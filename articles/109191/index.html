<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Slows down the web server. Setting by example www.ochevidets.ru</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I provide services for setting up web- and DB-servers. The other day I was approached by Ivan Usachev, the owner of the portal ochevidets.ru, with a r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Slows down the web server. Setting by example www.ochevidets.ru</h1><div class="post__text post__text-html js-mediator-article">  I provide services for setting up web- and DB-servers.  The other day I was approached by Ivan Usachev, the owner of the portal <a href="http://www.ochevidets.ru/">ochevidets.ru,</a> with a request to save the site from braking. <br><br>  Pages at peak times began to load for a long time, up to 5 minutes per page. <br><br><blockquote>  <b>UPDATE: The</b> article was written in 2010.  Something has changed: new versions of programs have been released, some directives have changed in nginx and new ones have appeared.  Consider this. </blockquote><br><a name="habracut"></a><br>  The first thing to start with in this case is to check if this is a problem of the provider through which the client enters the site.  The Internet is a large aggregate of networks, in which the package path from the data center to the client can be inhibited for reasons beyond the control of the site.  Therefore, we check the download speed of the site through other providers. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For this purpose there are convenient services: <br>  <a href="http://site-perf.com/">http://site-perf.com/</a> (access point is better to choose European) <br>  <a href="http://tools.pingdom.com/">http://tools.pingdom.com/</a> <br><br>  The problem was not in the providers.  We reason further. <br><br>  Rather heavy video content is distributed.  PHP scripts are quite simple, do not consume a lot of CPU time.  I learned this by looking at the output of the top linux command. <br><br>  The server has a ‚Äúmirror‚Äù raid with a read speed of each disk of about 60 MB / s (the server has been around for several years).  The server is connected to the Internet via a 100 Mb / s channel, which is roughly equivalent to 10 megabytes per second, considering that approximately 20% of the data is official. <br><br>  Obviously, the linear read speed is much higher than the throughput of the ethernet interface.  At first glance, there should be no problems. <br><br>  What if software raid moved to the degraded-state?  In this case, its performance may fall many times.  I look at the output of cat / proc / mdstat - all the disks [UU], everything is OK. <br><br>  Reason further.  The problem arose for the first time.  Attendance increased.  Many requests to the disk subsystem.  Since many users work with the site in parallel, the hard drive constantly repositions its heads and the reading speed can drop phenomenally due to such an unpleasant thing as seek-time. <br><br>  In addition, as I learned from the output of the free command from 8 GB of swap, 300 MB was used, which is in itself a very bad sign.  Writing and loading pages from a swap can specifically kill performance. <br><br>  From the output of the same top command, I learned that 70-80% of the time processes are in the io state ‚Äî which means waiting for input / output.  In principle, the network card also falls under the input, but according to the munin reports, the peak traffic was 70 Mbit, i.e.  peak performance has not been achieved. <br><br>  Here, of course, you need to take into account that the provider channel may not give the declared 100 Mbps and it is he who can limit the traffic. <br><br>  But taking into account the fact that during normal browsing of directories from mc, there was a slowdown in the problem was clearly in the disk subsystem. <br><br>  In general, there is a wonderful iotop utility, but to work with it, the kernel must include: CONFIG_TASK_IO_ACCOUNTING, CONFIG_TASK_DELAY_ACCT, CONFIG_TASKSTATS. <br><br>  The kernel was old, these options were not in it.  Therefore, during the day I could not use this diagnostic tool, because  server was undesirable to stop. <br><br>  I suggested that if you put the most frequently used files into the cache, then the number of repositioning will decrease by several times and this will save the server. <br><br>  The most beautiful way I know to cache a huge amount of data is a raid card with support for Max IQ technology.  SSD Drive for 64 GB or more is connected to the hardware raid controller.  And voila!  We have 64 GB cache!  Beautiful - but expensive to get started you need a controller with support for Max IQ ($ 500) and a special SSD Drive (from $ 1000). <br><br>  There was a place for the controller in the server, but not for the additional hard drive.  The server has a very compact 1U package.  So I decided to start using the system file system cache.  To increase this cache, simply increase the system memory. <br><br>  There were 4 more connectors left in the server and I found the necessary memory, focusing on the marking on the already standing memory modules. <br><br>  It was installed 2Gb of memory, I suggested adding another 8 GB.  I ordered it from an online store and while waiting for delivery, I decided to adjust the remaining moments. <br><br>  The server as frontend uses nginx and I decided to see what can be done with it. <br><br>  At first I installed <br><br><pre><code class="nginx">worker_processes 6;
</code></pre><br>
  2.   8 ,        nginx     apache  mysql.<br>
<br>
  /    :<br>
<br>
<pre><code class="nginx">http {

....

#  sendfile().  sendfile()   ,    ,                
#     .                                                                            
sendfile        on;

#                                                                                                         
tcp_nopush      on;                                                                                                       
tcp_nodelay     on;

#              .     
access_log off;

#   
gzip             on;
#   
gzip_min_length  1000;
gzip_buffers     16 8k;
#   
gzip_types       text/plain text/css text/xml application/x-javascript application/xml application/xhtml+xml;

}
</code></pre><br>
    flv  mp4.    (   /streaming)    .   ,    ‚Äî        ,    ,        .<br>
<br>
   flv- nginx      --with-http_flv_module.<br>
<br>
       x264 (mp4),        nginx       .<br>
<br>
        flv.    :<br>
<br>
<pre><code class="nginx">http {
    ...
    server {
        ...
        location ~ \.flv$ {
            flv;
        }
        ...
    }
    ...
}
</code></pre><br>
      .   ,     nginx    ,          apache.    :<br>
<br>
<pre><code class="nginx">server {
        listen       80;
        server_name  www.ochevidets.ru ochevidets.ru;
...
        location / {
            limit_conn   one  30;
            proxy_pass http://127.0.0.1:8128/;
...
        }
...
}
</code></pre><br>
     location   flv<br>
<br>
<pre><code class="nginx">location ~ \.flv$ {
            limit_conn   one  2;
            proxy_pass http://127.0.0.1:8128;
            proxy_buffer_size 2m;
...
        }

</code></pre><br>
    nginx   .  :<br>
<br>
<pre><code class="nginx">location /video/ {
  root /home/ochev/html/ochevidets.ru/;
}

location ~ /video/.*\.flv$ {
  root /home/ochev/html/ochevidets.ru/;
  flv;
  #      2 
  limit_conn   one  2;
}
</code></pre><br>
     server       <br>
<br>
<pre><code class="nginx">#       ,
#             150   
limit_rate_after  1m;
set $limit_rate  150k;
</code></pre><br>
  -    ,   - .    -   )<br>
<br>
   php.ini    -      php-.<br>
<br>
  eaccelerator   :<br>
<br>
<pre><code class="php">zend_extension="//eaccelerator.so"
eaccelerator.shm_size="8"  ;  shared memory    
eaccelerator.cache_dir="/home/ochev/tmp/eaccelerator" ;       ,   shared memory
eaccelerator.enable="1"  ;  
eaccelerator.optimizer="1"  ;     
eaccelerator.check_mtime="1"  ;     ,        
eaccelerator.debug="0"
eaccelerator.filter=""
eaccelerator.shm_max="0"
eaccelerator.shm_ttl="0"
eaccelerator.shm_prune_period="0"
eaccelerator.shm_only="0" ;   shared memory  
eaccelerator.compress="0"  ;      shared memory
</code></pre><br>
           ab,    .<br>
<br>
<pre><code class="bash">ab -c 10 -n 20 -t 20 http://www.ochevidets.ru/
</code></pre><br>
    ‚Äî 10,   20,     ‚Äî 20 <br>
<br>
Time per request   0.35   .           :        eaccelerator     mod_php   4,11  c 22,53  92,67   .<br>
<br>
       mysql.    --log-slow-queries=_.  ,     30 .     :<br>
<br>
<pre><code class="sql">... ORDER BY RAND(), ...... LIMIT ...
</code></pre><br>
     RAND()    2  <a href="http://www.titov.net/2005/09/21/do-not-use-order-by-rand-or-how-to-get-random-rows-from-table/"> </a>.      .<br>
<br>
    nginx         ,     .      ,            ?<br>
<br>
  linux-   :<br>
<br>
<pre><code class="bash">curl --head ____http
</code></pre><br>
  - -, , <a href="http://be1.ru/stat/">be1.ru/stat</a><br>
<br>
      :<br>
Cache-control ‚Äî    <br>
Expires ‚Äî      ,     <br>
Pragma ‚Äî  ,       cache-control<br>
Etag ‚Äî -  .   ,     <br>
<br>
        :<br>
<br>
 : <a href="">ochevidets.ru/userfiles/1209/images/2010/12/ekaterinburg/0.jpg</a><br>
<br>
<pre><code class="html">Status: HTTP/1.1 301 Moved Permanently
Server: nginx/0.8.53
Date: Wed, 01 Dec 2010 19:47:26 GMT
Content-type: text/html; charset=iso-8859-1
Connection: keep-alive
Location: http://www.ochevidets.ru/userfiles/1209/images/2010/12/ekaterinburg/0.jpg
Cache-control: max-age=3600
Expires: Wed, 01 Dec 2010 20:47:26 GMT
Content-length: 404
</code></pre><br>
        ,   .<br>
     ,    ,     ,     www.<br>
<br>
  ,           ,   <a href="http://ochevidets.ru/">ochevidets.ru</a> ,    <a href="http://www.ochevidets.ru/">www.ochevidets.ru</a>.      .<br>
<br>
     .htaccess  :<br>
<br>
<pre><code class="apache"># 
#RewriteCond %{HTTP_HOST} ^ochevidets\.ru$ [NC]
#RewriteCond %{REQUEST_URI} !^/robots\.txt$    
#RewriteRule ^(.*)$ http://www.ochevidets.ru/$1 [R=301,L]

#
#     ochevidets.ru     
RewriteCond %{HTTP_HOST} ^ochevidets\.ru$ [NC]
RewriteRule ^((.*/)|)$ http://www.ochevidets.ru/$1 [R=301,L]
</code></pre><br>
       .htaccess,        httpd.conf,       .<br>
<br>
   .htaccess     :<br>
<br>
<pre><code class="html">Status: HTTP/1.1 200 OK
Server: nginx/0.8.53
Date: Wed, 01 Dec 2010 19:53:24 GMT
Content-type: image/jpeg
Connection: keep-alive
Last-modified: Wed, 01 Dec 2010 09:25:20 GMT
Etag: "62957-1511b-49655e24e2000"
Accept-ranges: bytes
Content-length: 86299
Cache-control: max-age=864000
Expires: Sat, 11 Dec 2010 19:53:24 GMT
</code></pre><br>
      .<br>
<br>
  ,         .      :<br>
<br>
<blockquote>        .       .   .       .      .</blockquote><br>
<br>
   .<br>
<br>
             ‚Äî   <b></b>  2-3  (   ).<br>
<br>
 , ,      ‚Äî   RAM,     nginx  apache,    .<br>
<br>
<b>UPDATE</b>  :<ol>
<li>      mysql     <a href="http://habrahabr.ru/users/dulepov/" class="user_link">dulepov</a> (thread_cache_size = 36, wait_timeout = 300).</li>
<li>       nginx  <a href="http://habrahabr.ru/users/alexxxst/" class="user_link">alexxxst</a></li>
<li>    ab <a href="http://habrahabr.ru/users/woz/" class="user_link">WoZ</a>   siege</li>
<li><a href="http://habrahabr.ru/users/alfa/" class="user_link">alfa</a>      curl -I</li>
</ol></div><p>Source: <a href="https://habr.com/ru/post/109191/">https://habr.com/ru/post/109191/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../109181/index.html">Lessons from 10 years of technical reviews</a></li>
<li><a href="../109183/index.html">Turn one computer into two</a></li>
<li><a href="../109186/index.html">The long-awaited RC Drupal 7</a></li>
<li><a href="../109187/index.html">Synapse is a good alternative for Alt + F2</a></li>
<li><a href="../109189/index.html">"Software beyond morality." The Tear-Tale, Chapter One, Part One</a></li>
<li><a href="../109193/index.html">Work with sound in practice</a></li>
<li><a href="../109195/index.html">Seven principles of a successful social product that you need to know</a></li>
<li><a href="../109196/index.html">Released Google Reader app for Android</a></li>
<li><a href="../109200/index.html">To treat your customers badly is bad for business.</a></li>
<li><a href="../109201/index.html">Android 2.2 is finally ahead of 2.1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>