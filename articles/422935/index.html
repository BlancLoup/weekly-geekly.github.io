<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>2GIS on your hand. How we added a map to Apple Watch</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Apple Watch quickly gained popularity and became the most popular watch in the world, ahead of Rolex and other manufacturers. The idea of ‚Äã‚Äãcreating a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>2GIS on your hand. How we added a map to Apple Watch</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/ut/d9/tb/utd9tb6vvq-zreaxgxkakez4gce.jpeg"></p><br><p>  Apple Watch quickly gained popularity and became the most popular watch in the world, ahead of Rolex and other manufacturers.  The idea of ‚Äã‚Äãcreating an application for watches has been in the office of 2GIS since 2015. </p><br><p>  Before us, only Apple itself released a full-fledged application with a map on the clock.  The Yandex.Maps application displays only widgets of traffic jams and travel time to home and work.  Yandex.Navigator, Google Maps, Waze and Maps.Me are generally not available on the clock. </p><br><p>  In fact, due to the many limitations of the system and the complexity of development, companies either do not make applications for watches at all or make them very simple.  You can not just take and make a map on the clock.  But we could. </p><br><p>  Take a look under the cat to find out how the pet-project has grown into a complete product. </p><br><p>  <strong>UPD.:</strong> <a href="https://github.com/teanet/DemoWatch">Https://github.com/teanet/DemoWatch</a> </p><a name="habracut"></a><br><h3 id="my-reshili-delat-kartu-chto-bylo-na-starte">  We decided to make a map.  What was at the start? </h3><br><ol><li>  Development experience on the clock - 2 days of work on a test project. </li><li>  Experience with SpriteKit - 0 days. </li><li>  The experience of writing MapKit is 0 days. </li><li>  Doubts that something could go wrong - ‚àû. </li></ol><br><h3 id="iteraciya-1--polet-mysli">  Iteration 1 - flight of thought </h3><br><p>  We are serious people, so for the beginning we decided to draw up a work plan.  We took into account that we are working in a tightly planned sprint, we have five hundred points for "small-scale tasks" and complete ignorance of where to start. </p><br><p>  The map is a very big picture.  We can show pictures on the clock, so we can handle the display of the card. </p><br><p>  We have a service that can cut a card into pieces: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cu/or/kl/cuorkl7imghdolhexs7yb2qskr4.png"></div><br><p>  If to cut such picture and to put in WKImage, we will receive the simplest working prototype for five kopeks. </p><br><p>  And if we add PanGesture to this image and install a new image for each swipe, we will get a simulation of interaction with the map. </p><br><p>  / We rejoice / It sounds awful, it looks approximately the same, it works even worse, but in fact the task is completed. </p><br><h3 id="iteraciya-2--minimalnyy-prototip">  Iteration 2 - minimal prototype </h3><br><p>  Continuous loading of pictures is expensive for the battery in hours.  And the boot time itself suffers.  We wanted to get something more complete and responsive.  By the way, we heard that the clock has support for SpriteKit - the only framework for WatchOS, with the ability to use the coordinates, zoom and customize all this splendor for yourself. </p><br><p>  After a couple of hours of StackOverflow Driven Development (SDD), we get the second iteration: <br>  One SKSpriteNode, one WKPanGestureRecognizer. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dr/bi/ub/drbiubucg4xxcr7jbyccmmth71m.gif"></div><br><p>  / We rejoice / Yes, this is MapKit for 6 kopecks, fully working.  Urgent release! </p><br><h3 id="iteraciya-3-dobavlyaem-tayly-i-zum">  Iteration 3 ‚Äî add tiles and zoom </h3><br><p>  When emotions were asleep, thinking about where to go next. </p><br><p>  Understand what is most important: </p><br><ul><li>  Replace the picture on the tiles. </li><li>  Put 4 tiles in the application bundle and connect them together. </li><li>  Provide zoom pictures. <br>  Let's leave 4 tiles in the application bundle, then put them on some: </li></ul><br><pre><code class="hljs objectivec">let rootNode = <span class="hljs-built_in"><span class="hljs-built_in">SKSpriteNode</span></span>()</code> </pre> <br><p>  With the help of simple mathematics we connect them together. <br>  Zoom do through WKCrownDelegate: </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">crownDidRotate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> crownSequencer: WKCrownSequencer?, rotationalDelta: Double )</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.scale += <span class="hljs-type"><span class="hljs-type">CGFloat</span></span>(rotationalDelta * <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.rootNode.setScale(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.scale) }</code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/xf/zg/ws/xfzgwsd4wpsyappc4ehbejs8p2u.gif"></div><br><p>  / We rejoice / Well, now that's for sure!  A couple of fixes, and in the master. </p><br><h3 id="iteraciya-4--optimiziruem-vzaimodeystvie-s-kartoy">  Iteration 4 - we optimize interaction with the card </h3><br><p>  The next day it turned out that for SpriteKit anchorPoint does not affect the zoom.  The zoom completely ignores the anchorPoint and occurs relative to the center of the rootNode.  It turns out that for every step of the zoom we need to adjust the position. </p><br><p>  It would also be nice to load tiles from the server, and not to store the whole world in the memory of the clock. <br>  Do not forget that the tiles should be tied to the coordinates so that they do not lie in the center of the SKScene, but in the corresponding places on the map. </p><br><p>  Tiles look like this: </p><br><p><img src="https://habrastorage.org/webt/zo/-s/7d/zo-s7dhq--jmie8vigvbdqyp0g0.jpeg"></p><br><p>  For each zoomLevel (hereinafter referred to as ‚Äúz‚Äù) there is a set of tiles.  For z = 1, we have 4 tiles that make up the whole world. </p><br><p><img src="https://habrastorage.org/webt/oe/jl/6b/oejl6beiczhxnf09cj1oqyxr1-4.png"></p><br><p>  for z = 2 - in order to cover the whole world, you need 16 tiles, <br>  for z = 3 - 64 tiles. <br>  for z = 18 ‚âà 68 * 10 ^ 9 tiles. <br>  Now they need to be put into the world of SpriteKit. </p><br><p>  The size of one tile is 256 * 256 pt, it means <br>  for z = 1, the size of the ‚Äúworld‚Äù will be equal to 512 * 512 pt, <br>  for z = 2, the size of the ‚Äúworld‚Äù will be 1024 * 1024 pt. <br>  For ease of calculation, we put tiles into the world as follows: </p><br><p><img src="https://habrastorage.org/webt/l_/_u/vp/l__uvp1_sli-cirdspcwi_y6zlm.png"></p><br><p>  Encode the tile: </p><br><pre> <code class="hljs vbscript"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> kTileLength: CGFloat = <span class="hljs-number"><span class="hljs-number">256</span></span> struct TilePath { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> x: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> y: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> z: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span> }</code> </pre> <br><p>  Determine the coordinate of the tile in this world: </p><br><pre> <code class="hljs objectivec">var position: <span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span> { let x = <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.x) let y = <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.y) let offset: <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span> = pow(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.z - <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>(x: kTileLength * ( -offset + x ), y: kTileLength * ( offset - y - <span class="hljs-number"><span class="hljs-number">1</span></span> )) } var center: <span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.position + <span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>(x: kTileLength, y: kTileLength) * <span class="hljs-number"><span class="hljs-number">0.5</span></span> }</code> </pre> <br><p>  The location is convenient because it allows you to bring everything to the coordinates of the real world: latitude / longitude = 0, which is exactly in the center of the "world". </p><br><p>  The latitude / longitude of the real world is transformed into our world as follows: </p><br><pre> <code class="hljs coffeescript">extension CLLocationCoordinate2D { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     ( <span class="hljs-number"><span class="hljs-number">-1</span></span> &lt; TileLocation &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> ) func tileLocation() -&gt; CGPoint { var siny = sin(self.latitude * .pi / <span class="hljs-number"><span class="hljs-number">180</span></span>) siny = min(max(siny, <span class="hljs-number"><span class="hljs-number">-1</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>) let y = CGFloat(log( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> + siny )</span></span></span><span class="hljs-function"> / </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> - siny )</span></span></span><span class="hljs-function">)) return CGPoint</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( x: kTileLength * ( </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.5</span></span></span></span><span class="hljs-function"><span class="hljs-params"> + CGFloat(self.longitude) / </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">360</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ), y: kTileLength * ( </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.5</span></span></span></span><span class="hljs-function"><span class="hljs-params"> - y / ( </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">4</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * .pi ) ) )</span></span></span><span class="hljs-function"> } //       zoomLevel func location</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">for</span></span></span></span><span class="hljs-function"><span class="hljs-params"> z: Int)</span></span></span><span class="hljs-function"> -&gt;</span></span> CGPoint { let tile = self.tileLocation() let zoom: CGFloat = pow(<span class="hljs-number"><span class="hljs-number">2</span></span>, CGFloat(z)) let offset = kTileLength * <span class="hljs-number"><span class="hljs-number">0.5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CGPoint( x: (tile.x - offset ) * zoom, y: (-tile.y + offset) * zoom ) } }</code> </pre> <br><p>  With the zoom level, there were problems.  I had to spend a couple of weekends to gather all the mathematical apparatus in a pile and ensure the perfect merging of tiles.  That is, a tile for z = 1 should ideally go into four tiles for z = 2 and, on the contrary, four tiles for z = 2 should go into one tile for z = 1. </p><br><p><img src="https://habrastorage.org/webt/j_/62/0r/j_620racsivq_qnnj5euvweexlo.jpeg"></p><br><p>  In addition, it was necessary to turn the linear zoom into exponential, since the zooms vary from 1 &lt;= z &lt;= 18, and the map is scaled as 2 ^ z. </p><br><p>  Smooth zoom is provided by constant adjustment of the position of the tiles.  It is important that the tiles are stitched exactly in the middle: that is, the level 1 tile goes into 4 level 2 tiles at 1.5 zoom. </p><br><p>  SpriteKit under the hood uses float.  For z = 18, we get the scatter of coordinates (-33 554 432/33 554 432), and the accuracy of the float is 7 bits.  At the output, we have an error in the region of 30 pt.  To avoid the occurrence of "cracks" between the halves, place the visible tile as close as possible to the center of the SKScene. </p><br><p>  / We rejoice / After all these gestures we got a prototype ready for testing. </p><br><h3 id="reliz">  Release </h3><br><p>  Since the application did not really have the TK, we found a couple of volunteers to conduct a little testing.  Found no problems, and decided to roll out into the store. </p><br><p>  After the release, it turned out that on the clock of the first series, the processor does not have time to draw the first frame of the card in 10 seconds and falls on timeout.  I had to initially create a map completely empty in order to fit in 10 seconds, and then gradually load the substrate.  First, develop all levels of the map - and then load tiles for them. </p><br><p>  It took a lot of time to debug the network, properly setting the cache and a small Memory Footprint, so that WatchOS did not try to kill our application for as long as possible. </p><br><p>  After profiling the application, we found out that instead of the usual tiles, you can use Retina tiles, with almost no harm to the load time and memory consumption, and in the new release you have already switched to them. </p><br><h3 id="itogi-i-plany-na-buduschee">  Results and future plans </h3><br><p>  We can already display the route on the map with maneuvers built in the main application.  The feature will be available in one of the upcoming releases. </p><br><p>  The project, which initially seemed impracticable, turned out to be extremely useful for me personally.  I often use the app to see if I will soon leave at the right stop.  I believe that in winter it will be even more useful. </p><br><p>  At the same time, once again I was convinced that the complexity of the project, the belief of others in the success of the task or the availability of free time at work is not so important.  The main thing is the desire to make a project and a tedious, gradual movement towards the goal.  As a result, we have a full-fledged MapKit, which is almost unlimited and works with 3 WatchOS.  You can customize it as you want, without waiting for Apple to roll out a suitable API for development. </p><br><p>  <strong>PS</strong> For those interested, I can lay out the finished project.  The code level there is far from production.  But, according to the military principle, no matter how it works, the main thing is that it works! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/422935/">https://habr.com/ru/post/422935/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../422921/index.html">From Kotlin to Goblin: how TechTrain passed</a></li>
<li><a href="../422923/index.html">How to celebrate the day of the programmer, not decorating office ficus with zeros and units</a></li>
<li><a href="../422925/index.html">Interview with Godfrey Chan, RubyRussia Conference Speaker</a></li>
<li><a href="../422929/index.html">Yandex mail [was] unavailable for about an hour at 12:16 MSK</a></li>
<li><a href="../422931/index.html">Looking at tools for monitoring distributed applications</a></li>
<li><a href="../422937/index.html">Disk caching of lazy computing trees</a></li>
<li><a href="../422939/index.html">The book "Kali Linux from developers"</a></li>
<li><a href="../422941/index.html">"Three in a boat, poverty and dogs", or how Antiplagiat seeks paraphrase</a></li>
<li><a href="../422943/index.html">A little bit about industrial mining</a></li>
<li><a href="../422945/index.html">September 27, Moscow - Mitap QIWI SERVER PARTY 3.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>