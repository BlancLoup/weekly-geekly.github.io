<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Synchronization of two Apache + MySQL servers on FreeBSD</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this review I will talk about the implementation of a cluster consisting of two nodes with the reservation of a popular bundle for the Apache + MyS...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Synchronization of two Apache + MySQL servers on FreeBSD</h1><div class="post__text post__text-html js-mediator-article"> In this review I will talk about the implementation of a cluster consisting of two nodes with the reservation of a popular bundle for the Apache + MySQL + FreeBSD web server (or any Linux). <br><a name="habracut"></a><br>  Briefly about servers.  Each server has two network cards.  They are connected to one - to the switch, between the second ones there is a short patchcord, in order not to overload our switch with extra traffic. <br>  Accordingly, two network interfaces em0 - for external, rl0 - for replication. <br>  On the first server for the rl0 interface, set IP 192.168.0.1 on the second 192.168.0.2. <br><br>  <b>1. APACHE</b> <br>  The task is to synchronize the files of virtual hosts. <br>  We will use rsync in conjunction with ssh.  To do this, on the first server in the file / etc / ssh / sshd_config we write: <br><br> <code>AllowUsers root@192.168.0.2 <br> PermitRootLogin yes</code> <br> <br>  The second is similar: <br> <code>AllowUsers root@192.168.0.1 <br> PermitRootLogin yes</code> <br> <br>  That is, we allow ssh access to the root user, between servers.  For each virtual domain, different users are used, respectively, they have a different UID.  Of course, you can also create a separate user for replicating files that can access each user‚Äôs files, but it‚Äôs simpler to use root, especially since there‚Äôs no vulnerability.  SSH access to the superuser root has only one internal IP address, which we explicitly indicated in the configuration files. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Next, let's allow root access without a password, for this we will generate a pair of keys: <br> <code>ssh-keygen -t rsa (passphrase  ) <br> scp /root/.ssh/id_rsa.pub root@192.168.0.2:/root/.ssh/authorized_keys2</code> <br> <br>  and similarly on the second server: <br> <code>ssh-keygen -t rsa (passphrase  ) <br> scp /root/.ssh/id_rsa.pub root@192.168.0.1:/root/.ssh/authorized_keys2</code> <br> <br>  Next, on the second server, create, for example, in / root / scripts / file, let's call it sync.sh: <br> <code>/usr/local/bin/rsync -e 'ssh -l root -i /root/.ssh/id_rsa' --progress -lzuogthvr --compress-level=9 --delete-after root@192.168.0.1:/opt/vhosts/sitename.ru/ /opt/vhosts/sitename.ru/ &gt;&gt; /root/logs/sync.sitename</code> <br> <br>  sitename.ru - virtual host name <br><br>  Enable launch: <br> <code>chmod +x /root/scripts/sync.sh</code> <br> <br>  Let's write in / etc / crontab: <br> <code>0 */1 * * * root /root/scripts/sync.sh &gt;/dev/null 2&gt;&amp;1</code> <br>  In my example, synchronization is performed every hour. <br><br>  <b>2. MySQL</b> <br>  On the first server in the file my.cnf we write the following: <br> <code>log-bin=mysql-bin <br> binlog_format=mixed <br> server-id = 1 <br> slave-compressed = 1 <br> binlog-do-db = base ( ,   ) <br> replicate-wild-ignore-table=base.chat (   chat ‚Äì MEMORY TABLE    , )</code> <br> <br>  We will perform replication under a separate user, let's call it repluser, allow it access from IP 192.168.0.2 and give global rights SELECT, RELOAD, SUPER, REPLICATION SLAVE. <br><br>  On the second server in my.cnf: <br> <code>max-user-connections = 50 <br> master-host = 192.168.0.1 <br> master-user = repluser ( ) <br> master-password = &lt;  repluser&gt; <br> server-id = 2 (   ID !) <br> replicate-do-db = base ( )</code> <br> <br>  Farther <br>  On the first server we execute: <br> <code>mysql&gt; FLUSH TABLES WITH READ LOCK; <br> mysql&gt; show master status;</code> <br>  See something like this: <br> <code>+------------------+----------+--------------+------------------+ <br> | File | Position | Binlog_Do_DB | Binlog_Ignore_DB | <br> +------------------+----------+--------------+------------------+ <br> | mysql-bin.000031 | 2073 | base | | <br> +------------------+----------+--------------+------------------+ <br> 1 row in set (0.00 sec)</code> <br> <br>  Be sure to save the output to a text file!  Further: <br> <code>mysqldump -u root -p base &gt; /root/base.db <br> <br> mysql&gt; UNLOCK TABLES;</code> <br> <br>  transfer the received dump to the 2nd server. <br><br>  On the second server: <br> <code>mysql&gt;CREATE DATABASE base; <br> mysql&gt; USE base; <br> mysql&gt; SOURCE /root/base.db (   ) <br> <br> mysql&gt; CHANGE MASTER TO MASTER_LOG_FILE='srv011-bin.000813'; <br> Query OK, 0 rows affected (0.05 sec)</code> <br>  srv011-bin.000813 - what they wrote to the text file <br><br> <code>mysql&gt; CHANGE MASTER TO MASTER_LOG_POS=1156293; <br> Query OK, 0 rows affected (0.05 sec)</code> <br>  1156293 - from the same place <br><br> <code>mysql&gt; start slave; <br> Query OK, 0 rows affected (0.00 sec)</code> <br> <br>  Replication works!  Check the replication status with the command: <br><br> <code>mysql&gt; SHOW SLAVE STATUS\G;</code> <br> <br>  <b>3. Heartbeat</b> <br>  Cluster implementation.  Since the kernel update method was originally chosen - the binary update, the most convenient CARP option was dropped.  CARP is a great tool, unfortunately, not accessible without rebuilding the kernel.  So choose a heartbeat - a fairly well-known software, unfortunately ported from linux, which draws a lot of unnecessary dependencies, but it's not so scary. <br><br> <code>cd /usr/ports/sysutils/heartbeat <br> make &amp;&amp; make install &amp;&amp; make clean  portmaster sysutils/heartbeat</code> <br> <br>  Go to the configuration for this on the first server: <br>  /usr/local/etc/ha.d/authkeys: <br><br> <code>auth 1 <br> 1 crc</code> <br> <br>  /usr/local/etc/ha.d/ha.cf: <br><br> <code>crm off <br> logfile /var/log/heartbeat.log <br> keepalive 2 <br> deadtime 10 <br> udpport 694 <br> ucast rl0 192.168.0.2 <br> auto_failback on <br> node srv1.sitename.ru <br> node srv2.sitename.ru</code> <br> <br>  rl0 - the name of the interface on which we are synchronizing <br><br>  /usr/local/etc/ha.d/hareresources: <br> <code>srv1.sitename.ru 212.212.212.212/28/em0</code> <br>  212.212.212.212 - our white IP <br><br>  Similarly on the second server, except for the IP address in /usr/local/etc/ha.d/ha.cf: <br> <code>ucast rl0 192.168.0.1</code> <br> <br>  It seems to be all, but in the implementation for FreeBSD an error came out unpleasant, at the start, heartbeat did not want to set the correct subnet mask, and besides, it didn‚Äôt know what route was.  Fortunately, the solution is quite simple, go to: <br>  /usr/local/etc/ocf/resources.d/heartbeat/IPaddr <br><br>  Looking for a string <br> <code>CMD="$IFCONFIG $iface inet $ipaddr netmask 255.255.255.255 alias";;</code> <br> <br>  And change it to: <br> <code>CMD="$IFCONFIG $iface $ipaddr netmask $netmask broadcast $broadcast; route add default &lt;IP  -&gt;";;</code> <br> <br>  Now everything works as it should. <br><br>  Hearbeat can manage commands: <br><br>  Make the node enforced primary: <br>  / usr / local / lib / heartbeat / hb_takeover <br>  Make the node forced to spare: <br>  / usr / local / lib / heartbeat / hb_standby </div><p>Source: <a href="https://habr.com/ru/post/86496/">https://habr.com/ru/post/86496/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../86486/index.html">Bank Trust: How to work</a></li>
<li><a href="../86488/index.html">Remote control for Panasonic FZ-20</a></li>
<li><a href="../86490/index.html">The MeeGo repository will be publicly available this month, also for the N900</a></li>
<li><a href="../86491/index.html">Canobuvosti, 29th edition</a></li>
<li><a href="../86492/index.html">Freebsd + netgraph, multicast from home to work</a></li>
<li><a href="../86498/index.html">About time, slavery and tomatoes</a></li>
<li><a href="../86499/index.html">First look on Panasonic HDC-TM300e</a></li>
<li><a href="../86501/index.html">Impressions from attending i-Community 2010 and Yandex conferences</a></li>
<li><a href="../86504/index.html">What character articles do you like to read most of all?</a></li>
<li><a href="../86505/index.html">Problems downloading SQL Server 2005</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>