<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Protection against bots, based on differences in working with large numbers in JavaScript and PHP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I had to deal with the protection from bots, used on several fairly popular resources. 
 At first glance, the protection seemed to be the us...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Protection against bots, based on differences in working with large numbers in JavaScript and PHP</h1><div class="post__text post__text-html js-mediator-article">  Recently, I had to deal with the protection from bots, used on several fairly popular resources. <br>  At first glance, the protection seemed to be the usual setting of cookies via javascript, which is 15 minutes to cope with.  In fact, after a little research, it became clear where what is being done and what parameters are being transferred to, it remains only to rewrite a small function from javascript to php and the trick is done. <br>  But it was not so easy.  And although in the end the defense was broken, it took far 15 minutes, and the principle of protection itself turned out to be new and quite interesting for me. <br><br>  So, first things first. <br><a name="habracut"></a><br><h4>  Surface inspection </h4><br>  Protection works as follows. <br>  The script of the main page of the site index.php expects a cookie, in which one of the parameters will indicate the hash calculated from the visitor's IP address. <br>  If the cookie is not transmitted, then index.php redirects the visitor to another page containing the javascript code that calculates the required parameter, writes it to the cookie and returns us back to the main page. <br><br>  In order for a regular php bot that performs GET and POST requests through CURL to pass through such protection, you need to rewrite the hash calculation from javascript to php and then add the desired cookie to the request header. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Autopsy </h4><br>  Now more. <br>  Launch Firefox, disable javascript and enable Firebug. <br>  We request the main page index.php and look at the request and response headers. <br><br>  Request: <br><br>  Get <pre>  http://example.com </pre><br><br>  The headers of this query are of no interest to us. <br>  Here are the response headers: <br><br>  <i><b>Status: 302 Moved Temporarily</b></i> <i><br><br></i>  <i>Connection keep-alive</i> <i><br></i>  <i>Content-Type text / html</i> <i><br></i>  <i>Date XXX GMT</i> <i><br></i>  <i><b>Location</b></i> <pre>  http://example.com/govalidateyourself#98765:1234:11.22.3.3.4.4:/index.php </pre><br>  Server YTS / 1.20.0 <br>  Transfer-Encoding chunked <br><br><br>  Then Firefox automatically switches to the Location specified in the header, receiving the following response header: <br><br>  <i>Accept-Ranges bytes</i> <i><br></i>  <i>Connection keep-alive</i> <i><br></i>  <i>Content-Type text / html;</i>  <i>charset = utf-8</i> <i><br></i>  <i>Date XXX GMT</i> <i><br></i>  <i>Last-Modified YYY GMT</i> <i><br></i>  <i>Server YTS / 1.20.0</i> <i><br></i>  <i><b>Set-Cookie addr = 1234: 11.22.33.44;</b></i>  <i><b>path = /</b></i> <i><br></i>  <i>Transfer-Encoding chunked</i> <i><br></i> <br><br>  Where 11.22.33.44 is my IP address, 1234 is a number whose calculation logic is unknown. <br><br>  The page itself contains a link to the js-code. <pre>  http://example2.com/validator/va.js </pre>  and the inscription "No javascript". <br>  Without js, they won't let us go any further. <br><br>  After all the requests and responses are recorded, we enable javascript, clear the cookie and do it all over again. <br>  Now we are interested in what will happen after the request of the validation page. <br><br>  This time, the main page of the site is loaded, and here is the header of the last request: <br><br>  <i>Accept text / html, application / xhtml + xml, application / xml; q = 0.9, * / *; q = 0.8</i> <i><br></i>  <i>Accept-Encoding gzip, deflate</i> <i><br></i>  <i>Accept-Language ru-ru, ru; q = 0.8, en-us; q = 0.5, en; q = 0.3</i> <i><br></i>  <i>Connection keep-alive</i> <i><br></i>  <i><b>Cookie addr = 5678: 11.22.33.44;</b></i>  <i><b>urine = aabbccdd;</b></i>  <i><b>v = 1</b></i> <i><br></i>  <i>Host example.com</i> <i><br></i>  <i><b>Referer</b></i> <pre>  http://example.com/govalidateyourself </pre><br>  User-agent of some kind of firefox <br><br><br>  Constant 1234 from the last server response this time changed to 5678, the IP address remained the same.  Apparently this is the request ID assigned by the server and stored in the cookie.  Well, it should be saved and simply written in cookies unchanged during requests. <br><br>  But the parameter urine = aabbccdd is already interesting.  Since he did not come from the server, it means he was received from us, and something tells me that this is the work of va.js. <br><br>  It's time to see what's inside.  At first glance, a complete swamp, in which it is better not to get into: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.cookie==<span class="hljs-string"><span class="hljs-string">""</span></span>){<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.write(<span class="hljs-string"><span class="hljs-string">"Cookies error"</span></span>)}<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">poo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a,b</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> c=a.length,d=b^c,e=<span class="hljs-number"><span class="hljs-number">0</span></span>,f;<span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(c&gt;=<span class="hljs-number"><span class="hljs-number">4</span></span>){f=a.charCodeAt(e)&amp;<span class="hljs-number"><span class="hljs-number">255</span></span>|(a.charCodeAt(++e)&amp;<span class="hljs-number"><span class="hljs-number">255</span></span>)&lt;&lt;<span class="hljs-number"><span class="hljs-number">8</span></span>|(a.charCodeAt(++e)&amp;<span class="hljs-number"><span class="hljs-number">255</span></span>)&lt;&lt;<span class="hljs-number"><span class="hljs-number">16</span></span>|(a.charCodeAt(++e)&amp;<span class="hljs-number"><span class="hljs-number">255</span></span>)&lt;&lt;<span class="hljs-number"><span class="hljs-number">24</span></span>;f=(f&amp;<span class="hljs-number"><span class="hljs-number">65535</span></span>)*<span class="hljs-number"><span class="hljs-number">1540483477</span></span>+(((f&gt;&gt;&gt;<span class="hljs-number"><span class="hljs-number">16</span></span>)*<span class="hljs-number"><span class="hljs-number">1540483477</span></span>&amp;<span class="hljs-number"><span class="hljs-number">65535</span></span>)&lt;&lt;<span class="hljs-number"><span class="hljs-number">16</span></span>);f^=f&gt;&gt;&gt;<span class="hljs-number"><span class="hljs-number">24</span></span>;f=(f&amp;<span class="hljs-number"><span class="hljs-number">65535</span></span>)*<span class="hljs-number"><span class="hljs-number">1540483477</span></span>+(((f&gt;&gt;&gt;<span class="hljs-number"><span class="hljs-number">16</span></span>)*<span class="hljs-number"><span class="hljs-number">1540483477</span></span>&amp;<span class="hljs-number"><span class="hljs-number">65535</span></span>)&lt;&lt;<span class="hljs-number"><span class="hljs-number">16</span></span>);d=(d&amp;<span class="hljs-number"><span class="hljs-number">65535</span></span>)*<span class="hljs-number"><span class="hljs-number">1540483477</span></span>+(((d&gt;&gt;&gt;<span class="hljs-number"><span class="hljs-number">16</span></span>)*<span class="hljs-number"><span class="hljs-number">1540483477</span></span>&amp;<span class="hljs-number"><span class="hljs-number">65535</span></span>)&lt;&lt;<span class="hljs-number"><span class="hljs-number">16</span></span>)^f;c-=<span class="hljs-number"><span class="hljs-number">4</span></span>;++e}<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(c){<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>:d^=(a.charCodeAt(e+<span class="hljs-number"><span class="hljs-number">2</span></span>)&amp;<span class="hljs-number"><span class="hljs-number">255</span></span>)&lt;&lt;<span class="hljs-number"><span class="hljs-number">16</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>:d^=(a.charCodeAt(e+<span class="hljs-number"><span class="hljs-number">1</span></span>)&amp;<span class="hljs-number"><span class="hljs-number">255</span></span>)&lt;&lt;<span class="hljs-number"><span class="hljs-number">8</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:d^=a.charCodeAt(e)&amp;<span class="hljs-number"><span class="hljs-number">255</span></span>;d=(d&amp;<span class="hljs-number"><span class="hljs-number">65535</span></span>)*<span class="hljs-number"><span class="hljs-number">1540483477</span></span>+(((d&gt;&gt;&gt;<span class="hljs-number"><span class="hljs-number">16</span></span>)*<span class="hljs-number"><span class="hljs-number">1540483477</span></span>&amp;<span class="hljs-number"><span class="hljs-number">65535</span></span>)&lt;&lt;<span class="hljs-number"><span class="hljs-number">16</span></span>)}d^=d&gt;&gt;&gt;<span class="hljs-number"><span class="hljs-number">13</span></span>;d=(d&amp;<span class="hljs-number"><span class="hljs-number">65535</span></span>)*<span class="hljs-number"><span class="hljs-number">1540483477</span></span>+(((d&gt;&gt;&gt;<span class="hljs-number"><span class="hljs-number">16</span></span>)*<span class="hljs-number"><span class="hljs-number">1540483477</span></span>&amp;<span class="hljs-number"><span class="hljs-number">65535</span></span>)&lt;&lt;<span class="hljs-number"><span class="hljs-number">16</span></span>);d^=d&gt;&gt;&gt;<span class="hljs-number"><span class="hljs-number">15</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> d&gt;&gt;&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>}<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">coo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b=a+<span class="hljs-string"><span class="hljs-string">"="</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> c=<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.cookie.split(<span class="hljs-string"><span class="hljs-string">";"</span></span>);<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> d=<span class="hljs-number"><span class="hljs-number">0</span></span>;d&lt;c.length;d++){<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> e=c[d];<span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(e.charAt(<span class="hljs-number"><span class="hljs-number">0</span></span>)==<span class="hljs-string"><span class="hljs-string">" "</span></span>)e=e.substring(<span class="hljs-number"><span class="hljs-number">1</span></span>,e.length);<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(e.indexOf(b)==<span class="hljs-number"><span class="hljs-number">0</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> e.substring(b.length,e.length)}<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>}<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dt=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>,expiryTime=dt.setTime(dt.getTime()+<span class="hljs-number"><span class="hljs-number">1000e5</span></span>);<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dt2=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>,expiryTime=dt2.setTime(dt2.getTime()+<span class="hljs-number"><span class="hljs-number">2e4</span></span>);<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> addr=<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.location.hash.split(<span class="hljs-string"><span class="hljs-string">":"</span></span>)[<span class="hljs-number"><span class="hljs-number">2</span></span>];<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a=poo(addr,<span class="hljs-number"><span class="hljs-number">47</span></span>).toString(<span class="hljs-number"><span class="hljs-number">16</span></span>);<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>,z=<span class="hljs-string"><span class="hljs-string">""</span></span>;i&lt;<span class="hljs-number"><span class="hljs-number">8</span></span>-a.length;i++)z+=<span class="hljs-string"><span class="hljs-string">"0"</span></span>;a=z+a;a=a.substring(<span class="hljs-number"><span class="hljs-number">6</span></span>)+a.substring(<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>)+a.substring(<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)+a.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>);<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> refurl=<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.location.hash.split(<span class="hljs-string"><span class="hljs-string">":"</span></span>)[<span class="hljs-number"><span class="hljs-number">3</span></span>];<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.cookie=<span class="hljs-string"><span class="hljs-string">"urine="</span></span>+a+<span class="hljs-string"><span class="hljs-string">"; expires="</span></span>+dt.toGMTString()+<span class="hljs-string"><span class="hljs-string">"; path=/"</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!coo(<span class="hljs-string"><span class="hljs-string">"v"</span></span>)){<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.cookie=<span class="hljs-string"><span class="hljs-string">"v=1; expires="</span></span>+dt2.toGMTString()+<span class="hljs-string"><span class="hljs-string">"; path=/"</span></span>;setTimeout(<span class="hljs-string"><span class="hljs-string">"window.location = refurl"</span></span>,<span class="hljs-number"><span class="hljs-number">300</span></span>)}<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(coo(<span class="hljs-string"><span class="hljs-string">"v"</span></span>)&lt;<span class="hljs-number"><span class="hljs-number">3</span></span>){<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> c=coo(<span class="hljs-string"><span class="hljs-string">"v"</span></span>);c++;<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.cookie=<span class="hljs-string"><span class="hljs-string">"v="</span></span>+c+<span class="hljs-string"><span class="hljs-string">"; expires="</span></span>+dt2.toGMTString()+<span class="hljs-string"><span class="hljs-string">"; path=/"</span></span>;setTimeout(<span class="hljs-string"><span class="hljs-string">"window.location = refurl"</span></span>,<span class="hljs-number"><span class="hljs-number">300</span></span>)}<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(coo(<span class="hljs-string"><span class="hljs-string">"v"</span></span>)&gt;=<span class="hljs-number"><span class="hljs-number">3</span></span>){<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.write(<span class="hljs-string"><span class="hljs-string">"Too many redirects from: "</span></span>+<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.referrer)}}</code> </pre> <br><br>  But a little patience, and after formatting everything looks readable and quite understandable. <br>  There are two functions coo () and poo (), and the code that writes the cookie we need and sends it back to index.php. <br><br>  The soo () function is not of particular interest, it receives the value of the specified parameter from a cookie, and is easily written to php with a simple regular expression. <br><br>  Here is the poo () function, which counts the urine parameter: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">poo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> a, b </span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> c = a.length, d = b^c, e = <span class="hljs-number"><span class="hljs-number">0</span></span>, f; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>( c &gt;= <span class="hljs-number"><span class="hljs-number">4</span></span> ) { f = a.charCodeAt( e ) &amp; <span class="hljs-number"><span class="hljs-number">255</span></span> | ( a.charCodeAt( ++e ) &amp; <span class="hljs-number"><span class="hljs-number">255</span></span> ) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span> | ( a.charCodeAt( ++e ) &amp; <span class="hljs-number"><span class="hljs-number">255</span></span> ) &lt;&lt; <span class="hljs-number"><span class="hljs-number">16</span></span> | ( a.charCodeAt( ++e ) &amp; <span class="hljs-number"><span class="hljs-number">255</span></span> ) &lt;&lt; <span class="hljs-number"><span class="hljs-number">24</span></span>; f = ( f &amp; <span class="hljs-number"><span class="hljs-number">65535</span></span> ) * <span class="hljs-number"><span class="hljs-number">1540483477</span></span> + ( ( ( f &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">16</span></span> ) * <span class="hljs-number"><span class="hljs-number">1540483477</span></span> &amp; <span class="hljs-number"><span class="hljs-number">65535</span></span> ) &lt;&lt; <span class="hljs-number"><span class="hljs-number">16</span></span> ); f ^= f &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">24</span></span>; f = ( f &amp; <span class="hljs-number"><span class="hljs-number">65535</span></span> ) * <span class="hljs-number"><span class="hljs-number">1540483477</span></span> + ( ( ( f &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">16</span></span> ) * <span class="hljs-number"><span class="hljs-number">1540483477</span></span> &amp; <span class="hljs-number"><span class="hljs-number">65535</span></span> ) &lt;&lt; <span class="hljs-number"><span class="hljs-number">16</span></span> ); d = ( d &amp; <span class="hljs-number"><span class="hljs-number">65535</span></span> ) * <span class="hljs-number"><span class="hljs-number">1540483477</span></span> + ( ( ( d &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">16</span></span> ) * <span class="hljs-number"><span class="hljs-number">1540483477</span></span> &amp; <span class="hljs-number"><span class="hljs-number">65535</span></span> ) &lt;&lt; <span class="hljs-number"><span class="hljs-number">16</span></span> )^f; c -= <span class="hljs-number"><span class="hljs-number">4</span></span>; ++e } <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>( c ) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>: d ^= ( a.charCodeAt( e + <span class="hljs-number"><span class="hljs-number">2</span></span> ) &amp; <span class="hljs-number"><span class="hljs-number">255</span></span> ) &lt;&lt; <span class="hljs-number"><span class="hljs-number">16</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: d ^= ( a.charCodeAt( e + <span class="hljs-number"><span class="hljs-number">1</span></span> ) &amp; <span class="hljs-number"><span class="hljs-number">255</span></span> ) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: d ^= a.charCodeAt( e ) &amp; <span class="hljs-number"><span class="hljs-number">255</span></span>; d = ( d &amp; <span class="hljs-number"><span class="hljs-number">65535</span></span> ) * <span class="hljs-number"><span class="hljs-number">1540483477</span></span> + ( ( ( d &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">16</span></span> ) * <span class="hljs-number"><span class="hljs-number">1540483477</span></span> &amp; <span class="hljs-number"><span class="hljs-number">65535</span></span> ) &lt;&lt; <span class="hljs-number"><span class="hljs-number">16</span></span> ) } d ^= d &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">13</span></span>; d = ( d &amp; <span class="hljs-number"><span class="hljs-number">65535</span></span> ) * <span class="hljs-number"><span class="hljs-number">1540483477</span></span> + ( ( ( d &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">16</span></span> ) * <span class="hljs-number"><span class="hljs-number">1540483477</span></span> &amp; <span class="hljs-number"><span class="hljs-number">65535</span></span> ) &lt;&lt; <span class="hljs-number"><span class="hljs-number">16</span></span> ); d ^= d &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">15</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> d &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span> }</code> </pre><br><br>  During a call, the following parameters are passed to it: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = poo( addr, <span class="hljs-number"><span class="hljs-number">47</span></span> ).toString( <span class="hljs-number"><span class="hljs-number">16</span></span> );</code> </pre><br><br>  a - this is the ready-made value of the urine parameter (then it is only padded with zeros if it contains less than 8 characters). <br>  addr is our IP address 11.22.33.44. <br>  47 is a constant. <br><br>  Now everything looks clear. <br>  A php bot breaking through this protection should work according to the following algorithm. <br><br>  1. Making a GET request <pre>  http://example.com/index.php </pre>  Set the option to receive response headers: <br><br><pre> <code class="php hljs">curl_setopt( $ch, CURLOPT_HEADER, <span class="hljs-number"><span class="hljs-number">1</span></span> );</code> </pre><br><br>  And at the same time turn on the automatic transition in the case of redirect: <br><br><pre> <code class="php hljs">curl_setopt( $ch, CURLOPT_FOLLOWLOCATION, <span class="hljs-number"><span class="hljs-number">1</span></span> );</code> </pre><br><br>  In this case, curl itself will perform the transition to the new location, and we do not need to program the second request.  And we will get the headers of both responses, the first heading will be the Location, the second - the first cookie containing the request ID. <br><br>  2. Parsing the headers, we get the request ID and your IP address (if we use different tricks, then we may not know it at once, but here we are kindly prompted - it is very convenient). <br>  We consider the urine parameter, write to the cookie and send a new GET request to index.php.  Protection passed. <br><br>  Cook is prescribed as follows: <br><br><pre> <code class="php hljs">$headers = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">"Cookie: "</span></span> . $cookie_str, <span class="hljs-comment"><span class="hljs-comment">// "addr=5678:11.22.33.44; urine=aabbccdd; v=1" /*    / */ ); curl_setopt( $ch, CURLOPT_HTTPHEADER, $headers );</span></span></code> </pre><br><br>  So, there was the final touch - the calculation of urine. <br><br><h4>  Rake </h4><br>  You just need to rewrite the function poo () in php. <br>  To begin with, let's google a bit and write analogs for a pair of js-functions and operators that are not in php: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// php js functions function charCodeAt( $str, $i ) { return ord( substr( $str, $i, 1 ) ); } // char at function charAt( $str, $i ) { return $str{ $i }; } //unsigned shift right (js &gt;&gt;&gt;) function zeroFill( $a, $b ) { $z = hexdec( 80000000 ); if( $z &amp; $a ) { $a = ( $a &gt;&gt; 1 ); $a &amp;= ( ~ $z ); $a |= 0x40000000; $a = ( $a &gt;&gt; ( $b - 1 ) ); } else { $a = ( $a &gt;&gt; $b ); } return $a; }</span></span></code> </pre><br><br>  Now everything is ready, and you can rewrite poo (): <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// function poo( $a, $b ) { $c = strlen( $a ); $d = $b ^ $c; $e = 0; $f = ''; while( $c &gt;= 4 ) { $f = charCodeAt( $a, $e ) &amp; 255 | ( charCodeAt( $a, ++$e ) &amp; 255 ) &lt;&lt; 8 | ( charCodeAt( $a, ++$e ) &amp; 255 ) &lt;&lt; 16 | ( charCodeAt( $a, ++$e ) &amp; 255 ) &lt;&lt; 24; $f = ( $f &amp; 65535 ) * 1540483477 + ( ( ( zeroFill( $f, 16 ) ) * 1540483477 &amp; 65535 ) &lt;&lt; 16 ); $f ^= zeroFill( $f, 24 ); $f = ( $f &amp; 65535 ) * 1540483477 + ( ( ( zeroFill( $f, 16 ) ) * 1540483477 &amp; 65535 ) &lt;&lt; 16 ); $d = ( $d &amp; 65535 ) * 1540483477 + ( ( ( zeroFill( $d, 16 ) ) * 1540483477 &amp; 65535 ) &lt;&lt; 16 )^$f; $c -= 4; ++$e; } switch( $c ) { case 3: $d ^= ( charCodeAt( $a, $e + 2 ) &amp; 255 ) &lt;&lt; 16; case 2: $d ^= ( charCodeAt( $a, $e + 1 ) &amp; 255 ) &lt;&lt; 8; case 1: $d ^= charCodeAt( $a, $e ) &amp; 255; $d = ( $d &amp; 65535 ) * 1540483477 + ( ( ( zeroFill( $d, 16 ) ) * 1540483477 &amp; 65535 ) &lt;&lt; 16 ); } $d ^= zeroFill( $d, 13 ); $d = ( $d &amp; 65535 ) * 1540483477 + ( ( ( zeroFill( $d, 16 ) ) * 1540483477 &amp; 65535 ) &lt;&lt; 16 ); $d ^= zeroFill( $d, 15 ); return zeroFill( $d, 0 ); }</span></span></code> </pre><br><br>  Save, run and break off - the results of js and php versions do not match. <br>  What's the matter? <br>  Add the code in js and php to display the result after each line of calculations and see what it is. <br><br>  It turns out that simple arithmetic operators php, unlike javascript, do not work well with large numbers. <br><br>  For example, the expression <br><br><pre> <code class="javascript hljs">( <span class="hljs-number"><span class="hljs-number">18220025198660</span></span> &amp; <span class="hljs-number"><span class="hljs-number">65535</span></span> ) * <span class="hljs-number"><span class="hljs-number">1540483477</span></span> + ( ( ( <span class="hljs-number"><span class="hljs-number">18220025198660</span></span> &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">16</span></span> ) * <span class="hljs-number"><span class="hljs-number">1540483477</span></span> &amp; <span class="hljs-number"><span class="hljs-number">65535</span></span> ) &lt;&lt; <span class="hljs-number"><span class="hljs-number">16</span></span> );</code> </pre><br><br>  in javascript will be equal to 221886241596 <b>36</b> , and similar in php <br><br><pre> <code class="php hljs">( <span class="hljs-number"><span class="hljs-number">18220025198660</span></span> &amp; <span class="hljs-number"><span class="hljs-number">65535</span></span> ) * <span class="hljs-number"><span class="hljs-number">1540483477</span></span> + ( ( ( zeroFill( <span class="hljs-number"><span class="hljs-number">18220025198660</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span> ) ) * <span class="hljs-number"><span class="hljs-number">1540483477</span></span> &amp; <span class="hljs-number"><span class="hljs-number">65535</span></span> ) &lt;&lt; <span class="hljs-number"><span class="hljs-number">16</span></span> )</code> </pre><br><br>  will be equal to a slightly different number 221886241596 <b>00</b> <br><br>  When several similar formulas are calculated in a row, the error accumulates, giving a completely different result.  In some php expressions, by default, the result is that the type is int and limits the maximum value to 4 billion (on 32-bit systems). <br><br>  Perl has similar problems with large numbers. <br><br>  For accurate calculations in php, you must use the functions of the BC Math library.  At the same time, you need to add a cast to the float type. <br><br>  As a result of trial and error, we get code that gives the same results as javascript.  But this requires additional time and effort. <br>  The code is not the most optimal, for greater clarity, calculations are performed in steps. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// function poo( $a, $b ) { $c = strlen( $a ); $d = $b ^ $c; $e = 0; $f = ''; while( $c &gt;= 4 ) { $f = charCodeAt( $a, $e ) &amp; 255 | ( charCodeAt( $a, ++$e ) &amp; 255 ) &lt;&lt; 8 | ( charCodeAt( $a, ++$e ) &amp; 255 ) &lt;&lt; 16 | ( charCodeAt( $a, ++$e ) &amp; 255 ) &lt;&lt; 24; $f = bcadd( bcmul( $f &amp; 65535, 1540483477 ), ( floatval( ( bcmul( ( zeroFill( $f, 16 ) ), ( 1540483477 &amp; 65535 ) ) ) ) &lt;&lt; 16 ) ); $xx = zeroFill( $f, 24 ); $f = floatval( $f ) ^ floatval( $xx ); // $f = floatval( $f ); $f1 = bcmul( $f &amp; 65535, 1540483477 ); $f2 = ( floatval( ( bcmul( ( zeroFill( $f, 16 ) ), ( 1540483477 &amp; 65535 ) ) ) ) &lt;&lt; 16 ); $f = bcadd( $f1, $f2 ); $d1 = bcmul( $d &amp; 65535, 1540483477 ); $d2 = ( floatval( ( bcmul( ( zeroFill( $d, 16 ) ), ( 1540483477 &amp; 65535 ) ) ) ) &lt;&lt; 16 ); $d = bcadd( $d1, $d2 ); $d = floatval( $d ) ^ floatval( $f ); $c -= 4; ++$e; } switch( $c ) { case 3: $d = floatval( $d ) ^ ( ( charCodeAt( $a, $e + 2 ) &amp; 255 ) &lt;&lt; 16 ); case 2: $d = floatval( $d ) ^ ( ( charCodeAt( $a, $e + 1 ) &amp; 255 ) &lt;&lt; 8 ); case 1: $d = floatval( $d ) ^ ( charCodeAt( $a, $e ) &amp; 255 ); $d1 = bcmul( $d &amp; 65535, 1540483477 ); $d2 = ( floatval( ( bcmul( ( zeroFill( $d, 16 ) ), ( 1540483477 &amp; 65535 ) ) ) ) &lt;&lt; 16 ); $d = bcadd( $d1, $d2 ); } $d = floatval( $d ) ^ zeroFill( $d, 13 ); $d1 = bcmul( floatval( floatval( $d ) &amp; 65535 ), 1540483477 ); $dd21 = zeroFill( $d, 16 ); $dd22 = floatval( bcmul( $dd21, 1540483477 &amp; 65535 ) ); $dd23 = floatval( $dd22 &lt;&lt; 16 ); $d2 = $dd23; $d = bcadd( $d1, $d2 ); $d = floatval( $d ) ^ zeroFill( $d, 15 ); if( $d &lt; 0 ) { $res = bindec( decbin( ~0 ) ) - abs( $d ) + 1; } else { $res = $d; } return $res; }</span></span></code> </pre><br><br>  And for the zeroFill () function, we add to the very beginning: <br><br><pre> <code class="php hljs">$a = floatval( $a );</code> </pre><br><br><h4>  Conclusion </h4><br>  My bots have done their job, and you can use the protection described here for your own purposes.  If you modify it, for example, dynamically changing the code making the computation, then such a hacking will become an even more difficult task.  And if no one wants to take you seriously, this protection will be enough. <br><br>  In general, the best protection against bots is a captcha.  Even the most cunning javascript can be executed by bots using something like the <a href="http://search.cpan.org/~corion/WWW-Mechanize-Firefox-0.58/">Mechanize</a> Perl module. </div><p>Source: <a href="https://habr.com/ru/post/137961/">https://habr.com/ru/post/137961/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../137952/index.html">Welcome to the Quality Assurance Day conference.</a></li>
<li><a href="../137953/index.html">Household appliances interfaces are 20 years behind</a></li>
<li><a href="../137955/index.html">Payment interface, as a direct communication channel with developers</a></li>
<li><a href="../137956/index.html">Tighten the TCP / IP nuts on Solaris</a></li>
<li><a href="../137960/index.html">Some details about Class Based Views, part 4</a></li>
<li><a href="../137962/index.html">How to buy low customer loyalty?</a></li>
<li><a href="../137963/index.html">We communicate with the SIM card at a low level</a></li>
<li><a href="../137964/index.html">Free xml-source of cash exchange rates, as well as 3 convenient updates from the portal FINANCE.UA</a></li>
<li><a href="../137966/index.html">Filtering Input Characters in Ext.form.field.Number</a></li>
<li><a href="../137968/index.html">Joint promotion of Vodafone AU and Dropbox. + 2GB for your account</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>