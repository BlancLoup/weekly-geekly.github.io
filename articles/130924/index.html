<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Get configuration version 1c directly from SQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On duty, our office serves several organizations that use 1c for management and accounting. 
 1c, as is known, constantly releases updates for its con...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Get configuration version 1c directly from SQL</h1><div class="post__text post__text-html js-mediator-article">  On duty, our office serves several organizations that use 1c for management and accounting. <br>  1c, as is known, constantly releases updates for its configurations. <br>  Accordingly, updating at least 5 bases takes a decent amount of time. <br>  The story of how to achieve complete (except for downloading updates) process automation with MSSQL tools below. <br><a name="habracut"></a><br><br>  Automate the process start from the "end" <br><br>  In 1c there is a command line: <a href="http://www.script-coding.com/v8/v8_CmdPrmpt.html">but its parameters</a> <br>  The catch is as follows: <br><ul><li>  In 1c update is possible only from a specific version to a specific one.  This is due to the fact that the update files are not delivered in the form of a full "cast" configuration.  And in the form of changes from the reference version. </li><li>  Also in the 1c code itself there are predefined treatments that run when switching from one version to another. </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So we need to get the current version of 1c. <br>  There is of course the option of using 1c-COMConnector, which establishes the connection for at least 2 seconds, ‚ÄúEats‚Äù an extra license, memory, and drinks my coffee. <br>  I went the other way.  In versions 1c&gt; 8.0 there is no database directory, therefore, the MSSQL database stores everything. <br>  In database tables there is a _config table, and in it there is a line with FileName = root.  Look at the contents (Binary Data): <br> <code>{2,e0666db2-45d6-49b4-a200-061c6ba7d569}</code> <br>  <i>Content is stored in compressed form.</i>  <i>Below is an example of unpacking it.</i> <br>  By the method of scientific spear we find the same table there is an entry with FileName = e0666db2-45d6-49b4-a200-061c6ba7d569 (the same identifier): <br> <code>{2, <br> {1e4190e9-76c2-456e-a607-4d817110ffd9},6, <br> {9cd510cd-abfc-11d4-9434-004095e12fc7, <br> {1, <br> {36, <br> {0, <br> {0, <br> {0,3,6b021b70-482d-4baf-b590-b86b68d4730e},"", <br> {1,"ru","   ,  2.5"},""} <br> },"",1, <br> {1,"ru","   ,  2.5"}, <br> {1,"ru","   ,  2.5"}, <br> {1,"ru","Copyright ()  ""1C"", 2007-2011.   "}, <br> {1,"ru","http://www.1c.ru"}, <br> {1,"ru","http://v8.1c.ru/hrm/"},72ef09b4-4393-4d23-a530-7e5b50cf1d24,31e2aa98-4a9c-4d99-a3e7-540a13396b8c,1e7940af-fba5-46c3-8ffb-e8389ac2b79f,87090b31-2cd0-4b45-8b24-efdb2383b1a2,1," ""1""","2.5.40.3","http://downloads.v8.1c.ru/tmplts/",1,</code> <br>  <i>(only the most interesting part of the file is shown)</i> <br><br>  You probably guessed what this 1c configuration is. <br>  Now you need to explain this to MS SQL. <br>  In c #, I wrote a class: <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.IO; namespace metadata { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> v8metadata { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] array_data; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> v8metadata[] child; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> v8metadata parent; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string filename; private Decoder d; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> v8metadata(MemoryStream ms, string file_name, v8metadata p,Decoder <span class="hljs-type"><span class="hljs-type">dec</span></span>) { d = <span class="hljs-type"><span class="hljs-type">dec</span></span>; filename = file_name; array_data = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; child = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> v8metadata[<span class="hljs-number"><span class="hljs-number">0</span></span>]; parent = p; parse_ms(ms, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } //     MD  <span class="hljs-number"><span class="hljs-number">1</span></span>  <span class="hljs-number"><span class="hljs-number">7.7</span></span> //     <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> v8metadata(MemoryStream ms, string file_name,Decoder <span class="hljs-type"><span class="hljs-type">dec</span></span>) { d = <span class="hljs-type"><span class="hljs-type">dec</span></span>; filename = file_name; array_data = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; child = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> v8metadata[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) ms.Position = <span class="hljs-number"><span class="hljs-number">0</span></span>; parse_ms(ms); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> v8metadata(MemoryStream ms, string file_name) { d = <span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8.GetDecoder(); filename = file_name; array_data = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; child = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> v8metadata[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) ms.Position = <span class="hljs-number"><span class="hljs-number">0</span></span>; parse_ms(ms); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-type"><span class="hljs-type">int</span></span> pos) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> array_data[pos]; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(string descr) { string res = "error wrong param"; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (descr == "version") try { res = ((v8metadata)(((v8metadata)(((v8metadata)(this.array_data[<span class="hljs-number"><span class="hljs-number">3</span></span>])).array_data[<span class="hljs-number"><span class="hljs-number">1</span></span>])).array_data[<span class="hljs-number"><span class="hljs-number">1</span></span>])).array_data[<span class="hljs-number"><span class="hljs-number">15</span></span>].ToString(); } catch { res = ""; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (descr == "vendor") res = ((v8metadata)(((v8metadata)(((v8metadata)(this.array_data[<span class="hljs-number"><span class="hljs-number">3</span></span>])).array_data[<span class="hljs-number"><span class="hljs-number">1</span></span>])).array_data[<span class="hljs-number"><span class="hljs-number">1</span></span>])).array_data[<span class="hljs-number"><span class="hljs-number">14</span></span>].ToString(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (descr == "conf") res = ((v8metadata)(((v8metadata)(((v8metadata)(((v8metadata)(((v8metadata)(this.array_data[<span class="hljs-number"><span class="hljs-number">3</span></span>])).array_data[<span class="hljs-number"><span class="hljs-number">1</span></span>])).array_data[<span class="hljs-number"><span class="hljs-number">1</span></span>])).array_data[<span class="hljs-number"><span class="hljs-number">1</span></span>])).array_data[<span class="hljs-number"><span class="hljs-number">1</span></span>])).array_data[<span class="hljs-number"><span class="hljs-number">2</span></span>].ToString(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((res.Substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) == "\"") &amp;&amp; (res.Substring(res.Length - 1) == "\"")) { res = res.Substring(<span class="hljs-number"><span class="hljs-number">1</span></span>); res = res.Substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, res.Length - <span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.Replace("\"\"", "\""); } public string ToStr(string lev) { string ret = ""; for (int i = 0; i &lt; this.array_data.Length; i++) { ret = ret+ lev +"_" + i.ToString() + ":"; if (this.array_data[i].GetType().FullName == "<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.String") ret = ret + " " + this.array_data[i].ToString() + @" "; else ret = ret + ((v8metadata)this.array_data[i]).ToStr(lev + "_" + i.ToString()) + @" "; } return ret; } private void parse_ms(MemoryStream ms) { parse_ms(ms, false); } private int parse_ms(MemoryStream ms, Boolean findbegin) { int cur; byte[] bytedata = new byte[0]; //for (int i = Convert.ToInt16(ms.Position); i &lt; ms.Length; i++) while (ms.Position &lt; ms.Length) { cur = ms.ReadByte(); //  if (cur == 13) { cur = ms.ReadByte(); if (cur == 10) continue; else { Addtoarraybyte(ref bytedata, 13); Addtoarraybyte(ref bytedata, cur); } } if (cur == 123) { if (findbegin) { adddata(bytedata); adddata(new v8metadata(ms, filename, this,d)); } else { findbegin = true; bytedata = new byte[0]; } continue; } if (cur == 44) { // adddata(bytedata); bytedata = new byte[0]; continue; } if (cur == 125) break; Addtoarraybyte(ref bytedata, cur); } adddata(bytedata); return 0; } private static void Addtoarraybyte(ref byte[] arr, int val) { byte[] tmp = new byte[arr.Length + 1]; Array.Copy(arr, 0, tmp, 0, arr.Length); arr = tmp; arr[arr.Length - 1] = Convert.ToByte(val); } private void adddata(byte[] bytedata) { if (bytedata.Length == 0) return; char[] cs = new char[d.GetCharCount(bytedata, 0, bytedata.Length)]; d.GetChars(bytedata, 0, bytedata.Length, cs, 0); //  string a_data = new string(cs); object[] tmp = new object[array_data.Length + 1]; Array.Copy(array_data, 0, tmp, 0, array_data.Length); array_data = tmp; array_data[array_data.Length - 1] = a_data; } private void adddata(v8metadata childdata) { object[] tmp = new object[array_data.Length + 1]; Array.Copy(array_data, 0, tmp, 0, array_data.Length); array_data = tmp; array_data[array_data.Length - 1] = childdata; addv8metadata(childdata); } private void addv8metadata(v8metadata childdata) { v8metadata[] tmp1 = new v8metadata[child.Length + 1]; Array.Copy(child, 0, tmp1, 0, child.Length); child = tmp1; child[child.Length - 1] = childdata; } } }</code> </pre><br><br>  When creating a class, pass the MemoryStream binary data from the _config table. <br>  As you can see in the code, they can parse and configuration 7.7, before unpacking <br><br>  Now you can get to the configuration version by knowing its ‚Äúaddress‚Äù: Next, just create an empty database with the ‚ÄúVERSION‚Äù version and find its ‚Äúaddress‚Äù (v8metadata) (((v8metadata) (((v8metadata)) (this.array_data [3]) ) .array_data [1])). array_data [1])). array_data [15] .ToString (); <br><br>  "Binding" class: <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Data.SqlClient; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.IO.Compression; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.IO; namespace metadata { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> v8config { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> SqlConnection con; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string rootfile; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string platform; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string vendor; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string conf; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> v8metadata v8; private string db; private string <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> = ""; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> v8config(string constring) { con = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SqlConnection(constring); db = con.<span class="hljs-keyword"><span class="hljs-keyword">Database</span></span>; MemoryStream ms = file_data("root"); v8metadata v82 = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> v8metadata(ms, "root"); rootfile = v82.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v82.array_data.Length &gt; <span class="hljs-number"><span class="hljs-number">2</span></span>) platform = "8.2"; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> platform = "8.1"; update_prop(); } //  linked  <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> v8config(SqlConnection conn, string srv, string <span class="hljs-keyword"><span class="hljs-keyword">database</span></span>) { con = conn; <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> = srv; db = <span class="hljs-keyword"><span class="hljs-keyword">database</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (check_is_v8()) { MemoryStream ms = file_data("root"); v8metadata v82 = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> v8metadata(ms, "root"); rootfile = v82.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v82.array_data.Length == <span class="hljs-number"><span class="hljs-number">3</span></span>) platform = "8.2"; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v82.array_data.Length &gt; <span class="hljs-number"><span class="hljs-number">3</span></span>) { platform = "8.0"; rootfile = "root"; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> platform = "8.1"; update_prop(); } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> v8config(SqlConnection conn) { con = conn; db = con.<span class="hljs-keyword"><span class="hljs-keyword">Database</span></span>; MemoryStream ms = file_data("root"); v8metadata v82 = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> v8metadata(ms, "root"); rootfile = v82.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(); update_prop(); } //,  ,   private <span class="hljs-type"><span class="hljs-type">void</span></span> update_prop() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (platform != "8.0") { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v8 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { v8 = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> v8metadata(file_data(rootfile), rootfile); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (((v8metadata)(((v8metadata)(((v8metadata)(v8.array_data[<span class="hljs-number"><span class="hljs-number">3</span></span>])).array_data[<span class="hljs-number"><span class="hljs-number">1</span></span>])).array_data[<span class="hljs-number"><span class="hljs-number">1</span></span>])).array_data.Length &gt; <span class="hljs-number"><span class="hljs-number">20</span></span>) platform = "8.2"; vendor = v8.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("vendor"); conf = v8.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("conf"); version = v8.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("version"); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { vendor = "  "; conf = "  "; version = "  "; } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> SaveToFile(string file, string filename) { FileStream fs = File.OpenWrite(filename); MemoryStream ms = file_data(file); byte[] data = ms.ToArray(); fs.<span class="hljs-keyword"><span class="hljs-keyword">Write</span></span>(data, <span class="hljs-number"><span class="hljs-number">0</span></span>, data.Length); } private <span class="hljs-type"><span class="hljs-type">bool</span></span> check_is_v8() { try { <span class="hljs-type"><span class="hljs-type">bool</span></span> doopencon = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; SqlCommand cmdu1; <span class="hljs-type"><span class="hljs-type">bool</span></span> haslinked = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (con.State != <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Data.ConnectionState.<span class="hljs-keyword"><span class="hljs-keyword">Open</span></span>) { con.<span class="hljs-keyword"><span class="hljs-keyword">Open</span></span>(); doopencon = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } cmdu1 = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SqlCommand("", con); cmdu1.CommandText = "select name from [" + <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> + "].[master].dbo.sysdatabases where name='" + db + "'"; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmdu1.ExecuteScalar() == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { haslinked = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!haslinked) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (doopencon) con.<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } cmdu1.CommandText = "select name from [" + <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> + "]." + db + ".dbo.sysobjects where name ='config'"; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmdu1.ExecuteScalar() == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { haslinked = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (doopencon) con.<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> haslinked; } catch { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } } private MemoryStream file_data(string <span class="hljs-type"><span class="hljs-type">name</span></span>) { MemoryStream ms = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> MemoryStream(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (con.State != <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Data.ConnectionState.<span class="hljs-keyword"><span class="hljs-keyword">Open</span></span>) con.<span class="hljs-keyword"><span class="hljs-keyword">Open</span></span>(); string <span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> != "") <span class="hljs-keyword"><span class="hljs-keyword">sql</span></span> = "select BinaryData from [" + <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> + "].[" + db + "].dbo.Config where [filename]='" + <span class="hljs-type"><span class="hljs-type">name</span></span> + "'"; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sql</span></span> = "select BinaryData from [" + db + "].dbo.Config where [filename]='" + <span class="hljs-type"><span class="hljs-type">name</span></span> + "'"; SqlCommand cmdu1 = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SqlCommand(<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>, con); cmdu1.CommandTimeout = <span class="hljs-number"><span class="hljs-number">200</span></span>; SqlDataReader rs = cmdu1.ExecuteReader(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rs.<span class="hljs-keyword"><span class="hljs-keyword">Read</span></span>()) { DeflateStream dfs = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> DeflateStream(rs.GetSqlBytes(<span class="hljs-number"><span class="hljs-number">0</span></span>).Stream, CompressionMode.Decompress); byte[] BufferOut = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> byte[<span class="hljs-number"><span class="hljs-number">100</span></span>]; <span class="hljs-type"><span class="hljs-type">int</span></span> BytesRead; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((BytesRead = dfs.<span class="hljs-keyword"><span class="hljs-keyword">Read</span></span>(BufferOut, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>)) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) ms.<span class="hljs-keyword"><span class="hljs-keyword">Write</span></span>(BufferOut, <span class="hljs-number"><span class="hljs-number">0</span></span>, BytesRead); dfs.<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>(); } con.<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ms; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(string descr) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rootfile == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> "     1 v8"; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v8 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { v8 = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> v8metadata(file_data(rootfile), rootfile); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (descr == "test") { string fname = ((v8metadata)(((v8metadata)(((v8metadata)(v8.array_data[<span class="hljs-number"><span class="hljs-number">4</span></span>])).array_data[<span class="hljs-number"><span class="hljs-number">2</span></span>])).array_data[<span class="hljs-number"><span class="hljs-number">2</span></span>])).array_data[<span class="hljs-number"><span class="hljs-number">3</span></span>].ToString() + ".5"; MemoryStream ms = this.file_data(fname); v8metadata nv8 = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> v8metadata(ms, fname); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> "test"; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> v8.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(descr); } } }</code> </pre><br>  Usage: <br><pre> <code class="hljs cs"> v8config v8 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> v8config(<span class="hljs-string"><span class="hljs-string">"server=;database=;uid=sa;pwd=;Connection Timeout=300;"</span></span>); v8.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"version"</span></span>);</code> </pre> <br><br>  But where is MSSQL here? <br>  Here is the CLR function that will receive this data in MSSQL itself: <br>  <i>We have a separate database that stores the server and database.</i>  <i>Accordingly, the function is adapted to this.</i> <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Collections; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Data; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Data.<span class="hljs-keyword"><span class="hljs-keyword">Sql</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Data.SqlClient; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Data.SqlTypes; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.SqlServer.<span class="hljs-keyword"><span class="hljs-keyword">Server</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> partial <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> _1c_conf_functions { [SqlFunction(DataAccess = DataAccessKind.<span class="hljs-keyword"><span class="hljs-keyword">Read</span></span>, FillRowMethodName = "FillRowConfig", TableDefinition = "[platform] nvarchar(5),vendor nvarchar(150),conf nvarchar(250),version nvarchar(100)")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static IEnumerable v8getconfig(string srv, string dbs) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (SqlConnection conn = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SqlConnection("context connection=true")) { metadata.v8config v8 = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> metadata.v8config(conn, srv, dbs); metadata.v8config[] t = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> metadata.v8config[<span class="hljs-number"><span class="hljs-number">1</span></span>]; t[<span class="hljs-number"><span class="hljs-number">0</span></span>] = v8; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> t; } //v8metadata.v8_confmanager vconf = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> v8metadata.v8_confmanager(@"\\ackiy_gw\public\1c_distr\tmplts_8.1"); //<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> vconf.find_config(" \"<span class="hljs-number"><span class="hljs-number">1</span></span>\"", "").data; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">void</span></span> FillRowConfig(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> obj, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> SqlChars platform, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> SqlChars vendor, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> SqlChars conf, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> SqlChars <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>) { // dateupdate = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SqlDateTime(((v8metadata.v8info)obj).dataupdate); metadata.v8config cfg = (metadata.v8config)obj; platform = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SqlChars(cfg.platform); vendor = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SqlChars(cfg.vendor); conf = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SqlChars(cfg.conf); version = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SqlChars(cfg.<span class="hljs-keyword"><span class="hljs-keyword">version</span></span>); } };</code> </pre><br><br>  And how to determine which update is needed for this 1c configuration? <br>  When installing update 1c, you can use the update directory on the server.  Each update has a .mft file of the form: <br> <code>Vendor= "1" <br> Name= <br> Version=2.0.25.5 <br> AppVersion=8.2 <br> ........</code> <br> <br>  And the file UpdInfo.txt <br> <code>Version=2.0.25.5 <br> FromVersions=;2.0.24.10; <br> UpdateDate=11.07.2011</code> <br> <br>  That's all we need !!! <br>  Knowing FromVersions and the release date of the update, we can automatically generate a string to run the 1c update.  (link to the parameters at the beginning of the topic) <br><br>  But there is another problem - the presence of users in the database.  1c is not updated.  We write "expulsion" of users (vbscript) <br><br><pre> <code class="hljs vhdl"><span class="hljs-symbol"><span class="hljs-symbol">'basename</span></span>-     <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'updateway</span></span> -     <span class="hljs-symbol"><span class="hljs-symbol">'platform</span></span> -  <span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-number"><span class="hljs-number">8.1</span></span>/<span class="hljs-number"><span class="hljs-number">8.2</span></span>) <span class="hljs-symbol"><span class="hljs-symbol">'srv1c</span></span> -  <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'srvUser</span></span> -      <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'srvPasswd</span></span>-       <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'confchanged</span></span> -  -  .      <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> GetUpdateForConfig(basename,updateway,platform,srv1c,srvUser,srvPasswd,baseUsr,basepwd,confchanged) allowdisconnect=<span class="hljs-literal"><span class="hljs-literal">false</span></span> '    <span class="hljs-number"><span class="hljs-number">12</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  -     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Hour(now())&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> Hour(now)&lt;<span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> allowdisconnect=<span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> set Connector=CreateObject(<span class="hljs-string"><span class="hljs-string">"V"</span></span> &amp; Replace(platform,<span class="hljs-string"><span class="hljs-string">"."</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>) &amp; +<span class="hljs-string"><span class="hljs-string">".ComConnector"</span></span>) set AgentConnection=Connector.ConnectAgent(srv1c) set Cluster=AgentConnection.GetClusters() (<span class="hljs-number"><span class="hljs-number">0</span></span>) AgentConnection.Authenticate Cluster,srvUser,srvPasswd <span class="hljs-symbol"><span class="hljs-symbol">'WorkingProcess</span></span> = AgentConnection.GetWorkingProcesses(Cluster)[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">Process</span></span> = AgentConnection.GetWorkingProcesses(Cluster) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> each WorkingProcess <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Process</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> WorkingProcess.Running&lt;&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ConnectString = WorkingProcess.HostName &amp; <span class="hljs-string"><span class="hljs-string">":"</span></span> &amp; WorkingProcess.MainPort set WorkingProcessConnection = Connector.ConnectWorkingProcess(<span class="hljs-string"><span class="hljs-string">"tcp://"</span></span> &amp; ConnectString) WorkingProcessConnection.AddAuthentication baseUsr,basepwd set ibDesc = WorkingProcessConnection.CreateInfoBaseInfo() ibDesc.Name = basename Connections = WorkingProcessConnection.GetInfoBaseConnections(ibDesc) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> each Connection <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Connections <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> LCase(Connection.AppID) &lt;&gt; <span class="hljs-string"><span class="hljs-string">"comconsole"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> allowdisconnect <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> WorkingProcessConnection.<span class="hljs-keyword"><span class="hljs-keyword">Disconnect</span></span> Connection ShowStatus <span class="hljs-string"><span class="hljs-string">"Discconnect  "</span></span> &amp; Trim(Connection.ConnID),<span class="hljs-literal"><span class="hljs-literal">true</span></span>,<span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> ShowStatus <span class="hljs-string"><span class="hljs-string">"  ."</span></span>,<span class="hljs-literal"><span class="hljs-literal">false</span></span>,<span class="hljs-literal"><span class="hljs-literal">false</span></span> GetUpdateForConfig=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span> ShowStatus <span class="hljs-string"><span class="hljs-string">"  "</span></span> &amp; updateway,<span class="hljs-literal"><span class="hljs-literal">true</span></span>,<span class="hljs-literal"><span class="hljs-literal">false</span></span> ProcId=<span class="hljs-number"><span class="hljs-number">0</span></span> constr=<span class="hljs-string"><span class="hljs-string">"/S"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span> &amp; srv1c &amp; <span class="hljs-string"><span class="hljs-string">"\" &amp; basename &amp; "</span></span><span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">" if baseUsr&lt;&gt;"</span></span><span class="hljs-string"><span class="hljs-string">" then constr=constr &amp; "</span></span> /N<span class="hljs-string"><span class="hljs-string">" &amp; baseUsr &amp; "</span></span> /P<span class="hljs-string"><span class="hljs-string">" &amp; basepwd end if if not confchanged then constr=constr &amp; "</span></span> /UpdateCfg<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">" &amp; updateway &amp; "</span></span><span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">" end if constr=constr &amp; "</span></span> /UpdateDBCfg<span class="hljs-string"><span class="hljs-string">" if Way1cv81="</span></span><span class="hljs-string"><span class="hljs-string">" then ShowStatus "</span></span>    <span class="hljs-number"><span class="hljs-number">81</span></span><span class="hljs-string"><span class="hljs-string">",true,true GetUpdateForConfig="</span></span><span class="hljs-string"><span class="hljs-string">" Exit function End if RunString="</span></span><span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">" &amp; Way1cv81 &amp; "</span></span><span class="hljs-number"><span class="hljs-number">1</span></span>cv8.exe<span class="hljs-string"><span class="hljs-string">""</span></span> CONFIG <span class="hljs-string"><span class="hljs-string">" &amp; constr &amp; "</span></span><span class="hljs-string"><span class="hljs-string">" Resfile=WorkCatalog() &amp; "</span></span>result.txt<span class="hljs-string"><span class="hljs-string">" RunString=RunString &amp; "</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">Out</span></span><span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">" &amp; Resfile &amp; "</span></span><span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">" ShowStatus "</span></span> : <span class="hljs-string"><span class="hljs-string">" &amp; RunString,true,false CreateProcess RunString,true GetUpdateForConfig=ReadFileText(Resfile) End Function</span></span></code> </pre><br>  It remains only to add a puzzle. </div><p>Source: <a href="https://habr.com/ru/post/130924/">https://habr.com/ru/post/130924/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../130918/index.html">Rules of communication with speech recognition systems</a></li>
<li><a href="../130919/index.html">Backup solution from Cloud4Y</a></li>
<li><a href="../130920/index.html">Internet voting on html</a></li>
<li><a href="../130921/index.html">About danger and security in Cisco networks</a></li>
<li><a href="../130923/index.html">Writing a console translator for * nix in Python</a></li>
<li><a href="../130925/index.html">Work with contact photos in android 2.1+</a></li>
<li><a href="../130926/index.html">Remote Access with Dynamic IP or Configure DynDNS in Linux</a></li>
<li><a href="../130928/index.html">In Tatarstan, chop air optics</a></li>
<li><a href="../130930/index.html">Seagate GoFlex Satellite: Wireless Winchester for iPad and more</a></li>
<li><a href="../130931/index.html">Google AI Challenge. How to write your bot. Part 1, 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>