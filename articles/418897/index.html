<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CRDT: Conflict-free Replicated Data Types</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How to count hits of the google.com page? And how to store the likes of very popular users? This article proposes to consider solving these tasks usin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CRDT: Conflict-free Replicated Data Types</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/r1/we/lm/r1welma_rgaxinwrbp7ekni1tdo.png"></div><br>  How to count hits of the google.com page?  And how to store the likes of very popular users?  This article proposes to consider solving these tasks using CRDT (Conflict-free Replicated Data Types, which translates roughly as Conflict-Free Replicated Data Types), and more generally, replica synchronization tasks in a distributed system with several leading nodes. <br><a name="habracut"></a><br><h1>  1. Introduction </h1><br>  We have long been accustomed to using applications such as a calendar or note-type service like Evernote.  They are united by the fact that they allow working offline, from several devices and several people at the same time (on the same data).  The challenge facing the developers of each such application is how to ensure the most ‚Äúsmooth‚Äù synchronization of data changed simultaneously on several devices.  Ideally, user participation should not be required at all to resolve merge conflicts. <br><br>  In the <a href="https://habr.com/post/416961/">previous article</a> , an approach for solving such problems was considered - Operational Transformation, here a very similar method will be described, which has both advantages and disadvantages (for example, CRDT for JSON has not yet been invented. Upd: Thanks to the user <a href="https://habr.com/users/msvn/" class="user_link">msvn</a> for the link, <a href="https://github.com/automerge/automerge">here is a</a> project from the authors of a research article on JSON implementation in CRDT) <br><br><h1>  2. Strong eventual consistency </h1><br>  Recently, a lot of work has been written and a lot of research has been done in the field of eventual consistency.  In my opinion, now there is a strong trend to shift from strong consistency to various consistency options, to research what consistency in which situations / systems it is more advantageous to apply, to rethink existing definitions.  This leads to some confusion, for example, when the authors of some works, arguing about consistency, mean eventual consistency with some additional property, while other authors use certain terminology for this. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The question raised by the authors of one of the articles criticizes the current definition of eventual consistency: according to him, if your system always responds to all requests with the answer "42", then everything is OK, it will eventually be consistent. <br><br>  Without disturbing the correctness of this article, I, following the authors of the original articles, will use the following terminology (please note, these are not strict definitions, these are differences): <br><br><ul><li>  Strong consistency (SC): all write operations are strictly ordered, the read request on any replica returns the same, last recorded result.  <b>Real time</b> consensus is needed to resolve conflicts (with ensuing consequences), withstand a drop to n / 2 - 1 node. </li><li>  Eventual consistency (EC): update the data locally, send the update further.  Reading on different replicas can return stale data.  In case of conflicts, either roll back or somehow decide what to do.  So  consensus is still needed, but <b>not in real time</b> . </li><li>  Strong eventual consistency (SEC): EC + for conflict resolution replicas have a predefined algorithm.  So  <b>no consensus is needed</b> , withstand drops to n - 1 nodes. </li></ul><br>  Note that SEC (as it were) solves the problem of the CAP theorem: all three properties are satisfied. <br><br>  So, we are ready to sacrifice SC and want to have a certain set of basic data types for our potentially unstable distributed system that will automatically resolve recording conflicts for us (no user interaction or a request to an arbiter is required) <br><br><h1>  3. Tasks about likes and hits </h1><br>  Undoubtedly, there are several algorithms for solving such problems.  CRDT offers a rather elegant and easy way. <br><br><h3>  Google.com hits count: </h3><br>  google.com processes approximately 150,000 requests per second from all points of the planet.  Obviously, the counter needs to be updated asynchronously.  Queues solve a problem partially - for example, if we provide an external API to get this value, then we will have to do replication in order not to put the repository with read requests.  And if you already have replication, can it be possible without global queues? <br><br><div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/wv/4y/tn/wv4ytnmej1xm2tbhen3ddztgv6w.png" alt="image"></div><br><br><h3>  User likes count: </h3><br>  The task is very similar to the previous one, but now you need to count unique hits. <br><br><h1>  4. Terminology </h1><br>  For a more complete understanding of the article, you need to know about the following terms: <br><br><ol><li>  <a href="https://ru.wikipedia.org/wiki/%25D0%2598%25D0%25B4%25D0%25B5%25D0%25BC%25D0%25BF%25D0%25BE%25D1%2582%25D0%25B5%25D0%25BD%25D1%2582%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C">Idempotency</a> <br>  Says that the use of the operation several times does not change the result. <br>  Examples - GET operation or addition with zero: <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-1"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-2"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f </font></font></span><span class="MJXp-mo" id="MJXp-Span-3" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-4"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x </font></font></span><span class="MJXp-mo" id="MJXp-Span-5" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class="MJXp-mo" id="MJXp-Span-6" style="margin-left: 0.333em; margin-right: 0.333em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-7"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x </font></font></span><span class="MJXp-mo" id="MJXp-Span-8" style="margin-left: 0.267em; margin-right: 0.267em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ </font></font></span><span class="MJXp-mn" id="MJXp-Span-9"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></span></span></span><span class="MathJax_SVG MathJax_SVG_Processed" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="12.849ex" height="2.66ex" viewBox="0 -832 5532 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-66" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMAIN-28" x="550" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-78" x="940" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMAIN-29" x="1512" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMAIN-3D" x="2179" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-78" x="3236" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMAIN-2B" x="4030" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMAIN-30" x="5031" y="0"></use></g></svg></span><script type="math/tex" id="MathJax-Element-1"> f (x) = x + 0 </script><br></li><li>  <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D0%25BC%25D0%25BC%25D1%2583%25D1%2582%25D0%25B0%25D1%2582%25D0%25B8%25D0%25B2%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BE%25D0%25BF%25D0%25B5%25D1%2580%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F">Commutativity</a> <br><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-10"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-11"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f </font></font></span><span class="MJXp-mo" id="MJXp-Span-12" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-13"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x </font></font></span><span class="MJXp-mo" id="MJXp-Span-14" style="margin-left: 0em; margin-right: 0.222em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-15"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font></span><span class="MJXp-mo" id="MJXp-Span-16" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class="MJXp-mo" id="MJXp-Span-17" style="margin-left: 0.333em; margin-right: 0.333em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-18"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f </font></font></span><span class="MJXp-mo" id="MJXp-Span-19" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-20"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font></span><span class="MJXp-mo" id="MJXp-Span-21" style="margin-left: 0em; margin-right: 0.222em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-22"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x </font></font></span><span class="MJXp-mo" id="MJXp-Span-23" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font></span></span></span><span class="MathJax_SVG MathJax_SVG_Processed" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="16.312ex" height="2.66ex" viewBox="0 -832 7023.4 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-66" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMAIN-28" x="550" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-78" x="940" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMAIN-2C" x="1512" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-79" x="1957" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMAIN-29" x="2455" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMAIN-3D" x="3122" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-66" x="4178" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMAIN-28" x="4729" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-79" x="5118" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMAIN-2C" x="5616" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-78" x="6061" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMAIN-29" x="6633" y="0"></use></g></svg></span><script type="math/tex" id="MathJax-Element-2"> f (x, y) = f (y, x) </script><br></li><li>  <a href="https://ru.wikipedia.org/wiki/%25D0%25A7%25D0%25B0%25D1%2581%25D1%2582%25D0%25B8%25D1%2587%25D0%25BD%25D0%25BE_%25D1%2583%25D0%25BF%25D0%25BE%25D1%2580%25D1%258F%25D0%25B4%25D0%25BE%25D1%2587%25D0%25B5%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25BC%25D0%25BD%25D0%25BE%25D0%25B6%25D0%25B5%25D1%2581%25D1%2582%25D0%25B2%25D0%25BE">Partial order</a> <br>  Reflexivity + Transitivity + Antisymmetry <br></li><li>  <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25BE%25D0%25BB%25D1%2583%25D1%2580%25D0%25B5%25D1%2588%25D1%2591%25D1%2582%25D0%25BA%25D0%25B0">Semilattice</a> <br>  Partially ordered set with exact upper (bottom) face <br></li><li>  <a href="https://en.wikipedia.org/wiki/Version_vector">Version vector</a> <br>  The vector of dimension is equal to the number of nodes, and each node upon the occurrence of a particular event increases its value in the vector.  During synchronization, data is transmitted with this vector and this introduces an order relationship, which allows determining which replicas have old / new data. </li></ol><br><h1>  5. Synchronization models </h1><br><h3>  State-based (state synchronization): </h3><br>  Also called passive synchronization, it forms the Convergent Replicated Data Type - CvRDT. <br>  Used in file systems such as NFS, AFS, Coda, and in KV storages Riak, Dynamo <br>  In this case, the replicas are exchanged directly with the states, the receiving replica merges the received state with its current state. <br><br><div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/ac/r_/7b/acr_7blhm_vkl7rwgfenmjpvdus.png" alt="image"></div><br>  To perform replica convergence using this synchronization, you need to: <br><br><ul><li>  The data formed a semilattice </li><li>  The merge function produced an exact upper bound. </li><li>  Replicas formed a connected graph </li></ul><br>  Example: <br><br><ul><li>  Data set: natural numbers <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-24"><span class="MJXp-mtext" id="MJXp-Span-25">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-26"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-27"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-28"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-29"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-30"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">b </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-31"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">b </font></font></span><span class="MJXp-mrow" id="MJXp-Span-32"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-33"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N</font></font></span></span></span></span><span class="MathJax_SVG MathJax_SVG_Processed" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.088ex" height="2.057ex" viewBox="0 -780.1 4343.5 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-6D" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-61" x="1128" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-74" x="1658" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-68" x="2019" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-62" x="2596" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-62" x="3025" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-4E" x="3455" y="0"></use></g></svg></span><script type="math/tex" id="MathJax-Element-3"> \ mathbb {N} </script></li><li>  Minimum item: <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-34"><span class="MJXp-mo" id="MJXp-Span-35" style="margin-left: 0em; margin-right: 0.111em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font></span><font style="vertical-align: inherit;"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-37"><font style="vertical-align: inherit;">i </font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-38"><font style="vertical-align: inherit;">n </font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-39"><font style="vertical-align: inherit;">f </font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-40"><font style="vertical-align: inherit;">t </font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-41"><font style="vertical-align: inherit;">y</font></span></font><span class="MJXp-mtext" id="MJXp-Span-36">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-37"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-38"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-39"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-40"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-41"><font style="vertical-align: inherit;"></font></span></span></span><span class="MathJax_SVG MathJax_SVG_Processed" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.86ex" height="2.419ex" viewBox="0 -780.1 3384 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMAIN-2212" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-69" x="1028" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-6E" x="1374" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-66" x="1974" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-74" x="2525" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-79" x="2886" y="0"></use></g></svg></span><script type="math/tex" id="MathJax-Element-4"> - \ infty </script></li><li><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-42"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-43"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-44"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-45"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-46"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">g </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-47"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font></span><span class="MJXp-mo" id="MJXp-Span-48" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-49"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x </font></font></span><span class="MJXp-mo" id="MJXp-Span-50" style="margin-left: 0em; margin-right: 0.222em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-51"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font></span><span class="MJXp-mo" id="MJXp-Span-52" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class="MJXp-mo" id="MJXp-Span-53" style="margin-left: 0.333em; margin-right: 0.333em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-54"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-55"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-56"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x </font></font></span><span class="MJXp-mo" id="MJXp-Span-57" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-58"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x </font></font></span><span class="MJXp-mo" id="MJXp-Span-59" style="margin-left: 0em; margin-right: 0.222em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-60"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font></span><span class="MJXp-mo" id="MJXp-Span-61" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font></span></span></span><span class="MathJax_SVG MathJax_SVG_Processed" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="24.727ex" height="2.66ex" viewBox="0 -832 10646.4 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-6D" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-65" x="878" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-72" x="1345" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-67" x="1796" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-65" x="2277" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMAIN-28" x="2743" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-78" x="3133" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMAIN-2C" x="3705" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-79" x="4150" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMAIN-29" x="4648" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMAIN-3D" x="5315" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-6D" x="6371" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-61" x="7250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-78" x="7779" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMAIN-28" x="8352" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-78" x="8741" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMAIN-2C" x="9314" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMATHI-79" x="9759" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/418897/&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhpvKllY2V6-NDVtIZKjBYGmxIV7g#MJMAIN-29" x="10256" y="0"></use></g></svg></span><script type="math/tex" id="MathJax-Element-5"> merge (x, y) = max (x, y) </script></li></ul><br>  Such requirements give us a <b>commutative</b> and <b>idempotent</b> merge function, which <b>monotonously grows</b> on a given data set: <br><br><div style="text-align:center;"><img width="300" src="https://habrastorage.org/webt/jn/nw/vl/jnnwvlfp_tjkank2zknwdcbj-oc.png" alt="image"></div><br>  This ensures that the replicas will converge sooner or later and allows you not to worry about the data transfer protocol - <b>we can lose messages with the new state, send them several times, and even send them in any order</b> . <br><br><h3>  Operation-based (synchronization operations): </h3><br>  Also called active sync, it forms the Commutative Replicated Data Type - CmRDT. <br>  Used in cooperative systems such as Bayou, Rover, IceCube, Telex. <br><br>  In this case, the replicas exchange status update operations.  When updating data, the original replica: <br><br><ul><li>  Calls the generate () method which returns the effector () method for execution on the remaining replicas.  In other words, effector () is a closure for changing the state of the other replicas. </li><li>  Apply effector to local state </li><li>  Sends effector to all other replicas. </li></ul><br><div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/bd/i3/ps/bdi3pshr57wi0udnldnurhcdpfs.png" alt="image"></div><br>  To perform replica convergence, the following conditions must be met: <br><br><ul><li>  Reliable delivery protocol </li><li>  If effector is delivered to all replicas in accordance with the entered order (for this type), then simultaneous effector is commutative, <b>or</b> </li><li>  If effector is delivered to all replicas without regard to order, then all effector is commutative. </li><li>  In case effector can be delivered several times, then it must be idempotent </li><li>  Some implementations use queues (Kafka) as part of the delivery protocol. </li></ul><br><h3>  Delta-based: </h3><br>  Considering the state / op based it is easy to notice that if an update changes only part of the state, then there is no sense in sending the state as a whole, and also if a large number of changes affect one state (for example, a counter), then you can send one aggregated change, but not all operations changes. <br><br>  Delta sync combines both approaches and sends delta-mutators, which update the state according to the latest sync date.  During initial synchronization, it is necessary to send the state completely, and some implementations in such cases already take into account the state of the other replicas when building delta-mutators. <br><br>  The next optimization method is op-based log compression, if delays are allowed. <br><br><div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/rd/vi/a5/rdvia5kv708z55ndt_t5j_leaum.png" alt="image"></div><br><h3>  Pure operation-based (pure synchronization operations): </h3><br>  In op-based synchronization, there is a delay in creating effector.  In some systems, this may be unacceptable, then you have to send the original change at the cost of complicating the protocol and the additional amount of metadata. <br><br><div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/3l/p2/r2/3lp2r2ruizjddxllrwgbgwh5ykw.png" alt="image"></div><br><h3>  Standard approaches of use: </h3><br><ul><li>  If the system updates <b>should be sent immediately</b> , then state-based would be a bad choice, since sending a state is entirely more expensive than just an update operation.  Delta-based is better, but in this particular case, the difference with state-based will be small. </li><li>  If you need to <b>synchronize a replica after a failure</b> , then state-based and delta-based is the ideal choice.  If you have to use op-based, then the options are: <br><br>  1) Roll all missed operations from the moment of failure <br>  2) A complete copy of one of the replicas and roll forward missed operations. </li><li>  As noted above, op-based requires that updates be delivered exactly once to each replica.  The requirement of delivery only once can be omitted if effector is idempotent.  In practice, it is much easier to implement the first than the second. </li></ul><br><h3>  Connection between Op-based and State-based: </h3><br>  The two approaches can be emulated through each other, so that in the future we will consider CRDT without reference to any particular synchronization model. <br><br><h1>  6. CRDT </h1><br><h2>  6.1 Counter </h2><br>  Integer with support for two operations: inc and dec.  As an example, consider the possible implementations for op-based and state-based synchronization: <br><br><h3>  Op-based counter: </h3><br>  Obviously enough, just send updates.  Example for inc: <br><br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> function (counter) { counter += <span class="hljs-number"><span class="hljs-number">1</span></span> } }</code> </pre> <br><h3>  State-based counter: </h3><br>  The implementation is no longer so obvious, since it is not clear how the merge function should look. <br><br>  Consider the following options: <br><br>  <u>Monotonically increasing counter (Increment only counter, G-Counter):</u> <br><br>  The data will be stored as a vector of dimension equal to the number of nodes (version vector) and each replica will increase the value at position with its id. <br><br>  The merge function will take the maximum in the corresponding positions, and the final value will be the sum of all elements of the vector <br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-62"><span class="noError" id="MJXp-Span-63" style="display: inline-block;">\&nbsp;begin&nbsp;{align}&nbsp;inc&nbsp;()&nbsp;&amp;:&nbsp;V&nbsp;[id&nbsp;()]&nbsp;=&nbsp;V&nbsp;[id&nbsp;()]&nbsp;+&nbsp;1&nbsp;\\&nbsp;value&nbsp;()&nbsp;&amp;:&nbsp;\&nbsp;sum_&nbsp;{i&nbsp;=&nbsp;0}&nbsp;^&nbsp;{n}&nbsp;V&nbsp;[i]&nbsp;\\&nbsp;merge&nbsp;(C_1,&nbsp;C_2)&nbsp;&amp;:&nbsp;i&nbsp;\&nbsp;in&nbsp;[1..n]&nbsp;\&nbsp;Result&nbsp;[i]&nbsp;=&nbsp;max&nbsp;(C_1.V&nbsp;[i],&nbsp;C_2.V&nbsp;[i])&nbsp;\&nbsp;end&nbsp;{align}</span></span></span><div class="MathJax_SVG_Display MathJax_SVG_Processed"><span class="MathJax_SVG" id="MathJax-Element-6-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><span class="noError" style="display: inline-block;">\&nbsp;begin&nbsp;{align}&nbsp;inc&nbsp;()&nbsp;&amp;:&nbsp;V&nbsp;[id&nbsp;()]&nbsp;=&nbsp;V&nbsp;[id&nbsp;()]&nbsp;+&nbsp;1&nbsp;\\&nbsp;value&nbsp;()&nbsp;&amp;:&nbsp;\&nbsp;sum_&nbsp;{i&nbsp;=&nbsp;0}&nbsp;^&nbsp;{n}&nbsp;V&nbsp;[i]&nbsp;\\&nbsp;merge&nbsp;(C_1,&nbsp;C_2)&nbsp;&amp;:&nbsp;i&nbsp;\&nbsp;in&nbsp;[1..n]&nbsp;\&nbsp;Result&nbsp;[i]&nbsp;=&nbsp;max&nbsp;(C_1.V&nbsp;[i],&nbsp;C_2.V&nbsp;[i])&nbsp;\&nbsp;end&nbsp;{align}</span></span></div><script type="math/tex;mode=display" id="MathJax-Element-6"> \ begin {align} inc () &: V [id ()] = V [id ()] + 1 \\ value () &: \ sum_ {i = 0} ^ {n} V [i] \\ merge (C_1, C_2) &: i \ in [1..n] \ Result [i] = max (C_1.V [i], C_2.V [i]) \ end {align} </script></p><br>  You can also use the G-Set (see below) <br><br>  Application: <br><br><ul><li>  Counting the number of clicks / hits (sic!) </li></ul><br>  <u>Decrementing Counter (PN-counter)</u> <br><br>  We get two G-counter - one for increment operations, the second - for decrement <br><br>  Application: <br><br><ul><li>  The number of logged in users on the p2p network, such as Skype </li></ul><br>  <u>Non-negative counter (Non-negative counter)</u> <br><br>  A simple implementation does not yet exist.  Offer in the comments your ideas, we will discuss. <br><br><h2>  6.2 Register </h2><br>  A memory cell with two operations - assign (write) and value (read). <br>  Problem - assign is not commutative.  There are two approaches to solve this problem: <br><br><h3>  Last-Write-Wins Register (LWW-Register): </h3><br>  We enter the full order through the generation of unique id for each operation (timestamp, for example). <br><br>  An example of synchronization is the exchange of pairs (value, id): <br><br><div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/rw/8m/1k/rw8m1k8wgby7v0gczcthhdmdvns.png"></div><br>  Application: <br><br><ul><li>  Columns in cassandra </li><li>  NFS - whole or part file </li></ul><br><h3>  Multi-Value Register, MV-Register: </h3><br>  The approach is similar to the G-counter - we store the set (value, version version).  The register value is all values; when merged, the LWW is separately for each value in the vector. <br><br><div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/o3/kr/vc/o3krvcuowzsa-vi_avn27jcscxk.png"></div><br>  Application: <br><br><ul><li>  Basket in the Amazon.  A known bug is connected with this, when after removing things from the basket it appears there again.  The reason is that despite the fact that the register stores a set of values ‚Äã‚Äã‚Äî it is not a set (see the picture below).  Amazon, by the way, does not even consider it a bug - in fact it boosts sales. </li><li>  Riak.  In the more general case, we shift the problem of choosing the actual (note - there is no conflict!) Values ‚Äã‚Äãto the application. </li></ul><br>  The explanation of the bug in the Amazon: <br><br><div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/k0/au/le/k0auleq-jjcrfdtkdswe8tfdxnq.png"></div><br><br><h2>  6.3 Many </h2><br>  The set is the base type for building containers, maps, and graphs and supports the operations add and rmv, which are not commutative. <br><br>  Consider a naive implementation of an op-based set, in which add and rmv are executed as they arrive (add and then rmv at 1 at the same time) <br><br><div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/yk/uu/3b/ykuu3b4-brgkjj2p4y32gmytafs.png"></div><br>  As you can see, the replicas eventually diverged.  Consider the various options for constructing conflict-free sets: <br><br><h3>  Growing Set (G-Set): </h3><br>  The simplest solution is to prohibit deleting items.  The only thing left is the add operation, which is commutative.  The merge function is the union of sets. <br><br><h3>  Two Phase Set (2P-Set): </h3><br>  We allow to delete, but after removal it is impossible to add again.  To implement, we create a separate set of deleted G-set elements (such a set is called tombstone set) <br>  Example for state-based: <br><br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-64"><span class="noError" id="MJXp-Span-65" style="display: inline-block;">\&nbsp;begin&nbsp;{align}&nbsp;lookup&nbsp;(e)&nbsp;&amp;:&nbsp;e&nbsp;\&nbsp;in&nbsp;A&nbsp;\&nbsp;land&nbsp;e&nbsp;\&nbsp;notin&nbsp;R&nbsp;\\&nbsp;add&nbsp;(e)&nbsp;&amp;:&nbsp;A&nbsp;=&nbsp;A&nbsp;\&nbsp;cup&nbsp;\&nbsp;{e&nbsp;\}&nbsp;\\&nbsp;rmv&nbsp;(e)&nbsp;&amp;:&nbsp;R&nbsp;=&nbsp;R&nbsp;\&nbsp;cup&nbsp;\&nbsp;{e&nbsp;\}&nbsp;\\&nbsp;merge&nbsp;(S_1,&nbsp;S_2)&nbsp;&amp;:&nbsp;\\&nbsp;Res&nbsp;&amp;&nbsp;ult.A&nbsp;=&nbsp;S_1.A&nbsp;\&nbsp;cup&nbsp;S_2.A&nbsp;\\&nbsp;Res&nbsp;&amp;&nbsp;ult.R&nbsp;=&nbsp;S_1.R&nbsp;\&nbsp;cup&nbsp;S_2.R&nbsp;\&nbsp;end&nbsp;{align}</span></span></span><div class="MathJax_SVG_Display MathJax_SVG_Processed"><span class="MathJax_SVG" id="MathJax-Element-7-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><span class="noError" style="display: inline-block;">\&nbsp;begin&nbsp;{align}&nbsp;lookup&nbsp;(e)&nbsp;&amp;:&nbsp;e&nbsp;\&nbsp;in&nbsp;A&nbsp;\&nbsp;land&nbsp;e&nbsp;\&nbsp;notin&nbsp;R&nbsp;\\&nbsp;add&nbsp;(e)&nbsp;&amp;:&nbsp;A&nbsp;=&nbsp;A&nbsp;\&nbsp;cup&nbsp;\&nbsp;{e&nbsp;\}&nbsp;\\&nbsp;rmv&nbsp;(e)&nbsp;&amp;:&nbsp;R&nbsp;=&nbsp;R&nbsp;\&nbsp;cup&nbsp;\&nbsp;{e&nbsp;\}&nbsp;\\&nbsp;merge&nbsp;(S_1,&nbsp;S_2)&nbsp;&amp;:&nbsp;\\&nbsp;Res&nbsp;&amp;&nbsp;ult.A&nbsp;=&nbsp;S_1.A&nbsp;\&nbsp;cup&nbsp;S_2.A&nbsp;\\&nbsp;Res&nbsp;&amp;&nbsp;ult.R&nbsp;=&nbsp;S_1.R&nbsp;\&nbsp;cup&nbsp;S_2.R&nbsp;\&nbsp;end&nbsp;{align}</span></span></div><script type="math/tex;mode=display" id="MathJax-Element-7"> \ begin {align} lookup (e) &: e \ in A \ land e \ notin R \\ add (e) &: A = A \ cup \ {e \} \\ rmv (e) &: R = R \ cup \ {e \} \\ merge (S_1, S_2) &: \\ Res & ult.A = S_1.A \ cup S_2.A \\ Res & ult.R = S_1.R \ cup S_2.R \ end {align} </script></p><br><h3>  LWW-element Set: </h3><br>  The next way to implement a conflict-free set is to introduce a complete order, one of the options is to generate unique timestamp for each element. <br><br>  We create two sets ‚Äî add-set and remove-set; when we call add (), we add (element, unique_id ()); if we check if there is an element in the set, we see where the timestamp is greater ‚Äî in remove-set or in add-set <br><br><div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/iw/gt/95/iwgt95jsuu9xps80j0w-sjgweq4.png"></div><br><h3>  PN-Set: </h3><br>  Variation with the ordering of the set ‚Äî we start a counter for each element, increase it when adding it, decrease it as it deletes.  An element is in the set if its counter is positive. <br><div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/nf/qz/dw/nfqzdwf7risphmn8qyuq0tsjc3s.png"></div><br>  Note the interesting effect - in the third replica the addition of the element does not lead to its appearance. <br><br><h3>  Observe-Remove Set, OR-Set, Add-Win Set: </h3><br>  In this type, add takes precedence over remove.  Example of implementation: we assign a unique tag to each newly added element (relative to the element, and not the entire set).  Rmv removes the element from the set and sends all pairs seen (element, tag) to remove the replicas. <br><br><div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/5n/ac/1l/5nac1lanif5y_kh_w9rvaz-jqoe.png"></div><br><br><h3>  Remove-win Set: </h3><br>  Similar to the previous one, but at the same time add / rmv wins rmv. <br><br><h2>  6.4 Graph </h2><br>  This type is based on the set.  The problem is this: if there are simultaneous operations addEdge (u, v) and removeVertex (u) - what to do?  Such options are possible: <br><br><ul><li>  RemoveVertex priority, all edges incident to this vertex are removed </li><li>  AddEdge priority, remote vertices are restored </li><li>  We postpone the execution of removeVertex until all simultaneous addEdge are executed. </li></ul><br>  The easiest option is the first, to implement it (2P2P-Graph), it‚Äôs enough to have two 2P-Set, one for the vertices, the second for the edges <br><br><h2>  6.5 Mapping (Map) </h2><br><h3>  Display of literals (Map of literals): </h3><br>  Two problems to solve: <br><br><ul><li>  What to do with simultaneous put operations?  By analogy with counters, you can choose either LWW or MV semantics </li><li>  What to do with simultaneous put / rmv?  By analogy with sets, one can either put-wins, or rmv-wins, or last-put-wins semantics. </li></ul><br><h3>  CRDT mapping (Map of CRDTs): </h3><br>  A more interesting case, because  allows you to build nested maps.  We do not consider cases of changing nested types - this should be solved by the nested CRDT itself. <br><br>  <u>Remove-as-recursive-reset map</u> <br><br>  The remove operation ‚Äúresets‚Äù the value of the type to a certain starting state.  For example, for a counter it is a zero value. <br><br>  Consider an example - a general shopping list.  One of the users adds flour, and the second makes a checkout (this results in a call to a delete operation on all elements).  As a result, only one flour remains in the list, which looks logical. <br><br><div style="text-align:center;"><img width="700" src="https://habrastorage.org/webt/9g/sn/4j/9gsn4jdmbdg_ba1hdrmftl5mcgy.png"></div><br>  <u>Remove-wins map</u> <br><br>  The rmv operation takes precedence. <br><br>  Example: in an online game, player Alice has 10 coins and a hammer.  Then two events occur simultaneously: on a cue, A she produced a nail, and on a cue B her character was removed with the removal of all the items: <br><br><div style="text-align:center;"><img width="700" src="https://habrastorage.org/webt/tb/xd/6s/tbxd6s7eun3rpn57mnwt9d4hbxa.png"></div><br><br>  Note that using remove-as-recursive would ultimately leave a nail, which is not the correct state when the character is removed. <br><br>  <u>Update-wins map</u> <br><br>  Updates have priority, or rather, cancel previous operations to delete simultaneous rmv. <br><br>  Example: in an online game, the Alice character on the replica B is deleted due to inactivity, but at the same time, activity occurs on the replica A.  Obviously, the delete operation must be undone. <br><br><div style="text-align:center;"><img width="700" src="https://habrastorage.org/webt/63/oz/5y/63oz5yzch4ioguyram3erawkzl0.png"></div><br>  There is one interesting effect when working with this implementation - suppose that we have two replicas, A and B, and they store a set of some key k.  Then, if A removes the value of the key k, and B removes all the elements of a set, then, as a result, an empty set of the key k will remain in the replicas. <br><br>  Note that the naive implementation will not work correctly - you cannot just undo all previous deletions.  In the following example, with this approach, the final state would be as original, which is wrong: <br><br><div style="text-align:center;"><img width="700" src="https://habrastorage.org/webt/mp/un/hm/mpunhmkzj125hqob4net7iq7kc4.png"></div><br><h2>  List (List) </h2><br>  The problem with this type is that the indexes of the elements on different replicas will be different after a local insert / delete operation.  To solve this problem, use the Operational Transformation approach - when applying the resulting change, the index of the element in the original replica should be taken into account. <br><br><h1>  7. Riak </h1><br>  As an example, consider CRDT in Riak: <br><br><ul><li>  Counter: PN-Counter </li><li>  Set: OR-Set </li><li>  Map: Update-wins Map of CRDTs </li><li>  (Boolean) Flag: OR-Set where max 1 element </li><li>  Register: pairs (value, timestamp) </li></ul><br><h1>  8. Who uses CRDT </h1><br>  The <a href="https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type">wiki</a> section contains good examples. <br><br><h1>  9. References </h1><br><ul><li>  <a href="https://run.unl.pt/bitstream/10362/7802/1/Sousa_2012.pdf">Key-CRDT Stores</a> </li><li>  <a href="https://arxiv.org/abs/1608.03960">A Conflict-Free Replicated JSON Datatype</a> </li><li>  <a href="https://hal.inria.fr/inria-00555588/document">A comprehensive study of Convergent and Commutative Replicated Data Types</a> </li><li>  <a href="https://core.ac.uk/download/pdf/55634119.pdf">Convergent and Commutative Replicated Data Type</a> </li><li>  <a href="https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type">Conflict-free replicated data type</a> </li><li>  <a href="https://gist.github.com/russelldb/f92f44bdfb619e089a4d">A Bluffers Guide to CRDTs in Riak</a> </li><li>  <a href="https://speakerdeck.com/lenary/crdts-an-update-or-just-a-put%3Fslide%3D8">CRDTs: An UPDATE (or just a PUT)</a> </li><li>  <a href="https://arxiv.org/pdf/1806.10254.pdf">Conflict-free Replicated Data Types: An Overview</a> </li><li>  <a href="https://www.youtube.com/watch%3Fv%3DoyUHd894w18">Strong Eventual Consistency and Conflict-free Replicated Data Types</a> </li><li>  <a href="https://www.infoq.com/presentations/CRDT">Eventually-Consistent Data Structures</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/418897/">https://habr.com/ru/post/418897/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../418885/index.html">Crispr can accelerate natural processes and change the way food is grown.</a></li>
<li><a href="../418887/index.html">How fast is the universe expanding?</a></li>
<li><a href="../418889/index.html">Manual Application Testing Guide: Benefits, Milestones, and Methodologies</a></li>
<li><a href="../418891/index.html">Checked with the help of PVS-Studio Android source codes, or no one is perfect</a></li>
<li><a href="../418895/index.html">Learning Artificial Intelligence to play the game</a></li>
<li><a href="../418899/index.html">First impressions and actions after upgrading MySQL from version 5.7 to 8.0.11</a></li>
<li><a href="../418901/index.html">The Russians won the most gold medals of the European Olympiad in Informatics eJOI 2018</a></li>
<li><a href="../418903/index.html">Scientists: there is not enough CO‚ÇÇ on Mars to warm the atmosphere. The explosion of the poles will not help</a></li>
<li><a href="../418905/index.html">InlineKeyboard in Telegram Bots</a></li>
<li><a href="../418907/index.html">How to teach Zabbix to send problem notifications directly to the desktop</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>