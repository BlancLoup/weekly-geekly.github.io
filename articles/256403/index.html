<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We unify the behavior of LINQ to IEnumerable and LINQ to IQueriable in terms of working with null values. Part two. Its implementation of IQueryProvider</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the comments to the first part, I was rightly made a remark that I promised to unify IEnumerable and IQueryable, and I hid them behind a samopisny ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We unify the behavior of LINQ to IEnumerable and LINQ to IQueriable in terms of working with null values. Part two. Its implementation of IQueryProvider</h1><div class="post__text post__text-html js-mediator-article">  In the comments to the <a href="http://habrahabr.ru/post/256257/">first part,</a> I was rightly made a remark that I promised to unify IEnumerable and IQueryable, and I hid them behind a samopisny repository-like interface.  In this article I will try to fix it and give an example of what to do if we want to work with LINQ directly.  For this, I will offer my own implementation of the IQueryProvider interface. <br><br>  <a href="https://github.com/k-best/Tools">Github</a> <br>  <a href="https://www.nuget.org/packages/ExpressionHelpers/">Nuget</a> <br><br><a name="habracut"></a><br>  So, the first part ended with the fact that we wrote ExpressionVisitor, which added a wrapper checking for null to each node of the expression tree, which is an appeal to the property: <br><pre><code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> AddMaybeVisitor : ExpressionVisitor { //      ,   . <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Expression&lt;Func&lt;T1, T2&gt;&gt; Modify&lt;T1, T2&gt;(Expression&lt;Func&lt;T1, T2&gt;&gt; expression) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (Expression&lt;Func&lt;T1, T2&gt;&gt;)Visit(expression); } //      ,          ,   ,    . protected override Expression VisitMember(MemberExpression node) { var expression = Visit(node.Expression); var expressionType = expression.<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>; var memberType = node.<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>; var withMethodinfo = typeof(AddMaybeVisitor) .GetMethod("With") .MakeGenericMethod(expressionType, memberType); var p = Expression.Parameter(expressionType); var l = Expression.Lambda(Expression.MakeMemberAccess(p, node.Member), p); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Expression.<span class="hljs-keyword"><span class="hljs-keyword">Call</span></span>(withMethodinfo, expression, Expression.<span class="hljs-keyword"><span class="hljs-keyword">Constant</span></span>(l.Compile(), typeof(Func&lt;,&gt;).MakeGenericType(expressionType, memberType)) ); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static TResult <span class="hljs-keyword"><span class="hljs-keyword">With</span></span>&lt;TSource, TResult&gt;(TSource source, Func&lt;TSource, TResult&gt; action) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TSource : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (source != <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>(TSource)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> action(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>(TResult); } }</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let us again have a pair of data sources providing access to the book collection.  In this case, each book <i>may be</i> listed by the author, presented in the table of authors.  One of the data sources is a database, and accordingly an even IQueryable is returned from it, the second is an in-memory cache that returns a List.  Like the first time, we hide this interface, but now it will return IQueryable, and we will do all other transformations using standard LINQ methods. <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IBookSource</span></span> { <span class="hljs-function"><span class="hljs-function">IQueryable&lt;Book&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetBooks</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre><br><br>  The standard approach to getting from IEnumerable (and, in particular, from List) IQueryable is to call the AsQueryable () extension method.  However, this option does not suit us, because we need to perform our own manipulations with each used expression, namely, to wrap the property getter into a null test. <br>  Therefore, we will write our own extension method: <br><pre> <code class="hljs pgsql"> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> QueryableExtensions { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static IQueryable&lt;TElement&gt; AsMaybeQueryable&lt;TElement&gt;(this IEnumerable&lt;TElement&gt; source) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (source == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ArgumentNullException("source"); var elements = source <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IQueryable&lt;TElement&gt;; //      AsQueryable() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> elements ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> MaybeEnumerableQuery&lt;TElement&gt;(source); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static IQueryable AsMaybeQueryable(this IEnumerable source) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (source == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ArgumentNullException("source"); var queryable = source <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IQueryable; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (queryable != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> queryable; var enumType = FindGenericType(typeof(IEnumerable&lt;&gt;), source.GetType()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (enumType == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ArgumentException("Source is not generic","source"); //      AsQueryable() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MaybeEnumerableQuery.<span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>(enumType.GetGenericArguments()[<span class="hljs-number"><span class="hljs-number">0</span></span>], source); } private static <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> FindGenericType(<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> definition, <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> != typeof(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>.IsGenericType &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>.GetGenericTypeDefinition() == definition) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (definition.IsInterface) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> itype <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>.GetInterfaces()) { <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-built_in"><span class="hljs-built_in">found</span></span> = FindGenericType(definition, itype); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">found</span></span> != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">found</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>.BaseType; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre><br><br>  The difference is that instead of the standard EnumerableQuery class, we return our implementation of MaybeEnumerableQuery, which is a wrapper around EnumerableQuery: <br><pre> <code class="hljs kotlin"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MaybeEnumerableQuery</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt;: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaybeEnumerableQuery</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IQueryProvider</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IOrderedQueryable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IQueryable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IOrderedQueryable</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IQueryable</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IEnumerable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IEnumerable { private EnumerableQuery</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_innerQuery</span></span></span><span class="hljs-class">; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">public</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MaybeEnumerableQuery</span></span></span></span>(IEnumerable&lt;T&gt; enumerable) { _innerQuery = new EnumerableQuery&lt;T&gt;(enumerable); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MaybeEnumerableQuery(Expression expression) { _innerQuery = new EnumerableQuery&lt;T&gt;(RewriteExpression(expression)); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Expression RewriteExpression(Expression expression) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rewriter = new AddMaybeVisitor(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rewriter.Visit(expression); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IQueryable CreateQuery(Expression expression) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((IQueryProvider)_innerQuery).CreateQuery(RewriteExpression(expression)); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IQueryable&lt;TElement&gt; CreateQuery&lt;TElement&gt;(Expression expression) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((IQueryProvider)_innerQuery).CreateQuery&lt;TElement&gt;(RewriteExpression(expression)); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Execute(Expression expression) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((IQueryProvider)_innerQuery).Execute(RewriteExpression(expression)); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TResult Execute&lt;TResult&gt;(Expression expression) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((IQueryProvider)_innerQuery).Execute&lt;TResult&gt;(RewriteExpression(expression)); } ... <span class="hljs-comment"><span class="hljs-comment">//    ,         _innerQuery }</span></span></code> </pre><br>  In this case, each received expression we process using our ExpressionVisitor. <br><br>  Usage example: <br><pre> <code class="hljs swift"><span class="hljs-type"><span class="hljs-type">IQueryable</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Book</span></span>&gt; <span class="hljs-type"><span class="hljs-type">GetBooks</span></span>() { <span class="hljs-type"><span class="hljs-type">List</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Book</span></span>&gt; books = <span class="hljs-type"><span class="hljs-type">GetDataFromCache</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> books.<span class="hljs-type"><span class="hljs-type">AsMaybeQueryable</span></span>(); } ... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> names = <span class="hljs-type"><span class="hljs-type">GetBooks</span></span>.<span class="hljs-type"><span class="hljs-type">Select</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">c</span></span>=&gt;<span class="hljs-built_in"><span class="hljs-built_in">c</span></span>.<span class="hljs-type"><span class="hljs-type">Author</span></span>.<span class="hljs-type"><span class="hljs-type">Name</span></span>).<span class="hljs-type"><span class="hljs-type">ToArray</span></span>();</code> </pre><br><br>  <b><u>Important note: The</u></b> operation of rewriting the expression tree is not free.  It is fast compared to the data collection from the database, but I would not recommend using this solution to work purely with IEnumerable. </div><p>Source: <a href="https://habr.com/ru/post/256403/">https://habr.com/ru/post/256403/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256387/index.html">Ionic Framework - working with the camera</a></li>
<li><a href="../256389/index.html">Scrum sprint simulation. We solve problems of interaction with the client and within the team.</a></li>
<li><a href="../256393/index.html">How to make Xamarin Studio a little better?</a></li>
<li><a href="../256397/index.html">Transferring a project from iOS designers to developers</a></li>
<li><a href="../256401/index.html">Compare Visual Studio Community 2013 with Visual Studio 2013 Express. Features of the license agreement</a></li>
<li><a href="../256405/index.html">Interview with Serge</a></li>
<li><a href="../256407/index.html">Worm apples [WITHOUT JailBreak]</a></li>
<li><a href="../256409/index.html">New graphics mode: CGA in 1024 colors</a></li>
<li><a href="../256411/index.html">Interference: as a tram, radar detector and poorly crimped cable can affect the satellite channel</a></li>
<li><a href="../256413/index.html">Analysis of weather station data based on Arduino</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>