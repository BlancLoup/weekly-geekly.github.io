<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>50 shades of stub * ADC and ADC with Microchip microcontroller computer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="- POIs - Peripherals Independent of the Core in Microchip microcontrollers, also known as CIP - Core Independent Peripheral. 
 Part 3 


 The previous...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>50 shades of stub * ADC and ADC with Microchip microcontroller computer</h1><div class="post__text post__text-html js-mediator-article"><ul><li>  POIs - Peripherals Independent of the Core in Microchip microcontrollers, also known as CIP - Core Independent Peripheral. </li></ul><br><h1>  Part 3 </h1><br><p>  The previous articles [ <a href="https://geektimes.ru/post/278718">1</a> ] and [ <a href="https://geektimes.ru/post/279374/">2</a> ] dealt with such parts of the Microchip Independent Microcontroller (MK) Microchip Peripherals such as configurable logic cells and I / O ports with a new useful current limiting function. </p><br><p>  Now consider the Analog-to-Digital Converter (ADC) and in particular the new ADC with post-calculator.  As you probably already used to, new features of the periphery can help in the implementation of specific functions and simplify the code under the PIC microcontrollers. </p><br><p>  Unlike the previous parts, this one will have a bit more theory and a few less examples. </p><a name="habracut"></a><br><h1>  Content </h1><br><ul><li>  Overview of ADC capabilities <br><ul><li>  Trigger trigger </li><li>  VHD, CVD, Double conversion </li><li>  Post-calculator, filtering, averaging </li></ul><br></li><li>  Configuration Examples <br><ul><li>  Autostart, filtering </li><li>  Autostart, CVD, averaging, interruption compared to thresholds </li><li>  Autostart, Differential CVD, Conversion Series, Averaging </li></ul><br></li><li>  Results </li></ul><br><h1>  Overview of ADC capabilities </h1><br><p>  ADC with full confidence can be called Peripheral Independent of the Core, since the ADC has a clocking option from the built-in RC generator and can perform the conversion in the Sleep energy conservation mode.  But independence is not limited to this.  Many families of PIC16F1xxx have an ADC with the possibility of starting on events, and completely new families of PIC16F188xx have also received a post-calculator. </p><br><p>  Consider the possibilities of the ADC for example MK family PIC16F18855 / 75 </p><br><p>  ADC controllers of this family has: </p><br><ul><li>  8-bit Acquisition Timer </li><li>  Capacitive Voltage Divider (CVD) hardware support: <br><ul><li>  8-bit precharge timer </li><li>  Array of capacitors adjusting the capacity of the water economy department </li><li>  Guard Ring Output Driver </li></ul><br></li><li>  Automatic repeat and sequencing: <br><ul><li>  automated double conversion for CVD </li><li>  Two sets of result registers (result and previous result) </li><li>  Auto transform trigger </li><li>  Internal retrigger </li></ul><br></li><li>  Possibilities of the calculator: <br><ul><li>  Averaging and Low Pass Filter </li><li>  Comparison with the reference value </li><li>  2-level threshold comparison </li><li>  Selectable interrupts </li></ul><br></li></ul><br><p>  ADC with a post-calculator consists of several blocks (Fig. 1): </p><br><img src="https://habrastorage.org/files/b5a/8e2/7c0/b5a8e27c0958495a80ef14f86ac6ff29.png"><br><p>  Fig.  1. The structure of the ADC with the computer in the PIC16F18855 family. </p><br><h2>  Trigger trigger ADC </h2><br><p>  Gone are the days when it was necessary to manually set the bit to start the ADC measurement.  Now, the ADC can be launched by the following events: </p><br><ul><li>  external entrance; </li><li>  timers triggering (general purpose and SMT - 24-bit signal measurement timers); </li><li>  output of the comparison module and PWM; </li><li>  operation of the comparator; </li><li>  state change of inputs configured as interrupt due to state change; </li><li>  output logic cells; </li><li>  reading the measurement result of the ADC; </li><li>  change the channel number of the ADC. </li></ul><br><h2>  VHD and CVD </h2><br><p>  The sampling / storage unit (VHR) received additional capabilities, mainly related to simplifying the determination of the capacity of the ADC connected to the input.  First of all, it helps in creating interfaces with capacitive (touch) buttons. </p><br><p>  Microchip offers to determine the capacitance of the sensor using a capacitive voltage divider (Capacitive Voltage Divider, CVD). </p><br><p>  The essence of the method is as follows.  In the first step (see Fig. 2), the sensor input is connected to the ‚Äúground‚Äù (its capacity is discharged), and the ADC channel to the supply voltage, the capacity of the water economy department is charged. <br>  Then the sensor input is connected to the VHD ADC, the charge is redistributed between the capacitance of the sensor and the VHD capacity.  Then, the voltage measurement at the storage facility tank is measured. </p><br><table><thead><tr><th>  CVD input control </th><th>  CVD waveform </th></tr></thead><tbody><tr><td><img src="https://habrastorage.org/files/544/f37/cc9/544f37cc90a742b79c4095ed79a023e7.png"></td><td><img src="https://habrastorage.org/files/99c/61c/cd9/99c61ccd94994f6b9d972880421fb325.png" width="300"></td></tr></tbody></table><br><p>  Fig.  2. Diagrams explaining capacitance measurement using a capacitive voltage divider. </p><br><p>  Touching the sensor will change its capacitance, which means we will fix different steady-state values ‚Äã‚Äãof the voltage at the storage facility capacitor. <br>  To reduce the effect of induced noise on the sensor and / or operator, a differential CVD is used, consisting of two consecutive measurements using CVD, but in the second stage we invert the charges on the sensor and the water economy department (we charge the sensor to the supply voltage, and discharge the water economy device, see figure .3) </p><br><img src="https://habrastorage.org/files/3a6/9b9/91f/3a69b991f0dc46009a709d7dcabd8abe.png" width="450"><br><p>  Fig.3.  Signal diagram with differential CVD. </p><br><p>  Details about capacitive sensors, the method of differential CVD and control of the protective conductor can be found <a href="http://pickit2.ru/doku.php/all_articles:mtouch">under the link</a> [2]. </p><br><p>  The new ADC with post calculator for support and automation of CVD has the following functions: </p><br><ul><li>  precharge timer </li><li>  management of the charge sequence (desired polarity), measurement start; </li><li>  connection of additional internal tanks to the water economy department; </li><li>  two consecutive measurements; </li><li>  calculating the difference between two measured values; </li><li>  driver control "protective ring" (guard ring). </li></ul><br><p>  Thus, the ADC can automatically perform a differential CVD and provide us with the finished result. </p><br><h2>  Post-Calculator Functions </h2><br><p>  The post calculator performs several functions. </p><br><h3>  Filtration </h3><br><p>  The ADC module can operate in one of five modes: </p><br><p>  <b>Basic mode.</b>  In this mode, the ADC can make one or two measurements; after each, an interrupt flag can be set. </p><br><p>  <b>Accumulation.</b>  For each measurement, the result is added to the battery and the measurement counter is incremented. </p><br><p>  <b>Averaging</b>  For each measurement, the result is added to the battery and the measurement counter is incremented.  Upon reaching the specified number of repetitions, the result is divided and entered into the comparison module, and the next measurement will reset the counter to 1 and the battery value will be replaced with the result of the first measurement. </p><br><p>  <b>Queuing averaging.</b>  By launching the ADC, the battery and the measurement counter are cleaned and a series of measurements is performed a specified number of times, after which the result is divided and sent to the comparison module. </p><br><p>  <b>Low Pass Filter.</b>  Each measured value passes through the low-pass filter.  Upon completion of a specified number of measurements, the result falls into the comparison module. </p><br><h3>  Error calculation </h3><br><p>  Upon completion of each calculation, the result is recorded until the end of the next measurement.  It also calculates the difference between: </p><br><ul><li>  current and previous measurement (first derivative of a single measurement); </li><li>  two results in CVD measurement mode (differential CVD is calculated); </li><li>  current result and constant (setpoint); </li><li>  current result and filtered value; </li><li>  current and previous filtered values ‚Äã‚Äã(the first derivative of the filtered result); </li><li>  filtered value and constant (setpoint). </li></ul><br><p>  If you do not need to calculate the difference, then you can choose to calculate the difference between a constant equal to zero. </p><br><h3>  Comparison with thresholds </h3><br><p>  The result of the error calculation is compared with the upper and lower thresholds.  Additionally, an interrupt may be generated if: </p><br><ul><li>  the error is less than the lower threshold; </li><li>  the error is greater than or equal to the lower threshold; </li><li>  the error lies between the thresholds; </li><li>  error outside the thresholds; </li><li>  the error is less than or equal to the upper threshold; </li><li>  error greater than the upper threshold; </li><li>  formation of an interrupt regardless of the result of comparison with thresholds (this mode can be useful for fixing the very fact of comparison, that is, when, for example, you need to obtain filtering / averaging data after N-measurements, and not an interruption after each measurement). </li></ul><br><h2>  ADC Configuration Examples </h2><br><h3>  Autostart, Filtering </h3><br><p>  This example shows the ADC configuration in the Mplab Code Configurator (MCC) plugin for the following actions: </p><br><ul><li>  Timer2 timer is set to fire once per 1 ms; </li><li>  The ADC is triggered by a timer.  The ADC performs the pre-sampling and measurement, the result falls into the filter.  After accumulating 32 filtered measurements, a shift by 5 bits (division by 32) is made and an interrupt request is issued. <br>  The program only needs to read the register value from the register by interruption. </li></ul><br><img src="https://habrastorage.org/files/1dd/537/127/1dd537127aba46a9af9b4fb1c17dd2e8.png"><br><p>  Fig.  4. ADC settings with a calculator. </p><br><img src="https://habrastorage.org/files/4cc/b00/f1d/4ccb00f1db3f476e80c62c22d8c8a21e.png"><br><p>  Fig.  5. Read raw and filtered data from the ADC. </p><br><h3>  Autostart, CVD, averaging, interruption compared to thresholds </h3><br><p>  This example is based on the implementation of the ‚Äú <a href="http://microchip.wikidot.com/xpress:build-a-quick-capacitive-sensor-with-conductive-ink">fast creation of a capacitive sensor</a> ‚Äù from <a href="http://microchip.wikidot.com/">microchip.wikidot.com</a> [5]. </p><br><p>  The following configuration is selected: </p><br><ul><li>  Timer2 timer is set to fire every 10ms </li><li>  The ADC is triggered by the operation of the Timer 2 timer. The ADC measures by the CVD method and calculates the average value of 32 measurements.  After performing 32 measurements and accumulating the result, the division by 32 (shift by 5) is performed and if the total value lies outside the threshold values, then an interrupt request is formed, thus a ‚Äútouch‚Äù and ‚Äúrelease‚Äù of the touch button is reported (actually in this example, the interruption is generated every time, since the button is either pressed or not and does not have intermediate states)) </li></ul><br><img src="https://habrastorage.org/files/6c4/af7/fc6/6c4af7fc65354f088ee497f3cdcc46ac.png"><br><p>  Fig.  6. ADC settings for CVD. </p><br><img src="https://habrastorage.org/files/7d6/822/ba2/7d6822ba29684d188a39ab67f9db8c00.png"><br><p>  Fig.7.  Reaction to touch the touch button with a single CVD. </p><br><p>  Setting the threshold can give us an interruption not for each measurement / series of measurements with filtering, but at the touch of a ‚Äúbutton‚Äù. </p><br><h3>  Autostart, Differential CVD, Conversion Series, Averaging </h3><br><p>  This example uses the following peripheral configuration: </p><br><ul><li>  Timer2 timer is set to fire every 10ms </li><li>  The ADC is triggered by timer operation (see Figure 8, item 1).  The ADC performs sequential measurements using the differential CVD method (p.2) with a change in polarity (p.3), calculates the derivative (the difference between the 2nd CVD) (p.4), the ADC is set to calculate the average value (p.5) 32- x measurements (p.6).  After performing 32 pairs of measurements and accumulating the result, the division into 32 (paragraph 7) and the interrupt request (paragraph 8) are performed, successive measurements are stopped (paragraph 9) until the next trigger trigger (Timer2) </li></ul><br><img src="https://habrastorage.org/files/0fe/104/7a0/0fe1047a0e774e67b2a2e6f177be6060.png"><br><p>  Fig.  8. ADC settings for the differential CVD option. </p><br><img src="https://habrastorage.org/files/4a9/4f3/411/4a94f3411e5245f7a12ffea9b56bf5d1.png"><br><p>  Fig.  9, Chart at the input of a differential CVD sensor </p><br><img src="https://habrastorage.org/files/a6b/030/07e/a6b03007e556425ea020f54f419d7003.png"><br><p>  Fig.10.  Touch Response with Differential CVD </p><br><p>  From a comparison of CVD (Fig. 7) and differential CVD (Fig. 10), it can be seen that the second one is distinguished by a more ‚Äúpure‚Äù signal with a larger amplitude. </p><br><p>  The entire sequence of actions described is performed fully automatically and independently of the core - at this time, the MC can perform some other actions or be in the Sleep micro-consumption mode.  By interruption, it remains to calculate the averaged value of the measurement result. </p><br><h2>  Results </h2><br><p>  We looked at another part of the Peripheral Independent of the Core - the ADC with the transmitter in Microchip microcontrollers.  Some features, such as trigger triggering, or CVD are present in many PIC16F1xxx families, but a new ‚Äúfeature‚Äù - ADCC (ADC with a calculator) appeared in the PIC16F188xx family (PIC16F18855, etc.). </p><br><p>  The periphery independent of the core is interesting in and of itself, but the possibility of synthesizing functional blocks, i.e.  sharing of several peripheral modules for solving specific tasks.  In this case, the clock frequency, speed, and bit depth of the core go into the background - the hardware performs specialized functions, and the core deals with software support for the product. </p><br><p>  <b>PS</b> <br>  <b>Question to readers.</b>  Is it worth it to lay out the source code for the examples for some specific (cheap) demo board or from the descriptions and so everything is clear and code examples are not needed? </p><br><p>  Literature: </p><br><ol><li>  <a href="https://geektimes.ru/post/278718/">Configurable Logic Cells in PIC Controllers</a> </li><li>  <a href="https://geektimes.ru/post/279374/">50 shades of stub.</a>  <a href="https://geektimes.ru/post/279374/">I / O Ports</a> </li><li>  <a href="http://pickit2.ru/doku.php/all_articles:mtouch">Technology mTouch (tm).</a>  <a href="http://pickit2.ru/doku.php/all_articles:mtouch">Creating capacitive keyboards, sensors and screens.</a> </li><li>  PIC16 (L) F18855 / 75 Data Sheet.  www.microchip.com </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/397479/">https://habr.com/ru/post/397479/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../397463/index.html">PlayStation Meeting - the presentation of the novelties of the company Sony [broadcast over]</a></li>
<li><a href="../397465/index.html">HyperX Fury - when you don‚Äôt have to choose between accuracy and speed</a></li>
<li><a href="../397467/index.html">The space probe Gaia has compiled a detailed volume map of our galaxy.</a></li>
<li><a href="../397469/index.html">Innovation in detail, or 4 alternatives to the iPhone 7</a></li>
<li><a href="../397473/index.html">WAZER: the world's first desktop water cutter</a></li>
<li><a href="../397481/index.html">Overview of the Draytek 2925 Series Router. Part One: Overview, Features and Tests</a></li>
<li><a href="../397483/index.html">At the end of the month, Adobe will remove links to download Flash from your site.</a></li>
<li><a href="../397487/index.html">Heimdall - an amateur moon companion</a></li>
<li><a href="../397491/index.html">Marine says he served on Mars for 17 years</a></li>
<li><a href="../397493/index.html">How I made an electronic board for telemetry sensors and for controlling peripherals</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>