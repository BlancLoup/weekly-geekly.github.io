<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Domain telephony</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The study of the SIP protocol led to the understanding that it initially supports work with domain names. In particular, it is enough to create DNS re...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Domain telephony</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/366/d31/349/366d3134996a4252b2e13d243070465f.jpg"><br><br>  The study of the SIP protocol led to the understanding that it initially supports work with domain names.  In particular, it is enough to create DNS records like SRV and NAPTR to tell SIP clients where to look for your telephony server.  As a result, we are able to get users like alex@mysite.ru, director@mysite.ru, 101@mysite.ru and make calls directly to these numbers.  In particular, these numbers may coincide with the email address. <br><a name="habracut"></a><br><h2>  Free calls </h2><br>  The time when it will be possible to call via the Internet to any person on his SIP URI number, as well as to a regular phone is still far away, but now you can get clear advantages. <br><br>  Marketing component: You can advertise your company as the most focused on contact with the client, and give them different ways to communicate with employees. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For example, on an employee's business card, you can specify contacts for communication by analogy with an e-mail as sip: director@mysite.ru.  The bonus of such a call will be a detour of the voice menu, there is no need to dial an extension number - immediately connect with the employee you are interested in - save your time. <br><br>  You can make calls to your phone for free directly from the browser through WebRTC from various web services - this is an opportunity to save on the 8 800 hotline bill for telephone bills. Many of your customers can conveniently make calls directly from the computer in one click through the headset and not dial the number on mobile phone. <br><br>  In most cases, calls to SIP numbers are free for both parties.  And they make it possible to fully utilize the possibilities of modern telephony, for example, video communication.  You can hold open conferences and seminars. <br><br><h2>  Consider the setting on the popular office PBX Asterisk </h2><br>  When setting up your own server, a lot of attention should be paid to security.  Unfortunately, today telephony is a tasty morsel for hacking. <br><br>  We believe that Asterisk is already installed and configured for normal calls. <br><br>  First of all, we check if the firewall is enabled and configured on this server.  Configuration example for iptables for Debian.  The configuration is saved in /etc/iptables.up.  Boot using iptables-restore. <br><br>  Settings file /etc/iptables.up: <br><br><pre><code class="bash hljs">*filter <span class="hljs-comment"><span class="hljs-comment">#   ,      :INPUT DROP #    :FORWARD ACCEPT #    :OUTPUT ACCEPT #    -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT #    -A INPUT -i lo -j ACCEPT #   ping -A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT #    SSH -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT # RTP    ,   /etc/asterisk/rtp.conf -A INPUT -p udp -m udp --dport 10000:20000 -j ACCEPT # SIP  -A INPUT -p udp -m udp --dport 5060 -j ACCEPT -A INPUT -p tcp -m tcp --dport 5060 -j ACCEPT COMMIT</span></span></code> </pre> <br>  If necessary, we add rules for the nat and mangle tables, if the server is used as a gateway to the local network. <br><br>  We do autoload configuration.  To do this, add the post-up iptables-restore &lt;/etc/iptables.up line to the / etc / network / interfaces file after the interface description: <br><br><pre> <code class="bash hljs">allow-hotplug eth1 iface eth1 inet dhcp post-up iptables-restore &lt; /etc/iptables.up</code> </pre><br>  Further we configure fail2ban for the analysis of logs.  I recommend enabling SSH and Asterisk modules.  More setup is described <a href="http://habrahabr.ru/post/274731/">here</a> . <br><br><h2>  Configure DNS records </h2><br>  For calls to a SIP URI, you need to tell the callers where to look for the telephony server.  For this purpose, NAPTR and SRV records are used: <br><br>  The NAPTR record for the mysite.ru domain tells which services are supported: <br><br><pre> <code class="bash hljs">~$ host -t naptr mysite.ru mysite.ru has NAPTR record 10 50 <span class="hljs-string"><span class="hljs-string">"s"</span></span> <span class="hljs-string"><span class="hljs-string">"SIP+D2U"</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> _sip._udp.mysite.ru. mysite.ru has NAPTR record 10 51 <span class="hljs-string"><span class="hljs-string">"s"</span></span> <span class="hljs-string"><span class="hljs-string">"SIP+D2U"</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> _sip._udp.second.mysite.ru. mysite.ru has NAPTR record 20 50 <span class="hljs-string"><span class="hljs-string">"s"</span></span> <span class="hljs-string"><span class="hljs-string">"SIP+D2T"</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> _sip._tcp.mysite.ru. mysite.ru has NAPTR record 20 50 <span class="hljs-string"><span class="hljs-string">"s"</span></span> <span class="hljs-string"><span class="hljs-string">"SIPS+D2T"</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> _sips._tcp.mysite.ru.</code> </pre><br>  In this case, 4 NAPTR records are defined for the mysite.ru domain. <br><br><ul><li>  10 - Order field - service priority.  The lower the value, the higher the priority. </li><li>  50 - Preference field - the rule priority.  Checks only for identical Order values.  In this case, if the client supports the ‚ÄúSIP + D2U‚Äù service, then a request will first be sent to _sip._udp.mysite.ru, if it is not available, then to _sip._udp.second.mysite.ru </li><li>  ‚ÄúS‚Äù is the Flags field.  Indicates that the SRV record is in use. </li><li>  ‚ÄúSIP + D2U‚Äù - Service field.  Protocol that is supported.  In this case, SIP using UDP packets.  SIP + D2T - for TCP packets.  SIPS + D2T use TLS encryption over TCP packets. </li><li>  "" - field Regexp.  Regular expression to extract a domain name.  In this case, empty. </li><li>  _sip._udp.mysite.ru.  - SRV record name (server responsible for this type of connection). </li></ul><br>  Next you need to configure the SRV record: <br><br><pre> <code class="bash hljs">host -t srv _sip._udp.mysite.ru _sip._udp.mysite.ru has SRV record 10 0 5060 asterisk.mysite.ru.</code> </pre><br><ul><li>  _sip is the Service field.  Telephony service. </li><li>  _udp - field Proto - protocol.  Usually _udp or _tcp. </li><li>  mysite.ru - domain name for which an entry is created. </li><li>  10 - Priority field - sets the priority of this entry. </li><li>  0 - weight field - relative priority.  Plays value for entries with the same Priority. </li><li>  5060 - Port field.  Indicates on which port the server accepts SIP commands. </li><li>  asterisk.mysite.ru.  - Target field - server name. </li></ul><br>  As practice has shown, many SIP clients check only SRV records _sip._udp.  and _sip._tcp.  for your domain excluding information in NAPTR. <br><br>  More information on the communication of telephony with DNS can be read in the <a href="https://www.etsi.org/deliver/etsi_ts/184000_184099/184010/03.01.01_60/ts_184010v030101p.pdf">relevant standard</a> . <br><br><h2>  Configuring Asterisk Server </h2><br>  First, you need to allow calls without authorization and put them in a separate context.  To do this in sip.conf: <br><br><pre> <code class="bash hljs">[general] ... context=guest-call allowguest=yes ...</code> </pre><br>  Next, you need to create this context in the extensions.conf file: <br><br><pre> <code class="bash hljs">[guest-call] exten = &gt; director,1,Log(NOTICE,Good call IP=<span class="hljs-variable"><span class="hljs-variable">${CHANNEL(peerip)}</span></span>) exten = &gt; director,n,Dial(SIP/105@default) exten = &gt; alex,1,Log(NOTICE, Good call IP=<span class="hljs-variable"><span class="hljs-variable">${CHANNEL(peerip)}</span></span>) exten = &gt; alex,n,Dial(SIP/106@default) exten = &gt; 101,1,Log(NOTICE, Good call IP=<span class="hljs-variable"><span class="hljs-variable">${CHANNEL(peerip)}</span></span>) exten = &gt; 101,n,Dial(SIP/101@default) exten = &gt; _.,1,Log(WARNING,Wrong call IP=<span class="hljs-variable"><span class="hljs-variable">${CHANNEL(peerip)}</span></span>) exten = &gt; _.,n,Playback(bad-user) exten = &gt; _.,n,Hangup()</code> </pre><br>  Apply configuration sip reload and dialplan reload.  In this context, we log all unauthorized calls.  Next, the local subscriber is called.  Change default to your context with local users.  We register here all users for whom we will accept unauthorized calls. <br><br>  Wrong calls are logged with a separate message.  We can add analysis of this message to fail2ban to block the selection, for example, in the configuration file /etc/fail2ban/filter.d/asterisk.conf we add the line: <br><br><pre> <code class="bash hljs">failregex = ‚Ä¶ ‚Ä¶ ‚Ä¶ Wrong call IP=&lt;HOST&gt;</code> </pre><br>  Particular attention should be paid to this dialplan - you only need to allow calls to local users.  Correct setting will save you from unpleasant surprises to get a big bill for phone calls. <br><br>  It should also be remembered that vulnerabilities can be found in any software, for example, in the implementation of the SIP protocol or even an SSH server.  Therefore, it is advisable to set limits on the balance with your provider in order to avoid the risk of receiving a huge account. <br><br><h2>  Virtual Services Solution </h2><br>  Recently, virtual PBX services have become very popular, and many of them allow you to make and receive calls on the SIP URI.  There is also a <a href="https://digitoffice.ru/">Digital Office</a> service that allows you to bind your domain to a telephony service.  Using the services saves you from self-configuration and protection of the telephony server.  Most of them work on a prepaid basis and eliminate the risk of receiving large bills. <br><br>  After setup, you can receive calls from other services and call them.  You can also call other Asterisk servers if they support guest calls. </div><p>Source: <a href="https://habr.com/ru/post/276977/">https://habr.com/ru/post/276977/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276967/index.html">Hardware password manager or how to stop entering passwords and start living</a></li>
<li><a href="../276969/index.html">Dash opened source code for vending machine with InstantX</a></li>
<li><a href="../276971/index.html">RxSwift in action - we write reactive application</a></li>
<li><a href="../276973/index.html">Explaining the inexplicable. Part 2</a></li>
<li><a href="../276975/index.html">FRUSDR update for optimal server performance (INTEL platform)</a></li>
<li><a href="../276979/index.html">PRIMEFLEX vShape - turnkey solution for the implementation of virtualization</a></li>
<li><a href="../276981/index.html">Crash course on interfaces in go</a></li>
<li><a href="../276983/index.html">VK vulnerability: access to previews of photos from dialogues and hidden albums of any user</a></li>
<li><a href="../276987/index.html">Part-to-whole ratio in temporal / event ontology</a></li>
<li><a href="../276989/index.html">Checking WPF source code for examples from Infragistics</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>