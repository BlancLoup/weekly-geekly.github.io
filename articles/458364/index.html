<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fishnet Cases - How Microsoft Azure Helps with a Phishing Attack</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We publish an article following the traces of our performance on Fast Track OFFZONE-2019 with the report "Openwork Cases - How Microsoft Azure Helps w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fishnet Cases - How Microsoft Azure Helps with a Phishing Attack</h1><div class="post__text post__text-html js-mediator-article">  We publish an article following the traces of our performance on Fast Track OFFZONE-2019 with the report "Openwork Cases - How Microsoft Azure Helps with a Phishing Attack." <br><br>  When conducting a phishing attack with the distribution of a malicious attachment - the main problem is to bypass spam filters on the victim's mail server.  Mail for many companies is located in the Microsoft cloud - so you really need to be a mailing list guru so that a malicious attachment will skip past Microsoft's trained spam filters. <br><br>  When conducting RedTeam, we try to use legal means that users use.  For example, having a VPN service in a company helps us get into a company with user rights and, at the same time, cause a minimum of suspicion (or not at all). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There was an idea to see how Microsoft can help us.  We looked at what protection Microsoft provides and decided to see what kind of an animal this Azure Information Protection is. <br><a name="habracut"></a><br><h3>  Azure Information Protection </h3><br>  In this study, we will look at Azure Information Protection (AIP) - a tool that allows you to classify documents according to the degree of confidentiality and limit access to them for different users of the organization. <br><br>  It is very simple to use - software is swinging, with the help of which certain rights can be set for each document.  Tags and privacy levels are configured for each company - the administrator has these rights and responsibilities.  By default, created only 2 levels - Confidential and Highly Confidential. <br><br><img src="https://habrastorage.org/webt/rx/3y/83/rx3y83hdtlaigtb2gyj8-7x8gjk.png"><br><br>  It is also possible to allow access to individual users and assign them the right to use the document.  For example, if you need a specific user to change nothing in the document, but to get information, you can put the Viewer mode specially for him. <br><br><img src="https://habrastorage.org/webt/oj/ci/3b/ojci3b_7akd9_4414puo1jf0yjq.png"><br><br>  Azure Information Protection is integrated with Office365 and the user does not need additional software to open the document and perform authorized actions with it (from reading to revisions and full rights to the document). <br><br>  When using AIP not for Office365 - the pfile extension appears in the protected document and it is not possible to open it without Azure Information Protection Viewer. <br>  In general, the decision seemed interesting and we decided to conduct a study. <br><br>  To do a search we need: <br><br><ul><li>  select and register a suitable Microsoft account </li><li>  register 2 companies (attacker and victim) </li><li>  create a malicious document that we will send in a phishing email </li></ul><br><h3>  Microsoft account registration </h3><br>  For this study, we chose a Microsoft business account, because it has Azure Information Protection.  There are AIP in other tariff plans, you can get acquainted with them <a href="https://azure.microsoft.com/ru-ru/pricing/details/information-protection/">here</a> . <br><br>  We will not describe in detail the difficulties encountered in registering an account.  We will write briefly - from Russia it is impossible to register a business account yourself.  All because of the sanctions.  But you can contact your partners (official companies, there are 4 of them in Russia) or register on holiday from Europe after purchasing a local SIM card there. <br><br>  Registered 2 companies.  1 company - the company of the victim MyMetalCompany with the domain mymetalcompany.club and two users - Petr Petrov, Vasya Vasechkin.  The victim company does not use AIP. <br><br><img src="https://habrastorage.org/webt/y5/vn/sm/y5vnsmscgh6ujw-0aun3wwnwrts.png"><br><br>  2 company - an attacker company - Gem Company with a standard Microsoft domain - gemcompany.onmicrosoft.com and a single user - Evil User, which will send phishing emails to Petrov and Vasechkin. <br><br><img src="https://habrastorage.org/webt/qc/c1/hy/qcc1hygeifu80o-wgtvykdpr-10.png"><br><br>  Evil User will conduct an experiment with a malicious document, which is classified as DDEDownloader - a document with an embedded link that downloads the power shell script and runs on the command line.  Gem Company uses AIP. <br><br><h3>  Testing </h3><br>  Recall that our main goal is to make the malicious document go through spam filters and get to the user in the Inbox folder. <br><br>  The first thing to check is whether a malicious document arrives to the user if we send it in the so-called ‚Äúpure form‚Äù.  Let's send the just-formed document from Evil User to Comrade Vasechkin. <br><br>  The result was predictable - Microsoft didn‚Äôt like our letter and he decided that Vasechkin shouldn‚Äôt pay attention to such garbage.  Actually the letter to Vasechkin did not come. <br><br>  Let's try through Azure Information Protection to deliver that only Vasechkin in reading mode can open a document.  Why only in read mode?  Because it is important for us that the user opens the document, and what actions he will be able to perform with this document is completely indifferent.  Therefore, the reading mode is enough.  Note that we do not change anything in the document.  We simply set limits on working with the document.  Then some magic happens with encryption, which is organized by the AIP, but in this study it does not matter to us. <br><br><img src="https://habrastorage.org/webt/qx/ks/rl/qxksrlbqynti0r1_nddayqoqjfq.png"><br><br>  Let's send such a document to Petrov and Vasechkina.  Let's see what will happen with each of them.  Note that Petrov has no right to work with a document at all. <br><br>  The first thing you should pay attention to is that the malicious document got into the Inbox folder of both Petrov and Vasechkina! <br><br>  Vasechkin calmly opens the document using Microsoft Word.  No additional software is needed. <br><br><img src="https://habrastorage.org/webt/v2/vl/dm/v2vldmd3njstqtb1vxgorpkjqw4.png"><br><br>  We see that access is limited, but the entire contents of the document is also visible. <br><br>  Another point is that a document protected with AIP can be opened only in Word, i.e.  can not be viewed in the view mode in the mail client or in some online services. <br><br>  In Petrov, the situation is the opposite - he cannot open a document, because he has no ‚Äúdocuments‚Äù (as they say in one famous cartoon). <br><br><img src="https://habrastorage.org/webt/53/ug/kg/53ugkgce8wfa0g6vgggxc2laahk.png"><br><br>  From the minuses - you can see the account under which the document was protected using AIP.  This may provide some clue for BlueTeam when investigating an incident.  Otherwise, everything works according to the rules that we set. <br><br>  Great, but what happens if we just try to set privacy levels?  We don‚Äôt necessarily need someone to open a document - the main thing in this study is to get into the Inbox folder. <br><br>  We tried to set the Confidential confidentiality level for the document - the document was killed with a spam filter. <br><br>  Also restrictions can be put on the letter.  In the Outlook client, an add-on appears, which allows you to set restrictions on a letter, and they (according to how Microsoft writes in the documentation) - apply to the entire contents of the letter, including attachments.  An add-on appears if the user is using AIP.  In our case, Evil User uses it and has such an addition. <br><br>  We tried to put the label Highly Confidential on the letter with the attachment - the letter did not pass to the Inbox. <br><br>  We understand that ‚Äúfor all users‚Äù cannot be placed, because ‚Äúall users‚Äù includes service accounts that check incoming emails for malware. <br><br><h3>  Tracking system </h3><br>  One of the coolest AIP chips is the tracking system, which allows you to determine who, when and from where opened the document or tried to open it. <br><br>  In this case, we see that Petrov was trying to open the document, but he failed.  And Vasechkin opened the document.  When conducting a phishing attack, such a system is just a salvation ‚Äî you don‚Äôt need to think of anything, we immediately see whether the necessary comrade discovered the attachment or not. <br><br><img src="https://habrastorage.org/webt/ii/ax/_f/iiax_fvdw_cvcr0mcrqtrltcwl8.png"><br><br>  You can also configure the notification system so that an email arrives when you try to open a document. <br><br><h3>  findings </h3><br>  The purpose of the study was to get around the Microsoft spam filters using Microsoft itself (using the company's proposed protection). <br><br><ul><li>  The goal was successfully achieved with one remark - it is necessary to use AIP just for setting access rights to specific users.  Bypassing other means of protection - antivirus, intrusion detection systems that are activated when you open a document (we took a deliberately malicious document, which is detected by all means of protection) - it depends on your imagination.  We only sought letters in the Inbox. </li><li>  Azure Information Protection only works for users authorized by Office365 (this is the magic of encryption).  In almost all organizations, users are logged in to Office365 and there are no difficulties.  But take this fact into account. </li><li>  Tracking system is generally a smart thing and its use is convenient and practical. </li><li>  Using AIP to protect documents (as it were, for its intended purpose) is also cool and will give a headache to attackers - access to documents becomes more difficult. </li></ul><br>  The presentation from the very speech can be found on our <a href="https://github.com/mis-team/presentations/tree/master/offzone-2019">GitHub</a> . <br><br>  Thanks to the OFFZONE organizers for the conference!  It was interesting! </div><p>Source: <a href="https://habr.com/ru/post/458364/">https://habr.com/ru/post/458364/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../458354/index.html">Introduction to reversing from scratch using IDA PRO</a></li>
<li><a href="../458356/index.html">Studying the calendar</a></li>
<li><a href="../458358/index.html">Meinim is still legally: the experience of mining lightcoins in 2019</a></li>
<li><a href="../45836/index.html">About Subtitles and Lyrics on the iPhone and iPod Touch</a></li>
<li><a href="../458362/index.html">Single row multiplication table</a></li>
<li><a href="../458370/index.html">How fast results helped Ivan</a></li>
<li><a href="../458374/index.html">TJBOT as an illustration of IBM Watson services</a></li>
<li><a href="../458376/index.html">Not a regular programming language</a></li>
<li><a href="../458378/index.html">Use Avocode for site layout. Overview for beginners. Bonus - register a 30-day trial period</a></li>
<li><a href="../458382/index.html">Why do we teach this?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>