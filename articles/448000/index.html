<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to quickly try CQRS / ES in Laravel or write a bank in PHP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, in a podcast on Zinc Products , my colleagues and I discussed the CQRS / ES pattern and some features of its implementation in Elixir. Becau...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to quickly try CQRS / ES in Laravel or write a bank in PHP</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/_1/mv/ng/_1mvng1hgobkmr0xi8h7dryv32k.jpeg"></p><br><p>  Recently, in a podcast on <a href="https://soundcloud.com/znprod">Zinc Products</a> , my colleagues and I discussed the CQRS / ES pattern and some features of its implementation in Elixir.  Because  I use Laravel in my work, it was a sin not to rummage through the Internet and not to find out how to approach this approach in the ecosystem of this framework. </p><br><p>  I invite everyone under the cat, tried to describe the topic as briefly as possible. </p><a name="habracut"></a><br><h4 id="nemnozhko-opredeleniy">  Little definitions </h4><br><p>  <strong>CQRS</strong> (Command Query Responsibility Segregation) - selection of read and write operations into separate entities.  For example, we write to the master, we read from the replica.  <a href="https://habr.com/ru/post/347908/">CQRS.</a>  <a href="https://habr.com/ru/post/347908/">Facts and Fallacies</a> - will help to thoroughly learn Zen CQRS. <br>  <strong>ES</strong> (Event Sourcing) - storing all state changes of an entity or set of entities. <br>  <strong>CQRS / ES</strong> is an architectural approach where we save all events of a state change of an entity in the event table and add an aggregate and a projector to it. <br>  <strong>Aggregate</strong> - stores in memory the properties necessary for making decisions by the business of logic (to speed up writing), makes decisions (business logic) and publishes events. <br>  <strong>Projector</strong> - listens to events and writes in separate tables or bases (to speed up reading). </p><br><p><img src="https://habrastorage.org/webt/qw/44/au/qw44aus2nxjg3xg5ct_lfzn7lqk.jpeg"></p><br><h4 id="v-boy">  To battle </h4><br><p>  <a href="https://docs.spatie.be/laravel-event-projector/v2/introduction">Laravel event projector</a> - CQRS / ES library for Laravel <br>  <a href="https://github.com/spatie/larabank-event-projector-aggregates">Larabank</a> is a repository with a CQRS / ES implemented approach.  And take it on trial. </p><br><p>  The library configuration will tell you where to look and tell you what it is.  See the <a href="https://github.com/spatie/larabank-event-projector-aggregates/blob/7e0993e284353be6afd5e81b72bb617ec25f937f/config/event-projector.php">event-projector.php</a> file.  From the necessary to describe the work: </p><br><ul><li> <code>projectors</code> - register projectors; </li><li>  <code>reactors</code> - register the reactors.  Reactor - in this library adds side effects to event handling, for example, in this repository, if you try to exceed the withdrawal limit three times, the <a href="https://github.com/spatie/larabank-event-projector-aggregates/blob/7e0993e284353be6afd5e81b72bb617ec25f937f/app/Domain/Account/Events/MoreMoneyNeeded.php">MoreMoneyNeeded</a> event is written and a letter is sent to the user about its financial difficulties; </li><li>  <code>replay_chunk_size</code> - size of the chunk replay.  One of the features of ES is the ability to restore the history of events.  Laravel event projector prepared for a memory leak during such an operation using this setting. </li></ul><br><p>  Pay attention to migration.  In addition to standard Laravel tables, we have </p><br><ul><li>  <code>stored_events</code> is the main ES table with several columns of unstructured data for event meta data, a line storing event types.  The important column <code>aggregate_uuid</code> - stores the uuid of the aggregate, to receive all the events related to it; </li><li>  <code>accounts</code> - the table of the projector user accounts, necessary for quick return of current data on the state of balance; </li><li>  <code>transaction_counts</code> - the projector's table of the number of user transactions, necessary for the quick return of the number of completed transactions. </li></ul><br><p>  And now I propose to go along with the request to create a new account. </p><br><h4 id="sozdanie-scheta">  Account creation </h4><br><p>  Standard <code>resource</code> routing describes <a href="https://github.com/spatie/larabank-event-projector-aggregates/blob/110c29308f30fdd777655cb75269ff36c411d06e/app/Http/Controllers/AccountsController.php">Accounts Controls</a> .  We are interested in the <code>store</code> method </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">store</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Request $request)</span></span></span><span class="hljs-function"> </span></span>{ $newUuid = Str::uuid(); <span class="hljs-comment"><span class="hljs-comment">//   ,   uuid  //      AccountAggregateRoot::retrieve($newUuid) //           -&gt;createAccount($request-&gt;name, auth()-&gt;user()-&gt;id) //          -&gt;persist(); return back(); }</span></span></code> </pre> <br><p>  <a href="https://github.com/spatie/larabank-event-projector-aggregates/blob/7e0993e284353be6afd5e81b72bb617ec25f937f/app/Domain/Account/AccountAggregateRoot.php">AccountAggregateRoot</a> inherits the <a href="https://github.com/spatie/laravel-event-projector/blob/4808924a542a7ba1f1fafeed829ef9983ad2060b/src/AggregateRoot.php">AggregateRoot</a> library.  Let's see the methods that the controller called. </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//  uuid      public static function retrieve(string $uuid): AggregateRoot { $aggregateRoot = (new static()); $aggregateRoot-&gt;aggregateUuid = $uuid; return $aggregateRoot-&gt;reconstituteFromEvents(); } public function createAccount(string $name, string $userId) { //        //  ,   recordThat,  ,    , // ..     ) $this-&gt;recordThat(new AccountCreated($name, $userId)); return $this; }</span></span></code> </pre> <br><p>  The <code>persist</code> method calls the <code>storeMany</code> method <code>storeMany</code> the model specified in the configuration <a href="https://github.com/spatie/larabank-event-projector-aggregates/blob/7e0993e284353be6afd5e81b72bb617ec25f937f/config/event-projector.php">event-projector.php</a> as <code>stored_event_model</code> in our case <a href="https://github.com/spatie/laravel-event-projector/blob/4808924a542a7ba1f1fafeed829ef9983ad2060b/src/Models/StoredEvent.php">StoredEvent</a> </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">storeMany</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $events, string $uuid = null)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ collect($events) -&gt;map(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ShouldBeStored $domainEvent)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($uuid)</span></span></span><span class="hljs-function"> </span></span>{ $storedEvent = <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::createForEvent($domainEvent, $uuid); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [$domainEvent, $storedEvent]; }) -&gt;eachSpread(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ShouldBeStored $event, StoredEvent $storedEvent)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   ,     // QueuedProjector* Projectionist::handleWithSyncProjectors($storedEvent); if (method_exists($event, 'tags')) { $tags = $event-&gt;tags(); } //         $storedEventJob = call_user_func( [config('event-projector.stored_event_job'), 'createForEvent'], $storedEvent, $tags ?? [] ); dispatch($storedEventJob-&gt;onQueue(config('event-projector.queue'))); }); }</span></span></code> </pre> <br><p>  * <em><a href="https://github.com/spatie/laravel-event-projector/blob/d7f68f1f4372ba6c4dfcea1b84b74dc596877765/src/Projectors/QueuedProjector.php">QueuedProjector</a></em> </p><br><p>  The <a href="https://github.com/spatie/larabank-event-projector-aggregates/blob/7e0993e284353be6afd5e81b72bb617ec25f937f/app/Domain/Account/Projectors/AccountProjector.php">AccountProjector</a> and <a href="https://github.com/spatie/larabank-event-projector-aggregates/blob/7e0993e284353be6afd5e81b72bb617ec25f937f/app/Domain/Account/Projectors/TransactionCountProjector.php">TransactionCountProjector</a> projectors implement the <code>Projector</code> so that they will react to events synchronously with their recording. </p><br><p>  Ok, account created.  I propose to consider how the client will read it. </p><br><h4 id="otobrazhenie-scheta">  Invoice display </h4><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//    `accounts`     id public function index() { $accounts = Account::where('user_id', Auth::user()-&gt;id)-&gt;get(); return view('accounts.index', compact('accounts')); }</span></span></code> </pre> <br><p>  If the invoice projector implements the <a href="https://github.com/spatie/laravel-event-projector/blob/d7f68f1f4372ba6c4dfcea1b84b74dc596877765/src/Projectors/QueuedProjector.php">QueuedProjector</a> interface, then the user will not see anything until the event is processed in turn. </p><br><p>  Finally, we will study how the deposit and withdrawal of money works. </p><br><h4 id="popolnenie-i-snyatie">  Deposit and withdrawal </h4><br><p>  Again, look at the <a href="https://github.com/spatie/larabank-event-projector-aggregates/blob/110c29308f30fdd777655cb75269ff36c411d06e/app/Http/Controllers/AccountsController.php">AccountsController</a> controller: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//    uuid  //       //   ,     public function update(Account $account, UpdateAccountRequest $request) { $aggregateRoot = AccountAggregateRoot::retrieve($account-&gt;uuid); $request-&gt;adding() ? $aggregateRoot-&gt;addMoney($request-&gt;amount) : $aggregateRoot-&gt;subtractMoney($request-&gt;amount); $aggregateRoot-&gt;persist(); return back(); }</span></span></code> </pre> <br><p>  Consider <a href="https://github.com/spatie/larabank-event-projector-aggregates/blob/7e0993e284353be6afd5e81b72bb617ec25f937f/app/Domain/Account/AccountAggregateRoot.php">AccountAggregateRoot</a> </p><br><p>  when replenishing an account: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addMoney</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $amount)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;recordThat(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MoneyAdded($amount)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//    ""  recordThat // AggregateRoot*? //     apply(ShouldBeStored $event), //       'apply' . EventClassName  // ,     `MoneyAdded` protected function applyMoneyAdded(MoneyAdded $event) { $this-&gt;accountLimitHitInARow = 0; $this-&gt;balance += $event-&gt;amount; }</span></span></code> </pre> <br><p>  * <em><a href="https://github.com/spatie/laravel-event-projector/blob/4808924a542a7ba1f1fafeed829ef9983ad2060b/src/AggregateRoot.php">AggregateRoot</a></em> </p><br><p>  when withdrawing funds: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">subtractMoney</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $amount)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;hasSufficientFundsToSubtractAmount($amount)) { <span class="hljs-comment"><span class="hljs-comment">//        $this-&gt;recordThat(new AccountLimitHit()); //      ,  //   ,     //     if ($this-&gt;needsMoreMoney()) { $this-&gt;recordThat(new MoreMoneyNeeded()); } $this-&gt;persist(); throw CouldNotSubtractMoney::notEnoughFunds($amount); } $this-&gt;recordThat(new MoneySubtracted($amount)); } protected function applyMoneySubtracted(MoneySubtracted $event) { $this-&gt;balance -= $event-&gt;amount; $this-&gt;accountLimitHitInARow = 0; }</span></span></code> </pre> <br><p><img src="https://habrastorage.org/webt/wo/nv/4m/wonv4mfqesn7tejbn6jasjkmshc.jpeg"></p><br><h4 id="zaklyuchenie">  Conclusion </h4><br><p>  I tried as much as possible without water to describe the onboarding process in CQRS / ES on Laravel.  The concept is very interesting, but not without features.  Before embedding remember: </p><br><ul><li>  eventual consistency; </li><li>  it is desirable to use DDD in separate domains, you should not make a large system entirely on this pattern; </li><li>  changes in the pattern of the event table can be very painful; </li><li>  Responsible is to approach the choice of granularity of events, the more specific events there are, the more they will be in the table and more resources will be needed to work with them. </li></ul><br><p>  I will be glad to see the errors. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/448000/">https://habr.com/ru/post/448000/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447986/index.html">A very mathematical history of the perfect combination of colors.</a></li>
<li><a href="../447990/index.html">The story of the classic game hacking on Dendy or Contra with the spreadgan in the beginning</a></li>
<li><a href="../447992/index.html">Find out the age of the user VK or what else can tell the social graph</a></li>
<li><a href="../447996/index.html">How scientists study the genes that control the complete regeneration of the body</a></li>
<li><a href="../447998/index.html">Time Travel Debugging in Visual Studio Enterprise 2019</a></li>
<li><a href="../448002/index.html">What is heisenbag: the history of the term and examples</a></li>
<li><a href="../448004/index.html">Response to "Easel for microcontroller programmer"</a></li>
<li><a href="../448008/index.html">Choosing a software life cycle strategy when there are several dependent frontends</a></li>
<li><a href="../448010/index.html">3 weeks with Galaxy S10: pros and cons</a></li>
<li><a href="../448016/index.html">Clinical analysis of urine at home on the test strips: the pros and cons</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>