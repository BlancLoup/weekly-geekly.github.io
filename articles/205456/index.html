<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to make friends with the Yandex API and AJAX captcha</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dear colleagues. Disputes about whether the so-called ‚Äúcaptcha‚Äù is needed, whether it brings real benefits in the fight against evil robots, or just h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to make friends with the Yandex API and AJAX captcha</h1><div class="post__text post__text-html js-mediator-article">  Dear colleagues.  Disputes about whether the so-called ‚Äúcaptcha‚Äù is needed, whether it brings real benefits in the fight against evil robots, or just harms the project‚Äôs usability has long subsided, and everyone who in one way or another was interested in this issue drew the appropriate conclusions for themselves. <br><br>  However, faced with the need to install a captcha in the authorization form for the next project, and after a few hours of fussing with the reCaptcha service, which generates tons of <s>garbage</s> code on the page, I still could not find a ready solution that would suit me one hundred percent .  Well, if you want to do something - do it yourself. <br><br>  This article focuses on the transformation of a simple and convenient API Yandex - Clean Web into a full-fledged, modern and functional captcha.  And since we are talking about the authorization module, I think it would be appropriate to show how our new captcha works in conjunction with the module. <br><a name="habracut"></a><br>  So, we will need: <br>  <a href="http://api.yandex.ru/cleanweb/">API Yandex - Net Web</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I think that lovers of native js will not need anything else, I used the <a href="http://jquery.com/">jQuery</a> library <br><br>  First we turn to the Yandex API, because first we need to get the desired captcha.  After reading the documentation we write the class, which actually gives it to: <br><br>  <b>class_yandex_capcha.php</b> <br><br><pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">yandexCaptcha</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $lang = $_SESSION[<span class="hljs-string"><span class="hljs-string">'lang'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($lang == <span class="hljs-string"><span class="hljs-string">"ru"</span></span>) { $type = <span class="hljs-string"><span class="hljs-string">"std"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $type = <span class="hljs-string"><span class="hljs-string">"estd"</span></span>; } $key = <span class="hljs-string"><span class="hljs-string">" API "</span></span>; $xmlResponse = file_get_contents(<span class="hljs-string"><span class="hljs-string">"http://cleanweb-api.yandex.ru/1.0/get-captcha?key="</span></span>.$key.<span class="hljs-string"><span class="hljs-string">"&amp;type="</span></span>.$type); $xml = simplexml_load_string($xmlResponse); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $xml-&gt;url; } }</code> </pre> <br><br>  Everything is extremely simple - send a GET request with parameters: <br>  $ key - Yandex API Key, <a href="">You can get it here.</a> <br>  $ type is the type of captcha that we want to receive, the values ‚Äã‚Äãtaken by the variable are fully described in the Yandex documentation. <br><br>  In my case, the site supports several languages ‚Äã‚Äã- therefore, depending on the language, we select: <i>std</i> - numbers and the Yandex logo in Russian, or <i>estd</i> - also numbers, but with a logo in English. <br><br>  The <b>yandexCaptcha :: get ()</b> method now returns the image address - this is our captcha. <br>  In addition to the "url image captcha" xml method request returns another parameter - <u>captcha</u> , but there is a little trick thanks to which <br>  the captcha parameter can be not stored, say in a session.  It can not be stored at all, why - I will explain a little further. <br><br>  When our class is ready - we build it into the model of the authorization page on the site: <br><br>  <b>model_closed.php</b> <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">model_closed</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">model</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $root = $_SERVER[<span class="hljs-string"><span class="hljs-string">'DOCUMENT_ROOT'</span></span>]; $dataArray[<span class="hljs-string"><span class="hljs-string">'language'</span></span>] = parse_ini_file($root.<span class="hljs-string"><span class="hljs-string">"/app/languages/"</span></span>.Route::$lang.<span class="hljs-string"><span class="hljs-string">"_closed.ini"</span></span>); $dataArray[<span class="hljs-string"><span class="hljs-string">'base_href'</span></span>] = $_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTP_HOST'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span>($root.<span class="hljs-string"><span class="hljs-string">"/app/core/class/class_yandex_capcha.php"</span></span>); $dataArray[<span class="hljs-string"><span class="hljs-string">'capcha_url'</span></span>] = yandexCaptcha::get(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $dataArray; } }</code> </pre><br><br>  The last three lines of the <b>get_data ()</b> method give the captcha picture to the view: <br><br>  But actually the presentation - <b>closed_view.php</b> <br><br><pre> <code class="php hljs">&lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">closedLoginForm</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">input</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">loginInput</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">="&lt;?</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">php</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">echo</span></span></span><span class="hljs-class"> $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">language</span></span></span><span class="hljs-class">']['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">login</span></span></span><span class="hljs-class">']; ?&gt;"&gt;&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">br</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">input</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">password</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">passworldInput</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">="&lt;?</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">php</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">echo</span></span></span><span class="hljs-class"> $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">language</span></span></span><span class="hljs-class">']['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">passworld</span></span></span><span class="hljs-class">']; ?&gt;"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">capcha</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">title</span></span></span><span class="hljs-class">="&lt;?</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">php</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">echo</span></span></span><span class="hljs-class"> $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">language</span></span></span><span class="hljs-class">']['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">reload_image</span></span></span><span class="hljs-class">']; ?&gt;"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">img</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">yandexCapchaImage</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">src</span></span></span><span class="hljs-class">="" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">alt</span></span></span><span class="hljs-class">="&lt;?</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">php</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">echo</span></span></span><span class="hljs-class"> $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">language</span></span></span><span class="hljs-class">']['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">capcha</span></span></span><span class="hljs-class">']; ?&gt;"&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">input</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">capchaInput</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">="&lt;?</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">php</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">echo</span></span></span><span class="hljs-class"> $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">language</span></span></span><span class="hljs-class">']['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">capcha</span></span></span><span class="hljs-class">']; ?&gt;"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">loginButton</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">loginBottonInner</span></span></span><span class="hljs-class">"&gt;&lt;?</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">php</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">echo</span></span></span><span class="hljs-class"> $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">language</span></span></span><span class="hljs-class">']['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">loginBotton</span></span></span><span class="hljs-class">']; ?&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">loginError</span></span></span><span class="hljs-class">"&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">script</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">javascript</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">src</span></span></span><span class="hljs-class">="/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">js</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">jquery</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">js</span></span></span><span class="hljs-class">"&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">script</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">script</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">javascript</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">src</span></span></span><span class="hljs-class">="/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">js</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">closed</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">js</span></span></span><span class="hljs-class">"&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">script</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">script</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">javascript</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">src</span></span></span><span class="hljs-class">="/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">js</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">login</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">js</span></span></span><span class="hljs-class">"&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">script</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre><br><br>  As you can see from the presentation, there are no <b>form</b> tags in the html code <b>,</b> which means that <b>we will</b> most likely <b>use AJAX for authorization</b> . <br><br>  In the view, we have 3 fields: a login, password, and a captcha field, a captcha picture itself, and a send button. <br><br>  Send the form, as mentioned earlier, we will use the AJAX request in <b>login.js</b> <br><br><div class="spoiler">  <b class="spoiler_title">A lot of code, but it is here - the whole point</b> <div class="spoiler_text"><pre> <code class="javascript hljs">$(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>).ready(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> capchaStartText = $(<span class="hljs-string"><span class="hljs-string">".capchaInput"</span></span>).val(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> passworldStartText = $(<span class="hljs-string"><span class="hljs-string">".passworldInput"</span></span>).val(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> login = $(<span class="hljs-string"><span class="hljs-string">".loginInput"</span></span>), passworld = $(<span class="hljs-string"><span class="hljs-string">".passworldInput"</span></span>), capcha = $(<span class="hljs-string"><span class="hljs-string">".capchaInput"</span></span>), buttontext = $(<span class="hljs-string"><span class="hljs-string">".loginBottonInner"</span></span>).html(), captchasrc = $(<span class="hljs-string"><span class="hljs-string">".yandexCapchaImage"</span></span>).attr(<span class="hljs-string"><span class="hljs-string">"src"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pos = captchasrc.indexOf(<span class="hljs-string"><span class="hljs-string">"="</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> key = captchasrc.substr(pos+<span class="hljs-number"><span class="hljs-number">1</span></span>); $.ajax({ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>, <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">"/app/modules/module_login.php"</span></span>, <span class="hljs-attr"><span class="hljs-attr">dataType</span></span>: <span class="hljs-string"><span class="hljs-string">"json"</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: {<span class="hljs-attr"><span class="hljs-attr">login</span></span>:login.val(), <span class="hljs-attr"><span class="hljs-attr">passworld</span></span>:passworld.val(), <span class="hljs-attr"><span class="hljs-attr">captchaCode</span></span>:key, <span class="hljs-attr"><span class="hljs-attr">captchaValue</span></span>:capcha.val()}, <span class="hljs-attr"><span class="hljs-attr">beforeSend</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ $(<span class="hljs-string"><span class="hljs-string">".loginBottonInner"</span></span>).html(<span class="hljs-string"><span class="hljs-string">"..."</span></span>); } }).done(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data.captcha == <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; data.login == <span class="hljs-number"><span class="hljs-number">1</span></span>) { location.reload(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data.login == <span class="hljs-number"><span class="hljs-number">0</span></span>) { capchaRenew(); $(<span class="hljs-string"><span class="hljs-string">".loginBottonInner"</span></span>).html(buttontext); login.focus(); login.select(); passworld.val(passworldStartText); capcha.val(capchaStartText); $(<span class="hljs-string"><span class="hljs-string">".loginError"</span></span>).html(data.login_error); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data.captcha == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; data.login == <span class="hljs-number"><span class="hljs-number">1</span></span>) { capchaRenew(); $(<span class="hljs-string"><span class="hljs-string">".loginBottonInner"</span></span>).html(buttontext); capcha.val(capchaStartText); capcha.focus(); $(<span class="hljs-string"><span class="hljs-string">".loginError"</span></span>).html(data.captcha_error); } }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">capchaRenew</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ $.ajax({ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: {<span class="hljs-attr"><span class="hljs-attr">check</span></span>:<span class="hljs-string"><span class="hljs-string">"ok"</span></span>}, <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">"/app/modules/module_capcha_renew.php"</span></span> }).done(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">html</span></span></span><span class="hljs-function">) </span></span>{ $(<span class="hljs-string"><span class="hljs-string">".yandexCapchaImage"</span></span>).attr(<span class="hljs-string"><span class="hljs-string">"src"</span></span>,html); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(html); }); } $(<span class="hljs-string"><span class="hljs-string">"#capcha"</span></span>).click(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ capchaRenew(); $(<span class="hljs-string"><span class="hljs-string">".capchaInput"</span></span>).focus(); }); $(<span class="hljs-string"><span class="hljs-string">".loginBottonInner"</span></span>).click(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ login(); }); $(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>).keydown(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">eventObject</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($(<span class="hljs-string"><span class="hljs-string">".closedLoginForm input"</span></span>).is(<span class="hljs-string"><span class="hljs-string">":focus"</span></span>) == <span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (eventObject.which == <span class="hljs-number"><span class="hljs-number">13</span></span>) { login(); } } }); });</code> </pre><br></div></div><br><br>  <b>Now we need to check the captcha.</b> <br>  To do this, from the fields of our form by clicking on the ‚Äúsend‚Äù button or on the Enter button (we love users), we grab all the data - the login, password, character set entered by the user in the captcha field, and one more parameter I wrote about above - the same parameter <u>captcha</u> (see the description of the method <b>yandexCaptcha :: get ()</b> ). <br>  The fact is that this parameter is the <b>key for checking the correctness of captcha input by the user</b> initially present on the page as part of the captcha image URL.  Yandex gives her all in the same method <b>yandexCaptcha :: get ()</b> .  We can only ‚Äúisolate‚Äù the <u>captcha</u> parameter from the url of the image address, which we do. <br><br>  The <b>module_login.php</b> file <b>to</b> which we transfer data using an AJAX request, creates an instance <b>of the Login class</b> ‚Äî the main class we use to authorize users on the site; calls the <b>siteLogin ()</b> method that returns data on the result of the authorization, checking the correctness of the login-password combination and, What interests us most is the <i>correctness of captcha input.</i> <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> Login::siteLogin($login, $passworld, $captchaCode, $captchaValue);</code> </pre><br><br>  So that my article, which already turned out to be much longer than I had planned, did not grow to a completely enormous size, I will give only that part of the <b>Login :: siteLogin method</b> that is responsible for checking the captcha: <br><br>  <b>class_login.php</b> <br><br><div class="spoiler">  <b class="spoiler_title">Actually code</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Login</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">siteLogin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($login, $password, $captchaCode, $captchaValue)</span></span></span><span class="hljs-function"> </span></span>{ $path = $_SERVER[<span class="hljs-string"><span class="hljs-string">'DOCUMENT_ROOT'</span></span>]; session_start(); $langArray = parse_ini_file($path.<span class="hljs-string"><span class="hljs-string">"/app/languages/"</span></span>.$_SESSION[<span class="hljs-string"><span class="hljs-string">'lang'</span></span>].<span class="hljs-string"><span class="hljs-string">"_login.ini"</span></span>); $login = htmlspecialchars($login); $password = htmlspecialchars($password); $json = <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>(); $json[<span class="hljs-string"><span class="hljs-string">'captcha'</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; $json[<span class="hljs-string"><span class="hljs-string">'login'</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; $json[<span class="hljs-string"><span class="hljs-string">'captcha_error'</span></span>] = $langArray[<span class="hljs-string"><span class="hljs-string">'captcha_error'</span></span>]; $json[<span class="hljs-string"><span class="hljs-string">'login_error'</span></span>] = $langArray[<span class="hljs-string"><span class="hljs-string">'login_error'</span></span>]; $key = <span class="hljs-string"><span class="hljs-string">" API "</span></span>; $response = file_get_contents(<span class="hljs-string"><span class="hljs-string">"http://cleanweb-api.yandex.ru/1.0/check-captcha?key="</span></span>.$key.<span class="hljs-string"><span class="hljs-string">"&amp;captcha="</span></span>.$captchaCode.<span class="hljs-string"><span class="hljs-string">"&amp;value="</span></span>.$captchaValue); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strpos($response,<span class="hljs-string"><span class="hljs-string">"&lt;ok"</span></span>)){ $json[<span class="hljs-string"><span class="hljs-string">'captcha'</span></span>] = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>($json[<span class="hljs-string"><span class="hljs-string">'captcha_error'</span></span>]); } <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> $path.<span class="hljs-string"><span class="hljs-string">"/app/core/class/class_dbconnect.php"</span></span>; $mysqli = dbconnect::connect(); $sql = <span class="hljs-string"><span class="hljs-string">"SELECT `id`,`login`,`passworld`,`rights` FROM `users` WHERE `login` = '"</span></span>.$login.<span class="hljs-string"><span class="hljs-string">"'"</span></span>; $qr = $mysqli-&gt;query($sql); $quant = $qr-&gt;num_rows; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($quant &lt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { $row = $qr-&gt;fetch_assoc(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($row[<span class="hljs-string"><span class="hljs-string">'passworld'</span></span>] == hash(<span class="hljs-string"><span class="hljs-string">"whirlpool"</span></span>,<span class="hljs-string"><span class="hljs-string">"super"</span></span>.$password.<span class="hljs-string"><span class="hljs-string">"orgy"</span></span>)) { $json[<span class="hljs-string"><span class="hljs-string">'login'</span></span>] = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>($json[<span class="hljs-string"><span class="hljs-string">'login_error'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($json[<span class="hljs-string"><span class="hljs-string">'login'</span></span>] == <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> $json[<span class="hljs-string"><span class="hljs-string">'captcha'</span></span>] == <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//!    } } } return json_encode($json); } }</span></span></code> </pre><br></div></div><br><br>  * I thought about it and decided to bring all the code so that the reader could understand where the legs grow from. <br>  The essence of captcha checking is again a GET request according to the Yandex API; <br><br>  Accordingly, they led the right combination of login / password + captcha passed the test - Hooray!  We are authorized. <br><br>  Further, I think there will be the <b>most important moment of the article</b> .  I draw the attention of those who are still reading - it all comes down to the architecture of the application. <br><br>  Suppose the user made a mistake when entering a captcha, or simply cannot parse the text in the picture and wants to update it. <br><br>  <b>Warning - he does not need to make any extra gestures</b> <br><br>  In case of an error, the username and password entered by the user earlier are saved, and the captcha image is automatically updated.  And if the user decides to update the captcha - it is enough for him to simply click on it. <br><br>  Let's <b>go</b> back to the contents of the <b>login.js</b> file, and look at the <b>capchaRenew ()</b> function <b>.</b> <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">capchaRenew</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ $.ajax({ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: {<span class="hljs-attr"><span class="hljs-attr">check</span></span>:<span class="hljs-string"><span class="hljs-string">"ok"</span></span>}, <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">"/app/modules/module_capcha_renew.php"</span></span> }).done(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">html</span></span></span><span class="hljs-function">) </span></span>{ $(<span class="hljs-string"><span class="hljs-string">".yandexCapchaImage"</span></span>).attr(<span class="hljs-string"><span class="hljs-string">"src"</span></span>,html); }); }</code> </pre><br><br>  So - we just make a request to the module <b>module_capcha_renew.php the</b> whole function of which comes down to <br>  to reshape the captcha using the same method <b>yandexCaptcha :: get ()</b> that we addressed when loading the page and give the address of the new image to the user. <br><br>  As a result, we have a fully functional captcha, user friendly enough.  And most importantly, unlike the same reCapcha, there are no iframes, all the code is rather laconic, and is completely under our control. </div><p>Source: <a href="https://habr.com/ru/post/205456/">https://habr.com/ru/post/205456/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../205446/index.html">Variable number of arguments: problems and solutions</a></li>
<li><a href="../205448/index.html">Interface Digest, October-November 2013</a></li>
<li><a href="../205450/index.html">Axure Interactive Prototype in 20 Minutes</a></li>
<li><a href="../205452/index.html">20 years DOOM</a></li>
<li><a href="../205454/index.html">Data replication. Attunity Replicate and Greenplum</a></li>
<li><a href="../205458/index.html">Installing XenServer 6.2 in Hetzner</a></li>
<li><a href="../205460/index.html">Setting up an Internet gateway for a small office CentOS, Iptables, NAT, Squid Transparent, Sarg</a></li>
<li><a href="../205462/index.html">Reading Mettler Toledo PS60 Scale Data</a></li>
<li><a href="../205464/index.html">Working with Group Policy Preferences: Interacting with Local Accounts</a></li>
<li><a href="../205466/index.html">Development of Windows 8.1 applications on XAML / –° #. Part 3. Toolbars</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>