<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Track Changes in SQL Server 2008</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think every DBMS developer will sooner or later be confronted with the task of tracking database calls and server events in general. And before you ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Track Changes in SQL Server 2008</h1><div class="post__text post__text-html js-mediator-article">  I think every DBMS developer will sooner or later be confronted with the task of tracking database calls and server events in general.  And before you choose a tool (or write it yourself), of course, you should pay attention to the solutions offered by the DBMS developers themselves.  I want to share the experience of solving this problem for SQL Server 2008. <a name="habracut"></a><br><br>  At the moment there are 4 such solutions for SQL Server 2008 (for SQL Server 2011, no significant changes in this area are foreseen).  Some of these tools came from earlier versions, some appeared in 2008. These tools overlap in many ways, therefore, sometimes it‚Äôs not easy to choose one (or more) tools for solving a specific task.  In this I will try to help, having a brief overview of each tool with an example. <br><br><h4>  <b>1. CT (Change Tracking).</b> </h4><br>  Often confused with CDC (Change Data Capture).  But these tools are different in purpose and in implementation.  CT is designed to track changes (in which lines, which data has been changed (C <s>R</s> UD)), while the CDC keeps a history of changes (all versions of the lines, including those that have been deleted).  As for the implementation, the CDC is based on reading the transaction log (asynchronous), while CT works synchronously. <br>  For each table for which change tracking is enabled, a system table is created in which the ID of the modified row is stored, a bitmask to identify the changed columns, and the type of operation. <br>  To enable CT, you need to activate it at the database level and for a specific table: <br><blockquote> <code><font color="#0000FF">ALTER</font> <font color="#0000FF">DATABASE</font> ChangeTracking <font color="#0000FF">SET</font> change_tracking <font color="#808080">=</font> <font color="#0000FF">ON</font> &lt;br/&gt; <br> <font color="#808080">(</font> change_retention <font color="#808080">=</font> <font>10</font> minutes, auto_cleanup <font color="#808080">=</font> <font color="#0000FF">ON</font> <font color="#808080">)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#0000FF">ALTER</font> <font color="#0000FF">TABLE</font> Orders enable change_tracking <font color="#0000FF">WITH</font> <font color="#808080">(</font> track_columns_updated <font color="#808080">=</font> <font color="#0000FF">ON</font> <font color="#808080">)</font> <br></code> </blockquote> <code><font color="#0000FF">ALTER</font> <font color="#0000FF">DATABASE</font> ChangeTracking <font color="#0000FF">SET</font> change_tracking <font color="#808080">=</font> <font color="#0000FF">ON</font> &lt;br/&gt; <br> <font color="#808080">(</font> change_retention <font color="#808080">=</font> <font>10</font> minutes, auto_cleanup <font color="#808080">=</font> <font color="#0000FF">ON</font> <font color="#808080">)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#0000FF">ALTER</font> <font color="#0000FF">TABLE</font> Orders enable change_tracking <font color="#0000FF">WITH</font> <font color="#808080">(</font> track_columns_updated <font color="#808080">=</font> <font color="#0000FF">ON</font> <font color="#808080">)</font> <br></code> <br>  More details (description of the parameters, examples of use and detailed information) in an excellent <a href="http://blogs.msdn.com/b/alexejs/archive/2009/08/09/change-tracking.aspx">article</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  <b>2. CDC (Change Data Capture)</b> </h4><br>  Tool for tracking changed data.  The main differences from CT are the asynchronous implementation (as stated above) and the storage of all versions of modified (C <s>R</s> UD) data.  CDC uses system tables in the cdc schema to store modified data.  For each table for which CDC is activated, a table is created with a name like cdc.dbo_Orders_CT (for the dbo.Orders table). <br><br><img src="https://habrastorage.org/storage/habraeffect/dd/74/dd744df81a5d46734b5422dd1e6271f5.png" alt="image"><br><ul><li>  * _lsn - (log sequence number) - a kind of transaction identifiers in the log. <br>  $ operation - type of operation (1 - delete, 2 - insert, 3 - update (version of the line before the update), 4 - update (version of the line after the update). </li><li>  $ update_mask is a bitmask indicating the changed cells in the row. </li><li>  ID and all the others on the right - cells sootv.  The structure of the table, changes in which are tracked. </li></ul><br>  To activate CDC, you need to activate it at the database level for a specific table: <br><blockquote> <code><font color="#0000FF">EXEC</font> sys. <font color="#202020">sp_cdc_enable_db</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#0000FF">EXEC</font> sys. <font color="#202020">sp_cdc_enable_table</font> &lt;br/&gt; <br> @source_schema <font color="#808080">=</font> N <font color="#FF0000">'dbo'</font> ,&lt;br/&gt; <br> @source_name <font color="#808080">=</font> N <font color="#FF0000">'Orders'</font> ,&lt;br/&gt; <br> @role_name <font color="#808080">=</font> N <font color="#FF0000">'cdc'</font> ,&lt;br/&gt; <br> @capture_instance <font color="#808080">=</font> N <font color="#FF0000">'dbo_Orders'</font> ,&lt;br/&gt; <br> @supports_net_changes <font color="#808080">=</font> <font>1</font> ,&lt;br/&gt; <br> @index_name <font color="#808080">=</font> <font color="#FF0000">'id_idx'</font> ,&lt;br/&gt; <br> @captured_column_list <font color="#808080">=</font> null,&lt;br/&gt; <br> @ <font color="#FF00FF">FILEGROUP_NAME</font> <font color="#808080">=</font> null; <br></code> </blockquote> <code><font color="#0000FF">EXEC</font> sys. <font color="#202020">sp_cdc_enable_db</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#0000FF">EXEC</font> sys. <font color="#202020">sp_cdc_enable_table</font> &lt;br/&gt; <br> @source_schema <font color="#808080">=</font> N <font color="#FF0000">'dbo'</font> ,&lt;br/&gt; <br> @source_name <font color="#808080">=</font> N <font color="#FF0000">'Orders'</font> ,&lt;br/&gt; <br> @role_name <font color="#808080">=</font> N <font color="#FF0000">'cdc'</font> ,&lt;br/&gt; <br> @capture_instance <font color="#808080">=</font> N <font color="#FF0000">'dbo_Orders'</font> ,&lt;br/&gt; <br> @supports_net_changes <font color="#808080">=</font> <font>1</font> ,&lt;br/&gt; <br> @index_name <font color="#808080">=</font> <font color="#FF0000">'id_idx'</font> ,&lt;br/&gt; <br> @captured_column_list <font color="#808080">=</font> null,&lt;br/&gt; <br> @ <font color="#FF00FF">FILEGROUP_NAME</font> <font color="#808080">=</font> null; <br></code> <br><ul><li>  @source_schema - the schema that owns the table for which we activate the CDC </li><li>  @source_name is the name of the table for which we are activating the CDC </li><li>  @role_name - the name of the role that will have the right to view the changes (if not, it is created automatically) </li><li>  @capture_instance - corresponds to the part of the name that will be issued to the corresponding system table </li><li>  @supports_net_changes - support for the ability to display the resulting set of changes (only the latest versions of data).  This requires a unique index. </li><li>  @index_name - in fact, the name of the unique index </li><li>  @captured_column_list - a list of fields for which change tracking will be activated.  Default is everything. </li><li>  @filegroup_name - file group in which the system table will be placed </li></ul><br>  From a purely practical point of view, a significant minus of the CDC is that it is impossible to fix the author of the changes.  Of course, no one bothers to add a column to the cdc.dbo_Orders_CT system table with the default value of suser_sname () (in my practice it works), but such manipulations with system tables are not the best way to build a fault-tolerant system. <br><br>  Examples of queries to stored data and a detailed description in the <a href="http://blogs.msdn.com/b/alexejs/archive/2009/08/07/cdc.aspx">article</a> . <br><br><h4>  <b>3. SQL Server Audit</b> </h4><br>  A powerful tool designed to keep track of all events and requests and the server (including select).  The scope of this tool is quite wide - from profiling to issues related to security and identifying user activity in the part of the database that is not intended for them. <br>  SQL Server Audit allows you to flexibly customize the filters of monitored events. <br>  To use auditing, you need to activate it at the server level: <br><blockquote> <code><font color="#0000FF">CREATE</font> server audit ServerAudit&lt;br/&gt; <br> <font color="#0000FF">TO</font> <font color="#0000FF">FILE</font> <font color="#808080">(</font> filepath <font color="#808080">=</font> `D:\Audit\`, maxsize <font color="#808080">=</font> 1GB <font color="#808080">)</font> &lt;br/&gt; <br> <font color="#0000FF">WITH</font> <font color="#808080">(</font> on_failture <font color="#808080">=</font> <font color="#0000FF">CONTINUE</font> <font color="#808080">)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#0000FF">ALTER</font> server audit ServerAudit <font color="#0000FF">WITH</font> <font color="#808080">(</font> <font color="#0000FF">STATE</font> <font color="#808080">=</font> <font color="#0000FF">ON</font> <font color="#808080">)</font> <br></code> </blockquote> <code><font color="#0000FF">CREATE</font> server audit ServerAudit&lt;br/&gt; <br> <font color="#0000FF">TO</font> <font color="#0000FF">FILE</font> <font color="#808080">(</font> filepath <font color="#808080">=</font> `D:\Audit\`, maxsize <font color="#808080">=</font> 1GB <font color="#808080">)</font> &lt;br/&gt; <br> <font color="#0000FF">WITH</font> <font color="#808080">(</font> on_failture <font color="#808080">=</font> <font color="#0000FF">CONTINUE</font> <font color="#808080">)</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#0000FF">ALTER</font> server audit ServerAudit <font color="#0000FF">WITH</font> <font color="#808080">(</font> <font color="#0000FF">STATE</font> <font color="#808080">=</font> <font color="#0000FF">ON</font> <font color="#808080">)</font> <br></code> <br>  An example of creating a specification of audit (trace) at the server level: <br><blockquote> <code><font color="#0000FF">CREATE</font> server audit specification ServerAudit_Permissions&lt;br/&gt; <br> <font color="#0000FF">FOR</font> server audit ServerAudit&lt;br/&gt; <br> <font color="#0000FF">ADD</font> <font color="#808080">(</font> server_principal_change_group <font color="#808080">)</font> ,&lt;br/&gt; <br> <font color="#0000FF">ADD</font> <font color="#808080">(</font> server_permission_change_group <font color="#808080">)</font> ,&lt;br/&gt; <br> <font color="#0000FF">ADD</font> <font color="#808080">(</font> server_role_member_change_group <font color="#808080">)</font> ;&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#0000FF">ALTER</font> server audit specification ServerAudit_Permissions&lt;br/&gt; <br> <font color="#0000FF">WITH</font> <font color="#808080">(</font> <font color="#0000FF">STATE</font> <font color="#808080">=</font> <font color="#0000FF">ON</font> <font color="#808080">)</font> ; <br></code> </blockquote> <code><font color="#0000FF">CREATE</font> server audit specification ServerAudit_Permissions&lt;br/&gt; <br> <font color="#0000FF">FOR</font> server audit ServerAudit&lt;br/&gt; <br> <font color="#0000FF">ADD</font> <font color="#808080">(</font> server_principal_change_group <font color="#808080">)</font> ,&lt;br/&gt; <br> <font color="#0000FF">ADD</font> <font color="#808080">(</font> server_permission_change_group <font color="#808080">)</font> ,&lt;br/&gt; <br> <font color="#0000FF">ADD</font> <font color="#808080">(</font> server_role_member_change_group <font color="#808080">)</font> ;&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#0000FF">ALTER</font> server audit specification ServerAudit_Permissions&lt;br/&gt; <br> <font color="#0000FF">WITH</font> <font color="#808080">(</font> <font color="#0000FF">STATE</font> <font color="#808080">=</font> <font color="#0000FF">ON</font> <font color="#808080">)</font> ; <br></code> <br>  An example of creating an audit specification at the database level: <br><blockquote> <code><font color="#0000FF">USE</font> MyDb&lt;br/&gt; <br> <font color="#0000FF">CREATE</font> <font color="#0000FF">DATABASE</font> audit specification SA_MyDb_Orders &lt;br/&gt; <br> <font color="#0000FF">FOR</font> server audit ServerAudit&lt;br/&gt; <br> <font color="#0000FF">ADD</font> <font color="#808080">(</font> <font color="#0000FF">SELECT</font> , <font color="#0000FF">UPDATE</font> , <font color="#0000FF">INSERT</font> , <font color="#0000FF">DELETE</font> <font color="#0000FF">ON</font> dbo. <font color="#202020">Orders</font> <font color="#0000FF">BY</font> <font color="#0000FF">PUBLIC</font> <font color="#808080">)</font> ,&lt;br/&gt; <br> <font color="#0000FF">ADD</font> <font color="#808080">(</font> <font color="#0000FF">SELECT</font> , <font color="#0000FF">UPDATE</font> , <font color="#0000FF">INSERT</font> , <font color="#0000FF">DELETE</font> <font color="#0000FF">ON</font> dbo. <font color="#202020">OrderDetails</font> <font color="#0000FF">BY</font> <font color="#0000FF">PUBLIC</font> <font color="#808080">)</font> <br></code> </blockquote> <code><font color="#0000FF">USE</font> MyDb&lt;br/&gt; <br> <font color="#0000FF">CREATE</font> <font color="#0000FF">DATABASE</font> audit specification SA_MyDb_Orders &lt;br/&gt; <br> <font color="#0000FF">FOR</font> server audit ServerAudit&lt;br/&gt; <br> <font color="#0000FF">ADD</font> <font color="#808080">(</font> <font color="#0000FF">SELECT</font> , <font color="#0000FF">UPDATE</font> , <font color="#0000FF">INSERT</font> , <font color="#0000FF">DELETE</font> <font color="#0000FF">ON</font> dbo. <font color="#202020">Orders</font> <font color="#0000FF">BY</font> <font color="#0000FF">PUBLIC</font> <font color="#808080">)</font> ,&lt;br/&gt; <br> <font color="#0000FF">ADD</font> <font color="#808080">(</font> <font color="#0000FF">SELECT</font> , <font color="#0000FF">UPDATE</font> , <font color="#0000FF">INSERT</font> , <font color="#0000FF">DELETE</font> <font color="#0000FF">ON</font> dbo. <font color="#202020">OrderDetails</font> <font color="#0000FF">BY</font> <font color="#0000FF">PUBLIC</font> <font color="#808080">)</font> <br></code> <br>  For auditing infusions, there is a convenient visual interface in SQL Server Management Studio. <br><br>  Also, it should be noted that the availability of standardized audit tools of the c2 specification (the US state standard, according to MSDN, I did not find the reference to the standard), for activation of which should be done: <br><blockquote> <code><font color="#AF0000">SP_CONFIGURE</font> <font color="#FF0000">'show advanced options'</font> , <font>1</font> ;&lt;br/&gt; <br> <font color="#0000FF">RECONFIGURE</font> ;&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#AF0000">SP_CONFIGURE</font> <font color="#FF0000">'c2 audit mode'</font> , <font>1</font> ;&lt;br/&gt; <br> <font color="#0000FF">RECONFIGURE</font> ; <br></code> </blockquote> <code><font color="#AF0000">SP_CONFIGURE</font> <font color="#FF0000">'show advanced options'</font> , <font>1</font> ;&lt;br/&gt; <br> <font color="#0000FF">RECONFIGURE</font> ;&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#AF0000">SP_CONFIGURE</font> <font color="#FF0000">'c2 audit mode'</font> , <font>1</font> ;&lt;br/&gt; <br> <font color="#0000FF">RECONFIGURE</font> ; <br></code> <br><h4>  <b>4. SQL Server Profiler</b> </h4><br>  Everyone has long been familiar utility, so for now I will not dwell on it. <br><br>  Thank. <br>  Plans to write in detail about each instrument, unless of course the topic is of interest. </div><p>Source: <a href="https://habr.com/ru/post/111207/">https://habr.com/ru/post/111207/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../111201/index.html">Google Chrome Voice Search</a></li>
<li><a href="../111202/index.html">PHP and Dropbox. Remote storage of user files</a></li>
<li><a href="../111203/index.html">MODx - Accounting visitors and schedule visits</a></li>
<li><a href="../111204/index.html">Using HDAPS in ThinkPad Linux Laptops when needed</a></li>
<li><a href="../111205/index.html">Drupal module for working with Yandex.Mail</a></li>
<li><a href="../111208/index.html">Review of an inexpensive dual-core netbook, Packard Bell DOT SE W-301RU</a></li>
<li><a href="../111210/index.html">Some ideas of writing an artificial intellect for chess</a></li>
<li><a href="../111211/index.html">Drupal 7 released</a></li>
<li><a href="../111213/index.html">Vulnerability in php 5.3. * 32bit - float</a></li>
<li><a href="../111214/index.html">Software visualization of the local network</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>