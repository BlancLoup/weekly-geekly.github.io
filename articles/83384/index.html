<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Login to connect a specific flash drive</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One terrible Friday evening I wondered how the login to the system (Windows 7) was implemented, which is so often used on laptops. What most intereste...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Login to connect a specific flash drive</h1><div class="post__text post__text-html js-mediator-article">  One terrible Friday evening I wondered how the login to the system (Windows 7) was implemented, which is so often used on laptops.  What most interested me was how such transparent integration with WinLogon (the login mechanism) was made. <br><br>  With the help of a friend, I learned that this is called the Credential Provider (at least since Vista, before it - there was another mechanism).  And here I remembered that I had long wanted to do so that the system would be unlocked by connecting one specific flash drive.  Therefore, I wanted to quickly build such a project. <br><a name="habracut"></a><br>  The first thing I did was look for examples of the implementation of the Credential Provider.  They were quickly found in the <a href="http://www.microsoft.com/downloads/details.aspx%3Ffamilyid%3D71DEB800-C591-4F97-A900-BEA146E4FAE1%26amp%3Bdisplaylang%3Den">Windows SDK</a> , as well as separate <a href="http://www.microsoft.com/downloads/details.aspx%3Fdisplaylang%3Den%26amp%3BFamilyID%3Db1b3cbd1-2d3a-4fac-982f-289f4f4b9300">examples</a> (but outdated ones for whists). <br><br>  Among the examples was the one closest to me - SampleHardwareEventCredentialProvider. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I'll tell you briefly how the mechanism of account providers (Credential Provider) is arranged. <br><br>  There are two branches in the registry (HKLM \ Software \ Microsoft Windows \ CurrentVersion \ Authentification) - Credential Providers themselves and Credential Provider Filters.  In each of them, a set of the ‚Äúbranch-GUID‚Äù type (GUID is a unique identifier) ‚Äã‚Äãwith the default parameter ‚Äî the name of the provider or filter.  Here it is necessary to clarify what providers and filters are. <br><br>  Provider - it gives us the ability to log into the system.  For example, by fingerprint, by entering a password (default behavior), by smart card, etc. <br><br>  Filters - filter ‚Äúextra‚Äù behavior from the user.  Example - if the security policy prohibits smart card login - the filter may disable such provider. <br><br>  Further, in the registry in all known horrible place HKCR \ CLSID described GUIDs, and in our case - for the identifiers of filters and providers their names are written, the file name is dll, and the thread model (ThreadingModel = Apartment). <br><br>  We will not consider filters, we will pass specifically to the provider. <br><br>  In the project we have several classes: <br>  CSampleProvider, which implements the ICredentialProvider interface.  It is he who is responsible for the login mechanism and the provision of credentials (Credential) <br>  CSampleCredential, implementing the ICredentialProviderCredential.  Actually here are the username, password (or authorization token, which is better).  We give WinLogon a copy of this class to enter the system. <br>  CommandWindow, stub window class. <br><br>  The default behavior in SampleHardwareEventCredentialProvider is: <br>  When the main class is created by the WinLogon input mechanism, a window with a button is created in another thread that simulates a device connection event.  When you click on the button - the transition to the login with the account ‚ÄúAdministrator‚Äù. <br><br>  What do I need to change the minimum of this behavior to be a working solution for me? <br>  Hide the window, change the hardwired ‚ÄúAdministrator‚Äù account to mine (with auto-enter password), enable autologin, and implement the WM_DEVICECHANGE event. <br><br>  Hide the window was easy - just find ShowWindow (hWnd, SW_SHOW);  and replace with SW_HIDE <br>  Changing a hard-coded account was also easy - I created a separate file, consts.h, where I wrote: <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">static</font> <font color="#0000ff">const</font> wchar_t* USERNAME = (L <font color="#A31515">" "</font> ); <br> <font color="#0000ff">static</font> <font color="#0000ff">const</font> wchar_t* PASSWORD = (L <font color="#A31515">"      ."</font> ); <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  It was also easy to turn on autologin: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">HRESULT CSampleCredential::SetSelected(__out BOOL* pbAutoLogon) <br> { <br> *pbAutoLogon = TRUE; <font color="#008000">//  FALSE</font> <br> <font color="#0000ff">return</font> S_OK; <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  This method is called when a user is selected to log in. <br><br>  The only thing left is to implement the WM_DEVICECHANGE event. <br>  In it, I need to find some unique identifier of the flash drive, compare it with the reference one, and in case of a match, set the flag for the device you need, which will then read CSampleCredential. <br><br>  What could be unique to a flash drive?  In general, a lot of things, VendorID / ProductID (unique to the product, i.e. the same series of flash drives - the same), the serial number of the partition (cleared when reformatting).  I compare PNPID through the WMI (Windows Management Instrumentation) mechanism. <br><br>  In general, you can talk about WMI for a long time, I will just say that this means of obtaining information and managing a bunch of OS components and not only, and has its own SQL-like query language called WQL.  There is a wonderful utility from Microsoft called WMI Browser, I strongly advise you to install it - you can learn a lot about what you can learn with WMI. <br><br>  Here is a modified flow procedure, in which, in addition to creating a window, now also initializes global static variables for working with WMI: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">static</font> IEnumWbemClassObject* pEnumerator ; <br> <font color="#0000ff">static</font> IWbemLocator *pLoc ; <br> <font color="#0000ff">static</font> IWbemServices *pSvc; <br> <font color="#0000ff">static</font> IWbemClassObject *pclsObj; <br> <br> DWORD WINAPI CCommandWindow::_ThreadProc(__in LPVOID lpParameter) <br> { <br> CCommandWindow *pCommandWindow = static_cast&lt;CCommandWindow *&gt;(lpParameter); <br> <font color="#0000ff">if</font> (pCommandWindow == NULL) <br> { <br> <font color="#0000ff">return</font> 0; <br> } <br> <br> HRESULT hres; <br> hres = CoInitializeEx(0, COINIT_MULTITHREADED); <br> <font color="#0000ff">if</font> (FAILED(hres)) <br> <font color="#0000ff">return</font> 1; <font color="#008000">// Program has failed.</font> <br> <br> hres = CoCreateInstance( <br> CLSID_WbemLocator, <br> 0, <br> CLSCTX_INPROC_SERVER, <br> IID_IWbemLocator, (LPVOID *) &amp;(pLoc)); <br> <font color="#0000ff">if</font> (FAILED(hres)) <br> { <br> CoUninitialize(); <br> <font color="#0000ff">return</font> 1; <font color="#008000">// Program has failed.</font> <br> } <br> hres = pLoc-&gt;ConnectServer( <br> _bstr_t(L <font color="#A31515">"ROOT\\CIMV2"</font> ), <font color="#008000">// Object path of WMI namespace</font> <br> NULL, <font color="#008000">// User name. NULL = current user</font> <br> NULL, <font color="#008000">// User password. NULL = current</font> <br> 0, <font color="#008000">// Locale. NULL indicates current</font> <br> NULL, <font color="#008000">// Security flags.</font> <br> 0, <font color="#008000">// Authority (eg Kerberos)</font> <br> 0, <font color="#008000">// Context object</font> <br> &amp;pSvc <font color="#008000">// pointer to IWbemServices proxy</font> <br> ); <br> <br> <font color="#0000ff">if</font> (FAILED(hres)) <br> { <br> pLoc-&gt;Release(); <br> CoUninitialize(); <br> <font color="#0000ff">return</font> 1; <font color="#008000">// Program has failed.</font> <br> } <br> <br> hres = CoSetProxyBlanket( <br> pSvc, <font color="#008000">// Indicates the proxy to set</font> <br> RPC_C_AUTHN_WINNT, <font color="#008000">// RPC_C_AUTHN_xxx</font> <br> RPC_C_AUTHZ_NONE, <font color="#008000">// RPC_C_AUTHZ_xxx</font> <br> NULL, <font color="#008000">// Server principal name</font> <br> RPC_C_AUTHN_LEVEL_CALL, <font color="#008000">// RPC_C_AUTHN_LEVEL_xxx</font> <br> RPC_C_IMP_LEVEL_IMPERSONATE, <font color="#008000">// RPC_C_IMP_LEVEL_xxx</font> <br> NULL, <font color="#008000">// client identity</font> <br> EOAC_NONE <font color="#008000">// proxy capabilities</font> <br> ); <br> <br> <font color="#0000ff">if</font> (FAILED(hres)) <br> { <br> pSvc-&gt;Release(); <br> pLoc-&gt;Release(); <br> CoUninitialize(); <br> <font color="#0000ff">return</font> 1; <font color="#008000">// Program has failed.</font> <br> } <br> <br> <br> <br> HRESULT hr = S_OK; <br> <br> <font color="#008000">// Create the window.</font> <br> pCommandWindow-&gt;_hInst = GetModuleHandle(NULL); <br> <font color="#0000ff">if</font> (pCommandWindow-&gt;_hInst != NULL) <br> { <br> hr = pCommandWindow-&gt;_MyRegisterClass(); <br> <font color="#0000ff">if</font> (SUCCEEDED(hr)) <br> { <br> hr = pCommandWindow-&gt;_InitInstance(); <br> } <br> } <br> <font color="#0000ff">else</font> <br> { <br> hr = HRESULT_FROM_WIN32(GetLastError()); <br> } <br> ShowWindow(pCommandWindow-&gt;_hWnd, SW_HIDE); <br> <br> <font color="#0000ff">if</font> (SUCCEEDED(hr)) <br> { <br> <font color="#0000ff">while</font> (pCommandWindow-&gt;_ProcessNextMessage()) <br> { <br> } <br> } <br> <font color="#0000ff">else</font> <br> { <br> <font color="#0000ff">if</font> (pCommandWindow-&gt;_hWnd != NULL) <br> { <br> pCommandWindow-&gt;_hWnd = NULL; <br> } <br> } <br> <br> <font color="#0000ff">return</font> 0; <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  accordingly, in the CommandWindow destructor, we release the resources: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">pSvc-&gt;Release(); <br> pLoc-&gt;Release(); <br> pEnumerator-&gt;Release(); <br> pclsObj-&gt;Release(); <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  And now the most interesting thing is the WM_DEVICECHANGE event handler: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">case</font> WM_DEVICECHANGE: <br> { <br> HRESULT hres = pSvc-&gt;ExecQuery( <br> bstr_t( <font color="#A31515">"WQL"</font> ), <br> bstr_t( <font color="#A31515">"SELECT * FROM Win32_DiskDrive"</font> ), <br> WBEM_FLAG_FORWARD_ONLY | WBEM_FLAG_RETURN_IMMEDIATELY, <br> NULL, <br> &amp;pEnumerator); <br> <font color="#0000ff">if</font> (FAILED(hres)) <br> { <br> pSvc-&gt;Release(); <br> pLoc-&gt;Release(); <br> CoUninitialize(); <br> <font color="#0000ff">return</font> 1; <font color="#008000">// Program has failed</font> <br> } <br> <br> ULONG uReturn = 0; <br> <br> <font color="#0000ff">while</font> (pEnumerator) <br> { <br> HRESULT hr = pEnumerator-&gt;Next(WBEM_INFINITE, 1, <br> &amp;pclsObj, &amp;uReturn); <br> <br> <font color="#0000ff">if</font> (0 == uReturn) <br> { <br> <font color="#0000ff">break</font> ; <br> } <br> <br> VARIANT vtProp; <br> <br> hr = pclsObj-&gt;Get(L <font color="#A31515">"PNPDeviceID"</font> , 0, &amp;vtProp, 0, 0); <br> <font color="#0000ff">if</font> (wcscmp(vtProp.bstrVal,PNPID) == 0) <br> { <br> PostMessage(hWnd, WM_TOGGLE_CONNECTED_STATUS, 0, 0); <br> } <br> VariantClear(&amp;vtProp); <br> <br> pclsObj-&gt;Release(); <br> } <br> } <br> <font color="#0000ff">break</font> ; <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  This is where the WQL query to Win32_DiskDrive, the list of our disks, is executed.  Those.  by PNPID, we can attach to a flash drive, external hard drive, but not for example with a usb mouse (although this can also be implemented!). <br><br>  After executing the query, I compare the resulting string (vtProp.bstrVal) with the hard-coded PNPID in consts.h: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">static</font> <font color="#0000ff">const</font> wchar_t* PNPID = (L <font color="#A31515">"USBSTOR\\DISK&amp;VEN_CBM&amp;PROD_FLASH_DISK&amp;REV_5.00\\192023004CB4C702&amp;0"</font> ); <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  PNPID can be found in the same WMI Browser or you can use Visual Studio tools to work with WMI. <br><br>  If they match, then I send a message to turn on the connection flag of the desired flash drive, by which this flag is set and the update method of the provider is called. <br><br>  Next was the final touch - replace the GUID of our library from default to random in register.reg / unregister.reg and in guid.h. <br><br>  That's all.  Then it is easy to compile the project, copy the resulting library to System32, and execute register.reg.  Then press Win + L (system lock) and enjoy :) <br><br>  Here you can download the <a href="">source</a> . <br><br><h2>  What should be finalized? </h2><br><br>  Remove the PNPID hardcode and login / password.  It is better to serialize the authorization token in a separate software, and already use it in dll.  You can use cryptographic tools and store the login / password on a flash drive encrypted in a specific file. <br><br>  What I want to show with this article is that in Windows you can expand a lot for you, the main thing is not to be afraid to search for what you want to know and use the Windows SDK. <br><br>  Good luck to everyone, I hope someone inspired to develop something useful! <br></div><p>Source: <a href="https://habr.com/ru/post/83384/">https://habr.com/ru/post/83384/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../83375/index.html">Our world, perhaps - one huge hologram</a></li>
<li><a href="../83376/index.html">Xsplash - making a theme for yourself</a></li>
<li><a href="../83377/index.html">How do we sell software?</a></li>
<li><a href="../83378/index.html">Filling the database with test data using Populator and Faker</a></li>
<li><a href="../83381/index.html">Button and resistance</a></li>
<li><a href="../83385/index.html">ACM ICPC 2010 Unofficial Broadcast - How It Was</a></li>
<li><a href="../83387/index.html">Learn Japanese ABCs</a></li>
<li><a href="../83388/index.html">Are you ready to pass the exam on computer science?</a></li>
<li><a href="../83391/index.html">What is interesting to listen to IT person on the radio?</a></li>
<li><a href="../83394/index.html">Puzzles on the development of non-standard thinking</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>