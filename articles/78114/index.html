<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Twisted in action - memcache in python</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Preamble 
 In connection with the weekend, I spent some time implementing the Memcache server using the Twisted python framework. As a result, I recei...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Twisted in action - memcache in python</h1><div class="post__text post__text-html js-mediator-article"><h4>  Preamble </h4><br>  In connection with the weekend, I spent some time implementing the Memcache server using the Twisted python framework.  As a result, I received a speed twice as low, which I do not consider very critical, as well as the ability to implement a couple of extensions of the original protocol.  Optimizations are also possible, which will further improve performance. <br>  The protocol was not fully implemented - there are still points that can be worked on, but the standard set / get is quite efficient and ready to use. <br><br><h4>  Facilities </h4><br>  To store the cache, we use the base class dict.  As you might guess, the implementation of dict in python is fast, this basic type is used in python so actively that it was not left without detailed optimization.  Thus, we automatically have a structure for storing the cache in memory.  It remains to implement the memcache protocol, to provide access to dict to other programs. <br><br>  To implement the server use Twisted.  There are many variations of non-blocking IO for python today, but Twisted is already a classic, and has enough tools in its arsenal to easily solve such problems. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><h4>  Network Protocol Implementation </h4><br>  How are the protocols implemented?  First of all, you certainly need to find a description of the protocol.  I found it here - <a href="http://code.sixapart.com/svn/memcached/trunk/server/doc/protocol.txt">code.sixapart.com/svn/memcached/trunk/server/doc/protocol.txt</a> <br><br>  After reading the protocol, it becomes clear that we will receive one or two lines from the client, and we can safely divide the first line into elements by spaces.  The second line is used in commands that send data to the server - set, add, replace, etc.  If you would like to get into the article in more detail, then I will send you to read the description on your own, the purpose of posting his translation here was not <br><br>  Armed with this knowledge, we look at what Twisted can offer us to solve this problem, and immediately find LineOnlyReceiver ‚Äî the protocol from Twisted's basic delivery, which works only with protocols that exchange strings, that is what we need.  Even in Twisted, there is already an implementation of the memcache protocol, but only its client part, and we are making the server. <br><br>  <font color="#ff8800">1</font> <font color="#ff8800">class</font> <font color="#00ffff">MemcacheProtocol</font> (LineOnlyReceiver): <br>  <font color="#ff8800">2</font> <font color="#808080">"" "</font> <br>  <font color="#ff8800">3</font> <font color="#ff6060">Implements a protocol basis - receiving messages from a client</font> <br>  <font color="#ff8800">4</font> <font color="#ff6060">and return results.</font> <br>  <font color="#ff8800">five</font> <font color="#ff6060">&nbsp;&nbsp;&nbsp;&nbsp;</font>  <font color="#808080">"" "</font> <br>  <font color="#ff8800">6</font> <br>  <font color="#ff8800">7</font> <font color="#ff8800">def</font> <font color="#00ffff">lineReceived</font> (self, line): <br>  <font color="#ff8800">8</font> debug (repr (line)) <br>  <font color="#ff8800">9</font> <font color="#ff8800">if</font> <font color="#ff8800">not</font> <font color="#808080">'</font> <font color="#ff6060">parameters</font> <font color="#808080">'</font> <font color="#ff8800">in</font> self.instruction: <br>  <font color="#ff8800">10</font> parameters = line.split ( <font color="#808080">'</font> <font color="#ff6060">&nbsp;</font>  <font color="#808080">'</font> ) <br>  <font color="#ff8800">11</font> debug ( <font color="#808080">"</font> <font color="#ff6060">Got new command</font> <font color="#808080">"</font> + parameters [0]) <br>  <font color="#ff8800">12</font> self.instruction [ <font color="#808080">'</font> <font color="#ff6060">parameters</font> <font color="#808080">'</font> ] = parameters <br>  <font color="#ff8800">13</font> <br>  <font color="#ff8800">14</font> <font color="#8080ff"># If data is not expected, then to execution</font> <br>  <font color="#ff8800">15</font> <font color="#ff8800">if</font> parameters [0] <font color="#ff8800">in</font> Cache.oneline_commands: <br>  <font color="#ff8800">16</font> self.process () <br>  <font color="#ff8800">17</font> <font color="#ff8800">else</font> : <br>  <font color="#ff8800">18</font> <font color="#8080ff"># Received data for two-line command, for execution</font> <br>  <font color="#ff8800">19</font> debug ( <font color="#808080">"</font> <font color="#ff6060">Got data</font> <font color="#808080">"</font> + line) <br>  <font color="#ff8800">20</font> self.instruction [ <font color="#808080">'</font> <font color="#ff6060">data</font> <font color="#808080">'</font> ] = line <br>  <font color="#ff8800">21</font> self.process () <br>  <font color="#ff8800">22</font> <br>  <font color="#ff8800">23</font> <font color="#ff8800">def</font> <font color="#00ffff">process</font> (self): <br>  <font color="#ff8800">24</font> <font color="#8080ff"># Cache.call returns generator</font> <br>  <font color="#ff8800">25</font> <font color="#ff8800">for</font> line <font color="#ff8800">in</font> Cache.call (self.instruction): <br>  <font color="#ff8800">26</font> <font color="#8080ff"># And we send everything that it generates in separate lines</font> <br>  <font color="#ff8800">27</font> debug ( <font color="#808080">"</font> <font color="#ff6060">Send line</font> <font color="#808080">"</font> + line) <br>  <font color="#ff8800">28</font> self.sendLine (line) <br>  <font color="#ff8800">29</font> <font color="#8080ff"># Ready for further instructions, cashier!</font> <br>  <font color="#ff8800">30</font> self.instruction = {} <br>  <font color="#ff8800">31</font> <br>  <font color="#ff8800">32</font> <font color="#ff8800">def</font> <font color="#00ffff">connectionMade</font> (self): <br>  <font color="#ff8800">33</font> debug ( <font color="#808080">"</font> <font color="#ff6060">Connected!</font> <font color="#808080">"</font> ) <br>  <font color="#ff8800">34</font> self.instruction = {} <br><br><br>  As can be seen from the code, Cache is used for the actual work.  This singleton is essentially just a class whose methods are wrapped by the decorator @classmethod.  Calling Cache.call should return a generator that will be returned by strings, which, in turn, our implementation of the protocol will give to the client. <br><br><h4>  Parse the request from the client </h4><br>  The first line is a command and parameters separated by spaces, so we use the string split method, and the output is a list.  Next, it must be disassembled into components, before the command begins to work with the data.  I use the class, as I like the perspective to access the parameters, pointing them through the dot.  The code below already requires reading the protocol description, and for a lazy pair of suggestive lines: <br><pre>                                                                                                                        
 Data Commands:                                                                                                       
 &lt;command name&gt; &lt;key&gt; &lt;flags&gt; &lt;exptime&gt; &lt;bytes&gt; [noreply] \ r \ n                                                                 
 cas &lt;key&gt; &lt;flags&gt; &lt;exptime&gt; &lt;bytes&gt; &lt;cas unqiue&gt; [noreply] \ r \ n                                                               

 Receiving data:
 get &lt;key&gt; * \ r \ n   
 gets &lt;key&gt; * \ r \ n  
 delete &lt;key&gt; \ r \ n 

 Well, and the like.
</pre><br>  Implementation parsing: <br><br>  <font color="#ff8800">1</font> <font color="#ff8800">class</font> <font color="#00ffff">Instruction</font> (object): <br>  <font color="#ff8800">2</font> <font color="#ff8800">def</font> <font color="#00ffff">__init__</font> (self, i): <br>  <font color="#ff8800">3</font> p = i [ <font color="#808080">'</font> <font color="#ff6060">parameters</font> <font color="#808080">'</font> ] <br>  <font color="#ff8800">4</font> self.cmd = p.pop (0) <br>  <font color="#ff8800">five</font> <br>  <font color="#ff8800">6</font> <font color="#8080ff"># Check noreply</font> <br>  <font color="#ff8800">7</font> <font color="#ff8800">if</font> p [-1] == <font color="#808080">'</font> <font color="#ff6060">noreply</font> <font color="#808080">'</font> : <br>  <font color="#ff8800">8</font> self.reply = False <br>  <font color="#ff8800">9</font> <font color="#8080ff"># Throw it out</font> <br>  <font color="#ff8800">10</font> p.pop (-1) <br>  <font color="#ff8800">11</font> <font color="#ff8800">else</font> : <br>  <font color="#ff8800">12</font> self.reply = True <br>  <font color="#ff8800">13</font> <br>  <font color="#ff8800">14</font> <font color="#ff8800">if</font> self.cmd <font color="#ff8800">in</font> Cache.storage_commands: <br>  <font color="#ff8800">15</font> <font color="#8080ff"># If CAS, then there is one more parameter (i.e., a special case)</font> <br>  <font color="#ff8800">16</font> <font color="#ff8800">if</font> self.cmd == <font color="#808080">"</font> <font color="#ff6060">cas</font> <font color="#808080">"</font> : <br>  <font color="#ff8800">17</font> self.unique = p.pop (-1) <br>  <font color="#ff8800">18</font> <br>  <font color="#ff8800">19</font> <font color="#8080ff"># Now all parameters are unambiguous, but we want to expand the protocol,</font> <br>  <font color="#ff8800">20</font> <font color="#8080ff"># because everything is not as simple as dict (zip ())</font> <br>  <font color="#ff8800">21</font> self.bytes = p.pop (-1) <br>  <font color="#ff8800">22</font> self.exptime = p.pop (-1) <br>  <font color="#ff8800">23</font> self.flags = p.pop (-1) <br>  <font color="#ff8800">24</font> self.keys = p <br>  <font color="#ff8800">25</font> self.data = i.get ( <font color="#808080">'</font> <font color="#ff6060">data</font> <font color="#808080">'</font> , None) <br>  <font color="#ff8800">26</font> <br>  <font color="#ff8800">27</font> <font color="#8080ff"># get and gets</font> <br>  <font color="#ff8800">28</font> <font color="#ff8800">elif</font> self.cmd <font color="#ff8800">in</font> [ <font color="#808080">"</font> <font color="#ff6060">get</font> <font color="#808080">"</font> , <font color="#808080">"</font> <font color="#ff6060">gets</font> <font color="#808080">"</font> , <font color="#808080">"</font> <font color="#ff6060">getn</font> <font color="#808080">"</font> , <font color="#808080">"</font> <font color="#ff6060">delete</font> <font color="#808080">"</font> ]: <br>  <font color="#ff8800">29</font> self.keys = p <br>  <font color="#ff8800">thirty</font> <br>  <font color="#ff8800">31</font> <font color="#ff8800">def</font> <font color="#00ffff">__str__</font> (self): <br>  <font color="#ff8800">32</font> <font color="#ff8800">return</font> str (self .__ dict__) <br><br><br><h4>  Implementing cache storage and working with it </h4><br>  The protocol was immediately expanded by me, namely, there is the possibility of working with embedded data.  The cache is converted into a tree, and all operations that, according to the standard, indicate one key, can indicate a list of keys separated by spaces.  But it is easy to get rid of this, but then the meaning of the work will be completely unclear. <br><br>  As a storage unit, the Entry class is implemented, which contains a dictionary (childs of type dict) with child Entry instances.  Moreover, the top of the hierarchy is also an instance of the Entry class. <br><br>  Here I will give a fragment of the singleton Cache: <br><br>  <font color="#ff8800">1</font> <font color="#ff8800">class</font> <font color="#00ffff">Cache</font> (object): <br>  <font color="#ff8800">2</font> <font color="#8080ff"># consts</font> <br>  <font color="#ff8800">3</font> storage_commands = [ <font color="#808080">"</font> <font color="#ff6060">set</font> <font color="#808080">"</font> , <font color="#808080">"</font> <font color="#ff6060">add</font> <font color="#808080">"</font> , <font color="#808080">"</font> <font color="#ff6060">replace</font> <font color="#808080">"</font> , <font color="#808080">"</font> <font color="#ff6060">append</font> <font color="#808080">"</font> , <font color="#808080">"</font> <font color="#ff6060">prepend</font> <font color="#808080">"</font> , <font color="#808080">"</font> <font color="#ff6060">cas</font> <font color="#808080">"</font> ] <br>  <font color="#ff8800">4</font> oneline_commands = [ <font color="#808080">"</font> <font color="#ff6060">get</font> <font color="#808080">"</font> , <font color="#808080">"</font> <font color="#ff6060">gets</font> <font color="#808080">"</font> , <font color="#808080">"</font> <font color="#ff6060">getn</font> <font color="#808080">"</font> , <font color="#808080">"</font> <font color="#ff6060">delete</font> <font color="#808080">"</font> , <font color="#808080">"</font> <font color="#ff6060">incr</font> <font color="#808080">"</font> , <font color="#808080">"</font> <font color="#ff6060">decr</font> <font color="#808080">"</font> , <font color="#808080">"</font> <font color="#ff6060">stats</font> <font color="#808080">"</font> ] <br>  <font color="#ff8800">five</font> <br>  <font color="#ff8800">6</font> <font color="#8080ff"># cache storage</font> <br>  <font color="#ff8800">7</font> data = Entry (0,0,0) <br>  <font color="#ff8800">eight</font> <br>  <font color="#ff8800">9</font> <font color="#8080ff"># cache operations</font> <br>  <font color="#ff8800">10</font> <font color="#ff40ff">@</font> <font color="#00ffff">classmethod</font> <br>  <font color="#ff8800">11</font> <font color="#ff8800">def</font> <font color="#00ffff">call</font> (cls, instruction): <br>  <font color="#ff8800">12</font> i = Instruction (instruction) <br>  <font color="#ff8800">13</font> debug (i) <br>  <font color="#ff8800">14</font> command = getattr (cls, i.cmd) <br>  <font color="#ff8800">15</font> <font color="#ff8800">return</font> command (i) <br>  <font color="#ff8800">sixteen</font> <br>  <font color="#ff8800">17</font> <font color="#ff40ff">@</font> <font color="#00ffff">classmethod</font> <br>  <font color="#ff8800">18</font> <font color="#ff8800">def</font> <font color="#00ffff">set</font> (cls, i): <br>  <font color="#ff8800">19</font> <font color="#808080">"</font> <font color="#ff6060">set, support for nested keys</font> <font color="#808080">"</font> <br>  <font color="#ff8800">20</font> parent = cls.data.get_child (i.keys [: - 1]) <br>  <font color="#ff8800">21</font> <font color="#ff8800">if</font> parent: <br>  <font color="#ff8800">22</font> parent.set_child (i.keys [-1], Entry (i.data, i.flags, i.exptime)) <br>  <font color="#ff8800">23</font> <font color="#ff8800">yield</font> <font color="#808080">"</font> <font color="#ff6060">STORED</font> <font color="#808080">"</font> <br>  <font color="#ff8800">24</font> <font color="#ff8800">else</font> : <br>  <font color="#ff8800">25</font> <font color="#ff8800">yield</font> <font color="#808080">"</font> <font color="#ff6060">NOT_STORED</font> <font color="#808080">"</font> <br><br><br>  Entry code and everything else we look at here - <a href="http://github.com/Deepwalker/tx-cache/blob/master/mck.py">github.com/Deepwalker/tx-cache/blob/master/mck.py</a> <br><br><h4>  Amendments </h4><br>  As was rightly noted in the comments, the use of a singleton for storing Cache is somewhat unjustified, therefore, on github lies the corrected version, which fixes this annoying flaw.  Thank you, <a href="https://habrahabr.ru/users/drjonnie/" class="user_link">drJonnie</a> ! <br><br><h4>  Excuse </h4><br>  What do I expect from this article?  I expect that clever people, of whom there are many, will look at my code and stick their nose at the shortcomings of the lack of academic education.  Perhaps someone this article will be useful, with possible shortcomings, it describes the path to the implementation of network protocols in your programs.  Someone may use this code for their memcache extensions. </div><p>Source: <a href="https://habr.com/ru/post/78114/">https://habr.com/ru/post/78114/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../78106/index.html">C # 3.0 syntax highlighting in blogs</a></li>
<li><a href="../78108/index.html">Proposal for GNOME to exit GNU projects</a></li>
<li><a href="../78109/index.html">I do not want to advertise charlatans</a></li>
<li><a href="../78110/index.html">Nexus One - Will Google go all the same?</a></li>
<li><a href="../78113/index.html">Why Paypal does not accept transfers for Russian accounts? - It is not a feature!</a></li>
<li><a href="../78118/index.html">Skype will no longer be present in the Medibuntu repository.</a></li>
<li><a href="../78119/index.html">Demonoid resumes work?</a></li>
<li><a href="../78120/index.html">‚ÄúOver the Hill‚Äù is more and more interested in the Data technique: URI CSS Sprites</a></li>
<li><a href="../78122/index.html">Work for users</a></li>
<li><a href="../78127/index.html">Created the first portable inkless printer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>