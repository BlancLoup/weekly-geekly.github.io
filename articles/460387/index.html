<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SELinux Beginner's Guide</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Translation of the article prepared for students of the course "Linux Security" 



 SELinux or Security Enhanced Linux is an improved access control ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SELinux Beginner's Guide</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/pp/_j/xp/pp_jxp4pddr_8apkdp5bsztp3r4.png"></p><br><p>  <em>Translation of the article prepared for students of the course <a href="https://otus.pw/31Eb/">"Linux Security"</a></em> </p><br><hr><br><p>  SELinux or Security Enhanced Linux is an improved access control mechanism developed by the US National Security Agency (NSA) to prevent malicious intrusions.  It implements a mandatory (or mandatory) access control model (English Mandatory Access Control, MAC) on top of the existing Discretionary Access Control (DAC) model, that is, read, write, execute permissions. <a name="habracut"></a></p><br><p>  SELinux has three modes: </p><br><ol><li>  <strong>Enforcing</strong> - <strong>denies</strong> access based on policy rules. </li><li>  <strong>Permissive</strong> - logging of actions that violate policies that would be prohibited in enforcing mode. </li><li>  <strong>Disabled</strong> - disable SELinux completely. </li></ol><br><p> The default settings are in <code>/etc/selinux/config</code> </p><br><h1 id="izmenenie-rezhimov-selinux">  Changing SELinux Modes </h1><br><p>  To find out the current mode, run </p><br><pre> <code class="plaintext hljs">$ getenforce</code> </pre> <br><p>  To change the mode to permissive, run the following command </p><br><pre> <code class="plaintext hljs">$ setenforce 0</code> </pre> <br><p>  or, to change the mode from <strong>permissive</strong> to <strong>enforcing</strong> , execute </p><br><pre> <code class="plaintext hljs">$ setenforce 1</code> </pre> <br><p>  If you need to completely disable SELinux, this can only be done through the configuration file. </p><br><pre> <code class="plaintext hljs">$ vi /etc/selinux/config</code> </pre> <br><p>  To disable, change the SELINUX parameter as follows: </p><br><pre> <code class="plaintext hljs">SELINUX=disabled</code> </pre> <br><h1 id="nastroyka-selinux">  SELinux Setup </h1><br><p>  Each file and process is marked with a SELinux context, which contains additional information, such as user, role, type, etc.  If you turn on SELinux for the first time, you first need to set the context and labels.  The process of assigning labels and context is known as labeling.  To start marking, in the configuration file, change the mode to <strong>permissive</strong> . </p><br><pre> <code class="plaintext hljs">$ vi /etc/selinux/config SELINUX=permissive</code> </pre> <br><p>  After setting the <strong>permissive</strong> mode, we will create in the root an empty hidden file named <code>autorelabel</code> </p><br><pre> <code class="plaintext hljs">$ touch /.autorelabel</code> </pre> <br><p>  and restart the computer </p><br><pre> <code class="plaintext hljs">$ init 6</code> </pre> <br><p>  Note: we use <strong>permissive</strong> mode for marking, as the use of <strong>enforcing</strong> mode can lead to a system crash during reboot. </p><br><p>  Do not worry if the download is stuck on a file, the labeling takes some time.  After marking and loading your system, you can go to the configuration file and install <strong>enforcing</strong> mode, as well as run: </p><br><pre> <code class="plaintext hljs">$ setenforce 1</code> </pre> <br><p>  Now you have successfully enabled SELinux on your computer. </p><br><h1 id="monitorim-logi">  Monitor logs </h1><br><p>  You may have some errors during labeling or during system operation.  To check if your SELinux is working correctly and does not block access to any port, application, etc., you need to look at the logs.  The SELinux log is in <code>/var/log/audit/audit.log</code> , but you do not need to read it completely to find errors.  You can use the audit2why utility to find errors.  Run the following command: </p><br><pre> <code class="plaintext hljs">$ audit2why &lt; /var/log/audit/audit.log</code> </pre> <br><p>  As a result, you will receive a list of errors.  If there were no errors in the log, no messages will be displayed. </p><br><h1 id="nastroyka-politiki-selinux">  Setting up a SELinux policy </h1><br><p>  A SELinux policy is a set of rules that governs the SELinux security mechanism.  A policy defines a set of rules for a particular environment.  We will now learn how to configure policies to allow access to prohibited services. </p><br><h4 id="1-logicheskie-znacheniya-pereklyuchateli">  1. Logic values ‚Äã‚Äã(switches) </h4><br><p>  Switches (booleans) allow you to change parts of the policy during operation, without the need to create new policies.  They allow you to make changes without reloading or recompiling SELinux policies. </p><br><p>  <strong>Example</strong> <br>  Suppose we want to share the user's home directory via FTP for reading and writing, and we‚Äôve shared it, but we‚Äôve seen nothing when trying to access it.  This is due to the fact that the SELinux policy prevents the FTP server from reading and writing in the user's home directory.  We need to change the policy so that the FTP server can access the home directories.  Let's see if there are any switches for this by running </p><br><pre> <code class="plaintext hljs">$ semanage boolean -l</code> </pre> <br><p>  This command will display a list of available switches with their current state (on / on or off / off) and a description.  You can refine your search by adding grep to find results related only to ftp: </p><br><pre> <code class="plaintext hljs">$ semanage boolean -l | grep ftp</code> </pre> <br><p>  and find the following </p><br><pre> <code class="plaintext hljs">ftp_home_dir -&gt; off Allow ftp to read &amp; write file in user home directory</code> </pre> <br><p>  This switch is off, so we will enable it using <code>setsebool $ setsebool ftp_home_dir on</code> </p><br><p>  Now our ftp-daemon can access the user's home directory. <br>  Note: You can also get a list of available switches without a description by running <code>getsebool -a</code> </p><br><h4 id="2-metki-i-kontekst">  2. Tags and context </h4><br><p>  This is the most common way to implement SELinux policies.  Each file, folder, process, and port is marked with a SELinux context: </p><br><ul><li>  For files and folders, labels are stored as extended attributes in the file system and can be viewed with the following command: <br><pre> <code class="plaintext hljs">$ ls -Z /etc/httpd</code> </pre> </li><li>  For processes and ports, the labeling is controlled by the kernel, and you can look at these labels as follows: </li></ul><br><p>  process </p><br><pre> <code class="plaintext hljs">$ ps ‚ÄìauxZ | grep httpd</code> </pre> <br><p>  port </p><br><pre> <code class="plaintext hljs">$ netstat -anpZ | grep httpd</code> </pre> <br><p>  <strong>Example</strong> <br>  Now let's take an example to better understand labels and context.  Suppose we have a web server that <code>/var/www/html/  /home/dan/html/</code> instead of the <code>/var/www/html/  /home/dan/html/</code> directory.  SELinux considers this a policy violation and you will not be able to view your web pages.  This is because we have not set the security context associated with the HTML files.  To view the default security context, use the following command: </p><br><pre> <code class="plaintext hljs">$ ls ‚Äìlz /var/www/html -rw-r‚Äîr‚Äî. root root unconfined_u:object_r:httpd_sys_content_t:s0 /var/www/html/</code> </pre> <br><p>  Here we got <code>httpd_sys_content_t</code> as context for html files.  We need to set this security context for our current directory, which now has the following context: </p><br><pre> <code class="plaintext hljs">-rw-r‚Äîr‚Äî. dan dan system_u:object_r:user_home_t:s0 /home/dan/html/</code> </pre> <br><p>  Alternative command to check the security context of a file or directory: </p><br><pre> <code class="plaintext hljs">$ semanage fcontext -l | grep '/var/www'</code> </pre> <br><p>  We will also use semanage to change the context after we find the right security context.  To change the context / home / dan / html, run the following commands: </p><br><pre> <code class="plaintext hljs">$ semanage fcontext -a -t httpd_sys_content_t '/home/dan/html(/.*)?' $ semanage fcontext -l | grep '/home/dan/html' /home/dan/html(/.*)? all files system_u:object_r:httpd_sys_content_t:s0 $ restorecon -Rv /home/dan/html</code> </pre> <br><p>  After the context has been changed using semanage, the restorecon command will load the default context for files and directories.  Our web server can now read files from the <code>/home/dan/html</code> folder, because the security context for this folder has been changed to <code>httpd_sys_content_t</code> . </p><br><h4 id="3-sozdanie-lokalnyh-politik">  3. Creating local policies </h4><br><p>  There may be situations when the above methods are useless for you, and you get errors (avc / denial) in audit.log.  When this happens, you need to create a local policy (Local policy).  All errors can be found using audit2why, as described above. </p><br><p>  To eliminate errors, you can create a local policy.  For example, we get an error related to httpd (apache) or smbd (samba), we grep the errors and create a policy for them: </p><br><pre> <code class="plaintext hljs">apache $ grep httpd_t /var/log/audit/audit.log | audit2allow -M http_policy samba $ grep smbd_t /var/log/audit/audit.log | audit2allow -M smb_policy</code> </pre> <br><p>  Here, <code>http_policy</code> and <code>smb_policy</code> are the names of the local policies we created.  Now we need to load these created local policies into the current SELinux policy.  This can be done as follows: </p><br><pre> <code class="plaintext hljs">$ semodule ‚ÄìI http_policy.pp $ semodule ‚ÄìI smb_policy.pp</code> </pre> <br><p>  Our local policies were loaded, and we should no longer receive any avc or denail in audit.log. </p><br><hr><br><p>  <em>This was my attempt to help you understand SELinux.</em>  <em>I hope that after reading this article you will feel more comfortable with SELinux.</em> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/460387/">https://habr.com/ru/post/460387/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../46037/index.html">jQuery in Action in Russian already on sale</a></li>
<li><a href="../460373/index.html">"Under the hood" Turbo Pages: architecture of fast loading web pages technology</a></li>
<li><a href="../460375/index.html">The book "Machine learning for business and marketing"</a></li>
<li><a href="../460381/index.html">What is assertiveness and why is it needed?</a></li>
<li><a href="../460383/index.html">Screen transitions in Legend of Zelda use the undocumented features of NES</a></li>
<li><a href="../460393/index.html">Background: what to expect from Fedora Silverblue</a></li>
<li><a href="../460397/index.html">Quick start with WebComponents</a></li>
<li><a href="../460399/index.html">SVG download indicator on Vue.js</a></li>
<li><a href="../4604/index.html">Syndication reaction</a></li>
<li><a href="../46040/index.html">The concept of the mechanism for correcting typos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>