<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Text Template Transformation Toolkit (T4): code generator in Visual Studio</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings, Habr! 

 Today we talk about routine. Every now and then every programmer has to do a lot of tedious, voluminous and patterned work, which ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Text Template Transformation Toolkit (T4): code generator in Visual Studio</h1><div class="post__text post__text-html js-mediator-article">  Greetings, Habr! <br><br>  Today we talk about routine.  Every now and then every programmer has to do a lot of tedious, voluminous and patterned work, which I always want to automate, and my hands do not reach.  This is one little-known way to simplify my life with the help of <em>code generation,</em> and today I want to tell the community of dotnetchikov.  The method is known as <a href="http://msdn2.microsoft.com/en-us/library/bb126445.aspx">Text Template Transformation Toolkit</a> or simply <strong>T4</strong> . <br><br><a name="habracut"></a><h2>  Meet T4 </h2><br><h4>  Example task </h4><br>  Imagine the following situation: you need to describe a certain state machine.  It will be implemented incredibly crooked, but the example for illustration is quite suitable.  During the implementation, the heart of the automaton is a function that takes one parameter - the current state, and depending on its value, performs certain actions.  You have described all possible states of the automaton in advance in enum  ªe, and now you are sad to look at the monitor: you have to describe a giant switch on a half-screen, but what you don‚Äôt want ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Specifying the task, let it be 3 states in the automaton (and you imagine a situation when there are 43 of them - let's say this is some kind of WinAPI message), and enum looks like this: <br><br><blockquote><code><font color="black"><font color="#0000ff">enum</font> State <br> { <br> Alive, <br> Dead, <br> Schrodinger <br> }</font></code> </blockquote> <br>  The task is to create with T4 a template that will generate the following code from it: <br><br><blockquote> <code><font color="black"><font color="#0000ff">void</font> Select(State state) <br> { <br> <font color="#0000ff">switch</font> (state) <br> { <br> <font color="#0000ff">case</font> State.Alive: <br> <font color="#008000">// code here</font> <br> <font color="#0000ff">break</font> ; <br> <font color="#0000ff">case</font> State.Dead: <br> <font color="#008000">// code here</font> <br> <font color="#0000ff">break</font> ; <br> <font color="#0000ff">case</font> State.Schrodinger: <br> <font color="#008000">// code here</font> <br> <font color="#0000ff">break</font> ; <br> <font color="#0000ff">default</font> : <br> <font color="#008000">// code here</font> <br> <font color="#0000ff">break</font> ; <br> } <br> } <br></font></code> </blockquote><br><h4>  Recipe solution </h4><br>  Hereinafter I implicitly assume that you have installed Visual Studio 2005/2008/2010.  In an arbitrary project we add a new file with the extension * .tt, for example Switch.tt.  This extension is standard for template files and is automatically recognized by Studio.  Notice, in the Solution Explorer another node was automatically added to it, containing for now an empty Switch.cs file.  It will then be the result of generation. <br>  So, first - a recipe, then an explanation.  Insert the following text into the empty Switch.tt file: <br><blockquote> <code>&lt;#@ template language="C#v3.5" debug="True" #&gt; <br> &lt;#@ output extension="cs" #&gt; <br> void Select(State state) <br> { <br> switch (state) <br> { <br> &lt;# foreach (string Value in Enum.GetNames(typeof(State))) { #&gt; <br> case State.&lt;#= Value #&gt;: <br> // code here <br> break; <br> &lt;# } #&gt; <br> default: <br> // code here <br> break; <br> } <br> } <br> &lt;#+ <br> enum State <br> { <br> Alive, <br> Dead, <br> Schrodinger <br> } <br> #&gt;</code> </blockquote> <br>  After pressing Ctrl + S, you just have to look at Switch.cs and we will see the necessary text there. <br><br><h4>  How does this magic come about? </h4><br>  Take a closer look at the template text.  T4 uses a declarative style, so ASP.NET style tags are used throughout its code.  So, all the code that is in the template file can be divided into five types: <br><ul><li>  Text block - not framed by any tags, copied to the output file "as is". </li><li>  Directives - set the template settings, used by T4 in the generation process.  Framed with tags <code>&lt;#@ #&gt;</code> .  Below I will describe the most used ones. </li><li>  Block of code - this code will literally be inserted into T4 class, which actually generates the output file.  Framed with tags <code>&lt;# #&gt;</code> . </li><li>  Block expression - embedded inside a text block.  It contains some expression that can be compiled as part of a generation class, for example, a variable previously defined in a block of code.  When generating the output file, the current value of this expression will be substituted for it.  Framed with <code>&lt;#= #&gt;</code> tags. </li><li>  The class property block is framed with <code>&lt;#+ #&gt;</code> tags.  We will discuss its purpose later. </li></ul><br>  In order to fully understand the principles by which templates are written, you will have to look behind the scenes: find out exactly how T4 interprets the text of our .tt-file.  To do this, locate the last created .cs file in your% TEMP% folder.  If you throw out numerous #line and format the code, in this case it will look something like this: <br><br><blockquote> <code><font color="#0600FF">namespace</font> Microsoft. <font color="#0000FF">VisualStudio</font> . <font color="#0000FF">TextTemplatingFE5E01C975766D0E3C1DD071A5BFF52A</font> <font color="#000000">{</font> <br> <font color="#0600FF">using</font> <font color="#008080">System</font> <font color="#008000">;</font> <br> <font color="#0600FF">using</font> <font color="#008080">Microsoft.VisualStudio.TextTemplating.VSHost</font> <font color="#008000">;</font> <br> <br> <font color="#0600FF">public</font> <font color="#FF0000">class</font> GeneratedTextTransformation <font color="#008000">:</font> Microsoft. <font color="#0000FF">VisualStudio</font> . <font color="#0000FF">TextTemplating</font> . <font color="#0000FF">TextTransformation</font> <font color="#000000">{</font> <br> <font color="#0600FF">public</font> <font color="#0600FF">override</font> <font color="#FF0000">string</font> TransformText <font color="#000000">(</font> <font color="#000000">)</font> <font color="#000000">{</font> <br> <font color="#0600FF">try</font> <font color="#000000">{</font> <br> <font color="#0600FF">this</font> . <font color="#0000FF">Write</font> <font color="#000000">(</font> <font color="#666666">"void Select(State state) <font color="#008080">\r</font> <font color="#008080">\n</font> { <font color="#008080">\r</font> <font color="#008080">\n</font> <font color="#008080">\t</font> switch (state) <font color="#008080">\r</font> <font color="#008080">\n</font> <font color="#008080">\t</font> { <font color="#008080">\r</font> <font color="#008080">\n</font> "</font> <font color="#000000">)</font> <font color="#008000">;</font> <br> <font color="#0600FF">foreach</font> <font color="#000000">(</font> <font color="#FF0000">string</font> Value <font color="#0600FF">in</font> <font color="#FF0000">Enum</font> . <font color="#0000FF">GetNames</font> <font color="#000000">(</font> <font color="#008000">typeof</font> <font color="#000000">(</font> State <font color="#000000">)</font> <font color="#000000">)</font> <font color="#000000">)</font> <font color="#000000">{</font> <br> <font color="#0600FF">this</font> . <font color="#0000FF">Write</font> <font color="#000000">(</font> <font color="#666666">" <font color="#008080">\t</font> <font color="#008080">\t</font> case State."</font> <font color="#000000">)</font> <font color="#008000">;</font> <br> <font color="#0600FF">this</font> . <font color="#0000FF">Write</font> <font color="#000000">(</font> Microsoft. <font color="#0000FF">VisualStudio</font> . <font color="#0000FF">TextTemplating</font> . <font color="#0000FF">ToStringHelper</font> . <font color="#0000FF">ToStringWithCulture</font> <font color="#000000">(</font> Value <font color="#000000">)</font> <font color="#000000">)</font> <font color="#008000">;</font> <br> <font color="#0600FF">this</font> . <font color="#0000FF">Write</font> <font color="#000000">(</font> <font color="#666666">": <font color="#008080">\r</font> <font color="#008080">\n</font> <font color="#008080">\t</font> <font color="#008080">\t</font> <font color="#008080">\t</font> // code here <font color="#008080">\r</font> <font color="#008080">\n</font> <font color="#008080">\t</font> <font color="#008080">\t</font> <font color="#008080">\t</font> break; <font color="#008080">\r</font> <font color="#008080">\n</font> "</font> <font color="#000000">)</font> <font color="#008000">;</font> <br> <font color="#000000">}</font> <br> <font color="#0600FF">this</font> . <font color="#0000FF">Write</font> <font color="#000000">(</font> <font color="#666666">" <font color="#008080">\t</font> <font color="#008080">\t</font> default: <font color="#008080">\r</font> <font color="#008080">\n</font> <font color="#008080">\t</font> <font color="#008080">\t</font> <font color="#008080">\t</font> // code here <font color="#008080">\r</font> <font color="#008080">\n</font> <font color="#008080">\t</font> <font color="#008080">\t</font> <font color="#008080">\t</font> break; <font color="#008080">\r</font> <font color="#008080">\n</font> <font color="#008080">\t</font> } <font color="#008080">\r</font> <font color="#008080">\n</font> } <font color="#008080">\r</font> <font color="#008080">\n</font> "</font> <font color="#000000">)</font> <font color="#008000">;</font> <br> <font color="#000000">}</font> <br> <font color="#0600FF">catch</font> <font color="#000000">(</font> <font color="#000000">System</font> . <font color="#0000FF">Exception</font> e <font color="#000000">)</font> <font color="#000000">{</font> <br> <font color="#000000">System. <font color="#0000FF">CodeDom</font> . <font color="#0000FF">Compiler</font></font> . <font color="#0000FF">CompilerError</font> error <font color="#008000">=</font> <font color="#008000">new</font> <font color="#000000">System. <font color="#0000FF">CodeDom</font> . <font color="#0000FF">Compiler</font></font> . <font color="#0000FF">CompilerError</font> <font color="#000000">(</font> <font color="#000000">)</font> <font color="#008000">;</font> <br> error. <font color="#0000FF">ErrorText</font> <font color="#008000">=</font> e. <font color="#0000FF">ToString</font> <font color="#000000">(</font> <font color="#000000">)</font> <font color="#008000">;</font> <br> error. <font color="#0000FF">FileName</font> <font color="#008000">=</font> <font color="#666666">"C: <font color="#008080">\\</font> Users <font color="#008080">\\</font> Alex <font color="#008080">\\</font> Documents <font color="#008080">\\</font> Visual Studio 2008 <font color="#008080">\\</font> Projects <font color="#008080">\\</font> T4Article <font color="#008080">\\</font> T4Article <font color="#008080">\\</font> Switch.tt"</font> <font color="#008000">+</font> <font color="#666666">""</font> <font color="#008000">;</font> <br> <font color="#0600FF">this</font> . <font color="#0000FF">Errors</font> . <font color="#0000FF">Add</font> <font color="#000000">(</font> error <font color="#000000">)</font> <font color="#008000">;</font> <br> <font color="#000000">}</font> <br> <font color="#0600FF">return</font> <font color="#0600FF">this</font> . <font color="#0000FF">GenerationEnvironment</font> . <font color="#0000FF">ToString</font> <font color="#000000">(</font> <font color="#000000">)</font> <font color="#008000">;</font> <br> <font color="#000000">}</font> <br> <font color="#FF0000">enum</font> State <br> <font color="#000000">{</font> <br> Alive, <br> Dead, <br> Schrodinger <br> <font color="#000000">}</font> <br> <font color="#000000">}</font> <br> <font color="#000000">}</font></code> </blockquote> <br>  As you can see, T4 automatically creates a class, a successor to <code>Microsoft.VisualStudio.TextTemplating.TextTransformation</code> , and overrides in it a single <code>TransformText()</code> method, which forms the text of the output file in parts.  The code blocks from the source template become part of the method code, and text blocks are added to the output text by calling <code>this.Write</code> .  The expression blocks are interpreted in the same way.  As for the class properties blocks, then, as we see now, they represent the information that will be added later inside the generator class so that it can be referenced in the code of the <code>TransformText()</code> method.  In our example, this is the definition of enum `State, but you can perfectly describe inside <code>&lt;#+ #&gt;</code> , for example, the function that the generator will actively use. <br><br>  The generator is written in C #.  Why?  Because we ordered it.  The directive <code>&lt;#@ template language="C#v3.5" #&gt;</code> sets the programming language used in blocks of code, class properties and expressions.  At the moment, she has only four possible values: <code>"C#"</code> , <code>"VB"</code> , <code>"C#v3.5"</code> and <code>"VBv3.5"</code> <br>  Also, by the way, if <code>&lt;#@ template debug="True" #&gt;</code> were not specified in the text of the template, you would never find any traces of the generator, as well as the associated debugging information, in% TEMP% . <br><br><h4>  Directives </h4><ul><li>  <code>&lt;#@ assembly name="System.Data" #&gt;</code> links the System.Data assembly to the generator project.  It works in the same way as ‚ÄúAdd Reference‚Äù in Visual Studio. </li><li>  <code>&lt;#@ import namespace="System.Diagnostics" #&gt;</code> will add to the generator a using link to the System.Diagnostics namespace. </li><li>  <code>&lt;#@ include file="Another.tt" #&gt;</code> inserts the contents of the Another.tt template at this point. </li><li>  <code>&lt;#@ output extension=".cs" encoding="UTF-8"#&gt;</code> will tell T4 that the output file must be in UTF-8 encoding and have the extension .cs. </li></ul>  The remaining directives and parameters are used much less frequently, so I do not consider it necessary to spend on them your screen space :) curious people can find all the necessary links to the documentation in the postscript. <br><br><h2>  Something special </h2><br><h4>  TextTransformation </h4><br>  It must be admitted that by implementing the template parsing and generator creation, the guys from Microsoft used their realized opportunities as extremely uneconomical.  For example, take the code identification.  The generator mentioned above is problematic to read - the eyes burst from all these infinite output "\ t \ t \ t \ t". <br>  But all it was necessary was to use the simple function <code>PushIndent("\t")</code> .  She adds a new piece to the general prefix, which will then be added to each Write `y.  As you might guess, the <code>PopIndent()</code> function paired to it removes the last bit added to it from the prefix. <br>  And then there is the <code>CurrentIndent</code> property and the <code>ClearIndent()</code> method.  Just for the sake of information :) <br><br>  A similar situation with line breaks - instead of producing in string literals "\ r \ n", you could simply replace Write with WriteLine.  Under the current platform, of course. <br><br>  And it would not hurt to mention the methods of <code>Warning()</code> and <code>Error()</code> .  Being called in the generator code, they will cause respectively a warning or an error, which will appear in the Error List when trying to interpret the template.  It is very convenient to use in unexpected situations in blocks of code. <br><br><h4>  Professional examples </h4><br>  According to the previous task, you may get the impression that T4 templates are advantageous to use only for small improvised tasks, in order not to write a lot of tedious C # code.  Nothing like this.  A striking example illustrating this is: a template from the Tangible collection, which creates a simple html-page with a gallery of pictures using the specified folder with images. <br>  What is most interesting, it is not long, easy to read and modify to the needs of the developer. <br>  In order not to disfigure an article with unnecessary blocks of text, I placed it <a href="http://pastebin.com/f7d109891">on pastebin</a> . <br><br><h4>  T4 stuff </h4><br>  And in conclusion of the article - some useful links. <br>  A link to MSDN T4 documentation was provided at the beginning of the article.  This is the most complete description of the syntax and possibilities of the generator, however, without any useful examples in practice. <br><br>  <a href="http://www.olegsych.com/">Blog Oleg Sych</a> - a storehouse of useful information on T4.  Here you can learn in detail how to debug and modify templates, find a lot of ready-made examples (stored procedures, LINQ and Entity Framework classes, configs, MSBuild and WiX scripts, etc.), as well as a story about more advanced ones capabilities of templates that do not fit in this article.  Perhaps, I will adapt this information to habraauditorii sometime later, in the next article. <br><br>  <a href="http://t4toolbox.codeplex.com/">T4 Toolbox</a> - a set of ready-made templates for creating a ‚ÄúNew File‚Äù T4 in Visual Studio. <br><br>  <a href="http://t4-editor.tangible-engineering.com/">Tangible Engineering's T4 Editor</a> is an easy-to-use editor with backlight and IntelliSense, being introduced as a plug-in to Visual Studio.  Available in two editions: paid and trimmed free.  Personally, the possibilities of the free version are enough for my eyes. <br>  What else is convenient Tangible - its a nice gallery of ready-made templates. <br><br>  <a href="http://www.t4editor.net/">Clarius Consulting's T4 Editor</a> is another editor for T4 templates as a Studio plug-in.  It differs from the previous one only in that the functionality of its free edition is cut a little more. <br><br><h2>  Conclusion </h2><br>  The moral of this story is as follows: if fate has put you before the inevitability of monotonous and tedious work, you should never refuse help.  Especially - from the help of the computer. <br>  Good luck with code generation!  :) <br></div><p>Source: <a href="https://habr.com/ru/post/64895/">https://habr.com/ru/post/64895/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../64882/index.html">About the Internet and freedom of opinion or Web 2.0 in thinking</a></li>
<li><a href="../64883/index.html">Stickerity: upgrade</a></li>
<li><a href="../64888/index.html">FlylinkDC ++ and Wine</a></li>
<li><a href="../64889/index.html">Javascript from a to ... II</a></li>
<li><a href="../64894/index.html">Name mail</a></li>
<li><a href="../64897/index.html">LaTeX in practice. Announcement</a></li>
<li><a href="../64898/index.html">CrowdA - are they ahead of their time?</a></li>
<li><a href="../64905/index.html">Another critical vulnerability, version 3.5.1 is also affected.</a></li>
<li><a href="../64907/index.html">How to attract small businesses to the Internet</a></li>
<li><a href="../64910/index.html">2 new vulnerabilities in Internet Explorer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>