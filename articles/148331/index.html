<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Remote wipe on Android and Exchange ActiveSync</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One day, our Microsoft Exchange administrator mentioned the functionality of a complete wipe of any device of your choice (be it an iPhone, or a Black...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Remote wipe on Android and Exchange ActiveSync</h1><div class="post__text post__text-html js-mediator-article">  One day, our Microsoft Exchange administrator mentioned the functionality of a complete wipe of any device of your choice (be it an iPhone, or a BlackBerry-based or Android device) that received mail via Exchange ActiveSync.  The device reports to the server whether the wipe functionality is available to it, and the administrator can prevent the transfer of mail to devices that do not support wipe. <br><br>  At first, I didn‚Äôt believe it: as it is, the innocuous setup of a mail account gives the mail administrator so much authority on my personal device.  After making a full backup of the SD card and all the internal memory, I suggested an experiment.  And a miracle - a push-notification came, the phone was podzavis, after a while it rebooted and I was left with the factory settings.  And the SD card showed no signs of life at all. <br><br><img src="https://habrastorage.org/storage2/642/0e9/3df/6420e93dfc872177be1ffe6ecf2e7ded.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Interested, I decided to study this issue and, if possible, disable the malicious functionality of the mail client. <br><br><a name="habracut"></a><br><br>  First you had to see what happened to the SD card.  The phone believed that it was missing and I inserted it into the card reader.  A scan in the HEX editor showed that the partition table (MBR) is overwritten, but the partitions themselves (FAT32 and Linux swap) are quite normal.  With the wonderful <a href="http://www.cgsecurity.org/wiki/TestDisk">TestDisk</a> utility, I instantly restored the contents of the card to the state before cleaning (here you have Full Wipe) <br><br>  Then I looked through the Android sources, searching for the keywords wipe, clear, factory settings.  The self-destruction code is located in the /system/framework/services.jar module and is a kind of BroadcastReceiver that is waiting for a data destruction request (the <a href="http://www.devdaily.com/java/jwarehouse/android/services/java/com/android/server/MasterClearReceiver.java.shtml">source code of this class</a> ) <br><br>  The <b>Settings.apk</b> application, part of the open-source Android package, calls it in the following way: <br><pre><code class="java hljs">sendBroadcast(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-string"><span class="hljs-string">"android.intent.action.MASTER_CLEAR"</span></span>));</code> </pre> <br>  From an unauthorized call, he allegedly protected <br><pre> <code class="hljs pgsql">It can <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> be granted <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> apps signed <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> the platform key, <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> installed <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span>.</code> </pre> <br>  But, as we will see below, a regular application can bypass this protection. <br><br>  After searching for other ways to start cleaning, I found a recipe on Stackoverflow, just like a normal application (without special permissions), can ask <b>Settings.apk to</b> show a cleaning management page, where the user can click on ‚ÄúClear‚Äù on the page of the trusted application. <br><pre> <code class="java hljs">Context ctx = createPackageContext(<span class="hljs-string"><span class="hljs-string">"com.android.settings"</span></span>, Context.CONTEXT_IGNORE_SECURITY | Context.CONTEXT_INCLUDE_CODE); Class&lt;?&gt; mc = ctx.getClassLoader().loadClass(<span class="hljs-string"><span class="hljs-string">"com.android.settings.MasterClear"</span></span>); startActivity(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(ctx, mc));</code> </pre><br><br>  While everything is under the control of the user ... <br><br>  Next, I decompiled all applications from the standard Gingerbread 2.42 (HTC Sense) firmware for Desire Z, and looked in the source for references to android.intent.action.MASTER_CLEAR, or to com.android.settings.MasterClear. <br><br>  In total there were four such applications: <br><pre>  CheckinProvider.apk
 MyHTC.apk
 Settings.apk
 Mail.apk </pre><br><br>  The first two are the functionality of locking a lost device from Google and HTC online services, then clearing the device at the user's request from the settings page and the cause of the investigation, the email client. <br><br>  Mailer calls for cleaning with this code: <br><pre> <code class="java hljs"> Intent i = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-string"><span class="hljs-string">"android.intent.action.MAIN"</span></span>); i.setClassName(<span class="hljs-string"><span class="hljs-string">"com.android.settings"</span></span>, <span class="hljs-string"><span class="hljs-string">"com.android.settings.MasterClear"</span></span>); i.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK); i.putExtra(<span class="hljs-string"><span class="hljs-string">"EASRemoteWipe"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mContext.startActivity(i);</code> </pre><br>  That is, from the previous example, he went a little further and causes not an activity with a button that the user can click, but an activity that starts after pressing the button. <br><br>  I have a suspicion that special permissions are not needed to execute this code (I can‚Äôt verify it, because neither java-IDE nor Android SDK is installed). <br><br>  On this my curiosity was satisfied.  Having corrected the MasterClear line on <b>MasterXlear</b> in <b>dizasm listing</b> , I rebuilt Mail.apk, uploaded it to the device and checked that the wipe from exchange command no longer has power over the phone (when trying to synchronize mail, a synchronization error appears until the ‚Äúlost‚Äù phone will be untied from the exchange account, after which on the next synchronization all mail is re-uploaded, like on a new device, and continues to work normally) <br><br>  In conclusion, I will describe a few rakes that gave me a lot of pleasure in overcoming them.  For Android developers, these are elementary things, but for novice hackers, they are not obvious. <br><br>  1. Signature of the reassembled application. <br><br>  Any Android application must be signed by a personal developer certificate, otherwise it will not start.  A free certificate can be obtained from the <b>openssl</b> program, if you ask it about it like this: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">openssl</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">genrsa</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-out</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">key</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pem</span></span> 1024 <span class="hljs-selector-tag"><span class="hljs-selector-tag">openssl</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">req</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-new</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-key</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">key</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pem</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-out</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">request</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pem</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">openssl</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">x509</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-req</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-days</span></span> 9999 <span class="hljs-selector-tag"><span class="hljs-selector-tag">-in</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">request</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pem</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-signkey</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">key</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pem</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-out</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">certificate</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pem</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">openssl</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pkcs8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-topk8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-outform</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DER</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-in</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">key</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pem</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-inform</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PEM</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-out</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">key</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pk8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-nocrypt</span></span></code> </pre><br>  As a result, we will get the desired <b>certificate.pem</b> , <b>key.pem</b> and <b>key.pk8</b> , which we will sign <b>reassembled Mail.apk</b> with the help of the utility <b>signapk.jar</b> : <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">java</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-jar</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">signapk</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.jar</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">certificate</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pem</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">key</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pk8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mail-unsigned</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.apk</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mail-signed</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.apk</span></span></code> </pre><br><br>  2. Dalvik cache <br><br>  Each application has a JIT compilation cache so as not to compile each run.  When you install apk in the usual way, the cache is cleared, but when copying the application (to the system / system / app partition), you need to clear it yourself: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">rm</span></span> /data/dalvik-cache/*<span class="hljs-variable"><span class="hljs-variable">@Mail</span></span>.apk@*</code> </pre> <br><br>  3. Glitches apktool <br><br>  The <a href="http://code.google.com/p/android-apktool/">apktool</a> utility, which I used to disassemble and rebuild the application, persistently created an inoperative file.  Inside apk there are resources compiled into a binary file <b>resources.arsc</b> (for example, xml resources in this file are converted to a binary form, most likely for easy navigation through the xml tree) and the code compiled into <b>classes.dex</b> .  Since I only need to edit the code, when I decompiled I set the option -r (Do not decode resources) and after compiling the corrected tripe back into the apk-file, it finally started. </div><p>Source: <a href="https://habr.com/ru/post/148331/">https://habr.com/ru/post/148331/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148324/index.html">Sublime Text 2: How to create a snippet?</a></li>
<li><a href="../148325/index.html">Computational geometry, or how I became involved in Olympiad programming. Part 2</a></li>
<li><a href="../148326/index.html">The practice of using digital filters</a></li>
<li><a href="../148327/index.html">‚ÄúDiv‚Äù blocks of the same height</a></li>
<li><a href="../148329/index.html">What have you spent your best karma on?</a></li>
<li><a href="../148332/index.html">Create a feedback form using Google Forms</a></li>
<li><a href="../148334/index.html">Black screen internet. An example of a minimal useful web application.</a></li>
<li><a href="../148337/index.html">Why copyright is unconstitutional</a></li>
<li><a href="../148338/index.html">ASP.NET MVC 3/4: Anti-Hacking</a></li>
<li><a href="../148340/index.html">Template sites VS exclusive sites</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>