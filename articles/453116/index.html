<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Serverless PHP on AWS Lambda</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. Already on Monday, the first lesson in the new group ‚ÄúBackend Developer in PHP‚Äù course will take place. In this regard, we continue to publish ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Serverless PHP on AWS Lambda</h1><div class="post__text post__text-html js-mediator-article">  Hello.  Already on Monday, the first lesson in the new group <a href="https://otus.pw/GOXb/">‚ÄúBackend Developer in PHP‚Äù</a> course will take place.  In this regard, we continue to publish useful material on the topic.  Let's start. <br><br><img src="https://habrastorage.org/webt/_d/a5/ms/_da5ms7x5zhr34schrl4ghoxf0e.png"><br><br>  Like <a href="https://blog.gardeviance.org/2016/11/why-fuss-about-serverless.html">Simon Wordley</a> , I believe that serverless computing is an extremely interesting area, primarily because of the granular payment system (pay only when your code is executed), and you do not need to worry about servicing and preparing servers and containers.  So much so that I work with the open <a href="https://github.com/apache/incubator-openwhisk-runtime-php">PHP Runtime</a> for <a href="http://openwhisk.org/">Apache OpenWhisk</a> , the commercial version of which is available as one of the <a href="https://www.ibm.com/cloud/functions">IBM Cloud</a> features. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There are other serverless providers, and <a href="https://aws.amazon.com/lambda/">AWS Lambda</a> is the market leader, but until recently PHP support was extremely cumbersome and unsightly.  This changed at the end of 2018 with a new Lambda <a href="https://docs.aws.amazon.com/lambda/latest/dg/runtimes-api.html">runtime API</a> and <a href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html">layer support</a> . <br><br>  Let's look at the practical aspects of serverless PHP on Lambda with a <a href="https://serverless.com/">Serverless Framework</a> . <br><br><h2>  TL; DR </h2><br>  The source code for a simple Hello World is in my <a href="https://github.com/akrabat/lambda-php/tree/2019-01-02-article">lambda-php</a> repository on Github.  Go to the <i>Notes</i> section, and we can continue. <br><br><h2>  PHP runtime </h2><br>  The runtime API allows you to use any runtime with Lambda.  In a sense, this is similar to the work of OpenWhisk, since there is an HTTP API between serverless platform and runtime.  There is one big difference that with Lambda, runtime sends a request to the platform to receive call data, whereas OpenWhisk calls the endpoint that runtime should provide.  For more information, see the Michael Moussa article <a href="https://aws.amazon.com/blogs/apn/aws-lambda-custom-runtime-for-php-a-practical-example/">on the AWS blog</a> , which inspired me to do this work. <br><br>  To get started, we need a PHP runtime for Lambda.  It will consist of a PHP executable file, PHP code to call the serverless function, and a <code>bootstrap</code> file, as required by the platform.  From these three things we collect the layer.  Layers can be reused in different accounts, so I am surprised that AWS does not provide us with a PHP account.  Unbelievable, but true, they do not use PHP 7.3, so we will have to build our own. <br>  All files we put in the directory <code>layer/php</code> in our project. <br><br><h2>  Building a PHP Executable </h2><br>  We need a PHP executable file that will run inside Lambda containers.  The easiest way to do this is to compile it on the same platform as Lambda, so we will use EC2.  Michael's article explains how to do this, and I wrapped these commands in the <a href="">compile_php.sh</a> script, so that I could copy it into an EC2 instance, run it and copy the executable file back to my computer: <br><br><pre> <code class="php hljs">$ export AWS_IP=ec2-user@{ipaddress} $ export SSH_KEY_FILE=~/.ssh/aws-key.rsa $ scp -i $SSH_KEY_FILE compile_php.sh $AWS_IP:doc/compile_php.sh $ ssh -i $SSH_KEY_FILE -t $AWS_IP <span class="hljs-string"><span class="hljs-string">"chmod a+x compile_php.sh &amp;&amp; ./compile_php.sh 7.3.0"</span></span> $ scp -i $SSH_KEY_FILE $AWS_IP:php<span class="hljs-number"><span class="hljs-number">-7</span></span>-bin/bin/php layer/php/php</code> </pre> <br><br>  This approach will make it well replicable, and hopefully it will just update to new versions of PHP. <br><br><h2>  Bootstrapping </h2><br>  Since we are using the runtime API, we will need the <code>bootstrap</code> file.  This file name is required by Lambda itself, it is responsible for calling the function, corresponding to the images by calling the API in a loop. <br><br>  In essence, we need to be in a loop and call the end point <code>/next</code> to understand what to call next, call it, and then send the answer to the end point <code>/response</code> . <br>  AWS provides an example in BASH <a href="https://docs.aws.amazon.com/lambda/latest/dg/runtimes-walkthrough.html">using curl</a> : <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> HEADERS=<span class="hljs-string"><span class="hljs-string">"$(mktemp)"</span></span> <span class="hljs-comment"><span class="hljs-comment"># Get an event EVENT_DATA=$(curl -sS -LD "$HEADERS" -X GET "http://${AWS_LAMBDA_RUNTIME_API}/2018-06-01/runtime/invocation/next") REQUEST_ID=$(grep -Fi Lambda-Runtime-Aws-Request-Id "$HEADERS" | tr -d '[:space:]' | cut -d: -f2) # Execute the handler function from the script RESPONSE=$($(echo "$_HANDLER" | cut -d. -f2) "$EVENT_DATA") # Send the response curl -X POST "http://${AWS_LAMBDA_RUNTIME_API}/2018-06-01/runtime/invocation/$REQUEST_ID/response" -d "$RESPONSE" done</span></span></code> </pre> <br><br>  We want to do the same in PHP, and although I could write it on my own, Parikshit Agnihotri already beat me to <a href="https://github.com/pagnihotry/PHP-Lambda-Runtime/blob/master/runtime/runtime.php">PHP-Lambda-Runtime / runtime.php</a> , so we just copy it to <code>layer/php/runtime.php</code> .  In my version, I made a few changes, added json_encoding and improved the error handler. <br>  The <code>layer/php/bootstrap</code> file is very simple, and all that is required of it is to run the PHP executable file with this file: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh cd $LAMBDA_TASK_ROOT /opt/php /opt/runtime.php</span></span></code> </pre> <br><br>  That's all.  Now we have three files in layer / php: <br><br><ul><li>  <code>php</code> - <code>php</code> executable file; </li><li>  <code>runtime.php</code> - Work file runtime API; </li><li>  <code>bootstrap</code> - required Lambda file. </li></ul><br><br>  In the end, all this will become the PHP Layer (layer) in our Lambda application. <br><br><h2>  Serverless Framework Setup </h2><br>  Serverless Framework provides repeatable configuration and deployment of serverless applications.  I am a fan of this concept and I want to use more of these tools.  We will use the Serverless Framework for our PHP Hello World. <br>  Since there is no convenient template for PHP applications in the Serverless Framework, we simply create the <code>serverless.yml</code> file in the directory with our project. <br>  For a start, the most basic: <br><br><pre> <code class="php hljs">service: php-hello-world provider: name: aws runtime: provided region: eu-west<span class="hljs-number"><span class="hljs-number">-2</span></span> memorySize: <span class="hljs-number"><span class="hljs-number">128</span></span></code> </pre> <br><br>  We will call our application <code>php-hello-world</code> and use AWS as the provider.  Since I am in the UK, I established the <a href="https://docs.aws.amazon.com/general/latest/gr/rande.html">region of London</a> .  We do not need a lot of memory, so 128 MB will be enough. <br>  Runtime is usually the language in which you want your function to be executed.  To use the <code>runtime API</code> that our <code>bootstrap</code> file will execute, you set this field to <a href="https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html">provided</a> . <br>  You will <code>.gitignore</code> need a <code>.gitignore</code> file containing: <br><br><pre> <code class="php hljs">.serverless</code> </pre> <br><br>  Because we don‚Äôt need this directory in <code>git</code> . <br>  Next, let's add our layer to <code>serverless.yml</code> by adding: <br><br><pre> <code class="php hljs">layers: php: path: layer/php</code> </pre> <br><br>  This will create an AWS layer and give it the name <code>PhpLambdaLayer</code> , which we can refer to in our function. <br><br>  Let's write the <code>Hello World</code> function <br>  Now we can write our serverless PHP function.  It is necessary to enter in the file <code>handler.php</code> : <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($eventData)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-string"><span class="hljs-string">"msg"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"hello from PHP "</span></span> . PHP_VERSION]; }</code> </pre> <br><br>  The function takes information about the event and returns an associative array. <br>  To inform the Serverless Framework about the deployment of our feature, add the following to the <code>serverless.yml</code> file: <br><br><pre> <code class="php hljs">functions: hello: handler: handler.hello layers: - {Ref: PhpLambdaLayer}</code> </pre> <br><br>  Serverless Framework supports multiple functions for a single application.  Each of them has a name, in this case <code>hello</code> , and, in our case, a handler, which is the name of the file without an extension, followed by a dot, and then the name of the function in that file.  Thus, <code>handler.hello</code> means that we will run the <code>hello()</code> function in <code>handler.php</code> . <br>  Finally, we also report functions about our PHP layer so that it can execute PHP code. <br><br><h2>  Deploy to Lambda </h2><br>  To expand our function with its layer, we run the following command: <br><br><pre> <code class="php hljs">$ sls deploy</code> </pre> <br><br>  If the command is continued for a long time, an output similar to this will be received: <br><br><img src="https://habrastorage.org/webt/ug/tp/yc/ugtpycgq4z_-_4w2gjfcgp8bsrs.png"><br><br><h2>  Perform our function </h2><br>  After deployment, we can call the function using the command: <br><br><pre> <code class="php hljs">$ sls invoke -f hello -l</code> </pre> <br><br><img src="https://habrastorage.org/webt/r6/bw/dd/r6bwddsehfdsltvezx7-abrrwfy.png"><br><br>  And everything is ready! <br><br><h2>  Let's sum up </h2><br>  Thanks to new layers and the runtime API, you can now easily run serverless PHP functions in Lambda.  This is great news for PHP developers tied to AWS. <br><br>  We are waiting for your comments, friends! </div><p>Source: <a href="https://habr.com/ru/post/453116/">https://habr.com/ru/post/453116/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../453108/index.html">Overview of the program HolyJS 2019 Piter and links to the online broadcast</a></li>
<li><a href="../45311/index.html">MACRO is a flexible PHP template engine with a human face.</a></li>
<li><a href="../453110/index.html">Elastic made free problematic security functions previously derived from open source.</a></li>
<li><a href="../453112/index.html">Conversations'19: conversational AI for those who develop and who still doubt</a></li>
<li><a href="../453114/index.html">3D interfaces are usually worse than 2D interfaces</a></li>
<li><a href="../453118/index.html">Video mapping is spectacular! Compilation of interesting installations and thoughts on how to make a projector a means of earning</a></li>
<li><a href="../453122/index.html">Kotlin Heroes Programming Contest</a></li>
<li><a href="../453126/index.html">UIAppearance was not so simple</a></li>
<li><a href="../453128/index.html">Telecom Digest: 15 expert materials on IPv6, information security, standards and legislation in IT</a></li>
<li><a href="../453130/index.html">Systematic correction codes. Linearly group code</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>