<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Step-by-step modification of the preset Bacula setting</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 This is a brief step-by-step guide for beginners: how to change an already working backup system based on Bacula. This work will help y...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">🔎</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">📜</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">⬆️</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">⬇️</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Step-by-step modification of the preset Bacula setting</h1><div class="post__text post__text-html js-mediator-article"><h3>  Introduction </h3><br>  This is a brief step-by-step guide for beginners: how to change an already working backup system based on Bacula.  This work will help you understand the relationship of bacula configuration elements. <br><br>  In modern GNU / Linux distributions, the Bacula package installed from packages is often already configured to back up the OS configuration.  If your bacula is not set up in advance, take the complete manual (see “Literature”). <br><a name="habracut"></a><br><h3>  general description </h3><br>  The task is to add a new one in addition to the existing storage and organize a backup to a new location.  For this task, you must perform 4 steps. <br><br><ol><li>  The “Device” section must be added to the configuration file of the bacula-sd guard daemon in order for the daemon to learn about the new storage location. </li><li>  In the configuration file of the daemon-manager bacula-dir (bacula-dir.conf) you need to add the section “Storage”, which will describe the new “storage” (organized on the new “device” of the storage daemon). </li><li>  In the bacula-dir.conf file, add the “Pool” section, which will announce the new volume set (located on the new “storage”). </li><li>  In the bacula-dir.conf file, add the “Job” section, which will describe the new backup task (using the new set of volumes). </li></ol><br>  In addition to creating backups, you need to configure the ability to restore files.  To do this, you need to create a job for recovery - a new section “Job” with the job type “Restore”. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In case you need to set a new backup schedule, you will need to add the “Shedule” section to the bacula-dir.conf file and then the new schedule can be used in an existing or new task.  You can also describe several sets of volumes, for example, for long-term storage of full copies and short-term - incremental archives, then create corresponding tasks with these sets of volumes. <br><br>  If you change the parameters of the volume set (if the content of some already existing “Pool” section has changed), be sure to execute the update command in the bacula console.  With this command, the bacula-dir daemon will update the intervals (storage time) of the previously created volumes of the modified set. <br><br><h3>  Step 1. Add a storage location (Device) in bacula-sd.conf </h3><br>  In the configuration of the bacula-sd storage daemon we will add a new place (“device”) for storing files - the “Device {}” section. <br><br>  1.1.  Create the file /etc/bacula/device/backupstorage.conf <br>  - we copy available "in a box" /etc/bacula/device/file.conf <br>  and change in it the path to place the files, the name and type of media.  “Name” and “media type” should be unique among the “Device” descriptions - they will be used to select the storage location in the backup task. <br><br><pre><code class="hljs pgsql"># Definition <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> file <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span> device # iSCSI volume "iqn.2012-07.com.lenovoemc:storage.ix4-300d.ix4-300d-vol3g" # mapped <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> /dev/disk/<span class="hljs-keyword"><span class="hljs-keyword">by</span></span>-label/backupstorage # <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> mounted <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> /srv/backup/backupstorage # Device { <span class="hljs-type"><span class="hljs-type">Name</span></span> = BackupStorage Media <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> = File-NAS Archive Device = "/srv/backup/backupstorage" LabelMedia = yes; Random <span class="hljs-keyword"><span class="hljs-keyword">Access</span></span> = Yes; AutomaticMount = yes; RemovableMedia = <span class="hljs-keyword"><span class="hljs-keyword">no</span></span>; AlwaysOpen = <span class="hljs-keyword"><span class="hljs-keyword">no</span></span>; }</code> </pre> <br><br>  1.2.  Add this file to the /etc/bacula/bacula-sd.conf configuration next to the others: <br><br><pre> <code class="hljs pgsql">… @/etc/bacula/device/filestorage.conf @/etc/bacula/device/tapedrives.conf @/etc/bacula/device/backupstorage.conf # # Send <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> messages <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the Director, # mount messages <span class="hljs-keyword"><span class="hljs-keyword">also</span></span> are sent <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the email address # Messages { <span class="hljs-type"><span class="hljs-type">Name</span></span> = Standard director = labara-host = <span class="hljs-keyword"><span class="hljs-keyword">all</span></span>, !skipped, !restored }</code> </pre><br><br>  1.3.  We give the bacula-sd daemon a command to re-read the configuration. <br><br>  service bacula sd reload <br>  or <br>  /etc/init.d/bacula-sd reload <br><br><h3>  Step 2. Add the storage in bacula-dir.conf </h3><br>  Now add information about the new storage location to the bacula-dir daemon configuration — insert a new section “Storage {}” into the file “bacula-dir.conf”. <br><br>  2.1.  Create the file /etc/bacula/storage/backupstorage.conf - you can copy the existing /etc/bacula/storage/file.conf and replace the parameters "Name", "Device" and "Media Type".  Name we write new, for “Device” we use “Name” from “Step 1”, for “Media Type” - “Media Type” from “Step 1”. <br><br><pre> <code class="hljs pgsql"># Definition <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span> instance <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> # iSCSI volume "iqn.2012-07.com.lenovoemc:storage.ix4-300d.ix4-300d-vol3g", # mounted <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> /srv/backup/backupstorage # <span class="hljs-keyword"><span class="hljs-keyword">Storage</span></span> { <span class="hljs-type"><span class="hljs-type">Name</span></span> = NASBackupStorage Address = "192.0.2.3" SDPort = <span class="hljs-number"><span class="hljs-number">9103</span></span> @/etc/bacula/bacula-sd-<span class="hljs-keyword"><span class="hljs-keyword">password</span></span>.conf Device = BackupStorage Media <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> = File-NAS }</code> </pre><br><br>  2.2.  We insert /etc/bacula/storage/backupstorage.conf in /etc/bacula/bacula-sd.conf next to the others: <br><br><pre> <code class="hljs mel">… @/etc/bacula/client/client1.conf @/etc/bacula/storage/<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>.conf @/etc/bacula/storage/example.conf @/etc/bacula/storage/backupstorage.conf @/etc/bacula/messages/standart.conf @/etc/bacula/messages/daemon.conf @/etc/bacula/pool/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.conf …</code> </pre><br><br><h3>  Step 3. Add a volume pool to bacula-dir.conf </h3><br>  That bacula separately considered the files located on NAS, we create a pool for them.  This pool is clearly not attached to the repository, it will be used in the task. <br>  The same storage can be tied to multiple pools, for example, you can make different pools for weekly, monthly and daily backups, each with different storage times for volumes. <br><br>  3.1.  Create the file /etc/bacula/pool/nas.conf with the description of the Pool section.  Differences from default - label format (to distinguish files with stored data) and name.  It is also very desirable to limit the size of the volume, otherwise bacula will write everything into one volume and at some point the disk will overflow. <br><br><pre> <code class="hljs pgsql"># <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span> pool definition <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> NAS <span class="hljs-keyword"><span class="hljs-keyword">Storage</span></span> Pool { <span class="hljs-type"><span class="hljs-type">Name</span></span> = NAS Pool <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> = Backup Recycle = yes # Bacula can automatically recycle Volumes AutoPrune = yes # Prune expired volumes Volume Retention = <span class="hljs-number"><span class="hljs-number">365</span></span> days # one year LabelFormat = "bn" # Use <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> more Maximum Volume Bytes <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> disk Maximum Volume Bytes = <span class="hljs-number"><span class="hljs-number">4</span></span>G }</code> </pre><br><br>  3.2.  We put /etc/bacula/pool/nas.conf in /etc/bacula/bacula-sd.conf next to the others. <br><br><pre> <code class="hljs css">… @/<span class="hljs-keyword"><span class="hljs-keyword">etc</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">bacula</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">pool</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">conf</span></span> @/etc/bacula/pool/scratch.conf @/etc/bacula/pool/nas.conf …</code> </pre><br><br><h3>  Step 4. Add tasks to bacula-dir.conf </h3><br>  Now add the task using the existing Schedule «WeeklyCycle» (see the file /etc/bacula/schedule/weeklycycle.conf).  If the existing schedule does not suit us, we will have to create new schedules, in which we will specify the pools, start time and backup modes, and after they are created - new tasks. <br>  In the existing configuration there are tasks “BackupFullSet” (server files) with priority 10 and “BackupCatalog” (base Bakula) with priority 11. We will set the same priorities for our tasks. <br><br>  4.1.  In order not to write the same backup parameters to the mounted NAS volume many times, create a file with the JobDefs section /etc/bacula/job/defaultnasjob.conf: <br><pre> <code class="hljs pgsql">JobDefs { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "NASDefaultJob" <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> = Backup <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> = Incremental Client = fd FileSet = "Full Set" Storage = NASBackupStorage Messages = Standard Pool = NAS Priority = <span class="hljs-number"><span class="hljs-number">10</span></span> }</code> </pre><br><br>  4.2.  The task for saving server files to the NAS volume, its queue is “10”.  Create a job file /etc/bacula/job/baculadup.conf <br><br><pre> <code class="hljs pgsql"># # Define the duplicate <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> main backup job. This job stores backup <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> NAS. # Job { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "BackupFullSetDup" JobDefs = "NASDefaultJob" Schedule = "WeeklyCycle" <span class="hljs-keyword"><span class="hljs-keyword">Write</span></span> Bootstrap = "/srv/backup/backupstorage/bacula/DUPClient1.bsr" }</code> </pre><br><br>  4.3.  The task to save the bacula database on the NAS that needs to be performed last, queue number "11".  Create the job file /etc/bacula/job/backupcatalognas.conf: <br><br><pre> <code class="hljs pgsql">Job { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "BackupCatalogNAS" JobDefs = "NASDefaultJob" <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">Full</span></span> FileSet="Catalog" Schedule = "WeeklyCycleAfterBackup" # This creates an ASCII <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the catalog RunBeforeJob = "/usr/share/bacula/scripts/make_catalog_backup" # This deletes the <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the catalog RunAfterJob = "/usr/share/bacula/scripts/delete_catalog_backup" <span class="hljs-keyword"><span class="hljs-keyword">Write</span></span> Bootstrap = "/srv/backup/backupstorage/bacula/BackupCatalogNAS.bsr" Priority = <span class="hljs-number"><span class="hljs-number">11</span></span> # run <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> main backup }</code> </pre><br><br>  4.4.  Insert new job files in /etc/bacula/bacula-sd.conf alongside others: <br><br><pre> <code class="hljs mel">… @/etc/bacula/pool/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.conf @/etc/bacula/pool/scratch.conf @/etc/bacula/pool/nas.conf @/etc/bacula/job/defaultjob.conf @/etc/bacula/job/backupcatalog.conf @/etc/bacula/job/bacula.conf @/etc/bacula/job/defaultnasjob.conf @/etc/bacula/job/baculadup.conf @/etc/bacula/job/backupcatalognas.conf</code> </pre><br><br><h3>  Step 5. Check </h3><br>  5.1.  We give the command to the bacula-dir daemon to re-read the configuration.  The most reliable way to do this is with the reload command in the bacula-dir console: if the changed configuration contains an error, the daemon will show the location of the error in the console and continue working in the previous configuration. <br><br>  Connect to the bacula-dir daemon using bconsole or BAT.  In the console, enter the reload command (in BAT, you can use the graphical interface instead of entering the command: on the “console” line, right-click and select “Reload bacula-dir.conf” in the context menu). <br><br>  If something is wrong, you will see an error message in the console, if everything is in order, there will be no messages in the console. <br><br>  5.2.  We perform a backup of the new task.  This is most conveniently done in BAT: open the “Jobs” tab, select the name of the new task in the list of tasks (for example, “BackupFullSetDup”), right-click and select “RunJob” in the context menu. <br><br>  The status of the job, see the tab "Jobs Run".  In the console, see the steps to complete the task (the .message command).  If the task ends with an error, you can see an error message in the console. <br><br><h3>  Step 6. Create a file recovery task </h3><br>  In order to quickly restore a lost (deleted or modified) file, we will prepare a task of the “Restore” type.  It uses the same Pool, Storage, Fileset, and Client as in the “Backup” type task, a recovery path has been added (“Where”), the type is different, there is no schedule and level. <br><br>  6.1.  Add the file /etc/bacula/job/restorefromnas.conf: <br><br><pre> <code class="hljs pgsql">Job { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "RestoreFromNAS" <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> = Restore Client=fd FileSet="Full Set" Storage = NASBackupStorage Pool = NAS Messages = Standard <span class="hljs-keyword"><span class="hljs-keyword">Where</span></span> = /tmp/bacula-restores }</code> </pre><br><br>  6.2.  Insert the new job file in /etc/bacula/bacula-sd.conf next to the others: <br><br><pre> <code class="hljs css">… @/<span class="hljs-keyword"><span class="hljs-keyword">etc</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">bacula</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">job</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">restore</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">conf</span></span> @/etc/bacula/job/restorefromnas.conf …</code> </pre><br><br><h3>  Literature </h3><br><ul><li>  <a href="http://habrahabr.ru/post/135291/">Centralized backup of Windows and * nix servers using Bacula</a> </li><li>  <a href="http://habrahabr.ru/post/86526/">Customize and Understand Bacula</a> </li><li>  <a href="http://habrahabr.ru/post/211755/">Bacula: for those who need to quickly and in pictures</a> </li><li>  <a href="http://bacula.org/">Bacula - official site</a> </li><li>  <a href="https://ru.wikipedia.org/wiki/Bacula">Bacula - Wikipedia</a> </li></ul><br><br><h3>  Addition </h3><br>  In the default configuration, bacula creates a log file and this file grows without restrictions (the rule of rotation logrotate is usually not provided). <br>  Also, if you do not run bconsole and do not connect using BAT, the bacula-director accumulates console messages in the `hostname`.conmsg file (in the working directory). <br>  See /etc/bacula/messages/daemon.conf for details.  (In order not to store console messages, you can disable them, although this is not ideal. And the log should be rotated using logrotate.) </div><p>Source: <a href="https://habr.com/ru/post/243719/">https://habr.com/ru/post/243719/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../243705/index.html">Analyze text with Azure Machine Learning</a></li>
<li><a href="../243707/index.html">What I learned from C # /. Net developers at the Go conference #</a></li>
<li><a href="../243711/index.html">"English Lessons": Habrahabr vs Geektimes</a></li>
<li><a href="../243713/index.html">Flow - static type analysis in JS from Facebook</a></li>
<li><a href="../243715/index.html">Tomorrow at 10:00 (MSK), watch the Russian App Day conference broadcast</a></li>
<li><a href="../243721/index.html">Using anonymous methods in Delphi</a></li>
<li><a href="../243723/index.html">Gov.uk: basic aspects of the agile methodology</a></li>
<li><a href="../243725/index.html">Cooling server. Divide and rule</a></li>
<li><a href="../243727/index.html">Just backup btrfs</a></li>
<li><a href="../243731/index.html">Update on Android 5 Lolipop kills self-signed applications without the possibility of recovery</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>