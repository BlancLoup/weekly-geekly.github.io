<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Proxmox 3.1: installation details out of the box</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The virtualization system "Proxmox" on Habr√© is dedicated to several posts, and, of course, before writing this post, I had the opportunity to study t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Proxmox 3.1: installation details out of the box</h1><div class="post__text post__text-html js-mediator-article">  The virtualization system "Proxmox" on Habr√© is dedicated to several posts, and, of course, before writing this post, I had the opportunity to study them for my own experiment.  My research was to install Proxmox 3.1 on bare metal, configure it, and transfer existing virtual machines from VMWare to a new system.  Installing the OS was made, as the name implies, from the distribution of Proxmox 3.1, "as is."  During the installation, configuration, and import of virtual machines, interesting moments arose, which I would like to share with the community. <br><a name="habracut"></a><br><h5>  The first moment: Installation of the system and the message "GRUB LOADING ..." </h5><br>  After installing the OS from the disk, the system reboots and the Proxmox first starts, at this moment the message ‚ÄúGRUB LOADING ..‚Äù is displayed and the launch stops. <br>  The ‚ÄúGRUB LOADING ..‚Äù problem is related to 2 factors that should be considered when installing a proxmox: <br><ol><li>  The hard disk on which the OS is installed should always be first at startup (unfortunately, the corresponding setting of the boot order option in the BIOS does not give the desired result, a paradox, but you need to find the desired sata0 port and load the system in the correct configuration) </li><li>  the drive must always be connected (without a drive we will observe ‚ÄúGRUB LOADING ..‚Äù, obviously, the drive device appears in the startup scripts) </li></ol><br><h5>  The second moment: Setting up the network in an openvz container (proxmox) or activating an interface like bridge </h5><br>  After creating a container in the web interface, there is a problem with setting up the network.  When configuring, it is possible to specify an ip address, but this will be virtual NAT, i.e.  Access to the container is possible with vhost, but not from the entire network.  In order for the container to be accessible from the entire network, you need to configure ethernet (eth0).  At the installation stage, eth0 can also be configured, but the ip address will not be assigned.  And in the eth0 container itself is missing (ifconfig command does not show it).  This is where the problem arises: how to configure the bridge interface. <br>  According to the materials on setting up networks <a href="http://wiki.openvz.org/Using_private_IPs_for_Hardware_Nodes">OpenVZ</a> , you must do the following: enter the container ("100" - container id) <br> <code>vzctr enter 100</code> <br>  define the interface eth0 in the container system (without this step, the next step will be valid until the container is reloaded) <br> <code>ifconfig eth0 0</code> <br>  then configure the eth0 interface <br><pre>  ifconfig eth0 192.168.XXX.XXX netmask 255.255.255.0
 ip route add 192.168.XXX.YYY dev eth0
 ip route add default via 192.168.XXX.YYY
</pre><br>  or constantly add to / etc / network / interfaces <br><pre>  auto eth0
 iface eth0 inet static
		 address 192.168.XXX.XXX
		 netmask 255.255.255.0
		 gateway 192.168.XXX.YYY
</pre><br><h5>  The third moment: Import VMWare virtual machines to KVM Proxmox </h5><br><ol><li>  Import freebsd.vmdk <br>  Before importing an existing VMWare virtual machine with FreeBSD, you need to create a prototype of it on Proxmox KVM with the same parameters, choosing the ‚Äúvmdk‚Äù disk format, type IDE.  After creating the prototype, copy the ‚Äúfreebsd.vmdk‚Äù disk to / var / lib / vz / images / id /, rename it (giving the name of the created disk) and start the virtual machine.  If the download ends with a root partition search, then we load the frenzy disk into the drive of the machine and repeat the launch from live-cd in hdrw mode (write to disk).  We look at the mounted df -h slices, we find the disk marking (ad or da), we edit the / etc / fstab file, changing the disk marking to the one obtained in the previous command.  After successful loading of OS it will be necessary to edit and the network interface. </li><li>  Import windows.vmdk <br>  You must first load the imported VMWare virtual machine into your native software, then add the IDE drivers information to the registry in the loaded machine, copy pciide.sys to% SystemRoot% System32 / Drivers.  Uninstall from VMWare Tools virtual system, unmount virtual machine and copy vmdk virtual disk file to Proxmox (KVM).  Load a virtual system with an imported disk (IDE type). </li></ol><br><h5>  The fourth moment: Compress VMDK virtual disks in Proxmox </h5><br>  The compression procedure for vmdk drives, in my opinion, is very important because  The amount of physical disk is always limited. <br><ol><li>  Compress WINDOWS.vmdk <br>  Compressing virtual disks is associated with the effect of ‚Äúinflating‚Äù the vmdk file (increasing the file size) when the guest virtual system is running.  To compress a virtual disk format VMDK with MS Windows OS, you can use a pair of utilities from VMWare: vmware-mount and vmware-vmdiskmanager - as part of the VDDK package, you can download from the <a href="https://www.vmware.com/support/developer/vddk/">office.</a>  <a href="https://www.vmware.com/support/developer/vddk/">site</a> .  Since  Proxmox works on Debian, then we download the linux64 archive and install it: <br> <code>tar -xzf VMware-vix-disklib-5.1.0-774844.x86_64.tar.gz</code> <br> <code>cd ./vmware-vix-disklib-distrib</code> <br> <code>./vmware-install.pl</code> <br>  After installation, you need to add a line to /etc/ld.so.conf: <br> <code>/usr/lib/vmware-vix-disklib/lib64 <br></code> <br>  Further utilities are ready to work with disks.  Turn off the guest virtual system, the disk of which will be subject to compression.  The vmdk disk compression procedure consists of three phases: <br><ul><li>  vmdk disk defragmentation <br> <code>vmware-vdiskmanager -d /path/to/name.vmdk</code> </li> <li>  disk compression preparation <br> <code>vmware-mount /path/to/name.vmdk /mnt/vmdk/</code> <br>  If during the mount, an error occurs about an unknown NTFS file system, you must load the support for this system into Debian: <br> <code>apt-get install ntfs-3g</code> <br> <code>vmware-vdiskmanager -p /mnt/vmdk/</code> </li> <li>  disk compression <br> <code>vmware-mount -x #  vmdk </code> <br> <code>losetup -d /dev/loop0 #       : "device is busy"</code> <br> <code>vmware-mount -x #   </code> <br> <code>vmware-vdiskmanager -k /path/to/name.vmdk #   </code> <br> </li></ul><br>  The effect of vmdk disk compression is to the true size of the disk in the guest virtual system. <br></li><li>  Compress FREEBSD.vmdk <br>  For compressing a virtual disk with FREEBSD, the above utilities will not work, because  There is a problem mounting a vmdk disk to the host system: Debian does not know the UFS file system.  However, there is a solution, you can use the built-in features of FreeBSD: create dumps of the file system of the original guest OS and restore them to a newly created virtual disk, and then swap the disks - the procedure of <a href="http://www.lissyara.su/articles/freebsd/trivia/move_system_between_hard_drives/">transferring freeBSD to a new hdd</a> . <br></li></ol><br><h5>  The fifth moment: Restore the virtual guest system in Proxmox via the console </h5><br>  The procedure for restoring a virtual guest system in Proxmox through a web interface is well known, however, it‚Äôs not clear how this happens in the console.  Guest systems (KVM talk) are backed up to the file vzdump-qemu-id-date-time.vma.gz.  This is an archive of a pre-packaged virtual disk and a guest OS configuration file. <br>  It is logical to first get the file .vma: <br> <code>gzip -d vzdump-qemu-103-date-time.vma.gz</code> <br>  where 103 is the guest number in Proxmox <br>  Next, you need to locate the file vzdump-qemu-103-date-time.vma.  For this, in Proxmox 3.1 there is a special utility vma <br> <code>vma extract vzdump-qemu-103-date-time.vma /var/103</code> <br>  Note: the command will work without errors, unless you create the directory ‚Äú103‚Äù in the / var directory.  As a result, there will be a couple of files in / var / 103 /: <br> <code>vm-103-disk-1.raw</code> <br> <code>qemu-server.conf</code> <br>  Note: if we restored the guest system with a vmdk disk, then the recovered disk will be in raw format.  You can fix this by converting to the required format: <br> <code>qemu-img -f raw -O vmdk vm-103-disk-1.raw vm-103-disk-1.vmdk</code> <br> <br><h5>  The moment of the sixth: Proper shutdown of guest Windows on Proxmox (KVM) </h5><br>  "Proper OS Shutdown" for Proxmox (KVM) guest systems means simulating the event of "pressing the system off button on a physical machine."  Such shutdown works correctly in unix-systems.  This is achieved by a command in QEMU: <br> <code>qm shutdown 103</code> <br>  However, in guest Windows systems in the background, the command returns an error and the system does not shut down.  Disconnection occurs ‚Äúcorrectly‚Äù only in case of successful login to the system, or ‚Äúforcibly‚Äù (event ‚Äúdisconnecting the power cord‚Äù) - by another command (qm stop 103).  It is possible to correct this situation by adjusting the local guest Windows OS policy: <br>  Start - Control Panel - Administration - Local Security Policy - Security Settings - Local Policies - Security Settings - Shut Down: Allow the system to shutdown without logging in (‚ÄúEnable‚Äù) <br></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/215367/">https://habr.com/ru/post/215367/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../215353/index.html">We collect the pocket laser</a></li>
<li><a href="../215355/index.html">Search for odd performance reasons</a></li>
<li><a href="../215357/index.html">BitSorting Algorithm with complexity O (n)</a></li>
<li><a href="../215361/index.html">Turn Zalman into Noctua (or fan upgrade)</a></li>
<li><a href="../215363/index.html">Automation of system integration testing</a></li>
<li><a href="../215369/index.html">TFS Build Sequences</a></li>
<li><a href="../215371/index.html">Pitfalls of technology company</a></li>
<li><a href="../215373/index.html">Make life easier</a></li>
<li><a href="../215375/index.html">StarCraft disassembled and launched on ARM</a></li>
<li><a href="../215381/index.html">How to take back music and video from VC using Chrome browser using its extension</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>