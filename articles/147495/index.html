<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We send Nagios notifications to Skype chat</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So, once the thought occurred to me that it would be great to receive notifications from Nagios on skype. 
 In short: use Skype4Py, send notifications...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We send Nagios notifications to Skype chat</h1><div class="post__text post__text-html js-mediator-article">  So, once the thought occurred to me that it would be great to receive notifications from Nagios on skype. <br>  In short: use Skype4Py, send notifications with a script. <br>  Bold minus: skype does not work without X. <br>  Plus: reduced reaction time to problems. <br><br>  Interesting?  Details under the cut. <br><a name="habracut"></a><br>  Googling revealed only one similar option of sending notifications to Skype, but for <a href="http://www.qxs.ch/2011/01/07/skype-instant-messages-from-zabbix/">Zabbix</a> . <br>  Thanks to the author, convinced that the idea is feasible! <br><br>  So, further operations were performed under Gentoo, but it should be quite easily reproduced for other distributions. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We will need a whole set of packages: <br>  - X <br><blockquote><code># emerge x11-apps/xdm x11-apps/xsm x11-base/xorg-drivers x11-base/xorg-server x11-base/xorg-x11 -pv <br></code> </blockquote><br>  - skype and Skype4Py, which allows you to send messages <br><blockquote> <code># emerge skype skype4py -pv <br></code> </blockquote><br>  When installing skype, you will be prompted to accept the license, for this you need to add it in ACCEPT_LICENSE in make.conf. <br>  In addition, if the system is 64-bit, you can make sure that the kernel has the option CONFIG_IA32_EMULATION = y, which allows you to run 32-bit applications, otherwise, 32-bit Skype will not start. <br>  I also needed to rebuild udev with X support: <br><blockquote> <code>USE="X" emerge udev -pv <br></code> </blockquote><br>  While everything is compiled, you can read Habr, go on vacation, build a house, plant a tree, raise a son ... <br><br>  Hooray!  We are halfway there. <br>  Now the fun part. <br><br>  We register an account for our nagios: <a href="http://www.skype.com/go/join%3Fintcmp%3Djoin">here</a> . <br><br>  The most convenient option is to set up a skype account on a separate host (for example, on your laptop), and then copy ~ / .Skype / to the server in the nagios user's home folder. <br>  What is useful to do: <br>  - enable automatic user login when skype is started; <br>  - disable all pop-up and sound notifications about events; <br>  - add our user to the chat, where we plan to continue to write "letters of happiness." <br><br>  In addition, you must authorize Skype4Py, allowing him to perform actions on behalf of our user.  For this <br>  1) run python2.7; <br>  2) connect to the already working Skype, with a logged in user nagiosa <br><blockquote> <code>&gt;&gt;&gt; import Skype4Py &lt;br&gt;</code> <br> <code>&gt;&gt;&gt; import sys &lt;br&gt;</code> <br> <code>&gt;&gt;&gt; skype = Skype4Py.Skype(Transport='x11')</code> <br> <code>&gt;&gt;&gt; skype.Attach()</code> <br> </blockquote><br>  We confirm in the appeared window that we allow Skype4Py to connect, put a tick so that they no longer ask; <br>  3) the first chat, in which we were added, is visible as skype.Chats [0] - we will write something: <br><blockquote> <code>&gt;&gt;&gt; msg = "Ololo"</code> <br> <code>&gt;&gt;&gt; skype.Chats[0].SendMessage(msg)</code> <br> </blockquote><br>  Has come  Ok, so you can move on. <br><br>  By the way, the <a href="http://skype4py.sourceforge.net/doc/html/">Skype4Py</a> documentation can inspire a much wider range of actions than just sending a chat message. <br><br>  Turn off Skype, copy ~ / .Skype / to the target server with nagios in the home folder of the user nagios. <br><br>  Note: these actions can be done immediately on the right server by running x11vnc once, then you need to install x11vnc, xterm, twm, as the easiest option.  The result will not change, but I don‚Äôt want to install extra applications initially. <br><br>  Check what we are on the target server: <br><blockquote> <code># su - nagios</code> <br> <code>$ export DISPLAY=:0</code> <br> <code>$ Xvfb :0 -screen 0 800x600x16 &amp;</code> <br> <code>$ skype &amp;</code> <br> </blockquote><br>  If there are no errors in the output, everything is in order.  We check if Xvfb and skype are dead - we are looking for them in the processes. <br>  Then we try to connect and send something. <br>  If you could not connect (Connection refused) and the account is not online - then autologin was disabled, you need to turn it on and copy ~ / .Skype / to the server with nagios again. <br><br>  So, there is a working Skype, through which we can send messages.  Teach this nagios. <br>  Create in the home folder (for example, / var / nagios / home /) 2 files: <br><blockquote>  alert.sh: <br> <code>#!/bin/bash</code> <br> <code>export DISPLAY=:0</code> <br> <code>/usr/bin/python2.7 /var/nagios/home/alert.py "$*"</code> <br> </blockquote><br>  and <br><blockquote>  alert.py: <br> <code>#!/usr/bin/python2.7</code> <br> <code>import Skype4Py</code> <br> <code>import sys</code> <br> <code>skype = Skype4Py.Skype(Transport='x11')</code> <br> <code>skype.Attach()</code> <br> <code>msg=' '.join(sys.argv[1:])</code> <br> <code>skype.Chats[0].SendMessage(msg)</code> <br> </blockquote><br>  Do not forget to make the shell script executable (chmod + x alert.sh) and go to the nagios customization. <br>  Add a contact to /etc/nagios/contacts.cfg: <br><blockquote> <code>define contact{</code> <br> <code>contact_name skype</code> <br> <code>alias Skype</code> <br> <code>use generic-contact</code> <br> <code>service_notification_commands notify-service-by-skype</code> <br> <code>host_notification_commands notify-host-by-skype</code> <br> <code>}</code> <br> </blockquote><br>  We add our contact to the admins group or any other that receives notifications of problems from nagios. <br><br>  And decrypt the notify - * - by-skype commands in /etc/nagios/objects/commands.cfg <br><blockquote> <code># 'notify-host-by-skype'</code> <br> <code>define command{</code> <br> <code>command_name notify-host-by-skype</code> <br> <code>command_line /var/nagios/home/alert.sh "$NOTIFICATIONTYPE$ Host: $HOSTNAME$ State: $HOSTSTATE$ Info: $HOSTOUTPUT$"</code> <br> <code>}</code> <br> <br> <code># 'notify-service-by-skype'</code> <br> <code>define command{</code> <br> <code>command_name notify-service-by-skype</code> <br> <code>command_line /var/nagios/home/alert.sh "$NOTIFICATIONTYPE$ Host: $HOSTNAME$ Service: $SERVICEDESC$ Info: $SERVICEOUTPUT$"</code> <br> <code>}</code> <br> </blockquote><br>  Please note that you can display any necessary information, for example, you can add a variable with a description of the host. <br>  Do not forget to re-read the nagios config (/etc/init.d/nagios reload) and admire the results! <br><br><h6>  Useful links: </h6><br>  1. Nagios documentation: <a href="http://www.nagios.org/documentation">www.nagios.org/documentation</a> <br>  2. Skype4Py documentation: <a href="http://skype4py.sourceforge.net/doc/html/">skype4py.sourceforge.net/doc/html</a> </div><p>Source: <a href="https://habr.com/ru/post/147495/">https://habr.com/ru/post/147495/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147490/index.html">Negotiating Instructions</a></li>
<li><a href="../147491/index.html">Unit testing of models in Yii</a></li>
<li><a href="../147492/index.html">Space Snake in the Store or How We Put the ‚ÄúCheeseShop‚Äù</a></li>
<li><a href="../147493/index.html">Fulfillment - a catalyst for the growth of regional online sales</a></li>
<li><a href="../147494/index.html">Radio project about SaaS-services (20 gears) + Megaplan mini-series</a></li>
<li><a href="../147496/index.html">We invite to August 2 in Kiev for a free seminar on ITIL</a></li>
<li><a href="../147500/index.html">Intel Pair & Share: the communicator is turning ...</a></li>
<li><a href="../147501/index.html">Joel Spolsky: manufacturing inventories in software development</a></li>
<li><a href="../147503/index.html">FProg 2012-07 meeting in St. Petersburg</a></li>
<li><a href="../147504/index.html">Should I write my Framework / CMS if you already have it?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>