<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Corporate VPN with ACCEL-PPP + IPsec and authorization with Freeradius via AD</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this post I want to show an example of a quick implementation of a corporate VPN server with support for PPTP, L2TP (with and without IPsec), IPSec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Corporate VPN with ACCEL-PPP + IPsec and authorization with Freeradius via AD</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/e83/37e/d75/e8337ed75b7247bdae0d3f4f0b4b0497.jpg"><br>  In this post I want to show an example of a quick implementation of a corporate VPN server with support for PPTP, L2TP (with and without IPsec), IPSec vpn with a single database that can work with address pools, different groups of users, authorize users from both LDAP and and from the local database, the optional configuration of shaping for groups, as well as for individual users with support for windows, linux, osx, ios, android clients, and all this on open solutions. <br>  PS In this article, aspects of network security will not be touched upon, otherwise it will grow into a huge document, with a bunch of nuances in implementation, maybe I will tell you about the perimeter protection and network security next time. <br>  Who cares, welcome under cat. <br><a name="habracut"></a><br>  <b>Table of contents:</b> <br>  <u>Introduction</u> <br>  <a href="https://habr.com/ru/post/267103/">Preparatory work on the server</a> <br>  <a href="https://habr.com/ru/post/267103/">Accel-PPP (PPTP, L2TP)</a> <br>  <a href="https://habr.com/ru/post/267103/">Strongswan (IPsec)</a> <br>  <a href="https://habr.com/ru/post/267103/">Freeradius</a> <br>  <a href="https://habr.com/ru/post/267103/">Samba 4</a> <br><br>  As a result, we plan to get something like this: <br><img src="https://habrastorage.org/files/749/a7c/8ce/749a7c8ce75244a09db1e7f92ee7a012.png"><br>  The network has mobile clients, office clients and a secure network with important services, which should only be accessible via VPN, while office clients and mobile clients should receive different subnets from the VPN and have different rights to access resources, something common - only for one or the other, there are also administrators in the network, who should have full access to the company's internal infrastructure, both working from office and away, this scheme does not cover the internal office network with its servers available to the office users.  to local users, and to mobile clients via VPN. <br>  Start setting up the server. <br><a name="text0"></a><br><h4>  0) Preparatory work. </h4><br><img src="https://habrastorage.org/files/5d7/cac/cdb/5d7caccdb7464f2dad555eded122291b.jpg"><br>  Before proceeding directly to setting up a VPN, let's do some preparatory work. <br>  And so we have a freshly installed server with Debian 7 (it doesn't matter, it will work in the same way on any other linux) in a minimal configuration.  Login to it via ssh or in the local console, then: <br>  We set the correct time zone (in the example I put MSK) <br><pre><code class="bash hljs">mv /etc/localtime /etc/localtime_org &amp;&amp; ln -s /usr/share/zoneinfo/<span class="hljs-string"><span class="hljs-string">"Europe/Moscow"</span></span> /etc/localtime &amp;&amp; date</code> </pre> <br>  Disable IPv6 if you do not plan to use it on this server. <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> net.ipv6.conf.all.disable_ipv6=1 &gt; /etc/sysctl.d/disableipv6.conf</code> </pre><br>  We include backports in turnips (so as not to put ancient samba and strongswan in which there are a number of problems), for this we add the following lines to <b>/etc/apt/sources.list</b> : <br><pre> <code class="bash hljs">deb http://http.debian.net/debian wheezy-backports main contrib non-free deb http://mirror.yandex.ru/debian/ wheezy-backports main contrib non-free</code> </pre><br>  Install the minimum required packages at this stage. <br><pre> <code class="bash hljs">apt-get update apt-get install cmake make libssl-dev libpcre3-dev libnet-snmp-perl libtritonus-bin bzip2 checkinstall ntpdate</code> </pre><br>  Synchronize the time on the server, it is better to immediately with the domain clock, the easiest option through <br><pre> <code class="bash hljs">ntpdate DC.DOMAIN.COM</code> </pre><br>  Specify the domain DNS server in /etc/resolv.conf <br>  <b>The firewall settings are specific to the company and are not published here, but based on it, we associate different subnets of VPN clients with different bans and permissions.</b> <br><br>  Here and below <br>  <b>XX.UY.1.99 - external IP of your server.</b> <br><a name="text1"></a><br><h4>  1) Accel-PPP - the main service for working with L2TP and PPTP </h4><br><img src="https://habrastorage.org/files/7ac/8cb/4b6/7ac8cb4b65f54c338166e25bef36d6ae.jpg"><br><div class="spoiler">  <b class="spoiler_title">Description from the project site</b> <div class="spoiler_text">  ACCEL-PPP is a high-performance VPN / IPoE server for linux. <br>  Its advantage over other solutions is the integration of various popular VPN technologies into a single application. <br>  There are many open solutions for organizing VPN services, but they are all focused on one type of VPN: only PPTP, only PPPOE, only L2TP. <br>  If you want to start a multiservice VPN server, you must study and configure each application separately. <br>  With ACCEL-PPP, you get one application that supports everything, with a single configuration file, unified management and monitoring. <br>  ... <br>  The project can be found in more detail <a href="https://accel-ppp.org/">here</a> . <br></div></div><br>  <i>This VPN is very dimly lit, there are no references to Habr√©, more or less discussions revolve on one <a href="http://forum.nag.ru/forum/index.php%3Fshowtopic%3D45266">branch of the Naga</a> , although by the convenience of operation, stability of work and opportunities it bypasses more popular solutions, but let's finish with the lyrics and get started.</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Download and throw on the server. <br><pre> <code class="bash hljs">http://downloads.sourceforge.net/project/accel-ppp/accel-ppp-1.9.0.tar.bz2</code> </pre><br>  unzip <br><pre> <code class="bash hljs">tar -xjf accel-ppp-1.9.0.tar.bz2 mkdir accel-ppp-build <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> accel-ppp-build</code> </pre><br>  we collect <br><pre> <code class="bash hljs">cmake -DBUILD_PPTP_DRIVER=FALSE -DLOG_PGSQL=FALSE -DNETSNMP=FALSE -DRADIUS=TRUE -DSHAPER=TRUE /root/accel-ppp-1.9.0/ make checkinstall -D</code> </pre><br>  Create an autorun script from the example. <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../accel-ppp-1.9.0/contrib/debian cp accel-ppp-init /etc/init.d/accel-ppp</code> </pre><br>  Determine the directory with the demon <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">which</span></span> accel-pppd</code> </pre><br>  Most likely for deb will be <b>/ usr / local / sbin / accel-pppd</b> <br>  In the start file, change the path to the one obtained above. <br><pre> <code class="bash hljs">nano /etc/init.d/accel-ppp</code> </pre><br>  Add to autostart <br><pre> <code class="bash hljs">insserv -v accel-ppp</code> </pre><br>  Create a directory for logs <br> <code>mkdir /var/log/accel-ppp/ <br></code> <br>  Create a file with access to check connections, <u>then replace it with radius authorization</u> <br><pre> <code class="bash hljs">touch /etc/ppp/chap-secrets</code> </pre><br>  Format: <br>  <b>login * password ip</b> _ for issue (if you need to take from the pool, then just *) <br><br>  Create a configuration file <b>/etc/accel-ppp.conf</b> <br><div class="spoiler">  <b class="spoiler_title">Content</b> <div class="spoiler_text">  * tried to comment as much as possible on the options, uncomment <b>chap-secrets</b> during the test and comment out the <b>radius</b> in the <b>modules</b> section <br><pre> <code class="bash hljs">[modules] path=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/lib64/accel-ppp <span class="hljs-comment"><span class="hljs-comment">#        . log_file #     syslog. #log_syslog #  pptp l2tp #  auth_mschap_v2 auth_mschap_v1 auth_chap auth_pap #   CHAP-secrets   radius #chap-secrets #   RADIUS   chap-secrets radius # IPv4    . ippool sigchld #    ip-up/ip-down      RADIUS CoA . #pppd_compat #   . shaper #   . #connlimit [core] log-error=/var/log/accel-ppp/core.log thread-count=4 [ppp] verbose=0 min-mtu=1280 mtu=1480 mru=1480 #ccp=1 check-ip=1 #           . #    replace - accel-   ,    . #    deny accel-       #single-session=replace #   MPPE (Microsoft Point-to-Point Encryption) # prefer ‚Äì        mppe=prefer ipv4=prefer #   ,   0,  PPP    LCP  -  n . lcp-echo-interval=300 #   -  ,    n   . lcp-echo-failure=6 [dns] dns1=8.8.8.8 dns2=8.8.4.4 [auth] #any-login=0 #noauth=0 [pptp] bind=..1.99 echo-interval=300 echo-failure=6 verbose=0 [l2tp] bind=..1.99 #ppp-max-mtu=1300 dictionary=/usr/local/share/accel-ppp/l2tp/dictionary hello-interval=300 #timeout=60 #rtimeout=5 retransmit=3 host-name=vpn.mydomain.ru #dir300_quirk=1 #secret= verbose=0 [radius] dictionary=/usr/local/share/accel-ppp/radius/dictionary nas-identifier=cisco nas-ip-address=127.0.0.1 gw-ip-address=..1.99 auth-server=127.0.0.1:1812,Radius-Sicret acct-server=127.0.0.1:1813,Radius-Sicret server=127.0.0.1,Radius-Sicret,auth-port=1812,acct-port=1813,req-limit=0,fail-time=0 dae-server=127.0.0.1:3799,Radius-Sicret timeout=5 max-try=3 acct-timeout=600 acct-delay-time=1 verbose=0 [shaper] attr=Filter-Id #down-burst-factor=1.0 #up-burst-factor=1.0 #latency=50 #mpu=0 #time-range=1,7:00-00:59 #time-range=2,1:00-3:59 #time-range=3,4:00-6:59 #leaf-qdisc=sfq perturb 10 up-limiter=htb down-limiter=htb cburst=1375000 ifb=ifb0 r2q=10 quantum=1500 verbose=0 #   IP-,         : xxxx/mask (for example 10.0.0.0/8) [client-ip-range] #192.168.0.0/18 disable [log] log-file=/var/log/accel-ppp/accel-ppp.log log-emerg=/var/log/accel-ppp/emerg.log log-fail-file=/var/log/accel-ppp/auth-fail.log log-debug=/var/log/accel-ppp/debug.log #syslog=accel-pppd,daemon #log-tcp=127.0.0.1:3000 copy=1 color=1 #per-user-dir=per_user #per-session-dir=per_session #per-session=1 level=0 #    ,     #[chap-secrets] #gw-ip-address=..1.99 #chap-secrets=/etc/ppp/chap-secrets [ip-pool] attr=Framed-Pool gw-ip-address=..1.99 10.65.16.129-254,fullaccess 10.65.17.129-254,mobila 10.65.18.129-254,office [cli] telnet=127.0.0.1:2000 tcp=127.0.0.1:2001 #password=123 #[connlimit] #limit=10/min #burst=3 #timeout=60</span></span></code> </pre><br></div></div><br><br>  Run <br><pre> <code class="bash hljs">service accel-ppp start</code> </pre><br>  If something is wrong, we increase the logging level in the config and look at the logs. <br><br>  To work under load, a small tuning is needed, if you have less than 500 simultaneous clients on a VPN, you can not do it, except for the item <b>net.ipv4.ip_forward = 1</b> , it is mandatory. <br><br><div class="spoiler">  <b class="spoiler_title">Add to /etc/sysctl.conf</b> <div class="spoiler_text">  ############################ <br>  net.ipv4.ip_forward = 1 <br>  net.ipv4.neigh.default.gc_thresh1 = 1024 <br>  net.ipv4.neigh.default.gc_thresh2 = 2048 <br>  net.ipv4.neigh.default.gc_thresh3 = 4096 <br><br>  net.ipv4.netfilter.ip_conntrack_max = 9548576 <br>  net.netfilter.nf_conntrack_max = 9548576 <br><br>  # turn select selective ACK and timestamps <br>  net.ipv4.tcp_sack = 0 <br>  net.ipv4.tcp_timestamps = 0 <br><br>  # memory allocation min / pressure / max. <br>  # read buffer, write buffer, and buffer space <br>  net.ipv4.tcp_rmem = 10,000,000 10,000,000 10,000,000 <br>  net.ipv4.tcp_wmem = 10,000,000 10,000,000 10,000,000 <br>  net.ipv4.tcp_mem = 10,000,000 10,000,000 10,000,000 <br><br>  net.core.rmem_max = 524287 <br>  net.core.wmem_max = 524287 <br>  net.core.rmem_default = 524287 <br>  net.core.wmem_default = 524287 <br>  net.core.optmem_max = 524287 <br>  net.core.netdev_max_backlog = 300000 <br>  net.core.netdev_tstamp_prequeue = 0 <br>  ############################ <br></div></div><br>  Apply: <br><pre> <code class="bash hljs">sysctl -p</code> </pre><br>  We try to connect with PPTP and L2TP without IPsec with the login and password specified in <b>/ etc / ppp / chap-secrets</b> <br><br>  On the server itself, you can view a list of connected clients <br><pre> <code class="bash hljs">accel-cmd show session</code> </pre><br>  I highly recommend reading the <b>accel-cmd</b> help, it has many features, including changing the user authorization method on the fly without interrupting sessions <br><br>  If everything is OK, go to the next item. <br><a name="text2"></a><br><h4>  2) IPsec </h4><br><img src="https://habrastorage.org/files/00f/614/d38/00f614d38492491fbcfd389395644110.jpg"><br>  You can get acquainted with what it is and why you need it briefly <a href="http://xgu.ru/wiki/IPsec">here.</a> <br><br>  install <br><pre> <code class="bash hljs">apt-get -t wheezy-backports install strongswan libcharon-extra-plugins</code> </pre><br>  Configs are reduced to the form: <br>  <b>nano /etc/ipsec.conf</b> <br><div class="spoiler">  <b class="spoiler_title">ipsec.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ipsec.conf - strongSwan IPsec configuration file config setup #           strictcrlpolicy=no include /var/lib/strongswan/ipsec.conf.inc conn %default ikelifetime=1440m keylife=60m rekeymargin=3m keyingtries=1 keyexchange=ikev1 authby=xauthpsk #   Dead Peer Detection (DPD)  ,     ,       dpdaction=clear #    DPD # dpddelay=35s #   DPD # dpdtimeout=300s #   .   IPsec  ,    IP-  fragmentation=yes #       . Windows   . rekey=no #  ciphersuites    IKE ike=aes256gcm16-aes256gcm12-aes128gcm16-aes128gcm12-aesxcbc-sha256-sha1-modp4096-modp2048-modp1024,aes256-aes128-sha256-sha1-modp4096-modp2048-modp1024! #  ciphersuites    esp=aes128gcm12-aes128gcm16-aes256gcm12-aes256gcm16-modp4096-modp2048-modp1024,aes128-aes256-sha1-sha256-modp4096-modp2048-modp1024,aes128-sha1-modp1024,aes128-sha1! conn L2TP_Accel-PPP authby=psk rekey=no type=transport esp=aes128-sha1,null-sha1,md5 ike=aes128-sha-modp1024,null-sha1,md5 left=194.135.1.99 leftprotoport=17/%any #  1701    iOS right=%any rightprotoport=17/%any rightsubnetwithin=0.0.0.0/0 auto=add compress=no dpddelay=30 dpdtimeout=120 dpdaction=clear forceencaps=yes conn IPsec authby=secret rekeymargin=3m keyingtries=1 keyexchange=ikev1 leftfirewall=yes rekey=no left=XX.YY.1.99 leftsubnet=0.0.0.0/0 leftauth=psk rightsourceip=%radius rightdns=8.8.8.8 right=%any rightauth=psk rightauth2=xauth-radius dpdaction=clear dpdtimeout = 5s auto=add</span></span></code> </pre><br></div></div><br><br>  Next, we indicate our private key <br>  <b>nano /etc/ipsec.secrets</b> <br> <code>: PSK "Sicret-Test-Key" <br></code> <br>  For further integration with Freeradius we also rule <br>  <b>nano /etc/strongswan.d/charon/eap-radius.conf</b> <br><div class="spoiler">  <b class="spoiler_title">eap-radius.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">eap-radius { accounting = yes load = yes nas_identifier = StrongSwan <span class="hljs-comment"><span class="hljs-comment">#   Radius secret = Radius-Sicret server = 127.0.0.1 dae { enable = yes listen = 127.0.0.1 port = 3799 secret = Radius-Sicret } forward { } servers { } xauth { } }</span></span></code> </pre><br></div></div><br>  Run <br><pre> <code class="bash hljs">service ipsec start</code> </pre><br>  Status can be viewed as: <br><pre> <code class="bash hljs">ipsec statusall</code> </pre><br><a name="text3"></a><br><h4>  3) FreeRadius </h4><br><img src="https://habrastorage.org/files/879/a31/b84/879a31b84e90411eacfaf5a2b69c4436.png"><br>  <a href="https://ru.wikipedia.org/wiki/FreeRADIUS">* for those who do not know what it is.</a> <br>  Install as standard <br><pre> <code class="bash hljs">apt-get install freeradius freeradius-ldap</code> </pre><br>  The correct file is <b>/etc/freeradius/clients.conf</b> , which contains settings for FreeRadius users, we have local Accel-PPP and Strongswan demons, the following content is minimal: <br><pre> <code class="bash hljs">client localhost { ipaddr = 127.0.0.1 secret = Radius-Sicret nastype = cisco shortname = MY_TEST_VPN }</code> </pre><br>  Now we will prepare a profile for launch, the standard one is here <b>/ etc / freeradius / sites-enabled / default</b> <b><br></b>  , we need to bring it to mind: <br><div class="spoiler">  <b class="spoiler_title">/ etc / freeradius / sites-enabled / default</b> <div class="spoiler_text">  * LDAP integration is not configured yet. It is necessary to comment out all options related to ldap and ntlm_auth, later we will uncomment one of them, but not both, they conflict, if we don‚Äôt need LDAP groups, it‚Äôs easier to use ntlm_auth, if groups are needed, then ldap, In the example, the working config is already with groups <br><pre> <code class="bash hljs">authorize { preprocess chap mschap ldap <span class="hljs-comment"><span class="hljs-comment"># ntlm_auth digest suffix eap { ok = return } files expiration logintime pap } authenticate { Auth-Type PAP { pap } Auth-Type CHAP { chap } Auth-Type MS-CHAP { mschap } Auth-Type LDAP { ldap } # Auth-Type ntlm_auth { # ntlm_auth # } digest unix eap } preacct { preprocess acct_unique suffix files } accounting { detail unix radutmp exec attr_filter.accounting_response } session { radutmp } post-auth { exec Post-Auth-Type REJECT { attr_filter.access_reject } } pre-proxy { } post-proxy { eap }</span></span></code> </pre><br></div></div><br>  Now we will create a local user file, as well as a description of settings for various groups from LDAP <br><div class="spoiler">  <b class="spoiler_title">/ etc / freeradius / users</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#      ,    , #       #perl -e 'print(crypt("testpassword","abrakadabra")."\n");' #    #testuser Crypt-Password := "abA5hjwYqm1.I" testuser Cleartext-Password := "testpassword" , MS-CHAP-Use-NTLM-Auth := 0 Service-Type = Framed-User, Framed-Protocol = PPP, #     IP,      ,   Framed-Pool Framed-IP-Address = 10.65.18.12, Framed-IP-Netmask = 255.255.255.255, #       ,    ip-pool  accel-ppp Framed-Pool = "office", #      . Filter-Id = "100000/100000", #         ,    Reply-Message = "Accepted from local file" #        #   Idle-Timeout, Acct-Interim-Interval  .. #      LDAP,     # remote-connection   office,    ip-pool  accel-ppp DEFAULT Ldap-Group == "remote-connection" Service-Type = Framed-User, Framed-Protocol = PPP, Framed-Pool = "office", Filter-Id = "100000/100000" #     DEFAULT Ldap-Group == "full-access" Service-Type = Framed-User, Framed-Protocol = PPP, Framed-Pool = "fullaccess" #       # Filter-Id = "100000/100000" DEFAULT Ldap-Group == "mobile-access" Service-Type = Framed-User, Framed-Protocol = PPP, Framed-Pool = "mobila", Filter-Id = "100000/100000"</span></span></code> </pre><br></div></div><br>  Restart radius <br><pre> <code class="bash hljs">service freeradius restart</code> </pre><br>  * For debugging, you can run in the output mode of the log to the <b>freeradius-X</b> terminal <br>  If everything is OK and there are no errors in the launch, check the test user: <br><pre> <code class="bash hljs">radtest testuser testpassword 127.0.0.1 0 Radius-Sicret</code> </pre><br>  we should get an answer like: <br><pre> <code class="bash hljs">Sending Access-Request of id 238 to 127.0.0.1 port 1812 User-Name = <span class="hljs-string"><span class="hljs-string">"testuser"</span></span> User-Password = <span class="hljs-string"><span class="hljs-string">"testpassword"</span></span> NAS-IP-Address = XX.YY.1.99 NAS-Port = 0 Message-Authenticator = 0x00000000000000000000000000000000 rad_recv: Access-Accept packet from host 127.0.0.1 port 1812, id=238, length=105 Service-Type = Framed-User Framed-Protocol = PPP Framed-IP-Address = 10.65.18.12 Framed-IP-Netmask = 255.255.255.255 Framed-Pool = <span class="hljs-string"><span class="hljs-string">"office"</span></span> Filter-Id = <span class="hljs-string"><span class="hljs-string">"100000/100000"</span></span> Reply-Message = <span class="hljs-string"><span class="hljs-string">"Accepted from local file"</span></span></code> </pre><br>  If the answer is an <b>Access-Accept</b> , then everything is fine and you can proceed to setting up the integration of Freeradius with LDAP, put the configs in this section in advance, we need to correct: <br>  <b>nano / etc / freeradius / modules / ntlm_auth</b> <br>  * instead of KR.LOC just specify your domain <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> ntlm_auth { <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span> = yes program = <span class="hljs-string"><span class="hljs-string">"/usr/bin/ntlm_auth --request-nt-key --domain=KR.LOC --username=%{mschap:User-Name} --password=%{User-Password}"</span></span> }</code> </pre><br>  Slightly correct authorization through mschap, since  pap is not safe to use. <br>  <b>nano / etc / freeradius / modules / mschap</b> <br><pre> <code class="bash hljs">mschap { <span class="hljs-comment"><span class="hljs-comment">#  use_mppe = yes #      ,     ,    -   yes require_encryption = no require_strong = yes with_ntdomain_hack = no ntlm_auth = "/usr/bin/ntlm_auth --request-nt-key --username=%{%{Stripped-User-Name}:-%{%{User-Name}:-None}} --challenge=%{%{mschap:Challenge}:-00} --nt-response=%{%{mschap:NT-Response}:-00}" }</span></span></code> </pre><br>  well and most importantly, integration with LDAP directly <br>  <b>nano / etc / freeradius / modules / ldap</b> <br><div class="spoiler">  <b class="spoiler_title">bring to mind</b> <div class="spoiler_text">  * Do not forget to change the parameters of access to ldap to your own, user account must have permissions to read profiles in the domain. <br><pre> <code class="bash hljs">ldap { server = <span class="hljs-string"><span class="hljs-string">"10.13.205.7"</span></span> <span class="hljs-comment"><span class="hljs-comment">#  identity = "sf-test@KR.LOC" #  password = "987654321" #   basedn = "dc=KR,dc=LOC" #   filter = "(sAMAccountName=%{%{Stripped-User-Name}:-%{User-Name}})" ldap_connections_number = 5 max_uses = 0 #port = 389 timeout = 4 timelimit = 3 net_timeout = 1 tls { start_tls = no } dictionary_mapping = ${confdir}/ldap.attrmap password_attribute = userPassword edir_account_policy_check = no groupname_attribute = cn groupmembership_filter = "(|(&amp;(objectClass=GroupOfNames)(member=%{control:Ldap-UserDn}))(&amp;(objectClass=GroupOfUniqueNames)(uniquemember=%{control:Ldap-UserDn})))" groupmembership_attribute = memberOf access_attr_used_for_allow = yes chase_referrals = yes rebind = yes # set_auth_type = yes keepalive { idle = 60 probes = 3 interval = 3 } }</span></span></code> </pre><br></div></div><br>  Another important point is that in order to get the radius attributes for a specific user directly from the domain ldap attributes, you need to adjust their correspondence to each other, this is done in the <b>/etc/freeradius/ldap.attrmap</b> file there is a lot already filled in and intuitively clear, but for example I will show several of their own: <br><pre> <code class="bash hljs">replyItem Framed-IP-Address msRADIUSFramedIPAddress replyItem Framed-Pool msRADIUSFramedRoute</code> </pre><br>  Thus, specifying the personal attribute <b>msRADIUSFramedIPAddress</b> in the domain of the user, we will transfer the radius to consider it as the <b>Framed-IP-Address</b> attribute and give it to the user specifically via VPN, for pools by analogy. <br>  From the domain side, it looks like this: <br><img src="https://habrastorage.org/files/761/c5d/ed6/761c5ded6a1640d386c9be0673cfa5c7.png"><br>  IP needs to be converted to HEX on any <a href="http://www.miniwebtool.com/ip-address-to-hex-converter/">IP calculator</a> , you can of course create any of your attributes for ldap, through the attribute editor, but for an accelerated description we will use the standard ones. <br><br>  * these options will be available after configuring samba4, you need to remember to uncomment the <b>ldap</b> section in <b>/ etc / freeradius / sites-enabled / default</b> <br><a name="text4"></a><br><h4>  4) SAMBA 4 </h4><br><img src="https://habrastorage.org/files/e88/f81/aac/e88f81aace5f41dda3139a68ca878f94.png"><br>  <a href="https://ru.wikipedia.org/wiki/Samba">* brief help</a> <br><br>  First, install everything you need: <br><pre> <code class="bash hljs">apt-get install krb5-user libpam-krb5 samba winbind libnss-winbind libpam-winbind -t wheezy-backports</code> </pre><br>  The samba settings are in the /etc/samba/smb.conf file. <br><div class="spoiler">  <b class="spoiler_title">smb.conf</b> <div class="spoiler_text">  * Do not forget to change the domain name to your own. <br><pre> <code class="bash hljs">[global] obey pam restrictions = Yes <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> file = /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/samba/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>.%m <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> level = 1 socket options = TCP_NODELAY SO_SNDBUF=8192 SO_RCVBUF=8192 encrypt passwords = yes idmap config * : range = 10000-20000 idmap config * : backend = tdb auth methods = winbind name resolve order = hosts bcast lmhosts <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> sensitive = no dns proxy = no netbios name = SAMBA server string = %v samba password server = DC02.KR.LOC <span class="hljs-comment"><span class="hljs-comment">#        realm = KR.LOC client use spnego = yes client signing = yes local master = no domain master = no preferred master = no workgroup = KR debug level = 2 # ads        security = ads unix charset = UTF-8 dos charset = 866 max log size = 50 os level = 0 follow symlinks = yes winbind uid = 10000-20000 winbind gid = 10000-20000 winbind enum groups = yes winbind enum users = yes</span></span></code> </pre><br></div></div><br>  Now we‚Äôll configure winbind (allows Samba to recognize AD users and communicate with them as local). <br>  We need to edit the <b>/etc/nsswitch.conf</b> file, add to it: <br><pre> <code class="bash hljs">passwd: compat winbind group: compat winbind shadow: compat winbind</code> </pre><br><br>  It remains to configure Kerberos (used to integrate Samba into Active Directory) <br>  We bring <b>file</b> / <b>etc</b> / <b>krb5.conf</b> to a type <br><div class="spoiler">  <b class="spoiler_title">krb5.conf</b> <div class="spoiler_text">  * Domain change to your. <br><pre> <code class="bash hljs"> [logging] default = FILE:/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/krb5.log kdc = FILE:/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/krb5kdc.log [libdefaults] default_realm = KR.LOC clockskew = 500 dns_lookup_realm = <span class="hljs-literal"><span class="hljs-literal">false</span></span> dns_lookup_kdc = <span class="hljs-literal"><span class="hljs-literal">true</span></span> ticket_lifetime = 324000 [realms] KR.LOC = { kdc = DC02.KR.LOC admin_server = DC02.KR.LOC default_domain = KR.LOC } [domain_realm] .kr.loc = KR.LOC [login] krb4_convert = <span class="hljs-literal"><span class="hljs-literal">true</span></span> krb4_get_tickets = <span class="hljs-literal"><span class="hljs-literal">false</span></span></code> </pre><br></div></div><br>  Configs corrected, you can restart services: <br><pre> <code class="bash hljs">service samba restart service winbind restart</code> </pre><br>  Check for your domain user: <br><pre> <code class="bash hljs">kinit sf-test@KR.LOC</code> </pre><br>  We receive a request to enter a password, enter. <br><pre> <code class="bash hljs">Password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> sf-test@KR.LOC:</code> </pre><br>  If everything is OK, there will be no output on the screen, if everything does output something, carefully read and correct the errors in the config. <br>  We consider that you are fine and enter the server into the domain <br><pre> <code class="bash hljs">net join ‚ÄìU sf-test@KR.LOC</code> </pre><br>  Check winbind's work: <br><pre> <code class="bash hljs">wbinfo -u wbinfo -g</code> </pre><br>  The output should see a list of domain users and groups. <br><br>  To check whether domain users are perceived as local, you can use the command: <br><pre> <code class="bash hljs">id domain_user</code> </pre><br>  We check the operation of the authentication module (login / password / domain - of course your own) <br><pre> <code class="bash hljs">ntlm_auth --request-nt-key --domain=KR.LOC --username=sf-test --password=123456789</code> </pre><br>  Got OK, so you can uncomment the ldap or ntlm_auth module in the radius config (if you don‚Äôt need domain groups), restart freeradius and enjoy the work of the VPN server with domain uchetka, but to calm the conscience we‚Äôll check that the radius authorizes domain users: <br><pre> <code class="bash hljs">radtest -t mschap sf-test 123456789 127.0.0.1 0 Radius-Sicret</code> </pre><br>  Now you can create a VPN connection at your place and check the entire bundle. <br><br><h4>  5) Bonus </h4><br>  Scrolling through the note again looked at the network diagram and remembered that we have site-to-site connections for IPsec - this is also convenient if VPN users need to be given access to other networks, all this is implemented by firewall, but the example of setting up strongswan for such connections cite below. <br><div class="spoiler">  <b class="spoiler_title">ipsec.conf</b> <div class="spoiler_text">  Add the following section to /etc/ipsec.conf: <br><pre> <code class="bash hljs">conn juniper forceencaps=yes dpddelay=30 <span class="hljs-comment"><span class="hljs-comment"># Dead peer detection - 30  -   keep-alive  dpdtimeout=120 # dpd  120 ,       # IKE alg 3DES - HASH sha1 - DH group 2 (1024) ike=3des-sha1-modp1024 # IKE lifetime 86400 seconds (24 hours) ikelifetime=86400s # IKE auth method Pre-Shared Key (PSK secret) authby=secret # IPSec type tunnel type=tunnel #  -  #left side (myside) left=..1.99 # OpenSWAN side leftsubnet=10.65.0.0/16 #  ,      right=..116.5 #  rightsubnet=192.168.105.0/24 #   ,     VPN auto=start esp=3des-sha1,3des-md5 keyexchange=ikev1</span></span></code> </pre><br></div></div><br><h4>  Conclusion </h4><br>  I hope everything worked out the first time and immediately worked, if it is not so - ask questions in the comments.  The author is pathologically illiterate, if you see a mistake, a typo, not unambiguity or any other moment that interferes with the perception of the note - please inform in a personal.  Thank you all for your time. </div><p>Source: <a href="https://habr.com/ru/post/267103/">https://habr.com/ru/post/267103/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../267091/index.html">The evolution of network communication methods. Part I</a></li>
<li><a href="../267093/index.html">Microsoft has released a major update for Windows RT</a></li>
<li><a href="../267095/index.html">Nginx: protect url one-time password</a></li>
<li><a href="../267097/index.html">Deploy Nginx Flask Application Using Gunicorn</a></li>
<li><a href="../267099/index.html">Malware Odlanor specializes in compromising poker players</a></li>
<li><a href="../267105/index.html">UrbanAirship - push without creating a server</a></li>
<li><a href="../267107/index.html">Log Analysis with Hadoop / Python</a></li>
<li><a href="../267109/index.html">In the Norwegian abandoned mine will build the largest data center in Europe</a></li>
<li><a href="../267111/index.html">BabylonJS. Lesson 2 - Basic Meshes</a></li>
<li><a href="../267113/index.html">Deepen in Scheme</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>