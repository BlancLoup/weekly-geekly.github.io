<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dune 2: The Building of a Dynasty</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Developer: Westwood Studios 
 Publisher: Virgin Games 
 Genre: Strategy (Real-time) / Top-down 
 System requirements: 



 Instead of introducing 
 Du...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dune 2: The Building of a Dynasty</h1><div class="post__text post__text-html js-mediator-article">  <b>Developer:</b> Westwood Studios <br>  <b>Publisher:</b> Virgin Games <br>  <b>Genre:</b> Strategy (Real-time) / Top-down <br>  <b>System requirements:</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/0d2/390/5dc/0d23905dc962524094f870678d2691c5.png" alt="moder browsers"><br><a name="habracut"></a><br><br><h4>  Instead of introducing </h4><br>  <a href="http://ru.wikipedia.org/wiki/Dune_II">Dune 2</a> is a great strategy, one of the first in the genre.  It makes no sense to grovel and say how great this game is for a whole generation of children of the 90s.  And since I unexpectedly find it my pleasure to mess around with the code and port it in JavaScript, then of course my goal after TTD ( <a href="http://habrahabr.ru/post/147138/">article</a> ) inevitably became Dune 2. By luck, I didn‚Äôt think of starting with it, because I'm afraid I wouldn‚Äôt handled it.  As it turned out, although Dune 2 is simpler in functionality than TTD, it was more difficult to port it, but more on that later. <br><br><h4>  Code base </h4><br>  The choice of the ‚Äúcorrect‚Äù code base is the main factor in the successful porting of a project using <a href="http://emscripten.org/">emscripten</a> .  For example, the use of <a href="http://www.libsdl.org/">SDL</a> , lack of multithreading is a good marker of the fact that porting will be successful.  I looked through all the projects related to Dune 2, and stopped at <a href="http://www.opendune.org/">OpenDune</a> .  The chip that hooked me was a complete copy of all the behavior of the original game, including all its bugs.  It seems that the code of this project was originally obtained semi-automatically from the original.  In the code here and there are variables called <i>local_03FF</i> , a lot of global variables, the code is very difficult to read.  The most serious disadvantage of the source code base in multithreading, it caused a lot of problems when porting.  But the result is really good, in the browser the game is very similar to the original, with the exception of the new pack of bugs. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h6>  So, the dry facts: </h6><br>  Language: C <br>  Number of source files: 143 <br>  Number of lines of code: 59151 <br>  Binary size: 423.2 Kb <br>  Size equivalent javascript: ~ 1000 Kb <br>  Porting time: ~ 2 months <br><br>  Later in this article will be described the difficulties that I encountered when porting.  Surely it is not interesting to everyone, if so, then lower this subsection to "known problems". <br><br><h4>  Multithreading vs asynchrony </h4><br>  OpenDune has a rather interesting interrupt based multithreading model.  To ensure multithreading, the game code is spinning in endless cycles at the moment of idle, it looks like this: <br><br><pre><code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { uint16 key; key = GUI_Widget_HandleEvents(w); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (key = <span class="hljs-number"><span class="hljs-number">13</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } sleepIdle(); }</code> </pre> <br><br>  When the application starts, the interval timer is initialized with the <a href="http://www.intuit.ru/department/se/pposix/12/7.html">setitimer</a> function.  This timer triggers an interrupt at regular intervals.  It pauses the main thread of execution and allows the execution of arbitrary code.  For JavaScript, the implementation of a similar timer is trivial, however, another porting path was chosen in order not to artificially divide the project into JavaScript and C implementations.  It was decided to completely abandon the use of the <i>setitimer</i> function; instead, the <i>sleepIdle ()</i> call was replaced with a timer event function, i.e.  instead of idle, this function determines which scheduled events have come up and launches them for execution. <br><br>  A more serious problem is internal <i>while</i> loops; any occurrence of such a loop in JavaScript will inevitably cause the open tab of the browser (or the browser as a whole) to hang.  This is due to the fact that most of the cycles expect user input (pressing the mouse button, keyboard), but the browser cannot handle events from input devices, they are placed in the execution chain after the current JavaScript block being executed.  A possible way to solve this problem is to manually edit the code and transfer the problem code to asynchronous mode. <br><br>  Small primerichik.  Here is a draft code that causes problems: <br><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> someProblemFunction() { { //<span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // code <span class="hljs-number"><span class="hljs-number">2</span></span> } // <span class="hljs-keyword"><span class="hljs-keyword">close</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> } { //<span class="hljs-keyword"><span class="hljs-keyword">close</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> } }</code> </pre><br><br>  After agonizing speculative manipulations, asynchronous code: <br><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> asyncSomeProblemFunction() { Async_InvokeInLoop( asyncSomeProblemFunctionOpen1, asyncSomeProblemFunctionCondition1, asyncSomeProblemFunctionLoop1, asyncSomeProblemFunctionClose1); } <span class="hljs-type"><span class="hljs-type">void</span></span> asyncSomeProblemFunctionOpen1() { // code <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> } <span class="hljs-type"><span class="hljs-type">void</span></span> asyncSomeProblemFunctionCondition1() { // code <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> condition } <span class="hljs-type"><span class="hljs-type">void</span></span> asyncSomeProblemFunctionLoop1() { Async_InvokeInLoop( asyncSomeProblemFunctionOpen2, asyncSomeProblemFunctionCondition2, asyncSomeProblemFunctionLoop2, asyncSomeProblemFunctionClose2); } <span class="hljs-type"><span class="hljs-type">void</span></span> asyncSomeProblemFunctionClose1() { // code <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">close</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre><br><br>  Hell of a job.  The core of the entire system is the <i>Async_InvokeInLoop</i> function. <br><br><pre> <code class="hljs lisp">void Async_InvokeInLoop( <span class="hljs-name"><span class="hljs-name">void</span></span> (<span class="hljs-name"><span class="hljs-name">*open</span></span>)(), void (<span class="hljs-name"><span class="hljs-name">*condition</span></span>)(<span class="hljs-name"><span class="hljs-name">bool*</span></span> ref), void (<span class="hljs-name"><span class="hljs-name">*loop</span></span>)(), void (<span class="hljs-name"><span class="hljs-name">*close</span></span>)())<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre><br><br>  <i>Async_InvokeInLoop</i> - allows you to replace any <i>while (true) loop with</i> an asynchronous equivalent.  The function guarantees to call <i>open</i> before the start of the cycle, and <i>close</i> after the end of the cycle.  References to the <i>condition</i> and <i>loop</i> functions are equal participants in asynchronous iteration, which is clear from the name.  Iteration is implemented through the <i>Async_Loop</i> function: <br><br><pre> <code class="hljs php">void Async_Loop() { ScheduledAsync *top = STACK_TOP; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (top-&gt;state) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ScheduledAsync_OPEN: { top-&gt;open(); top-&gt;state = ScheduledAsync_CONDITION; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ScheduledAsync_CONDITION: { top-&gt;condition(&amp;top-&gt;conditionValue); top-&gt;state = ScheduledAsync_LOOP; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ScheduledAsync_LOOP: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (top-&gt;conditionValue) { top-&gt;loop(); top-&gt;state = ScheduledAsync_CONDITION; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { top-&gt;state = ScheduledAsync_CLOSE; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ScheduledAsync_CLOSE: { popStack(); top-&gt;close(); free(top); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: abort(); } }</code> </pre><br><br>  The game loop (or the timer in JavaScript) periodically jerks this function forcing everything in the game to spin.  If the original function should return a result, then the problems are doubled - you have to save the result globally, and then retrieve it in other functions.  Everything works by agreement.  As a result, I have a hellish framework for asynchronizing a project, here is its interface: <br><br><pre> <code class="hljs vala"><span class="hljs-comment"><span class="hljs-comment">/* * async.h * * Created on: 19.10.2012 * Author: caiiiycuk */</span></span> #ifndef ASYNC_H_ #define ASYNC_H_ #include <span class="hljs-string"><span class="hljs-string">"types.h"</span></span> extern <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> async_noop(); extern <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> async_false(<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> *condition); extern <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> async_true(<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> *condition); extern <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Async_InvokeInLoop(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*open)(), <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*condition)(<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>* ref), <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*loop)(), <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*close)()); extern <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Async_IsPending(); extern <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Async_Loop(); extern <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Async_InvokeAfterAsync(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*callback)()); extern <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Async_InvokeAfterAsyncOrNow(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*callback)()); extern <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Async_Storage_uint16(<span class="hljs-keyword"><span class="hljs-keyword">uint16</span></span>* storage); extern <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Async_StorageSet_uint16(<span class="hljs-keyword"><span class="hljs-keyword">uint16</span></span> value); #endif <span class="hljs-comment"><span class="hljs-comment">/* ASYNC_H_ */</span></span></code> </pre><br><br>  The synchronous nature of the game mutated into asynchronous, which pleased several funny bugs: <br><ul><li>  If you call up the construction menu immediately before the computer opponent determines the next building to be built, then you can access its facilities (corrected) </li><li>  When loading the script, it was possible that the enemy‚Äôs facilities would receive 20,000‚Äì30,000 units of life instead of 150‚Äì200 (corrected) </li><li>  Due to synchronization errors - the game map can be redrawn directly on top of the dialogue with the mentat, though this is rarely shown (not fixed) </li></ul><br><br><h4>  Known Issues </h4><br>  Due to the fact that the tester staff consists of me and my fictional friends, it is only known that: <br><ul><li>  The game works in browsers Firefox, Chrome, Opera, Chrome (Android ~ 4) </li><li>  The game is completely passed for the house of the Harkonnens and no serious problems were found. </li><li>  A small number of missions completed in two other houses, there were no problems either </li><li>  The game cursor never changes (regardless of the selected action), it is intentional (it slows down) </li><li>  To scroll the map, use the minimap or keyboard arrows (use the keyboard more in the game) </li><li>  There is music, but no effects </li><li>  Artifacts may appear on the game map (very rarely, you will immediately understand), in this case opening / closing of the game menu helps </li><li>  The menu items work: save, load, restart the mission </li><li>  There is only one save slot in the game (for all houses) </li></ul><br>  Everything else works, or should work. <br>  Tracker: <a href="https://github.com/caiiiycuk/play-dune">https://github.com/caiiiycuk/play-dune</a> <br><br><h4>  Are we playing? </h4><br>  <a href="http://play-dune.com/">http://play-dune.com/</a> <br><br>  71 <br><br>  <b>UPD1.</b>  Hotkeys: <a href="http://habrahabr.ru/post/159501/">habrahabr.ru/post/159501/#comment_5516325</a> <br><br>  <b>UPD2.</b>  The server is asking for, I give direct links with statics: <br>  <a href="http://play-dune.com/atreides/">House Play Atreides</a> <br>  <a href="http://play-dune.com/ordos/">House Game Ordos</a> <br>  <a href="http://play-dune.com/harkonnen/">House Play Harkonnen</a> <br><br>  <b>UPD3.</b>  The server has rested against the restriction tcpsndbuf - the total size of buffers, which can be used to send data via TCP connections.  The restriction that the provider puts to me, I cannot afford a more productive server, sorry if you could not play.  We are waiting for the load to return to normal. <br><br>  <b>UPD4.</b>  Yet the problem was in my crooked hands, now the server has to cope with the load. <br><br>  <b>UPD5.</b>  The ‚ÄúInvoice‚Äù button does not work in the spaceport, be careful, if you have not ordered a single unit in the spaceport and clicked ‚ÄúSend Order‚Äù, the ‚ÄúInvoice‚Äù button will automatically be pressed and everything will hang. <br><br>  <b>UPD6.</b>  New <a href="http://epicport.com/">project site.</a> </div><p>Source: <a href="https://habr.com/ru/post/159501/">https://habr.com/ru/post/159501/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../159481/index.html">New project - handler server specifications "Server-Audit"</a></li>
<li><a href="../159483/index.html">Regular Expression Advance and Retrospective Checks</a></li>
<li><a href="../159487/index.html">AppSurfer in action - android programs in the browser</a></li>
<li><a href="../159489/index.html">Human rights activists urge to adopt the First Law of Robotics</a></li>
<li><a href="../159497/index.html">Lomogram - photo editor for Windows Phone</a></li>
<li><a href="../159503/index.html">The easiest way to call a list of numbers with Asterisk</a></li>
<li><a href="../159507/index.html">Bitrix Integration. Implementing a directory with two item group structures</a></li>
<li><a href="../159509/index.html">The robot draws portraits almost like a man</a></li>
<li><a href="../159513/index.html">Convenient work with pictures in Django</a></li>
<li><a href="../159515/index.html">Release Firefox 17 and Firefox 17 ESR</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>