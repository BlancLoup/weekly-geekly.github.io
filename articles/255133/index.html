<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I fumbled with one button different data in the Android application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once I faced the task of adding export to the calendar to the already written export of plain text data via the ShareActionProvider button. Immediatel...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I fumbled with one button different data in the Android application</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/d6a/9dd/156/d6a9dd15628c4050ac6b560a7d278e0b.jpg"><br><br>  Once I faced the task of adding export to the calendar to the already written export of plain text data via the ShareActionProvider button.  Immediately there were several options, each of which for some reason did not suit me. <br><a name="habracut"></a><br>  SO <sup>1</sup> suggested that I change the MIME type from ‚Äútext / plain‚Äù to ‚Äú* / *‚Äù to cover a larger number of installed applications.  This added a lot of unnecessary applications, and the necessary ones were lost in the sea of ‚Äã‚Äãunnecessary ones.  There were proposals to use libraries, also, SO proposed to create your own Intent Chooser, and in it to implement the logic of choice, what data should be exported.  I did not want to use the dialog box only in order to be able to choose from several types of applications - and I decided to deal with the ShareActionProvider source code. <br><br><h2>  Digging in the source: </h2><br>  First of all, my view fell on the setShareIntent method, which took the collected Intent with the data for export.  And what if you can make a universal intent, I asked myself and rushed to look for how to combine the two intents into one, and even with different actions (Intent.ACTION_INSERT and Intent.ACTION_SEND).  Not a single solution that I found (I didn‚Äôt dig too deeply, to be honest), so I decided to peek at what is being done under the hood of the ShareActionProvider class.  Looking ahead, I‚Äôm saying that getting source <sup>2</sup> from Google, finding classes that work with our intent, and repeating steps 1 and 2 several times, I found out that there are three classes in charge of everything: Actually, ShareActionProvider, ActivityChooserView and ActivityChooserModel.  The last two are responsible for selecting the necessary applications for our intention, creating a drop-down list and processing the list selection. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The solution to the problem I decided to start with changing the type of data that I will pass to setShareIntent ().  Logically, if I want to export more different data, I need more intents and, therefore, the first solution that comes to mind is to use an array: <br><br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setShareIntent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Intent shareIntent)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shareIntent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String action = shareIntent.getAction(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Intent.ACTION_SEND.equals(action) || Intent.ACTION_SEND_MULTIPLE.equals(action)) { shareIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_DOCUMENT | Intent.FLAG_ACTIVITY_MULTIPLE_TASK); } } ActivityChooserModel dataModel = ActivityChooserModel.get(mContext, mShareHistoryFileName); dataModel.setIntent(shareIntent); }</code> </pre> <br><br>  change to: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setShareIntent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Intent[] shareIntents)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     for (Intent intent : shareIntents) { //      if (intent != null) { final String action = intent.getAction(); if (Intent.ACTION_SEND.equals(action) || Intent.ACTION_SEND_MULTIPLE.equals(action)) { intent.addFlags(Intent.FLAG_ACTIVITY_NEW_DOCUMENT | Intent.FLAG_ACTIVITY_MULTIPLE_TASK); } } } CustomActivityChooserModel dataModel = CustomActivityChooserModel.get(mContext, mShareHistoryFileName); //   ActivityChooserModel  ,  dataModel.setIntent(shareIntents); //     dataModel }</span></span></code> </pre><br><br>  The first step is passed, the first method is changed, we go further along the chain.  The following problem manifested itself in the dataModel object.  He (or she, model) does not want to take our array.  What to do, go inside ActivityChooserModel.get () and see what we can change there: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> CustomActivityChooserModel </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, String historyFileName)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (sRegistryLock) { CustomActivityChooserModel dataModel = sDataModelRegistry.get(historyFileName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dataModel == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { dataModel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CustomActivityChooserModel(context, historyFileName); sDataModelRegistry.put(historyFileName, dataModel); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dataModel; } }</code> </pre><br><br>  In fact, in this method, we changed only the class name from ActivityChooserModel to ours.  From here, our path goes through sDataModelRegistry to the get () method, but sDataModelRegistry is just the Map set, which is returned to us by an object of type ActivityChooserModel.  Vicious circle.  We leave the mental cycle and try another approach -&gt; if the dataModel is an object of type ActivityChooserModel, it means that it has a setIntent () method.  It remains for us (too naively) to only change the type of its input parameter to an array: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setIntent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Intent[] intents)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//        synchronized (mInstanceLock) { if (mIntents == intents) { //    intent mIntent  Intent[] mIntents return; } mIntents = intents; mReloadActivities = true; ensureConsistentState(); } } //        mIntent  mIntents //  : getIntent(), chooseActivity(), sortActivitiesIfNeeded(), loadActivitiesIfNeeded() // getIntent()   ,     //  chooseActivity()   .      ,    mIntent  mIntents</span></span></code> </pre><br><br>  We continue the excavation.  Add one more method to ensureConsistentState () in our carbon form stack, and dive into it with a head for editing and find two methods - loadActivitiesIfNeeded () and sortActivitiesIfNeeded ().  These are the ones we need to fix.  We mentally hope that the trend will not continue, and we will not end with sixteen methods in the fifth step. <br><br>  We start with the first method: <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;ActivityResolveInfo&gt; mActivities = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;ActivityResolveInfo&gt;(); <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-comment"><span class="hljs-comment">// -    private boolean loadActivitiesIfNeeded() { if (mReloadActivities &amp;&amp; mIntent != null) { mReloadActivities = false; mActivities.clear(); List&lt;ResolveInfo&gt; resolveInfos = mContext.getPackageManager().queryIntentActivities(mIntent, 0); final int resolveInfoCount = resolveInfos.size(); for (int i = 0; i &lt; resolveInfoCount; i++) { ResolveInfo resolveInfo = resolveInfos.get(i); mActivities.add(new ActivityResolveInfo(resolveInfo)); } return true; } return false; }</span></span></code> </pre><br><br>  change to: <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> LinkedHashMap&lt;Intent, ArrayList&lt;ActivityResolveInfo&gt;&gt; mActivities = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LinkedHashMap&lt;Intent, ArrayList&lt;ActivityResolveInfo&gt;&gt;(); <span class="hljs-comment"><span class="hljs-comment">// -, ,   mActivities   ,  ,         (   . , -) /* ... */ private boolean loadActivitiesIfNeeded() { if (mReloadActivities &amp;&amp; mIntents != null) { mReloadActivities = false; mActivities.clear(); for (Intent intent : mIntents) { //     List&lt;ResolveInfo&gt; resolveInfos = mContext.getPackageManager().queryIntentActivities(intent, 0); ArrayList&lt;ActivityResolveInfo&gt; activityResolveInfos = new ArrayList&lt;&gt;(); //   ArrayList      final int resolveInfoCount = resolveInfos.size(); for (int i = 0; i &lt; resolveInfoCount; i++) { ResolveInfo resolveInfo = resolveInfos.get(i); activityResolveInfos.add(new ActivityResolveInfo(resolveInfo)); } mActivities.put(intent, activityResolveInfos); //   ,   - .        ,       } return true; } return false; }</span></span></code> </pre><br><br>  We are moving to the sorting method, everything is simple, we add a loop through the array instead of a single element.  Now we know that everything is stored in the set, therefore no input parameters of the method are required: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sortActivitiesIfNeeded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mActivitySorter != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; mIntents != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; !mActivities.isEmpty() &amp;&amp; !mHistoricalRecords.isEmpty()) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Intent intent : mIntents) { <span class="hljs-comment"><span class="hljs-comment">// -   mActivitySorter.sort(intent, mActivities.get(intent), Collections.unmodifiableList(mHistoricalRecords)); } // ‚∏Æ       .     ‚∏Æ return true; } return false; }</span></span></code> </pre><br><br><h2>  We clean the code behind us </h2><br>  Looking around.  We also have methods that disagree with our changes: getActivity (), getActivityIndex (), the same chooseActivity (), already with a new error, then getDefaultActivity () and setDefaultActivity ().  Looking closer - we see that they swear only for changes in the type of mActivities from ArrayList to LinkedHashMap, then: <br><br>  Add a method to get the ActivityResolveInfo by index <br><br><pre> <code class="java hljs"> <span class="hljs-comment"><span class="hljs-comment">/** * Gets an activity resolve info at a given index. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> The activity resolve info. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@see</span></span></span><span class="hljs-comment"> ActivityResolveInfo * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@see</span></span></span><span class="hljs-comment"> #setIntent(Intent[]) */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> ActivityResolveInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getActivityResolveInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (mInstanceLock) { ensureConsistentState(); Collection&lt;ArrayList&lt;ActivityResolveInfo&gt;&gt; activitiesValues = mActivities.values(); ArrayList&lt;ActivityResolveInfo&gt; activitiesList = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (ArrayList&lt;ActivityResolveInfo&gt; list : activitiesValues) { activitiesList.addAll(list); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> activitiesList.get(index); } }</code> </pre><br><br>  This method will help us more.  After that we change: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ResolveInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getActivity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (mInstanceLock) { ensureConsistentState(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mActivities.get(index).resolveInfo; } }</code> </pre><br><br>  On: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ResolveInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getActivity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getActivityResolveInfo(index).resolveInfo; }</code> </pre><br><br>  It's simple ... <br><br>  We recall what has been done and what remains: <br><ul><li>  <s>getIntent ()</s> </li><li>  <s>sortActivitiesIfNeeded ()</s> </li><li>  <s>loadActivitiesIfNeeded ()</s> </li><li>  <s>getActivity ()</s> </li><li>  getDefaultActivity () </li><li>  setDefaultActivity () </li><li>  getActivityIndex () </li><li>  chooseActivity () </li></ul><br><br>  Let's do the default activation.  You need to adapt them to use the Map: <br><br>  In the setDefaultActivity () method, we only take an ArrayList by the first key: <br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setDefaultActivity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   //   // ActivityResolveInfo newDefaultActivity = mActivities.get(index); // ActivityResolveInfo oldDefaultActivity = mActivities.get(0); //   ActivityResolveInfo newDefaultActivity = mActivities.get(mIntents[0]).get(index); ActivityResolveInfo oldDefaultActivity = mActivities.get(mIntents[0]).get(0); //   </span></span></code> </pre><br><br>  As for getDefaultActivity (): <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ResolveInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDefaultActivity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (mInstanceLock) { ensureConsistentState(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!mActivities.isEmpty()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mActivities.get(<span class="hljs-number"><span class="hljs-number">0</span></span>).resolveInfo; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }</code> </pre><br><br>  We need to get the first element of the first key: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ResolveInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDefaultActivity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (mInstanceLock) { ensureConsistentState(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!mActivities.isEmpty()) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (ArrayList&lt;ActivityResolveInfo&gt; arrayList : mActivities.values()) { <span class="hljs-comment"><span class="hljs-comment">//    if (!arrayList.isEmpty()) { return arrayList.get(0).resolveInfo; //     -  ResolveInfo   } } } } return null; //       null }</span></span></code> </pre><br><br>  Two methods remain: getActivityIndex () and chooseActivity (). <br><br>  To get the activation index, we need to take the string <br><br><pre> <code class="java hljs"> List&lt;ActivityResolveInfo&gt; activities = mActivities; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> activityCount = activities.size();</code> </pre><br><br>  And paint all the same, only with a few ArrayList, which we keep in mActivities: <br><br><pre> <code class="java hljs"> HashMap&lt;Intent, ArrayList&lt;ActivityResolveInfo&gt;&gt; activities = mActivities; Collection&lt;ArrayList&lt;ActivityResolveInfo&gt;&gt; activitiesValues = activities.values(); ArrayList&lt;ActivityResolveInfo&gt; activitiesList = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (ArrayList&lt;ActivityResolveInfo&gt; list : activitiesValues) { activitiesList.addAll(list); <span class="hljs-comment"><span class="hljs-comment">//   ArrayList          } final int activityCount = activitiesList.size();</span></span></code> </pre><br><br>  Now we need to choose aktiviti, a lot of changes, so I will give the whole method, sorry for a bunch of code :-( <br><br>  Old method: <br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Intent </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">chooseActivity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (mInstanceLock) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mIntent == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } ensureConsistentState(); ActivityResolveInfo chosenActivity = mActivities.get(index); ComponentName chosenName = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ComponentName(chosenActivity.resolveInfo.activityInfo.packageName, chosenActivity.resolveInfo.activityInfo.name); Intent choiceIntent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(mIntent); <span class="hljs-comment"><span class="hljs-comment">//      } }</span></span></code> </pre><br><br>  The new method: <br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Intent </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">chooseActivity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (mInstanceLock) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mIntents == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } ensureConsistentState(); ActivityResolveInfo chosenActivity = getActivityResolveInfo(index); <span class="hljs-comment"><span class="hljs-comment">//      ComponentName chosenName = new ComponentName(chosenActivity.resolveInfo.activityInfo.packageName, chosenActivity.resolveInfo.activityInfo.name); Iterator iterator = mActivities.keySet().iterator(); //       Intent tmpIntent = (Intent) iterator.next(); while (mActivities.get(tmpIntent).size() &lt;= index) { //     -     index -= mActivities.get(tmpIntent).size(); //        tmpIntent = (Intent) iterator.next(); //    ,       } Intent choiceIntent = new Intent(tmpIntent); //    ,    - //      } }</span></span></code> </pre><br><br><h2>  ActivityChooserView </h2><br>  Not tired?  <b>But ActivityChooserView is on the way!</b> <br><br>  But we were all lucky.  In our artificial ActivityChooserView, we just need to change all ActivityChooserModel to CustomActivityChooserModel.  If we consider that the ActivityChooserView itself will change to CustomActivityChooserView. <br><br><h2>  Testing </h2><br>  Now we need to prepare the data we want to export: <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Intent[] getDefaultIntents() { DateFormat dateFormat = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleDateFormat(<span class="hljs-string"><span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span></span>, Locale.US); Calendar startCalendar = Calendar.getInstance(); Calendar endCalendar = Calendar.getInstance(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { startCalendar.setTime(dateFormat.parse(<span class="hljs-string"><span class="hljs-string">"2015-01-06 00:00:00"</span></span>)); endCalendar.setTime(dateFormat.parse(<span class="hljs-string"><span class="hljs-string">"2015-05-06 00:00:00"</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ParseException e) { e.printStackTrace(); } Intent calendarIntent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(Intent.ACTION_INSERT).setData(CalendarContract.Events.CONTENT_URI) .putExtra(CalendarContract.EXTRA_EVENT_BEGIN_TIME, startCalendar.getTimeInMillis()) .putExtra(CalendarContract.EXTRA_EVENT_END_TIME, endCalendar.getTimeInMillis()) .putExtra(CalendarContract.Events.TITLE, <span class="hljs-string"><span class="hljs-string">"My calendar event"</span></span>) .putExtra(CalendarContract.Events.DESCRIPTION, <span class="hljs-string"><span class="hljs-string">"Group class"</span></span>) .putExtra(CalendarContract.Events.EVENT_LOCATION, <span class="hljs-string"><span class="hljs-string">"Imaginary street 16, Imaginaryland"</span></span>); Intent messageIntent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(Intent.ACTION_SEND); messageIntent.putExtra(Intent.EXTRA_TEXT, <span class="hljs-string"><span class="hljs-string">" "</span></span>); messageIntent.putExtra(Intent.EXTRA_SUBJECT, <span class="hljs-string"><span class="hljs-string">" "</span></span>); messageIntent.setType(<span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent[] {calendarIntent, messageIntent}; }</code> </pre><br><br>  Mini example of work: <br><img src="//habrastorage.org/files/b22/3f6/ff2/b223f6ff26db4a7e86cc280486fe4dfc.jpg"><br><img src="//habrastorage.org/files/c59/d32/ee9/c59d32ee9c7b4d649c70fda99d7fd0a4.jpg"><br><br>  By the same principle, you can use not only two, but more intents for different types of data that we want to share with neighboring applications on our or user device. <br><br>  Any edits or suggestions are accepted 24/7 in a personal or in the comments (at your own risk). <br><br>  That's all, <br>  Happiness to all! <br><br>  - Footnotes: <br>  1 - StackOverflow.com <br>  2 - <a href="http://grepcode.com/project/repository.grepcode.com/java/ext/com.google.android/android/">grepcode.com/project/repository.grepcode.com/java/ext/com.google.android/android</a> </div><p>Source: <a href="https://habr.com/ru/post/255133/">https://habr.com/ru/post/255133/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255123/index.html">"Another" look at the choice of a new flash drive</a></li>
<li><a href="../255125/index.html">10 paper encryption methods for schoolchildren with ABBYY FineReader</a></li>
<li><a href="../255127/index.html">Automated testing survey results: 620 responses</a></li>
<li><a href="../255129/index.html">In search of a non-existent time</a></li>
<li><a href="../255131/index.html">‚ÄúNot a single break!‚Äù Or why should a customer fight with technical support</a></li>
<li><a href="../255135/index.html">Reverse Engineering ESP8266 - Part 1</a></li>
<li><a href="../255137/index.html">Exploring JavaScript Symbols. Symbol - new data type in javascript</a></li>
<li><a href="../255139/index.html">Collect the best of two worlds - frameworks and CMS (part 2)</a></li>
<li><a href="../255141/index.html">R-prong electrocardiogram as a parameter of the tree of Pythagoras</a></li>
<li><a href="../255143/index.html">Bag of words and sentiment analysis on R</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>