<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Heroes III. The Restoration of Campaign</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Of course, everyone knows about the third heroes. Weeks of time lost behind the hotseat, chiselled characteristics of units, tactics of development, d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Heroes III. The Restoration of Campaign</h1><div class="post__text post__text-html js-mediator-article">  Of course, everyone knows about the third heroes.  Weeks of time lost behind the hotseat, chiselled characteristics of units, tactics of development, development.  Weekly gatherings with friends for the heroes c coffee and bagels.  Great, in general, it was.  But the other day I wanted to repeat and play on the network.  All are already gone, hotseat is not a ride.  They downloaded the Armageddon blade distribution kit, set up hamachi, but something went wrong.  Ping is big for some reason, nothing happened.  Well, busy all, there is no time to understand, and reluctance.  The game did not go. <br><br>  And the characters are installed, the desire to play is.  I decided to go through the campaign (to my shame, I never had the patience to go through it in the past).  Launched, chose the campaign of the revival of Eratia, clicked on the episode "Victims of War."  And I do not know, intuition, probably, appears during the time you are programming.  In general, the heroes showed me this picture: <br><img src="https://habrastorage.org/storage2/26e/4ca/7bb/26e4ca7bba5c7af95f39e02b5b868587.png"><br>  And, as often happens with me, the game is over, and a more interesting and exciting activity has begun. <br><a name="habracut"></a><br>  I start in the debugger, I select the same problem point.  In this section of the code, an exception occurs when accessing memory on line mov bl, [eax + ecx + 1F879h]. <br><br><blockquote>  <font color="#339933">.</font>  text <font color="#339933">:</font> 004567A3 <font color="#00007f">mov</font> <font color="#00007f">ecx</font> <font color="#339933">,</font> dword_68C818 <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> 004567A9 <font color="#00007f">test</font> <font color="#00007f">ecx</font> <font color="#339933">,</font> <font color="#00007f">ecx</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> 004567AB <font color="#00007f">jl</font> <font color="#000000">short</font> loc_4567F2 <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> 004567AD <font color="#00007f">mov</font> <font color="#00007f">dl</font> <font color="#339933">,</font> <font color="#009900">[</font> <font color="#00007f">eax</font> <font color="#339933">+</font> <font color="#00007f">edi</font> <font color="#339933">+</font> <font color="#0000ff">1F879h</font> <font color="#009900">]</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> 004567B4 <font color="#00007f">mov</font> <font color="#00007f">bl</font> <font color="#339933">,</font> <font color="#009900">[</font> <font color="#00007f">eax</font> <font color="#339933">+</font> <font color="#00007f">ecx</font> <font color="#339933">+</font> <font color="#0000ff">1F879h</font> <font color="#009900">]</font> </blockquote>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I look at the values ‚Äã‚Äãof the registers: EDI is equal to zero, EAX indicates the correct memory location, ECX is just huge and points to nowhere.  Most likely, the problem is in it.  Now you need to find where the value is entered into it.  I climbed a little higher on the code, I find the line mov ecx, dword_68C818.  Yeah, then the ECX register is populated with a global variable.  I open the cross-reference window to see where the value is written to this variable. <br><img src="https://habrastorage.org/storage2/0ec/081/298/0ec08129851af11f2c29c1abece5b0fd.png"><br><br>  Interestingly, the value in it is written in the same function.  In general, a strange thing.  The variable is global, and is used only in one function.  Does it mean that it should be created on the stack?  Well, well, I probably do not understand something.  I look who writes it.  And it looks like this: <br><blockquote>  <font color="#339933">.</font>  text <font color="#339933">:</font> <font color="#0000ff">00456736</font> <font color="#00007f">mov</font> <font color="#00007f">eax</font> <font color="#339933">,</font> <font color="#009900">[</font> <font color="#00007f">eax</font> <font color="#339933">+</font> <font color="#0000ff">1F468h</font> <font color="#009900">]</font> <font color="#666666">;</font>  <font color="#666666">this is an argument</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> <font color="#0000ff">0045673F</font> <font color="#00007f">push</font> <font color="#00007f">eax</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> <font color="#0000ff">00456743</font> <font color="#00007f">mov</font> <font color="#00007f">ecx</font> <font color="#339933">,</font> <font color="#009900">[</font> <font color="#00007f">ecx</font> <font color="#339933">+</font> <font color="#0000ff">0A4h</font> <font color="#009900">]</font> <font color="#666666">;</font>  <font color="#666666">here is an object with a "bad" value</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> <font color="#0000ff">00456749</font> <font color="#00007f">mov</font> <font color="#00007f">edx</font> <font color="#339933">,</font> <font color="#009900">[</font> <font color="#00007f">ecx</font> <font color="#009900">]</font> <font color="#666666">;</font>  <font color="#666666">and this is his table of pointers to virtual functions</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> 0045674B <font color="#00007f">call</font> <font color="#000000">dword</font> <font color="#000000">ptr</font> <font color="#009900">[</font> <font color="#00007f">edx</font> <font color="#339933">+</font> <font color="#0000ff">20h</font> <font color="#009900">]</font> <font color="#666666">;</font>  <font color="#666666">here call subroutine</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> 00483A60 <font color="#00007f">push</font> <font color="#00007f">ebp</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> 00483A61 <font color="#00007f">mov</font> <font color="#00007f">ebp</font> <font color="#339933">,</font> <font color="#00007f">esp</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> 00483A63 <font color="#00007f">mov</font> <font color="#00007f">eax</font> <font color="#339933">,</font> <font color="#009900">[</font> <font color="#00007f">ecx</font> <font color="#339933">+</font> <font color="#0000ff">8</font> <font color="#009900">]</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> 00483A66 <font color="#00007f">mov</font> <font color="#00007f">ecx</font> <font color="#339933">,</font> <font color="#009900">[</font> <font color="#00007f">ebp</font> <font color="#339933">+</font> arg_0 <font color="#009900">]</font> <font color="#666666">;</font>  <font color="#666666">this argument is -1</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> 00483A69 <font color="#00007f">mov</font> <font color="#00007f">eax</font> <font color="#339933">,</font> <font color="#009900">[</font> <font color="#00007f">eax</font> <font color="#339933">+</font> <font color="#00007f">ecx</font> <font color="#339933">*</font> <font color="#0000ff">8</font> <font color="#009900">]</font> <font color="#666666">;</font>  <font color="#666666">something like result = arr [-1] happens here.</font>  <font color="#666666">Very suspicious place</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> 00483A6D <font color="#00007f">pop</font> <font color="#00007f">ebp</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> 00483A6E <font color="#00007f">retn</font> <font color="#0000ff">4</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> 0045674E <font color="#00007f">mov</font> dword_68C818 <font color="#339933">,</font> <font color="#00007f">eax</font> <font color="#666666">;</font>  <font color="#666666">here we write to our global variable the value that the subroutine returned.</font>  <font color="#666666">This is the same ‚Äúbad‚Äù figure, which brings down the game.</font> </blockquote><br><br>  It is very strange that the array is addressed at a negative index.  It can be assumed that the error in the argument.  Text search seeking access to a variable with offset 1F468h <br><img src="https://habrastorage.org/storage2/ced/21e/e1c/ced21ee1c3f419d588886c5e2b41c8b0.png"><br><br>  As you can see, refer to it exactly twice.  The first time a constant is written into it at initialization (apparently this constant is exactly what I get).  The second case will have to be studied in more detail.  I‚Äôm going to the address specified in the search results (I‚Äôm not going to give a large function), put a breakpoint, choose a script.  Nothing happens.  I go higher to the top of the function.  The function is called quite often.  By the presence of multiple branches, it can be assumed that this is processing some messages.  I try to click on all the buttons that are in the script window.  The breakpoint is triggered during the selection of the initial prize.  Something like this: <br><img src="https://habrastorage.org/storage2/d9f/08d/1f4/d9f08d1f4345f217bd5cfe3d35d6a92e.jpg"><br>  Now we can formulate a mistake in a human way.  There is a virtual function getStartupBonus, which returns the initial bonus.  In scripts of one type, a variable is returned, in scripts of another type, an array element specified by some external index.  It is understood that the index does not extend beyond the array.  But for some reason, before loading the script, the wrong value is written to the index.  There is an output outside the array, the application crashes. <br>  There are several solutions.  You can, for example, change the constant with which the variable is initialized to zero.  But, truth, it can lead to quite unexpected consequences.  It seems to me that it would be best to add a few instructions to the function that checks the argument before the function that works with the array.  And the function will look like this: <br><blockquote>  <font color="#339933">.</font>  text <font color="#339933">:</font> 0048385A <font color="#00007f">push</font> <font color="#00007f">ebp</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> 0048385B <font color="#00007f">mov</font> <font color="#00007f">ebp</font> <font color="#339933">,</font> <font color="#00007f">esp</font> <font color="#666666">;</font>  <font color="#666666">ebp points to stack</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> 0048385D <font color="#00007f">mov</font> <font color="#00007f">eax</font> <font color="#339933">,</font> <font color="#009900">[</font> <font color="#00007f">ecx</font> <font color="#339933">+</font> <font color="#0000ff">8</font> <font color="#009900">]</font> <font color="#666666">;</font>  <font color="#666666">eax points to an array</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> <font color="#0000ff">00483860</font> <font color="#00007f">mov</font> <font color="#00007f">ecx</font> <font color="#339933">,</font> <font color="#009900">[</font> <font color="#00007f">ebp</font> <font color="#339933">+</font> arg_0 <font color="#009900">]</font> <font color="#666666">;</font>  <font color="#666666">The argument contains the estimated array index</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> <font color="#0000ff">00483863</font> <font color="#00007f">test</font> <font color="#00007f">ecx</font> <font color="#339933">,</font> <font color="#00007f">ecx</font> <font color="#666666">;</font>  <font color="#666666">check if the index is negative</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> <font color="#0000ff">00483865</font> <font color="#00007f">jns</font> <font color="#000000">short</font> loc_483869 <font color="#666666">;</font>  <font color="#666666">if it is not, then go to reading the array element</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> <font color="#0000ff">00483867</font> <font color="#00007f">xor</font> <font color="#00007f">ecx</font> <font color="#339933">,</font> <font color="#00007f">ecx</font> <font color="#666666">;</font>  <font color="#666666">if the array index is negative, then we equate it to zero</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> <font color="#0000ff">00483869</font> <font color="#00007f">mov</font> <font color="#00007f">eax</font> <font color="#339933">,</font> <font color="#009900">[</font> <font color="#00007f">eax</font> <font color="#339933">+</font> <font color="#00007f">ecx</font> <font color="#339933">*</font> <font color="#0000ff">8</font> <font color="#009900">]</font> <font color="#666666">;</font>  <font color="#666666">return array element</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> 0048386C <font color="#00007f">pop</font> <font color="#00007f">ebp</font> <br>  <font color="#339933">.</font>  text <font color="#339933">:</font> 0048386D <font color="#00007f">retn</font> <font color="#0000ff">4</font> </blockquote><br>  I write down the changes in the executable file, restart the game, select the campaign, it works. </div><p>Source: <a href="https://habr.com/ru/post/149218/">https://habr.com/ru/post/149218/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../149211/index.html">NGINX to Mars will bring</a></li>
<li><a href="../149212/index.html">Half empty glass</a></li>
<li><a href="../149214/index.html">Harmful mobile apps</a></li>
<li><a href="../149215/index.html">Welcome post</a></li>
<li><a href="../149217/index.html">Winners of the contest Ubuntu App Showdown have become known</a></li>
<li><a href="../149219/index.html">Live tiles (Live tiles) in Windows 8 (WinRT)</a></li>
<li><a href="../149220/index.html">Vim to the desktop</a></li>
<li><a href="../149221/index.html">RE: Earth in the information blockade?</a></li>
<li><a href="../149223/index.html">The problem with financial performance SaaS</a></li>
<li><a href="../149225/index.html">Damn Small Linux unexpectedly updated</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>