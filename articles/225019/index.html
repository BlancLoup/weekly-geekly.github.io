<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating audio plug-ins, part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All posts series: 
 Part 1. Introduction and setup 
 Part 2. Learning Code 
 Part 3. VST and AU 
 Part 4. Digital Distortion 
 Part 5. Presets and GUI...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating audio plug-ins, part 2</h1><div class="post__text post__text-html js-mediator-article">  All posts series: <br>  <a href="http://habrahabr.ru/post/224911/">Part 1. Introduction and setup</a> <br>  <a href="http://habrahabr.ru/post/225019/">Part 2. Learning Code</a> <br>  <a href="http://habrahabr.ru/post/225457/">Part 3. VST and AU</a> <br>  <a href="http://habrahabr.ru/post/225751/">Part 4. Digital Distortion</a> <br>  <a href="http://habrahabr.ru/post/225755/">Part 5. Presets and GUI</a> <br>  <a href="http://habrahabr.ru/post/226439/">Part 6. Signal synthesis</a> <br>  <a href="http://habrahabr.ru/post/226573/">Part 7. Receive MIDI Messages</a> <br>  <a href="http://habrahabr.ru/post/226823/">Part 8. Virtual Keyboard</a> <br>  <a href="http://habrahabr.ru/post/227475/">Part 9. Envelopes</a> <br>  <a href="http://habrahabr.ru/post/227601/">Part 10. Refinement GUI</a> <br>  <a href="http://habrahabr.ru/post/227791/">Part 11. Filter</a> <br>  <a href="http://habrahabr.ru/post/227827/">Part 12. Low-frequency oscillator</a> <br>  <a href="http://habrahabr.ru/post/228267/">Part 13. Redesign</a> <br>  <a href="http://habrahabr.ru/post/231513/">Part 14. Polyphony 1</a> <br>  <a href="http://habrahabr.ru/post/231923/">Part 15. Polyphony 2</a> <br>  <a href="http://habrahabr.ru/post/232153/">Part 16. Antialiasing</a> <br><hr><br><br>  Let's take a closer look at our test project.  The most important files are <i>resource.h</i> , <i>MyFirstPlugin.h</i> and <i>MyFirstPlugin.cpp</i> .  At the moment, the plugin is a simple volume control. <br><a name="habracut"></a><br><br><h2>  Learning code </h2>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Constants, flags and image sources </h3><br><br>  Open in <i>resource.h</i> navigator.  This file contains such constants as the name of the plug-in, its version, unique ID, and links to image sources for the GUI.  In lines 23-26, you can register a unique ID: <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// 4 chars, single quotes. At least one capital letter #define PLUG_UNIQUE_ID 'Ipef' // make sure this is not the same as BUNDLE_MFR #define PLUG_MFR_ID 'Acme'</span></span></code> </pre> <br><br>  ID is important for general plug-in cataloging.  You can register it <a href="http://service.steinberg.de/databases/plugin.nsf/plugIn%3FopenForm">here</a> .  Lines 56 and further define the ID and the path to the image for the volume knob that you see when launching the plug-in: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Unique IDs for each image resource. #define KNOB_ID 101 // Image resource locations for this plug. #define KNOB_FN "resources/img/knob.png"</span></span></code> </pre><br><br>  Find in the navigator and open <i>Resources ‚Üí img ‚Üí knob.png</i> .  This is a sprite with sixty different handle positions, each 48 by 48 pixels in size.  When you launch the plugin and twist the knob, the knob image does not rotate.  The program only shows the corresponding part of this sprite. <br>  Why doesn't it rotate?  Imagine that the pen has some notches and casts a shadow.  Then, while rotating, the shadow will also spin.  This does not really happen, as you (hopefully) know. <br><br>  Below in resource.h you can set the size of the plugin window: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GUI_WIDTH 300 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GUI_HEIGHT 300</span></span></code> </pre><br><br>  Play around with the values ‚Äã‚Äãand run the plugin. <br><br><h3>  Plugin class interface </h3><br><br>  Open <i>MyFirstPlugin.h</i> .  It contains the interface for the plugin class.  The <code>public</code> part includes a constructor, a destructor, and three member functions of the class: <br><br><ul><li>  <code>Reset</code> is called when the sample rate changes. </li><li>  <code>OnParamChange</code> is called when the plug-in parameters change, for example, when we twist the handle. </li><li>  <code>ProcessDoubleReplacing</code> is the core of the plugin.  It is in it that the incoming audio is processed. </li></ul><br><br>  In the <code>private</code> part there is only a <code>double</code> variable that stores the current volume value. <br><br><h3>  Implementation </h3><br><br>  Go to the interesting part!  Open <i>MyFirstPlugin.cpp</i> .  We immediately see an interesting trick with the <code>enum</code> type: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> EParams { kGain = <span class="hljs-number"><span class="hljs-number">0</span></span>, kNumParams };</code> </pre><br><br>  By setting <code>kGain = 0</code> and putting <code>kNumParams</code> after it, <code>kNumParams</code> becomes the number of parameters for the plugin (in this case, 1). <br>  The following <code>enum</code> uses the constants described in <i>resource.h</i> and sets the handle coordinates in the plugin window: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> ELayout { kWidth = GUI_WIDTH, kHeight = GUI_HEIGHT, kGainX = <span class="hljs-number"><span class="hljs-number">100</span></span>, kGainY = <span class="hljs-number"><span class="hljs-number">100</span></span>, kKnobFrames = <span class="hljs-number"><span class="hljs-number">60</span></span> };</code> </pre><br><br>  It also defines the number of frames in <i>knob.png</i> equal to 60. <br>  Next begins the implementation of the constructor.  The attributes of the plugin are set: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//arguments are: name, defaultVal, minVal, maxVal, step, label GetParam(kGain)-&gt;InitDouble("Gain", 50., 0., 100.0, 0.01, "%");</span></span></code> </pre><br><br>  In the GUI, neither the value nor the percent icon is visible yet, but the value can vary from <code>0</code> to <code>100</code> .  The default value is <code>50</code> .  You may notice that the gradation of values ‚Äã‚Äãis not uniform on the circle.  This is because of <code>SetShape(2.)</code> .  If this is replaced with <code>SetShape(1.)</code> , Then the distribution of values ‚Äã‚Äãwill be linear.  <code>SetShape</code> sets non-linear behavior. <br>  Next, the designer creates the graphic context of the desired size and sets the background color to red: <br><br><pre> <code class="cpp hljs">IGraphics* pGraphics = MakeGraphics(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, kWidth, kHeight); pGraphics-&gt;AttachPanelBackground(&amp;COLOR_RED);</code> </pre><br><br>  After that, the <i>knob.png is</i> loaded, a new <i>IKnobMultiControl</i> is created with the image and tied to the GUI.  <code>IKnobMultiControl</code> is a class for interface handles. <br>  Notice how the kKnobFrames parameter is passed to indicate the number of frames in the sprite: <br><br><pre> <code class="cpp hljs">IBitmap knob = pGraphics-&gt;LoadIBitmap(KNOB_ID, KNOB_FN, kKnobFrames); pGraphics-&gt;AttachControl(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IKnobMultiControl(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, kGainX, kGainY, kGain, &amp;knob));</code> </pre><br><br>  Finally, the constructor binds the graphics context and creates a default preset for the plugin: <br><br><pre> <code class="cpp hljs">MakeDefaultPreset((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *) <span class="hljs-string"><span class="hljs-string">"-"</span></span>, kNumPrograms);</code> </pre><br><br>  <code>OnParamChange</code> look at <code>OnParamChange</code> (at the end of the file).  <code>IMutexLock</code> provides <a href="http://ru.wikipedia.org/wiki/Thread-safety">streaming security</a> - a concept that we will examine later.  Everything else is just a set of options depending on which parameter is changed: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> kGain: mGain = GetParam(kGain)-&gt;Value() / <span class="hljs-number"><span class="hljs-number">100.</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;</code> </pre><br><br>  As we remember, <code>kGain</code> changes from 0 to 100. So after dividing the value by 100, we assign the value from 0 to 1 to a <code>private</code> member of the <code>mGain</code> class. <br><br>  So, we have a little dismantled the process of creating a GUI and binding to it parameters such as <code>mGain</code> .  Let's now take a look at how the plugin handles incoming audio.  In our case, the audio stream is a sequence of samples represented by a <code>double</code> data type, each of which contains the signal amplitude value at a given point in time. <br>  The first parameter passed to the <code>ProcessDoubleReplacing</code> function is <code>double** inputs</code> .  You can pass a sequence of <code>double</code> using <code>double*</code> .  But the plugin processes two channels (stereo) or even more, so we need several sequences of samples, and we report this with <code>double**</code> .  The first two lines in the function illustrate this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">double</span></span>* in1 = inputs[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>* in2 = inputs[<span class="hljs-number"><span class="hljs-number">1</span></span>];</code> </pre><br><br>  <code>in1</code> indicates the first sequence of samples (left channel), <code>in2</code> indicates the samples of the right channel.  After performing similar actions for the output buffer, we can iterate over the elements of the input and output buffers: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> s = <span class="hljs-number"><span class="hljs-number">0</span></span>; s &lt; nFrames; ++s, ++in1, ++in2, ++out1, ++out2) { *out1 = *in1 * mGain; *out2 = *in2 * mGain; }</code> </pre><br><br>  For each sample, we take the input value, multiply it by <code>mGain</code> and write it to the output buffer.  <code>nFrames</code> tells us how many samples per channel there are, so that we know the length of the buffers. <br>  You may have noticed that when you run the plugin as a standalone application, you can hear yourself from the speakers, if the computer has a built-in microphone.  This is due to the fact that by default the application uses this microphone as an input source.  To change this (and something else), go to the <i>preferences</i> : <br><br><br><br><br><br>  Set breakpoint in <code>Reset</code> function.  Change the <i>Sampling Rate</i> on the right and apply the changes.  The debugger will abort the execution of the code in the <code>Reset</code> function.  Bottom right where <code>lldb</code> works. Enter <code>print GetSampleRate()</code> . <br><br><br><br>  Note that you can also call any function from the debugger and see the correct values.  Click <i>Stop</i> at the top left when you look at it and decide to continue. <br>  Now it's time to create a plugin from code and upload it to the host.  This will be the topic of the next post. <br>  For now <br><br><h3>  Additional reading </h3><br><br>  To fill in some of the gaps, I highly recommend reading <a href="http://olilarkin.blogspot.de/2012/01/m4u-convention-iplug-workshop-slides.html">these slides by the</a> ingenious Mr. Oli Larkin.  They contain some of the key explanations about the <i>WDL-OL</i> . <br><br>  Original article: <br>  <a href="http://martin-finke.de/blog/articles/audio-plugins-003-examining-the-code/">martin-finke.de/blog/articles/audio-plugins-003-examining-the-code</a> </div><p>Source: <a href="https://habr.com/ru/post/225019/">https://habr.com/ru/post/225019/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../225007/index.html">In Asterisk version 12 appeared REST interface (Asterisk REST Interface - ARI)</a></li>
<li><a href="../225009/index.html">3G SG-1CR video recorder</a></li>
<li><a href="../225013/index.html">Functional typology</a></li>
<li><a href="../225015/index.html">Experiments in the genre of match3, ‚ÄúHunger Games‚Äù from Kabam and updated HockeyApp - the main mobile news of the week</a></li>
<li><a href="../225017/index.html">Post inspiration: the best time to start your own business</a></li>
<li><a href="../225021/index.html">How to earn income from Google Play to the account of LLC</a></li>
<li><a href="../225025/index.html">Analysis of the tasks of the fourth qualifying round of the Russian Code Cup 2014</a></li>
<li><a href="../225027/index.html">How to cook hundreds of bases 1C and not go crazy</a></li>
<li><a href="../225031/index.html">Chasing the chairs</a></li>
<li><a href="../225033/index.html">x264 + VirtualDub vs XviD. Explore opportunities, increase efficiency</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>