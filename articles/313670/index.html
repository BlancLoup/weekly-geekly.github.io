<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Go for the record: Chromium fifth check</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It would seem that Chromium was considered by us repeatedly. The attentive reader will ask a logical question: ‚ÄúWhy do we need another check? Wasn‚Äôt i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Go for the record: Chromium fifth check</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/f5e/8a1/f46/f5e8a1f46052cffe7cdf1b1dc0120cc7.png" align="left">  It would seem that Chromium was considered by us repeatedly.  The attentive reader will ask a logical question: ‚ÄúWhy do we need another check?  Wasn‚Äôt it enough? ‚Äù  Undoubtedly, the Chromium code is distinguished by its purity, which we were convinced of every time we checked, but errors inevitably continue to be detected.  Repeated checks well demonstrate that the more often static analysis is applied, the better.  Well, if the project is checked every day.  It is even better if the analyzer is used by programmers directly at work (automatic analysis of the modified code). <br><a name="habracut"></a><br><h2>  A bit of background </h2><br>  Chromium has already been tested with PVS-Studio four times: <br><br><ul><li>  <a href="http://www.viva64.com/ru/a/0074/">first check</a> (05/23/2011) </li><li>  <a href="http://www.viva64.com/ru/b/0113/">the second check</a> (10/13/2011) </li><li>  <a href="http://www.viva64.com/ru/b/0205/">the third check</a> (08/12/2013) </li><li>  <a href="http://www.viva64.com/ru/b/0225/">the fourth check</a> (02.12.2013) </li></ul><br>  Previously, all checks were performed by the Windows version of the PVS-Studio analyzer.  Recently, PVS-Studio works under Linux, so this version was used for analysis. <br><br>  During this time, the project grew in size: in the third test, the number of projects reached 1169. At the time of writing, their number was 4420. The size of the source code grew noticeably to 370 MB (in 2013, the size was 260 MB). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For four checks, the highest quality code for such a large project was noted.  Has the situation changed after two and a half years?  Not.  The quality is still on top.  However, due to the large amount of code and its continuous development, we again find many errors. <br><br><h2>  How to check? </h2><br>  Let us dwell on how to make a test Chromium.  This time we will do it in Linux.  After downloading the sources using depot_tools and preparing (more details <a href="https://www.chromium.org/developers/how-tos/get-the-code">here</a> , before the Building section) we build the project: <br><br><pre><code class="cpp hljs">pvs-studio-analyzer trace -- ninja -C out/Default chrome</code> </pre> <br>  Next, execute the command (this is one line): <br><br><pre> <code class="cpp hljs">pvs-studio-analyzer analyze -l /path/to/PVS-Studio.lic -o /path/to/save/chromium.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> -j&lt;N&gt;</code> </pre> <br>  where the "-j" flag starts the analysis in multi-threaded mode.  The recommended number of threads is the number of physical CPU cores plus one (for example, on a quad-core processor, the flag will look like "-j5"). <br><br>  As a result, a report of the PVS-Studio analyzer will be received.  Using the PlogConverter utility, which comes as part of the PVS-Studio distribution, it can be converted to one of three readable formats: xml, errorfile, tasklist.  We will use tasklist for viewing messages.  In the current check, only general purpose warnings (General Analysis) of all levels (High, Medium, Low) will be viewed.  The conversion command will look like this (in one line): <br><br><pre> <code class="cpp hljs">plog-converter -t tasklist -o /path/to/save/chromium.tasks -a GA:<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span> /path/to/saved/chromium.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span></code> </pre> <br>  More information about all the parameters of PlogConverter can be found <a href="http://www.viva64.com/ru/m/0036/">here</a> .  The tasklist load ‚Äúchromium.tasks‚Äù in QtCreator (must be pre-installed) is performed using the command: <br><br><pre> <code class="cpp hljs">qtcreator path/to/saved/chromium.tasks</code> </pre> <br>  It is highly recommended to start viewing the report with High and Medium level alerts - the probability that there will be erroneous instructions in the code will be very high.  Low level warnings can also indicate potential errors, but they have a higher probability of false positives, so they are usually not studied when writing articles. <br><br>  The report view in QtCreator itself will look like this: <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/d04/bc8/fed/d04bc8fed8ef7781cb704229b25b6211.png"></a> </div><br>  <font color="#999999"><i>Figure 1 - Working with the results of the analyzer from under QtCreator (click on image to enlarge)</i></font> <br><br><h2>  What did the analyzer tell? </h2><br>  After checking the Chromium project, 2312 warnings were received.  The following diagram shows the distribution of warnings by severity level: <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0a4/cf7/546/0a4cf7546649ad338be9c6cd09330a95.png"></div><br>  <font color="#999999"><i>Figure 2 - Distribution of alerts by severity level</i></font> <br><br>  We briefly comment on the diagram: 171 warnings of the High level were received, 290 warnings of the Medium level, 1851 warnings of the Low level. <br><br>  Despite the rather large number of warnings, for such a giant project it is not much.  The total number of lines of the source code (SLOC) without libraries is 6468751. If we take into account only the warnings of the High and Medium levels, then among them I can probably point out 220 true errors.  Figures are numbers, but in fact we get an error density of 0.034 errors per 1000 lines of code.  This, of course, is not the density of all errors, but only those that PVS-Studio finds.  Or rather, the mistakes that I noticed while viewing the report. <br><br>  As a rule, on other projects we get <i>the</i> greater density of errors found.  The developers of Chromium are great!  However, you should not relax: there are mistakes, and they are far from harmless. <br><br>  Let us consider in more detail the most interesting errors. <br><br><h2>  New bugs found </h2><br><h3>  Copy paste </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a26/782/480/a26782480019ef7706cbba46bdf64b6c.png"></div><br><br>  <b>Analyzer Warning</b> : <a href="http://www.viva64.com/ru/w/V501/">V501</a> There are identical sub-expressions 'request_body_send_buf_ == nullptr' the operator.  http_stream_parser.cc 1222 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> HttpStreamParser::SendRequestBuffersEmpty() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request_headers_ == <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span> &amp;&amp; request_body_send_buf_ == <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span> &amp;&amp; request_body_send_buf_ == <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;= }</span></span></code> </pre> <br>  Classics of the genre.  The programmer compared the <i>request_body_send_buf_</i> pointer to <i>nullptr twice</i> .  This is probably a typo, and some member of the class should have been compared with <i>nullptr</i> . <br><br>  <b>Analyzer Warning</b> : <a href="http://www.viva64.com/ru/w/V766/">V766</a> An item with the same key '"colorSectionBorder"' has already been added.  ntp_resource_cache.cc 581 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> NTPResourceCache::CreateNewTabCSS() { .... substitutions[<span class="hljs-string"><span class="hljs-string">"colorSectionBorder"</span></span>] = <span class="hljs-comment"><span class="hljs-comment">// &lt;= SkColorToRGBAString(color_section_border); .... substitutions["colorSectionBorder"] = // &lt;= SkColorToRGBComponents(color_section_border); .... }</span></span></code> </pre> <br>  The analyzer reports a suspicious double initialization of the object using the <i>‚ÄúcolorSectionBorder‚Äù</i> key.  The variable <i>substitutions</i> in this context is an associative array.  In the first initialization, the <i>color_section_border</i> variable of the <i>SkColor</i> type (defined as <i>uint32_t</i> ) is translated into the string representation of RGBA (judging from the name of the <i>SkColorToRGBAString</i> method) and stored by the <i>‚ÄúcolorSectionBorder‚Äù</i> key.  When reassigning, <i>color_section_border is</i> converted to another string format ( <i>SkColorToRGBComponents</i> method) and is written using the same key.  This means that the previous value for the key <i>"colorSectionBorder"</i> will be destroyed.  Perhaps it was conceived, but then one of the initializations should be removed.  Otherwise, you should save the color components by a different key. <br><br>  <b>Note.</b>  By the way, this is the first error found using the <a href="http://www.viva64.com/ru/w/V766/">V766</a> diagnostics in a real project.  The type of error is quite specific, but the Chromium project is so large that you can meet exotic defects in it. <br><br><h3>  Incorrect work with pointers </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3d3/583/86a/3d358386a52e59e666ce4222faf703a8.png"></div><br>  I suggest that readers warm up a little and try to find a mistake on their own. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Returns the item associated with the component |id| or nullptr // in case of errors. CrxUpdateItem* FindUpdateItemById(const std::string&amp; id) const; void ActionWait::Run(UpdateContext* update_context, Callback callback) { .... while (!update_context-&gt;queue.empty()) { auto* item = FindUpdateItemById(update_context-&gt;queue.front()); if (!item) { item-&gt;error_category = static_cast&lt;int&gt;(ErrorCategory::kServiceError); item-&gt;error_code = static_cast&lt;int&gt;(ServiceError::ERROR_WAIT); ChangeItemState(item, CrxUpdateItem::State::kNoUpdate); } else { NOTREACHED(); } update_context-&gt;queue.pop(); } .... }</span></span></code> </pre> <br>  <b>Analyzer Warning</b> : <a href="http://www.viva64.com/ru/w/V522/">V522</a> Dereferencing of the null pointer 'item' might take place.  action_wait.cc 41 <br><br>  Here the programmer decided to shoot his leg in an obvious way.  In the code, the <i>queue</i> is sequentially bypassed, which contains identifiers in string representations.  The identifier is retrieved from the queue, then the <i>FindUpdateItemById</i> method must return a pointer to an object of type <i>CrxUpdateItem</i> by identifier.  If an error occurs in the <i>FindUpdateItemById</i> method, a <i>nullptr</i> will be returned, which will then be de-signed in the <i>then</i> branch of the <i>if statement</i> . <br><br>  The correct code might look like this: <br><br><pre> <code class="cpp hljs">.... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!update_context-&gt;<span class="hljs-built_in"><span class="hljs-built_in">queue</span></span>.empty()) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span>* item = FindUpdateItemById(update_context-&gt;<span class="hljs-built_in"><span class="hljs-built_in">queue</span></span>.front()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (item != <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) { .... } .... } ....</code> </pre> <br>  <b>Analyzer Warning</b> : <a href="http://www.viva64.com/ru/w/V620/">V620</a>  string_conversion.cc 62 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UTF8ToUTF16Char</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *in, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> in_length, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> out[</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">])</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> UTF8 *source_ptr = <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> UTF8 *&gt;(in); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> UTF8 *source_end_ptr = source_ptr + <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> *target_ptr = out; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> *target_end_ptr = target_ptr + <span class="hljs-number"><span class="hljs-number">2</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span>); <span class="hljs-comment"><span class="hljs-comment">// &lt;= out[0] = out[1] = 0; .... }</span></span></code> </pre> <br>  The analyzer detected a code with a suspicious address arithmetic.  As the name implies, the function converts a character from UTF-8 to UTF-16.  The current Unicode 6.x standard implies a UTF-8 character extension to four bytes.  In this regard, a UTF-8 character is decoded as 2 UTF-16 characters (a UTF-16 character is hard-coded by two bytes).  For decoding, 4 pointers are used - pointers to the beginning and end of the arrays <i>in</i> and <i>out</i> .  Pointers to the end of arrays in the code act like STL iterators: they refer to the memory area behind the last element in the array.  If in the case of <i>source_end_ptr the</i> pointer was received correctly, then with <i>target_end_ptr</i> everything is not so rosy.  The implication was that he had to refer to the memory area behind the second element of the <i>out</i> array (that is, move relative to the <i>out</i> pointer by 4 bytes), but instead the pointer would refer to the memory area behind the fourth element (8 out byte). <br><br>  We illustrate the words spoken, as it should have been: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4a4/ff3/b6b/4a4ff3b6b90b8af393eb95819b32a6af.png"></div><br><br>  How did it actually happen: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/06a/3b9/7c9/06a3b97c90b6d54f194899d76d1e719e.png"></div><br><br>  The correct code should look like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UTF8ToUTF16Char</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *in, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> in_length, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> out[</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">])</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> UTF8 *source_ptr = <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> UTF8 *&gt;(in); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> UTF8 *source_end_ptr = source_ptr + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> *target_ptr = out; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> *target_end_ptr = target_ptr + <span class="hljs-number"><span class="hljs-number">2</span></span>; out[<span class="hljs-number"><span class="hljs-number">0</span></span>] = out[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; .... }</code> </pre> <br>  The analyzer also found another suspicious location: <br><br><ul><li>  <i>V620 It is unusual that it can be summed with the pointer to the T type.</i>  <i>string_conversion.cc 106</i> </li></ul><br><h3>  Various errors </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/eac/0c4/998/eac0c4998963a496e715b6cc06412173.png"></div><br><br>  I propose to warm up again and try to find an error in the code yourself. <br><br><pre> <code class="cpp hljs">CheckReturnValue&amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>=(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CheckReturnValue&amp; other) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> != &amp;other) { DCHECK(checked_); value_ = other.value_; checked_ = other.checked_; other.checked_ = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }</code> </pre> <br>  <b>Analyzer warning</b> : <a href="http://www.viva64.com/ru/w/V591/">V591</a> Non-void function should return a value.  memory_allocator.h 39 <br><br>  <a href="http://www.viva64.com/ru/t/0066/">Undefined behavior</a> occurs in the code above: the C ++ standard says that any non-void method should return a value.  What is the code above?  The assignment operator checks for assignment to itself (comparison of objects by their pointers) and copying fields (if the pointers are different).  However, the method did not return a reference to itself ( <i>return * this</i> ). <br><br>  There are a couple more places in the project where the non-void method does not return values: <br><br><ul><li>  <i>V591 Non-void function should return a value.</i>  <i>sandbox_bpf.cc 115</i> </li><li>  <i>V591 Non-void function should return a value.</i>  <i>events_x.cc 73</i> </li></ul><br>  <b>Analyzer warning</b> : <a href="http://www.viva64.com/ru/w/V583/">V583</a> The '?:' Operator, regardless of its conditional expression, always returns one and the same value: 1. configurator_impl.cc 133 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ConfiguratorImpl::StepDelay() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fast_update_ ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br>  The code always returns a delay equal to one.  Perhaps this is a reserve for the future, but so far there is no use for such a ternary operator. <br><br>  <b>Analyzer Warning</b> : Consider <a href="http://www.viva64.com/ru/w/V590/">Inspecting</a> the 'rv == OK ||  rv! = ERR_ADDRESS_IN_USE 'expression.  The expression is misprint.  udp_socket_posix.cc 735 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> UDPSocketPosix::RandomBind(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> IPAddress&amp; address) { DCHECK(bind_type_ == DatagramSocket::RANDOM_BIND &amp;&amp; !rand_int_cb_.is_null()); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; kBindRetries; ++i) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rv = DoBind(IPEndPoint(address, rand_int_cb_ .Run(kPortStart, kPortEnd))); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rv == OK || rv != ERR_ADDRESS_IN_USE) <span class="hljs-comment"><span class="hljs-comment">// &lt;= return rv; } return DoBind(IPEndPoint(address, 0)); }</span></span></code> </pre> <br>  The analyzer warns of possible excessive comparison.  In the code, a random port is bound to an IP address.  If the binding is successful, the loop stops (which means the number of attempts to bind the port to the address).  Based on the logic, you can leave one of the comparisons (now the cycle stops, if the binding is successful, or if the port is not returned using a different address). <br><br>  <b>Analyzer Warning</b> : <a href="http://www.viva64.com/ru/w/V523/">V523</a> The 'then' statement is equivalent to the 'else' statement. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> ResourcePrefetcher::ShouldContinueReadingRequest( net::URLRequest* request, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bytes_read ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bytes_read == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// When bytes_read == 0, no more data. if (request-&gt;was_cached()) FinishRequest(request); // &lt;= else FinishRequest(request); // &lt;= return false; } return true; }</span></span></code> </pre> <br>  The analyzer reported similar statements in the <i>then</i> and <i>else</i> branches of an <i>if statement</i> .  What can this lead to?  Based on the code, the non-cached URL request ( <i>net :: URLRequest * request</i> ) will be completed in the same way as the cached one.  If it should be like this, then you can remove the branch statement: <br><br><pre> <code class="cpp hljs">.... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bytes_read == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// When bytes_read == 0, no more data. FinishRequest(request); // &lt;= return false; } ....</span></span></code> </pre> <br>  If another logic was implied, then the wrong method would be called that could lead to "sleepless nights" and "coffee sea". <br><br>  <b>Analyzer Warning</b> : <b><a href="http://www.viva64.com/ru/w/V609/">V609</a></b> Divide by zero.  Denominator range [0..4096].  addr.h 159 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BlockSizeForFileType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FileType file_type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (file_type) { .... <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;= } } static int RequiredBlocks(int size, FileType file_type) { int block_size = BlockSizeForFileType(file_type); return (size + block_size - 1) / block_size; // &lt;= }</span></span></code> </pre> <br>  What do we see here?  This code can lead to a subtle error: the <i>RequiredBlocks</i> method is divided by the value of the <i>block_size</i> variable (calculated using the <i>BlockSizeForFileType</i> method).  In the <i>BlockSizeForFileType</i> method, the transferred value of the <i>FileType</i> enumeration in the <i>switch</i> operator returns some value, however, the default value of 0 was also provided. Suppose that the <i>FileType</i> enumeration decided to expand and added a new value but did not add a new <i>case</i> branch in the <i>switch</i> operator .  This will lead to undefined behavior: according to the C ++ standard, division by zero does not cause a program exception.  Instead, a hardware exception will be triggered, which is not caught by the standard <i>try</i> / <i>catch block</i> (signal handlers are used instead, you can read more <a href="http://www.cplusplus.com/reference/csignal/">here</a> and <a href="http://www.yolinux.com/TUTORIALS/C%2B%2BSignals.html">here</a> ). <br><br>  <b>Analyzer warning</b> : <b><a href="http://www.viva64.com/ru/w/V519/">V519</a></b> The '* list' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 136, 138. util.cc 138 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetListName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ListType list_id, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">* </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">list</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (list_id) { .... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> IPBLACKLIST: *<span class="hljs-built_in"><span class="hljs-built_in">list</span></span> = kIPBlacklist; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> UNWANTEDURL: *<span class="hljs-built_in"><span class="hljs-built_in">list</span></span> = kUnwantedUrlList; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MODULEWHITELIST: *<span class="hljs-built_in"><span class="hljs-built_in">list</span></span> = kModuleWhitelist; <span class="hljs-comment"><span class="hljs-comment">// &lt;= case RESOURCEBLACKLIST: *list = kResourceBlacklist; break; default: return false; } .... }</span></span></code> </pre> <br>  A typical mistake when writing a <i>switch-</i> operator.  It is expected that if the <i>list_id</i> variable takes the value <i>MODULEWHITELIST</i> from the <i>ListType</i> enumeration, the string at the <i>list</i> pointer is initialized with the value of <i>kModuleWhitelist</i> and the <i>switch-</i> operator is interrupted.  However, due to the missing <i>break</i> statement, the transition to the next <i>RESOURCEBLACKLIST</i> branch will occur, and the string <i>kResourceBlacklist</i> will actually be saved in * <i>list</i> . <br><br><h2>  findings </h2><br>  Chromium remains a tough nut to crack.  Still, the PVS-Studio analyzer may again and again find errors in it.  When using static analysis methods, errors can be found at the stage of writing code, before the testing stage. <br><br>  What tools can I use for static code analysis?  In fact, <a href="https://en.wikipedia.org/wiki/List_of_tools_for_static_code_analysis">a lot of tools</a> .  I naturally suggest trying PVS-Studio: the product is very conveniently integrated into the Visual Studio environment, or perhaps it can be used with any build system.  And more recently, the version for Linux has become available.  More information about the Windows and Linux versions can be found <a href="http://www.viva64.com/ru/pvs-studio/">here</a> and <a href="http://www.viva64.com/ru/b/0415/">here</a> . <br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0442/"><img src="https://habrastorage.org/getpro/habr/post_images/35e/064/ddf/35e064ddf91f5d99b620384893909ff7.png"></a> </div><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Phillip Khandeliants.  <a href="http://www.viva64.com/en/b/0442/">Heading for a Record: Chromium, the 5th Check</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/313670/">https://habr.com/ru/post/313670/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../313658/index.html">Node.js 7.0.0 is released. Meet async / await without babel</a></li>
<li><a href="../313660/index.html">Experience of installing Apple iBeacon & Google Physical Web beacons in the Semenovsky shopping mall in Moscow</a></li>
<li><a href="../313664/index.html">Mobile traffic arbitration: methods and approaches</a></li>
<li><a href="../313666/index.html">Scalable nginx configuration</a></li>
<li><a href="../313668/index.html">How to write in English scientific articles in journals and applications for grants</a></li>
<li><a href="../313672/index.html">Lord of storage</a></li>
<li><a href="../313674/index.html">Secrets of Progressive Web Apps: Part 2</a></li>
<li><a href="../313676/index.html">Determine the user's location by IP and create a hit counter</a></li>
<li><a href="../313678/index.html">Cyber-grouping Sednit activities under a microscope - Part 2</a></li>
<li><a href="../313680/index.html">We control the standard Sailfish OS player using voice commands</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>