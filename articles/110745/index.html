<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mikrotik Router OS, script for dynamic speed division</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mikrotik Router OS, a script for dynamic speed division. 

 The other day, the following problem arose: to divide the speed equally between all users,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mikrotik Router OS, script for dynamic speed division</h1><div class="post__text post__text-html js-mediator-article"><h4>  Mikrotik Router OS, a script for dynamic speed division. </h4><br><br>  The other day, the following problem arose: to divide the speed equally between all users, so that the speed was not allocated to customers who currently do not use the Internet, but to give to everyone else, so that with a large number of customers and a narrow channel, they get some kind of ‚Äúbuffering‚Äù channel. <a name="habracut"></a><br><br>  Having carefully studied a handful of manuals, I came to the conclusion that without raising the script in the internal language of Router OS can not do. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The script works only with VPN clients, since  I did not find a way to work with individual IP. <br><br>  So let's go! <br><br><h5>  An example of three PPTP users, primary configuration </h5><br>  Addresses of users 192.168.70.10-192.168.70.12 <br>  Server address 192.168.70.1 <br><br>  Add three users: <br><br> <code>/ ppp secret add name="user1" service=pptp password="null" profile=default-encryption local address=192.168.70.1 remote-address=192.168.70.10 disabled=no <br> / ppp secret add name="user2" service=pptp password="null" profile=default-encryption local-address=192.168.70.1 remote-address=192.168.70.11 disabled=no <br> / ppp secret add name="user3" service=pptp password="null" profile=default-encryption local-address=192.168.70.1 remote-address=192.168.70.12 disabled=no <br></code> <br><br>  Add to each of the users on the interface, the interface name and user name must match! <br><br> <code>/ interface pptp-server add name="user1" user="user1" disabled=no <br> / interface pptp-server add name="user2" user="user2" disabled=no <br> / interface pptp-server add name="user3" user="user3" disabled=no <br></code> <br><br>  Mangle, I don‚Äôt know why, but in all examples the specialists first mark the connection, and then mark the packages in it, maybe I don‚Äôt quite understand the whole depth of thought, but I don‚Äôt see a special point in this and mark the packages right away in the general stream, because .  every extra rule noticeably slows down the system.  Attention!  the value of new-packet-mark should be ‚Äúusername / server‚Äù + ‚Äú_ down‚Äù and ‚Äú_up‚Äù, respectively. <br><br> <code>/ ip firewall mangle add chain=forward src-address=192.168.70.10 dst-address=0.0.0.0/0 action=mark-packet new-packet-mark=user1_up passthrough=no disabled=no <br> / ip firewall mangle add chain=forward src-address=192.168.70.11 dst-address=0.0.0.0/0 action=mark-packet new-packet-mark=user2_up passthrough=no disabled=no <br> / ip firewall mangle add chain=forward src-address=192.168.70.12 dst-address=0.0.0.0/0 action=mark-packet new-packet-mark=user3_up passthrough=no disabled=no <br> <br> / ip firewall mangle add chain=forward src-address=0.0.0.0/0 dst-address=192.168.70.10 action=mark-packet new-packet-mark=user1_down passthrough=no disabled=no <br> / ip firewall mangle add chain=forward src-address=0.0.0.0/0 dst-address=192.168.70.11 action=mark-packet new-packet-mark=user2_down passthrough=no disabled=no <br> / ip firewall mangle add chain=forward src-address=0.0.0.0/0 dst-address=192.168.70.12 action=mark-packet new-packet-mark=user3_down passthrough=no disabled=no <br></code> <br><br>  The next step is to build a tree in Queue.  All traffic restrictions will occur in it. <br><br> <code>/ queue tree add name="Download" parent=global-out limit-at=0 queue=hotspot-default priority=8 max-limit=0 burst-limit=0 burst-threshold=0 burst-time=0s disabled=no <br> / queue tree add name="user1_down" parent=Download packet-mark=user1_down disabled=no <br> / queue tree add name="user2_down" parent=Download packet-mark=user2_down disabled=no <br> / queue tree add name="user3_down" parent=Download packet-mark=user3_down disabled=no <br> <br> / queue tree add name="Upload" parent=global-out limit-at=0 queue=hotspot-default priority=8 max-limit=0 burst-limit=0 burst-threshold=0 burst-time=0s disabled=no <br> / queue tree add name="user1_up" parent=Upload packet-mark=user1_up disabled=no <br> / queue tree add name="user2_up" parent=Upload packet-mark=user2_up disabled=no <br> / queue tree add name="user3_up" parent=Upload packet-mark=user3_up disabled=no <br></code> <br><br>  The last step is to configure the computational part of the script and place it in the system scheduler, with an interval of 10-60 seconds.  depending on the performance of your microtic, the smaller the interval - the better. <br><br><h5>  Variables and some features of the computing part </h5><br> <code>MaxRateDownload -     () <br> MaxRateUpload -     () <br> ActiveThresholddown -        () <br> ActiveThresholdup -         () <br> ParentDownload -  () <br> ParentUpload -   () <br></code> <br><br> <code>:local MaxRateDownload ("2000000"); <br> :local MaxRateUpload ("2000000"); <br></code> <br><br>  It should be set slightly less than the width of your channel in order to avoid brakes when another user is active, who has not consumed the Internet before. <br><br> <code>:local ActiveThresholddown ("5000"); <br> :local ActiveThresholdup ("5000"); <br></code> <br><br>  Set these values ‚Äã‚Äãaccording to your needs, but based on the calculation: the number of users multiplied by Thresholddown = should not exceed MaxRateDownload otherwise your users will always be inactive!  Naturally users * ActiveThresholdup = should not exceed MaxRateUpload.  Always leave some stock. <br><br><h5>  The principle of the script </h5><br>  The script measures how fast the client is running and if it exceeds ActiveThresholddown, adds it as an active one to receive, <br>  it also increases the counter if the user is connected to his account's PPTP. <br>  Next, the script checks ActiveThresholdup, if the user has exceeded this mark, then adds it as active for feedback. <br><br>  If the number of active clients is zero, it changes it to one, for later to make mathematical calculations, and then something is not divided by zero :) <br><br>  Calculates: <br>  MaxRateDownload divides by the number of active users to receive, displays the speed per user. <br>  MaxRateUpload divides by the number of active users per share, displays the speed per user. <br><br>  Next, it sets a limit to all users in the Queue Tree, as calculated above. <br><br>  Next, it calculates the value in kilobits and displays statistics in the log. <br><br><h5>  Script code </h5><br>  For different versions of Router OS, you need your own version of the script.  This is due to the fact that the internal syntax of the language gradually evolves and thus does not always please users. <br><br><h6>  Script code for versions 2.9.xx: </h6><br> <code>###################### <br> :local MaxRateDownload ("2000000"); <br> :local MaxRateUpload ("2000000"); <br> :local ActiveThresholddown ("5000"); <br> :local ActiveThresholdup ("5000"); <br> :local ParentDownload ("Download"); <br> :local ParentUpload ("Upload"); <br> ###################### <br> <br> ###################### <br> :local z; <br> :local i; <br> :local ii; <br> :local userX; <br> :global onlineclientsdown (0); <br> :global onlineclientsup (0); <br> :global connected (0); <br> ###################### <br> <br> ###################### <br> :foreach i in=[/ppp active find] do={ :set userX [/ppp active get $i name]; <br> :global connected ($connected+1); <br> /interface monitor-traffic [/interface find name=$userX] once do {:if ($received-bits-per-second&gt;=$ActiveThresholddown) do { :set onlineclientsdown ($onlineclientsdown+1);}} }; <br> <br> :foreach ii in=[/ppp active find] do={ :set userX [/ppp active get $ii name]; <br> /interface monitor-traffic [/interface find name=$userX] once do {:if ($sent-bits-per-second&gt;=$ActiveThresholdup) do { :set onlineclientsup ($onlineclientsup+1);}} }; <br> <br> :if ($onlineclientsdown = 0) do {:set onlineclientsdown (1)}; <br> :if ($onlineclientsup= 0) do {:set onlineclientsup (1)}; <br> <br> :local ratelimitdown ($MaxRateDownload/$onlineclientsdown) <br> :local ratelimitup ($MaxRateUpload/$onlineclientsup) <br> <br> :foreach z in=[/ppp active find] do={ :set userX [/ppp active get $z name]; <br> /queue tree set [/queue tree find name=($userX . "_down")] parent=$ParentDownload packet-mark=($userX . "_down") queue=hotspot-default priority=8 max-limit=$ratelimitdown <br> <br> /queue tree set [/queue tree find name=($userX . "_up")] parent=$ParentUpload packet-mark=($userX . "_up") queue=hotspot-default priority=8 max-limit=$ratelimitup}; <br> ###################### <br> <br> ###################### <br> :local kbsmaxdown ($MaxRateDownload/1000); <br> :local kbsmaxup ($MaxRateUpload /1000); <br> :local kbsthr ($ActiveThresholddown/1000); <br> :local kbsdown ($ratelimitdown/1000); <br> :local kbsup ($ratelimitup/1000); <br> <br> :log warning ("Shaper:"); <br> :log info ("MaxRate Download : " . $MaxRateDownload . " bps /" . $kbsmaxdown . " kbs / Upload : " . $MaxRateUpload . " bps /" . $kbsmaxup . " kbs"); <br> :log info ("Threshold: Download : " . $ActiveThresholddown . " bps /" . $kbsthr . " kbs / Upload : " . $ActiveThresholdup . " bps /" . $kbsthr . " kbs"); <br> :log info ("Connected Users : " . $connected); <br> :log info ("Active Users : Download : " . $onlineclientsdown . " / Upload : " . $onlineclientsup); <br> :log info ("User Speed Download : " . $ratelimitdown . " bps /" . $kbsdown . " kbs / Upload : " . $ratelimitup . " bps /" . $kbsup . " kbs"); <br> ###################### <br> # (C) Inlarion icq 429-587 Copyright! <br></code> <br><br><h6>  Script code for version 3.22: </h6><br> <code>###################### <br> :local MaxRateDownload ("2000000"); <br> :local MaxRateUpload ("2000000"); <br> :local ActiveThresholddown ("5000"); <br> :local ActiveThresholdup ("5000"); <br> :local ParentDownload ("Download"); <br> :local ParentUpload ("Upload"); <br> ###################### <br> <br> ###################### <br> :local z; <br> :local i; <br> :local ii; <br> :local userX; <br> :global onlineclientsdown (0); <br> :global onlineclientsup (0); <br> :global connected (0); <br> ###################### <br> <br> ###################### <br> :foreach i in=[/ppp active find] do={ :set userX [/ppp active get $i name]; <br> :global connected ($connected+1); <br> /interface monitor-traffic [/interface find name=$userX] once do {:if ($"received-bits-per-second"&gt;=$ActiveThresholddown) do { :set onlineclientsdown ($onlineclientsdown+1);}} }; <br> <br> :foreach ii in=[/ppp active find] do={ :set userX [/ppp active get $ii name]; <br> /interface monitor-traffic [/interface find name=$userX] once do {:if ($"sent-bits-per-second"&gt;=$ActiveThresholdup) do { :set onlineclientsup ($onlineclientsup+1);}} }; <br> <br> :if ($onlineclientsdown = 0) do {:set onlineclientsdown (1)}; <br> :if ($onlineclientsup= 0) do {:set onlineclientsup (1)}; <br> <br> :local ratelimitdown ($MaxRateDownload/$onlineclientsdown) <br> :local ratelimitup ($MaxRateUpload/$onlineclientsup) <br> <br> :foreach z in=[/ppp active find] do={ :set userX [/ppp active get $z name]; <br> /queue tree set [/queue tree find name=($userX . "_down")] parent=$ParentDownload packet-mark=($userX . "_down") queue=hotspot-default priority=8 max-limit=$ratelimitdown <br> <br> /queue tree set [/queue tree find name=($userX . "_up")] parent=$ParentUpload packet-mark=($userX . "_up") queue=hotspot-default priority=8 max-limit=$ratelimitup}; <br> ###################### <br> <br> ###################### <br> :local kbsmaxdown ($MaxRateDownload/1000); <br> :local kbsmaxup ($MaxRateUpload /1000); <br> :local kbsthr ($ActiveThresholddown/1000); <br> :local kbsdown ($ratelimitdown/1000); <br> :local kbsup ($ratelimitup/1000); <br> <br> :log warning ("Shaper:"); <br> :log info ("MaxRate Download : " . $MaxRateDownload . " bps /" . $kbsmaxdown . " kbs / Upload : " . $MaxRateUpload . " bps /" . $kbsmaxup . " kbs"); <br> :log info ("Threshold: Download : " . $ActiveThresholddown . " bps /" . $kbsthr . " kbs / Upload : " . $ActiveThresholdup . " bps /" . $kbsthr . " kbs"); <br> :log info ("Connected Users : " . $connected); <br> :log info ("Active Users : Download : " . $onlineclientsdown . " / Upload : " . $onlineclientsup); <br> :log info ("User Speed Download : " . $ratelimitdown . " bps /" . $kbsdown . " kbs / Upload : " . $ratelimitup . " bps /" . $kbsup . " kbs"); <br> ###################### <br> # (C) Inlarion icq 429-587 Copyright! <br></code> <br><br><h6>  Script code for versions 3.30 - 4.x - 5.x: </h6><br> <code>###################### <br> :local MaxRateDownload ("2000000"); <br> :local MaxRateUpload ("2000000"); <br> :local ActiveThresholddown ("5000"); <br> :local ActiveThresholdup ("5000"); <br> :local ParentDownload ("Download"); <br> :local ParentUpload ("Upload"); <br> ###################### <br> <br> ###################### <br> :local z; <br> :local i; <br> :local ii; <br> :local userX; <br> :global onlineclientsdown (0); <br> :global onlineclientsup (0); <br> :global connected (0); <br> ###################### <br> <br> ###################### <br> :foreach i in=[/ppp active find] do={ :set userX [/ppp active get $i name]; <br> :global connected ($connected+1); <br> /interface monitor-traffic [/interface find name=$userX] once do {:if ($"rx-bits-per-second"&gt;=$ActiveThresholddown) do { :set onlineclientsdown ($onlineclientsdown+1);}} }; <br> <br> :foreach ii in=[/ppp active find] do={ :set userX [/ppp active get $ii name]; <br> /interface monitor-traffic [/interface find name=$userX] once do {:if ($"tx-bits-per-second"&gt;=$ActiveThresholdup) do { :set onlineclientsup ($onlineclientsup+1);}} }; <br> <br> :if ($onlineclientsdown = 0) do {:set onlineclientsdown (1)}; <br> :if ($onlineclientsup= 0) do {:set onlineclientsup (1)}; <br> <br> :local ratelimitdown ($MaxRateDownload/$onlineclientsdown) <br> :local ratelimitup ($MaxRateUpload/$onlineclientsup) <br> <br> :foreach z in=[/ppp active find] do={ :set userX [/ppp active get $z name]; <br> /queue tree set [/queue tree find name=($userX . "_down")] parent=$ParentDownload packet-mark=($userX . "_down") queue=hotspot-default priority=8 max-limit=$ratelimitdown <br> <br> /queue tree set [/queue tree find name=($userX . "_up")] parent=$ParentUpload packet-mark=($userX . "_up") queue=hotspot-default priority=8 max-limit=$ratelimitup}; <br> ###################### <br> <br> ###################### <br> :local kbsmaxdown ($MaxRateDownload/1000); <br> :local kbsmaxup ($MaxRateUpload /1000); <br> :local kbsthr ($ActiveThresholddown/1000); <br> :local kbsdown ($ratelimitdown/1000); <br> :local kbsup ($ratelimitup/1000); <br> <br> :log warning ("Shaper:"); <br> :log info ("MaxRate Download : " . $MaxRateDownload . " bps /" . $kbsmaxdown . " kbs / Upload : " . $MaxRateUpload . " bps /" . $kbsmaxup . " kbs"); <br> :log info ("Threshold: Download : " . $ActiveThresholddown . " bps /" . $kbsthr . " kbs / Upload : " . $ActiveThresholdup . " bps /" . $kbsthr . " kbs"); <br> :log info ("Connected Users : " . $connected); <br> :log info ("Active Users : Download : " . $onlineclientsdown . " / Upload : " . $onlineclientsup); <br> :log info ("User Speed Download : " . $ratelimitdown . " bps /" . $kbsdown . " kbs / Upload : " . $ratelimitup . " bps /" . $kbsup . " kbs"); <br> ###################### <br> # (C) Inlarion icq 429-587 Copyright! <br></code> </div><p>Source: <a href="https://habr.com/ru/post/110745/">https://habr.com/ru/post/110745/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../110739/index.html">Personal Finance Management Online in the CIS countries</a></li>
<li><a href="../110740/index.html">Snippet catalogView for MODx Evolution</a></li>
<li><a href="../110741/index.html">Several foreign services to communicate with Santa Claus / Santa Claus</a></li>
<li><a href="../110742/index.html">From the President of the United States want to take the right to disable computer systems and servers</a></li>
<li><a href="../110743/index.html">Is the remote control perfect?</a></li>
<li><a href="../110746/index.html">Mercurial Cheat Sheet</a></li>
<li><a href="../110748/index.html">Smooth animation on iPhone and iPad</a></li>
<li><a href="../110749/index.html">IT education in schools and universities</a></li>
<li><a href="../110754/index.html">How a hacker mocked a criminal who stole his PC</a></li>
<li><a href="../110755/index.html">Hypocampo - geoplanger</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>