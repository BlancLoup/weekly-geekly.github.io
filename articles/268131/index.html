<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mono and OS MSVS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Import substitution! This is a very popular word now eclipsed even nanotechnology! It carries both great prospects and many problems. Not so long ago,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mono and OS MSVS</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/e44/88c/27a/e4488c27a25242fd8f161ebfda29c88a.jpg" align="left" width="220" height="120"><br>  Import substitution!  This is a very popular word now eclipsed even nanotechnology!  It carries both great prospects and many problems.  Not so long ago, it touched me.  I was given the task to run our software on the operating system OS MSVS.  It's a very interesting thing, considering that I last saw Linux about 8 years ago, and our software was written under .Net. <br><a name="habracut"></a><br><h3>  Familiarity with OS MSVS </h3><br>  So, <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D0%25BE%25D0%25B1%25D0%25B8%25D0%25BB%25D1%258C%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2581%25D0%25B8%25D1%2581%25D1%2582%25D0%25B5%25D0%25BC%25D0%25B0_%25D0%2592%25D0%25BE%25D0%25BE%25D1%2580%25D1%2583%25D0%25B6%25D1%2591%25D0%25BD%25D0%25BD%25D1%258B%25D1%2585_%25D0%25A1%25D0%25B8%25D0%25BB">Wikipedia</a> says that the OS MSVS is the Mobile System of the Armed Forces.  Namely, a general purpose protected operating system.  Developed its organization VNIINS.  The system is based on Linux in accordance with the requirements of the Ministry of Defense of the Russian Federation. <br><br>  There are two branches of the system: <br><ul><li>  MSVS 3.0 - 32-bit version with kernel 2.4; </li><li>  MSVS 5.0 - 64-bit version with kernel 2.6. </li></ul><br><br>  In each branch there are several versions called ‚Äúchanges‚Äù.  The most recent certified versions are: <br><ul><li>  OS MSVS 3.0 FLIR.80001-12 rev.  ‚Ññ6; </li><li>  OS MSVS 5.0 TsAVM.11004-01 rev.  ‚Ññ7. </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the formulation of the task, no specific version of the system was indicated, therefore, after consulting with the technical support of VNIINS, the most current OS MSVS 5.0 TsAVM.11004-01 rev.  ‚Ññ7. <br><br>  About a month went to buy the official version and a few more days to select the hardware and install the system.  We can definitely say that OS MSVS 5.0 is not installed on x86 processors and laptops with 2 video cards. <br><br>  This is how the GUI of OSVS looks like: <br><br><img src="https://habrastorage.org/files/a39/446/ab3/a39446ab3a6d4127a5248c7ed6101e6b.png" width="1024"><br><br>  The manufacturer indicates the following system parameters: <br><ul><li>  Build date by the command ‚Äúuname -a‚Äù: February 1, 2013; </li><li>  Kernel: 2.6.32; </li><li>  QT: 3.3.8b, 4.8.5; </li><li>  gcc: 4.1.2, 4.4.7; </li><li>  glibc: 2.5; </li><li>  KDE: 3.5. </li></ul><br><br>  Having a little got acquainted with the system, I received the following information: <br><ul><li>  OS MSVS 5.0 is based on Red Hat Enterprises Intelligent Linux or its derivatives; </li><li>  Judging by the kernel version and build date, this is RHEL 6.3; </li><li>  The glibc libraries are very old: from September 2006; </li><li>  For development it is recommended to use QT is also not the very first freshness. </li></ul><br><br>  It can be assumed that this state of affairs is caused by difficulties in certifying the components of the system. <br><br>  Well, the task has become more specific.  Now you need to choose a solution.  There are only two of them: <br><ul><li>  rewrite everything under QT or under glibc; </li><li>  Try running what you have with <a href="http://www.mono-project.com/">Mono</a> . </li></ul><br>  In order to save forces, time and nerves, the second option was chosen.  Potential problems of this option are both the inability to normally start everything in principle, and the subsequent certification of software together with Mono.  However, it is still faster and easier than rewriting everything. <br><br><h3>  Mono installation </h3><br>  What is Mono?  <a href="https://ru.wikipedia.org/wiki/Mono">Wikipedia</a> suggests that this <blockquote>  A project to create a full-fledged implementation of the .NET Framework based on free software. </blockquote>  And also that <blockquote>  Mono implementations exist for the following operating systems: Windows, Linux, BSD (FreeBSD, OpenBSD, NetBSD), Solaris, Mac OS X, Apple iOS, Wii.  Supported platforms: s390, SPARC, PowerPC, x86 / x86-64, IA64, ARM, Alpha, MIPS, HPPA. </blockquote><br><br>  Go to <a href="http://www.mono-project.com/docs/getting-started/install/linux/">the</a> project <a href="http://www.mono-project.com/docs/getting-started/install/linux/">site</a> and see there that you need to execute only 3 commands to install: <br><br><ol><li><code>rpm --import "http://keyserver.ubuntu.com/pks/lookup?op=get&amp;search=0x3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF"</code> </li> <li> <code><a href="http://download.mono-project.com/repo/centos/"></a> yum-config-manager --add-repo download.mono-project.com/repo/centos</code> </li> <li> <code>yum install mono-complete</code> </li> </ol><br><br>  The first command adds a signature key for access to the repository, the second sets up a repository, the third sets Mono. <br><br>  The software is installed in the OS MSVS (as in the RHEL successor) in the form of <a href="https://ru.wikipedia.org/wiki/RPM">RPM packages</a> .  For convenience of this process, the <a href="https://ru.wikipedia.org/wiki/Yellow_dog_Updater,_Modified">YUM package manager</a> is often used.  The OS MSVS includes a graphical package manager shell, but I used the console version.  Packages are in repositories that can be located both on the local machine and somewhere on the network.  By adding links to the repositories in the YUM package manager, you can quite conveniently update the system.  As a rule, the repositories have already been added and configured in RHEL and its successors, however in the OS MSVS there is only one repository located on the installation CD. <br><br>  The problems started already on the second team.  It turned out that <code>yum-config-manager</code> missing from the system: <br><img src="https://habrastorage.org/files/6f7/a80/7fa/6f7a807fa58f40bca37b38a136a171e6.png"><br><br>  This means that you need to add the repository manually.  They are located in the <code>/etc/yum.repos.d</code> directory.  There you need to create a file <code>&lt;reponame&gt;.repo</code> .  For example, <code>mono.repo</code> .  In this file you need to add the following: <br><br> <code>[mono_repository]</code> <br> <code>name=mono repository</code> <br> <code>baseurl=http://download.mono-project.com/repo/centos/</code> <br> <code>enabled=1</code> <br> <code>gpgcheck=0</code> <br> <br>  After saving the file, I check that the repository is added by running the <code>yum repolist</code> .  In this case, the disk with the distribution kit must be inserted and mounted.  Or the repository on the disk should be disabled: <code>enabled = 0</code> in the <code>server.repo</code> file. <br><br>  However, now nothing happened: <br><img src="https://habrastorage.org/files/1b8/44d/7f1/1b844d7f1e40433a87f1365c1bdefb8c.png"><br><br>  Error <code>[Errno -3] Error performing checksum</code> says that YUM cannot calculate the checksum.  As <a href="">it turned out</a> , the repository uses the <code>sha256</code> hash function, which YUM cannot calculate.  Experienced people <a href="http://www.openfusion.net/linux/yum_error_performing_checksum">write</a> that in this case you need to put the <code>python-hashlib</code> .  Since the repositories are not configured, I manually installed <a href="http://www.rpmfind.net//linux/RPM/epel/5/x86_64/python-hashlib-20081119-4.el5.x86_64.html">this version</a> . <br><br>  After that, the repositories are earned as needed: <br><img src="https://habrastorage.org/files/986/04d/e6d/98604de6dde9425fab6a7d6e3f24bd2d.png"><br><br>  But still installing Mono fails anyway .: <br><img src="https://habrastorage.org/files/4a0/c58/55b/4a0c5855b09349a298bf4df66c31a36c.png"><br><br>  During installation, package dependencies are checked.  It turned out that the installation of Mono from this repository requires that the system have library versions not lower than: <br><br><ul><li> <code>GLIBC_2.16</code> </li> <li> <code>PNG15_0</code> </li> <li> <code>LIBTIFF_4.0</code> </li> <li> <code>LIBJPEG_6.2</code> </li> </ul><br><br>  It would be possible to try to update all these libraries, however this may lead to problems in the work of other software using them. <br><br>  <a href="http://stackoverflow.com/questions/3510320/install-mono-on-centos5-5-using-yum">StackOverFlow</a> prompted me another solution: you need to try installing an earlier version of Mono.  It turns out that there is an <a href="http://download.mono-project.com/archive/">archive of versions</a> .  Experimentally it was possible to determine that the latest version of Mono, which is normally installed on OS MSVS 5.0 TsAVM.11004-01 meas.  # 7 is version 2.10.2.  The repository is <a href="http://origin-download.mono-project.com/archive/2.10.2/download/RHEL_5/">here</a> . <br><br>  As a result, to install everything, you need to do the following: <br><br>  1. Create (or correct) the <code>&lt;reponame&gt;.repo</code> repository file in <code>/etc/yum.repos.d</code> For example, <code>mono.repo</code> . <br>  This file should contain the following: <br> <code>[Mono]</code> <br> <code>name=Mono Stack (RHEL_5)</code> <br> <code>type=rpm-md</code> <br> <code>baseurl=http://origin-download.mono-project.com/archive/2.10.2/download/RHEL_5/</code> <br> <code>gpgcheck=1</code> <br> <code>gpgkey=http://origin-download.mono-project.com/archive/2.10.2/download/RHEL_5/repodata/repomd.xml.key</code> <br> <code>enabled=1</code> <br> <br>  2. Run the <code>yum install monotools-addon-server</code> command to install the main libraries. <br>  3. Run the <code>yum install mono-addon-winforms-2.10.2-5.1.x86_64</code> to install the <code>yum install mono-addon-winforms-2.10.2-5.1.x86_64</code> libraries. <br>  4. Run the <code>yum install mono-addon-libgdiplus0.x86_64 0:2.10-6.2</code> to install the GDI + implementation. <br><br>  You can install other libraries.  Description of the distribution kit can be found <a href="http://origin-download.mono-project.com/archive/2.10.2/download/RHEL_5/repodata/">here</a> .  Mono is installed in <code>/opt/novell/mono</code> .  Mono version 2.10.2 contains the following .Net versions: 2.0, 3.5 and 4.0. <br><br>  You can check the installation as follows: <br><ol><li>  configure the environment with the <code>source /opt/novell/mono/bin/mono-addon-environment.sh</code> </li><li>  find out version with <code>mono --version</code> </li></ol><br><br>  The result should be like this: <br><img src="https://habrastorage.org/files/e11/d3c/d83/e11d3cd8305f456e9f2f06a00cf8a754.png"><br><br>  In addition, you can check the performance by running a <a href="http://www.mono-project.com/docs/getting-started/mono-basics/">couple of programs</a> . <br><br><h3>  Porting problems </h3><br>  To work in a familiar environment, I installed <a href="http://origin-download.mono-project.com/archive/2.10.2/download/">the same version of</a> Mono for Windows. <br><br>  For debugging it is convenient to use the output in the console.  To display it, you need to run the application with the parameter - <code>--debug</code> .  For example, <code>mono --debug helloworld.exe</code> . <br><br>  To isolate code intended only for Mono, I created two new configurations, <code>MonoRelease</code> and <code>MonoDebug</code> in VisualStudio. <br><img src="https://habrastorage.org/files/daf/852/1b4/daf8521b4a6340d5af37829edad6b618.png"><br><br>  In each of them, I added the compiler option <code>/define MONO</code> <br><img src="https://habrastorage.org/files/9f7/0fb/453/9f70fb453b244d3382029afd4f53b4aa.png"><br><br>  Now you can use the following construction: <br><br><pre> <code class="hljs cs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> MONO #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre><br><br>  From the first, of course, nothing worked.  First of all - getting the name of the processes: <br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; foreach (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> clsProcess <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-type"><span class="hljs-type">Process</span></span>.<span class="hljs-type"><span class="hljs-type">GetProcesses</span></span>()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(clsProcess.<span class="hljs-type"><span class="hljs-type">ProcessName</span></span>.<span class="hljs-type"><span class="hljs-type">Contains</span></span>(<span class="hljs-type"><span class="hljs-type">Process</span></span>.<span class="hljs-type"><span class="hljs-type">GetCurrentProcess</span></span>().<span class="hljs-type"><span class="hljs-type">ProcessName</span></span>)) <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>++; }</code> </pre><br><br>  This code returns the number of the same processes running on the system.  The problem was solved by ignoring exceptions from processes that we do not need. <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; foreach (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> clsProcess <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-type"><span class="hljs-type">Process</span></span>.<span class="hljs-type"><span class="hljs-type">GetProcesses</span></span>()) { #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-type"><span class="hljs-type">MONO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { #endif <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(clsProcess.<span class="hljs-type"><span class="hljs-type">ProcessName</span></span>.<span class="hljs-type"><span class="hljs-type">Contains</span></span>(<span class="hljs-type"><span class="hljs-type">Process</span></span>.<span class="hljs-type"><span class="hljs-type">GetCurrentProcess</span></span>().<span class="hljs-type"><span class="hljs-type">ProcessName</span></span>)) <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>++; #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-type"><span class="hljs-type">MONO</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { } #endif }</code> </pre> <br>  In this case, the code continued to perform its function. <br><br>  Then on the form ‚Äúleft‚Äù buttons.  It should be like this: <br><img src="https://habrastorage.org/files/c59/10c/c60/c5910cc608c34f7ca4111767aacdb21d.png"><br><br>  And it turned out like this: <br><img src="https://habrastorage.org/files/07c/6f5/1d1/07c6f51d1b7a470399d9c77f38363b78.png"><br><br>  This was decided by a small change in the arrangement of elements on the form: <br><br><pre> <code class="hljs cs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> MONO tableLayoutPanel1.RowStyles[1].Height = 60; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre><br><br>  There were also problems with the paths.  In Linux, the <code>'/'</code> character is used to separate directories, and in Windows <code>'\'</code> .  The problem is solved using <code>System.IO.Path.DirectorySeparatorChar</code> .  This static field always has the correct value on any operating system. <br><br>  But the main problem was marshaling.  In our software, <code>Marshal.StructureToPtr</code> and <code>Marshal.PtrToStructure</code> are used to serialize specially tagged classes to a byte array and back to be transmitted over a network.  Moreover, classes have a complex hierarchy and nesting.  Microfoft .NET copes with this task with a bang, and Mono could not.  I think this is a consequence of <a href="http://habrahabr.ru/company/enterra/blog/243371/">differences</a> in working with memory. <br><br>  As a result, we had to rewrite a very impressive part of the code, replacing the automatic serialization with the ‚Äúmanual‚Äù assembly of the class from the array. <br><br><h3>  Result </h3><br>  As a result, the problem was solved.  Directly to porting took about 2 weeks.  Another week took a study of the installation process Mono.  And the month was the purchase of the operating system. <br><br><h3>  What's next? </h3><br>  And then you need to create your own repository, which will automatically install Mono and the software itself.  After that, there should be certification ... <br><br>  But, as usual, everything changed at the most interesting place.  In the midst of work, it turned out that OS MSVS is no longer relevant.  It is necessary to do everything on <a href="https://ru.wikipedia.org/wiki/Astra_Linux">AstraLinux</a> ... And this is a slightly different story. </div><p>Source: <a href="https://habr.com/ru/post/268131/">https://habr.com/ru/post/268131/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268119/index.html">Creating loadable Zabbix modules on the example of adding the Modbus protocol</a></li>
<li><a href="../268123/index.html">Fantasy on WebDAV. Regular Client</a></li>
<li><a href="../268125/index.html">Underground carders market. Translation of the book "KingPIN". Chapter 15. "UBuyWeRush"</a></li>
<li><a href="../268127/index.html">How does the radio interface work in GSM networks</a></li>
<li><a href="../268129/index.html">File System and Hadoop: The Twitter Experience (Part 2)</a></li>
<li><a href="../268135/index.html">About safety UEFI, part six</a></li>
<li><a href="../268137/index.html">Good luck in the digital age! Or turn on the paranoid and check the protection of their data</a></li>
<li><a href="../268141/index.html">Non-constant constant expressions</a></li>
<li><a href="../268143/index.html">Android Studio 1.4 available</a></li>
<li><a href="../268145/index.html">Network system calls. Part 3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>