<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Active Directory Audit Powershell Change Alert. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article, I published my first post on Habr√©. In the continuation of the topic was going to write the second part. 

 In the comments t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Active Directory Audit Powershell Change Alert. Part 2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/7f0/f7b/909/7f0f7b909b1451ffeaf29fed80400f35.png" align="right"><br>  In the <a href="http://habrahabr.ru/post/147750/x">previous</a> article, I published my first post on Habr√©.  In the continuation of the topic was going to write the second part. <br><br>  In the comments to the first part, I casually mentioned that I expanded the functionality of monitoring scripts for server connections.  In particular, I added notifications to the XMPP (Jabber) instant messaging service, as well as writing a log to a separate text file. <br><a name="habracut"></a><br><br><h4>  Instant Alert. </h4><br>  What is so good is the instant notifications, because there is no need to constantly check email for new messages - messages come themselves and make themselves known immediately (Depending on the client‚Äôs settings, of course). <br>  Personally for myself, I have to open messages on top of all windows.  Of course, to avoid spamming himself, such alerts are sent to critical events. <br>  I took the critically important ones: unsuccessful attempts to log on to the domain controllers, unsuccessful attempts to log in to the VPN service (PPTP on WIndows).  Also added this feature to monitoring scripts for AD.  Because  I have access to AD with several people, over time, you can lose the thread of actual data (something, once, someone deleted / moved / added and you are not aware).  And these messages will be just the way to know in real time about the changes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Search solutions </h5><br>  When I got the idea of ‚Äã‚Äãthis kind of alert (given the fact that we have a fairly active Jabber-service in our organization), the first thing I did was scoring to google <a href="http://www.google.ru/search%3Fclient%3Dopera%26rls%3Dru%26q%3DPowershell%2Bjabber%26sourceid%3Dopera%26ie%3Dutf-8%26oe%3Dutf-8%26redir_esc%3D%26ei%3Dvhg2ULS0KoiKhQfYwYGwBQ">Powershell Jabber</a> .  The first link I was sent to the <a href="http/xaegr.wordpress.com/2008/03/11/">site is</a> not unknown in the open spaces of the <a href="http://social.technet.microsoft.com/Forums/ru-RU/scrlangru/threads">Microsoft Technet</a> <a href="http/xaegr.wordpress.com/2008/03/11/">Xaerg forums</a> .  What I saw there could not but make me happy: ‚ÄúDid you know that the NetCmdlets tooling, which includes cmdlets for working with a huge number of network protocols, is available for free for non-commercial use?‚Äù <br>  And a list of available commands.  ‚ÄúThis is what I need, and even for free !!!‚Äù - I thought and was upset when I went to the developer‚Äôs website for this toolset cmdlets, it turns out they don‚Äôt have a free version, there is only a trial for 1 month, after which you need to re-request the key.  Only after that I noticed the date of the article, it turned out to be 2008 - too old: (. <br>  For the sake of experiment I downloaded the trial version.  Installed on the server on which I want to use alerts.  Installation took place with a bang.  Immediately became available new commandlet.  Their syntax is quite simple and there were no problems with sending messages.  For a while, I used this trial license, re-registering it once a month.  But the feeling that you are using the trial version depressed me, even more depressed by the fact that it is necessary to register it every month for each server where it is installed.  And since at that moment a little less than 30 servers were present in the infrastructure, even the thought of registering at least once a month on all servers horrified me. <br>  When it became more free over time, I decided to finish this idea.  It was necessary to have a tool that allows using Powershell to send messages using the XMPP protocol.  In this case, an important factor should be the conditions of use of this tool - it should be free. <br><br>  I started tormenting Google again.  And my efforts were not in vain.  In one great click, I got to the <a href="http://sourceforge.com/">page with the utility</a> , which just allows you to send messages from the PS-console using the XMPP-protocol. <br>  I was particularly pleased with the inscription in the title of the page: <b>Project Hosting for Open Source Software.</b>  What made me think that this product is free to use is just what I need. <br><br><h4>  Audit of unsuccessful attempts to log on to the server, with notification by e-mail, Jabber-service, and writing to the log file. </h4><br><pre><code class="javascript hljs">#    WIndowsEventLog       ,      Body $HostName = HostName $Body=Get-WinEvent -FilterHashtable @{LogName=<span class="hljs-string"><span class="hljs-string">"Security"</span></span>;ID=<span class="hljs-number"><span class="hljs-number">4625</span></span>} | Select TimeCreated,@{n=<span class="hljs-string"><span class="hljs-string">"User"</span></span>;e={([xml]$_.ToXml()).Event.EventData.Data | ? {$_.Name -eq <span class="hljs-string"><span class="hljs-string">"TargetUserName"</span></span>} | %{$_.<span class="hljs-string"><span class="hljs-string">'#text'</span></span>}}},@{n=<span class="hljs-string"><span class="hljs-string">"ComputerName"</span></span>;e={([xml]$_.ToXml()).Event.EventData.Data | ? {$_.Name -eq <span class="hljs-string"><span class="hljs-string">"WorkstationName"</span></span>}| %{$_.<span class="hljs-string"><span class="hljs-string">'#text'</span></span>}}},@{n=<span class="hljs-string"><span class="hljs-string">"IPAddress"</span></span>;e={([xml]$_.ToXml()).Event.EventData.Data | ? {$_.Name -eq <span class="hljs-string"><span class="hljs-string">"IPAddress"</span></span>}| %{$_.<span class="hljs-string"><span class="hljs-string">'#text'</span></span>}}} | select-object -first <span class="hljs-number"><span class="hljs-number">1</span></span> #$BodyL -      - $BodyL = <span class="hljs-string"><span class="hljs-string">"`n"</span></span>+$Body.TimeCreated +<span class="hljs-string"><span class="hljs-string">"`t"</span></span>+ $Body.User +<span class="hljs-string"><span class="hljs-string">"`t"</span></span>+ $Body.ComputerName +<span class="hljs-string"><span class="hljs-string">"`t"</span></span>+ $Body.IPAddress #$Body -           Jabber $Body = <span class="hljs-string"><span class="hljs-string">"`n: "</span></span>+$Body.TimeCreated +<span class="hljs-string"><span class="hljs-string">"`n : "</span></span>+ $Body.User +<span class="hljs-string"><span class="hljs-string">"`n-: "</span></span>+ $Body.ComputerName +<span class="hljs-string"><span class="hljs-string">"`nIP : "</span></span>+ $Body.IPAddress #$Theme -  . $Hostname -   $Theme = <span class="hljs-string"><span class="hljs-string">"     "</span></span>+$hostname # Jabber- Add-PSSnapin poshxmpp <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-client -JabberId AUDIT@domain.ru -Password PASSWORD Send-Message admin@domain.ru <span class="hljs-string"><span class="hljs-string">"$Theme $Body"</span></span> $PoshXmppClient.Close() #    e-mail    $Subject = <span class="hljs-string"><span class="hljs-string">"     "</span></span>+$hostname $Server = <span class="hljs-string"><span class="hljs-string">"mail.domain.ru"</span></span> # SMTP  $From = <span class="hljs-string"><span class="hljs-string">"audit@domain.ru"</span></span> #   $To = <span class="hljs-string"><span class="hljs-string">"admin@domain.ru"</span></span> #  $pass = ConvertTo-SecureString <span class="hljs-string"><span class="hljs-string">"PASSWORD"</span></span> -AsPlainText -Force $cred = New-<span class="hljs-built_in"><span class="hljs-built_in">Object</span></span> System.Management.Automation.PSCredential(<span class="hljs-string"><span class="hljs-string">"AUDIT"</span></span> , $pass) $encoding = [System.Text.Encoding]::UTF8 # e-mail Send-MailMessage -From $From -To $To -SmtpServer $server -Body <span class="hljs-string"><span class="hljs-string">"$Theme `n$Body"</span></span> -Subject $Subject -Credential $cred -Encoding $encoding #    - FaildConnect.txt $BodyL | out-file <span class="hljs-string"><span class="hljs-string">"\ServerNameServerLogFilesServerFaildConnect.txt"</span></span> -append</code> </pre> <br><br>  As I wrote in the <a href="http://habrahabr.ru/post/147750/x">first part</a> , for the script to automatically work it is necessary to place it in the task scheduler and configure the launch of this script when an event with ID = 4625 is detected in the Security log. <br><br><h4>  Recommendations. </h4><br>  It is these scripts that I work on the VPN server and on all domain controllers. <br>  Now I always know when and who connects to the VPN, for example.  Or when someone tries to pick up a password for access to the server. <br>  I also recommend hanging such a script on those services that ‚Äúshine‚Äù on the Internet, for example, terminal access services. <br>  And writing to a separate file will allow you, in the future, to analyze connections.  By the way, the log can be opened via the spreadsheet editor (MS Excel or OO Calc) and you can work with the log as a table (sort, filter, etc.). </div><p>Source: <a href="https://habr.com/ru/post/150122/">https://habr.com/ru/post/150122/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../150116/index.html">Black Isle Studios revived</a></li>
<li><a href="../150118/index.html">Hard prioritization, or the first 5 steps to an excellent application for Windows 8. Functionality</a></li>
<li><a href="../150119/index.html">Tesla's laboratory will be turned into a museum - with the help of crowdfunding almost a million dollars was collected</a></li>
<li><a href="../150120/index.html">How to conduct business in the dark light of a crisis of confidence?</a></li>
<li><a href="../150121/index.html">Option to migrate FreeBSD from a physical server to a VMware ESXi virtual environment using NFS</a></li>
<li><a href="../150123/index.html">Is Google App Engine so good?</a></li>
<li><a href="../150125/index.html">The most valuable programming advice I received</a></li>
<li><a href="../150126/index.html">Whether sales or conversion increased after you installed an online consultant in your online store</a></li>
<li><a href="../150127/index.html">Cloud protection for .NET applications</a></li>
<li><a href="../150128/index.html">Microsoft has changed the logo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>