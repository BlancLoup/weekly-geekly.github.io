<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Stupid Weatherbox on E-Ink</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Already a year and a half ago, I bought a pair of E-Ink screens with eBay based on the SSD1606 driver, just for the weather station. And 4 months ago,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Stupid Weatherbox on E-Ink</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/f5/hr/3f/f5hr3fihi1v1nb9qyzk2gznhchs.jpeg"><br><br>  Already a year and a half ago, I bought a pair of E-Ink screens with eBay based on the SSD1606 driver, just for the weather station.  And 4 months ago, before the new year, he appeared. <br><a name="habracut"></a><br>  I will say at once that there is no clock in it, since at home there are literally watches everywhere  But he can show the following: <br><br><ul><li>  current temperature Celsius; </li><li>  current humidity in percent; </li><li>  current pressure in mm Hg; </li><li>  pressure history for the last 15 hours as a graph; </li><li>  battery voltage. </li></ul><br>  Actually, that's all.  The necessary minimum and ultimate simplicity! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Even there is no such GUI</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/t4/i5/ms/t4i5msbcfv3fjby4jiavjaiup5i.png"><br></div></div><br><h3>  Principle of operation </h3><hr>  The controller should at the touch of a button to display current information.  Most of the time the controller sleeps, as does the display, which is in deep sleep. <br><br>  The controller periodically wakes up on watchDog and once every 5 minutes makes pressure measurements, to build a graph of pressure changes. <br><br>  With the schedule came out very interesting, since the pressure can change very quickly and strongly (the weather in the northern city is generally unpredictable), then at some point a graph may increase in scale.  To do this, once a couple of hours, the average measurement point is recalibrated (the pressure can go both up and down).  However, due to this, the visual difference of the previous values ‚Äã‚Äãsimplifies the reading of the graph (example on KPDV). <br><br><h3>  Iron </h3><hr>  The main brain is the ATMega328P microcontroller, the BME280 is used as an all- <s>meter</s> barometer, and for the screen the previously described E-Ink second revision based on SSD1606 from Smart-Prototyping. <br><br>  This is almost the same screen as waveShare epaper 2.7 ‚Äú, only older (they have very similar datasheets). <br><br>  All this works on the battery from a <s>toy</s> helicopter at 120 mAh.  The battery is charged using a module with protection against deep discharge and recharging on the basis of TP4056 with a 47 kŒ© resistor installed for charging current of about 20mA. <br><br><h3>  Energy Optimization </h3><hr>  Good and healthy sleep is our everything!  Therefore, you need to sleep to the maximum! <br><br>  Since there was no software for working with the screen, only a basic code sample with comments in the language of the Middle Kingdom and datasheet (the screen just appeared a year and a half ago), I had to do most of the work myself, since there was already experience with different screens. <br><br>  The DeepSleep mode was found in the datasheet, the screen consumes nothing but 1.6mA in it! <br><br>  The barometer has a metering mode on demand (aka standby), in it the sensor consumes a minimum of energy, while providing sufficient accuracy for simple indication of changes (in the datasheet it is indicated that it is just for weather stations).  The inclusion of this mode gave a consumption of 6.2 ŒºA.  Next on the module was the LDO controller with the LM6206N3 (and maybe the XC6206, both of them disguised as 662k) on the MCP1700. <br><br><img src="https://habrastorage.org/webt/qn/bn/nq/qnbnnqabodmapplkcsgoxzkaw74.jpeg"><br><br>  This gave a gain of even 2 ¬µA. <br><br>  Since you need to achieve minimal power consumption, the LowPower library was used.  It has a convenient work with watchDog, on the basis of which the dream is made.  However, by itself, it consumes about 4¬µA.  I see a solution to this problem using an external timer based on Texas Instruments TPL5010 or similar. <br><br>  To reduce power consumption, it was also necessary to flash the tool with other FUSE bits and a bootloader, which was successfully done with USBasp, and was added to the boards.txt file <br><br><div class="spoiler">  <b class="spoiler_title">The following text:</b> <div class="spoiler_text"><code>## Arduino Pro or Pro Mini (1.8V, 1 MHz Int.) w/ ATmega328p <br> ## internal osc div8, also now watchdog, no LED on boot <br> ## bootloader size: 402 bytes <br> ## http://homes-smart.ru/index.php/oborudovanie/arduino/avr-zagruzchik <br> ## http://homes-smart.ru/fusecalc/?prog=avrstudio&amp;part=ATmega328P <br> ## http://www.engbedded.com/fusecalc <br> ## ------------------------------------------------- <br> pro.menu.cpu.1MHzIntatmega328=ATmega328 (1.8V, 1 MHz Int., BOD off) <br> <br> pro.menu.cpu.1MHzIntatmega328.upload.maximum_size=32256 <br> pro.menu.cpu.1MHzIntatmega328.upload.maximum_data_size=2048 <br> pro.menu.cpu.1MHzIntatmega328.upload.speed=9600 <br> <br> pro.menu.cpu.1MHzIntatmega328.bootloader.low_fuses=0x62 <br> pro.menu.cpu.1MHzIntatmega328.bootloader.high_fuses=0xD6 <br> pro.menu.cpu.1MHzIntatmega328.bootloader.extended_fuses=0x07 <br> pro.menu.cpu.1MHzIntatmega328.bootloader.file=atmega/a328p_1MHz_62_d6_5.hex <br> <br> pro.menu.cpu.1MHzIntatmega328.build.mcu=atmega328p <br> pro.menu.cpu.1MHzIntatmega328.build.f_cpu=1000000L <br></code> <br></div></div><br>  Also put in the ‚Äúbootloaders / atmega /‚Äù folder the bootloader compiled from optiboot: <br><br><div class="spoiler">  <b class="spoiler_title">a328p_1MHz_62_d6_5.hex</b> <div class="spoiler_text"> <code>:107E0000F894112484B714BE81FFDDD082E0809302 <br> :107E1000C00088E18093C10086E08093C2008CE0BE <br> :107E20008093C4008EE0B9D0CC24DD2488248394D0 <br> :107E3000B5E0AB2EA1E19A2EF3E0BF2EA2D08134A3 <br> :107E400061F49FD0082FAFD0023811F0013811F43F <br> :107E500084E001C083E08DD089C0823411F484E1D4 <br> :107E600003C0853419F485E0A6D080C0853579F447 <br> :107E700088D0E82EFF2485D0082F10E0102F00278F <br> :107E80000E291F29000F111F8ED068016FC0863583 <br> :107E900021F484E090D080E0DECF843609F040C049 <br> :107EA00070D06FD0082F6DD080E0C81680E7D8065C <br> :107EB00018F4F601B7BEE895C0E0D1E062D089932E <br> :107EC0000C17E1F7F0E0CF16F0E7DF0618F0F60147 <br> :107ED000B7BEE89568D007B600FCFDCFA601A0E0CC <br> :107EE000B1E02C9130E011968C91119790E0982F91 <br> :107EF0008827822B932B1296FA010C0187BEE895F6 <br> :107F000011244E5F5F4FF1E0A038BF0751F7F60133 <br> :107F1000A7BEE89507B600FCFDCF97BEE89526C042 <br> :107F20008437B1F42ED02DD0F82E2BD03CD0F601D2 <br> :107F3000EF2C8F010F5F1F4F84911BD0EA94F80143 <br> :107F4000C1F70894C11CD11CFA94CF0CD11C0EC0EF <br> :107F5000853739F428D08EE10CD085E90AD08FE03E <br> :107F60007ACF813511F488E018D01DD080E101D09E <br> :107F700065CF982F8091C00085FFFCCF9093C600FD <br> :107F800008958091C00087FFFCCF8091C00084FDE0 <br> :107F900001C0A8958091C6000895E0E6F0E098E160 <br> :107FA000908380830895EDDF803219F088E0F5DF5B <br> :107FB000FFCF84E1DECF1F93182FE3DF1150E9F7E5 <br> :107FC000F2DF1F91089580E0E8DFEE27FF27099494 <br> :0400000300007E007B <br> :00000001FF <br></code> <br></div></div><br>  Actually, as you most likely guessed, all this was done on the basis of the Arduino, namely pro mini at 8 MHz 3.3V.  The mic5203 LDO controller (too voracious at low currents) was dropped from this board and the LED resistor was sealed off to indicate power. <br><br>  As a result, it was possible to achieve energy consumption of 10 ¬µAh in sleep mode, which gives about 462.96 days of work.  It is safe to deduct a third from this number, thereby obtaining about 10 months, which so far corresponds to reality. <br><br>  I tested the version on ionistors, with a final capacity of 3 mAh, it works no more than 6 days (high self-discharge).  The calculation of the capacity of the ionistor was made according to the formula C * V / 3.6 = X mAh.  I think that the version with the solar battery and MSP430 will be generally eternal. <br><br><div class="spoiler">  <b class="spoiler_title">Ads:</b> <div class="spoiler_text"> <code>#include &lt;SPI.h&gt; <br> #include &lt;Wire.h&gt; <br> #include &lt;ssd1606.h&gt; <br> #include &lt;Adafruit_BME280.h&gt; <br> //#include &lt;BME280_2.h&gt; // local optimisation <br> #include &lt;LowPower.h&gt; <br> <br> #include &lt;avr/sleep.h&gt; <br> #include &lt;avr/power.h&gt; <br> <br> #define TIME_X_POS 0 <br> #define TIME_Y_POS 12 <br> <br> #define DATE_X_POS 2 <br> #define DATE_Y_POS 9 <br> <br> #define WEECK_X_POS 65 <br> #define WEECK_Y_POS 9 <br> <br> // ====================================== // <br> #define TEMP_X_POS 105 <br> #define TEMP_Y_POS 15 <br> <br> #define PRESURE_X_POS 105 <br> #define PRESURE_Y_POS 12 <br> <br> #define HUMIDITY_X_POS 105 <br> #define HUMIDITY_Y_POS 9 <br> // ====================================== // <br> <br> #define BATT_X_POS 65 <br> #define BATT_Y_POS 15 <br> <br> #define ONE_PASCAL 133.322 <br> <br> // ==== for presure history in graph ==== // <br> #define MAX_MESURES 171 <br> #define BAR_GRAPH_X_POS 0 <br> #define BAR_GRAPH_Y_POS 0 <br> #define PRESURE_PRECISION_RANGE 4.0 // -/+ 4 mm <br> #define PRESURE_GRAPH_MIN 30 // vertical line graph for every N minutes <br> #define PRESURE_PRECISION_VAL 10 // max val 100 <br> #define PRESURE_CONST_VALUE 700.0 // const val what unneed in graph calculations <br> #define PRESURE_ERROR -1000 // calibrated value <br> // ====================================== // <br> <br> #define VCC_CALIBRATED_VAL 0.027085714285714 // == 3.792 V / 140 (real / mesured) <br> //#define VCC_CALIBRATED_VAL 0.024975369458128 // == 5.070 V / 203 (real / mesured) <br> #define VCC_MIN_VALUE 2.95 // min value to refresh screen <br> #define CALIBRATE_VCC 1 // need for battery mesure calibration <br> <br> // 37 ~296 sec or 5 min * MAX_MESURES = 14,33(3) hours for full screen <br> #define SLEEP_SIZE 37 <br> <br> #ifdef BME280_ADDRESS <br> #undef BME280_ADDRESS <br> #define BME280_ADDRESS 0x76 <br> #endif <br> <br> #define ISR_PIN 3 // other mega328-based 2, 3 <br> #define POWER_OFF_PIN 4 // also DONEPIN <br> <br> #define E_CS 6 // CS ~ D6 <br> #define E_DC 5 // D/C ~ D5 <br> #define E_BSY 7 // BUSY ~ D7 <br> #define E_RST 2 // RST ~ D2 <br> #define E_BS 8 // BS ~ D8 <br> <br> /* <br> MOSI ~ D11 <br> MISO ~ D12 <br> CLK ~ D13 <br> */ <br> EPD_SSD1606 Eink(E_CS, E_DC, E_BSY, E_RST); <br> Adafruit_BME280 bme; <br> <br> volatile bool adcDone; <br> bool updateSreen = true; <br> bool normalWakeup = false; <br> <br> float battVal =0; <br> uint8_t battValcV =0; <br> <br> uint8_t timeToSleep = 0; <br> <br> float presure =0; <br> float temperature =0; <br> float humidity =0; <br> float presure_mmHg =0; <br> <br> unsigned long presureMin =0; <br> unsigned long presureMax =0; <br> <br> uint8_t currentMesure = MAX_MESURES; <br> uint8_t presureValHistoryArr[MAX_MESURES] = {0}; <br> <br> typedef struct { <br> uint8_t *pData; <br> uint8_t pos; <br> uint8_t size; <br> unsigned long valMax; <br> unsigned long valMin; <br> } history_t; <br></code> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Initialization:</b> <div class="spoiler_text"> <code>void setup() <br> { <br> saveExtraPower(); <br> Eink.begin(); <br> <br> initBME(); <br> <br> // https://www.arduino.cc/en/Reference/attachInterrupt <br> pinMode(ISR_PIN, INPUT_PULLUP); <br> attachInterrupt(digitalPinToInterrupt(ISR_PIN), ISRwakeupPin, RISING); <br> <br> //drawDefaultGUI(); <br> drawDefaultScreen(); <br> <br> // tiiiiny fix.... <br> checkBME280(); <br> updatePresureHistory(); <br> } <br> <br> void saveExtraPower(void) <br> { <br> power_timer1_disable(); <br> power_timer2_disable(); <br> <br> // Disable digital input buffers: <br> DIDR0 = 0x3F; // on ADC0-ADC5 pins <br> DIDR1 = (1 &lt;&lt; AIN1D) | (1 &lt;&lt; AIN0D); // on AIN1/0 <br> } <br> <br> void initBME(void) <br> { <br> bme.begin(BME280_ADDRESS); // I2C addr <br> <br> LowPower.powerDown(SLEEP_250MS, ADC_OFF, BOD_OFF); // wait for chip to wake up. <br> while(bme.isReadingCalibration()) { // if chip is still reading calibration, delay <br> LowPower.powerDown(SLEEP_120MS, ADC_OFF, BOD_OFF); <br> } <br> bme.readCoefficients(); <br> <br> bme.setSampling(Adafruit_BME280::MODE_FORCED, <br> Adafruit_BME280::SAMPLING_X1, // temperature <br> Adafruit_BME280::SAMPLING_X1, // pressure <br> Adafruit_BME280::SAMPLING_X1, // humidity <br> Adafruit_BME280::FILTER_OFF); <br> } <br></code> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Main code:</b> <div class="spoiler_text"> <code>void loop() <br> { <br> for(;;) { // i hate func jumps when it's unneed! <br> checkVCC(); <br> if(normalWakeup) { <br> checkBME280(); <br> updatePresureHistory(); <br> } else { <br> normalWakeup = true; <br> } <br> <br> updateEinkData(); <br> enterSleep(); <br> } <br> } <br> <br> // func to exec in pin ISR <br> void ISRwakeupPin(void) <br> { <br> // Keep this as short as possible. Possibly avoid using function calls <br> normalWakeup = false; <br> updateSreen = true; <br> timeToSleep = 1; <br> } <br> <br> ISR(ADC_vect) <br> { <br> adcDone = true; <br> } <br> <br> void debounceFix(void) <br> { <br> normalWakeup = true; <br> updateSreen = false; <br> } <br> <br> //https://github.com/jcw/jeelib/blob/master/examples/Ports/bandgap/bandgap.ino <br> uint8_t vccRead(void) <br> { <br> uint8_t count = 4; <br> set_sleep_mode(SLEEP_MODE_ADC); <br> ADMUX = bit(REFS0) | 14; // use VCC and internal bandgap <br> bitSet(ADCSRA, ADIE); <br> do { <br> adcDone = false; <br> while(!adcDone) sleep_mode(); <br> } while (--count); <br> bitClear(ADCSRA, ADIE); <br> // convert ADC readings to fit in one byte, ie 20 mV steps: <br> // 1.0V = 0, 1.8V = 40, 3.3V = 115, 5.0V = 200, 6.0V = 250 <br> return (55U * 1023U) / (ADC + 1) - 50; <br> } <br> <br> unsigned long getHiPrecision(double number) <br> { <br> // what if presure will be more 800 or less 700? ... <br> number -= PRESURE_CONST_VALUE; // remove constant value <br> number *= PRESURE_PRECISION_VAL; // increase precision by PRESURE_PRECISION_VAL <br> return (unsigned long)number; // Extract the integer part of the number <br> } <br> <br> void checkVCC(void) <br> { <br> // reconstruct human readable value <br> battValcV = vccRead(); <br> battVal = battValcV * VCC_CALIBRATED_VAL; <br> <br> if(battVal &lt;= VCC_MIN_VALUE) { // not enought power to drive E-Ink or work propetly <br> detachInterrupt(digitalPinToInterrupt(ISR_PIN)); <br> // to prevent full discharge: just sleep <br> bme.setSampling(Adafruit_BME280::MODE_SLEEP); <br> LowPower.powerDown(SLEEP_2S, ADC_OFF, BOD_OFF); <br> Eink.sleep(true); <br> LowPower.powerDown(SLEEP_FOREVER, ADC_OFF, BOD_OFF); <br> } <br> } <br> <br> void checkBME280(void) <br> { <br> bme.takeForcedMeasurement(); // wakeup, make new mesure and sleep <br> temperature = bme.readTemperature(); <br> humidity = bme.readHumidity(); <br> presure = bme.readPressure(); <br> } <br> <br> void updatePresureHistory(void) <br> { <br> // convert Pa to mmHg; 1 mmHg == 133.322 Pa <br> presure_mmHg = (presure + PRESURE_ERROR)/ONE_PASCAL; <br> <br> // === calc presure history in graph === // <br> if((++currentMesure) &gt;= (MAX_MESURES/3)) { // each 4,75 hours <br> currentMesure =0; <br> presureMin = getHiPrecision(presure_mmHg - PRESURE_PRECISION_RANGE); <br> presureMax = getHiPrecision(presure_mmHg + PRESURE_PRECISION_RANGE); <br> } <br> <br> // 36 == 4 pixels in sector * 9 sectors <br> presureValHistoryArr[MAX_MESURES-1] = map(getHiPrecision(presure_mmHg), presureMin, presureMax, 0, 35); <br> <br> for(uint8_t i=0; i &lt; MAX_MESURES; i++) { <br> presureValHistoryArr[i] = presureValHistoryArr[i+1]; <br> } <br> } <br> <br> void updateEinkData(void) <br> { <br> if(updateSreen) { <br> updateSreen = false; <br> Eink.sleep(false); <br> <br> // bar history <br> Eink.fillRect(BAR_GRAPH_X_POS, BAR_GRAPH_Y_POS, MAX_MESURES, 9, COLOR_WHITE); <br> <br> for(uint8_t i=1; i &lt;= (MAX_MESURES/PRESURE_GRAPH_MIN); i++) { <br> Eink.drawVLine(BAR_GRAPH_X_POS+i*PRESURE_GRAPH_MIN, BAR_GRAPH_Y_POS, 35, COLOR_DARKGREY); <br> } <br> <br> for(uint8_t i=0; i &lt;= MAX_MESURES; i++) { <br> Eink.drawPixel(i, BAR_GRAPH_Y_POS+presureValHistoryArr[i], COLOR_BLACK); <br> } <br> <br> #if CALIBRATE_VCC <br> Eink.setCursor(BATT_X_POS, BATT_Y_POS); <br> Eink.print(battVal); <br> <br> Eink.setCursor(BATT_X_POS, BATT_Y_POS-3); <br> Eink.print(battValcV); <br> #endif <br> <br> Eink.setCursor(TEMP_X_POS, TEMP_Y_POS); <br> Eink.print(temperature); <br> <br> Eink.setCursor(PRESURE_X_POS, PRESURE_Y_POS); <br> Eink.print(presure_mmHg); <br> <br> Eink.setCursor(HUMIDITY_X_POS, HUMIDITY_Y_POS); <br> Eink.print(humidity); <br> <br> updateEinkSreen(); <br> Eink.sleep(true); <br> } <br> } <br> <br> void updateEinkSreen(void) <br> { <br> Eink.display(); // update Eink RAM to screen <br> LowPower.idle(SLEEP_15MS, ADC_OFF, TIMER2_OFF, TIMER1_OFF, TIMER0_OFF, SPI_OFF, USART0_OFF, TWI_OFF); <br> <br> Eink.closeChargePump(); <br> // as Eink display acts not like in DS, then just sleep for 2 seconds <br> LowPower.powerDown(SLEEP_2S, ADC_OFF, BOD_OFF); <br> } <br> <br> void effectiveIdle(void) <br> { <br> LowPower.idle(SLEEP_30MS, ADC_OFF, TIMER2_OFF, TIMER1_OFF, TIMER0_OFF, SPI_OFF, USART0_OFF, TWI_OFF); <br> } <br> <br> void drawDefaultScreen(void) <br> { <br> Eink.fillScreen(COLOR_WHITE); <br> <br> Eink.printAt(TEMP_X_POS, TEMP_Y_POS, F("00.00 C")); <br> Eink.printAt(PRESURE_X_POS, PRESURE_Y_POS, F("000.00 mm")); <br> Eink.printAt(HUMIDITY_X_POS, HUMIDITY_Y_POS, F("00.00 %")); <br> <br> #if CALIBRATE_VCC <br> Eink.printAt(BATT_X_POS, BATT_Y_POS, F("0.00V")); <br> // just show speed in some kart racing game in mushr... kingdom \(^_^ )/ <br> Eink.printAt(BATT_X_POS, BATT_Y_POS-3, F("000cc")); <br> #endif <br> } <br> <br> void drawDefaultGUI(void) <br> { <br> Eink.drawHLine(0, 60, 171, COLOR_BLACK); // split 2 areas <br> <br> // draw window <br> Eink.drawRect(0, 0, 171, 71, COLOR_BLACK); <br> <br> // frame for text <br> Eink.drawRect(BATT_X_POS, BATT_Y_POS, 102, 32, COLOR_BLACK); <br> } <br> <br> void snooze(void) <br> { <br> do { <br> LowPower.powerDown(SLEEP_8S, ADC_OFF, BOD_OFF); <br> } while(--timeToSleep); <br> } <br> <br> void disablePower(void) <br> { <br> digitalWrite(POWER_OFF_PIN, HIGH); <br> delay(1); <br> digitalWrite(POWER_OFF_PIN, LOW); <br> LowPower.powerDown(SLEEP_FOREVER, ADC_OFF, BOD_OFF); <br> } <br> <br> void enterSleep(void) <br> { <br> // wakeup after ISR signal; <br> timeToSleep = SLEEP_SIZE; <br> debounceFix(); <br> snooze(); <br> } <br></code> <br></div></div><br><h3>  Housing </h3><hr>  Since I do not have a 3D printer, but I have a MyRiwell RP800A 3D pen.  It turned out that it was not so easy for her to make planar and even structures.  All PLA was painted with plastic, which was at that time, so the case came out multi-colored, which in other matters gives a certain charm (then I will redo it under the tree, when plastic with wood chips comes). <br><br>  The first parts were drawn directly on paper, after which they came off.  It left traces on the plastic.  Moreover, the details were crooked and needed to be straightened somehow! <br><br><img src="https://habrastorage.org/webt/8n/hw/qd/8nhwqdqi0lozsurrddj06swislq.jpeg"><br><br>  The solution turned out to be trivially simple - to draw on the glass, and under it put "drawings" of the necessary elements of the body. <br><br>  And that's what happened: <br><br><img src="https://habrastorage.org/webt/0s/-n/lg/0s-nlgl04kdto1md7029tbzgpxc.jpeg"><br><br>  The screen update button just had to be red on a white background! <br><br><img src="https://habrastorage.org/webt/ir/vo/uq/irvouqutxblp5uyytjprerhqqrc.jpeg"><br><br>  The back wall is made with a simple pattern, thereby creating air vents. <br><br><img src="https://habrastorage.org/webt/-f/9g/g6/-f9gg6mv1og3uqsemlmplrvjwfg.jpeg"><br><br>  The button was attached to the horizontal strut inside (in yellow) with the handle that was also made. <br><br><img src="https://habrastorage.org/webt/lg/b0/ta/lgb0taq2azc8mqhuv5s8n-a6kvu.jpeg"><br><br>  The button itself is taken from the old computer case (it has a pleasant sound). <br><br><img src="https://habrastorage.org/webt/e-/v-/yz/e-v-yzbtd-_pgeebpvpj5dzjvek.jpeg"><br><br>  Inside, everything is fixed with hot melt and plastic, so that it‚Äôs not easy to disassemble. <br><br><img src="https://habrastorage.org/webt/do/j_/n5/doj_n5orgkzsc6f3m-untuxsgvy.jpeg"><br><br>  Of course, left the connector for charging and firmware upgrades.  The case, unfortunately, had to be made monolithic for greater strength. <br><br><h3>  Conclusion </h3><hr>  4 months have passed, and after not fully charging (up to 4V) the voltage on the battery is only up to 3.58V, which guarantees a long service life until the next charge. <br><br>  People are very accustomed to this thing in the case of headaches or if you need to know the exact weather forecast for the next hour or two, they immediately go to her and see what happened with the pressure.  At KPDV, for example, one can see a strong drop in pressure, as a result it began to snow heavily with the wind. <br><br>  Repository links: <br><br>  ‚Üí <a href="https://github.com/Bismuth208/SSD1606_EPD">screen library</a> <br>  ‚Üí <a href="https://github.com/rocketscream/Low-Power">library for lowPower</a> <br>  ‚Üí <a href="https://github.com/adafruit/Adafruit_BME280_Library">library for BME280</a> <br><br>  Updated: <br><br>  In connection with the increased interest in the body posted more images.  Screen Smart-Prototyping second revision.  Analog to him on Ali <a href="https://ru.aliexpress.com/item/296x128-2-9inch-E-Ink-display-module-SPI-interfac-Without-PCB-Communicate-via-SPI-interface-Supports/32811510579.html">here</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Click me:</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/nu/dq/na/nudqnavt9d2tcveb2vbwel7yx70.jpeg"><br><img src="https://habrastorage.org/webt/jy/5e/iw/jy5eiwertmyppaqejgaupdi5ky0.jpeg"><br><img src="https://habrastorage.org/webt/4k/uc/u2/4kucu2vgl70ktuec6fjdbkgmo_c.jpeg"><br></div></div><br>  PS KPDV was done in the evening, as a result, very, very much snow fell in St. Petersburg tonight. <br>  PPS Blue tape did not add to the survey for known reasons. </div><p>Source: <a href="https://habr.com/ru/post/410949/">https://habr.com/ru/post/410949/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../410937/index.html">3D vlog: everything about digital production - # 1</a></li>
<li><a href="../410939/index.html">Superconducting transformer almost with their own hands</a></li>
<li><a href="../410941/index.html">Review of the laptop Lenovo V330-15: reliable office laborer</a></li>
<li><a href="../410943/index.html">Lamptest-1 brightness analyzer</a></li>
<li><a href="../410945/index.html">New record of Rubik's cube assembly: 0.38 seconds</a></li>
<li><a href="../410951/index.html">11 possible future scenarios</a></li>
<li><a href="../410953/index.html">Space illegal SpaceBEE</a></li>
<li><a href="../410955/index.html">Oc√© Colorado 1640 - the first roll-up printer with UVgel technology</a></li>
<li><a href="../410957/index.html">Stephen Hawking's latest theory will prove the existence of parallel universes.</a></li>
<li><a href="../410959/index.html">The Google division launches a trucking test service using robots</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>