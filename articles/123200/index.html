<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Controller architecture: simple tips for every day</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The fact that controllers should be ‚Äúthin‚Äù is known to everyone, but as the functionality grows, it becomes more and more difficult to maintain cleanl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Controller architecture: simple tips for every day</h1><div class="post__text post__text-html js-mediator-article">  The fact that controllers should be ‚Äúthin‚Äù is known to everyone, but as the functionality grows, it becomes more and more difficult to maintain cleanliness of controllers.  <a href="http://devmen.ru/">We</a> want to offer a few recommendations on how to keep your controllers as clean as possible without compromising the quality of the code. <br><a name="habracut"></a><br><h4>  1. Use <a href="https://github.com/josevalim/inherited_resources">inherited_resources</a> </h4><br>  All controllers are built on the basis of inherited_resources, which allows us to avoid the banal CRUD code.  Only two lines of the declaration of the controller inherited from InheritedResources :: Base, and he knows how to perform all the basic operations (create / display / update / delete) with the resource!  Everything is good, but problems often arise: <br><ul><li>  filter / sort the list </li><li>  page breakdown of collections </li><li>  sharing access between users / user groups </li></ul><br>  To solve the first problem, you can override the corresponding controller method (index) and make the necessary changes to the sample, but there is a much more elegant method, which is described in the inherited_resources documentation, but for some reason few people use it. <br><br><h4>  2. Use the <a href="http://github.com/plataformatec/has_scope">has_scope</a> extension </h4><br>  This gem allows you to insert into the selection of a resource / collection of resources any scopes described in the model. <br>  How it works?  For example, we need to display all blog posts, i.e.  filter blog posts: <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">class</font> PostsController &lt; InheritedResources::Base <br> has_scope :by_blog, :only =&gt; :index <br> end <br> <br> <font color="#0000ff">class</font> Post &lt; ActiveRecord::Base <br> belongs_to :blog <br> scope :by_blog, lambda{|blog_id| <font color="#0000ff">where</font> (:blog_id =&gt; blog_id)} <br> end <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Now when you request / posts? By_blog = 1, the collection of resources will be automatically filtered by blog with id = 1.  But it doesn‚Äôt look very nice, so let's write the following in routs: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">get</font> <font color="#A31515">"blogs/:blog_id(/page/:page)(.:format)"</font> =&gt; <font color="#A31515">"posts#index"</font> , :constraints =&gt; { :page =&gt; /\d+/ }, :defaults =&gt; { :page =&gt; 1 } <br> resources :posts</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  And the same result can be obtained from the URL / blogs / 1. <br><br>  If you need to <strong>constantly</strong> sort collections, then you can use the default parameter - then the scop will always be used with the specified default value: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">class</font> PostsController &lt; InheritedResources::Base <br> has_scope :ordered, : <font color="#0000ff">default</font> =&gt; <font color="#A31515">'created_at DESC'</font> <br> end <br> <br> <font color="#0000ff">class</font> Post &lt; ActiveRecord::Base <br> scope :ordered, lambda{|field| order(field)} #      <br> end</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Similarly, you can eliminate the problem of N + 1 queries: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">class</font> PostsController &lt; InheritedResources::Base <br> has_scope :eager_loading, : <font color="#0000ff">default</font> =&gt; <font color="#A31515">'true'</font> , :only =&gt; :index <br> end <br> <br> <font color="#0000ff">class</font> Post &lt; ActiveRecord::Base <br> scope :eager_loading, preload(:blog, :user, :tags) <br> scope :eager_loading2, includes(:blog, :user) <br> end</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote>  If you need to specify several scopes at once, check some additional conditions or simply do not want to produce scops in the model, you can specify them directly when setting the has_scope parameters in the block: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">class</font> PostsController &gt; InheritedResources::Base <br> has_scope :blog <font color="#0000ff">do</font> |controller, scope, <font color="#0000ff">value</font> | <br> <font color="#0000ff">value</font> != <font color="#A31515">"all"</font> ? scope. <font color="#0000ff">where</font> (:blog_id =&gt; <font color="#0000ff">value</font> ) : scope <br> end <br> end</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  More information about the has_scope can be on <a href="http://github.com/plataformatec/has_scope">the project page</a> .  The effect of it as from HAML is to spend a little time getting used to the features, but then a lot of time is saved. <br><br><h4>  3. For pagination use <a href="https://github.com/amatsuda/kaminari">kaminari</a> / <a href="https://github.com/mislav/will_paginate">will_paginate</a> </h4><br>  These gems are very popular and only lazy did not use them.  How do they integrate with inherited_resources?  With kaminari there are no problems at all - it can be applied in the controller as a usual download: page just like in the previous examples.  But with will_paginate - you have to tinker a bit, because  The paginate method it provides is not a scoped model.  But here there is a quite elegant solution - it is necessary to override the collection method in the controller as follows: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">class</font> PostsController &lt; InheritedResources::Base <br> <font color="#0000ff">protected</font> <br> def collection <br> @posts ||= end_of_association_chain.paginate(:page =&gt; <font color="#0000ff">params</font> [:page]) <br> end <br> end</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Since this trick will be used very often, it can be brought into the module and connected as needed to other controllers, but more on that next time. <br><br><h4>  4. For <a href="http://ru.wikipedia.org/wiki/%25D0%2590%25D1%2583%25D1%2582%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B8%25D1%2584%25D0%25B8%25D0%25BA%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F">authentication</a> and <a href="http://ru.wikipedia.org/wiki/%25D0%2590%25D0%25B2%25D1%2582%25D0%25BE%25D1%2580%25D0%25B8%25D0%25B7%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F">authorization,</a> use <a href="https://github.com/plataformatec/devise">devise</a> and <a href="https://github.com/ryanb/cancan">cancan</a> respectively. </h4><br>  When using this bundle, you can completely dispense with separate controllers for the control panel.  They allow you to fully make the logic of sharing access to resources from the controller, leaving only the declarations there and deserve a separate article. <br><br><h4>  5. If possible, avoid overlapping standard controller methods. </h4><br>  All additional checks, normalization of parameters and other actions for standard operations can be made in before_filter: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">class</font> PostsController &lt; InheritedResources::Base <br> before_filter lambda{ resource.user = current_user }, :only =&gt; :create <br> before_filter lambda { resource.thumb = nil <font color="#0000ff">if</font> <font color="#0000ff">params</font> [:thumb_delete] }, :only =&gt; :update <br> end</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br><h4>  6. For forming RSS feeds, uploading AJAX collections, etc.  no need to produce separate methods </h4><br>  It is enough to request the collection in the required format: /posts.rss and /posts.json, while in the controller it is enough to register: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">class</font> PostsController &lt; InheritedResources::Base <br> respond_to :html <br> respond_to :rss, :json, :only =&gt; :index <br> end</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  In addition, for the formation of RSS you need to register in the template posts / index.rss.builder: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">xml.instruct! :xml, :version =&gt; <font color="#A31515">"1.0"</font> <br> xml.rss :version =&gt; <font color="#A31515">"2.0"</font> <font color="#0000ff">do</font> <br> xml.channel <font color="#0000ff">do</font> <br> xml.title <font color="#A31515">""</font> <br> xml.description <font color="#A31515">""</font> <br> xml.link collection_url(:format =&gt; :rss) <br> <br> <font color="#0000ff">for</font> resource <font color="#0000ff">in</font> collection <br> xml.item <font color="#0000ff">do</font> <br> xml.title resource.title <br> xml.description <font color="#A31515">"#{resource.annotation}\n#{link_to ' ...', resource_url(resource)}"</font> <br> xml.pubDate resource.published_at.to_s(:rfc822) <br> xml.link resource_url(resource) <br> xml.guid resource_url(resource) <br> end <br> end <br> end <br> end</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  You can handle the JSON collection with the following jQuery code: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">$( <font color="#A31515">'#blog_id'</font> ).live( <font color="#A31515">'change'</font> , <font color="#0000ff">function</font> () { <br> $.ajax({ <br> url: <font color="#A31515">'/posts.json'</font> , <br> dataType: <font color="#A31515">'json'</font> , <br> data: { blog_id: $( <font color="#0000ff">this</font> ).val() }, <br> success: <font color="#0000ff">function</font> (json) { <br> <font color="#0000ff">var</font> options = <font color="#A31515">''</font> ; <br> <font color="#0000ff">for</font> ( <font color="#0000ff">var</font> i = 0; i &lt; json.length; i++) { <br> options += <font color="#A31515">'&lt;option value="'</font> + json[i].id + <font color="#A31515">'"&gt;'</font> + json[i].title + <font color="#A31515">'&lt;/option&gt;'</font> ; <br> } <br> $( <font color="#A31515">'#destination'</font> ).html(options); <br> } <br> }); <br> });</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Thus, it is possible to achieve the minimum amount of code in the controllers while maintaining flexible functionality, REST approach and code transparency.  All these principles are implemented in real projects and have shown themselves well in practice.  Some statistics: after 10 months of development, the largest controller in the project <a href="http://smartsourcing.ru/">SmartSourcing</a> takes 86 lines, the smallest - 2 lines, but most controllers - no more than 20 LOC. </div><p>Source: <a href="https://habr.com/ru/post/123200/">https://habr.com/ru/post/123200/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../123194/index.html">The history of the confrontation between OpenGL and Direct3D</a></li>
<li><a href="../123195/index.html">Do no harm, or read the user agreement carefully!</a></li>
<li><a href="../123196/index.html">Ostrovok.ru invites the first users of the new hotel booking service (+ review contest)</a></li>
<li><a href="../123197/index.html">New PHC shop partners network management module released</a></li>
<li><a href="../123198/index.html">Crowdsourcing in translation sites</a></li>
<li><a href="../123205/index.html">Is it all bad with RIM and BlackBerry?</a></li>
<li><a href="../123206/index.html">Organizational structure of different IT companies</a></li>
<li><a href="../123207/index.html">We make a simple web service using the Yandex.Metrics API</a></li>
<li><a href="../123208/index.html">Please finally shoot these tags!</a></li>
<li><a href="../123209/index.html">Court and EMS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>