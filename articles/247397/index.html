<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>WS_EX_LAYERED style for child windows in Windows 8</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In Windows, you cannot just make a translucent control, you must either draw all controls yourself (Qt, FMX) or use DrawThemeParentBackground , which ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>WS_EX_LAYERED style for child windows in Windows 8</h1><div class="post__text post__text-html js-mediator-article">  In <b>Windows,</b> you cannot just make a translucent control, you must either draw all controls yourself (Qt, FMX) or use <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/bb773289(v%3Dvs.85).aspx">DrawThemeParentBackground</a> , which inevitably leads to brakes. <br>  Regions will not help here because  they do not support partial transparency. <br>  It would be convenient to use windows with the <b>WS_EX_LAYERED</b> style (‚ÄúLayered‚Äù windows that support the alpha transparency of individual pixels), but <b>Windows only</b> supports this style for top-level windows.  So it was before <b>Windows 8</b> in which <s>, less than half a century, it</s> finally became possible to assign this style to child windows. <br><img src="https://habrastorage.org/files/f2b/df0/8b9/f2bdf08b95c744bdacd8fec88a52e8e4.png"><br>  What does this give?  The first thing that comes to mind is that the video card will be engaged in the composition of the windows, which will give a performance boost. <br><br>  Under the cat a little research of this feature of <b>Windows 8</b> . <br><a name="habracut"></a><br>  All code samples will be presented in <b>Delphi</b> , but this approach can be used in other languages. <br><br>  Let's try to create such a translucent button: <br><img src="https://habrastorage.org/files/2a4/5cb/b82/2a45cbb8288e4f35a643135fdfadf25c.png"><br>  For simplicity, we will not draw it with <b>GDI +</b> tools, but simply use a ready-made 32-bit BitMap. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Create a new <b>Vcl</b> application, add a <b>TImage</b> to the form and load our 32-bit BitMap there. <br>  We will also add a button to the form, when clicked, we will create 100 ‚Äúbuttons‚Äù. <br><br>  We will make our <b>Layered</b> component a successor from <b>TButton</b> , in which we add a constructor that accepts a 32-bit BitMap with the image of our button, and override the <b>CreateWnd</b> procedure responsible for creating the window: <br><pre><code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TWin8Control</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TButton) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WinBitMap: TBitMap; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateWnd</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AOWner: TComponent; BitMap: TBitMap)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ... constructor TWin8Control.Create(AOWner: TComponent; BitMap: TBitMap); begin inherited Create(AOwner); WinBitMap := BitMap; end; procedure TWin8Control.CreateWnd; var bf: TBlendFunction; BitmapSize: TSize; BitmapPos:Tpoint; begin inherited; if Assigned(WinBitMap) then begin //       Premultiplied  WinBitMap.AlphaFormat := afPremultiplied; bf.BlendOp := AC_SRC_OVER; bf.BlendFlags := 1; bf.AlphaFormat := AC_SRC_ALPHA; bf.SourceConstantAlpha := 255; //   BitMap BitmapSize.cx := WinBitMap.Width; BitmapSize.cy := WinBitMap.Height; BitmapPos.X := 0; BitmapPos.Y := 0; //  ""   SetWindowLong(Handle, GWL_EXSTYLE, GetWindowLong(Handle, GWL_EXSTYLE) or WS_EX_LAYERED); UpdateLayeredWindow( Handle, 0, nil, @BitmapSize, WinBitMap.Canvas.Handle, @BitmapPos, 0, @bf, ULW_ALPHA ); end; end;</span></span></code> </pre> <br><br>  Let's now in the handler of our button make the creation of 100 child <b>Layered</b> windows: <br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TfrmMain</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btnAdd100Click</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: Integer; Win8Control: TWin8Control; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">99</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Win8Control := TWin8Control.Create(Self, Image.Picture.Bitmap); Win8Control.Parent := Self; Win8Control.Top := Random(<span class="hljs-number"><span class="hljs-number">400</span></span>); Win8Control.Left := Random(<span class="hljs-number"><span class="hljs-number">400</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><br>  Run the application and click on the button: <br><img src="https://habrastorage.org/files/213/4e7/fdb/2134e7fdb40f46b1a61adbf4b156de16.png"><br>  ... And note that for some reason, the <b>WS_EX_LAYERED</b> style has not been applied to the child windows. <br><br>  As it turned out, the whole thing is that this feature does not work until the application manifest shows support for Windows 8 (which is not explicitly stated on <b>msdn</b> ): <br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">compatibility</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:schemas-microsoft-com:compatibility.v1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">application</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">supportedOS</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{1f676c76-80e1-4239-95bb-83d0f6d0da78}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">supportedOS</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{4a2f28e3-53b9-4441-ba9c-d69d4a4a6e38}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">application</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">compatibility</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Add these lines to the manifest, connect it to the project, run it again and click on the button: <br><img src="https://habrastorage.org/files/8e4/628/af7/8e4628af7d734357bea35db81cc80e92.png"><br>  Hurray, it works! <br><br>  However, not everything is so rosy ... <br>  The first thing that catches your eye is that such windows are created very slowly, 10 times slower than usual. <br>  The second is that even elementary dragging of the window, let alone resize, under which you can observe wonderful artifacts (I apologize for the photo from the screen, but due to the specific work of <b>Windows</b> with such windows, is not visible on the screenshots of artifacts), has slowed down: <br><img src="https://habrastorage.org/files/ef8/203/dbb/ef8203dbb1144bc3a3e4dbf282eadd80.png"><img src="https://habrastorage.org/files/1fc/863/d13/1fc863d138e04b6ea4c365313a385cd9.png"><br>  This is a must see, do not be lazy and play with an example. <br><br>  If you press the button several times, it will freeze not only the application, but also ... the whole system, which does not happen when creating ordinary windows. <br>  This leads to the conclusion that, <b>unfortunately, such a great opportunity was not implemented qualitatively, and its use in real applications is not possible</b> . <br><br>  And one more experiment, about how to suspend the entire system (only save all your data first). <br>  Add another button to the form and make such an infinite loop in the handler: <br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TfrmMain</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoopClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Win8Control: TWin8Control; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> True <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Win8Control := TWin8Control.Create(Self, Image.Picture.Bitmap); Win8Control.Parent := Self; Win8Control.Top := Random(<span class="hljs-number"><span class="hljs-number">400</span></span>); Win8Control.Left := Random(<span class="hljs-number"><span class="hljs-number">400</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br>  After clicking on the button, <b>Windows</b> will only be busy creating <b>Layered</b> windows and nothing else will react even to <b>Ctrl + Alt + Del</b> :) <br><br>  Project on GitHub: <a href="https://github.com/errorcalc/LayeredTest">https://github.com/errorcalc/LayeredTest</a> </div><p>Source: <a href="https://habr.com/ru/post/247397/">https://habr.com/ru/post/247397/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../247385/index.html">Fourier transform in action: accurate signal frequency determination and note highlighting</a></li>
<li><a href="../247389/index.html">How to enable the display of Facebook applications on mobile devices?</a></li>
<li><a href="../247391/index.html">Fail2ban integration with CSF to counter DDoS on nginx</a></li>
<li><a href="../247393/index.html">https comes on geektimes / habrahabr?</a></li>
<li><a href="../247395/index.html">Internet in a closed country: the experience of North Korea</a></li>
<li><a href="../247399/index.html">History of the creation of Norton Commander. Part 1: introduction</a></li>
<li><a href="../247401/index.html">Five popular myths about C ++, part 1</a></li>
<li><a href="../247405/index.html">Approaches to the creation of a scripting language for the description of board games</a></li>
<li><a href="../247409/index.html">Potential Android Telegram Vulnerability</a></li>
<li><a href="../247413/index.html">Pulp Fiction Weekend - Microsoft Press Free Books</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>