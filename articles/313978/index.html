<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>GPU animations: doing it right</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think everyone already knows that modern browsers can draw some parts of the page on the GPU. This is especially noticeable in the animations. For e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>GPU animations: doing it right</h1><div class="post__text post__text-html js-mediator-article"><p> I think everyone already knows that modern browsers can draw some parts of the page on the GPU.  This is especially noticeable in the animations.  For example, an animation made using the CSS <code>transform</code> property looks much nicer and smoother than an animation made through <code>top/left</code> .  However, the question ‚Äúhow to properly do animations on a GPU?‚Äù Is usually answered with something like ‚Äúuse <code>transform: translateZ(0)</code> or <code>will-change: transform</code> ‚Äù.  These properties have already become something like <code>zoom: 1</code> for IE6 (if you know what I mean;) to prepare a layer for animation on the GPU or <em>composition</em> (compositing), as browser developers prefer to call it. </p><br><p>  However, very often animations that worked beautifully and smoothly on simple demos suddenly start to slow down on the finished site, cause various visual artifacts or, even worse, lead to browser crash.  Why it happens?  How to deal with it?  Let's try to understand this article. </p><a name="habracut"></a><br><h2 id="one-big-disclaimer">  One big disclaimer </h2><br><p>  The most important thing I want to say before we start exploring the details of a GPU composition: <strong>it's all one huge hack</strong> .  You will not find in the <a href="https://www.w3.org/">W3C</a> specifications (at least for now) a description of the process of a GPU composition, methods of explicitly transferring an element to a separate layer, or even the mode of composition itself.  This is just a way to speed up some typical tasks and each browser developer does this in his own way.  Everything that you read in this article is by no means an official explanation, but the results of experiments and observations, seasoned with common sense and knowledge of the work of some browser subsystems.  Something may be wrong, but something will change with time - I warned you! </p><br><h2 id="kak-rabotaet-kompoziciya">  How composition works </h2><br><p>  In order to properly prepare a page for a GPU animation, it is very important not so much to follow the tips found on the Internet or in this article, but to understand how it works inside the browser. </p><br><p>  Suppose we have a page with elements <code>A</code> and <code>B</code> that have <code>position: absolute</code> and a different <code>z-index</code> .  The browser will draw the entire page on the CPU, send the resulting image to the GPU, and from there it will get to us on the screen. </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css"> </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#a</span></span></span><span class="css">, </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#b</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">position</span></span></span><span class="css">: absolute; } </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#a</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">left</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">30px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">top</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">30px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">z-index</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">2</span></span></span><span class="css">; } </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#b</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">z-index</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">1</span></span></span><span class="css">; } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#a"</span></span></span><span class="hljs-tag">&gt;</span></span>A<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#b"</span></span></span><span class="hljs-tag">&gt;</span></span>B<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p><img src="https://habrastorage.org/files/6ee/852/9fc/6ee8529fc82a416aa25136821d7647b2.png" alt="example 1"></p><br><p>  We decided to animate the movement of the <code>A</code> element via the CSS <code>left</code> property using CSS Animations: </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css"> </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#a</span></span></span><span class="css">, </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#b</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">position</span></span></span><span class="css">: absolute; } </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#a</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">left</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">10px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">top</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">10px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">z-index</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">2</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">animation</span></span></span><span class="css">: move </span><span class="hljs-number"><span class="css"><span class="hljs-number">1s</span></span></span><span class="css"> linear; } </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#b</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">left</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">50px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">top</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">50px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">z-index</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">1</span></span></span><span class="css">; } @</span><span class="hljs-keyword"><span class="css"><span class="hljs-keyword">keyframes</span></span></span><span class="css"> move { </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">from</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">left</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">30px</span></span></span><span class="css">; } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">to</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">left</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">100px</span></span></span><span class="css">; } } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#a"</span></span></span><span class="hljs-tag">&gt;</span></span>A<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#b"</span></span></span><span class="hljs-tag">&gt;</span></span>B<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p><img src="https://habrastorage.org/files/764/ed2/88f/764ed288f51e4b1482b9cede0ea1bb45.gif" alt="example 1-2"></p><br><p>  In this case, for each frame of the animation, the browser from the CPU side recalculates the geometry of the elements (reflow), draws a new image with the current page state (repaint), also sends it to the GPU, after which it is displayed on the screen.  We know that repaint is a rather expensive operation, but all modern browsers are smart enough to redraw not the entire image, but only the changed parts.  And they do it quickly enough, but the animations still lack smoothness. </p><br><p>  Recalculation of geometry and redrawing, albeit partial, of the entire page for each step of the animation: looks like a very time-consuming operation, especially on large and complex sites.  <em>It would be much more effective to draw two images once: element <code>A</code> and the page itself without element <code>A</code> , and then simply move these images relative to each other.</em>  In other words, you need to make a <em>composition of</em> cached images of elements.  And this is exactly the task that the GPU does best.  Moreover, he knows how to do it with <em>sub-pixel precision</em> , which gives the very smooth animation. </p><br><p>  To apply composition optimization, the browser must be sure that the CSS properties to be animated: </p><br><ol><li>  do not affect the flow of the document; </li><li>  do not depend on the flow of the document; </li><li>  will not require redrawing the element itself. </li></ol><br><p>  From the side it may seem that the <code>top</code> and <code>left</code> properties together with <code>position: absolute/fixed</code> do not depend on external factors, but this is not so.  For example, the <code>left</code> property can take values ‚Äã‚Äãin percent, which depend on the size of the <code>.offsetParent</code> , as well as the units <code>em</code> , <code>vh</code> , etc., which depend on the environment.  Therefore, it is the CSS properties <code>transform</code> and <code>opacity</code> fit the description. </p><br><p>  Let's remake our animation: instead of <code>left</code> we will animate the <code>transform</code> : </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css"> </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#a</span></span></span><span class="css">, </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#b</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">position</span></span></span><span class="css">: absolute; } </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#a</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">left</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">10px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">top</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">10px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">z-index</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">2</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">animation</span></span></span><span class="css">: move </span><span class="hljs-number"><span class="css"><span class="hljs-number">1s</span></span></span><span class="css"> linear; } </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#b</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">left</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">50px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">top</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">50px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">z-index</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">1</span></span></span><span class="css">; } @</span><span class="hljs-keyword"><span class="css"><span class="hljs-keyword">keyframes</span></span></span><span class="css"> move { </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">from</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">transform</span></span></span><span class="css">: </span><span class="hljs-built_in"><span class="css"><span class="hljs-built_in">translateX</span></span></span><span class="css">(0); } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">to</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">transform</span></span></span><span class="css">: </span><span class="hljs-built_in"><span class="css"><span class="hljs-built_in">translateX</span></span></span><span class="css">(70px); } } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#a"</span></span></span><span class="hljs-tag">&gt;</span></span>A<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#b"</span></span></span><span class="hljs-tag">&gt;</span></span>B<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Pay attention to the code.  We declaratively described the entire animation: its beginning, end, duration, etc.  And this allows the browser to determine which CSS properties of the element will change even before the animation begins.  Having seen that among these properties there are no those that affect reflow / repaint, the browser can apply optimization with composition: draw two images and transfer them to the GPU. </p><br><p><img src="https://habrastorage.org/files/407/9a2/a20/4079a2a20eef49a8b85e5583a4c0c534.gif" alt="example 2"></p><br><p>  The advantages of this optimization: </p><br><ul><li>  Very smooth animation with <em>sub-pixel anti-aliasing</em> : it is now engaged in a graphics processor, specially optimized for such tasks. </li><li>  The animation does not depend on the CPU: even if at this moment we perform very intensive calculations, the animation will continue to be smooth, as it is performed entirely on the GPU. </li></ul><br><p>  It would seem that everything is simple and clear, what problems may arise?  Let's take a look at what this optimization actually does. </p><br><hr><br><p>  Perhaps for some it will be a discovery, but the GPU is a <em>separate computer</em> .  Yes, an integral part of all modern devices is actually an independent subsystem with its own processors, memory and information processing methods.  And the browser, like any other program or game, is forced to communicate with the GPU just as with a separate device. </p><br><p>  To better understand this, just remember AJAX.  For example, you need to register a user by the data that he entered in the authorization form.  You cannot tell the remote server ‚Äúhey, take the data from these fields here and that variable and save it in the database‚Äù because the server does not have access to the browser‚Äôs memory.  Instead, you collect the necessary data from the page into some kind of payload with a simple data format (for example, JSON) and send it to the server. </p><br><p>  The same thing happens during composition.  Since the GPU, in fact, is a remote server, the browser on the part of the CPU is forced to first prepare a special payload, and then send it to the device.  Yes, the GPU is very close to the CPU, but if 2 seconds to send and receive a response via AJAX are often quite acceptable, then an extra 3-5 milliseconds to transfer data to the GPU can seriously degrade the quality of the animation. </p><br><p>  What is the payload for a GPU?  As a rule, these are <em>images of layers</em> and additional instructions that determine the sizes of layers, their location relative to each other, instructions for animation, etc.  Here is how the process of creating the load and its transfer to the GPU looks approximately: </p><br><ul><li>  Render each composite layer into a separate image. </li><li>  Preparation of data on layers (location, size, transparency, etc.). </li><li>  Shader preparation for animation (if using CSS Transitions or Animations). </li><li>  Sending data to the GPU. </li></ul><br><p>  Thus, each time you add a magical <code>transform: translateZ(0)</code> or <code>will-change: transform</code> element, you start this whole process.  You already know that repaint is quite a resource-intensive task.  But in this case everything is still worse: quite often the browser cannot use the incremental repaint and redraw only the changed part.  It must re-draw those parts that were hidden by the new layer: </p><br><p><img src="https://habrastorage.org/files/6a2/226/55e/6a222655edf242c5b993b1807f075c59.png" alt="example 3"></p><br><h2 id="neyavnaya-kompoziciya">  Implicit composition </h2><br><p>  Let's go back to our example with elements <code>A</code> and <code>B</code>  Previously, we animated element <code>A</code> , which is on top of all other elements on the page.  The result was a composition of two layers: a layer with <code>A</code> and a layer with <code>B</code> and the background of the page. </p><br><p>  Now let's change the task: we will animate the element <code>B</code> ... </p><br><p><img src="https://habrastorage.org/files/6da/938/2bf/6da9382bff8c4913845012d72e38feee.gif" alt="example 4"></p><br><p>  ... and we have a logical problem.  Element <code>B</code> must be on a separate composite layer, the final composition of the image that the user sees occurs on the GPU.  But the element <code>A</code> , which we don‚Äôt touch at all, should visually be <em>on top of the</em> element <code>B</code> </p><br><p>  We recall <strong>One Big Disclaimer</strong> - in CSS there is no special mode for a GPU composition, this is just an optimization for solving specific problems.  We <em>must</em> get the elements <code>A</code> and <code>B</code> exactly in the order that was given through the <code>z-index</code> .  What should the browser do in this case? </p><br><p>  Exactly: it will transfer element <code>A</code> to a separate composite layer!  Adding another heavy repaint: </p><br><p><img src="https://habrastorage.org/files/f06/6bb/27a/f066bb27a9cd477ab3f805ed28f96b23.gif" alt="example 4-2"></p><br><blockquote>  This is called <em>implicit composition</em> : one or more non-composite elements that are above the composite element in the <code>z-index</code> also become composite, that is, they are drawn into a separate image, which is then sent to the GPU. </blockquote><p>  You will encounter implicit composition much more often than you think: the browser places an element on the composite layer for many reasons: </p><br><ul><li>  3D transformations: <code>translate3d</code> , <code>translateZ</code> , etc. </li><li>  The elements <code>&lt;video&gt;</code> , <code>&lt;canvas&gt;</code> , <code>&lt;iframe&gt;</code> . </li><li>  Animation <code>transform</code> and <code>opacity</code> via <code>Element.animate()</code> . </li><li>  Transform and <code>opacity</code> animation via CSS Transitions and Animations. </li><li>  <code>position: fixed</code> . </li><li>  <a href="https://www.w3.org/TR/css-will-change-1/"><code>will-change</code></a> . </li><li>  <a href="https://drafts.fxtf.org/filters/"><code>filter</code></a> . </li></ul><br><p>  Read more in the CompromitingReasons.h file of the Chromium project. </p><br><p>  At first glance, it may seem that the main problem with GPU animations is unexpected, heavy repaint.  But it is not.  The biggest problem is ... </p><br><h2 id="potreblenie-pamyati">  Memory consumption </h2><br><p>  And again, we remember that the GPU is a separate computer.  The rendered images of the layers need not only be transferred to the GPU, but also <em>stored</em> there in order to animate beautifully later. </p><br><p>  How much does the image of one layer weigh?  Let's take an example.  Try to guess the size of a regular rectangle, 320 √ó 240, filled with solid color <code>#ff0000</code> . </p><br><p><img src="https://habrastorage.org/files/34b/218/0dd/34b2180ddf734fed84b96723f220c7ad.png" alt="rect"></p><br><p>  Usually web developers think like this: ‚Äúthis is a single-color image ... I‚Äôll save it to PNG and check the size, it must be less than a kilobyte‚Äù.  And they will be right: this image really weighs only 104 bytes in PNG. </p><br><p>  But the problem is that PNG (like JPEG, GIF, etc.) is a format for storing and transferring data.  To draw such an image on the screen, the computer must unpack it and <strong>present it as an array of pixels</strong> .  Thus, our image in the computer memory will occupy <em>320 √ó 240 √ó 3 = 230,400 bytes</em> .  That is, we multiply the width of the image by its height - so we get the number of pixels.  Then the number of pixels is multiplied by 3, since the color of each pixel is described by 3 bytes: RGB.  If the image were translucent, we would be multiplied by 4, since we need another byte to describe the value of transparency (RGBA): <em>320 √ó 240 √ó 4 = 307,200 bytes</em> . </p><br><p>  The browser <em>always</em> draws composite layers to RGBA images: apparently, there is not a sufficiently fast and efficient way to automatically determine if the DOM element being drawn has transparent areas. </p><br><p>  Consider a typical example: a carousel of 10 photos of size 800 √ó 600.  You decided to make a smooth change of images in the carousel, so in advance of each photo, you <code>will-change: transform</code> , and then use JS to animate transitions to the user's action, for example, dragging.  Let us calculate how much <em>additional</em> memory is required to simply display such a page: 800 √ó 600 √ó 4 √ó 10 ‚âà <strong>19 MB</strong> . </p><br><p>  19 MB of additional memory was required to render just one control per page.  And considering the love of modern developers for SPA-pages with a lot of animated controls, parallax effects, retina-images and other visual pieces, an additional 100‚Äì200 MB per page is far from the limit.  Add to this an implicit composition (admit it, haven't you even thought about it before? :) and we‚Äôll get a very sad picture. </p><br><p>  Moreover, quite often this additional memory is wasted, just to display the exact same result: </p><br><p><img src="https://habrastorage.org/files/357/08f/db2/35708fdb20c8470580e55c2f13444284.png" alt="example 5"></p><br><p>  And if for desktop clients it is still not so strongly noticeable, then for mobile devices this problem is particularly acute.  First, almost all modern devices use screens with a high pixel density: we multiply the image layers by another 4‚Äì9.  Secondly, on such devices <em>quite a bit of memory</em> , compared with desktops.  For example, the still-not-so-old iPhone 6 has only 1 GB of memory, and it‚Äôs common for RAM and VRAM (memory for the GPU).  Considering that, at best, a third of this memory will be used by the system itself and background processes, another third by the browser and the current page (and this is on condition that you do not use dozens of frameworks and optimize everything very much), then for GPU special effects will remain about 200-300 MB.  Moreover, the iPhone 6 is an expensive high-end device, on more affordable devices, memory is much less. </p><br><p>  You may have a reasonable question: is <em>it possible to store pictures on the GPU in PNG format to save memory?</em>  Yes, technically it is possible, but the feature of the GPU is that <a href="http://www.html5rocks.com/en/tutorials/webgl/shaders/">each layer is drawn pixel-by-pixel</a> .  This means that in order to draw one pixel on the screen, you will need to re-decode the PNG image each time to get the desired color.  In this case, the speed of the simplest animation is unlikely to rise above 1 fps. </p><br><p>  It is worth noting that GPUs have their own <a href="https://en.wikipedia.org/wiki/Texture_compression">image compression formats</a> , but they are not even closely comparable to PNG or JPEG in terms of compression, and the possibility of using them, including limited support for the GPU itself. </p><br><h2 id="za-i-protiv">  Pros and cons </h2><br><p>  Now that we have reviewed the theoretical part of the work of animations on the GPU, let us, for convenience, gather all the pros and cons of using them. </p><br><h3 id="za">  Behind </h3><br><ul><li>  Very smooth animations with sub-pixel accuracy and speed of 60 fps. </li><li>  Properly made animations work in a separate thread and are not blocked by heavy JS operations. </li><li>  "Cheap" 3D-conversion. </li></ul><br><h3 id="protiv">  Vs </h3><br><ul><li>  To remove an element on the composite layer, an additional repaint is required, sometimes it can be very slow (full drawing of the element instead of incremental). </li><li>  The drawn layer must be transferred to the GPU: the more layers and the larger their size, the more time is required for transmission.  On medium and weak mobile devices, you can notice a "blink" when the element disappears and immediately appears. </li><li>  <em>Each composite layer takes up additional memory.</em>  Memory is a very limited resource on mobile devices.  <strong>Excessive memory consumption can lead to browser crash!</strong> </li><li>  Implicit composition: if you do not follow it, the time for repaint increases, memory consumption and chances to ‚Äúdrop‚Äù the browser increase. </li><li>  Visual artifacts: drawing text in Safari, disappearing or distorted page fragments. </li></ul><br><p>  As you can see, for all its unique virtues, GPU-animation has a number of very significant drawbacks, the main of which are repaint and memory consumption.  Therefore, all of our optimizations will be linked precisely with these two points. </p><br><h2 id="nastraivaem-okruzhenie">  Customize the environment </h2><br><p>  Before we begin to optimize the site for high-quality animations, we need to stock up on special tools that will not only show us the result of optimizations, but also problem areas. </p><br><h3 id="safari">  Safari </h3><br><p>  Safari Web Inspector has a great tool built in that allows you to see all the composite layers on the page, the memory they use, and also - which is no less valuable - show the <em>reason for moving the item to a separate layer</em> .  To see this tool: </p><br><ol><li>  In Safari, open Web Inspector with ‚åò‚å•I.  If it does not work, try in Preferences&gt; Advanced enable the <em>Show Develop Menu in menu bar</em> option and try again. </li><li>  In the Web Inspector, open the Elements tab and select Layers in the right column. </li><li>  Now, when you click on the elements in the main part of the Elements tab, on the right you will see information about the composite layer for this element (if it exists), as well as a list of all child elements with their own layers. </li><li>  If you click on the child layer, the reason for the composition is displayed - why the browser decided to move the element to a separate composite layer. </li></ol><br><p><img src="https://habrastorage.org/files/736/250/350/736250350ab642c2bd0e0584f6e4933c.png" alt="Safari with Web Inspector"></p><br><h3 id="google-chrome">  Google chrome </h3><br><p>  DevTools also has a similar tool, but to enable it you need to set a special flag: </p><br><ol><li>  In your browser, go to <code>chrome://flags/#enable-devtools-experiments</code> and enable the <strong>Developer Tools experiments</strong> flag. </li><li>  Open DevTools using ‚åò‚å•I (Mac) or Ctrl-Shift-I (PC), click on the icon <img src="https://habrastorage.org/files/d15/27c/e20/d1527ce204894a61a856db13ac36f9f2.png" alt="Chrome with DevTools">  in the upper right corner and go to the Settings section. </li><li>  Select the Experiments section in the menu and turn on the Layers panel. </li><li>  Close and reopen DevTools: you will see the Layers panel. </li></ol><br><p><img src="https://habrastorage.org/files/60c/5c9/6ea/60c5c96ea43c4fd3beb835c128d5c5c9.png" alt="Chrome with DevTools"></p><br><p>  This pane displays all active composite layers of the page as a tree.  If you select a layer, information about it will be available: size, amount of memory used, the number of redraws, as well as the reason for moving to the composite layer. </p><br><h2 id="optimizaciya">  Optimization </h2><br><p>  So, we set up the environment and now we can proceed directly to the optimization.  We have already identified two main problems with the use of composite layers: an extra repaint, after which the image of the layer needs to be transferred to the GPU, and memory consumption.  Therefore, all our optimizations will be aimed at reducing redraw cycles and reducing memory consumption. </p><br><h3 id="izbegayte-neyavnoy-kompozicii">  Avoid implicit composition </h3><br><p>  Very simple, obvious, but the most important optimization.  Let me remind you that an implicit composition is the removal of elements onto a separate composite layer only in order to correctly link it onto the GPU with another, explicit composite layer (video, CSS animation, etc.).  Especially strongly this problem can be felt on mobile devices at the start of the animation. </p><br><p>  Consider a small example. </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://codepen.io/sergeche/embed/preview/jrZZgL" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  We have the element <code>A</code> , which we want to animate by user action.  If you look at the page using the Layers tool, we will see that there are no additional layers on it.  However, immediately after clicking on the Play button, several composite layers will appear, which will disappear by the end of the animation.     Timeline,  ,       repaint   : </p><br><p><img src="https://habrastorage.org/files/db2/aab/cd8/db2aabcd84d2470c94cfb7839c022dcd.png" alt="Chrome timeline"></p><br><p>   ,      . </p><br><ol><li>     ,        ,         .  ‚Äî           . </li><li>    Play      <code>A</code> ‚Äî CSS Transition  <code>transform</code> .   ,   <code>z-index</code>  <code>A</code>  <em></em>  <code>B</code> .           . </li><li>      <em></em>  repaint. -,    -  ,  - ‚Äî      .         . </li><li>       GPU,         ,   . <em>    ,      ,      GPU    .</em>      ¬´¬ª     :         . </li><li>          <code>A</code> .     ,             ,        ‚Äì   <code>A</code>  <code>B</code>   .   ,        (  repaint)      GPU.    ,    .4,   ¬´¬ª. </li></ol><br><p>          ,  : </p><br><ul><li>         <code>z-index</code> .         <code>&lt;body&gt;</code> .  ,     -  ,       DOM-    .       ,   ,      <code>&lt;body&gt;</code> . </li><li>    ,     ,   CSS- <a href="https://developer.mozilla.org/docs/Web/CSS/will-change"><code>will-change</code></a> .       (  !)           .      ,      . </li></ul><br><h3 id="animiruyte-tolko-svoystva-transform-i-opacity">    <code>transform</code>  <code>opacity</code> </h3><br><p>              ,     ,      GPU.   ,       , , , ,   ,     3D-.          . </p><br><p>   :     .     ,    : </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bg-change"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css"> </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#bg-change</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">width</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">100px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">height</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">100px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">background</span></span></span><span class="css">: red; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">transition</span></span></span><span class="css">: background </span><span class="hljs-number"><span class="css"><span class="hljs-number">0.4s</span></span></span><span class="css">; } </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#bg-change</span></span></span><span class="hljs-selector-pseudo"><span class="css"><span class="hljs-selector-pseudo">:hover</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">background</span></span></span><span class="css">: blue; } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>      CPU,  repaint       .        GPU:              : </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bg-change"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css"> </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#bg-change</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">width</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">100px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">height</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">100px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">background</span></span></span><span class="css">: red; } </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#bg-change</span></span></span><span class="hljs-selector-pseudo"><span class="css"><span class="hljs-selector-pseudo">::before</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">background</span></span></span><span class="css">: blue; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">opacity</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">transition</span></span></span><span class="css">: opacity </span><span class="hljs-number"><span class="css"><span class="hljs-number">0.4s</span></span></span><span class="css">; } </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#bg-change</span></span></span><span class="hljs-selector-pseudo"><span class="css"><span class="hljs-selector-pseudo">:hover</span></span></span><span class="hljs-selector-pseudo"><span class="css"><span class="hljs-selector-pseudo">::before</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">opacity</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">1</span></span></span><span class="css">; } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>        ,          .     -   . </p><br><h3 id="umenshayte-gabarity-kompozitnyh-sloyov">     </h3><br><p>    .      ? </p><br><p><img src="https://habrastorage.org/files/4ac/f27/127/4acf271270c8453fb39f926edca29749.png" alt="example 6"></p><br><p>   <em> </em>  ,    40 000  (39 ),   ‚Äî  100  ,  400 .  Why?  <a href="https://sergeche.github.io/gpu-article-assets/examples/layer-size.html"> </a>  : </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"a"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"b"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css"> </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#a</span></span></span><span class="css">, </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#b</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">will-change</span></span></span><span class="css">: transform; } </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#a</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">width</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">100px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">height</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">100px</span></span></span><span class="css">; } </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#b</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">width</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">10px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">height</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">10px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">transform</span></span></span><span class="css">: </span><span class="hljs-built_in"><span class="css"><span class="hljs-built_in">scale</span></span></span><span class="css">(10); } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>   ,    <code>#a</code>   ‚Äî 100√ó100  (100√ó100√ó4 = 40 000 ),    <code>#b</code> ‚Äî 10√ó10  (10√ó10√ó4 = 400 ),   100√ó100   <code>transform: scale(10)</code> .    <code>#b</code>    - <code>will-change</code> ,  <code>transform</code>        GPU     . </p><br><p>    :   <code>width</code>  <code>height</code>    ,    <code>transform: scale(‚Ä¶)</code>       .  ,              . , ,      ,       5‚Äì10%      :        ,     . </p><br><h3 id="po-vozmozhnosti-ispolzuyte-css-transitions-i-animations">    CSS Transitions  Animations </h3><br><p>   ,    <code>transform</code>  <code>opacity</code>  CSS Transitions  Animations         GPU.         JS,    ,  ,      ,      :  <code>translateZ(0)</code>  <code>transform</code> , <code>will-change: transform, opacity</code>   ,   . </p><br><blockquote>  JS-   ,    <code>requestAnimationFrame</code>    .  <a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/animate"><code>Element.animate()</code></a>    CSS-. </blockquote><p>    CSS Transitions/Animations     ,   ‚Äî  JS       ,   CSS,         . </p><br><p>       ? ,    JS   -    ? </p><br><p>     CSS-     : <em>    GPU</em> .    <em></em> ,      ,             GPU.   <em></em> JS ,     ‚Äî    .        60        ( JS    )          GPU,    .  ,         ,  CSS-,        : </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://codepen.io/sergeche/embed/preview/RoPMKO" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>    ,  ,      JS    .  CSS-    ,          (    ),    JS            . </p><br><p>        CSS,     .       ,         JS. </p><br><h2 id="primer-optimizacii">   </h2><br><p>           ,       <a href="https://ru.4game.com/chaos-fighters/">Chaos Fighters</a> .   -       .      ,    ,          GPU,   ,    .        iPhone 5 ‚Äî        Apple    ‚Äî      .            . </p><br><p>   ,   ,      . </p><br><p>       ,      -   .     :     CSS-.   ‚Äî  :      ,      <code>&lt;img&gt;</code>    CSS-   : </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://codepen.io/sergeche/embed/preview/gwBjqG" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>        .        ‚Äî       . </p><br><p>     .  ,   ,    .   ,               .        ,    . </p><br><p>       : <code>.sun</code>   ,        ;       . </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://codepen.io/sergeche/embed/preview/qaJraq" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>    ,   ,        .      : 500√ó500√ó4 ‚âà 977 . </p><br><blockquote>         ,  500√ó500 ,    ,        (  )   ,     3000√ó3000√ó4 = 36 !         ‚Ä¶ </blockquote><p>         Layers  .      :     .           ,     GPU.  -         (),    ‚Äî <em>  </em> . </p><br><p>  ,      ,  !        ,     . </p><br><p>     ,        :  GPU     ,   .   ,   : </p><br><ul><li>  : 500√ó500√ó4 ‚âà 977  </li><li>  12 : 250√ó40√ó4 √ó 12 ‚âà 469  </li></ul><br><p>     2 .   ,        ,  <em>   </em> .      ,       GPU,       . </p><br><p>          ,   CSS   ,  .         <code>transform</code> .             360Àö.   ,         <code>@keyframes</code> ,   <em>  </em> . </p><br><p>     JS-,               ,    .. </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://codepen.io/sergeche/embed/preview/bwmxoz" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>        ,      2 . </p><br><p>  But that's not all.         ‚Äî  ,  ,  .         .   ,               .    c   GPU   ,       :        . </p><br><p>       10%.     250√ó0.9 √ó 40√ó0.9 = 225√ó36 . ,  <em></em>    250√ó20 ,       250/225 ‚âà 1.111. </p><br><p>       : <code>background-size: cover;</code>  <code>.sun-ray</code> ,       ,   <code>transform: scale(1.111)</code>   . </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://codepen.io/sergeche/embed/preview/YGJOva" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  ,       ,   PNG-   .  ,  ,   ,   PNG-. </p><br><p>         GPU  225√ó36√ó4 √ó 12 ‚âà 380  ( 469 ).     19%      ,    <code>downscale</code>         .     <code>0.1</code> ,  ,     ,  ,          977 / 380 ‚âà 2.5 ! </p><br><p> ,  ,       :     CPU,      JS-.  ,     ,     .   <a href="https://codepen.io/sergeche/pen/YGJOva"> </a>     ,      GPU,         .    . </p><br><h2 id="usvoennye-uroki">  Lessons learned </h2><br><p> ,     Chaos Fighters,        .    : </p><br><ul><li>      ,       .         . </li><li>               Layers,    . </li><li>          ,        . , <code>position: fixed</code> , <code>&lt;iframe&gt;</code> , <code>&lt;video&gt;</code>     . </li><li>        ,   .       (. <a href="https://www.chromium.org/developers/design-documents/gpu-accelerated-compositing-in-chrome">Layer Squashing</a> ) ‚Äî     ,     .     :        ,    .    ,      <code>translateZ()</code>  . : <code>translateZ(0.0001px)</code> , <code>translateZ(0.0002px)</code>  ..  ,         . </li><li>       <code>transform: translateZ(0)</code>  <code>will-change: transform</code>  ,        .     GPU       ,   .          :   .   ‚Äî  ¬´¬ª . </li></ul><br><p>      <strong>One Big Disclaimer</strong> :     GPU-            -. ,          . ,  Google Chrome        CPU  GPU,     ,      .  Safari       (,    <code>background-color</code>   )     CPU    GPU   ,       . </p><br><p>     ,            GPU      . </p><br><p> <em><a href="https://www.smashingmagazine.com/2016/12/gpu-animation-doing-it-right/">English version</a></em> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/313978/">https://habr.com/ru/post/313978/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../313966/index.html">Redux-form. When to work with forms is simple</a></li>
<li><a href="../313968/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ234 (October 24 - 30, 2016)</a></li>
<li><a href="../313970/index.html">Small design algorithms against large decay</a></li>
<li><a href="../313972/index.html">How to deploy for your team an archive of slack messages with synchronization and search</a></li>
<li><a href="../313974/index.html">PHP Digest number 95 - interesting news, materials and tools (October 9 - 30, 2016)</a></li>
<li><a href="../313980/index.html">Integration of the external object system in Delphi on the example of IBM SOM</a></li>
<li><a href="../313982/index.html">"Pitfalls" of a simple electronic signature</a></li>
<li><a href="../313984/index.html">RAM memory for video surveillance</a></li>
<li><a href="../313986/index.html">How to fill a bunch of cones and release the game</a></li>
<li><a href="../313988/index.html">Interview with Pavel R√§ikkonen, Executive Director of Nevosoft</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>