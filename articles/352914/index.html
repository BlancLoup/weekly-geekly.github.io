<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Universal links: the palace of pitfalls</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Given how much mobile apps they gave to humanity, they ‚Äúbroke‚Äù the Internet at the same time. Instead of clear links to sites that can be copied and s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Universal links: the palace of pitfalls</h1><div class="post__text post__text-html js-mediator-article">  Given how much mobile apps they gave to humanity, they ‚Äúbroke‚Äù the Internet at the same time.  Instead of clear links to sites that can be copied and shared, it became necessary to explain "put such an application and go there somewhere." <br><br>  Fortunately, the developers of mobile platforms have realized this problem and proposed the concept of ‚Äúuniversal links‚Äù, which with one click open the right one on any platform.  But the fact that for the user "one click", for the programmer - "with sweat and blood."  On the way to success there is a whole heap of unexpected nuances, and <b>Konstantin Yakushev</b> got to know them on personal experience when introducing universal links into <a href="https://habrahabr.ru/company/badoo/">Badoo</a> .  And then at our conference, <b>Mobius</b> told how to do everything right and get around problems.  The audience liked the report, and we decided that it was useless to use only video recordings, so the text version is under the cut. <br><br>  The report considers the situation from the side of iOS, but universal links to universal and universal ones, in order to unite different platforms, so not only iOS developers can benefit. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <iframe width="560" height="315" src="https://www.youtube.com/embed/Vb28IRC8c6o" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br><h2>  Introduction </h2><br>  My name is Kostya Yakushev and I spent several months debugging universal links in Badoo for everything at once: iOS, Android, web.  I coordinated the actions of all these beautiful guys, because I am a <a href="https://habrahabr.ru/company/avito/blog/343642/">mother architect</a> . <br><br>  And today I will tell you the following: <br><br><ul><li>  What are universal links? </li><li>  Why do you need them </li><li>  How to make them </li><li>  The most important thing: what will be the problem with it </li><li>  And how to solve these problems </li><li>  What a fantastic general algorithm of incredible success that will allow you to do this not in a few months, like us, but in one evening (well, maybe two, then bugs a week) ... </li></ul><br><br>  What is universal links in general?  The story is quite simple.  You use some application, for example, Badoo.  If you opened someone‚Äôs user profile there and you wanted to send a link to this profile to a friend, you press this button with an arrow: <br><br><img src="https://habrastorage.org/webt/jd/0l/ro/jd0lro1xkewpne459eihrlmjr-o.jpeg"><br><br>  You send a link to a friend, she is beautifully displayed in the correspondence, a friend clicks on her, and the page of the same girl opens: <br><br><img src="https://habrastorage.org/webt/ol/0k/0e/ol0k0epcgu3di65wpurqyipymea.jpeg"><br><br>  When a link opens up some content inside the application, this is traditionally referred to as deep linking.  But this is the ideal scenario when a friend has an application installed, and it is under iOS. <br><br>  But in practice, a friend may not have an application, and then we want to send it to the App Store. <br><br>  Or, if we do not really want installations, but we really want to immediately show the page, send it to the mobile version. <br><br>  Either a friend even opened a link on the desktop, and then he needed to send a desktop site. <br><br>  But the worst thing that a friend might have is Android!  And this should work too. <br><br><img src="https://habrastorage.org/webt/no/fo/fi/nofofioaawsvkyk00a3h3zekhrq.jpeg"><br><br>  When a link has all these properties, or at least some of them, it is called a universal link.  And about them I will tell you how to do it. <br><br>  This is how it looks from a more algorithmic point of view.  If the link is open from the desktop, we open the desktop web, if from the smartphone we‚Äôre looking to see if the application is installed, and depending on the answer, either open it in the application or enter the application store.  In the case of the store, ideally, we want the user to immediately go to the place where he originally wanted after the first launch of the application after installation. <br><br><img src="https://habrastorage.org/webt/xl/f9/ka/xlf9kaf-o_pudajghvr1f2e_hvo.jpeg"><br><br>  Why is all this necessary?  Million applications. <br><br>  For example, you want to send a letter to the user "see, you have a new like."  It would be great if you click on ‚ÄúTake a look‚Äù to open a new like. <br><br><img src="https://habrastorage.org/webt/u4/jr/ud/u4jrud01xybl-rip2ynfdehibta.jpeg"><br><br>  For example, the Serebro group has opened a profile in your application.  You want them to publish a link under their clips that would also open this profile. <br><br><img src="https://habrastorage.org/webt/mn/6h/wp/mn6hwpvtggtmk3ghtvfcricrm40.jpeg"><br><br>  For example, you advertise on Facebook.  Facebook is very scrupulous about the fact that if something specific is shown on the ad, the link should also lead to that particular one.  That is, if you see a profile of a girl in an advertisement, then they insist that the same girl could be seen in the application. <br><br><img src="https://habrastorage.org/webt/oz/o-/a8/ozo-a8rspkgjq6xizncd20re-sw.jpeg"><br><br>  Not necessarily we should talk about the dating, in other cases, too many applications. <br><br>  And the ‚Äúshare‚Äù button, about which I have already spoken, is the most important, the coolest, the coolest, but also the most difficult. <br><br>  The idea here is that users want to share something in your application.  This is even more important for other non-dated applications.  Suppose if you have a travel app, users will definitely want to share tickets or hotels.  They send links to their friends for free, thereby making advertising to your application.  Ideally, this leads to new installations, to organic growth, and at the same time almost free of charge (at a price, in fact, the implementation of this technology). <br><br>  And here we understood that it is cool and we want it, we gathered and began to think how to do it.  There are several services: everyone knows branch.io, there are AppsFlyer, there are still some strange services, and you can make your own bike.  It all ended with the fact that we made our bike, but tell you how it came to this. <br><br>  First we went to look at branch.io.  Everything that they do is connected solely with deep links: on the site deep linking is written on the site, but two points on the sides, in general, also mean diplinking. <br><br><img src="https://habrastorage.org/webt/_6/rj/aq/_6rjaqybyylfylwmjubd_bxcvqu.jpeg"><br><br>  They have a lot of cool customers, our favorite competitor Tinder uses them.  And in some cases they are free.  But in our case, they were not free at all. <br><br>  They are, of course, experts in the subject, they write a million blog posts that tell about the same problems that I‚Äôm going to tell you about.  However, when in a post they move from problem to solution, they knead it a little bit and say ‚Äúwell, use our service, we know how to do it‚Äù.  Fortunately, you have me. <br><br><img src="https://habrastorage.org/webt/6v/0j/qf/6v0jqfegz6vxyl5emcfgnbwsedw.jpeg"><br><br>  AppsFlyer is a marketing service that is primarily intended for tracking installations, to determine where users came from, measure the effectiveness of advertising campaigns, and so on.  When we started doing universal links, Badoo already used this service for other tasks, and our marketing specialists simply adore it.  If you lean our marketer against a wall and ask if AppsFlyer is cool, he will say: ‚ÄúVery cool, all other services are much worse.  And don't lean me more against the wall, please. ‚Äù <br><br>  AppsFlyer also has a lot of cool customers, Tinder also uses it - for everything except diplinks, but then it didn't bother us.  We go to the site, we see the inscription "The most world's powerful deeplinking platform" - well, we must take.  In addition, at that time it was for us, in general, free of charge, because it was part of the product for which we already pay. <br><br><img src="https://habrastorage.org/webt/fy/-q/rb/fy-qrbiltochqe2ygakd8qi1g7i.jpeg"><br><br>  We went to their site.  Then there was such a scheme, but now it is no longer on the site.  In principle, this is the same as I showed before.  You follow the link; if the application is installed, it starts; if not, go to the App Store.  But! <br><br>  As it turned out, the part where the application is not installed, we go to the AppStore and after installation we open the content, it works.  And this is logical: these guys are engaged in tracking installations, they ate this dog. <br><br>  But here the ‚Äúapplication is already installed‚Äù part, when we implemented it, for some reason, instead of opening the content, also showed the question ‚ÄúOpen this page in the App Store?‚Äù. <br><br><img src="https://habrastorage.org/webt/dm/z4/gg/dmz4ggytj1e1pipzydq4e3vo48q.jpeg"><br><br>  Then we stopped blindly following the SDK and sat down to figure out how it basically works.  And to explain why they have this error and what we have done with it, you need to start from the very beginning. <br><br><h2>  From the very beginning </h2><br>  Here is the archetypical diplink: <br><br><img src="https://habrastorage.org/webt/_x/me/jl/_xmejlpo0syzvv16axsvvosr3_o.jpeg"><br><br>  There is a custom badoo: // scheme, some thing that we want to open (say, a user), and there is an ID of this user. <br><br>  It is clear that in raw form this link can not be used for a very simple reason.  If the application is installed, it works as a link, but if not installed, it results in the error "Safari cannot open the page".  This is logical, Safari has no idea how to work with it. <br><br>  Until recently, it was quite easy.  We do the usual HTML thing, in which we have a few things: <br><br><img src="https://habrastorage.org/webt/5x/wy/cw/5xwycwpaml3hqj4run3niu6ktpg.jpeg"><br><br>  There is an iframe that gets the parameters from the URL and has the same deep link.  And there is JavaScript that redirects in the App Store.  The idea is that if you have an application installed - the iframe will work, if it is not installed, the redirect will work, and everyone is happy, the error will not come out. <br><br>  In addition, to the HTML page, you can add Open Graph tags that will allow the link to look as beautiful as I showed: it has a picture, a preview, and all that. <br><br><img src="https://habrastorage.org/webt/ux/_g/6-/ux_g6-ivuxnhcbbrpj9birjx4pa.jpeg"><br><br>  So, starting around iOS 9, this beautiful scheme has stopped working. <br><br>  What does "stop working" mean?  This means that it began to work as if you were just fumbling the badoo: // link.  If the application is installed - it works, if not installed - it shows an error (in general, on top of the redirect).  That is, if the user follows the link and it does not have an application installed, an error occurs.  And Apple broke it completely consciously. <br><br>  What for?  Because they came up with something "fundamentally new and fantastic": universal links. <br><br>  In their idea, you simply register the entire link, the entire domain as a universal link.  And when I say ‚Äúfundamentally new and fantastic‚Äù way, I mean ‚Äúalmost fundamentally new‚Äù, in Android it has been for many years. <br><br><img src="https://habrastorage.org/webt/26/ub/wi/26ubwimckfukglpqe-foy3k5eqk.jpeg"><br><br>  Why did they do it? <br><br><ul><li>  First, the badoo: // protocol can be registered by anyone, there is no verification.  And the domain is confirmed by DNS. </li><li>  Secondly, privacy: the application no longer gets access to the cookie.  This is what Apple wants every year more and more - to separate the knowledge of the user in Safari from the knowledge of the user in the application. </li></ul>  Thirdly, it helps to get rid of hacks with an i-frame. <br><br>  Finally, (ideally) works equally on all platforms. <br><br>  Unfortunately, when we got rid of hacks with iframes, we got a lot of other hacks, but more on that later.  Now about AppsFlyer.  Remember, it all started with the fact that they do not support universal links. <br><br>  In fact, as it became clear from the documentation, they support them, but they require the use of such a scheme: they expect that we will create a third level domain and the second level domain will belong to them. <br><br><img src="https://habrastorage.org/webt/7q/ow/uy/7qowuyq4avemmzrrkfrtbsjcaps.jpeg"><br><br>  In our case, it was a completely unjustified risk and a very unpleasant story.  Because they could increase their price tag, they could simply close, and our users themselves fumble these links, they should ideally work forever.  We did not like it. <br><br>  But we can solve these problems, right?  Usually we redirect, redirects work on the web, right? <br><br><img src="https://habrastorage.org/webt/ol/cx/6h/olcx6h6rnr5ce50jhb0v15ebrj0.jpeg"><br><br>  And we began to test.  Ok, onelink.me works, we have integrated everything correctly, the SDK starts up, opens Badoo, opens content.  Our link, which is a blunt redirect ... opens Safari.  Wow, we thought. <br><br><img src="https://habrastorage.org/webt/fr/ym/mq/frymmquwjbsvu0ycx7fhkwz_ypa.jpeg"><br><br>  And then we began to maintain a list that was getting longer with each day of our implementation.  It is called "When universal links do not open the application, although you expect it to open." <br><br>  And here is the first item on this list: <br><br><img src="https://habrastorage.org/webt/fp/dk/-k/fpdk-kheczdqjpbezu1tlsfwr5a.jpeg"><br><br>  Redirects for universal links do not work.  This greatly confused us, then we decided to quit AppsFlyer (for this reason, and for some others), having done everything ourselves.  Especially since we already had a ready-made android scheme: <br><br><img src="https://habrastorage.org/webt/be/pt/vt/beptvtn7n8nlvlhp9wbpj0cgxfi.jpeg"><br><br>  It consisted of two parts.  We had a page id (the id of the page to open) and the content id (for example, the user id).  And in principle, it‚Äôs not difficult to do, Apple has a <a href="https://developer.apple.com/library/content/documentation/General/Conceptual/AppSearch/UniversalLinks.html">manual</a> on the site, it takes literally three pages and represents three points. <br><br>  Firstly, you need to add apple-app-site-association - a json-file in which you will have your appID and paths that the application should open in the universal links. <br><br><img src="https://habrastorage.org/webt/h1/h4/x_/h1h4x_pttqaown8snparmoksdps.jpeg"><br><br>  The second.  You need to add domains to the entitlements: <br><br><img src="https://habrastorage.org/webt/sf/tx/yg/sftxygyn27navmvpaopnqg8ijai.jpeg"><br><br>  And third: you need to write some code that, in general, will verify that ActivityType is BrowsingWeb, and the URL is there. <br><br><img src="https://habrastorage.org/webt/bb/bx/-j/bbbx-jq3ndy3xj0_fu90jddqjya.jpeg"><br><br>  We did this, tested a couple of cases, everything worked, and went to argue on the topic of how links should look like. <br><br>  That is the story.  We have our first scheme, which I said, which indicates page id.  There is a second scheme, it is used just by branch.io and AppsFlyer: they usually make it so that you do not have an identifier, but there is just some kind of ref link that the application sends to the server when it starts up, receives in reply where to send it, and landit there. <br><br><img src="https://habrastorage.org/webt/ap/we/2e/apwe2emb1bxizlsdmunyfxpjyga.jpeg"><br><br>  The problem with the second option is that while the application receives content, we would like to show some kind of content framework, and the second scheme does not allow us to do this (in particular, with AppsFlyer, this does not do anything). <br><br>  Ultimately, we decided that we would just use everything at once: <br><br><img src="https://habrastorage.org/webt/df/pg/4l/dfpg4la7akqovtwy5b7oftflxey.jpeg"><br><br>  In principle, this is a normal solution: we can use ref both for statistics and to vary the behavior of the server depending on what kind of link it is (for example, we have links that give credits).  Page id and user id can be used in order to quickly start and immediately get a get user. <br><br>  But there was another problem.  The managers came to us and said: "Guys, you have a very long link, how people will fumble it." <br><br>  Well, again, we know the solution ... to redirect ... um. <br><br><img src="https://habrastorage.org/webt/ld/vc/hi/ldvchiomn4yoyagsu2mfuezaegu.jpeg"><br><br>  In principle, in the short link we will save all the properties, there will be both the page identifier and the content identifier, this can be done.  But how do we redirect? <br><br>  It turns out that in fact, a redirect can be done, but for this you need to make a small hack.  It is quite simple.  Your minifier (it should be your personal minifier) ‚Äã‚Äãis also declared a link in the application, for it you also do the apple-app-site-association, also write code, and, accordingly, both domains are diplink. <br><br><img src="https://habrastorage.org/webt/gt/cq/fb/gtcqfbqxbskcsguxehibcsmpydu.jpeg"><br><br>  Moreover, it can be implemented quite easily.  Simply in the code that opens your application, it makes an http-request for a minicator, looks where the redirect goes, and uses a long link using standard logic. <br><br>  If you remember, with AppsFlyer, the redirected part to app stores works well, and we applied it to the App Store.  This is the only part that we did not do ourselves, but, in principle, you can do it yourself, we just did not want to. <br><br>  What is the idea.  The user opens the AppsFlyer http-link, they do fingerprinting of the user (that is, remembers the IP address, iPhone model, time cut-off and so on, some properties of this phone), and redirect to the App Store.  The user installs, and after that, in the application itself, AppsFlyer SDK matches the devices that recently followed the links with the current device and concludes which link should be opened. <br><br><img src="https://habrastorage.org/webt/8x/8o/s4/8x8os4h_hbddt80ujqtvzgvjpgm.jpeg"><br><br>  Accordingly, the general scheme turned out like this.  Minifikator redirects to our link, but if neither one nor the other link is picked up by the application, then the application does not exist, we redirect to AppsFlyer, it redirects to the App Store with tracking and already does what is needed. <br><br><img src="https://habrastorage.org/webt/yx/36/jl/yx36jlavalelblbtrvdjn7lx1gs.jpeg"><br><br>  While we were engaged in all this garbage, QA came to us and said: "Guys, I send the link to Telegram, to Skype, to HipChat, nothing works."  We: "How wait, everything works for us." <br><br>  It turned out the thing in SafariViewController. <br><br><img src="https://habrastorage.org/webt/a-/qb/gg/a-qbggenp2wlhfplqffm-oa3kfs.jpeg"><br><br>  The story of SafariViewController is completely tragic.  The point is this.  As planned by Apple, if a user opens Safari, enters a universal link into the address, and presses Enter, then it does not open the application.  This is logical: if you are a user, you do not expect that when you press Enter in a browser, you will get into the application. <br><br>  The second part is illogical: when an application opens SafariViewController, exactly the same thing happens as if the user entered a link in the address bar and pressed Enter.  There is no way to open the universal link instead of opening SafariViewController. <br><br>  So we increase this list: <br><br><img src="https://habrastorage.org/webt/jr/ku/ee/jrkueec-npuc50zwywfpyvh_qg8.jpeg"><br><br>  If the user entered the link in Safari himself or opened SafariViewController, nothing works.  We thought for a while, and then we <s>saw a</s> solution. <br><br>  And it is quite logical.  We will open with html-preview, and then click on the button to go to the same link: <br><br><img src="https://habrastorage.org/webt/1l/mx/wy/1lmxwycduhknlhrmsmksfrqntm4.jpeg"><br><br>  And since universal links work in SafariViewController, only the opening of a universal link instead of SafariViewController does not work, this should work, right? <br><br>  Not really. <br><br>  This solution doesn't work either, and here's why: <br><br><img src="https://habrastorage.org/webt/u6/yp/vi/u6ypvig6be9jnxp4rf4ouuqy27w.jpeg"><br><br>  If a user clicks on a link in the same domain on which he is currently located, it does not open the application. <br><br>  What to do? <br><br>  Well, like that - another hack, of course. <br><br>  Everything is very simple: we make two domains, and both register as a universal link.  Here's what it looks like. <br><br><img src="https://habrastorage.org/webt/st/xp/sj/stxpsjdoknolxdd6hti3cw9iyna.jpeg"><br><br>  The user opens m.badoo.com, and on the button he will have mlink.badoo.com.  You can even copy this link and send, it works in both directions, we have these two domains work as equivalent.  Accordingly, if the user opens mlink.badoo.com, he will have on the m.badoo.com button.  Victory. <br><br>  The overall scheme has become even more fun. <br><br><img src="https://habrastorage.org/webt/-z/hv/dx/-zhvdx-ohcqleq24l08j1jktiba.jpeg"><br><br>  Now we have a minifier, which is not shown here.  Domain m.badoo.com button direct in mlink, mlink redirect in AppsFlyer, and there is already a redirect on the App Store with tracking.  It began to work somewhat better.  At least in Safari, in Telegram, people were more or less able to somehow open up. <br><br>  Then our beloved QA, which is already sad-sad, also comes to us again and says: ‚ÄúYou know, very strange things have started to happen here.‚Äù <br><br><img src="https://habrastorage.org/webt/fb/lz/br/fblzbrsq4gfq1bsan7ih562sj8g.jpeg"><br><br>  On some devices, only some, for some reason, universal links did not work.  At all. <br><br>  We found.  When clicking on the universal link and launching the application, this button appeared in the upper right corner: <br><br><img src="https://habrastorage.org/webt/mk/zr/um/mkzrumsikfbrvanhjgywbxuxrog.jpeg"><br><br>  And she does two things.  First, it opens Safari.  Secondly, it breaks diplinks for your application forever! <br><br>  And then the only way to break them back is to make a long tap on the link, click "open in Badoo", and then everything will work back.  But not a single user in my memory has ever thought of this himself.  The general idea: do not touch this button. <br><br>  Fortunately, in its infinite wisdom, Apple has given us a fantastic gift this fall and removed this button from iOS 11. <br><br>  But if you support iOS 9 and 10, remember this button.  And if you suddenly support iOS 9, remember that the apple-app-site-association should not be closed by robots.txt, otherwise it will not work, and this is also a problem that we have encountered. <br><br><img src="https://habrastorage.org/webt/sy/eg/qa/syegqavvtbrygid1v6soudk4mbo.jpeg"><br><br><h2>  Versioning </h2><br><br>  In general, we stuffed an infinite number of cones.  And then something happened that filled us with a second cone of infinity. <br><br>  The company Badoo decided to make a new cool feature "Twins" ("Lookalikes"). <br><br>  The idea is very simple.  You can take a picture of someone or take a finished photo, and we will find in our service the people most like this person.  You can search for celebrities, you can search for friends, you can search for yourself, look at your doppelgangers.  Cool topic. <br><br>  So cool that our managers said about this scheme that they need to change it. <br><br><img src="https://habrastorage.org/webt/4z/jg/wj/4zjgwjhbjetmn96hgfo3j2wjpy4.jpeg"><br><br>  Why?  We really want that when our users share with each other twins, the recipients must see this at all costs, nothing should stand in their way.  Therefore, if the application is not installed, we no longer divert it to the App Store.  We open in the mobile web. <br><br><img src="https://habrastorage.org/webt/f6/zb/ka/f6zbkah2utyo5juzn36zagvli28.jpeg"><br><br>  ‚ÄúOookey,‚Äù we said.  In principle, everything is not so difficult, right?  We say: ‚ÄúWell, if the address is a different page id, we will redirect it to the mobile web‚Äù <br><br><img src="https://habrastorage.org/webt/fb/yu/l_/fbyul_nmifhgdcjcpv3yriw5d-o.jpeg"><br><br>  It was easy, we did.  But then it dawned on us that this is a new functionality that was not previously in our applications. <br><br>  And this means that even if the application is installed, it is still not a fact that we should open it.  In fact, the scheme should look like this: <br><br><img src="https://habrastorage.org/webt/ro/is/yh/roisyh9rlu8lejb3tahurabgbes.jpeg"><br><br>  If the application is installed, you need to check if it supports our new functionality.  And only if it supports, open in the application, and otherwise, again, lead to the mobile web. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Because on some platforms, and on iOS in particular, there was not even an opportunity to open it yet. And so we approach the topic of versioning. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Again, ideally, everything is very simple. We have an old version and a new version. The idea is that the old version opens only the paths / u, and the new version opens / u and, say, / l / a from ‚Äúlook alikes‚Äù. </font></font><br><br><img src="https://habrastorage.org/webt/95/nn/j3/95nnj3p981vk9pn4hxyl4qh0b5a.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We rolled up our sleeves, we think, now we‚Äôll do everything.</font></font> But it was not there. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remember, I was at the beginning told how to customize links? So, the paths that the application supports are indicated in a special file on the site. And only on the site. Accordingly, as soon as we add a new path there, this thing starts to open in the old application and in the new one: </font></font><br><br><img src="https://habrastorage.org/webt/nq/e6/bp/nqe6bpllrn8ljtpesimhkb6rbug.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But in the old application it crashed, because we forgot to think about it. And we could not do anything with it. The only thing we did was wait until the new application rolled for a sufficient number of users, and only then turned it on. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But I can tell you - guys, think about it in advance. Check here if you can open the URL and return false if necessary:</font></font><br><br><img src="https://habrastorage.org/webt/fl/z3/cj/flz3cjbhdgrvcvk62yaopb4yav0.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then, if the users of the old version of the application tries to open something that it does not support, you will open Safari instead. </font><font style="vertical-align: inherit;">And as soon as the new one supports, canOpenUrl will begin to return true, and it will open already.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fantastic algorithm of incredible success. </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">These are the ones we crammed, and the time has come for the fantastic algorithm that I promised you. Important point: this is a fantastic algorithm of incredible success for those who do not want to use branch.io. At this point, we learned that their business is not so much ‚Äúon nothing‚Äù, they are doing something. All these hacks that we did, in principle, are somehow supported in their SDK and infrastructure (but I cannot advise them, because I have never tried it). However, if you want to do everything yourself, if you like to customize everything or you feel sorry for the money, now I will tell you what to do. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, think up a scheme and do not forget that you have a ref and a page in the scheme. Then you can beautifully display the frames and at the same time keep any statistics.</font></font><br><br><img src="https://habrastorage.org/webt/pw/9v/zx/pw9vzxtnst4sfkbfhfz6kdny260.jpeg"><br><br>  The second.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Very simple, do what Apple </font></font><a href="https://developer.apple.com/library/content/documentation/General/Conceptual/AppSearch/UniversalLinks.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tells you</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : apple-app-site-association, domains and code. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And do not forget in the code about canOpenUrl, check that you can actually open it, otherwise send it to Safari. </font></font><br><br><img src="https://habrastorage.org/webt/hq/ic/ni/hqicnilute9slcbgs19_c9wga5a.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Third. Do not forget about the HTML preview and Open Graph tags, otherwise everything will look ugly. By the way, although in this report I don‚Äôt disclose the Android theme, for Facebook on Android I need to support </font></font><a href="https://developers.facebook.com/docs/applinks/add-to-content"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">separate og tags with</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Android </font><a href="https://developers.facebook.com/docs/applinks/add-to-content"><font style="vertical-align: inherit;">link</font></a><font style="vertical-align: inherit;"> . In addition, for some webview android, you can leave the iframe with a delay of redirection, like the one I mentioned at the beginning. </font></font><br><br><img src="https://habrastorage.org/webt/hn/64/iu/hn64iu3dkvpri8h7rbolp9r66ge.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the HTML preview, again, do not forget that you need two domains: one in the button, the other in the preview.</font></font><br><br><img src="https://habrastorage.org/webt/m4/su/h_/m4suh_jcsdfqd8zmmgus2fp0fma.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not forget about deferred deep linking (delayed diplink, i.e. diplink to an application that is not yet installed). Here we have AppsFlyer, and you may have your own personal solution that will allow you to track the installation and open the content after installation by the user. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In general, this is all you need to build your palace from the pitfalls: </font></font><br><br><img src="https://habrastorage.org/webt/yg/fr/p-/ygfrp-8o3qcqaa6_ptmjajbihtq.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But I still have a small bonus track, which I added at the last moment. Remember how in the early scheme, starting with iOS 9, we had an error Safari in the event that the user does not have the application installed? This is ugly, we do not want users to see the error. Do you remember this slide? </font></font><br><br><img src="https://habrastorage.org/webt/u4/jr/ud/u4jrud01xybl-rip2ynfdehibta.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We send letters to these users, and this button simultaneously logs in the user (there is a token for the login) and opens the content.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So: we send these letters to specific users, and we know if they have the application installed and on which device. And this means that we can use the old scheme for those cases when we appeal to specific users who log off from these devices. In this case, we have logic on the server about whether the application is installed or not. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accordingly, if the application is installed, we can use the old scheme. It does not need so many hacks, and it is more likely to work in the Gmail client (which uses SafariViewController) and others. And all the rest will be sent to the mobile version. Accordingly, the new version of the fantastic algorithm of incredible success has one more point:</font></font><br><br><img src="https://habrastorage.org/webt/hz/r3/oz/hzr3ozajnluxmm7aha8bf8y_o7q.jpeg"><br><br><blockquote>  .         ‚Äî 20-21   <b>Mobius 2018 Piter</b> ,    <a href="https://mobiusconf.com/"></a>   ! <br></blockquote></div><p>Source: <a href="https://habr.com/ru/post/352914/">https://habr.com/ru/post/352914/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352904/index.html">We create TUI on python</a></li>
<li><a href="../352906/index.html">Tamed floating point numbers. Is it possible to debug shaders for mobile devices on a PC?</a></li>
<li><a href="../352908/index.html">SEO article optimization: actual plan</a></li>
<li><a href="../352910/index.html">Hosting: exit poll</a></li>
<li><a href="../352912/index.html">What we read in March: five necessary books for infrastructure engineers</a></li>
<li><a href="../352916/index.html">Apache Ignite 2.4 BaselineTopology Concept</a></li>
<li><a href="../352918/index.html">How to test SkyNet? (if it is written in js)</a></li>
<li><a href="../352922/index.html">The path of the IT-manager (part # 1)</a></li>
<li><a href="../352924/index.html">5 lessons we learned by spending 100500 RK on Facebook</a></li>
<li><a href="../352928/index.html">RISC-V core generation and testing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>