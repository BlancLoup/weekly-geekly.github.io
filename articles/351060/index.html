<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write Telegram-bot on Go to search Wikipedia</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Content 

- Create a bot 
- Write the code 
- We deploy the bot 
- Conclusion 


 Telegrams are very popular now, and writing bots for him has become ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write Telegram-bot on Go to search Wikipedia</h1><div class="post__text post__text-html js-mediator-article"><div class="spoiler">  <b class="spoiler_title">Content</b> <div class="spoiler_text"><ul><li>  Create a bot </li><li>  Write the code </li><li>  We deploy the bot </li><li>  Conclusion </li></ul></div></div><br><p>  Telegrams are very popular now, and writing bots for him has become a kind of hello world of our day, which is why many people immediately think about writing bot telegrams when thinking about what can be written now. </p><br><p>  As a student, I, like all students, often visit Wikipedia in parallel, devoting time and a telegram.  It was decided to find a way to combine the presence in the telegram and the opportunity to find the material I needed in Wikipedia, and this bot actually appeared (at the time of writing the bot I didn‚Äôt even know that there is a bot for the same purpose from the telegram team). </p><a name="habracut"></a><br><h3 id="sozdaem-bota">  Create a bot </h3><br><p>  Go to the <a href="https://telegram.me/BotFather">BotFather</a> and create a new bot. </p><br><p><img src="https://habrastorage.org/webt/8z/zg/4f/8zzg4fcmdkr4qnyv-_arz-d0fys.png"></p><br><p>  Next, we add a command to it with which we can get the number of users who used the bot. </p><br><p><img src="https://habrastorage.org/webt/mc/ld/3s/mcld3sljukhnl5odaqqtsff_srs.png"></p><br><h3 id="pishem-kod">  Write the code </h3><br><p>  Since our bot will live inside the container docker, we will immediately set the environment variables to set the parameters without entering the container. </p><br><p>  From non-standard libraries we will need. </p><br><pre><code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">go</span></span> get github.com/Syfaro/telegram-bot-api</code> </pre> <br><p>  To work with TelegramAPI. </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">go</span></span> get github.com/lib/pq</code> </pre> <br><p>  To work with Postgres DB. </p><br><p>  Create structures. </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> SearchResults <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { ready <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Query <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Results []Result } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Result <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { Name, Description, URL <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> }</code> </pre> <br><p>  Pay attention to the field <em>ready bool</em> , if the structure is empty, then the value will be <em>false</em> . </p><br><p>  Next, enter the data in the structure. </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sr *SearchResults)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UnmarshalJSON</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bs []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { array := []<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{}{} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := json.Unmarshal(bs, &amp;array); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err } sr.Query = array[<span class="hljs-number"><span class="hljs-number">0</span></span>].(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> array[<span class="hljs-number"><span class="hljs-number">1</span></span>].([]<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{}) { sr.Results = <span class="hljs-built_in"><span class="hljs-built_in">append</span></span>(sr.Results, Result{ array[<span class="hljs-number"><span class="hljs-number">1</span></span>].([]<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{})[i].(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>), array[<span class="hljs-number"><span class="hljs-number">2</span></span>].([]<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{})[i].(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>), array[<span class="hljs-number"><span class="hljs-number">3</span></span>].([]<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{})[i].(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>), }) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br><p>  Now we need a function that will send and receive data. </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wikipediaAPI</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(answer []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//   3  s := make([]string, 3) //  if response, err := http.Get(request); err != nil { s[0] = "Wikipedia is not respond" } else { defer response.Body.Close() //  contents, err := ioutil.ReadAll(response.Body) if err != nil { log.Fatal(err) } //    sr := &amp;SearchResults{} if err = json.Unmarshal([]byte(contents), sr); err != nil { s[0] = "Something going wrong, try to change your question" } //      if !sr.ready { s[0] = "Something going wrong, try to change your question" } //           for i := range sr.Results { s[i] = sr.Results[i].URL } } return s }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Full code</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> SearchResults <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { ready <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Query <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Results []Result } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Result <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { Name, Description, URL <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sr *SearchResults)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UnmarshalJSON</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bs []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { array := []<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{}{} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := json.Unmarshal(bs, &amp;array); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err } sr.Query = array[<span class="hljs-number"><span class="hljs-number">0</span></span>].(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> array[<span class="hljs-number"><span class="hljs-number">1</span></span>].([]<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{}) { sr.Results = <span class="hljs-built_in"><span class="hljs-built_in">append</span></span>(sr.Results, Result{ array[<span class="hljs-number"><span class="hljs-number">1</span></span>].([]<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{})[i].(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>), array[<span class="hljs-number"><span class="hljs-number">2</span></span>].([]<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{})[i].(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>), array[<span class="hljs-number"><span class="hljs-number">3</span></span>].([]<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{})[i].(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>), }) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wikipediaAPI</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(answer []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//   3  s := make([]string, 3) //  if response, err := http.Get(request); err != nil { s[0] = "Wikipedia is not respond" } else { defer response.Body.Close() //  contents, err := ioutil.ReadAll(response.Body) if err != nil { log.Fatal(err) } //    sr := &amp;SearchResults{} if err = json.Unmarshal([]byte(contents), sr); err != nil { s[0] = "Something going wrong, try to change your question" } //      if !sr.ready { s[0] = "Something going wrong, try to change your question" } //           for i := range sr.Results { s[i] = sr.Results[i].URL } } return s }</span></span></code> </pre></div></div><br><p>  Due to the fact that we are sending the URL, we need to convert the message from the user into the URL part.  Why this is needed, then that the user can send the bot not one but two words separated by a space, we need to replace the space so that it becomes part of the URL.  This will be done by the urlEncoded function. </p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//       URL func urlEncoded(str string) (string, error) { u, err := url.Parse(str) if err != nil { return "", err } return u.String(), nil }</span></span></code> </pre> <br><p>  Now we need to somehow interact with the database.  Create variables in which we will store the data of environment variables for connecting to the database. </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> host = os.Getenv(<span class="hljs-string"><span class="hljs-string">"HOST"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> port = os.Getenv(<span class="hljs-string"><span class="hljs-string">"PORT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = os.Getenv(<span class="hljs-string"><span class="hljs-string">"USER"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> password = os.Getenv(<span class="hljs-string"><span class="hljs-string">"PASSWORD"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbname = os.Getenv(<span class="hljs-string"><span class="hljs-string">"DBNAME"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sslmode = os.Getenv(<span class="hljs-string"><span class="hljs-string">"SSLMODE"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbInfo = fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"host=%s port=%s user=%s password=%s dbname=%s sslmode=%s"</span></span>, host, port, user, password, dbname, sslmode)</code> </pre><br><p>  And we write the function that will create the table in our database. </p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//  users       func createTable() error { //   db, err := sql.Open("postgres", dbInfo) if err != nil { return err } defer db.Close() //  users if _, err = db.Exec(`CREATE TABLE users(ID SERIAL PRIMARY KEY, TIMESTAMP TIMESTAMP DEFAULT CURRENT_TIMESTAMP, USERNAME TEXT, CHAT_ID INT, MESSAGE TEXT, ANSWER TEXT);`); err != nil { return err } return nil }</span></span></code> </pre> <br><p>  We have created a table, and we need to enter data into it, the next function will do this. </p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//    func collectData(username string, chatid int64, message string, answer []string) error { //   db, err := sql.Open("postgres", dbInfo) if err != nil { return err } defer db.Close() //      answ := strings.Join(answer, ", ") // SQL  data := `INSERT INTO users(username, chat_id, message, answer) VALUES($1, $2, $3, $4);` //  SQL  if _, err = db.Exec(data, `@`+username, chatid, message, answ); err != nil { return err } return nil }</span></span></code> </pre> <br><p>  Also let's write a function that will count the number of unique users who wrote the bot, to give this number to users if they send the right command to the bot. </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNumberOfUsers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int64</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> count <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span> <span class="hljs-comment"><span class="hljs-comment">//   db, err := sql.Open("postgres", dbInfo) if err != nil { return 0, err } defer db.Close() //         row := db.QueryRow("SELECT COUNT(DISTINCT username) FROM users;") err = row.Scan(&amp;count) if err != nil { return 0, err } return count, nil }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Full code</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> host = os.Getenv(<span class="hljs-string"><span class="hljs-string">"HOST"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> port = os.Getenv(<span class="hljs-string"><span class="hljs-string">"PORT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = os.Getenv(<span class="hljs-string"><span class="hljs-string">"USER"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> password = os.Getenv(<span class="hljs-string"><span class="hljs-string">"PASSWORD"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbname = os.Getenv(<span class="hljs-string"><span class="hljs-string">"DBNAME"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sslmode = os.Getenv(<span class="hljs-string"><span class="hljs-string">"SSLMODE"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbInfo = fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"host=%s port=%s user=%s password=%s dbname=%s sslmode=%s"</span></span>, host, port, user, password, dbname, sslmode) <span class="hljs-comment"><span class="hljs-comment">//    func collectData(username string, chatid int64, message string, answer []string) error { //   db, err := sql.Open("postgres", dbInfo) if err != nil { return err } defer db.Close() //      answ := strings.Join(answer, ", ") // SQL  data := `INSERT INTO users(username, chat_id, message, answer) VALUES($1, $2, $3, $4);` //  SQL  if _, err = db.Exec(data, `@`+username, chatid, message, answ); err != nil { return err } return nil } //  users       func createTable() error { //   db, err := sql.Open("postgres", dbInfo) if err != nil { return err } defer db.Close() //  users if _, err = db.Exec(`CREATE TABLE users(ID SERIAL PRIMARY KEY, TIMESTAMP TIMESTAMP DEFAULT CURRENT_TIMESTAMP, USERNAME TEXT, CHAT_ID INT, MESSAGE TEXT, ANSWER TEXT);`); err != nil { return err } return nil } func getNumberOfUsers() (int64, error) { var count int64 //   db, err := sql.Open("postgres", dbInfo) if err != nil { return 0, err } defer db.Close() //         row := db.QueryRow("SELECT COUNT(DISTINCT username) FROM users;") err = row.Scan(&amp;count) if err != nil { return 0, err } return count, nil }</span></span></code> </pre> </div></div><br><p>  <strong>We put everything together</strong> </p><br><p>  Create a bot. </p><br><pre> <code class="go hljs"> <span class="hljs-comment"><span class="hljs-comment">//  bot, err := tgbotapi.NewBotAPI(os.Getenv("TOKEN")) if err != nil { panic(err) } //   u := tgbotapi.NewUpdate(0) u.Timeout = 60 //    updates, err := bot.GetUpdatesChan(u) for update := range updates { if update.Message == nil { continue }</span></span></code> </pre> <br><p>  We need to check that the text message comes from the user and our if will do this. </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> reflect.TypeOf(update.Message.Text).Kind() == reflect.String &amp;&amp; update.Message.Text != <span class="hljs-string"><span class="hljs-string">""</span></span></code> </pre> <br><p>  If the user has sent a sticker or a video, then we will send a message to the user that will indicate that only text messages are suitable. </p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//  msg := tgbotapi.NewMessage(update.Message.Chat.ID, "Use the words for search.") bot.Send(msg)</span></span></code> </pre> <br><p>  Inside if, we nest a switch that will catch the commands: </p><br><p>  <strong>/ start</strong> </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"/start"</span></span>: <span class="hljs-comment"><span class="hljs-comment">//  msg := tgbotapi.NewMessage(update.Message.Chat.ID, "Hi, i'm a wikipedia bot, i can search information in a wikipedia, send me something what you want find in Wikipedia.") bot.Send(msg)</span></span></code> </pre><br><p>  <strong>/ number_of_users</strong> </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"/number_of_users"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> os.Getenv(<span class="hljs-string"><span class="hljs-string">"DB_SWITCH"</span></span>) == <span class="hljs-string"><span class="hljs-string">"on"</span></span> { <span class="hljs-comment"><span class="hljs-comment">//      num  num, err := getNumberOfUsers() if err != nil { //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, "Database error.") bot.Send(msg) } //        ans := fmt.Sprintf("%d peoples used me for search information in Wikipedia", num) //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, ans) bot.Send(msg) } else { //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, "Database not connected, so i can't say you how many peoples used me.") bot.Send(msg) }</span></span></code> </pre> <br><p>  <strong>and default which will interact with wikipedia and database</strong> </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-comment"><span class="hljs-comment">//      language := os.Getenv("LANGUAGE") // url   ms, _ := urlEncoded(update.Message.Text) url := ms request := "https://" + language + ".wikipedia.org/w/api.php?action=opensearch&amp;search=" + url + "&amp;limit=3&amp;origin=*&amp;format=json" //       message message := wikipediaAPI(request) if os.Getenv("DB_SWITCH") == "on" { // username, chat_id, message, answer   if err := collectData(update.Message.Chat.UserName, update.Message.Chat.ID, update.Message.Text, message); err != nil { //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, "Database error, but bot still working.") bot.Send(msg) } } //        for _, val := range message { //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, val) bot.Send(msg) } }</span></span></code> </pre> <br><p>  We create main. </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { time.Sleep(<span class="hljs-number"><span class="hljs-number">1</span></span> * time.Minute) <span class="hljs-comment"><span class="hljs-comment">//  if os.Getenv("CREATE_TABLE") == "yes" { if os.Getenv("DB_SWITCH") == "on" { if err := createTable(); err != nil { panic(err) } } } time.Sleep(1 * time.Minute) //  telegramBot() }</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">Full code</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">telegramBot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//  bot, err := tgbotapi.NewBotAPI(os.Getenv("TOKEN")) if err != nil { panic(err) } //   u := tgbotapi.NewUpdate(0) u.Timeout = 60 //    updates, err := bot.GetUpdatesChan(u) for update := range updates { if update.Message == nil { continue } //        if reflect.TypeOf(update.Message.Text).Kind() == reflect.String &amp;&amp; update.Message.Text != "" { switch update.Message.Text { case "/start": //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, "Hi, i'm a wikipedia bot, i can search information in a wikipedia, send me something what you want find in Wikipedia.") bot.Send(msg) case "/number_of_users": if os.Getenv("DB_SWITCH") == "on" { //      num  num, err := getNumberOfUsers() if err != nil { //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, "Database error.") bot.Send(msg) } //        ans := fmt.Sprintf("%d peoples used me for search information in Wikipedia", num) //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, ans) bot.Send(msg) } else { //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, "Database not connected, so i can't say you how many peoples used me.") bot.Send(msg) } default: //      language := os.Getenv("LANGUAGE") // url   ms, _ := urlEncoded(update.Message.Text) url := ms request := "https://" + language + ".wikipedia.org/w/api.php?action=opensearch&amp;search=" + url + "&amp;limit=3&amp;origin=*&amp;format=json" //       message message := wikipediaAPI(request) if os.Getenv("DB_SWITCH") == "on" { // username, chat_id, message, answer   if err := collectData(update.Message.Chat.UserName, update.Message.Chat.ID, update.Message.Text, message); err != nil { //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, "Database error, but bot still working.") bot.Send(msg) } } //        for _, val := range message { //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, val) bot.Send(msg) } } } else { //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, "Use the words for search.") bot.Send(msg) } } } func main() { time.Sleep(1 * time.Minute) //  if os.Getenv("CREATE_TABLE") == "yes" { if os.Getenv("DB_SWITCH") == "on" { if err := createTable(); err != nil { panic(err) } } } time.Sleep(1 * time.Minute) //  telegramBot() }</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Summary code</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"database/sql"</span></span> <span class="hljs-string"><span class="hljs-string">"encoding/json"</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/Syfaro/telegram-bot-api"</span></span> _ <span class="hljs-string"><span class="hljs-string">"github.com/lib/pq"</span></span> <span class="hljs-string"><span class="hljs-string">"io/ioutil"</span></span> <span class="hljs-string"><span class="hljs-string">"log"</span></span> <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> <span class="hljs-string"><span class="hljs-string">"net/url"</span></span> <span class="hljs-string"><span class="hljs-string">"os"</span></span> <span class="hljs-string"><span class="hljs-string">"reflect"</span></span> <span class="hljs-string"><span class="hljs-string">"strings"</span></span> <span class="hljs-string"><span class="hljs-string">"time"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> SearchResults <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { ready <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Query <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Results []Result } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Result <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { Name, Description, URL <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sr *SearchResults)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UnmarshalJSON</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bs []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { array := []<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{}{} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := json.Unmarshal(bs, &amp;array); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err } sr.Query = array[<span class="hljs-number"><span class="hljs-number">0</span></span>].(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> array[<span class="hljs-number"><span class="hljs-number">1</span></span>].([]<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{}) { sr.Results = <span class="hljs-built_in"><span class="hljs-built_in">append</span></span>(sr.Results, Result{ array[<span class="hljs-number"><span class="hljs-number">1</span></span>].([]<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{})[i].(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>), array[<span class="hljs-number"><span class="hljs-number">2</span></span>].([]<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{})[i].(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>), array[<span class="hljs-number"><span class="hljs-number">3</span></span>].([]<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{})[i].(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>), }) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wikipediaAPI</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(answer []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//   3  s := make([]string, 3) //  if response, err := http.Get(request); err != nil { s[0] = "Wikipedia is not respond" } else { defer response.Body.Close() //  contents, err := ioutil.ReadAll(response.Body) if err != nil { log.Fatal(err) } //    sr := &amp;SearchResults{} if err = json.Unmarshal([]byte(contents), sr); err != nil { s[0] = "Something going wrong, try to change your question" } //      if !sr.ready { s[0] = "Something going wrong, try to change your question" } //           for i := range sr.Results { s[i] = sr.Results[i].URL } } return s } //       URL func urlEncoded(str string) (string, error) { u, err := url.Parse(str) if err != nil { return "", err } return u.String(), nil } var host = os.Getenv("HOST") var port = os.Getenv("PORT") var user = os.Getenv("USER") var password = os.Getenv("PASSWORD") var dbname = os.Getenv("DBNAME") var sslmode = os.Getenv("SSLMODE") var dbInfo = fmt.Sprintf("host=%s port=%s user=%s password=%s dbname=%s sslmode=%s", host, port, user, password, dbname, sslmode) //    func collectData(username string, chatid int64, message string, answer []string) error { //   db, err := sql.Open("postgres", dbInfo) if err != nil { return err } defer db.Close() //      answ := strings.Join(answer, ", ") // SQL  data := `INSERT INTO users(username, chat_id, message, answer) VALUES($1, $2, $3, $4);` //  SQL  if _, err = db.Exec(data, `@`+username, chatid, message, answ); err != nil { return err } return nil } //  users       func createTable() error { //   db, err := sql.Open("postgres", dbInfo) if err != nil { return err } defer db.Close() //  users if _, err = db.Exec(`CREATE TABLE users(ID SERIAL PRIMARY KEY, TIMESTAMP TIMESTAMP DEFAULT CURRENT_TIMESTAMP, USERNAME TEXT, CHAT_ID INT, MESSAGE TEXT, ANSWER TEXT);`); err != nil { return err } return nil } func getNumberOfUsers() (int64, error) { var count int64 //   db, err := sql.Open("postgres", dbInfo) if err != nil { return 0, err } defer db.Close() //         row := db.QueryRow("SELECT COUNT(DISTINCT username) FROM users;") err = row.Scan(&amp;count) if err != nil { return 0, err } return count, nil } func telegramBot() { //  bot, err := tgbotapi.NewBotAPI(os.Getenv("TOKEN")) if err != nil { panic(err) } //   u := tgbotapi.NewUpdate(0) u.Timeout = 60 //    updates, err := bot.GetUpdatesChan(u) for update := range updates { if update.Message == nil { continue } //        if reflect.TypeOf(update.Message.Text).Kind() == reflect.String &amp;&amp; update.Message.Text != "" { switch update.Message.Text { case "/start": //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, "Hi, i'm a wikipedia bot, i can search information in a wikipedia, send me something what you want find in Wikipedia.") bot.Send(msg) case "/number_of_users": if os.Getenv("DB_SWITCH") == "on" { //      num  num, err := getNumberOfUsers() if err != nil { //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, "Database error.") bot.Send(msg) } //        ans := fmt.Sprintf("%d peoples used me for search information in Wikipedia", num) //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, ans) bot.Send(msg) } else { //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, "Database not connected, so i can't say you how many peoples used me.") bot.Send(msg) } default: //      language := os.Getenv("LANGUAGE") // url   ms, _ := urlEncoded(update.Message.Text) url := ms request := "https://" + language + ".wikipedia.org/w/api.php?action=opensearch&amp;search=" + url + "&amp;limit=3&amp;origin=*&amp;format=json" //       message message := wikipediaAPI(request) if os.Getenv("DB_SWITCH") == "on" { // username, chat_id, message, answer   if err := collectData(update.Message.Chat.UserName, update.Message.Chat.ID, update.Message.Text, message); err != nil { //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, "Database error, but bot still working.") bot.Send(msg) } } //        for _, val := range message { //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, val) bot.Send(msg) } } } else { //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, "Use the words for search.") bot.Send(msg) } } } func main() { time.Sleep(1 * time.Minute) //  if os.Getenv("CREATE_TABLE") == "yes" { if os.Getenv("DB_SWITCH") == "on" { if err := createTable(); err != nil { panic(err) } } } time.Sleep(1 * time.Minute) //  telegramBot() }</span></span></code> </pre> </div></div><br><p>  Let's split the code into separate files so that it is more readable. </p><br><div class="spoiler">  <b class="spoiler_title">wikipedia_api.go</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"encoding/json"</span></span> <span class="hljs-string"><span class="hljs-string">"io/ioutil"</span></span> <span class="hljs-string"><span class="hljs-string">"log"</span></span> <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> SearchResults <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { ready <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Query <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Results []Result } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Result <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { Name, Description, URL <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sr *SearchResults)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UnmarshalJSON</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bs []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { array := []<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{}{} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := json.Unmarshal(bs, &amp;array); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err } sr.Query = array[<span class="hljs-number"><span class="hljs-number">0</span></span>].(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> array[<span class="hljs-number"><span class="hljs-number">1</span></span>].([]<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{}) { sr.Results = <span class="hljs-built_in"><span class="hljs-built_in">append</span></span>(sr.Results, Result{ array[<span class="hljs-number"><span class="hljs-number">1</span></span>].([]<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{})[i].(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>), array[<span class="hljs-number"><span class="hljs-number">2</span></span>].([]<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{})[i].(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>), array[<span class="hljs-number"><span class="hljs-number">3</span></span>].([]<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{})[i].(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>), }) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wikipediaAPI</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(answer []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//   3  s := make([]string, 3) //  if response, err := http.Get(request); err != nil { s[0] = "Wikipedia is not respond" } else { defer response.Body.Close() //  contents, err := ioutil.ReadAll(response.Body) if err != nil { log.Fatal(err) } //    sr := &amp;SearchResults{} if err = json.Unmarshal([]byte(contents), sr); err != nil { s[0] = "Something going wrong, try to change your question" } //      if !sr.ready { s[0] = "Something going wrong, try to change your question" } //           for i := range sr.Results { s[i] = sr.Results[i].URL } } return s }</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">url_encoder.go</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"net/url"</span></span> ) <span class="hljs-comment"><span class="hljs-comment">//       URL func urlEncoded(str string) (string, error) { u, err := url.Parse(str) if err != nil { return "", err } return u.String(), nil }</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">db.go</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"database/sql"</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> _ <span class="hljs-string"><span class="hljs-string">"github.com/lib/pq"</span></span> <span class="hljs-string"><span class="hljs-string">"os"</span></span> <span class="hljs-string"><span class="hljs-string">"strings"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> host = os.Getenv(<span class="hljs-string"><span class="hljs-string">"HOST"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> port = os.Getenv(<span class="hljs-string"><span class="hljs-string">"PORT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = os.Getenv(<span class="hljs-string"><span class="hljs-string">"USER"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> password = os.Getenv(<span class="hljs-string"><span class="hljs-string">"PASSWORD"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbname = os.Getenv(<span class="hljs-string"><span class="hljs-string">"DBNAME"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sslmode = os.Getenv(<span class="hljs-string"><span class="hljs-string">"SSLMODE"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbInfo = fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"host=%s port=%s user=%s password=%s dbname=%s sslmode=%s"</span></span>, host, port, user, password, dbname, sslmode) <span class="hljs-comment"><span class="hljs-comment">//    func collectData(username string, chatid int64, message string, answer []string) error { //   db, err := sql.Open("postgres", dbInfo) if err != nil { return err } defer db.Close() //      answ := strings.Join(answer, ", ") // SQL  data := `INSERT INTO users(username, chat_id, message, answer) VALUES($1, $2, $3, $4);` //  SQL  if _, err = db.Exec(data, `@`+username, chatid, message, answ); err != nil { return err } return nil } //  users       func createTable() error { //   db, err := sql.Open("postgres", dbInfo) if err != nil { return err } defer db.Close() //  users if _, err = db.Exec(`CREATE TABLE users(ID SERIAL PRIMARY KEY, TIMESTAMP TIMESTAMP DEFAULT CURRENT_TIMESTAMP, USERNAME TEXT, CHAT_ID INT, MESSAGE TEXT, ANSWER TEXT);`); err != nil { return err } return nil } func getNumberOfUsers() (int64, error) { var count int64 //   db, err := sql.Open("postgres", dbInfo) if err != nil { return 0, err } defer db.Close() //         row := db.QueryRow("SELECT COUNT(DISTINCT username) FROM users;") err = row.Scan(&amp;count) if err != nil { return 0, err } return count, nil }</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">telegrambot.go</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/Syfaro/telegram-bot-api"</span></span> <span class="hljs-string"><span class="hljs-string">"os"</span></span> <span class="hljs-string"><span class="hljs-string">"reflect"</span></span> <span class="hljs-string"><span class="hljs-string">"time"</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">telegramBot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//  bot, err := tgbotapi.NewBotAPI(os.Getenv("TOKEN")) if err != nil { panic(err) } //   u := tgbotapi.NewUpdate(0) u.Timeout = 60 //    updates, err := bot.GetUpdatesChan(u) for update := range updates { if update.Message == nil { continue } //        if reflect.TypeOf(update.Message.Text).Kind() == reflect.String &amp;&amp; update.Message.Text != "" { switch update.Message.Text { case "/start": //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, "Hi, i'm a wikipedia bot, i can search information in a wikipedia, send me something what you want find in Wikipedia.") bot.Send(msg) case "/number_of_users": if os.Getenv("DB_SWITCH") == "on" { //      num  num, err := getNumberOfUsers() if err != nil { //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, "Database error.") bot.Send(msg) } //        ans := fmt.Sprintf("%d peoples used me for search information in Wikipedia", num) //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, ans) bot.Send(msg) } else { //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, "Database not connected, so i can't say you how many peoples used me.") bot.Send(msg) } default: //      language := os.Getenv("LANGUAGE") // url   ms, _ := urlEncoded(update.Message.Text) url := ms request := "https://" + language + ".wikipedia.org/w/api.php?action=opensearch&amp;search=" + url + "&amp;limit=3&amp;origin=*&amp;format=json" //       message message := wikipediaAPI(request) if os.Getenv("DB_SWITCH") == "on" { // username, chat_id, message, answer   if err := collectData(update.Message.Chat.UserName, update.Message.Chat.ID, update.Message.Text, message); err != nil { //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, "Database error, but bot still working.") bot.Send(msg) } } //        for _, val := range message { //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, val) bot.Send(msg) } } } else { //  msg := tgbotapi.NewMessage(update.Message.Chat.ID, "Use the words for search.") bot.Send(msg) } } } func main() { time.Sleep(1 * time.Minute) //  if os.Getenv("CREATE_TABLE") == "yes" { if os.Getenv("DB_SWITCH") == "on" { if err := createTable(); err != nil { panic(err) } } } time.Sleep(1 * time.Minute) //  telegramBot() }</span></span></code> </pre> </div></div><br><p>  Now when we have our bot we will write a Dockerfile for it. </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> alpine ENV <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span>="en" <span class="hljs-keyword"><span class="hljs-keyword">COPY</span></span> /code/code . RUN apk <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-comment"><span class="hljs-comment">--no-cache ca-certificates &amp;&amp;\ chmod +x code EXPOSE 80/tcp CMD [ "./code" ]</span></span></code> </pre><br><p>  As well as docker-compose.yml in order for us not to have to manually raise the database if we have the database on the same machine as the bot. </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-string"><span class="hljs-string">'3.5'</span></span> services: db: image: postgres environment: POSTGRES_PASSWORD: test bot: image: trigun117/wikipedia-telegram-bot environment: CREATE_TABLE: "yes" DB_SWITCH: "on" TOKEN: HOST: db PORT: <span class="hljs-number"><span class="hljs-number">5432</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>: postgres <span class="hljs-keyword"><span class="hljs-keyword">PASSWORD</span></span>: test DBNAME: postgres SSLMODE: <span class="hljs-keyword"><span class="hljs-keyword">disable</span></span></code> </pre> <br><h3 id="razvorachivaem-bota">  We deploy the bot </h3><br><p>  Let's deploy the bot on a local PC, Amazon Web Service: EC2 and RDS database, Google Cloud Platform: GCE and SQL database. </p><br><p>  <strong>Docker-compose</strong> </p><br><p>  We insert in our docker-compose.yml a token for a bot. </p><br><p><img src="https://habrastorage.org/webt/q2/5d/pc/q25dpcuo3rvc6tfsyhmytcq35hm.png"></p><br><p>  And run docker-compose. </p><br><p><img src="https://habrastorage.org/webt/bj/xy/rg/bjxyrgwwdiwwnjmsfpkaoqpjqe8.png"></p><br><p>  We are waiting for about 3 minutes and our bot is ready to go. </p><br><p>  <strong>Google Cloud Platform</strong> </p><br><p>  Go to the SQL section in the GCP and create the database. </p><br><p><img src="https://habrastorage.org/webt/bt/1p/ol/bt1polz7sagg-t1rrmojvxiwtao.png"></p><br><p>  In allowed networks, we indicate that traffic can come from any source. </p><br><p><img src="https://habrastorage.org/webt/fu/sg/1q/fusg1qunhflx-_pv_hmcq5-r0tw.png"></p><br><p>  Now we have a database and IP to connect to it. </p><br><p><img src="https://habrastorage.org/webt/jv/ss/wv/jvsswvsixwqlai0jrvsfhdq6wmw.png"></p><br><p>  Next, go to the Compute Engine tab and create an instance on which the bot will be deployed. </p><br><p><img src="https://habrastorage.org/webt/gg/xm/_u/ggxm_ugu_0vh0-ncgzaufoll3f4.png"></p><br><p>  Since Google Compute Engine has such a thing as Automation, which allows us to execute any commands on the instance after its creation without our participation, we will use it for a comfortable sweep. </p><br><p>  On the Automation tab, we indicate the commands for installing the docker and launching the container with our bot. </p><br><p><img src="https://habrastorage.org/webt/ow/tj/w9/owtjw9w8wdaf3ixhpsh3dwrddaq.png"></p><br><pre> <code class="bash hljs">curl -s https://raw.githubusercontent.com/trigun117/TelegramBot-Go/master/installdocker.sh | bash &amp;&amp; \ sudo docker run \ -e CREATE_TABLE=yes \ -e DB_SWITCH=on \ -e TOKEN=497014514:AAGKayv3tUxNrFWCmqtEIxKAS1TMvhXGdLE \ -e HOST=35.189.116.57 \ -e PORT=5432 \ -e USER=postgres \ -e PASSWORD=postgres \ -e DBNAME=postgres \ -e SSLMODE=<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span> \ -d trigun117/wikipedia-telegram-bot</code> </pre> <br><p>  We are waiting for about 5 minutes and our bot is ready to use. </p><br><p>  <strong>Amazon Web Service</strong> </p><br><p>  Create a database. </p><br><p><img src="https://habrastorage.org/webt/gi/h6/9b/gih69bdt-d5f6gbtlu8i0yuuuuw.png"></p><br><p><img src="https://habrastorage.org/webt/jn/ax/e4/jnaxe43pkx6ufiagymwhlkqxyrc.png"></p><br><p><img src="https://habrastorage.org/webt/kk/bq/wc/kkbqwcmcsynuq52jpdtg4bdsjwg.png"></p><br><p>           endpoint        . </p><br><p><img src="https://habrastorage.org/webt/4c/b6/bo/4cb6bo2finkppwpsvcat2mprqry.png"></p><br><p>     EC2, Security Groups        . </p><br><p><img src="https://habrastorage.org/webt/8v/u5/p3/8vu5p3_cuxpovsj6poryjwk5r6q.png"></p><br><p>    Inbound  Edit             </p><br><p><img src="https://habrastorage.org/webt/0f/bg/0g/0fbg0ghxxgysqlsjyc3aqavviwm.png"></p><br><p>   Save. </p><br><p>   Instances,        .               . </p><br><p><img src="https://habrastorage.org/webt/ww/rh/wb/wwrhwb9rbrryy9qxeekgk7dyzkg.png"></p><br><p>   3       . </p><br><pre> <code class="bash hljs">curl -s https://raw.githubusercontent.com/trigun117/TelegramBot-Go/master/installdocker.sh | bash &amp;&amp;\ sudo docker run \ -e CREATE_TABLE=yes \ -e DB_SWITCH=on \ -e TOKEN=497014514:AAGKayv3tUxNrFWCmqtEIxKAS1TMvhXGdLE \ -e HOST=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-habr.c2ugekubflbp.eu-west-2.rds.amazonaws.com \ -e PORT=5432 \ -e USER=postgres \ -e PASSWORD=postgres \ -e DBNAME=postgres \ -e SSLMODE=<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span> \ -d trigun117/wikipedia-telegram-bot</code> </pre> <br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>  ,  ,     Go  -    .          . </p><br><p> <a href="https://github.com/trigun117/TelegramBot-Go"></a>  GitHub </p><br><p>              . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/351060/">https://habr.com/ru/post/351060/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351050/index.html">New NTC Training Center Office - Check Point Training Center</a></li>
<li><a href="../351052/index.html">Why should ignore the history of the founders of successful startups</a></li>
<li><a href="../351054/index.html">How to make a good UI animation great</a></li>
<li><a href="../351056/index.html">Where digital engineers will come from</a></li>
<li><a href="../351058/index.html">Guide to SEO javascript sites. Part 2. Problems, experiments and recommendations</a></li>
<li><a href="../351062/index.html">Hell of a bare iron programming</a></li>
<li><a href="../351068/index.html">Program for digitizing graphs, drawings, drawings: algorithms for the project ‚ÄúTutor: Mathematics‚Äù</a></li>
<li><a href="../351070/index.html">Unexpected earnings difficulties on the Internet</a></li>
<li><a href="../351072/index.html">Password change: 10 steps to good implementation</a></li>
<li><a href="../351074/index.html">How to quickly write and roll out in the production of machine learning algorithm</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>