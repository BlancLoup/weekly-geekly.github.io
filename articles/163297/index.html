<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Proxmox cluster storage. Part one. Fencing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 I want to talk about how we use Proxmox Virtual Environment . 

 I will not describe the installation and initial setup - Proxmox is very si...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Proxmox cluster storage. Part one. Fencing</h1><div class="post__text post__text-html js-mediator-article">  Hello! <img src="https://habrastorage.org/storage2/68d/062/59a/68d06259a365e77b307b25a20c4ab6ac.jpg" align="right"><br><br>  I want to talk about how we use <a href="http://www.proxmox.com/products/proxmox-ve">Proxmox Virtual Environment</a> . <br><br>  I will not describe the installation and initial setup - <i>Proxmox is</i> very simple and enjoyable in installation and configuration.  I will tell about how we use system in a cluster environment. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To complete the work of the cluster, it is necessary that the various hosts of the cluster can quickly take over the control of the virtual machine.  Virtualok data should not be copied anywhere.  That is, all cluster hosts must have access to the data of a specific machine, or, in other words, all cluster hosts must work with a single data store, within which a specific set of virtual machines is running. <br><br>  Proxmox works with two types of virtualization: the operating system level, based on <i>OpenVZ</i> and hardware, based on <i>KVM</i> .  These two types use a different approach to utilizing disk space.  If, in the case of <i>OpenVZ</i> containers, the virtual machine disk is operated at the host file system level, then in the case of <i>KVM</i> machines, a disk image is used that contains the virtual machine's own file system.  The host operating system does not care about placing data inside a <i>KVM</i> disk.  Hypervisor does this.  When organizing the work of a cluster, the variant with disk images is implemented easier than working with the file system.  <i>KVM-</i> machine data from the point of view of the host‚Äôs operating system may simply be ‚Äú <i>somewhere</i> ‚Äù in the repository.  This concept remarkably rests on the <i>LVM</i> workflow when the <i>KVM</i> disk image is inside a logical volume. <br><br>  In the case of <i>OpenVZ,</i> we are dealing with the file system, and not just with the data areas on the <i>Shared Storage</i> .  We need a complete cluster file system. <br><br>  The cluster file system will not be discussed in this part of the article.  About working with <i>KVM</i> - too.  Now let's talk about preparing the cluster for working with shared storage. <br><a name="habracut"></a><br>  I want to immediately say that we do not give the load to the cluster, and we do not plan.  The system is used for internal needs, which we have plenty.  As I wrote in the <a href="http://habrahabr.ru/company/alawar/blog/154451/">previous article</a> , we gradually transfer the payload to <i>vCloud</i> , and deploy Proxmox on the released capacity. <br><br>  In our case, the problem of organizing a common repository boils down to two aspects: <br><br><ol><li>  We have a block device sent over the network to which several hosts will have access simultaneously.  In order for these hosts not to fight for space on the device, we need <i>CLVM</i> - <i>Clustered Logical Volume Manager</i> .  This is the same as <i>LVM</i> , only <i>Clustered</i> .  Thanks to <i>CLVM,</i> each host has up-to-date information ( <i>and can change it safely, without compromising integrity</i> ) about the status of <i>LVM</i> volumes on <i>Shared Storage</i> .  Logical volumes in <i>CLVM</i> live just like normal <i>LVM</i> .  Logical volumes contain either <i>KVM</i> images or cluster <i>FS</i> . </li><li>  In the case of <i>OpenVZ</i> , we have a logical volume on which the file system is located.  The simultaneous operation of several machines with a noncluster file system leads to inevitable errors in the operation of everything - it is swan, cancer and pike, only worse.  The file system must be aware that it lives on a shared resource, and be able to work in this mode. </li></ol><br>  Creating a cluster and connecting nodes to it I will not describe.  About this you can read, for example, <a href="http://pve.proxmox.com/wiki/Proxmox_VE_2.0_Cluster">on the site of developers</a> .  By the way, their <a href="http://pve.proxmox.com/wiki/Documentation">knowledge base is</a> quite extensive and informative. <br><br>  We work with <i>Proxmox</i> version <i>2.2</i> .  We assume that the cluster is configured for us, and it works. <br><br><h4>  We are going to set up a fenced daemon. </h4><br>  The specifics of the cluster environment requires cluster nodes to follow certain rules of behavior.  You can not just go and start writing on the device.  First you need to ask permission.  This is controlled by several cluster subsystems - <i>CMAN</i> ( <i>Cluster manager</i> ), <i>DLM</i> ( <i>Distributed lock manager</i> ) and <i>Fenced</i> .  <i>The fenced</i> daemon plays the role of a bouncer.  If from a cluster point of view, a node starts to behave inadequately - communication with the storage in the cluster freezes, and <i>fenced</i> tries to disconnect the failed node from the cluster. <br><br>  <i>Fencing</i> is the process of eliminating nodes from working with cluster storage.  Since an inadequate machine may not respond to requests to leave in an amicable way, weaning of a node can be done using forces external to the cluster.  Specially trained fence agents are used to communicate with these forces.  As a rule, <i>fencing</i> is reduced to de-energizing the node, after which the cluster takes a breath and resumes work. <br><br>  In the role of external forces, any equipment capable of de-energizing the <s>muzzle of a</s> signal or isolating a machine from a network can act as a signal.  Most often in the role of such devices are industrial power supplies, or server management console.  We use <i>HP</i> equipment.  Fencing is made using <i>iLO</i> cards. <br><br>  Until the <i>fenced</i> daemon received confirmation from the agent that the node is safely " <i>fenced</i> " - all I / O operations in the cluster will be suspended.  This is done to minimize the risk of data corruption in the repository.  Since the failed node has ceased to follow the generally accepted rules of behavior, you can expect anything from it.  For example, unauthorized ( <i>and non-logged</i> ) attempts to write to disk.  Therefore, any communication with the repository in this situation increases the risk of data corruption. <br><br>  If the <i>fence</i> agent is not configured for the node, then <i>fenced</i> will not be able to kick it in case of problems, and the cluster will be in a frozen state until the situation is resolved.  In this situation, there are several scenarios for further developments: <br><br><ol><li>  Noda can come to his senses, return to the cluster and say that she will not be like this anymore.  It will be released, and the cluster will be resumed. </li><li>  A node can reboot ( <i>or someone will reload it</i> ), and be asked to cluster.  The fact of a new attempt to connect to the cluster is considered a signal that the node is healthy, and you can continue to work. </li><li>  Noda may die.  This situation requires manual intervention.  It is necessary to make clear to the <i>fenced</i> daemon that the cluster can resume work with the storage, since the node is no longer dangerous.  And in general, maybe it will not return.  For this purpose there is a utility " <i>fence_ack_manual</i> ".  In this case, the operator assumes responsibility for making decisions on the resumption of the cluster. </li></ol><br>  If the host finishes work in the normal mode, it simply asks to delete itself from the <i>domain</i> fence, after which it loses the ability to communicate with the repository. <br><br>  The presence of a host in the <i>fence</i> domain is a prerequisite for performing any operations with the shared storage using cluster <i>software</i> . <br><br>  Consider the fenced configuration using the <i>fence-ilo</i> agent (the <i>configuration is performed on each node of the cluster</i> ): <br><br>  In the <i>/ etc / default / redhat-cluster-pve file we</i> set <br><br><pre><code class="hljs objectivec">FENCE_JOIN=<span class="hljs-string"><span class="hljs-string">"yes"</span></span></code> </pre> <br>  Now when the system starts, the node will connect to the fence-domain.  We do not want to reboot, so we add the node to the domain manually: <br><br><pre> <code class="bash hljs">root@srv03-vmx-02:~<span class="hljs-comment"><span class="hljs-comment"># fence_tool join</span></span></code> </pre><br>  You can view the status of a <i>fenced</i> daemon like this: <br><br><pre> <code class="bash hljs">root@srv03-vmx-02:~<span class="hljs-comment"><span class="hljs-comment"># fence_tool ls fence domain member count 4 victim count 0 victim now 0 master nodeid 1 wait state none members 1 2 3 4</span></span></code> </pre><br><h4>  Testing fence-agent </h4><br>  There are different agents for different versions of <i>iLO</i> : <br><br><pre> <code class="bash hljs">root@tpve01:~<span class="hljs-comment"><span class="hljs-comment"># fence_ilo fence_ilo fence_ilo2 fence_ilo3 fence_ilo_mp</span></span></code> </pre><br>  First of all, we'll <i>poll the</i> status of the node of interest through <i>iLO</i> : <br><br><pre> <code class="bash hljs">root@tpve01:~<span class="hljs-comment"><span class="hljs-comment"># fence_ilo -a ILO_IP -l LOGIN -p PASSWORD -o status Status: ON</span></span></code> </pre><br>  <i>Status: ON</i> .  Instead of " <i>-o status</i> ", you can say " <i>-o reboot</i> ".  The experimental machine will receive a reset of podhy. <br><br>  In the same way, we check the performance of <i>iLO</i> on all nodes. <br><br>  Now we set up the cluster for the correct operation of the <i>fence</i> agents.  <i>There</i> is a good <a href="http://pve.proxmox.com/wiki/Fencing">article</a> about setting up <i>fenced</i> in <i>Proxmox</i> , and I will not retell here what is written there, I will give only the final configuration of our cluster: <br><br><pre> <code class="xml hljs">root@tpve01:~# cat /etc/pve/cluster.conf.new <span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cluster</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tpve"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">config_version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cman</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">keyfile</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/var/lib/pve-cluster/corosync.authkey"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cman</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fencedevices</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fencedevice</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">agent</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fence_ilo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ipaddr</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"IP_ILO_TPVE01"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tpve01"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">passwd_script</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/usr/local/pvesync/ilo_pass/tpve01"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">login</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"LOGIN"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fencedevice</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">agent</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fence_ilo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ipaddr</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"IP_ILO_TPVE02"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tpve02"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">passwd_script</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/usr/local/pvesync/ilo_pass/tpve02"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">login</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"LOGIN"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fencedevices</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">clusternodes</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">clusternode</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tpve01"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">votes</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">nodeid</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fence</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">method</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"power"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">device</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tpve01"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">method</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fence</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">clusternode</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">clusternode</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tpve02"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">votes</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">nodeid</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fence</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">method</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"power"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">device</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tpve02"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">method</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fence</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">clusternode</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">clusternode</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tpve03"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">votes</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">nodeid</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"3"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">clusternodes</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cluster</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  In our example, the " <i>tpve03</i> " node does not have a configured fence agent, and if there are problems with it, the conflict will have to be resolved manually. <br><br>  In order not to shine <i>iLO</i> passwords in the config, instead of the password in the agent settings, the parameter is specified <br><br><pre> <code class="hljs objectivec">passwd_script=<span class="hljs-string"><span class="hljs-string">"/usr/local/pvesync/ilo_pass/tpve01"</span></span></code> </pre><br>  This is the path to the script that gives the password.  The script is primitive: <br><br><pre> <code class="bash hljs">root@tpve01:~<span class="hljs-comment"><span class="hljs-comment"># cat /usr/local/pvesync/ilo_pass/tpve01 #!/bin/bash echo "DERPAROL"</span></span></code> </pre><br>  These scripts must exist on all nodes of the cluster. <br><br>  After all changes to the cluster configuration <a href="http://pve.proxmox.com/wiki/Fencing">are made and validated</a> , we use our config.  In the <i>Proxmox</i> web interface <i>,</i> go to the <i>HA</i> settings and say " <i>Activate</i> ".  If everything happened without errors, and the serial number of the cluster configuration was increased, then the changes will take effect, and you can try to add nodes.  In general, it is highly recommended to arrange fensing of each node of the cluster in order to be sure that everything really works. <br><br>  To begin, we kick the node hands: <br><br><pre> <code class="bash hljs">root@tpve01:~<span class="hljs-comment"><span class="hljs-comment"># fence_node tpve02 fence tpve02 success</span></span></code> </pre><br>  Noda caught reset. <br><br>  Now let's try to emulate the problem.  On one of the nodes we add the network interface, through which the cluster nodes communicate with each other: <br><br><pre> <code class="bash hljs">root@tpve02:~<span class="hljs-comment"><span class="hljs-comment"># ifdown vmbr0</span></span></code> </pre><br>  After some time on a live node, polling the state of the <i>fenced</i> daemon will show the following: <br><br><pre> <code class="bash hljs">root@tpve01:~<span class="hljs-comment"><span class="hljs-comment"># fence_tool ls fence domain member count 2 victim count 1 victim now 2 master nodeid 1 wait state fencing members 1 2 3</span></span></code> </pre><br>  " <i>wait state fencing</i> " says that the problem node is being eliminated from the cluster right now, and the <i>fenced</i> daemon is waiting for news from the <i>fence</i> agent. <br><br>  After receiving confirmation from the agent: <br><br><pre> <code class="bash hljs">root@tpve01:~<span class="hljs-comment"><span class="hljs-comment"># fence_tool ls fence domain member count 2 victim count 0 victim now 0 master nodeid 1 wait state none members 1 3</span></span></code> </pre><br>  Noda killed, work on. <br><br>  When the node rises, it connects to the cluster. <br><br>  Now our cluster is ready to work with shared storage. <br><br>  Perhaps this will stop.  In the next article, which will be released, apparently, in January, I will talk about connecting the storage and working with it. <br><br><ul><li>  Proxmox cluster storage.  Part one.  Fencing </li><li>  <a href="http://habrahabr.ru/company/alawar/blog/166919/">Proxmox cluster storage.</a>  <a href="http://habrahabr.ru/company/alawar/blog/166919/">Part two.</a>  <a href="http://habrahabr.ru/company/alawar/blog/166919/">Launch</a> </li><li>  <a href="http://habrahabr.ru/company/alawar/blog/178429/">Proxmox cluster storage.</a>  <a href="http://habrahabr.ru/company/alawar/blog/178429/">Part Three</a>  <a href="http://habrahabr.ru/company/alawar/blog/178429/">Nuances</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/163297/">https://habr.com/ru/post/163297/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../163285/index.html">Testing unloading 200,000 products on the site of 1C</a></li>
<li><a href="../163287/index.html">Prestigio Multipad 8.0 Pro Duo Review</a></li>
<li><a href="../163289/index.html">Do I need to calibrate color printers?</a></li>
<li><a href="../163291/index.html">Why don't you use cloud infrastructure / services in your company?</a></li>
<li><a href="../163295/index.html">Boston Dynamics LS3 learned to understand voice commands</a></li>
<li><a href="../163303/index.html">In the US, a small business is thinking about the cost of cloud services, and in Russia - about security</a></li>
<li><a href="../163305/index.html">Talking with Bj√∂rn Straustrup, C ++ creator</a></li>
<li><a href="../163307/index.html">10 free tools to control your IT infrastructure: software + video</a></li>
<li><a href="../163309/index.html">Board games played in IT offices - 3</a></li>
<li><a href="../163311/index.html">Books for tmlidov and project managers. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>