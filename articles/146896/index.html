<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using Multiple Persistent Store in Core Data</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All iOS (and Mac OS X) developers know such a system framework as Core Data. This thing is a fairly powerful ORM (at least for a mobile platform). 

 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using Multiple Persistent Store in Core Data</h1><div class="post__text post__text-html js-mediator-article">  All iOS (and Mac OS X) developers know such a system framework as Core Data.  This thing is a fairly powerful ORM (at least for a mobile platform). <br><br>  Initially, our application used one database for all information that needed to be stored in the application.  But as the functionality swells, it became clear that it is more logical to place some entities in different databases, or even in different types of storage (persistent store).  I will not go into details, the main thing is that the initially monolithic NSSQLiteStore needed to be divided into several. <br><a name="habracut"></a><br>  In documentation this question is lit very poorly.  It is only said that it is possible to use several NSPersistentStore inside one NSPersistentStoreCoordinator, and even more, use them directly from one NSManagedObjectContext.  It looks fantastic. <br>  Desperate to understand the issue exclusively on Apple documentation had to switch to Google.  After wandering around the expanses of the network, mainly in the Stack Overflow area, I gathered up a lot of pieces of information, and after several hours of war with XCode, I achieved a less working solution.  In the course of studying the issue, the following was revealed: <br><br>  Indeed, in one NSManagedObjectContext information from several NSPersistentStore may be collected.  This is a detailed article that describes the mechanism for connecting plug-ins to an application with Core Data.  You can get acquainted here: <a href="http://www.cimgf.com/2009/05/03/core-data-and-plug-ins/">www.cimgf.com/2009/05/03/core-data-and-plug-ins</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Only one NSManagedObjectModel can correspond to one NSManagedObjectContext.  How to specify which entities in which storage should be stored?  This is done using the configuration name.  You can create a set of configurations in one NSManagedObjectModel, or you can take several NSManagedObjectModel and merge them into one (while creating each, you still need to create a named configuration). <br><br><pre><code class="objectivec hljs">-(<span class="hljs-built_in"><span class="hljs-built_in">NSManagedObjectModel</span></span>*)managedObjectModel; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(managedObjectModel)<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> managedObjectModel; <span class="hljs-built_in"><span class="hljs-built_in">NSBundle</span></span>*myBundle =[<span class="hljs-built_in"><span class="hljs-built_in">NSBundle</span></span> bundleForClass:[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]]; <span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span>*bundles =[<span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span> arrayWithObject:myBundle]; managedObjectModel =[[<span class="hljs-built_in"><span class="hljs-built_in">NSManagedObjectModel</span></span> mergedModelFromBundles:bundles] <span class="hljs-keyword"><span class="hljs-keyword">retain</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> managedObjectModel; }</code> </pre> <br><br>  Once we have a prepared (second-hand or pre-created) NSManagedObjectModel, you can add storages to the coordinator using the function <br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">NSPersistentStore</span></span> *)addPersistentStoreWithType:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)storeType configuration:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)configuration URL:(<span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> *)storeURLoptions:(<span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *)options error:(<span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> **)error</code> </pre><br>  using the configuration name for each storage type.  Like that: <br><pre> <code class="objectivec hljs"> <span class="hljs-built_in"><span class="hljs-built_in">NSPersistentStore</span></span> * store = [_persistentStoreCoordinator addPersistentStoreWithType:<span class="hljs-built_in"><span class="hljs-built_in">NSSQLiteStoreType</span></span> configuration:CONFIG_NAME URL:databaseURL options:options error:&amp;error];</code> </pre><br>  The file with storage will be created automatically.  After the goal was achieved, I really wanted to see with my own eyes the vaults that Core Data created there.  Specifically, under the magnifying glass was considered NSSQLiteStore.  An interesting thing turned out - whatever the configuration name for the file, it still creates labels for all the entities from the object model.  However, exactly those entities that are specified in the configuration are written to the file.  Otherwise, everything worked in a magical way, from one NSManagedObjectModel, entities were actually pushed into different bases! <br><br>  Separately, you need to say about the link storage.  You cannot create relationships between entities from different repositories.  But you can use fetched properties.  This is more or less clearly described in the Apple dock at <a href="http://developer.apple.com/library/mac/">developer.apple.com/library/mac/#documentation/Cocoa/Conceptual/CoreData/Articles/cdRelationships.html#//apple_ref/doc/uid/TP4000185757-SW5</a> <br><br>  But that is not all.  Since the old version of the application stored a bunch of useful data in its only database, I wanted to somehow migrate this information to our new repositories.  For this, I have sketched something like this in the category NSPersistentStoreCoordinator <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)migratePersistentStore:(<span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> *)sourceStoreURL withType:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)sourceType to:(<span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> *)destinationStoreURL type:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)destinationType andAddWithConfiguration:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)configuration { <span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *error = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *sourceMetadata = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.class metadataForPersistentStoreOfType:sourceType URL:sourceStoreURL error:&amp;error]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(sourceMetadata==<span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">NSManagedObjectModel</span></span> *sourceModel = [<span class="hljs-built_in"><span class="hljs-built_in">NSManagedObjectModel</span></span> mergedModelFromBundles:<span class="hljs-literal"><span class="hljs-literal">nil</span></span> forStoreMetadata:sourceMetadata]; <span class="hljs-built_in"><span class="hljs-built_in">NSMigrationManager</span></span> *migrationManager = [[[<span class="hljs-built_in"><span class="hljs-built_in">NSMigrationManager</span></span> alloc] initWithSourceModel:sourceModel destinationModel:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.managedObjectModel] autorelease]; <span class="hljs-built_in"><span class="hljs-built_in">NSMappingModel</span></span> *mappingModel = [<span class="hljs-built_in"><span class="hljs-built_in">NSMappingModel</span></span> mappingModelFromBundles:<span class="hljs-literal"><span class="hljs-literal">nil</span></span> forSourceModel:sourceModel destinationModel:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.managedObjectModel]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(mappingModel==<span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> result = [migrationManager migrateStoreFromURL:sourceStoreURL type:sourceType options:<span class="hljs-literal"><span class="hljs-literal">nil</span></span> withMappingModel:mappingModel toDestinationURL:destinationStoreURL destinationType:destinationType destinationOptions:nilerror:&amp;error]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(result==<span class="hljs-literal"><span class="hljs-literal">NO</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"Successful DB migration"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *options = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.class migrationOptionsWithAutoMigration:<span class="hljs-literal"><span class="hljs-literal">NO</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">NSPersistentStore</span></span> * addedStore = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> addPersistentStoreWithType:destinationType configuration:configuration URL:destinationStoreURL options:options error:&amp;error]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> addedStore!= <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; }</code> </pre><br>  Unfortunately, decomposing one base in several ways in this way failed.  The first method call works out with a bang.  However, on the second call, already with a different configuration name, Core Data tragically tells me "Can't add the same store twice."  As a result, I decided to migrate only the configuration where important data is stored, and the bases for all logs and caches that can be rebuilt, create from scratch. <br></div><p>Source: <a href="https://habr.com/ru/post/146896/">https://habr.com/ru/post/146896/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../146886/index.html">Online promotion - a spherical horse in a vacuum or why it does not work</a></li>
<li><a href="../146889/index.html">vmd - console application for downloading music from vk.com</a></li>
<li><a href="../146891/index.html">Ubercart shopping cart in popup window. Drupal 6</a></li>
<li><a href="../146893/index.html">Localization of projects written using Catalyst MVC Framework</a></li>
<li><a href="../146894/index.html">Automatic weather station at the cottage</a></li>
<li><a href="../146897/index.html">The illusion of reality, a note on human engineering</a></li>
<li><a href="../146898/index.html">Artificial Intelligence. Forecast 2029</a></li>
<li><a href="../146899/index.html">Book purchases can be tracked on Google Maps</a></li>
<li><a href="../146900/index.html">About emotions, programs and artificial intelligence</a></li>
<li><a href="../146901/index.html">Programmers misconceptions about names</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>