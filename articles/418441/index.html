<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Basics of privilege escalation in Windows</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I decided for myself and for those who would benefit from collecting everything I know, but I don‚Äôt remember on the subject, in this article. Share ti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Basics of privilege escalation in Windows</h1><div class="post__text post__text-html js-mediator-article">  I decided for myself and for those who would benefit from collecting everything I know, but I don‚Äôt remember on the subject, in this article.  Share tips.  The main source of this article is <a href="http://www.fuzzysecurity.com/tutorials/16.html">this</a> . <br><br>  I freely translated and added a little from myself, what I gathered and learned from other sources. <br><br>  In general, here are ways to help us achieve the goal of elevating privileges. <br><a name="habracut"></a><br>  The starting point for this small article is the unprivileged shell (account).  We may have used an exploit or launched an attack and got this shell. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In principle, at the initial moment of time we do not understand the machine: what it does, what it is connected to, what level of privileges we have or even what kind of operating system it is. <br><br>  First, we need to get the information we need in order to understand where we are and what we have: <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">systeminfo</span></span> | findstr /B /C:<span class="hljs-string"><span class="hljs-string">" "</span></span> /C:<span class="hljs-string"><span class="hljs-string">" "</span></span></code> </pre> <br>  This command allows you to determine, as can be seen from it, the Name and version of the OS.  You can execute it without parameters, then the command output will be more complete, but this is enough for us. <br><br>  Next, it is important to find out the name of the machine and the name of the user under which we are connected. <br><br><ul><li>  hostname is the username. </li><li>  echo% username% - username. </li></ul><br>  Next, let's see what users are still on this host and get more detailed information about your user. <br><br><ul><li>  net users - other users </li><li>  net user user1 - detailed information on the user, where user1 is the name of your user. </li></ul><br>  After receiving information about accounting, we will look at information about the network interaction of this host. <br><br>  First, look at the available interfaces and the routing table. <br><br><ul><li>  ipconfig / all - information about the available interfaces. </li><li>  route print - routing table </li><li>  arp -A - table arp records </li></ul><br>  Next, look at the active network connections and firewall rules. <br><br><ul><li>  netstat -ano - active network connections. </li></ul><br>  -a - starting with this parameter will display all active TCP connections, as well as TCP and UDP ports that the system is listening on; <br>  -n - option to show active TCP connections with addresses and port numbers; <br>  -o - the same as the previous key, displays active TCP connections, but process codes have been added to the statistics, it is already possible to determine exactly which application uses the connection. <br><br><ul><li>  netsh firewall show state - firewall status </li><li>  netsh firewall show config - firewall configuration </li></ul><br>  Finally, we briefly review what works on a compromised host: scheduled tasks, running processes, running services, and installed drivers. <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">schtasks</span></span> /query /fo LIST /v</code> </pre> <br>  Where <br>  / query - Displays data on all scheduled tasks. <br>  / fo LIST - Output to the list. <br>  / v - Displays detailed information about the task. <br><br>  The following command associates the running processes with the running services. <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">tasklist</span></span> /SVC</code> </pre> <br>  Where, <br>  / Svc - Displays services for each process. <br><br>  Also see the list of running Windows services. <br><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">net</span></span> <span class="hljs-built_in"><span class="hljs-built_in">start</span></span></code> </pre> <br>  It is also useful to look at information about the drivers of the compromised system. <br><br><pre> <code class="hljs">DRIVERQUERY</code> </pre> <br>  Further I would like to mention, probably, the most useful Windows command - wmic.  The WMIC (Windows Management Instrumentation Command) is used to get information about hardware and systems, manage processes and their components, and change settings using the capabilities of Windows Management Instrumentation (Windows Management Instrumentation or WMI).  <a href="https://www.computerhope.com/wmic.htm">Good description</a> . <br><br>  Unfortunately, some default Windows configurations do not allow access to WMIC if the user is not in the Administrators group (which is a really good idea).  Any XP version did not allow access to WMIC from an unprivileged account. <br><br>  By contrast, Windows 7 Professional and Windows 8 Enterprise allowed low-privilege users to use WMIC by default. <br><br>  According to custom - program parameters: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">wmic</span></span> /?</code> </pre> <br>  <a href="">A good script to collect information through wmic.</a> <br><br>  Before you go further it is worth running through the collected information.  You should also pay attention to patches installed in the system, since any information about holes in the system will give us additional support to increase our privileges.  By HotFix number, you can search for privilege elevation vulnerabilities. <br><br>  Next we look at the automatic installation.  If there is a need to install and configure a large fleet of vehicles, as a rule, technicians will not move from one vehicle to another to set up a personal one.  There are several solutions for automatic installation.  It is not so important for us what these methods are and how they work, but what is important is that they leave configuration files that are used for the installation process, containing a lot of confidential information, such as the operating system product key and administrator password.  What interests us most is the administrator password, which we can use to enhance our privileges. <br><br>  Typically, these are the following directories: <br><br><ul><li>  c: \ sysprep.inf </li><li>  c: \ sysprep \ sysprep.xml </li><li>  % WINDIR% \ Panther \ Unattend \ Unattended.xml </li><li>  % WINDIR% \ Panther \ Unattended.xml </li></ul><br>  But it is worth checking the whole system. <br><br>  These files contain passwords in clear text or in BASE64 encoding. <br>  Examples: <br><br>  Sysprep.inf - password in clear text. <br><br><img src="https://habrastorage.org/webt/fq/1t/qm/fq1tqm53bjiwjlwsbrevzdcy6qw.png">  " <br><br>  Sysprep.xml is a base64 encoded password. <br><br><img src="https://habrastorage.org/webt/rh/2r/gk/rh2rgkl3wtby-9lagcxmfrnrlgu.png">  " <br><br>  Unattended.xml is a base64 encoded password. <br><br><img src="https://habrastorage.org/webt/5e/1p/gl/5e1pglvwtogk0kd0xn4cmey_hlo.png"><br><br>  Also, for hosts connected to a domain, you can search for the Group.xml file, which contains the encrypted AES256 password, but which can be decrypted, because  The key is laid out on msdn (https://msdn.microsoft.com/en-us/library/cc422924.aspx) and other sources.  But this is the case if the policy of creating local users on hosts is used, or, for example, setting a password to the local Administrator. <br><br>  For example, I have here: <br><br><img src="https://habrastorage.org/webt/jy/wu/4g/jywu4g6xzymrbkwwniw4m_3uckg.png"><br><br>  Opening it, look for the ‚Äúcpassword‚Äù parameter. <br><br><img src="https://habrastorage.org/webt/i9/ow/hk/i9owhkwprnwlpmltga00uj-awx4.png"><br><br>  Next you need to decipher this sequence.  We use, for example, <a href="https://www.cryptool.org/en/ct1-downloads">CrypTool</a> .  First we decode Base64. <br>  The peculiarities of Base64 are that its length should be a multiple of 4. Therefore, we count blocks of 4, and if there are not enough characters in the last block, then the missing ones are added with ‚Äú=‚Äù symbols. <br>  I got 2 "=". <br><br><img src="https://habrastorage.org/webt/bm/sc/73/bmsc73fsqblniktrnrsyugqowhi.png"><br><br>  Next, decipher.  Applying the key above. <br><br><img src="https://habrastorage.org/webt/-f/n0/nt/-fn0ntf9um-zfyfoqpn7uwafoay.png"><br><br>  Remove the extra points separating the characters and get the password. <br><br>  In addition to Group.xml, here are a few other policy preference files that may have an additional set of cPassword attributes: <br><br><ul><li>  Services \ Services.xml </li><li>  ScheduledTasks \ ScheduledTasks.xml </li><li>  Printers \ Printers.xml </li><li>  Drives \ Drives.xml </li><li>  DataSources \ DataSources.xml </li></ul><br>  However, we all love automated solutions, so we can get to the finish line as quickly as possible.  There are two main options, depending on the type of shell / access that we have.  There is a metasploit module that can be run through an established session (https://www.rapid7.com/db/modules/post/windows/gather/credentials/gpp) or you can use Get-GPPPassword, which is part of <a href="https://github.com/PowerShellMafia/PowerSploit">PowerSploit</a> . <br><br>  Okay, next.  We will look for a strange registry key "AlwaysInstallElevated".  This option allows unprivileged users to install .msi files from under NT AUTHORITY \ SYSTEM. <br><br>  In order to be able to use this, we must verify that both registry keys are installed, and if so, we can get the SYSTEM shell.  Check: <br><br><pre> <code class="hljs tex">reg query HKLM<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SOFTWARE</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Policies</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Installer</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AlwaysInstallElevated</span></span></span></span></code> </pre> <br><pre> <code class="hljs tex">reg query HKCU<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SOFTWARE</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Policies</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Installer</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AlwaysInstallElevated</span></span></span></span></code> </pre> <br>  Metasploit includes a special module exploit / windows / local / always_install_elevated, which creates an MSI file with a special executable file embedded in it, which is extracted and executed by the installer with system privileges.  After its execution, the msi file stops installation in order to prevent the registration of the action in the system.  In addition, if you start the installation with the / quiet key, then there is not even an error. <br><br>  Well, some useful commands for searching the system: <br><br>  The command below will search the file system for filenames containing specific keywords.  You can specify any number of keywords. <br><br><pre> <code class="hljs markdown">dir /s <span class="hljs-emphasis"><span class="hljs-emphasis">*pass*</span></span> == <span class="hljs-emphasis"><span class="hljs-emphasis">*cred*</span></span> == <span class="hljs-emphasis"><span class="hljs-emphasis">*vnc*</span></span> == <span class="hljs-emphasis"><span class="hljs-emphasis">*.config*</span></span></code> </pre> <br>  Search for specific file types by keyword, this command can generate a lot of output. <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">findstr</span></span> /si password <span class="hljs-regexp"><span class="hljs-regexp">*.xml</span></span> <span class="hljs-regexp"><span class="hljs-regexp">*.ini</span></span> <span class="hljs-regexp"><span class="hljs-regexp">*.txt</span></span></code> </pre> <br>  Similarly, the two commands below can be used to grep the registry by keyword, in this case ‚Äûpassword‚Äú. <br><br><pre> <code class="hljs pgsql">reg query HKLM /f <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> /t REG_SZ /s</code> </pre> <br><pre> <code class="hljs pgsql">reg query HKCU /f <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> /t REG_SZ /s</code> </pre> <br>  At the moment we already have enough to get the system walked.  But there are a couple more attacks to get the desired result: we look at Windows services and permissions for files and folders.  Our goal here is to use weak permissions to elevate session privileges. <br><br>  We will check a lot of access rights, accesschk.exe, which is a tool from Microsoft Sysinternals Suite, will help us with this.  Microsoft Sysinternals contains many great tools.  The package can be downloaded from the Microsoft technet site (https://docs.microsoft.com/ru-ru/sysinternals/downloads/sysinternals-suite). <br><br>  We can check the required privilege level for each service using accesschk. <br><br>  We can see the permissions that each user level has. <br><br><img src="https://habrastorage.org/webt/jo/pf/q2/jopfq2pwodrwtcexiainzaji4yk.png"><br><br>  Accesschk can automatically check if we have write access to a Windows service with a specific user level.  As a rule, as a user with low privileges, we want to check "Users".  Make sure to check which user groups you belong to. <br><br>  -c The Windows service is specified as the name, for example ssdpsrv (specify ‚Äú*‚Äù to display all services on the screen) <br>  -d Process directories only. <br>  -e Only explicitly set integrity levels (for Windows Vista only) <br>  -k The registry key is specified as a name, for example hklm \ software <br>  -n Only display objects that do not have access rules. <br>  -p The name or process identifier (PID) is specified as a name, for example cmd.exe (specify ‚Äú*‚Äù as the name to display all processes) <br>  -q Delete title <br>  -r Only display objects that have read access. <br>  -s recursive processing <br>  -v Show detailed information <br>  -w Display only objects that have write access. <br><br><img src="https://habrastorage.org/webt/4z/1r/u6/4z1ru6mikuprkxybtdzohmzgl5s.png"><br><br>  There is also another interesting team: <br><br><pre> <code class="hljs dos">autorunsc.exe -a | <span class="hljs-built_in"><span class="hljs-built_in">findstr</span></span> /n /R "File\ <span class="hljs-keyword"><span class="hljs-keyword">not</span></span>\ found"</code> </pre> <br>  Allows you to find an entry in the registry about a file that was launched automatically, but is no longer in the system  The record could remain if, for example, the service was incorrectly deleted.  Each time the system is started, it tries unsuccessfully to launch this file.  This situation can also be used to expand its powers.  Just in place of this file, you can substitute ours. <br><br>  Next, we consider two vulnerabilities: <br><br>  First: replicate the results of a post written by Parvez from GreyHatHacker;  "Elevating privileges by exploiting weak folder permissions" (http://www.greyhathacker.net/?p=738). <br><br>  This example is a special case of dll hijacking.  Programs usually cannot function by themselves, they have a lot of resources that they need to connect (mostly dll, but their own files).  If a program or service downloads a file from a directory to which we have write access, we can abuse it to run a shell with the privileges under which the program runs. <br><br>  Typically, a Windows application will use predefined search paths to find the dll, and it will check these paths in a specific order.  Dll hijacking usually occurs by placing malicious dll along one of these paths.  This problem can be eliminated by specifying the absolute paths for the application to the necessary dll. <br><br>  Dll search order: <br><br><ol><li>  Directory with which the application is running </li><li>  32-bit System directory (C: \ Windows \ System32) </li><li>  16-bit System directory (C: \ Windows \ System) </li><li>  Windows directory (C: \ Windows) </li><li>  Current working directory (CWD) </li><li>  Directories in the PATH environment variable (system then user) </li></ol><br>  Sometimes applications try to load dll files missing on the machine.  This can occur for several reasons, for example, if the dll library is required only for certain plug-ins or components that are not installed.  In this case, Parvez found that some Windows services are trying to load dll libraries that do not exist in the default settings. <br><br>  Since dll does not exist, we end up traversing all the search paths.  As a user with a low level of privileges, we have few chances to put a malicious dll in sections 1-4, 5. But if we have write access to any of the directories, then our chances of winning are great. <br><br>  Let's see how this works in practice, for our example, we will use the IKEEXT (IPSec IKE and AuthIP key modules) service that tries to load wlbsctrl.dll. <br><br>  Any directory in "C: \" will give write access to authenticated users, this gives us a chance. <br><br><pre> <code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span></span>1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Desktop</span></span></span></span>&gt; accesschk.exe -dqv "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Python</span></span></span></span>27"</code> </pre> <br><pre> <code class="hljs pgsql">C:\Python27 Medium Mandatory <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>) [<span class="hljs-keyword"><span class="hljs-keyword">No</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">Write</span></span>-Up] RW BUILTIN\Administrators FILE_ALL_ACCESS RW NT AUTHORITY\<span class="hljs-keyword"><span class="hljs-keyword">SYSTEM</span></span> FILE_ALL_ACCESS R BUILTIN\Users FILE_LIST_DIRECTORY FILE_READ_ATTRIBUTES FILE_READ_EA FILE_TRAVERSE SYNCHRONIZE READ_CONTROL RW NT AUTHORITY\Authenticated Users FILE_ADD_FILE FILE_ADD_SUBDIRECTORY FILE_LIST_DIRECTORY FILE_READ_ATTRIBUTES FILE_READ_EA FILE_TRAVERSE FILE_WRITE_ATTRIBUTES FILE_WRITE_EA <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> SYNCHRONIZE READ_CONTROL</code> </pre><br><pre> <code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span></span>1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Desktop</span></span></span></span>&gt; icacls "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Python</span></span></span></span>27"</code> </pre> <br><pre> <code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Python</span></span></span></span>27 BUILTIN<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Administrators</span></span></span></span>:(ID)F BUILTIN<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Administrators</span></span></span></span>:(OI)(CI)(IO)(ID)F NT AUTHORITY<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SYSTEM</span></span></span></span>:(ID)F NT AUTHORITY<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SYSTEM</span></span></span></span>:(OI)(CI)(IO)(ID)F BUILTIN<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span>:(OI)(CI)(ID)R NT AUTHORITY<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Authenticated</span></span></span></span> Users:(ID)C NT AUTHORITY<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Authenticated</span></span></span></span> Users:(OI)(CI)(IO)(ID)C</code> </pre><br>  F - full access. <br>  (OI) - inheritance by objects. <br>  (CI) - container inheritance. <br>  (IO) - inheritance only. <br>  (NP) - a ban on the distribution of inheritance. <br>  (I) - inheritance of permissions from the parent container. <br><br>  Before proceeding to the action, you must check the status of the IKEEXT service.  In this case, we can see that it is set to ‚ÄûAUTO_START‚Äú! <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sc</span></span> qc IKEEXT</code> </pre> <br><pre> <code class="hljs tex">[SC] QueryServiceConfig SUCCESS SERVICE_NAME: IKEEXT TYPE : 20 WIN32_SHARE_PROCESS START_TYPE : 2 AUTO_START ERROR_CONTROL : 1 NORMAL BINARY_PATH_NAME : C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system</span></span></span></span>32<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">svchost</span></span></span></span>.exe -k netsvcs LOAD_ORDER_GROUP : TAG : 0 DISPLAY_NAME : IKE and AuthIP IPsec Keying Modules DEPENDENCIES : BFE SERVICE_START_NAME : LocalSystem</code> </pre> <br>  Now we know that we have the necessary conditions, and we can create malicious dll and shell interception! <br><br>  We use Metasploit -&gt; msfvenom, for example. <br><br><img src="https://habrastorage.org/webt/ac/-m/_z/ac-m_z8lymihvi6r6g3dsxmebr8.png"><br><br>  After transferring evil.dll to our target computer, all we need to do is rename it to wlbsctrl.dll and move it to "C: \ Python27".  Once this is done, we need to wait patiently for the reboot of the machine (or we can try to force a reboot) and we will get the system shell. <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">copy</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">evil</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.dll</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span>:\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Python27</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">wlbsctrl</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.dll</span></span></code> </pre> <br>  After that, it remains only to wait for the system to reboot. <br><br>  For our last example, we will look at scheduled tasks.  I will describe the principle, because  everyone may have different cases. <br><br>  We find the process, service, application launched by the task scheduler from SYSTEM. <br>  Check permissions on the folder where our target is located. <br><br><pre> <code class="hljs objectivec">accesschk.exe -dqv <span class="hljs-string"><span class="hljs-string">"__"</span></span></code> </pre> <br>  Clearly, this is a serious configuration issue, but it‚Äôs even worse that any authenticated User (authenticated user) has write access to this folder.  In this example, we can simply overwrite the binary executable file with the file generated in metasploit. <br><br>  You can code additionally. <br><br><img src="https://habrastorage.org/webt/7c/p6/qv/7cp6qviajkpgxvibpruzsgqhjv4.png"><br><br>  Now it remains only to download the malicious executable file and overwrite it in the folder of the executable file.  Once this is done, we can safely go to sleep and get a system walk early in the morning. <br><br>  These two examples should give us an idea of ‚Äã‚Äãthe vulnerabilities that need to be sought when considering permissions for files and folders.  It will take time to explore all the binpath paths for windows services, scheduled tasks, and autorun tasks. <br><br>  Finally a couple of tips on using accesschk.exe. <br><br>  Find all weak permissions for folders on disk. <br><br><pre> <code class="hljs swift">accesschk.exe -uwdqs <span class="hljs-type"><span class="hljs-type">Users</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\ accesschk.exe -uwdqs <span class="hljs-string"><span class="hljs-string">"Authenticated Users"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\</code> </pre><br>  Find all weak permissions for files on disk. <br><br><pre> <code class="hljs swift">accesschk.exe -uwqs <span class="hljs-type"><span class="hljs-type">Users</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\*.* accesschk.exe -uwqs <span class="hljs-string"><span class="hljs-string">"Authenticated Users"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\*.*</code> </pre> <br>  Look like that's it. </div><p>Source: <a href="https://habr.com/ru/post/418441/">https://habr.com/ru/post/418441/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../418429/index.html">My experience with being an Agile Coach in Europe, part two</a></li>
<li><a href="../418431/index.html">Imaginary problems are the root of bad software.</a></li>
<li><a href="../418433/index.html">August 4th. Peter. First cycle quest for programmers</a></li>
<li><a href="../418435/index.html">"Yandex" again indexed documents Google Docs</a></li>
<li><a href="../418439/index.html">The Basics of Progressive Web Applications</a></li>
<li><a href="../418443/index.html">GObject: encapsulation, instantiation, introspection</a></li>
<li><a href="../418445/index.html">Django Channels - the answer to the modern web</a></li>
<li><a href="../418447/index.html">Why Moscow Python Conf is now ++</a></li>
<li><a href="../418449/index.html">Binary modules for Python</a></li>
<li><a href="../418451/index.html">3D printing lessons. Effective support and changing the height of the layers in practice from the company 3Dtool</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>