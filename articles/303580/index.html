<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we develop a new frontend Tinkoff.ru</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In April of this year, we restarted tinkoff.ru. The bank has become a financial supermarket. Now not only the bank‚Äôs client, but any visitor will pay ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we develop a new frontend Tinkoff.ru</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/04f/713/140/04f713140833405a822536f1a3e44c36.png" alt="Tinkoff.ru"></p><br><p>  In April of this year, we restarted tinkoff.ru.  The bank has become a financial supermarket.  Now not only the bank‚Äôs client, but any visitor will pay for the mobile, check taxes and issue a mortgage - all on one platform.  In this article, I will share the experience and technological solutions to which we came during the year of development. </p><a name="habracut"></a><br><p>  Our stack for the front end showed itself well.  Now we solve problems and adapt to new requirements within the framework of the concept of architecture. </p><br><p>  Over the year, we have developed 350 independent interface blocks of 3000 React components.  Optimized the loading of pages, because 7 million users visit tinkoff.ru per month and the number of visitors is constantly growing.  The frontend develops 30 people and we are constantly looking for talented developers. </p><br><p>  We have combined the functions of the previous Internet banks, the portal and the wallet.  Therefore, I will first describe the source stacks, and then tell you how we came to the current stack. </p><br><h1>  Review of previous stacks </h1><br><h2>  Portal and Internet Bank 2011 </h2><br><p>  We developed the first version with internal resources based on a commercial solution from a Dutch company.  Backend spun based on heavy Java / Spring applications.  At the front, due to lack of flexibility and detailed documentation, a stack of jQuery, Backbone, Handlebars was formed. </p><br><p><img src="https://habrastorage.org/files/5c6/0f8/def/5c60f8defe394451abc27215192fc3df.png" align="left">  Maven collected front with back.  There were too few plugins for the front, since Maven was not suitable for building client packages.  This led us to a dead end.  The blessing found how to separate client assembly from the server using Grunt. </p><br><p>  Using templates on the server and unrelated templates on the client with its own logic and architecture was considered the norm.  It was necessary to support two UI-layers: server UI and client UI.  When we have a large RIA, a lot of logic is duplicated, which is written in different programming languages.  For example: routing through pages, data acquisition logic, or patterns with the same markup. </p><br><p>  At the end of 2013, an isomorphic approach to creating web applications began to develop.  And the solution with duplication of templates on the server and on the client was considered conceptually incorrect. </p><br><h2>  Wallet 2014 </h2><br><p>  This project is interesting for two reasons: </p><br><ol><li>  Tinkoff Mobile Wallet is the first application that everyone used, not just bank customers. </li><li>  We tried an isomorphic approach based on the MVC architecture.  The starting point is <a href="http://nerds.airbnb.com/isomorphic-javascript-future-web-apps/">an article from Airbnb</a> . </li></ol><br><p>  The stack was similar to Internet banking: Backbone and Handlebars, a server on Node.js.  Part of the view was rendered on the server.  The application solved its tasks and even turned out one UI-layer.  But it became clear that on a large application such architecture would bring complexity.  There were problems with the enrichment of data models in the browser.  I had to write separate controllers for the server and client side. </p><br><p>  The next project was developed according to a different paradigm. </p><br><h2>  Online Banking 2015 </h2><br><p>  The Internet Bank was separated from the external site and was a Single Page Application.  For online banking, the framework used is Angular.js.  As a result, we received a modern online banking interface. </p><br><p>  In 2015, the business changed its development strategy and presented new requirements for the web application.  We had to: </p><br><ul><li>  update Tinkoff.ru, </li><li>  integrate Internet bank and wallet functionality into all pages, </li><li>  support SEO and SMM for all pages, including pages with payment providers. </li></ul><br><p><img src="https://habrastorage.org/files/585/560/87f/58556087fe09499f95a64da43d8609dd.png" align="left">  A new Internet bank had a UI-layer only on the client.  Search robots have not yet learned how to index such applications well.  And it is not clear when this will happen.  It was not possible to abandon the server layer.  We have seen several paths for the development of existing stacks: </p><br><ol><li>  <strong>Combine old portal and new internet bank.</strong>  The portal would act as a server UI layer, and Angular.js as a client.  This option would not solve our fundamental problems. </li><li>  <strong>Replace Java application Node.js application.</strong>  This could simplify support, but there are two UI layers left. </li><li>  <strong>Remove Java, leave only Angular.js.</strong>  And render SPA using deployed servers with Phantom.js headless browser.  This scheme is difficult to debug, so this option is not suitable for a large number of pages. </li></ol><br><p>  We analyzed the development paths of existing stacks and realized that they did not solve our problems.  As a result, we chose a radically different approach. </p><br><h2>  Platform 2016 </h2><br><p>  What is now available on Tinkoff.ru, we call the platform. </p><br><p>  We chose the <a href="https://facebook.github.io/flux/">Flux</a> architecture, which was proposed by Facebook engineers in 2014, as the basis for this system.  Flux differs from MV * in that there are no multidirectional data streams, which makes it easier to fit the isomorphic paradigm and all this helps to debug the application faster.  The Flux architecture has taken the <a href="http://martinfowler.com/bliki/CQRS.html">CQRS</a> database model as a basis. </p><br><p><img src="https://habrastorage.org/files/cda/83e/393/cda83e39303344c8877617bccdc39532.png" align="left">  We implemented the idea of ‚Äã‚Äãan isomorphic application with a single UI layer.  We chose React.js library with virtual DOM support as a template engine.  Thanks to which templates are easily rendered on the server. </p><br><p>  The established stack solves the problems of SEO and SMM.  Re-uses code between the browser and the server, with the exception of environment-specific code, such as working with cookies.  Allows you to solve the whole range of tasks by one group of developers, which leads to acceleration of work.  It does not depend on one framework / vendor.  The application is united by a set of rules, lined up from small and independent modules.  The module can be replaced if there is a more suitable implementation. </p><br><h1>  Universal application </h1><br><h2>  Fluxible </h2><br><p>  The <a href="http://fluxible.io/">Fluxible</a> framework from Yahoo engineers was chosen as the Flux implementation.  This implementation is focused on isomorphic rendering.  The chosen solution fully meets our requirements. </p><br><p>  We try not to associate the application with large dependencies, so we use only two libraries from the set: </p><br><ol><li>  <a href="https://github.com/yahoo/routr">Routr</a> - routing through pages.  The library supports express-like paths.  It is isomorphic and fast: we are now moving across 2000 pages. </li><li>  <a href="https://github.com/yahoo/fluxible/tree/master/packages/dispatchr">Dispatchr</a> - Flux controller. </li></ol><br><h2>  Layer distribution </h2><br><p>  Application architecture </p><br><p><img src="https://habrastorage.org/files/403/e65/17d/403e6517d6884057a1f2e1c98eb4a3cf.png" alt="image"></p><br><p>  <em>Services.</em>  Access to browser or HTTP API, interaction with external systems.  This contains part of the business logic.  Services have several implementations: isomorphic shared, server for node.js and client for browser.  Can cache the result. </p><br><p>  <em>Actions.</em>  Flux action creators, contain part of the UI and business logic.  Have access to services. </p><br><p>  <em>Stor.</em>  Data models that contain UI logic. </p><br><p>  <em>Components.</em>  Render data from HTML to HTML. </p><br><h2>  Progressive download </h2><br><p>  Thanks to the server renderer, we get the effect of progressive loading and reducing time to glass.  The average user sees a working page after 600 ms after a site request.  After a couple of seconds, the speaker is initialized and personal data is loaded. </p><br><p><img src="https://habrastorage.org/files/8c3/5c3/91c/8c35c391cd094a4baa3122a33bb72f97.png" alt="image"></p><br><p>  We can render all the data on the server, we can render part of it.  And we can completely disable the server part and use the application as a SPA.  To reduce server load, we render only general data for all users, and work with personal data in the browser. </p><br><p><img src="https://habrastorage.org/files/c10/ddb/570/c10ddb5703ab44c4a173b58914af760d.png" alt="image"></p><br><h2>  Code example </h2><br><p>  What to perform on the server or what to allow the user to start with certain roles, we define at the level of the function of creating actions: </p><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { ACCOUNT_LIST } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../actions'</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { CLIENT } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../roles'</span></span>;

accountList.isServer = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-comment"><span class="hljs-comment">//        </span></span>
accountList.requiredRoles = [CLIENT]; <span class="hljs-comment"><span class="hljs-comment">//     </span></span>

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accountList</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">context</span></span></span><span class="hljs-function">) </span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.service(<span class="hljs-string"><span class="hljs-string">'account/list'</span></span>) <span class="hljs-comment"><span class="hljs-comment">//             .    .</span></span>
        .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">payload</span></span></span><span class="hljs-function"> =&gt;</span></span> context.dispatch(ACCOUNT_LIST, payload)); <span class="hljs-comment"><span class="hljs-comment">//      </span></span>
}

<span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> accountList;</code></pre><br>
<p>        .     ,      .</p><br>
<h2></h2><br>
<p>      .    ,   .         :</p><br>
<p><img src="https://habrastorage.org/files/731/02b/7e8/73102b7e8c5e4581a586a4ac7ce38af5.png" alt="image"></p><br>
<p>      .</p><br>
<h2> </h2><br>
<pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { LogoPure } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./LogoPure.jsx'</span></span>;

<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> UILogo = connect(
    [<span class="hljs-string"><span class="hljs-string">'config'</span></span>, <span class="hljs-string"><span class="hljs-string">'brands'</span></span>],
    ({
        brands,
        <span class="hljs-attr"><span class="hljs-attr">config</span></span>: { brandsBasePath }
    }) =&gt; ({
        brands,
        brandsBasePath
    })
)(LogoPure);

<span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> UILogo;</code></pre><br>
<p>  connect (    redux),      .   ‚Äì  ,    .   ‚Äì  ,            .</p><br>
<h2>Higher-order Components</h2><br>
<p> ,         ‚Äî   .      ,   React.createClass.</p><br>
<p>    .            ,      .      <a href="https://medium.com/%40dan_abramov/mixins-are-dead-long-live-higher-order-components-94a0d2f9e750">Mixins Are Dead. Long Live Composition</a>.</p><br>
<h1></h1><br>
<p>      :   .        .</p><br>
<h2>  </h2><br>
<p>    ‚Äì      render.      pure-render.   render    <a href="https://facebook.github.io/react/docs/component-specs.html">shouldComponentUpdate</a>,      (props  state).</p><br>
<p>     ,   .    ,   ,      .     pure-render  .     render    ,    <a href="https://facebook.github.io/react/docs/perf.html">react-perf</a>.        :</p><br>
<p><img src="https://habrastorage.org/files/530/f5b/5cb/530f5b5cb66144358abd79188b6bd500.png" alt="image"></p><br>
<p>       ,         render-logger.     ,    render:</p><br>
<p><img src="https://habrastorage.org/files/33c/d92/f8e/33cd92f8edf542439b0745beae2c8f1c.png" alt="image"></p><br>
<p>  -  ,    onClick.     bind     render  ,     render   .  -     pure-render  .</p><br>
<p>  bind  render,   Eslint   <a href="https://github.com/yannickcr/eslint-plugin-react">eslint-plugin-react</a>   jsx-no-bind.</p><br>
<h3>Batched updates</h3><br>
<p>React      runtime.        .     ,     .     .</p><br>
<h3> </h3><br>
<p> ,        ,   .         .</p><br>
<p>   Tinkoff.ru      ,    .</p><br>
<p><img src="https://habrastorage.org/files/bb6/d28/136/bb6d28136a524747a00bc31254e554c7.png" alt="image"> <img src="https://habrastorage.org/files/19f/368/e5e/19f368e5e35b4273b66ae3d4c40b387b.png" alt="image"></p><br>
<p>          JS.            .  ,     .</p><br>
<p>      ,     .       ,     . </p><br>
<h2>  </h2><br>
<p>   React    .    ,      .</p><br>
<ol>
<li> ES6 Class,   React.createClass (  - autobinding)    NODE_ENV=production,     .    4  .</li>
<li>  React.     . +2% (      )</li>
<li>    Babel.   : <br>
<ol>
<li>transform-react-constant-elements        </li>
<li> transform-react-inline-elements   createElement   . +10%</li>
</ol></li>
<li>  <a href="https://facebook.github.io/react/docs/reusable-components.html">stateless </a>.           45%.</li>
<li><a href="https://github.com/aickin/react-dom-stream">React-dom-stream</a>    renderToString  ,         (TTFB)     3-5.         (TTLB)  55%.<br>
      React 15. ,      React: <a href="https://github.com/aickin/react-dom-stream/issues/18"></a><a href="https://github.com/aickin/react-dom-stream/issues/18">https://github.com/aickin/react-dom-stream/issues/18</a>  ,        ,     .</li>
</ol><br>
<p>      .      HTML,    .</p><br>
<h1></h1><br>
<p>      :</p><br>
<ol>
<li>Nginx         .</li>
<li><a href="https://github.com/punkave/express-cache-on-demand">Express-cache-on-deamand</a>     .</li>
<li><a href="https://github.com/isaacs/node-lru-cache">Lru-cache</a>      .</li>
</ol><br>
<p> lru-cache        .     TTL    ,    .      ‚Äì    .    ,    .        ,    .</p><br>
<p> <a href="https://github.com/cyberthom/stale-lru-cache"></a>,    :</p><br>
<p><img src="https://habrastorage.org/files/6e1/8bf/4b4/6e18bf4b482e499e9e24314b1e841bf9.png" alt="image"></p><br>
<h1>  </h1><br>
<p>     CI Teamcity.        .       Webpack.     .</p><br>
<p>     tar       .     Babel  ,        ‚Äì Babel     . </p><br>
<p><strong>  </strong> ‚Äì    , .<br>
   Babel   ,       .<br>
           .          ,    Babel   . </p><br>
<p><strong> ,   </strong> ‚Äì      Webpack.    ,      .<br>
      ,         .                    .</p><br>
<p>        application runner PM2. PM2   .</p><br>
<ol>
<li>     pm2 startOrGracefulReload processes.json,        .<br>
processes.json:<br>
<pre><code class="javascript hljs">{
<span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"portal"</span></span>,
<span class="hljs-string"><span class="hljs-string">"script"</span></span>: <span class="hljs-string"><span class="hljs-string">"server/index.js"</span></span>,
<span class="hljs-string"><span class="hljs-string">"instances"</span></span>: <span class="hljs-number"><span class="hljs-number">-1</span></span>
}</code></pre></li>
<li>        ,     .          Node.js   .            ‚Äì Nginx.            Nginx    .  PM2   .        NODE_APP_INSTANCE: PORT: process.env.PORT + process.env.NODE_APP_INSTANCE</li>
</ol><br>
<p><img src="https://habrastorage.org/files/227/fa9/8f0/227fa98f089444cc97d6b194b4b33c65.png" alt="image"></p><br>
<h1></h1><br>
<p> -   ,       . React.js       -.  DOM   -  . Flux      . Node.js        .</p><br>
<p>       , , ,          . ,              ,      .         React.js, Flux     Dream Team. </p><br>
<p>    <a href="">best-talents@tinkoff.ru</a>.</p><br>
<p>        :</p><br>
<p><img src="https://habrastorage.org/files/a02/fe1/854/a02fe18543fb40019bf320bacddd4766.png" alt="image"></p><br>
<p><img src="https://habrastorage.org/files/fe0/388/3cd/fe03883cd8d348469aa5f51c6e7bc394.png" alt="image"></p><br>
<p>    !</p><br>
<p>PS:        -,      ,      <a href="https://fintech.tinkoff.ru/">  FinTech</a>.            .</p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/303580/">https://habr.com/ru/post/303580/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303566/index.html">When software communicates with us, should they be friendly</a></li>
<li><a href="../303572/index.html">We write an extension for PHP (7.0.7) without knowledge of C / C ++ and how it works in general</a></li>
<li><a href="../303574/index.html">Implementing demons on Node.js</a></li>
<li><a href="../303576/index.html">Unique data center Finger Lakes Technologies Group inside the nuclear storage</a></li>
<li><a href="../303578/index.html">Creating a blog on symfony 2.8 lts [Part 6]</a></li>
<li><a href="../303582/index.html">C--. First meeting</a></li>
<li><a href="../303584/index.html">Experience in automating server REST API testing with Jmeter</a></li>
<li><a href="../303590/index.html">Comparing D and Go performance for web</a></li>
<li><a href="../303594/index.html">Using lambda as local functions</a></li>
<li><a href="../303600/index.html">Emacs as a code editor for Python and Golang</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>