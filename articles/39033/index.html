<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write extensions for PHP to C (C)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A modern PHP developer may need this knowledge to expand consciousness, rather than a direct guide to action, but despite the fact that almost everyth...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write extensions for PHP to C (C)</h1><div class="post__text post__text-html js-mediator-article">  A modern PHP developer may need this knowledge to expand consciousness, rather than a direct guide to action, but despite the fact that almost everything you need is already built into PHP, and in various PEAR and PECL repositories you can find a package of add-ons for every taste, I think many will interesting, and some useful to know how and what works inside PHP. <br><br>  And since Zend provided us with such convenient tools, why not use them?  For example, to optimize some processes, conceal one's own when in commercial applications and embed a license mechanism, implement multithreading, or for something else ... <br><br><a name="habracut"></a><br>  There are two options for extensions: build PHP with our code or dynamically loadable modules.  Both options differ only in one line - the presence of the macro ZEND_GET_MODULE in the last one.  There is no particular difference between them, but in the process of developing and further supporting the application it is much more convenient to work with individual modules. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <br><h3>  Hello world </h3><br>  Let's look at a slightly modified for simplicity example from the official documentation. <br>  All that our first program does is return ‚Äú1‚Äù, and gives us an idea of <br>  standard extension structure.  In essence, this minimal set of macros and APIs is a skeleton that will work in most cases. <br><br><pre> #include "php.h"

 / * declaration of functions to be exported * /
 ZEND_FUNCTION (my_function);

 / * compiled function list so that Zend knows what's in this module * /
 zend_function_entry firstmod_functions [] =
 {
	 ZEND_FE (my_function, NULL)
	 {NULL, NULL, NULL}
 };

 / * compiled module information * /
 zend_module_entry firstmod_module_entry =
 {
	 STANDARD_MODULE_HEADER,
	 "First Module",
	 firstmod_functions,
	 Null
	 Null
	 Null
	 Null
	 Null
	 NO_VERSION_YET,
	 STANDARD_MODULE_PROPERTIES
 };

 ZEND_GET_MODULE (firstmod)

 / * implement the function to make it available to PHP * /
 ZEND_FUNCTION (my_function)
 {
	 RETURN_LONG (1);
 }
</pre><br><br><h3>  Compilation </h3><br><pre> cc -fpic -Wall -I / opt / php-5.2.6 / include / php / Zend -I / opt / php-5.2.6 / include / php / main 
 -I / opt / php-5.2.6 / include / php / TSRM -I / opt / php-5.2.6 / include / php -c -o test.o test.c

 cc -shared -rdynamic -Wall -O3 -o test.so test.o
</pre><br>  To make it clear where everything comes from, I have shown the full paths to the header files. <br>  But if you are going to work on a large project, then you should pay attention to <br>  Recommended and pre-installed tools, and use the ext_skel utility. <br>  (php-dist / ext / ext_skel --extname = mymod), which will generate a directory with configs for the new <br>  module.  Here we will not consider this in detail, there is no global difference, but for understanding <br>  manual assembly is more convenient. <br><br>  Now copy test.so to 'extension_dir'.  <i>extension_dir we must either write in php.ini,</i> <i><br></i>  <i>or use the existing one.</i>  <i>It all depends on the previous setting of your system.</i> <br><br>  Immediately after this, our module is ready for work; all that remains is to load it into a PHP script. <br>  Create test.php <br><br><pre> &lt;? php
	
	 dl ("test.so");  // Load our module
	 $ return = my_function (); 
	 print ("We got '$ return'");

 ?&gt;
</pre><br><br><h3>  Getting, processing arguments and returning results. </h3><br>  First, let's write a module that will take three arguments and just output them. <br>  <i>The title remains the same, changing only my_function</i> <br><pre> ZEND_FUNCTION (my_function)
 {
     char * str;  int str_len;
     long l;
     zval * array_arg;
     zval ** tmp;
     HashTable * target;
     HashPosition pos;
	
     if (ZEND_NUM_ARGS ()! = 3) WRONG_PARAM_COUNT;	
	
     if (zend_parse_parameters (ZEND_NUM_ARGS () TSRMLS_CC, "zsl", 
         &amp; array_arg, &amp; str, &amp; str_len, &amp; l) == FAILURE) {
         return;
     }
     / *
         z - zval *
         s - string, char *, int - note 
                 that the pointer is followed by an int variable,
                 which is written in length.  [..., &amp; str, &amp; str_len, ...] Do not forget
                 this, if you are going to use string in their understanding.
         l - Long, long
		
         list of other types and codes available in this function
         b - boolean, zend_bool
         d - double, double
         r - resource, zval *
         a - array, zval *
         o - object, zval *
     * /
	
     / * Processing array * /
     target = Z_ARRVAL_P (array_arg);
     if (! target) {
         php_error_docref (NULL TSRMLS_CC, E_WARNING, 
                                     "The argument 'array_arg' should be an array");
         RETURN_FALSE;
     }
	
     zend_hash_internal_pointer_reset_ex (target, &amp; pos);
	
     zend_printf ("Array size:% d &lt;br&gt; \ r \ n", zend_hash_num_elements (target));
	
     while (zend_hash_get_current_data_ex (target, (void **) &amp; tmp, &amp; pos) == SUCCESS) {
         convert_to_string (* tmp);
         zend_printf ("% s &lt;br&gt; \ r \ n", Z_STRVAL_PP (tmp));
         zend_hash_move_forward_ex (target, &amp; pos);
     }
	
     / * It's much easier with ordinary variables * /
     zend_printf ("% s &lt;br&gt; \ r \ n", str);
     zend_printf ("% ld &lt;br&gt; \ r \ n", l);
    
     RETURN_LONG (1);

 }
</pre><br><br>  Here I would like to focus on a few points.  Since there are no variable types in PHP <br>  form, which C understands them, and they can contain anything, then you need to determine for yourself <br>  where to prepare the transmitted data. <br>  This can be done in a PHP script, and given to a function, as is done in the example or <br>  check everything in the module, in this case everything is transmitted as ‚Äúz‚Äù.  Doing it in two places can <br>  be right, but not very reasonable, but we strive for optimization. <br><br>  And if the arguments passed for us are processed by zend_parse_parameters, then with arrays <br>  have to do it yourself. <br>  - in the example, all elements of the array are applied <br><pre>     convert_to_string (* tmp);
     Z_STRVAL_PP (tmp);
</pre><br>  in this case it fits - we just need to print it. <br><br>  We will leave to your discretion the processing and pre-preparation of arguments in PHP, who knows how, <br>  that‚Äôs what Zend does, Zend API offers us a wonderful set of macros, it can look like, <br>  for example: <br><br><pre> while (zend_hash_get_current_data_ex (target, (void **) &amp; tmp, &amp; pos) == SUCCESS) {
	 switch (Z_TYPE_PP (tmp)) {
		 case IS_NULL:
			 php_printf ("NULL &lt;br&gt;");
			 break;
		 case IS_BOOL:
			 convert_to_boolean (* tmp);
			 php_printf ("Boolean:% s &lt;br&gt;", Z_LVAL_PP (tmp)? "TRUE": "FALSE");
			 break;
		 case IS_LONG:
			 convert_to_long (* tmp);
			 php_printf ("Long:% ld &lt;br&gt;", Z_LVAL_PP (tmp));
			 break;
		 case IS_DOUBLE:
			 convert_to_double (* tmp);
			 php_printf ("Double:% f &lt;br&gt;", Z_DVAL_PP (tmp));
			 break;
		 case IS_STRING:
			 convert_to_string (* tmp);
			 php_printf ("String:% s, len (% d) &lt;br&gt;", Z_STRVAL_PP (tmp), Z_STRLEN_PP (tmp));
			 break;
		 case IS_RESOURCE:
			 php_printf ("Resource &lt;br&gt;");
			 break;
		 case IS_ARRAY:
			 php_printf ("Array &lt;br&gt;");
			 break;
		 case IS_OBJECT:
			 php_printf ("Object &lt;br&gt;");
			 break;
		 default:
			 php_printf ("Unknown &lt;br&gt;");
	 }
	 zend_hash_move_forward_ex (target, &amp; pos);
 }

</pre><br><br><h3>  We return the result </h3><br>  Now let's talk a little about what and how you can return from our program. <br>  As expected, all types except arrays are returned with little effort from ours. <br>  parties: <br><pre>     RETURN_BOOL (bool)
     RETURN_NULL ()
     RETURN_LONG (long)
     RETURN_DOUBLE (double)
     RETURN_STRING (string, duplicate)
     RETURN_EMPTY_STRING ()
     RETURN_FALSE
     RETURN_TRUE
</pre><br>  <i>(Full list of macros can be found in the official documentation)</i> <br><br>  For arrays, there is a specific procedure for the actions we need to perform: <br><br>  array_init (return_value) - initialize the array <br>  then we add elements to it in the following ways. <br><br>  add_next_index_ * for an index array <br>  or <br><br>  add_index_ * for index array by key <br>  or <br><br>  add_assoc_ * for an associative array by key <br><br>  * this <pre>  bool, long, string, null, zval, double </pre><br><br>  Here is a small example of how to return an array whose elements are other <br>  arrays containing in turn the result of a SELECT. <br><br><pre>	 array_init (return_value);  / * Initialize the main array * /
	
	 rcnt = PQntuples (result);  / * Number of lines (postgresql api) * /
	 fcnt = PQnfields (result);  / * Number of columns (postgresql api) * /
	 for (i = 0; i &lt;rcnt; i ++) {	
		 MAKE_STD_ZVAL (row);  / * Create a zval container for the future array * /
                 / * Initialize the second array in which the data will be stored * /
		 array_init (row);	
		 for (x = 0; x &lt;fcnt; x ++) 
			 add_index_stringl (row, x, (char *) PQgetvalue (result, i, x), 
                                                  strlen ((char *) PQgetvalue (result, i, x)), 1);

		 / * Add row as an element of the return_value array * /	
		 add_index_zval (return_value, i, row);	
	 }

</pre><br><br><h3>  Multithreading ...? </h3><br>  In the official documentation, I did not find any information regarding the features. <br>  using program threads when writing PHP extensions so that you can do <br>  the conclusion is that they work like any other library included in our code.  Not this way <br>  long time ago there was a link to an article about multithreading using PHP itself.  In my opinion, <br>  if you have already decided on such a step, it is better to use pthread and modules written in C. <br>  Let's check that it all works.  We will write a small tcp server that simultaneously <br>  will open 3 incoming ports.  Thus, we will be able to make sure that everything works correctly by simply running netstat -ln or opening 3 connections simultaneously. <br><br>  The title is left the same (as in the first example), we change only my_func and add the function <br>  thr. <br><br><pre> void * thr (void * ptr)
 {
         struct sockaddr_in cliaddr, servaddr;
         int servsock, sock, on, Port = -1, i = 0;
         socklen_t clilen;
         char p, line [128];
        
         pthread_detach (pthread_self ());

         if ((servsock = socket (AF_INET, SOCK_STREAM, 0)) &lt;0) {
                 zend_printf ("can't create servsocket &lt;br&gt; \ n");
                 return (0);
         }
         if (setsockopt (servsock, SOL_SOCKET, SO_REUSEADDR, (char *) &amp; on, sizeof (on)) &lt;0) {
                 zend_printf ("SO_REUSEADDR error &lt;br&gt; \ n");
                 return (0);
         }
        
         Port = * ((int *) ptr);
         free (ptr);
        
         servaddr.sin_family = AF_INET;
         servaddr.sin_port = htons (Port);
         servaddr.sin_addr.s_addr = htonl (INADDR_ANY);

         if (bind (servsock, (struct sockaddr *) &amp; servaddr, sizeof (servaddr)) &lt;0) {
                 zend_printf ("can't bind socket &lt;br&gt; \ n");
                 return (0);
         }
         listen (servsock, 5);
         clilen = sizeof (cliaddr);	
        
         while (1) {
                 sock = accept (servsock, (struct sockaddr *) &amp; cliaddr, &amp; clilen);
                 if (sock &lt;0) {
                         zend_printf ("[-] accept error &lt;br&gt; \ n");
                         return (0);
                 }
                 zend_printf ("[+]% s: connected &lt;br&gt; \ n", inet_ntoa (cliaddr.sin_addr));
                
                 memset (&amp; line, 0x00, sizeof (line));
                                
                 while (read (sock, (char *) &amp; p, 1)&gt; 0) {/ * Do not do this!  Here it is 
                                                           just for simplicity code.  * /
                         if (i&gt; = 127) {
                                 memset (&amp; line, 0x00, sizeof (line));
                                 i = 0;
                         }
                         if (p == '\ n') {
                                 line [i] = '\ 0';
                                 zend_printf ("port [% d] line:% s &lt;br&gt; \ r \ n", Port, line);
                                 memset (&amp; line, 0x00, sizeof (line));
                                 i = 0;
                         }
                         line [i] = p;
                         i ++;
                 }

         }
        
         return (0);
 }


 ZEND_FUNCTION (my_function)
 {
        
         pthread_t tid;
         int * port_arg;
         int i = 0;
        
         for (i = 1; i &lt;4; i ++) {
                 port_arg = (int *) malloc (sizeof (int));
                 * port_arg = 1024 + i;
                
                 if (pthread_create (&amp; tid, NULL, &amp; thr, (void *) port_arg)! = 0) {
                         zend_printf ("thread creating error &lt;br&gt; \ n");
                         RETURN_LONG (-1);
                 }
                 zend_printf ("Thread [% d] created, port_arg =% d &lt;br&gt; \ r \ n", i, * port_arg);
         }
        
         sleep (30);  / * 
                         After 30 seconds, all our processes will die.
                      * /
         zend_printf ("done &lt;br&gt; \ n");		
        
         RETURN_LONG (1);
 }
</pre><br><br>  We change our test.php a bit <br><pre> &lt;? php

   dl ("test.so"); 

   ob_implicit_flush (true);
   ob_end_flush ();

 
   my_function ();
  
   return;      
 ?&gt;
</pre><br><br><h3>  Additional Information </h3><br>  <a href="http://ru.php.net/manual/ru/internals2.ze1.zendapi.php">Official documentation</a> <br>  <a href="http://devzone.zend.com/public/view/tag/Extension">Extensions articles in Sehnde</a> <br>  I also highly recommend that you familiarize yourself with the source code of the extensions included in <br>  PHP distribution, especially with ext / standart folder. <br></div><p>Source: <a href="https://habr.com/ru/post/39033/">https://habr.com/ru/post/39033/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../39032/index.html">September 8 let go free ...</a></li>
<li><a href="../390321/index.html">From people to machines: the robotic revolution in China</a></li>
<li><a href="../390323/index.html">On Safe Internet Day, Google distributes 2 GB per security check</a></li>
<li><a href="../390325/index.html">Backup power supply with sine output. Part 2. Development of electrical concepts</a></li>
<li><a href="../390327/index.html">Another way to determine the quality of air on the Arduino - with the transfer of data to the network</a></li>
<li><a href="../390331/index.html">Tablet on windows 10 - a review of the powerful tablet Chuwi Hi10 for $ 180</a></li>
<li><a href="../390333/index.html">Official Press Conference on Gravitational Wave Detectors: Answers to All Your Questions This Thursday</a></li>
<li><a href="../390337/index.html">Video review laptop Asus G752VT</a></li>
<li><a href="../390339/index.html">Video review 3D-printer Wanhao Duplicator i3 v2</a></li>
<li><a href="../39034/index.html">Interesting PHP language features</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>