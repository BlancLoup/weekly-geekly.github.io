<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Part 3/3. Ideal VM compiler for ICFPC 2009, on Haskell, with popularizing comments</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ending. Previous parts: 1 and 2 

 What is left? We missed a place where two adjacent opcodes turn into one. What did we have? According to the specif...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Part 3/3. Ideal VM compiler for ICFPC 2009, on Haskell, with popularizing comments</h1><div class="post__text post__text-html js-mediator-article"> Ending.  Previous parts: <a href="http://san13.habrahabr.ru/blog/68995/">1</a> and <a href="http://san13.habrahabr.ru/blog/70179/">2</a> <br><br>  What is left?  We missed a place where two adjacent opcodes turn into one.  What did we have?  According to the specification, the following operations took place: <br><br> <code>flag = m20 &gt; 0 <br> if (flag) m222 = m3 else m222 = m4 <br></code> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Exploring binary files for how these constructs are used, we realized that they walk in a pair of Cmp, then Phi.  Surely, because it was compiled by the organizers from some of their original formulas and with some compiler.  Well, if so, then we glue them a little together in one operation: <br><br><blockquote> <code><font color="#0000ff">-- convert 2-op conditional operator to 1-op</font> &lt;br&gt; <br> removePhi [] <font color="#a52a2a"><b>=</b></font> []&lt;br&gt; <br> removePhi ((Cmpz cond condr1) <font color="#a52a2a"><b>:</b></font> (Phi addr r1 r2) <font color="#a52a2a"><b>:</b></font> xs) <font color="#a52a2a"><b>=</b></font> &lt;br&gt; <br> Noop addr <font color="#a52a2a"><b>:</b></font> If cond condr1 addr r1 r2 <font color="#a52a2a"><b>:</b></font> removePhi xs&lt;br&gt; <br> removePhi (x <font color="#a52a2a"><b>:</b></font> xs) <font color="#a52a2a"><b>=</b></font> x <font color="#a52a2a"><b>:</b></font> removePhi xs&lt;br&gt; <br></code> </blockquote><a name="habracut"></a>  Here the list is handled as follows: the input of the function is a list of opcodes, the output is a list in which this pair [Cmp, Phi] is replaced by [Noop, If].  Noop is inserted in order to leave the addresses of all commands unchanged (i.e. so that their number and position does not change, because their position in memory is one of their operands). <br><br>  Here, we define that for an empty list and do nothing.  For the list starting with our two required teams, we replace them with two new teams, and then process the rest of the list.  And if the list starts with everything else (which corresponds to the third line, the rest is given the name "x"), then we leave this rest unchanged, and process the rest of the list "xs". <br><br>  Now the main part of the program.  Haskell Entry Point - main function <br><br><blockquote> <code>main <font color="#a52a2a"><b>=</b></font> <font color="#a52a2a"><b>do</b></font> &lt;br&gt; <br> (len,buf) <font color="#a52a2a"><b>&lt;-</b></font> readMyFile&lt;br&gt; <br></code> </blockquote><br>  This is the file we read (see above) <br><blockquote> <code><font color="#a52a2a"><b>let</b></font> nframes <font color="#a52a2a"><b>=</b></font> fromInteger <font color="#a52a2a"><b>$</b></font> len <font color="#a52a2a"><b>`div`</b></font> <font color="#ff00ff">12</font> <font color="#0000ff">--      .</font> &lt;br&gt; <br> <font color="#0000ff">-- opcode/data memory in tuples</font> &lt;br&gt; <br> ids <font color="#a52a2a"><b>&lt;-</b></font> mapM ( <font color="#a52a2a"><b>\</b></font> i <font color="#a52a2a"><b>-&gt;</b></font> instruction (plusPtr buf <font color="#a52a2a"><b>$</b></font> i <font color="#a52a2a"><b>*</b></font> <font color="#ff00ff">12</font> ) i) [ <font color="#ff00ff">0</font> <font color="#a52a2a"><b>..</b></font> nframes <font color="#a52a2a"><b>-</b></font> <font color="#ff00ff">1</font> ]&lt;br&gt; <br></code> </blockquote>  Here, every i (from 0 to nframes-1) was put on the result - a pair (instructon, data), which was obtained by adding the corresponding offset (i * 12) to the pointer (buf) and interpreting the command at this address (call instruction with where it lies with the instruction number, for even-odd sampling). <br><br><blockquote> <code><font color="#0000ff">-- code AST</font> &lt;br&gt; <br> <font color="#a52a2a"><b>let</b></font> code <font color="#a52a2a"><b>=</b></font> removePhi <font color="#a52a2a"><b>$</b></font> map disasm <font color="#a52a2a"><b>$</b></font> zip (map fst ids) [ <font color="#a52a2a"><b>O..</b></font> ]&lt;br&gt; <br></code> </blockquote>  Now we (read to the right), took from the list of pairs (ids) all (map) first (fst) elements (only instructions), made pairs (zip) with numbers from zero to as many as necessary ([0 ..] ), then for all these pairs (instruction, address) missed (map) via disasm, got a list of Op-s, and then removed Phi from them, making If instead of it (using removePhi). <br><br><blockquote> <code>-- print code&lt;br&gt; <br> putStrLn $ produceCode code (map snd ids)&lt;br&gt; <br></code> </blockquote>  Further, having code and data (via map snd ids - take the second halves of the pairs "(instruction, data)", they called produceCode with two parameters and printed the result (putStrLn). <br><br><blockquote> <code>free buf <br></code> </blockquote>  And this line just does not need comments. <br><br>  Conclusion <br><br>  This ‚Äúcompiler‚Äù is written at the level of a novice haskelist, of course.  But even at this level, I became noticeably different from Java, where I write every day at work. <br><br>  First of all, the absence of any ‚Äúutility functions‚Äù and classes required in java for the implementation of all sorts of patterns there that would surely be used by any faithful javist. <br><br>  Secondly, the distribution of time.  I spent a large chunk of time researching work with Ptr - because I chose this method of converting 8 bytes to Double, and I didn‚Äôt do it before.  Then, about two-thirds of the time was spent writing exactly the decoding of the file, the creation of the AST and its basic serialization into Haskell code (linear).  And only a third of the time I actually spent on the algorithm for converting flat opcodes into a tree-like AST, and the algorithm turned out by itself. <br><br>  In short, I experienced a feeling of deep satisfaction.  Sorry, there was no time for the IFCPC. </div><p>Source: <a href="https://habr.com/ru/post/70185/">https://habr.com/ru/post/70185/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../70173/index.html">Doctrine integration in kohana 3</a></li>
<li><a href="../70174/index.html">simple editor bb codes</a></li>
<li><a href="../70176/index.html">What to wish before the death penalty</a></li>
<li><a href="../70179/index.html">Part 2/3. Ideal VM compiler for ICFPC 2009, on Haskell, with popularizing comments</a></li>
<li><a href="../70181/index.html">Check of equality, inequality, identity of nodes in XPath</a></li>
<li><a href="../70186/index.html">Singed netbook as a work of art</a></li>
<li><a href="../70188/index.html">Plugin for WordPress. Making LaTex image formulas using the Google API</a></li>
<li><a href="../70189/index.html">The study of site design portfolio - patterns and modern practice</a></li>
<li><a href="../70190/index.html">IE7 vs. DXTransform or How bugs become features</a></li>
<li><a href="../70191/index.html">Hrenus - Irc bot in PHP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>