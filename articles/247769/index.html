<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How Bitrix didn‚Äôt ruin the New Year</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We lived in a small fun web-studio, did business cards, online stores and small portals. There were projects on the 1C-Bitrix platform. We, of course,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How Bitrix didn‚Äôt ruin the New Year</h1><div class="post__text post__text-html js-mediator-article">  We lived in a small fun web-studio, did business cards, online stores and small portals.  There were projects on the 1C-Bitrix platform.  We, of course, were not the official integrator of Bitrix, but we did workable projects as far as strength and experience allowed.  It would seem that we only had to use some components, but this miracle of domestic brains managed to make a surprise for the new year. <br><a name="habracut"></a><br>  Received us a new order - online store.  By the way, we also had online stores, they worked on our CMS, based on the Codeigniter framework.  Worked quite well, quite quickly.  But time took its toll, Laravel4 came out (as everything is simple and wonderful), Yii2 (finally stable), Phalcon (C is very fast) and finally using the deceased CI (somebody take me home) did not have more strength.  Having exchanged glances with the assistant, we immediately realized that I did not want to create a new order on the old system.  There were thoughts to rewrite the successful solutions of the online store on Yii2, we looked in the direction of Open Cart, CS Cart and PrestaShop, but the customer put the end to the question - 1C Bitrix (edited by Business).  Bright hopes neatly laid the soap and rope in a suitcase and set off home.  On the other hand, not everything is so bad, I thought.  We will have a set of ready-made high-quality solutions (the key word is ready-made, as the customer was warned about), all that remains is to implement the layout.  And after a couple of days the work began to boil. <br><br>  "Hooray!  It was loaded and installed! ‚ÄùI exclaimed, finishing up the cup of tea lost in the bill.  ‚ÄúDamn it, what a bunch of files ?!‚Äù, thought git and thought. <br><br>  As a basis, I took an online clothing store, which can be installed with Bitrix. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We sit with a friend in the office, we pull on minor components and suddenly we get the first prize from Beatrix.  This system has the ability to merge and compress css and js files connected in the correct way.  ‚ÄúWhere I screwed up‚Äù - the first soap that came to my head when jquery stopped connecting.  Convulsively press Ctrl + Z, canceling the written code, but nothing helps.  Unthinkable options go into battle, but they also do not bring success.  Chaos in the head.  I leave to drink tea.  While I was gone, Bitrix solemnly begged to return, saying that he would forgive everything and earned it.  When I launched the site again, the static build was in perfect order.  Magic, I thought, and wanted to forget about it already, as my comrade, who was sitting a few meters away from me, stumbles upon the same bug.  Googling ruled that people face this, but there is no solution. <br><br>  As in my case, after some time the static on the site was fixed by itself.  By the way, this bug we have emerged even once in the development process.  The essence of this bug, apparently, lies in the fact that, for an unspecified reason, the order of js files when merged is confused or some necessary js files do not fall into the union. <br><br>  Who cares, the head part looked like this: <br><div class="spoiler">  <b class="spoiler_title">head</b> <div class="spoiler_text"><pre><code class="php">&lt;head&gt;
		&lt;meta charset="utf-8"/&gt;
        &lt;?
        $APPLICATION-&gt;ShowMeta("robots", false, true);
        $APPLICATION-&gt;ShowMeta("keywords", false, true);
        $APPLICATION-&gt;ShowMeta("description", false, true);
        ?&gt;
		&lt;link rel="shortcut icon" type="image/x-icon" href="&lt;?= SITE_DIR ?&gt;/favicon.ico"/&gt;
		&lt;link rel="stylesheet"
			  type="text/css"
			  href="&lt;?= CUtil::GetAdditionalFileURL('http://fonts.googleapis.com/css?family=PT+Sans:400,700,400italic,700italic&amp;subset=latin,cyrillic'
			  ) ?&gt;"/&gt;
		&lt;link rel="stylesheet"
			  type="text/css"
			  href="&lt;?= CUtil::GetAdditionalFileURL('http://fonts.googleapis.com/css?family=Noto+Sans&amp;subset=latin,cyrillic'
			  ) ?&gt;"/&gt;
		&lt;link rel="stylesheet"
			  type="text/css"
			  href="&lt;?= CUtil::GetAdditionalFileURL('http://fonts.googleapis.com/css?family=Roboto+Slab:400,300,700&amp;subset=latin,cyrillic'
			  ) ?&gt;"/&gt;
		&lt;?
		$APPLICATION-&gt;ShowCSS(true, true);
		?&gt;
		&lt;link rel="stylesheet"
			  type="text/css"
			  href="&lt;?= CUtil::GetAdditionalFileURL(SITE_TEMPLATE_PATH . "/css/jquery.formstyler.css") ?&gt;"/&gt;
		&lt;link rel="stylesheet"
			  type="text/css"
			  href="&lt;?= CUtil::GetAdditionalFileURL(SITE_TEMPLATE_PATH . "/css/jquery.nouislider.css") ?&gt;"/&gt;
		&lt;link rel="stylesheet"
			  type="text/css"
			  href="&lt;?= CUtil::GetAdditionalFileURL(SITE_TEMPLATE_PATH . "/css/jquery.ad-gallery.css") ?&gt;"/&gt;
        &lt;link rel="stylesheet"
              type="text/css"
              href="&lt;?= CUtil::GetAdditionalFileURL(SITE_TEMPLATE_PATH . "/css/keyboard.css") ?&gt;"/&gt;

        &lt;?$APPLICATION-&gt;AddHeadScript(SITE_TEMPLATE_PATH."/js/jquery-1.11.1.min.js");?&gt;
        &lt;?$APPLICATION-&gt;AddHeadScript(SITE_TEMPLATE_PATH."/functions.js");?&gt;

		&lt;?
		$APPLICATION-&gt;ShowHeadStrings();
		$APPLICATION-&gt;ShowHeadScripts();
		?&gt;

        &lt;!--[if lt IE 9]&gt;
        &lt;script src="http://html5shim.googlecode.com/svn/trunk/html5.js"&gt;&lt;/script&gt;
        &lt;![endif]--&gt;

		&lt;title&gt;&lt;? $APPLICATION-&gt;ShowTitle() ?&gt;&lt;/title&gt;
	&lt;/head&gt;
</code></pre><br>
</div></div><br>
      ,      . <br>
<br>
    ,  .        .    (#SITE_DIR#/catalog/#SECTION_CODE#/).  ,     #SITE_DIR#/catalog/           .     /catalog/index.php     . ¬´  ¬ª ‚Äì  ,      30 .   .      .   ajax          ,        .    :<br>
<br>
<pre><code class="php">if($_REQUEST['ajax']=='Y')
</code></pre><br>
   ,    ,    $_REQUEST[‚Äòajax‚Äô]   NOTICE,  -    .    isset  .<br>
<br>
<pre><code class="php">if(isset($_REQUEST['ajax']) &amp;&amp; $_REQUEST['ajax']=='Y')
</code></pre><br>
    ,       .  ,  ,    ,        ,    ,       -  .    ‚Äî       .            ,   -     ,           .      ,  ,      (      )      <s></s>,      .         js  \bitrix\components\bitrix\catalog.element\templates\.default\script.js, 2839   ,     result_modifier.php     ,   js      . <br>
<br>
         ,         ¬´    - ¬ª.           .   jquery, ,  1    BX.js,     .      200 . <br>
<br>
 ,   -          .       ,     -  ,    .     , ,    1000 mA    ¬´ ¬ª   :         ?       ,      ,         .    . ,               .  ,    ,       . <br>
<br>
 ,       ,        -  ,           ajax ,           .    ,    ,                .   ‚Äú‚Äù          . <br>
<br>
       .          -  .      CSaleBasket::Add, ,    ,     .   ,  . <br>
<br>
,        ,         .       ¬´¬ª.   .        Update     .     .<br>
<br>
<pre><code class="php">$code = Add2BasketByProductID($productID, $QUANTITY, $arRewriteFields, $product_properties);

if (!$code) {
    $response['status'] = 400;
    $response['message'] = '     ';
} else {
    $response['basket'] = getActualSmallBasket();

    /*fix     sku  */
    if (is_array($productProperties)) {
        $arFields["PROPS"] = $productProperties;
        CSaleBasket::Update($code, $arFields);
     }
}
</code></pre><br>
      .  ,   ,      .   ,   ,   .   ,     (bitrix:search.page),    ,   arResult  .            ,    .         arResult[‚ÄòPARAM2‚Äô],    id   ,       ,    ITEM_ID    S,     .        arResult,    ,  -   .      ,    <a href="http://toster.ru/q/154487"></a>.  ,    . <br>
<br>
  .   ,    -,   ajax      . Ajax       .      ¬´ ¬ª. ,    ,     -.           .        PAGEN_1, PAGEN_2.         ,     .         .             ,       ,   ajax      .      .        ,        . <br>
<br>
     .      .  ,      ,        . - ,      ,        ,    .                    .     ¬´¬ª .   :             ‚Äì    .        .      .             .   ,     : ,        .   ,    .  OnAfterIBlockElementAdd      .    :<br>
<br>
<pre><code class="php">/*       */
AddEventHandler("catalog", "OnPriceUpdate", Array("DiEvent", "OnPriceUpdateHandler"));
AddEventHandler("catalog", "OnPriceAdd", Array("DiEvent", "OnPriceAddHandler"));

/*       */
AddEventHandler("catalog", "OnProductAdd", Array("DiEvent", "OnProductAddHandler"));
AddEventHandler("iblock", "OnAfterIBlockElementUpdate", Array("DiEvent", "OnProductUpdateHandler"));

/**
     *        
     *
     * @param $id
     * @param $arFields
     */
    function OnPriceUpdateHandler($id, $arFields) {
        self::updateFilterPrice($arFields['PRODUCT_ID']);
    }

    /**
     *        
     *
     * @param $id
     * @param $arFields
     */
    function OnPriceAddHandler($id, $arFields) {
        self::updateFilterPrice($arFields['PRODUCT_ID']);
    }

    /**
     *        
     *
     * @param $id
     * @param $arFields
     */
    function OnProductAddHandler($id, $arFields) {
        self::updateFilterPrice($id);
    }

    /**
     *        
     * OnProductUpdate    ((
     * @param $arFields
     */
    function OnProductUpdateHandler(&amp;$arFields) {
        if ($arFields['IBLOCK_ID'] == 2) {
            self::updateFilterPrice($arFields['ID']);
        }
    }

/**
     *          
     * MIN_OFFER_PRICE, MAX_OFFER_PRICE     .
     *      BASE!      .
     *
     * @param $PRODUCT_ID id 
     */
    public static function updateFilterPrice($PRODUCT_ID) {
        $EL = new CIBlockElement();

        //    
        $arr = CIBlockPriceTools::GetOffersArray(
            array('IBLOCK_ID' =&gt; 2),
            array($PRODUCT_ID),
            array(),
            array(),
            array(),
            0,
            CIBlockPriceTools::GetCatalogPrices(2, array('BASE'))
        );

        if (is_array($arr) &amp;&amp; count($arr) &gt; 0) {
            $minPrice = null;
            $maxPrice = 0;

            //      ,     

            foreach ($arr as $offer) {
                $offerMinPrice = $offer['MIN_PRICE']['VALUE'];

                if (is_null($minPrice)) {
                    $minPrice = $offerMinPrice;
                } else {
                    if ($offerMinPrice &lt; $minPrice) {
                        $minPrice = $offerMinPrice;
                    }
                }

                if ($offerMinPrice &gt; $maxPrice) {
                    $maxPrice = $offerMinPrice;
                }
            }

            //   MIN_OFFER_PRICE, MAX_OFFER_PRICE
            $EL-&gt;SetPropertyValuesEx($PRODUCT_ID, 2,
                                     array('MIN_OFFER_PRICE'=&gt;$minPrice,
                                           'MAX_OFFER_PRICE'=&gt;$maxPrice,)
            );
        } else {
            //   
            $priceType = CIBlockPriceTools::GetCatalogPrices(2, array('BASE'));
            $cgroup = $priceType['BASE']['SELECT'];

            //       !
            $result = $EL-&gt;GetList(array(), array('IBLOCK_ID'=&gt;2, 'ID'=&gt;$PRODUCT_ID), false, false, array('*', $cgroup));
            $arrElm = $result-&gt;GetNextElement();

            if (is_object($arrElm)) {
                $fields = $arrElm-&gt;GetFields();

                //   
                $price = CIBlockPriceTools::GetItemPrices(2, $priceType, $fields);

                //   MIN_OFFER_PRICE, MAX_OFFER_PRICE
                $EL-&gt;SetPropertyValuesEx($PRODUCT_ID, 2,
                                         array('MIN_OFFER_PRICE'=&gt;$price['BASE']['VALUE'],
                                               'MAX_OFFER_PRICE'=&gt;$price['BASE']['VALUE'],)
                );
            }
        }
    }
</code></pre><br>
           (sale.order.full).    , ,  EDOST  , ,        .           .     <a href="http://dev.1c-bitrix.ru/community/forums/forum6/topic61662/"></a>      .     . <br>
<br>
    .     ,   .         ,      ,    ,   ‚Äì              ,  N .  ,   1C   ,      .     .      ,       .     ,   .       ,    .       ,   ,    .  ,   ,       .   :   ,    ,    ,      .     ,  ,    . <br>
<br>
    , , ,    ,  ,     ,        .     -   30   ,     31,        .     ¬´¬ª          .</div><p>Source: <a href="https://habr.com/ru/post/247769/">https://habr.com/ru/post/247769/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../247757/index.html">How to promote your business in 2015 with maximum efficiency? 10 marketing predictions you should know about</a></li>
<li><a href="../247759/index.html">Development vs. Testing, or where to go graduate FVT</a></li>
<li><a href="../247761/index.html">How to promote your business in 2015 with maximum efficiency? 10 marketing predictions that you should know about! (part 2)</a></li>
<li><a href="../247763/index.html">What lessons did I learn from the not very successful f2p socials</a></li>
<li><a href="../247765/index.html">Types and functions</a></li>
<li><a href="../247771/index.html">How to get a lot of street wifi? Experience in building OpenDoor networks with high subscriber density</a></li>
<li><a href="../247773/index.html">Bovanenkovo ‚Äã‚Äã- the organization of communication in the gas field No. 3 in Russia from the BS on permafrost</a></li>
<li><a href="../247775/index.html">Subject-oriented design in PHP</a></li>
<li><a href="../247779/index.html">How I stopped worrying and loved Hyper-V replication</a></li>
<li><a href="../247781/index.html">Mikrotik - Open and check cooling</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>