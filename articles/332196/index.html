<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to organize secure access using VPN</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Who needs VPN? 


 As of March 2017, the share of vacancies on work with remote access posted on hh.ru was 1.5% or 13,339 vacancies. During the year t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to organize secure access using VPN</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/4e3/817/9c0/4e38179c0dff4802a7046693544d3bd0.jpeg"><br><p><br></p><br><h1 id="komu-nuzhen-vpn">  Who needs VPN? </h1><br><p>  As of March 2017, the share of vacancies on work with remote access posted on hh.ru was 1.5% or 13,339 vacancies.  During the year their number <a href="http://www.rbc.ru/newspaper/2017/03/13/58c27cf89a79473a18a8f7df">doubled</a> .  In 2014, the number of remote employees was estimated at 600 thousand people or 1% of the economically active population (15‚Äì69 years).  J'son &amp; Partners Consulting <a href="https://vc.ru/p/solarstaff-distant-work">predicts</a> that by 2018, about 20% of all employed Russians will work remotely.  For example, by the end of 2017, Beeline plans to transfer from 50% to 70% of staff to remote cooperation. </p><br><p>  Why do companies transfer employees to the remote: </p><br><ul><li>  Reducing the cost of the company for the rental and maintenance of jobs. </li><li>  The lack of binding to one location makes it possible to assemble a team <br>  a project that could never be put together within the same city.  An additional plus is the possibility of using cheaper labor. </li><li>  Satisfying the needs of employees due to their family circumstances. </li></ul><br><p>  We discovered the need for VPN more than 10 years ago.  For us, the motivator of providing VPN access to employees was the ability to quickly access the corporate network from anywhere in the world and at any time of the day or night. </p><a name="habracut"></a><br><h1 id="put-vybora-idealnogo-vpn-resheniya">  The way to choose the perfect VPN solution </h1><br><p>  There are a lot of solutions.  Often, the decision should be made on the basis of what equipment and software is already used in the company, the skill of setting which software the system administrator has.  I'll start with what we gave up right away, and then tell you what we tried at what we eventually stopped at. </p><br><h2 id="vpn-v-routerah">  VPN in routers </h2><br><p>  There are many so-called ‚ÄúChinese solutions‚Äù on the market.  Virtually any router has the functionality of a built-in VPN server.  This is usually a simple on / off functionality and adding usernames of passwords for users, sometimes integration with the Radius server.  Why we did not begin to consider such a decision?  First of all, we think about our security and continuity of the service.  Similar glands cannot boast of any reliable protection (firmwares are usually very rarely released, or do not come out in principle), and the reliability of work leaves much to be desired. </p><br><h2 id="vpn-enterprise-klassa">  VPN Enterprise Class </h2><br><p>  If you look at the Gartner square, then the VPN market has long been a leader among companies that produce network equipment.  Juniper, Cisco, Check Point: they all have integrated solutions, which include a VPN service. </p><br><img src="https://habrastorage.org/web/511/8a7/6a2/5118a76a28bc42ecb2e6b85f5d4116ec.png"><br><p>  There are probably two disadvantages to such decisions.  First and foremost - the high cost.  Second, the speed of closing vulnerabilities leaves much to be desired, and if you do not pay annual support fees, then you should not wait for security updates.  Not so long ago, the third moment appeared - bookmarks embedded in the software of large network vendors. </p><br><h2 id="microsoft-vpn">  Microsoft VPN </h2><br><p>  10 years ago we were a company focused primarily on Windows.  Microsoft offers a free solution for those who have the entire infrastructure built on their base.  In simple cases, setting up does not cause difficulties even for a novice system administrator.  In our case, we wanted to squeeze everything out of the VPN from a security point of view; accordingly, the use of passwords was excluded.  We naturally wanted to use certificates instead of passwords and use our <a href="https://www.rutoken.ru/products/all/rutoken-ecp/">Rutoken EDS</a> product to store the key pair.  To implement the project, we needed: a domain controller, a radius server, and a properly raised and configured PKI infrastructure.  I will not dwell on the settings in detail, there is a lot of information on these issues on the Internet, and the correct setting of the PKI can generally pull a dozen articles.  The first protocol we used was PPTP.  For a long time, this VPN option suited us, but in the end we had to abandon it for two reasons: PPTP did not work everywhere and we started using not only Windows, but other operating systems as well.  Therefore, we began to look for alternatives.  I note that the support for PPTP was recently <a href="https://support.apple.com/ru-ru/HT206844">stopped by apple</a> .  To begin, we decided to see what else the protocols can offer to Microsoft.  SSTP / L2TP.  SSTP suited us all, except that it worked only on Windows.  L2TP did not have this drawback, but it seemed quite costly to set up and maintain it in our work, and we decided to try alternatives.  I wanted a simpler solution for both users and administrators. </p><br><h2 id="openvpn">  Openvpn </h2><br><p>  We at Aktiv sincerely love open source.  Choosing a replacement for Microsoft VPN, we could not ignore the OpenVPN solution.  The main advantage for us was that the out-of-the-box solution works on all platforms.  To raise the server in a simple case is quite simple.  Now, using docker and, for example, a ready <a href="https://hub.docker.com/r/kylemanna/openvpn/">image</a> , it can be done in a few minutes.  But we wanted more.  We wanted to add Microsoft CA integration to the project in order to use the certificates issued earlier.  We wanted to add support for the tokens we used.  How to configure a bunch of OpenVPN and tokens described for example here in this <a href="https://habrahabr.ru/company/aktiv-company/blog/137306/">article</a> .  It was more difficult to configure the integration of Microsoft CA and OpenVPN, but in general it is also quite realizable.  We used the resulting solution for about three years, but all the while we continued to look for more convenient options.  The main opportunity we got by going to OpenVPN was access from any OS.  But there are still two complaints: the company‚Äôs employees need to go through 7 laps of the Microsoft CA hell to issue a certificate, and the administrators still had to maintain a fairly complex VPN infrastructure. </p><br><h1 id="rutoken-vpn">  Rutoken VPN </h1><br><p>  We have knowledge of how to use tokens in any operating systems, we have an understanding of how to properly prepare the PKI infrastructure, we are able to configure different versions of OpenVPN, and we have technologies that allow you to manage all this convenient for the user from the browser window.  So the idea of ‚Äã‚Äãa new product appeared. </p><br><img src="https://habrastorage.org/web/5dd/18c/e4b/5dd18ce4b5a848a380f750aa795a8e87.jpg"><br><h2 id="nastroyka-rutoken-vpn">  Configure Rutoken VPN </h2><br><p>  We really tried to make the setting easy and understandable.  The entire setup takes only a few minutes and is implemented as an initial setup wizard.  In the first step, you need to configure the network settings of the device, I think the comments here will be superfluous. </p><br><img src="https://habrastorage.org/web/70e/fa2/051/70efa20510084a57a785c02da8827acd.JPG"><br><p><br>  In the second step, you need to enter the company name and wait a few minutes while the device configures the built-in certification authority. </p><br><img src="https://habrastorage.org/web/65b/b8d/d48/65bb8dd480de4809a9d1acb38ba80c08.png"><br><p><br></p><br><img src="https://habrastorage.org/web/773/a94/ffe/773a94ffe6a643b0a8407227860b4d93.png"><br><p><br>  The third step is to configure the VPN service itself.  Specify the external IP to connect to.  Select the type of encryption and network addressing. </p><br><img src="https://habrastorage.org/web/370/a8e/907/370a8e9073cd4ff3b7ffc4ba5bcd2264.png"><br><p><br>  The fourth step is to create local users, or add them from AD </p><br><img src="https://habrastorage.org/web/a5e/954/6ea/a5e9546ead4c4ac7a355ab3e0b7ccce1.png"><br><p><br>  At this setting can be considered complete, all other actions can be performed by the employee himself (although the administrator can do everything). </p><br><h2 id="lichnyy-kabinet-sotrudnika">  Personal account of the employee </h2><br><p>  After the administrator has added users, the employee can use the self-service portal. </p><br><img src="https://habrastorage.org/web/dfd/8a7/731/dfd8a77319de4ffbab71171abc485e76.png"><br><p><br>  Depending on the employee‚Äôs operating system and browser, you will need to install the plugin and browser extension, which are necessary for working with tokens. </p><br><img src="https://habrastorage.org/web/c07/098/491/c07098491e38485b97b9cc500ce690f7.png"><br><p><br>  After installing the plug-in / extension, we can only generate a certificate for ourselves on the Rutoken EDS. </p><br><img src="https://habrastorage.org/web/11f/c93/4f5/11fc934f578e44d6a620298f2c451b24.png"><br><p><br></p><br><img src="https://habrastorage.org/web/8f6/a08/284/8f6a082846f04b18a6b893931b9533a5.png"><br><p><br>  And install the client under the desired operating system: </p><br><img src="https://habrastorage.org/web/a59/874/314/a5987431460d451aba698062fc84d961.png"><br><p><br></p><br><h2 id="kak-vse-eto-rabotaet">  How does all this work? </h2><br><p>  A little about the hardware.  Initially, we thought for a long time what ‚Äúbase‚Äù to use for our solution, since it was necessary to keep a balance between cost, convenience, performance.  After researching what is offered on the market, we stopped at two options for the implementation and further distribution of the solution: </p><br><ul><li>  x86 (Enterprise) is a software solution that is provided to the end user in the form of an image of a virtual machine that can be deployed within its IT infrastructure. </li></ul><br><ul><li>  Raspberry Pi is already a fairly well-known microcomputer, which has quite good performance at not the highest cost and which can be started to use as a VPN server within 10 minutes after it was literally taken out of the box. </li></ul><br><p>  So now let's look at how our solution works.  Initially, I want to remind you that we have implemented two-factor authentication.  Own-produced tokens are used as carriers of client private keys and certificates, as well as software for working with them. </p><br><p>  But initially, we still need to configure the services that are required for the correct operation of the product.  The services are currently configured by the specialists of our company in a semi-automatic mode.  This means that the process of deployment of software and initial settings is automated, but the initialization of this process is still a human privilege.  During the initial configuration, the system packages, python, django, OpenVPN, supervisor, OpenSSL, etc. are installed. </p><br><p>  And what next?  Next, you need to configure the entire infrastructure, which is actually responsible for the overall security.  Namely: CA (certificate authority), PKI (public key infrastructure), write out the necessary keys and certificates. </p><br><p> The creation of PKI and CA, as well as the formation of the configuration file of the OpenVPN server, the generation of keys and the issuance of certificates is carried out after the transfer of the product to the client.  But this does not mean that for this you need to have some specific knowledge and direct access to the operating system.  Everything is implemented in the back end business logic of the administration system, access to which is provided via the Web interface.  The client is only required to enter the minimum set of attributes (described above), after which the process of initializing the PKI and creating the CA starts.  It makes no sense to describe the specific calls of the system commands, since everything has long been described and chewed up to us.  The main thing that we did was to automate this process, freeing the user from having to have specific administrative knowledge. </p><br><p>  To work with keys and certificates, we decided not to reinvent the wheel (although we really wanted and still have the idea to invent it based on our future product development plans) and use easy-rsa. </p><br><p>  The longest process in setting up the infrastructure is the generation of the Diffie-Hellman file.  We experimented with the parameters for a long time and came to the balance of "quality-performance".  Although there were thoughts to get rid of this step altogether, to generate such files in advance, using our server capacities and simply ‚Äúdistribute‚Äù them during the initial initialization.  Moreover, the data contained in this file are not private.  But so far we have left these thoughts for further ‚Äúresearch.‚Äù </p><br><p>  Next, you need to provide the end user with a mechanism for self-creation of key pairs, making requests for issuing a certificate to CA and actually receiving this certificate with a record on a token.  A client is also needed to establish a VPN connection with pre-authentication on a token. </p><br><p>  We solved the first task thanks to our plug-in that implements the functionality of electronic signature, encryption and two-factor authentication for Web and SaaS services.  In order to write out the certificate and write it to the token, the user must install this plugin, follow the link to get into the personal account of the RutokenVPN service, having previously connected the token to the computer (read more about the plugin on our <a href="https://www.rutoken.ru/products/all/rutoken-plugin/">resource</a> ) </p><br><p>  When initializing the process of issuing a certificate, a request is made for a token to generate a key pair as well as a request for a certificate to be issued to CA.  The private key is written to the token, and a certificate statement request is sent to the CA, which in turn writes it out and returns it in the response.  After that, the certificate is also written to the token. </p><br><p>  Almost everything is ready to establish a VPN connection.  There is a lack of a client who ‚Äúknows‚Äù how to work with the server and our tokens. </p><br><img src="https://habrastorage.org/web/0f5/b2f/292/0f5b2f292d7f45a1a87926ef52f139bb.jpg"><br><p><br>  Our client is implemented on Electron.  Who does not know what kind of animal, then, if very briefly - the ability to implement a desktop application using js, css and html.  Without going into details, the client is a kind of ‚Äúwrapper‚Äù over the OpenVPN client, allowing it to make calls with the necessary parameters.  Why so?  In fact, it was more convenient for us, although the chosen solution imposes certain limitations. </p><br><p>  Since we use the token as the key information carrier required for authentication when establishing a VPN session, we need to configure the OpenVPN client to work with it.  The PKCS # 11 provider is a proprietary library for working with our tokens, the path to which is specified in the settings of the OpenVPN client.  Read more about it <a href="https://www.rutoken.ru/support/download/pkcs/">here</a> . </p><br><p>  When a request is made to establish a VPN connection, the PIN code of the key is requested, if entered correctly, a certificate is extracted for client authentication, the client is handed down to the server and the VPN connection is established.  Knowledgeable people may argue that not everything is so simple, but the purpose of this description is not to tell all the subtleties of the work of OpenVPN, but only to highlight the main points of our implementation. </p><br><p>  A little about our plans.  The main thing we are working on now is the implementation of GOST-encryption.  A rather large research path has already been passed, which allowed us to come as close as possible to its implementation.  In the near future we will be able to satisfy the interest of potential customers in this functionality. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/332196/">https://habr.com/ru/post/332196/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../332186/index.html">4 popular mistakes in business card design</a></li>
<li><a href="../332188/index.html">Three days like all ticket offices in the country should become online (in fact, not)</a></li>
<li><a href="../332190/index.html">The tale of how an Android developer spammers, and that came out of it</a></li>
<li><a href="../332192/index.html">Canvas - almost like SVG</a></li>
<li><a href="../332194/index.html">ArrayBuffer and SharedArrayBuffer in JavaScript, part 3: race streams and Atomics</a></li>
<li><a href="../332198/index.html">Introduction to procedural animation: inverse kinematics</a></li>
<li><a href="../332200/index.html">VeeamON 2017: what marketers do not write in blogs</a></li>
<li><a href="../332202/index.html">About analytics and silver bullets or ‚ÄúWhat does Rambler / Top 100 have to do with it?‚Äù</a></li>
<li><a href="../332204/index.html">GitLab 9.3 released: Code Quality and inter-project pipeline schedules</a></li>
<li><a href="../332206/index.html">How to repeat anyroom.io service in several JS lines and without a backend</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>