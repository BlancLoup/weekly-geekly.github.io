<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Making the right platform or How to repeat Google</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction  Today I will talk about the design of highly-loaded fault-tolerant systems. Emphasis will be placed on practical development and fried f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Making the right platform or How to repeat Google</h1><div class="post__text post__text-html js-mediator-article"><img src="http://root.loopback.su/habralogger/empty.gif"><h5>  Introduction </h5>  Today I will talk about the design of highly-loaded fault-tolerant systems.  Emphasis will be placed on practical development and fried facts, rather than on a dry theory.  After reading you will not be afraid of developing a service with a billion users if you have enough servers.  The topic is very extensive, but I will try to be brief and concise. <br><a name="habracut"></a><br><h5>  What do we want to get? </h5>  Let's start with a thesis statement of the problem and system requirements, there are not many of them. <br><ul><li>  The system should automatically share tasks between the servers available to it. </li><li>  Simultaneous physical failure (shutdown) of any two servers will not affect the integrity of the system. </li><li>  The physical failure of any equipment does not entail the failure of the whole system. </li><li>  Turning on a new server does not require any manual configuration. </li><li>  A client can interact with any frontend server equally. </li></ul><h5>  Two ways. </h5>  There are two ways.  The first is the way of Microsoft - each service is developed independently, with each group of developers making their own decisions. <br>  The second way - the way Google - there is a single platform and a single system in which applications live (search engine, mailer, groups, etc.). <br>  The second way significantly benefits, because when optimizing any part of the system, the work of all services improves at once, and during development you do not need to think about how all this will actually work.  The first is very reminiscent of Krylov's fable about the swan, cancer, and pike. <br><br><h5>  The main components of the platform. </h5>  On each server any set of components can be started, the number of servers for each component is automatically determined. <br><ul><li>  Data store.  The state of the system is stored only in it. </li><li>  Cache subsystem.  Used to temporarily store hot data in memory. </li><li>  Service locks.  Used to prevent simultaneous calling of sequential procedures. </li><li>  Application service.  All end services live in it. </li><li>  Service interaction with the client.  Includes a web server and a DNS server. </li></ul><h5>  Data store. </h5>  The state of the system is stored only in it, no other repositories for applications are available.  I choose MongoDB.  In order to understand how to approach it, I recommend reading my previous article - <a href="http://habrahabr.ru/blogs/webdev/74273/">MongoDB - we make good coffee</a> , pay special attention to clustering.  MapReduce is also important. <br><br><h5>  Cache subsystem. </h5>  It is necessary to reduce the load on the database on a simple sample of objects, and on complex samples.  I choose memcached.  About how to make friends MongoDB and memcached said in an article about MongoDB, I advise you to pay attention. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Service locks. </h5>  Used to prevent simultaneous calling of sequential procedures.  Before performing a procedure that requires a sequence of actions, the application sends a request to the lock service.  In response, it receives either a consent for execution or a refusal.  I choose phpDaemon :: LockServer.  In the event of a fall of one node, all clients driven by it switch to another node. <br><br><h5>  Application service. </h5>  In it live end services.  <a href="http://ru.wikipedia.org/wiki/OpenVZ">OpenVZ</a> can act as an application service.  Applications can also be asynchronous phpDaemon modules.  When developing applications, you need to queue up any heavy operations. <br><br><h5>  Service interaction with the client. </h5>  Includes a Web server (nginx), a DNS server (bind9) and a firewall through which requests are sent directly to applications.  Fault tolerance and load balancing are provided either via DNS round-robin or via BGP to obtain AS status. <br><br><h5>  File storage </h5>  Files are stored in a database using the <a href="http://www.mongodb.org/display/DOCS/GridFS%2BSpecification">GridFS</a> methodology; there is an implementation as a FUSE module. <br><br><h5>  An example of use.  Description of the Web search service. </h5>  This service is divided into several components: <br>  1. Storage of information about documents. <br>  To do this, use the documents collection with documents containing the url, host, type, size, mtime, atime, title, text, description, indexed, and other properties. Sharding a field by url. <br><br>  2. Crawler'y, save the contents of the pages in the database. <br>  Crawler requests documents.find ({host: ..., indexed: 0}), acquiring a lock on this host.  Requests each document over the network and adds it to the database, exposing indexed: 1. <br><br>  3. Full-text search. <br>  To effectively search the text, you need a special mechanism that allows you to quickly find documents by specified words. <br><br>  3.1.  Reduction of the word to the "normal" form.  Words can be written in different word forms, they all need to be reduced to one normal form, for this you need to use dictionaries (see spelldump from Sphinx), and heuristic stemmers for words missing in dictionaries. <br><br>  3.2.  Index storage. <br>  There are two approaches. <br><br>  The first approach is more often used in search engines with a relatively small number of search queries.  It implies the division of a single search index into several, and the parallelism of the work of all nodes in the query.  That is, when a search query is submitted, all nodes are polled and their responses are glued together.  In this approach, to increase performance, mirrors of nodes are added, and the load is balanced between these mirror nodes.  But it is very inefficient, because  the larger the index, the more servers are required, while the popularity of words is not taken into account.  Many words will never be requested at all. <br><br>  The second approach involves word distribution, so when we query ‚Äúhot girls‚Äù, we first know which servers are responsible for each of these words, then we request them, and we glue the results together.  Servers that are not responsible for these words are not loaded at all.  This gives a huge performance gain. <br><br>  Therefore, we choose the second option.  When the document is indexed, it is broken down into words, they are reduced to normal form, and words.upsert ({word: ..., {"$ push": {"docs": ...}}}) are called for each word. <br><br>  3.3.  Search. <br>  With a simple search for ‚Äúhot girls,‚Äù query words.find ({word: ‚Äúhot‚Äù}) and words.find ({word: ‚Äúgirl‚Äù), notice that ‚Äúgirl‚Äù and not ‚Äúgirls‚Äù.  Then intersections between them are revealed and ranking is performed. <br>  For effective ranking it is necessary to keep the distances between all pairs of words in the document.  A wordpairs collection with objects of the form {docid: ..., word1: "hot", word2: "girl", distance: 1}.  Thus, you can quickly find out in which documents hot and girl are located closest. <br><br><h5>  References to used software. </h5><ul><li>  <a href="http://nginx.ru/">Nginx</a> - Web Server </li><li>  <a href="http://mongodb.org/">MongoDB</a> - Database </li><li>  <a href="http://phpdaemon.googlecode.com/">phpDaemon</a> - server including server blocking and other modules </li></ul><h5>  Conclusion </h5> In fact, making such a system is not at all difficult.  Moreover, I am working on an appropriate framework for the simple creation of such systems. <br>  It is very difficult to fit such a huge amount of information into an article, but I hope I managed to convey the essence.  I am wondering what aspects will seem particularly interesting to you, and I will write about them next time. <br>  The main thing is to understand and realize that if you encounter a problem while working with a simpler tool, rather than using a ready-made solution instead to disregard such problems, this does not mean that the problem is solved, most likely this problem is solved so much in one place. that you can't even imagine.  In general, I am suspicious of products that do not profess the principle of Keep It Simple, Stupid.  When I cannot control what will happen at the elementary level, I understand that it will not be possible to do everything correctly, since all sorts of optimizers automatically (SQL queries, code, etc.) are often mistaken. <br>  For example, in the comments to one of the articles, a person asked whether it is possible in MongoDB to perform an analogue of the SQL query "SELECT * FROM table ORDER BY RAND () * hosts LIMIT 5".  This is of course great and convenient, but with the same success we can select the whole table, and then in the script we will choose what we need, it will not slow down much, because MySQL in this case performs RAND () * hosts for each row, sorts everything these series are in memory, and cuts off the first 5 results.  Of course, the larger the label, the greater the brakes.  So you should always think what is really happening as a result of your actions, otherwise you will never learn how to make highly loaded systems. <br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/74589/">https://habr.com/ru/post/74589/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../74583/index.html">About MTS, 3G, support, holidays and wireless Internet problems</a></li>
<li><a href="../74584/index.html">My first programming experience for Photoshop</a></li>
<li><a href="../74585/index.html">7 Harry Potter Problems</a></li>
<li><a href="../74587/index.html">Migration from PHP to Java</a></li>
<li><a href="../74588/index.html">Fix DSL problem through NetworkManager in Ubuntu 9.10</a></li>
<li><a href="../74592/index.html">EMS vs DHL. Or all the delights of courier services</a></li>
<li><a href="../74594/index.html">Clients of the MTS operator get into the society of total surveillance from Tuesday ten rubles per subscriber</a></li>
<li><a href="../74595/index.html">Windows Server Chief</a></li>
<li><a href="../74601/index.html">Russian browser will not</a></li>
<li><a href="../74603/index.html">The impact of information exchange on science</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>