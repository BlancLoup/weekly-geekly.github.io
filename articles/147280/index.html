<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Crash reports in * nix: backtrace, SEGFAULT (and reinterpret_cast)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, dear habrayuzer! 

 All program developers sooner or later face the problem of the fall of the program from the user. But not everyone can get acc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Crash reports in * nix: backtrace, SEGFAULT (and reinterpret_cast)</h1><div class="post__text post__text-html js-mediator-article">  Hi, dear habrayuzer! <br><img src="https://habrastorage.org/storage2/ca8/892/468/ca8892468d8c9af9782cbb455fd9f319.png" align="right"><br>  All program developers sooner or later face the problem of the fall of the program from the user.  But not everyone can get access to a specific computer on which something is going wrong, run gdb there and repeat the crash.  And even getting information from the user is extremely difficult: a message ‚Äúa program crashes, what to do?‚Äù Comes to the bugtracker (or tech support), but the user does not attach technical information that is so important to the developer.  Yes, and not everyone will write about it!  Just stop using the program - that's all. <br><br>  Some OS offer to send crash-report to developers.  But!  OS developers, not you, that is, not the people who really need it!  And then come to the aid of their own crash reports, which your program should send to your server.  But how to make them?  How to properly handle SEGFAULT and at the same time send intelligible information to the developer? <br><a name="habracut"></a><br>  On Habr√© was already an interesting article from <a href="https://habrahabr.ru/users/arenim/" class="user_link">Arenim</a> , dedicated to the treatment of beautiful.  Briefly, I repeat the point: we catch the POSIX-signal SIGSEGV, and after processing it we exit the program. <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">catchCrash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> signum)</span></span></span><span class="hljs-function"> </span></span>{ reportTrouble(); <span class="hljs-comment"><span class="hljs-comment">//  - signal(signum, SIG_DFL); //   exit(3); //   } int main() { signal(SIGSEGV, catchCrash); //-- ... --// }</span></span></code> </pre> <br>  Now it's up to you: localize the problem!  And although the above method works in Windows, we can get a normal backtrace only in * nix (in fact, you can get it in Windows, but for this you have to distribute the debug build, which is not very good).  So, we smoke manuals and do this: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reportTrouble</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *callstack[<span class="hljs-number"><span class="hljs-number">128</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> frames = backtrace(callstack, <span class="hljs-number"><span class="hljs-number">128</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> **strs=backtrace_symbols(callstack, frames); <span class="hljs-comment"><span class="hljs-comment">//      crash_report.txt //         -  , , etc FILE *f = fopen("crash_report.txt", "w"); if (f) { for(int i = 0; i &lt; frames; ++i) { fprintf(f, "%s\n", strs[i]); } fclose(f); } free(strs); system("curl -A \"MyAppCrashReporter\" --form report_file=@\"crash_report.txt\" http://reports.myserver.com"); }</span></span></code> </pre><br>  And everything, the report went to the server!  If you want, you can ask the user before sending - and not whether to send us a reporter?  Of course, in the GUI program it is a bit dangerous - after all, after the SEGFAULT, the adequacy of the internal state of the graphical framework (well, or bare X) is not guaranteed, so it‚Äôs better to warn the user in advance (for example, in the license agreement) send anonymous reports. ‚Äù  The main thing is not to enter the user's personal information and other data into the report, it is not only immoral, but it can also be prosecuted (unless, of course, at the end of the license agreement the user‚Äôs consent is not written in small letters). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We will now test the method described in practice.  Let's create a simple program with a simple class and simple additional functions.  And try to <i>drop</i> this code.  The simplest thing is to call the method at the null pointer to the class, but this is too primitive, let the pointer point ‚Äúto the sky‚Äù better, so interesting.  How to achieve this?  Well, of course, apply the beloved <code>reinterpret_cast</code> all of us!  So, to make the backtrack more interesting, we create the functions <code>goCrash()</code> and <code>crash(void *)</code> . <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">crash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *obj)</span></span></span><span class="hljs-function"> </span></span>{ Crasher *crasher = <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;Crasher *&gt;(obj); crasher-&gt;doSomething(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">goCrash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *str = <span class="hljs-string"><span class="hljs-string">"Hello, crash!"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *str2 = <span class="hljs-string"><span class="hljs-string">"Hello again, crash!"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> str3[<span class="hljs-number"><span class="hljs-number">200</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(str3, <span class="hljs-string"><span class="hljs-string">"%s\t\t%s\n"</span></span>, str, str2); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> add = rand() % <span class="hljs-number"><span class="hljs-number">20000</span></span> + <span class="hljs-number"><span class="hljs-number">1500234000l</span></span>; <span class="hljs-comment"><span class="hljs-comment">// fire in my leg! crash(reinterpret_cast&lt;void *&gt;(str3 - add)); }</span></span></code> </pre><br>  Well, it seems that we will send to our class <code>Crasher</code> some previously unknown address.  Very curious!  Let's declare the class: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> P_DOUBLE_COUNT 10000 class Crasher { public: </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// c-tor Crasher() { myPrivateString = new char[100]; sprintf(myPrivateString, "%s\n", "that\'s my private string!"); myPrivateInteger = 100; for (int i = 0; i &lt; P_DOUBLE_COUNT; ++i) myPrivateDoubles[i] = i / 100.0; } // func void doSomething() { // here we can (?) crash fprintf(stderr, "%s\n", "That\'sa function!"); doSomethingPrivate(); } private: void doSomethingPrivate() { // crash? oh, no... fprintf(stderr, "%s myPrivateInteger == %d\n", "That\'sa private function!", myPrivateInteger); fprintf(stderr, "myPrivateDoubles[1] == %f\n", myPrivateDoubles[1]); fprintf(stderr, "myPrivateString == %p\n", myPrivateString); // still alive? crash! crash! crash! ((Crasher*)NULL)-&gt;doSomething(); } private: char *myPrivateString; int myPrivateInteger; double myPrivateDoubles[P_DOUBLE_COUNT]; };</span></span></span></span></code> </pre><br>  Note that in the <code>doSomethingPrivate()</code> function, we all call the function at the null pointer.  So, just in case.  Suddenly, after calling <code>doSomething()</code> for an undefined address, will the program still survive? <br><br>  You can now build and run our program.  And what will we see?  The program worked successfully, but <code>curl</code> cursed that the server was not found.  Well, this is nonsense, you can temporarily replace his call with <code>cat crash_report.txt</code> order to see our crash report right away.  So what else do we see? <br><br>  And we see the line <code>"That's a function!"</code>  derived from the <code>doSomething()</code> method!  Interesting, isn't it?  The pointer points to the sky, and the methods work?  Well, not exactly. <br><br>  The program is crashing (most likely) on the call to <code>doSomethingPrivate()</code> , and the backtrack tells us eloquently about it: <br><pre> <code class="bash hljs">0 segfault 0x000000010d0a98c8 _Z13reportTroublev + 40 1 segfault 0x000000010d0a99d0 _Z10catchCrashi + 16 2 libsystem_c.dylib 0x00007fff99b5dcfa _sigtramp + 26 3 ??? 0x00007fff00000000 0x0 + 140733193388032 4 segfault 0x000000010d0a9c67 _ZN7Crasher11doSomethingEv + 71 5 segfault 0x000000010d0a9880 _Z5crashPv + 32 6 segfault 0x000000010d0a9ac7 _Z7goCrashv + 199 7 segfault 0x000000010d0a9b33 main + 67 8 segfault 0x000000010d0a9854 start + 52</code> </pre><br>  Let's experiment, to begin with, let's not add an extra address shift when calling <code>crash()</code> , what will the program output?  Where does it crash?  Ahem! <br><pre> <code class="bash hljs">That<span class="hljs-string"><span class="hljs-string">'s a function! That'</span></span>s a private <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>! myPrivateInteger == 1752392050 myPrivateDoubles[1] == 60993401604041306737928347282702617388988841504491171140800281285302442927306116721201046092641903128620672849302937378251940003901836219046866981678295779355600933772275817062376375849852470059862498765690530537583237171035779906888043337758015488.000000 myPrivateString == 0x63202c6f6c6c6548 That<span class="hljs-string"><span class="hljs-string">'s a function! 0 segfault 0x0000000109a5e8c8 _Z13reportTroublev + 40 1 segfault 0x0000000109a5e9d0 _Z10catchCrashi + 16 2 libsystem_c.dylib 0x00007fff99b5dcfa _sigtramp + 26 3 ??? 0x0000040000000000 0x0 + 4398046511104 4 segfault 0x0000000109a5ec67 _ZN7Crasher11doSomethingEv + 71 5 segfault 0x0000000109a5ec1a _ZN7Crasher18doSomethingPrivateEv + 208 6 segfault 0x0000000109a5ec67 _ZN7Crasher11doSomethingEv + 71 7 segfault 0x0000000109a5e880 _Z5crashPv + 32 8 segfault 0x0000000109a5eac4 _Z7goCrashv + 196 9 segfault 0x0000000109a5eb33 main + 67 10 segfault 0x0000000109a5e854 start + 52</span></span></code> </pre><br>  It can be seen that it crashes on the second call to <code>doSomethingPrivate()</code> , and the first one went off with a bang, although it didn‚Äôt bring us anything that was intended. <br><br>  So, why even when calling a method at a null pointer, a segment appears only on the second function?  What is the difference?  Experienced plugs have long guessed <s>and did not read this article</s> , and for the rest I will explain.  They differ in the use of class variables!  If variables are not used, then it does not matter at all which pointer to call the function, because the hidden parameter <code>this</code> not used, namely in it we have garbage.  In the second example (without a shift), a private function is called with <code>this</code> ' om pointing to our string, and our class variables will point to parts of this string and contain, respectively, any garbage included in it.  And in the first case, the pointer is likely to simply refer to the memory area inaccessible to the program, so the first call to the private function will be painted. <br><br>  Why in this article description of such elementary things?  Well, of course, you have to show how to crash programs!  And explain why calling class methods on invalid pointers does not always lead to crash.  If the full code is interesting, I ask, as always, on the <a href="https://github.com/silvansky/segfault">githab</a> . <br><br>  In general, successful debugging!  And smaller crash reports;) </div><p>Source: <a href="https://habr.com/ru/post/147280/">https://habr.com/ru/post/147280/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147273/index.html">Remote control of a windows user session using standard tools</a></li>
<li><a href="../147274/index.html">Google transfers GWT project management to an independent committee.</a></li>
<li><a href="../147275/index.html">Some experience in working with the FatFree Framework</a></li>
<li><a href="../147276/index.html">How Microsoft became what it used to despise</a></li>
<li><a href="../147277/index.html">Single-line C / C ++. Part 2</a></li>
<li><a href="../147281/index.html">Thoughts of Python 3</a></li>
<li><a href="../147283/index.html">Sberbank cards stopped working</a></li>
<li><a href="../147284/index.html">Trade knows when you are expecting a baby</a></li>
<li><a href="../147287/index.html">Live broadcast "Invasions" on Yandex.Music</a></li>
<li><a href="../147288/index.html">Electronic Debt Collectors Appear in Russia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>