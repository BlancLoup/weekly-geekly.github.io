<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>To yourself devops or configure Nginx proxy for Apache Tomcat on Ubuntu in 5 minutes with https and firewall</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I am not an admin, but sometimes there are tasks that are easier (and more interesting) to solve myself than to delegate. 

 Occasionally, we need to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>To yourself devops or configure Nginx proxy for Apache Tomcat on Ubuntu in 5 minutes with https and firewall</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/039/571/089/039571089fb10bc2e457428ec7d35244.jpg"><br><br>  I am not an admin, but sometimes there are tasks that are easier (and more interesting) to solve myself than to delegate. <br><br>  Occasionally, we need to ‚Äúraise‚Äù the servlet container (most often Apache Tomcat) and configure proxying for it, ssl termination (or, more simply, https) and cover it all with a firewall (leaving only ssh and http / https out). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It so happened that over the last week I solved this problem three times (this is how the stars became, and before that - two years ago) and this experience was transformed into this little opus. <br><a name="habracut"></a><br>  So, given Ubuntu server is 18.04 or 16.04 (most likely you will not have problems with earlier versions 14.04 or so).  If you do not have a Ubuntu server, you can quickly ‚Äúraise‚Äù it, for example, to <a href="https://m.do.co/c/07e6f256a864">Digital Ocean</a> (my referral link).  After writing the article I noticed that DO for new accounts gives $ 100 for 60 days to try, if you specify a loan. <br><br><h2>  DNS </h2><br>  For a simple scheme for obtaining a free https certificate from Let's Encrypt, we will need access to the DNS server.  We register in it the IP address of our Ubuntu server with the name, say, xyz.  Let's, for definiteness, suppose that you have a domain mydomain.com, i.e.  DNS name of our server will be xyz.mydomain.com <br><br><h2>  Installation </h2><br>  Install Apache Tomcat (I will use version 8) <br><br><pre><code class="bash hljs">apt install tomcat8</code> </pre> <br>  And now Nginx <br><br><pre> <code class="bash hljs">apt install nginx-core</code> </pre> <br><h2>  Customization </h2><br><h3>  Nginx </h3><br>  Configuring Nginx registered earlier in the DNS server name (file <i>/ etc / nginx / sites-available / default</i> ) <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> xyz.mydomain.com;</code> </pre> <br>  We register the link to the installed Apache Tomcat (if you didn‚Äôt change anything, then it ‚Äúlives‚Äù on port 8080).  We need to add an <i>upstream</i> block to the <i>server</i> block. <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> tomcat { <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> <span class="hljs-number"><span class="hljs-number">127.0.0.1:8080</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-section"><span class="hljs-section">server</span></span> { ...</code> </pre> <br>  Make changes to the <i>location</i> block and redirect all traffic to Apache Tomcat <br><br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { ... <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-comment"><span class="hljs-comment"># try_files $uri $uri/ =404; include proxy_params; proxy_pass http://tomcat/; }</span></span></code> </pre> <br>  Check that everything is correct <br><br><pre> <code class="bash hljs">service nginx configtest</code> </pre> <br>  and restart nginx <br><br><pre> <code class="bash hljs">service nginx restart</code> </pre> <br><h3>  Apache tomcat </h3><br>  In principle, this part is optional, and if it doesn‚Äôt matter to you that real ip addresses, ports, the scheme for which the request goes (I‚Äôm talking about https) and the requested server ‚Äúcome‚Äù to tomcat, then this step can be omitted.  However, in some cases this step is required (for example, for Java Web Start technology aka JNLP). <br><br>  Add to the <i>/etc/tomcat8/server.xml</i> file in the <i>&lt;Host /&gt;</i> block. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Host</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Valve</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">className</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.apache.catalina.valves.RemoteIpValve"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">remoteIpHeader</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"x-forwarded-for"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">remoteIpProxiesHeader</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"x-forwarded-by"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">protocolHeader</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"x-forwarded-proto"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Host</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Restart tomcat <br><br><pre> <code class="bash hljs">service tomcat8 restart</code> </pre> <br><h2>  HTTPS certificate </h2><br>  HTTPS certificate with verification via http will help us get the certbot bot, or rather its modification for nginx'a - python-certbot-nginx <br><br>  On Ubuntu 18.04, installing certbot is sufficient to complete <br><br><pre> <code class="bash hljs">apt install python-certbot-nginx</code> </pre> <br>  For Ubuntu 16.04 - you will have to tinker with the addition of repositories, etc. (see the <a href="https://certbot.eff.org/lets-encrypt/ubuntuxenial-nginx">detailed guide for the link</a> ). <br><br>  Run <br><br><pre> <code class="bash hljs">certbot --nginx</code> </pre> <br>  In the process, we specify our email, accept the license agreement, do not allow ‚Äúfumble‚Äù our data with Let's Encrypt, confirm the DNS name to which the certificate will be issued, agree to let the bot otconfigure nginx. <br><br>  Voila :) <br><br>  Just in case, we check that the renewal of the certificate will pass without problems (the certificate is issued for 90 days and after that it can be extended indefinitely for the same period). <br><br><pre> <code class="bash hljs">certbot renew --dry-run</code> </pre> <br>  And for internal paranoia we check that the cron file is in place. <br><br><pre> <code class="bash hljs">ls -al /etc/cron.d/certbot</code> </pre> <br><h2>  Firewall </h2><br>  Stop and make backup (snapshot) virtualki. <br><br><pre> <code class="bash hljs">ufw allow ssh ufw allow http ufw allow https ufw default allow outgoing ufw default deny incoming ufw show added</code> </pre> <br>  We pray! <br><pre> <code class="bash hljs">ufw <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> ufw status</code> </pre> <br>  We check that everything turned out - the site is accessible via https, http traffic is redirected and ports, except for those previously listed, and ssh are securely closed. <br><br>  PS I sincerely hope that this text can be useful to someone and will be glad to constructive criticism. <br><br>  PPS And maybe the all-knowing ALL prompts me to replace certbot for Windows?  It is necessary that he received the initial certificate (ideally, updated it on a schedule, and not at all chic brilliance) he configured nginx himself.  Yes, I understand that you can certainly take the tool for let's encrypta + IIS and use it in my script, but what if there is a ready-made ‚Äúideal‚Äù? </div><p>Source: <a href="https://habr.com/ru/post/434010/">https://habr.com/ru/post/434010/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../434000/index.html">The most significant data breaches in 2018. Part Two (July-December)</a></li>
<li><a href="../434002/index.html">Traffic monitoring systems in VoIP networks. Part One - Overview</a></li>
<li><a href="../434004/index.html">Wargaming Platform: Hello World</a></li>
<li><a href="../434006/index.html">Do we need cookies banners in the era of GDPR - we discuss the situation and the requirements of the law</a></li>
<li><a href="../434008/index.html">How to stop worrying and start writing tests based on properties</a></li>
<li><a href="../434012/index.html">Free PVS-Studio for those who develop open projects</a></li>
<li><a href="../434016/index.html">Operation of rabbits (RabbitMQ) in the "Survive at any cost"</a></li>
<li><a href="../434018/index.html">We get a certificate from Google Associate Android Developer</a></li>
<li><a href="../434022/index.html">Uber resumed tests of its robomobiles nine months after the fatal accident</a></li>
<li><a href="../434024/index.html">Horsepower in Android or once again about RecyclerView.LayoutManager</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>