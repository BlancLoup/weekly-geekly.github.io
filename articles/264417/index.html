<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Proper use of Exception in PHP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I would love to write that ‚Äúthis article is intended for newbies‚Äù , but it‚Äôs not. Most php-developers, having experience of 3, 5 and even 7 years, abs...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Proper use of Exception in PHP</h1><div class="post__text post__text-html js-mediator-article"> I would love to write that <i>‚Äúthis article is intended for newbies‚Äù</i> , but it‚Äôs not.  Most php-developers, having experience of 3, 5 and even 7 years, absolutely do not understand how to properly use exceptions.  No, they are well aware of their existence, the fact that they can be created, processed, etc., but they do not realize their convenience, consistency, and do not perceive them as an absolutely normal element of development. <br><br>  In this article there will not be a manual for the exceptions - this is all perfectly described in the php documentation.  Here I will tell you about the advantages of using exceptions, and about where, strictly speaking, they should be used.  All examples will be for <code>Yii</code> , but this is not particularly important. <br><a name="habracut"></a><br><h2>  Why we do not know how to use exceptions: </h2><br>  I love <code>PHP</code> .  This is an excellent language, as if it were not scolded.  But for novice developers, he carries a certain danger: he forgives too much. <br><br>  <code>PHP</code> is an overly loving mother.  And in the absence of a strict father (for example, <code>Java</code> ) or self-discipline, the developer will grow into an egoist who doesn‚Äôt care about all the rules, standards and best practices.  And it seems to <code>E_NOTICE</code> time to include <code>E_NOTICE</code> , and he hopes for his mother.  Which, by the way, is getting old - it already <code>E_STRICT</code> with <code>E_DEPRICATED</code> , and everything is hanging around its neck. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Whether <code>PHP</code> is a matter of discussion is to blame, but the fact that from the very beginning <code>PHP</code> doesn‚Äôt teach us exceptions is a fact: its standard functions do not create exceptions.  They either return <code>false</code> , hinting that something is wrong, or write down an error code somewhere that you don‚Äôt always think of to check.  Or fall into another extreme - <code>Fatal Error</code> . <br><br>  And while our novice developer is trying to write his first bydlo-cms, he never meets with the mechanism of execs.  Instead, he will come up with several ways to handle errors.  I think everyone understands what I am talking about - these methods returning different types (for example, an object when successfully executed, and if unsuccessful, a string with an error), or writing an error to some variable / property, and always a bunch of checks to pass error up the call stack. <br><br>  Then he will begin to use third-party libraries: he will try, for example, <code>Yii</code> , and for the first time he will encounter exams.  And then ... <br><br>  And then nothing will happen.  Nothing at all.  He has already developed methods of error handling honed by months / years - he will continue to use them.  Caused by someone (a third-party library), the exception will be perceived as a specific type of <code>Fatal Error</code> .  Yes, much more detailed, logged in detail, and Yii will show a beautiful page, but no more. <br><br>  Then he learn to catch and process them.  And this is where his acquaintance with the exceptions will end.  After all, you have to work, not learn: he already has enough knowledge (sarcasm)! <br><br>  But the worst thing is that the attitude towards the exceptions is developed as something bad, undesirable, dangerous, which should not be, and which should be avoided by all means.  This is absolutely not the right approach. <br><br><h2>  Advantages of exceptions </h2><br>  In fact, the use of exceptions is an extremely concise and convenient solution for creating and handling errors.  I will give the most significant benefits: <br><br><h3>  Context logic </h3><br>  First of all, I would like to show that the execution is not always just a mistake (as usual, developers perceive it).  Sometimes it can be part of the logic. <br><br>  For example, we have a function for reading a <code>JSON</code> object from a file: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** *    JSON  * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $file * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> FileNotFoundException    * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> JsonParseException    json * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readJsonFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($file)</span></span></span><span class="hljs-function"> </span></span>{ ... }</code> </pre><br>  Suppose we are trying to read some previously loaded data.  With such an operation, the FileNotFoundException <code>FileNotFoundException</code> not an error and is perfectly admissible: it is possible that we have never loaded data, therefore there is no file.  But <code>JsonParseException</code> is already a sign of an error, because the data was loaded, processed, saved to a file, but for some reason it was not stored correctly. <br><br>  It is quite another thing when we try to read a file that should always be: for such an operation, <code>FileNotFoundException</code> is also an error signal. <br><br>  Thus, exceptions allow us to define the logic of their processing depending on the context, which is very convenient. <br><br><h3>  Simplify application logic and architecture </h3><br>  Try using exceptions, and you will see how your code will become more concise and understandable.  All the crutch mechanisms will disappear, a bunch of nested ifs will be removed, various error transfer mechanisms go up the call stack, the logic will become simpler and more straightforward. <br><br>  Places the calls of exceptions will help your colleague to better understand business logic and the subject area, for delving into your code, he will immediately see what is permissible and what is not. <br><br>  And, if we consider any self-sufficient piece of code, for example, a component, then the list of exceptions thrown by it performs another important thing: it complements the interface of this component. <br><br>  Using third-party components, we are accustomed to pay attention only to the positive side - that he knows how.  In this case, we usually do not think about the exceptions that he can create in the process of work.  The list of warnings immediately warns where, when, and what problems may arise.  But forewarned is forearmed. <br><br>  Here is an example of an informative interface that is supplemented with knowledge of the behavior: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">KladrService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** *      * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Address $address * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string    * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> AddressNotFoundException       * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> UnresoledAddressException  ,        */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resolveCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Address $address)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *      * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $code * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Address * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> CodeNotFoundException     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resolveAddress</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($code)</span></span></span></span>; }</code> </pre><br>  It should be mentioned that in developing classes of exceptions, we must follow the principle of an informative interface.  Roughly speaking - to take into account their logical sense, and not physical.  For example, if our addresses are stored in files, then the absence of an address file will cause a <code>FileNotFoundException</code> .  We should intercept it and cause more sensible <code>AddressNotFoundException</code> . <br><br><h3>  Use of objects </h3><br>  Using a specific class as an error is a very convenient solution.  First, the class cannot be confused: take a look at 2 ways to handle the error: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Yii::app()-&gt;kladr-&gt;getLastError() == <span class="hljs-string"><span class="hljs-string">'  '</span></span>){ ‚Ä¶. }</code> </pre><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{ ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(AddressNotFoundException $e){ ... }</code> </pre><br>  In the first variant, an elementary typo will break the whole logic for you, in the second one it is simply impossible to make a mistake. <br><br>  The second advantage - the class of encapsulation encapsulates all the necessary data for its processing.  For example, <code>AddressNotFoundException</code> might look like this: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** *       */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddressNotFoundException</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Exception</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** *    * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> Address */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $address; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Address $address */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Address $address)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>::__construct(<span class="hljs-string"><span class="hljs-string">'   '</span></span>.$address-&gt;oneLine); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;address = $address; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Address */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAddress</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;address; } }</code> </pre><br>  As you can see, the event contains an address that could not be found.  The handler can get it and execute some logic of its own based on it. <br><br>  The third advantage is, in fact, all the advantages of the PLO.  Although, as a rule, simple objects, so the possibilities of OOP are used a little, but are used. <br><br>  For example, I have about 70 classes of classes in the application.  Of these, several - basic - one class per module.  All the others are inherited from the base class of their module.  This is done for the convenience of log analysis. <br><br>  I also use several INTERFACE MARKERS: <br><br><ul><li>  <b>UnloggedInterface:</b> By default, I log all unprocessed errors.  I mark this interface with exceptions that do not need to be logged at all. </li><li>  <b>PreloggedInterface: I use</b> this interface to mark exceptions that need to be logged anyway: it doesn't matter whether they are processed or not. </li><li>  <b>OutableInterface:</b> This interface marks exceptions, the text of which can be given to the user: not every event can be displayed to the user.  For example, you can display an exception with the text <i>‚ÄúPage not found‚Äù</i> - this is normal.  But it is impossible to display an event with the text <i>‚ÄúCould not connect to Mysql using root login and password 123‚Äù</i> .  <code>OutableInterface</code> marks exceptions that can be displayed (I have such a minority).  In the rest of the situation, something like <i>‚ÄúService is not available‚Äù is</i> displayed. </li></ul><br><h3>  Default handler logging </h3><br>  The default handler is an extremely useful thing.  Who does not know: it is executed when the operation could not be processed by any <code>try catch</code> . <br><br>  This handler allows us to perform various actions before stopping the script.  The most important thing to do is: <br><br>  <b>Rolling back changes:</b> since the operation was not completed, it is necessary to roll back all the changes made.  Otherwise, we will corrupt the data.  For example, you can open a transaction in <code>CController::beforeAction()</code> commit it in <code>CController::afterAction()</code> , and make a rollback in the default handler in case of an error. <br><br>  This is a rather rude way to rollback, plus often rolling back implies not only rolling back transactions, and knowledge of how to roll back properly must be in the business logic code.  In such situations, you should use this technique: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addPosition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Position $position)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ...   ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> $e) { ...   ... <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> $e; <span class="hljs-comment"><span class="hljs-comment">//      } }</span></span></code> </pre><br>  It turns out that we rolled back the changes and threw the same exception that we continue to process it. <br><br>  <b>Logging: the</b> default handler allows us to perform some kind of custom logging.  For example, in my application, I put everything in the database and use my own analysis tool.  At work, we use <a href="https://getsentry.com/welcome/">getsentry.com/welcome</a> .  In any case, the exception that has reached the default handler is most likely an unintended exception and needs to be logged.  It should be noted that you can add various information to the class of the exceptions that you need to log in order to better understand the cause of the error. <br><br><h3>  Impossibility not to notice and confuse </h3><br>  A huge advantage of the exception is its unambiguity: it is impossible not to notice and cannot be confused with something. <br><br>  From the first it follows that we will always be aware of the error.  And this is wonderful - it is always better to know about the problem than not to know. <br><br>  The second plus becomes obvious in comparison with the custom error handling methods, for example, when the method returns <code>null</code> if it does not find the required object and false in case of an error.  In this case, it is elementary not to notice the error: <br><br><pre> <code class="php hljs">$result = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;doAnything(); <span class="hljs-comment"><span class="hljs-comment">// null       false    //    if($result){ ... } //    if($result == null){ ... } //    if(empty($result)){ ... } //    if($result = null){ ... }</span></span></code> </pre><br>  Exception is impossible to miss. <br><br><h3>  Termination of an erroneous operation </h3><br>  But the most important thing, and the most important thing that makes the expection, is that it stops the further execution of the operation.  An operation that has already gone wrong.  And, therefore, the result is unpredictable. <br><br>  A huge minus of self-made error handling mechanisms is the need to independently verify the occurrence of an error.  For example, after each operation we need to write something like: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;doOperation(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getLastError() !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getLastError(); <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>; }</code> </pre><br>  This requires a certain discipline from the developers.  And not all are disciplined.  Not everyone knows that your object has a <code>getLastError()</code> method.  Not everyone understands why it is so important to check that everything is going as it should, and if not, roll back the changes and stop execution. <br><br>  As a result, checks are not done, and performing the operation leads to completely unexpected results: instead of one user, everything is deleted, the money is sent to the wrong person, voting in the State Duma produces a false result - I have seen this a dozen times. <br><br>  Exception protects us from such problems: it either looks for the corresponding handler (its presence means that the developer has foreseen this situation, and everything is fine), or comes to the default handler, which can roll back all changes, log the error, and issue an appropriate warning to the user. <br><br><h2>  When to call exceptions: </h2><br>  With the benefits sort of sorted out.  I hope I managed to show that exams are an extremely convenient mechanism. <br><br>  The question is: in what situations is it worth to call an event? <br><br>  In short - always!  In detail: always, when you are sure that the operation should be performed normally, but something went wrong, and you do not know what to do with it. <br><br>  Let's look at the simplest action to add a post: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** *   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $post = \Yii::app()-&gt;request-&gt;loadModel(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Post()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($post-&gt;save()) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;outSuccess($post); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;outErrors($post); } }</code> </pre><br>  When we enter incorrect data, the post is not called.  And it completely corresponds to the formula: <br><br><ul><li>  At this step, we are not sure that the operation should be successful, because you cannot trust the data entered by the user. </li><li>  We know what to do with it.  We know that in the case of incorrect data, we must display to the user a list of errors.  It should be noted here that the knowledge of what to do is within the limits of the current method. </li></ul><br>  Therefore, in this case there is no need to use exceptions.  But let's look at another example: There is an order page, on which there is a button that cancels the order.  The cancellation code is as follows: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** *  . *       STATUS_CANCEL. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> \Exception */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ,   STATUS_CANCEL   if(!$this-&gt;isAllowedStatus(self::STATUS_CANCEL)) { throw new \Exception('Cancel status not allowed'); } //    $this-&gt;status = self::STATUS_CANCEL; $isSaved = $this-&gt;save(); //              STATUS_CANCEL if(!$isSaved|| $this-&gt;status !== self::STATUS_CANCEL) { throw new \Exception('Bad logic in order cancel'); } }</span></span></code> </pre><br>  The cancel button itself is shown only when the order can be canceled.  Thus, when this method is called, I am sure that the operation should be successful (otherwise the button would not be displayed, and the user would not be able to click on it to call this method). <br><br>  The first thing to do is prevalidation - we check whether we can really perform the operation.  In theory, everything should be successful, but if <code>isAllowedStatus</code> returns <code>false</code> , then something went wrong.  Plus, within the current method, we absolutely do not know how to handle this situation.  It is clear that you need to log a mistake, display it to the user, etc ... But in the context of this particular method, we do not know what to do with it.  Therefore, we throw an exception. <br><br>  Next is the operation and saving changes. <br><br>  Then there is a postvalidation - we check whether everything is really preserved and whether the status has really changed.  At first glance, this may seem meaningless, but: the order could not be fully preserved (for example, it did not pass validation), and the status could well be changed (for example, someone could have a CAdbloader in <code>CActiveRecord::beforeSave</code> ).  Therefore, these actions are necessary, and, again, if something went wrong, we throw an exception, because within this method we do not know how to handle these errors. <br><br><h3>  Exclusion vs return null </h3><br>  It should be noted that the exception should be thrown only in case of an error.  I‚Äôve seen some developers abuse them, throwing them where they shouldn‚Äôt.  Especially often - when the method returns an object: if it fails to return the object - an action is thrown. <br><br>  Here you should pay attention to the responsibilities of the method.  For example, <code>ActiveRecord::find()</code> does not throw an exception, and this is logical - the level of its ‚Äúknowledge‚Äù does not contain information about whether the absence of a result is an error.  Another thing, for example, is the method <code>KladrService::resolveAddress()</code> which in any case is obliged to return the address object (otherwise either the code is incorrect or the base is not up to date).  In this case, you need to throw Exception, because the lack of a result is a mistake. <br><br>  In general, the described formula ideally defines the places where it is necessary to throw exceptions.  But I would especially like to highlight 2 categories of execs, which need to be done as much as possible: <br><br><h3>  Technical exceptions </h3><br>  These are exceptions that are completely unrelated to the subject area, and are necessary in order to technically prevent the execution of incorrect logic. <br><br>  Here are some examples: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//   if if($condition1) { $this-&gt;do1(); } elseif($condition2) { $this-&gt;do2(); } ... else { //       if,    -   throw new BadLogicException; }</span></span></code> </pre><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//     swith switch($c) { case 'one': return 1; case 'two' return 2; ... default: //       case,    -   throw new BadLogicException; }</span></span></code> </pre><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//     if($model1-&gt;isNewRecord) { //     ,    id,   $model2-&gt;parent_id = $model1-&gt;id //   ,    throw new BadLogicException; } $model2-&gt;parent_id = $model1-&gt;id;</span></span></code> </pre><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//   -     save     if(!$model-&gt;save()) { throw new BadLogicException; }</span></span></code> </pre><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * C  id  * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $userId * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> $this */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">byUserId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($userId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!$userId) { <span class="hljs-comment"><span class="hljs-comment">//     ,    userId      throw new InvalidArgumentException; } $this-&gt;dbCriteria-&gt;compare('userId', $userId); return $this; }</span></span></code> </pre><br>  Technical descriptions will help prevent or catch, IMHO, most of the bugs in any project.  And the indisputable advantage of their use is the lack of need to understand the subject area: the only thing required is the discipline of the developer.  I urge not to be lazy and insert such checks everywhere. <br><br><h3>  Exception statements </h3><br>  Statements of statements (based on <code>DDD</code> ) are called when we discover that some business logic is violated.  Of course, they are closely related to the knowledge of the subject area. <br><br>  They rush when we check a statement, and see that the result of the check does not match what was expected. <br><br>  For example, there is a method for adding an item to an order: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** *     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Position $position * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> \Exception */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addPosition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Position $position)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;positions[] = $position; ...   , , ,   ... <span class="hljs-comment"><span class="hljs-comment">//    if($this-&gt;totalCost != $this-&gt;positionsCost + $this-&gt;deliveryCost - $this-&gt;totalDiscounts) { throw new \Exception('Cost recalculation error'); } ...    ... //          if(!Yii::app()-&gt;deliveryService-&gt;canDelivery($this)) { throw new \Exception('Cant delivery with new position') } ‚Ä¶   ... }</span></span></code> </pre><br>        .       :    ,      ‚Äî     . <br><br>        : <br> ,        ,      ‚Äî     .            (    ,  ) <br><br>   ,           .    , ,  ,      . <br><br>        . <br><br><h2>      </h2><br>    , <code>PHP</code>   .    ,     . <br><br>         :    , ,     - ,   -  . <br><br>  :      id (   ‚Äî      ) <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** *    id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $id */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ $page = Page::model()-&gt;findByPk($id) ?: Page::model()-&gt;find(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;render(<span class="hljs-string"><span class="hljs-string">'view'</span></span>, [<span class="hljs-string"><span class="hljs-string">'page'</span></span> =&gt; $page]); }</code> </pre><br>       ‚Äî    . <br>  ,          ,       : <br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if </font></font><code>id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not specified, it is taken </font></font><code>id = 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The problem is that when id is not set - this is already a bug, because somewhere we have not correctly formed links.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the page is not found, it means that somewhere we have a link to a non-existent page. </font><font style="vertical-align: inherit;">This is also most likely a bug.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This behavior does not benefit either the user or the developers. </font><font style="vertical-align: inherit;">The motivation for such a realization is to show at least something, for an </font></font><code>404</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exception is bad. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One more example:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** *     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> mixed $region * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> mixed $city * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCityKladrCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($region, $city)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($ode = ...    ... ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $ode; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ...     ... }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Also from a real project, and the motivation is the same: to return at least something, but not to cause an exception, despite the fact that the method clearly must return the city code, not the region. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And such changes of logic in the average project a huge amount. As long as you remember it, it seems harmless. But as soon as you forget, or another developer connects, the bug is provided. And an implicit bug floating. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">My opinion is inadmissible. Just when you work with big money (and I worked with them for a long time), certain rules are worked out, and one of them is to interrupt the operation in case of any suspicion of a mistake. Transaction for 10 million dollars: agree that it is better to cancel it than to transfer money to the wrong person.</font></font><br><br> ,        .    , ,          .     (    )    , , ,  .   ,     -   ‚Äî     .     ,    ,        .  ,       -   , -   , -   , -   . ,  ! <br><br><h2>  Dogs </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For some reason I thought that </font><font style="vertical-align: inherit;">no one uses </font></font><a href="http://php.net/manual/ru/language.operators.errorcontrol.php"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dogs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> anymore. </font><font style="vertical-align: inherit;">But I recently encountered a team of developers who use them everywhere instead of checking </font></font><code>isset</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, so I decided to write about them. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dogs instead </font></font><code>isset</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">used for brevity code:</font></font><br><br><pre> <code class="php hljs">@$policy-&gt;owner-&gt;address-&gt;locality;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vs </font></font><br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($policy-&gt;owner-&gt;address) ? $policy-&gt;owner-&gt;address-&gt;locality : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Indeed, it looks much shorter, and at first glance the result is the same. </font></font> But!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It's dangerous to forget that the dog is an operator ignoring error messages. </font><font style="vertical-align: inherit;">And it </font></font><code>@$policy-&gt;owner-&gt;address-&gt;locality</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will return, </font></font><code>null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not because it checks the existence of a chain of objects, but because it simply ignores the error that occurred. </font><font style="vertical-align: inherit;">And these are completely different things. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The problem is that in addition to ignoring the error </font></font><code>Trying to get property of non-object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(which makes the dog‚Äôs behavior similar to </font></font><code>isset</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), all other possible errors are ignored. </font></font><br><br> <code>PHP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- this is a magic language! </font><font style="vertical-align: inherit;">In the presence of all these magical methods ( </font></font><code>__get, __set, __call, __callStatic, __invoke</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and so forth), we cannot always immediately understand what is actually happening. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For example, look at the line again </font></font><code>$policy-&gt;owner-&gt;address-&gt;locality</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">At first glance - a chain of objects, if you look closely - it may well be this:</font></font><br><br><ul><li> <code>policy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - model </font></font><code>CActiveRecord</code> </li><li> <code>owner</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - relay </font></font></li><li> <code>address</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - getter, which, for example, refers to any third-party service </font></font></li><li> <code>locality</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - attribute </font></font></li></ul><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, with a simple string, </font></font><code>$policy-&gt;owner-&gt;address-&gt;locality</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we actually run the execution of thousands of lines of code. </font><font style="vertical-align: inherit;">And the little dog in front of this line hides errors in any of these lines. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, such a rash use of a dog potentially creates a huge number of problems.</font></font><br><br><h2>  Afterword </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programming is awesome. </font><font style="vertical-align: inherit;">In my opinion, it looks like an assembly of a huge LEGO designer. </font><font style="vertical-align: inherit;">Right at the beginning before you the instruction and a scattering of fine details. </font><font style="vertical-align: inherit;">And so, you take the instruction, according to which you systematically assemble them into small blocks, then you merge them into something more, even more ... And you catch the buzz from this damn fascinating process, you catch the buzz on how logical and thoughtful everything is All these parts fit together. </font><font style="vertical-align: inherit;">And now - in front of you is a whole tractor, or a dump truck. </font><font style="vertical-align: inherit;">And this is awesome!</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In programming, the same thing, only the role of instructions is performed by knowledge of patterns, principles of class design, best practices of programming and building architectures. And when you soak it all up and learn how to put it into practice, you begin to catch the buzz from work, the same as when assembling a LEGO. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But try building a constructor without an instruction ... This thought is like nonsense. However, programmers without all this knowledge work fine. For years. And this does not seem to them nonsense - they do not even understand that they are doing something wrong. Instead, they complain that they were given too little time. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And if in the afterword of the </font></font><a href="http://habrahabr.ru/post/211739/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">previous post</font></font></a>   ,   -     ,      . ,      ,   . <br><br>   ,       ‚Äú  ‚Äù, ‚Äú   ,   ‚Äù,  ‚Äú   ‚Äù ‚Äî    . ,     .   , ,   ,  : ‚Äú     -   ‚Äù? <br><br>     .     ,  ,     .  Amen. <br><br>   ) </div><p>Source: <a href="https://habr.com/ru/post/264417/">https://habr.com/ru/post/264417/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264405/index.html">Ministry of Defense accused of sending sensitive information through public postal services</a></li>
<li><a href="../264407/index.html">Buying the best apartment with R</a></li>
<li><a href="../264409/index.html">Min-plus polynomials, cyclic games, and Hilbert's theorem on zeros</a></li>
<li><a href="../264411/index.html">The rhythm of the gameplay - why do we need a base</a></li>
<li><a href="../264415/index.html">Implementing web consoles in the jvm process using the SonarQube example</a></li>
<li><a href="../264419/index.html">Method of Lyapunov functions in the problem of the Janibekov effect</a></li>
<li><a href="../264421/index.html">Grinding CSS Animation</a></li>
<li><a href="../264423/index.html">Isomorphic Application with React and Redux</a></li>
<li><a href="../264425/index.html">CometQL - api of work from comets server using MySQL protocol</a></li>
<li><a href="../264427/index.html">Limited offer: a cloud server in the Netherlands and the United States at the price of hosting, cheaper ip-address</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>