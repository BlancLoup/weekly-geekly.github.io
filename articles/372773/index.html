<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write our firmware for Sonoff TH10 / 16 modules</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently on Geektimes there was a review about ITEAD TH10 modules . I want to share the experience of developing their own firmware for these devices....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write our firmware for Sonoff TH10 / 16 modules</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/40c/321/74d/40c32174da2b4d90aa534a7d6afd2fc7.jpg"></div><br>  Recently on Geektimes there was a <a href="https://geektimes.ru/company/coolrf/blog/281410/">review about ITEAD TH10 modules</a> .  I want to share the experience of developing their own firmware for these devices. <br><a name="habracut"></a><br>  <a href="https://www.itead.cc/wiki/Sonoff_Smart_Home_Solution">SONOFF is a series of switches, sockets and other devices of the ‚ÄúInternet of Things‚Äù category from ITEAD</a> .  They are characterized by a fairly low price, the use of the ‚Äúpeople's WiFi module‚Äù ESP8266 and work in its own service, located in the cloud Amazon AWS global server. <br><br>  For these modules there are third-party firmware.  For example, the <a href="https://github.com/arendst/Sonoff-MQTT-OTA">MQTT OTA collected from the ESP SDK</a> or the <a href="https://github.com/arendst/Sonoff-MQTT-OTA-Arduino">same but in the Arduino IDE</a> <br><br>  I want to share the experience of creating my own firmware for Sonnoff in the Ardiono IDE environment. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I liked the Sonoff modules right away.  Starting from packaging: <br><br><img src="https://habrastorage.org/files/867/4c6/f38/8674c6f38ab244cb8a71f6c0e2bb18b0.jpg"><br><br>  Appearance: <br><br><img src="https://habrastorage.org/files/65f/902/057/65f902057e484228a54d080979a14cbc.jpg"><br><br><img src="https://habrastorage.org/files/47a/48e/f66/47a48ef66dd44e1ebf7b8405570da1fd.jpg"><br><br>  High-quality assembly and soldering: <br><br><img src="https://habrastorage.org/files/217/b43/b8b/217b43b8b38242aea04e3f8ff2268b24.jpg"><br><br><img src="https://habrastorage.org/files/cc4/ea5/033/cc4ea5033ff2412f89217b535ddbbb73.jpg"><br><br>  And ending with a <a href="https://www.itead.cc/wiki/images/3/39/Sonoff_TH10A%252816A%2529_schmatic.pdf">sophisticated circuitry</a> , in which the transistors for load control, pull-up and matching resistors and conders clearly did not spare. <br><br><img src="https://habrastorage.org/files/acb/00f/0bd/acb00f0bd2b949a982a15a10abf87f83.jpg"><br><br><img src="https://habrastorage.org/files/b33/fac/5e4/b33fac5e40ab46cc92c509a14c086347.jpg"><br><br>  With the support and documentation of its devices, ITEAD can plug many famous manufacturers into the belt, not bothering to publish technical details on their hardware.  And the <a href="https://www.itead.cc/wiki/Product">list of ITEAD products is quite impressive.</a> <br><br>  In essence, the Sonoof TH10 / 16 is an ESP8266 with a network power supply unit, peripherals in the form of relays, LEDs, temperature and humidity sensors, with a connection block and in a decent package. <br><br><img src="https://habrastorage.org/files/30a/afe/bbb/30aafebbb9fa456f96690875aae1e888.jpg"><br><br>  I‚Äôll omit the description of how to connect Sonoff to a cloud service and manage the eWeLink application on a smartphone.  In my opinion, it is completely inapplicable when control of controllers depends on the Internet and account in some cloud, even on Amazon servers.  Therefore, we leave the eWeLink application to demonstrate the capabilities of Sonoff and write our control program. <br><br>  To do this, you need to solder the 4-pin connector for connecting to a USB / TTL converter. <br><br><img src="https://habrastorage.org/files/657/898/41e/65789841e1384941a4611c1c0e7c6489.jpg"><br><br>  Having a negative experience of flashing Sonoff POW, I highly recommend that all programming work be carried out with the Sonoff power section disconnected and powered via pin 3.3V. <br><br>  My last USB / TTL heroically died along with the Sonoff POW module, so I‚Äôm using an Arduino UNO with a RESET plugged in to connect to the ground.  The 3.3-volt Una stabilizer does an excellent job with the ESP8266 load and the entire periphery of the module. <br><br><img src="https://habrastorage.org/files/489/bf4/be9/489bf4be94a249d1aa1282b9a1c1bcd2.jpg"><br><br>  As a development environment, I will use the Arduino IDE for the ease of installation and abundance of ready-made libraries and examples, although as an experienced programmer I still think that <b>VI</b> and <b>make</b> is enough for developing programs of any complexity))). <br><br>  How to install the ESP8266 Cire for Arduiono IDE devoted a lot of material on the Internet.  From myself I want to recommend the <a href="https://www.arduino.cc/en/Main/OldSoftwareReleases">version of Arduino IDE 1.6.5</a> , as having the least glitches when working with ESP. <br><br><img src="https://habrastorage.org/files/c25/150/745/c25150745d554788a33292fb6717b687.jpg"><br><br>  Since the board has a 1 MB memory chip installed, select the appropriate configuration when booting into the Board Manager: <br><br><img src="https://habrastorage.org/files/63c/95e/5d1/63c95e5d1a4d49b3993484622e635a49.jpg"><br><br>  Now it is enough to press the Sonoff controller button and distort the power, the device switches to the firmware download mode. <br><br><img src="https://habrastorage.org/files/200/7b4/59f/2007b459f173468c955a627896f8627b.jpg"><br><br>  In order to program the controller itself, you need to understand which ports are connected to what.  To do this, you can use the scheme on the ITEAD website, the link to which I gave above and the tester. <br><br>  So, what we have: <br><br><blockquote>  GPIO0 - button (this is understandable when we turned on the bootloader) <br>  GPIO12 - red LED and relay <br>  GPIO13 - Blue LED <br>  GPIO14 and GPIO4 are connected to the sensor connector. </blockquote><br>  Moreover, both sensors are single-wire and use GPIO14.  GPIO4 still needs to be enabled with a jumper on the board. <br><br>  Yes.  Not much, although more than ESP01. <br><br>  GPIO2 and GPIO15 have pull-up resistors on the board, you can solder to them.  GPIO5 and ADC are not soldered at all, and you need to connect directly to the ESP chip.  Leave these four outputs alone and proceed to programming. <br><br><div class="spoiler">  <b class="spoiler_title">Sketch blinking LEDs on sonoff</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** *  SONOFF TH10/16 * Copyright 2016   * http://samopal.pro */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;arduino.h&gt; uint8_t PIN_RELAY = 12; uint8_t PIN_LED2 = 13; void setup() { pinMode(PIN_RELAY,OUTPUT); pinMode(PIN_LED2, OUTPUT); }</span></span></span></span></code> </pre> <br></div></div><br>  LEDs work in antiphase.  Blue lights up when it is low.  The relay should not operate due to lack of 5V power.  In the future, I will use a blue LED to display various modes.  <a href="https://geektimes.ru/post/270592/">I wrote about this in detail in this article.</a> <br><br>  I will not dwell on the button in detail.  Yes, the control buttons, I wrote a convenient library that catches long and short press, auto-repeat with a long press and presses the bounce of contacts.  <a href="http://samopal.pro/arduino-button-2/">I described all this in detail in my blog</a> . <br><br>  Now the sensors.  I was sent a temperature / humidity sensor AM2301 and a DS18B20 temperature sensor in a waterproof design. <br><br><img src="https://habrastorage.org/files/6c2/7a2/819/6c27a28198de4c48a0125fbc0e8ce7c3.jpg"><br><br>  AM2301 is compatible with the DHT21 sensor.  His work requires a DHT library.  There are a lot of Forks of the DHT library, I recommend taking the <a href="https://github.com/adafruit/DHT-sensor-library">version from Adafruit in which there is an autotune on the controller frequency and which works correctly on ESP8266</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Sketch work with the sensor AM2301</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** *  SONOFF TH10/16 * Copyright 2016   * http://samopal.pro */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;arduino.h&gt; // DHT  Adafruit // https://github.com/adafruit/DHT-sensor-library #include &lt;DHT.h&gt; uint8_t PIN_DHT = 14; DHT dht(PIN_DHT, AM2301); void setup() { //     Serial.begin(115200); Serial.printf("DHT init ..."); dht.begin(); } void loop() { delay(1000); Serial.print("Temperature="); Serial.print(dht.readTemperature(),1); Serial.println(" C"); Serial.print("Humidity="); Serial.print(dht.readHumidity(),0); Serial.println("%"); }</span></span></span></span></code> </pre><br></div></div><br><img src="https://habrastorage.org/files/f1e/c1d/0fc/f1ec1d0fcb76455fb49e0eea8531c611.jpg"><br><br>  To connect to the DS18B20, the OneWire library is needed.  Fully compatible with ESP <a href="https://github.com/PaulStoffregen/OneWire">multiplatform version of this library.</a> <br><br>  The algorithm for polling the sensor is taken from the example: <br><br><div class="spoiler">  <b class="spoiler_title">Sketch work with sensor DS18B20</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** *  SONOFF TH10/16 * Copyright 2016   * http://samopal.pro */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;arduino.h&gt; //   // https://github.com/PaulStoffregen/OneWire #include &lt;OneWire.h&gt; #define ERROR_VALUE 2147483647 float GetDS18X20(); uint8_t PIN_DS = 14; OneWire ds(PIN_DS); void setup() { //     Serial.begin(115200); Serial.printf("DS18B20 init ..."); } void loop() { delay(1000); float t = GetDS18X20(); if( t!= ERROR_VALUE ){ Serial.print("Temperature="); Serial.print(t,1); Serial.println(" C"); } } /** *    */ float GetDS18X20(){ byte i; byte present = 0; byte type_s; byte data[12]; byte addr[8]; float celsius; if ( !ds.search(addr)) { // Serial.println("DS18B20: No more addresses."); ds.reset_search(); delay(250); return ERROR_VALUE; } if (OneWire::crc8(addr, 7) != addr[7]) { // Serial.println("DS1820: CRC is not valid!"); return ERROR_VALUE; } // the first ROM byte indicates which chip switch (addr[0]) { case 0x10: type_s = 1; break; case 0x28: type_s = 0; break; case 0x22: type_s = 0; break; default: // Serial.println("Device is not a DS18x20 family device."); return ERROR_VALUE; } ds.reset(); ds.select(addr); ds.write(0x44, 1); // start conversion, with parasite power on at the end delay(1000); // maybe 750ms is enough, maybe not // we might do a ds.depower() here, but the reset will take care of it. present = ds.reset(); ds.select(addr); ds.write(0xBE); // Read Scratchpad for ( i = 0; i &lt; 9; i++) { // we need 9 bytes data[i] = ds.read(); } // Convert the data to actual temperature // because the result is a 16 bit signed integer, it should // be stored to an "int16_t" type, which is always 16 bits // even when compiled on a 32 bit processor. int16_t raw = (data[1] &lt;&lt; 8) | data[0]; if (type_s) { raw = raw &lt;&lt; 3; // 9 bit resolution default if (data[7] == 0x10) { // "count remain" gives full 12 bit resolution raw = (raw &amp; 0xFFF0) + 12 - data[6]; } } else { byte cfg = (data[4] &amp; 0x60); // at lower res, the low bits are undefined, so let's zero them if (cfg == 0x00) raw = raw &amp; ~7; // 9 bit resolution, 93.75 ms else if (cfg == 0x20) raw = raw &amp; ~3; // 10 bit res, 187.5 ms else if (cfg == 0x40) raw = raw &amp; ~1; // 11 bit res, 375 ms //// default is 12 bit resolution, 750 ms conversion time } celsius = (float)raw / 16.0; return celsius; }</span></span></span></span></code> </pre><br></div></div><br><img src="https://habrastorage.org/files/d06/e75/23d/d06e7523d75d4fb9bc8bcd075153c686.jpg"><br><br>  Well, the periphery works.  Next, I use my existing experiences.  <a href="https://github.com/samopal-pro/custom_th10">Completely all the firmware can be taken from here.</a> <br><br>  <u><b>Features of the firmware:</b></u> <br><ul><li>  Automatic detection of sensors AM2301 and DS18B20 </li><li>  Long press the button - on / off access point mode </li><li>  A short press of a button - on / off relay </li><li>  Blue LED is on - connection established, double flash - no connection, single flash - access point mode </li><li>  Local WEB server in access point mode 192.168.4.1 </li><li>  when connecting to WiFi at the IP address that is configured </li><li>  Authorization of access by password.  By default admin / 12345 </li><li>  Saving parameters to a server on the Internet using a regular HTTP request.  You can configure any server, for example, national monitoring.  And you can also local without any Internet. </li><li>  Saving settings to EEPROM </li><li>  When connecting to the Internet, setting the time by NTP </li></ul><br><img src="https://habrastorage.org/files/98a/13b/55f/98a13b55f63c45faa93beed49f00e714.jpg"><br><br><img src="https://habrastorage.org/files/a12/f76/2b2/a12f762b2cc141e8bac22a0499cddc3f.jpg"><br><br>  For lovers of ready services.  the ready-made library MQTT, BLYNK, etc. is easily screwed. But this is already beyond the scope of this article. <br><br><h3>  Total </h3><br>  SONOFF is a convenient platform primarily for those who can independently develop and modify control programs. <br><br>  For those familiar with the ESP8266 - Sonoff is the savings on assembly, soldering and parts, provided that you need just such a device configuration, as laid down in a specific Sonoff module. <br><br>  The biggest disadvantage of these modules is that part of the GPIO is not divorced into connectors.  Well, ITEAD company should make a comb with 8 pin and get there all the free GPIO from ESP.  I think the popularity of such modules at the current price would greatly increase. <br><br>  As for specific applications, <a href="https://geektimes.ru/post/270142/">such a controller</a> can be fully implemented on the Sonoff TH10 module. </div><p>Source: <a href="https://habr.com/ru/post/372773/">https://habr.com/ru/post/372773/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../372763/index.html">Kingston DC400: capacious SSD for reasonable money</a></li>
<li><a href="../372765/index.html">Archiver</a></li>
<li><a href="../372767/index.html">Nobel Week: Why did the medal become a prize for scientific achievements?</a></li>
<li><a href="../372769/index.html">Physics in the animal world: sea turtles and their "compass"</a></li>
<li><a href="../372771/index.html">More fun and efficient: how to use music for work and where to look for it</a></li>
<li><a href="../372775/index.html">In memory of Churyumov Klim Ivanovich dedicated: "His among the stars and comets"</a></li>
<li><a href="../372777/index.html">IoT-solution for transport: the path from idea to production</a></li>
<li><a href="../372779/index.html">Six Real-life ThinkPad Survival Stories</a></li>
<li><a href="../372781/index.html">Microsoft's speech recognition system has reached the human level</a></li>
<li><a href="../372783/index.html">The book "Ontogenesis. From cell to person "</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>