<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Stack implementation details - part one</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago I wrote that ‚Äúlinks‚Äù are not ‚Äúaddresses‚Äù when it comes to C # and the placement of its objects in memory. Although this is true, but thi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Stack implementation details - part one</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/7be/1bd/2a7/7be1bd2a7f99a260c143f716039329ce.jpg" align="right" alt="image"><br>  Some time ago I wrote that <a href="http://blogs.msdn.com/ericlippert/archive/2009/02/17/references-are-not-addresses.aspx">‚Äúlinks‚Äù are not ‚Äúaddresses‚Äù</a> when it comes to C # and the placement of its objects in memory.  Although this is true, but this is just a implementation detail, but not the meaning of a ‚Äúreference‚Äù.  Another implementation detail that is often confused with the essence is that "memory for significant types (value types) is allocated on the stack."  I often see this <a href="http://msdn.microsoft.com/en-us/library/system.valuetype.aspx">because it is written in our documentation</a> . <br><br>  Virtually every article I see describes in detail (often incorrectly) what a stack is and what the main difference between significant and reference types is that significant types are located on the stack.  I am sure you can find many examples of such articles on the web. <br><a name="habracut"></a><br><br>  I believe that the definition of meaningful types, which is based on implementation details, and not on their observable behavior, is both confusing and not entirely correct.  The most significant characteristic of an object of a significant type is not how it is located in memory, but how they behave from the point of view of semantics: ‚Äúobjects of significant types‚Äù are always transmitted ‚Äúby value‚Äù, i.e.  are copied.  If the main differences between reference and significant types were in the details of memory location, we would call them ‚Äútypes on the heap‚Äù and ‚Äútypes on the stack‚Äù.  But in general, it has nothing to do with the essence.  In general, it is important that instances of significant types are copied and compared. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Unfortunately, the documentation is not focused on the most significant characteristics, but it is focused on the implementation details and misses the essence of the significant types.  I would very much like all those articles that explain ‚Äúwhat a stack is‚Äù instead to explain what ‚Äúcopy by value‚Äù is and how misunderstanding this mechanism can cause errors. <br><br>  The statement that significant types are placed on the stack is not true in the general case.  The documentation on MSDN correctly noted that significant types are placed on the stack sometimes.  For example, an int field in a reference type is part of an object of this type and, like the entire object, its field is located on the heap.  The same story with local variables that fall into the closure of anonymous methods (*), because they essentially become fields of a hidden class and are also located on the heap, so local variables can be located on the heap even if they are of a meaningful type. <br><br>  In short, we have an explanation that explains nothing.  Rejecting performance considerations what else, in terms of developer expectations, can force CLRjitter to place an int variable on the stack, and not on the heap?  Nothing, as long as the specification is not violated, the system can choose the most effective code generation strategy. <br><br>  Yeah, no one promised that the operating system on top of which is implemented CLI provides an array of 1 megabyte called "stack".  Windows typically does this and this one megabyte array is a great place to efficiently store small objects with a short lifetime, but there are no requirements or guarantees that the operating system provides this kind of structure or that jitter will use it.  In principle, Jitter can decide to create all local variables on the heap, despite the loss of performance, this will work as long as the semantic requirements for the relevant types are met. <br><br>  It is even worse to think that the significant types are ‚Äúfast and small‚Äù and the reference types are ‚Äúlarge and slow‚Äù.  Indeed, significant types can be generated by jitter in the code on the stack, which is very fast both when allocating and clearing the memory.  But at the same time, large structures created on the heap, such as an array of elements of a significant type, are also created very quickly, provided that they are initialized with default values.  And reference types occupy additional space in memory.  And of course there are such conditions when significant types give a big performance gain.  But in the vast majority of programs, how local variables are created and destroyed cannot be a bottleneck in terms of performance. <br><br>  Nano optimizations for turning reference types into meaningful ones that yield several nanoseconds are not worth it.  This should be done only if the profiler data showed that there are real problems that can be solved by using meaningful types instead of reference ones.  I have no such data.  When choosing to use a reference or significant type, I am always guided by how the type that I create should behave semantically. <br><br>  (*) also holds for an iterator block. <br><br><blockquote>  From the translator: recently I again had the opportunity to conduct several interviews and often to the question ‚Äúwhat are significant and reference types‚Äù I heard ‚Äúsignificant types are types whose instances are located on the stack, and reference types are types whose instances are located in heap. "  So before you is a translation of an article by Eric Lippert, which is very old, but has not lost its relevance.  I tried to make the translation as readable and easy to read in Russian as possible, so that it differs significantly from the original in form but not in meaning. </blockquote></div><p>Source: <a href="https://habr.com/ru/post/221861/">https://habr.com/ru/post/221861/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../221851/index.html">Lists with different item types and different data providers</a></li>
<li><a href="../221853/index.html">Automatic text category detection</a></li>
<li><a href="../221855/index.html">Serious games</a></li>
<li><a href="../221857/index.html">PKI (Public Key Infrastructure) using javascript? This is now possible using the PKIjs and ASN1js libraries.</a></li>
<li><a href="../221859/index.html">May 16, a seminar on sales of storage systems will start - ‚ÄúStorage technology and systems for SMB customers‚Äù</a></li>
<li><a href="../221863/index.html">Where to start your extension for Photoshop, Illustrator, etc. on HTML5</a></li>
<li><a href="../221865/index.html">OpenStack large-scale benchmarking: How we tested the Mirantis OpenStack in SoftLayer</a></li>
<li><a href="../221867/index.html">Way of the lark</a></li>
<li><a href="../221869/index.html">Analysis of tasks of the Russian Design Cup 2013. Task about smart watches</a></li>
<li><a href="../221871/index.html">Spam bot Stealrat</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>