<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Deploy Elixir Applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is participating in a contest from Wunsh.ru - the Russian-speaking community of Elixir. Practices and just sympathizers - join us ! 


 T...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Deploy Elixir Applications</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/c17/830/61d/c1783061d0d44b48a0adab6b4fa31175.png" alt="Deploy Exilir Applications"></p><br><p>  This article is participating in a contest from <a href="http://wunsh.ru/">Wunsh.ru</a> - the Russian-speaking community of Elixir.  Practices and just sympathizers - <a href="http://wunsh.ru/news/2016/first-contest.html">join us</a> ! </p><br><p> The article describes the process of setting up an application for release on a remote server.  For such a not easy business in the world of Elixir, there are two good projects, the first is <code>Distillery</code> , which makes the application build and the second is <code>Edeliver</code> , which allows hot-swappable code.  Below are the basic instructions for using these two libraries on the example of the simplest Elixir application.  As well as the article will tell how to improve deploy through the use of <code>docker</code> containers. </p><br><h1 id="distillery">  Distillery </h1><br><p>  <code>Distillery</code> designed to automate the generation of releases of Elixir projects!  He is an <a href="https://github.com/bitwalker/exrm">Exrm</a> heir from the same author.  Very easy to use. </p><br><p>  The first thing you need to add <code>distillery</code> in the project.  And then run <code>mix deps.get</code> . </p><a name="habracut"></a><br><pre> <code class="hljs sql">def application <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> [ <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span>: {Single, []}, applications: [:logger, :cowboy, :plug] ] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defp deps <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> [{:cowboy, <span class="hljs-string"><span class="hljs-string">"~&gt; 1.1.2"</span></span>}, {:plug, <span class="hljs-string"><span class="hljs-string">"~&gt; 1.3.0"</span></span>}, {:distillery, <span class="hljs-string"><span class="hljs-string">"~&gt; 1.0"</span></span>}] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  To create a configuration file for a <code>distillery</code> , the following command should be executed in the project directory: </p><br><pre> <code class="hljs swift">mix release.<span class="hljs-keyword"><span class="hljs-keyword">init</span></span></code> </pre> <br><p>  This command will create a <code>rel</code> directory with the <code>config.exs</code> file.  <code>Distillery</code> has a large number of <a href="https://hexdocs.pm/distillery/configuration.html">customizable parameters</a> .  The file generated automatically came right away. </p><br><p>  In order to make a build application for deployment in "combat" mode, you must run the following command: </p><br><pre> <code class="hljs pgsql">MIX_ENV=prod mix <span class="hljs-keyword"><span class="hljs-keyword">release</span></span> <span class="hljs-comment"><span class="hljs-comment">--env=prod</span></span></code> </pre> <br><p>  This command will create a <code>_build/prod/rel/&lt;name&gt;/releases/&lt;version&gt;/&lt;name&gt;.tar.gz</code> with the compiled application.  Further, this archive must be delivered to the prod.  server where you need to unzip and run the application.  This can be done using a simple <code>shell</code> script, but this is not the best option, since it will be downtime. </p><br><div class="spoiler">  <b class="spoiler_title">deploy.sh</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk">#!/bin/sh <span class="hljs-type"><span class="hljs-type">REMOTE_USER</span></span>=<span class="hljs-comment"><span class="hljs-comment">"www"</span></span> <span class="hljs-type"><span class="hljs-type">REMOTE_HOST</span></span>=<span class="hljs-comment"><span class="hljs-comment">"host"</span></span> <span class="hljs-type"><span class="hljs-type">APP_NAME</span></span>=<span class="hljs-comment"><span class="hljs-comment">"single"</span></span> <span class="hljs-type"><span class="hljs-type">APP_FOLDER</span></span>=<span class="hljs-comment"><span class="hljs-comment">"/home/$REMOTE_USER/$APP_NAME"</span></span> <span class="hljs-type"><span class="hljs-type">SERVER</span></span>=<span class="hljs-string"><span class="hljs-string">$R</span></span>EMOTE_USER@<span class="hljs-string"><span class="hljs-string">$R</span></span>EMOTE_HOST echo <span class="hljs-comment"><span class="hljs-comment">"Enter the version of the application"</span></span> read <span class="hljs-type"><span class="hljs-type">VERSION</span></span> if !(ssh <span class="hljs-string"><span class="hljs-string">$S</span></span>ERVER <span class="hljs-comment"><span class="hljs-comment">"[ -d $APP_FOLDER/tmp/ ]"</span></span>) then echo <span class="hljs-comment"><span class="hljs-comment">"Preparing directory structure"</span></span> ssh <span class="hljs-string"><span class="hljs-string">$S</span></span>ERVER <span class="hljs-comment"><span class="hljs-comment">"mkdir -p $APP_FOLDER/tmp/"</span></span> fi echo <span class="hljs-comment"><span class="hljs-comment">"Copying release to server in $APP_FOLDER"</span></span> scp _build/prod/rel/<span class="hljs-string"><span class="hljs-string">$A</span></span>PP_NAME/releases/<span class="hljs-string"><span class="hljs-string">$V</span></span>ERSION/<span class="hljs-string"><span class="hljs-string">$A</span></span>PP_NAME.tar.gz <span class="hljs-string"><span class="hljs-string">$S</span></span>ERVER:<span class="hljs-string"><span class="hljs-string">$A</span></span>PP_FOLDER/tmp/ echo <span class="hljs-comment"><span class="hljs-comment">"Stopping the old version"</span></span> ssh <span class="hljs-string"><span class="hljs-string">$S</span></span>ERVER <span class="hljs-comment"><span class="hljs-comment">"cd $APP_FOLDER &amp;&amp; bin/$APP_NAME stop"</span></span> echo <span class="hljs-comment"><span class="hljs-comment">"Extracting archive with release"</span></span> ssh <span class="hljs-string"><span class="hljs-string">$S</span></span>ERVER <span class="hljs-comment"><span class="hljs-comment">"cd $APP_FOLDER/tmp/ &amp;&amp; tar -xzf $APP_NAME.tar.gz -C $APP_FOLDER"</span></span> echo <span class="hljs-comment"><span class="hljs-comment">"Running the new version"</span></span> ssh <span class="hljs-string"><span class="hljs-string">$S</span></span>ERVER <span class="hljs-comment"><span class="hljs-comment">"cd $APP_FOLDER &amp;&amp; PORT=80 bin/$APP_NAME start"</span></span></code> </pre> </div></div><br><p>  It remains only to check the availability of the offer. </p><br><pre> <code class="hljs sql">curl -i http://host HTTP/1.1 200 OK server: Cowboy date: Thu, 09 Feb 2017 11:28:08 GMT content-length: 9 <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span>-control: <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-age=<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>, must-revalidate <span class="hljs-keyword"><span class="hljs-keyword">content</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>/plain; charset=utf-8 Single v1</code> </pre> <br><p>  You can simplify the delivery of the application on the prod.  server using <code>Edeliver</code> . </p><br><h1 id="edeliver">  Edeliver </h1><br><p>  <code>Edeliver</code> is essentially an add-on written on Elixir over a <a href="https://github.com/gerhard/deliver">set of bash scripts</a> that can build and deploy Elixir and Erlang applications, as well as perform hot code updates. </p><br><p>  The first step is to add <code>edeliver</code> to the project dependencies.  And then run <code>mix deps.get</code> . </p><br><pre> <code class="hljs sql">def application <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> [ <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span>: {Single, []}, applications: [:logger, :cowboy, :plug, :edeliver] ] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defp deps <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> [{:cowboy, <span class="hljs-string"><span class="hljs-string">"~&gt; 1.1.2"</span></span>}, {:plug, <span class="hljs-string"><span class="hljs-string">"~&gt; 1.3.0"</span></span>}, {:distillery, <span class="hljs-string"><span class="hljs-string">"~&gt; 1.0"</span></span>}, {:edeliver, <span class="hljs-string"><span class="hljs-string">"~&gt; 1.4.2"</span></span>}] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  All settings for <code>Edeliver</code> are stored in a <code>.deliver/config</code> file.  In it, you can specify all sorts of environments.  For example BUILD, STAGING and PRODUCTION. </p><br><pre> <code class="hljs objectivec">APP=<span class="hljs-string"><span class="hljs-string">"single"</span></span> BUILD_HOST=<span class="hljs-string"><span class="hljs-string">"host"</span></span> BUILD_USER=<span class="hljs-string"><span class="hljs-string">"www"</span></span> BUILD_AT=<span class="hljs-string"><span class="hljs-string">"/home/www/single/tmp"</span></span> PRODUCTION_HOSTS=<span class="hljs-string"><span class="hljs-string">"host"</span></span> PRODUCTION_USER=<span class="hljs-string"><span class="hljs-string">"www"</span></span> DELIVER_TO=<span class="hljs-string"><span class="hljs-string">"/home/www/single"</span></span></code> </pre> <br><p>  In order to make a build application for deployment in "combat" mode, you must run the following command: </p><br><pre> <code class="hljs pgsql">env MIX_ENV=prod mix edeliver build <span class="hljs-keyword"><span class="hljs-keyword">release</span></span></code> </pre> <br><p>  Then, to deliver the build to the right environment (in this case, production), you need to do: </p><br><pre> <code class="hljs pgsql">mix edeliver deploy <span class="hljs-keyword"><span class="hljs-keyword">release</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> production <span class="hljs-comment"><span class="hljs-comment">--version=0.1.0</span></span></code> </pre> <br><p>  This command will only download the collected release to a remote server, but will not launch the application itself. <br>  To launch an application, use the following command: </p><br><pre> <code class="hljs pgsql">mix edeliver <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> production</code> </pre> <br><p>  If you did a build in a non-production environment, you can get a non-working application.  This is due to the fact that when assembling an application, NIFs (native implemented functions) are used, which on different machines may be ... different. </p><br><p>  It remains only to check the availability of the offer. </p><br><pre> <code class="hljs sql">curl -i http://host HTTP/1.1 200 OK server: Cowboy date: Thu, 09 Feb 2017 11:28:08 GMT content-length: 9 <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span>-control: <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-age=<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>, must-revalidate <span class="hljs-keyword"><span class="hljs-keyword">content</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>/plain; charset=utf-8 Single v2</code> </pre> <br><h1 id="nemnogo-o-docker-i-distillery">  A bit about Docker and Distillery </h1><br><p>  I have nothing to tell here, better read the excellent <a href="https://wunsh.ru/articles/elixir-deploy-1.html">translation from Wunsh of</a> this article <a href="http://teamon.eu/2017/deploying-phoenix-to-production-using-docker/">http://teamon.eu/2017/deploying-phoenix-to-production-using-docker/</a> </p><br><h1 id="heroku">  Heroku </h1><br><p>  Deploying Elixir applications on Heroku is very simple, all you need is to add a buildpack to an existing application. </p><br><pre> <code class="hljs swift">heroku buildpacks:<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> https:<span class="hljs-comment"><span class="hljs-comment">//github.com/HashNuke/heroku-buildpack-elixir</span></span></code> </pre> <br><p>  Or create a new application with this buildpack. </p><br><pre> <code class="hljs pgsql">heroku <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-comment"><span class="hljs-comment">--buildpack "https://github.com/HashNuke/heroku-buildpack-elixir.git"</span></span></code> </pre> <br><p>  This buildpack can be configured using the example from the <a href="https://github.com/HashNuke/heroku-buildpack-elixir">official repository</a> . </p><br><p>  Then, as you are used to, just do: </p><br><pre> <code class="hljs perl">git <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> heroku master</code> </pre> <br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  If you are interested in the functional programming language Elixir or you are just sympathetic, then I advise you to join the Telegram channel <a href="https://telegram.me/proelixir">https://telegram.me/proelixir</a> about Elixir. </p><br><p>  In the domestic Elixir community, a single platform begins to appear in the face of the <a href="http://wunsh.ru/">Wunsh.ru</a> project.  Now the project has a thematic newsletter, in which there is nothing illegal, once a week will receive a letter with a collection of articles about Elixir in Russian. </p><br><h1 id="literatura">  Literature </h1><br><p>  <a href="http://bitwalker.org/posts/2016-07-21-distillery-vs-exrm-vs-relx/">http://bitwalker.org/posts/2016-07-21-distillery-vs-exrm-vs-relx/</a> <br>  <a href="https://shovik.com/blog/6-deploying-phoenix-apps-for-rails-developers">https://shovik.com/blog/6-deploying-phoenix-apps-for-rails-developers</a> <br>  <a href="https://github.com/bitwalker/distillery">https://github.com/bitwalker/distillery</a> <br>  <a href="https://github.com/boldpoker/edeliver">https://github.com/boldpoker/edeliver</a> <br>  <a href="https://github.com/HashNuke/heroku-buildpack-elixir">https://github.com/HashNuke/heroku-buildpack-elixir</a> <br>  <a href="http://blog.plataformatec.com.br/2016/06/deploying-elixir-applications-with-edeliver/">http://blog.plataformatec.com.br/2016/06/deploying-elixir-applications-with-edeliver/</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/320096/">https://habr.com/ru/post/320096/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320084/index.html">Pure javascript. Testing. Formatting Comments</a></li>
<li><a href="../320086/index.html">Past and Future of IT Service Management (ITSM)</a></li>
<li><a href="../320088/index.html">The art of defensive programming</a></li>
<li><a href="../320090/index.html">Are bots and channels popular in messengers?</a></li>
<li><a href="../320092/index.html">Maintainers do not scale</a></li>
<li><a href="../320098/index.html">UIColor and UIImage in Xcode 8 using literals</a></li>
<li><a href="../320100/index.html">Development of SELinux-module for the application</a></li>
<li><a href="../320102/index.html">Upgrading features and infrastructure of free video conferencing 3CX WebMeeting</a></li>
<li><a href="../320104/index.html">About ScalaCheck. Generators (Part 2)</a></li>
<li><a href="../320106/index.html">VulnHub: Immerse yourself in hacking in the style of the TV series Mr. Robot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>