<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Calling methods through reflection</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All Java programmers explicitly or implicitly use reflection to invoke methods. Even if you didn‚Äôt do it yourself, the libraries or frameworks that yo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Calling methods through reflection</h1><div class="post__text post__text-html js-mediator-article"><p>  All Java programmers explicitly or implicitly use reflection to invoke methods.  Even if you didn‚Äôt do it yourself, the libraries or frameworks that you use will probably do it for you.  Let's see how this call is arranged inside and how fast it is.  We will look in OpenJDK 8 with the latest updates. </p><a name="habracut"></a><br><p>  Start learning is actually with the method <a href="">Method.invoke</a> .  Three things are done there: </p><br><ul><li>  The permissions of the method are checked. </li><li> <code>MethodAccessor</code> is created and remembered if it is not already there (if this method has not yet been called through reflection). </li><li>  Called by <code>MethodAccessor.invoke</code> . </li></ul><br><p>  Access verification consists of two parts.  A quick check establishes that both the method and the class containing it have <code>public</code> modifiers.  If this is not the case, then it is verified that the calling class has access to this method.  To find out the calling class, use the private method <code>Reflection.getCallerClass()</code> .  Some people, by the way, like to use it in their code.  In Java 9, a public <a href="http://openjdk.java.net/jeps/259">Stack-Walking API</a> will appear and it will be extremely reasonable to switch to it. </p><br><p>  It is known that access checks can be canceled by calling <code>method.setAccessible(true)</code> in advance.  This setter sets the <code>override</code> flag to ignore checks.  Even if you know that your method is public, setting <code>setAccessible(true)</code> will save some time on checks. </p><br><p>  Let's see how many different scenarios eat up the time.  Let's write a simple class with public and non-public methods: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; Person(String name) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.name = name; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> name; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> name; } }</code> </pre> <br><p>  We write a <a href="http://openjdk.java.net/projects/code-tools/jmh/">JMH</a> test, parameterized with two flags: <code>accessible</code> and <code>nonpublic</code> .  This will be our preparation: </p><br><pre> <code class="java hljs">Method method; Person p; <span class="hljs-meta"><span class="hljs-meta">@Setup</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ method = Person.class.getDeclaredMethod(nonpublic ? <span class="hljs-string"><span class="hljs-string">"getName2"</span></span> : <span class="hljs-string"><span class="hljs-string">"getName1"</span></span>); method.setAccessible(accessible); p = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Person(String.valueOf(Math.random())); }</code> </pre> <br><p>  And the benchmark itself: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Benchmark</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reflect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (String) method.invoke(p); }</code> </pre> <br><p>  I see the following results (3 forks, 5x500ms warm-up, 10x500ms measurement): </p><br><table><thead><tr><th>  (accessible) </th><th>  (nonpublic) </th><th>  Time </th></tr></thead><tbody><tr><td>  true </td><td>  true </td><td>  5,062 ¬± 0,056 ns / op </td></tr><tr><td>  true </td><td>  false </td><td>  5,042 ¬± 0,032 ns / op </td></tr><tr><td>  false </td><td>  true </td><td>  6.078 ¬± 0.039 ns / op </td></tr><tr><td>  false </td><td>  false </td><td>  5,835 ¬± 0,028 ns / op </td></tr></tbody></table><br><p>  Indeed, if <code>setAccessible(true)</code> executed, the result is the fastest.  At the same time, it makes no difference whether or not the public method.  If <code>setAccessible(false)</code> , then both tests are slower and the non-public method is slightly slower than the public one.  But I expected the difference to be stronger.  It mainly helps here that <code>Reflection.getCallerClass()</code> is an intrinsic of the JIT compiler, which in most cases is <a href="">replaced by just</a> a compile-time <a href="">constant</a> : if the JIT compiler inline calls Method.invoke, it knows what method it inlines, and It means and knows what it should return to <code>getCallerClass()</code> .  Further verification is essentially reduced to comparing the package of the called and calling classes.  If the package were different, another class hierarchy would be checked. </p><br><p>  What happens next?  Next you need to create a <code>MethodAccessor</code> object.  By the way, despite the fact that <code>Person.class.getMethod("getName")</code> will always return a new instance of the <code>Method</code> object used inside <code>MethodAccessor</code> will be reused through the <a href="">root</a> field, which, of course, is nice.  However, <code>getMethod</code> itself <code>getMethod</code> much slower than a call, so if you plan to call a method several times, it is wise to store the <code>Method</code> object. </p><br><p>  Creating <code>MethodAccessor</code> 's <a href="">ReflectionFactory</a> .  Here we see two scenarios that are controlled by the global settings of the JVM: </p><br><ul><li>  If the <code>-Dsun.reflect.noInflation=true</code> option is <code>-Dsun.reflect.noInflation=true</code> (disabled by default), an auxiliary class is generated immediately, which will launch the target method. </li><li>  Otherwise, a <code>DelegatingMethodAccessorImpl</code> wrapper is created, inside which <code>NativeMethodAccessorImpl</code> is placed.  In turn, he <a href="">considers</a> how many times this method was called.  If the number of calls has exceeded the threshold specified by <code>-Dsun.reflect.inflationThreshold</code> (default 15), then the accessor is inflated: an auxiliary class is generated, as in the first scenario.  If the threshold is not reached, the call goes honestly through JNI.  Although the implementation on the C ++ side is <a href="">trivial</a> , the overhead for JNI is quite high. </li></ul><br><p>  Let's see what will happen to our test if you enable <code>-Dsun.reflect.noInflation=true</code> and if you use only JNI (for this we set a large threshold <code>-Dsun.reflect.inflationThreshold=100000000</code> ): </p><br><table><thead><tr><th>  (accessible) </th><th>  (nonpublic) </th><th>  Default </th><th>  noInflation </th><th>  JNI-only </th></tr></thead><tbody><tr><td>  true </td><td>  true </td><td>  5,062 ¬± 0,056 </td><td>  4,935 ¬± 0,375 </td><td>  195,960 ¬± 1,873 </td></tr><tr><td>  true </td><td>  false </td><td>  5.042 ¬± 0.032 </td><td>  4,914 ¬± 0,329 </td><td>  194,722 ¬± 1,151 </td></tr><tr><td>  false </td><td>  true </td><td>  6.078 ¬± 0.039 </td><td>  5,638 ¬± 0,050 </td><td>  196,196 ¬± 0,910 </td></tr><tr><td>  false </td><td>  false </td><td>  5,835 ¬± 0,028 </td><td>  5.520 ¬± 0.042 </td><td>  194.626 ¬± 0.918 </td></tr></tbody></table><br><p>  Hereinafter, all results are in nanoseconds per operation.  As expected, JNI is significantly slower, so it is unnecessary to include such a mode.  Curiously, the noInflation mode was slightly faster.  This is due to the fact that there is no <code>DelegatingMethodAccessorImpl</code> , which removes the need for one indirect addressing.  By default, the call goes through <code>Method ‚Üí DelegatingMethodAccessorImpl ‚Üí GeneratedMethodAccessorXYZ</code> , and with this option the chain is reduced to <code>Method ‚Üí GeneratedMethodAccessorXYZ</code> .  Calling <code>Method ‚Üí DelegatingMethodAccessorImpl</code> monomorphic and easy to virtualize, but indirect addressing still remains. </p><br><p>  By the way, about devirtualization.  It is worth noting that our benchmark is bad, because it does not reflect the situation in a real program.  In the benchmark, we call only one method through reflection, which means we have only one generated accessor, which is also easily devirtualized and even inline.  In a real application this does not happen: there are many accessors.  To emulate this situation, let's optionally poison the type profile in the <code>setup</code> method: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(polymorph) { Method method2 = Person.class.getMethod(<span class="hljs-string"><span class="hljs-string">"toString"</span></span>); Method method3 = Person.class.getMethod(<span class="hljs-string"><span class="hljs-string">"hashCode"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;<span class="hljs-number"><span class="hljs-number">3000</span></span>; i++) { method2.invoke(p); method3.invoke(p); } }</code> </pre> <br><p>  Please note that we did not change the code, the performance of which we measure.  We just made a few thousand seemingly useless calls before this.  However, these useless calls will spoil the picture a bit: JIT sees that there are a lot of options and cannot substitute the only possible one, making an honest virtual call now.  The results will be as follows (poly is a variant with the transformation of a method call into a polymorphic, does not affect JNI) </p><br><table><thead><tr><th>  (acc) </th><th>  (nonpub) </th><th>  Default </th><th>  Default / poly </th><th>  noInflation </th><th>  noInflation / poly </th><th>  JNI-only </th></tr></thead><tbody><tr><td>  true </td><td>  true </td><td>  5,062 ¬± 0,056 </td><td>  6,848 ¬± 0,031 </td><td>  4,935 ¬± 0,375 </td><td>  6,509 ¬± 0,032 </td><td>  195,960 ¬± 1,873 </td></tr><tr><td>  true </td><td>  false </td><td>  5.042 ¬± 0.032 </td><td>  6.847 ¬± 0.035 </td><td>  4,914 ¬± 0,329 </td><td>  6,490 ¬± 0,037 </td><td>  194,722 ¬± 1,151 </td></tr><tr><td>  false </td><td>  true </td><td>  6.078 ¬± 0.039 </td><td>  7.855 ¬± 0.040 </td><td>  5,638 ¬± 0,050 </td><td>  7.661 ¬± 0.049 </td><td>  196,196 ¬± 0,910 </td></tr><tr><td>  false </td><td>  false </td><td>  5,835 ¬± 0,028 </td><td>  7.568 ¬± 0.046 </td><td>  5.520 ¬± 0.042 </td><td>  7.111 ¬± 0.058 </td><td>  194.626 ¬± 0.918 </td></tr></tbody></table><br><p>  As you can see, the virtual call adds about 1.5-1.8 ns on my hardware - even more than access checks.  It is important to remember that the behavior of a virtual machine in a microbenchmark may differ significantly from that in a real application, and, if possible, recreate conditions close to reality.  Here, of course, is still far from reality: at a minimum, all the necessary objects in the processor L1 cache and garbage collection do not occur, because there is no garbage. </p><br><p>  Some might think cool, they say that with <code>-Dsun.reflect.noInflation=true</code> everything becomes faster.  Let only 0.3 ns, but still.  Yes, plus the first 15 calls will accelerate.  Yes, and the working set has slightly decreased, we save the processor cache - solid pluses!  Add an option in production and we'll live!  So do not.  In the benchmark, we tested one scenario, and in nature there are others.  For example, some code may call many different methods once.  With this option, the accessor will be generated immediately on the first call.  And how much does it cost?  How long is the accessor generated? </p><br><p>  To evaluate this, you can use reflection to clear the private <code>Method.methodAccessor</code> field (by clearing <code>Method.root</code> ), forcing it to initialize the accessor again.  Recording the field through reflection is well optimized, so the test will not slow down much.  We get these results.  Top line - previously obtained results (polymorph, accessible), for comparison: </p><br><table><thead><tr><th>  (test) </th><th>  Default </th><th>  noInflation </th><th>  Jni </th></tr></thead><tbody><tr><td>  invoke </td><td>  6,848 ¬± 0,031 </td><td>  6,509 ¬± 0,032 </td><td>  195,960 ¬± 1,873 </td></tr><tr><td>  reset + invoke </td><td>  227.133 ¬± 9.159 </td><td>  100195,746 ¬± 2060,810 </td><td>  236,900 ¬± 2,042 </td></tr></tbody></table><br><p>  As you can see, if the accessor is reset, then by default the performance becomes slightly worse than in the version with JNI.  But if we completely refuse from JNI, then we get 100 microseconds to launch the method.  Generation and loading of a class in runtime compared to a single method call (even through JNI) is, of course, monstrously slow.  Therefore, the default behavior "to try 15 times through JNI and only then generate a class" seems extremely reasonable. </p><br><p>  In general, remember that there is no magic option that will speed up any application.  If she was, she would be enabled by default.  What is the point of hiding it from people?  Perhaps there is an option that will speed up your application specifically, but do not take on faith any advice like "cut -XX: + MakeJavaFaster, and everything will fly." </p><br><p>  What do these generated accessors look like?  The bytecode is generated in the <a href="">MethodAccessorGenerator</a> class using the rather trivial low-level <a href="">ClassFileAssembler</a> API, which is somewhat similar to the abbreviated <a href="http://asm.ow2.org/">ASM</a> library.  Classes <a href="">are given the names of the</a> form <code>sun.reflect.GeneratedMethodAccessorXYZ</code> , where <code>XYZ</code> is a global synchronized counter, you can see them in the graph trace and debugger. </p><br><p>  The generated class exists only in memory, but we can easily dump it to disk by adding a line to the <a href="">ClassDefiner.defineClass</a> method </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Files.write(Paths.get(name+<span class="hljs-string"><span class="hljs-string">".class"</span></span>), bytes); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(Exception ex) {}</code> </pre> <br><p>  After that, you can look at the class in the decompiler.  For our <code>getName1()</code> method, the following code was generated (FernFlower decompiler and manual variable renaming): </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GeneratedMethodAccessor1</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodAccessorImpl</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GeneratedMethodAccessor1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object target, Object[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> InvocationTargetException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(target == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NullPointerException(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Person person; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { person = (Person)target; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(args != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; args.length != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (NullPointerException | ClassCastException ex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(ex.toString()); } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> person.getName1(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Throwable ex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvocationTargetException(ex); } } } }</code> </pre> <br><p>  Notice how many extra things you have to do.  We need to check that we were given a non-empty object of the desired type and passed an empty argument list or <code>null</code> instead of the argument list (not everyone knows, but when called through the reflection method without arguments, we can pass <code>null</code> instead of an empty array).  In this case, you must carefully observe the contract: if <code>null</code> passed instead of an object, then throw a <code>NullPointerException</code> .  If you passed an object of another class, then <code>IllegalArgumentException</code> .  If an exception occurred while executing <code>person.getName1()</code> , then <code>InvocationTargetException</code> .  And this method has no arguments.  And if they are?  For example, let's call this method (for a change, now static and returning <code>void</code> ): </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Test</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String s, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{} }</code> </pre> <br><p>  Now the code is much larger: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GeneratedMethodAccessor1</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodAccessorImpl</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GeneratedMethodAccessor1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object target, Object[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> InvocationTargetException </span></span>{ String s; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(args.length != <span class="hljs-number"><span class="hljs-number">2</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(); } s = (String)args[<span class="hljs-number"><span class="hljs-number">0</span></span>]; Object arg = args[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Byte) { x = ((Byte)arg).byteValue(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Character) { x = ((Character)arg).charValue(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Short) { x = ((Short)arg).shortValue(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!(arg <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Integer)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(); } x = ((Integer)arg).intValue(); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (NullPointerException | ClassCastException ex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(ex.toString()); } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Test.test(s, x); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Throwable ex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvocationTargetException(ex); } } }</code> </pre> <br><p>  Notice that instead of <code>int</code> we have the right to pass <code>Byte</code> , <code>Short</code> , <code>Character</code> or <code>Integer</code> , and all of this must be transformed.  This is where the transformation goes.  Such a block will be added for each primitive argument where an expanding transformation is possible.  Now it‚Äôs also clear why catch is catching a <code>NullPointerException</code> : it can occur during anboxing and then we must also <code>IllegalArgumentException</code> .  But due to the fact that the method is static, we do not care at all that in the parameter <code>target</code> .  Well, the <code>return null</code> line appeared, because our method returns <code>void</code> .  All this magic is neatly painted in <a href="">MethodAccessorGenerator.emitInvoke</a> . </p><br><p>  This is how the method call works.  The constructors call is similarly arranged.  Also, this code is partially reused to deserialize objects.  When an accessor already exists, from the point of view of the JVM, it is not very different from the code that you would write yourself manually, so reflection starts working very quickly. </p><br><p>  In conclusion, starting with Java 7, the <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/invoke/package-summary.html">java.lang.invoke</a> API has appeared, which also allows you to call methods dynamically, but it works quite differently. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/318418/">https://habr.com/ru/post/318418/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318406/index.html">Google: Security Keys - the best way to secure your account</a></li>
<li><a href="../318410/index.html">PHP Digest number 99 - the results of 2016 and a selection of interesting links (December 11 - 25, 2016)</a></li>
<li><a href="../318412/index.html">Algorithm for secretly assigning donors to Secret Santa</a></li>
<li><a href="../318414/index.html">Briefly about leasing: you buy iron for a third of the price, but it stays with the seller</a></li>
<li><a href="../318416/index.html">Performance comparison of analytical Exasol and Oracle In-Memory Option DBMS</a></li>
<li><a href="../318424/index.html">Geography package: ready to go</a></li>
<li><a href="../318426/index.html">HikVision - stop China before it's too late</a></li>
<li><a href="../318428/index.html">"Emergency" suitcase animator</a></li>
<li><a href="../318430/index.html">"Digest 1cloud": 25 materials on security, the work of programmers and the experience of creating an IaaS provider</a></li>
<li><a href="../318432/index.html">"SLA in the cloud": what to look for</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>