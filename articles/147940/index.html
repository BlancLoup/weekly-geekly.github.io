<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Control of several servos with high accuracy on ATmega16 MK</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I was approached by acquaintances from a mock-up workshop and offered to work on a very interesting project. They needed to carry out a mode...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Control of several servos with high accuracy on ATmega16 MK</h1><div class="post__text post__text-html js-mediator-article">  Recently, I was approached by acquaintances from a mock-up workshop and offered to work on a very interesting project.  They needed to carry out a model in which the details of several machines (a crane, an excavator, a destroyer) would move.  The logic is simple, but the peculiarity is that they had to move at a speed that is much lower than the speed of the drives themselves, and this can only be done by passing through intermediate points.  In this article I want to introduce you to an interesting method of precise control of a large number of servos. <br><br>  In my case it was supposed to use four drives.  For this project, I made a small fee: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/007/b21/fcb/007b21fcb15d9d709310217a8ac310a1.jpg" alt="image"><br><a name="habracut"></a><br><img src="https://habrastorage.org/getpro/habr/post_images/c0a/903/640/c0a903640085cbf01b2a7ecbe4f73ff7.jpg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The board itself is simple - an Atmega16A-AU microcontroller, a stabilizer for the controller, two stabilizers on the drives, and a PLS connector for connecting the drives.  In my case, there was almost no load on the drives (servos moved with paper parts), so for the drives there was enough of a linear stabilizer on a small radiator. <br><br>  In drive management, I found the two most interesting articles in <a href="http://alex-exe.ru/radio/robotics/servo-pc/">alex-exe</a> and <a href="http://easyelectronics.ru/upravlenie-mnozhestvom-servomashinok.html">di halt</a> .  But in both methods there are certain disadvantages.  In the first case: it is necessary to cause an interruption too often, which slows down the fulfillment of the main loop hardly predictable and does not allow to obtain high positioning accuracy.  In its implementation, the drive jerks quite strongly, the installation accuracy is about 1 degree.  Actually, here is the video: <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/5tKhdHswxUE%3Ffeature%3Doembed&amp;xid=17259,1500008,15700022,15700186,15700190,15700253,15700255,15700259&amp;usg=ALkJrhhFzLiRGn1haUlW_3d-sK92Li9k2g" frameborder="0" allowfullscreen=""></iframe><br><br>  The DI HALT method assumes the formation in ascending order, that is, it is necessary to additionally calculate signals. <br><br>  In this regard, I want to propose another method that avoids both these difficulties. <br><br>  The principle of servo control is simple: it is necessary to send pulses with a duration of 0.8‚Äì2.3 ms with a period of 15‚Äì20 ms.  The pulse duration determines the position of the servo drive.  The proposed method involves the formation of pulses on the legs MK one by one, as shown in the figure. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ab5/87c/ad5/ab587cad5d8c69ea7fc50b011448c506.jpg" alt="image"><br><br>  To implement this method, only one timer is sufficient.  I set the timer to increase every microsecond.  The entire signal period is 18000 Œºs, the time for the formation of a single pulse is 4500 Œºs.  A timer interrupt when running four servos is called eight times.  Hence the limitation of the method: it will not work for one timer to hang more than 8 drives (in 20 ms, you can form a maximum of 8 pulses with a duration of 2.3 ms). <br><br>  Variables angle1-angle4 are angles in normalized units, varying in the main program loop.  To change the angle from 0 to 180 degrees, they must change from 800 to 2200. All control takes place in the interrupt handler.  When the timer is first triggered, the leg responsible for the first drive is set to one.  The value of the angle for this drive is also recorded in the OCR1A register.  The next time the leg is triggered, the leg is set to 0 and the number of ticks that is left until the end of the control period for one drive is recorded in the OCR1A register (I have 4500).  Then the same thing is done with the foot responsible for the second drive.  Thus, every 4.5 ms on one foot after another, an impulse of the required duration appears, and with an accuracy of up to 1 Œºs!  That is, the accuracy of the angle setting will be less than 10 minutes and is limited by the characteristics of the drive itself.  So, the code itself: <br><br><pre><code class="cpp hljs">ISR(TIMER1_COMPA_vect) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (takt == <span class="hljs-number"><span class="hljs-number">0</span></span>) { PORTC |= <span class="hljs-number"><span class="hljs-number">0b00000001</span></span>; OCR1A = angle1; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (takt == <span class="hljs-number"><span class="hljs-number">1</span></span>) { PORTC = PORTC &amp; <span class="hljs-number"><span class="hljs-number">0b11111110</span></span>; OCR1A = cycle - angle1; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (takt == <span class="hljs-number"><span class="hljs-number">2</span></span>) { PORTC |= <span class="hljs-number"><span class="hljs-number">0b00000010</span></span>; OCR1A = angle2; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (takt == <span class="hljs-number"><span class="hljs-number">3</span></span>) { PORTC = PORTC &amp; <span class="hljs-number"><span class="hljs-number">0b11111101</span></span>; OCR1A = cycle - angle2; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (takt == <span class="hljs-number"><span class="hljs-number">4</span></span>) { PORTC |= <span class="hljs-number"><span class="hljs-number">0b00000100</span></span>; OCR1A = angle3; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (takt == <span class="hljs-number"><span class="hljs-number">5</span></span>) { PORTC = PORTC &amp; <span class="hljs-number"><span class="hljs-number">0b11111011</span></span>; OCR1A = cycle - angle3; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (takt == <span class="hljs-number"><span class="hljs-number">6</span></span>) { PORTC |= <span class="hljs-number"><span class="hljs-number">0b00001000</span></span>; OCR1A = angle4; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (takt == <span class="hljs-number"><span class="hljs-number">7</span></span>) { PORTC = PORTC &amp; <span class="hljs-number"><span class="hljs-number">0b11110111</span></span>; OCR1A = cycle - angle4; } takt = takt + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (takt == <span class="hljs-number"><span class="hljs-number">9</span></span>) takt = <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><br>  I will not give the text of the whole program, I will just say that the corners in the main loop can be formed in any way - at least according to data from the UART, even from the ADC.  I actually scored with my hands where to go, where and how much to stand, etc.  I also had a toggle switch.  In the on position, the servos move according to the program, and when they turn off, they return to their original position.  If necessary, all the source code of the project can send to the mail. <br><br>  Here is a video of the four drives: <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/ywb8E4YyLcY%3Ffeature%3Doembed&amp;xid=17259,1500008,15700022,15700186,15700190,15700253,15700255,15700259&amp;usg=ALkJrhg9dgwuADGdQoRE4OJAkosBQolpag" frameborder="0" allowfullscreen=""></iframe><br><br>  Pay attention to the drive in the lower left corner - the movement is almost negligible!  This drive controls the boom of the crane.  I will add more about the drives themselves.  I got four different drives in my hands - two analog and two digital ones.  It is noteworthy that both analog drives could work normally only for a couple of minutes, and then start arbitrarily twitching, clamping in extreme positions, etc., although both drives were working - I checked it with a servo tester.  Digital drives performed everything clearly and stably for several hours in a row (and maybe a day).  I did not hear any complaints from the customer.  For the boom crane, I used the Hi-Tech drive, which changed its position with minimal steps. <br><br>  And finally - a photo of the layout.  Video, unfortunately, I can not post. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e14/a8c/690/e14a8c690bac99df4d3cea15b7fbf3a7.jpg" alt="image"><br><br>  <b>UPD:</b> <br>  The main article is now stored <a href="http://www.customelectronics.ru/servo-control/">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/147940/">https://habr.com/ru/post/147940/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147934/index.html">Metro Design Summer School Records</a></li>
<li><a href="../147936/index.html">Materials for learning SharePoint 2013 Preview</a></li>
<li><a href="../147937/index.html">Math for rogues</a></li>
<li><a href="../147938/index.html">How I watched a streaming torrent video from a computer on an Android tablet</a></li>
<li><a href="../147939/index.html">Craftsman opens handcuffs enhanced security keys from a 3D printer</a></li>
<li><a href="../147941/index.html">‚ÄúPenguins with a penny,‚Äù or Valve talk about their plans for Linux</a></li>
<li><a href="../147942/index.html">Yet another factory</a></li>
<li><a href="../147943/index.html">Obuchalka. The story of the iPhone manual</a></li>
<li><a href="../147944/index.html">Big Data: Backup can not be done without it</a></li>
<li><a href="../147945/index.html">We are looking for Milnera - Durova not to offer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>