<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>VoIP telephony. Asterisk. Non-standard approach to everything. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Exactly a year ago, our former colleagues turned to us with a proposal to take part in modifying the operator's VoIP engine. The task was reduced to a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>VoIP telephony. Asterisk. Non-standard approach to everything. Part 1</h1><div class="post__text post__text-html js-mediator-article"><p>  Exactly a year ago, our former colleagues turned to us with a proposal to take part in modifying the operator's VoIP engine.  The task was reduced to a complete rework of the personal account, ensuring the scaling of the system, creating a billing system, LCR, monitoring user expenses, controlling the duration of calls, analytics on calls.  The story ended sadly, because  The expanded functionality of the system we have laid down allegedly did not correspond to the TZ, which was not formalized on paper and is only in the heads of the managers of the operator.  Due to the fact that managers did not want to pay for the developed functionality, which the customer really liked, we broke off the relationship.  We did not have the NDA and we did not have a contract, so after consulting with colleagues we decided to put part of the developments into free access.  I think this will be a series of articles.  And let's start with the basic things and architecture. </p><a name="habracut"></a><br><p>  Every administrator who has dealt with IP telephony at least once in his life knows that IP telephony services can be provided to the final subscriber in several ways: </p><br><ul><li>  Rent a number from a carrier.  In this case, the user is given a personal login / password to which the phone number is "linked".  When using the login / password connection to connect to the operator‚Äôs equipment, the user can receive calls to the rented number and make calls to other subscribers from this number. </li><li>  Rent a block of numbers and connect via SIP Trunk (trunk).  When connecting via SIP Trunk, the service provider sends all calls to the numbers leased from this carrier to a pre-agreed IP address.  Depending on how the SIP trunk is organized, password authentication may or may not be used.  In this case, the installation of the correct CallerID, which the called party will see during outgoing calls lies on the shoulders of the IP PBX administrator. </li><li>  Buying DID numbers from telecom operators without buying outgoing traffic.  The operator simply redirects the call that came to this number to the specified server. </li><li>  Purchase outbound traffic.  There are quite a lot of telecom operators selling outbound traffic.  At the same time, depending on the tariff plan, the CallerID transmitted to the called party can be transmitted or lost when passing through the chain of terminating operators (delivering to the final client) traffic of the desired direction.  There are quite often cases when a call to a Moscow number through a Moscow operator can come from, say, a London number or from a Belgian number, because the route was cheaper. </li></ul><br><p>  Companies with offices in several countries or who wish to have a presence in another country can buy, for the convenience of their clients, a phone number in the UK, for example, and handle incoming calls in Moscow.  At the same time, the operator who provided them with such a number may not be engaged in the delivery of calls to the UK.  Some countries, such as the Republic of Belarus, do not provide numbers to non-residents. </p><br><p>  So, we proceed from the following initial requirements: </p><br><ol><li>  The server for receiving calls can be anywhere </li><li>  The number of servers is not limited. </li><li>  The number of telecom operators is not limited. </li><li>  Acceptance of a call can occur with any type of lease number (login / password or trunk) </li><li>  A call with a specific CallerID should occur only from that server and only from that account to which this CallerID is currently linked, or through an operator allowing you to change CallerID </li><li>  Calls between neighboring servers should be transparent without losing information about the called subscriber.  For example, redirecting a London number to an internal, mobile or landline phone in another region </li><li>  For outgoing calls, depending on the tariff plan, the cheapest route should be chosen with reservation through more expensive ones.  In order to control the quality of communication, it is necessary to ensure monitoring of ABR, ASR (statistical parameters determining the quality of communication in a given direction through a certain telephony node) </li><li>  If there are external users using the system, they should see their current balance and current conversations in realtime in realtime </li><li>  When the value of the current balance is less than a certain amount, the user should receive a voice message about the negative balance with the termination of the conversation </li><li>  The user must be able to make calls via a web browser (WebRTC) </li><li>  Processing servers for incoming and outgoing calls, as well as servers serving subscribers can be divided </li><li>  For analytics and call routing, geolocation of incoming and outgoing calls is required. </li></ol><br><p>  <em>A small remark: the described configuration is universal, but is more suitable for services with a customer-oriented direction, such as call centers, in cases where customer personalization is necessary and the client is tied to one manager or a group of managers.</em>  <em>Most of the described mechanisms are universal and can be effectively used in other configurations.</em> </p><br><p>  Quite a few requirements, so where to start?  Asterisk will accept and make calls, Application Server will be responsible for preparing calls in python, we will store all working data in MariaDB, and most of the logic will be implemented in the form of procedures.  This will allow us to maximally distance the logic of asterisk from unnecessary rules in the dialplan and provide scalability along with configuration unification. </p><br><h1 id="trafik">  Traffic </h1><br><p>  We will determine our traffic.  We need a presence say in Cyprus, America, the UK and Russia.  From the point of view of Russian traffic, it is more profitable to work through Russian telecom operators.  For example Vestkol, IPPort and others.  Russian (Moscow) operators also provide telephone numbers in codes 495 and 499 at a fairly reasonable price. We can provide a presence in Cyprus, in America and the United Kingdom by purchasing numbers from Zadarma, Multilel or someone else.  Since international calls from Russian operators are quite expensive, you can buy traffic from foreign operators for example VoiceBuy or VoxBeam. </p><br><p>  When connecting to the operator in the option "login / password" calls to our PBX will come from the IP address of the server of the operator on which the registration takes place.  However, in the case of outgoing calls, the server address may be different. </p><br><p>  When connecting to an operator via a SIP trunk, incoming calls can come from several servers from the operator's pool, and outgoing calls are made using a single DNS name, which in most cases contains several IP addresses.  As we have already defined, the operator may be able to replace CallerID for an outgoing call, which can be regulated by a tariff plan or contract.  Replacing CallerID (number substitution) in Russia for outgoing calls is prohibited.  With foreign operators, the situation is much simpler and the replacement of CallerID is fully supported. </p><br><h1 id="sozdayom-bazu-dannyh">  Create a database. </h1><br><p>  <em>Most of the data and tables published in this article are extracts from the core of the real database, with the exception of phone numbers and IP addresses</em> </p><br><p>  Due to the fact that we have multicurrency communication operators, the link to the currency table should be in the table of communication operators.  A little later we will consider the possibility of multi-currency recalculation of tariffs of operators. </p><br><div class="spoiler">  <b class="spoiler_title">Currency table</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`currency`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`iso`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHAR</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, <span class="hljs-string"><span class="hljs-string">`name_en`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, <span class="hljs-string"><span class="hljs-string">`name_ru`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, <span class="hljs-string"><span class="hljs-string">`numcode`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> ZEROFILL <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'numcode for country'</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> <span class="hljs-string"><span class="hljs-string">`iso`</span></span> (<span class="hljs-string"><span class="hljs-string">`iso`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">' , iso   '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span>=<span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> AUTO_INCREMENT=<span class="hljs-number"><span class="hljs-number">1</span></span> ;</code> </pre> </div></div><br><h2>  currency </h2><br><table><thead><tr><th>  id </th><th>  iso </th><th>  name_en </th><th>  name_ru </th><th>  numcode </th></tr></thead><tbody><tr><td>  96 </td><td>  RUB </td><td>  Russian ruble </td><td>  Russian ruble </td><td>  643 </td></tr><tr><td>  122 </td><td>  USD </td><td>  US Dollar </td><td>  U.S. dollar </td><td>  840 </td></tr><tr><td>  156 </td><td>  EUR </td><td>  Euro </td><td>  Euro </td><td>  978 </td></tr></tbody></table><br><div class="spoiler">  <b class="spoiler_title">Table operators</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`providers`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`providername`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, <span class="hljs-string"><span class="hljs-string">`currency_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>, <span class="hljs-string"><span class="hljs-string">`noncli_prefix`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, <span class="hljs-string"><span class="hljs-string">`cli_prefix`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, <span class="hljs-string"><span class="hljs-string">`premcli_prefix`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, <span class="hljs-string"><span class="hljs-string">`cli_allowed`</span></span> ENUM(<span class="hljs-string"><span class="hljs-string">'Y'</span></span>,<span class="hljs-string"><span class="hljs-string">'N'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'N'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, <span class="hljs-string"><span class="hljs-string">`dynamic_calls`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'N'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, <span class="hljs-string"><span class="hljs-string">`append_plus`</span></span> TINYINT(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'1'</span></span>, <span class="hljs-string"><span class="hljs-string">`dynamic_calls_caller_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> <span class="hljs-string"><span class="hljs-string">`FK_providers_currency`</span></span> (<span class="hljs-string"><span class="hljs-string">`currency_id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> <span class="hljs-string"><span class="hljs-string">`FK_providers_currency`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`currency_id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> <span class="hljs-string"><span class="hljs-string">`currency`</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">'       '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span>=<span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> AUTO_INCREMENT=<span class="hljs-number"><span class="hljs-number">1</span></span> ;</code> </pre> </div></div><br><h2>  providers </h2><br><table><thead><tr><th>  id </th><th>  providername </th><th>  currency_id </th><th>  noncli_prefix </th><th>  cli_prefix </th><th>  premcli_prefix </th><th>  cli_allowed </th><th>  dynamic_calls </th><th>  append_plus </th><th>  dynamic_calls_caller_id </th></tr></thead><tbody><tr><td>  3 </td><td>  Zadarma </td><td>  96 </td><td></td><td></td><td></td><td>  N </td><td>  N </td><td>  one </td><td></td></tr><tr><td>  four </td><td>  Multitel </td><td>  122 </td><td></td><td></td><td></td><td>  N </td><td>  N </td><td>  one </td><td></td></tr><tr><td>  7 </td><td>  Westcall </td><td>  96 </td><td></td><td></td><td></td><td>  Y </td><td>  N </td><td>  0 </td><td>  74951815283 </td></tr><tr><td>  eight </td><td>  Voxbeam </td><td>  122 </td><td>  0011103 </td><td>  0011101 </td><td>  0011102 </td><td>  Y </td><td>  Y </td><td>  one </td><td></td></tr><tr><td>  eleven </td><td>  Voicebuy </td><td>  122 </td><td>  9991 </td><td>  9992 </td><td>  9993 </td><td>  Y </td><td>  Y </td><td>  one </td><td></td></tr><tr><td>  sixteen </td><td>  IPport </td><td>  96 </td><td></td><td></td><td></td><td>  N </td><td>  N </td><td>  one </td><td></td></tr></tbody></table><br><p>  So.  Operators. </p><br><p>  Usually, foreign operators have 2-3 tariffs for which they deliver traffic to the called subscriber.  You can read about the differences between CLI and NonCLI techniques <a href="http://cheapestvoipcalls.net/voip-wholesale-termination-non-cli-vs-cli-routes/">here</a> . </p><br><p>  To select a tariff plan, the prefix ( <strong>noncli_prefix, cli_prefix, premcli_prefix</strong> ) is usually used <strong>,</strong> indicated before the called number in the process of forming the call line. </p><br><p>  Description of fields: </p><br><ul><li>  <strong>providername</strong> - name of the operator </li><li>  <strong>currency_id</strong> - operator's currency </li><li>  <strong>noncli_prefix</strong> - tariff without CLI support </li><li>  <strong>cli_prefix</strong> - tariff with CLI support </li><li>  <strong>premcli_prefix</strong> - premium rate </li><li>  <strong>cli_allowed</strong> - indicates that the operator allows you to change the CLI for outgoing calls </li><li>  <strong>dynamic_calls</strong> - indicates that the operator allows making calls in any direction with any CLI. </li><li>  <strong>append_plus</strong> - add or not add "+" before the called number.  Some of the operators require a "+", some do not. </li><li>  <strong>dynamic_calls_caller_id</strong> - CID for the default operator. </li></ul><br><p>  In the case of WestCall and other operators providing a connection via a SIP trunk, you buy a pool of numbers and, when making calls, you can change the outgoing number to any number from this pool.  IPPort, like other operators, when using the login / password scheme with a single purchased number, does not allow changing the outgoing number.  Operators VoxBeam and VoiceBuy are used for outgoing calls for any directions and allow you to change the outgoing number to any other.  The truth is there is one thing!  And it lies in the fact that the end telecom operators delivering the call to the called subscriber can reject the call or change the caller's number to their own if the calling number corresponds to the internal number of the country or area.  Those.  for example, when calling from Russia to Ukraine (Kiev), we change CallerID to a Ukrainian number in Kiev and the telecom operator through which the call is being made can simply call the call, because  it does not comply with the internal call processing policy "A call through an external incoming international trunk cannot contain internal numbers".  Operators Zadarma and Multitel will be used as number providers and we will not send outgoing traffic through them, although we could have done so if we wanted to. </p><br><p>  An important aspect of call processing is security.  Quite often there are situations when an incorrectly configured IP telephony server allows other calls to pass through.  To ensure the security of the circuits that process incoming and outgoing calls, in addition to separating operators into different contexts, it is worth creating a database of IP addresses of telecom operators providing us with communication services.  Firstly, it will allow you to configure the export of addresses in the firewall and remove unnecessary attempts to ‚Äúring out‚Äù through us, and secondly, it will provide more complete information about how to connect to telecom operators. </p><br><div class="spoiler">  <b class="spoiler_title">Table of IP addresses of telecom operators</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`providers_ips`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`provider_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>, <span class="hljs-string"><span class="hljs-string">`ipaddress`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'2130706433'</span></span>, <span class="hljs-string"><span class="hljs-string">`domainname`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, <span class="hljs-string"><span class="hljs-string">`direction`</span></span> ENUM(<span class="hljs-string"><span class="hljs-string">'IN'</span></span>,<span class="hljs-string"><span class="hljs-string">'OUT'</span></span>,<span class="hljs-string"><span class="hljs-string">'IN/OUT'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'IN'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, <span class="hljs-string"><span class="hljs-string">`proto`</span></span> ENUM(<span class="hljs-string"><span class="hljs-string">'SIP'</span></span>,<span class="hljs-string"><span class="hljs-string">'IAX2'</span></span>,<span class="hljs-string"><span class="hljs-string">'H323'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'SIP'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> <span class="hljs-string"><span class="hljs-string">`FK_providers_ips_providers`</span></span> (<span class="hljs-string"><span class="hljs-string">`provider_id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> <span class="hljs-string"><span class="hljs-string">`FK_providers_ips_providers`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`provider_id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> <span class="hljs-string"><span class="hljs-string">`providers`</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">'      . direction    / '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span>=<span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> AUTO_INCREMENT=<span class="hljs-number"><span class="hljs-number">1</span></span> ;</code> </pre> </div></div><br><h2>  providers_ips </h2><br><table><thead><tr><th>  id </th><th>  provider_id </th><th>  ipaddress </th><th>  domainname </th><th>  direction </th><th>  proto </th></tr></thead><tbody><tr><td>  one </td><td>  eight </td><td>  2130706433 </td><td>  sbc.voxbeam.com </td><td>  Out </td><td>  Sip </td></tr><tr><td>  2 </td><td>  eight </td><td>  1607694320 </td><td>  95.211.119.240 </td><td>  IN </td><td>  Sip </td></tr><tr><td>  7 </td><td>  3 </td><td>  2130706433 </td><td>  sip.zadarma.com </td><td>  Out </td><td>  Sip </td></tr><tr><td>  sixteen </td><td>  3 </td><td>  3106773121 </td><td>  proxy-1.fr.zadarma.com </td><td>  IN </td><td>  Sip </td></tr><tr><td>  17 </td><td>  3 </td><td>  3106773122 </td><td>  proxy-2.fr.zadarma.com </td><td>  IN </td><td>  Sip </td></tr><tr><td>  31 </td><td>  sixteen </td><td>  1506852360 </td><td>  89.208.190.8 </td><td>  IN </td><td>  Sip </td></tr><tr><td>  33 </td><td>  sixteen </td><td>  1506852357 </td><td>  89.208.190.5 </td><td>  IN </td><td>  Sip </td></tr><tr><td>  34 </td><td>  sixteen </td><td>  1506852354 </td><td>  sip.n1.ipport.net </td><td>  Out </td><td>  Sip </td></tr><tr><td>  35 </td><td>  eleven </td><td>  2991415097 </td><td>  sip.voicebuy.com </td><td>  Out </td><td>  Sip </td></tr><tr><td>  42 </td><td>  four </td><td>  3514573416 </td><td>  209.124.34.104 </td><td>  Out </td><td>  Sip </td></tr><tr><td>  44 </td><td>  7 </td><td>  3277775106 </td><td>  195.94.225.2 </td><td>  IN / OUT </td><td>  Sip </td></tr><tr><td>  51 </td><td>  four </td><td>  3514573417 </td><td>  209.124.34.105 </td><td>  IN </td><td>  Sip </td></tr><tr><td>  52 </td><td>  four </td><td>  3514573446 </td><td>  209.124.34.134 </td><td>  IN </td><td>  Sip </td></tr></tbody></table><br><p>  Description of fields: </p><br><ul><li>  <strong>provider_id</strong> specifies the binding of the address to the operator from the providers table </li><li>  <strong>ipaddress</strong> is an Int fqdn representation of the operator's server address for conversion using the built-in function INET_NTOA. </li><li>  <strong>The domainname</strong> indicates the fqdn server name of the operator of the call processing. </li><li>  <strong>direction</strong> indicates the call direction for the specified IP address (OUT to output only, IN to input only, IN / OUT to both input and output) </li><li>  <strong>proto</strong> specifies the protocol by which the interaction with the communication operator (SIP / IAX2 / H323) </li></ul><br><p>  Thus, a bunch of operator and addresses will look like this. </p><br><h2>  vw_providers </h2><br><table><thead><tr><th>  id </th><th>  providername </th><th>  proto </th><th>  aa </th><th>  direction </th></tr></thead><tbody><tr><td>  sixteen </td><td>  IPport </td><td>  Sip </td><td>  89.208.190.5 [89.208.190.5] </td><td>  IN </td></tr><tr><td>  sixteen </td><td>  IPport </td><td>  Sip </td><td>  sip.n1.ipport.net [89.208.190.2] </td><td>  Out </td></tr><tr><td>  sixteen </td><td>  IPport </td><td>  Sip </td><td>  89.208.190.8 [89.208.190.8] </td><td>  IN </td></tr><tr><td>  four </td><td>  Multitel </td><td>  Sip </td><td>  80.97.55.105 [80.97.55.105] </td><td>  IN </td></tr><tr><td>  four </td><td>  Multitel </td><td>  Sip </td><td>  209.124.34.104 [209.124.34.104] </td><td>  Out </td></tr><tr><td>  four </td><td>  Multitel </td><td>  Sip </td><td>  41.218.96.199 [41.218.96.199] </td><td>  IN </td></tr><tr><td>  eleven </td><td>  Voicebuy </td><td>  Sip </td><td>  sip.voicebuy.com [178.77.95.57] </td><td>  Out </td></tr><tr><td>  eight </td><td>  Voxbeam </td><td>  Sip </td><td>  sbc.voxbeam.com [127.0.0.1] </td><td>  Out </td></tr><tr><td>  eight </td><td>  Voxbeam </td><td>  Sip </td><td>  95.211.119.240 [95.211.119.240] </td><td>  IN </td></tr><tr><td>  7 </td><td>  Westcall </td><td>  Sip </td><td>  195.94.225.2 [195.94.225.2] </td><td>  IN / OUT </td></tr><tr><td>  3 </td><td>  Zadarma </td><td>  Sip </td><td>  proxy-1.fr.zadarma.com [185.45.152.129] </td><td>  IN </td></tr><tr><td>  3 </td><td>  Zadarma </td><td>  Sip </td><td>  proxy-3.ri.zadarma.com [195.122.19.11] </td><td>  IN </td></tr><tr><td>  3 </td><td>  Zadarma </td><td>  Sip </td><td>  siplv.zadarma.com [195.122.19.17] </td><td>  IN </td></tr><tr><td>  3 </td><td>  Zadarma </td><td>  Sip </td><td>  proxy-8.fr.zadarma.com [185.45.152.136] </td><td>  IN </td></tr><tr><td>  3 </td><td>  Zadarma </td><td>  Sip </td><td>  sip.zadarma.com [127.0.0.1] </td><td>  Out </td></tr><tr><td>  3 </td><td>  Zadarma </td><td>  Sip </td><td>  siplv1.zadarma.com [195.122.19.17] </td><td>  IN </td></tr><tr><td>  3 </td><td>  Zadarma </td><td>  Sip </td><td>  mediarelay-1.zadarma.com [185.45.152.162] </td><td>  IN </td></tr></tbody></table><br><p>  What is it for ? </p><br><ol><li>  An incoming call to the phone number we rented from a particular operator should come from the pool of IP addresses of the servers of this operator.  Therefore, at the time of an incoming call, it is worth checking the number associated with the operator with the table of IP addresses of the operator </li><li>  The operator may have several servers processing outgoing calls from our server, so this should be taken into account when forming the call queue </li><li>  This scheme allows you to instantly receive a call string.  In this case, replacing the domainname with the name of the trunk defined in sip.conf or iax.conf does not disrupt the operation of the system </li><li>  Numbers can be spread over several servers for fault tolerance, and can be rigidly assigned to each server.  It makes no sense to serve the call on the server to which this number is not attached. </li></ol><br><p>  Let's try to get a call string for the number 74957777777. </p><br><div class="spoiler">  <b class="spoiler_title">Call string request</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONCAT_WS</span></span>(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, pips.proto, pips.domainname, <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(p.append_plus <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span>,<span class="hljs-string"><span class="hljs-string">'+'</span></span>,<span class="hljs-string"><span class="hljs-string">''</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(p.cli_prefix,<span class="hljs-string"><span class="hljs-string">''</span></span>),<span class="hljs-number"><span class="hljs-number">74957777777</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> dial_string <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> providers_ips <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> pips <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> providers <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> p.id=pips.provider_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> pips.direction <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-string"><span class="hljs-string">'OUT'</span></span>, <span class="hljs-string"><span class="hljs-string">'IN/OUT'</span></span>)</code> </pre> </div></div><br><h2>  Dialer prompt </h2><br><table><thead><tr><th>  dial_string </th></tr></thead><tbody><tr><td>  Sip / sip.zadarma.com/74957777777 </td></tr><tr><td>  Sip / westcall / 74957777777 </td></tr><tr><td>  Sip / sbc.voxbeam.com/001110174957777777 </td></tr><tr><td>  Sip / sip.voicebuy.com/999274957777777 </td></tr><tr><td>  SIP / sip.n1.ipport.net / + 74957777777 </td></tr></tbody></table><br><p>  As we see, we received ready data for dialing, which need to be transferred to the Dial application of the Asterisk server.  Let's stop on this for now. </p><br><p>  To bind the numbers leased from the carrier, we need to specify a list of servers on which these numbers will be serviced. </p><br><div class="spoiler">  <b class="spoiler_title">Server table</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`servers`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`servername`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, <span class="hljs-string"><span class="hljs-string">`location`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'country code where server is located'</span></span>, <span class="hljs-string"><span class="hljs-string">`ipaddress`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'2130706433'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'localhost by default'</span></span>, <span class="hljs-string"><span class="hljs-string">`comment`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, <span class="hljs-string"><span class="hljs-string">`sip`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'SIP URI'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, <span class="hljs-string"><span class="hljs-string">`iax2`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'IAX2 address and user binding if rsa keys used'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, <span class="hljs-string"><span class="hljs-string">`iax2control`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'IAX2 address and control user binding for pair and route control'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, <span class="hljs-string"><span class="hljs-string">`protocol`</span></span> ENUM(<span class="hljs-string"><span class="hljs-string">'SIP'</span></span>,<span class="hljs-string"><span class="hljs-string">'IAX2'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'SIP'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">'   '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span>=<span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> AUTO_INCREMENT=<span class="hljs-number"><span class="hljs-number">1</span></span> ;</code> </pre> </div></div><br><h2>  servers </h2><br><table><thead><tr><th>  id </th><th>  servername </th><th>  location </th><th>  ipaddress </th><th>  comment </th><th>  sip </th><th>  iax2 </th><th>  iax2control </th><th>  protocol </th></tr></thead><tbody><tr><td>  0 </td><td>  undefined </td><td>  0 </td><td>  2130706433 </td><td>  0 </td><td></td><td></td><td></td><td>  Sip </td></tr><tr><td>  one </td><td>  asterisk-macomnet </td><td>  189 </td><td>  3557129729 </td><td>  0 </td><td>  SIP / 212.5.126.1 </td><td>  IAX2 / macomnet @ macomnet </td><td>  IAX2 / macomnetcontrol @ macomnet </td><td>  IAX2 </td></tr><tr><td>  2 </td><td>  asterisk-msm </td><td>  189 </td><td>  1506807809 </td><td>  0 </td><td>  SIP / 89.208.16.1 </td><td>  IAX2 / msm @ msm </td><td>  IAX2 / msmcontrol @ msm </td><td>  IAX2 </td></tr><tr><td>  five </td><td>  asterisk-corbina </td><td>  189 </td><td>  1399234817 </td><td>  0 </td><td>  SIP / 83.102.161.1 </td><td>  IAX2 / corbina @ corbina </td><td>  IAX2 / corbinacontrol @ corbina </td><td>  IAX2 </td></tr></tbody></table><br><p>  Description of fields: </p><br><ul><li>  <strong>servername</strong> - internal server name </li><li>  <strong>location</strong> - the geographical area in which the server is located.  In this case, Russia </li><li>  <strong>ipaddress</strong> - real server IP address </li><li>  <strong>sip</strong> - SIP URL to connect to the server </li><li>  <strong>iax2</strong> - RSA key <strong>combination</strong> with server identifier for call forwarding between servers </li><li>  <strong>iax2control</strong> is a special command channel for remote server management and server-to-server communication.  Team length up to 80 characters </li><li>  <strong>protocol</strong> - information field for sorting by interserver communication type </li></ul><br><p>  What is this table for and why is it so strange?  For the inter-server connection of asterisk servers, it is most convenient to use the IAX protocol.  There are several reasons: </p><br><ol><li>  all transit traffic between servers can be encrypted </li><li>  Unlike the SIP protocol, it is easier to get communication operators through the firewall (all you need is 1 UDP port) </li><li>  the inability to connect to the attacker with the server without the presence of encryption keys </li><li>  the ability to transfer data between servers.  for example, session variables.  In the SIP protocol, you can add data to the headers of session packets, but often superfluous headers are simply ‚Äúcleaned‚Äù by intermediate servers from the packets.  In the IAX protocol, you can transfer the necessary variables in the stream before establishing the connection. </li><li>  precise binding of the host and user / key combinations to the context on the server </li></ol><br><div class="spoiler">  <b class="spoiler_title">approximate iax.conf config on one of the servers</b> <div class="spoiler_text"><pre> <code class="hljs coffeescript">[macomnet] type=user username=macomnet auth=rsa inkeys=asterisk-corbina:asterisk-msm context=incoming_dialer encryption=<span class="hljs-literal"><span class="hljs-literal">yes</span></span> qualify=<span class="hljs-literal"><span class="hljs-literal">yes</span></span> disallow=all allow=gsm allow=ulaw [msm] type=peer host=<span class="hljs-number"><span class="hljs-number">89.208</span></span><span class="hljs-number"><span class="hljs-number">.16</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> username=msm auth=rsa outkey=asterisk-macomnet encryption=<span class="hljs-literal"><span class="hljs-literal">yes</span></span> qualify=<span class="hljs-literal"><span class="hljs-literal">yes</span></span> disallow=all allow=gsm allow=ulaw trunk=<span class="hljs-literal"><span class="hljs-literal">yes</span></span> [corbina] type=peer host=<span class="hljs-number"><span class="hljs-number">83.102</span></span><span class="hljs-number"><span class="hljs-number">.161</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> username=corbina auth=rsa outkey=asterisk-macomnet encryption=<span class="hljs-literal"><span class="hljs-literal">yes</span></span> qualify=<span class="hljs-literal"><span class="hljs-literal">yes</span></span> disallow=all allow=gsm allow=ulaw trunk=<span class="hljs-literal"><span class="hljs-literal">yes</span></span></code> </pre> </div></div><br><p>  With the servers initially figured out.  Now you need to bind the rented numbers to a specific server.  This is necessary for correct call routing. </p><br><div class="spoiler">  <b class="spoiler_title">Number table</b> <div class="spoiler_text"><p>  CREATE TABLE <code>numbers_pool</code> ( <br>  <code>id</code> INT (11) UNSIGNED NOT NULL AUTO_INCREMENT, <br>  <code>number</code> VARCHAR (50) NULL DEFAULT '0' COMMENT 'The rented number' COLLATE 'is utf8mb4_unicode_ci', <br>  <code>provider_id</code> INT (11) UNSIGNED NOT NULL DEFAULT '0' COMMENT 'Attaching a number to the operator', <br>  <code>server_id</code> INT (11) UNSIGNED NOT NULL DEFAULT '0' COMMENT 'Attaching a number to the server', <br>  <code>enabled</code> BIT (1) NOT NULL DEFAULT b'1 'COMMENT' Enabling / disabling number ', <br>  <code>direction</code> ENUM ('IN', 'OUT', 'IN / OUT') NULL DEFAULT 'IN' COMMENT 'The default call direction is' COLLATE 'utf8mb4_unicode_ci', <br>  <code>virtualflag</code> BIT (1) NOT NULL DEFAULT b'1 'COMMENT' Virtual or real number ', <br>  <code>echotest</code> TINYINT (1) UNSIGNED NOT NULL DEFAULT '0' COMMENT 'Testing the number 0/1 - off / on', <br>  PRIMARY KEY ( <code>id</code> ) <br>  UNIQUE INDEX <code>number</code> ( <code>number</code> ), <br>  INDEX <code>FK_number_assignment_copy_providers</code> ( <code>provider_id</code> ), <br>  INDEX <code>FK_number_assignment_servers</code> ( <code>server_id</code> ), <br>  INDEX <code>number btree</code> ( <code>number</code> ) <br>  CONSTRAINT <code>FK_provider</code> FOREIGN KEY ( <code>provider_id</code> ) REFERENCES <code>providers</code> ( <code>id</code> ), <br>  CONSTRAINT <code>FK_server</code> FOREIGN KEY ( <code>server_id</code> ) REFERENCES <code>servers</code> ( <code>id</code> ) <br>  ) <br>  COLLATE = 'utf8mb4_unicode_ci' <br>  ENGINE = InnoDB <br>  AUTO_INCREMENT = 1 <br>  ; </p></div></div><br><h2>  numbers_pool </h2><br><table><thead><tr><th>  id </th><th>  number </th><th>  provider_id </th><th>  server_id </th><th>  enabled </th><th>  direction </th><th>  virtualflag </th><th>  echotest </th></tr></thead><tbody><tr><td>  125 </td><td>  37167859001 </td><td>  four </td><td>  one </td><td>  one </td><td>  IN </td><td>  one </td><td>  0 </td></tr><tr><td>  126 </td><td>  37167859002 </td><td>  four </td><td>  one </td><td>  one </td><td>  IN </td><td>  one </td><td>  0 </td></tr><tr><td>  278 </td><td>  4971122954000 </td><td>  four </td><td>  one </td><td>  0 </td><td>  IN </td><td>  one </td><td>  0 </td></tr><tr><td>  279 </td><td>  74951815000 </td><td>  7 </td><td>  one </td><td>  one </td><td>  IN / OUT </td><td>  0 </td><td>  0 </td></tr><tr><td>  280 </td><td>  74951815001 </td><td>  7 </td><td>  one </td><td>  one </td><td>  IN / OUT </td><td>  0 </td><td>  0 </td></tr><tr><td>  281 </td><td>  74951815002 </td><td>  7 </td><td>  one </td><td>  one </td><td>  IN / OUT </td><td>  0 </td><td>  0 </td></tr><tr><td>  426 </td><td>  74951339501 </td><td>  3 </td><td>  2 </td><td>  0 </td><td>  IN / OUT </td><td>  one </td><td>  0 </td></tr><tr><td>  427 </td><td>  74951339502 </td><td>  3 </td><td>  one </td><td>  0 </td><td>  IN / OUT </td><td>  one </td><td>  0 </td></tr><tr><td>  515 </td><td>  74957952301 </td><td>  sixteen </td><td>  one </td><td>  one </td><td>  IN / OUT </td><td>  0 </td><td>  0 </td></tr><tr><td>  516 </td><td>  74957952302 </td><td>  sixteen </td><td>  2 </td><td>  one </td><td>  IN / OUT </td><td>  0 </td><td>  0 </td></tr><tr><td>  529 </td><td>  442038070121 </td><td>  eleven </td><td>  one </td><td>  one </td><td>  IN </td><td>  one </td><td>  0 </td></tr><tr><td>  531 </td><td>  442038070123 </td><td>  eleven </td><td>  one </td><td>  one </td><td>  IN </td><td>  one </td><td>  0 </td></tr></tbody></table><br><p>  Description of fields: </p><br><ul><li>  <strong>number</strong> - number in international format </li><li>  <strong>provider_id</strong> - binding the number to the operator </li><li>  <strong>server_id</strong> - binding the number to the server </li><li>  <strong>enabled</strong> - serve calls on this number or not </li><li>  <strong>direction</strong> - number accepted by call directions </li><li>  <strong>virtualflag</strong> - the number is "real" or "virtual".  "Real" numbers are tied to dialperes, "virtual" numbers are not bound </li><li>  <strong>echotest</strong> - enable the number test mode.  if the mode is on, the call is redirected to the Asterisk server's Echo () application </li></ul><br><p>  At the time of developing the system, the number of leased numbers was about 400, the number of servers was 4. To test call routing, they even added a Multiphone from Megaphone.  When using "real" numbers associated with the login / password, it is necessary to ensure the implementation of the call through the correct dialpyr.  Since asterisk cannot know through which dialpere a call should be routed, it is necessary to create a table of connections. </p><br><div class="spoiler">  <b class="spoiler_title">Table of numbers and dialpeer</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`gates`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`numbers_pool_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>, <span class="hljs-string"><span class="hljs-string">`serverid`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>, <span class="hljs-string"><span class="hljs-string">`gatename`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, <span class="hljs-string"><span class="hljs-string">`gatenumber`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, <span class="hljs-string"><span class="hljs-string">`cid_support`</span></span> ENUM(<span class="hljs-string"><span class="hljs-string">'Y'</span></span>,<span class="hljs-string"><span class="hljs-string">'N'</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, <span class="hljs-string"><span class="hljs-string">`contextname`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, <span class="hljs-string"><span class="hljs-string">`comment`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> <span class="hljs-string"><span class="hljs-string">`name_number`</span></span> (<span class="hljs-string"><span class="hljs-string">`gatename`</span></span>, <span class="hljs-string"><span class="hljs-string">`gatenumber`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> <span class="hljs-string"><span class="hljs-string">`FK_gates_servers`</span></span> (<span class="hljs-string"><span class="hljs-string">`serverid`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> <span class="hljs-string"><span class="hljs-string">`FK_gates_numbers_pool`</span></span> (<span class="hljs-string"><span class="hljs-string">`numbers_pool_id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> <span class="hljs-string"><span class="hljs-string">`FK_gates_numbers_pool`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`numbers_pool_id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> <span class="hljs-string"><span class="hljs-string">`numbers_pool`</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> <span class="hljs-string"><span class="hljs-string">`FK_gates_servers`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`serverid`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> <span class="hljs-string"><span class="hljs-string">`servers`</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">'List of gates on servers'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span>=<span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> AUTO_INCREMENT=<span class="hljs-number"><span class="hljs-number">1</span></span> ;</code> </pre> </div></div><br><h2>  gates </h2><br><table><thead><tr><th>  id </th><th>  numbers_pool_id </th><th>  serverid </th><th>  gatename </th><th>  gatenumber </th><th>  cid_support </th><th>  contextname </th><th>  comment </th></tr></thead><tbody><tr><td>  one </td><td>  516 </td><td>  one </td><td>  sip_peer_msm_2302 </td><td>  74957952302 </td><td>  Y </td><td>  sip_msm_74957952302 </td><td></td></tr><tr><td>  2 </td><td>  515 </td><td>  one </td><td>  sip_peer_msm_2301 </td><td>  74957952301 </td><td>  Y </td><td>  sip_msm_74957952301 </td><td></td></tr><tr><td>  eight </td><td>  279 </td><td>  one </td><td>  westcall </td><td>  74951815000 </td><td>  Y </td><td>  westcall </td><td></td></tr><tr><td>  9 </td><td>  280 </td><td>  one </td><td>  westcall </td><td>  74951815001 </td><td>  Y </td><td>  westcall </td><td></td></tr><tr><td>  ten </td><td>  281 </td><td>  one </td><td>  westcall </td><td>  74951815002 </td><td>  Y </td><td>  westcall </td><td></td></tr></tbody></table><br><p>  Description of fields: </p><br><ul><li>  <strong>numbers_pool_id</strong> - ID of the number from the numbers_pool table </li><li>  <strong>serverid</strong> - binding the gate to the server </li><li>  <strong>gatename</strong> is the name of the gate </li><li>  <strong>gatenumber</strong> - the number connected to the gate </li><li>  <strong>cid_support</strong> - is callerid setting supported on an outgoing call </li><li>  <strong>contextname</strong> - context on the server that serves outgoing calls to this number </li></ul><br><p>  At this point, the setting of the base for service calls is almost complete.  I deliberately do not consider now the work of the tariffiser and call control systems, as this is a very big topic that should be put in a separate article. </p><br><p>  Due to the fact that the main call processing and call routing logic is removed from Asterisk to the Application Server, and the procedures are in MariaDB, it is necessary to provide mechanisms for debugging and controlling the operation of the procedures.  To do this, you can use the following scheme. <br>  To store debug information, create an additional <strong>debug</strong> database and create a <strong>debug_records</strong> table there <strong>.</strong> </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`debug_records`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`logtime`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span>, <span class="hljs-string"><span class="hljs-string">`procedure_name`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, <span class="hljs-string"><span class="hljs-string">`debug_text`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span>=<span class="hljs-string"><span class="hljs-string">'utf8mb4_unicode_ci'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> AUTO_INCREMENT=<span class="hljs-number"><span class="hljs-number">1</span></span> ;</code> </pre> <br><p>  To write to this data table, create a <strong>debug</strong> procedure. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> DEFINER=<span class="hljs-string"><span class="hljs-string">`root`</span></span>@<span class="hljs-string"><span class="hljs-string">`localhost`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-string"><span class="hljs-string">`debug`</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-string"><span class="hljs-string">`ProcedureName`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-string"><span class="hljs-string">`DebugText`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DETERMINISTIC</span></span> CONTAINS <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SECURITY</span></span> DEFINER <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'Save debug info to log'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> DebugEnabled TINYINT <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">False</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> DebugEnabled=<span class="hljs-literal"><span class="hljs-literal">True</span></span>; IF DebugEnabled THEN <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> debug_records (procedure_name,debug_text) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (ProcedureName,DebugText); <span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre> <br><p>  Now debugging and control of the procedure at the development stage becomes a pleasure.  At the beginning of each procedure, we define two variables, the first is the name of the procedure, the second is the flag defining whether debugging is enabled or not.  And then in various places where the procedure may behave incorrectly - we first add an entry to the debug log. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> DEFINER=<span class="hljs-string"><span class="hljs-string">`root`</span></span>@<span class="hljs-string"><span class="hljs-string">`localhost`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-string"><span class="hljs-string">`usp_gettypeofcall`</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-string"><span class="hljs-string">`IncomingPhoneNumber`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-string"><span class="hljs-string">`TargetGateNumber`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-string"><span class="hljs-string">`CHANID`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">60</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-string"><span class="hljs-string">`SYSTEMNAME`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DETERMINISTIC</span></span> CONTAINS <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SECURITY</span></span> DEFINER <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'        '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> ProcedureName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'usp_gettypeofcall'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> ProcedureDebug TINYINT <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">True</span></span>; IF ProcedureDebug THEN <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> debug.debug(ProcedureName,<span class="hljs-keyword"><span class="hljs-keyword">CONCAT_WS</span></span>(<span class="hljs-string"><span class="hljs-string">' '</span></span>,<span class="hljs-string"><span class="hljs-string">'Call from '</span></span>,IncomingPhoneNumber,<span class="hljs-string"><span class="hljs-string">'to'</span></span>,TargetGateNumber,<span class="hljs-string"><span class="hljs-string">'at server'</span></span>,SYSTEMNAME,<span class="hljs-string"><span class="hljs-string">'with channelid'</span></span>,CHANID)); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre> <br><p>  <strong>I draw your attention to the fact that the use of this logic is not recommended !!!</strong>  <strong>in production mode at high loads, since the output of debugging information can greatly reduce the speed.</strong> </p><br><h1 id="nastroyka-asterisk">  Configure Asterisk </h1><br><p>  Let us proceed to setting up the Asterisk server.  The standard procedure for handling calls that fall into a <strong>public</strong> context, in most existing configurations, is as follows. </p><br><pre> <code class="hljs php">[<span class="hljs-keyword"><span class="hljs-keyword">public</span></span>] exten =&gt; <span class="hljs-number"><span class="hljs-number">74951815000</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,NoOp(Incoming Call to ${EXTEN}) same =&gt; n,Dial(SIP/<span class="hljs-number"><span class="hljs-number">1000</span></span>,<span class="hljs-number"><span class="hljs-number">60</span></span>) same =&gt; n,Hangup()</code> </pre> <br><p>  handling outgoing calls from the <strong>dialout</strong> context looks like this </p><br><pre> <code class="hljs php">[dialout] exten =&gt; _X.,<span class="hljs-number"><span class="hljs-number">1</span></span>,NoOp(Outgoing Call to ${EXTEN}) same =&gt; n,Dial(SIP/dialpeer_name/${EXTEN},<span class="hljs-number"><span class="hljs-number">60</span></span>) same =&gt; n,Hangup()  [dialout] exten =&gt; _X.,<span class="hljs-number"><span class="hljs-number">1</span></span>,NoOp(Outgoing Call to ${EXTEN}) same =&gt; n,Dial(SIP/sip.n1.ipport.net/${EXTEN},<span class="hljs-number"><span class="hljs-number">60</span></span>) same =&gt; n,Hangup()  [dialout] exten =&gt; _X.,<span class="hljs-number"><span class="hljs-number">1</span></span>,NoOp(Outgoing Call to ${EXTEN}) same =&gt; n,Dial(SIP/${EXTEN}@sip.n1.ipport.net,<span class="hljs-number"><span class="hljs-number">60</span></span>) same =&gt; n,Hangup()</code> </pre> <br><p>  In general, who is as accustomed and as you like.  As we see with such an organization of outgoing calls, there is practically no information about the status of the call.  We modified Dialplan call processing and added service functions to it. </p><br><pre> <code class="hljs php">[service] ; GetIP subroutine exten =&gt; getip,<span class="hljs-number"><span class="hljs-number">1</span></span>,Set(TESTAT=${CUT(SIP_HEADER(From),@,<span class="hljs-number"><span class="hljs-number">2</span></span>)}) same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${TESTAT}"</span></span> != <span class="hljs-string"><span class="hljs-string">""</span></span>]?hasat) same =&gt; n,Set(FROM_IP=${CUT(CUT(SIP_HEADER(From),&gt;,<span class="hljs-number"><span class="hljs-number">1</span></span>),:,<span class="hljs-number"><span class="hljs-number">2</span></span>)}) same =&gt; n,<span class="hljs-keyword"><span class="hljs-keyword">Goto</span></span>(gotip) same =&gt; <span class="hljs-number"><span class="hljs-number">20</span></span>(hasat),Set(FROM_IP=${CUT(CUT(CUT(SIP_HEADER(From),@,<span class="hljs-number"><span class="hljs-number">2</span></span>),&gt;,<span class="hljs-number"><span class="hljs-number">1</span></span>),:,<span class="hljs-number"><span class="hljs-number">1</span></span>)}) same =&gt; n(gotip),NoOp(Incoming Server IP is ${FROM_IP}) same =&gt; n,<span class="hljs-keyword"><span class="hljs-keyword">Return</span></span>() exten =&gt; set_handler,<span class="hljs-number"><span class="hljs-number">1</span></span>,Set(CHANNEL(hangup_handler_push)=service,outbound_handler,<span class="hljs-number"><span class="hljs-number">1</span></span>) same =&gt; n,AGI(/usr/local/etc/asterisk_scripts/create_channel_record.py) same =&gt; n,<span class="hljs-keyword"><span class="hljs-keyword">Return</span></span>() ; Set Hangup handler <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> channel exten =&gt; outbound_handler,<span class="hljs-number"><span class="hljs-number">1</span></span>,NoOp(Hungup handler python started) same =&gt; n,AGI(/usr/local/etc/asterisk_scripts/hangup.py) same =&gt; n,HangupCauseClear() same =&gt; n,<span class="hljs-keyword"><span class="hljs-keyword">Return</span></span>() exten =&gt; no_more_paths,<span class="hljs-number"><span class="hljs-number">1</span></span>,NoOp(No more dial paths) same =&gt; n,Hangup() [predial] exten =&gt; s,<span class="hljs-number"><span class="hljs-number">1</span></span>,NoOp(PreDial handler python started) same =&gt; n,AGI(/usr/local/etc/asterisk_scripts/predial.py) same =&gt; n,<span class="hljs-keyword"><span class="hljs-keyword">Return</span></span>() [<span class="hljs-keyword"><span class="hljs-keyword">public</span></span>] exten =&gt; _X.,<span class="hljs-number"><span class="hljs-number">1</span></span>,GoSub(service,getip,<span class="hljs-number"><span class="hljs-number">1</span></span>) same =&gt; n,AGI(/usr/local/etc/asterisk_scripts/incoming.py) exten =&gt; _+X.,<span class="hljs-number"><span class="hljs-number">1</span></span>,GoSub(service,getip,<span class="hljs-number"><span class="hljs-number">1</span></span>) same =&gt; n,AGI(/usr/local/etc/asterisk_scripts/incoming.py) [users_context] exten =&gt; _X.,<span class="hljs-number"><span class="hljs-number">1</span></span>,NoOp() same =&gt; n,AGI(/usr/local/etc/asterisk_scripts/make_a_route.py) [make_a_call] exten =&gt; h,<span class="hljs-number"><span class="hljs-number">1</span></span>,NoOp(Hangup) exten =&gt; _.,<span class="hljs-number"><span class="hljs-number">1</span></span>,NoOp(${EXTEN}) same =&gt; n,SET(__LoopCount=<span class="hljs-number"><span class="hljs-number">1</span></span>) same =&gt; n(<span class="hljs-keyword"><span class="hljs-keyword">try</span></span>),AGI(/usr/local/etc/asterisk_scripts/incoming_dialer.py) same =&gt; n,Dial(${DIALSTRING},<span class="hljs-number"><span class="hljs-number">60</span></span>,b(service^set_handler^<span class="hljs-number"><span class="hljs-number">1</span></span>)U(predial)) same =&gt; n,SET(__LoopCount=${<span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>($[${HANGUPCAUSE}=<span class="hljs-number"><span class="hljs-number">17</span></span>]?<span class="hljs-number"><span class="hljs-number">10</span></span>:${LoopCount})}) same =&gt; n,Set(__LoopCount=${INC(LoopCount)}) same =&gt; n,NoOp(Current LoopCount ${LoopCount}) same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${LoopCount}"</span></span> &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>]?<span class="hljs-keyword"><span class="hljs-keyword">try</span></span>) same =&gt; n,Hangup() [redirect] exten =&gt; h,<span class="hljs-number"><span class="hljs-number">1</span></span>,NoOp(Hangup) exten =&gt; _.,<span class="hljs-number"><span class="hljs-number">1</span></span>,NoOp(${ForwardPath}) same =&gt; n,Dial(${ForwardPath}/${EXTEN},<span class="hljs-number"><span class="hljs-number">60</span></span>,b(service^set_handler^<span class="hljs-number"><span class="hljs-number">1</span></span>)) same =&gt; n,Hangup()</code> </pre> <br><p>  The <strong>[service]</strong> context contains service functions such as: </p><br><ul><li>  <strong>getip</strong> - determining the IP address of the incoming server </li><li>  <strong>set_handler</strong> - setting handlers for the current outgoing call.  This handler is called before making a call when creating a channel. </li><li>  <strong>outbound_handler</strong> - call completion handler.  Called in all cases of a release from the side of the called subscriber </li><li>  <strong>no_more_paths</strong> - used if all available subscriber call options are exhausted </li></ul><br><p>  The <strong>[predial]</strong> context is invoked before the callers are connected when they successfully <strong>pick</strong> up the handset on the called side. <br>  All external calls fall into the <strong>[public]</strong> context. <br>  All calls that need to be redirected from server to server fall into the <strong>[redirect]</strong> context. <br>  The context <strong>[users_context]</strong> is the main context of users for preparing routes for calls. <br>  The context <strong>[make_a_call]</strong> is the main context when making an outgoing call. </p><br><p>  Let us consider in more detail the procedure for processing an incoming call: </p><br><ol><li>  The call comes from the operator's server and falls into the context of <strong>[public]</strong> </li><li>  Called the procedure for determining the IP address of the server from which the call came based on the headers of the SIP packet </li><li>  Calls the AGI application <em>incoming.py that</em> performs the initial processing of the incoming call. </li><li>  The internal logic of the application connects to the database and sends the initial parameters to the connection check procedure: the server‚Äôs IP address, the called number, the server identifier.  The server identifier is unique, corresponds to the server table and is defined in the <em>asterisk.conf</em> file. </li><li>      ,         .          .         .      ,    "". </li></ol><br><p>          <strong>[users_context]</strong>  <strong>[make_a_call]</strong> . </p><br><p>     : </p><br><ol><li>       </li><li>     <strong>[users_context]</strong> </li><li>        AGI  <em>make_a_route.py</em> ,   ,    ,      .     ,   : <br><ul><li>      </li><li>      </li><li> CallerID    </li><li>     </li><li>  ... <br>  <em>make_a_route.py</em>    <strong>[make_a_call]</strong>  <strong>[redirect]</strong>        </li></ul></li><li>  <strong>[redirect]</strong>   ,      ,     ,    . </li><li>  <strong>[make_a_call]</strong>       .            10 .      ,    1    ,     . </li><li>              AGI  <em>incoming_dialer.py</em> ,    ,  AGI  <em>make_a_route.py</em> , DialString   . </li><li>    ,     <a href="https://wiki.asterisk.org/wiki/display/AST/Asterisk%2B13%2BApplication_Dial">Dial</a> ,   U  b.  b       ,    .         AGI ,      .     ,   ,      .  U        , ..      .          . </li><li>            17(),    . </li><li>             .    ABR, ASR          </li><li>         ,      <strong>[no_more_paths]</strong> ,           </li></ol><br><p>      Asterisk .       ,            Asterisk,   ,   RSA   IAX         .               . </p><br><p>  AGI   Python       Application .   AGI      .       , AGI       HTTP  Application Server  <a href="https://uwsgi-docs.readthedocs.io/en/latest/">uwsgi</a> .        ,    ,       CURL  . </p><br><p> <a href="https://habrahabr.ru/post/319558/"> </a>  , LCR       . </p><br><p> ¬© Aborche 2017 <br><img src="http://aborche.com/pics/aborchelogo.jpg" alt="Aborche"></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/319352/">https://habr.com/ru/post/319352/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319342/index.html">Higher education and IT - current realities and perspectives, opinions and experience of experts</a></li>
<li><a href="../319344/index.html">Automation of business processes. Ad-hoc changes on the example of life. Part 3</a></li>
<li><a href="../319346/index.html">LexikFormFilterBundle, create filter forms even faster</a></li>
<li><a href="../319348/index.html">Overview of cross-platform solutions for mobile application development</a></li>
<li><a href="../319350/index.html">Competitiveness: Asynchrony</a></li>
<li><a href="../319354/index.html">Data center infrastructure: what awaits us in the new year. Trends and opinions</a></li>
<li><a href="../319356/index.html">Religious compilation. Dogma technician</a></li>
<li><a href="../319358/index.html">PropTypes - type checking in React</a></li>
<li><a href="../319360/index.html">Viber vulnerability, allowing to listen to someone else's conversation</a></li>
<li><a href="../319362/index.html">Tractor to Estonia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>