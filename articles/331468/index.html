<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Use template + constexpr to create mask masks for microcontroller peripherals at compile time (C ++ 14)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 This small note does not contain an obvious solution to the problem set out below, to which I had to go through several sleepless night...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Use template + constexpr to create mask masks for microcontroller peripherals at compile time (C ++ 14)</h1><div class="post__text post__text-html js-mediator-article"><h2>  Introduction </h2><br>  This small note does not contain an obvious solution to the problem set out below, to which I had to go through several sleepless nights. <br><br>  Task: on the basis of user-defined data on how the microcontroller's peripheral unit should work, to obtain at the compilation stage an array of mask configurations of its registers that could be used in real time.  In this case, it is required at the compilation stage to check that all the parameters specified are correct (the microcontroller periphery will be configured correctly). <br><br><img src="https://habrastorage.org/web/534/7f5/eac/5347f5eac108477cb575ea56dffb45ca.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Interested in how this can be done, please under the cat. <br><a name="habracut"></a><br><h2>  Table of contents: </h2><br><ol><li>  The main problems and limitations of C ++ 14. </li><li>  Decision based on the fact that the user is never wrong. </li><li>  Accounting for custom errors. </li><li>  Expand the capabilities of the class. </li><li>  About abbreviated records. </li><li>  Total. </li></ol><br><h2>  Main problems and limitations of C ++ 14 </h2><br>  As soon as I ran into the task described in the introduction, I immediately remembered the C ++ language specifier - <b>constexpr</b> .  Since the need to solve this problem was identified at the design stage of the library, all limitations of the C ++ 11 standard, which was originally planned to build the library (the inability to use loops inside constexpr methods, etc.), were taken into account, and The C ++ 14 standard was selected, in which many of the C ++ 11 limitations were removed (C ++ 17 was not deliberately chosen, since it was not too different from C ++ 14 in terms of the tasks set for the library, but This is its support from GCC, also selected as the main  The library compiler, at the time of this writing, is not very stable). <br><br>  But despite the fact that constexpr functions in C ++ 14 have become almost as flexible as real-time functions, they have only one fat minus, crossing out most of the advantages - the absence of any debugging.  About it was written on Habr√© <a href="https://habrahabr.ru/post/228181/">here</a> .  From this article I drew the main idea: <blockquote>  But the problems do not end there.  When you write some constexpr-function, which will then often use, it would be good to return a readable error.  Here you can mistakenly assume that static_assert is suitable for this.  But static_assert cannot be used, since the parameters of the functions cannot be constexpr, which is why the values ‚Äã‚Äãof the parameters are not guaranteed to be known at the compilation stage. <br><br>  How to display errors?  The only more or less normal way I found is to throw an exception: </blockquote>  And since exceptions are not supported in the constexpr methods, we will simply get an error that using throw in constexpr is impossible.  If we were processing something in a loop, then we can never know which element we fell on (when checking which element we caused an exception). <br><br>  Moreover, the situation is as follows: static_assert is impossible, throw is impossible, printf and interruption of compilation are not allowed. <br><br><h2>  Decision based on the fact that the user is never wrong </h2><br>  How to deal with all these limitations and the inability to debug?  To begin with, suppose that the <b>USER is NEVER MISTAKING</b> (yes, futuristic, but for now let's take this as an axiom).  Then constexpr, it turns out, in principle, does not need debugging and throwing exceptions that the input data parameters are incorrect. <br><br>  For example, consider the class of the object controlling the output of the microcontroller's port, initially switched on by someone (a clock signal was sent to the peripheral unit) and with the output configured at the output at the desired speed (the most blinking LED).  In essence, an object of our class must have methods for switching the output state from 1 to 0 and back.  More from our facility is not required. <br><br>  However, in order not to produce entities, suppose that we have some structure that describes the configuration of one entire output.  This structure is used not only by the class of our object, but also by others (for example, those that initialized the module for us in advance and configured the output to the desired state).  This structure will look like this: <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* *   . */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attribute__</span></span></span><span class="hljs-class">( ( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packed</span></span></span><span class="hljs-class"> ) ) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pin_config_t</span></span></span><span class="hljs-class"> {</span></span> EC_PORT_NAME port; <span class="hljs-comment"><span class="hljs-comment">//   // ( : EC_PORT_NAME::A ). EC_PORT_PIN_NAME pin_name; //   // ( : EC_PORT_PIN_NAME::PIN_0 ). EC_PIN_MODE mode; //   // ( : EC_PIN_MODE::OUTPUT ). EC_PIN_OUTPUT_CFG output_config; //   // ( : EC_PIN_OUTPUT_CFG::NOT_USE ). EC_PIN_SPEED speed; //   // ( : EC_PIN_SPEED::MEDIUM ). EC_PIN_PULL pull; //   // ( : EC_PIN_PULL::NO ). EC_PIN_AF af; //    // ( : EC_PIN_AF::NOT_USE ). EC_LOCKED locked; //     //     // global_port  // (  EC_LOCKED::NOT_LOCKED ). EC_PIN_STATE_AFTER_INIT state_after_init; //      // (  ,      ). // ( EC_PIN_STATE_AFTER_INIT::NO_USE). };</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">The structure uses the following enum classes.</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/********************************************************************** *  enum class-. **********************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/* *    . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EC_PORT_PIN_NAME</span></span></span><span class="hljs-class"> {</span></span> PIN_0 = <span class="hljs-number"><span class="hljs-number">0</span></span>, PIN_1 = <span class="hljs-number"><span class="hljs-number">1</span></span>, PIN_2 = <span class="hljs-number"><span class="hljs-number">2</span></span>, PIN_3 = <span class="hljs-number"><span class="hljs-number">3</span></span>, PIN_4 = <span class="hljs-number"><span class="hljs-number">4</span></span>, PIN_5 = <span class="hljs-number"><span class="hljs-number">5</span></span>, PIN_6 = <span class="hljs-number"><span class="hljs-number">6</span></span>, PIN_7 = <span class="hljs-number"><span class="hljs-number">7</span></span>, PIN_8 = <span class="hljs-number"><span class="hljs-number">8</span></span>, PIN_9 = <span class="hljs-number"><span class="hljs-number">9</span></span>, PIN_10 = <span class="hljs-number"><span class="hljs-number">10</span></span>, PIN_11 = <span class="hljs-number"><span class="hljs-number">11</span></span>, PIN_12 = <span class="hljs-number"><span class="hljs-number">12</span></span>, PIN_13 = <span class="hljs-number"><span class="hljs-number">13</span></span>, PIN_14 = <span class="hljs-number"><span class="hljs-number">14</span></span>, PIN_15 = <span class="hljs-number"><span class="hljs-number">15</span></span> }; <span class="hljs-comment"><span class="hljs-comment">/* *  . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EC_PIN_MODE</span></span></span><span class="hljs-class"> {</span></span> INPUT = <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-comment"><span class="hljs-comment">// . OUTPUT = 1, // . AF = 2, //  . ANALOG = 3 //  . }; /* *  . */ enum class EC_PIN_OUTPUT_CFG { NO_USE = 0, //     . PUSH_PULL = 0, // "-". OPEN_DRAIN = 1 // " ". }; /* *  . */ enum class EC_PIN_SPEED { LOW = 0, // . MEDIUM = 1, // . FAST = 2, // . HIGH = 3 //   }; /* *   */ enum class EC_PIN_PULL { NO_USE = 0, //  . UP = 1, //   . DOWN = 2 //   . }; /* *   ,  . */ enum class EC_PIN_AF { AF_0 = 0, NO_USE = AF_0, SYS = AF_0, AF_1 = 1, TIM1 = AF_1, TIM2 = AF_1, AF_2 = 2, TIM3 = AF_2, TIM4 = AF_2, TIM5 = AF_2, AF_3 = 3, TIM8 = AF_3, TIM9 = AF_3, TIM10 = AF_3, TIM11 = AF_3, AF_4 = 4, I2C1 = AF_4, I2C2 = AF_4, I2C3 = AF_4, AF_5 = 5, SPI1 = AF_5, SPI2 = AF_5, I2S2 = AF_5, AF_6 = 6, SPI3 = AF_6, I2S3 = AF_6, AF_7 = 7, USART1 = AF_7, USART2 = AF_7, USART3 = AF_7, AF_8 = 8, UART4 = AF_8, UART5 = AF_8, USART6 = AF_8, AF_9 = 9, CAN1 = AF_9, CAN2 = AF_9, TIM12 = AF_9, TIM13 = AF_9, TIM14 = AF_9, AF_10 = 10, OTG_FS = AF_10, AF_11 = 11, ETH = AF_11, AF_12 = 12, FSMC = AF_12, SDIO = AF_12, AF_13 = 13, DCMI = AF_13, AF_14 = 14, AF_15 = 15, EVENTOUT = AF_15 }; /* *       set_locked_key_port  * set_locked_keys_all_port   global_port. * !       global_port.    *          - . *     -  . */ enum class EC_LOCKED { NOT_LOCKED = 0, //   . LOCKED = 1 //  . }; /* *      * ( ,     ). */ enum class EC_PIN_STATE_AFTER_INIT { NO_USE = 0, RESET = 0, SET = 1 };</span></span></code> </pre> <br></div></div><br>  As mentioned earlier, the object of our class should only change the state at the output of the output (legs).  Since the library is written under stm32f2 (and only), it is reasonable to use for this purpose the <b>BSR</b> register available in the physical GPIO block of each port, which allows writing the unit (1) to bits 0-15 to set the corresponding bit (writing unit (1) to The 0th bit will set the output status of port 0 to 1), and writing the unit (1) to 16-31 will reset the corresponding bit - 16 (writing the unit (1) to the 31st bit will reset 31-16 = the 15th output of the port to 0). <br><br>  As you can see, the task of setting the desired output to 1 is reduced to writing to BSR register <i>1 &lt;&lt; output_number</i> , and resetting to recording <i>1 &lt;&lt; output_number + 16</i> . <br><br>  For these purposes, it is enough for us to take the <b>port</b> and <b>pin_name</b> fields from the received from the user field structure.  All other fields we do not need. <br><br>  Denote a general view of the class of our object: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pin</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pin</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pin_config_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pin_cfg_array )</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reset</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> state )</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> state )</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> state )</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">p_bsr_get</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pin_config_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pin_cfg_array )</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_msk_get</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pin_config_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pin_cfg_array )</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reset_msk_get</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pin_config_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pin_cfg_array )</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> p_bsr; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> bsr_set_msk, bsr_reset_msk; };</code> </pre> <br>  As you can see, the class has the following methods: <br><br><ul><li>  set without parameters - sets the state at the output of the output to 1; </li><li>  reset - resets the state at the output of the output to 0; </li><li>  set with parameters of different types - in fact is one function (which will be discussed later), which sets the specified state at the output using the functions above. </li></ul><br>  All these methods are used by the user in real time.  Consider them. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* *      &lt;&lt;1&gt;&gt;, *     . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> pin::<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { *M_U32_TO_P(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;p_bsr) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;bsr_set_msk; } <span class="hljs-comment"><span class="hljs-comment">/* *      &lt;&lt;0&gt;&gt;, *     . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> pin::reset ( <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { *M_U32_TO_P(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;p_bsr) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;bsr_reset_msk; } <span class="hljs-comment"><span class="hljs-comment">/* *      , *     . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> pin::<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> state ) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( state ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;reset(); } } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> pin::<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> state ) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> &gt;( state ) ); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> pin::<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> state ) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> &gt;( state ) ); }</code> </pre> <br>  The set and reset methods use the define defined below to explicitly convert the value in the uint32_t variable to a pointer to the uint32_t variable. <br><br><pre> <code class="hljs pgsql">//    uint32_t     uint32_t. //     . #define M_U32_TO_P(<span class="hljs-type"><span class="hljs-type">point</span></span>) ((uint32_t *)(<span class="hljs-type"><span class="hljs-type">point</span></span>))</code> </pre> <br>  At the moment, we have figured out how the object's methods work with ready-made masks, the most important thing remains (for the sake of which this article was written) to prepare them. <br><br>  The class has three methods: <br><br><ol><li>  set_msk_get - returns the value of the uint32_t variable, which is the mask of the BSR register for setting user-specified output to &lt;1 &gt;&gt;. </li><li>  reset_msk_get - Returns the value of the uint32_t variable, which is the mask of the BSR register for resetting user-defined output to &lt;&lt; 0 &gt;&gt;. </li><li>  p_bsr_get - returns the value of the uint32_t variable, which contains the address of the register BSR on the physical memory card of the microcontroller. </li></ol><br>  Knowing that the user is definitely not mistaken when specifying the parameters of the structure, we can write the following code: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/********************************************************************** *  constexpr . **********************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/* *       "1"   BSR. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> pin::set_msk_get ( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pin_config_t</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pin_cfg_array ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; M_EC_TO_U8(pin_cfg_array-&gt;pin_name); } <span class="hljs-comment"><span class="hljs-comment">/* *       "0"   BSR. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> pin::reset_msk_get ( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pin_config_t</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pin_cfg_array ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; M_EC_TO_U8( pin_cfg_array-&gt;pin_name ) + <span class="hljs-number"><span class="hljs-number">16</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* *      BSR,    . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> pin::p_bsr_get( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pin_config_t</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pin_cfg_array ) { <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> p_port = p_base_port_address_get( pin_cfg_array-&gt;port ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p_port + <span class="hljs-number"><span class="hljs-number">0x18</span></span>; }</code> </pre> <br>  These functions use define to convert the value of the enum class to the uint8_t variable. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//  enum class  uint8_t. #define M_EC_TO_U8(ENUM_VALUE) ((uint8_t)ENUM_VALUE)</span></span></code> </pre> <br>  Also, the <i>p_bsr_get</i> method uses the <i>p_base_port_address_get</i> method, which does not belong to any particular class, and taking the value of the enum class of EC_PORT_NAME (port name) returns the physical address of the beginning of the location of the registers of this port on the physical microcontroller map.  It looks like this: <br><br><div class="spoiler">  <b class="spoiler_title">General method p_base_port_address_get</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* *        - *        . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">p_base_port_address_get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( EC_PORT_NAME port_name )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>( port_name ) { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> PORTA case EC_PORT_NAME::A: return 0x40020000; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> PORTB case EC_PORT_NAME::B: return 0x40020400; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> PORTC case EC_PORT_NAME::C: return 0x40020800; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> PORTD case EC_PORT_NAME::D: return 0x40020C00; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> PORTE case EC_PORT_NAME::E: return 0x40021000; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> PORTF case EC_PORT_NAME::F: return 0x40021400; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> PORTG case EC_PORT_NAME::G: return 0x40021800; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> PORTH case EC_PORT_NAME::H: return 0x40021C00; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> PORTI case EC_PORT_NAME::I: return 0x40022000; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> } }</span></span></code> </pre> </div></div>  The class constructor that fills the constants of the reset / set masks and the register address is as follows. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/********************************************************************** *  constexpr . **********************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> pin::pin ( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pin_config_t</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pin_cfg_array ): p_bsr ( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;p_bsr_get( pin_cfg_array ) ), bsr_set_msk ( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;set_msk_get( pin_cfg_array ) ), bsr_reset_msk ( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;reset_msk_get( pin_cfg_array ) ) {};</code> </pre> <br>  Technically, now you can use this class, but we remember that the user can not always enter all the parameters of the structure correctly ... <br><br><h2>  Accounting for custom errors. </h2><br>  Now that we have a working and debugged class, it remains only to refine the input structure check and we can safely use the objects of our class.  But, as mentioned earlier, to do this in constexpr is comfortable - impossible.  But the solution is - template.  Since all objects in the user code should be set globally (this is the main condition for using the library, which can be read in the document of its (library) description, link to which will be given at the end of the article), the use of template-s seems to be the most reasonable.  The fact is that in the template, static_assert is allowed.  Also, they can use all sorts of code to conduct more complex checks.  And, most importantly: <br><br>  <b>If you create a template class inherited from a structure, perform all the necessary checks in the constructor of this class, and then declare an object of the given template class globally in the user's code, the compiler will allow you to apply an implicit type conversion to the structure from which the class was inherited.</b> <br><br>  This opportunity simply can not be used! <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/********************************************************************** *  template . **********************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt; EC_PORT_NAME PORT, EC_PORT_PIN_NAME PIN_NAME, EC_PIN_MODE MODE, EC_PIN_OUTPUT_CFG OUTPUT_CONFIG, EC_PIN_SPEED SPEED, EC_PIN_PULL PULL, EC_PIN_AF AF, EC_LOCKED LOCKED, EC_PIN_STATE_AFTER_INIT STATE_AFTER_INIT &gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pin_config_check_param</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pin_config_t</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pin_config_check_param</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pin_config_t</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( { .port = PORT, .pin_name = PIN_NAME, .mode = MODE, .output_config = OUTPUT_CONFIG, .speed = SPEED, .pull = PULL, .af = AF, .locked = LOCKED, .state_after_init = STATE_AFTER_INIT } )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* *       . */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> defined(STM32F205RB)|defined(STM32F205RC)|defined(STM32F205RE) \ |defined(STM32F205RF)|defined(STM32F205RG) static_assert( PORT &gt;= EC_PORT_NAME::A &amp;&amp; PORT </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;= EC_PORT_NAME::H, "Invalid port name. The port name must be A..H." ); #endif static_assert( PIN_NAME &gt;= EC_PORT_PIN_NAME::PIN_0 &amp;&amp; PIN_NAME &lt;= EC_PORT_PIN_NAME::PIN_15, "Invalid output name. An output with this name does not" "exist in any port. The output can have a name PIN_0..PIN_15." ); static_assert( MODE &gt;= EC_PIN_MODE::INPUT &amp;&amp; MODE &lt;= EC_PIN_MODE::ANALOG, "The selected mode does not exist. " "The output can be set to mode: INPUT, OUTPUT, AF or ANALOG." ); static_assert( OUTPUT_CONFIG == EC_PIN_OUTPUT_CFG::PUSH_PULL || OUTPUT_CONFIG == EC_PIN_OUTPUT_CFG::OPEN_DRAIN, "A non-existent output mode is selected. " "The output can be in the mode: PUSH_PULL, OPEN_DRAIN." ); static_assert( SPEED &gt;= EC_PIN_SPEED::LOW &amp;&amp; SPEED &lt;= EC_PIN_SPEED::HIGH, "A non-existent mode of port speed is selected. " "Possible modes: LOW, MEDIUM, FAST or HIGH." ); static_assert( PULL &gt;= EC_PIN_PULL::NO_USE &amp;&amp; PULL &lt;= EC_PIN_PULL::DOWN, "A non-existent brace mode is selected." "The options are: NO_USE, UP or DOWN." ); static_assert( AF &gt;= EC_PIN_AF::AF_0 &amp;&amp; AF &lt;= EC_PIN_AF::AF_15, "A non-existent mode of the alternative port function is selected." ); static_assert( LOCKED == EC_LOCKED::NOT_LOCKED || LOCKED == EC_LOCKED::LOCKED, "Invalid port lock mode selected." ); static_assert( STATE_AFTER_INIT == EC_PIN_STATE_AFTER_INIT::NO_USE || STATE_AFTER_INIT == EC_PIN_STATE_AFTER_INIT::SET, "The wrong state of the output is selected." "The status can be: NO_USE, UP or DOWN." ); }; };</span></span></span></span></code> </pre> <br>  Now we can declare an object of this class in the user code: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pin_config_check_param&lt; EC_PORT_NAME::C, EC_PORT_PIN_NAME::PIN_4, EC_PIN_MODE::OUTPUT, EC_PIN_OUTPUT_CFG::PUSH_PULL, EC_PIN_SPEED::MEDIUM, EC_PIN_PULL::NO_USE, EC_PIN_AF::NO_USE, EC_LOCKED::LOCKED, EC_PIN_STATE_AFTER_INIT::SET &gt; lcd_res;</code> </pre> <br><br>  After that, when creating an object of the pin class, refer to it as if it were a regular structure: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> pin </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pin_lcd_res</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( &amp;lcd_res )</span></span></span></span>;</code> </pre> <br>  Then, in the user code, you can use the methods of this object: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">port_test</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span><span class="hljs-function"> </span></span>{ pin_lcd_res.reset(); pin_lcd_res.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(); }</code> </pre> <br><h2>  Extend class features </h2><br>  We got a class that is quite suitable for controlling the leg in exit mode.  However, not to create a separate class for input?  We will slightly modify the class so that it can be used both for outputs configured for output and for input.  We also add a method for inverting the output state. <br><br>  We add two (2) constants to the class: <br><br><ol><li>  p_bb_odr_read - there will be a pointer to the output bit of the object in the ODR register (the position set by the user at the output of the output, if the output is used at the output).  Used bit-banding area. </li><li>  p_bb_idr_read - there will be a pointer to the output bit of the object in the IDR register (this register contains the actual state of the output inputs, regardless of how the output is configured).  Used bit-banding area. </li></ol><br>  We write methods that return the values ‚Äã‚Äãof these constants for a particular output. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* *     bit_banding *  ,      . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> pin::bb_p_idr_read_get ( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pin_config_t</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pin_cfg_array ) { <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> p_port = p_base_port_address_get( pin_cfg_array-&gt;port ); <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> p_idr = p_port + <span class="hljs-number"><span class="hljs-number">0x10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> M_GET_BB_P_PER(p_idr, M_EC_TO_U8(pin_cfg_array-&gt;pin_name)); } <span class="hljs-comment"><span class="hljs-comment">/* *     bit banding  , *       . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> pin::odr_bit_read_bb_p_get ( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pin_config_t</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pin_cfg_array ) { <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> p_port = p_base_port_address_get( pin_cfg_array-&gt;port ); <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> p_reg_odr = p_port + <span class="hljs-number"><span class="hljs-number">0x14</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> M_GET_BB_P_PER(p_reg_odr, M_EC_TO_U8(pin_cfg_array-&gt;pin_name)); }</code> </pre> <br>  This is used to define M_GET_BB_P_PER which, by uint32_t value of the register address in the field of the periphery and uint32_t, the port bit number returns the bit-banding address of this bit. <br><br><div class="spoiler">  <b class="spoiler_title">define M_GET_BB_P_PER</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//********************************************************************* // ,    . //********************************************************************* #define BIT_BAND_SRAM_REF 0x20000000 #define BIT_BAND_SRAM_BASE 0x22000000 //   RAM  Bit Banding . #define MACRO_GET_BB_P_SRAM(reg, bit) \ ((BIT_BAND_SRAM_BASE + (reg - BIT_BAND_SRAM_REF)*32 + (bit * 4))) #define BIT_BAND_PER_REF ((uint32_t)0x40000000) #define BIT_BAND_PER_BASE ((uint32_t)0x42000000) //      Bit Banding . #define M_GET_BB_P_PER(ADDRESS,BIT) \ ((BIT_BAND_PER_BASE + (ADDRESS - BIT_BAND_PER_REF)*32 + (BIT * 4)))</span></span></code> </pre> <br></div></div><br>  Let's add in the constructor initialization of these commands. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/********************************************************************** *  constexpr . **********************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> pin::pin ( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pin_config_t</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pin_cfg_array ): p_bsr ( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;p_bsr_get( pin_cfg_array ) ), p_bb_odr_read ( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;odr_bit_read_bb_p_get( pin_cfg_array ) ), bsr_set_msk ( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;set_msk_get( pin_cfg_array ) ), bsr_reset_msk ( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;reset_msk_get( pin_cfg_array ) ), p_bb_idr_read ( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;bb_p_idr_read_get( pin_cfg_array ) ) {};</code> </pre> <br>  Well, let's add real-time functions that will work with these constants: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* *      , *     . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> pin::invert( <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*M_U32_TO_P_CONST(p_bb_odr_read)) { <span class="hljs-comment"><span class="hljs-comment">//   1,   0. this-&gt;reset(); } else { this-&gt;set(); } } /* *      . */ int pin::read() const { return *M_U32_TO_P_CONST(p_bb_idr_read); }</span></span></code> </pre><br>  It uses another 1 define (M_U32_TO_P_CONST), which converts the value stored in the uint32_t variable into a pointer to the uint32_t variable write-protected. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    uint32_t     uint32_t. //    ,    ( ). #define M_U32_TO_P_CONST(point) ((const uint32_t *const)(point))</span></span></code> </pre> <br>  In the end, our class has acquired the following form: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pin</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pin</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pin_config_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pin_cfg_array )</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reset</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> state )</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> state )</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> state )</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invert</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">p_bsr_get</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pin_config_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pin_cfg_array )</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_msk_get</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pin_config_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pin_cfg_array )</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reset_msk_get</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pin_config_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pin_cfg_array )</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">odr_bit_read_bb_p_get</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pin_config_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pin_cfg_array )</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bb_p_idr_read_get</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pin_config_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pin_cfg_array )</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> p_bsr; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> bsr_set_msk, bsr_reset_msk; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> p_bb_odr_read, p_bb_idr_read; };</code> </pre> <br><h2>  About abbreviated records. </h2><br>  It often happens that you need to create an object configuration structure for a specific task (for example, under the ADC input).  If there are a lot of such conclusions, then to write all the parameters every time is tiresome.  For this you can use the template class, which will use our template class.  For ADC, it will look like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt; EC_PORT_NAME PORT, EC_PORT_PIN_NAME PIN_NAME &gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pin_config_adc_check_param</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> pin_config_check_param&lt; PORT, PIN_NAME, EC_PIN_MODE::INPUT, EC_PIN_OUTPUT_CFG::NO_USE, EC_PIN_SPEED::LOW, EC_PIN_PULL::UP, EC_PIN_AF::NO_USE, EC_LOCKED::LOCKED, EC_PIN_STATE_AFTER_INIT::NO_USE &gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pin_config_adc_check_param</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{}; };</code> </pre> <br>  The ad in the code will take many times less space <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pin_config_adc_check_param&lt; EC_PORT_NAME::B, EC_PORT_PIN_NAME::PIN_1 &gt; adc_left;</code> </pre> <br><h2>  Total </h2><br>  Thus, at the output, we were able to create objects at the compilation stage, which do not use RAM in any way and do not require calling the constructor in real time.  At the same time we will be sure that they are initialized correctly. <br><br>  In this particular case, it is difficult to make a mistake, I agree.  Maybe there is no need to check here, but for example, when it comes to creating PLL configuration settings, it is already more difficult.  You can not take something into account.  For example, that a divider cannot be set to any value, although the input field allows it to be received, or the displayed divider receives a frequency that exceeds, or vice versa, does not reach the limits of the recommended values.  In such cases, the ability to check at compile time is very helpful. <br><br>  It is also worth noting that the global initialization structure created for the pin class object will not go into the main firmware file.  It will be dropped by the linker as not used.  Only uint32_t variables filled with a constructor and the methods actually called in the user program will go into flash. <br><br>  The code in the article is part of <a href="https://github.com/Vadimatorik/stm32f2_api">this</a> library.  The library is still in its infancy.  How will the alpha version - will be a separate article on this topic. <br><br>  Special thanks to <a href="https://habrahabr.ru/users/madcomaker/" class="user_link">madcomaker</a> for responding to the <a href="https://toster.ru/q/435737">Toaster</a> , who came up with an idea. </div><p>Source: <a href="https://habr.com/ru/post/331468/">https://habr.com/ru/post/331468/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../331456/index.html">How we gopher apples fed or effective backend on Go for iOS</a></li>
<li><a href="../331458/index.html">The history of the development and life of one small game. Release</a></li>
<li><a href="../331460/index.html">PostgreSQL features for those who migrated from MySQL</a></li>
<li><a href="../331462/index.html">Web sockets for php. Choosing a web server server</a></li>
<li><a href="../331466/index.html">Lessons from three million downloads on the AppStore</a></li>
<li><a href="../331470/index.html">How to overdo the door lock</a></li>
<li><a href="../331472/index.html">Introduction to ServiceNow and IT Infrastructure Management: Digest # 2</a></li>
<li><a href="../331474/index.html">Automatic compression of stored data in redis</a></li>
<li><a href="../331476/index.html">Visualizing goals increases their achievement by 46%. How do we solve this in WebCanape?</a></li>
<li><a href="../331478/index.html">How to hold a raffle among Java programmers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>