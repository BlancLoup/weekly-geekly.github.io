<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Humidity Controller Atmega328</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently I faced a trivial task - control of an exhaust fan at home in the bathroom. 

 It would seem that something easier, connect it to the light s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Humidity Controller Atmega328</h1><div class="post__text post__text-html js-mediator-article">  Recently I faced a trivial task - control of an exhaust fan at home in the bathroom. <br><br>  It would seem that something easier, connect it to the light switch and ready.  But, the operating time of the light is not constant and may not be enough to reduce the humidity, although this problem can be solved by setting the timer.  In addition, my family does not like the working fan when taking water procedures, as it "creates a cold wind." <br><br>  The second obvious solution was to simply put the fan on a separate switch and provide control to the person.  But the human factor is such that the fan was constantly forgotten to turn on, and if turned on, turn off.  Fan efficiency quickly went to zero. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I had to connect my passion for Arduino and simple microcontrollers to the case. <br><a name="habracut"></a><br>  Shaking brains formulated <br><br><h4>  Control device requirements </h4><br><br><ol><li>  the control device must operate in automatic mode; </li><li>  the fan should turn on from increased humidity; </li><li>  turning on the fan should not depend on the current level of humidity in the apartment; </li><li>  the fan should work when no one is in the bathroom; </li><li>  control device should be as simple and cheap as possible; </li></ol><br><br><h4>  Element selection </h4><br>  The prototype of this device was created on a Chinese-made Arduino Uno debug board: <br><img src="https://habrastorage.org/getpro/habr/post_images/d4b/df0/348/d4bdf03481a48c882b54eabec39e1d43.jpg"><br><br>  Then everything was transferred to the Atmega328 microcontroller, stitched with a standard Arduin's bootloader. <br><br>  The final device was created according to the principle "I blinded you from what was."  All items were previously purchased on the Internet for various projects or torn out of non-working devices: <br><br><ul><li>  <a href="http://www.aliexpress.com/item/10LOT-ATMEGA328P-PU-without-for-Arduino-BOOTLOADER-DIP-Socket-16MHz-crystal-Kit-Free-shipping-best-prices/591965142.html">Atmega328P-PU microcontroller with socket</a> ; </li><li>  <a href="http://www.ebay.com/itm/Double-Side-Prototype-PCB-Tinned-Universal-Breadboard-5x7-cm-50mmx70mm-FR4-/200926111761%3Fpt%3DLH_DefaultDomain_0%26hash%3Ditem2ec8212811">breadboard</a> ; </li><li>  <a href="http://www.ebay.com/itm/DHT11-DHT-11-Digital-Temperature-and-Humidity-Sensor-Temperature-sensor-Arduino-/400489574221%3Fpt%3DLH_DefaultDomain_0%26hash%3Ditem5d3f09ef4d">DHT11 temperature and humidity sensor</a> ; </li><li>  two-digit seven-segment indicator CPS03621BR from non-working hours; </li><li>  boxed photoresistor with amateur radio; </li><li>  <a href="http://www.ebay.com/itm/DC-DC-Buck-Converter-Step-Down-Module-LM2596-Power-Supply-Output-1-25V-35V-/400560839975%3Fpt%3DLH_DefaultDomain_0%26hash%3Ditem5d43495d27">voltage regulator on the LM2596</a> ; </li><li>  <a href="http://www.ebay.com/itm/10PCS-BT137-600E-BT137-TO-220-600V-8A-Triacs-NEW-GOOD-QUALITY-T3-/290893060599%3Fpt%3DLH_DefaultDomain_0%26hash%3Ditem43ba93d9f7">triac BT137</a> ; </li><li>  <a href="http://www.ebay.com/itm/10PCS-IC-MOC3061-DIP-6-Zero-Cross-Optoisolators-Triac-Drive-NEW-GOOD-QUALITY-/290735848626%3Fpt%3DLH_DefaultDomain_0%26hash%3Ditem43b134fcb2">optoshimistor MOC3061</a> for galvanic isolation; </li><li>  button and several resistors </li></ul><br><br>  The LED driver 3x1W from the luminaire came up as the power source. <br>  As the case was used a cross box from the old PBX. <br><br><h4>  Connection </h4><br>  Due to the fact that <s>there was very laziness</s> in the device, non-standard elements were used, the general scheme did not draw.  I bring the table of connection of elements to the microcontroller: <br><br><ul><li>  Pin 1 (Reset) through a 10K resistor to + (to avoid interference on this leg); </li><li>  Pin 2 (D0) - not used; </li><li>  Pin 3 (D1) - not used; </li><li>  Pin 4 (D2) - the cathode ‚ÄúG‚Äù of a seven-segment indicator; </li><li>  Pin 5 (D3) - cathode "."  seven-segment indicator; </li><li>  Pin 6 (D4) - cathode ‚ÄúA‚Äù of a seven-segment indicator; </li><li>  Pin 7 (+) - 3.5V power supply; </li><li>  Pin 8 (-) - ground; </li><li>  Pin 9 (Clock) - not used; </li><li>  Pin 10 (Clock) - not used; </li><li>  Pin 11 (D5) - cathode ‚ÄúF‚Äù of a seven-segment indicator; </li><li>  Pin 12 (D6) - cathode ‚ÄúD‚Äù of a seven-segment indicator; </li><li>  Pin 13 (D7) - cathode ‚ÄúE‚Äù of a seven-segment indicator; </li><li>  Pin 14 (D8) - cathode "C" seven-segment indicator; </li><li>  Pin 15 (D9) - cathode ‚ÄúB‚Äù of a seven-segment indicator; </li><li>  Pin 16 (D10) - not used; </li><li>  Pin 17 (D11) - not used; </li><li>  Pin 18 (D12) - not used; </li><li>  Pin 19 (D13) - control of the fan on circuit; </li><li>  Pin 20 (+) - 3.5V power supply (double); </li><li>  Pin 21 (Aref) - not used; </li><li>  Pin 22 (-) - ground (double); </li><li>  Pin 23 (A0 / D14) - photoresistor with 27K pull-up resistor to ground; </li><li>  Pin 24 (A1 / D15) - input from the DHT11 sensor; </li><li>  Pin 25 (A2 / D16) - common anode of the 2nd digit of the seven-segment indicator through the 4.7K resistor; </li><li>  Pin 26 (A3 / D17) - common anode of the 1st digit of the seven-segment indicator through the 4.7K resistor; </li><li>  Pin 27 (A4 / D18) - button with pull-up resistor 10K +; </li><li>  Pin 28 (A5 / D19) - not used; </li></ul><br><br>  The datasheet was not found on the CPS03621BR indicator, so the findings were found using a spear battery.  The indicator appeared with a common anode.  Cathode layout: <br><img src="https://habrastorage.org/getpro/habr/post_images/f30/511/1b8/f305111b83ff2a0ca094ea2cf166add4.gif" alt="image"><br><br>  The fan is controlled by a simistor BT137. <br>  Connection diagram taken from the site <a href="http://avr.ru/beginer/avrsbs/step7">avr.ru</a> <br><img src="https://habrastorage.org/getpro/habr/post_images/7ba/01b/12b/7ba01b12b6fe6032e9e5d679a6226c3f.gif"><br>  If someone thinks of repeating - CAUTION, there is 220V voltage on the case of the triac. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/23a/9ea/083/23a9ea083da5ce3f14a07c4765542e1c.jpg"><br><br><h4>  Work algorithm </h4><br><br>  The microcontroller measures the humidity and temperature every 10 seconds. <br>  Humidity cyclically accumulates in the archive of 6 values.  If the current humidity is more than 3% above the first one from the archive or the absolute value of humidity is above 85%, then you need to turn on the fan. <br>  The fan turns on for 20 minutes when there is no light on the photoresistor. <br>  The button forcibly turns on the fan for 20 minutes (if it is not working) or turns it off (if it is working). <br>  All constants in the algorithm were chosen experimentally. <br><br>  The indicator cyclically displays the current temperature, humidity, and the inverse report timer. <br>  The second discharge point lights up if a decrease in humidity is required and flashes if a command to turn on the fan is given. <br><br>  The complete logic of the device can be described by a finite deterministic automaton. <br>  The input alphabet of the automaton consists of the following events (in order of priority): <br><ul><li>  manual mode button pressed; </li><li>  humidity sensor tripped; </li><li>  the light is on; </li><li>  no light is on; </li><li>  The fan timer has been activated. </li></ul><br><br>  Many states: <br><ol><li>  standby mode, the fan does not work, the time is off; </li><li>  the fan is turned on, the fan does not work, the timer (when) is stopped; </li><li>  the fan is in automatic mode, the timer is on; </li><li>  the fan is in manual mode, the timer is on; </li></ol><br><br>  Well, the state transition table of the automaton: <br><img src="https://habrastorage.org/getpro/habr/post_images/530/bdd/691/530bdd6918df1b6b4b8cbd82bbb90a1b.jpg"><br><br><h4>  Programming </h4><br>  I did not install AVR-studio and other monsters, but I managed again with what was - IDE Arduino. <br><br>  I create in the board.txt file a new controller working on an internal 8 MHz quartz: <br><br> <code>atmega328_8.name=Atmega328 (5V, 8 MHz internal) <br> <br> atmega328_8.upload.protocol=arduino <br> atmega328_8.upload.maximum_size=30720 <br> atmega328_8.upload.speed=57600 <br> <br> atmega328_8.bootloader.low_fuses=0xE2 <br> atmega328_8.bootloader.high_fuses=0xDE <br> atmega328_8.bootloader.extended_fuses=0x05 <br> atmega328_8.bootloader.path=optiboot <br> atmega328_8.bootloader.file=optiboot_atmega328.hex <br> atmega328_8.bootloader.unlock_bits=0x3F <br> atmega328_8.bootloader.lock_bits=0x0F <br> <br> atmega328_8.build.mcu=atmega328p <br> atmega328_8.build.f_cpu=8000000L <br> atmega328_8.build.core=arduino <br> atmega328_8.build.variant=standard <br></code> <br><br>  I connect a <a href="http://www.ebay.com/itm/gib-51AVR-USB-MCU-Download-Cable-USBASP-USBISP-Downloader-Support-Win7-/171123398178%3Fpt%3DLH_DefaultDomain_2%26hash%3Ditem27d7bfd622">cheap USBASP programmer</a> to the ISCP connector of the Arduino UNO board and, inserting my Atmega328P into the socket, flashing the bootloader. <br><br>  Now my microcontroller can be debugged and programmed via a standard bootloader on the UNO board, by selecting the appropriate board in the environment. <br><br>  In this project, ready-made libraries for Arduino were used: <br><br><ul><li>  <a href="https://github.com/adafruit/DHT-sensor-library">Arduino DHT library</a> for working with a DHT11 sensor </li><li>  <a href="https://github.com/likema/Arduino-SevenSegmentDisplay">Seven Segment Display</a> to work with the seven-segment indicator. </li></ul><br><br><div class="spoiler">  <b class="spoiler_title">Full sketch code</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;DHT.h&gt; #include &lt;SevenSegmentDisplay.h&gt; #define DEBUG 1 #define TIMER_PERIOD 2400 #define ctrPIN 13 //    #define dhtPIN 15 //     #define btnPIN 18 // //      void(* resetFunc) (void) = 0; // Reset MC function //    SevenSegmentDisplay&lt;true, BiDigit&lt;17, 16&gt; &gt; ss(4, 9, 8, 6, 7, 5, 2, 3); //  DHT11     8 DHT dht(dhtPIN, DHT11, 3);// 8 //DHT dht(dhtPIN, DHT11); //16 //  FSM enum TMode { tmWait, //  tmNeedPower, //   tmAutoPower, //     tmManualPower //     }; //   enum TDisplayMode { tdmTemp , //  tdmHum , //  tdmTimer //  }; //int h_prev; int t,h,a0; int h_arr[6]; void setup() { //    #ifdef DEBUG Serial.begin(9600); Serial.println("Humidity controller start ..."); #endif //    pinMode(ctrPIN, OUTPUT); //      digitalWrite(ctrPIN, LOW); //     pinMode(btnPIN, INPUT); //   digitalWrite(btnPIN, HIGH); //    DHT11 dht.begin(); //     h = dht.readHumidity(); for( int i=0; i&lt;6; i++)h_arr[i] = h; } //  0.5   unsigned long cnt05 = 0; unsigned long ms1 = 0; //    boolean flag_light = false; //    boolean flag_btn = false; //   boolean flag_hum = false; //     unsigned int timer = 0; TMode mode = tmWait; TDisplayMode dmode = tdmTemp; boolean blink_stat = false; void loop () { unsigned long ms = millis(); int p = ms - ms1; //    if( digitalRead(btnPIN) == LOW ){ int n = 1; for( int i=0; i&lt;9; i++ ){ if( digitalRead(btnPIN) == LOW )n++; delay(10); } if( n &gt; 9 )flag_btn = true; delay(400); #ifdef DEBUG Serial.println("Button is press"); #endif }//end if // ,     0.5  if( p &lt; 0 || p &gt; 500 ){ cnt05++; ms1 = ms; //    a0 = analogRead(A0); if( a0 &gt; 1000 )flag_light = false; else flag_light = true; //  10    DHT11     if( cnt05%20 == 0 ){ h = dht.readHumidity(); t = dht.readTemperature(); //     3%    85% if( h - h_arr[5] &gt; 3 || h &gt; 85 )flag_hum = true; //      for( int i=5; i&gt;0; i--)h_arr[i] = h_arr[i-1]; h_arr[0] = h; #ifdef DEBUG Serial.print("VAL: Temp="); Serial.print(t); Serial.print(" H="); Serial.print(h); Serial.print(" A0="); Serial.print(a0); Serial.print(" X="); Serial.print(cnt05); Serial.print(" TM="); Serial.print(timer); Serial.print(" MODE="); Serial.print(mode); Serial.print(" DMODE="); Serial.print(dmode); Serial.println(""); #endif //   switch( dmode ){ case tdmTemp : dmode = tdmHum; break; case tdmHum : dmode = tdmTimer; break; default: dmode = tdmTemp; }//end switch }//end if( cnt05%20 == 0 ) blink_stat = !blink_stat; SetStatusFSM(); }//end if( p &lt; 0 || p &gt; 500 ){ DisplayStatus(); }//end loop() /** *     */ void DisplayStatus(){ //     int point = -1; switch( mode ){ case tmNeedPower: point = 0; break; case tmAutoPower: case tmManualPower: if( blink_stat )point = 0; break; } switch( dmode ){ case tdmTemp : ss.print((unsigned)t,point,50); break; case tdmHum : ss.print((unsigned)h,point,50); break; case tdmTimer: //   if( timer &gt; 120 )ss.print((unsigned)(timer/120),point,50); //   else if( timer &gt; 0 )ss.print((unsigned)(timer/2),point,50); //  0 else ss.print(0,point,50); // ss.print((unsigned)(a0/100),point,50); break; }//end switch } /** *     */ void SetStatusFSM(){ switch(mode){ //   case tmWait : digitalWrite(ctrPIN, LOW); //   if( flag_btn ){ timer = TIMER_PERIOD; mode = tmManualPower; } //     else if( flag_hum ){ timer = TIMER_PERIOD; mode = tmNeedPower; } break; //     case tmNeedPower: digitalWrite(ctrPIN, LOW); //   if( flag_btn ){ mode = tmManualPower; } //   else if( !flag_light ){ mode = tmAutoPower; } break; //  "   " case tmAutoPower: //   digitalWrite(ctrPIN, HIGH); //   if( timer &gt; 0 )timer--; //   if( flag_btn ){ mode = tmWait; timer = 0; } //   else if( flag_light ){ mode = tmNeedPower; } //   else if( timer &lt;= 0 ){ timer = 0; mode = tmWait; } break; //  "    " case tmManualPower: //   digitalWrite(ctrPIN, HIGH); //   if( timer &gt; 0 )timer--; //   if( flag_btn ){ mode = tmWait; timer = 0; } //   else if( timer &lt;= 0 ){ timer = 0; mode = tmWait; } break; } //      flag_btn = false; flag_hum = false; }</span></span></span></span></code> </pre><br></div></div><br><br><h4>  Problems </h4><br><br>  The first problem I encountered in the implementation was that the DHT11 sensor was not working.  On Arduino UNO, everything is fine, but on a bare microcontroller does not work.  The problem was in the frequency of the controller and timing of the DHT polling protocol. <br>  In controllers operating at 8 MHz in the DHT library, it is necessary to specify the delay "3" (the third parameter in the class constructor) DHT dht (dhtPIN, DHT11, 3); <br><br>  The second problem was the arbitrary operation of the reset and manual mode buttons.  The reason for all was the interference from power wires passing close to these findings.  First, the built-in pull-up resistor of the microcontroller on the corresponding pins was replaced with an external 10K.  The interference has decreased, but has not disappeared altogether.  The controller periodically lived its life independently turning on / off the fan. <br>  Then I implemented software interference suppression - the button was interrogated in a row 10 times with a delay of 10 ms, and only with all 10 actuations, was the button pressed. <br><br>  The finished device looks like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/193/f41/269/193f4126927f2ebd67d930a29d4b29b3.jpg"><br><br>  Now the fan control controller is in trial operation, and I am considering the control of the fan in the kitchen: from the switched on stove, smoke and the smell of gas. <br><br>  List of useful links: <br><ul><li>  <a href="http://www.atmel.com/Images/doc8161.pdf">Technical description of the Atmega328P microcontroller</a> </li><li>  <a href="http://avr.ru/beginer/avrsbs/step7">Power control from the microcontroller</a> </li><li>  <a href="http://zelectro.com.ua/bootloaderUSBasp">Fill the bootloader in the microcontroller</a> </li><li>  <a href="http://arduino.ru/forum/apparatnye-voprosy/duino-na-vnutrennem-rezonatore-mozhet-komuto-budet-polezno">Duino on the internal resonator</a> </li><li>  <a href="http://easyelectronics.ru/avr-uchebnyj-kurs-konfiguraciya-fuse-bit.html">FUSE configuration bit</a> </li></ul><br><br>  All articles my articles can be found in my blog <a href="http://samopal.pro/">samopal.pro</a> </div><p>Source: <a href="https://habr.com/ru/post/213789/">https://habr.com/ru/post/213789/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../213775/index.html">Writing a driver for an LCD display under embedded linux</a></li>
<li><a href="../213779/index.html">Reverse side of freedom of freelancing</a></li>
<li><a href="../213783/index.html">Hacking accounts through the form and event. "XSS" to avoid confusion with cascading style sheets</a></li>
<li><a href="../213785/index.html">Duplicate code search plugin for QtCreator</a></li>
<li><a href="../213787/index.html">The harsh life of a game tester</a></li>
<li><a href="../213791/index.html">Valentine's day gift for 4 nights and 1 day</a></li>
<li><a href="../213795/index.html">SmartWatch for Vasya Engineer</a></li>
<li><a href="../213797/index.html">We program robots on Windows 8. Sphero magic ball</a></li>
<li><a href="../213799/index.html">Future Sales: Cyber ‚Äã‚ÄãEyes for a Manager</a></li>
<li><a href="../213801/index.html">Several useful CSS tricks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>