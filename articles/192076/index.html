<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Learning Tarantool + Lua</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share the experience of studying Tarantool. I will not write about all the advantages and features of the Tarantula itself, there have been ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Learning Tarantool + Lua</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage3/e96/3db/d48/e963dbd483aca9f66cd94e81a2be9d25.png" alt="logo" align="left"><br>  I want to share the experience of studying Tarantool.  I will not write about all the advantages and features of the Tarantula itself, there have been many articles on this topic (for example, <a href="http://habrahabr.ru/post/133435/">this</a> , <a href="http://habrahabr.ru/company/mailru/blog/136288/">this</a> and <a href="http://habrahabr.ru/post/155575/">this</a> ).  This post tells how to start working with a tarantula and about some of the features and goodies that can be obtained from the box. <br clear="all"><a name="habracut"></a><br><br><h5>  Install </h5><br><br>  Actually, the first thing I encountered was the installation.  Since I had to install it for tests on MacOS, then, most likely, very few people will come to this, but nevertheless.  The package that was offered on the site was not established either because of some kind of dependencies, or because the system has already experienced more than one experiment.  Therefore, I decided to collect from source. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The installation process is well described in the README.  Do not forget to download submodules, if the source is downloaded from git.  Even when building under MacOS, you do not need to be afraid of the fact that not all tests pass - the documentation says that this is normal. <br>  If you want to get a console client, cmake must be run with the DENABLE_CLIENT = true key.  Actually, after make we get the server and the client, if asked, src / box / tarantool_box and client / tarantool / tarantool, respectively. <br><br><h5>  Configuring the server </h5><br>  For example, you can take the configuration of one of the tests, for example, test / box / tarantool.cfg <br>  One of the important parameters is slab_alloc_arena - this is the amount of memory used by the Tarantula.  I advise you to study this parameter in more detail.  It is also worth paying attention to the rows_per_wal, so you do not wonder why so many small files lie))) <br>  Now we proceed to the most interesting.  A tarantula only needs to know about the indexes, and he absolutely doesn‚Äôt care what will be stupid and what size it will be.  Actually, in the config we describe only indices.  In more detail types of indexes can be studied in the documentation.  From the main point: when choosing an index, you need to understand exactly what it is for.  HASH-index can not be non-unique.  TREE indexes are good to use for organizing a sorted list by non-unique values.  Also, indexes can be composite.  Indexes are described for each space.  Spaces can be a lot. <br>  Total: Imagine that we need a space with 5 fields.  The first field is non-unique, with the first + second field unique;  we will do point selections on them.  In the fourth field there is a certain parameter for sorting.  Total build a unique index: <br><blockquote>  space [0] .index [0] .type = "HASH" # index type <br>  space [0] .index [0] .unique = 1 # sign of uniqueness <br>  space [0] .index [0] .key_field [0] .fieldno = 0 # record number in bluntly <br>  space [0] .index [0] .key_field [0] .type = "NUM" # data type <br>  space [0] .index [0] .key_field [1] .fieldno = 1 <br>  space [0] .index [0] .key_field [1] .type = "NUM" <br></blockquote><br>  We build an index to fetch a pack of non-unique records by the first field: <br><blockquote>  space [0] .index [1] .type = "TREE" <br>  space [0] .index [1] .unique = 0 <br>  space [0] .index [1] .key_field [0] .fieldno = 0 <br>  space [0] .index [1] .key_field [0] .type = "NUM" <br></blockquote><br>  Build an index to select sorted records by the first + third field <br><blockquote>  space [0] .index [2] .type = "TREE" <br>  space [0] .index [2] .unique = 0 <br>  space [0] .index [2] .key_field [0] .fieldno = 0 <br>  space [0] .index [2] .key_field [0] .type = "NUM" <br>  space [0] .index [2] .key_field [1] .fieldno = 3 <br>  space [0] .index [2] .key_field [1] .type = "NUM" <br></blockquote><br>  Well, do not forget that the space should be made active: <br><blockquote>  space [0] .enabled = 1 </blockquote><br>  Now we will describe another space where the stupid of two fields will be stored: the first is the unique, the second is not.  Typical key value storage in its simplest representation: <br><blockquote>  space [1] .enabled = 1 <br>  space [1] .index [0] .type = "HASH" <br>  space [1] .index [0] .unique = 1 <br>  space [1] .index [0] .key_field [0] .fieldno = 0 <br>  space [1] .index [0] .key_field [0] .type = "NUM" <br></blockquote><br>  Actually, with these settings, the Tarantula is ready for work.  It is necessary to initialize the repository - and go. <br><pre><code class="bash hljs">&gt; ./src/box/tarantool_box --init-storage tarantool/src/box/tarantool_box: space 0 successfully configured tarantool/src/box/tarantool_box: space 1 successfully configured tarantool/src/box/tarantool_box: creating <span class="hljs-string"><span class="hljs-string">'./00000000000000000001.snap.inprogress'</span></span> tarantool/src/box/tarantool_box: saving snapshot <span class="hljs-string"><span class="hljs-string">'./00000000000000000001.snap'</span></span> tarantool/src/box/tarantool_box: <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br>  As you can see, he created all the files in the folder from which we launched Tarantula.  If you want to change it, then in the settings there is a wirk_dir parameter, which can be determined at will. <br><br>  After that we start the server: <br><pre> <code class="bash hljs">&gt; ./src/box/tarantool_box --background &gt; ps xa | grep tarantool 5627 ?? Us 0:10.55 tarantool/src/box/tarantool_box --background</code> </pre><br>  Hooray!  You can start filling with data and extract them in the desired sequence and according to the necessary criteria. <br><br><h5>  Getting started </h5><br>  How to use the console client and paint every command in detail now I will not - this could be the topic of a separate article.  And now I‚Äôll focus on the Lua procedures.  One of the interesting, in my opinion, features is the built-in procedures.  With their help, you can make some "black box" with business logic, which can be easily and independently of the rest of the code can be changed, thereby separating the technical part from the business model.  I think that Lua is a very good hint to the fact that business logic will be stored there. <br>  So, at the start, the tarantula is trying to load the init.lua file, into which we will add our functions. <br><br>  When writing functions, special attention should be paid to data types that are not present in Lua and, for example, not in Perl, but because of the implementation features of protocols, Perl numbers in Lua do not come in the same way as they come from the console client.  So, while not supporting the data types in the adapters to the Tarantula, you can always transfer strings and where you need to convert them into numbers. <br><br>  We write a procedure that will change one field depending on the value of another field and the current date.  A very standard task, which, as a rule, is ‚Äúblurred‚Äù in the code, and at the next refactoring an error occurs with the calculation of dates in this logic. <br><pre> <code class="lua hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">increase_score</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id, id2)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> id = <span class="hljs-built_in"><span class="hljs-built_in">tonumber</span></span>(id) ‚Äî     <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> fid = <span class="hljs-built_in"><span class="hljs-built_in">tonumber</span></span>(id2) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(id == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> fid == <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ‚Äî    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-comment"><span class="hljs-comment">--     date_time local dt = os.date("*t") --       local cd = os.time({year = dt.year; month=dt.month; day=dt.day}) --    0 ,    0  local tup = box.select('0','0', id, fid) if( tup == nil ) then --      ,    box.insert('0', id, fid, cd, 100,cd) else local lu = box.unpack('i', tup[2]) local sc = box.unpack('i', tup[3]) local la = box.unpack('i', tup[4]) --        local diffs = (math.floor(sc/((la-lu)/24/60/60+30))+1)*((cd-lu)/24/60/60) if( diffs &lt; 0 or diffs &gt; sc ) then --   ,    : -- -   30   -- -            diffs = sc end --      diffs = 100 - diffs box.update('0',{id;fid},'+p=p=p',3, diffs,2,cd,4,cd) --    0     end end</span></span></code> </pre><br>  In total, it can be considered that this is an atomic action from the point of view of an external system. <br><br>  Now a few words about performance.  The call frequency of this procedure has reached 20,000 rps.  In this case, the pebble load was 67%. <br><br>  Further I will tell about one more delicacy.  The update with the calculation described above is good, but in addition to the update, as a rule, the task says that these data must be retrieved and, moreover, must be given in a sorted order.  In order not to take out the sorting to the external system and not to do the sorting ourselves, let's use the indices. <br><pre> <code class="lua hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_top</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uid)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> id = <span class="hljs-built_in"><span class="hljs-built_in">tonumber</span></span>(uid) ‚Äî    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(id == <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-comment"><span class="hljs-comment">-- ,      return false end local ret = {} --             id. --     ,         --   ,      . --   ,        , --      ( ,    ) for v in box.space[0].index[2]:iterator(box.index.LE, id) do if( v == nil or #ret == 10 or box.unpack('i',v[0]) ~= id) then break end -- , : -- -   , -- -    10    -- -         table.insert(ret, v) end return unpack(ret) end</span></span></code> </pre><br>  So we created a procedure that, taking advantage of the charms of the index, returns to us a list of sorts sorted in descending order.  Regarding the sorting order, you can search the documentation box.index.LE and see what is different and how it works. <br><br>  And most importantly: from the client, these procedures are called like this: <br><pre> <code class="bash hljs">&gt; lua increase_score(1,2)</code> </pre>  and <br><pre> <code class="bash hljs">&gt; lua get_top(1)</code> </pre> <br><br>  In the next article I will write how all this good can solve one of the most common tasks and show the peculiarities of using the driver for communicating with the Perl Tarantula. </div><p>Source: <a href="https://habr.com/ru/post/192076/">https://habr.com/ru/post/192076/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../192062/index.html">Notes iOS developer: Sharing experience, part 1</a></li>
<li><a href="../192064/index.html">Fresh impressions of the BlackBerry 10 NDK</a></li>
<li><a href="../192066/index.html">Imagination will release server MIPS processors by the end of 2014</a></li>
<li><a href="../192068/index.html">Major update HabraDesigner</a></li>
<li><a href="../192070/index.html">[Post] Friday - dictionary with Lettered.Me</a></li>
<li><a href="../192078/index.html">Computer History Museum</a></li>
<li><a href="../192080/index.html">Roskomnadzor began active actions against telecom operators not blocking prohibited sites</a></li>
<li><a href="../192082/index.html">9 most important facts about mobile advertising</a></li>
<li><a href="../192084/index.html">Convenient file synchronization</a></li>
<li><a href="../192090/index.html">Core Data for iOS. Chapter number 2. Practical part</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>