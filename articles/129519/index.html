<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Model-oriented design, or taking the Cortex M3 by storm with Matlab / Simulink</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Justification 
 Immediately, I‚Äôll make a reservation that I began the study of microcontrollers with the KR580 as part of the CMD with such awesome ch...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Model-oriented design, or taking the Cortex M3 by storm with Matlab / Simulink</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/67931c17/d1be6012/7a7c9407/9578d97a.png" title="Workstation developer of microprocessor control systems in Toyota"><br><br><h4>  Justification </h4><br>  Immediately, I‚Äôll make a reservation that I began the study of microcontrollers with the KR580 as part of the CMD with such awesome characteristics: <br>  Type of MP used - KR580VM80A. <br>  The amount of RAM - 3 KB. <br>  The amount of ROM - 2 KB. <br>  Ability to interrupt - 1 vector. <br>  Software - system program "Monitor". <br>  The input and output levels are compatible with TTL levels. <br>  ... <br>  <b>Product weight not more than 9.6 kg!</b> <br><a name="habracut"></a><br>  <b>Photos of this technology found on the Internet, and I am not on it!</b>  But the atmosphere of the work conveys excellent! <img src="https://habrastorage.org/storage1/6fb77abc/81f3c6b5/2fadb309/40c6f1bd.jpg" align="right"><br>  I have a general concept of assembly language (in hexadecimal codes from a hardware keyboard), registers, and other things that people immediately start writing in C are blamed for not knowing.  It is this close acquaintance that completely discouraged from now on writing in assembler, but C fans also have something to kick me off.  I will not program microcontrollers on C in this topic.  I will be more exact, but a little non-standard image. <br>  Although I work in the field of software development, I am indirectly associated with programming.  So the information presented below is intended more likely for beginners in electronics and programming, although it gives a considerable chance to apply advanced technologies adopted by world leaders. <br><br><h4>  Closer to the point </h4><br>  Back to the microcontroller programming I was forced by an article like the following: <br>  <a href="http://www.mathworks.com/automotive/userstories.html%3Ffile%3D2340">MathWorks Tools Help Toyota Design for the Future</a> <br>  ‚ÄúMATLAB, Simulink, and Stateflow ... have become the de facto standard at Toyota for simulation, data processing, and controls design.  It would be impossible to list all the tools for Toyota at Toyota. ‚Äù <br>  Akira Ohata, Toyota <br>  If such a " <a href="http://brandz.ogilvyeditions.com/top100/2011/">well-known</a> " company like Toyota chooses for itself a certain strategy for the development of new products, then this path may not be of interest to the public.  So what is model-oriented design? <br>  <a href="http://sl-matlab.ru/solutions/model/">Quote from the Matlab distributor site.</a> <br>  Model-oriented design (hereinafter referred to as MOS) is an efficient and cost-effective way of developing control systems, processing signals and images, building communication systems, developments in the field of mechatronics, and creating embedded systems.  The application of this approach in Tesla, General Motors, Harman Becker, mainroland, Toyota, and others has increased the product quality and reduced development time more than doubled. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Instead of physical prototypes and textual specifications in model-oriented design, an executable model is used.  This model is used in all stages of development.  With this approach, it is possible to develop and carry out simulation modeling of both the entire system as a whole and its components.  There is the possibility of <b>automatic code generation</b> , testing in continuous mode and verification. <br><br><h4>  Formulation of the problem </h4><br>  Port the control system model from Simulink to a real device with minimal time costs. <br>  Applying a MOS for simple blinking with a diode seems to me to be too easy a start, so immediately we will master the analog-to-digital converter (ADC).  Let various ports be activated depending on the level of the input to the ADC and the LEDs will flash with pulses of different frequency and duty cycle. <br><br><h4>  Target selection </h4><br>  Under the hand of the good old KR580 was not there, and I started looking for another stone. <br>  As a result of studying the rather changed market of microprocessor technology, my choice fell on <b>stm32 vl Discovery</b> with the Cortex M3 (STM32F100RB) on board. <br><br>  Benefits: <br><ol><li>  Price </li><li>  Availability of the <a href="http://www.fioboards.com/">Rapidstm32</a> library for Simulink </li><li>  Excellent articles <a href="http://habrahabr.ru/search/%3Fq%3Dstm32">on Habr√©</a> and <a href="http://easyelectronics.ru/index.php%3Fs%3Dstm32">just electronics</a> </li><li>  The presence of a built-in programmer and debugger ST-LINK </li><li>  Enough other benefits </li></ol><br>  Disadvantages: <br><ol><li>  The <a href="http://www.fioboards.com/">Rapidstm32</a> library works in full-featured mode with only $ 80 <a href="http://www.fioboards.com/products/fio-boards.html">FiO Std</a> boards. </li><li>  ARM after KR580 was <s>not</s> much more complicated than I imagined </li></ol><br>  Considered option with Arduino, which is also <a href="http://www.mathworks.com/academia/arduino-software/arduino-simulink.html">friends</a> with Matlab / Simulink.  On youtube just <a href="http://www.youtube.com/results%3Fsearch_query%3Darduino%2Bmatlab%2Bsimulink%26aq%3Df">wonders</a> with this bundle can be viewed.  Now I study the techniques of the respected DI HALT, I hope the next step will be purely your device. <br><br><h4>  Software </h4><br><ol><li>  Matlab R2011a composed of: <br>  Simulink 7.3 or later <br>  Embeded coder <br>  Simulink coder <br>  Realtime workshop <br>  Stateflow and other toolboxes as desired </li><li>  <a href="http://www.fioboards.com/">Rapidstm32</a> library </li><li>  <a href="">Microsoft .NET Framework 3.5 is</a> required by this very library. </li><li>  <a href="http://www.keil.com/arm/mdk.asp">MDK-ARM Microcontroller Development Kit</a> for compiling code, or other convenient package </li></ol><br><br><h4>  Hardware </h4><br><ol><li>  stm32 vl Discovery (do not forget to read the <a href="http://www.st.com/internet/evalboard/product/250863.jsp">manuals and datasheets</a> ) </li><li>  Mini USB cable (not included with the board) </li><li>  Bread board </li><li>  LEDs </li><li>  Trimmers Resistors </li></ol><br><h4>  MOS </h4><br><h5>  Setting up a future model </h5><br><br>  Create a new model in Simulink, go to Simulation -&gt; Configuration parameters and configure everything as shown below: <br><img src="https://habrastorage.org/storage1/ac46d310/86b7c8cc/d1d5f0cc/dcb9ea57.png"><br><br><img src="https://habrastorage.org/storage1/abff74c7/031c1e97/2452ada3/9e0d1337.png"><br><br><h5>  Build a model </h5><br>  From the Simulink library, we select the blocks we need, place them conveniently, connect them with connections. <br>  This procedure took me about two minutes with breaks for reading the manual. <br>  It should be something like this: <br><img src="https://habrastorage.org/storage1/7c5fc2d8/f13dca47/9b06bc3c/6cd2247a.png"><br>  In addition to what it looks like a visual diagram of the system, it is also ‚Äúlive‚Äù! <br><br>  Then double-click Update diagram on the model window toolbar.  After the first click, an evil window will pop up: <br><img src="https://habrastorage.org/storage1/5863a6aa/16182d4a/99934947/f4fe7a64.png" align="right"><br>  They say in it that since we did not buy the original FiO Std board, we will not receive the full version of the library either.  The fact that the frequency will be limited to 24 MHz is not terrible for us, the frequency of our stone is just that.  But other restrictions are rather unpleasant, so I still think about arduino ... <br>  After the second press, the color gamut of individual blocks and links will change in accordance with the selected clocking.  You can view the clocking map by pressing Ctrl + J: <br><br><img src="https://habrastorage.org/storage1/dd020374/63e63f57/2f8f38ac/15d38683.png"><br><br>  After updating the diagram, you can safely press Ctrl + B and build our model.  This can also be done from the menu Tools -&gt; Code Generation -&gt; Build Model. <br>  As a result of the construction, we should see in the Matlab command window a construction history with beautiful lines at the end: <br> <code>********************************************************************* <br> RapidSTM32: Target built directory is: adcpwm_rapidstm32 <br> RapidSTM32: Build completed at: 01-Oct-2011 22:52:36 <br> ********************************************************************* <br> ### Successful completion of Real-Time Workshop build procedure for model: adcpwm</code> <br>  But not everything is as smooth as it seems!  Before seeing these lines, I looked at error reports of the following type for a long time: <br> <code>### Real-Time Workshop build procedure for model: 'target' aborted due to an error.</code> <br>  Knocked on all sorts of forums including the <a href="http://www.mathworks.com/matlabcentral/">official Matlab user portal</a> .  All ended with a video conference with one of the developers of the library.  Dear Krisada Sangpetchsong from Thailand fixed a bug in the file <a href="">rapidstm32_exit_hook.p</a> , and promised that everything will be fixed in the new version of the library.  I had this file along the path C: \ rapidstm32 \ rapidstm32, since by default the library is installed in the root C: \. <br>  As a result of the successful code generation, another folder named model_apidstm32 with the source code of the C code should appear in the folder with the model. <br><br><h5>  Create a project in keil </h5><br>  We need to create a project in the same folder where Matlab has placed our source code, and call it meaningfully.  When creating we will be asked the type of device, what you need to answer STM32F100RB. <br>  <b>Important!</b>  After specifying the device type, there will be a question about adding a startup file to a new project.  Here you need to answer NO, since this file is also already created from our model. <br>  In the project window in the created group New Gpoup from the context menu, we add files with the extension * .c and * .s. <br><img src="https://habrastorage.org/storage1/36f5eb1e/b8dd409b/a8cf5176/93d3e781.png"><br>  With the selected root of the Target 1 project tree, we call up the Target Options settings, and configure each tab as shown below: <br><img src="https://habrastorage.org/storage1/dbca337d/4985f4f5/abfceab8/f95c5268.png"><br><br><img src="https://habrastorage.org/storage1/d11a2cef/7b34deea/33e777d1/a5edcea3.png"><br><br><img src="https://habrastorage.org/storage1/0e32b6aa/9de6be5a/1e03c216/1d5b3d7d.png"><br><br><img src="https://habrastorage.org/storage1/806bb007/b84d4fab/374d6f46/c28255af.png"><br><br><img src="https://habrastorage.org/storage1/f956bd2e/b88c442f/88b24a50/8f8fc668.png"><br>  After that click Build (F7) and see in the status line: <br> <code>"__.axf" - 0 Error(s), 0 Warning(s).</code> <br> <br><h5>  Firmware and debugging </h5><br>  In order to flash our board, you need to click the Download button on the Keil toolbar.  Here I encountered a second difficulty.  The board did not want to be stitched and gave the error "NO ST-Link Detected".  The problem was solved by replacing the Keil \ ARM \ STLink \ STLinkUSBDriver.dll driver with an older one that can be found <a href="">here</a> .  After that, the board is stitched, and debugging is launched by Ctrl + F5.  Pressing the cherished Reset button allows you to see how the demo board reacts to the rotation of the trimmer: <br><iframe width="560" height="315" src="https://www.youtube.com/embed/VGh2YEdrzyg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><h4>  findings </h4><br>  This topic is certainly not for one topic, I have already delayed the final.  I deliberately did not go into the details of setting up blocks of the model and circuit design.  But the fact that the time to create a prototype of the product is reduced by several times I think can be seen with the naked eye.  With the help of Simulink and Stateflow (event-oriented development based on the theory of finite automata), literally "on the knee" you can assemble an extremely complex control system.  Here we are limited only by the capabilities of the hardware and to have a concept in modeling, and the development time is no longer the decisive factor. <br>  If the topic is interesting, I can please with a couple more topics dedicated to <a href="http://en.wikipedia.org/wiki/Model-based_design">Model-based design</a> . <br><br>  Thank you for attention! <br><br><h4>  Information sources </h4><br><ol><li>  <a href="http://www.mathworks.com/">Matlab website</a> </li><li>  <a href="http://blogs.mathworks.com/">Matlab User Blogs</a> </li><li>  <a href="http://www.aimagin.com/learn/index.php/Learn_RapidSTM32_Home">Rapidstm32 Developer Training Portal</a> </li></ol><br><h4>  Attachments </h4><br><ol><li>  <a href="">Keil Project</a> </li><li>  <a href="">Simulink source model</a> </li></ol><br><br>  UPDATE 1: <br><br>  Screenshot of checking the logic of the model before generating code: <br><img src="https://habrastorage.org/storage1/38e1981b/1c5051f8/21bc320b/2256aa84.png"></div><p>Source: <a href="https://habr.com/ru/post/129519/">https://habr.com/ru/post/129519/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../129512/index.html">Samsung introduced the Galaxy Tab 7.0 Plus</a></li>
<li><a href="../129514/index.html">Tactoom - closed beta testing</a></li>
<li><a href="../129515/index.html">Microsoft Security Essentials removes Google Chrome, considering it PWS Win32 / Zbot</a></li>
<li><a href="../129516/index.html">The simplest logical circuit. Part 2: rules for connecting modules to each other and analyzing simple logic circuits</a></li>
<li><a href="../129518/index.html">A selection of interesting facts about the great IT people</a></li>
<li><a href="../129520/index.html">Premium .me auctions</a></li>
<li><a href="../129521/index.html">From user to developer</a></li>
<li><a href="../129522/index.html">rusleaks.com - personal data of Russians on the Internet</a></li>
<li><a href="../129523/index.html">Sharp 3D phone review compared to HTC Evo 3D and LG Optimus 3D</a></li>
<li><a href="../129525/index.html">Eric Schmidt: our autonomous cars drive better than you ... drunk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>