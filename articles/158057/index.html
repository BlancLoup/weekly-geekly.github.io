<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Office telephony on Asterisk + FreePBX</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 For some political reasons, I was faced with the task of transferring the telephony of our office from the hybrid analog PBX Panasonic KX...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Office telephony on Asterisk + FreePBX</h1><div class="post__text post__text-html js-mediator-article"><h5>  Prehistory </h5><br>  For some political reasons, I was faced with the task of transferring the telephony of our office from the hybrid analog PBX Panasonic KX-TDA200 to SIP.  Simplified the task of having an SCS in the office, and made it difficult for operators to use panels with buttons for quickly switching calls. <br><a name="habracut"></a><br>  Considered options: <br><ul><li>  Upgrade PBX to KX-TDE Series </li><li>  Buy something iron, such as Cisco or Avaya </li><li>  Put Asterisk </li></ul><br>  Being a supporter of free software, I persuaded the authorities to accept the third option.  Moreover, I just released a server that could be used for this task. <br><br><h5>  Procurement and preparation </h5><br>  To communicate with the city telephone networks, the <a href="http://www.openvox.cn/en/products/t1e1j1-cards/de130e.html">OpenVox DE130E</a> was purchased.  Phones were purchased by <a href="http://www.grandstream.com/">Grandstream</a> . <br><br>  I put on the server: <br><ul><li>  Current debian version </li><li>  dhcp3-server - for distribution of addresses and parameters to telephones </li><li>  ntp - to provide the phones with the current time </li><li>  tftp - to provide phones with firmware and configurations </li><li>  mysql, apache, php - for FreePBX </li><li>  build-essential - to build Asterisk </li></ul><br><h5>  Assembly </h5><br>  I decided to take Asterisk not from the package, but from the source code, since there was no certainty that it would work from the package with the OpenVox board. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h6>  DAHDI driver for OpenVox </h6><br>  Instructions for building and configuring DAHDI drivers are available on the openvox website ( <a href="http://downloads.openvox.cn/pub/manuals/V2.2/English/D130E%2520DE130E_on_DAHDI_User_Manual.pdf">PDF</a> ).  No ambushes were met.  Zhelezyaka immediately saw the stream. <br><br><h6>  Asterisk </h6><br>  Asterisk I took version 10.9.0 (yes, they recently changed the principle of numbering versions).  I downloaded, unpacked, said <code>./configure; make menuconfig</code>  <code>./configure; make menuconfig</code> , just like in the old days for the kernel.  First ambush - for menuconfig need ncurses, newt or GTK.  Moreover, since we collect from source, we need -dev versions of libraries (this is also true for all other packages delivered in the process). <br>  asterisk menuconfig is clear and convenient, if some component cannot be assembled, then it is written that you need to add it to make the assembly.  For example, for a fax, <code>libspandsp-dev</code> had to be delivered.  Do not forget to restart <code>./configure</code> after installing the libraries.  If additional files are required for assembly, they will be downloaded automatically. <br><br>  For FreePBX to work, it is necessary that Asterisk has a manager interface.  You need to remember to turn on this module, and before installing FreePBX, put the imputed password and permissions in the /etc/asterisk/manager.conf file. <br><br>  So, all components are selected, you can run standard <code>make; make install</code>  <code>make; make install</code> .  Installing FreePBX will require us to run asterisk, so let's say <code>make samples</code> . <br><br>  <b>Attention!</b>  After this, when you start, you will get an absolutely live asterisk in the configuration "for example", which is not a model of security.  In other words - turn off the firewall. <br><br>  FreePBX requires Asterisk and Apache to spin from the same user, so we create the user and the asterisk group, register them in the Apache config.  Permishy on files FreePBX will adjust on their own. <br><br><h6>  Freepbx </h6><br>  Surprisingly, no rake appeared.  I downloaded, strictly according to the instructions, created a database, user, ran the scripts, launched.  You can go to the interface settings. <br><br><h5>  Customization </h5><br><br><h6>  Initial setup </h6><br>  On the first screen of the administration interface in the ‚ÄúFreePBX Notices‚Äù area, a lot of messages appeared that there are many configuration files in / etc / asterisk that FreePBX itself should manage.  I deleted these files (saved copies).  When you click the big red ‚ÄúApply Config‚Äù button, FreePBX generated the necessary files by itself. <br><br><h6>  Selection of FreePBX Modules </h6><br>  Went to ‚ÄúAdmin - Module Admin‚Äù.  Noted repositories Basic, Extended and just in case Unsupported.  I clicked on "Check Online" and got the opportunity to collect modules for myself.  In addition to the default settings, I chose: <br><ul><li>  Call Recording - to record conversations </li><li>  Conferences - to organize conferences with passwords, etc. </li><li>  Ring Groups - for group call processing (secretaries) </li><li>  PBX End Point Manager - for creating phone configurations </li><li>  Fax Configuration - to configure the fax </li></ul><br><br><h6>  Preparing phone settings </h6><br>  Group settings of phones are very conveniently done using the End Point Manager. <br><br>  In the Connectivity - End Point Configuration, you need to select the manufacturer and phone models that we use.  Just for starters, you should click on ‚ÄúCheck for Updates‚Äù, as the project is quite lively and constantly releases new models. <br><br>  Then in the Connectivity - End Point Advanced Settings you need to set the path to the directory from where tftp distributes files.  And now there are several options: <br><ul><li>  You can connect all the phones, wait for the download and scan the network from the "Connectivity - End Point Device List" </li><li>  When entering the device, you can fill in the End Point Manager section, specifying the MAC address and device model </li><li>  You can add devices one by one. </li></ul><br>  I registered one phone for each model, edited the settings templates, and then when entering each device I indicated its MAC address and selected the model and the template.  After this, End Point Manager generated the correct cfgMAC files and put them in a directory for distribution via tftp. <br><br><h6>  DHCP setup </h6><br>  For the phones to pick up their configs correctly, you need to tell them about it.  Here is a piece from the <code>/etc/dhcp/dhcpd.conf</code> file: <br><pre> <code class="perl hljs">subnet <span class="hljs-number"><span class="hljs-number">192.168</span></span>.xxx.<span class="hljs-number"><span class="hljs-number">0</span></span> netmask <span class="hljs-number"><span class="hljs-number">255.255</span></span>.<span class="hljs-number"><span class="hljs-number">255.0</span></span> { range <span class="hljs-number"><span class="hljs-number">192.168</span></span>.xxx.<span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span>.xxx.<span class="hljs-number"><span class="hljs-number">240</span></span>; server-name <span class="hljs-string"><span class="hljs-string">"192.168.xxx.1"</span></span>; option domain-name <span class="hljs-string"><span class="hljs-string">"my.domain"</span></span>; option domain-name-servers <span class="hljs-number"><span class="hljs-number">192.168</span></span>.xxx.<span class="hljs-number"><span class="hljs-number">1</span></span>; option domain-search <span class="hljs-string"><span class="hljs-string">"my.domain"</span></span>; option routers <span class="hljs-number"><span class="hljs-number">192.168</span></span>.xxx.<span class="hljs-number"><span class="hljs-number">1</span></span>; option nntp-server <span class="hljs-number"><span class="hljs-number">192.168</span></span>.xxx.<span class="hljs-number"><span class="hljs-number">1</span></span>; option tftp-server-name <span class="hljs-string"><span class="hljs-string">"192.168.xxx.1"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">next</span></span>-server <span class="hljs-number"><span class="hljs-number">192.168</span></span>.xxx.<span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre><br>  Pay attention to where there are quotes, and where not.  192.168.xxx.1 - address of the server on which the whole system is spinning. <br><br><h6>  End of setting </h6><br>  To configure the lines of communication with the outside world is the screen "Connectivity - Trunks".  Your SIP providers are also registered there, and, in my case, flow through the OpenVox board. <br>  To describe how incoming calls will be handled, configure the ‚ÄúConnectivity - Inbound Routes‚Äù.  I have there for the flow indicated what incoming numbers where to send the call (in what format the DID number will be sent check with the operator). <br>  To describe how to handle outgoing calls, use the ‚ÄúConnectivity - Outbound Routes‚Äù.  Here you can configure, for example, intercity via sipnet, or the choice of an operator based on the dialed prefix. <br><br><h6>  Additional goodies </h6><br>  FreePBX automatically generates all configuration files, but what to do if you want a strange one?  Fortunately, the developers have provided such desires.  In every context, macro or subroutine used, there is a mandatory inclusion of the element element <code>-custom</code> element. <br>  Put your own additional chips in the file <code>/etc/asterisk/extensions_custom.conf</code> .  I, for example, added this: <br><pre> <code class="markdown hljs">; Talking clock for Russian [sub-hr24format-custom] exten =&gt; ru,1,Playback(at-tone-time-exactly) exten =&gt; ru,n,SayUnixTime(${FutureTime},,kM) exten =&gt; ru,n,Return() ; Directed FAX [app-fax-custom] exten =&gt; 667,1,Set(FAX<span class="hljs-emphasis"><span class="hljs-emphasis">_FOR_</span></span>NUM=${CONNECTEDLINE(num)}) exten =&gt; 667,n,NoOp(Directed call transfer from ${CALLERID(all)} for ${FAX<span class="hljs-emphasis"><span class="hljs-emphasis">_FOR_</span></span>NUM}) exten =&gt; 667,n,GoTo(ext-fax,${FAX<span class="hljs-emphasis"><span class="hljs-emphasis">_FOR_</span></span>NUM},1)</code> </pre><br>  With the first block everything is clear, out of the box there is simply no setting for the Russian language of the clock.  But the second block may be interesting.  By default, the system fax is on number 666 (yes, FreePBX authors clearly consider faxes to be evil).  When connecting with this number, the fax is received and sent to the e-mail address indicated in the system as the ‚Äúsystem fax recipient‚Äù (I have this shared folder in Exchange, but there is usually nothing except spam that gets there).  And what to do if the fax in manual mode wants to take our chief accountant Ivan Ivanovich?  And he certainly does not want to shine him in a shared folder.  I have in the settings of the phone Ivan Ivanovich: <br><pre> <code class="markdown hljs">Fax: Enabled Fax Email: Ivan.Ivanov@my.domain</code> </pre><br>  And now, if Ivan Ivanovich transfers the call to number 667, then the received fax will be sent to his personal mail.  Do not forget to set up GhostScript so that poor Ivan Ivanovich would not suffer trying to open tiff. <br><br><h5>  findings </h5><br><ul><li>  FreePBX has proven to be a very handy tool for configuring Asterisk.  Routine tasks are solved simply, and for non-standard problems, the possibility of manual writing configs is provided. </li><li>  There were absolutely no problems with the OpenVox board.  Soared instantly. </li><li>  The Grandstream phones were, on the one hand, comfortable and easily customizable.  On the other hand, the build quality is just awful.  I handed over under warranty more than 10% of the devices - everyone did not have a handset, some had a speaker, others had a microphone.  Separately, I do not recommend their DECT phone DP715. </li></ul><br><br><h5>  Future plans </h5><br>  Put <code>hylafax</code> and send faxes, not just receive. <br>  Put the <code>Phonebook</code> module, make a general office phone book and show not only the number, but also the name of the caller during incoming calls. <br>  Put the TAPI driver and give people the opportunity to call contacts directly from Outlook. <br><br>  <i>I omitted many of the details that are obvious to me in this article, I will answer questions with pleasure.</i> </div><p>Source: <a href="https://habr.com/ru/post/158057/">https://habr.com/ru/post/158057/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../158045/index.html">Zero Day Vulnerability in Adobe Reader X / XI</a></li>
<li><a href="../158047/index.html">Using Data Mining in Sales</a></li>
<li><a href="../158049/index.html">Ratings of merchants on Google and their use of Adwords</a></li>
<li><a href="../158051/index.html">The Humble Bundle for Android 4 has started</a></li>
<li><a href="../158055/index.html">About the benefits of application programming, or why I chose an unpopular visual basic</a></li>
<li><a href="../158059/index.html">Search for all possible solutions in the game "Plumbing"</a></li>
<li><a href="../158061/index.html">Installing the virtualization management system (openvz, kvm) proxmox 2.2 on the server in Hetzner</a></li>
<li><a href="../158063/index.html">Wikipedia introduces an advanced open-source player on its website</a></li>
<li><a href="../158067/index.html">Clustering duplicates in search by pictures</a></li>
<li><a href="../158071/index.html">Clock with a linear time display</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>