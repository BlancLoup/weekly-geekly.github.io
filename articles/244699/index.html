<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We integrate AutoMapper with DI-containers on the example of Unity</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL; DR: A package for easy registration (and configuration) of AutoMapper in Unity . 



var container = new UnityContainer(); container.RegisterMappi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We integrate AutoMapper with DI-containers on the example of Unity</h1><div class="post__text post__text-html js-mediator-article">  <b>TL; DR: A</b> package for easy registration (and configuration) of <a href="http://automapper.org/">AutoMapper</a> in <a href="https://unity.codeplex.com/">Unity</a> . <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> container = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnityContainer(); container.RegisterMappingProfile&lt;DataModelToViewModel&gt;(); container.RegisterMapper(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SomeController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IMappingEngine mapper</span></span></span><span class="hljs-function">)</span></span> { _mapper = mapper; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ViewModel </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SomeAction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _mapper.Map&lt;ViewModel&gt;(dataModel) }</code> </pre> <br><ul><li>  <a href="http://www.nuget.org/packages/AutoMapper.Unity/">Nuget</a> </li><li>  <a href="https://github.com/srogovtsev/AutoMapper.Unity">Github</a> </li></ul><br><a name="habracut"></a><br>  I don‚Äôt need to introduce AutoMapper.  You can discuss for a long time whether it is convenient or not, on which tasks it is applicable, and on which it is not, where it slows down, in the end;  but in the end - you either use it or not.  I enjoyed;  and against the background of more or less general convenience, I had a number of problems that were transformed into routine tasks.  So suppose you use AutoMapper too ... <br><br><h1>  Testing code using AutoMapper </h1><br>  The first thing that bothers you while actively using AutoMapper is that the main proposed usage scenario assumes statics.  See: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Mapper.CreateMap&lt;Order, OrderDto&gt;(); // OrderDto dto = Mapper.Map&lt;OrderDto&gt;(order);</span></span></code> </pre><br>  At the same time, the configuration would have to be performed once per application, so it is naturally placed somewhere in the general initialization area, where it is lost (if you have modules in the application, each of which uses its own configuration, each of them has its own own configurator method, which is called from general initialization). <br><br>  If you are using unit testing, then sooner (most likely sooner) or later you will encounter a situation where to test a piece of code you need to initialize an unknown number of mappings located in unknown places of the program, and if these mappings rely on external dependencies (more on this later), you never know exactly how these dependencies are initialized.  In other words, you will find yourself in the very small adik that is prepared for people who use static dependencies for isolated testing. <br><br>  The way out, in general, is obvious - let's find a way to turn a dependency from a static one into a regular one, and use a regular instance of an object (and it would be better - by interface), and manage its lifetime using the same tool that is used to manage life other dependencies. <br><br>  Fortunately, the static <code>Mapper</code> is just a facade, behind which, as a result, an object with the <code>IMappingEngine</code> interface is <code>IMappingEngine</code> .  It only remains to register it in our dependency injection container of choice, and cheers. <br><br>  (I‚Äôll make a reservation right away, we use Unity as a DI container, all the examples and the final solution are written for it, but it should be easy to transfer this solution to other containers) <br><br>  So, after a brief search on Stackoverflow and reading the sources, we generate something like the following: <br><br><pre> <code class="cs hljs">_configurationProvider = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConfigurationStore(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TypeMapFactory(), MapperRegistry.Mappers); _configurationProvider.CreateMap&lt;Order, OrderDto&gt;(); <span class="hljs-comment"><span class="hljs-comment">//, ,  //      -   _mappingEngine = new MappingEngine(_configurationProvider);</span></span></code> </pre><br>  It should be noted that in the first three, it seems, the approaches to this projectile mapper were created inside a specially written wrapper, and the wrapper hid the entire configuration in itself, and the wrapper was registered in DI.  Like any extra level of abstraction, this one at some point also turned out to be superfluous, and we successfully got rid of it, bringing the configuration to the composition root region, and the mapper itself - directly to DI.  Total we get: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configurationProvider = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConfigurationStore(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TypeMapFactory(), MapperRegistry.Mappers); configurationProvider.CreateMap&lt;Order, OrderDto&gt;(); <span class="hljs-comment"><span class="hljs-comment">//, ,  container.RegisterInstance&lt;IConfigurationProvider&gt;(configurationProvider); //       , ,    container.RegisterInstance&lt;IMappingEngine&gt;(new MappingEngine(configurationProvider));</span></span></code> </pre><br><br>  It remains to add a mechanism that would allow the mapping configuration to be removed from composition root.  Again, first we made our bikes, and then, as expected, read the documentation.  It turned out that <a href="https://github.com/AutoMapper/AutoMapper/wiki/Configuration">the profile mechanism</a> quite successfully solves our problem. <br><br>  Iteration 1: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configurationProvider = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConfigurationStore(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TypeMapFactory(), MapperRegistry.Mappers); configurationProvider.AddProfile(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SomeProfile()); <span class="hljs-comment"><span class="hljs-comment">//, ,  container.RegisterInstance&lt;IConfigurationProvider&gt;(configurationProvider); container.RegisterInstance&lt;IMappingEngine&gt;(new MappingEngine(configurationProvider));</span></span></code> </pre><br>  We think a little - iteration 2: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configurationProvider = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConfigurationStore(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TypeMapFactory(), MapperRegistry.Mappers); <span class="hljs-comment"><span class="hljs-comment">//   ,     -       foreach (var profile in container.ResolveAll&lt;Profile&gt;()) configurationProvider .AddProfile(profile); container.RegisterInstance&lt;IConfigurationProvider&gt;(configurationProvider); container.RegisterInstance&lt;IMappingEngine&gt;(new MappingEngine(configurationProvider));</span></span></code> </pre><br><br>  After the third repetition of this code, we took it out to an extension method, and after another two weeks I made a nuget-package in order to never again ask the question ‚Äúhow to do it‚Äù.  Hooray. <br><br><h1>  Using external dependencies when mapping </h1><br>  Actually, don't do that.  No, seriously, do not do that, mapping becomes too complicated, it needs to be tested separately, the whole idea is lost - well, don‚Äôt do it.  However, if you still need it (for example, you map from DTO, which sends reference value codes, to the essence of the database, where identifiers are needed, and you want to retrieve identifiers from the database by codes during mapping), for this, oddly enough, there is also a standard mechanism. <br><br>  Step 1: create a <a href="https://github.com/AutoMapper/AutoMapper/wiki/Custom-value-resolvers">value resolver</a> (a fully functional method, as a separate class, is not enough).  For example: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OKEIResolver</span></span>: <span class="hljs-title"><span class="hljs-title">ValueResolver</span></span>&lt;<span class="hljs-title"><span class="hljs-title">string</span></span>,<span class="hljs-title"><span class="hljs-title">int</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Func&lt;ISomeDbContext&gt; _contextFactory; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OKEIResolver</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Func&lt;ISomeDbContext&gt; contextFactory</span></span></span><span class="hljs-function">)</span></span> { _contextFactory = contextFactory; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ResolveCore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> source</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dc = _contextFactory()) { <span class="hljs-comment"><span class="hljs-comment">//    return dc.Set&lt;OKEI&gt;() .Where(s =&gt; s.Code == source) .Single(s =&gt; s.Id) } } }</span></span></code> </pre><br>  Step 2 the big-eyed have already noticed themselves: we throw the dependence we need into the resolver. <br>  Step 3: <a href="https://github.com/AutoMapper/AutoMapper/wiki/Containers">teach</a> AutoMapper to create resolvers (and other useful things) from the container: <br><pre> <code class="cs hljs">configuration.ConstructServicesUsing(t =&gt; container.Resolve(t));</code> </pre><br>  There is a trick: on the version of AutoMapper on which I implemented it, <code>ConstructServicesUsing</code> had to be called before the first configuration using a resolver, otherwise it was created bypassing the container. <br><br>  It should be noted that right up to the third (even, in my opinion, three-some) version of AutoMapper, using a throw-in through the container was the only way (well, not counting the static facade) to get the mapper inside the resolver.  Now, fortunately, inside the <code>ResolutionContext</code> comes a link to the existing mapper. <br><br>  Need I say that this small but useful challenge was also included inside our extension method? <br><br>  Comments, tips, corrections are welcome. <br></div><p>Source: <a href="https://habr.com/ru/post/244699/">https://habr.com/ru/post/244699/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../244687/index.html">Come and pick up the prototype books!</a></li>
<li><a href="../244689/index.html">Cloud working weekend from #tceh and Microsoft</a></li>
<li><a href="../244691/index.html">Winter Changes in the Authors Promotion Program</a></li>
<li><a href="../244695/index.html">High Frequency Trading Neighborhood - Part III</a></li>
<li><a href="../244697/index.html">InterSystems iKnow. Part two. Creating a simple domain</a></li>
<li><a href="../244701/index.html">New version of RubyMine: Chef, Puppet, EditorConfig and more</a></li>
<li><a href="../244705/index.html">OpenVPN Denial of Service Vulnerability</a></li>
<li><a href="../244707/index.html">How to create a DbContext inside Visual Studio, or ‚ÄúWhat if you want something strange?‚Äù</a></li>
<li><a href="../244709/index.html">Saving "many to many" in Yii2 through behavior</a></li>
<li><a href="../244711/index.html">Optional types? Only if very necessary</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>