<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Lua API for D language</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 This note will not be too voluminous, but rather, quite the contrary, small. 

 For quite a long time, I have been following a series of ar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Lua API for D language</h1><div class="post__text post__text-html js-mediator-article"><h1>  Foreword </h1><br>  This note will not be too voluminous, but rather, quite the contrary, small. <br><br>  For quite a long time, I have been following a <a href="http://habrahabr.ru/post/226071/">series of articles about the D language, published on Habr√©</a> .  After reviewing a number of sources, ranging from Wikipedia and ending with the official manuals on this language, I came to the conclusion that it would be useful to use it in my research projects.  The main project of the doctoral dissertation came to a standstill, demanding processing (a number of mechanical issues surfaced).  It was decided to combine the revision of the project and learning a new language for me. <br><br>  Said done - most of the code was rather quickly transferred from C / C ++ to D. Despite the different opinions about D being in the environment of software developers, I liked the language. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      One problem - in the old version of the project to set the parameters of the train model and change the logic of work without recompilation, Lua scripting was used.  Those who come across it know by their occupation that there is a well-developed and well-documented API for developing in C / C ++. <br><br>  As for Lua-scripting in D, there are a number of projects, for example <a href="https://github.com/JakobOvrum/LuaD">LuaD</a> , which brings the ability to work with Lua into D programs.  However, LuaD is designed for the previous version 5.1.  I came across a project for 5.2 - <a href="https://github.com/DerelictOrg/DerelictLua">DerelictLua</a> , but offhand from the ‚Äúlight kick‚Äù it was not possible to get it.  If you have time, you can figure it out, but as always there is no time.  I had to strain my thinking powers and come up with a faster and easier solution.  If the reader is interested in what came of it, welcome under cat. <br><a name="habracut"></a><br><h1>  1. Calling C-functions from a D program </h1><br>  This is implemented not simply, but very simply - in module D we write the function prototype, indicating that it is located in the external module and uses the C-function calling convention <br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span>(C) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">my_C_func</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> param1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> param2</span></span></span><span class="hljs-function">)</span></span>;</code> </pre> <br>  Naturally, the external module must be one way or another assembled with the program in D. <br><br>  In this regard, the first idea arose - to implement work with Lua on C, and to register prototypes in a module on D and compile everything into one program.  There was even a redesigned project build script (using SCons) in this way. <br><br><div class="spoiler">  <b class="spoiler_title">SConstruct to compile a program from modules in C / C ++ and D</b> <div class="spoiler_text"><pre> <code class="hljs delphi">#-------------------------------------------------------------------- # Project globals #-------------------------------------------------------------------- source_dir = <span class="hljs-string"><span class="hljs-string">'src/'</span></span> d_include_path = <span class="hljs-string"><span class="hljs-string">'src/D/'</span></span> release_target_dir = <span class="hljs-string"><span class="hljs-string">'bin/release/'</span></span> debug_target_dir = <span class="hljs-string"><span class="hljs-string">'bin/debug/'</span></span> target_name = <span class="hljs-string"><span class="hljs-string">'train'</span></span> #-------------------------------------------------------------------- # Release build configuration #-------------------------------------------------------------------- release_env = Environment( CC=<span class="hljs-string"><span class="hljs-string">'gcc'</span></span>, CXX=<span class="hljs-string"><span class="hljs-string">'g++'</span></span>, DMD=<span class="hljs-string"><span class="hljs-string">'dmd'</span></span>, DPATH=d_include_path, LINK=<span class="hljs-string"><span class="hljs-string">'gcc'</span></span>, CPPFLAGS=<span class="hljs-string"><span class="hljs-string">'-O3'</span></span>, DFLAGS=<span class="hljs-string"><span class="hljs-string">'-O'</span></span> ) release_env.VariantDir(release_target_dir, source_dir, duplicate=<span class="hljs-number"><span class="hljs-number">0</span></span>) d_sources = Glob(release_target_dir + <span class="hljs-string"><span class="hljs-string">'D/*.d'</span></span>) c_sources = Glob(release_target_dir + <span class="hljs-string"><span class="hljs-string">'C/*.c'</span></span>) c_obj = release_env.<span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>(c_sources) d_obj = release_env.<span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>(d_sources) release_env.<span class="hljs-keyword"><span class="hljs-keyword">Program</span></span>(release_target_dir + target_name, d_obj + c_obj, LIBS=[<span class="hljs-string"><span class="hljs-string">'phobos2'</span></span>, <span class="hljs-string"><span class="hljs-string">'lua'</span></span>]) #-------------------------------------------------------------------- # Debug build configuration #-------------------------------------------------------------------- debug_env = Environment( CC=<span class="hljs-string"><span class="hljs-string">'gcc'</span></span>, CXX=<span class="hljs-string"><span class="hljs-string">'g++'</span></span>, DMD=<span class="hljs-string"><span class="hljs-string">'dmd'</span></span>, DPATH=d_include_path, LINK=<span class="hljs-string"><span class="hljs-string">'gcc'</span></span>, CPPFLAGS=<span class="hljs-string"><span class="hljs-string">'-g3'</span></span>, DFLAGS=<span class="hljs-string"><span class="hljs-string">'-g'</span></span> ) debug_env.VariantDir(debug_target_dir, source_dir, duplicate=<span class="hljs-number"><span class="hljs-number">0</span></span>) d_sources = Glob(debug_target_dir + <span class="hljs-string"><span class="hljs-string">'D/*.d'</span></span>) c_sources = Glob(debug_target_dir + <span class="hljs-string"><span class="hljs-string">'C/*.c'</span></span>) c_obj = debug_env.<span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>(c_sources) d_obj = debug_env.<span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>(d_sources) debug_env.<span class="hljs-keyword"><span class="hljs-keyword">Program</span></span>(debug_target_dir + target_name, d_obj + c_obj, LIBS=[<span class="hljs-string"><span class="hljs-string">'phobos2'</span></span>, <span class="hljs-string"><span class="hljs-string">'lua'</span></span>])</code> </pre><br></div></div><br><br>  After successfully reading the test Lua script, it was understood that there are too many entities - why write a module in C, if you can write it in D, and export the necessary functions directly from <b>liblua.so</b> ?!?  In addition, on D, you can implement the functionality that I already need by setting it up, let's say in the form of a class (this was done in the previous C ++ version of the project). <br><br>  Armed with the <a href="http://www.lua.org/manual/5.2/">guide to Lua 5.2</a> and the header files in <b>/ usr / include /</b> I started.  Initially, the idea was to export only the functions I needed and stop there.  But then I felt ashamed - for sure the results of this work may be useful to someone else.  Therefore, the C API to Lua was almost completely ported to D. <br><br><h1>  2. D-library for working with Lua API </h1><br>  Result <a href="https://github.com/maisvendoo/lua_d_api">is available on github</a> <br><br>  The archive contains the following files <br><ol><li>  <b>lua.d</b> - prototypes of basic functions </li><li>  <b>lualib.d</b> - functions for working with Lua libraries </li><li>  <b>lauxlib.d</b> - additional functions </li><li>  <b>luaconf.d</b> - description of some types and constants </li></ol><br>  As for the last file, it is ported to the part that is used inside other modules.  This work has yet to be done.  Otherwise, this library allows you to use the interface to Lua from a program in D, as is done when developing in C / C ++.  The listed modules are connected to the project on D and it is linked with the library <b>liblua.so</b> (the linker key is <b>-llua</b> , in the case of GNU / Linux). <br><br>  Implemented all the functions described in the Lua C API.  When writing modules, all macros in the original headers that implement the simplified calls to the basic API functions were replaced by functions. <br><br>  A tiny Lua script was written for verification. <br><br>  <b>test.lua</b> <br><pre> <code class="hljs matlab">--     nv = <span class="hljs-number"><span class="hljs-number">2</span></span> -- ,    my_number_sqr = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  To read it, we write such code on D, connecting the necessary libraries. <br>  <b>main.d</b> <br><pre> <code class="hljs coffeescript"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span> main; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> std.stdio; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lua; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lualib; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lauxlib; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>------------------------------------------------------------------- <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>------------------------------------------------------------------- void main() { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    Lua     lua_State *lua_state = luaL_newstate(); luaL_openlibs(lua_state); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (luaL_dofile(lua_state, <span class="hljs-string"><span class="hljs-string">"test.lua"</span></span>)) { writeln(<span class="hljs-string"><span class="hljs-string">"Error"</span></span>); } <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    Lua int top = lua_gettop(lua_state); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     nv lua_getglobal(lua_state, <span class="hljs-string"><span class="hljs-string">"nv"</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      lua_Integer tmp = lua_tointeger(lua_state, <span class="hljs-number"><span class="hljs-number">-1</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (top - lua_gettop(lua_state)) lua_pop(lua_state, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   my_number_sqr top = lua_gettop(lua_state); lua_getglobal(lua_state, <span class="hljs-string"><span class="hljs-string">"my_number_sqr"</span></span>); double x = <span class="hljs-number"><span class="hljs-number">8</span></span>; lua_pushnumber(lua_state, x); lua_pcall(lua_state, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); double ret = lua_tonumber(lua_state, <span class="hljs-number"><span class="hljs-number">01</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (top - lua_gettop(lua_state)) lua_pop(lua_state, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   writeln(<span class="hljs-string"><span class="hljs-string">"readed integer nv = "</span></span>, tmp); writefln(<span class="hljs-string"><span class="hljs-string">"sqr(%f) = %f "</span></span>, x, ret); lua_close(lua_state); }</code> </pre><br>  Putting it <b>together</b> , not forgetting <b>linking liblua.so</b> (the build script may be easier, but it was too lazy to write separately). <br><div class="spoiler">  <b class="spoiler_title">SConstruct to compile a test program</b> <div class="spoiler_text"><pre> <code class="hljs delphi">#-------------------------------------------------------------------- # Project globals #-------------------------------------------------------------------- source_dir = <span class="hljs-string"><span class="hljs-string">'src/'</span></span> d_include_path = <span class="hljs-string"><span class="hljs-string">'src/D/'</span></span> release_target_dir = <span class="hljs-string"><span class="hljs-string">'bin/release/'</span></span> target_name = <span class="hljs-string"><span class="hljs-string">'test_lua_api'</span></span> #-------------------------------------------------------------------- # Release build configuration #-------------------------------------------------------------------- release_env = Environment( CC=<span class="hljs-string"><span class="hljs-string">'gcc'</span></span>, CXX=<span class="hljs-string"><span class="hljs-string">'g++'</span></span>, DMD=<span class="hljs-string"><span class="hljs-string">'dmd'</span></span>, DPATH=d_include_path, LINK=<span class="hljs-string"><span class="hljs-string">'gcc'</span></span>, CPPFLAGS=<span class="hljs-string"><span class="hljs-string">'-O3'</span></span>, DFLAGS=<span class="hljs-string"><span class="hljs-string">'-O'</span></span> ) release_env.VariantDir(release_target_dir, source_dir, duplicate=<span class="hljs-number"><span class="hljs-number">0</span></span>) d_sources = Glob(release_target_dir + <span class="hljs-string"><span class="hljs-string">'D/*.d'</span></span>) d_obj = release_env.<span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>(d_sources) release_env.<span class="hljs-keyword"><span class="hljs-keyword">Program</span></span>(release_target_dir + target_name, d_obj, LIBS=[<span class="hljs-string"><span class="hljs-string">'phobos2'</span></span>, <span class="hljs-string"><span class="hljs-string">'lua'</span></span>])</code> </pre><br></div></div><br>  having an exit <br><pre> <code class="hljs perl">readed integer nv = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">s</span></span><span class="hljs-string"><span class="hljs-string">qr(8.000000)</span></span> = <span class="hljs-number"><span class="hljs-number">64.000000</span></span></code> </pre><br><br><h1>  Instead of conclusion </h1><br>  Most of the functions have not yet been tested, in fact, in my project, reading of table fields and calling Lua functions is used so far.  For a good check, this code should be given free of charge to the people, which I do.  I hope someone will come in handy.  Thank you for your attention to my work. <br><br><h1>  PS: </h1><br>  The code will have to be seriously corrected.  For example, to work correctly with strings, we had to make some adjustments in lua_tostring (...) <br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lua_tostring</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">lua_State *L, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> idx</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> to!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(lua_tolstring(L, idx, <span class="hljs-literal"><span class="hljs-literal">null</span></span>)); }</code> </pre><br>  adding conversion to string.  Well, as you make adjustments will be made </div><p>Source: <a href="https://habr.com/ru/post/248039/">https://habr.com/ru/post/248039/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../248023/index.html">Disco on the project, or rhythm as a means of project management</a></li>
<li><a href="../248025/index.html">SAL. Contract programming from Microsoft or how to help a static analyzer</a></li>
<li><a href="../248027/index.html">MindStream. How do we write software under FireMonkey. Part 5. Testing</a></li>
<li><a href="../248033/index.html">Permanent intruder ban with Fail2Ban + MikroTik</a></li>
<li><a href="../248037/index.html">Herringbone, light up! Part 3: Web Interface and Android Application</a></li>
<li><a href="../248041/index.html">Once again (I hope the last one) about double-checked locking</a></li>
<li><a href="../248043/index.html">An approximate comparison of numbers in Haskell</a></li>
<li><a href="../248047/index.html">HP ProLiant ML350 Gen9 - server with insane extensibility</a></li>
<li><a href="../248051/index.html">Doomsday QA</a></li>
<li><a href="../248053/index.html">3CXPhone for Android and iOS in Unified Communications style</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>