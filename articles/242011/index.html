<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We optimize $ 5 VPS (512MB RAM / 1 CPU) so that the wordpress site can handle 42,735,587 hits per day</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When you buy a VPS server with 256MB or 512MB of RAM onboard and only a fraction of the processor power, using the default settings for services like ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We optimize $ 5 VPS (512MB RAM / 1 CPU) so that the wordpress site can handle 42,735,587 hits per day</h1><div class="post__text post__text-html js-mediator-article">  When you buy a VPS server with 256MB or 512MB of RAM onboard and only a fraction of the processor power, using the default settings for services like MySQL / PHP / Apache is a very bad idea.  Currently I have 3 sites launched on the cheapest tariff plan with 512MB RAM / 1 CPU.  Not completely sure, but attendance is about 5-10 thousand visitors per day.  Next, I want to share instructions on how to optimize LAMP using as little as 512 MB without going to swap.  Typically, this setting uses 256 - 378Mb of memory and everything works pretty quickly. <br><br><h5>  Determine available memory and swap activity. </h5><br>  Before starting the optimization let's take a look at the amount of memory used.  To do this, run the following command: <br><br><pre><code class="bash hljs">$ free -m</code> </pre> <br>  For.  To see a list of running processes and sort them by memory usage, you need to run the following command: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="bash hljs">$ ps -eo pmem,pcpu,rss,vsize,args | sort -k 1 -r | less</code> </pre> <br><br><h5>  We configure the LAMP server to consume a small amount of RAM.  Stop, disable unnecessary services. </h5><br>  The first and obvious question that needs to be asked is ‚Äúwhat services do I not need to use?‚Äù.  Recently, I discovered a very handy utility for managing services.  It is called " <b>sysv-rc-conf</b> " and manages services using pseudographics and flags.  Exits like this: <br><br><img src="https://habrastorage.org/files/063/267/8b9/0632678b958742c98ee88f66f028145a.png"><br><br><h5>  Here is a list of services that I have changed. </h5><br><ul><li>  <b>Postfix</b> .  This service allows you to send and receive email email messages for a domain.  I use Google Apps for this purpose to send mail and mailchimp for news subscribers.  So I stopped and disabled this service. </li><li>  <b>Bind9</b> .  It is needed to manage your domain‚Äôs DNS records.  It can be disabled, since all DNS records are stored at the hoster. </li><li>  <b>Sshd</b> .  There are other implementations that use much less memory, but they do not support sftp, so I left this service unchanged. </li></ul><br><br>  Do not start the X server, turn off all unnecessary services and configure Apache, MySQL, PHP only with the basic functionality required. <br><a name="habracut"></a><br><h5>  Apache </h5><br>  Apache‚Äôs biggest problem is the amount of RAM it uses.  I will consider the following ways to speed up work and reduce RAM consumption: <br><br><ul><li>  Handle fewer simultaneous requests; </li><li>  Smaller loading of modules (disable unused); </li><li>  Less logging. </li></ul><br><br><h4>  Configure Apache to use only the smallest number of running child processes. </h4><br>  <b>Prefork</b> is where real magic happens.  This is where we tell Apache to generate a lot of processes.  By default, a large number is allocated, which leads to the consumption of server RAM.  Make sure that apache2.conf is not configured to run too many servers or has plenty of spare ones.  Below is an example: <br><br><pre> <code class="bash hljs">&lt;IfModule mpm_prefork_module&gt; StartServers 1 MinSpareServers 1 MaxSpareServers 3 MaxClients 10 MaxRequestsPerChild 3000 &lt;/IfModule&gt; &lt;IfModule mpm_worker_module&gt; StartServers 1 MinSpareThreads 5 MaxSpareThreads 15 ThreadLimit 25 ThreadsPerChild 5 MaxClients 25 MaxRequestsPerChild 200 &lt;/IfModule&gt;</code> </pre><br>  Also, be sure to adjust the " <b>KeepAliveTimeout</b> " setting to 10 or 15. In my opinion, 15 seconds is too long for a small page to view and shorter than for a long page view. <br><br><h5>  Load only the most necessary modules. </h5><br>  The default Apache web server loads too many unnecessary modules.  You can check which modules are installed and enabled with the following command: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># apache2ctl -M</span></span></code> </pre><br>  Below is a list of modules that are required for Wordpress. <br><pre> <code class="bash hljs">LoadModule dir_module modules/mod_dir.so LoadModule log_config_module modules/mod_log_config.so LoadModule mime_module modules/mod_mime.so LoadModule setenvif_module modules/mod_setenvif.so LoadModule alias_module modules/mod_alias.so LoadModule authz_host_module modules/mod_authz_host.so LoadModule rewrite_module modules/mod_rewrite.so</code> </pre><br>  You need to comment out the remaining modules to save memory.  Or you can enable / disable modules via the command line.  To enable, use the command: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># a2enmod module_name</span></span></code> </pre><br>  To disable: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># a2dismod module_name</span></span></code> </pre><br>  After the done manipulations you need to restart the Apache web server: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># service apache2 restart</span></span></code> </pre><br><h5>  Reduce logging </h5><br>  If you want maximum performance, you definitely need to limit logging.  On my server, I set the level of "error" (error).  Also, if you do not need detailed statistics, you can disable user-agent or the http-referer logging. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ErrorLog: The location of the error log file. # If you do not specify an ErrorLog directive within a &lt;VirtualHost&gt; # container, error messages relating to that virtual host will be # logged here. If you *do* define an error logfile for a &lt;VirtualHost&gt; # container, that host's errors will be logged there and not here. # ErrorLog ${APACHE_LOG_DIR}/error.log # # LogLevel: Control the number of messages logged to the error_log. # Possible values include: debug, info, notice, warn, error, crit, # alert, emerg. # LogLevel error</span></span></code> </pre><br>  I am satisfied with such settings, but you decide. <br><br><h5>  MySQL server optimization </h5><br>  Tweaking MySQL to use a small amount of RAM is quite simple. <br>  Next we will consider the following types of MySQL settings: <br><br><ul><li>  Things we can disable; </li><li>  Optimization of MySQL server settings; </li><li>  Third-party MySQL configuration tools. </li></ul><br><br>  To optimize MySQL, we need to edit the <b>/etc/mysql/my.cnf</b> file. <br><br><h5>  Things we need to turn off </h5><br>  Mysql provides several table storage engines.  Two of them are the most popular - this is <b>InnoDB</b> and <b>MyISAM</b> .  The main differences between them are: <br><ul><li>  <b>MyISAM</b> offers table-level locking, which means that when information is written to a table, the entire table is locked and if at this point there are more records that must be executed simultaneously in the same table, then they will have to wait until the first record is added successfully. ; </li><li>  <b>InnoDB</b> , on the other hand, proposes locking at the row level, which means that when writing to a line occurs, only this single line is blocked;  the rest are available for recording. </li></ul><br><br>  Problems with table level locks are noticeable only on very busy servers.  For regular web sites, MyISAM performs better on low-cost servers. <br><br>  If you decide to use MyISAM tables, then you need to add the following lines to the my.cnf configuration file: <br><br><pre> <code class="bash hljs">default-storage-engine=MyISAM default-tmp-storage-engine=MyISAM</code> </pre><br>  If you only have MyISAM tables, you can disable the InnoDB engine, thereby saving RAM by adding just one line to my.cnf: <br><br><pre> <code class="bash hljs">skip-innodb</code> </pre><br>  If you have used InnoDB in the past, then below I give you a script that automatically converts all InnoDB tables into MyISAM. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash MYSQLCMD=mysql for db in `echo show databases | $MYSQLCMD | grep -v Database`; do for table in `echo show tables | $MYSQLCMD $db | grep -v Tables_in_`; do TABLE_TYPE=`echo show create table $table | $MYSQLCMD $db | sed -e's/.*ENGINE=\([[:alnum:]\]\+\)[[:space:]].*/\1/'|grep -v 'Create Table'` if [ $TABLE_TYPE = "InnoDB" ] ; then mysqldump $db $table &gt; $db.$table.sql echo "ALTER TABLE $table ENGINE = MyISAM" | $MYSQLCMD $db fi done done</span></span></code> </pre><br><h5>  Optimizing MySQL server settings </h5><br>  Below are a few parameters that can be adjusted to speed up the MySQL server. <br><br><h6>  Key buffer size </h6><br>  This is one of the most important parameters affecting memory consumption and performance, which needs to be optimized.  MySQL is trying to put everything that is indexed in key buffer, so this parameter brings tremendous performance.  The SQL query will be submitted directly from RAM.  I cannot say what size you should set for the key buffer, because only you know how much RAM you have free. <br><br><h6>  The query cache </h6><br>  If you do the same query twice in a row, the result is placed in the query cache, so mysql will not have to do the query again.  If you are going to improve performance, then this option can be of great benefit, but memory consumption will increase.  Therefore, you need to set this parameter not too huge, but not too small, that is, as much as your website needs. <br><br>  Below are three variables that affect how your query cache works: <br><br><pre> <code class="bash hljs">query_cache_size query_cache_limit query_cache_type</code> </pre><br><br><h6>  Maximum Number of Connections </h6><br>  This is an optional parameter.  If you have already limited the number of apache processes, then everything is fine.  If not, and you need to process thousands of users at the same time, you need to increase the value of this parameter. <br><br><h6>  The table cache </h6><br>  Each time you access the table, MySQL loads the link to the table as one entry in the table cache.  This is done for each parallel access to the table, it is really important for performance, not significant for memory usage.  You can constantly increase the cache table, but then you will rest on the limit on the number of open files in your operating system, so keep this in mind.  If the table cache is set too small, mysql will barf at you, but you don‚Äôt want it. <br><br>  Below is the correct my.cnf, which I optimized on my VPS with the lowest data plan. <br><div class="spoiler">  <b class="spoiler_title">My my.cnf</b> <div class="spoiler_text"><pre> <code class="bash hljs">[mysqld] port = 3306 socket = /var/lib/mysql/mysql.sock skip-locking key_buffer = 16K max_allowed_packet = 1M table_cache = 4 sort_buffer_size = 64K read_buffer_size = 256K read_rnd_buffer_size = 256K net_buffer_length = 2K thread_stack = 64K <span class="hljs-comment"><span class="hljs-comment"># For low memory, InnoDB should not be used so keep skip-innodb uncommented unless required skip-innodb # Uncomment the following if you are using InnoDB tables #innodb_data_home_dir = /var/lib/mysql/ #innodb_data_file_path = ibdata1:10M:autoextend #innodb_log_group_home_dir = /var/lib/mysql/ #innodb_log_arch_dir = /var/lib/mysql/ # You can set .._buffer_pool_size up to 50 - 80 % # of RAM but beware of setting memory usage too high #innodb_buffer_pool_size = 16M #innodb_additional_mem_pool_size = 2M # Set .._log_file_size to 25 % of buffer pool size #innodb_log_file_size = 5M #innodb_log_buffer_size = 8M #innodb_flush_log_at_trx_commit = 1 #innodb_lock_wait_timeout = 50 [mysqldump] quick max_allowed_packet = 16M [mysql] no-auto-rehash # Remove the next comment character if you are not familiar with SQL #safe-updates [isamchk] key_buffer = 8M sort_buffer_size = 8M [myisamchk] key_buffer = 8M sort_buffer_size = 8M [mysqlhotcopy] interactive-timeout</span></span></code> </pre><br></div></div><br><h5>  Third-party MySQL configuration wizards </h5><br>  I found Percona, which provides free MySQL configuration and helps to choose the best MySQL server features for achieving better performance, as well as save time, avoid difficult moments and risks that can arise when self-configuring my.cnf. <br><br><h5>  MySQL server monitoring </h5><br>  MySQL stores statistics that help determine the best values ‚Äã‚Äãto use.  In addition, there are two handy utilities that you can use to read these statistics and output in a clear format: <a href="https://launchpad.net/mysql-tuning-primer">tuning-primer.sh</a> and <a href="http://mysqltuner.com/">mysqltuner.pl</a> . <br>  These scripts will allow you to monitor your MySQL server, and then provide a hint about the parameters that must be configured on your server. <br><br><h5>  PHP optimization and caching </h5><br>  PHP does not use memory very intensively, so I don‚Äôt think I need to worry much about the memory consumption of these processes if your application does not need it, but even if it is necessary to optimize, there will not be a significant reduction in memory consumption.  But I researched and then found a few settings for PHP configurations that reduce the memory consumption by the web server. <br><br><pre> <code class="bash hljs">; Limit the memory to 40M should be fine <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> barebones Wordpress memory_limit = 48M realpath_cache_ttl=300 realpath_cache_size=1M</code> </pre><br><h5>  Alternative PHP Cache </h5><br>  Install PHP Cache, for example, Alternative PHP Cache.  PHP cache will store compiled PHP scripts in such a way that they will be reused without compiling and, accordingly, will not create a load: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># pecl install apc</span></span></code> </pre><br>  Below is my configured php.ini file. <br><div class="spoiler">  <b class="spoiler_title">My php.ini</b> <div class="spoiler_text"><pre> <code class="bash hljs">[APC] extension=apc.so apc.enabled=1 apc.shm_segments=1 ;32M per WordPress install apc.shm_size=128M ;Relative to the number of cached files (you may need to watch your stats <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a day or two to find out a good number) apc.num_files_hint=7000 ;Relative to the size of WordPress apc.user_entries_hint=4096 ;The number of seconds a cache entry is allowed to idle <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> a slot before APC dumps the cache apc.ttl=7200 apc.user_ttl=7200 apc.gc_ttl=3600 ;Setting this to 0 will give you the best performance, as APC will ;not have to check the IO <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> changes. However, you must clear ;the APC cache to recompile already cached files. If you are still ;developing, updating your site daily <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> WP-ADMIN, and running W3TC ;<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> this to 1 apc.stat=1 ;This MUST be 0, WP can have errors otherwise! apc.include_once_override=0 ;Only <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to 1 <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> debugging apc.enable_cli=0 ;Allow 2 seconds after a file is created before it is cached to prevent users from seeing half-written/weird pages apc.file_update_protection=2 ;Leave at 2M or lower. WordPress does<span class="hljs-string"><span class="hljs-string">'t have any file sizes close to 2M apc.max_file_size=2M ;Ignore files apc.filters = "/var/www/apc.php" apc.cache_by_default=1 apc.use_request_time=1 apc.slam_defense=0 apc.mmap_file_mask=/var/www/temp/apc.XXXXXX apc.stat_ctime=0 apc.canonicalize=1 apc.write_lock=1 apc.report_autofilter=0 apc.rfc1867=0 apc.rfc1867_prefix =upload_ apc.rfc1867_name=APC_UPLOAD_PROGRESS apc.rfc1867_freq=0 apc.rfc1867_ttl=3600 apc.lazy_classes=0 apc.lazy_functions=0</span></span></code> </pre><br></div></div><br><h5>  Static cache </h5><br>  Another thing that might be a good idea for a blog on a small server is to put it in front of a static HTTP-cache, for example, Varnish.  What can really increase your scalability.  Varnish configuration is a separate large article requiring a separate topic. <br><br><h4>  Conclusion </h4><br>  I laid out in open access the configuration of my web server to prove that you can achieve high performance even from the cheapest VPS container with 512MB of RAM and 1Ghz CPU.  I use Ubuntu 12.04 LTS, LAMP, Varnish, APC Cache to host 3 websites made on Wordpress (not multisite) with attendance of 10k per day.  Let's take a look at the test results from Blitz.io: <br><br><img src="https://habrastorage.org/files/6dd/18a/792/6dd18a7922b34f02946dfc02e75821dc.png"><br><br>  As you can see, 0.23% of users get Connection Timeout, when my website has <b>42,735,587</b> hits per day (WOW), you can still optimize something, but I enjoy the work of my web server.  If you‚Äôre tired of this tutorial or don‚Äôt want to do it yourself, you can use services like PuPHPet or Vagrant. </div><p>Source: <a href="https://habr.com/ru/post/242011/">https://habr.com/ru/post/242011/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../242001/index.html">Working with Virtual Private Cloud API: Console Clients</a></li>
<li><a href="../242003/index.html">No safety concerns.</a></li>
<li><a href="../242005/index.html">Skype for Mac got support for OS X Yosemite</a></li>
<li><a href="../242007/index.html">Hackspace in the capital of China, what is it?</a></li>
<li><a href="../242009/index.html">Flexible graphing in JavaFX</a></li>
<li><a href="../242015/index.html">Yandex.Maps, 2GIS or still Google Maps?</a></li>
<li><a href="../242017/index.html">[SetNet & Console Application] First steps. SetNet.PeerBase. Part 2</a></li>
<li><a href="../242019/index.html">Nanopatch to proxmox ve 3.3 web interface for displaying lmsensors</a></li>
<li><a href="../242023/index.html">The course of pixel art 3</a></li>
<li><a href="../242025/index.html">Kitchenware testing: or what to choose from online resources for product testing?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>