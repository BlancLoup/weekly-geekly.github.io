<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Universal mobile electronic key</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I can not say that I felt a great enthusiasm when I was invited to participate in the project ‚ÄúDevice Lab from Google‚Äù , however, no doubt, there was ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Universal mobile electronic key</h1><div class="post__text post__text-html js-mediator-article">  I can not say that I felt a great enthusiasm when I was invited to participate in the project <a href="https://special.habrahabr.ru/google/lab/">‚ÄúDevice Lab from Google‚Äù</a> , however, no doubt, there was interest.  Once I did a project with various interactions via Bluetooth, and I got very interesting implementations.  However, it turned out that in the course of Bluetooth manipulation, all the phones, whose owners, due to an oversight, had put them off within the Bluetooth radius, lost their charge three times faster than usual.  Colleagues, of course, were not very happy.  The project had to close.  In this regard, I have long wanted to hold the last generation beacons in the ‚Äútenacious‚Äù hands.  And the project Device Lab gave me this opportunity. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/04c/0e9/f28/04c0e9f288b444288ac25a67b1c2ce54.jpg"></div><br>  <em>Article author Dmitry Senashenko ( <a href="https://habrahabr.ru/users/dmitrysen/">@DmitrySen</a> ), in the framework of the competition <a href="http://special.habrahabr.ru/google/lab">"Device Lab from Google</a></em> . <em><a href="http://special.habrahabr.ru/google/lab">"</a></em> <br><a name="habracut"></a><br>  On the market now there are many beacons and their manufacturers.  And most of them are designed to determine the geolocation inside buildings.  There are interesting ideas from the category of embedding beacons in suitcases to search for them at the airport at their signal.  But, given the power, it looks like a toy.  I wanted to invent and implement something original and useful at the same time.  So, a few formalities on the site and in the office of Habr, and the iBKS beacon in my hands: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/15c/223/551/15c223551e924ab7825dd7d8a1dc3752.png"></div><br>  Much has been written about beacons.  For example: ‚Äú <a href="https://habrahabr.ru/post/279381/">Google's beacon platform.</a>  <a href="https://habrahabr.ru/post/279381/">Part 1</a> "or" <a href="https://habrahabr.ru/post/279379/">Google's beacon platform.</a>  <a href="https://habrahabr.ru/post/279379/">Part 2</a> ".  I will not repeat, but I will say that it was intended to use the beacon with Google's beacon platform and work with it using the API.  Reality dotted the ‚Äúi‚Äù, which I will discuss later. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In life, I work with telephony and intelligent IVR with support for email, html, sms, etc.  Therefore, there are ready-made stands, it is easy to get the necessary equipment, etc.  And it was precisely to this subject that I wanted to adapt the beacons. <br><br><h2>  Idea </h2><br>  So, I got the idea to use beacons as an authorization key to the doors in the office.  As everyone knows, every office has doors with electronic locks and a reader at the entrance.  Each employee has a key in the form of a card, and to enter the door, he needs to attach this card to the reader, after which the door will open.  In the world, the number of such doors amounts to many billions, and the number of cards, probably trillions.  Although in reality it is not very convenient to use them.  If you are in a hurry for an important meeting, then it is very tiring to waste time trying to remove the card (or remove the object in which this card - the wallet, the folder with documents) lies. <br><br>  However, every person in his pocket now has a phone.  And for some - even worn on hand electronics.  It is easier to meet a person who has forgotten the card than the one who has forgotten his phone.  Therefore, it is more convenient and cost-effective to replace the card with a telephone and the reader with a beacon.  Of course, there are some good ideas in this direction. <br><br>  For example, doorknob with a fingerprint reader, NFC in the phone, etc.  But NFC technology never appeared in every smartphone, but there is Bluetooth just in every smartphone.  Therefore, technologically, this idea is actually ready for implementation. <br><br>  In addition, this solution increases the level of employee comfort.  Approaching the door, just click on the application icon, and after passing the authorization the door will open.  Those.  it can be opened from the elevator or on the way to the door.  In addition, you can open the door with a clock or say so in the headphones with a microphone to a personal assistant.  An important factor is authorization.  Let's take a look at this in more detail.  See Figure 1. <br><br><h2>  Schematic work </h2><br>  The phone enters the visibility area of ‚Äã‚Äãthe beacon, finds it using Beacon Discover, and via Nearby messages API gets its attachment from Google Beacons Registry.  Further, via Wifi or mobile Internet in an encrypted session, the phone sends this attachment and its IMEI or other unique code specified when installing the application to the authorization server.  The authorization server identifies the access rights and, in the event of a positive decision, commands the electronic lock management server to open the corresponding lock based on data from the attachment, which uniquely characterizes the door.  The electronic lock control server instructs the actuator to open the door. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/10b/5ca/0bd/10b5ca0bded14a4e92f1ebfdc0150b61.png"></div><br>  <em>Figure 1. The scheme of the organization of interaction</em> <br><br>  Here is a solution that occurred to me, and now let's try to implement it. <br><br><h2>  Embody the idea in the gland </h2><br>  I had at my disposal an Avaya PBX with a G250 gateway.  This is an old gateway, long out of production.  But its new replacement - the G450 / G430 gateway - also has the components we need, namely the drive for controlling the electronic door lock.  A dry relay is built into this gateway for the needs of small offices - the so-called Contact Closure Adjunct (see Figure 2). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f32/9c3/0b9/f329c30b95e9452cb67e606754202663.png"></div><br>  <em>Figure 2. Avaya G430 Gateway</em> <br><br>  This connector can control the dialing of an arbitrary pre-configured telephone number.  When you dial this number, the gateway closes the relay and gives a signal to open the electronic lock. <br><br>  Further, I had a working stand with an IVR (Interactive Voice Response) manufactured by Avaya as well.  This is a fully software service with the ability to handle not only voice requests, but also email, sms and, in this solution, it will need html requests.  Also, this IVR can initiate not only email and SMS, but also voice calls.  Those.  in relation to this project, this IVR can receive a request via html with the transfer of variables and, based on the results of processing these variables, initiate an outgoing voice call to a certain number.  Request processing in IVR can be carried out both by in-built tools and using the Java programming language.  In this regard, just this IVR was used as the authorization server.  In the role of an electronic lock management server, an Avaya Aura Communication Manager PBX was used with a G250 gateway.  An electronic lock was also available. <br><br>  Thus, the application on the mobile phone was required to obtain a beacon identifier, contact the Google Beacons Registry and receive its attachment, then in the html request to send this information and its IMEI to IVR, which, having checked it, will dial the PBX, thus giving a signal to close the Contact Closure dry relay on the G250 and thus open the door. <br><br>  Well, the last step in preparing for the implementation was getting a mobile phone running the Android operating system.  It was HTC Desire c Android Lollipop 5.1.1.  And, of course, it was also necessary to install Android Studio on your laptop. <br><br>  Everything was ready, and I started.  As usual, reality dotted the ‚Äúi‚Äù. <br><br><h2>  Underwater rocks </h2><br>  To start the beacon is required to register with Google Beacon Registry.  The easiest way to do this is through the Google Beacon Tools mobile app, available in both the Google Play Market and the Apple App Store. <br><br>  I turned on the beacon, removing the plastic disconnector between the microcircuit and the battery, installed Google Beacon Tools and began to search for the beacon.  He did not appear.  Then I downloaded the app maker iBKS Config Tool.  This application is also available for both Android and IOS devices.  And - lo and behold!  The beacon appeared. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/752/f97/403/752f974036de435889e1dd7408ff0faa.png"></div><br>  <em>Figure 3. iBKS Config Tool</em> <br><br>  However, in Google Beacon Tools, he stubbornly did not want to appear.  Having studied the Internet, I read that it is required to enter the editing mode on the iBKS Config Tool and change the type of the beacon.  The application persistently refused to enter the editing mode, both on Android and iOS.  It was possible to enter this mode only after the beacon was turned off and on again by removing the battery.  For everything about everything was about 30 seconds, then the beacon was blocked again.  I did not manage to understand whether this is a feature or a bug.  It was not described anywhere.  See Figure 4. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/6f0/17a/13c/6f017a13c1404ebba6eeb358bd0bff60.jpg"></div><br>  <em>Figure 4. Edit mode of iBKS Config Tool</em> <br><br>  Having changed Advertising Mode from 1 to 7 (see Figure 5), I finally saw the beacon in Google Beacon Tools (see Figure 6).  But he persistently refused to register. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/33f/595/de2/33f595de2828475fa3b2da3d99e4da46.png"></div><br>  <em>Figure 5. Selecting Advertising Mode</em> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/17e/c4f/072/17ec4f0729f44bdd91e3444e4711b998.jpg"></div><br>  <em>Figure 6. Google Beacon Tools</em> <br><br>  For registration, Google Beacon Tools required the beacon to be in iBeacon or Eddystone UUID mode, but in this mode, it was hard to see it.  In the Eddystone URL mode, he saw it, but refused to register.  The behavior of this application on Android and IOS was the same, although on Android the application first selected the project and only then refused to register the beacon. <br><br>  It was not possible to find out what caused the behavior of the beacon during the project.  It seems that the beacon itself was a problem.  It was worth replacing him, of course, but the project was limited in time, and there was no time for a new trip to Habr's office.  From experiences with iBKS Config Tool and Google Beacon Tools, it was clear that the beacon radiates, while transmitting its unique identifier.  Therefore, it was decided to identify the beacon for the demonstration stand not by the attachment received from Google Beacons Registry, but by its identifier.  In general, for a prototype solution such a replacement is quite adequate. <br><br>  So, it remains only to find a Java library that would allow Android Studio to organize the detection of the beacon identifier.  Of course, GitHub and the Radiusnetwork.com.eddystonedemo library came to the rescue.  This library allows you to see the identifier transmitted by the beacon, which is also visible through the iBKS Config Tool.  The description is given <a href="http://developer.radiusnetworks.com/2015/07/14/building-apps-with-eddystone.html">here</a> . <br><br>  An Activity was organized (see Figure 7), which had a large gray button.  This button after finding the beacon changed the color, name and property of Clickable.  That is, until the beacon is found, nothing happens when you press the button.  As soon as the beacon is found, the button turns red and allows itself to be pressed.  When you click on the button, the URL is called leading to the IVR application with the transfer of IMEI, which checks it, and if successful, forms a call using the SIP protocol to the control server of the electronic lock.  In case of loss of a beacon signal (increasing the distance to it or turning it off), the button changes color and the Clickable property back. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/648/cfa/760/648cfa7601f647a58d44e680d65a0b87.jpg"></div><br>  <em>Figure 7. Screenshots of the application</em> <br><br><h2>  Code and final implementation </h2><br>  Entire project can be found Github <a href="https://github.com/dsenash/Beacon-Google-Lab">here.</a>  Let us dwell on the details.  Below is the function called when the beacon is found: <br><br><pre><code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> didRangeBeaconsInRegion(Collection&lt;Beacon&gt; beacons, Region region) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Beacon beacon: beacons) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (beacon.getServiceUuid() == <span class="hljs-number"><span class="hljs-number">0xfeaa</span></span> &amp;&amp; beacon.getBeaconTypeCode() == <span class="hljs-number"><span class="hljs-number">0x00</span></span>) { // This <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> a Eddystone-UID frame Identifier namespaceId = beacon.getId1(); Identifier instanceId = beacon.getId2(); foundBeacon = namespaceId.toString(); //       .       . <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (foundBeacon.equals("0xba1c51bab3147efee8e5")) { <span class="hljs-keyword"><span class="hljs-keyword">Log</span></span>.d("Found beacon", foundBeacon); //         <span class="hljs-built_in"><span class="hljs-built_in">found</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; runOnUiThread(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Runnable() { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> run() { //   ,    Clickable   . mainButton.setText("You can open the door now"); mainButton.setBackgroundColor(<span class="hljs-number"><span class="hljs-number">0xffef0606</span></span>); mainButton.setClickable(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } }); } <span class="hljs-keyword"><span class="hljs-keyword">Log</span></span>.d("RangingActivity", "I see a beacon transmitting namespace id: " + namespaceId + " and instance id: " + instanceId + " approximately " + beacon.getDistance() + " meters away."); runOnUiThread(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Runnable() { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> run() { ((TextView) RangingActivity.this.findViewById(R.id.foundbeacon)).setText("Found beacon - " + foundBeacon); } }); } } }</code> </pre> <br>  Below is the function of calling the URL on the IVR: <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> buttonClick(<span class="hljs-keyword"><span class="hljs-keyword">View</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>) { //    IMEI  String ret = telephonyManager.getDeviceId(); <span class="hljs-keyword"><span class="hljs-keyword">Log</span></span>.d("IMEI", ret); //URL    IP  IVR     HTML    OpenTheDoor       IMEI webview.loadUrl("http://192.168.0.204:7080/Redirector/?AVAYAEP__LaunchId=OpenTheDoor&amp;beacon=" + foundBeacon + "&amp;imei=" + ret.toString()); }</code> </pre><br>  The timer in this application is needed to turn off the button when the phone becomes unavailable 5 seconds after the loss. <br><br><pre> <code class="hljs pgsql">protected <span class="hljs-type"><span class="hljs-type">void</span></span> onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_ranging); mainButton = (Button) findViewById(R.id.mainbutton); telephonyManager = (TelephonyManager) getSystemService(Context.TELEPHONY_SERVICE); webview = (WebView)findViewById(R.id.webView); //   mTimer = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Timer(); mMyTimerTask = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> MyTimerTask(); mTimer.schedule(mMyTimerTask, <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">5000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> MyTimerTask extends TimerTask { @Override <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> run() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">found</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">found</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { runOnUiThread(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Runnable() { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> run() { //       mainButton.setText("Open the door"); mainButton.setBackgroundColor(<span class="hljs-number"><span class="hljs-number">0xffcfc3c3</span></span>); mainButton.setClickable(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); ((TextView) RangingActivity.this.findViewById(R.id.foundbeacon)).setText(""); } }); } } } }</code> </pre><br>  Application development for IVR is carried out in a specialized Avaya Aura Orchestration Designer environment and is based on the Eclipse development environment.  In fact, under each element is Java code.  Building the application to simplify development is carried out in the style of Drag &lt;&amp;&gt; Drop.  Figure 8 shows a screenshot of the IVR application development environment screen. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/1b3/29d/817/1b329d817db74057b1a60c0949753e39.png"></div><br>  <em>Figure 8. Avaya Aura Orchestration Designer Development Environment</em> <br><br>  This application has two main modules: Data1 and Outcalling.  Screenshots of these modules are shown in Figures 9 and 10. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cce/59e/a52/cce59ea52a924e928ba764a238ff13f3.png"></div><br>  <em>Figure 9. Data1 Module</em> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/342/d93/823/342d938232e34f57a745267882e5df89.png"></div><br>  <em>Figure 10. Outcalling Module</em> <br><br>  In the Data1 module, the beacon identifier and IMEI are actually authorized: if both are correct, then the transfer is made to the Outcalling module, in which an outgoing call is made to the pre-configured number stored in the variable CalledNumber.  This variable sets the number configured in the ATC to trigger the dry ContactClosure relay connected to the electronic door lock. <br><br>  The full project can be found <a href="">here</a> . <br><br>  And finally, a video was posted on this <a href="https://www.youtube.com/watch%3Fv%3DqlIRxQdTAto">address</a> , in which a description of the project was given and a finished project was demonstrated.  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/310506/">https://habr.com/ru/post/310506/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../310496/index.html">Just a label on the site</a></li>
<li><a href="../310498/index.html">Quick integration of Google Chromecast in Android app</a></li>
<li><a href="../310500/index.html">Matrix-based collection development</a></li>
<li><a href="../310502/index.html">GitLab CI: Learning to Deploy</a></li>
<li><a href="../310504/index.html">Equation Group exploit box added a new instance</a></li>
<li><a href="../310510/index.html">Eddystone technologies replace QR codes</a></li>
<li><a href="../310512/index.html">Oracle promises new products to help Amazon beat Amazon in the cloud market</a></li>
<li><a href="../310514/index.html">Adapting a mobile Android TV application or why I love Google</a></li>
<li><a href="../310516/index.html">Use the Entity Framework Core with the universal Windows platform application</a></li>
<li><a href="../310518/index.html">We catch notifications using beacons</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>