<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using LibVirt API, InfluxDB and Grafana to collect and visualize VM execution statistics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In my practice, I devote a lot of time to designing and administering cloud infrastructures for various purposes. This is mainly Apache CloudStack. Th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using LibVirt API, InfluxDB and Grafana to collect and visualize VM execution statistics</h1><div class="post__text post__text-html js-mediator-article"><p>  In my practice, I devote a lot of time to designing and administering cloud infrastructures for various purposes.  This is mainly Apache CloudStack.  This system has excellent capabilities, but in terms of monitoring, there is clearly not enough functionality (read - no), especially if monitoring is viewed more broadly than monitoring an individual observation object (server, virtual machine). </p><br><p>  In general, in connection with broader requirements for visual information analysis systems and requirements for integration with data sources, specialized solutions for ad-hoc data analysis, such as Kibana, Grafana, and others, have been distributed.  These systems can be integrated with specialized data time series repositories, one of which is <a href="https://www.influxdata.com/">InfluxDB</a> .  The article will tell about a ready-made solution distributed as a Docker image using the LibVirt API, Grafana and InfluxDB, designed to collect and analyze parameters of running VMs for the KVM hypervisor. <a name="habracut"></a></p><br><h2 id="obzor-resheniya">  Solution Overview </h2><br><p>  The solution is presented in the form of a Docker container distributed under the Apache License v2, so it can be applied without restrictions in any organization and can be modified to reflect the needs of a specific task.  The container is hosted on a dedicated server, the python data collection utility remotely connects via TCP to LibVirt and sends data to InfluxDB, from where they can be requested using Grafana for visualization and analysis. </p><br><p>  The container is available as source code on <a href="https://github.com/bwsw/cs-pulse-sensor">GitHub</a> and as an installable image on <a href="https://hub.docker.com/r/bwsw/cs-pulse-sensor/">DockerHub</a> .  The implementation language is python. </p><br><h3 id="pochemu-docker-konteyner">  Why Docker Container </h3><br><p>  This solution is final and convenient for implementation, and also does not require any additional configuration and installation of additional software on virtualization servers, except allowing access to the LibVirt API over the network.  If access to the LibVirt API from outside is not possible, then it is possible to install Docker on the virtualization host and launch the container locally. </p><br><blockquote>  As part of the solutions that I use in my practice, there is always a secure network, access to which is restricted for unauthorized users, respectively, I do not restrict access to LibVirt with a password, and the presented container does not support authentication.  In the event that such a function is required, it can simply be added. </blockquote><br><h3 id="kakie-dannye-sobirayutsya">  What data is collected </h3><br><p>  The sensor collects the following data about virtual machines available through LibVirt: </p><br><p>  CPU: </p><br><pre><code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"fields"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"cpuTime"</span></span>: <span class="hljs-number"><span class="hljs-number">1070.75</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cpus"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"measurement"</span></span>: <span class="hljs-string"><span class="hljs-string">"cpuTime"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tags"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"vmHost"</span></span>: <span class="hljs-string"><span class="hljs-string">"qemu+tcp://root@10.252.1.33:16509/system"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"vmId"</span></span>: <span class="hljs-string"><span class="hljs-string">"i-376-1733-VM"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"vmUuid"</span></span>: <span class="hljs-string"><span class="hljs-string">"12805898-0fda-4fa6-9f18-fac64f673679"</span></span> } }</code> </pre> <br><p>  RAM: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"fields"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"maxmem"</span></span>: <span class="hljs-number"><span class="hljs-number">4194304</span></span>, <span class="hljs-attr"><span class="hljs-attr">"mem"</span></span>: <span class="hljs-number"><span class="hljs-number">4194304</span></span>, <span class="hljs-attr"><span class="hljs-attr">"rss"</span></span>: <span class="hljs-number"><span class="hljs-number">1443428</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"measurement"</span></span>: <span class="hljs-string"><span class="hljs-string">"rss"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tags"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"vmHost"</span></span>: <span class="hljs-string"><span class="hljs-string">"qemu+tcp://root@10.252.1.33:16509/system"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"vmId"</span></span>: <span class="hljs-string"><span class="hljs-string">"i-376-1733-VM"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"vmUuid"</span></span>: <span class="hljs-string"><span class="hljs-string">"12805898-0fda-4fa6-9f18-fac64f673679"</span></span> } }</code> </pre> <br><p>  Statistics for each network adapter with a MAC address: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"fields"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"readBytes"</span></span>: <span class="hljs-number"><span class="hljs-number">111991494</span></span>, <span class="hljs-attr"><span class="hljs-attr">"readDrops"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"readErrors"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"readPackets"</span></span>: <span class="hljs-number"><span class="hljs-number">1453303</span></span>, <span class="hljs-attr"><span class="hljs-attr">"writeBytes"</span></span>: <span class="hljs-number"><span class="hljs-number">3067403974</span></span>, <span class="hljs-attr"><span class="hljs-attr">"writeDrops"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"writeErrors"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"writePackets"</span></span>: <span class="hljs-number"><span class="hljs-number">588124</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"measurement"</span></span>: <span class="hljs-string"><span class="hljs-string">"networkInterface"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tags"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"mac"</span></span>: <span class="hljs-string"><span class="hljs-string">"06:f2:64:00:01:54"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"vmHost"</span></span>: <span class="hljs-string"><span class="hljs-string">"qemu+tcp://root@10.252.1.33:16509/system"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"vmId"</span></span>: <span class="hljs-string"><span class="hljs-string">"i-376-1733-VM"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"vmUuid"</span></span>: <span class="hljs-string"><span class="hljs-string">"12805898-0fda-4fa6-9f18-fac64f673679"</span></span> } }</code> </pre> <br><p>  Statistics for each disk: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"fields"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"allocatedSpace"</span></span>: <span class="hljs-number"><span class="hljs-number">890</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ioErrors"</span></span>: <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"onDiskSpace"</span></span>: <span class="hljs-number"><span class="hljs-number">890</span></span>, <span class="hljs-attr"><span class="hljs-attr">"readBytes"</span></span>: <span class="hljs-number"><span class="hljs-number">264512607744</span></span>, <span class="hljs-attr"><span class="hljs-attr">"readIOPS"</span></span>: <span class="hljs-number"><span class="hljs-number">16538654</span></span>, <span class="hljs-attr"><span class="hljs-attr">"totalSpace"</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"writeBytes"</span></span>: <span class="hljs-number"><span class="hljs-number">930057794560</span></span>, <span class="hljs-attr"><span class="hljs-attr">"writeIOPS"</span></span>: <span class="hljs-number"><span class="hljs-number">30476842</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"measurement"</span></span>: <span class="hljs-string"><span class="hljs-string">"disk"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tags"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"image"</span></span>: <span class="hljs-string"><span class="hljs-string">"cc8121ef-2029-4f4f-826e-7c4f2c8a5563"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pool"</span></span>: <span class="hljs-string"><span class="hljs-string">"b13cb3c0-c84d-334c-9fc3-4826ae58d984"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"vmHost"</span></span>: <span class="hljs-string"><span class="hljs-string">"qemu+tcp://root@10.252.1.33:16509/system"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"vmId"</span></span>: <span class="hljs-string"><span class="hljs-string">"i-376-1733-VM"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"vmUuid"</span></span>: <span class="hljs-string"><span class="hljs-string">"12805898-0fda-4fa6-9f18-fac64f673679"</span></span> } }</code> </pre> <br><p>  General statistics on the virtualization host, as LibVirt "sees" it: </p><br><pre> <code class="hljs json"> { <span class="hljs-attr"><span class="hljs-attr">"fields"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"freeMem"</span></span>: <span class="hljs-number"><span class="hljs-number">80558</span></span>, <span class="hljs-attr"><span class="hljs-attr">"idle"</span></span>: <span class="hljs-number"><span class="hljs-number">120492574</span></span>, <span class="hljs-attr"><span class="hljs-attr">"iowait"</span></span>: <span class="hljs-number"><span class="hljs-number">39380</span></span>, <span class="hljs-attr"><span class="hljs-attr">"kernel"</span></span>: <span class="hljs-number"><span class="hljs-number">1198652</span></span>, <span class="hljs-attr"><span class="hljs-attr">"totalMem"</span></span>: <span class="hljs-number"><span class="hljs-number">128850</span></span>, <span class="hljs-attr"><span class="hljs-attr">"user"</span></span>: <span class="hljs-number"><span class="hljs-number">6416940</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"measurement"</span></span>: <span class="hljs-string"><span class="hljs-string">"nodeInfo"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tags"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"vmHost"</span></span>: <span class="hljs-string"><span class="hljs-string">"qemu+tcp://root@10.252.1.33:16509/system"</span></span> } }</code> </pre> <br><h2 id="nastroyka-libvirt">  LibVirt setup </h2><br><p>  In the configuration file <code>/etc/libvirt/libvirtd.conf</code> you need to install: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">listen_tls</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> listen_tcp = <span class="hljs-number"><span class="hljs-number">1</span></span> tcp_port = <span class="hljs-string"><span class="hljs-string">"16509"</span></span> auth_tcp = <span class="hljs-string"><span class="hljs-string">"none"</span></span> mdns_adv = <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><blockquote>  <strong>Attention</strong> !  The above settings will allow you to connect to the LibVirt API via TCP, configure the firewall correctly to limit access. </blockquote><p>  After completing these settings, LibVirt must be restarted. </p><br><pre> <code class="bash hljs">sudo service libvirt-bin restart</code> </pre> <br><h2 id="influxdb">  InfluxDB </h2><br><h3 id="ustanovka-dlya-ubuntu">  Installation (for Ubuntu) </h3><br><p>  InfluxDB is installed according to the <a href="https://docs.influxdata.com/influxdb/v0.9/introduction/installation/">documentation</a> , for example, for Ubuntu: </p><br><pre> <code class="bash hljs">curl -sL https://repos.influxdata.com/influxdb.key | sudo apt-key add - <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> /etc/lsb-release <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb https://repos.influxdata.com/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${DISTRIB_ID,,}</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${DISTRIB_CODENAME}</span></span></span><span class="hljs-string"> stable"</span></span> | sudo tee /etc/apt/sources.list.d/influxdb.list sudo apt-get update &amp;&amp; sudo apt-get install influxdb sudo service influxdb start</code> </pre> <br><h3 id="nastroyka-autentifikacii">  Authentication Setting </h3><br><p>  Run the influx command to open a session to the DBMS: </p><br><pre> <code class="bash hljs">$ influx</code> </pre> <br><p>  Create an administrator (we will need it when we activate authentication): </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PASSWORD</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;password&gt;'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">PRIVILEGES</span></span></code> </pre> <br><p>  Create a database pulsedb and regular pulse user with access to this database: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> pulsedb <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> pulse <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PASSWORD</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;password&gt;'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pulsedb <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> pulse</code> </pre> <br><p>  Enable <a href="https://docs.influxdata.com/influxdb/v0.9/administration/authentication_and_authorization/">authentication</a> in the /etc/influxdb/influxdb.conf configuration file: </p><br><pre> <code class="hljs objectivec">auth-enabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> <br><p>  Restart InfluxDB: </p><br><pre> <code class="bash hljs">service influxdb restart</code> </pre> <br><p>  If everything is done correctly, now when opening a session you need to specify a username and password: </p><br><pre> <code class="bash hljs">influx -username pulse -password secret</code> </pre> <br><h2 id="zapusk-konteynera-dlya-nachala-sbora-dannyh">  Running a container to start collecting data </h2><br><pre> <code class="bash hljs">docker pull bwsw/cs-pulse-sensor docker run --restart=always -d --name 10.252.1.11 \ -e PAUSE=10 \ -e INFLUX_HOST=influx \ -e INFLUX_PORT=8086 \ -e INFLUX_DB=pulsedb \ -e INFLUX_USER=pulse \ -e INFLUX_PASSWORD=secret \ -e GATHER_HOST_STATS=<span class="hljs-literal"><span class="hljs-literal">true</span></span> -e DEBUG=<span class="hljs-literal"><span class="hljs-literal">true</span></span> \ -e KVM_HOST=qemu+tcp://root@10.252.1.11:16509/system \ bwsw/cs-pulse-sensor</code> </pre> <br><p>  Most of the parameters are self-evident, I will explain only two: </p><br><ol><li>  PAUSE - the interval between the request values ‚Äã‚Äãin seconds; </li><li>  GATHER_HOST_STATS - determines whether or not to collect additional statistics on the host; </li></ol><br><p>  After that, the container log with the help of the docker logs command should reflect the activity and should not reflect errors. </p><br><p>  If you open a session to InfluxDB, then in the console you can execute a command and make sure that the measurement data is available: </p><br><pre> <code class="bash hljs">influx -database pulsedb -username admin -password secret</code> </pre> <br><pre> <code class="sql hljs">&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cpuTime <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: cpuTime <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> cpuTime cpus vmHost vmId vmUuid <span class="hljs-comment"><span class="hljs-comment">---- ------- ---- ------ ---- ------ 1498262401173035067 1614.06 4 qemu+tcp://root@10.252.1.30:16509/system i-332-2954-VM 9c002f94-8d24-437e-8af3-a041523b916a</span></span></code> </pre> <br><p>  This concludes the main part of the article, then we will see how you can work with persistent time series using Grafana. </p><br><h2 id="ustanovka-i-nastroyka-grafana-ubuntu">  Install and configure Grafana (Ubuntu) </h2><br><p>  Install as described in the <a href="http://docs.grafana.org/installation/debian/">documentation.</a> </p><br><pre> <code class="bash hljs">wget https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana_4.4.1_amd64.deb sudo apt-get install -y adduser libfontconfig sudo dpkg -i grafana_4.4.1_amd64.deb sudo service grafana-server start sudo update-rc.d grafana-server defaults</code> </pre> <br><p>  Launch the web browser and open the Grafana administrative interface <a href="http://influx.host.com:3000/">http</a> ://influx.host.com.000000/. </p><br><h3 id="dobavlenie-istochnika-dannyh-v-grafana">  Adding a data source to Grafana </h3><br><p>  Detailed <a href="http://docs.grafana.org/features/datasources/influxdb/">instructions</a> for adding a data source on the project website.  In our case, the added data source might look like this: </p><br><p><img src="https://habrastorage.org/web/846/429/596/84642959614b4ebaa0de9c23b6df2be4.png"></p><br><p>  After saving the data source, you can create "deshbordy" and try to create queries for graphs (since this instruction is not about how to use Grafana, then I give only expressions for queries): </p><br><p>  CPU load (minutes): </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> NON_NEGATIVE_DERIVATIVE(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(<span class="hljs-string"><span class="hljs-string">"cpuTime"</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>m) / <span class="hljs-keyword"><span class="hljs-keyword">LAST</span></span>(<span class="hljs-string"><span class="hljs-string">"cpus"</span></span>) / <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"cpuTime"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">"vmUuid"</span></span> = <span class="hljs-string"><span class="hljs-string">'6da0cdc9-d8ff-4b43-802c-0be01c6e0099'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> $timeFilter <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>m)</code> </pre> <br><p>  CPU load (five minutes): </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> NON_NEGATIVE_DERIVATIVE(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(<span class="hljs-string"><span class="hljs-string">"cpuTime"</span></span>), <span class="hljs-number"><span class="hljs-number">5</span></span>m) / <span class="hljs-keyword"><span class="hljs-keyword">LAST</span></span>(<span class="hljs-string"><span class="hljs-string">"cpus"</span></span>) / <span class="hljs-number"><span class="hljs-number">300</span></span> * <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"cpuTime"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">"vmUuid"</span></span> = <span class="hljs-string"><span class="hljs-string">'6da0cdc9-d8ff-4b43-802c-0be01c6e0099'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> $timeFilter <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>m)</code> </pre> <br><p>  CPU load (all VMs): </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> NON_NEGATIVE_DERIVATIVE(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(<span class="hljs-string"><span class="hljs-string">"cpuTime"</span></span>),<span class="hljs-number"><span class="hljs-number">1</span></span>m) / <span class="hljs-keyword"><span class="hljs-keyword">LAST</span></span>(<span class="hljs-string"><span class="hljs-string">"cpus"</span></span>) / <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CPU <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"cpuTime"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> $timeFilter <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>m), vmUuid</code> </pre> <br><p><img src="https://habrastorage.org/web/830/271/acb/830271acb9954493838e7b202127357b.png"></p><br><p>  VM memory (five minute aggregation): </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(<span class="hljs-string"><span class="hljs-string">"rss"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">"rss"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-string"><span class="hljs-string">"vmUuid"</span></span> = <span class="hljs-string"><span class="hljs-string">'6da0cdc9-d8ff-4b43-802c-0be01c6e0099'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> $timeFilter <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>m) fill(<span class="hljs-literal"><span class="hljs-literal">null</span></span>)</code> </pre> <br><p>  ReadBytes, WriteBytes for disk statistics (five-minute aggregation): </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> NON_NEGATIVE_DERIVATIVE(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(<span class="hljs-string"><span class="hljs-string">"readBytes"</span></span>),<span class="hljs-number"><span class="hljs-number">5</span></span>m) / <span class="hljs-number"><span class="hljs-number">300</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"disk"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">"image"</span></span> = <span class="hljs-string"><span class="hljs-string">'999a1942-3e14-4d04-8123-391494a28198'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> $timeFilter <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>m) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> NON_NEGATIVE_DERIVATIVE(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(<span class="hljs-string"><span class="hljs-string">"writeBytes"</span></span>),<span class="hljs-number"><span class="hljs-number">5</span></span>m) / <span class="hljs-number"><span class="hljs-number">300</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"disk"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">"image"</span></span> = <span class="hljs-string"><span class="hljs-string">'999a1942-3e14-4d04-8123-391494a28198'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> $timeFilter <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>m)</code> </pre> <br><p>  ReadBits, WriteBits statistics for NIC (five-minute aggregation): </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> NON_NEGATIVE_DERIVATIVE(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(<span class="hljs-string"><span class="hljs-string">"readBytes"</span></span>), <span class="hljs-number"><span class="hljs-number">5</span></span>m) / <span class="hljs-number"><span class="hljs-number">300</span></span> * <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"networkInterface"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">"mac"</span></span> = <span class="hljs-string"><span class="hljs-string">'06:07:70:00:01:10'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> $timeFilter <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>m) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> NON_NEGATIVE_DERIVATIVE(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(<span class="hljs-string"><span class="hljs-string">"writeBytes"</span></span>), <span class="hljs-number"><span class="hljs-number">5</span></span>m) / <span class="hljs-number"><span class="hljs-number">300</span></span> * <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"networkInterface"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">"mac"</span></span> =<span class="hljs-string"><span class="hljs-string">'06:07:70:00:01:10'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> $timeFilter <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>m)</code> </pre> <br><p>  All the power of the query language InfluxDB at your service, and you can build such deshboards that meet your needs and allow you to make a visual analysis of the data.  For example, one of the most useful cases for me is the analysis of incidents, it happens that a client complains that "your code is **** o" ¬© and says that his VM worked wonderfully, and then everything.  We build the expression, look at the picture, we see how the CPU of its VM for an hour left at the peak and left.  Screenshot is a great argument for resolving a conflict. </p><br><p>  You can also analyze the most intensively using various resources of the VM, in order to migrate them to individual hosts.  Yes, whatever.  In this sense, Grafana, Kibana and similar systems compare favorably with traditional monitoring systems (for example, Zabbix) in that they allow you to do on-demand analysis and build complex analytical sets, and InfluxDB helps to ensure high performance analysis even on a large data set. </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  The code that receives data from LibVirt has been tested with VMs that use volumes in QCOW2 format.  I tried to take into account the options LVM2 and RBD, but not tested.  If someone succeeds in testing the code on other versions of the VM volumes and sending corrections for the code, I would be grateful. </p><br><p>  PS: When monitoring VM network traffic, you may find that the PPS data is much less than what you receive via Sflow / Netflow on the router or tcpdump in the VM.  This is a well-known feature of KVM, the network subsystem of which does not adhere to the standard MTU of 1500 bytes. </p><br><p>  PPS: LibVirt API documentation for python is terrible and I had to wade through different versions to still find out how the data is returned and what they mean. </p><br><p>  PPS2: If anything, as they say on Gazorpazorp, "I'm there, if you need to talk" ¬© </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/332652/">https://habr.com/ru/post/332652/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../332638/index.html">RAML routing in the Play Framework</a></li>
<li><a href="../332640/index.html">How generic-they save us from packing</a></li>
<li><a href="../332642/index.html">Simple field validation</a></li>
<li><a href="../332644/index.html">Tandem office and mobile telephony. How we developed FMC</a></li>
<li><a href="../332646/index.html">Security Week 27: ExPetr = BlackEnergy, more than 90% of sites are insecure, in RCE-vulnerability closed in Linux</a></li>
<li><a href="../332654/index.html">Creating chatbot-a using sockeye (MXNet) based on AWS EC2 and AWS DeepLearning AMI</a></li>
<li><a href="../332656/index.html">What did the PR leaders do on the day of the meeting between Putin and Trump on the G20?</a></li>
<li><a href="../332658/index.html">Personal experience: as an IT specialist, move to work in the USA, relying only on himself</a></li>
<li><a href="../332660/index.html">Script for express recovery Excel files after damage</a></li>
<li><a href="../332662/index.html">Interview in SD podCast with Pavel Odintsov, author of FastNetMon, a tool for detecting and repelling DDoS attacks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>