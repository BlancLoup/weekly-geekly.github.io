<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Static analysis: errors in the media player and bugless ICQ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I will continue the tour of program errors and demonstration of the utility of static code analysis. 

 This is my last post about a version of PVS-St...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Static analysis: errors in the media player and bugless ICQ</h1><div class="post__text post__text-html js-mediator-article">  I will continue the tour of program errors and demonstration of the utility of static code analysis. <br><br>  This is my last post about a version of <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> that is not yet available for download.  I plan that in a week you will be able to try the first beta-version with a new set of general-purpose rules. <br><br>  Consider two projects.  The first is the <a href="http://fennec.sourceforge.net/">Fennec Media Project</a> .  This is a universal media player focused on playing audio and video in high resolution.  The set of source codes includes many plug-ins and codecs, but only the player itself will be analyzed.  The source code for the latest version of Alpha 1.2 is available <a href="http://sourceforge.net/projects/fennec/">here</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The second project is <a href="http://www.qutim.org/glavnaya">qutIM</a> .  This is a cross-platform open-source instant messaging client.  The code was analyzed at the beginning of November 2010.  A set of source codes was provided to me by one of the developers, but you can also download the source code from the official site.  This developer, by the way, is here - <a href="http://gorthauer87.habrahabr.ru/">gorthauer87</a> . <br><br><a name="habracut"></a><br><br>  Fennec Media Project.  A small normal project containing a normal amount of errors.  Here is the first mistake.  Or the first two errors, depending on how you count.  In general, in two places, instead of the variable 'b', the variable 'a' is used. <br><br><pre>  int fennec_tag_item_compare (struct fennec_audiotag_item * a,
   struct fennec_audiotag_item * b)
 {
   int v;
   if (a-&gt; tsize &amp;&amp; a-&gt; tsize)
     v = abs (str_cmp (a-&gt; tdata, a-&gt; tdata));
   else
     v = 1;
   return v;
 } </pre><br>  PVS-Studio pointed to this code, since the condition "a-&gt; tsize &amp;&amp; a-&gt; tsize" is clearly suspicious. <br><br>  Diagnostic message and error location in code: <br><table><tbody><tr><td>  I‚Äôm the operator: a -&gt; tsize &amp;&amp; a -&gt; tsize media library.c 1076 </td></tr></tbody></table>  And now the dear and dear to the heart of every programmer are superfluous semicolons.  Here is the first fragment: <br><br><pre>  int settings_default (void)
 {
   ...
   for (i = 0; i &lt;16; i ++);
     for (j = 0; j &lt;32; j ++)
     {
       settings.conversion.equalizer_bands.boost [i] [j] = 0.0;
       settings.conversion.equalizer_bands.preamp [i] = 0.0;
     }
 } </pre><br>  PVS-Studio message and location code: <br><table><tbody><tr><td>  V529 Odd semicolon ';'  after 'for' operator.  settings.c 483 </td></tr></tbody></table>  The second fragment: <br><br><pre>  int trans_rest (transcoder_settings * trans)
 {
   ...
   for (i = 0; i &lt;16; i ++);
   {
     trans-&gt; eq.eq.preamp [i] = 0.0;
     for (j = 0; j &lt;32; j ++)
     {
       trans-&gt; eq.eq.boost [i] [j] = 0.0;
     }
   }
 } </pre><br>  PVS-Studio message and location code: <br><table><tbody><tr><td>  V529 Odd semicolon ';'  after 'for' operator.  settings.c 913 </td></tr></tbody></table>  There is a third and fourth fragment with a ';'.  But I will not give here.  All the same type and uninteresting. <br><br>  Further not quite a mistake, but almost.  Instead of the _beginthreadex function, CreateThread is used.  There are several calls to CreateThread in Fennec, but I will give only one example: <br><br><pre>  t_sys_thread_handle sys_thread_call (t_sys_thread_function cfunc)
 {
   unsigned long tpr = 0;
   unsigned long tid = 0;
   return (t_sys_thread_handle)
     CreateThread (0, 0, cfunc, &amp; tpr, 0, &amp; tid);
 } </pre><br>  PVS-Studio warning and location code: <br><table><tbody><tr><td>  V513 Use _beginthreadex / _endthreadex functions instead of CreateThread / ExitThread functions.  system.c 331 </td></tr></tbody></table>  I‚Äôll not go into the question of why _beginthreadex / _endthreadex should be used instead of CreateThread / ExitThread.  I will write quite briefly, and detailed discussions of this issue can be read <a href="http://www.viva64.com/go.php%3Furl%3D385">here</a> , <a href="http://www.viva64.com/go.php%3Furl%3D386">here</a> and <a href="http://www.viva64.com/go.php%3Furl%3D387">here</a> . <br><br>  Scripture (MSDN) states: <br><br>  A thread-in-run-time library (CRT) should use the <a href="http://go.microsoft.com/fwlink/%3FLinkId%3D125829">_thigthadex</a> and <a href="http://go.microsoft.com/fwlink/%3FLinkId%3D125830">_endthreadex</a> functions for thread management rather than the CreateThread and <a href="http://msdn.microsoft.com/en-us/library/ms682659(v%3DVS.85).aspx">ExitThread</a> ;  this requires a multi-threaded version of the CRT.  If you have created a CRT, you can terminate the process in low-memory conditions. <br><br>  In general, it is better to err and always call _beginthreadex / _endthreadex.  By the way, this is exactly what Jeffrey Richter recommends doing in the sixth chapter ‚ÄúWindows for professionals: creating effective Win32 applications tailored to the specifics of the 64-bit version of Windows‚Äù / Trans.  from English  - 4th ed. <br><br>  There were several unsuccessful uses of the memset function.  By the way, until recently I thought that the anxiety associated with the use of memset, memcmp, memcpy was a thing of the past.  Like, it used to be written like this, but now everyone knows about the dangers, is careful with these functions, use sizeof (), use containers from STL and so on.  And now everything is pink and soft.  It turns out that no.  I have seen enough of these functions for the last month.  So all these mistakes still bloom and smell. <br><br>  Let's go back to Fennec.  First memset: <br><br><pre>  #define uinput_size 1024
 typedef wchar_t letter;

 letter uinput_text [uinput_size];

 string basewindows_getuserinput (const string title,
   const string cap, const string dtxt)
 {
   memset (uinput_text, 0, uinput_size);
   ...
 } </pre><br>  Diagnostics of PVS-Studio and location code: <br><table><tbody><tr><td>  V512 A call of the memset function will lead to a buffer overflow or underflow.  base windows.c 151 </td></tr></tbody></table>  At first glance, with ‚Äúmemset (uinput_text, 0, uinput_size);‚Äù everything is fine.  And maybe it was even good, in those times when the type of 'letter' was 'char'.  But now it is 'wchar_t' and as a result we clean only half of the buffer. <br><br>  Second unsuccessful memset: <br><br><pre>  typedef wchar_t letter;
 letter name [30];

 int Conv_EqualizerProc (HWND hwnd, UINT uMsg,
   WPARAM wParam, LPARAM lParam)
 {
   ...
   memset (eqp.name, 0, 30);
   ...
 } </pre><br>  Truly magical numbers are evil.  It seems and not difficult to write "sizeof (eqp.name)".  But we don‚Äôt persist in writing and continue to shoot ourselves again and again :). <br><br>  Diagnostics of PVS-Studio and location code: <br><table><tbody><tr><td>  V512 A call of the memset function will lead to a buffer overflow or underflow.  base windows.c 2892 </td></tr></tbody></table>  Well, in another place there is such a mistake: <br><table><tbody><tr><td>  V512 A call of the memset function will lead to a buffer overflow or underflow.  transcode settings.c 588 </td></tr></tbody></table>  It is possible that sometimes in some programs you noticed that the file open / save dialogs work with oddities or some nonsense is present in the fields of the available extensions.  Now you will know where your legs grow from. <br><br>  In the Windows API, there are structures in which pointers to lines must end with a double zero.  The most used is the lpstrFilter member in the OPENFILENAME structure.  This parameter actually points to a set of strings separated by the '\ 0' character.  And in order to find out that the lines are over and we need two zeros at the end. <br><br>  That's just very easy to forget.  Code snippet: <br><br><pre>  int JoiningProc (HWND hwnd, UINT uMsg,
   WPARAM wParam, LPARAM lParam)
 {
   ...
   OPENFILENAME lofn;
   memset (&amp; lofn, 0, sizeof (lofn));
   ...
   lofn.lpstrFilter = uni ("All Files (*. *) \ 0 *. *");
   ...
 } </pre><br>  PVS-Studio message and location code: <br><table><tbody><tr><td>  V540 Member 'lpstrFilter' should point to string terminated by two 0 characters.  base windows.c 5309 </td></tr></tbody></table>  Whether the dialogue will work normally or not depends on what is located in memory after the line ‚ÄúAll Files (*. *) \ 0 *. *‚Äù.  Right here you should write "All Files (*. *) \ 0 *. * \ 0".  One zero is clearly indicated by us, one more zero will be added by the compiler. <br><br>  Similar trouble with other dialogues. <br><br><pre>  int callback_presets_dialog (HWND hwnd, UINT msg,
   WPARAM wParam, LPARAM lParam)
 {
   ...
   // SAVE
   OPENFILENAME lofn;
   memset (&amp; lofn, 0, sizeof (lofn));
   ...
   lofn.lpstrFilter = uni ("Equalizer Preset (* .feq) \ 0 * .feq");
   ...
   ...
   // LOAD
   ...
   lofn.lpstrFilter = uni ("Equalizer Preset (* .feq) \ 0 * .feq");
   ...
 }
 int localsf_show_save_playlist (void)
 {
   OPENFILENAME lofn;
   memset (&amp; lofn, 0, sizeof (lofn));
   ...
   lofn.lpstrFilter = uni ("Text file (* .txt) \ 0 * .txt \ 0M3U file \ 0 * .m3u");
   ...
 } </pre><br>  Diagnostics of PVS-Studio and location in code: <br><table><tbody><tr><td>  V540 Member 'lpstrFilter' should point to string terminated by two 0 characters.  base windows.c 986 </td></tr><tr><td>  V540 Member 'lpstrFilter' should point to string terminated by two 0 characters.  base windows.c 1039 </td></tr><tr><td>  V540 Member 'lpstrFilter' should point to string terminated by two 0 characters.  shared functions.c 360 </td></tr></tbody></table>  Now a suspicious feature.  Very suspicious.  However, there really is a mistake or it is simply unsuccessfully written, I do not know <br><br><pre>  unsigned long ml_cache_getcurrent_item (void)
 {
   if (! mode_ml)
     return skin.shared-&gt; audio.output.playlist.getcurrentindex ();
   else
     return skin.shared-&gt; audio.output.playlist.getcurrentindex ();
 } </pre><br>  Diagnostics of PVS-Studio and location in code: <br><table><tbody><tr><td>  V523 The 'then' statement is equivalent to the 'else' statement.  media library window.c 430 </td></tr></tbody></table>  I did not begin to analyze the various modules of extensions that come with Fennec.  But there are no less than different sad places.  I will give only a couple of examples.  Code snippet from Codec ACC project. <br><br><pre>  void MP4RtpHintTrack :: GetPayload (...)
 {
   ...
   if (pSlash! = NULL) {
     pSlash ++;
     if (pSlash! = '\ 0') {
       length = strlen (pRtpMap) - (pSlash - pRtpMap);
       * ppEncodingParams = (char *) MP4Calloc (length + 1);
       strncpy (* ppEncodingParams, pSlash, length);
     }
 } </pre><br>  As follows from the PVS-Studio diagnostic message: <br><table><tbody><tr><td>  V528 It is odd that pointer to 'char' type is compared with the '\ 0' value.  Probably meant: * pSlash! = '\ 0'.  rtphint.cpp 346 </td></tr></tbody></table>  here forgot pointer dereferencing.  It turns out that we are doing a meaningless comparison of the pointer with 0. It should have been: "if (* pSlash! = '\ 0')". <br><br>  A snippet of code from the Decoder Mpeg Audio project: <br><br><pre>  void * tag_write_setframe (char * tmem,
   const char * tid, const string dstr)
 {
   ...
   if (lset)
   {
     fhead [11] = '\ 0';
     fhead [12] = '\ 0';
     fhead [13] = '\ 0';
     fhead [13] = '\ 0';
   }
   ...
 } </pre><br>  Diagnostic message of PVS-Studio and location in code: <br><table><tbody><tr><td>  V525 The code containing the collection of similar blocks.  Check items '11', '12', '13', '13' in lines 716, 717, 718, 719. id3 editor.c 716 </td></tr></tbody></table>  Here is the evil of the Copy-Paste method :). <br><br>  On the whole, the general-purpose analysis in PVS-Studio on the Fennec Media Project project performed very well.  The analysis was performed with a low percentage of false positives.  In total, PVS-Studio pointed to 31 code fragments.  In this case, in 19 places, the code should really be corrected. <br><br>  We now turn to the project qutIM. <br><br>  Here with this project, PVS-Studio was defeated.  Despite the fact that the project is quite large (about 200 thousand stock), the PVS-Studio analyzer could not identify any errors in it.  Although they certainly are.  They are always and everywhere :).  And the developers of qutIM do not argue with this, as in some cases qutIM manages to fall. <br><br>  You have to score one point ‚Äúteam error‚Äù. <br><br>  What does this mean?  It means: <br><br>  1) The project qutIM is a very high-quality project.  And although it also contains errors, they are very rare and too high for static analysis (at least for PVS-Studio). <br><br>  2) PVS-Studio still has a long way to develop and train higher-level diagnostics.  Now it has become more obvious to strive for.  The goal is to find at least a couple of real errors in qutIM. <br><br>  Did you give out something to PVS-Studio for the qutIM project?  Gave out.  But a little and almost all the false positives.  From the present at least some interest, you can select only the following. <br><br>  A) Use the CreateThread function. <br><br>  B) Found some strange features.  Then one of the authors qutIM said that this is a forgotten stub.  The oddity is that one has the name save (), the other cancel (), but their contents are identical: <br><br><pre>  void XSettingsWindow :: save ()
 {
   QWidget * c = p-&gt; stackedWidget-&gt; currentWidget ();
   while (p-&gt; modifiedWidgets.count ()) {
     SettingsWidget * widget = p-&gt; modifiedWidgets.takeFirst ();
     widget-&gt; save ();
     if (widget! = c)
       widget-&gt; deleteLater ();
   }
   p-&gt; buttonBox-&gt; close ();
 }

 void XSettingsWindow :: cancel ()
 {
   QWidget * c = p-&gt; stackedWidget-&gt; currentWidget ();  
   while (p-&gt; modifiedWidgets.count ()) {
     SettingsWidget * widget = p-&gt; modifiedWidgets.takeFirst ();
     widget-&gt; save ();
     if (widget! = c)
       widget-&gt; deleteLater ();
   }  
   p-&gt; buttonBox-&gt; close ();
 } </pre><br>  Diagnostics of PVS-Studio: <br><table><tbody><tr><td>  V524 It is the odd that the 'cancel' function is fully equivalent to the 'save' function (xsettingswindow.cpp, line 256).  xsettingswindow.cpp 268 </td></tr></tbody></table>  I hope it was interesting, and you will soon want to try PVS-Studio 4.00 Beta.  Of course, PVS-Studio still finds few errors of a general form, but this is only the beginning.  At the same time, correcting even one single error at the coding stage can save a lot of nerves to customers, testers and programmers. <br><br><hr><br>  PS Once again I want to thank everyone who took part in the discussion of the topic "I <a href="http://habrahabr.ru/company/intel/blog/108231/">collect the ugly things from programmers</a> " and shared examples.  Much will eventually come to PVS-Studio.  Thank! </div><p>Source: <a href="https://habr.com/ru/post/108397/">https://habr.com/ru/post/108397/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../108391/index.html">How to buy sales, not traffic?</a></li>
<li><a href="../108392/index.html">Your GPS monitoring</a></li>
<li><a href="../108393/index.html">Platform 2011. Photo report</a></li>
<li><a href="../108394/index.html">Launched WebProfessionals.ru service to find partners for website customers</a></li>
<li><a href="../108395/index.html">Photo report from the construction of a 570 megapixel camera</a></li>
<li><a href="../108399/index.html">Sale of the Sex.com domain for $ 13 million confirmed</a></li>
<li><a href="../108400/index.html">Open standard OSSIRIUS SCS 702</a></li>
<li><a href="../108401/index.html">Reg.ru vs. Ru-Center: The Lawyers' War against Techies</a></li>
<li><a href="../108402/index.html">Kaspersky code leak - now in public</a></li>
<li><a href="../108403/index.html">Launched the world's first 100 Gbit / s commercial highway</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>