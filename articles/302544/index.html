<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unwanted DNS Unlocker uses the DNS hijack method to trick users</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Our technical support specialists record a variety of user requests. One of these requests was very interesting for analysis. The situation was that w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unwanted DNS Unlocker uses the DNS hijack method to trick users</h1><div class="post__text post__text-html js-mediator-article">  Our technical support specialists record a variety of user requests.  One of these requests was very interesting for analysis.  The situation was that we detected malicious activity in the user's system, which was manifested in the <a href="https://ru.wikipedia.org/wiki/DNS_hijacking">DNS hijack</a> technique.  It is used to redirect user‚Äôs DNS requests to special DNS servers.  The peculiarity of the situation was that the malware used a special method for the operation hijack, which hid the malicious activity from the user's eyes. <br><br><img src="https://habrastorage.org/files/438/55b/b6b/43855bb6b36241c484af0f9fbd8f41e3.jpeg"><br><br>  Thus, the user could not see the settings of the DNS servers in the GUI interface of the network settings.  In addition, it will also indicate that the system uses the DHCP protocol to obtain the settings.  An unwanted application that performs similar operations on the system is called <b>DNS Unlocker</b> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>  The DNS Unlocker application sets the victim's network settings in such a way that they point to fake DNS server addresses.  When a web browser visits the victim of google-analytics.com, a fake DNS server will point to a malicious address with JavaScript content embedded there.  This is done in order to advertise, which is inserted into the web page DNS Unlocker, relied on Google Analytics.  Typically, a user with DNS Unlocker installed will see advertisements with a note at the bottom of a web page that says "Ads by DNSUnlocker" (Fig. 1) or something similar in a variety of other options (Fig. 2). <br><br><img src="https://habrastorage.org/files/1e0/94f/1ed/1e094f1edf424adbad4cde03de0cceec.png"><br>  Fig.  1. Advertising content embedded in a web page. <br><br><img src="https://habrastorage.org/files/e25/040/8de/e250408def064820a926ab15205549ef.png"><br>  Fig.  2. Phishing message to intimidate the user. <br><br>  Malicious software that uses DNS address spoofing mechanisms in Windows settings is not new, besides, such instances are not even worthy of detailed coverage.  However, DNS Unlocker incorporates an interesting feature that distinguishes it from other similar examples.  It is used to secretly change the DNS settings in such a way that the user will not notice.  The user will not be able to see the new TCP / IPv4 settings in the control panel, which are responsible for the fields of static DNS records.  As a rule, when specifying the DNS server address, its address should be displayed in the list of Preferred DNS Servers settings, provided that the Use the following DNS server addresses check box is selected.  In addition, the user can pay attention to the setting "Alternative DNS-server."  When using DHCP to get DNS addresses (used in most configurations of home and office environments), the setting ‚ÄúObtain DNS server address automatically‚Äù is active. <br><br><img src="https://habrastorage.org/files/6cf/674/347/6cf674347de748eb87197fc25aafce2c.png"><br>  Fig.  3. TCP / IPv4 network settings with typical settings. <br><br>  The peculiarity of the technique used by DNS Unlocker is that the static DNS address specified by it is not displayed in the list of network settings, besides, it indicates that the user receives DNS addresses automatically.  The <i>ipconfig / all</i> command will also indicate the use of DHCP, but it will also display statically set DNS addresses.  When using the ipconfig tool, however, it is impossible to establish which network connections use DHCP and which static addresses.  The network settings GUI does not display the static part and assures the user of the use of DHCP.  Below we answer the question why this happens, that is, what causes the static entry to not appear in the GUI interface of the network settings. <br><br>  Consider the registry key that is responsible for configuring network interfaces. <br><br>  <i>HKEY_LOCAL_MACHINE \ SYSTEM \ CurrentControlSet \ Services \ Tcpip \ Parameters \ Interfaces \</i> <br><br>  This registry key captures the settings of network interfaces, each of which is specified by a GUID.  The settings section for each network adapter can contain the <i>DhcpNameServer</i> and <i>NameServer parameters</i> .  The parameter <i>NameServer</i> is of interest to us.  Usually, if you configure a static DNS server, use the network settings of the control panel (or use the <i>netsh</i> command to do this).  In this case, the static server addresses will be stored in the NameServer registry parameter with the symbol ‚Äú,‚Äù as a separator for the value elements. <br><br>  <i>192.168.1.21,192.168.1.22</i> <br><br>  Now consider the case when the space separator is used as the address separator in this parameter. <br><br>  <i>192.168.1.21 192.168.1.22</i> <br><br>  This small change allows you to hide the addresses of the DNS servers being used from the GUI interface of the network settings, since, in fact, one of them is the main and the second is additional.  For a user, this fact means receiving advertisements embedded in websites visited by the user. <br><br>  Since Windows assumes that the addresses of the primary and secondary DNS servers are already set, setting the user to new values ‚Äã‚Äãwill only add them to the end of the list of items already existing there, as shown below. <br><br>  <i>192.168.1.21 192.168.1.22,208.67.222.123,208.67.220.123</i> <br><br>  It can be seen that Windows uses the symbol ‚Äú,‚Äù as a separator, while the first elements still use a space. <br><br>  The question is why Windows allows this behavior of its system component.  We do not have a reliable answer to this question.  Our hypothesis is the assumption that the <i>DhcpNameServer</i> parameter uses a list with a space as separators, and the <i>NameServer</i> copies its behavior.  In addition, according to Microsoft itself on the TechNet website, if the <i>NameServer</i> parameter is <i>present</i> , it has a higher priority than the <i>DhcpNameServer</i> . <br><br>  <i>If the value of the NameServer is valid, it takes precedence over the value of the DhcpNameServer.</i> <br>  Source: <a href="https://technet.microsoft.com/en-us/library/cc962470.aspx">technet.microsoft.com/en-us/library/cc962470.aspx</a> . <br><br>  Since the value of the <i>DhcpNameServer</i> parameter <i>is</i> allowed to have a space character as a separator, the same can be allowed for <i>NameServer</i> .  In addition, the TechNet resource <a href="https://technet.microsoft.com/en-us/library/cc978468.aspx">indicates</a> that the space character is allowed to separate the elements of the value of the <i>NameServer</i> parameter.  In fact, this property of the registry key is not standard and the GUI interface of the control panel does not know how to handle this value.  The control panel uses only the comma symbol as a separator between the Preferred and Alternate DNS servers.  It is worth noting that other Windows applications that work with this registry parameter work fine with a space as a separator.  The same applies to the parameter value on the Advanced TCP / IP Settings tab. <br><br>  Worst of all, this feature uses unwanted applications to redirect user‚Äôs DNS requests to the resources they need.  It is used as the hijack DNS method and forces the user to work with spoofed DNS servers.  We call them hidden because the user will not be able to see them in the settings of the network connections of the control panel. <br><br>  Now that we‚Äôve dealt with the DNS hijack, let's look at other areas in the TCP / IPv4 network settings GUI interface of the control panel.  We will be interested in the TCP / IP advanced settings window on the DNS tab.  The upper part of the tab contains a list that defines the order in which DNS servers are used and allows you to specify the use of more than two IP addresses as them.  Each address must use its own separate line.  Now, in the case where the DNS was intercepted and hidden, the TCP / IP settings will look like this. <br><br><img src="https://habrastorage.org/files/f77/64c/c91/f7764cc9120e47a5868d5b268d3d4c34.png"><br>  Fig.  4. Tab with advanced DNS settings for TCP / IP protocol, which uses the option with a space as a separator. <br><br>  It can be seen that in the settings on the screenshot above there are two addresses, separated by a space.  In that case, if you try to click on the "Add ..." button to add two addresses, separated by a space, the system will display an error message indicating the wrong IP address.  In the case of an attempt to add additional addresses of DNS servers to the already indicated hidden ones, they will be added in the GUI interface of the TCP / IP properties tab as separate lines. <br><br><img src="https://habrastorage.org/files/9e6/648/612/9e6648612489437896fc6091280aa7c3.png"><br>  Fig.  5. Manually set addresses of DNS servers, when previously ‚Äúhidden‚Äù records were already included. <br><br>  Fortunately, the user can delete malicious DNS entries on the DNS tab on the TCP / IP advanced settings page. <br><br>  Our specialists reported this problem to the Microsoft Security Response Center (MSRC) on May 10, 2016. MSRC recognized the problem, but did not classify it as a vulnerability, since modifying the registry value requires administrative rights.  They sent the question to other development teams for reviewing the fix in future releases. <br><br>  <b>Conclusion</b> <br><br>  Note that Windows itself can work normally with the value of the <i>NameServer</i> parameter, which uses spaces instead of a comma as a separator.  In turn, unwanted applications can use this method to hide the DNS settings in the system.  It has been observed in the use of DNS Unlocker since December 2015 and works on all Windows OS, starting with Windows XP.  It is interesting to note that a semicolon can be used as a separator for the DNS hijack method, however, we did not observe the use of this option in other types of malicious or unwanted software as of May 31, 2016. <br><br>  <b>Indicators of compromise</b> <br><br>  The DNS Unlocker version described above is detected by ESET as <b>MSIL / Adware.CloudGuard.C</b> .  It uses the following IP addresses for DNS spoofing: <br><br><ul><li>  203.131.145 </li><li>  203.131.150 - 199.203.131.152 </li><li>  163.142.2 - 82.163.142.7 </li><li>  163.142.66 - 82.163.142.70 </li><li>  163.142.130 - 82.163.142.189 </li><li>  163.143.131 - 82.163.143.190 </li><li>  211.158.129 - 95.211.158.135 </li><li>  211.158.145 - 95.211.158.151 </li></ul><br>  The following IP addresses are used as HTTP servers to inject malicious JavaScript content that displays ads on web pages. <br><br><ul><li>  163.143.23 - 82.163.143.250 </li><li>  88.193.133 - 209.88.193.141 </li></ul><br>  The following malware samples use this technique. <br><br><img src="https://habrastorage.org/files/2ea/d19/c1b/2ead19c1bf084728bd293b59129bca83.png"></div><p>Source: <a href="https://habr.com/ru/post/302544/">https://habr.com/ru/post/302544/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302532/index.html">Basics of game design: 20 board games. Part Two: Backgammon, Monopoly, Scrabble</a></li>
<li><a href="../302534/index.html">How we developed a chat framework for Android applications - Chateau</a></li>
<li><a href="../302536/index.html">World of Tanks: what does the win rate of tanks depend on?</a></li>
<li><a href="../302538/index.html">Experience of using Liferay Portal in eCommerce</a></li>
<li><a href="../302542/index.html">10,000 virtual servers on RU VDS</a></li>
<li><a href="../302548/index.html">Security Week 22: Microsoft against passwords, legal issues with Tor, crypto-fiber attacks Amazon customers</a></li>
<li><a href="../302550/index.html">IBM introduces the world's first PCM memory with three bits per cell</a></li>
<li><a href="../302552/index.html">Dynamic blur on Android</a></li>
<li><a href="../302554/index.html">Uber founder Travis Kalanik - "a rebel in the elite of Silicon Valley"</a></li>
<li><a href="../302556/index.html">Mastering programming - no problem</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>