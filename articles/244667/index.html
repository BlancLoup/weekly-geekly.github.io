<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>NetApp 7-Mode: Undocumented features or doing DR from SnapVault</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In continuation of the article about the NetApp backup paradigm , I want to talk about the undocumented possibility of converting "archival copies" in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>NetApp 7-Mode: Undocumented features or doing DR from SnapVault</h1><div class="post__text post__text-html js-mediator-article">  In continuation of the article about <a href="http://habrahabr.ru/post/244923/">the NetApp backup paradigm</a> , I want to talk about the undocumented possibility of converting "archival copies" into "backup" for the <abbr title="Fabric-attached storage">FAS</abbr> series.  A distinctive feature of NetApp <abbr title="Fabric-attached storage">FAS</abbr> series <abbr title="Storage System">storage</abbr> systems is that they are all unified.  Uniformity not only in the fact that one device provides access to hosts both by block and file protocols, but also by the method of application.  <abbr title="Fabric-attached storage">FAS</abbr> systems are used for virtualization, for Data Compliance, for storing backup copies, for building Disaster Recovery solutions, etc.  The same <abbr title="Storage System">storage system</abbr> can perform many functions at once.  So for each function, you do not need to keep one ‚Äúspecialized‚Äù device, and in case you need an ‚Äúspare‚Äù <abbr title="Storage System">storage system</abbr> , you can always ‚Äúrepurpose‚Äù it from what is, for example, from a <abbr title="Storage System">storage system</abbr> for data archiving.  Thanks to this versatility, there is no need to retrain for each of these tasks because the operating system, command line and all the configuration principles are the same for all <abbr title="Fabric-attached storage">FAS</abbr> systems. <br><br>  In this article, I‚Äôll tell you how to convert the built-in solution ‚ÄúArchiving Data to NetApp‚Äù into a ‚ÄúDisaster Recovery‚Äù solution. <br><br>  From a business perspective, Disaster Recovery and archiving are different in that: <br><ul><li>  Archiving (SnapVault) - the solution is designed for long-term storage and protection of data from changes, for subsequent restoration to where they were copied from (or to another location). </li><li>  Disaster Recovery (SnapMirror) - storing data on a backup site, to switch to it (and, accordingly, changing data) in the event of a disaster. </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let me explain with an example: when you have at least two <abbr title="Storage System">storage systems</abbr> with configured SnapMirror replication, in such a scheme one of them plays the role of a source (primary), and the second role of a receiver (Secondary).  In the event of a crash, when replication is discontinued (with the break command, and not just breaking the link), the receiving (Secondary) system will translate the replicable mirror from read-only mode to read-write mode.  Those.  It is a tool for creating a solution ‚ÄúSwitching to a spare site in case of an accident‚Äù (Disaster Recovery).  It is logical that both systems have a plus or minus of the same performance in order to ensure all the nodes switched from one site to another, due level of performance. <br><br><img src="https://habrastorage.org/files/a02/72c/ad4/a0272cad4b294a24bb95ca422e07f6dd.png"><br><br>  While SnapVault is designed for archiving to a backup (Secondary) system, in order to restore all data from it back to the primary system or to a third system in general.  It is worth noting that for archiving tasks it is very important to store data in an unchanged state all the time.  In this case, the secondary system, where all the archives are added, can be any model.  It is logical to have the cheapest model of NetApp <abbr title="Fabric-attached storage">FAS</abbr> with slower and cheaper larger disks.  For example, <a href="http://blog.aboutnetapp.ru/archives/1369">FAS2554 or FAS2520</a> . <br><a name="habracut"></a><br>  In more detail how <a href="http://blog.aboutnetapp.ru/archives/1263">SnapMirror</a> and <a href="http://blog.aboutnetapp.ru/archives/1264">SnapVault work,</a> you can read the relevant articles, as well as compare these two solutions from a technical point of view. <br><br>  <abbr title="Qtree SnapMirror">QSM</abbr> SnapMirror works almost the same as SnapVault and uses the same algorithm and internal replication device, SnapMirror except <abbr title="Qtree SnapMirror">QSM</abbr> , also includes block replication <abbr title="Volume SnapMirror">VSM</abbr> .  Block replication can be synchronous or asynchronous, while SnapVault and <abbr title="Qtree SnapMirror">QSM</abbr> SnapMirror only replicate data asynchronously on a schedule.  But for that, the SnapVault archives transferred as snapshots once on a remote system can be duplicated ( <abbr title="Write Anywhere File Layout">WAFL</abbr> <a href="http://blog.aboutnetapp.ru/archives/1137">File Folding</a> works in the same way) with the contents of previous snapshots (not to be confused with deduplication inside the active file system).  Thus, SnapVault will provide an analogue of various kinds, types of archives, transferring only modified data to the remote system in the form of snapshots and storing them in deduplicated form.  Those.  snapshots are analogous to incremental backups, if you try to bring terminology closer to standard backup terminology, then snapshots from NetApp are analogous to reverse incremental backups.  Such backups (snapshots) do not need to be assembled into a ‚Äúfull backup‚Äù and waste time loading the system, while taking up such archives place as regular incremental backups.  I want to draw attention to the fact that the ‚Äúclassic implementation‚Äù of snapshots using <a href="http://en.wikipedia.org/wiki/Copy-on-write">COW</a> technology from other manufacturers is different from NetApp snepsing technology.  So snapshots working on <abbr title="Copy on Write">COW</abbr> technology have a drop in performance, with an increase in their number.  <a href="http://habrahabr.ru/post/244923/">More details</a> . <br><br>  The downside of SnapVault is that in the event of a relationship breakdown, the data on the secondary system does not go into read-write mode, these are archives, right? <br><br>  In this connection, the SnapVault archiving license is much cheaper than SnapMirror.  I‚Äôll tell you right now that I‚Äôm not going to talk about prices here, please, to authorized persons - your integrators, distributors and representatives.  I am an engineer and work with technology, not prices. <br>  Let me remind you that both in the case of SnapVault and in the case of SnapMirror, the licenses are not ‚Äúterabyte‚Äù, but ‚Äúby controller‚Äù,  a license is required both at the source and at the recipient.  Let me give an example: there are two <abbr title="High availability">HA</abbr> (two controllers in a fault-tolerant pair) of the system, one on the main one, the other on the backup site, in the amount of 4 controllers, for replication whether SnapMirror, whether SnapVault needs to acquire 4 corresponding licenses. <br><br>  Sometimes it happens that when using SnapVault, well, it‚Äôs very straightforward that we need to transfer our archive to read-write mode and, in an emergency, emergency or abnormal case, on the basis of the secondary system, raise the <abbr title="Disaster Recovery">DR</abbr> site.  That is, convert the archive system to the <abbr title="Disaster Recovery">DR</abbr> system, even if it is weaker than the main one.  Since <abbr title="Qtree SnapMirror">QSM</abbr> SnapMirror and inside "under the hood" is the same SnapVault, this can be done with the help of not documented service commands. <br><br>  <font color="red">Let me remind you that all operations you perform at your own peril and risk, the author does not bear any obligations and guarantees.</font> <br><br>  Add a SnapMirror license, you can request a trial license from the representative office, usually this is a very fast process: <br><br><pre><code class="bash hljs">netapp-sec1-7M&gt; license add SNAPMIRRORCODE</code> </pre> <br>  Make sure SnapMirror is turned off: <br><br><pre> <code class="bash hljs">netapp-sec1-7M&gt; snapmirror off</code> </pre><br>  If you have a FlexClone license or you have ordered a trial license, I recommend using it in order not to touch or damage your backup archives, but to make a complete thin copy of the data and work with it already.  By the way, let me remind you that in thin cloning of NetApp, unlike, for example, IBM Storwize block cloning, there is no drop in performance from any number of such clones.  If there is no license and you will convert the backup, skip this step and go to the next one. <br><br><pre> <code class="bash hljs">netapp-sec1-7M&gt; vol <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> create new_infra -b backup</code> </pre><br>  Cloning will also copy ‚ÄúSnapVault Relationships‚Äù <br><br>  Next, perform the magic combination of the commands for conversion: <br><br><pre> <code class="bash hljs">netapp-sec1-7M&gt; options snapvault.enable off netapp-sec1-7M&gt; priv <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> diag; snapmirror convert /vol/new_infra/nfs; priv <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> netapp-sec1-7M&gt; options snapvault.enable on</code> </pre><br>  SnapVault only works with <i>Qtree <a href="https://habr.com/ru/post/244667/">*</a></i> , you need to convert Qtree accordingly.  Not only Qtree itself, but also replication ‚Äúrelationships‚Äù are converted into SnapMirror.  In the same way, you can convert ‚Äúin the other direction‚Äù from <abbr title="Qtree SnapMirror">QSM</abbr> to SnapVault. <br><br>  Turn on SnapMirror <br><pre> <code class="bash hljs">netapp-sec1-7M&gt; snapmirror on</code> </pre><br>  Without SnapMirror enabled, you cannot break a relationship (now SnapMirror is a relationship, they were converted too) <br>  Stop the relationship.  And finally we tear them (if necessary) in order to transfer the Volyum to the RW state. <br><br><pre> <code class="bash hljs">netapp-sec1-7M&gt; snapmirror quiesce /vol/new_infra/nfs netapp-sec1-7M&gt; snapmirror <span class="hljs-built_in"><span class="hljs-built_in">break</span></span> /vol/new_infra/nfs</code> </pre><br>  Remove the SnapMirror license if necessary: <br><br><pre> <code class="bash hljs">netapp-sec1-7M&gt; license delete SNAPMIRRORCODE</code> </pre><br>  I want to draw your attention to the fact that as a result you can see in the current NetApp file system the latest archived data that has been replicated to it, available for recording.  But to restore the older snapshots, in several ways: <br><br>  Copy them with pens from snapshots, for example, using the <abbr title="Network Data Management Protocol">NDMP ndmpcopy</abbr> command from the <abbr title="Storage System">storage</abbr> command line or copy all the necessary data through the host in the standard way for it, by entering the hidden snapshoot folder. <br><br>  You can also use another <a href="http://blog.aboutnetapp.ru/archives/1145">SnapRestore</a> license, which instantly rolls back the current file system to the desired snapshot. <br><br>  The third option is that at the stage of cloning an archive (volyuma with qtree), you can clone not the state of the actual data on the NetApp <abbr title="File system">filesystem</abbr> , but one of the stored snapshots, thus, without resorting to a SnapRestore license or a long-term manual copy. <br><br><a name="Qtree_in_Clustered_ONTAP"></a><br>  * Qtree - Application for replication in NetApp <abbr title="Fabric attached storage">FAS</abbr> systems with DataONTAp Cluster-Mode OS (Clustered ONTAP) is no longer required, as <i>SnapVault</i> and <i>SnapMirror</i> <abbr title="Qtree * SnapMirror">QSM are</abbr> now able to replicate and restore data at the <i>Volume</i> level. <br><br>  <b>I ask to send messages on errors in the text to the <abbr title="Private message">LAN</abbr> .</b> <br>  <b>Notes and additions on the contrary please in the comments</b> </div><p>Source: <a href="https://habr.com/ru/post/244667/">https://habr.com/ru/post/244667/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../244651/index.html">JavaScript goes beyond the Web in 2014</a></li>
<li><a href="../244653/index.html">Servers based on new Intel Xeon E5v3 processors and DDR4 memory</a></li>
<li><a href="../244655/index.html">"Programming a mouse" in Swift part 2 - navigation</a></li>
<li><a href="../244661/index.html">Diskless booting using Windows-based iSCSI technology</a></li>
<li><a href="../244663/index.html">VoiceFabric: speech synthesis technology from the cloud</a></li>
<li><a href="../244669/index.html">Powered by a 9/12-volt SOHO router from a USB source</a></li>
<li><a href="../244671/index.html">Restoring access to Google Analytics in 4 easy steps.</a></li>
<li><a href="../244673/index.html">Welcome to CocoaHeads Moscow December 5th</a></li>
<li><a href="../244675/index.html">SnapProtect for Open Systems</a></li>
<li><a href="../244677/index.html">Backup architecture on NetApp FAS systems</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>