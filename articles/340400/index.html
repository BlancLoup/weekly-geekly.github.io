<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Competition Topcoder "Konica-Minolta Pathological Image Segmentation Challenge". Member Notes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! While we are waiting for Saturday and Avito Data Science Meetup: Computer Vision, I‚Äôll tell you about my participation in the KONICA MINOLTA Pa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Competition Topcoder "Konica-Minolta Pathological Image Segmentation Challenge". Member Notes</h1><div class="post__text post__text-html js-mediator-article"><p>  Hello!  While we are waiting for Saturday and Avito Data Science Meetup: Computer Vision, I‚Äôll tell you about my participation in the <a href="https://community.topcoder.com/longcontest/%3Fmodule%3DViewProblemStatement%26rd%3D16950%26pm%3D14622">KONICA MINOLTA Pathological Image Segmentation Challenge</a> machine learning <a href="https://community.topcoder.com/longcontest/%3Fmodule%3DViewProblemStatement%26rd%3D16950%26pm%3D14622">competition</a> .  Although I spent only a few days on this, I was lucky to take 2nd place.  Description of the solution and a detective story under the cut. </p><br><p><img src="https://habrastorage.org/webt/ht/w2/am/htw2amglshnr96ovu9uieuuoiay.png"></p><a name="habracut"></a><br><h1 id="opisanie-zadachi">  Task Description </h1><br><p>  It was necessary to develop an algorithm for the segmentation of areas in the images from the microscope.  Apparently, these were some foci of cancer cells in the epithelium.  In the picture below - what was given and how it should be done: </p><br><p><img src="https://habrastorage.org/webt/dv/jl/2d/dvjl2dbkxafbkev6_mbg-4dgj2a.png"></p><br><p>  The training and test samples consisted of 168 and 162 such images, 500x500 pixels in size, respectively.  The target metric is the arithmetic mean of F1-micro and instance-wise Dice x 1000000. </p><br><h1 id="liricheskoe-otstuplenie-s-vpechatleniyami-o-ploschadke">  Lyrical digression with impressions of the site </h1><br><p>  <a href="https://community.topcoder.com/longcontest/%3Fmodule%3DViewProblemStatement%26rd%3D16950%26pm%3D14622">The competition</a> was held on the Topcoder website.  Perhaps the reader this site reminds more about Olympiad programming than about machine learning and neural networks.  But, apparently, the guys decided to be trendy too.  It turned out that they are doubtful not only in terms of data preparation (see below), but also in terms of usability.  To submit a solution, you must: </p><br><ul><li>  predict train (!) and test; </li><li>  overtake the mask in txt, and do not forget to transpose them; </li><li>  pack the mask into the archive and drop it into your gdrive / dropbox / etc; </li><li>  enter the competition submission system and write a java-class that pulls the archive by reference. </li></ul><br><p>  Submits can be sent every 2 hours.  Once every 15 minutes check your train is available.  Accordingly, if at some point something went wrong - we walk for 2 hours.  I threw the files in the archive into the folder, but not to the root - it‚Äôs a pity, we didn‚Äôt find the mask, go check, you have 2 hours.  I forgot to throw the train masks - in 2 hours be more attentive.  I'm not saying that it is easy to confuse with such a system and send a solution that has already been sent.  Well, it's very cool, when at one o'clock in the morning you finally finished the next improver, compiled the archive and made a mistake - it remains either not to sleep, or to wait until the morning. </p><br><p>  Also, there was no option to choose some kind of your submit as the final one.  He just had to send it last.  And not to be mistaken, of course.  Looking ahead, I must say that the Chinese platform challenger.ai surpassed the topcoder in the uproarness, but this is about next time. </p><br><h1 id="pervaya-iteraciya">  First iteration </h1><br><p>  I must say that I did not want to participate for a long time, because this is again a segmentation and the site is strange.  But <a href="https://www.linkedin.com/in/iglovikov/">Vladimir Iglovikov</a> and <a href="https://www.linkedin.com/in/nizhibitsky/">Evgeny Nizhibitsky</a> shoved me to join, for which they had a special thanks. </p><br><p>  As usual, I decided to start with baseline.  As him, I chose <a href="https://github.com/ZFTurbo/ZF_UNET_224_Pretrained_Model">the ZFTurbo code</a> , which he brushed and laid out after the <a href="https://habrahabr.ru/company/avito/blog/325632/">kaggle with satellites</a> .  There were already examples of models and code for their training.  I added it to the division into five folds.  I made them by sorting all the masks of the train by area and dividing them so that in each fold the distribution of areas was the same.  I was hoping to stratify folds as much as I was wrong ... </p><br><p>  From augmentations, I left the standard corners, crop, resize.  Adam was chosen as an optimizer. </p><br><h1 id="vtoraya-iteraciya">  Second iteration </h1><br><p>  While the models were being trained, I decided to improve the baseline and started by looking carefully at the pictures.  For a start, I used mathematics and realized that the number of shots in the train is divided into 6, so it‚Äôs better to do 6 folds, not 5. It seemed to me that I don‚Äôt really understand where some of the fabrics end and others start, so I just combined each training part of the fold in one huge mask.  And then I pulled random patches 1.5 times more out of it than the input of the neural network.  More aggressive augmentations were applied to them using the <a href="https://github.com/aleju/imgaug">imgaug</a> library. </p><br><p><img src="https://habrastorage.org/webt/5z/bk/oj/5zbkoj5ylprsqez8b_ivvjne2ze.png"></p><br><p>  It is worth saying that imgaug uses a skimage, which is not very fast as it is written in python.  To overcome this flaw, I used the pytorch dataloader.  It is awesome: you need to write essentially one function get_sample, which prepares x and y (in this case, a picture and a mask), and the iterator itself collects the batch in several threads with a buffer.  He is so cool that I use it even with c keras and mxnet.  To do this, you need to tear out the batch tensors and overtake in numpy. </p><br><p>  Also in the second iteration, I changed the learning strategy.  At first, I trained Adam with a decrease in the Learning rate, then switched to SGD and at the end taught with SGD without augmentation of images associated with blues and sharps. </p><br><p>  In addition, I simultaneously launched three trainings with different loss functions: Binary Cross Entropy (BCE), BCE - log (Jaccard), BCE - log (Dice). </p><br><p><img src="https://habrastorage.org/webt/ld/xl/_t/ldxl_tcfp8bvcluzx1ypx-ry1eq.png"></p><br><h1 id="tretya-iteraciya">  Third iteration </h1><br><p>  In the third call, I decided that it was time to get off the needle of the U-net architecture, to love other neural networks and start living.  I carefully studied the pictures in the <a href="http://blog.qure.ai/notes/semantic-segmentation-deep-learning-review">review</a> and chose the <a href="https://arxiv.org/pdf/1703.02719.pdf">Global Convolutional Network</a> .  Large kernels, factorized convolutions, border-specifying blocks, a goose in the pictures ... ‚ÄúEasygold!‚Äù, I thought.  But for a couple of evenings I didn‚Äôt get a decent result on this architecture, the time was over and all the experiments moved to kaggle Carvana. </p><br><h1 id="finalnyy-ansambl">  Final ensemble </h1><br><p>  As a result, I simply mixed all the neural networks trained by that time with the geometric mean.  Picked up the thresholds on the OOF predictions and sent a few hours before the deadline.  I was extremely surprised to find myself in second place, since the public part was 11th.  In my opinion, I was incredibly lucky, because in the data there was one global joint about which below.  Blue badges indicate members from the ODS.ai community.  It is seen that the raid was a success.  To follow the progress of our chat, you can subscribe to <a href="https://twitter.com/odsai_en/status/896019971381358593">twitter</a> </p><br><p><img src="https://habrastorage.org/webt/i0/z5/xq/i0z5xqe02neabhclsjp4a-3xdvk.png"></p><br><h1 id="detektivnoe-cv-rassledovanie-evgeniya-nizhibickogo">  Detective CV-investigation of Evgeny Nizhibitsky </h1><br><p>  In the vast majority of competitions, local validation and leaderboard cease to coincide, starting with a certain quality of models.  And this competence is no exception.  However, the reason turned out to be much more interesting than just inhomogeneous partitioning. </p><br><p>  In this competition, by analogy with the <a href="https://www.kaggle.com/c/planet-understanding-the-amazon-from-space">Kaggle Amazon from Space</a> competition, Yevgeny Nizhibitsky decided to assemble an initial mosaic from which pictures were cut. </p><br><p><img src="https://habrastorage.org/webt/lb/kh/fm/lbkhfmvxlahpy4t0zqylgo8ww_k.jpeg"></p><br><p>  The search for neighbors was carried out on the basis of the L2 distance between pairs of boundaries for all possible images.  Based on the comparison with the threshold, a table was created in which its neighbors and the distance to them were indicated for each image.  Each time the pairs found were validated with the eyes, and both correct and incorrect were memorized separately.  After that, the threshold increased slightly and the search was performed again. </p><br><p>  The result of the mosaic was the understanding of the data structure - the training sample consists of 42 squares 1000x1000, each of which is cut into 4 smaller ones.  The test sample into squares did not ‚Äúfall apart‚Äù, but 120 out of 162 test images are also combined into 30 2x2 squares. </p><br><p>  A disappointing conclusion can be made from this experiment - cross-validation with random splits of splits is not representative, because with 6 folds for each fixed 2x2 square, its parts with a probability of about 50% fall in the train and in the validation. </p><br><p>  But curiosity did not fade away, why did 42 tiles from the test not unite in a mosaic?  During one of the screening processes of incorrectly matched adjacent tiles, it was found that the erroneously glued dough and train tiles were not really connected along the border, but after turning, they would be fought by entire subregions! </p><br><p>  A small proof-of-concept with matching on the SURF signs made it possible to find out that some test images were really just cut from the original large images of the train: </p><br><p><img src="https://habrastorage.org/webt/s7/24/yh/s724yhcdo_aeul94dmb1dw9isey.png"></p><br><p>  After trying to match all the pictures of the test, it turned out that 42 pictures from the test that do not come together in the mosaic are nothing but the sections of the train.  That is, the orgi did the following. </p><br><ol><li>  They took 42 original (1000x1000 size) pictures of the train and 30 pictures of the dough. </li><li>  Cut from them pictures of size 500x500. </li><li>  We decided that the test is not enough pictures (120). </li><li>  Dropped into the test randomly rotated patches from the train. </li></ol><br><p><img src="https://habrastorage.org/webt/hc/ox/po/hcoxpouwibvjlbdhmfzrfqq3mgy.png" alt="image"><br>  In the picture from left to right: one picture from the test, it is also rotated to fit the train, the original square is 2x2 train. </p><br><p>  As a result, all the participants who did not clean the data in this way and who did not split the patients (that is, all the ODS.ai participants) were overwritten.  At the same time, improvement on the leaderboard could occur for two reasons: improving the quality of the model on unknown data and retraining on rotated pieces of dough in the train.  And since the splits were not informative, there was no sign of a correlation with local validation and leaderboard.  After all, it was impossible even locally to understand: the model really learned to generalize or overfit on the train and due to this the validation improved. </p><br><p>  I talked about this competency at the <a href="https://youtu.be/u4ZwBqXRgcE">ML-training in Yandex</a> , you can watch the video.  Bonus, you can see the <a href="http://slides.com/vladimiriglovikov/deck-6">slides of Vladimir from mitap in H20</a> .  Yevgeny Nizhibitsky will talk about a much more advanced approach to segmentation at the end of this week at a <a href="https://avitotech.timepad.ru/event/595080/">meetup at Avito</a> .  Registration is already closed, but you can join the online broadcast on the <a href="https://goo.gl/S6vQNC">youtube channel AvitoTech</a> on the day of the event from 12:30. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/340400/">https://habr.com/ru/post/340400/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../340386/index.html">SOC for beginners. SOC objectives: monitoring</a></li>
<li><a href="../340388/index.html">ATMii worm allows you to steal money from ATMs</a></li>
<li><a href="../340390/index.html">On the issue of strangeness and the impossible</a></li>
<li><a href="../340394/index.html">C / C ++ code profiling on * nix-systems</a></li>
<li><a href="../340396/index.html">Writing Arcsight FlexConnector. Log file</a></li>
<li><a href="../340402/index.html">Open broadcast from the main hall of SmartData 2017: speech is not about solutions - speech is about evolution</a></li>
<li><a href="../340404/index.html">Comparison and creation of morphological analyzers in the NLTK</a></li>
<li><a href="../340406/index.html">Microsoft and Amazon introduced a new library for machine learning - Gluon</a></li>
<li><a href="../340408/index.html">How to add information about transfers to the game assembly at Unity</a></li>
<li><a href="../340410/index.html">Visual Scripting: The Future Is Now?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>