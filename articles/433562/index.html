<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Checking the LibrePCB project with PVS-Studio inside the Docker container</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is a classic article about how our team checked the open LibrePCB project with the help of the PVS-Studio static code analyzer. However, the arti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Checking the LibrePCB project with PVS-Studio inside the Docker container</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9cf/0ad/c99/9cf0adc990a16a5f4b3589254d6d1ecf.png" alt="PVS-Studio and Docker Container"></div><br>  This is a classic article about how our team checked the open LibrePCB project with the help of the PVS-Studio static code analyzer.  However, the article is interesting because the check was performed inside the Docker container.  If you use containers, we hope that the article will demonstrate another simple way to integrate the analyzer into the development process. <br><a name="habracut"></a><br><h2>  LibrePCB </h2><br>  <a href="https://librepcb.org/">LibrePCB</a> is free software for designing electronic circuits and printed circuit boards.  The program code is written in C ++, and Qt5 is used to build the graphical interface.  Recently, the first official release of this application, marked the stabilization of its own file format (* .lp, * .lplib).  Binary packages are prepared for Linux, macOS and Windows. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/eca/fd3/b3e/ecafd3b3e956a20f10f53fa20ae1e93e.png" alt="LibrePCB"></div><br><br>  LibrePCB is a small project containing only about 300,000 non-empty lines of C and C ++ code.  At the same time, 25% of non-empty lines are comments.  By the way, this is a big percentage for comments.  Most likely, this is due to the fact that there are many small files in the project, a substantial part of which is occupied by the header comments from the project information and license.  The code on the site GitHub: <a href="https://github.com/librepcb/librepcb">LibrePCB</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The project seemed interesting to us, and we decided to check it out.  But the test results were not so interesting.  Yes, there were real mistakes.  But there was not anything special about which you should definitely tell the readers of our articles.  Perhaps we would not write an article and limit ourselves to sending the found errors to the project developers.  However, the interesting point was that the project was tested inside the Docker image, and therefore we decided that it was still worth writing an article. <br><br><h2>  Docker </h2><br>  <a href="https://www.docker.com/">Docker</a> is an automation software for deploying and managing applications in a virtualization environment at the operating system level.  It allows you to "pack" the application with all its environments and dependencies in the container.  Although this technology is about five years old and many companies have long introduced Docker into their project infrastructures, in the open source world this was not very noticeable until recently. <br><br>  Our company works very closely with open source projects, checking the source code using our own PVS-Studio static analyzer.  At the moment, <a href="https://www.viva64.com/ru/inspections/">more than 300 projects</a> have been verified.  The most difficult thing in this activity has always been the compilation of other people's projects, but the implementation of Docker containers has greatly simplified this process. <br><br>  The first experience with testing an open source project in Docker was with <a href="https://www.viva64.com/ru/b/0567/">Azure Service Fabric</a> .  There, the developers did mount the source directory to the container and analyzer integration was limited to editing one of the scripts running in the container: <br><br><pre><code class="cpp hljs">diff --git a/src/build.sh b/src/build.sh index <span class="hljs-number"><span class="hljs-number">290</span></span>c57d.<span class="hljs-number"><span class="hljs-number">.2</span></span>a286dc <span class="hljs-number"><span class="hljs-number">100755</span></span> --- a/src/build.sh +++ b/src/build.sh @@ <span class="hljs-number"><span class="hljs-number">-193</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span> +<span class="hljs-number"><span class="hljs-number">193</span></span>,<span class="hljs-number"><span class="hljs-number">9</span></span> @@ BuildDir() cd ${ProjBinRoot}/build.${DirName} + pvs-studio-analyzer analyze --cfg /src/PVS-Studio.cfg \ + -o ./service-fabric-pvs.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> -j4 + <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"false"</span></span> = ${SkipBuild} ]; <span class="hljs-function"><span class="hljs-function">then </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(( $NumProc &lt;= </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ))</span></span></span></span>; then NumProc=$(($(getconf _NPROCESSORS_ONLN)+<span class="hljs-number"><span class="hljs-number">0</span></span>))</code> </pre> <br>  The difference between the LibrePCB project is that they immediately provided the <a href="https://github.com/LibrePCB/LibrePCB/blob/master/dev/docker/Dockerfile">Dockerfile</a> to build the image and the project in it.  It turned out to be even more convenient for us.  Here is the part of the Docker file that we are interested in: <br><br><pre> <code class="cpp hljs">FROM ubuntu:<span class="hljs-number"><span class="hljs-number">14.04</span></span> <span class="hljs-meta"><span class="hljs-meta"># install packages RUN DEBIAN_FRONTEND=noninteractive \ apt-get -q update \ &amp;&amp; apt-get -qy upgrade \ &amp;&amp; apt-get -qy install git g++ qt5-default qttools5-dev-tools qt5-doc \ qtcreator libglu1-mesa-dev dia \ &amp;&amp; apt-get clean # checkout librepcb RUN git clone --recursive https:</span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//..../LibrePCB.git /opt/LibrePCB \ &amp;&amp; cd /opt/LibrePCB .... # build and install librepcb RUN /opt/LibrePCB/dev/docker/make_librepcb.sh ....</span></span></span></span></code> </pre> <br>  We will not compile and install the project when building the image.  Thus, we have assembled an image in which the author of the project guarantees the successful assembly of the project. <br><br>  After launching the container, the analyzer was installed and the following commands were executed for assembling and analyzing the project: <br><br><pre> <code class="cpp hljs">cd /opt/LibrePCB mkdir build &amp;&amp; cd build qmake -r ../librepcb.pro pvs-studio-analyzer trace -- make -j2 pvs-studio-analyzer analyze -l /mnt/Share/PVS-Studio.lic -r /opt/LibrePCB \ -o /opt/LibrePCB/LibrePCB.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> -v -j4 cp -R -L -a /opt/LibrePCB /mnt/Share</code> </pre> <br>  By the way, all actions were performed in Windows 10. I am very pleased that the developers of all popular operating systems are also developing in this direction.  Unfortunately, Windows containers are not so convenient.  Especially because of the inability to install software as well. <br><br><h2>  Bugs found </h2><br>  Now the classic section containing the description of the errors we found using the PVS-Studio static code analyzer.  By the way, using the case, I want to remind you that lately we have been developing the analyzer in the direction of supporting analysis of code for embedded systems.  Here are a couple of articles that some of our readers might have missed: <br><br><ol><li>  <a href="https://www.viva64.com/ru/b/0588/">GNU Arm Embedded Toolchain has been added to PVS-Studio</a> ; </li><li>  <a href="https://www.viva64.com/ru/b/0596/">PVS-Studio: support for MISRA C and MISRA C ++ coding standards</a> . </li></ol><br><h3>  Typos </h3><br><pre> <code class="cpp hljs">SymbolPreviewGraphicsItem::SymbolPreviewGraphicsItem( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> IF_GraphicsLayerProvider&amp; layerProvider, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QStringList&amp; localeOrder, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Symbol&amp; symbol, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Component* cmp, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tl::optional&lt;Uuid&gt;&amp; symbVarUuid, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tl::optional&lt;Uuid&gt;&amp; symbVarItemUuid) <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mComponent &amp;&amp; symbVarUuid &amp;&amp; symbVarItemUuid) .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mComponent &amp;&amp; symbVarItemUuid &amp;&amp; symbVarItemUuid) <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... }</span></span></code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v501/">warning</a> : <a href="https://www.viva64.com/ru/w/v501/">V501</a> CWE-571 There are identical sub-expressions of the operator.  symbolpreviewgraphicsitem.cpp 74 <br><br>  <a href="https://www.viva64.com/ru/examples/v501/">Classic</a> typo: twice the variable <i>symbVarItemUuid is checked</i> .  Above is a similar check, and, looking at it, it becomes clear that the second variable to be checked must be a <i>symbVarUuid</i> . <br><br>  The following is a typo code snippet: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Clipper::DoMaxima(TEdge *e) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e-&gt;OutIdx &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { AddOutPt(e, e-&gt;Top); e-&gt;OutIdx = Unassigned; } DeleteFromAEL(e); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (eMaxPair-&gt;OutIdx &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { AddOutPt(eMaxPair, e-&gt;Top); <span class="hljs-comment"><span class="hljs-comment">// &lt;= eMaxPair-&gt;OutIdx = Unassigned; } DeleteFromAEL(eMaxPair); .... }</span></span></code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v778/">warning</a> : <a href="https://www.viva64.com/ru/w/v778/">V778</a> CWE-682 Two code fragments were found.  Perhaps this is a typo and 'eMaxPair' variable should not be used instead of 'e'.  clipper.cpp 2999 <br><br>  Most likely, the code was written using Copy-Paste.  Due to an oversight in the second block of text, they forgot to replace <i>e-&gt; Top</i> with <i>eMaxPair-&gt; Top</i> . <br><br><h3>  Extra checks </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rndr_emphasis</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(hoedown_buffer *ob, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> hoedown_buffer *content, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> hoedown_renderer_data *data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!content || !content-&gt;size) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; HOEDOWN_BUFPUTSL(ob, <span class="hljs-string"><span class="hljs-string">"&lt;em&gt;"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (content) hoedown_buffer_put(ob, content-&gt;data, content-&gt;size); HOEDOWN_BUFPUTSL(ob, <span class="hljs-string"><span class="hljs-string">"&lt;/em&gt;"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v547/">warning</a> : <a href="https://www.viva64.com/ru/w/v547/">V547</a> CWE-571 Expression 'content' is always true.  html.c 162 <br><br>  This is probably not an error, but simply a redundant code.  No need to re-check the <i>content</i> pointer.  If it is zero, the function immediately terminates its work. <br><br>  Similar situation: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Clipper::DoMaxima(TEdge *e) { .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( e-&gt;OutIdx &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; eMaxPair-&gt;OutIdx &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e-&gt;OutIdx &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) AddLocalMaxPoly(e, eMaxPair, e-&gt;Top); DeleteFromAEL(e); DeleteFromAEL(eMaxPair); } .... }</code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v547/">warning</a> : <a href="https://www.viva64.com/ru/w/v547/">V547</a> CWE-571 Expression 'e-&gt; OutIdx&gt; = 0' is always true.  clipper.cpp 2983 <br><br>  <i>Rechecking (e-&gt; OutIdx&gt; = 0)</i> does not make sense.  However, this may be a mistake.  For example, it can be assumed that the variable <i>e-&gt; Top</i> should be checked.  However, this is only a guess.  We are not familiar with the project code and cannot distinguish errors from redundant code :). <br><br>  And one more case: <br><br><pre> <code class="cpp hljs">QString SExpression::toString(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> indent) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (child.isLineBreak() &amp;&amp; nextChildIsLineBreak) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (child.isLineBreak() &amp;&amp; (i &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) &amp;&amp; mChildren.at(i - <span class="hljs-number"><span class="hljs-number">1</span></span>).isLineBreak()) { <span class="hljs-comment"><span class="hljs-comment">// too many line breaks ;) } else { str += '\n'; } } .... }</span></span></code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v571/">warning</a> : <a href="https://www.viva64.com/ru/w/v571/">V571</a> CWE-571 Recurring check.  The 'child.isLineBreak ()' condition was already verified in line 208. sexpression.cpp 209 <br><br><h3>  Error in logic </h3><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> FootprintPreviewGraphicsItem::paint(....) <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Circle&amp; circle : mFootprint.getCircles()) { layer = mLayerProvider.getLayer(*circle.getLayerName()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!layer) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;= if (layer) { // &lt;= pen = QPen(....); painter-&gt;setPen(pen); } else painter-&gt;setPen(Qt::NoPen); .... } .... }</span></span></code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v547/">warning</a> : <a href="https://www.viva64.com/ru/w/v547/">V547</a> CWE-571 Expression 'layer' is always true.  footprintpreviewgraphicsitem.cpp 177 <br><br>  Since the condition in the second <i>if statement is</i> always true, the <i>else</i> branch is never executed. <br><br><h3>  Forgotten pointer check </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> ZEXPORT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unzGetGlobalComment</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( unzFile file, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * szComment, uLong uSizeBuf)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (uReadThis&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>) { *szComment=<span class="hljs-string"><span class="hljs-string">'\0'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ZREAD64(s-&gt;z_filefunc,s-&gt;filestream,szComment,uReadThis)!=uReadThis) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UNZ_ERRNO; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((szComment != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) &amp;&amp; (uSizeBuf &gt; s-&gt;gi.size_comment)) *(szComment+s-&gt;gi.size_comment)=<span class="hljs-string"><span class="hljs-string">'\0'</span></span>; .... }</code> </pre> <br>  PVS-Studio Warning: <a href="https://www.viva64.com/ru/w/v595/">V595</a> CWE-476: The 'szComment'  Check lines: 2068, 2073. unzip.c 2068 <br><br>  If <i>uReadThis&gt; 0</i> , then the <i>szComment</i> pointer is <i>dereferenced</i> .  This is dangerous, as this pointer may be null.  The analyzer makes this conclusion on the basis of the fact that this pointer is further checked for <i>NULL</i> equality. <br><br><h3>  Uninitialized class member </h3><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Edge</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> VertexType = Vector2&lt;T&gt;; Edge(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VertexType &amp;p1, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VertexType &amp;p2, T w=<span class="hljs-number"><span class="hljs-number">-1</span></span>) : p1(p1), p2(p2), weight(w) {}; <span class="hljs-comment"><span class="hljs-comment">// &lt;= Edge(const Edge &amp;e) : p1(e.p1), p2(e.p2), weight(e.weight), isBad(false) {}; Edge() : p1(0,0), p2(0,0), weight(0), isBad(false) {} VertexType p1; VertexType p2; T weight=0; bool isBad; };</span></span></code> </pre> <br>  PVS-Studio Warning: <a href="https://www.viva64.com/ru/w/v730/">V730</a> CWE-457 <a href="https://www.viva64.com/ru/w/v730/">Notice</a> .  Consider inspecting: isBad.  edge.h 14 <br><br>  All constructors except the first initialize the <i>isBad</i> class <i>field</i> .  Most likely, in the first constructor, they simply accidentally forgot to do this initialization.  As a result, the first constructor creates an incompletely initialized object, which can lead to undefined program behavior. <br><br>  There are 11 more <a href="https://www.viva64.com/ru/w/v730/">V730</a> diagnostic <a href="https://www.viva64.com/ru/w/v730/">triggers</a> .  However, since we are not familiar with the code, it is difficult to say whether these warnings indicate real problems.  I think these warnings are best studied by the authors of the project. <br><br><h3>  Memory leak </h3><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ElementType&gt; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ProjectLibrary::loadElements(....) { .... ElementType* element = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ElementType(elementDir, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-comment"><span class="hljs-comment">// can throw if (elementList.contains(element-&gt;getUuid())) { throw RuntimeError( __FILE__, __LINE__, QString(tr("There are multiple library elements with the same " "UUID in the directory \"%1\"")) .arg(subdirPath.toNative())); } .... }</span></span></code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v773/">warning</a> : <a href="https://www.viva64.com/ru/w/v773/">V773</a> CWE-401  A memory leak is possible.  projectlibrary.cpp 245 <br><br>  If a certain element is already present in the list, an exception will be generated.  But it does not destroy the previously created object, the pointer to which is stored in the variable <i>element</i> . <br><br><h3>  Wrong type of exception </h3><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CmdRemoveSelectedSchematicItems::performExecute() { .... <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LogicError(__FILE__, __LINE__); .... }</code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v1022/">warning</a> : <a href="https://www.viva64.com/ru/w/v1022/">V1022</a> CWE-755 An exception was thrown by pointer.  Consider throwing it by value instead.  cmdremoveselectedschematicitems.cpp 143 <br><br>  The analyzer detected an exception thrown by the pointer.  Most often, it is customary to throw exceptions by value, and to intercept by reference.  Throwing a pointer can lead to the fact that the exception will not be caught, since it will intercept it by reference.  Also, the use of a pointer forces the intercepting side to call the <i>delete</i> operator to destroy the created object so that memory leaks do not occur. <br><br>  In general, the operator <i>new is</i> written here by chance and should be removed.  The fact that this is a mistake is confirmed by the fact that in all other places it is written: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> LogicError(__FILE__, __LINE__);</code> </pre> <br><h3>  Dangerous use of dynamic_cast </h3><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> GraphicsView::handleMouseWheelEvent( QGraphicsSceneWheelEvent* event) <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event-&gt;modifiers().testFlag(Qt::ShiftModifier)) .... } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> GraphicsView::eventFilter(QObject* obj, QEvent* event) { .... handleMouseWheelEvent(<span class="hljs-keyword"><span class="hljs-keyword">dynamic_cast</span></span>&lt;QGraphicsSceneWheelEvent*&gt;(event)); .... }</code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v522/">warning</a> : <a href="https://www.viva64.com/ru/w/v522/">V522</a> CWE-628 Dereferencing of the null pointer 'event' might take place.  The potential null pointer is passed into the 'handleMouseWheelEvent' function.  Inspect the first argument.  Check lines: 143, 252. graphicsview.cpp 143 <br><br>  The pointer, which is the result of the <i>dynamic_cast</i> operator, is passed to the <i>handleMouseWheelEvent</i> function.  In it, this pointer is dereferenced without prior verification. <br><br>  This is dangerous because the <i>dynamic_cast statement</i> can return <i>nullptr</i> .  It turns out that this code is no better than just using the faster <i>static_cast</i> . <br><br>  In this code, you should add an explicit pointer check before use. <br><br>  Also, the following code is very common: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> GraphicsView::eventFilter(QObject* obj, QEvent* event) { .... QGraphicsSceneMouseEvent* e = <span class="hljs-keyword"><span class="hljs-keyword">dynamic_cast</span></span>&lt;QGraphicsSceneMouseEvent*&gt;(event); Q_ASSERT(e); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e-&gt;button() == Qt::MiddleButton) .... }</code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v522/">warning</a> : <a href="https://www.viva64.com/ru/w/v522/">V522</a> CWE-690 There might be a pointer of a potential null pointer 'e'.  graphicsview.cpp 206 <br><br>  The pointer is checked using the <i>Q_ASSERT</i> macro.  Here is its description: <br><table><tbody><tr><td>  If the test is false. <br><br>  Q_ASSERT () is useful for pre-and post-conditions during development.  It doesn‚Äôt if QT_NO_DEBUG was defined during compilation. <br></td></tr></tbody></table><br>  <i>Q_ASSERT is a</i> bad way to check pointers before use.  As a rule, the release version of <i>QT_NO_DEBUG is</i> not defined.  I do not know what the situation is with the LibrePCB project.  However, if <i>QT_NO_DEBUG is</i> defined in Release, then this is a strange and non-standard solution. <br><br>  If a macro expands into emptiness, it turns out that there is no verification.  And then it is not clear why it was generally used <i>dynamic_cast</i> .  Why then not use <i>static_cast</i> ? <br><br>  In general, this code is with a smell and it is worth reviewing all similar code fragments.  And, by the way, there are a lot of them.  <b>I counted 82 similar cases!</b> <br><br><h2>  Conclusion </h2><br>  In general, the LibrePCB project seemed to be of high quality.  Nevertheless, we recommend the project authors to arm themselves with the PVS-Studio tool and independently conduct a Code Review of the code sections indicated by the analyzer.  We are ready to provide them with a free license for a month to fully analyze the project.  Moreover, they can use the free licensing option of the analyzer, since the project code is open and posted on the GitHub website.  We will write about this licensing option soon. <br><br><p> <a href="https://www.viva64.com/en/b/0598/"><img src="https://habrastorage.org/webt/ts/z9/km/tsz9kmyjtteajhd4x1au60rsrvq.png" align="left"></a> </p><br><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Andrey Karpov, Svyatoslav Razmyslov.  <a href="https://www.viva64.com/en/b/0598/">Checking LibrePCB with PVS-Studio Inside a Docker Container</a> . </div><p>Source: <a href="https://habr.com/ru/post/433562/">https://habr.com/ru/post/433562/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../433550/index.html">Slack Messenger - reasons for choice, jambs in the implementation and features of the service that make life easier</a></li>
<li><a href="../433552/index.html">EOS Blockchain Vulnerabilities on ZeroNights 2018</a></li>
<li><a href="../433554/index.html">We correct typographical errors in search queries.</a></li>
<li><a href="../433556/index.html">The Economist: As private investment companies, 0.001% of the richest people in the world are changing the global finance industry</a></li>
<li><a href="../433558/index.html">TeamCity 2018.2: support for GitHub Pull Requests, secondary server, installation of plug-ins from the repository, screenshots in tests</a></li>
<li><a href="../433564/index.html">Predictive web interface behavior</a></li>
<li><a href="../433566/index.html">We study Adversarial Tactics, Techniques & Common Knowledge (ATT @ CK). Enterprise Tactics. Part 6</a></li>
<li><a href="../433568/index.html">As in America, fighting thieves parcels</a></li>
<li><a href="../433570/index.html">The secret of the ritual ‚Äúwarming up‚Äù or why ‚Äúwarm‚Äù headphones sound ‚Äúbetter‚Äù</a></li>
<li><a href="../433572/index.html">Introduction to Testing in Python. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>