<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Play head</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Experience of declarative programming in JavaScript on the example of an audio player 

 Author - Rostislav Chebykin. 
 Layout and placement on Habr -...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Play head</h1><div class="post__text post__text-html js-mediator-article">  <i>Experience of declarative programming in JavaScript on the example of an audio player</i> <br><br>  Author - Rostislav Chebykin. <br>  Layout and placement on Habr - <a href="https://habrahabr.ru/users/den_lesnov/" class="user_link">den_lesnov</a> . <br><br><blockquote>  I feel something so wrong <br>  By doing the right thing ... <br>  Ryan Tedder (OneRepublic).  Counting stars <br></blockquote>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Denis Lesnov and I developed an audio player for <a href="http://rostislav.chebykin.ru/">my site</a> .  The site contains audio recordings of songs, and I have long dreamed of making them play directly from web pages. <br><br>  The player looks like this: <br><br><img src="https://habrastorage.org/files/b0d/01c/54d/b0d01c54d3a7493b8d131ef2a1485ed5.png"><br><br>  How it works - you can see on the <a href="http://rostislav.chebykin.ru/player/">demo page</a> . <br><br>  The first question we are asked is: why did we townline our own player from scratch, and not use any of the hundreds of ready-made solutions?  The answer is simple: because we were interested in this task. <br><br>  In this project there were no customers, bosses, financial motivation and certain deadlines.  We met about once a week at one of us at home and programmed for our own pleasure.  The first valid version of the player was ready in two evenings and uploaded to the site, and then for about a year we brought the code into a divine form. <br><br>  Here we will talk about the main technical solutions that we used. <br><br><a name="habracut"></a><br><br><h5>  Technical Kosher </h5><br><br>  <i>- Wow, we just started yesterday, and we already have a legacy code ...</i> <br><br>  The player works on modern client technologies (HTML5 Audio object), without Flash and other antiques.  However, users of old browsers do not suffer: for them, the player behaves as a direct link to the MP3 file.  This is achieved without checking for specific models and versions of browsers, but only through feature detection. <br><br>  We did not use jQuery and other libraries, all code is written in pure JavaScript.  This is also because it is so interesting. <br><br>  In JavaScript, we followed the ‚Äúminimum imperative, maximum declarative‚Äù approach, and also tried to avoid duplication of code, ‚Äúomnipotent‚Äù functions, multi-storey conditions and cycles, and other code smells. <br><br>  The player is "rubber" horizontally: it automatically stretches across the width of the container, even if this width changes during sound. <br><br><h5>  HTML: less is more </h5><br><br>  <i>can not moses people</i> <i><br></i>  <i>read the tables</i> <i><br></i>  <i>they probably encoded</i> <i><br></i>  <i>koi</i> <br><br>  The HTML code associated with the player, in its initial state, is the usual direct hyperlink to the audio file: <br><br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/path/file.mp3"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">target</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_blank"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"player"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ready"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  This is convenient if you do not want to start the music, but save the file to disk, open it with another application, copy the link and so on. <br><br>  If you click on the link, JavaScript will check if the environment is ready to play the file.  If not ready - the link works in the usual way.  The same thing happens if javascript doesn't start at all. <br><br>  Finally, if playback is available, the content of the link becomes: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">target</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_blank"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"player"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">track</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">track</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">playhead</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">draggable</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">playhead</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  In the active state of the player, the HTML code consists of only three elements: exactly one for each component of the interface with which you can interact: <br><ul><li>  a still represents the entire player.  User can start or stop sound playback by clicking on the icon. <img src="https://habrastorage.org/files/b0a/aa5/95c/b0aaa595c4884678b68e0da31fbee852.png">  / <img src="https://habrastorage.org/files/ac7/e45/af8/ac7e45af8aad45ec8bd7c1da88d4a339.png">  .  (There is no separate HTML element for the icon; it also refers to a.) </li><li>  track - sound track.  You can click on it to rewind playback to a specific place. </li><li>  The playhead is a ‚Äúpickup head‚Äù.  It shows the current playback position and can be dragged. </li></ul><br><br><h5>  Design without haste </h5><br><br>  <i>- Here we need to mimic the code ...</i> <i><br></i>  <i>- It‚Äôs good that you don‚Äôt get it!</i> <br><br>  The design was based on a model representing the player as a set of core functions that were independent of the implementation.  In order to identify the most universal model, we wondered what would have happened if the system were not a web interface, but consisted of concrete blocks or in general represented a live minstrel with a lute. <br><br>  At this stage, we fixed, for example, that starting and stopping music are the fundamental capabilities of the player, and ‚Äúchanging the value of left for the head‚Äù is the implementation details.  This helped not to mix abstractions of different levels in the code. <br><br>  Refining the model, we drew a lot of charts and tables and accidentally came up with the original version of ER-modeling, which I will tell about another time. <br><br>  We are sensitive to the names of variables, CSS classes and other entities.  We could spend an hour or two on the selection of a successful name, for which then will not be ashamed.  For example, at first we called the slider either slider or indicator until we found out that in English there is an old playhead term that means exactly what you need.  We were so happy that we began to use the comic translation "Play-head" as the unofficial name of the entire project. <br><br><h5>  CSS: geometry without images </h5><br><br>  <i>- It looks native, and look disgusting ...</i> <br><br>  We did not use pictures;  All player geometry is drawn using CSS.  For example, here's an icon <img src="https://habrastorage.org/files/b0a/aa5/95c/b0aaa595c4884678b68e0da31fbee852.png">  : <br><br><pre> <code class="css hljs"><span class="hljs-selector-id"><span class="hljs-selector-id">#player</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::before</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">content</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">float</span></span>: left; <span class="hljs-attribute"><span class="hljs-attribute">margin-right</span></span>: <span class="hljs-number"><span class="hljs-number">6px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">1px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border-top</span></span>: <span class="hljs-number"><span class="hljs-number">5px</span></span> solid transparent; <span class="hljs-attribute"><span class="hljs-attribute">border-bottom</span></span>: <span class="hljs-number"><span class="hljs-number">5px</span></span> solid transparent; <span class="hljs-attribute"><span class="hljs-attribute">border-left</span></span>: <span class="hljs-number"><span class="hljs-number">10px</span></span> solid <span class="hljs-number"><span class="hljs-number">#999</span></span>; }</code> </pre><br><br>  Actually, the icon <img src="https://habrastorage.org/files/b0a/aa5/95c/b0aaa595c4884678b68e0da31fbee852.png">  / <img src="https://habrastorage.org/files/ac7/e45/af8/ac7e45af8aad45ec8bd7c1da88d4a339.png">  implemented as pseudo element :: before element a.  This simplified JavaScript: to start and stop the music, click <i>on the player itself</i> , rather than on a special element, is processed. <br><br>  Similarly, to depict the filling of the buffer, we did not introduce a separate element, but used the linear-gradient function as background-image for the track.  In the initial state, the buffer is empty, and the track is filled with white: <br><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">track</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">background-image</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">linear-gradient</span></span>(to right, #ddd 0%, #fff 0%); }</code> </pre><br><br>  The percentage value after #ddd is incremented in accordance with the buffer fullness, and part of the track becomes gray.  When the buffer is full, the entire track is grayed out. <br><br><h5>  System states </h5><br><br>  <i>- This is not a crutch, but an adapter!</i> <br><br>  We decided that at each moment of time the system can be in one of three states: <br><ul><li>  READY - the original state; </li><li>  SET - after the system has made sure that the player is ready to play; </li><li>  GO - operational status after the user has activated the player. </li></ul><br><br>  Distinguishing between states is important for the system to react differently to the same events.  For example, clicking the player in the SET state causes it to expand its entire infrastructure, and in the GO state, it causes it to start or stop the music. <br><br>  States helped build the code more declaratively.  In the first version of the program it was impossible to breathe from addEventListener / removeEventListener strung together, but to the final version this one went completely to the side. <br><br>  The stateCtrl special object helps to monitor the states.  For example, stateCtrl.is ('SET') returns true if and only if the system is in the SET state. <br><br><h5>  All behavior in one place </h5><br><br>  <i>- What do you think about unit tests?</i> <i><br></i>  <i>- You know, Kozma Prutkov on this occasion was an aphorism ... only I forgot what.</i>  <i>That's all I think about unit tests.</i> <br><br>  Perhaps from this place the most enthusiastic begins.  All system behavior is described by one structure, which I will show in its entirety: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> behavior = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Behavior({ <span class="hljs-attr"><span class="hljs-attr">window</span></span>: { <span class="hljs-attr"><span class="hljs-attr">DOMContentLoaded</span></span>: { <span class="hljs-attr"><span class="hljs-attr">READY</span></span>: <span class="hljs-string"><span class="hljs-string">'player.set'</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">html</span></span>: { <span class="hljs-attr"><span class="hljs-attr">dragover</span></span>: <span class="hljs-string"><span class="hljs-string">'playhead.pull'</span></span>, <span class="hljs-attr"><span class="hljs-attr">drop</span></span>: [<span class="hljs-string"><span class="hljs-string">'audio.land'</span></span>, <span class="hljs-string"><span class="hljs-string">'stateCtrl.toggle'</span></span>] }, <span class="hljs-attr"><span class="hljs-attr">audio</span></span>: { <span class="hljs-attr"><span class="hljs-attr">timeupdate</span></span>: { <span class="hljs-attr"><span class="hljs-attr">NO_DRAG</span></span>: [<span class="hljs-string"><span class="hljs-string">'playhead.move'</span></span>, <span class="hljs-string"><span class="hljs-string">'track.augment'</span></span>] }, <span class="hljs-attr"><span class="hljs-attr">progress</span></span>: <span class="hljs-string"><span class="hljs-string">'track.augment'</span></span>, <span class="hljs-attr"><span class="hljs-attr">ended</span></span>: [<span class="hljs-string"><span class="hljs-string">'audio.pause'</span></span>, <span class="hljs-string"><span class="hljs-string">'player.toggle'</span></span>] <span class="hljs-comment"><span class="hljs-comment">// 1 }, player: { click: { SET: ['audio.start', 'player.go', 'stateCtrl.nextActivityState'], GO: 'audio.toggle' // 2 } }, playhead: { dragstart: 'playhead.drag' }, track: { click: 'audio.rewind' } });</span></span></code> </pre><br><br>  Here we describe what events we expect at what facility and in what state and what to do in response to each event.  For example, line 1 means that when the ended event occurs on the audio object (in any state), the functions audio.pause and player.toggle are called.  Line 2 means that the click event on the player object (this is the player itself is element a in HTML), if the system is in the GO state, the audio.toggle function is called. <br><br>  In fact, the rest of the code is dedicated to ‚Äúbreathing life‚Äù into this purely declarative description and make it work. <br><br><h5>  The same and preventDefault </h5><br><br>  <i>‚ÄúWell, two handlers started dragging the playhead and tore it up ...‚Äù</i> <br><br>  In response to some events, it is necessary not only to perform certain actions, but also to prevent the default reaction (for example, following a link).  We decided not to mix it with the behavior described earlier, because this does not apply to the player‚Äôs ‚Äúbusiness logic‚Äù, but to the features of event handling in the browser. <br><br>  A separate structure describes where to hang the preventDefault: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> modifiers = { <span class="hljs-attr"><span class="hljs-attr">preventDefault</span></span>: [<span class="hljs-string"><span class="hljs-string">'html'</span></span>, <span class="hljs-string"><span class="hljs-string">'track'</span></span>, <span class="hljs-string"><span class="hljs-string">'html.dragenter'</span></span>, <span class="hljs-string"><span class="hljs-string">'player.click.SET'</span></span>] };</code> </pre><br><br>  This means that preventDefault will be added to the handlers: <br><ul><li>  all events of the html and track objects (listed in the behavior), </li><li>  the html dragenter event (this event is not in the behavior), </li><li>  the click event of the player object only if the system is in the SET state. </li></ul><br><br><h5>  The whole implementation is also in one place. </h5><br><br>  <i>- Say a rhyme to the word eval!</i> <i><br></i>  <i>- setInterval ... Oh, no, this is a bad rhyme ... That is, a rhyme is good, the idea is bad.</i> <br><br>  The implementation of all functions is also described in a separate structure, built according to this scheme: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> impl = { <span class="hljs-attr"><span class="hljs-attr">Number</span></span>: { <span class="hljs-attr"><span class="hljs-attr">toPercentString</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* ‚Ä¶ */</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">Array</span></span>: { <span class="hljs-attr"><span class="hljs-attr">modify</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">handler</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* ‚Ä¶ */</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">String</span></span>: { <span class="hljs-attr"><span class="hljs-attr">createListeners</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">behavior</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* ‚Ä¶ */</span></span> }, <span class="hljs-attr"><span class="hljs-attr">getObject</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* ‚Ä¶ */</span></span> }, <span class="hljs-attr"><span class="hljs-attr">modify</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">handler</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* ‚Ä¶ */</span></span> }, }, <span class="hljs-attr"><span class="hljs-attr">HTMLElement</span></span>: { <span class="hljs-attr"><span class="hljs-attr">move</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* ‚Ä¶ */</span></span> }, <span class="hljs-comment"><span class="hljs-comment">// ‚Ä¶  . . ‚Ä¶ }, // ‚Ä¶  . . ‚Ä¶ };</span></span></code> </pre><br><br>  The keys of this structure are the names of "classes" (more precisely, prototypes), and the values ‚Äã‚Äãare a list of functions that will be called from instances of these "classes".  For example, the move function is called from a playhead object whose prototype is an HTMLElement. <br><br>  In the current system, functions are attached directly to the corresponding prototypes, which spoils the code kosher.  Further we will adjust more accurate inheritance. <br><br>  A separate feature: if the name of a function in impl starts with get, then it is attached as a full-fledged getter.  For example, the function getObject turns into a property that can be called as a string.object. <br><br><h5>  How things are going </h5><br><br>  <i>- The plan is this: first we write the unclean function, then we make it clean.</i>  <i>Laundering features!</i> <br><br>  When the script is launched, special black magic is triggered, which digests all this declarativeness and eventually makes the music sound: <br><ul><li>  A separate cycle goes through the list of implementations of impl and stuffs each function into the corresponding prototype.  This is done using a specially written method addProperties, which, in turn, is based on the standard Object.defineProperties: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> typeName <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> impl) { <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>[typeName].addProperties(impl[typeName]); }</code> </pre></li><li>  Another specially written modify method modifies the behavior object (in which the ‚Äúbusiness logic‚Äù is stored), adding to it preventDefault'y from the modifiers object: <br><pre> <code class="javascript hljs">behavior.modify(modifiers);</code> </pre></li><li>  Finally, the third special createListeners method is applied to the window, which hangs on the window event handlers described in the modified behavior: <br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">'window'</span></span>.createListeners(behavior);</code> </pre></li></ul><br><br>  From this, DOMContentLoaded immediately fires on the window, and everything takes off.  The rest of the handlers are hung inside individual functions at the right moments.  For example, handlers for the html, player and audio objects are created inside the set function, which starts after the page loads, and the handlers for track and playhead are inside the go function, which starts after the player is activated: <br><br><pre> <code class="javascript hljs">[<span class="hljs-string"><span class="hljs-string">'playhead'</span></span>, <span class="hljs-string"><span class="hljs-string">'track'</span></span>].createListeners(behavior);</code> </pre><br><br>  As a result, the word "addEventListener" is mentioned exactly once in all the code. <br><br><h5>  More about black magic </h5><br><br>  <i>- We need to go thiser ...</i> <br><br>  I mentioned black magic, because attempts to program in JavaScript in a declarative style inevitably lead to mystical spells in the code.  For example, the createListeners method recursively circumvents the insides of behavior using the polymorphic walk method, which is defined like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> typeName <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> walkers) { <span class="hljs-comment"><span class="hljs-comment">// Object, Array, String window[typeName].addProperties({ walk: functools.partialLeft( function(name, params) { walkers[name].call(this, params); }, typeName ) }); }</span></span></code> </pre><br><br>  Here we pulled a piece of Python by the ears: in order for this code to work, we conjured partialLeft and put it in the ‚Äúmodule‚Äù of functools. <br><br>  In turn, partialLeft uses the auxiliary function array, which turns everything into an array.  What is not black magic? <br><br><h5>  Moral of this fable </h5><br><br>  <i>- Do you again refactor non-existent code?</i> <br><br>  As you have noticed, there is almost nothing in this narration about working with the Audio object and about other specific features of media players.  This is because in this area we just did not produce anything stunning.  Our player makes a sound about the same as hundreds of other analogs. <br><br>  But the declarative architecture, in the center of which lies the object of behavior with all the behavior of the system, seems to us promising for use not only in this player, but also in other projects.  Perhaps, in time, a library will grow out of this, which will disgrace and supplant all others. <br><br>  In the meantime, Denis and I continue to polish the existing code and are going to add playlists to it so that you can listen to entire albums on the site. </div><p>Source: <a href="https://habr.com/ru/post/256329/">https://habr.com/ru/post/256329/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256317/index.html">Machine Learning - 4: Moving Average</a></li>
<li><a href="../256319/index.html">Miracle Yudo Yukit fish or the 128th website builder</a></li>
<li><a href="../256321/index.html">Geolocation without GPS (part 1)</a></li>
<li><a href="../256323/index.html">Average Freelancer Rates - Payoneer Survey Results</a></li>
<li><a href="../256325/index.html">Intensity, scroll indicator (or life after scrollbar)</a></li>
<li><a href="../256331/index.html">Temporal relativistic ontological space</a></li>
<li><a href="../256333/index.html">The program of practical training in the field of information security: "Zero Security: A"</a></li>
<li><a href="../256337/index.html">Services on the conveyor. How is the information infrastructure of WebCanape?</a></li>
<li><a href="../256339/index.html">Doing yourself to open it up, or the Right to pre-edit</a></li>
<li><a href="../256345/index.html">Control robots created with LEGO¬Æ Mindstorms¬Æ NXT Brick using the Wolfram Language (Mathematica)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>