<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DSL to JavaScript for C ++ or code generator - it's easy!</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good Monday, habrovchane! 

 It was picked just now with one universal, and therefore to an indecent powerful, data access interface on Python. Indece...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DSL to JavaScript for C ++ or code generator - it's easy!</h1><div class="post__text post__text-html js-mediator-article">  Good Monday, habrovchane! <br><br>  It was picked just now with one universal, and therefore to an indecent powerful, data access interface on Python.  Indecent power is expressed as a set of parameters for all occasions, often extremely extravagant and necessary only in 5% of cases.  As a result, you have to duplicate the whole pack of parameters and details, even in straight-line queries, which causes pessimism and a desire to do something else.  And then I remembered a similar story from my distant past, which I share. <br><img src="https://habrastorage.org/getpro/habr/post_images/552/d72/9bc/552d729bcf6ff980768266aecec53f6a.jpg"><br><a name="habracut"></a><br><h1>  Problem </h1><br>  It was a long time ago <strike>and not true</strike> , so long that it can be safely attributed to the category of memoirs.  They sent us to help the department engaged in outsourcing.  The project was already at the stage of active coding, and it was too late to discuss and change something (or maybe it was impossible initially).  It was necessary to make the business-level interface to the data stored in 20 tablets.  In C ++.  Under Windows and Linux.  20 plates in Postgres or Orakle.  The ‚Äúbusiness-level interface‚Äù is such a euphemism for the dumbest set of operations on entities from these tables, namely, by choosing a key or value of other fields, creating, modifying, or choosing connected entities. <br>  By that time, I was already beginning to guess that our work is sometimes not very interesting, but so much so!  This task by its despondency broke all records.  Overnight, I felt in the shoes of those people who are not interested in their work, and for some reason, this didn‚Äôt inspire me at all.  Against this background, my colleagues were not so bad - they just went through a bunch of C ++ (C) or simplifying access to the database and made sure that none of them, contrary to statements, normally work simultaneously with Oraklom and Postgres. <br><br><h1>  Idea </h1><br>  The conviction that this stupid work should be done by anyone, but not only me, slowly pushed me to the idea that it was necessary to dump it on someone's thread.  From my environment, only a computer agreed to accept such a fate, so that, as a result, he had the honor of generating the necessary code.  Strained in this whole undertaking only that at that time about the subject I had a very vague idea as something very complex and non-trivial.  From the incubation period, the idea of ‚Äã‚Äãgeneration brought a random memory of the debugging of one web application with JSP, bins and other horror flying on the wings of the night.  Debuger showed me the code that is generated from the JSP (java server pages) pages.  For example from such a page: <br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span><span class="hljs-tag"> (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span><span class="hljs-tag"> &lt; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">10</span></span></span><span class="hljs-tag">; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span><span class="hljs-tag">++) { %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> } %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  It turns out the following code <br><pre> <code class="java hljs">out.println(<span class="hljs-string"><span class="hljs-string">"&lt;ul&gt;"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { out.print(<span class="hljs-string"><span class="hljs-string">"&lt;li&gt;"</span></span>); out.print(i); out.println(); } out.println(<span class="hljs-string"><span class="hljs-string">"&lt;/ul&gt;"</span></span>);</code> </pre><br>  That is, the generation algorithm from JSP code which, in turn, generates HTML is very simple, approximately: everything inside &lt;%%&gt; becomes the code, and everything outside is wrapped in out.print ("&lt;text&gt;"), Well, a little syntactic sugar.  In our case, you just need to replace HTML with C ++, but with something else and, after the simplest transformations, we get the code that generates the desired C ++ code.  ‚ÄúSomething else‚Äù I chose according to the principle of least resistance - the windows scripting host was already on our build machine, respectively, we use the java script (or ECMAScript, as it is there). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  Prototype </h1><br>  In this article we will consider the most ‚Äúclose to the text‚Äù solution.  The original solution, unfortunately, cannot be considered - too many important details have already been erased from memory.  We assume that we only have Postgres database, in order not to leave the cozy linuh windows scripting host, we will not use the windows scripting host either, as the data we will use some kind of thread with a simple layout from Employee, Department, etc. <br>  As a standalone JS implementation, let's take the first one that came to mind - rhino (for some reason, the v8 was the second).  So, we put rhino, we create the codegen.js file, we write print (2 * 2) there;  rhino codegen.js: 4, voila! <br><div class="spoiler">  <b class="spoiler_title">codegen.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>.length &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { print(<span class="hljs-string"><span class="hljs-string">"Usage: codegen.js &lt;template&gt;"</span></span>); quit(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">produce_text</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">text</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"__codegen_output += '"</span></span> + text.replace(<span class="hljs-string"><span class="hljs-string">"'"</span></span>, <span class="hljs-string"><span class="hljs-string">"\\'"</span></span>, <span class="hljs-string"><span class="hljs-string">'g'</span></span>).replace(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>, <span class="hljs-string"><span class="hljs-string">'\\n'</span></span>, <span class="hljs-string"><span class="hljs-string">'g'</span></span>).replace(<span class="hljs-string"><span class="hljs-string">'\r'</span></span>, <span class="hljs-string"><span class="hljs-string">'\\r'</span></span>, <span class="hljs-string"><span class="hljs-string">'g'</span></span>).replace(<span class="hljs-string"><span class="hljs-string">'\t'</span></span>, <span class="hljs-string"><span class="hljs-string">'\\t'</span></span>, <span class="hljs-string"><span class="hljs-string">'g'</span></span>) + <span class="hljs-string"><span class="hljs-string">"';\n"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">produce_code</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">code</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (code[<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-string"><span class="hljs-string">'='</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'__codegen_output += '</span></span> + code.substr(<span class="hljs-number"><span class="hljs-number">1</span></span>) + <span class="hljs-string"><span class="hljs-string">';\n'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> code + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>; } remainder = readFile(<span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> code = <span class="hljs-string"><span class="hljs-string">'var __codegen_output = ""; '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (remainder.length) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> begin = remainder.indexOf(<span class="hljs-string"><span class="hljs-string">'&lt;%'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (begin &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { code += produce_text(remainder.substr(<span class="hljs-number"><span class="hljs-number">0</span></span>, begin)); remainder = remainder.substr(begin + <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> end = remainder.indexOf(<span class="hljs-string"><span class="hljs-string">'%&gt;'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (end &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { code += produce_code(remainder.substr(<span class="hljs-number"><span class="hljs-number">0</span></span>, end)); remainder = remainder.substr(end + <span class="hljs-number"><span class="hljs-number">2</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { code += produce_code(remainder); remainder = <span class="hljs-string"><span class="hljs-string">''</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { code += produce_text(remainder); remainder = <span class="hljs-string"><span class="hljs-string">''</span></span>; } } code += <span class="hljs-string"><span class="hljs-string">'print(__codegen_output);'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(code);</code> </pre><br></div></div>  - the dumbest, straightforward implementation of the algorithm described just above - 50 lines - the entire code generator.  Testing: <br>  template file: <br><pre> <code class="hljs mel">&lt;% var className = <span class="hljs-string"><span class="hljs-string">'MyClass'</span></span>; var fields = [<span class="hljs-string"><span class="hljs-string">'Name'</span></span>, <span class="hljs-string"><span class="hljs-string">'Description'</span></span>, <span class="hljs-string"><span class="hljs-string">'AnotherOne'</span></span>, <span class="hljs-string"><span class="hljs-string">'LastOne'</span></span>]; %&gt; class &lt;%= className %&gt; { private: &lt;% <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; fields.length; i++) { %&gt; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> &lt;%= fields[i] %&gt;; &lt;% } %&gt; };</code> </pre><br><br><pre>  rhino codegen.js template: </pre><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyClass</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Name; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Description; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> AnotherOne; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> LastOne; };</code> </pre><br>  In &lt;%%&gt; we have any js code, &lt;% = expr%&gt; is replaced by the result of the expr calculation.  In principle, this is all we need, it is enough to generate anything at all.  Unfortunately, it is worth noting that this simplicity also has a downside - the code in the template is very dense and it is difficult to read it without a suitable syntax highlighting.  Not the last violin in this is played by JS himself - he is no different to laconic and expressive <br>  Now time to try to generate something more useful. <br>  template file: <br><pre> <code class="javascript hljs">&lt;% <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> model = [ { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Employee'</span></span>, <span class="hljs-attr"><span class="hljs-attr">fields</span></span>: { <span class="hljs-attr"><span class="hljs-attr">Id</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span> }, <span class="hljs-attr"><span class="hljs-attr">Name</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'string'</span></span> } } } ]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cppTypeMap = { <span class="hljs-string"><span class="hljs-string">'int'</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-string"><span class="hljs-string">'string'</span></span>: <span class="hljs-string"><span class="hljs-string">'std::string'</span></span> }; %&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">model.length</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">++) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">model[i];%</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> struct </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.name</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> { </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">in</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.fields</span></span></span></span><span class="xml"><span class="hljs-tag">) { %&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cppTypeMap</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.fields</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span></span><span class="xml"><span class="hljs-tag">]</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">.type</span></span></span></span><span class="xml"><span class="hljs-tag">] %&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml">; </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> } %&gt;</span></span></span><span class="xml"> }; </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> } %&gt;</span></span></span></span></code> </pre><br><br><pre>  rhino codegen.js template: </pre><br><pre> <code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Employee</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> Name; };</code> </pre><br>  The content of the model variable is, in fact, the so-called DSL (domain specific language).  In our case, it is a language for describing entities of the subject area.  The current version of it is too primitive to be at least somehow useful, so let's add it with all the necessary. <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> model = [ { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Department'</span></span>, <span class="hljs-attr"><span class="hljs-attr">fields</span></span>: { <span class="hljs-attr"><span class="hljs-attr">Id</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span> }, <span class="hljs-attr"><span class="hljs-attr">Name</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'string'</span></span>} }, <span class="hljs-attr"><span class="hljs-attr">primaryKey</span></span>: <span class="hljs-string"><span class="hljs-string">'Id'</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Employee'</span></span>, <span class="hljs-attr"><span class="hljs-attr">fields</span></span>: { <span class="hljs-attr"><span class="hljs-attr">Id</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span> }, <span class="hljs-attr"><span class="hljs-attr">Name</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'string'</span></span> }, <span class="hljs-attr"><span class="hljs-attr">DepartmentId</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-attr"><span class="hljs-attr">references</span></span>: <span class="hljs-string"><span class="hljs-string">'Department'</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">primaryKey</span></span>: <span class="hljs-string"><span class="hljs-string">'Id'</span></span> } ];</code> </pre><br><br><h1>  Decision </h1><br>  Now we are able to generate the code for receiving entities from the database by key, by connected entities, etc.  You can also generate a sql script to create a database.  In order to generate different sources from one model, we will scatter the code a bit: <div class="spoiler">  <b class="spoiler_title">model</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> model = [ { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Department'</span></span>, <span class="hljs-attr"><span class="hljs-attr">fields</span></span>: { <span class="hljs-attr"><span class="hljs-attr">Id</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span> }, <span class="hljs-attr"><span class="hljs-attr">Name</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'string'</span></span>} }, <span class="hljs-attr"><span class="hljs-attr">primaryKey</span></span>: <span class="hljs-string"><span class="hljs-string">'Id'</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Employee'</span></span>, <span class="hljs-attr"><span class="hljs-attr">fields</span></span>: { <span class="hljs-attr"><span class="hljs-attr">Id</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span> }, <span class="hljs-attr"><span class="hljs-attr">Name</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'string'</span></span> }, <span class="hljs-attr"><span class="hljs-attr">DepartmentId</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-attr"><span class="hljs-attr">references</span></span>: <span class="hljs-string"><span class="hljs-string">'Department'</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">primaryKey</span></span>: <span class="hljs-string"><span class="hljs-string">'Id'</span></span> } ];</code> </pre><br></div></div>  will only contain our DSL, <div class="spoiler">  <b class="spoiler_title">cpp.template</b> <div class="spoiler_text"><pre> <code class="javascript hljs">&lt;% load(<span class="hljs-string"><span class="hljs-string">'model'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cppTypeMap = { <span class="hljs-string"><span class="hljs-string">'int'</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-string"><span class="hljs-string">'string'</span></span>: <span class="hljs-string"><span class="hljs-string">'std::string'</span></span> }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fieldType</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">entity, field</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cppTypeMap[entity.fields[field].type]; } %&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">model.length</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">++) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">model[i];%</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> struct </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.name</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> { </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">in</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.fields</span></span></span></span><span class="xml"><span class="hljs-tag">) { %&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fieldType</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span></span><span class="xml"><span class="hljs-tag">) %&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml">; </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> } %&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fieldList</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[];</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">in</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.fields</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fieldList.push</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span></span><span class="xml"><span class="hljs-tag">); %&gt;</span></span></span><span class="xml"> static </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.name</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> ByKey(</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fieldType</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.primaryKey</span></span></span></span><span class="xml"><span class="hljs-tag">) %&gt;</span></span></span><span class="xml"> key, pqxx::work&amp; tr) { if (!tr.prepared("</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.name</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml">ByKey").exists()) { tr.conn().prepare("</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.name</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml">ByKey", "select </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fieldList.join</span></span></span></span><span class="xml"><span class="hljs-tag">() %&gt;</span></span></span><span class="xml"> from </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.name</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> where </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.primaryKey</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> = $1"); } pqxx::result rows = tr.prepared("</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.name</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml">ByKey")(key).exec(query); </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.name</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> result; </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fieldList.length</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span></span><span class="xml"><span class="hljs-tag">++) { %&gt;</span></span></span><span class="xml"> result.</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fieldList</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span></span><span class="xml"><span class="hljs-tag">] %&gt;</span></span></span><span class="xml"> = rows[0][</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml">].as</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt;%= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">fieldType(entity,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fieldList</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span></span><span class="xml"><span class="hljs-tag">]) %&gt;</span></span></span><span class="xml">&gt;(); </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> } %&gt;</span></span></span><span class="xml"> return result; } </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">in</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.fields</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.fields</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span></span><span class="xml"><span class="hljs-tag">]</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">.references</span></span></span></span><span class="xml"><span class="hljs-tag">) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">entity.fields[field].references;</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> Get</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml">() { return </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml">::ByKey(</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml">); } static std::vector</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt;%= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">entity.name</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml">&gt; By</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml">(</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fieldType</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span></span><span class="xml"><span class="hljs-tag">) %&gt;</span></span></span><span class="xml"> key) { if (!tr.prepared("</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.name</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml">By</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml">").exists()) { tr.conn().prepare("</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.name</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml">By</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml">", "select </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fieldList.join</span></span></span></span><span class="xml"><span class="hljs-tag">() %&gt;</span></span></span><span class="xml"> from </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.name</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> where </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> = $1"); } pqxx::result rows = tr.prepared("</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.name</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml">By</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml">")(key).exec(query); std::vector</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt;%= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">entity.name</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml">&gt; result; for (pqxx::result::size_type i = 0; i </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rows.size</span></span></span></span><span class="xml"><span class="hljs-tag">(); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">++) { &lt;%= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">entity.name</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> row; </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fieldList.length</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span></span><span class="xml"><span class="hljs-tag">++) { %&gt;</span></span></span><span class="xml"> row.</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fieldList</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span></span><span class="xml"><span class="hljs-tag">] %&gt;</span></span></span><span class="xml"> = rows[i][</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml">].as</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt;%= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">fieldType(entity,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fieldList</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span></span><span class="xml"><span class="hljs-tag">]) %&gt;</span></span></span><span class="xml">&gt;(); </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> } %&gt;</span></span></span><span class="xml"> result.push_back(row); } return result; } </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> } %&gt;</span></span></span><span class="xml"> }; </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> } %&gt;</span></span></span></span></code> </pre><br></div></div>  - template for generating a plus code and <div class="spoiler">  <b class="spoiler_title">sql.template</b> <div class="spoiler_text"><pre> <code class="javascript hljs">&lt;% load(<span class="hljs-string"><span class="hljs-string">'model'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sqlTypeMap = { <span class="hljs-string"><span class="hljs-string">'int'</span></span>: <span class="hljs-string"><span class="hljs-string">'integer'</span></span>, <span class="hljs-string"><span class="hljs-string">'string'</span></span>: <span class="hljs-string"><span class="hljs-string">'text'</span></span> }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fieldType</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">entity, field</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sqlTypeMap[entity.fields[field].type]; } %&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">model.length</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">++) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">model[i];%</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> CREATE TABLE </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.name</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> ( </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">in</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.fields</span></span></span></span><span class="xml"><span class="hljs-tag">) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">entity.fields[field].references;</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fieldType</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span></span><span class="xml"><span class="hljs-tag">) %&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span></span><span class="xml"><span class="hljs-tag">) { %&gt;</span></span></span><span class="xml"> REFERENCES </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> } %&gt;</span></span></span><span class="xml">, </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> } %&gt;</span></span></span><span class="xml"> PRIMARY KEY (</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">entity.primaryKey</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml">) ); </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> } %&gt;</span></span></span></span></code> </pre><br></div></div>  - template for generating the database creation script. <br><br><pre>  rhino codegen.js cpp.template: </pre><br><pre> <code class="hljs pgsql">struct Department { <span class="hljs-type"><span class="hljs-type">int</span></span> Id; std::string <span class="hljs-type"><span class="hljs-type">Name</span></span>; static Department ByKey(<span class="hljs-type"><span class="hljs-type">int</span></span> key, pqxx::<span class="hljs-keyword"><span class="hljs-keyword">work</span></span>&amp; tr) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!tr.<span class="hljs-keyword"><span class="hljs-keyword">prepared</span></span>("DepartmentByKey").<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span>()) { tr.conn().<span class="hljs-keyword"><span class="hljs-keyword">prepare</span></span>("DepartmentByKey", "select Id,Name from Department where Id = $1"); } pqxx::result <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> = tr.<span class="hljs-keyword"><span class="hljs-keyword">prepared</span></span>("DepartmentByKey")(key).exec(query); Department result; result.Id = <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>].<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt;(); result.Name = <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>].<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>&lt;std::string&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }; struct Employee { <span class="hljs-type"><span class="hljs-type">int</span></span> Id; std::string <span class="hljs-type"><span class="hljs-type">Name</span></span>; <span class="hljs-type"><span class="hljs-type">int</span></span> DepartmentId; static Employee ByKey(<span class="hljs-type"><span class="hljs-type">int</span></span> key, pqxx::<span class="hljs-keyword"><span class="hljs-keyword">work</span></span>&amp; tr) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!tr.<span class="hljs-keyword"><span class="hljs-keyword">prepared</span></span>("EmployeeByKey").<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span>()) { tr.conn().<span class="hljs-keyword"><span class="hljs-keyword">prepare</span></span>("EmployeeByKey", "select Id,Name,DepartmentId from Employee where Id = $1"); } pqxx::result <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> = tr.<span class="hljs-keyword"><span class="hljs-keyword">prepared</span></span>("EmployeeByKey")(key).exec(query); Employee result; result.Id = <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>].<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt;(); result.Name = <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>].<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>&lt;std::string&gt;(); result.DepartmentId = <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">2</span></span>].<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } Department GetDepartment() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Department::ByKey(DepartmentId); } static std::vector&lt;Employee&gt; ByDepartment(<span class="hljs-type"><span class="hljs-type">int</span></span> key) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!tr.<span class="hljs-keyword"><span class="hljs-keyword">prepared</span></span>("EmployeeByDepartment").<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span>()) { tr.conn().<span class="hljs-keyword"><span class="hljs-keyword">prepare</span></span>("EmployeeByDepartment", "select Id,Name,DepartmentId from Employee where DepartmentId = $1"); } pqxx::result <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> = tr.<span class="hljs-keyword"><span class="hljs-keyword">prepared</span></span>("EmployeeByDepartment")(key).exec(query); std::vector&lt;Employee&gt; result; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (pqxx::result::size_type i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>.size(); i++) { Employee <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>.Id = <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>[i][<span class="hljs-number"><span class="hljs-number">0</span></span>].<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>.Name = <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>[i][<span class="hljs-number"><span class="hljs-number">1</span></span>].<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>&lt;std::string&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>.DepartmentId = <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>[i][<span class="hljs-number"><span class="hljs-number">2</span></span>].<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt;(); result.push_back(<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } };</code> </pre><br>  I admit that the generated code did not run and did not even compile, but I promise that it is very close to the real code that works with postgres.  :) <br><br><pre>  rhino codegen.js sql.template: </pre><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> Department ( <span class="hljs-keyword"><span class="hljs-keyword">Id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> Employee ( <span class="hljs-keyword"><span class="hljs-keyword">Id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, DepartmentId <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> Department, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>) );</code> </pre><br>  For many, I think it is obvious that I did not invent anything new.  Many ORMs can generate similar code.  The main purpose of the article was to demonstrate that creating your own language, even if only DSL, is not easy, but very simple.  This is not at all as scary as it seems, because at many stages you can save a lot of money.  For example, in this case we saved on the parser - most of the work is done by the JS engine, and on the compiler - it is much easier to generate the plus code than the machine code, and let the plus compiler drag around the weights. </div><p>Source: <a href="https://habr.com/ru/post/199012/">https://habr.com/ru/post/199012/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../198994/index.html">Applications are open for the MSIT-SE 2014/15 MSIT program at Innopolis University</a></li>
<li><a href="../199000/index.html">php.net is compromised</a></li>
<li><a href="../199006/index.html">The Government of the Russian Federation has prepared the text of the decision on the petition to cancel the 187-FZ (# Law against Internet)</a></li>
<li><a href="../199008/index.html">Font Awesome 4 released</a></li>
<li><a href="../199010/index.html">Growth Hacking - what is it for, what it is eaten with or ‚Äúhow SEO died‚Äù</a></li>
<li><a href="../199014/index.html">About gdemvd.ru</a></li>
<li><a href="../199016/index.html">Hardware protection against piracy on Windows RT 8.1</a></li>
<li><a href="../199018/index.html">Firmware update for Sony Xperia Z1 and Z Ultra</a></li>
<li><a href="../199020/index.html">"Union" lost a lawsuit to "Vkontakte"</a></li>
<li><a href="../199026/index.html">Development of cross-platform mobile applications in Delphi # 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>