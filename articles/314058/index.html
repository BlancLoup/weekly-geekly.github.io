<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Grouping Sednit uses bootkit in cyber attacks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The first two parts [ 1 , 2 ] of our detailed analysis of the activities of the Sednit grouping were devoted to the mechanisms of the initial compromi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Grouping Sednit uses bootkit in cyber attacks</h1><div class="post__text post__text-html js-mediator-article">  The first two parts [ <a href="https://habrahabr.ru/company/eset/blog/313188/">1</a> , <a href="https://habrahabr.ru/company/eset/blog/313678/">2</a> ] of our detailed analysis of the activities of the Sednit grouping were devoted to the mechanisms of the initial compromise of users, as well as the description of the backdoors of the group called SEDRECO, XAGENT and XTUNNEL.  These backdoors were used for cyber espionage for compromised users, as well as for exfiltration of data from infected systems. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cab/c95/160/cabc95160ffb430d8e25b0be6fddbf3a.jpeg"></div><br><br>  The final part of our study is devoted to an interesting mechanism for covertly maintaining its presence in the system, which is also used by the group to disguise its presence.  Sednit uses bootkit technology to compromise Windows at the earliest stage of its loading. <br><a name="habracut"></a><br>  To compromise the victim's system with the kernel mode component, the grouping uses a special compact bootloader or downloader, which ESET specialists call <b>Downdelph</b> .  Sednit used this daunloader quite rarely.  Over the past two years, this bootloader has been used to use a bootkit, although operators also used it to install the SEDRECO and XAGENT backdoors.  Downdelph was used by the group from November 2013 to September 2015. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Below is information about downdelph use by attackers in chronological order. <br><br><img src="https://habrastorage.org/files/1d3/11e/a24/1d311ea241e64028abf379b3316c5eb3.png"><br><br>  We managed to track only seven cases of installing Downdelph on users' computers.  In all these cases, a dropper was used, which was responsible for installing malware components into the system. <br><br><img src="https://habrastorage.org/files/084/0dc/57a/0840dc57a4db4057aecd2db2e06fee71.png"><br><br>  It can be seen that in cases 3, 4, 5, 6, the dropper used the circumvention technique of the user account management system (UAC).  The authors used two techniques to bypass the UAC.  The first is the use of the already well-known ‚ÄúRedirectEXE‚Äù shim database <a href="https://www.digitaldefense.com/using-application-compatibility-fixes-to-bypass-user-account-control/">method</a> , and the second is using the hijack DLL vulnerability of the standard Windows utility called <i>sysprep.exe</i> .  This application has the ability to automatically increase their privileges. <br><br>  In the seventh case, the dropper was installed in the system using directional phishing.  For the other cases mentioned in the diagram, this method of installing malware is not relevant.  In this case, after its launch, the dropper shows the user a lure document to disguise its malicious activity.  The figure below shows this document, which is an invitation to a conference organized by the Slovak Foreign Policy Association in November 2015. The conference is dedicated to Russian-Ukrainian relations. <br><br><img src="https://habrastorage.org/files/033/2a0/f57/0332a0f5788f4df6a79d2f035194e3c9.png"><br><br>  The core logic of the (core) Downdelph is implemented in a single Delphi class, which was named by the authors of <i>TMyDownloader</i> .  The same class is used in all other bootloader instances we analyzed.  In short, the first thing that Downdelph does is that it loads the main configuration file, which expands the list of C &amp; C servers, and then extracts the payload from each of these servers.  This whole process is illustrated in the figure below. <br><br><img src="https://habrastorage.org/files/fa9/2fc/5d7/fa92fc5d7a1c439b841b752ecc041837.png"><br><br>  As already mentioned, the first thing that Downdelph does is that it loads a configuration file called extended.ini from the original C &amp; C server.  The address of this server is hardwired in the body of the executable file.  To send a network request, HTTP POST is used, in which the URI string contains the name of the file to be extracted.  This file name is encoded using a special algorithm. <br><br><img src="https://habrastorage.org/files/65d/1e0/2ea/65d1e02ea9c140208164aa25ea6de4a3.png"><br><br>  The mentioned request encoding algorithm was designed to make writing network signatures for Downdelph network requests a complex process.  For this, after each character of a line special characters are inserted, which are generated in a pseudo-special way.  Thus, when you type the same word in the query, each of them will be encoded differently. <br><br>  The response from the server is an encrypted configuration file in INI format.  The file has one section called [options], which contains key-value pairs, as indicated in the table below. <br><br><img src="https://habrastorage.org/files/8b1/744/574/8b17445745934cc38f203b5cc49f8d91.png"><br><br>  If the value of the Servers key is not empty, Downdelph adds the addresses of the specified C &amp; C servers to its list for subsequent loading of the payload from there. <br><br>  For each of the C &amp; C servers listed, the malware performs three steps that are used to load the payload.  In the first step, Downdelph sends to the server the system ID that was generated based on the hard disk serial number.  The second step is to load a configuration file called pinlt.ini, which describes the payload file.  Network requests are sent in the above screenshot format.  Possible keys and their configuration file values ‚Äã‚Äãare described in the table below. <br><br><img src="https://habrastorage.org/files/d4c/179/ba5/d4c179ba5f624315899f34886cbde407.png"><br><br>  At the final stage, the malware downloads the payload file from a specific C &amp; C server and works with it in the manner indicated in the configuration file.  After polling all C &amp; C servers, Downdelph suspends its work for a while (Sleep), while the waiting time is specified in the Sleep parameter of the configuration file.  After that, Downdelph begins the process of polling C &amp; C servers from the very beginning.  We did not observe examples of configuration files Downdelph in-the-wild.  However, we know that in some cases, he uploaded Sedreco and Xagent backdoors to the system. <br><br>  We have seen cases of using Downdelph with a bootkit in two cases, 1 and 5. In recent years, bootkits have become quite a popular way to load illegitimate kernel-mode drivers in 64-bit editions of Windows.  Although this is also true for our case, it is worth noting that the use of a bootkit is determined by the mechanism for ensuring the survival of the Downdelph loader in the system.  Using a bootkit allows authors to deeply hide malicious components, making them invisible even before the OS is loaded. <br><br>  The Sednit bootkit is capable of compromising the 32-bit and 64-bit editions of Windows XP - 7. As far as we know, this bootkit has never been documented by any of the researchers, even though other representatives of this kind of malware are already well documented. <br><br>  The process of installing a bootkit varies depending on the version of Windows, as well as its bit depth, that is, whether it is 32 or 64 bits.  In both cases, the bootkit installer begins by rewriting the MBR. <br><br><img src="https://habrastorage.org/files/70e/152/c1c/70e152c1cc234505a3faa9523d10f0f9.png"><br><br>  The MBR is overwritten by its malicious counterpart, and the original sector is encrypted and stored in the second sector.  The main code of the bootkit is stored on the disk starting from the third sector, also in the form encrypted using the XOR operation.  This core code will be different for different versions of Windows, since the hooks it installs during the Windows boot process are different.  After that, the control is transferred to the rootkit driver, which is stored on the disk in the form encrypted using the RC4 algorithm.  The driver can be either 32-bit or 64-bit. <br><br>  To access the first disk sector, i.e. the MBR, the dropper resorts to the already known method that was previously <a href="http://www.welivesecurity.com/media_files/white-papers/The_Evolution_of_TDL.pdf">used by the</a> authors of the TDL4 rootkit. <br><br><img src="https://habrastorage.org/files/99b/442/038/99b44203882e434f8d9c50432fec0bab.png"><br><br>  After opening the handle to a disk device, the dropper uses the <i>WriteFile</i> API to overwrite the first disk sectors.  It should be noted that this operation requires administrative rights for the dropper in the system. <br><br>  Next, the dropper saves the special DLL library in the created registry section called <i>HKLM \ SYSTEM \ CurrentControlSet \ Control \ Lsa \ Core Packages</i> .  As we will explain later, this library is a user mode component.  In addition, the Downdelph loader itself is stored along the same registry path, but in a section called Impersonation Packages. <br><br>  These two files are stored in the registry settings after other encrypted data, which is also used by the bootkit code.  This data is compressed with aPLib, and then encrypted with RC4 and begins with the header of the following structure. <br><br><pre><code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackedChunkHeader</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-type"><span class="hljs-type">DWORD</span></span> magic; <span class="hljs-comment"><span class="hljs-comment">//    '0x203a3320'  " :3 "  ASCII DWORD packed_size; DWORD unpacked_size; DWORD key_size; BYTE rc4_key[16]; };</span></span></code> </pre> <br>  The value of the <i>magic</i> field is also recorded by the dropper at the 0x19B offset of the malicious MBR and serves as a marker that the MBR has already been overwritten by the malicious content. <br><br>  After its installation in the system, the bootkit takes control of it and then loads Windows.  The boot process of the Windows 7 bootkit system is shown below. <br><br><img src="https://habrastorage.org/files/04d/28b/b5e/04d28bb5eafe4043b074c3f469318f60.png"><br><br>  Obviously, the main purpose of the bootkit is to compromise Windows at an early stage and the secretive execution of the payload after it is loaded.  Unfortunately, such a bootkit survival scheme in the system requires the use of significant modifications of the Windows system components in memory.  A bootkit should contain in its arsenal a code both for the real mode of operation of the microprocessor and for the protected one, and also to constantly check the fact of gaining control over the system loading at each of the stages.  To achieve this goal, the malicious code installs various interceptions in the system components in memory.  Despite the fact that the process of executing the bootkit code in the system is described in the picture above, as well as in the presentation of our specialists called <a href="https://www.virusbulletin.com/uploads/pdf/conference/vb2014/VB2014-RodionovMatrosov.pdf">Bootkits: Past, Present &amp; Future</a> , there are a number of features that we would like to point out. <br><br>  Malicious code in the bootkit's MBR decrypts the bootkit's code, as well as the driver, which has been saved to disk since the third sector, into a memory buffer.  In the system investigated by us, this buffer was located at the physical address 0x97C00.  Thus, this region of memory contains the main part of the bootkit code, as well as intercepts for bootmgr, winload.exe and ACPI.sys.  Thus, the hooks in these modules will redirect the flow of execution to the above buffer.  This feature is not typical for bootkits, since, as a rule, they copy their code at each stage of loading into a new memory area in order to ensure their survival when the microprocessor mode is switched from real to protected. <br><br>  In addition, the Sednit bootkit is the first instance that uses the legitimate acpi.sys driver for its download.  Malicious code modifies the code at the entry point of this driver so that it points to a small piece of code from its resource section. <br><br><img src="https://habrastorage.org/files/874/c32/f35/874c32f3596a4ff7b87169e4c9c78a89.png"><br><br>  This fragment of malicious code receives as an input argument the load address of the kernel ntoskrnl.exe in memory, in which the unused fields of the PE header of which the bootkit stores some of its important data.  Using this data, the bootkit code recovers the first five bytes of the acpi.sys entry point, and then redirects the bootkit code to the physical address 0x97C00.  This region of physical memory was projected onto protected mode virtual memory using the <i>MmMapIoSpace</i> kernel <i>API</i> .  This code decrypts and executes the bootkit driver. <br><br>  The bootkit driver injects the contents of the user mode into the explorer.exe process by modifying its entry point prior to its actual execution.  This user mode component starts the Downdelph loader for execution.  In addition, he is trying to set the exported global boolean variable <i>m_bLoadedByBootkit</i> to one. <br><br><img src="https://habrastorage.org/files/881/753/f12/881753f12d0046dcbf02ffd525b6d3e6.png"><br><br>  Since this global variable is not present in all Downdelph executables except the bootloader, we assume that the bootkit was originally intended for use with different payloads, and later it was reoriented by Sednit operators to the component they need.  In addition, the user component of the bootkit exports two functions called <i>Entry</i> and <i>ep_data</i> . </div><p>Source: <a href="https://habr.com/ru/post/314058/">https://habr.com/ru/post/314058/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314046/index.html">How I went to the first in Russia "Testathon", hackathon for testers</a></li>
<li><a href="../314048/index.html">Safety when using PostgreSQL</a></li>
<li><a href="../314050/index.html">As I wrote the application on Elm</a></li>
<li><a href="../314054/index.html">Editing a hopeless support letter</a></li>
<li><a href="../314056/index.html">Optimization by example. Ant algorithm (ACS) vs Annealing Method. Part 2</a></li>
<li><a href="../314060/index.html">TextBlock with backlit text (WPF)</a></li>
<li><a href="../314062/index.html">How the Python parser works, and how to reduce memory consumption by three times</a></li>
<li><a href="../314068/index.html">ASO optimization. Compiling a semantic core for app stores</a></li>
<li><a href="../314072/index.html">Simple and convenient notifications</a></li>
<li><a href="../314074/index.html">3CX Phone System V15 SP3 released and integrated with Insightly CRM</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>