<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Open SSl and .NET - data signature</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Good day! By fate, I had to work with one operator who was very fond of encrypting his data :) It seems that the task seemed trivial an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Open SSl and .NET - data signature</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  Good day!  By fate, I had to work with one operator who was very fond of encrypting his data :) It seems that the task seemed trivial and quite ordinary - the RSA algorithm is popular and familiar to everyone, the implementation of cryptography is in .NET - I wrote a couple of lines and nobody asked you he sees :) But I thought so only until I began to write these same pair of lines ... <br><br><h4>  Task </h4><br>  So, what I had to do was: sign (sign) requests from our side, and decrypt signed requests sent by the partner using the RSA algorithm. <br><a name="habracut"></a><br>  <b>A few words about the signature</b> : there are 2 keys public and private.  Subscriber A encrypts the <b>private</b> key with a message and sends it to subscriber B. Subscriber B, having received this message and having the <b>public</b> key (which subscriber A sent), can verify that this message was sent by subscriber A. In general <a href="http://ru.wikipedia.org/wiki/RSA">,</a> there is enough <a href="http://ru.wikipedia.org/wiki/RSA">information</a> about Rsa, so I‚Äôll stop here. <br><br><h4>  Encryption tools </h4><br>  In my case, the ‚Äúclient‚Äù used the popular <a href="http://www.openssl.org/">Open SSL</a> program, which allows doing a lot of things with encryption, including signing data.  The program works as follows: it accepts a file as input, a key and issues a signed message.  Verification works in a similar way: it receives the encrypted file, the public key and, if successful, outputs a file with the decrypted message. <br>  To implement RSA signature in .NET, there is a very convenient <a href="http://msdn.microsoft.com/ru-ru/library/system.security.cryptography.rsacryptoserviceprovider.aspx">RSACryptoServiceProvider</a> class that allows you to do encryption and signing.  Everything would be fine, until it turned out that the concept of a <b>signature</b> on these implementations is very different ... :( I had to spend a single hour searching on the Internet, but I didn‚Äôt have any information. Although people saw complaints often about the incompatibility of implementations. The main point is that OpenSSL inserts the data itself (as encryption) into the signature, and .NET only signs it (logically). I found <a href="http://www.example-code.com/csharp/rsa_sign_key_cer.asp">only 1 C # library</a> , which contains the OpenSSL implementation, but it turned out to be paid. However, the main difference between the implementations is written there: <br>  <i>OpenSSL rsautl is very different.</i>  <i>Here's what it does:</i> <i><br></i>  <i>1. The input data is not hashed.</i>  <i>It can be padded and signed.</i>  <i>PKCS v1.5 padding is always used.</i>  <i>The data is not ASN.1 encoded before padding.</i> <i><br></i>  <i>2. The PKCS v1.5 padded data is RSA signed and the signature is returned.</i> <br>  Almost desperate and even writing a wrapper for OpenSSL, I stumbled upon one good link: the <a href="http://openssl-net.sourceforge.net/">OPEN SSL NET</a> project - i.e.  a wrapper for OpenSSL, or rather the libraries it uses - <b>libeay32.dll</b> and <b>ssleay32.dll</b> .  But, as it turned out, not everything was obvious there, but digging among C # classes was still easier than implementing the source code itself with C :) After talking with the author of the library, he wrote a wrapper class that contains signature and verification methods similar to OpenSSL. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Just in case, I‚Äôll give an example of working with the OpenSSL utility so that those interested do not waste time on -help :) <br>  Signature: <i>openssl rsautl -inkey priv.key -in temp.txt -out temp.bin -sign</i> , <br>  Verification: <i>openssl rsautl -pubin -inkey pub.key -in temp2.bin -out result2.txt -verify</i> <br>  So, the code itself: <br><br><h4>  Emulator class RsaUtl OpenSSL </h4><br>  I think the comments to the code itself are superfluous.  I included this class myself in the OpenSSL.NET assembly, but it can be used with the same success outside it.  Successful work requires libraries libeay32.dll, ssleay32.dll (and if you use outside the assembly, then ManagedOpenSsl.dll).  Briefly about the class: loads the keys in pem format and then signs / verifies the data.  I made an overload so that the key could be specified as the path to the file, or simply byte []. <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">using</font> System; <br> <font color="#0000ff">using</font> System.Collections. <font color="#2B91AF">Generic</font> ; <br> <font color="#0000ff">using</font> System.Text; <br> <font color="#0000ff">using</font> System.IO; <br> <font color="#0000ff">using</font> System.Security.Cryptography.X509Certificates; <br> <font color="#0000ff">using</font> OpenSSL; <br> <br> <font color="#0000ff">namespace</font> Rsautl <br> { <br> <font color="#008000">/// &lt;summary&gt;</font> <br> <font color="#008000">///     Openssl -rsautl</font> <br> <font color="#008000">/// &lt;/summary&gt;</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">class</font> Rsautl <br> { <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> RSA ReadPrivateKey( <font color="#0000ff">string</font> path) <br> { <br> <font color="#2B91AF">Stream</font> s = <font color="#2B91AF">File</font> .Open(path, <font color="#2B91AF">FileMode</font> .Open); <br> <font color="#0000ff">byte</font> [] pk = <font color="#0000ff">new</font> <font color="#0000ff">byte</font> [s.Length]; <br> s.Read(pk, 0, pk.Length); <br> s.Close(); <br> BIO b = <font color="#0000ff">new</font> BIO(pk); <br> <font color="#0000ff">return</font> RSA.FromPrivateKey(b); <br> <br> } <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> RSA ReadPrivateKey( <font color="#0000ff">byte</font> [] path) <br> { <br> BIO b = <font color="#0000ff">new</font> BIO(path); <br> <font color="#0000ff">return</font> RSA.FromPrivateKey(b); <br> <br> } <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> RSA ReadPubKey( <font color="#0000ff">string</font> path) <br> { <br> <font color="#2B91AF">Stream</font> s = <font color="#2B91AF">File</font> .Open(path, <font color="#2B91AF">FileMode</font> .Open); <br> <font color="#0000ff">byte</font> [] pk = <font color="#0000ff">new</font> <font color="#0000ff">byte</font> [s.Length]; <br> s.Read(pk, 0, pk.Length); <br> s.Close(); <br> BIO b = <font color="#0000ff">new</font> BIO(pk); <br> <font color="#0000ff">return</font> RSA.FromPublicKey(b); <br> } <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> RSA ReadPubKey( <font color="#0000ff">byte</font> [] path) <br> { <br> BIO b = <font color="#0000ff">new</font> BIO(path); <br> <font color="#0000ff">return</font> RSA.FromPublicKey(b); <br> } <br> <br> <font color="#0000ff">#region</font>  <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">byte</font> [] RsaUtlSignData( <font color="#0000ff">byte</font> [] data, <font color="#0000ff">string</font> privatekeypath) <br> { <br> RSA key = ReadPrivateKey(privatekeypath); <br> <font color="#0000ff">return</font> key.PrivateEncrypt(data,RSA.Padding.PKCS1); <br> } <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">byte</font> [] RsaUtlSignData( <font color="#0000ff">byte</font> [] data, <font color="#0000ff">byte</font> [] privatekey) <br> { <br> RSA key = ReadPrivateKey(privatekey); <br> <font color="#0000ff">return</font> key.PrivateEncrypt(data, RSA.Padding.PKCS1); <br> <br> } <br> <font color="#0000ff">#endregion</font> <br> <br> <font color="#0000ff">#region</font>   <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">byte</font> [] RsaUtlVerifyData( <font color="#0000ff">byte</font> [] sign, <font color="#0000ff">string</font> pathtopublickey) <br> { <br> RSA key = ReadPubKey(pathtopublickey); <br> <font color="#0000ff">return</font> key.PublicDecrypt(sign, RSA.Padding.PKCS1); <br> } <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">byte</font> [] RsaUtlVerifyData( <font color="#0000ff">byte</font> [] sign, <font color="#0000ff">byte</font> [] publickey) <br> { <br> RSA key = ReadPubKey(publickey); <br> <font color="#0000ff">return</font> key.PublicDecrypt(sign, RSA.Padding.PKCS1); <br> } <br> <font color="#0000ff">#endregion</font> <br> <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br><h4>  Conclusion </h4><br>  I hope this article will be useful to someone and save your valuable time.  Just do not say that you can do it all in 1 minute - I don‚Äôt believe :) But if there is still a way to sign data in NET without third-party libraries, it‚Äôs compatible with OpenSSL please write !!! <br>  <b>PS</b> please argue the evaluation of the article;) <br>  <b>PS2</b> if anyone is interested, I can write an article about how I struggled with OpenPGP =) There's a similar story ... :) </div><p>Source: <a href="https://habr.com/ru/post/68591/">https://habr.com/ru/post/68591/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../68580/index.html">Sony: 3D TVs in every home!</a></li>
<li><a href="../68582/index.html">In England, a proposal to pay for the use of content of media sites was announced.</a></li>
<li><a href="../68584/index.html">About influenza A (H1N1) in terms of programming</a></li>
<li><a href="../68586/index.html">Historical iRiver with comics</a></li>
<li><a href="../68587/index.html">Smartphones crush the GPS navigation market</a></li>
<li><a href="../68593/index.html">August contest is over!</a></li>
<li><a href="../68595/index.html">Kryptonomicon</a></li>
<li><a href="../68596/index.html">body parts</a></li>
<li><a href="../68597/index.html">Russian SharePoint User Group</a></li>
<li><a href="../68598/index.html">Invites to Peers.FM and Animuxia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>