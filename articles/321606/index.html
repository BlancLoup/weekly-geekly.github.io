<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Home Assistant or another ‚Äúbrain‚Äù for a project like ‚ÄúSmart Home‚Äù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, dear reader. The other day I had a chance to play around with many already known toys from Google - Google Home. The thing is good - I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Home Assistant or another ‚Äúbrain‚Äù for a project like ‚ÄúSmart Home‚Äù</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, dear reader.  The other day I had a chance to play around with many already known toys from Google - Google Home.  The thing is good - I certainly will not do a review of it.  In the closet, Raspberry PI 3 (RPi), Arduino Mega and a similar trifle, which they wanted to connect to Google Home (GH) for voice control, were <s>completely randomly</s> lying around.  GH does not have a simple API, but it is possible to organize voice control of the system on the RPi + Arduino with the help of a third-party service with a delay of several seconds in commands. <br><br>  Reading the bourgeois forums (for the sake of justice, I need to point out the person I turned on automation and IoT), I noticed a hitherto unknown to me something that is called the <b>Home Assistant</b> (HASS), this system is fastened to the GH by the craftsmen. <br><br>  Briefly about the platform itself: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The system is written in Python, the last release was January 29, <a href="https://home-assistant.io/blog/2017/01/28/face-coffee-wink/">current version:</a> 0.37.0 <br><br>  Supported OS: <br><br><ul><li>  Windows 10 </li><li>  Mac os x </li><li>  Ubuntu 14.04 </li><li>  Raspbian (Raspberry PI) </li><li>  iOS App - beta </li></ul><br>  Supported components: 545 pcs., Including almost all TV / AV receivers, Broadlink, ZigBee, iCloud, Yandex TTS and much, much more. <br><a name="habracut"></a><br>  To start, connect and configure components, switches, scripts, groups, triggers, it is not necessary to know Python, but you need to know a little yaml. <br><br>  ‚ÄúWhat a sudden?‚Äù - you think. <br><br>  The answer is: the configuration of all of the above (existing components) is carried out exclusively through the YAML file (‚Äúconfiguration.yaml‚Äù). <br><br>  The installation is simple - it doesn't make sense to dwell on it and paint all the steps, besides, the project has a smart <a href="https://community.home-assistant.io/">community</a> ready to help in difficult times (Eng).  (All links will be additionally placed in the basement, as prescribed by the statute) <br><br>  Be prepared that the installation takes a lot of time, on my RPi 3 the total time (without Raspbian) took about an hour. <br><br>  After completing the coveted <code>wget</code> , I proceeded to explore the platform.  HASS is installed in the directory: <code>/home/homeassistant</code> .  We are also interested in <code>/home/homeassistant/.homeassistant/configuration.yaml</code> . <br><br>  By default, the following component is present in the config: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta">#   discovery:</span></span></code> </pre> <br>  If you have such devices on your network: <br><br><ul><li>  Google chromecast </li><li>  Belkin WeMo switches </li><li>  Philips Hue </li><li>  Netgear routers </li><li>  Plex media server </li><li>  Panasonic Viera </li><li>  Roku media player </li><li>  Sonos speakers </li><li>  Yamaha media player </li><li>  Logitech media server (Squeezebox) </li><li>  DirecTV </li></ul><br>  They will be detected automatically and displayed in the main (and so far the only) group ‚Äú <i>Home</i> ‚Äù. <br><br>  The " <i>http</i> " component: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta">#    frontend http: #       (recommended!) #api_password: YOUR_PASSWORD</span></span></code> </pre> <br>  As absolutely rightly noted <a href="http/">on the portal</a> - HIGHLY recommended - for security reasons. <br><br>  After successfully changing the configuration file, you must restart the service.  There are two ways to do this: <br><br>  1) Use shell commands: <br><br><pre> <code class="bash hljs">~ $ sudo systemctl stop home-assistant.service ~ $ sudo systemctl start home-assistant.service</code> </pre> <br>  or immediately <br><br><pre> <code class="bash hljs">~ $ sudo systemctl restart home-assistant.service</code> </pre> <br>  2) Restart from the GUI: Expand the hamburger, open ‚Äú <b>Services</b> ‚Äù in the ‚Äú <b>Developer Tool</b> ‚Äù basement, select ‚Äú <i>homeassistant</i> ‚Äù in the ‚Äú <b>Domain</b> ‚Äù drop-down list, and click ‚ÄúCALL SERVICE‚Äù in the ‚Äú <b>Service</b> ‚Äù drop-down list. <br><blockquote>  I draw your attention that the frontend uses caching, while restarting or stopping the service, the page is fully viewable, but no action is possible. </blockquote><br>  As soon as the restart of the service is launched, either through the shell or through the GUI, a field showing the current status of the service will be displayed at the bottom of the screen. <br><br>  As soon as the service rises, the page automatically refreshes and the field disappears.  If an error has crept into the config, the service will not start. <br><br>  What should be done in this case: <br><br>  1) Open the log file: <code>~/.homeassistant/ home-assistant.log</code> <br>  Log entries are quite structured, with often specifying the line number in configuration.yaml in which the error occurred. <br>  2) Solve the problem specified in the log <br>  3) Start the service with the command from the console above. <br><br>  We set the password, we set up (if for some reason there was no default) autodetection of the equipment, it‚Äôs time to go to the portal: <br><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">//IP-Address:8123</span></span></code> </pre> <br>  8123 is the default port. <br><br><div class="spoiler">  <b class="spoiler_title">First launch of HASS</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/bf3/966/f68/bf3966f68d6898a29c9032c2ff0ba4c8.jpg" alt="image"><br></div></div><br>  What allows HASS to do with the receiver: <br><br>  Available to us: Source, Volume, Without Sound (when listening to audio recordings, track control buttons are available). <br><br>  Now, let's take a closer look at yaml-ku.  I present a somewhat enhanced version, on the basis of which it will be easier to understand what opportunities HASS has, and also, perhaps, will help you in setting up your own environment. <br><br><div class="spoiler">  <b class="spoiler_title">configuration.yaml</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">homeassistant: #    HASS <span class="hljs-type"><span class="hljs-type">name</span></span>:  #    *,        latitude: _REDACTED_ longitude: _REDACTED_ #     ‚Äì      elevation: <span class="hljs-number"><span class="hljs-number">0</span></span> # <span class="hljs-string"><span class="hljs-string">'metric'</span></span>   , <span class="hljs-string"><span class="hljs-string">'imperial'</span></span> -  unit_system: metric #  : http://en.wikipedia.org/wiki/List_of_tz_database_time_zones time_zone: Europe/Moscow #    customize  .  -       #customize: !<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> customize.yaml #  frontend GUI.  ,   frontend: #    updater: reporting: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> #        logbook: #      -      sun: #     GUI conversation: #    history: #    discovery: #    : http: api_password: _REDACTED_ # ssl_certificate: _REDACTED_ # SSL  # ssl_key: _REDACTED_ # base_url: _REDACTED_ # trusted_networks: # - <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> # - _REDACTED_/<span class="hljs-number"><span class="hljs-number">24</span></span> # ip_ban_enabled: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> # login_attempts_threshold: <span class="hljs-number"><span class="hljs-number">5</span></span></code> </pre> <br><blockquote>  <i>House Zone *</i> - HASS allows you to create zones (locations) around the world, country, city (anywhere) on the basis of geo-coordinates, for use later in creating ‚Äúautomation‚Äù (automation) and notifications (notify). </blockquote><br></div></div><br>  Looking ahead, HASS supports integration with the Telegram service, on the basis of which I implemented an alert, but more on that later. <br><br>  Next you need to edit the config file, restart the HASS service, go to the Web page and see what happened. <br><br>  <b>Now we will start the first automation</b> (further <i>automation</i> ).  As the first automation, I propose to consider the "Alarm Clock".  To accomplish this task, we do not need to have audio or video devices on the network.  However, in the example, I will show the use of the receiver as the alarm clock itself. <br><br>  <b>Task</b> <br><br>  Wake up at the appointed time, turning on the AV receiver, with increasing volume.  After a certain time, synthesize text to speech and notify those who wake up about the current weather outside the window, in order to dress in accordance with weather conditions, also sending a message to the Telegram, with information about the weather. <br><br>  <b>Resources</b> <br><br><ul><li>  Raspberry pi </li><li>  Home assistant </li><li>  Network (wired / wireless) with Internet access </li><li>  VLC </li><li>  AV Receiver (optional) </li><li>  Telegram </li><li>  Telegram Bot </li><li>  Yandex SpeechKit Cloud </li><li>  Openweathermap </li></ul><br>  <b>Implementation</b> <br><br>  First we need to create a bot in Telegram, to connect it to our project.  There are many instructions on the Internet about <a href="https://core.telegram.org/bots">how to register your own bot</a> , so I will not describe this process.  Only in the course of the description, I will focus your attention on the important points. <br><br>  So, we have our own bot.  To connect to HASS, you need to set the following in <code>configuration.yaml</code> : <br><br><pre> <code class="hljs pgsql"># Telegram Notifier <span class="hljs-keyword"><span class="hljs-keyword">notify</span></span>: - <span class="hljs-type"><span class="hljs-type">name</span></span>: NOTIFIER_NAME (        <span class="hljs-string"><span class="hljs-string">'notify'</span></span> - eng) platform: telegram api_key: ABCDEFGHJKLMNOPQRSTUVXYZ chat_id: YOUR_CHAT_ID</code> </pre> <br>  However, if you plan to add several alert services, it is better to use the attached file.  Significantly simplifies the readability of the configuration file. <br><br>  <i>How to do this will be written below.</i> <br><br>  As you can see from the comments, we need the API given to us for Bot, and also Chat ID.  In order to get the Chat ID, you need to write your Bot at least one message, and then open the page with the address: <br><br><pre> <code class="hljs objectivec"> https:<span class="hljs-comment"><span class="hljs-comment">//api.telegram.org/bot*API*/getUpdates.</span></span></code> </pre> <br>  Where * API * - API given to you. <br><br>  As a result, you will get some JSON in which we are interested in the following: <br><br><pre> <code class="hljs xml">{"<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span>id<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span>":<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span>123456789 <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span>‚Ä¶}</code> </pre> <br>  The ID value is what we need. <br><br>  Next, let's connect the component responsible for synthesizing text - <i>SpeechKit Cloud Yandex</i> . <br><br>  To do this, we need to <a href="https://developer.tech.yandex.ru/">register</a> and go through several simple configuration steps. <br><br>  Choose SpeechKit Cloud API from the connected services and get the key. <br><br>  In <code>configuration.yaml</code> make the following entry: <br><br><pre> <code class="hljs pgsql">tts: - platform: yandextts #       TTS <span class="hljs-type"><span class="hljs-type">name</span></span>: yandextts #  ,     api_key: <span class="hljs-string"><span class="hljs-string">'API  SpeechKit'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">language</span></span>: <span class="hljs-string"><span class="hljs-string">'ru-RU'</span></span> #    ‚Äì   ru codec: <span class="hljs-string"><span class="hljs-string">'mp3'</span></span> #     voice: <span class="hljs-string"><span class="hljs-string">'jane'</span></span> #   emotion: <span class="hljs-string"><span class="hljs-string">'good'</span></span> #   speed: <span class="hljs-string"><span class="hljs-string">'1'</span></span> #  </code> </pre> <br>  <a href="https://tech.yandex.ru/speechkit/cloud/doc/dg/concepts/speechkit-dg-tts-docpage/">Explanations and options of parameters</a> are available on the Yandex website. <br><br>  Now we already have two warning services, but we will ‚Äúnot be enough‚Äù, we will have to add one more: VLC. <br><br>  Since I originally used Raspberry PI, I installed VLC with a simple command: <br><br><pre> <code class="bash hljs">sudo apt-get install vlc</code> </pre> <br>  Next, you need to adjust the sound settings on Raspberry - the default playback device and do some simple manipulation with the user's access rights, which was created when installing HASS AIO (All-In-One). <br><br><pre> <code class="bash hljs">sudo usermod -a -G audio homeassistant</code> </pre> <br>  The command adds the user to the audio group. <br><br>  In <code>configuration.yaml</code> we enter the line: <br><br><pre> <code class="hljs pgsql">media_player: !<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> media_player.yaml</code> </pre> <br>  Create a file in the parent folder: <code>media_player.yaml</code> where all settings for media devices that we will connect will be stored. <br><br>  We make the following settings: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">platform</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">yamaha</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">Yamaha_671</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">zone</span></span>: 2 #     <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">commands</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">turn_on</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">service</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">media_player</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.turn_on</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">turn_off</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">service</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">media_player</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.turn_off</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">volume_up</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">service</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">media_player</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.volume_up</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">volume_down</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">service</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">media_player</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.volume_down</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">customize</span></span>: #    <span class="hljs-selector-tag"><span class="hljs-selector-tag">frontend</span></span>   <span class="hljs-selector-tag"><span class="hljs-selector-tag">media_player</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yamaha_671</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">hidden</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">true</span></span> #   <span class="hljs-selector-tag"><span class="hljs-selector-tag">yamaha_671</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>   (<span class="hljs-selector-tag"><span class="hljs-selector-tag">Main</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">platform</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">vlc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">vlcmp</span></span> #    <span class="hljs-selector-tag"><span class="hljs-selector-tag">VLC</span></span></code> </pre> <br>  My receiver has two playback zones ( <i>Main</i> , <i>Zone 2</i> ).  In the example I use the second. <br><br>  All optional components are connected.  We can proceed to setting the alarm element itself. <br><br>  Add a line to the configuration file: <br><br><pre> <code class="hljs pgsql">## <span class="hljs-keyword"><span class="hljs-keyword">Input</span></span> <span class="hljs-type"><span class="hljs-type">Boolean</span></span> input_boolean: !<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> input_boolean.yaml</code> </pre> <br>  Create a file in the parent folder: <code>input_boolean.yaml</code> <br><br>  We enter the following lines: <br><br><pre> <code class="hljs pgsql">alarmweekday: #  -      <span class="hljs-type"><span class="hljs-type">name</span></span>:   initial: <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> #    icon: mdi:calendar</code> </pre> <br>  As you can see from the name yaml, we connect a component of the ‚ÄúSwitch‚Äù type.  The only thing that seems to me additionally is to describe this <i>icon</i> .  We can use any icons from the <a href="https://materialdesignicons.com/">MDI</a> library. <br><br>  You can use components to set the time: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">input_slider</span></span> input_select</code> </pre> <br>  One is a selection from the list.  Another slider.  I used a convenient slider to customize. <br><br>  We register in <code>configuration.yaml</code> : <br><br><pre> <code class="hljs pgsql">## <span class="hljs-keyword"><span class="hljs-keyword">Input</span></span> Slider input_slider: !<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> input_slider.yaml</code> </pre> <br>  As already started in the parent folder, create the file: <code>input_slider.yaml</code> <br>  Next, fill it in: <br><br><pre> <code class="hljs swift">alarmhour: name:  icon: mdi:timer initial: <span class="hljs-number"><span class="hljs-number">8</span></span> #    <span class="hljs-built_in"><span class="hljs-built_in">min</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> #  <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>: <span class="hljs-number"><span class="hljs-number">23</span></span> #  step: <span class="hljs-number"><span class="hljs-number">1</span></span> #  alarmminutes: name:  icon: mdi:timer initial: <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-built_in"><span class="hljs-built_in">min</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>: <span class="hljs-number"><span class="hljs-number">59</span></span> step: <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  And one more simple piece we have to do: the <i>sensor</i> . <br>  In the config we write: <br><br><pre> <code class="hljs erlang-repl">sensor: !include_dir_merge_list sensors</code> </pre> <br>  This command means that all files from the <i>sensors</i> folder should be taken.  In turn, in the sensors folder, create a yaml file with the name: <code>alarmclock.yaml</code> .  <code>alarmclock.yaml</code> : <br><br><pre> <code class="hljs django"><span class="xml"><span class="xml">- platform: template sensors: alarm_time: friendly_name: ' ' value_template: '</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ states.input_slider.alarmhour.state | int }}</span></span><span class="xml"><span class="xml">:</span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">if</span></span></span></span></span><span class="hljs-template-tag"> states.input_slider.alarmminutes.state|</span><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name">length</span></span></span><span class="hljs-template-tag"> == 1 %}</span></span><span class="xml"><span class="xml">0</span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endif</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"></span><span class="hljs-template-variable"><span class="xml"></span><span class="hljs-template-variable">{{ states.input_slider.alarmminutes.state | int }}</span></span><span class="xml"><span class="xml">'</span></span></code> </pre> <br>  It's more interesting here.  A <i>template</i> appears.  This component allows you to fully manage the data of other HASS components.  In this example, we create a sensor and fill it with data from the alarm clock sliders, forcing the value to <i>int</i> and adding ‚Äú0‚Äù if ‚Äúlength‚Äù minutes == 1. For more information about the possibilities, see the <a href="https://home-assistant.io/topics/templating/">HASS</a> portal. <br><br>  We need another sensor - weather conditions. <br><br>  Among all the <a href="https://home-assistant.io/components/">available</a> weather <a href="https://home-assistant.io/components/">components,</a> my choice fell on <a href="https://home-assistant.io/components/sensor.openweathermap/">OpenWeatherMap Sensor</a> .  In the <i>sensors</i> folder, you need to create a <code>weather.yaml</code> file and fill it with the following: <br><br><pre> <code class="hljs markdown"><span class="hljs-bullet"><span class="hljs-bullet">- </span></span>platform: openweathermap api<span class="hljs-emphasis"><span class="hljs-emphasis">_key: *API* latitude: *latitude* longitude: *longitude* monitored_</span></span>conditions: - weather - temperature - wind_speed - humidity - clouds - rain - snow</code> </pre> <br>  As it is not difficult to notice, we will need to integrate the API from OWM.  API is free, and you can get it by <a href="https://home.openweathermap.org/users/sign_up">registering on the portal</a> .  Save, close, go ahead. <br><br>  Switches, sliders and sensors for the alarm we have created.  But why include if there is no alarm clock yet? <br><br>  Let's start creating <i>automation</i> . <br><br>  We register in <code>configuration.yaml</code> : <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta">## Automation for: alarmclock... automation: !include_dir_merge_list automation</span></span></code> </pre> <br>  This means that all files from the <i>automation</i> folder will be loaded.  Now we create an ‚Äúautomation‚Äù folder in the parent directory. <br><br>  Create a file: <code>alarmclock.yaml</code> <br><br>  And proceed to fill. <br><br>  Since my volume increment is used every second, the file is large.  I will give the most necessary lines, the rest can be customized by analogy. <br><br><div class="spoiler">  <b class="spoiler_title">Automation for Alarm</b> <div class="spoiler_text"><pre> <code class="hljs mel">- <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span>: <span class="hljs-string"><span class="hljs-string">' '</span></span> trigger: platform: template value_template: <span class="hljs-string"><span class="hljs-string">'{{ states.sensor.time.state == states.sensor.alarm_time.state }}'</span></span> #  . <span class="hljs-keyword"><span class="hljs-keyword">condition</span></span>: #  <span class="hljs-keyword"><span class="hljs-keyword">condition</span></span>: or conditions: - <span class="hljs-keyword"><span class="hljs-keyword">condition</span></span>: and conditions: - <span class="hljs-keyword"><span class="hljs-keyword">condition</span></span>: state entity_id: input_boolean.alarmweekday state: <span class="hljs-string"><span class="hljs-string">'on'</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">condition</span></span>: time weekday: - mon - tue - wed - thu - fri - <span class="hljs-keyword"><span class="hljs-keyword">condition</span></span>: state entity_id: input_boolean.alarmweekday state: <span class="hljs-string"><span class="hljs-string">'off'</span></span> action: #  - service: notify.NOTIFIER_NAME data_template: title:  , ! =) message: <span class="hljs-string"><span class="hljs-string">",   !    {{ states('sensor.owm_temperature')|int }} ¬∞C."</span></span> - service: media_player.turn_on #    entity_id: media_player.yamaha_671_zone_2 # ,       - service: media_player.volume_set #   data: entity_id: media_player.yamaha_671_zone_2# ,       volume_level: <span class="hljs-string"><span class="hljs-string">'0.20'</span></span> #    - service: media_player.select_source #   data: entity_id: media_player.yamaha_671_zone_2 <span class="hljs-keyword"><span class="hljs-keyword">source</span></span>: NET RADIO - delay: <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span> #  - service: media_player.volume_set #   data: entity_id: media_player.yamaha_671_zone_2 volume_level: <span class="hljs-string"><span class="hljs-string">'0.25'</span></span> - delay: <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span> #  - service: media_player.volume_set #   data: entity_id: media_player.yamaha_671_zone_2 volume_level: <span class="hljs-string"><span class="hljs-string">'0.30'</span></span> #            - delay: <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span> - service: media_player.turn_on #  ,  . (      automation) entity_id: media_player.yamaha_671_zone_2 - service: media_player.select_source data: entity_id: media_player.yamaha_671_zone_2 #   -    Audio <span class="hljs-number"><span class="hljs-number">2</span></span> -     RPi <span class="hljs-keyword"><span class="hljs-keyword">source</span></span>: AUDIO2 - service: media_player.volume_set data: entity_id: media_player.yamaha_671_zone_2 volume_level: <span class="hljs-string"><span class="hljs-string">'0.70'</span></span> - delay: <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span> - service: tts.yandextts_say #   data_template: message: <span class="hljs-string"><span class="hljs-string">" !       .    {{ states('sensor.owm_temperature')|int }} ."</span></span> #       entity_id: media_player.vlcmp # ,       language: <span class="hljs-string"><span class="hljs-string">'ru-RU'</span></span></code> </pre> <br></div></div><br>  "Hooray!  Earned!  But in order to do everything beautifully, I propose to perform one more simple action.  Create groups (tab on the frontend). <br><br>  Create a file <code>group.yaml</code> in the parent folder.  In the config, refer to it: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">group</span></span>: !<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>.yaml</code> </pre> <br>  And we proceed to filling out <code>group.yaml</code> . <br><br><div class="spoiler">  <b class="spoiler_title">Customize the display of created items</b> <div class="spoiler_text"><pre> <code class="hljs css">#         <span class="hljs-selector-tag"><span class="hljs-selector-tag">frontend</span></span>,  ,      . <span class="hljs-selector-tag"><span class="hljs-selector-tag">default_view</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">view</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">yes</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">entities</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">group</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.AlarmClock</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sensor</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.alarm_time</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sensor</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.owm_cloud_coverage</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sensor</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.owm_condition</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sensor</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.owm_humidity</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sensor</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.owm_rain</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sensor</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.owm_snow</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sensor</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.owm_temperature</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sensor</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.owm_wind_speed</span></span> #       <span class="hljs-selector-tag"><span class="hljs-selector-tag">alarmclock</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>: . <span class="hljs-selector-tag"><span class="hljs-selector-tag">entities</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sensor</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.alarm_time</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">input_slider</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.alarmhour</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">input_slider</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.alarmminutes</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">input_boolean</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.alarmweekday</span></span> # (<span class="hljs-selector-tag"><span class="hljs-selector-tag">tab</span></span>)   . <span class="hljs-selector-tag"><span class="hljs-selector-tag">AlarmClock</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>:  <span class="hljs-selector-tag"><span class="hljs-selector-tag">view</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">yes</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">entities</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">group</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.alarmclock</span></span></code> </pre><br></div></div><br>  It is time to save all our settings, restart the service and see what happened! <br><br>  At the moment I have the following components connected: <br><br>  TV, AV Receiver, TP-Link router, tracking devices, alerting me and my wife when one of us came / left the house, auto-switching on the receiver when someone first appears at home, turning off devices when everyone leaves home, temporarily: Broadlink + Livolo Switch. <br><br>  Development <br><br><ul><li>  Connect to DIY light switches </li><li>  Try to connect to a coffee machine and a kettle </li><li>  Make buttons by the bed for easier turning off the alarm! </li><li>  Create more optimal "automation" </li></ul><br>  Dear reader, I am grateful to you for your precious time!  If there is a keen interest in HASS, I will describe other possibilities with examples.  See you again! <br><br><div class="spoiler">  <b class="spoiler_title">Bibliography</b> <div class="spoiler_text">  <a href="https://home-assistant.io/">HASS official website</a> <br>  <a href="https://community.home-assistant.io/">HASS official community</a> <br>  <a href="https://ru.wikipedia.org/wiki/YAML">Yaml</a> <br>  <a href="https://telegram.me/botfather">Telegram Registration Bot</a> <br>  <a href="https://core.telegram.org/bots">Telegram how to work with the bot</a> <br>  <a href="https://tech.yandex.ru/">Yandex Technologies</a> <br>  <a href="http://openweathermap.org/">Openweathermap</a> <br>  <a href="http://jointspace.sourceforge.net/">Control Philips TVs over the network</a> <br>  <a href="https://www.raspberrypi.org/">Raspberry pi</a> <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/321606/">https://habr.com/ru/post/321606/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321596/index.html">How IT professionals work. Dmitry Tsimoshko, director of information technology at Century 21</a></li>
<li><a href="../321598/index.html">Implementation of the procedure ‚ÄúPlanning Release Release by Product‚Äù by the tools of the Atlassian family</a></li>
<li><a href="../321600/index.html">Kotlin Video Tutorial Series</a></li>
<li><a href="../321602/index.html">Procedural level generation for MERC in Unity</a></li>
<li><a href="../321604/index.html">Seminar "How much does the data center operation cost?", February 21, OST data center</a></li>
<li><a href="../321612/index.html">Evening class: resizing elements to pure JS</a></li>
<li><a href="../321614/index.html">The tale of an internship in a small company or how Kontur and I competed [Part I]</a></li>
<li><a href="../321618/index.html">Motion Detection Based on OpenCV Bioinspired Module</a></li>
<li><a href="../321620/index.html">Black magic of metaprogramming: how macros work in Rust 1.15</a></li>
<li><a href="../321622/index.html">Corporations and startups: successful cooperation models</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>