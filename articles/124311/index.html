<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The play "Developing a multiplayer online game." Part 3: Client-server interaction</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Part 1: Architecture 
 Part 2: Protocol 
 Part 4: Moving to 3D 

 With the third part, I was a little late. But as they say better late than never ......">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The play "Developing a multiplayer online game." Part 3: Client-server interaction</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/d0e62f4f/07221579/091fa0b2/8bd6c378.jpg"><br><br>  <a href="http://habrahabr.ru/blogs/gdev/123220/">Part 1: Architecture</a> <br>  <a href="http://habrahabr.ru/blogs/gdev/123748/">Part 2: Protocol</a> <br>  <a href="http://habrahabr.ru/blogs/gdev/136467/">Part 4: Moving to 3D</a> <br><br>  With the third part, I was a little late.  But as they say better late than never ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, we continue the conversation. <br><br>  In the third part of our production, we will implement the protocol, write the server and the client that will interact over the network.  And (OMG!) Tanks will ride! <br>  Under the cut that you have long wanted, but were afraid to ask ... <br><br><a name="habracut"></a><br><br>  <i>For the most snooty, let me remind you that all the code in the article does not claim to be the title ‚ÄúSuperPuperMegaFrigitelno FuckingAnable solution to all problems‚Äù.</i>  <i>The code is intended to show the main points and only.</i>  <i>It is ugly in places, is not optimal, but the nadis conveys the main essence.</i> <br><br>  Since the last article a lot has happened.  One of them is that I switched to developing for Scala under IDEA.  The reason is simple - the plug-in for NetBeans is completely lame ... Therefore, the project in bitbucket has been changed from NetBeans to IDEA, so don't be intimidated.  And although the first impressions of IDEA are not very positive, I will try to chew this cactus. <br><br><h4>  Part Three  Action one: What is there with the architector? </h4><br><br>  Recall that there with the architatura ... <br><br><img src="https://habrastorage.org/storage1/c68f345e/cb99c836/3b18f5ce/5f65cc60.png"><br><br>  She lays well on the actors in the rock.  It turns out that there will be one process (GameServer) which accepts connections and, after the connection is established, passes the channel to the Actor (ClientHandler) for processing.  Thus, an actor will be created for each client and he will be responsible for communication with the client.  To send a message to the client, we simply send it to the actor and forget, the actor will send it to the client and accept the response.  In general, the actors in the rock is a very interesting thing.  They can be created by tens of thousands, practically for everybody.  There is another implementation of the actors on the rock, the Akka project.  He is much more sophisticated.  And for real projects it makes sense to look at it. <br><br><h4>  Part Three  Step two: The data transfer protocol. </h4><br><br>  To begin, create a class player Player.  He will store the player id and his coordinates. <br><pre><code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Player</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">idd: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, xx: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, yy: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id = idd <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x = xx <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> y = yy }</code> </pre> <br><br>  We have the easiest protocol. To implement it, you need to create 2 classes.  Packet class in which the message is stored. <br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Packet</span></span></span><span class="hljs-class"> (</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> comm:</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, player: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Player</span></span></span></span><span class="hljs-class"><span class="hljs-params"> </span></span></span><span class="hljs-class">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> com = comm <span class="hljs-comment"><span class="hljs-comment">//  val id = player.id // id     val x = player.x val y = player.y }</span></span></code> </pre><br><br>  and Class encoding and decoding messages <br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Protocol</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  def encode( packet: Packet ): ByteBuffer = { val rez: ByteBuffer = ByteBuffer.allocate(16) rez.putInt(packet.com) rez.putInt(packet.id) rez.putInt(packet.x) rez.putInt(packet.y) rez } //  def decode( buffer: ByteBuffer ): Packet = { val com = buffer.getInt(0) val idd = buffer.getInt(4) val xx = buffer.getInt(8) val yy = buffer.getInt(12) val rez: Packet = new Packet( com, new Player(idd, xx, yy) ) rez } }</span></span></code> </pre><br>  The protocol implementation is ready.  As you can see, in the simplest cases, nothing terrible.  But in real projects for the invention of the bicycle there should be weight bases.  It is better to use ready-made time-tested solutions. <br><br><h4>  Part Three  Action three: Server, as much in this word ... </h4><br><br>  While we are creating a game frame.  Therefore, the server will perform purely nominal work.  Handle client connections and provide communication between clients.  In the future, we will refine it. <br><br>  Create a GameServer class <br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GameServer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Runnable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> isActive = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> selector: <span class="hljs-type"><span class="hljs-type">Selector</span></span> = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> numClients = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> port = <span class="hljs-number"><span class="hljs-number">7778</span></span> <span class="hljs-comment"><span class="hljs-comment">//              var sessions = new HashMap[ SocketChannel, Actor ] var lock: AnyRef = new Object() //            def addPlayerMsg(player: Player) { lock.synchronized { ..... } } //   def init(portt: Int) { port = portt try { selector = Selector.open println( "Selector opened" ) } catch { case e =&gt; println( "Problems during Socket Selector init: " + e ) } } override def run() { //   bindSocket( "", port) //    while ( isActive ) { Loop() } } def Loop() { if ( selector.select &gt; 0 ) { val it = selector.selectedKeys().iterator() while ( it.hasNext ) { val skey = it.next it.remove() if ( !skey.isValid ) { continue() } //  if ( skey.isAcceptable ) { val socket:ServerSocketChannel = skey.channel().asInstanceOf[ServerSocketChannel] try { numClients = numClients + 1 val channel = socket.accept channel.configureBlocking(false) channel.register(selector, SelectionKey.OP_READ) //      val player = new Player(numClients, numClients * 20, numClients * 20) val actor = new ClientHandler(player, channel) actor.start() //      val packet = new Packet( 0, player) actor.packets += packet //     sessions += channel -&gt; actor println( "Accepted connection from:" + channel.socket().getInetAddress + ":" + channel.socket().getPort ) } catch { case e: Exception =&gt; println( "Game Loop Exception: " + e.getMessage ) } } //            else { val channel:SocketChannel = skey.channel.asInstanceOf[SocketChannel] val actor = sessions.get(channel).get.asInstanceOf[ClientHandler] if ( actor.packets.size &gt; 0 ) { skey.interestOps(SelectionKey.OP_WRITE) } actor ! skey } } } } def close(remoteAddress:String, channel:SocketChannel) { channel.close(); println("Session close: " + remoteAddress); } //   def bindSocket(address: String, port: Int) { try { //   val hostAddr: InetAddress = null val isa = new InetSocketAddress(hostAddr, port) val serverChannel = ServerSocketChannel.open serverChannel.configureBlocking(false) serverChannel.socket.bind(isa) serverChannel.socket.setReuseAddress(true) serverChannel.register(selector, SelectionKey.OP_ACCEPT ) println( "Listening game on port: " + port ) } catch { case e: IOException =&gt; println("Could not listen on port: " + port + ".") System.exit(-1) case e =&gt; println("Unknown error " + e) System.exit(-1) } } }</span></span></code> </pre><br>  The server turned out simple as a perpendicular.  It runs in a separate thread.  Bread does not ask.  Only the work with clients is shown here.  There are no parts processing the correct connection / disconnection of clients.  No session management.  But this is already everyone can modify how he likes. <br><br><h4>  Part Three  The fourth act: Actor is still Actor. </h4><br><br>  Now create an Actor that will handle the client connection. <br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClientHandler</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">player: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Player</span></span></span></span><span class="hljs-class"><span class="hljs-params">, chanel:</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">SocketChannel</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Actor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> player_id = player.id <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> channel = chanel <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> remoteAddress = channel.socket().getRemoteSocketAddress.toString <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> packets = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">HashSet</span></span>[ <span class="hljs-type"><span class="hljs-type">Packet</span></span> ] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">act</span></span></span></span>() { loop { receive { <span class="hljs-comment"><span class="hljs-comment">//   case key: SelectionKey =&gt; { try { //   if (key.isReadable) { val buffer = ByteBuffer.allocate(16) channel.read(buffer) match { case -1 =&gt; close(remoteAddress, channel) case 0 =&gt; case x =&gt; processMessageRead(key, buffer) } } //   else if (key.isWritable) { packets.synchronized { for(packet &lt;- packets) { processMessageWrite( Protocol.encode(packet) ) packets.remove(packet) } } if(packets.isEmpty) key.interestOps(SelectionKey.OP_READ) } } catch { case e: SocketException =&gt; println("ClientHandler SocketException error " + e.getMessage) case e: IOException =&gt; println("ClientHandler IOException error " + e.getMessage) case e =&gt; println("ClientHandler Unknown error " + e.getMessage) } } } } } //    def processMessageRead(key: SelectionKey, buffer: ByteBuffer) { if ( buffer.limit() == 0 ) { return } buffer.flip val protocol = Protocol.decode( buffer ) println( "Client : " + player.id + " - " + new Date + " - " + "com:" + protocol.com + " x:" + protocol.x + " y:" + protocol.y ) player.x = protocol.x player.y = protocol.y buffer.clear if (protocol.com == 0) { key.interestOps(SelectionKey.OP_WRITE) } else if (protocol.com == 1) { GameServer.addPlayerMsg(player) } } //    def processMessageWrite(buffer: ByteBuffer) { if ( buffer.limit() == 0 ) { return } buffer.flip channel.write(buffer) println( "Client write: " + player.id + " - " + new Date + " - " + buffer.array().mkString(":") ) buffer.clear } def close(remoteAddress: String, channel: SocketChannel) { channel.close() println("Session " + player.id + " close: " + remoteAddress) } }</span></span></code> </pre><br>  Actor turned out simple as a stick.  He only receives messages and sends them. <br><br>  For load testing, I launched the server on a rather weak laptop (1.3 GHz, AMD, WiFi 56Mbit).  And as a client, I created a console java application that runs the specified number of threads, and in each continuously, without a pause, sends packets to the server.  The client was launched on the desktop (3.6 GHz, 4 cores) in 100 threads. <br>  As a result, the server digested about 6000 messages per second.  Which is not bad in general.  Depending on the computational load, on a real server hardware, it will be able to hold several thousand clients. <br><br><h4>  Part Three  Step Five: The client ... and who else? </h4><br><br>  The client from the last part has not changed.  Only the player‚Äôs graphic display in the form of a tank and protocol implementation was added. <br><br>  Add a class describing the player <br><pre> <code class="scala hljs"> public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Player</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MovieClip</span></span></span><span class="hljs-class"> </span></span>{ public <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-type"><span class="hljs-type">Name</span></span>:<span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"Player"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id:int = <span class="hljs-number"><span class="hljs-number">0</span></span>; [<span class="hljs-type"><span class="hljs-type">Embed</span></span>(source = '../../../../lib/tank.png')] public <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _tank: <span class="hljs-type"><span class="hljs-type">Class</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tank:<span class="hljs-type"><span class="hljs-type">Bitmap</span></span>; public function <span class="hljs-type"><span class="hljs-type">Player</span></span>() { width = <span class="hljs-number"><span class="hljs-number">30</span></span>; height = <span class="hljs-number"><span class="hljs-number">30</span></span>; tank = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> _tank(); tank.width = <span class="hljs-number"><span class="hljs-number">30</span></span>; tank.height = <span class="hljs-number"><span class="hljs-number">30</span></span>; addChild(tank); } }</code> </pre><br>  And also we will add the methods implementing the protocol. <br><pre> <code class="scala hljs"> <span class="hljs-comment"><span class="hljs-comment">//  public function sendMessage(val:int):void { if (socket.connected) { var bytes:ByteArray = new ByteArray(); bytes.writeInt(val); bytes.writeInt(player.id); bytes.writeInt(player.x); bytes.writeInt(player.y); socket.writeBytes( bytes, 0, 16); socket.flush(); } } //    private function dataHandler(e:ProgressEvent):void { var bytes:ByteArray = new ByteArray(); socket.readBytes(bytes, 0, 16); var com:int = bytes.readInt(); var id:int = bytes.readInt(); var x:int = bytes.readInt(); var y:int = bytes.readInt(); switch (com) { //   case 0: ‚Ä¶ //  case 1: ... } }</span></span></code> </pre><br><br>  Here is the basic interaction between the client and the server. <br><br>  The issues of correct connection / disconnection of clients are not resolved, clients are synchronized (because of which the tanks are twitching while moving).  All this awaits us in the following parts ... <br><br>  PS Too much code ... can remove a part and leave only a description of the methods? <br><br>  As always, all the sources can be viewed on <a href="https://github.com/solverit/mserver">Github</a> </div><p>Source: <a href="https://habr.com/ru/post/124311/">https://habr.com/ru/post/124311/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../124300/index.html">Mozilla is developing an alternative to OpenID</a></li>
<li><a href="../124302/index.html">Configure Kannel SMS Gateway</a></li>
<li><a href="../124305/index.html">Create an email newsletter that sells</a></li>
<li><a href="../124306/index.html">BitTorrent Inc will release a paid version of uTorrent</a></li>
<li><a href="../124310/index.html">DoS vulnerability in Open vSwitch</a></li>
<li><a href="../124312/index.html">Amateur radio community</a></li>
<li><a href="../124313/index.html">Each hosting by audio player</a></li>
<li><a href="../124314/index.html">Do search engines make us lazier?</a></li>
<li><a href="../124315/index.html">Google Docs Viewer now supports ZIP and RAR formats.</a></li>
<li><a href="../124317/index.html">Why doesn‚Äôt a standard vSwitch need a Spanning Tree protocol?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>