<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JMock and EasyMock: comparison and howto in examples and not only</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It is practically no secret to anyone that when testing code that uses some external components, they often use the mock-objects approach. For those w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JMock and EasyMock: comparison and howto in examples and not only</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/628/9d0/7a6/6289d07a6667adaf90e0ad656eea3d7d.jpg" align="left">  It is practically no secret to anyone that when testing code that uses some external components, they often use the mock-objects approach.  For those who still do not know about it, briefly explain: these are objects that have the same interface as the components used, but their behavior is fully defined in the test, and their use avoids raising the full infrastructure required for the application to run .  More importantly, you can easily and unconditionally check that the code called certain methods on a mock object with certain arguments. <br><br>  In this article, I will conduct a comparative analysis of two common libraries for working with mocks in Java: <a href="http://easymock.org/">EasyMock</a> and <a href="http://www.jmock.org/">JMock</a> .  Awareness of <a href="http://junit.org/">JUnit's</a> basic knowledge is enough, and after reading this article you will have a very good idea of ‚Äã‚Äãhow to use both of these libraries. <a name="habracut"></a><br><br><h1>  Task </h1>  As an example of what needs to be tested, we will consider some application that has approximately the following structure: <table><tbody><tr><td><pre><code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span></code> </pre> </td><td><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WayTooComplexClass</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WayTooComplexClass</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String serverAddress)</span></span></span><span class="hljs-function"> </span></span>{<span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span>} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id, String data)</span></span></span><span class="hljs-function"> </span></span>{<span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span>} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id)</span></span></span><span class="hljs-function"> </span></span>{<span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span>} }</code> </pre></td></tr></tbody></table>  Let the implementation hidden in ellipses use any service that has a simple HTTP API (for example, <a href="http://www.ioremap.net/projects/elliptics">elliptics</a> ) as storage.  In order to keep this server constantly somewhere in tests, there are at least two problems: <ol><li>  It is necessary that from each machine on which the test is run, there is access to this server. </li><li>  The description of the mock-server behavior is out of the code, and therefore various troubles can arise, especially if one developer updates the test in the code and on the server, and the other does not update, and the test that took place yesterday, will suddenly break </li></ol>  Some people give up at this moment, say that their <i>‚Äúcode is too complicated for Unit-tests‚Äù ‚Ñ¢</i> , and they are hammered into writing.  Fortunately, we are not one of those, and therefore we will raise a small HTTP server directly from the test, which will respond to the necessary requests as needed.  In this example, I used <a href="http://jetty.codehaus.org/jetty/">jetty</a> for such purposes.  Such code will be common when using both mock libraries: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  Mock-server for testing <sup>(you can not read)</sup> </h1><table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">26</span></span> <span class="hljs-number"><span class="hljs-number">27</span></span> <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-number"><span class="hljs-number">29</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">33</span></span> <span class="hljs-number"><span class="hljs-number">34</span></span> <span class="hljs-number"><span class="hljs-number">35</span></span> <span class="hljs-number"><span class="hljs-number">36</span></span> <span class="hljs-number"><span class="hljs-number">37</span></span> <span class="hljs-number"><span class="hljs-number">38</span></span> <span class="hljs-number"><span class="hljs-number">39</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">41</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span> <span class="hljs-number"><span class="hljs-number">44</span></span> <span class="hljs-number"><span class="hljs-number">45</span></span> <span class="hljs-number"><span class="hljs-number">46</span></span> <span class="hljs-number"><span class="hljs-number">47</span></span></code> </pre></td><td><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WayTooComplexClassTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RequestHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String target, String data)</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MockHttpServerHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> RequestHandler handler; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setRequestHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RequestHandler handler)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handler = handler; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String target, HttpServletRequest request, HttpServletResponse response, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dispatch )</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException, ServletException </span></span>{ String req = IOUtils.toString(request.getInputStream(), <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>); String result = handler.handle(target, req); response.setStatus(HttpStatus.ORDINAL_200_OK); response.setContentType(<span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ServletOutputStream outputStream = response.getOutputStream(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { outputStream.print(result); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { outputStream.close(); } } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MockHttpServerHandler SERVER_HANDLER = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MockHttpServerHandler(); <span class="hljs-meta"><span class="hljs-meta">@BeforeClass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startServer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ org.mortbay.jetty.Server server = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> org.mortbay.jetty.Server(); server.setHandler(SERVER_HANDLER); server.start(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> WayTooComplexClass wayTooComplex = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WayTooComplexClass(<span class="hljs-string"><span class="hljs-string">"http://localhost/9001"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//Tests go here }</span></span></code> </pre></td></tr></tbody></table>  Here we have three interesting points.  The first one is lines 3-5, describing the <b><code>RequestHandler</code></b> interface, which receives the purpose of the request ( <font color="grey">for example, in the address <font>http:</font> // habrahabr <font>.ru</font> <b>/ blogs / java / 136466 / the</b> goal will be highlighted in bold <b>/ blogs / java / 136466 /</b></font> ) and data sent by the user in the request body.  The second, lines 7 through 32, is the <b><code>MockHttpServerHandler</code></b> class.  <b><code>RequestHandler</code></b> installed to <b><code>RequestHandler</code></b> , to which all ‚Äúbusiness logic‚Äù is delegated, and the result of its work is recorded in the HTTP response.  And the third, lines 36-41, is the <b><code>startServer</code></b> method, which, as you can guess from the annotations and names, is called before any tests listed in this class are started and starts the HTTP server. <br><br><h1>  The first and easiest test </h1>  Suppose that, in theory, the code hidden in the save method must pass through <b><code>{serverAddress}/upload/{id}</code></b> and transfer <b><code>data</code></b> .  Check if this happens in reality. <br><br><h2>  JMock </h2><table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span></code> </pre></td><td><pre> <code class="java hljs">Mockery context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JUnit4Mockery(); <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testSaveWithJMock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> id = <span class="hljs-number"><span class="hljs-number">13</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String data = <span class="hljs-string"><span class="hljs-string">"nanofilters"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> RequestHandler requestHandler = context.mock(RequestHandler.class); context.checking(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Expectations() {{ one(requestHandler).handle(<span class="hljs-string"><span class="hljs-string">"/upload/"</span></span> + id, data); will(returnValue(<span class="hljs-string"><span class="hljs-string">"Saved "</span></span> + id)); }}); SERVER_HANDLER.setRequestHandler(requestHandler); wayTooComplex.save(id, data); context.assertIsSatisfied(); }</code> </pre></td></tr></tbody></table><br>  In the first line, we need to create a JMock context in which the test will run.  This context is enough for the whole test, but to <font color="darkred"><b>do without it in any way</b></font> .  To avoid problems with several mocks of the same one, the context should be recreated before each test (that is, inside the method marked with the <code><b>@Before</b></code> annotation) In the eighth line we easily and naturally create a mock for our interface.  Next, in lines 10-13, we describe which calls should occur.  At first glance, the syntax is <font color="darkred"><b>not very intuitive</b></font> , but eventually you get used to it.  In line 11, we indicated that we expect exactly one call to the <b><code>handle</code></b> method with arguments <b><code>("/upload/" + id)</code></b> and <b><code>(data)</code></b> .  In line 12, we say that the last call will return the value <b><code>("Saved " + id)</code></b> .  Here, as you can guess, <font color="darkred"><b>there is no typical security</b></font> .  We can casually transfer there the value of the wrong type and find out about it only in runtime, by getting an exception.  But if the return value is not important, then you can not write this at all: JMock automatically returns the default value ( <code><b>0</b></code> , <code><b>false</b></code> , <code><b>null</b></code> or an empty string).  Next, we tell our mock server to use the newly created mock handler, call the application under test method and check in line 19 that all the expected calls were made.  <font color="darkgreen"><b>You can get rid of the latter by</b></font> adding the <b><code>@RunWith(JMock.class)</code></b> annotation <b><code>@RunWith(JMock.class)</code></b> to the test class <b><code>@RunWith(JMock.class)</code></b> <br><br><h2>  Easymock </h2><table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span></code> </pre></td><td><pre> <code class="java hljs">IMocksControl control = EasyMock.createControl(); <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testSaveWithEasyMock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> id = <span class="hljs-number"><span class="hljs-number">15</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String data = <span class="hljs-string"><span class="hljs-string">"cold fusion reactor"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> RequestHandler requestHandler = control.createMock(RequestHandler.class); expect(requestHandler.handle(<span class="hljs-string"><span class="hljs-string">"/upload/"</span></span> + id, data)).andReturn(<span class="hljs-string"><span class="hljs-string">"Saved "</span></span> + id); control.replay(); SERVER_HANDLER.setRequestHandler(requestHandler); wayTooComplex.save(id, data); control.verify(); }</code> </pre></td></tr></tbody></table>  In the first line, we create control, which is an analogue of the JMock context.  Further in the eighth line we create a mock object, in the tenth we indicate that we expect a call to the handle method with certain arguments and say in this case return a certain value.  There <font color="darkgreen"><b>is a typical security</b></font> : an attempt to pass an argument of a type other than String to andReturn will result in a compilation error. <br>  With my EasyMock, from my point of view, the <font color="darkgreen"><b>specification of the expected behavior is more understandable</b></font> .  This approach, however, has a drawback: as you can see in line 11, <font color="darkred"><b>it is necessary to clearly indicate that the record of the expected behavior is completed</b></font> .  After all the "business logic" we reach line 17 and check that all expected methods have been called.  By the way, if we don‚Äôt care what the method returns, then <font color="darkgreen"><b>for void-methods we can omit the <code><b>expect</b></code> construct</b></font> and simply make the call: <code><b>requestHandler.handle("/upload/" + id, data)</b></code> .  In addition, <b><font color="darkgreen">it is not necessary to use <code><b>control</b></code></font></b> , and you can simply do this: <table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span></code> </pre></td><td><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> RequestHandler requestHandler = EasyMock.createMock(RequestHandler.class); <span class="hljs-comment"><span class="hljs-comment">//... EasyMock.replay(requestHandler); //... EasyMock.verify(requestHandler);</span></span></code> </pre></td></tr></tbody></table><br><br><h1>  More complex response to method calls </h1><br>  Suppose now that we need to test that our application behaves correctly and when an external component fails.  To do this, it is enough to organize an exception in the <code><b>handle</b></code> method, and then jetty will set http status 500 itself. <br><br><h2>  JMock </h2><table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span></code> </pre></td><td><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testErrorHandlingWithJMock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... context.checking(new Expectations() {{ one(requestHandler).handle("/upload/" + id, data); will(throwException(new RuntimeException("Somebody set up us the bomb."))); }}); }</span></span></code> </pre></td></tr></tbody></table>  Nothing complicated.  I think comments are superfluous.  You can only add that out of the box <code><b>will</b></code> still know how to <code><b>returnIterator</b></code> , but you can arrange something of your own by implementing the <b><code>Action</code></b> interface.  True, it is <font color="darkred"><b>not very clear, and the documentation is not so hot</b></font> . <br><br><h2>  Easymock </h2><table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre></td><td><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testErrorHandlingWithEasyMock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... expect(requestHandler.handle("/upload/" + id, data)) .andThrow(new RuntimeException("All your base are belong to us.")); }</span></span></code> </pre></td></tr></tbody></table>  Here, too, everything is simple, but, as you probably already suspect, if the method returns nothing (that is, it has the void type), you have to write differently, and the <font color="darkred"><b>commonality of the style is lost</b></font> .  It would look like this: <table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre></td><td><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testErrorHandlingWithEasyMock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... requestHandler.handle("/upload/" + id, data); expectLastCall() .andThrow(new RuntimeException("You have no chance to survive make your time.")); }</span></span></code> </pre></td></tr></tbody></table>  Besides <b><code>andThrow</code></b> you can also use <b><code>andDelegateTo</code></b> , which, as you might guess, <font color="darkgreen"><b>delegates the method call to some other object</b></font> ( <font color="darkred"><b>there is no typical security at compile time!</b></font> ) <b><code>andAnswer</code></b> .  For the latter, you need to implement an <code><b>IAnswer</b></code> interface, and write any code inside the <code><b>answer</b></code> method.  There is a little less power than JMock, but much, much more convenience. <br><br><h1>  Matching arguments when calling a method </h1><br>  Now suppose that we do not know exactly which arguments should be passed to the call to the mocked method.  The only thing we are sure about is that the <b><code>target</code></b> argument must contain an <b><code>id</code></b> somewhere. <br><br><h2>  JMock </h2><table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span></code> </pre></td><td><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testArgumentMatchingWithJMock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... context.checking(new Expectations() {{ one(requestHandler).handle(with(containsString(String.valueOf(id))), anything()); }}); }</span></span></code> </pre></td></tr></tbody></table>  JMock <font color="darkgreen"><b>uses hamcrest matchers</b></font> and allows you to add something non-standard blackjack to write your matcher. <br><br><h2>  Easymock </h2><table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre></td><td><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testArgumentMatchingWithEasyMock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... expect(requestHandler.handle(contains(String.valueOf(id)), anyObject(String.class))) .andReturn(null); }</span></span></code> </pre></td></tr></tbody></table>  It uses its own matcher, and therefore the <font color="darkred"><b>set of ready-made matcher is less</b></font> .  However, what is already done is done fairly decently and satisfies all basic needs, and the rest is exactly the same as in JMock, you can satisfy it by implementing the necessary matcher yourself. <br><br><h1>  Number of calls </h1>  Now let's change the conditions a bit, saying that some method should be called several times.  The example has become quite far from reality, but I don‚Äôt want to invent a more vital one solely to show something simple. <br><br><h2>  JMock </h2><table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span></code> </pre></td><td><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testMultipleInvocationsWithJMock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... context.checking(new Expectations() {{ between(2, 5).of(requestHandler).handle(anything(), anything()); }}); }</span></span></code> </pre></td></tr></tbody></table>  As the attentive reader could guess, in all the previous examples the word <code><b>one</b></code> was not just like that, but indicated how many challenges to expect.  It supports all the necessary number of calls: whether it is zero or not care how many. <br><br><h2>  Easymock </h2><table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre></td><td><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testMultipleInvocationsWithEasyMock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... expect(requestHandler.handle(anyObject(String.class), anyObject(String.class))) .andReturn(null).times(2, 5); }</span></span></code> </pre></td></tr></tbody></table>  Here, too, everything is quite simple, but there is a small minus: <b><font color="darkred">there is no possibility to say "at least n times" without restriction from above</font></b> .  This is slightly strange, given that the <b><code>atLeastOnce</code></b> method is.  To expect at least three calls, you need to write something like this code: <br><br><table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span></code> </pre></td><td><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testMultipleInvocationsWithEasyMock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... expect(requestHandler.handle(anyObject(String.class), anyObject(String.class))) .andReturn(null).times(3); expectLastCall().andReturn(null).anyTimes(); }</span></span></code> </pre></td></tr></tbody></table><br><br><h1>  Stubs </h1><br>  It often happens that, in principle, it is not very important for us how and when a method will be called, but it is only interesting that it existed and returned something. <br><br><h2>  JMock </h2><table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span></code> </pre></td><td><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testStubMethodsWithJMock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... context.checking(new Expectations() {{ allowing(requestHandler).handle(anything(), anything()); will(returnValue("There will be cake")); }}); }</span></span></code> </pre></td></tr></tbody></table>  It is noticeable that this is done <font color="darkgreen"><b>uniformly</b></font> with the determination of the number of times.  Instead of <b><code>allowing</code></b> you to say <code><b>ignoring</b></code> .  Also, if you wish, it is easy to make the entire Mock object one big stub: <table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span></code> </pre></td><td><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testStubObjectsWithJMock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... context.checking(new Expectations() {{ allowing(requestHandler); }}); }</span></span></code> </pre></td></tr></tbody></table><br><h2>  Easymock </h2><table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre></td><td><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testStubMethodsWithEasyMock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... expect(requestHandler.handle(anyObject(String.class), anyObject(String.class))) .andStubReturn("Greetings, human."); }</span></span></code> </pre></td></tr></tbody></table>  Slightly less uniform in style, but also quite comfortable.  But you can make an object with a gag only when creating: <table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span></code> </pre></td><td><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testStubObjectsWithEasyMock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> RequestHandler requestHandler = createNiceMock(RequestHandler.class); <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre></td></tr></tbody></table>  Methods then, when called, will return the default value for their type ( <code><b>0</b></code> , <code><b>false</b></code> or <code><b>null</b></code> ).  <font color="darkred"><b><code>null</code> will be returned including for <code>String</code></b></font> , whereas in JMock the default value for this class is the empty string. <br><br><h1>  Checking the order of calling </h1><br>  Often it is important in which order the methods are called.  Suppose we got paranoid and immediately after downloading the file we decided to download it back and compare it with the reference one.  You can make sure that the application does it <font color="grey">(and then you never know, it does not cause much confidence ...)</font> , you can: <br><br><h2>  JMock </h2><table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span></code> </pre></td><td><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testStrictOrderingWithJMock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... final Sequence paranoia = context.sequence("shhh-they-are-watching-us"); context.checking(new Expectations() {{ one(requestHandler).handle("/upload/" + id, data); will(returnValue("Saved " + id)); inSequence(paranoia); one(requestHandler).handle("/get/" + id, ""); will(returnValue(data)); inSequence(paranoia); }}); }</span></span></code> </pre></td></tr></tbody></table>  Here we are interested in lines 9 and 13, in which we, in fact, check the order of execution.  It is important to remember that <code><b>inSequence</b></code> will only follow the order of the call of the mock object that is immediately specified.  Therefore, in order to track that ten different calls will be made in a strict order, you have <b><font color="darkred">to write <code><b>inSequence</b></code> ten times</font></b> .  But <b><font color="darkgreen">you can hang on the call several sequences</font></b> . <br><br><h2>  Easymock </h2><table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span></code> </pre></td><td><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testStrictOrderingWithEasyMock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... EasyMock.checkOrder(requestHandler, true); EasyMock.expect(requestHandler.handle("/upload/" + id, data)).andReturn("Saved " + id); EasyMock.expect(requestHandler.handle("/get/" + id, "")).andReturn(data); }</span></span></code> </pre></td></tr></tbody></table>  It's all a little simpler: <b><font color="darkgreen">you can turn on and off the</font></b> test <b><font color="darkgreen">several times for each mock separately</font></b> .  In addition, the <b><font color="darkgreen">whole <code><b>control</b></code> can be strict</font></b> (see the first example), and then the general order will be checked for all the mocks included in it.  In addition, mock or control <b><font color="darkgreen">can be made strict immediately upon creation</font></b> , by saying <code><b>createStrictMock</b></code> .  Of course, this amount of green needs to be diluted with a serious minus: one mock (or control) <b><font color="darkred">cannot take part in several sequences</font></b> .  There is even no such thing. <br><br><h1>  Conditions under which the method call is allowed </h1><br>  In some cases, it is necessary to simulate the state of the application, which will change when calling some methods, and be checked when calling some other (or the same).  Let our application contact one of the two elliptics instances (the instances are called panola and yarbo) to download the file, and then have to download it from the same instance it downloaded.  This can also be checked: <br><br><h2>  JMock </h2><table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span></code> </pre></td><td><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testStatesWithJMock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... final States progress = context.states("progress").startsAs("none"); context.checking(new Expectations() {{ one(requestHandler).handle("/panola/upload/" + id, data); will(returnValue("Saved " + id)); when(progress.is("none")); then(progress.is("panola")); one(requestHandler).handle("/yarbo/upload/" + id, data); will(returnValue("Saved " + id)); when(progress.is("none")); then(progress.is("yarbo")); one(requestHandler).handle("/panola/get/" + id, ""); will(returnValue(data)); when(progress.is("panola")); then(progress.is("done")); one(requestHandler).handle("/yarbo/get/" + id, ""); will(returnValue(data)); when(progress.is("yarbo")); then(progress.is("done")); }}); }</span></span></code> </pre></td></tr></tbody></table>  You need to look at lines 9, 13, 17 and 21. In each of them, we check with <code><b>when</b></code> that the application is now in the correct state, and then set a new one with <code><b>then</b></code> .  <b><font color="darkgreen">Very comfortable</font></b> .  Proponents of the paradigm of automaton programming, probably, now think that they have found a way to test their dreams. <br><br><h2>  EasyMock: <font color="darkred">no analog</font> </h2><br><br><h1>  Testing multi-threaded code </h1><br>  Generally speaking, testing a multi-threaded code is very, very difficult, because there are a lot of different combinations of when a particular thread performs an action.  Especially if you do not declare all critical sections, but try to do with a minimum of locks.  Abstracting now from our wonderful application, and look directly at how things are going with the multithreading support of different libraries. <br><br><h2>  JMock </h2><br>  Honestly, for me it was a terrible torment: the documentation on this issue <font color="grey">(as, indeed, on many others) is</font> pretty fig, and therefore I had to do it by trial and error <font color="grey">(and since then I was in Amsterdam, and also at the airport , it was not so easy)</font> .  As a result, I was saved manually by the downloaded version of JMock 2.6.0-RC2 with the manually downloaded version of hamcrest-core 1.3.0RC1 and the following code: <table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span></code> </pre></td><td><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Synchroniser synchroniser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Synchroniser(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Mockery context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JUnit4Mockery() {{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setThreadingPolicy(synchroniser); }}; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testConcurrencyWithJMock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... final States progress = context.states("progress").startsAs("none"); context.checking(new Expectations() {{ //check something then(progress.is("done")); }}); //do something in multiple threads synchroniser.waitUntil(states.is("done"), TimeUnit.SECONDS.toMillis(1)); }</span></span></code> </pre></td></tr></tbody></table>  Here, in the first line, we create a new synchronizer, in the third we tell the context to use it, and in the 17th we wait for all the necessary operations to be performed.  The fact that the <b><font color="darkgreen">States can do this</font></b> is very cool, and in some cases eliminates the need to wait until the application finishes its work. <br><br><h2>  Easymock </h2><br>  There is full support for multithreading out of the box.  Moreover, it <b><font color="darkgreen">can be disabled</font></b> by using <code><b>makeThreadSafe(mock, false)</b></code> while writing, and if necessary, <b><font color="darkgreen">check that the mock was used from one thread</font></b> , saying <code><b>checkIsUsedInOneThread(mock, true)</b></code> <br><br><h1>  Mocking classes </h1><br>  Sometimes it turns out that the developer of the module that needs to be replaced with mock in the test did not bother to make the interface, and we only have a specific class.  Fortunately, if this class is not final and has no final methods, then we can easily mock it. <br><br><h2>  JMock </h2><table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span></code> </pre></td><td><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Mockery context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JUnit4Mockery() {{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setImposteriser(ClassImposteriser.INSTANCE); }}; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testClassMockingWithJMock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre></td></tr></tbody></table>  All you need to do is call the <code><b>setImposteriser</b></code> method in the context.  In the example, this happens in the second line. <br><br><h2>  Easymock </h2><table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre></td><td><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.easymock.classextension.EasyMock.*; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testClassMockingWithEasyMock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre></td></tr></tbody></table>  It is enough to use methods from another class, which, however, is in another maven artifact.  However, with classextension, you can easily create mocks for both classes and interfaces. <br><br><h1>  Partial mocking </h1><br>  Still sometimes it may be necessary to make a mock only for a part of the class methods, without touching the rest. <br><br><h2>  JMock: <font color="darkred">there is no such possibility</font> </h2><br><br><h2>  Easymock </h2><table><tbody><tr><td><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span></code> </pre></td><td><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testPartialMockingWithEasyMock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... IntArraySorter sorter = EasyMock.createMockBuilder(IntArraySorter.class) .addMockedMethod("sort", int[].class).createMock(); //... }</span></span></code> </pre></td></tr></tbody></table>  Everything is simple and clear.  You can also specify which parameters to pass to which constructor.  All non-mocked methods will be delegated to this class. <br><br><h1>  Conclusion </h1>  This completes the examples and comparisons.  I hope everyone who has read this far now knows how to use both libraries well, and in the future, using the acquired skills, will save themselves from many mistakes. <br><br>  Perhaps the reader is waiting here for an answer from me to the question ‚ÄúSo what is better for me to use in my project?  JMock or EasyMock?  The answer here is very simple and unambiguous: ‚ÄúIt depends on the requirements of the project.  Each of these libraries is a tool, and each of them needs to be able to use, and one must be chosen for a specific task. ‚Äù <br><br>  That's all.  Waiting for interesting questions and comments! </div><p>Source: <a href="https://habr.com/ru/post/136466/">https://habr.com/ru/post/136466/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../136460/index.html">A simple Dropbox based blog service.</a></li>
<li><a href="../136461/index.html">Controller Hierarchy</a></li>
<li><a href="../136463/index.html">Application for drawing under the Android</a></li>
<li><a href="../136464/index.html">Details about the ReFS (Protogon) file system</a></li>
<li><a href="../136465/index.html">Microsoft and Skype</a></li>
<li><a href="../136467/index.html">The play "Developing a multiplayer online game." Part 4: Moving into 3D</a></li>
<li><a href="../136468/index.html">Oracle on the way to decline</a></li>
<li><a href="../136469/index.html">Code Review and Probability Theory</a></li>
<li><a href="../136471/index.html">We create our own framework based on symfony2. (Part 3)</a></li>
<li><a href="../136472/index.html">Be a voice, not an echo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>