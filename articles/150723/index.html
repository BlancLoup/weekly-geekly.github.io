<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JavaScript: the delete operator creates a leak !?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, I want to tell you about the history of insidious leakage, and about the great misunderstanding. 
 In fact, everything is very simple, such a s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JavaScript: the delete operator creates a leak !?</h1><div class="post__text post__text-html js-mediator-article">  Hello, I want to tell you about the history of insidious leakage, and about the great misunderstanding. <br>  In fact, everything is very simple, such a seemingly ordinary line of code that, <b>under certain conditions,</b> can cause a leak: <br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> testedObject[ i ].obj;</code> </pre> <br>  But, I repeat only in certain conditions.  One more thing, for the time being, it is not exactly known whether this is a browser bug or a JS feature. <br>  Google said nothing to me about this. Digging into the ECMAScript specification also did nothing, because it is difficult to understand in a sober state.  Actually this was the reason for writing this article. <br><br><a name="habracut"></a><br><h4>  Prehistory </h4><br>  So, I started working on project X, for one firm Y. They needed a management system for the firm, employees, etc., all in one package.  The whole thing had to work through the browser.  It was decided to write this miracle on JS.  The specificity of the application is such that the tab could be open all day, and actively used.  Therefore, we fought for every kilobyte of memory and every millisecond of CPU time.  The frameworks didn‚Äôt cope with this task, and I had to write my bikes, and then miracles began! <br><br><h4>  The essence </h4><br>  After the next portion of the finished piece of the application, testing began, and oh God, the application slowly eats memory and does not want to stop.  And in all browsers polls.  For Fox, the most fatal outcome is that closing the tab does not help, and the memory remains eaten.  At first, I sinned on my bike, but after a while I got to the bottom of the truth and realized that it was all about the delete operator. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At first, I was "delighted" that I found another bug browser.  But then he was tormented by doubts, because it can‚Äôt be such that all browsers polls run.  Yes, and in large frameworks, the delete operator is very actively used. <br><br>  Therefore, I began to compromise a leak in jQuery, I suffered for a couple of hours, but there was no leakage.  What is the matter, looked into the jQuery code and did not find any magic there.  Well, okay, I thought, I created a new file, made a prototype of the function where there is a leak, and began to deal with obscenities with it. <br><br><div class="spoiler">  <b class="spoiler_title">Actually prototype code, with leak</b> <div class="spoiler_text"><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> count = </span><span class="hljs-number"><span class="actionscript"><span class="hljs-number">100000</span></span></span><span class="actionscript">; </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> testedObject; </span><span class="hljs-function"><span class="hljs-keyword"><span class="actionscript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="actionscript"><span class="hljs-function"><span class="hljs-title">getObject</span></span></span></span><span class="hljs-params"><span class="actionscript"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span></span><span class="actionscript">{ </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">//    return { first: { val : 'tratata', item : { val : 'tratata' } }, second: { val : 'tratata', item : { val : 'tratata' } }, third: { val : 'tratata', item : { val : 'tratata' } }, fourth: { val : 'tratata', item : { val : 'tratata' } }, fifth: { val : 'tratata', item : { val : 'tratata' } }, sixth: { val : 'tratata', item : { val : 'tratata' } }, seventh: { val : 'tratata', item : { val : 'tratata' } }, eighth: { val : 'tratata', item : { val : 'tratata' } }, ninth: { val : 'tratata', item : { val : 'tratata' } } }; } //   function fillArray() { testedObject = {}; for( var i = 0; i &lt; count; i++ ) { testedObject[ i ] = { obj : getObject() }; } } //   function deleteObjects() { for( var i = 0; i &lt; count; i++ ) { delete testedObject[ i ].obj; } } </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fillArray()"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"deleteObjects()"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br><br>  Screen leakage: <br><img src="https://habrastorage.org/storage2/085/d0c/0a9/085d0c0a9b841b242766430959ab52af.jpg"><br><br>  On the screen you can clearly see that at the moment of deletion of objects, the memory is somehow otzhiraetsya, but then released to its previous state.  But still, the memory allocated for objects that have been deleted has not been cleared. <br><br>  At the same time, the delete operator behaves quite normally, does not swear and does not scream, objects seem to be deleted and everything is normal, but the memory occupied by them is not released. <br><br><h4>  Off the drain </h4><br>  Some time later, I realized that everything is quite simple, and the leakage can be avoided, but I will have to rebuild the code a little. <br>  The memory is cleared if you do this: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> testedObject[ i ];</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Leak free option</b> <div class="spoiler_text"><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> count = </span><span class="hljs-number"><span class="actionscript"><span class="hljs-number">100000</span></span></span><span class="actionscript">; </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> testedObject; </span><span class="hljs-function"><span class="hljs-keyword"><span class="actionscript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="actionscript"><span class="hljs-function"><span class="hljs-title">getObject</span></span></span></span><span class="hljs-params"><span class="actionscript"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span></span><span class="actionscript">{ </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">//    return { first: { val : 'tratata', item : { val : 'tratata' } }, second: { val : 'tratata', item : { val : 'tratata' } }, third: { val : 'tratata', item : { val : 'tratata' } }, fourth: { val : 'tratata', item : { val : 'tratata' } }, fifth: { val : 'tratata', item : { val : 'tratata' } }, sixth: { val : 'tratata', item : { val : 'tratata' } }, seventh: { val : 'tratata', item : { val : 'tratata' } }, eighth: { val : 'tratata', item : { val : 'tratata' } }, ninth: { val : 'tratata', item : { val : 'tratata' } } }; } function fillArray() { testedObject = { obj : {} }; for( var i = 0; i &lt; count; i++ ) { testedObject.obj[ i ] = getObject(); } } function deleteObjects() { for( var i = 0; i &lt; count; i++ ) { delete testedObject.obj[ i ]; } } </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fillArray()"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"deleteObjects()"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br><br>  The changes are certainly not so complex, and they did not greatly influence the architecture of my bike, but it was very unexpected and annoying that the first option created a leak. <br><br>  <b>Immediately make a reservation that the cause of the leak is not scopes, not contexts, not indices, not the names of the parameters - I checked it all.</b> <br><br><h4>  Conclusion </h4><br>  So, I kind of fixed the leak, and all is well, life is good.  But I still suffer a lot of questions: <br>  What is the fundamental difference between the first version of the function and the second? <br>  And is it a feature or a browser bug? <br>  If a feature, then why is this feature not described in any manner of JS? <br>  If a browser bug, then why so many years later is it still there? <br>  Maybe someone already knows about it, but is silent? <br><br>  I hope my article will help someone!  And I think you should check your bikes for such leaks! <br><br>  PS: Thank you all for your attention !!! <br><br>  <b>UPDATE 1:</b> <br><br>  <s><a href="https://bugzilla.mozilla.org/show_bug.cgi%3Fid%3D787929">Wrote</a> about this so far in the Mozilla bugtracker, let's see what they say.</s> <br><br>  <b>UPDATE 2:</b> <br><br><h4>  Beam at the end of the tunnel </h4><br><br>  So, the situation has cleared up, thanks for this huge <a href="http://habrahabr.ru/users/mraleph/" class="user_link">mraleph</a> and <a href="http://habrahabr.ru/users/seriyps/" class="user_link">seriyPS</a> , in their comments, everything is described in detail.  <a href="https://habr.com/ru/post/150723/"># comment_5107501</a> , <a href="https://habr.com/ru/post/150723/"># comment_5107585</a> , <a href="https://habr.com/ru/post/150723/"># comment_5107692</a> , <a href="http://habrahabr.ru/users/mavim/" class="user_link">Mavim</a> also <a href="https://habr.com/ru/post/150723/">describes</a> my particular case <a href="https://habr.com/ru/post/150723/">in detail</a> . <br><br>  All questions received clear answers, this is not the magic of JavaScript, not a leak and not a browser bug, this is a feature of the implementation of the operator delete.  And rather, it can be called redundant use of memory, and I just stepped on such a mine.  But now we know the enemy by sight and get rid of him without any problems. <br><br>  Thanks to all!!! </div><p>Source: <a href="https://habr.com/ru/post/150723/">https://habr.com/ru/post/150723/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../150716/index.html">A simple way to organize an e-mail queue with Zend_Mail</a></li>
<li><a href="../150719/index.html">Dell Technology Park at IFA 2012</a></li>
<li><a href="../15072/index.html">About poor terminology put in a word</a></li>
<li><a href="../150720/index.html">The selector of generalized related elements</a></li>
<li><a href="../150722/index.html">What killed Linux Desktop (version of Miguel de Icaza)</a></li>
<li><a href="../150724/index.html">Convenient classes for getting IM statuses in PHP</a></li>
<li><a href="../150725/index.html">Building Distributed Data Center (DC Interconnect, DCI)</a></li>
<li><a href="../150726/index.html">CAD: all arbitration courts of Russia in one Android device</a></li>
<li><a href="../150727/index.html">Internet Explorer 7-9: Choosing Tools for Maximum CSS3, HTML5 Support</a></li>
<li><a href="../150728/index.html">Acceleration 3.7 times after removing Sleep () in WebKit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>