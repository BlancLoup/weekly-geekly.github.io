<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Lazy Loading in Entity Framework</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to talk about Lazy Loading in the Entity Framework and why it should be used with caution. At once I will say that I assume that the reader use...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Lazy Loading in Entity Framework</h1><div class="post__text post__text-html js-mediator-article">  I want to talk about Lazy Loading in the Entity Framework and why it should be used with caution.  At once I will say that I assume that the reader uses the Entity Framework, or at least read about it. <br><br><h2>  What is Lazy Loading? </h2><br>  Lazy loading is the ability of EF to automatically load related entities from the database when it is first accessed.  For example, consider the class <i>Trade</i> : <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Trade</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> Counterparty Buyer { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> Counterparty Seller { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span> Qty { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre> <a name="habracut"></a><br>  When you first access the <i>Buyer</i> or <i>Seller</i> properties, they will be automatically loaded from the database.  Technically, this is implemented through the creation of proxy instances of the classes inherited from the <i>Trade</i> class.  At the proxy class, the access to the properties is redefined and contains logic for loading data from the database.  Accordingly, in order for the mechanism to work, the properties must be virtual. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  What does this give? </h2><br>  In theory, lazy loading makes it possible to load only the data that is actually used and needed in the work.  Facilitates the acquisition of related entities and potentially should speed up the work. <br><br><h2>  And what's wrong with that? </h2><br>  As usual, you have to pay for everything, here are some drawbacks that you should definitely consider when using lazy loading. <br><br><h4>  Violates data consistency. </h4><br>  Consider the following example: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Order</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id {<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> IList&lt;OrderLine&gt; OrderLines {<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>;} } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetOrderInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> orderId</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Context()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> order = context.Orders.First(x=&gt;x.orderId == <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">// some logic var info = string.Join(",", order.OrderLines.Select(x=&gt;x.Name)); return $"{order.Id} {info}"; } }</span></span></code> </pre> <br>  Imagine that in the interval between loading an order from the database and accessing the OrderLines property, the contents of the order were changed.  As a result, we will receive the contents of the order at the current moment, and not at the time of loading the order itself from the database. <br><br><h4>  May degrade performance. </h4><br>  How so, you ask, he is intended to accelerate ??  In theory, yes, but in practice I often had to solve problems arising from the illiterate use of this feature.  A simple example: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//      public string GetTradeDescription(int tradeId) { using (var context = new Context()) { var trade = context.Trades.First(x =&gt; x.Id == tradeId); var result = $"{trade.Id}:{trade.Buyer.Name}-{trade.Seller.Name}:{trade.Qty}"; return result; } }</span></span></code> </pre><br>  The question is, how many requests will be sent to the database?  That's right, 3. In this case, perhaps this is not very scary. <br><br>  But let's imagine that now we want to receive information immediately on an arbitrary number of transactions.  Modifying our method: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetTradeDescription</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] tradeIds</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Context()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> trades = context.Trades.Where(x =&gt; tradeIds.Contains(x.Id)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = trades .AsEnumerable() .Select(trade =&gt; <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{trade.Id}</span></span></span><span class="hljs-string">:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{trade.Buyer.Name}</span></span></span><span class="hljs-string">-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{trade.Seller.Name}</span></span></span><span class="hljs-string">:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{trade.Qty}</span></span></span><span class="hljs-string">"</span></span>) .ToList(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }</code> </pre> <br>  As a result, the number of requests will increase in proportion to the number of requested transactions.  Imagine that when requesting information on hundreds of transactions in the database will fly&gt; 100 requests, although one would be enough.  At the same time, such errors are not so easy to catch during the development / review phase, and such a code can fire already in the combat environment. <br><br>  A similar problem arises when attempting to serialize objects with lazy loading support, the serializer will pull an object for each property, thus generating additional calls to the database. <br><br><h4>  Fluid abstraction </h4><br>  When using lazy loading, our POCO objects cease to be POCO, because now we work with proxies that store a link to the context and go to the database themselves.  What will happen if you use these objects outside the context that loaded them? <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoSomeLogic</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tradeId</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> trade = LoadTrade(tradeId); Console.WriteLine(trade.Buyer.Name);<span class="hljs-comment"><span class="hljs-comment">// Oops,     The ObjectContext instance has been disposed and can no longer be used for operations that require a connection } private Trade LoadTrade(int tradeId) { using (var context = new Context()) { var trade = context.Trades.First(x =&gt; tradeId == x.Id); return trade; } }</span></span></code> </pre> <br><h2>  Conclusion </h2><br>  Personally, in my projects I decided not to use lazy loading at all, maybe it‚Äôs too categorical, but based on my experience I‚Äôll say that I got a lot more problems from it. <br><br>  There is an alternative option to leave lazy loading turned on but strictly ensure that all navigation properties are not virtual (with the rare exception where <s>hands itch</s> lazy loading is very necessary). </div><p>Source: <a href="https://habr.com/ru/post/336812/">https://habr.com/ru/post/336812/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336796/index.html">Low branch trees</a></li>
<li><a href="../336798/index.html">Kotlin: combat use experience</a></li>
<li><a href="../336800/index.html">Education from Mail.Ru Group: telling live on Tehnostrim about training opportunities</a></li>
<li><a href="../336804/index.html">Gazer: backdoor of the second stage of the ART group Turla</a></li>
<li><a href="../336810/index.html">How to earn on ICO? And how to do it is not necessary</a></li>
<li><a href="../336814/index.html">Hanami Getting Started</a></li>
<li><a href="../336816/index.html">Spring MVC - the basic principles</a></li>
<li><a href="../336818/index.html">XBRL: just about the complex - Chapter 6. Immersion in XBRL - Part 6. Multidimensionality</a></li>
<li><a href="../336822/index.html">Factory Testing: The Black Box and Short Testing Cycle</a></li>
<li><a href="../336824/index.html">How to step over legacy and start using static code analysis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>