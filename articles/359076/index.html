<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pure Storage ActiveCluster in conjunction with VMware: review and testing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, Pure Storage announced a new ActiveCluster functionality - an active / active metro cluster between data warehouses. This is a synchr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pure Storage ActiveCluster in conjunction with VMware: review and testing</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/zg/gc/4j/zggc4jbmbue0g53rlyy1spa8-c8.png"><br><br>  Not so long ago, Pure Storage announced a new ActiveCluster functionality - an active / active metro cluster between data warehouses.  This is a synchronous replication technology, in which a logical volume is stretched between two storages and is read / write accessible to both.  This functionality is available with the new version of the firmware Purity // FA 5 and is absolutely free.  Also, Pure Storage was promised that setting up a stretched cluster has never been so easy and understandable. <br><br>  In this article we will tell about ActiveCluster: what it consists of, how it works and is configured.  In part, the article is a translation of official documentation.  In addition, we will share the experience of testing it for fault tolerance in a VMware environment. <br><a name="habracut"></a><br><h2>  Competitive decisions </h2><br>  The presented functionality is not something innovative, similar solutions exist for most major storage vendors: Hitachi GAD (Global Active Device), IBM HyperSwap, HPE 3PAR Peer Persistance, Fujitsu Storage Cluster, Dell Compellent Live Volume, <a href="https://habr.com/company/jetinfosystems/blog/326082/">Huawei HyperMetro</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      However, we decided to highlight some advantages of ActiveCluster compared to competitive solutions: <br><br><ul><li>  Does not require additional licenses.  Functionality is available out of the box. </li><li>  Simple replication management (we tried - it is really convenient and easy). </li><li>  Cloud pick (Quorum device).  Does not require a third site and the deployment of a quorum server on it. </li></ul><br><h2>  ActiveCluster Overview </h2><br>  Consider the components that make up ActiveCluster: <br><br><ul><li>  <b>Transparent Failover Mediation</b> .  Cloud Mediator is a server / device quorum that decides which of the arrays will continue to work and provide access to the data, and which should stop working in case of various failures. </li><li>  <b>Active / Active Clustered Arrays</b> ‚Äî PureStorage arrays with configured synchronous replication between them.  Provide access to a consistent copy of data from one array or from another. </li><li>  <b>Stretched Storage Containers</b> - containers containing objects that must be replicated between two arrays. </li></ul><br><img src="https://habrastorage.org/webt/_e/gl/iq/_egliqwihoi7so379ytlwsszulc.png"><br><br>  New objects appeared in ActiveCluster - Pods.  Pod is a container containing other objects.  If there is a replication channel between two arrays, then several arrays can be added to the pod and then all the objects in this pod will be replicated between the arrays.  Stretched pods can be controlled from any array. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bx/d9/w7/bxd9w7wrkk7sd6geba3jdadfixg.png"></div><br><br>  Pods may contain volumes, snapshots, protection groups, and other configuration information.  Pod functions as a consistency group, that is, it guarantees a consistent order of recording volumes in one pod. <br><br><h2>  ActiveCluster: array access schemes for hosts </h2><br>  Access to data hosts can be configured with two access models: uniform and non-uniform.  In the uniform model, each host on both sites has access to both arrays for reading / writing.  In a non-uniform model, each host has access only to a locally located array for read / write. <br><br><h2>  Uniform access model </h2><br>  A uniform data access model can be used in environments where Fiber Channel or Ethernet (iSCSI) is used to connect hosts to arrays and Ethernet connection (10g) for replication is used between arrays.  In this configuration, the host has access to data through both arrays: both via local and remote.  This solution is only supported with a maximum delay between arrays across replication channels of 5 ms. <br><br><img src="https://habrastorage.org/webt/xa/m4/0g/xam40gjk-rbqc4acpu5wfmuw3tw.png"><br><br>  The diagram above illustrates the logical paths from hosts to arrays, as well as the replication channel between arrays in the Uniform access scheme.  It is assumed that the data is available to both hosts regardless of the site on which they are located.  It is important to understand that the paths to the local array will have less delay than to the remote one. <br><br><h2>  Optimized performance when using a uniform model </h2><br>  For better I / O performance when using active / active synchronous replication, the host should not use paths to the remote array.  For example, consider the picture below.  If ‚ÄúVM 2A‚Äù performs a write operation on volume ‚ÄúA‚Äù using an array ‚ÄúArray A‚Äù, then this write operation will entail a double delay in the transmission of data through the replication channel, as well as a delay from the host to the remote array. <br><br><img src="https://habrastorage.org/webt/wm/zi/q9/wmziq9mu1zefmxniuo93smh9md4.png"><br><br>  I propose to disassemble in more detail.  Suppose that the delay on the replication channel between arrays is 3ms.  In case of ‚ÄúHost B‚Äù connection &lt;-&gt; ‚ÄúArray B‚Äù, 1ms delay.  And in the case of ‚ÄúHost B‚Äù &lt;-&gt; ‚ÄúArray A‚Äù - 3ms.  A write command will be sent from the ‚ÄúVM 2A‚Äù host to the remote site to the ‚ÄúArray A‚Äù array with a delay of 3ms.  Further, the write command will be sent via the replication channel to the Array B array with a delay of 6ms (3ms + 3ms).  After that, a successful write response will be sent back from the Array B array to the Array A array via the replication channel (6ms + 3ms = 9ms).  Then the answer about the successful recording will be sent back to the host ‚ÄúVM 2A‚Äù (9ms + 3ms = 12ms).  Total we get a delay of 12ms per write operation in the case of using a remote array.  If we calculate exactly the same principle as using a local array, then we get 8ms. <br><br>  ActiveCluster allows you to use ALUA (Asymmetric Logical Unit Access) to provide paths to local hosts as active / optimized and to provide paths to remote hosts as active / non-optimized.  The optimal path is determined for each host &lt;-&gt; volume bind by setting the preferred array option.  Thus, it does not matter which of the hosts your application or virtual machine is running on, the host will always know which array is local for it (it has the best paths), and which remote (it does not have the best paths). <br><br><img src="https://habrastorage.org/webt/ff/i0/gu/ffi0guesway6-jujus5im_bjqkw.png"><br><br>  Using ActiveCluster, you can configure truly active / active data centers, without worrying about which platform your virtual machine or application is running on.  All read / write operations will always go through the array local to the host. <br><br><h2>  Non-uniform access model </h2><br>  The non-uniform access model is also used in environments where Fiber Channel or Ethernet (iSCSI) is used to connect hosts to arrays.  In this model, the hosts have access only to the local array and do not have access to the remote array.  This solution also involves the use of replication connections between arrays with a delay of no more than 5ms. <br><br><img src="https://habrastorage.org/webt/3i/1v/xm/3i1vxmgkeomtvsuqsyvnrysf56m.png"><br><br><h2>  Pros and cons of these access models </h2><br>  The Uniform access model provides a higher level of fault tolerance, since the failure of one array does not entail restarting the virtual machines or applications that used this array ‚Äî data access will continue through the other.  Of course, this model assumes a working and configured multipathing (multipathing) on ‚Äã‚Äãthe host side, which would distribute I / O requests over active / optimized paths and active / non-optimized in the case when the first ones are unavailable. <br><br>  In the case of using the Non-uniform model, the hosts have access only to the local array and, accordingly, only by active / optimized paths.  If a local array fails, all virtual machines or applications will lose access to data on this site and will be restarted (for example, using VMware HA tools) on another site using data access through another array. <br><br><h2>  Configure Active Cluster </h2><br>  The guys from Pure Storage declare a very simple, intuitive configuration of ActiveCluster.  Well, let's see.  Setup is done in 4 steps: <br><br>  <b>Step 1</b> : Connect two Flash arrays. <br><br>  We connect our arrays with two Ethernet 10Gb / s channels and configure the type of connection as Sync Replication via GUI. <br><br><img src="https://habrastorage.org/webt/zf/7r/at/zf7ratgvqwge0idctv5ynwaeypk.png"><br><br>  <b>Step 2</b> : Creating and Stretching pod. <br><br>  To create a pod, we will use the CLI (through the GUI, too, is possible).  The purepod command is used to create and stretch pod.  As we said earlier, pod is a container that is designed to simplify management in an active / active environment.  Pod determines which objects should synchronously replicate between arrays.  You can manage stretched pods and objects in them from any of the arrays.  Pods may contain volumes, snapshots, clones, group protection and other configuration information. <br><br>  Create a pod on the Array A array: <br><br> <code>arrayA&gt; purepod create pod1</code> <br> <br>  Stretch the pod on Array B: <br><br> <code>arrayA&gt; purepod add --array arrayB pod1</code> <br> <br>  Now, any volumes, snapshots or clones placed in this pod will automatically replicate between the Array A and Array B arrays. <br><br>  <b>Step 3</b> : Creating Volumes <br><br>  On any of the arrays we create a volume vol1 of 1TB size and place it in pod1: <br><br> <code>&gt; purevol create --size 1T pod1::vol1</code> <br> <br>  Instead of creating a volume, we can move any already existing volume to pod1 and it will begin to replicate. <br><br>  <b>Step 4</b> : Presentation of the volume to the host. <br><br>  Once again, we note that ActiveCluster is a real active / active solution that allows you to read and write to the same logical volume using both arrays. <br><br>  Create a host and present volume vol1 to this host: <br><br> <code>&gt; purehost create --preferred-array arrayA --wwnlist &lt;WWNs f ESX-1 &gt; <br> &gt; purehost connect --vol pod1::vol1 ESX-1</code> <br> <br>  Please note that we specify the option ‚Äìpreferred-array, which means that the paths from the ArrayA array will be optimal for this host (active / optimized). <br><br>  It's all!  Now ESX-1 has access to vol1 through both the ArrayA and ArrayB arrays.  Quick and easy, isn't it? <br><br>  Additionally, check the status of the mediator.  We use the cloud mediator Pure, to access it arrays must have access to the Internet.  If the security policy does not allow this, then it is possible to download and deploy a local mediator. <br><br> <code>purepod list --mediator <br> Name Source Mediator Mediator Version Array Status Frozen At Mediator Status <br> pod1 - purestorage 1.0 Array-A online ‚Äì online <br> Array-B online - online</code> <br> <br><h2>  Functional testing of ActiveCluster in VMware environment </h2><br>  We were faced with the task of functional testing of a bunch of two Flash Array // m20 in ActiveCluster and VMware configuration (2 ESX hosts) in terms of ensuring the fail-safe operation of virtual machines.  We emulated the presence of two sites, each of which had an ESX host and a Flash Array.  The version used is VMware 6.5 U1 and version Pure // FA 5.0.1. <br><br>  We had the following success criteria: <br><br><ol><li>  Emulated disk array failures do not interrupt virtual machines. </li><li>  Emulated failures of the ESX server allow you to automatically (using VMware HA) run virtual machines on another ESX server. </li><li>  Emulated site failures (array + esx server) allow automatically (using VMware HA) to start virtual machines on another site. </li><li>  Test vMotion in configuration with VMware + ActiveCluster. </li></ol><br>  The scheme of our stand is presented below: <br><br><img src="https://habrastorage.org/webt/qn/tz/mm/qntzmmivlxh6xd3ydwbxo0hj0ze.png"><br><br>  ActiveCluster was built between the m20 # 1 and m20 # 2 arrays using a 10 Gbps replication channel.  A pod was created on one array, and then stretched by adding a second array to it.  On both arrays, a 200GB volume was created and added to the stretched pod, thereby starting replication of these volumes between arrays.  The replicated volume was presented to both ESX hosts using the Uniform access scheme with the preferred array configuration for host groups.  For the ESX1 host, the preferred array was m20 # 1, and for ESX2, the corresponding m20 # 2.  Thus, from the side of the ESX hosts, the paths to the datastores were active (I / O optimized) to the local array and active (non-optimized) to the remote one. <br><br><img src="https://habrastorage.org/webt/4o/lt/vf/4oltvf_1zjqywixqiafoepgdkvo.png"><br><br><h2>  Emulation of disk array failure </h2><br>  For testing, a virtual machine with Windows 2012 r2 was installed.  VM files were located on a shared datastore on a stretched volume with Pure Storage.  Also in this VM, another 100GB disk was presented from the same datastore, to which we launched a synthetic load using IOmeter.  I note that we didn‚Äôt have a goal to measure performance, we had to generate any I / O activity so that during our tests we could catch moments when SCSI read / write commands could hang when switching paths to arrays. <br><br>  So, everything is ready: the test VM runs on ESX1, the ESX1 host uses the optimal paths to the m20 # 1 array for I / O operations.  We go to the server room and chop off the m20 # 1 array on power and monitor the IOmeter in the VM.  No interruption in input / output occurs.  We look at the state of the paths to the datastor: the paths to m20 # 1 are in the dead state, the paths to m20 # 2 are switched to the active (I / O) state.  The test was conducted several times with slightly different inputs, but the result was always successful.  We consider the test successfully passed. <br><br>  PS After turning on the m20 # 1 array, the paths switched back to it, that is, to the site local to this ESX host. <br><br><h2>  ESX host failure emulation </h2><br>  This test is not very interesting, as we, in fact, do not check Pure Storage, but the operation of VMware HA.  In any case, we expected a downtime for the VM and its subsequent resurrection by a cluster on another ESX host. <br><br>  In general, we went to the server room and pulled the power supply host ESX1.  VMware HA worked properly, and our VM successfully went up on the ESX2 host.  The test is considered successful. <br><br><h2>  Emulation of the entire site failure </h2><br>  In fact, this is the first and second test conducted simultaneously.  And in any case, this is downtime for the virtual machine, since we disable the ESX host.  The source data is the same as in the first test: the VM runs on ESX1, the ESX1 host uses the m20 # 1 for I / O, the VM runs the IOmeter for the synthetic load on the array. <br><br>  We go to the server and turn off the power at ESX1 and m20 # 1.  We are watching.  Within 1-2 minutes, VMware HA raises the virtual machine on ESX2, the paths on ESX2 are in the dead state for m20 # 1 and in the active (I / O) state for the m20 # 2 array.  The test is considered successful. <br><br><h2>  Verify vMotion performance in ActiveCluster configuration </h2><br>  A very formal test.  We needed to check that it works and there are no pitfalls.  We drove vMotion both on the enabled virtual machine and on the off, with and without a datastor change, no problems were revealed.  Test passed successfully. <br><br><h2>  Conclusion </h2><br>  Synchronous replication technology is no longer new and almost every major storage vendor has one, but Pure Storage stands out among them because it does not require additional licenses to use it, which can often make up a large part of the cost of the storage itself.  Also, the guys from Pure have brought a new level of convenience to managing replication, now there is no need to study dozens of pages of documentation in order to configure it, and the whole process is intuitive.  In order to increase our own competencies, we also conduct various tests both at home and at customers within the framework of the organization Proof of Concept.  Together with the OCS distributor (we took the second array from them), we deployed the first Pure Storage ActiveCluster in Russia, where we tested. <br><br>  <i>Sergey Surnin, expert of the Jet Infosystems Service Center</i> </div><p>Source: <a href="https://habr.com/ru/post/359076/">https://habr.com/ru/post/359076/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../359066/index.html">Saint P Rubyconf 2018: June 10, St. Petersburg</a></li>
<li><a href="../359068/index.html">Systems thinking as the main driver of growth: the concept of Growth System</a></li>
<li><a href="../359070/index.html">ETL: quality data for management decisions</a></li>
<li><a href="../359072/index.html">The book "Head First. Programming for Android. 2nd ed ¬ª</a></li>
<li><a href="../359074/index.html">GeekUniversity opens a set of information security faculty</a></li>
<li><a href="../359078/index.html">We write a simple cache manager in memory on Go</a></li>
<li><a href="../359080/index.html">"This is not a hoax": Wall Street investment banks are starting to believe in Bitcoin under the pressure of customers</a></li>
<li><a href="../359082/index.html">JetBrains Open Day Moscow: results and video</a></li>
<li><a href="../359084/index.html">Is XMPP so bad as it is painted? How Jabber has become today</a></li>
<li><a href="../359086/index.html">Not Delisamokat one: how small usability errors create big problems with a real example</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>