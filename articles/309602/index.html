<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Skype-bot with a human face (on the Microsoft Bot Framework V3 and Slack API)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Skype is an excellent channel for quick communication with customers. He has all and provides fast live communication without unnecessary gestures and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Skype-bot with a human face (on the Microsoft Bot Framework V3 and Slack API)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/a73/f7f/e73/a73f7fe73e9843d08738440597fa3368.jpg"><br><br>  Skype is an excellent channel for quick communication with customers.  He has all and provides fast live communication without unnecessary gestures and costs (for example, on the telephone).  However, when the number of customers is in the thousands, the benefits of Skype begin to turn into disadvantages.  In this article we will talk about our Skype bot, in fact, performing the role of a telephonist from the early 20th century: it connects the client with a free manager and maintains this connection until the issue is resolved. <br><a name="habracut"></a><br>  Skyeng School has always had the task of creating a convenient communication channel between messengers and operators of customer support services.  The instant messenger that now receives the largest number of applications from us is Skype.  When the number of contacts in Skype amounts to thousands, communication directly through the Skype client becomes problematic.  First, the performance of this client during such work drops to almost zero, the contact list is loaded prohibitively long.  Secondly, often several operators need to maintain parallel communication with users;  Using one Skype account on several devices is possible, but incoming messages from all conversations are visible to all operators, which hinders the work.  In addition, all communications in Skype remain in Skype itself, in order to retrieve them into internal CRM or HelpDesk systems, you have to copy-peist. <br><br>  These difficulties led us to the decision to create a chat bot that will serve <b>as an entry point for messages</b> to the support service.  The topic of chat bots has been very popular lately, and Microsoft has provided access to the Skype REST API, which includes an <a href="https://developer.microsoft.com/en-us/skype/bots/downloads">SDK</a> with examples for C # and Node.js. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For full-fledged multi-channel communication, receiving messages is not enough; they must also be delivered somewhere where the operator can read them.  Since our school actively uses Slack in its internal communications, and this messenger has good support for the concept of channels, it was decided to forward incoming messages there. <br><br>  As a result, we have created a model with entry and exit points, within which we have complete control over the data flows. <br><br><img src="https://habrastorage.org/files/73b/dad/325/73bdad325863495d93a8212790169b4e.png"><br><br><h2>  Architecture </h2><br>  The system does not imply any complicated calculations on the server;  Its main tasks are receiving, storing and routing data.  Therefore, <a href="https://nodejs.org/">Node.js</a> was chosen as the main platform, which is well suited for such tasks.  They took the latest available LTS version, at the time of the start of the project - 6.3.0.  According to <a href="http://node.green/">node.green, the</a> six covers 95% of ES 2015, which is very nice, and the <a href="https://nodesource.com/blog/essential-steps-long-term-support-for-nodejs/">nodesource blog</a> promises its operation until April 2018, after which the maintenance phase will begin.  It fits. <br><br><img src="https://habrastorage.org/files/1d5/be9/7e8/1d5be97e8c094340979450c27b669192.png"><br><br>  There are no special requirements for the database, so we took the classic reliable relational in the form of <a href="https://www.postgresql.org/">PostgreSQL</a> . <br><br>  To ensure sufficiently high fault tolerance, the ability to scale and at the same time low connectivity of components, it was decided to include in the message queue architecture in the form of <a href="https://www.rabbitmq.com/">RabbitMQ</a> for data exchange between system modules. <br><br>  The result is the following scheme of work: <br><br><img src="https://habrastorage.org/files/fe3/0b4/bf4/fe30b4bf4d024f77a0bd290c11ae64b9.png"><br><br>  The system consists of <b>three main services</b> (Skype service, Logic service, Slack service) and the additional micro service Slack messaging micro-service.  The main task of Slack service is to ensure endpoint's work for the Skype bot and send messages to Skype.  Logic service is responsible for routing messages, storing messages, processing commands and providing an API for integration with the school‚Äôs internal services.  Slack service has a subscription to <a href="https://api.slack.com/rtm">Slack RTM</a> and is responsible for the endpoint for accepting commands from support operators on Slack. <br><br>  An additional Slack messaging micro-service was needed in order to confidently send messages to Slack, without fear of exceeding the <a href="https://api.slack.com/docs/rate-limits">limits of the Slack API</a> , so messages are sent by long-polling reading them on a timer from RabbitMQ and sending to Slack. <br><br><h2>  Can you trust the preview?  Migration to Microsoft Bot Framework </h2><br>  The use of <b>preview versions of the</b> tools always carries a certain risk, since by the time of release serious changes may occur to them or, even worse, this release <i>will not take place at all</i> .  This is the fate that befell the SDK for the development of Skype bots: it appeared in the form of a preview and grew old in the same form (received the status of deprecated).  After that, the creation of new bots exclusively for Skype became impossible, and then a redirect to the Microsoft Bot Framework and a warning about the need to migrate in the near future appeared. <br><br><img src="https://habrastorage.org/files/e95/0ec/e11/e950ece1187040a4ba43637e2c3dadcf.jpg"><br><br><img src="https://habrastorage.org/files/12d/cdd/134/12dcdd134eb746c99431facd09328730.png"><br><br>  The Microsoft Bot Framework is an attempt by Microsoft to cover multiple communication channels in a single tool.  Currently supported: Facebook Messenger, Kik, Slack, Telegram, Skype and even channels such as Email, Twilio (SMS) and Direct Line.  All this is interesting, but at this stage we were only interested in Skype (although it was a good start, of course, you can add support for other instant messengers with lower labor costs). <br><br><img src="https://habrastorage.org/files/c1a/471/d3f/c1a471d3f3ac4f7cb606ec4cc0d67cd7.JPG"><br><br>  We did not wait and migrated immediately.  Registering a new bot in the Microsoft Bot Framework is simple, just have a Microsoft account. <br><br>  <b>The algorithm is</b> as follows: <br><br><ul><li>  follow the <a href="https://dev.botframework.com/bots/new">link</a> ; </li><li>  fill in all fields with an asterisk; </li><li>  click Create Microsoft App ID and Password; </li><li>  a new page will open where you need to enter the name of the application, for example, TestBotApp; </li><li>  next button Generate a password to continue; </li><li>  The generated password must be saved somewhere, because you can‚Äôt re-see it, but you will need it to work with the Framework and the App ID; </li><li>  further button Finish and go back to Bot Framework; </li><li>  On the registration page, you need to accept the agreement and click Register, after which we have a ready registered bot for the Microsoft Bot Framework </li></ul><br>  On the registration page there is a Messaging endpoint field, it is not necessary for registration, but it is the entry point for the bot, without which it will not function.  The main requirement for endpoint is that it should be a working HTTPS link. <br><br>  In terms of <b>migrating the code</b> , there was no need to make big changes, since all that our bot should be able to do is receive and send messages.  Nevertheless, the code for the same functionality has become bigger: <br><br><pre><code class="javascript hljs">bot.send( <span class="hljs-string"><span class="hljs-string">'8:skype.username'</span></span>, <span class="hljs-string"><span class="hljs-string">'message from bot to user'</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-comment"><span class="hljs-comment">// escape (error) =&gt; console.log(error) );</span></span></code> </pre> <br>  turned into <br><br><pre> <code class="javascript hljs">bot.send( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> builder.Message() .address({ <span class="hljs-attr"><span class="hljs-attr">channelId</span></span>: <span class="hljs-string"><span class="hljs-string">"skype"</span></span>, <span class="hljs-attr"><span class="hljs-attr">user</span></span>: { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"29:some-long-hash-here"</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"User Display Name"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">bot</span></span>: { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"28:bot-uuid"</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Bot Name"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">serviceUrl</span></span>: <span class="hljs-string"><span class="hljs-string">"https://skype.botframework.com"</span></span>, <span class="hljs-attr"><span class="hljs-attr">useAuth</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }) .text(<span class="hljs-string"><span class="hljs-string">'Message from bot to user'</span></span>), (err) =&gt; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(err) );</code> </pre> <br>  And small changes in message reception: <br><br><pre> <code class="javascript hljs">bot.on(<span class="hljs-string"><span class="hljs-string">'personalMessage'</span></span>, (bot, data) =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Got message from user'</span></span>); });</code> </pre> <br>  Since the Bot Framework has such a thing as dialogs, but we just needed to receive messages, we subscribed to the most general dialogue, which is represented by a slash;  it will accept all incoming messages: <br><br><pre> <code class="javascript hljs">bot.dialog(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, [ <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">session</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Got message from bot"</span></span>, session.message); } ]);</code> </pre> <br>  In the above <i>bot</i> code snippets in the case of the Skype Bot SDK, there is an instance of the BotService class, and on the Bot Framework this is already <a href="">UniversalBot</a> . <br><br>  It is also worth noting that if in the Skype Bot SDK we hoped to be able to understand by user id, who we are dealing with, then in the Microsoft Bot Framework all users are represented as long hashes, which makes the interlocutors anonymous.  The task of <b>identification</b> can be solved only in a lively dialogue with the user. <br><br>  Another interesting point is editing the messages sent by the bot.  In the Skype Bot SDK, as <a href="https://github.com/Microsoft/BotBuilder/issues/1050">some github users</a> say, there was such an opportunity, but in the Microsoft Bot Framework it is not for Skype (although for other platforms, in particular Telegram and Slack, it is possible). <br><br>  Nevertheless, the Microsoft Bot Framework is a good step towards unifying the bot development platform for various communication channels.  It is hoped that Microsoft will continue the development of this product and add the missing features for Skype bots now. <br><br><h2>  We meet messages in Slack </h2><br>  To organize multi-channel message acceptance, we used the Slack tool such as private channels;  in Slack API terminology, this is <a href="https://api.slack.com/methods">groups</a> . <br><br>  Initially, we expected that the creation of a single <a href="https://api.slack.com/bot-users">Custom Bot</a> would be enough for us, which would cover all the functionality of sending messages to Slack: create a private channel there, add an operator to it and continue to provide proxy communication.  It turned out, however, that bots in Slack do not have the right to create private channels. <br><br>  Therefore, in addition to the <a href="https://api.slack.com/rtm">Slack-</a> connected <a href="https://api.slack.com/rtm">RTM Api</a> Custom Bot, we also created a Slack application, which, on behalf of the average Slack user, creates private channels and invites operators to them. <br><br>  The Slack API is fairly stable, well documented, and even contains an online tester that allows you to check the method call, so fortunately there were no other surprises.  To work with him, we took this very simple <a href="https://www.npmjs.com/package/slack">npm package</a> : it is convenient, since its methods are mostly the same as the Slack API methods. <br><br><h2>  Not so simple! </h2><br>  In order for your bot to work, it must be approved by Microsoft.  It would seem a simple formality, but it took us a lot of time and effort.  We will tell you about the rake that you stepped on yourself, but this does not mean that you will not step on any more;  be prepared for this. <br><br>  So, two weeks after the first submission, we received this: <br><br><img src="https://habrastorage.org/web/efa/acf/fb5/efaacffb56e549f3b889cf144a6a21be.png"><br><br>  with an explanation: Bot content is in Russian language.  At this time, Skype Bots only support English Users.  Please ‚Äúyour bot is in Russian, but you need to be able to communicate with users in English‚Äù).  As it turned out, to solve this problem, it is enough to have the Terms of Service and Privacy Policy in English;  OK, wrote, <a href="http://skyeng.ru/policy">posted</a> , sent a new application. <br><br>  This time the fail came faster: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/9a6/66e/8d3/9a666e8d32ad4817957b1b2896c0a5c4.png"></div><br>  Our bot is only intended to connect the client with the operator.  According to Microsoft, this is not enough.  It was necessary to fasten the minimum functionality - a couple of commands to which the bot can react independently (help and lessons-count). <br><br>  While we were fulfilling these requirements, a new one appeared: a bot should be able to issue Terms of Service and Privacy Policy on command (just having them on the site is not enough).  Okay, did that too.  It turned out that this is not enough, the conditions must be present in each message.  Good.  Meanwhile, in the London office of Microsoft, massive reshuffles began, which is why approval was postponed again and again ... <br><br>  But in the end we got a long-awaited apruv: <br><br><img src="https://habrastorage.org/web/98b/cde/62c/98bcde62c9fa42268ab746903e4a3d24.png"><br><br>  All these machinations have taken away a huge amount of time from us, be prepared for unforeseen and sometimes unexplained delays. <br><br><h2>  Conclusion </h2><br>  As a result, we received a Skype bot that provides a quick, high-quality response to incoming messages and talking to the client ‚Äúas alive‚Äù (which is not surprising, considering that the operator controls it).  Gone are the answers to the wrong channel and missed incoming contacts;  ‚ÄúYour question is very important for us‚Äù - not empty words, now not a single message will be lost, and the conversation will not die out through our fault.  At the same time, the problems of regular Skype were solved, and communications acquired a structured form, which we integrated into our internal user support services.  And all the ‚Äúmagic‚Äù is in the uncomplicated architecture of routing messages between different platforms. <br><br>  PS We remind you that our doors are open for <a href="https://moikrug.ru/companies/skyeng/vacancies">different talented professionals</a> ! </div><p>Source: <a href="https://habr.com/ru/post/309602/">https://habr.com/ru/post/309602/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309586/index.html">MS Office spells the words to a new line</a></li>
<li><a href="../309588/index.html">Announcement of the conference "Designing Business Architectures 2016"</a></li>
<li><a href="../309592/index.html">Review services cloud PBX Beeline</a></li>
<li><a href="../309596/index.html">The concept of the programming language of the 5th generation. Part 3</a></li>
<li><a href="../309600/index.html">Monitoring the linux network stack</a></li>
<li><a href="../309606/index.html">Moscow JS Meetup in Badoo</a></li>
<li><a href="../309608/index.html">Business planning web studio at the start</a></li>
<li><a href="../309612/index.html">What interesting things have I learned in two years of developing and promoting a mobile game?</a></li>
<li><a href="../309614/index.html">‚ÄúNot a single break‚Äù: what is the cost of making an online broadcast that will not fall, slow down and cause pain in the eyes?</a></li>
<li><a href="../309616/index.html">Google Analytics for Telegram Bot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>