<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Shell parser with authentication XOR encryption bypass</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, there was a need for a parser of an online bank card account for further notification of transactions via SMS \ e-mail. It was decided to do...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Shell parser with authentication XOR encryption bypass</h1><div class="post__text post__text-html js-mediator-article">  Recently, there was a need for a parser of an online bank card account for further notification of transactions via SMS \ e-mail.  It was decided to do this quickly in a shell script that will parse the page with the account at a certain frequency using the task in cron, and in case of changing the account balance - send a message to a mobile phone or e-mail.  Nothing complicated at first glance, but during the writing I had to solve some difficulties that you can read about under the cut. <br><br><a name="habracut"></a>  For parsing, it was decided to use standard unix utilities - curl, grep, sed.  It was supposed to authenticate to the https server using a post-request, and then, as usual, using regular expressions, pull the necessary information from the page.  But it was then that the main problem was discovered - the data during authentication (more precisely, the password) was sent to the server encrypted.  Let me remind you that the banking page was taken over https, i.e.  such a mechanism, in addition to TLS, is due, perhaps, to protection from local sniffers. <br><br><img src="https://habrastorage.org/storage2/f43/cdd/71b/f43cdd71b9b1f4cb106c91e141e12d95.png" alt="POST"><br><h6>  Before sending, in the best traditions of Unicode, hieroglyphs are encoded in hex </h6><br>  Obviously, encryption was used on the client side, but it is difficult to imagine this process without a key, which I was looking for. <br>  First of all, after thinking, why not, cookies were checked, it is clear that no dependencies that issued the key were detected.  Plans to write a script in a hurry and continue to go about their business, began to gradually crumble.  The site was written in jQuery, <s>which further depressed my position</s> .  Using the debugger, an embedded script was detected in the events: <br><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).parents(<span class="hljs-string"><span class="hljs-string">"#loginParamsWrapper"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> authMode = $(<span class="hljs-string"><span class="hljs-string">"#AuthMode"</span></span>, context).val(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> form = $(<span class="hljs-string"><span class="hljs-string">"#frm"</span></span> + authMode, context); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!TWIB.validForm(form)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = form.formToArray(); data.push({<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"AuthMode"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: authMode}); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (authMode == <span class="hljs-string"><span class="hljs-string">"TBId"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pan = $(<span class="hljs-string"><span class="hljs-string">"#name"</span></span>, form).val(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> prefix = <span class="hljs-string"><span class="hljs-string">"9129120000000000"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (prefix != <span class="hljs-string"><span class="hljs-string">""</span></span> &amp;&amp; prefix.length &gt; pan.length) { pan = prefix.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, prefix.length - pan.length) + pan; } data.push({<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"PAN"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: pan}); } data.push({<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"PIN"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: TWIB.xorString($(<span class="hljs-string"><span class="hljs-string">"#password"</span></span>, form).val(), <span class="hljs-string"><span class="hljs-string">"3734"</span></span>)}); ... }</code> </pre> <h6>  The PDA-version of the site was analyzed in view of resource saving during parsing; no special differences were found with the main version in the authentication mechanism </h6><br>  As can be seen from the code, the prefix 912912 is added to the digital login (in my case, the ten-digit one), which seems to be static, which was discovered even when viewing the http-headers.  But of greater interest is the last line, which suggests that the password value is encrypted using the xorString function and the dynamic key val, in this case, 3734. Let's look for the body of the function itself in other scripts. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/c3a/d10/911/c3ad1091132b79bbb1c388266d7b390c.png" alt="firebug"><br><br>  This code fragment modulo 2 adds each character of the string str (password entered) with the entire string val (key combination), the String.fromCharCode method displays the characters by their received decimal codes, and the string res is returned, which is transmitted instead of the password in the post- authentication request. <br>  The overall picture of the defense mechanism is already there, it remains to find out where the key combination comes from. <br><br>  But it turned out pretty simple.  When the page is opened, the session identifier is written in the cookie, then the post ajax request (XNR) is sent to the actionParam: Logon (which, by the way, the debugger built into the last chrome did not notice at first), and the script with the key combination associated with the session id. <br><br>  In order for our parser to get to the desired page, it will have to do the following: <br><br>  1. Request a page, get session cookies <br>  2. Using the received cookies, send a post-request, get a page with an embedded script <br>  3. Dump the received json key, which will be used for XOR encryption <br>  4. Add modulo 2 of each password character with a key combination. <br>  4.1.  Convert password characters from decimal codes <br>  4.2.  Perform operation XOR <br>  4.3.  Convert from decimal to hexadecimal <br>  4.4.  Get unicode characters from code values <br>  5. Using the resulting string, authenticate to the site. <br><br>  Some difficulty is only in obtaining an encrypted password for authentication.  To begin with, we will get the key, with the help of which we will carry out further manipulations: <br><pre> <code class="bash hljs">curl -s -b <span class="hljs-string"><span class="hljs-string">"PDAVersion=true"</span></span> -A <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ua</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$site</span></span></span><span class="hljs-string">"</span></span> -c <span class="hljs-string"><span class="hljs-string">"cookies"</span></span> &gt; /dev/null</code> </pre> <br><pre> <code class="bash hljs">key=$(curl -s -b <span class="hljs-string"><span class="hljs-string">"cookies"</span></span> -b <span class="hljs-string"><span class="hljs-string">"PDAVersion=true"</span></span> -e <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$site</span></span></span><span class="hljs-string">"</span></span> -A <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ua</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$site</span></span></span><span class="hljs-string">/getData.jsp?actionParam=Logon&amp;appendTransactions=true&amp;format=html"</span></span> | grep -om 1 <span class="hljs-string"><span class="hljs-string">"val(), '[0-9]*'"</span></span> | sed <span class="hljs-string"><span class="hljs-string">"s/val(), //;s/'//g"</span></span>)</code> </pre> <br>  Promised key manipulations: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#ascii char -&gt; dec char code -&gt; xor -&gt; hex char code -&gt; unicode char #     dec () { for i in `echo $1 | sed 's/./&amp;\n/g'`; do printf '%d\n' "'$i"; done } #    2   xor () { for i in $*; do echo $(($i ^$key)); done } #  xor  dec  hex hex () { for i in $*; do printf '%X\n' "$i"; done } #       unicode () { for i in $*; do printf "\u$i"; done } dec=`dec "$pass"` xor=`xor $dec` hex=`hex $xor` char=`unicode $hex` echo $char &gt; /dev/null</span></span></code> </pre> <br>  At the output we will receive an encrypted password, which we authenticate with the help of a post-request on the site: <br><pre> <code class="bash hljs">curl -s -b <span class="hljs-string"><span class="hljs-string">"cookies"</span></span> -e <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$site</span></span></span><span class="hljs-string">"</span></span> -A <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ua</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$site</span></span></span><span class="hljs-string">/getData.jsp"</span></span> -d AuthMode=TBId -d PAN=912912<span class="hljs-variable"><span class="hljs-variable">$login</span></span> --data-urlencode PIN=<span class="hljs-variable"><span class="hljs-variable">$char</span></span> -d actionParam=GetPANRq -d appendParams=<span class="hljs-literal"><span class="hljs-literal">true</span></span> -d format=json -c cookies &gt; /dev/null</code> </pre> <br><br><img src="https://habrastorage.org/storage2/83f/551/4af/83f5514afc5443094e69990129e66fdc.png" alt="security"><br><h6>  It is rather unsafe to provide information about an invalid user ID, given that theoretically the maximum number of digital IDs in the database is 10 <sup>10</sup> , and digital passwords are only 10 <sup>6</sup> <pre>  <sub>Just do not frantically pull the mouse in the desire to use the brutus, nothing "tasty", except for information about the owner and transfers, you will not receive, because</sub>  <sub>98.76% of accounts do not have access to financial transactions, I guarantee)</sub> </pre></h6><br>  Now you can get the necessary data from the page, in my case, the amount on the account: <br><pre> <code class="bash hljs">cash=$(curl -s -b <span class="hljs-string"><span class="hljs-string">"cookies"</span></span> -b <span class="hljs-string"><span class="hljs-string">"twebank_authmode=TBId"</span></span> -e <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$site</span></span></span><span class="hljs-string">"</span></span> -A <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ua</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$site</span></span></span><span class="hljs-string">/getData.jsp?actionParam=AcctsMenu&amp;appendTransactions=true&amp;format=html"</span></span> | grep -o <span class="hljs-string"><span class="hljs-string">'unt"&gt;.*&lt;b'</span></span> | sed <span class="hljs-string"><span class="hljs-string">'s/unt"&gt;//;s/\.[0-9][0-9]&lt;b//;s/\ //g'</span></span>)</code> </pre> <br>  And now let's finish our plans by writing a small script to notify about changes in the amount: <br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -s <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$HOME</span></span></span><span class="hljs-string">/cashlog"</span></span> ] <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ `cat <span class="hljs-variable"><span class="hljs-variable">$HOME</span></span>/cashlog` = `cat <span class="hljs-variable"><span class="hljs-variable">$HOME</span></span>/cashlog | sed <span class="hljs-string"><span class="hljs-string">'s/[^0-9]//g'</span></span>` ] <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> cashlog=$(&lt;<span class="hljs-variable"><span class="hljs-variable">$HOME</span></span>/cashlog) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$cash</span></span></span><span class="hljs-string">"</span></span> -gt <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$cashlog</span></span></span><span class="hljs-string">"</span></span> ] <span class="hljs-comment"><span class="hljs-comment">#if [ $(echo "$cashlog &lt; $cash"|bc) -eq 1 ] then a=`expr $cash - $cashlog` in=$(echo "$a rub added to your account. Now you have $cash rub") echo $in python $HOME/sms_send.py -n "+79999999999" -t "$in" -l "some@mail.ru" -p "pass" echo "$cash" &gt; "$HOME/cashlog" elif [ "$cash" -lt "$cashlog" ] then z=`expr $cashlog - $cash` out=$(echo "Exchanged $z rub, you have $cash rub") echo $out python $HOME/sms_send.py -n "+79999999999" -t "$out" -l "some@mail.ru" -p "pass" echo "$cash" &gt; "$HOME/cashlog" #else echo "No changes, you have $cash rub" fi else echo "$cash" &gt; "$HOME/cashlog" echo "Cash log was updated" fi else echo "$cash" &gt; "$HOME/cashlog" echo "Cash log was created" fi</span></span></code> </pre> <br>  For sending SMS via mail.ru agent services, a small python script found on the Internet is used. <br>  Implement sending a message to the e-mail did not specifically, because  it will be implemented by means of cron. <br><br>  Using crontab, add an entry <br> <code>*/10 * * * * /path/to/script/ca.sh</code> <br>  to run the script every ten minutes. <br><br>  It is also worth adding to the beginning of the script a record like <code>MAILTO=your@mail.net</code> , with correctly configured sendmail (or its equivalent), cron will send messages to the specified soap with the results of the script output. <br><br>  You can view the whole script <a href="http://pastebin.com/MUZhqgw8">here</a> , tested on bash. <br><br>  I admit, the implementation does not shine with elegance, but the main thing, as they say, is the result.  The script was written in haste, with the thoughts ‚Äúwell, let it be, the main thing works,‚Äù so there are moments that were clearly worth implementing otherwise.  I hope to rewrite later, you can find on the same link.  With a small adjustment should work with any site that uses such an authentication scheme.  The main purpose of the article is to show by example how to solve such problems using standard unix tools.  I hope the article was useful to someone. <br><br>  Upd: It turned out that the old version of banking has no additional protection, i.e.  for its parsing there would be enough <a href="http://pastebin.com/ySDePJke">such script</a> . </div><p>Source: <a href="https://habr.com/ru/post/127451/">https://habr.com/ru/post/127451/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../127441/index.html">Python packages and their use</a></li>
<li><a href="../127444/index.html">Bot for browser game, network approach</a></li>
<li><a href="../127446/index.html">Yandex.Maps API: Address inside / outside MKAD, distance from MKAD</a></li>
<li><a href="../127448/index.html">Pakistan has banned the use of communication encryption protocols</a></li>
<li><a href="../127449/index.html">Survey: how many hours could we save?</a></li>
<li><a href="../127453/index.html">Matchstick Rectangles</a></li>
<li><a href="../127454/index.html">Raspberry Pi computer performance tested in Quake 3</a></li>
<li><a href="../127456/index.html">Google is working on DNS acceleration</a></li>
<li><a href="../127457/index.html">Google has made offline versions of Gmail, Calendar and Docs</a></li>
<li><a href="../127458/index.html">Faviconist: Create a beautiful favicon with HTML5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>