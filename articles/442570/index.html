<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sigma rules. Craft or new standard for SOC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I am Sergey Rublev, head of the SOC (Security Operations Center) at Infosecurit company. 
 In this article I will discuss in detail the ambitious proj...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sigma rules. Craft or new standard for SOC</h1><div class="post__text post__text-html js-mediator-article">  I am Sergey Rublev, head of the SOC (Security Operations Center) at Infosecurit company. <br>  In this article I will discuss in detail the ambitious project <a href="https://github.com/Neo23x0/sigma/">Sigma Rules</a> , the motto of which is: ‚ÄúSigma for logs is like Snort for traffic and Yara for files‚Äù. <br><br><img src="https://habrastorage.org/webt/xi/c9/_a/xic9_a4hwhjkjsi4shhsk2oqalk.png"><br><br>  It will be about three aspects: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  The applicability of the Sigma-rules syntax for maintaining a knowledge base of threat identification scenarios </li><li>  Possibilities of tools for generating rules for boxed SIEM systems </li><li>  The SOC value of the current content of the Sigma-rules public repositories </li></ul><a name="habracut"></a><br><h2>  Once upon a time, in a galaxy far far away </h2><br>  It all started a few years ago, when the trees were large, and our monitoring team was still small.  We are faced with a lot of questions, almost any team that grows into three people passes through this. <br><br><img src="https://habrastorage.org/webt/eu/0a/1t/eu0a1ti-3y93okrcileh_cymq3w.png"><br><br>  The causes of the questions are different: <br><br><ul><li>  Team growth </li><li>  Staff turnover </li><li>  A large number of heterogeneous systems on monitoring </li></ul><br>  In case you have to take a SIEM already tuned by someone, the number of questions grows like an avalanche. <br><br><h2>  Use Case Library </h2><br>  The world experience of building monitoring centers has already come up with a solution for organizing chaos and his name is the library of juz cases.  The goal of each case is to comprehensively describe the solution of a certain task within the framework of information security monitoring. <br><br>  The composition of knowledge laid down in each case can vary, we are repelled by the following set: <br><br><ul><li>  <b>Objective</b> - a task solved by a case </li><li>  <b>Threat</b> - a threat that is detected by the detection rule. </li><li>  <b>Stakeholders</b> - people interested in the work of this rule: IB / IT / Business </li><li>  <b>Data Requirements</b> - the data set required to identify the threat </li><li>  <b>Logic</b> - the logic of detecting threats </li><li>  <b>Testing</b> - an algorithm for testing the correctness of the detection rule </li><li>  <b>Priority</b> - priority of event handling by case (as a rule, it is calculated from the potential damage from a successfully realized threat) </li><li>  <b>Output</b> - A list of actions for parsing an alert, a description of the correct exits from the parsing procedure and the composition of the data recorded in the parsing results </li></ul><br>  Example use case for the task of detecting communication with the botnet control server (C &amp; C popularly or just C2): <br><br><img src="https://habrastorage.org/webt/jh/zz/s9/jhzzs9zblfsxc5-vehzmadc_hjk.png"><br><br>  The example is considerably simplified; in reality, the case with proper description expands into a multipage document. <br><br>  At that moment, when the number of cases exceeded several dozen, we began to look for ready-made tools for maintaining such a knowledge base, preferably having, besides human friendly, also some kind of machine friendly interface for work. <br><br><h2>  Sigma project </h2><br>  The Sigma project certainly deserves consideration in the context of the knowledge base on incident detection rules.  He started in 2016, and I follow him almost from the very beginning. <br><br>  In fact, the project consists of <br><br><ul><li>  Samih Sigma-rules </li><li>  Utilities for converting rules to queries for various SIEM systems </li></ul><br>  The list of SIEM is impressive: there are almost all popular solutions for analyzing events.  Then everything in detail and in order. <br><br><h2>  Syntax rules </h2><br>  Sigma rules are YAML documents that describe a script to detect a particular attack.  Syntactically, the rules consist of the following blocks: <br><br><h3>  Meta-information </h3><br>  The descriptive part to structure and simplify the search for the necessary rules. <br><br><pre><code class="plaintext hljs">title: Access to ADMIN$ Share description: Detects access to $ADMIN share author: Florian Roth falsepositives: - Legitimate administrative activity level: low tags: - attack.lateral_movement - attack.t1077 status: experimental</code> </pre> <br>  Separately, I would like to note that many of the rules are already supplied with links to the attack technique using the MITER ATT &amp; CK methodology. <br><br><h3>  Data source declaration </h3><br>  Description of the source based on the events of which the detection logic is implemented. <br><br><pre> <code class="actionscript hljs">logsource: product: windows service: security</code> </pre><br>  Syntactically, it is possible to describe both the final service of a specific product, and the whole category of systems. <br><br><h3>  Declaration of processing logic </h3><br>  At the detection logic level, the following are described: <br><br><ul><li>  Required patterns </li><li>  Values ‚Äã‚Äãof certain fields in the log </li><li>  Time frame </li><li>  Aggregate functions </li></ul><br>  The logic can be as trivial, for example, the conditions imposed on a set of fields: <br><br><pre> <code class="actionscript hljs">detection: selection: EventID: <span class="hljs-number"><span class="hljs-number">5140</span></span> ShareName: Admin$ filter: SubjectUserName: <span class="hljs-string"><span class="hljs-string">'*$'</span></span> condition: selection and not filter</code> </pre><br>  and quite complicated: <br><br><pre> <code class="actionscript hljs">detection: selection1: EventID: - <span class="hljs-number"><span class="hljs-number">529</span></span> - <span class="hljs-number"><span class="hljs-number">4625</span></span> UserName: <span class="hljs-string"><span class="hljs-string">'*'</span></span> WorkstationName: <span class="hljs-string"><span class="hljs-string">'*'</span></span> selection2: EventID: <span class="hljs-number"><span class="hljs-number">4776</span></span> UserName: <span class="hljs-string"><span class="hljs-string">'*'</span></span> Workstation: <span class="hljs-string"><span class="hljs-string">'*'</span></span> timeframe: <span class="hljs-number"><span class="hljs-number">24</span></span>h condition: - selection1 | count(UserName) by WorkstationName &gt; <span class="hljs-number"><span class="hljs-number">3</span></span> - selection2 | count(UserName) by Workstation &gt; <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre><br>  Although expressive means of language are not universal, they are still quite wide and allow us to describe a large number of cases for detecting attacks. <br><br><h2>  Rule development tools </h2><br>  In addition to your favorite text editor, SOC Prime's WEB UI is also available for YAML, which allows both to validate the syntax of an already written rule and to create rules manually from graphic blocks. <br><br><img src="https://habrastorage.org/webt/_a/fj/yv/_afjyva1emrq4kapfrzhsdfa25g.png"><br><br><h2>  Sigma as a means of maintaining the knowledge base </h2><br>  Let's summarize a brief summary. <br><br>  At the moment, the syntax of the rules mainly concentrates on the description of the threat detection logic and is not intended for a comprehensive description of the use case, respectively, it will not work to maintain a full-fledged library using only Sigma Rules. <br><br>  For the use case structure we chose, Sigma covers only half (Objective, Data requirements, Logic and Priority). <br><br><img src="https://habrastorage.org/webt/cc/f7/ee/ccf7ee58wrz2rtolzizshobhrdi.png"><br><br><h2>  Conversion to various SIEM </h2><br>  Since we are a SOC service provider, the idea of ‚Äã‚Äãkeeping all our developments according to the correlation rules in a universal format looked very tempting to us and at the implementation stage to convert the necessary SIEM into the format. <br><br>  The project includes console utilities for generating event requests in the format of various SIEM.  Consider what constitutes a conversion and what is under its hood. <br><br><img src="https://habrastorage.org/webt/ff/eh/6e/ffeh6eo7eo57c9jqruz-wzptwnm.png"><br><br>  The conversion takes place in 3 stages: <br><br><ol><li>  Parsing the rules - I think everything is clear with this: the YAML document is parsed into its component blocks </li><li>  Reduction to the taxonomy of the SIEM <br>  The need for this stage is due to the fact that normalization in the SIEM systems is implemented a little differently, respectively, the declaration from the Sigma-rules must be brought to the taxonomy of the events of the selected SIEM. </li><li>  Request generation for SIEM <br>  For this stage, another component is required - the backend for this SIEM. <br>  In fact, the backend is a plugin for the conversion utility, which incorporates the conversion logic to the final request format in SIEM.  The detection and logsource blocks are converted based on the previously applied field mapping, additional SIEM-specific information is added. <br></li></ol><br>  As a result, the launch of the conversion utility is as follows: <br><br><img src="https://habrastorage.org/webt/p8/co/pu/p8copuabozrkspbihteeynh_sxy.png"><br><br>  The following parameters are passed as parameters: <br><br><ul><li>  Target SIEM </li><li>  Rule </li><li>  File with mappings for this SIEM </li></ul><br><br>  SOC Prime also has a ready UI for the conversion function ( <a href="https://uncoder.io/">uncoder.io</a> ) <br><br><img src="https://habrastorage.org/webt/gz/-i/jj/gz-ijj-iw3bu_pcbng8orprja0w.png"><br><br><h2>  Conversion pitfalls </h2><br><ul><li>  Having studied the mechanics of conversion, we faced significant limitations, which kept us from transferring all the developments into the Sigma format: </li><li>  The converter operates only with the request.  The correlation rule in the SIEM covers more aspects: time window, aggregation, actions based on the results of detected alerts </li><li>  Key features of individual SIEMs, for example, ActiveLists, are not taken into account. </li><li>  Insufficient detailing of the mapping of fields - as part of the mapping configuration, the fields of just a few sources are described, respectively, having rules for several dozens of different types of event sources in the base, you have to invest heavily in writing mapping. </li></ul><br><h2>  Rule base </h2><br>  Let's see what the publicly available Sigma rule base carries.  Currently, content is actively being added to two repositories: <br><br><ul><li>  The main repository of the project </li><li>  SOC Prime Threat Detection Marketplace </li></ul><br>  The rules in the repository have a non-zero intersection. <br>  SOC Prime has a number of rules distributed in a paid subscription, I do not consider their content in this article. <br><br>  For analytics, we need a <a href="https://pypi.org/project/sigmatools/">sigmatools</a> library for Python and some programming skills. <br><br>  To parse and download the rules from the catalog to the dictionary, you can use the following code: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sigma.parser.collection <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> SigmaCollectionParser <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pathlib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> itertools <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alliter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(path)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> sub <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> path.iterdir(): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> sub.name.startswith(<span class="hljs-string"><span class="hljs-string">"."</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> sub.is_dir(): <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> alliter(sub) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> sub <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_inputs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(paths, recursive)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> recursive: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> list(itertools.chain.from_iterable([list(alliter(pathlib.Path(p))) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> paths])) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [pathlib.Path(p) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> paths] BASE_PATH = [<span class="hljs-string"><span class="hljs-string">r'sigma\rules'</span></span>] path_list = get_inputs(BASE_PATH, <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) rules_map = {} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> sigmafile <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> get_inputs(BASE_PATH, <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>): f = sigmafile.open(encoding=<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) parser = SigmaCollectionParser(f) rule = next(iter(parser)) rules_map[rule[<span class="hljs-string"><span class="hljs-string">'title'</span></span>]] = rule</code> </pre><br>  Deduplicating the same rules, the following picture emerges: <br><br><img src="https://habrastorage.org/webt/pd/92/jt/pd92jtrbth6glocd2kh-m9rcuqw.png"><br><br>  Within the framework of a unique list of rules, we obtain the following distributions: <br><br>  <b>By type of event source:</b> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/av/sn/h5/avsnh5hk5_szx4lfbc7tule8d9g.png"></div><br>  Slightly larger statistics <br><br><ul><li>  Windows ~ 80% </li><li>  Sysmon ~ 53% </li><li>  Proxy ~ 8% </li><li>  Linux ~ 4% </li></ul><br>  Basically, the current content is focused on the Windows system and Sysmon, in particular, only a few of the rules on other systems. <br><br>  <b>By the degree of content readiness:</b> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rt/v2/vd/rtv2vd91ppx816ok1jtdhchylmq.png"></div><br>  It turns out that the developers of the Sigma-rules marked as stable, less than 20% of all existing rules. <br><br><h2>  Let's sum up </h2><br>  There are a large number of rules in publicly available sources.  They are regularly updated, and the rules for detecting indicators appear quickly, and sometimes even the technician for the loudest APT companies. <br><br>  To apply the rules in real life there are a large number of restrictions: <br><br><ul><li>  A lot of rules for Microsoft Sysmon, which is rarely used in the enterprise. </li><li>  There are many rules that actually verify IoC (hashes, IP addresses, URLs, User Agents).  Such rules quickly become obsolete, and there are more efficient mechanisms than rules for searching for IoC. </li><li>  A lot of experimental content, respectively, imposes additional requirements on high-quality testing before commissioning. </li></ul><br>  In Infosecurity, we use the content of Sigma-rules as an additional source of knowledge for more efficient detection of incidents.  If we find something interesting, we implement it already within the framework of our correlation rules, which take into account the core of the rules (Apache Spark), and the specifics of the infrastructures and the security tools we use. </div><p>Source: <a href="https://habr.com/ru/post/442570/">https://habr.com/ru/post/442570/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../442556/index.html">Another remote story</a></li>
<li><a href="../442558/index.html">"If the product is not needed, no matter how you pack it, there will be no sense": how technology companies work on interfaces</a></li>
<li><a href="../442560/index.html">Mash: multithreading, coroutines, async & wait</a></li>
<li><a href="../442562/index.html">How to cool the equipment in the data center - three new technologies</a></li>
<li><a href="../442568/index.html">Security Week 10: NVIDIA driver vulnerabilities</a></li>
<li><a href="../442572/index.html">Using the Datapath Config Tool</a></li>
<li><a href="../442574/index.html">Created the basis for a generalized theory of neural networks</a></li>
<li><a href="../442576/index.html">Long live overclockers: how liquid cooling has become dominant in data centers</a></li>
<li><a href="../442578/index.html">Linux 5.0 release</a></li>
<li><a href="../442580/index.html">Reverse engineering of a binary format on the example of Korg .SNG files</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>