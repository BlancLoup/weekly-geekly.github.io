<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ASP.NET Identity Cach√© Provider - we work with Identity through InterSystems Cach√©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="With the advent of Microsoft's .NET ASP.NET Identity technology, developers have increasingly begun to use it when creating web applications. For a br...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ASP.NET Identity Cach√© Provider - we work with Identity through InterSystems Cach√©</h1><div class="post__text post__text-html js-mediator-article">  With the advent of Microsoft's .NET ASP.NET Identity technology, developers have increasingly begun to use it when creating web applications.  For a brief insight into the technology, we suggest reading the <a href="https://habrahabr.ru/post/227351/">article</a> .  This technology is present in the standard project template and allows you to use the standard implementation of user authentication and authentication functionality. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c9a/1f0/935/c9a1f093507410e05ad082e01110a6e7.jpg" alt="image"></div><br><br>  Out of the box, the data provider for ASP.NET Identity is MSSQL, but since the Identity authorization system can interact with any other relational DBMS, we researched and implemented this feature for InterSystems Cach√©. <br><a name="habracut"></a><br>  First, what is all this for?  Imagine that your project uses a Cach√© DBMS on .NET and you need a complete and reliable authorization system.  It is extremely inexpedient to write such a system from scratch, naturally, that you want to use the existing analog in .NET - ASP.NET Identity.  But in its pure form, the framework is able to work only with its native Microsoft DBMS - MS SQL.  Our task was to implement an adapter that allows easy movement of the Identity to DBMS Intersystems Cache.  The task was implemented in ASP.NET Identity Cach√© Provider. <br>  The core of the ASP.NET Identity Cach√© Provider project is to implement the Cach√© Data Provider for ASP.NET Idenity.  The main task was to store and provide access to the <i>AspNetRoles</i> , <i>AspNetUserClaims</i> , <i>AspNetUserLogins</i> , <i>AspNetUserRoles</i> and <i>AspNetUsers tables</i> without disrupting the standard logic of working with these tables. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">A couple of words about ASP.NET Identity architecture</b> <div class="spoiler_text">  The key objects in Asp.Net Identity are users and roles.  All the functionality to create and delete users, interact with the user repository is stored in the <i>UserManager</i> class.  The <i>RoleManager</i> class is defined for working with roles and their management in Asp.Net Identity.  Below is a Microsoft.AspNet.Identity.Core class diagram. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1ac/a5a/f02/1aca5af0231b611e3a941f229dc0ac83.jpg" alt="image"></div><br><br><br>  Each user for <i>UserManager</i> provides a <i>IUser</i> interface <i>object</i> .  In this case, all user management operations are performed through the storage provided by the <i>IUserStore</i> object.  Each role represents an implementation of the <i>IRole</i> interface, and manipulations with roles (add, change, delete) are performed via the RoleManager.  Directly implementing the <i>IUser</i> , <i>IRole</i> , <i>IUserStore</i> and <i>IRoleStore interfaces</i> provides the Microsoft.AspNet.Identity EntityFramework namespace, where classes such as <a href="https://msdn.microsoft.com/en-us/library/dn613256(v%3Dvs.108).aspx">IdentityUser</a> , <a href="https://msdn.microsoft.com/en-us/library/dn613259(v%3Dvs.108).aspx">UserStore</a> , <a href="https://msdn.microsoft.com/en-us/library/dn613249(v%3Dvs.108).aspx">IdentityRole</a> , <a href="https://msdn.microsoft.com/en-us/library/dn613257(v%3Dvs.108).aspx">RoleStore</a> , <a href="https://msdn.microsoft.com/en-us/library/dn613255(v%3Dvs.108).aspx">IdentityDbContext</a> are available for use. <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f9e/5b1/107/f9e5b1107135e9ea48f3787b968ea432.jpg" alt="image"></div><br><br>  If you need to store additional information about the user, which is not in the specified tables by default, there is a class <i>IdentityUserClaim</i> (stamps) that allows you to add the necessary fields and then use them, for example, when registering a user. <br></div></div><br>  Let us consider the implementation of the Cach√© Data Provider for ASP.NET Identity.  It took place in two stages: <br><br>  - Implementation of data storage classes (which will be responsible for state storage) and the <i>IdentityDbContext</i> class, which encapsulates all the low-level logic of working with the data storage.  The <i>IdentityDbInitializer</i> class has also been implemented, which adapts the Cach√© database to work with Identity. <br>  - Implementation of the <i>UserStore</i> and <i>RoleStore classes</i> (together with the integration <br>  tests).  Demonstration project. <br><br>  During the first stage the following classes were implemented: <br>  - <i>IdentityUser</i> - implementation of the <a href="https://msdn.microsoft.com/en-us/library/microsoft.aspnet.identity.iuser(v%3Dvs.108).aspx">IUser</a> interface. <br>  - <i>IdentityUserRole</i> - associative entity for User ‚Äì Role communication. <br>  - <i>IdentityUserLogin</i> - data about user logins. <br><br>  An extensible version of the <a href="https://msdn.microsoft.com/en-us/library/microsoft.aspnet.identity.userlogininfo(v%3Dvs.108).aspx">UserLoginInfo</a> class. <br>  - <i>IdentityUserClaim</i> - data on user stamps. <br>  - <i>IdentityDbContext</i> &lt;TUser, TRole, TKey, TUserLogin, TUserRole, TUserClaim&gt; is the context of the Entity Framework database. <br><br>  Consider in more detail the essence of <i>IdentityUser</i> , which is a repository for users, roles, logins, stamps and user-role connections.  An example of the implementation of the usual and generic version of <i>IdentityUser</i> . <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">InterSystems.AspNet.Identity.Cache</span></span> { <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> IUser implementation </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public class IdentityUser : IdentityUser</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string, IdentityUserLogin, IdentityUserRole, IdentityUserClaim&gt;</span></span></span><span class="hljs-comment">, IUser { </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Constructor which creates a new Guid for the Id </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public IdentityUser() { Id = Guid.NewGuid().ToString(); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Constructor that takes a userName </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="userName"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> public IdentityUser(string userName) : this() { UserName = userName; } } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> IUser implementation </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TKey"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TLogin"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TRole"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TClaim"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> public class IdentityUser</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TKey, TLogin, TRole, TClaim&gt;</span></span></span><span class="hljs-comment"> : IUser</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TKey&gt;</span></span></span><span class="hljs-comment"> where TLogin : IdentityUserLogin</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TKey&gt;</span></span></span><span class="hljs-comment"> where TRole : IdentityUserRole</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TKey&gt;</span></span></span><span class="hljs-comment"> where TClaim : IdentityUserClaim</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TKey&gt;</span></span></span><span class="hljs-comment"> { </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Constructor </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public IdentityUser() { Claims = new List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TClaim&gt;</span></span></span><span class="hljs-comment">(); Roles = new List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TRole&gt;</span></span></span><span class="hljs-comment">(); Logins = new List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TLogin&gt;</span></span></span><span class="hljs-comment">(); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Email </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public virtual string Email { get; set; }</span></span></code> </pre> <br>  To implement the restriction of access rights in Identity are special objects - Roles.  The role in the configuration may correspond to the positions or activities of different user groups. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">InterSystems.AspNet.Identity.Cache</span></span> { <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> EntityType that represents a user belonging to a role </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public class IdentityUserRole : IdentityUserRole</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string&gt;</span></span></span><span class="hljs-comment"> { } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> EntityType that represents a user belonging to a role </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TKey"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> public class IdentityUserRole</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TKey&gt;</span></span></span><span class="hljs-comment"> { </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> UserId for the user that is in the role </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public virtual TKey UserId { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> RoleId for the role </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public virtual TKey RoleId { get; set; } } }</span></span></code> </pre><br>  <i>IdentityDbContext</i> - an entity that encapsulates the creation of a connection, the loading of entities from the database, the validation of the correspondence of user objects to the structure of related tables and field values.  As an example, consider the <i>OnModelCreating</i> method, which validates tables in accordance with the requirements of the Identity. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnModelCreating</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DbModelBuilder modelBuilder</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Mapping and configuring identity entities according to the Cache tables var user = modelBuilder.Entity&lt;TUser&gt;() .ToTable("AspNetUsers"); user.HasMany(u =&gt; u.Roles).WithRequired().HasForeignKey(ur =&gt; ur.UserId); user.HasMany(u =&gt; u.Claims).WithRequired().HasForeignKey(uc =&gt; uc.UserId); user.HasMany(u =&gt; u.Logins).WithRequired().HasForeignKey(ul =&gt; ul.UserId); user.Property(u =&gt; u.UserName) .IsRequired() .HasMaxLength(256) .HasColumnAnnotation("Index", new IndexAnnotation(new IndexAttribute("UserNameIndex") { IsUnique = true })); user.Property(u =&gt; u.Email).HasMaxLength(256); modelBuilder.Entity&lt;TUserRole&gt;() .HasKey(r =&gt; new { r.UserId, r.RoleId }) .ToTable("AspNetUserRoles"); modelBuilder.Entity&lt;TUserLogin&gt;() .HasKey(l =&gt; new { l.LoginProvider, l.ProviderKey, l.UserId }) .ToTable("AspNetUserLogins"); modelBuilder.Entity&lt;TUserClaim&gt;() .ToTable("AspNetUserClaims"); var role = modelBuilder.Entity&lt;TRole&gt;() .ToTable("AspNetRoles"); role.Property(r =&gt; r.Name) .IsRequired() .HasMaxLength(256) .HasColumnAnnotation("Index", new IndexAnnotation(new IndexAttribute("RoleNameIndex") { IsUnique = true })); role.HasMany(r =&gt; r.Users).WithRequired().HasForeignKey(ur =&gt; ur.RoleId); }</span></span></code> </pre><br>  <i>DbModelBuilder</i> is used to compare CLR classes with a database schema.  This code-oriented approach to building an EDM model is called Code First.  <i>DbModelBuilder is</i> commonly used to tune a model by overriding <i>OnModelCreating (DbModelBuilder)</i> .  However, <i>DbModelBuilder</i> can also be used independently of <i>DbContext</i> to build a model and then construct a <i>DbContext</i> or <i>ObjectContext</i> . <br><br>  The <i>IdentityDbInitializer</i> class prepares the Cach√© database for <i>Identity</i> use. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitializeDatabase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DbContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connection = BuildConnection(context)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tables = GetExistingTables(connection); CreateTableIfNotExists(tables, AspNetUsers, connection); CreateTableIfNotExists(tables, AspNetRoles, connection); CreateTableIfNotExists(tables, AspNetUserRoles, connection); CreateTableIfNotExists(tables, AspNetUserClaims, connection); CreateTableIfNotExists(tables, AspNetUserLogins, connection); CreateIndexesIfNotExist(connection); } }</code> </pre><br>  The <i>CreateTableIfNotExists</i> methods create the necessary tables, if they do not already exist.  Checking the existence of a table is done by querying the <b>Cache</b> table <b>- Dictionary.CompiledClass</b> , which stores information about already existing tables.  If a table has not yet been created, it is created. <br><br>  At the second stage, such entities as IdentityUserStore and IdentityRoleStore, which encapsulate the logic of adding, editing and deleting users, and roles were implemented.  These entities required 100% coverage with unit tests. <br><br>  To summarize: a data provider was implemented for Cach√© DBMS with the Entity Framework in the context of ASP.NET Identity technology.  The application is designed in a separate Nuget-package, and now, if you need to work with the Cach√© DBMS, and at the same time use the standard Microsoft authorization, you simply integrate the Identity Cach√© Provider assembly into the project through the Nuget Package Manager. <br><br>  The implementation of the project with the source code, an example and tests is laid out on <a href="https://github.com/intersystems-ru/identity_cache">GitHub</a> . </div><p>Source: <a href="https://habr.com/ru/post/301368/">https://habr.com/ru/post/301368/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../301358/index.html">Why you need to visit Novosibirsk AngelHack?</a></li>
<li><a href="../301360/index.html">The digest of interesting materials for the mobile # 154 developer (May 16-22)</a></li>
<li><a href="../301362/index.html">How a new phone helped to find a Vkontakte vulnerability</a></li>
<li><a href="../301364/index.html">Mastering Android NDK</a></li>
<li><a href="../301366/index.html">An honest story of launch, existence, and possibly failure</a></li>
<li><a href="../301370/index.html">Unkillable Postgresql cluster inside Kubernetes cluster</a></li>
<li><a href="../301374/index.html">Paul Graham: A few words about resourcefulness (A Word to the Resourceful)</a></li>
<li><a href="../301378/index.html">An easy way to organize requirements at the requirements gathering stage (or the first step to forming a comfortable backlog)</a></li>
<li><a href="../301380/index.html">Swift 3.0, a lot of noise, but in practice?</a></li>
<li><a href="../301384/index.html">Hibernate Developer Documentation - Chapter I. Database Access</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>