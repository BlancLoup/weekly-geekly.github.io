<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mikrotik Router OS, We are looking for your server in a foreign network. Or how not to pay big money</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mikrotik Router OS, We are looking for your server in a foreign network. Or how not to pay big money 

 All of us have heard more than once about the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mikrotik Router OS, We are looking for your server in a foreign network. Or how not to pay big money</h1><div class="post__text post__text-html js-mediator-article"><h4>  Mikrotik Router OS, We are looking for your server in a foreign network.  Or how not to pay big money </h4><br><br>  All of us have heard more than once about the grand support of small business and private entrepreneurship in our country.  While you are an individual, you have no problems.  But as soon as you collected your thoughts and decided to start your own business, you instantly end up with money (horse interest in banks, taxes, contributions to the Pension Fund, extortions, fines, inflation, and other cotton wool).  Providers especially distinguished themselves in this regard; if the requirements for a simple home user are minimal, then for private entrepreneurs and organizations there is a special approach.  Namely: if you rented non-residential premises for work, it means that you are a cash cow and have to pay a lot of money to the provider.  Yes, of course, very well, if you managed to agree with the provider and draw up an agreement for an individual, well, let's say, not far your friend lives who agrees to put the wifi in the window.  But if these options do not roll, there is another way not to pay the provider a lot of money.  :) <br><br>  The idea is that nowadays it is not difficult to find a provider with an internal local network 10.0.0.0/255.0.0.0 or 192.168.0.0/255.255.0.0 and organize two points in it (An individual with a cheap, unlimited Internet will be a server) ( An organization with expensive Internet by Internet will be a Client) between them we are raising a VPN. <br><a name="habracut"></a><br>  In principle, there is no problem if the provider‚Äôs gray addresses are static, but if not, then we will have to use the DDNS service on the Internet.  local service may not be. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/e31/dfa/710/e31dfa71075b60fb71073d56ea8bcac6.jpg" alt="image"><br><br>  <a href="">Full size pichka</a> <br><br>  There are a lot of DDNS services on the Internet, but most of them recede into the background, because the microtic doesn't work with them, or they are not suitable for our purposes. <br><br>  We will use the DDNS service changeip.com because of its support since versions 2.X <br><br>  In the process of developing a script to send a gray ip address, one significant problem arose.  The changeip.com service with each DNS name update checks the ip of the address that was sent in the message to the networks with the first octets 10 and 192.168.  If this accessory occurs, replaces the address from the message to the white ip, which is determined automatically by the changeip.com service, and unfortunately we can‚Äôt disable this option :( <br><br>  It was decided to mask the first octet of the ip address before sending, and replace it when it was received. <br><br><h5>  Server part, parameters: </h5><br> <code>:local interfacename ("eth1"); -    . <br> :local replacement ("222"); -    ip ,  ,     .   10. - 00-99,  192.  100-254. <br> :local dnsname ("my.server.ddns.info"); -DNS   . <br> :local login ("login"); -   changeip.com <br> :local password ("password"); -   changeip.com</code> <br> <br><h5>  Server part, code: </h5><br> <code><a href="http://mikrotik.axiom-pro.ru/"></a> ################################################## <br> #Server Part <br> ################################################## <br> <br> #Settings <br> ################################################## <br> <br> :local interfacename ("eth1"); <br> :local replacement ("222"); <br> :local dnsname ("my.server.ddns.info"); <br> :local login ("login"); <br> :local password ("password"); <br> <br> ################################################## <br> <br> ################################################## <br> <br> :local CurrentDynDNSIP ([:resolve $dnsname]); <br> :local TMPDynDNSIP ([/ip address get [/ip address find interface=$interfacename] address]); <br> :local RealDynDNSIP ([:pick $TMPDynDNSIP 0 ([:len $TMPDynDNSIP]-3)]); <br> :local ShortIP ([:pick $RealDynDNSIP ([:len $replacement]) ([:len $RealDynDNSIP])]); <br> :local FakeIP ($replacement . $ShortIP); <br> :if ($CurrentDynDNSIP != $FakeIP) do={/tool dns-update name=$dnsname address=$FakeIP key-name=$login key=$password}; <br> <br> ################################################## <br> #(C) Inlarion icq 429-587 mikrotik.axiom-pro.ru Copyright! <br> ##################################################</code> <br> <br><h5>  Description: </h5><br>  The principle of the server part is very simple, the ip address is taken from the specified interface, the subnet mask is truncated, the first octet is replaced with masking and sent to changeip.com <br><br><h5>  Client part, parameters: </h5><br> <code>:local dnsname ("my.server.ddns.info"); -DNS      ip . <br> :local replacement ("192"); -     . <br> :local gateoctet ("1"); -       :local internettype  "ethernet"        192.168..1   . <br> <br> :local internetname ("LAN"); -        . <br> :local internettype ("ethernet"); -       "ethernet"   . <br> :local internetdns ("192.168.3.1"); DNS  . <br> <br> :local tunnelname ("ISP1"); -        . <br> :local tunneltype ("pptp"); -  ,    "pptp"  "l2tp". <br> :local tunneldns ("192.168.90.1"); - DNS  PPTP  L2TP .</code> <br> <br><h5>  Client part, code: </h5><br> <code><a href="http://mikrotik.axiom-pro.ru/"></a> #################################################### <br> #Client part <br> #################################################### <br> <br> #Settings <br> #################################################### <br> <br> :local dnsname ("my.server.ddns.info"); <br> :local replacement ("192"); <br> :local gateoctet ("1"); <br> <br> :local internetname ("LAN"); <br> :local internettype ("ethernet"); <br> :local internetdns ("192.168.3.1"); <br> <br> :local tunnelname ("ISP1"); <br> :local tunneltype ("pptp"); <br> :local tunneldns ("192.168.90.1"); <br> <br> #################################################### <br> <br> :global internetgate (" "); <br> <br> #################################################### <br> :if ( $internettype != "ethernet" ) do={ <br> :set internetgate ([/ip address get [/ip address find interface=$internetname] network]); <br> } else={ <br> :set internetgate ([/ip address get [/ip address find interface=$internetname] network]); <br> :local ShortIP ([:pick $internetgate 0 ([:len $internetgate]-1)] ); <br> :set internetgate ($ShortIP . $gateoctet); <br> }; <br> #################################################### <br> <br> :if ($tunneltype = "pptp") do={ <br> /interface pptp-client monitor [/interface pptp-client find name=$tunnelname] once do={ <br> :if ($status != "connected") do={ <br> :if ($internetdns != [/ip dns get servers]) do={ /ip dns set servers=$internetdns; }; <br> } else={ <br> :if ($tunneldns != [/ip dns get servers]) do={ /ip dns set servers=$tunneldns; }; <br> }; <br> }; <br> }; <br> <br> :if ($tunneltype = "l2tp") do={ <br> /interface l2tp-client monitor [/interface l2tp-client find name=$tunnelname] once do={ <br> :if ($status != "connected") do={ <br> :if ($internetdns != [/ip dns get servers]) do={ /ip dns set servers=$internetdns; }; <br> } else={ <br> :if ($tunneldns != [/ip dns get servers]) do={ /ip dns set servers=$tunneldns; }; <br> }; <br> }; <br> }; <br> <br> #################################################### <br> :local WWW ([:resolve changeip.com]); <br> :local NIC ([:resolve nic.changeip.com]); <br> :if ( [/ip route find comment="WWW_changeip.com"] = "" ) do={ /ip route add dst-address=$WWW gateway=$internetgate comment="WWW_changeip.com" }; <br> :if ( [/ip route find comment="NIC_changeip.com"] = "") do={ /ip route add dst-address=$NIC gateway=$internetgate comment="NIC_changeip.com" }; <br> :if ( [/ip route find comment="INTERNET_DNS"] = "") do={ /ip route add dst-address=$internetdns gateway=$internetgate comment="INTERNET_DNS" }; <br> :if ( [/ip route get [/ip route find comment="WWW_changeip.com"] dst-address] != $WWW) do={ /ip route set [/ip route find comment="WWW_changeip.com"] dst-address=$WWW gateway=$internetgate }; <br> :if ( [/ip route get [/ip route find comment="NIC_changeip.com"] dst-address] != $NIC) do={ /ip route set [/ip route find comment="NIC_changeip.com"] dst-address=$NIC gateway=$internetgate }; <br> :if ( [/ip route get [/ip route find comment="INTERNET_DNS"] dst-address] != $internetdns) do={ /ip route set [/ip route find comment="INTERNET_DNS"] dst-address=$internetdns gateway=$internetgate }; <br> #################################################### <br> <br> :if ($tunneltype = "pptp") do={ <br> :local CurrentVHNIP ([:resolve $dnsname]); <br> :local TMPVHNIP ([/interface pptp-client get [/interface pptp-client find name=$tunnelname] connect-to]); <br> :local ShortIP ([:pick $CurrentVHNIP ([:len $replacement]) ([:len $CurrentVHNIP])]); <br> :local RealDNSIP ($replacement . $ShortIP); <br> :if ($RealDNSIP != $TMPVHNIP) do={/interface pptp-client set [/interface pptp-client find name=$tunnelname] connect-to=$RealDNSIP; }; <br> }; <br> <br> :if ($tunneltype = "l2tp") do={ <br> :local CurrentVHNIP ([:resolve $dnsname]); <br> :local TMPVHNIP ([/interface l2tp-client get [/interface l2tp-client find name=$tunnelname] connect-to]); <br> :local ShortIP ([:pick $CurrentVHNIP ([:len $replacement]) ([:len $CurrentVHNIP])]); <br> :local RealDNSIP ($replacement . $ShortIP); <br> :if ($RealDNSIP != $TMPVHNIP) do={/interface l2tp-client set [/interface l2tp-client find name=$tunnelname] connect-to=$RealDNSIP; }; <br> }; <br> <br> #################################################### <br> #(C) Inlarion icq 429-587 mikrotik.axiom-pro.ru Copyright! <br> ####################################################</code> <br> <br><h5>  Description: </h5><br>  The principle of the client part a little more complicated.  The first is the definition of a gateway to the Internet through an expensive provider.  The second step is to check the connection to the VPN server, if there is no connection, the DNS provider is installed, if there is a connection, the DNS server is installed.  The third step is installing / updating routes through the main provider for DNS and changeip.com servers.  The last step is to check the server's ip address in the connection properties with the address that was received from changeip.com with an edited octet. <br><br>  In conclusion, I would like to note that this method is not a violation of the terms of the contract, if the contract with the provider is made on you, and you personally use it. <br>  This method has obvious drawbacks; about the strong distance of the client from the server, the traffic will pass through the provider's subnets, and in each subnet, in addition to routers, there are smart switches with QoS support, which during prime time will negate the entire transmission. <br><br>  To avoid packet loss and not to get much QoS, it is advisable to locate the server and the client on the same subnet, or to pay attention to the ‚ÄúPaid Inter-subscriber Traffic‚Äù service where information is transmitted between two white addresses of subscribers of one provider.  This service costs from 2-15kop. / MB.  and has the same priority as internet traffic. </div><p>Source: <a href="https://habr.com/ru/post/111943/">https://habr.com/ru/post/111943/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../111931/index.html">Laptop increased vitality</a></li>
<li><a href="../111932/index.html">Statistics: Half of US Adult Internet Users Work with Wikipedia</a></li>
<li><a href="../111934/index.html">Long-lived computer skills, or What to teach children and students</a></li>
<li><a href="../111935/index.html">Fibonacci numbers on Brainfuck</a></li>
<li><a href="../111939/index.html">3D without glasses</a></li>
<li><a href="../111945/index.html">The first signed homebrew for psp and some thoughts on the topic</a></li>
<li><a href="../111947/index.html">The jQuery 1.5 beta 1 release is available for testing.</a></li>
<li><a href="../111948/index.html">Learn more about changing the HTML video codec in Chrome.</a></li>
<li><a href="../111950/index.html">A / B Experience Test Download Page</a></li>
<li><a href="../111951/index.html">3D without glasses</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>