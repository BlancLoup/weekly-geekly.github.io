<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>GPRS inside. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue our acquaintance with the packet transmission in the networks of mobile operators, which we started with you in the first part about GPRS ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>GPRS inside. Part 2</h1><div class="post__text post__text-html js-mediator-article">  We continue our acquaintance with the packet transmission in the networks of mobile operators, which we started with you in the <a href="http://habrahabr.ru/blogs/telecom/80951/">first</a> part about GPRS / EDGE technologies.  This article will discuss the process of authentication and authorization, the so-called.  the GPRS Attach procedure, as well as the activation of the service requested by the subscriber - raising the PDP Context.  Let's see what data is stored on the SGSN side, and which data is on the subscriber side. <br>  Well, let's go ... <br><br><a name="habracut"></a><br><h5>  GPRS Attach </h5><br>  I will miss some of the processes immediately preceding and accompanying the GPRS Attach procedure, and more specifically: <br><ul><li>  allocation of radio resources </li><li>  the exchange of service information on the logical channels between the base station and the subscriber terminal </li><li>  data link establishment </li><li>  terminal status change </li></ul><br>  If anyone is interested in the details, please ask questions.  We will start immediately with the GPRS Attach procedure, which allows identifying the subscriber, determining which services are available to the subscriber, checking the legality of using the mobile terminal of the subscriber in the operator‚Äôs network ( <a href="http://ru.wikipedia.org/wiki/IMEI">IMEI</a> Check procedure is optional) and actually enabling the subscriber to activate the service he requests. <br><br>  The process of authentication and authorization, the so-called.  GPRS Attach procedure, is shown in the diagram below (the image is clickable). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7c9/1df/e49/7c91dfe4957ef0e852b9c8f9eef5000e.jpg" width="200" alt="image"></div><br><ol><li>  <b>Attach Request</b> <br>  The GPRS Attach procedure starts with a subscriber request from your mobile terminal, GPRS / EDGE service (or when the subscriber selects a permanent connection to the packet network on the device: Menu -&gt; Settings -&gt; Device connection -&gt; Packet data -&gt; Packet connection -&gt; On Demand / Permanent access), i.e.  opening a mobile browser / checking mail / trying to send MMS / etc., which in turn initiates sending an Attach Request request if the subscriber has not been connected to the operator‚Äôs packet network before.  If the subscriber is going to connect to the network for the first time, then the request will contain the following basic data: <br><ul><li>  Attach type: GPRS Attach (subscription for packet data only), IMSI attach (subscription for voice services only, if the subscriber is registered to perform / accept voice services), Combined Attach (combined subscription = voice + packet data) </li><li>  P-TMSI ( <a href="http://ru.wikipedia.org/wiki/IMSI">IMSI</a> replacement, in case the subscriber is already ‚Äúknown‚Äù to SGSN) </li><li>  RAI = MCC + MNC + LAC + RAC, i.e.  subscriber coordinates within the base station subnet <br><blockquote>  <i>RAI</i> - Routing Are Identity <br>  <i>MCC</i> - Mobile Country Code (international country code) <br>  <i>MNC</i> - Mobile Network Code (international operator code within the country) <br>  <i>LAC</i> - Location Area Code (set of base stations united by one code) <br>  <i>RAC</i> - Routing Area Code (zone smaller or equal to LAC) <br></blockquote></li><li>  MS network capability - subscriber terminal capabilities in terms of data transfer </li><li>  MS radio access capability - subscriber terminal capabilities in terms of radio transmission </li></ul><br></li><li>  <b>Identification Request</b> <br>  If the subscriber was previously in the service area of ‚Äã‚Äãanother SGSN, then when switching to service at the new SGSN, the subscriber does not need to re-provide all the information for his identification, since  it will be requested from the previous item.  If the subscriber at that time used the services of GPRS / EDGE, i.e.  he had the PDP Context open, the new SGSN would ‚Äúpick up‚Äù the subscriber along with his session, without interrupting the service. <br></li><li>  <b>Identity Request (Req) / Response (Res)</b> <br>  This procedure is carried out, for new subscribers, or for subscribers, the data about which were not transmitted (or transferred incorrectly) from the old SGSN, then the SGSN again asks for all the data from the subscriber that we considered in the Attach Request procedure (instead of P- TMSI [Packet-TMSI], TMSI [Temporary Mobile Station Identity] are required by IMSI [International Mobile Subscriber Identity]). <br></li><li>  <b>Send Authentication Info Req / Res</b> <br>  During this procedure, the SGSN, based on the IMSI of the subscriber, makes a request to the HLR / AuC, which is a database of subscribers of the operator‚Äôs network.  On the HLR / AuC, IMSI side of the subscriber there corresponds a certain checksum / secret number - K <sub>i</sub> , and also on the HLR / AuC side there is a randomized generator that generates a random number for our request.  Then formed, so-called.  triplet [TRIPLETS = RAND + SRES (Signed Response) + K <sub>with</sub> ] data, which consists of: <br><ul><li>  Rand is a random number </li><li>  SRES - the result of ‚Äúsweeping‚Äù a random number RAND through the algorithm A3 </li><li>  K <sub>with</sub> - the result, ‚Äúsweep‚Äù the number of K <sub>i</sub> through the algorithm A5 </li></ul>  The data triple is then sent to the SGSN. <br></li><li>  <b>Authentication and Cyphering Req / Res</b> <br>  The values ‚Äã‚Äãobtained from the HLR / AuC are stored on the SGSN side, and the value of the RAND number is transmitted to the subscriber‚Äôs mobile terminal, based on which the SRES and K <sub>c</sub> values ‚Äã‚Äãare ‚Äúcalculated‚Äù on the subscriber side.  The A3 / A5 encryption algorithms, as well as the secret number K <sub>i, are</sub> ‚Äúsewn up‚Äù in the subscriber‚Äôs <a href="http://ru.wikipedia.org/wiki/SIM-%25D0%25BA%25D0%25B0%25D1%2580%25D1%2582%25D0%25B0">SIM</a> card. <br></li><li>  <b>Identity Check Request (Req) / Response (Res)</b> <br>  This procedure is optional and allows you to check the legality of using the subscriber‚Äôs terminal in the operator‚Äôs network, i.e.  request the IMEI code of the terminal and compare it with the databases of the White, Gray and Black lists.  If the subscriber is on the Black List, he will be denied service at this stage, but this is all in theory.  In practice, it turns out the opposite, because  in fact, the blacklist blocking is still not working (I speak for the territory of Ukraine). <br></li><li>  <b>Check IMEI Req / Res</b> <br>  Check IMEI on the <a href="http://ru.wikipedia.org/wiki/EIR">EIR</a> , on the basis of which a decision will be made on the legitimacy of using the subscriber‚Äôs terminal in the operator‚Äôs network. <br></li><li>  <b>Location Update Procedures Req / Res</b> <br>  During the GPRS Attach procedure, the subscriber‚Äôs location information is updated, i.e.  The SGSN updates the information in the HLR, and then the HLR updates the data in the MSC / VLR. <br>  <i>If the subscriber performs Combined Attach, the SGSN updates the subscriber information in the MSC / VLR</i> </li><li>  <b>Attach Accept</b> <br>  After successfully completing all the above operations, SGSN informs the subscriber that the GPRS Attach is accepted and the subscriber can now use the packet data services in the operator‚Äôs network. <br></li><li>  <b>TMSI Realocation Complete</b> <br>  The final stages is the update / notification of the MSC / VLR of the new <a href="http://ru.wikipedia.org/wiki/TMSI">TMSI</a> value assigned to the subscriber. <br></li></ol><br>  This is actually the way the subscriber is authenticated and authorized to provide the transfer of packet data to the operator‚Äôs network.  After this procedure, a letter ‚ÄúG‚Äù (or ‚ÄúE‚Äù :) will appear on the subscriber‚Äôs terminal, indicating that the connection to the packet network has been successfully completed, but this still does not allow the subscriber to use any service * in the packet network, since  you must also activate the PDP Context for the requested service. <br><blockquote>  * - after a successful GPRS Attach procedure, the subscriber can only send short messages via the GPRS / EDGE network, so-called.  SMS over GPRS. <br></blockquote><br><h5>  PDP Context Activation </h5><br>  After successfully completing the GPRS Attach procedure, the user can activate the PDP Context, which will allow him to use the packet data services. <br><br>  The context activation procedure itself is somewhat similar to the communication activation procedure during a dial-up connection.  Let's look at these two procedures in comparison. <br>  Simply put, the procedure for activating the Dial-Up link can be represented as a scheme: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/e4d/677/521/e4d6775217958b1ad510de5ee998a62d.png" alt="image"></a> <br><br>  Now let's look at the PDP Context'a concept of activation: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/ea5/77a/d52/ea577ad528a1f2d796a5e4340bf15927.png" alt="image"></a> <br><br>  As you can see, the similarity between these two procedures consists in applying the same protocols, the steps themselves and the procedures that are used during the connection establishment stages, and the key nodes involved in the communication establishment process are similar. <br><br>  Having determined the key moments, when PDP Context is activated, we consider the full procedure and determine what data is transmitted during this procedure. <br><br>  The PDP Context'a activation scheme is shown in the figure below: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/307/635/322/30763532202f01baecea00843296d46f.jpg" alt="image"></a> <br><br><ol><li>  <b>Activate PDP Context Request</b> <br>  In this request, quite a lot of different data is transmitted, but we will be more interested in the following: <br><ul><li>  QoS requested - the requested subscriber service profile, quality characteristics of the connection, if this field is empty, the SGSN will decide on the assigned profile </li><li>  PDP type - determines what type of protocol will be used by the terminal for a specific IP / X.25 / etc service. </li><li>  Address - type of address issued to the subscriber for communication in the network [IPv4, IPv6, auto] </li><li>  APN * [Access Point Name] - the name of the access point that defines the address of the GGSN, which will serve the user's session. <br><blockquote>  * - in more detail about the choice and use of APN in the process of activating the context, you can read in the article: <a href="http://habrahabr.ru/blogs/telecom/79505/">"It does not matter who you are ... it is important what your APN is"</a> <br></blockquote></li></ul><br></li><li>  <b>DNS Query / Response</b> <br>  Having received a specific APN from the subscriber in the request, the SGSN will form a complete address, adding to the APN, the so-called.  GOI [GGSN Operator Identifier], the full address will look something like this: <br><br>  <i><b>internet.mnc009.mcc255.gprs</b></i> , where <br><br>  <i>internet</i> - APN registered in the subscriber‚Äôs terminal, <br>  <i>mnc009.mcc255.gprs</i> - GOI of some virtual operator (Ukraine). <br><br>  Then, a request is made to the local DNS server of the operator, which results in the IP address of (a) GGSNs, which provide the requested service to the user. <br>  If the local DNS server cannot ‚Äúrecognize‚Äù the full address (for example, for a roaming subscriber), the request is redirected to the DNS server of the highest level (here, everything is very similar to the structure of IP networks). <br></li><li> <b>Create PDP Context Req / Res</b> <br>  All collected data from an authorized user, including requests for issuing an IP address, IMSI, <a href="http://ru.wikipedia.org/wiki/MSISDN">MSISDN</a> , APN (in the case of access to the internal network, for example) are transmitted by a special [Create PDP Context Request] request to the GGSN.  For this event, a billing entry is opened for the subscriber session. <br></li><li>  <b>Activate PDP Context Accept</b> <br>  The response message that is sent to the subscriber‚Äôs terminal contains all the necessary information to complete the activation of the PDP Context.  With this message, the user is assigned a specific IP address in the operator‚Äôs network, the service profiles are negotiated, and the provision of the requested service begins. <br></li></ol><br>  After successful activation of the PDP Context, on the user terminal, the letter ‚ÄúG‚Äù (or ‚ÄúE‚Äù :) is surrounded by a square and symbolizes the use of packet data. <br><br><h5>  Information stored before / after GPRS Attach </h5><br>  Let's find out what data is stored on the subscriber side, and which data is on the SGSN side before and after the authentication and authorization process in the operator's packet network. <br>  The summary table is presented below: <br><br><table><tbody><tr><td></td><td>  <b>MS</b> </td><td>  <b>SGSN</b> </td><td>  <b>Hlr</b> </td></tr><tr><td>  <b>Before GPRS Attach</b> </td><td>  IMSI <br>  MSISDN <br>  RAI <br>  K <sub>i</sub> <br>  QoS profile <br></td><td></td><td>  IMSI <br>  MSISDN <br>  K <sub>i</sub> <br>  QoS profile <br></td></tr><tr><td>  <b>After GPRS Attach</b> </td><td>  PMM State <br>  P-TMSI <br></td><td>  PMM State <br>  P-TMSI <br>  MSISDN <br>  RAI <br>  K <sub>c</sub> <br>  QoS profile <br></td><td>  SGSN address </td></tr></tbody></table><br><br>  <b><i>A small assistant:</i></b> <br><br>  <b>APN</b> - Access Point Name <br>  <b>CHAP</b> - Challenge Handshake Authentication Protocol <br>  <b>EIR</b> - Equipment Identity Register <br>  <b>GGSN</b> - Gateway GPRS Support Node <br>  <b>GOI</b> - GGSN Operator Identifier <br>  <b>GPRS</b> - General Packet Radio Service <br>  <b>HLR</b> - Home Location Register <br>  <b>HPLMN</b> - Home PLMN <br>  <b>IMSI</b> - International Mobile Subscriber Identity <br>  <b>IPCP</b> - Internet Protocol Control Protocol <br>  <b>MS</b> - Mobile Station <br>  <b>MSC</b> - Mobile Switching Center <br>  <b>MSISDN</b> - Mobile Station Integrated Services Digital Number <br>  <b>PAP</b> - Password Authentication Protocol <br>  <b>PDN</b> - Packet Data Networks <br>  <b>PDP</b> - Packet Data Protocol <br>  <b>PLMN</b> - Public Land Mobile Network <br>  <b>PPP</b> - Point-to-Point Protocol <br>  <b>RAS</b> - Registration, Admission and Status <br>  <b>RNC</b> - Radio Network Controller <br>  <b>SGSN</b> - Serving GPRS Support Node <br>  <b>VLR</b> - Visitors Location Register <br>  <b>VPLMN</b> - Visitor PLMN <br><br>  <b><i>Related links (en):</i></b> <br><ul><li>  <a href="http://wiki.forum.nokia.com/%3Ftitle%3DSpecial:PdfPrint%26page%3DPDP%26ei%3D9txnS9KOB5mImwO3ouG_Bg%26usg%3DAFQjCNHAErcMW9YOasLyHjw1a08UNz9Sew%26sig2%3DUcqShgLue4f4QDJRpkRl9g">GPRS attach</a> </li><li>  <a href="http://www.eventhelix.com/RealtimeMantra/Telecom/">GSM / GPRS Sequence Diagrams</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/81385/">https://habr.com/ru/post/81385/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../81376/index.html">Will you switch from Windows Mobile to another OS?</a></li>
<li><a href="../81378/index.html">Freedom Icons</a></li>
<li><a href="../81379/index.html">PyCamp Kiev</a></li>
<li><a href="../81380/index.html">New version of C # -SQLite</a></li>
<li><a href="../81383/index.html">Lost and found‚Ä¶</a></li>
<li><a href="../81386/index.html">Browsers</a></li>
<li><a href="../81387/index.html">Atari 2600 Emulator - Stella</a></li>
<li><a href="../81389/index.html">Isaac Brooke. Pioneer of domestic computing</a></li>
<li><a href="../81390/index.html">Why study other people's mistakes?</a></li>
<li><a href="../81391/index.html">Project Portfolio Management and Macros for Google Spreadsheets</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>