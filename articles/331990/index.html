<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tale about NePetu, or rather not about Petya</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I did not want to write a note about Petya / Nyetya / NePetya and other names of malicious code, which at the beginning of the week once again made th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tale about NePetu, or rather not about Petya</h1><div class="post__text post__text-html js-mediator-article">  I did not want to write a note about Petya / Nyetya / NePetya and other names of malicious code, which at the beginning of the week once again made the world shudder according to many media.  My reluctance was dictated by two reasons.  First of all, it was us, that is, Cisco and its division Talos (I already mentioned it <a href="https://habrahabr.ru/company/cisco/blog/328502/">here</a> , but, apparently, I will have to tell a little more about what kind of division), we were invited to participate in the investigation of what is happening in Ukraine, and write about the results before the end of the investigation, we understand that we do not have the opportunity.  And after the end of the investigation, not all of its results will be published.  Secondly, I must admit that I do not share that rush around the malicious code called Nyetya, which has only been fueled by various publications and statements in recent days. <br><br>  What is so unique about it that distinguishes it from other malicious programs and from the same <a href="https://habrahabr.ru/company/cisco/blog/328598/">WannaCry</a> ?  Why no one writes so much about <a href="http://blog.talosintelligence.com/2017/05/jaff-ransomware.html">Jaff</a> or BitKangoroo, which were distributed at the same time as WannaCry and used similar methods?  Why no one makes a report and does not discuss Untukmu, Shifu, Blackshades or the same <a href="http://blog.talosintelligence.com/2017/06/necurs-locky-campaign.html">Locky</a> , which infected more computers than WannaCry, Petya, Misha and Nyetya combined?  Why do IS specialists with a serious face discuss who used to turn Petya out of them and who spread the indicators of compromise faster than anyone?  Someone calls 30 minutes, someone 37 minutes, someone ‚Äúwoke up‚Äù only after a few hours ... <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2de/c99/66f/2dec9966f8d7f4a3210d49815df8e043.jpg" alt="image"><br><a name="habracut"></a><br><h2>  Why? </h2><br>  Why did Nyetya become possible at all?  Why didn‚Äôt the recommendations given by almost all experts a month and a half ago when WannaCry let me go?  The victims did not install the update on the operating system (at the same time, browsers with plugins could be updated)?  And the external access via SMB ports is also not closed?  But it was worth doing regardless of WannaCry.  These are so trivial axioms of information security that they even stopped being talked about at conferences, plunging into more complex matters ‚Äî machine learning, artificial intelligence, anomaly detection, big data analytics, and so on.  But what can you say if even simple things that do not require any budgets are not done? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When WannaCry happened (as usual, all of a sudden), everyone was so immersed in it that they stopped looking around and ask a more general question: ‚ÄúAnd what needs to be done to protect yourself from cryptographers?‚Äù Not from a specific WannaCry more than 400 modifications were found), and from all (or the maximum possible number) of ransomware programs (although the same Nyetya is not an ransomware, despite the demand for ransom).  After all, this is exactly the job of information security specialists - not to plug holes after they were discovered, but to reduce the area of ‚Äã‚Äãa possible attack by building a defense system so that it can deal with most of the threats initially. <br><br><h2>  How to build a protection strategy against encryption programs? </h2><br>  Is it possible to catch not a specific version of a specific cryptographer, but to develop a universal option?  Let's try.  Without pretending to complete coverage, let‚Äôs make a list of the characteristics of most cryptographers: <br><br><ul><li>  hitting the computer through various communication channels (mail, Web, flash drives, shared folders, direct network connection) </li><li>  interaction with the command server (according to our statistics in 92% of cases using the DNS protocol) or checking for an external kill switch </li><li>  work with the file system, including the substitution or deletion of individual files, as well as a large number of operations with files of certain types </li><li>  work with the registry </li><li>  work with administrative utilities </li><li>  interaction with the anonymous network Thor </li><li>  further propagation by scanning vulnerable nodes inside or outside the network. </li></ul><br>  It is clear that not all of these characteristics are present in every cryptographer.  For example, the self-distribution function was not so often used by attackers, who, preferring point attacks, forced users to perform some action (click on a link, open an attachment, run a file from a flash drive, etc.).  Not all cryptographers had the opportunity to work with the command server, acting completely autonomously.  But without having one or two characteristics, the rest were still present and they could be countered with a set of protective measures.  What could be the measures of protection? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6b1/0fb/bf4/6b10fbbf45ad4c236dcbea781f306601.png" alt="image"><br><br>  Again, let's reason.  In the threat prevention phase, we must: <br><br><ul><li>  block unnecessary network and DNS connections with the outside world, including anonymous networks (Top, etc.) </li><li>  segment the network to prevent the spread of malicious code, if it did get into the internal network, for example, on a flash drive </li><li>  fix vulnerabilities </li><li>  block the use of vulnerabilities if they cannot be eliminated (note, I‚Äôm not talking about blocking specific exploits, but blocking attempts to exploit specific vulnerabilities, which allows blocking any existing and future exploits - this distinguishes traditional IPS from modern NGIPS) </li><li>  block user access to malicious IP addresses, domains and URLs, including from mobile devices </li><li>  block the launch and operation of dangerous applications and processes </li><li>  block the spread of malware over the network (both at the perimeter and inside the LAN) </li><li>  Implement (pre-tested recovery capability) backup system. </li></ul><br><h2>  Model of information security ‚ÄúBEFORE IN TIME - AFTER‚Äù </h2><br>  But today one cannot be sure of 100% threat prevention - they can get on a flash drive, via a 4G modem, unprotected Wi-Fi or a company top manager who infected his personal laptop at home and brought it to the corporate network for treatment could bring them .  Therefore, several years ago we suggested following the BEFORE - DURING - AFTER concept, which implies that we should spend 80% of efforts to neutralize threats, but usually allocate a third of possible resources and protective measures.  Another third to put on the discovery of what can pass through protective barriers.  In the discovery phase, we must: <br><br><ul><li>  identify the use of known vulnerabilities (including attempts to use holes) </li><li>  detect abnormal, atypical user behavior (for example, starting psexec for an ordinary company user), nodes (for example, network scanning), applications (for example, encapsulating something non-standard in HTTP traffic), processes (for example, injection) and network traffic ( for example, bursts of traffic of a certain type, different from the normal picture on the network) </li><li>  analyze on the fly attachments to e-mail and files downloaded from web pages, running scripts or displayed Flash or other multimedia clips and banners </li><li>  Detect calls to the kill switch or other sites of the attacker's infrastructure on the Internet (for example, to DGA domains) by analyzing DNS queries, proxy Web logs, Netflow analysis, and simply learning TCP / IP streams. </li></ul><br>  And what about the remaining third effort?  We must let them in to remedy the situation, which is unpleasant to admit, but which is possible in any company - to fight the infection or compromise that has happened.  But in this case we should not bury our heads in the sand like ostriches (in fact, ostriches do not bury their heads in the ground, but such a version has gone since the times of Pliny the Elder and we are used to it), and promptly localize the problem and prevent it from spreading network, ‚Äúcure‚Äù the compromised nodes and return the system to its preattached state.  In the response phase, we must: <br><br><ul><li>  limit network traffic from infected or suspicious sites </li><li>  put suspected or infected nodes in quarantine (by placing in the appropriate VLAN or blocking the port on the switch or changing the ACL on an access point or router), and user accounts temporarily freeze </li><li>  to analyze suspicious files in the sandbox, as well as using other mechanisms </li><li>  track the trajectory of malicious or suspicious files on the network </li><li>  restore data from backup </li><li>  launch in some cases complex processes of Threat Hunting, which allow to confirm or refute the hypothesis about the presence of a cryptographer, put forward by the information security analyst. </li></ul><br><h2>  Cisco solutions for dealing with cryptographers </h2><br>  It is clear that one product does not implement the above set of tasks.  Modern extortionists are still quite complex and use a variety of attack vectors so that they can withstand any one product, even the best, hung with awards and placed in various magic squares.  For example, Cisco, which is the leader of the global information security market, has a whole range of technologies and solutions that can deal with this threat, at different stages of the cryptographer's life cycle, from an infection attempt to active distribution on the internal network. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0ce/275/6f3/0ce2756f3098d95075ad2a29b8c8f256.png" alt="image"><br><br>  But this is not just a beautiful picture.  We have prepared (by the way, even before WannaCry and Nyetya) detailed <a href="http://www.cisco.com/c/dam/en/us/solutions/collateral/enterprise/design-zone-security/ransomware-defense-dig.pdf">technical guidelines</a> on the design of the infrastructure to combat this threat.  It was developed by us in accordance with our Cisco <a href="https://www.youtube.com/watch%3Fv%3DEo6fl3nv6zY">SAFE</a> (Security Architecture for Enterprise) architecture, but it also examines in detail the methods of penetration of ransomware programs into the customer‚Äôs network, and methods of preventing, detecting and responding to the current life cycle of the modern threat ‚Äú <a href="http://gblogs.cisco.com/ru/bda/">TILL TIME‚Äù AFTER</a> ‚Äú. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/688/87d/748/68887d748ad402900206dc0df7c01884.png" alt="image"><br><br>  This manual describes the whole stack of technologies that allow you to deal with extortionate software: <br><br><ul><li>  <a href="https://habrahabr.ru/company/cisco/blog/229195/">Cisco ASA</a> and Cisco <a href="https://habrahabr.ru/company/cisco/blog/237759/">Firepower</a> hardware and virtual firewalls </li><li>  Cisco <a href="https://habrahabr.ru/company/cisco/blog/268207/">NGIPS</a> and Cisco wIPS Intrusion Prevention Systems </li><li>  anti-malware systems <a href="https://habrahabr.ru/company/cisco/blog/226699/">Cisco Advanced Malware Protection</a> </li><li>  Cisco OpenDNS DNS Monitoring Tools </li><li>  <a href="https://habrahabr.ru/company/cisco/blog/229525/">Cisco Identity Service Engine</a> corporate network segmentation tools </li><li>  systems analysis of anomalies in the internal network of enterprise <a href="https://habrahabr.ru/company/cisco/blog/229073/">Cisco Stealthwatch</a> </li><li>  hardware, virtual or cloud access control of <a href="https://habrahabr.ru/company/cisco/blog/232863/">Cisco Web Security web</a> resources </li><li>  <a href="https://habrahabr.ru/company/cisco/blog/260693/">Cisco Email Security</a> inbound and outbound hardware, virtual, or cloud protection </li><li>  <a href="https://habrahabr.ru/company/cisco/blog/271191/">Cisco AMP ThreatGrid sandbox</a> </li><li>  etc. </li></ul><br>  But Cisco would not be Cisco if it simply listed the technologies and solutions used in the flyer.  We have combined them into a complete system, which allows us to obtain a synergistic effect from this integration.  Each technology, each product found its place, most accurately satisfying the task.  Our customers do not need to think about what and how to do to protect against the most serious threat of recent times, on which attackers earn more than $ 1 billion a year.  We have tested the work of all components of the new leadership and are responsible for their performance. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/70f/6be/722/70f6be7224fe2ac1f002ad050ed74b3c.png" alt="image"><br><br><h2>  But what about all the same to be with NePety? </h2><br>  If you still go back to the story with Nyetya (aka Petya.A, aka Petya.C, aka PetrWrap, aka PetyaCry, aka GoldenEye, aka ExPetr), what do we know today? <br><br>  Starting with SamSam, the main victim of which was the US health authorities in March 2016, Talos <a href="https://gblogs.cisco.com/ru/mcr2016/">warned</a> of the risk of malware propagation using unsecured network-wide vulnerabilities.  In May 2017, WannaCry made many cry, taking advantage of the vulnerabilities of the SMBv1 protocol implementation and spread widely across many systems around the world.  On June 27, a new malware sample was found, quite different from the original Petya, so that people began to give it new names, such as Petrwrap and GoldenEye.  Talos identifies this pattern of malware as Nyetya.  Our current investigation (the original and constantly updated Cisco Talos blog entry in English is available <a href="http://blog.talosintelligence.com/2017/06/worldwide-ransomware-variant.html">here</a> ) showed that this sample also uses EternalBlue and EternalRomance in combination with psexec and WMI tools to spread and infect new victims within the network.  We will look at this in detail below in the ‚ÄúNyetya malware functionality‚Äù section.  Compared to WannaCry, there is no scanning external network component. <br><br>  Identification of the initial vector is currently difficult.  Early reports on the use of the mail vector have not yet been confirmed.  Based on observations of the behavior of the samples ‚Äúin the wild world‚Äù, we see that there are no obvious, visible external mechanisms for the reproduction of this sample of malware.  We suspect that part of the infections may have used a mechanism for updating accounting software known in Ukraine, called MeDoc, which is indirectly confirmed by the manufacturer MeDoc and research colleagues.  Talos continues to search for the original attack vector. <br><br>  As with any malware, Talos does not recommend paying a ransom.  Keep in mind that for this particular sample of malicious code it is also meaningless, since the mailbox that was supposed to be used to exchange information about payments and get the decryption keys was blocked by the mail provider posteo.de.  It was the only way of communication used by attackers to obtain information about payments and to obtain decryption keys.  There are no other methods for connecting malware to remote management servers and retrieving decryption keys from them (in the absence of such).  Thus, Nyetya is not a cryptographer who works for ransom, but is simply a sample of malware that destroys data and systems that can reach. <br><br><h3>  Method for obtaining user passwords </h3><br>  Perfc.dat, responsible for spreading the malware, contains an embedded executable in the resources section.  This executable is created as a temporary file in the user% TEMP% directory and starts the named pipe with a parameter containing the GUID.  Further, the main executable module Perfc.dat interacts with this executable module through the named pipe.  For example: <br><br><pre><code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WINDOWS</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TEMP</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span></span>561D.tmp, <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>.<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pipe</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">{</span></span></span></span>C1F0BF2D-8C17-4550-AF5A-65A22C61739C}</code> </pre> <br>  It seems that .tmp-executable code is based on Mimikatz, a well-known open source toolkit for retrieving user passwords and logins from the system‚Äôs memory and uses several methods to do this. However, Talos confirms that this code is not an exact copy of Mimikatz. <br><br>  The received login / password pairs are used to infect remote systems via WMIC and PsExec.  For example: <br><br><pre> <code class="hljs tex">Wbem<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wmic</span></span></span></span>.exe /node:"wxyz" /user:"username" /password:"password" "process call create "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">System</span></span></span></span>32<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rundll</span></span></span></span>32.exe <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span>C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">perfc</span></span></span></span>.dat<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span> #1</code> </pre> <br><h3>  Nyetya malware functionality </h3><br>  In its investigation, the Talos team discovered that the compromised systems had the file ‚ÄúPerfc.dat‚Äù.  Perfc.dat contains the functionality necessary to further compromise the system, and contains one unnamed exported function, # 1.  The library attempts to obtain system administrator privileges using calls to SeShutdowPrivilege and SeDebugPrivilege on behalf of the current user through a call to the Windows API AdjustTokenPrivileges.  If successful, the malware overwrites the master boot record (MBR) on a disk device, denoted as PhysicalDrive 0 inside Windows.  Regardless of whether this action succeeds or not, the malware proceeds to create a deferred task through schtasks, in order to overload the system an hour after the initial infection. <br><br>  During the propagation process, the malware enumerates all machines available to it over the network through a NetServerEnum call and then scans for the presence of an open TCP port 139.  This is enough to create a list of active devices that have this port open and that can potentially be compromised. <br><br>  The malware uses three possible mechanisms for reproduction: <br><br><ol><li>  EternalBlue is the same exploit as WannaCry. </li><li>  EternalRomance - SMBv1 exploit, made available as a result of a ShadowBrokers leak </li><li>  Psexec is a legal tool for Windows administrators. </li><li>  WMI - Windows Management Instrumentation, a legal component of Microsoft Windows. </li></ol><br>  These mechanisms are used to install and run perfc.dat for execution. <br><br>  For systems that do not have the MS17-010 patch installed, EternalBlue or EternalRomance exploits are used to compromise the system.  The type of exploit depends on which operating system the victim is using. <br><br><ul><li>  EternalBlue <br><ul><li>  Windows Server 2008 R2 </li><li>  Windows Server 2008 </li><li>  Windows 7 </li></ul></li><li>  EternalRomance <br><ul><li>  Windows xp </li><li>  Windows Server 2003 </li><li>  Windows vista </li></ul></li></ul><br>  Psexec is used to run the following command (where wxyz is the IP address), using the current user's token to install the malware on the network device.  Talos is still investigating the method by which the ‚Äúcurrent user's windows token‚Äù is pulled out by the malware on the current machine. <br><br><pre> <code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WINDOWS</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dllhost</span></span></span></span>.dat <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>wxyz -accepteula -s -d C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">System</span></span></span></span>32<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rundll</span></span></span></span>32.exe C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">perfc</span></span></span></span>.dat,#1</code> </pre> <br>  WMI is used to execute the following commands, which functionally do the same as psexec, but use the current username and password (username and password).  Talos is still investigating the method by which the current user's login and password become known to the malware. <br><br><pre> <code class="hljs tex">Wbem<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wmic</span></span></span></span>.exe /node:"wxyz" /user:"username" /password:"password" "process call create "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">System</span></span></span></span>32<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rundll</span></span></span></span>32.exe <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span>C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">perfc</span></span></span></span>.dat<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span> #1"</code> </pre> <br>  Once the system is compromised, the malware encrypts files using an RSA cipher with a 2048-bit key.  Additionally, the malware attempts to clear the current system logs on the compromised system using the following commands: <br><br><pre> <code class="hljs swift">wevtutil cl <span class="hljs-type"><span class="hljs-type">Setup</span></span> &amp; wevtutil cl <span class="hljs-type"><span class="hljs-type">System</span></span> &amp; wevtutil cl <span class="hljs-type"><span class="hljs-type">Security</span></span> &amp; wevtutil cl <span class="hljs-type"><span class="hljs-type">Application</span></span> &amp; fsutil usn deletejournal /<span class="hljs-type"><span class="hljs-type">D</span></span> %<span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:</code> </pre> <br>  Systems with a rewritten MBR after a restart show the following message: <br><br>  Ôøº <img src="https://habrastorage.org/getpro/habr/post_images/396/f4d/093/396f4d0938d8814d8cdd0f8c351f5f93.png" alt="image"><br><br><h3>  Recommended countermeasures </h3><br>  There are several effective countermeasures that can be taken to protect your environment from Nyetya actions: <br><br><ul><li>  First and foremost, we highly recommend customers who have not yet installed the patch MS17-010 to do so immediately.  Given the scale of the threat and its spread, it is extremely unwise to have unpatched systems. </li><li>  Use software that can detect and block the launch of known samples of malicious code. </li><li>  Develop and implement an action plan in the event of such abnormal situations, including not only regular backups, but also regular checks of data recovery from backups.  Backups should not be accessible from the network and stored separately. </li><li>  Completely disable SMBv1, if possible, and switch to using more advanced SMB versions.  (SMBv2 first appeared in Microsoft Vista). </li></ul><br>  Since Nyetya is trying to overwrite the MBR on an infected machine, Talos tested the applicability of the <a href="https://www.talosintelligence.com/mbrfilter">MBRFilter</a> software we developed to protect the system MBR.  Tests have shown the applicability of this software to protect the system MBR.  For those users and companies for whom this is relevant, we recommend MBRFilter as one of the protection measures.  However, MBRFilter is an open source Talos project and we cannot provide any guarantees or support when using it. <br><br><h3>  Current Cisco Security Coverage </h3><br>  Cisco customers can protect themselves from Nyetya using the following products: <br><br><ul><li>  Advanced Malware Protection (AMP) is ideal for blocking the execution of malware.  It should be noted that the detection of malicious code is carried out not by signatures, but by behavior, that is, AMP does not depend on the frequency of updating antivirus databases, like traditional antiviruses. </li><li>  Network protection devices such as NGFW, NGIPS, and Meraki MX can detect network activity associated with a threat.  It is worth noting that we have discovered the exploitation of EternalBlue and EternalRomance since April of this year, long before the start of the WannaCry and Nyetya epidemics. </li><li>  The AMP Threat Grid successfully identifies malware binaries. </li><li>  Email and Web are not yet confirmed as currently used in the attack vector.  In addition, there are no known external control elements for this malware at this time. </li><li>  Fresh Snort signatures are available on the official website of the Snort.org project. </li></ul><br><h3>  NGIPS / Snort Rules </h3><br>  The following NGIPS / Snort rules detect this threat: <br><br><ul><li>  42944 - OS-WINDOWS Microsoft Windows SMB remote code execution attempt </li><li>  42340 - OS-WINDOWS Microsoft Windows SMB anonymous session IPC share access attempt </li><li>  41984 - OS-WINDOWS Microsoft Windows SMBv1 identical MID and FID type confusion attempt </li></ul><br>  The following NGIPS / Snort rules also detect malware activity in traffic: <br><br><ul><li>  5718 - OS-WINDOWS Microsoft Windows SMB-DS Trans unicode Max Param / Count OS-WINDOWS attempt </li><li>  1917 - INDICATOR-SCAN UPnP service discover attempt </li><li>  5730 - OS-WINDOWS Microsoft Windows SMB-DS Trans Max Param OS-WINDOWS attempt </li><li>  26385 - FILE-EXECUTABLE Microsoft Windows executable file save include SMB share attempt </li><li>  43370 - NETBIOS DCERPC possible wmi remote process launch </li></ul><br><h3>  Threat grid </h3><br>  The Threat Grid successfully detects Nyetya malware samples and correctly assigns them as malicious. <br>  Ôøº <br><img src="https://habrastorage.org/getpro/habr/post_images/e9a/ccb/2b5/e9accb2b5ef62a46eee84d198b1ef3d9.png" alt="image"><br><br><h3>  Compromise Indicators (IOCs) </h3><br><h4>  Detection in AMP </h4><br>  W32.Ransomware.Nyetya.Talos <br><br><h4>  SHA256 </h4><br>  027cc450ef5f8c5f653329641ec1fed91f694e0d229928963b30f6b0d7d3a745 <br>  eae9771e2eeb7ea3c6059485da39e77b8c0c369232f01334954fbac1c186c998 (password stealer) <br><br>  <b>Additional information</b> : <br><br><ul><li>  Cisco Webinar <a href="http://cs.co/61828mehk">video recording</a> "Do not let me encrypt myself" about the WannaCry encryption program </li><li>  Cisco Infrastructure Design <a href="http://www.cisco.com/c/dam/en/us/solutions/collateral/enterprise/design-zone-security/ransomware-defense-dig.pdf">Guide</a> for Extinguishing Extortionists (in English) </li><li>  <a href="http://www.cisco.com/c/en/us/solutions/enterprise-networks/ransomware-defense/index.html">a section on the</a> Cisco <a href="http://www.cisco.com/c/en/us/solutions/enterprise-networks/ransomware-defense/index.html">website</a> (in English) devoted to the fight against extortionists </li><li>  Cisco <a href="https://habrahabr.ru/company/cisco/blog/328598/">recommendations</a> to combat WannaCry (in Russian) </li><li>  Detailed description of <a href="https://habrahabr.ru/company/cisco/blog/326356/">network segmentation</a> capabilities (in Russian) </li><li>  <a href="https://habrahabr.ru/company/cisco/blog/328502/">Annual</a> Cyber ‚Äã‚ÄãSecurity <a href="https://habrahabr.ru/company/cisco/blog/328502/">Report</a> (in Russian) </li><li>  Detailed and regularly updated <a href="http://blog.talosintelligence.com/2017/06/worldwide-ransomware-variant.html">description</a> of Cisco Talos Nyetya (in English) </li><li>  e-book " <a href="http://engage2demand.cisco.com/ru-ransomware-defense%3FCAMPAIGN%3DSC05-ransomware-for-dummies%26COUNTRY_SITE%3Dru%26REFERRING_SITE%3Dhabrahabr%26POSITION%3Dnyetyapost">Ransomware Defense for Dummies</a> " (in English) </li><li>  <a href="https://ciscoexperttalks.com/ru/83/programmy-vymogateli-zaschita-do-vo-vremya-i-posle-ataki%3Futm_source%3DRU-social-media%26utm_medium%3Dtwitter%26utm_campaign%3Dfy17_expert_talks_ru_promo">video presentation</a> on our approach in combating extortion programs (in Russian) </li></ul></div><p>Source: <a href="https://habr.com/ru/post/331990/">https://habr.com/ru/post/331990/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../331976/index.html">Kotlin and the cost of developing the game (+ a little offtopic)</a></li>
<li><a href="../331978/index.html">Day after the Petya virus</a></li>
<li><a href="../331982/index.html">We use Laravel IoC container at full capacity</a></li>
<li><a href="../331986/index.html">Football as an exact science: how ITMO University helps the organizers of the Confederations Cup and the 2018 World Cup</a></li>
<li><a href="../331988/index.html">Graphics for indie games. What to do if the roundels and sticks do not suit you</a></li>
<li><a href="../331992/index.html">‚ÄúIceberg instead of Oscar!‚Äù Or as I tried to learn the basics of DataScience on kaggle</a></li>
<li><a href="../331994/index.html">Ruining people not beer</a></li>
<li><a href="../331996/index.html">Rasking through the parts of a particularly hardy iron bullion S line, where 768 GB of RAM</a></li>
<li><a href="../331998/index.html">Using Python and Excel to process and analyze data. Part 2: libraries for working with data</a></li>
<li><a href="../332000/index.html">Autoencoders in Keras, Part 5: GAN (Generative Adversarial Networks) and tensorflow</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>