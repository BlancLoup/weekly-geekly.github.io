<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Selecting and configuring the Garbage Collector for Highload system in the Hotspot JVM</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 When working in the field of RTB (Real Time Bidding), one of the key characteristics is the time taken to display an advertisement to a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Selecting and configuring the Garbage Collector for Highload system in the Hotspot JVM</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/767/976/0bb/7679760bba6642618b4a52b6de26929a.jpg"></div><br><br><h1>  <b>Introduction</b> </h1><br>  When working in the field of RTB (Real Time Bidding), one of the key characteristics is the time taken to display an advertisement to a user who has visited the site.  It consists of several stages, one of which is an auction for an advertising space held by the Supply Side Platform SSP between several DSP (Demand Side Platform) systems.  In this case, the critical value is the time over which the DSP will have time to respond with its inventory and cash rate for the given show.  As a rule, the upper limit of this time is approximately 100 milliseconds.  Given that the optimal performance of advertising campaigns requires tens of thousands of requests per second, the implementation of this requirement can be a very trivial task. <br><a name="habracut"></a><br>  Our Ad Server, responsible for the core work of GetIntent DSP, is designed in Java and runs on the standard Hotspot JVM, which has well-known garbage collection (GC) mechanisms.  Therefore, the best option lies in the analysis of exactly how the work with memory occurs, and as a result, the selection of the most appropriate garbage collection algorithm and its optimal tuning.  This will be discussed in this article. <br><br>  In aggregate, our expected result is the maximum balance between the number of servers (the smaller, the better) and the total duration and frequency of GC pauses, during which we can lose potential impressions. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  <b>How we tested</b> </h1><br>  For testing, 2 workstations were used.  On the first one, the JVM started with: <br><pre><code class="java hljs">-Xmx4500m</code> </pre> <br>  On the second: <br><pre> <code class="java hljs">-Xmx12g</code> </pre><br>  JVM Version: Oracle 1.8.0_66-b17 <br>  CMS (Concurrent Mark Sweep) and G1 (Garbage First) garbage collectors were compared <br>  Testing was carried out within 16 hours on a load that is fully consistent with the combat. <br><br><h2>  CMS (Concurrent Mark Sweep) </h2><br>  CMS allows you to significantly reduce delays associated with garbage collection.  However, its use inevitably faces two main problems, which create the need for additional configuration: <br><ul><li>  Memory fragmentation </li><li>  High allocation rate </li></ul><br>  You can positively influence the first parameter by controlling the promotion rate of the indicator.  To do this, it is necessary to determine how many objects fall into the Tenured, and what ‚Äúdies young‚Äù in the Eden area. <br><br>  Testing was performed with the following parameters: <br><pre> <code class="java hljs">-XX:+UseConcMarkSweepGC -XX:NewRatio=<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span></code> </pre><br>  for logging were used: <br><pre> <code class="java hljs">-XX:+PrintGCDetails -XX:+PrintGC -XX:+PrintGCTimeStamps -XX:+PrintTenuringDistribution -XX:+PrintGCDateStamps -XX:+PrintCMSInitiationStatistics -XX:PrintCMSStatistics=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br><br><h2>  G1 (Garbage First) </h2><br>  G1 GC looks like a tempting choice for the RTB bidder, as its main goal is to maintain stable and predictable Stop The World (STW) pauses.  It also determines the simplicity and clarity of its settings.  In fact, it is necessary to operate with only one parameter - the maximum allowed STW pause duration: -XX: MaxGCPauseMillis <br>  In our case, in order to eliminate random long pauses, you can donate a small amount of throughput. <br><br>  Regarding G1 GC, since its appearance as a garbage collector available for experiments, some prejudices have been formed, the main one being that MaxGCPauseMillis is not maintained.  There is also a recommendation voiced by Oracle to use it on fairly large heap sizes (&gt; = 6 Gb). <br>  How all this is relevant, we learn after our testing.  We will also spend some time on such an exclusive G1 GC function as String Deduplication. <br><br>  Testing was performed with the following parameters: <br><pre> <code class="java hljs">-XX:+UseG1GC -XX:MaxGCPauseMillis=<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-number"><span class="hljs-number">40</span></span></code> </pre><br>  Additionally tests were carried out with the parameter: <br><pre> <code class="java hljs">-XX:MaxTenuringThreshold=<span class="hljs-number"><span class="hljs-number">8</span></span></code> </pre><br>  for logging were used: <br><pre> <code class="java hljs">-XX:+PrintGCDetails -XX:+PrintGC -XX:+PrintGCTimeStamps -XX:+PrintTenuringDistribution -XX:+PrintGCDateStamps -XX:+PrintAdaptiveSizePolicy -XX:+PrintReferenceGC</code> </pre><br><br><h1>  <b>Max Heap Size 4.5Gb</b> </h1><br>  Pivot table distribution Stop The World pauses: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/ec7/1e6/e86/ec71e6e864e045639980f2a2af2c47c1.png" height="75%" width="75%"></div><br>  The clear winner in this configuration is the CMS with the flag <br><pre> <code class="java hljs">-XX:NewRatio=<span class="hljs-number"><span class="hljs-number">5</span></span></code> </pre><br>  As you can see, despite the pauses ms / sec indicator of this configuration is slightly worse than the others, it still shows itself as the most stable - ~ 12 ms average pause and almost 98% fit into the norm - an excellent result for us.  With such indicators on one Full GC for 16 hours, you can close your eyes. <br><br>  The latency distribution graph for the best G1 and CMS performance: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/a82/94c/be4/a8294cbe4d1440e790570fd84969caaa.png"></div><br><h2>  CMS results analysis </h2><br>  We experimented with parameter sets in which the size of Eden (-XX: NewRatio) was 1/2, 1/4, and 1/6 of the total memory size.  The average promotion rate for these configurations was distributed accordingly: 1.7, 2.75 and 2.79 mb / sec, which is quite logical - the smaller the size of Eden, the more debris manages to seep directly into the Old Gen.  As you can see, from a certain point on, the size of the Eden area begins to have little effect on this indicator.  In our case, we can sacrifice a higher promotion rate (as a result, more frequent OldGen assemblies and a high probability of fragmentation) for the lowest possible average delay during the operation of the application. <br><br><h2>  G1 Results Analysis </h2><br>  It can be seen that G1 is closely in such a small heap.  Mixed pauses are very frequent. <br>  -XX: MaxGCPauseMillis has little effect on the final result, and the configuration with the desired 40ms pause could not do without Full GC. <br>  However, there is another point that confused us.  By default, G1 selects 15 ages for the Survivor area.  We decided to see if we really need so much: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/d93/d26/e3b/d93d26e3b39746d886052dc3853d5a72.png" height="40%" width="40%"></div><br>  Obviously a strange sign.  Starting from about age 8, the size always remains at about the same level;  this suggests that these are long-lived objects that are likely to fall into the Tenured area anyway, and before that at every minor assembly we just pour it from empty to empty, whereas we could immediately put all this in OldGen.  A good solution is to set MaxTenuringThreshold = 8. <br>  However, in the case of heap 4.5Gb, we did not notice a big difference in the results, so for brevity we omit them.  See if something changes on a big heap. <br><br><h1>  <b>Max Heap Size 12Gb</b> </h1><br>  Pivot table distribution Stop-the-World pauses: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/83c/149/bab/83c149babc8c437b895f0a390008b4dd.png" height="75%" width="75%"></div><br>  The composition of the representatives of the G1 has changed slightly, because  MaxTenuringThreshold = 8 (in the table mtt = 8) in this configuration began to bring noticeable results. <br>  On the big heap, the G1 spread its wings and stepped forward both in the overall distribution of pauses and in the very short maximum pause.  The average time spent on the GC was less than 7ms every second, i.e.  less than 0.7% <br><br>  The latency distribution graph for the best G1 and CMS performance: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/24d/cb1/ff3/24dcb1ff3fba432c86bf5b0355aeb0fc.png"></div><br><h2>  CMS results analysis </h2><br>  It is believed that the main problem of CMS is a matter of scalability.  Our testing confirms this.  Almost all indicators are worse than when using a small heap.  From the advantages it can be noted that due to the larger memory capacity, the effects of fragmentation are noticeably lower here - not a single Full GC during the whole experiment. <br><br><h2>  G1 Results Analysis </h2><br>  The result clearly shows that the G1 is indeed much more stable on large amounts of memory;  The conditions specified in the settings are quite clearly fulfilled.  Here is the undisputed winner with 40 ms latency.  The average pause increased by only 3 ms, while the memory size increased almost 2.4 times!  What to say about the ms / sec indicator is twice as good. <br><br><h1>  <b>G1 String Deduplication</b> </h1><br>  Since our bidder works with the text OpenRTB protocol, writes a lot of string logs, stores string caches, etc., it is quite logical to expect a big effect from this new function.  In theory, the number of garbage collections should be reduced, while the average assembly time will increase.  We added this flag for configuration with MaxGCPauseMillis = 100ms and Xmx = 4500m: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/a76/1e3/af5/a761e3af537d4175a109e2fbabde393e.png" height="40%" width="40%"></div><br>  Although the average pause is within the specified limits, the number of pauses exceeding 1000ms exceeded the permissible limits.  This can be seen on the chart: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/769/8aa/bb4/7698aabb49964af3b8b6414dfdd2c285.png"></div><br>  Attempts to set a shorter pause time led to a very strong increase in CPU consumption.  It was decided to abandon the use of this parameter. <br><br><h1>  <b>Results</b> </h1><br>  We conducted a detailed analysis of CMS and G1 garbage collectors, whose main goal was to understand how much we can reduce the impact of GC on latency - the most critical indicator for our system. <br><br>  Quite an expected result - there are no unambiguous conclusions here.  For a VM with a memory size of 5Gb, the winner is a CMS with the -XX configuration: NewRatio = 5;  despite the large maximum pause, during the life of the application, it showed a more stable result, better percentile and average delay.  However, on a VM with a heap of 12Gb G1, it is far ahead of CMS, which justifies the recommendations of Oracle;  ms / sec delay is 1.94 times better, max pause is 13.3 times! <br><br>  Thanks to this research, we could no longer work blindly, guided only by individual recommendations and heterogeneous opinions;  on the contrary, we were able to find the perfect balance for our heterogeneous system in terms of system configuration, obtaining maximum stability and, as a result, profit from what we have today. <br><br>  Article authors - <a href="https://habrahabr.ru/users/absorbb/" class="user_link">absorbb</a> and <a href="https://habrahabr.ru/users/dmart28/" class="user_link">dmart28</a> </div><p>Source: <a href="https://habr.com/ru/post/302910/">https://habr.com/ru/post/302910/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302898/index.html">Mozilla Firefox 48 beta web browser has the ability to split processes</a></li>
<li><a href="../302900/index.html">How to trick the GPS Glonass without vandalism</a></li>
<li><a href="../302902/index.html">A few words about REST API on symfony in the FOSRestBundle + JMSSerializerBundle bundle</a></li>
<li><a href="../302904/index.html">The difference between disaster recovery, backup and business continuity</a></li>
<li><a href="../302906/index.html">In the data center market. Apple and Microsoft are expanding their holdings</a></li>
<li><a href="../302912/index.html">Programming skills</a></li>
<li><a href="../302914/index.html">Quantity and quality: how do task trackers develop in a competitive environment</a></li>
<li><a href="../302916/index.html">Live broadcast of the conference "Payment innovations and alternative payment systems"</a></li>
<li><a href="../302918/index.html">Colors Go! Mutant game from Color Lines</a></li>
<li><a href="../302920/index.html">How to turn landing into profit?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>