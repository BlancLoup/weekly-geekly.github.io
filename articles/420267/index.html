<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The authors of the game 0 AD - well done</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="0 AD is a three-dimensional game in the genre of historical real-time strategy, developed by a community of volunteers. The size of the code base is s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The authors of the game 0 AD - well done</h1><div class="post__text post__text-html js-mediator-article"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6c5/b41/bfb/6c5b41bfb68b23ef10d61f6ecd1a6665.png" alt="PVS-Studio &amp; 0 A.D."></div><br>  0 AD is a three-dimensional game in the genre of historical real-time strategy, developed by a community of volunteers.  The size of the code base is small and I decided to check out the game as a holiday from large projects such as Android and XNU Kernel.  So, we have a project that contains 165,000 lines of C ++ code.  Let's see what's interesting in it can be found with the help of the PVS-Studio static analyzer. <br><a name="habracut"></a><br><h2>  0 AD </h2><br>  <a href="https://play0ad.com/">0 AD</a> (0 AD) is a free three-dimensional game in the genre of historical real-time strategy strategy, developed by a community of volunteers (the main developers are united in the Wildfire Games team).  The game allows you to control civilizations that existed in the period of 500 years BC.  e. ‚Äî1 year BC.  e.  As of the summer of 2018, the project is in alpha version.  [ <a href="https://ru.wikipedia.org/wiki/0_A.D.">Description</a> taken from Wikipedia]. <br><br>  Why exactly 0 AD? <br><br>  I asked my colleague <a href="https://www.viva64.com/ru/b/a/egor-bredikhin/">Yegor Bredikhin</a> ( <a href="https://habr.com/users/egorbredikhin/" class="user_link">EgorBredikhin</a> ) to select and check for me some small open project with which I could work in breaks between other tasks.  He sent me a log for the 0 AD project. To the question: ‚ÄúWhy this particular project?‚Äù Was the answer: ‚ÄúYes, I just played this game, a good real-time strategy.‚Äù  Ok, then it will be 0 AD :). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Error density </h2><br>  Just want to praise the authors of 0 AD for good quality C ++ code.  Well done, rarely able to meet such a low density of errors.  Of course, not all errors are meant, but those that can be detected with PVS-Studio.  As I have already said, although PVS-Studio does not find all the errors, nevertheless, we can safely talk about the relationship between the density of errors and the quality of the code as a whole. <br><br>  Few numbers.  The total number of non-empty lines of code is 231270. Of these, 28.7% are comments.  Total, 165,000 lines of pure C ++ code. <br><br>  The number of messages issued by the analyzer was small, and after reviewing them all, I wrote out 19 errors.  All these errors I will discuss later in the article.  Perhaps I missed something, considering the error innocuous, inaccurate code.  However, in general, this picture does not change. <br><br>  So, I found 19 errors on 165,000 lines of code.  We calculate the density of errors: 19 * 1000/165000 = 0.115. <br><br>  For simplicity, we round and assume that the PVS-Studio analyzer detects 0.1 errors per 1000 lines of code in the game code. <br><br>  Excellent result!  For comparison, in my recent <a href="https://www.viva64.com/ru/b/0579/">article on Android,</a> I thought that I detected at least 0.25 errors per 1000 lines of code.  In fact, the density of errors there is even more, I just did not find the strength to carefully analyze the entire report. <br><br>  Or take for example the EFL Core Libraries library, which I carefully <a href="https://www.viva64.com/ru/b/0523/">studied</a> and counted the number of defects.  In it, PVS-Studio detects 0.71 errors per 1000 lines of code. <br><br>  So, the authors of AD 0 are great, but for the sake of fairness, it should be noted that a small amount of code written in C ++ helps them.  Unfortunately, the larger the project, the faster its complexity increases, and the error density increases nonlinearly ( <a href="https://www.viva64.com/ru/b/0158/">more</a> ). <br><br><h2>  Errors </h2><br>  Let's now look at the 19 errors I found in the game.  To analyze the project, I used <a href="https://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> version 6.24.  I suggest trying to download the demo version and check the projects you are working on. <br><br>  <b>Note.</b>  We are positioning PVS-Studio as a B2B solution.  For small projects and individual developers, we have the free license option: " <a href="https://www.viva64.com/ru/b/0457/">How to use PVS-Studio for free</a> ." <br><br>  <b>Error n1</b> <br><br>  Let's start with a complex error.  In fact, it is not complicated, but you have to get acquainted with a fairly large code fragment. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> WaterManager::CreateWaveMeshes() { .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nbNeighb = <span class="hljs-number"><span class="hljs-number">0</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> found = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; nbNeighb = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> p = <span class="hljs-number"><span class="hljs-number">0</span></span>; p &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; ++p) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (CoastalPointsSet.count(xx+around[p][<span class="hljs-number"><span class="hljs-number">0</span></span>] + (yy + around[p][<span class="hljs-number"><span class="hljs-number">1</span></span>])*SideSize)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nbNeighb &gt;= <span class="hljs-number"><span class="hljs-number">2</span></span>) { CoastalPointsSet.erase(xx + yy*SideSize); <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } ++nbNeighb; <span class="hljs-comment"><span class="hljs-comment">// We've found a new point around us. // Move there xx = xx + around[p][0]; yy = yy + around[p][1]; indexx = xx + yy*SideSize; if (i == 0) Chain.push_back(CoastalPoint(indexx,CVector2D(xx*2,yy*2))); else Chain.push_front(CoastalPoint(indexx,CVector2D(xx*2,yy*2))); CoastalPointsSet.erase(xx + yy*SideSize); found = true; break; } } if (!found) endedChain = true; .... }</span></span></code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v547/">warning</a> : <a href="https://www.viva64.com/ru/w/v547/">V547</a> CWE-570 Expression 'nbNeighb&gt; = 2' is always false.  WaterManager.cpp 581 <br><br>  At first glance, the message analyzer seems strange.  Why is the condition <i>nbNeighb&gt; = 2</i> always false?  Indeed, in the body of the loop there is an increment of the variable <i>nbNeighb</i> ! <br><br>  Take a look below and you will see a <i>break</i> statement that interrupts the loop.  Therefore, if the variable <i>nbNeighb</i> is increased, the cycle will be stopped.  Thus, the value of the variable <i>nbNeighb</i> will never reach a value greater than 1. <br><br>  The code clearly contains some kind of logical error. <br><br>  <b>N2 error</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CmpRallyPointRenderer::MergeVisibilitySegments( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">deque</span></span>&lt;SVisibilitySegment&gt;&amp; segments) { .... segments.erase(segments.end()); .... }</code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v783/">warning</a> : <a href="https://www.viva64.com/ru/w/v783/">V783</a> CWE-119 Dereferencing of the invalid iterator 'segments.end ()' might take place.  CCmpRallyPointRenderer.cpp 1290 <br><br>  Very, very strange code.  Perhaps the programmer wanted to remove the last element from the container.  In this case, the code should be like this: <br><br><pre> <code class="cpp hljs">segments.erase(segments.end() - <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br>  Although, then it would be easier to write: <br><br><pre> <code class="cpp hljs">segments.pop_back();</code> </pre> <br>  To be honest, I do not quite understand what exactly was supposed to be written here. <br><br>  <b>Error N3, N4</b> <br><br>  I decided to consider two errors together, as they are related to the leakage of resources and require you first to show what the <i>WARN_RETURN</i> macro <i>is</i> . <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WARN_RETURN(status)\ do\ {\ DEBUG_WARN_ERR(status);\ return status;\ }\ while(0)</span></span></code> </pre> <br>  So, as you can see, the <i>WARN_RETURN</i> macro causes the function to exit the body.  Now look at the sloppy ways to use this macro. <br><br>  The first fragment. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sys_generate_random_bytes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(u8* buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count)</span></span></span><span class="hljs-function"> </span></span>{ FILE* f = fopen(<span class="hljs-string"><span class="hljs-string">"/dev/urandom"</span></span>, <span class="hljs-string"><span class="hljs-string">"rb"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!f) WARN_RETURN(ERR::FAIL); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (count) { <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> numread = fread(buf, <span class="hljs-number"><span class="hljs-number">1</span></span>, count, f); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (numread == <span class="hljs-number"><span class="hljs-number">0</span></span>) WARN_RETURN(ERR::FAIL); buf += numread; count -= numread; } fclose(f); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> INFO::OK; }</code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v773/">warning</a> : <a href="https://www.viva64.com/ru/w/v773/">V773</a> CWE-401 The function was exited without releasing the 'f' handle.  A resource leak is possible.  unix.cpp 332 <br><br>  If the <i>fread</i> function cannot read the data, the <i>sys_generate_random_bytes</i> function <i>will</i> terminate without releasing the file descriptor.  In practice, this is hardly possible.  It is doubtful that data from "/ dev / urandom" cannot be read.  However, the code is inaccurate. <br><br>  The second fragment. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sys_cursor_create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... sys_cursor_impl* impl = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> sys_cursor_impl; impl-&gt;image = image; impl-&gt;cursor = XcursorImageLoadCursor(wminfo.info.x11.display, image); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(impl-&gt;cursor == None) WARN_RETURN(ERR::FAIL); *cursor = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;sys_cursor&gt;(impl); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> INFO::OK; }</code> </pre> <br>  PVS-Studio warning: V773 CWE-401 The function was exited.  A memory leak is possible.  x.cpp 421 <br><br>  If the cursor cannot load, then a memory leak occurs. <br><br>  <b>Error n5</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadHeightmapImageOs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;u8&gt; fileData = <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;u8&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> u8[fileSize]); .... }</code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v554/">warning</a> : <a href="https://www.viva64.com/ru/w/v554/">V554</a> CWE-762 Incorrect use of shared_ptr.  The memory is allocated with 'new []' will be cleaned using 'delete'.  MapIO.cpp 54 <br><br>  The correct option is: <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;u8[]&gt; fileData = <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;u8&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> u8[fileSize]);</code> </pre> <br>  <b>Error N6</b> <br><br><pre> <code class="cpp hljs">FUTrackedPtr(ObjectClass* _ptr = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) : ptr(_ptr) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptr != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) FUTracker::TrackObject((FUTrackable*) ptr); ptr = ptr; }</code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v570/">warning</a> : <a href="https://www.viva64.com/ru/w/v570/">V570</a> The 'ptr' variable is assigned to itself.  FUTracker.h 122 <br><br>  <b>Error N7, N8</b> <br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::wstring TraceEntry::EncodeAsText() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> action = (<span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span>)m_action; <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> buf[<span class="hljs-number"><span class="hljs-number">1000</span></span>]; swprintf_s(buf, ARRAY_SIZE(buf), <span class="hljs-string"><span class="hljs-string">L"%#010f: %c \"%ls\" %lu\n"</span></span>, m_timestamp, action, m_pathname.<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>().c_str(), (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)m_size); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buf; }</code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v576/">warning</a> : <a href="https://www.viva64.com/ru/w/v576/">V576</a> CWE-628 Incorrect format.  Consider checking the fifth argument of the swprintf_s function.  The char type argument is expected.  trace.cpp 93 <br><br>  Here we are confronted with a confusing and unintelligible history of the alternative implementation of the <i>swprintf</i> function in Visual C ++.  I will not <a href="https://www.viva64.com/ru/w/v576/">retell</a> it, but refer to the <a href="https://www.viva64.com/ru/w/v576/">V576</a> diagnostic <a href="https://www.viva64.com/ru/w/v576/">documentation</a> (see the ‚ÄúWide lines‚Äù section). <br><br>  In this case, most likely, this code will work correctly when compiling in Visual C ++ for Windows and incorrectly when building for Linux or macOS. <br><br>  Similar error: V576 CWE-628 Incorrect format.  Consider checking the fourth argument of the swprintf_s function.  The char type argument is expected.  vfs_tree.cpp 211 <br><br>  <b>Error N9, N10, N11</b> <br><br>  <a href="https://www.viva64.com/ru/examples/v595/">Classic</a>  At the beginning, the pointer is used, and only then it is checked. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TEST_CAT2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* dst, ....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">strcpy</span></span>(dst, dst_val); <span class="hljs-comment"><span class="hljs-comment">// &lt;= int ret = strcat_s(dst, max_dst_chars, src); TS_ASSERT_EQUALS(ret, expected_ret); if(dst != 0) // &lt;= TS_ASSERT(!strcmp(dst, expected_dst)); }</span></span></code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v595/">warning</a> : <a href="https://www.viva64.com/ru/w/v595/">V595</a> CWE-476: The 'dst' pointer was used against nullptr.  Check lines: 140, 143. test_secure_crt.h 140 <br><br>  I think the error does not require clarification.  Similar warnings: <br><br><ul><li>  V595 CWE-476 The 'dst' pointer was used before it was verified against nullptr.  Check lines: 150, 153. test_secure_crt.h 150 </li><li>  V595 CWE-476 The 'dst' pointer was used before it was verified against nullptr.  Check lines: 314, 317. test_secure_crt.h 314 </li></ul><br>  <b>Error n12</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> tbool; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> MikkTSpace::setTSpace(...., <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tbool bIsOrientationPreserving, ....) { .... m_NewVertices.push_back(bIsOrientationPreserving &gt; <span class="hljs-number"><span class="hljs-number">0.5</span></span> ? <span class="hljs-number"><span class="hljs-number">1.0f</span></span> : (<span class="hljs-number"><span class="hljs-number">-1.0f</span></span>)); .... }</code> </pre> <br>  <a href="https://www.viva64.com/ru/w/v674/">V674</a> CWE-682 The '0.5' literal of the 'double' type is compared to the value of the 'int' type.  Consider inspecting the 'bIsOrientationPreserving&gt; 0.5' expression.  MikktspaceWrap.cpp 137 <br><br>  It makes no sense to compare a variable of type <i>int</i> with a constant of 0.5.  Moreover, by its very meaning, this is generally a boolean variable, which means comparing it with 0.5 looks quite strange.  I suppose that instead of <i>bIsOrientationPreserving</i> , another variable should be used here. <br><br>  <b>Error N13</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> Status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReplaceFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> VfsPath&amp; pathname, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">shared_ptr</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;u8&gt;&amp; fileContents, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ ScopedLock s; VfsDirectory* directory; VfsFile* file; Status st; st = vfs_Lookup(pathname, &amp;m_rootDirectory, directory, &amp;file, VFS_LOOKUP_ADD|VFS_LOOKUP_CREATE); <span class="hljs-comment"><span class="hljs-comment">// There is no such file, create it. if (st == ERR::VFS_FILE_NOT_FOUND) { s.~ScopedLock(); return CreateFile(pathname, fileContents, size); } .... }</span></span></code> </pre> <br>  PVS-Studio Warning: CWE-675 Destructor's <a href="https://www.viva64.com/ru/w/v749/">V749</a> Destructor will be <a href="https://www.viva64.com/ru/w/v749/">taken away</a> after leaving the object's scope.  vfs.cpp 165 <br><br>  Before you create a file, you need an object of type <i>ScopedLock</i> to unlock an object.  To do this, explicitly call the destructor.  The trouble is that the destructor for the object <i>s</i> will be automatically called again when exiting the function.  Those.  The destructor will be called twice.  I have not studied the device class <i>ScopedLock</i> , but in any case, this is not worth it.  Often, such a double call to the destructor leads to undefined behavior or other unpleasant errors.  Even if the code now works fine, it is very easy to break everything by changing the implementation of the <i>ScopedLock</i> class. <br><br>  <b>Error N14, N15, N16, N17</b> <br><br><pre> <code class="cpp hljs">CFsmEvent* CFsm::AddEvent( <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> eventType ) { .... pEvent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CFsmEvent( eventType ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !pEvent ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; .... }</code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v668/">warning</a> : <a href="https://www.viva64.com/ru/w/v668/">V668</a> CWE-570, it‚Äôs not a problem.  The exception will be generated in the case of memory allocation error.  fsm.cpp 259 <br><br>  Checking the pointer does not make sense, since in case of a memory allocation error, the exception <i>std :: bad_alloc</i> will be generated. <br><br>  So, the check is superfluous, but the error is not serious.  However, everything is much worse when some logic is executed in the body of the <i>if statement</i> .  Consider the following case: <br><br><pre> <code class="cpp hljs">CFsmTransition* CFsm::AddTransition(....) { .... CFsmEvent* pEvent = AddEvent( eventType ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !pEvent ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Create new transition CFsmTransition* pNewTransition = new CFsmTransition( state ); if ( !pNewTransition ) { delete pEvent; return NULL; } .... }</span></span></code> </pre> <br>  Analyzer Warning: VW C8E-570 V668  The exception will be generated in the case of memory allocation error.  fsm.cpp 289 <br><br>  An attempt is made to free the memory whose address is stored in the <i>pEvent</i> pointer.  Naturally, this will not happen and a memory leak will occur. <br><br>  In fact, when I started to deal with this code, it turned out that everything is more complicated and perhaps there is not one mistake, but two.  Now I will explain what is wrong with this code.  To do this, we need to familiarize ourselves with the device function <i>AddEvent</i> . <br><br><pre> <code class="cpp hljs">CFsmEvent* CFsm::AddEvent( <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> eventType ) { CFsmEvent* pEvent = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Lookup event by type EventMap::iterator it = m_Events.find( eventType ); if ( it != m_Events.end() ) { pEvent = it-&gt;second; } else { pEvent = new CFsmEvent( eventType ); if ( !pEvent ) return NULL; // Store new event into internal map m_Events[ eventType ] = pEvent; } return pEvent; }</span></span></code> </pre> <br>  Note that the function does not always return a pointer to a new object created with the <i>new</i> operator.  Sometimes it takes an existing object from the <i>m_Events</i> container.  And the pointer to the newly created object will also be placed in <i>m_Events</i> , by the way. <br><br>  And then the question arises: who owns and must destroy the objects, the pointers to which are stored in the <i>m_Events</i> container?  I am not familiar with the project, but, most likely, somewhere there is code that destroys all these objects.  Then deleting an object inside the <i>CFsm :: AddTransition function is</i> generally redundant. <br><br>  I got the impression that you can simply delete the following code fragment: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !pNewTransition ) { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> pEvent; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; }</code> </pre> <br>  Other errors: <br><br><ul><li>  V668 CWE-571 has been defined as the ‚Äúnew‚Äù operator.  The exception will be generated in the case of memory allocation error.  TerrainTextureEntry.cpp 120 </li><li>  The V668 CWE-571 has been defined as the ‚Äúnew‚Äù operator.  The exception will be generated in the case of memory allocation error.  SoundManager.cpp 542 </li></ul><br>  <b>Error N18, N19</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dir_scan_callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct de *de, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dir_scan_data</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dsd</span></span></span><span class="hljs-class"> = (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dir_scan_data</span></span></span><span class="hljs-class"> *) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dsd-&gt;entries == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> || dsd-&gt;num_entries &gt;= dsd-&gt;arr_size) { dsd-&gt;arr_size *= <span class="hljs-number"><span class="hljs-number">2</span></span>; dsd-&gt;entries = (struct de *) <span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>(dsd-&gt;entries, dsd-&gt;arr_size * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(dsd-&gt;entries[<span class="hljs-number"><span class="hljs-number">0</span></span>])); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dsd-&gt;entries == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// TODO(lsm): propagate an error to the caller dsd-&gt;num_entries = 0; } else { dsd-&gt;entries[dsd-&gt;num_entries].file_name = mg_strdup(de-&gt;file_name); dsd-&gt;entries[dsd-&gt;num_entries].st = de-&gt;st; dsd-&gt;entries[dsd-&gt;num_entries].conn = de-&gt;conn; dsd-&gt;num_entries++; } }</span></span></code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v701/">warning</a> : <a href="https://www.viva64.com/ru/w/v701/">V701</a> CWE-401 realloc () possible leak: when realloc () fails in allocating memory, original pointer 'dsd-&gt; entries' is lost.  Consider assigning realloc () to a temporary pointer.  mongoose.cpp 2462 <br><br>  If the size of the array becomes insufficient, memory allocation is performed using the <i>realloc</i> function.  The error is that the value of the pointer to the original memory block is immediately overwritten by the new value returned by the <i>realloc</i> function. <br><br>  If the memory cannot be allocated, the <i>realloc</i> function will return NULL, and this NULL will be written to the variable <i>dsd-&gt; entries</i> .  After that, it will be impossible to free a block of memory whose address was previously stored in <i>dsd-&gt; entries</i> .  There is a memory leak. <br><br>  Another error: V701 CWE-401 realloc () possible leak: when realloc () fails in allocating memory, the original pointer 'Buffer' is lost.  Consider assigning realloc () to a temporary pointer.  Preprocessor.cpp 84 <br><br><h2>  Conclusion </h2><br>  I can not say that this time the article turned out to be fascinating, or that I managed to show a lot of terrible mistakes.  What to do, just once is not necessary.  <a href="https://www.viva64.com/ru/b/0580/">I see what I write</a> . <br><br>  Thanks for attention.  For a change, I‚Äôll finish the article with an invitation to follow me on Instagram <a href="https://www.instagram.com/pvs_studio_unicorn/">@pvs_studio_unicorn</a> and on Twitter <a href="https://twitter.com/Code_Analysis">@Code_Analysis</a> . <br><br><p> <a href="https://www.viva64.com/en/b/0581/"><img src="https://habrastorage.org/webt/ts/z9/km/tsz9kmyjtteajhd4x1au60rsrvq.png" align="left"></a> </p><br><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Andrey Karpov.  <a href="https://www.viva64.com/en/b/0581/">Good job, authors of the game 0 AD!</a> </div><p>Source: <a href="https://habr.com/ru/post/420267/">https://habr.com/ru/post/420267/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../420257/index.html">Do you still install Windows 2008? Me too and that's why</a></li>
<li><a href="../420259/index.html">Singapore Aging Dashboard</a></li>
<li><a href="../420261/index.html">What will we measure? How to choose the right ML-metrics for business tasks</a></li>
<li><a href="../420263/index.html">ServiceNow-conference "Knowledge18"</a></li>
<li><a href="../420265/index.html">Seven Scrum Implementation Problems We Didn't Know About</a></li>
<li><a href="../420269/index.html">Money to the wind: why your anti-phishing does not detect phishing sites and how Data Science will make it work?</a></li>
<li><a href="../420271/index.html">Empathy training: stimulating the brain's neural connections with a video game</a></li>
<li><a href="../420273/index.html">How is the long-distance passenger car</a></li>
<li><a href="../420275/index.html">Major conferences on the Internet of things in 2018-2019. Russia and the world</a></li>
<li><a href="../420277/index.html">After the gold rush is over: blockchain technology perspectives</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>