<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We configure the Internet gateway with transparent bypass of blocking (and we will block advertising)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Do you have an old (or not so) computer with two network cards? Are you tired of advertising and unnecessary gestures to bypass blockages? You do not ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We configure the Internet gateway with transparent bypass of blocking (and we will block advertising)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/f4f/02d/938/f4f02d9383e34045a19c8ddaebc993f6.jpg"><br><br>  Do you have an old (or not so) computer with two network cards?  Are you tired of advertising and unnecessary gestures to bypass blockages?  You do not want to put up with this?  Then welcome under cat. <br><a name="habracut"></a><br><h2>  purpose </h2><br>  Configure the Internet gateway so that clients inside the local network without additional settings work with the Internet without restrictions.  Blocked sites will be accessed via a torus, to the rest via a normal Internet connection.  Access to .onion resources from any browser as usual sites.  As a bonus, we will configure the blocking of advertising domains and access to conditionally blocked sites via a torus (meaning sites that limit functionality for users from the Russian Federation).  My Internet provider <s>so that you can</s> perform the interception of DNS queries and the substitution of addresses (i.e., when resolving forbidden sites, returns the address of its stub), so I send all DNS queries to the torus. <br><br><div class="spoiler">  <b class="spoiler_title">A warning</b> <div class="spoiler_text">  All that is described below helps to bypass the blocking, but does not ensure anonymity.  From the word at all. <br></div></div><br>  Ideas and methods of implementation took <a href="https://www.alexeykopytko.com/2016/tor-transparent-proxy/">from here</a> and <a href="https://advanxer.com/blog/2015/05/adblocking-using-bind-dns-server/">from here</a> .  The authors of these articles thank you very much. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  So let's go </h2><br>  It is assumed that at the initial stage you already have an installed OS (in my case, Ubuntu server 16.04) on a computer with two network interfaces.  One of which (I have this ppp0) looks towards the provider, and the second (I have it enp7s0) to LAN.  The internal IP of the gateway is 192.168.1.2.  Local Area Network 192.168.1.0/24. <br><br>  How to approach this stage is not considered in this article, since there is more than enough information on the network.  I can only say that pppoe connection to the provider is conveniently configured using the pppoeconf utility. <br><br><h3>  Preparatory stage </h3><br>  If you, like me, use n {e | oy tbuk, then you might want him not to fall asleep when you close the lid. <br><br><pre><code class="bash hljs">sudo nano /etc/systemd/logind.conf</code> </pre> <br><pre> <code class="hljs">HandleLidSwitch=ignore</code> </pre> <br>  Resolve Forwarding in the kernel.  I have disabled IPv6 in one. <br><br><pre> <code class="bash hljs">sudo nano /etc/sysctl.conf</code> </pre> <br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.ipv4.ip_forward=<span class="hljs-number"><span class="hljs-number">1</span></span> # IPv6 disabled <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.ipv6.conf.all.disable_ipv6 = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.ipv6.conf.default.disable_ipv6 = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.ipv6.conf.lo.disable_ipv6 = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  Apply changes without rebooting. <br><br><pre> <code class="bash hljs">sudo sysctl -p</code> </pre> <br><h2>  DHCP setup </h2><br>  We want clients to be configured automatically, so you can‚Äôt do without a DHCP server. <br><br><pre> <code class="bash hljs">$ sudo apt install isc-dhcp-server $ sudo nano /etc/dhcp/dhcpd.conf</code> </pre> <br>  We give the file approximately to this form. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-lease-time <span class="hljs-number"><span class="hljs-number">600</span></span>; max-lease-time <span class="hljs-number"><span class="hljs-number">7200</span></span>; subnet <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> netmask <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> { range <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.200</span></span>; option routers <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; option domain-name-servers <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>, <span class="hljs-number"><span class="hljs-number">8.8</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span>; option broadcast-address <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span>; }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Explanation</b> <div class="spoiler_text">  <b>subnet 192.168.1.0 netmask 255.255.255.0</b> - defines the network and mask, <br>  <b>range 192.168.1.100 192.168.1.200;</b>  - the range of addresses that will be issued by the server, <br>  <b>option routers 192.168.1.2;</b>  - gateway address <br>  <b>option domain-name-servers 192.168.1.2, 8.8.8.8;</b>  - DN addresses of servers <br>  <b>option broadcast-address 192.168.1.255;</b>  - broadcast address. <br></div></div><br>  Restart server <br><br><pre> <code class="bash hljs">sudo /etc/init.d/isc-dhcp-server restart</code> </pre> <br><h2>  TOR setting </h2><br>  Install and open settings. <br><br><pre> <code class="bash hljs">$ sudo apt install tor $ sudo nano /etc/tor/torrc</code> </pre> <br>  Add strings <br><pre> <code class="hljs 1c"><span class="hljs-meta"><span class="hljs-meta">#        onion #   .   . VirtualAddrNetworkIPv4 10.0.0.0/8 # DNS   AutomapHostsOnResolve 1 #     DNS TransPort 0.0.0.0:9040 DNSPort 0.0.0.0:5353 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">    </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">   ExcludeExitNodes {RU}, {UA}, {BY}</span></span></code> </pre> <br><h2>  DNS setup </h2><br>  If you do not need ad blocking, then this item may not be performed.  If you just want to use DNS from the torus, add the <b>DNSPort 0.0.0.0:53</b> line to the <b>/ etc / tor / torrc</b> file and that's it. <br><br>  But I will cut advertising, which means install and open settings <br><br><pre> <code class="bash hljs">$ sudo apt install bind9 $ sudo nano /etc/<span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>/named.conf.options</code> </pre> <br>  We bring the file to the following form <br><pre> <code class="cpp hljs">options { directory <span class="hljs-string"><span class="hljs-string">"/var/cache/bind"</span></span>; forwarders { <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> port <span class="hljs-number"><span class="hljs-number">5353</span></span>; }; listen-on { <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; }; dnssec-validation <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span>; auth-nxdomain no; listen-on-v6 { none; }; };</code> </pre> <br>  If your provider does not chemically with DNS queries, you can send traffic to other DNS servers.  For example, on a google server: <br><pre> <code class="cpp hljs">forwarders { <span class="hljs-number"><span class="hljs-number">8.8</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span>; <span class="hljs-number"><span class="hljs-number">8.8</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span>; };</code> </pre> <br>  Theoretically, it should work faster than through a torus. <br>  To further configure the DNS back later.  That's enough for now.  Now restart the service. <br><br><pre> <code class="bash hljs">sudo /etc/init.d/bind9 restart</code> </pre> <br><h2>  Iptables configuration </h2><br>  All the magic will be created here. <br><br><div class="spoiler">  <b class="spoiler_title">The essence of the idea</b> <div class="spoiler_text"><ol><li>  We form a list of IP addresses to which we want to go through the torus. </li><li>  We wrap up requests to these addresses on a transparent proxy tor. </li><li>  Wrapping DNS requests for resources .onion on DNS torus </li><li>  When resolving names from the .onion zone, the top returns the IP address from the subnet 10.0.0.0/8 (which we specified when setting the TOP).  Of course, this zone is not routed on the Internet and we need to wrap calls on this subnet on a transparent proxy. </li></ol><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Lyrical digression</b> <div class="spoiler_text">  Initially, I thought that you can do without redirecting DNS requests to .onion in iptables.  That it is possible to configure bind so that it redirects requests to the DNS torus and returns addresses from the 10th zone.  I did not manage to configure it. <br><br><pre> <code class="cpp hljs">forwarders { <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> port <span class="hljs-number"><span class="hljs-number">5353</span></span>; };</code> </pre> <br>  It does not lead to the desired result, as well as the allocation of a separate zone ".onion" with forwarders at 127.0.0.1 port 5353. <br>  If anyone knows why this is happening and how to fix it, write in the comments. <br></div></div><br>  I assume that iptables is already installed.  Install ipset.  With this utility, we can manage the list of blocked addresses and wrap packets in a transparent proxy. <br><br><pre> <code class="bash hljs">sudo apt install ipset</code> </pre> <br>  Next, sequentially from under the root execute commands to configure iptables.  Of course, you need to replace the interface names and addresses with your own.  I put these commands in /etc/rc.local <b>before exit 0</b> and they are executed every time after loading. <br><br><div class="spoiler">  <b class="spoiler_title">I suggest that you do the same.</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ipset    ipset -exist create blacklist hash:ip #  DNS  TOR   onion.  bind9      iptables -t nat -A PREROUTING -p udp --dport 53 -m string --hex-string "|056f6e696f6e00|" --algo bm -j REDIRECT --to-port 5353 iptables -t nat -A OUTPUT -p udp --dport 53 -m string --hex-string "|056f6e696f6e00|" --algo bm -j REDIRECT --to-port 5353 #   IP     iptables -t nat -A PREROUTING -p tcp -m set --match-set blacklist dst -j REDIRECT --to-port 9040 iptables -t nat -A OUTPUT -p tcp -m set --match-set blacklist dst -j REDIRECT --to-port 9040 #         10.0.0.0/8 #  .onion iptables -t nat -A PREROUTING -p tcp -d 10.0.0.0/8 -j REDIRECT --to-port 9040 iptables -t nat -A OUTPUT -p tcp -d 10.0.0.0/8 -j REDIRECT --to-port 9040 ########################################### #       ,     # ########################################### # NAT iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE #   iptables -A INPUT -p icmp --icmp-type echo-reply -j ACCEPT iptables -A INPUT -p icmp --icmp-type destination-unreachable -j ACCEPT iptables -A INPUT -p icmp --icmp-type time-exceeded -j ACCEPT iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT #    iptables -A INPUT -m state --state INVALID -j DROP iptables -A FORWARD -m state --state INVALID -j DROP #    iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP #   syn-flood  iptables -A INPUT -p tcp ! --syn -m state --state NEW -j DROP iptables -A OUTPUT -p tcp ! --syn -m state --state NEW -j DROP #      ,      iptables -A INPUT -i lo -j ACCEPT iptables -A INPUT -i enp7s0 -j ACCEPT iptables -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT #   iptables -P INPUT DROP #   . iptables -A FORWARD -i enp7s0 -j ACCEPT iptables -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT #   iptables -P FORWARD DROP</span></span></code> </pre><br></div></div><br>  After rebooting, we need to get a gateway that: <br><br><ul><li>  Provides IP addresses and network settings to clients. </li><li>  Distributes the Internet. </li><li>  Resolvit names through DNS torus. </li><li>  Resolves the names .onion and allows you to visit these resources through a regular browser. </li><li>  Closes us from incoming connections. </li></ul><br>  There is no bypass of locks, since despite the fact that we created a blacklist and configured routing, the blacklist itself is still empty.  It is time to fix it. <br><h2>  Fill in the blacklist </h2><br>  We create the directory in which the script will lie. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mkdir -p /var/local/blacklist</span></span></code> </pre> <br>  Create a script <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># nano /var/local/blacklist/blacklist-update.sh</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">with the following content</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /bin/bash #    cd $(dirname $0) #  github      git pull -q || git clone https://github.com/zapret-info/zi.git . # dump.csv     blacklist.txt  IP    cat dump.csv | cut -f1 -d\; | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | sort | uniq &gt; blacklist.txt #  my-blacklist c  ,     #       .  blacklist.txt dig +short -f my-blacklist &gt;&gt; blacklist.txt # ipset ipset flush blacklist #c   cat blacklist.txt | xargs -n1 ipset add blacklist</span></span></code> </pre> <br></div></div><br>  Making the script executable <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># chmod +x /var/local/blacklist/blacklist-update.sh</span></span></code> </pre> <br>  We create the file my-blacklist, which we will later manually fill with the resources that we want to go through the torus. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># echo lostfilm.tv &gt; /var/local/blacklist/my-blacklist</span></span></code> </pre> <br>  Execute the script <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /var/local/blacklist/blacklist-update.sh</span></span></code> </pre> <br>  The script works for a long time, <s>be patient</s> be patient.  Now <s>should open flibusta</s> blocked sites should work.  Add to the end of the /etc/rc.local file, but <b>before exit 0</b> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#     , , #  DNS sleep 60 #   .  . /var/local/blacklist/blacklist-update.sh</span></span></code> </pre><br><h2>  Customize the advertising filter </h2><br><div class="spoiler">  <b class="spoiler_title">The essence of the idea</b> <div class="spoiler_text"><ol><li>  Install and run a micro HTTP server that listens to port 80 and returns a png image with one transparent pixel to any request. </li><li>  We get a list of advertising domains. </li><li>  We configure bind as an authoritative server for them. </li><li>  Wraps all requests for advertising domains on our HTTP server with a wonderful picture. </li></ol><br></div></div><br>  Let's get started  Let us deal with the north.  Create a file <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># nano /usr/local/bin/pixelserv</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">with content</b> <div class="spoiler_text"><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#! /usr/bin/perl -Tw use IO::Socket::INET; $crlf="\015\012"; $pixel=pack("C*",qw(71 73 70 56 57 97 1 0 1 0 128 0 0 255 255 255 0 0 0 33 249 4 1 0 0 0 0 44 0 0 0 0 1 0 1 0 0 2 2 68 1 0 59)); $sock = new IO::Socket::INET ( LocalHost =&gt; '0.0.0.0', LocalPort =&gt; '80', Proto =&gt; 'tcp', Listen =&gt; 30, Reuse =&gt; 1); if (!defined($sock)) { print "error : cannot bind : $! exit\n"; exit(1); } while ($new_sock = $sock-&gt;accept()) { while (&lt;$new_sock&gt;) { chop;chop; # print "$_\n"; if ($_ eq '') { last; } } print $new_sock "HTTP/1.1 200 OK$crlf"; print $new_sock "Content-type: image/gif$crlf"; print $new_sock "Accept-ranges: bytes$crlf"; print $new_sock "Content-length: 43$crlf$crlf"; print $new_sock $pixel; shutdown($new_sock,2); undef($new_sock); } close($sock); exit(0);</span></span></code> </pre><br></div></div><br>  make it executable <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># chmod +x /usr/local/bin/pixelserv</span></span></code> </pre> <br>  Create server initialization file <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># nano /etc/init.d/pixelserv</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">with content</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /bin/sh # /etc/init.d/pixelserv # # Carry out specific functions when asked to by the system case "$1" in start) echo "Starting pixelserv " /usr/local/bin/pixelserv &amp; ;; stop) echo "Stopping script pixelserv" killall pixelserv ;; *) echo "Usage: /etc/init.d/pixelserv {start|stop}" exit 1 ;; esac exit 0</span></span></code> </pre><br></div></div><br>  Make it executable, register the service, start the http server <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># chmod +x /etc/init.d/pixelserv # update-rc.d pixelserv defaults # /etc/init.d/pixelserv start</span></span></code> </pre> <br>  Now we create a script for updating advertising domains. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># nano var/local/blacklist/ad-update.sh</span></span></code> </pre> <br>  with content <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /bin/bash cd /etc/bind/ curl "http://pgl.yoyo.org/adservers/serverlist.php?hostformat=bindconfig&amp;showintro=0&amp;mimetype=plaintext" | sed 's/null.zone.file/\/etc\/bind\/db.adzone/g' &gt; named.ad.conf rndc reload</span></span></code> </pre> <br>  Making it executable <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># chmod +x /var/local/blacklist/ad-update.sh</span></span></code> </pre> <br>  and perform <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /var/local/blacklist/ad-update.sh</span></span></code> </pre> <br>  Create a zone file <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># nano /etc/bind/db.adzone</span></span></code> </pre> <br>  with the following content service <br><br><pre> <code class="hljs vbscript">$TTL <span class="hljs-number"><span class="hljs-number">86400</span></span> ; one <span class="hljs-built_in"><span class="hljs-built_in">day</span></span> @ <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> SOA ads.example.com. hostmaster.example.com. ( <span class="hljs-number"><span class="hljs-number">2014090102</span></span> <span class="hljs-number"><span class="hljs-number">28800</span></span> <span class="hljs-number"><span class="hljs-number">7200</span></span> <span class="hljs-number"><span class="hljs-number">864000</span></span> <span class="hljs-number"><span class="hljs-number">86400</span></span> ) NS my.dns.<span class="hljs-built_in"><span class="hljs-built_in">server</span></span>.org A <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> @ <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> A <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> A <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span></code> </pre> <br>  Add to file <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># nano /etc/bind/named.conf</span></span></code> </pre> <br>  the string <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "/etc/bind/named.ad.conf";</code> </pre> <br>  Apply changes <br><br><pre> <code class="bash hljs">rndc reload</code> </pre> <br>  We configure updating of the list of domains when loading.  To do this, open the file /etc/rc.local and add after sleep 60 <br><br><pre> <code class="bash hljs">/var/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/blacklist/ad-update.sh</code> </pre> <br><h2>  Finishing touches </h2><br>  To periodically update the lists, create a file <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># nano /etc/cron.daily/blacklist-update</span></span></code> </pre> <br>  With the following content <br><br><pre> <code class="bash hljs"><span class="hljs-meta"><span class="hljs-meta">#!/bin/bash #       /var/local/blacklist/ad-update.sh #   .  . /var/local/blacklist/blacklist-update.sh</span></span></code> </pre> <br>  Making it executable <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># chmod +x /etc/cron.daily/blacklist-update</span></span></code> </pre>  . <br><h2>  Note for users of Ubuntu desktop versions </h2><br>  Despite the fact that the goal was to create a gateway that does not require client settings, in my case it didn‚Äôt work out quite like that.  As a working operating system, I use desktop Ubuntu 16.04.  To configure the network, it uses the NetworkManager utility, which by default is configured so that the server DN is not taken from the DHCP server, but is set as 127.0.1.1:53.  On this port, dnsmasq hangs and resolves names only by its rules.  In ordinary life, this does not interfere, and in our case makes the zone .onion completely inoperative <br><br>  To fix this, you need to comment out the line in /etc/NetworkManager/NetworkManager.conf <br><br><pre> <code class="hljs">dns=dnsmasq</code> </pre> <br>  like this <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta">#dns=dnsmasq</span></span></code> </pre> <br>  After rebooting, everything works. <br><h2>  Imprisonment <s>only</s> </h2><br>  Android clients work fine without additional settings. <br>  Windows did not check, because I do not use it, but I think there should be no problems. <br>  The limitations for firefox and iOs are described <a href="https://www.alexeykopytko.com/2016/tor-transparent-proxy/">here.</a> <br><br>  I apologize for the chaotic presentation.  Additions, corrections, comments are welcome. <br>  Thanks for attention. <br><br><div class="spoiler">  <b class="spoiler_title">Update as of September 3, 2017</b> <div class="spoiler_text">  At the request of workers laid out <a href="">their settings</a> on github. <br>  The settings are given as reference information.  Out of the box, they do not suit you with a probability close to 100%.  Requires a fit for yourself. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/336966/">https://habr.com/ru/post/336966/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336956/index.html">Cheat Sheet or Must have for Android Developer</a></li>
<li><a href="../336958/index.html">Locky is alive: 23 million infected emails per day</a></li>
<li><a href="../336960/index.html">Security Week 35: Carders donate to Hutchins, 500 thousand pacemakers withdrawn, 711 million emails were found in the spam bot</a></li>
<li><a href="../336962/index.html">The flaw in formatting Swift blocks in Xcode</a></li>
<li><a href="../336964/index.html">40 spectacular ARKit demos that will soon see the world</a></li>
<li><a href="../336968/index.html">We pump USB Mass Storage Device on STM32F103 using FreeRTOS and DMA</a></li>
<li><a href="../336970/index.html">RxSwift: a bit about share (), replay (), shareReplayLatestWhileConnected () and other cool operators</a></li>
<li><a href="../336972/index.html">Optimization of the process of searching for violators of land legislation</a></li>
<li><a href="../336976/index.html">‚ÄúBy whom do you see yourself in 5 years?‚Äù: Wall Street top manager's advice on the answers to the cunning questions of recruiters</a></li>
<li><a href="../336978/index.html">Traffic mirroring on Juniper MX</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>