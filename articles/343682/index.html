<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Administering Juniper Switches with Ansible</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It all started with the task of creating a certain amount of vlan on a stack of switches, but I didn't want to do this at all. Knowledgeable people ha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Administering Juniper Switches with Ansible</h1><div class="post__text post__text-html js-mediator-article">  It all started with the task of creating a certain amount of vlan on a stack of switches, but I didn't want to do this at all.  Knowledgeable people have advised to use Ansible.  It does not pretend to be a manual, as there is not a lot of experience yet, but I want to share what happened.  Constructive criticism, comments and suggestions are welcome. <br><br><img src="https://habrastorage.org/webt/1x/cf/sy/1xcfsyew2fhc7uokgkbx7k1sciw.png"><br><br>  Details under the cut. <br><a name="habracut"></a><br><h3>  Installation </h3><br>  Installation on Centos is quite simple. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs sql">yun <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> ansible</code> </pre> <br>  Next you need to install the modules from Juniper for Ansible, here the Juniper team a special thanks. <br><br><pre> <code class="hljs sql">ansible-galaxy <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> Juniper.junos</code> </pre> <br>  You can check the installed modules with the command. <br><br><pre> <code class="hljs php">ansible-galaxy <span class="hljs-keyword"><span class="hljs-keyword">list</span></span></code> </pre> <br>  After installation, you can check the version <br><br><pre> <code class="hljs mel">ansible --version ansible <span class="hljs-number"><span class="hljs-number">2.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> config <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> = /etc/ansible/ansible.cfg configured module search path = Default w/o overrides <span class="hljs-keyword"><span class="hljs-keyword">python</span></span> version = <span class="hljs-number"><span class="hljs-number">2.7</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>, Nov <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">2016</span></span>, <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">28</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>) [GCC <span class="hljs-number"><span class="hljs-number">4.8</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> <span class="hljs-number"><span class="hljs-number">20150623</span></span> (Red Hat <span class="hljs-number"><span class="hljs-number">4.8</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-11</span></span>)]</code> </pre><br>  In the configuration file, <b>ansible.cfg</b> , the path to the log file and the list of devices are defined, as well as the option that disables the check of SSH keys in the local storage when connected to the switch: <br><br><pre> <code class="hljs pgsql">[defaults] inventory = /etc/ansible/hosts host_key_checking = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> log_path = /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/ansible.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span></code> </pre><br>  The list of devices is in the <b>hosts file</b> .  Hosts can be grouped, groups can be members of other groups: <br><br><pre> <code class="hljs css"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[testswitches]</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#SWTEST</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.8</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.192</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#SWAC_0901</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.8</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.218</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[prodswitches]</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#SWAC_1301</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.8</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.81</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#SWAC_1302</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.8</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.82</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[allswitches:children]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">testswitches</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">prodswitches</span></span></code> </pre><br><h3>  Making configuration changes to the switch </h3><br>  You need to create a <b>ansible playbook</b> - a script in which Ansible will perform certain actions.  The first playbook for making changes to the switch configuration is <b>changeconfig.yml</b> .  Just create an empty file with the extension yml: <br><br><pre> <code class="hljs swift">#playbook   --- --- #  - name: <span class="hljs-type"><span class="hljs-type">Juniper</span></span> <span class="hljs-type"><span class="hljs-type">Config</span></span> <span class="hljs-type"><span class="hljs-type">Changes</span></span> # ,     playbook hosts: testswitches #,    -    <span class="hljs-type"><span class="hljs-type">Juniper</span></span>,    roles: - <span class="hljs-type"><span class="hljs-type">Juniper</span></span>.junos connection: local gather_facts: no #     <span class="hljs-type"><span class="hljs-type">Python</span></span>,        vars: ansible_python_interpreter: /usr/bin/python #     ,      playbook vars_prompt: - name: <span class="hljs-type"><span class="hljs-type">USERNAME</span></span> prompt: <span class="hljs-type"><span class="hljs-type">Username</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: no - name: <span class="hljs-type"><span class="hljs-type">PASSWORD</span></span> prompt: <span class="hljs-type"><span class="hljs-type">Password</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: yes #  ,    #timeout   <span class="hljs-number"><span class="hljs-number">120</span></span> ,    commit  <span class="hljs-type"><span class="hljs-type">EX2200</span></span>   ,      tasks: - name: <span class="hljs-type"><span class="hljs-type">Retrieve</span></span> information from devices running <span class="hljs-type"><span class="hljs-type">Junos</span></span> <span class="hljs-type"><span class="hljs-type">OS</span></span> junos_config: host: <span class="hljs-string"><span class="hljs-string">"{{ inventory_hostname }}"</span></span> username: <span class="hljs-string"><span class="hljs-string">"{{ USERNAME }}"</span></span> password: <span class="hljs-string"><span class="hljs-string">"{{ PASSWORD }}"</span></span> timeout: <span class="hljs-number"><span class="hljs-number">120</span></span> port: <span class="hljs-number"><span class="hljs-number">22</span></span> #  ,         lines: - delete interfaces vme unit <span class="hljs-number"><span class="hljs-number">0</span></span> family inet dhcp - <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vlans vlan10 description <span class="hljs-string"><span class="hljs-string">"TestVlan"</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vlans vlan10 vlan-id <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre><br>  Run the playbook with the <b>ansible-playbook command changeconfig.yml</b> <br><br><pre> <code class="hljs markdown">Username: admin Password: PLAY [Juniper Config Changes] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* TASK [Retrieve information from devices running Junos OS] ok: [192.168.8.218] changed: [192.168.8.192] PLAY RECAP *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-emphasis"><span class="hljs-emphasis">***</span></span> 192.168.8.192 : ok=1 changed=1 unreachable=0 failed=0 192.168.8.218 : ok=1 changed=0 unreachable=0 failed=0</code> </pre><br>  I cleaned the output a bit, but overall, ok shows that the connection was successful, changed = 1 - that the changes were made to the switch.  At 192.168.8.218 the right vlan was already <br><br>  Before launch, you can test exactly what changes will be made.  To do this, run the command with the parameter <b>ansible-playbook changeconfig.yml -bDC</b> <br><br>  The changes will be shown in the log, but in fact they will not be applied, key <b>C</b> allows you to make a check, and <b>bD</b> will show the difference.  In the example below, one of the switches described Vlan 10 with the name SRV, ansible will remove it and add a new one, and create the vlan itself. <br><br><pre> <code class="hljs css">* <span class="hljs-selector-attr"><span class="hljs-selector-attr">[edit vlans vlan10]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">description</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SRV</span></span>; + <span class="hljs-selector-tag"><span class="hljs-selector-tag">description</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">TestVlan</span></span>"; + <span class="hljs-selector-tag"><span class="hljs-selector-tag">vlan-id</span></span> 10; <span class="hljs-selector-tag"><span class="hljs-selector-tag">changed</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[192.168.8.192]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ok</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[192.168.8.218]</span></span></code> </pre><br><br><h3>  Collecting information from switches </h3><br>  Another Playbook shows how to collect the necessary data from the switches and save the results to a local file.  I was interested in the Junos version.  Below I will give only a part of the tasks, everything above is similar to the previous playbook <br><br><pre> <code class="hljs pgsql"> tasks: - <span class="hljs-type"><span class="hljs-type">name</span></span>: Retrieve information <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> devices running Junos OS junos_command: host: "{{ inventory_hostname }}" username: "{{ USERNAME }}" <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: "{{ PASSWORD }}" timeout: <span class="hljs-number"><span class="hljs-number">120</span></span> port: <span class="hljs-number"><span class="hljs-number">22</span></span> commands: - <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> #   ,     ,             register: printout - <span class="hljs-type"><span class="hljs-type">name</span></span>: Save Output #<span class="hljs-keyword"><span class="hljs-keyword">debug</span></span>: msg="{{printout.stdout_lines}}" lineinfile: <span class="hljs-type"><span class="hljs-type">path</span></span>: versions.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span>: yes <span class="hljs-type"><span class="hljs-type">line</span></span>: "{{printout.stdout_lines}}"</code> </pre><br>  To debug, you can run the playbook with the command <i>ansible-playbook -vvv getversion.yml</i> <br>  Also, all logs will be in the <i>/var/log/ansible.log</i> specified in the config <br><br>  In general, I liked Ansible, I will explore further, thank you for your attention. </div><p>Source: <a href="https://habr.com/ru/post/343682/">https://habr.com/ru/post/343682/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343672/index.html">Video surveillance in the entrance on their own</a></li>
<li><a href="../343674/index.html">Outbound call center call center: create a predictive dialer in 3CX Call Flow Designer</a></li>
<li><a href="../343676/index.html">Write your insurance agent: Ingosstrakh organizes hackathon</a></li>
<li><a href="../343678/index.html">Is it true that the future of CPaaS is for ‚ÄúServerless‚Äù technologies?</a></li>
<li><a href="../343680/index.html">Secrets of React and Redux in the development of web applications</a></li>
<li><a href="../343684/index.html">Regression tests for memory leaks, or how to write a memory profiler for .NET applications</a></li>
<li><a href="../343688/index.html">Implementation of the simplest investment strategy based on API MOEX (Moscow Exchange)</a></li>
<li><a href="../343690/index.html">How to get on the road to OS development</a></li>
<li><a href="../343692/index.html">Open the CrackMe winter contest: break-rover</a></li>
<li><a href="../343694/index.html">Arduino and segment LCD indicator</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>