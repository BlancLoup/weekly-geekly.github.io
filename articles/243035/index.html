<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We catch snmp mac-notification traps from Cisco devices</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In spite of the seeming simplicity of the question, I had to collect the information bit by bit for a long time and tediously. In this publication, I ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We catch snmp mac-notification traps from Cisco devices</h1><div class="post__text post__text-html js-mediator-article">  In spite of the seeming simplicity of the question, I had to collect the information bit by bit for a long time and tediously.  In this publication, I want to share my experience. <br><br>  So, <a href="http://tools.cisco.com/Support/SNMP/do/BrowseOID.do%3FobjectInput%3D1.3.6.1.4.1.9.9.215.%26translate%3DTranslate%26submitValue%3DSUBMIT%26submitClicked%3Dtrue">mac notification</a> - snmp notification, which will send the server information about the mac-address of the device on the switch port when this device is turned on or off.  A very handy thing that extends network monitoring capabilities through snmp. <br><a name="habracut"></a><br><h4>  Proceed to setup </h4><habracut><br>  Setting up the switch does not take much time: <br><br><pre><code class="bash hljs">!   !   snmp snmp-server community _ RO ! mac  snmp-server <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> traps mac-notification change move threshold !,    snmp-server host IP-_ _ mac-notification snmp !   mac address-table notification change mac address-table notification change interval 15 mac address-table notification change <span class="hljs-built_in"><span class="hljs-built_in">history</span></span>-size 100 !              int range fa0/1-24 snmp <span class="hljs-built_in"><span class="hljs-built_in">trap</span></span> mac-notification change added snmp <span class="hljs-built_in"><span class="hljs-built_in">trap</span></span> mac-notification change removed</code> </pre> <br>  You can check the settings in debug mode: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="bash hljs">debug snmp packets ter mon</code> </pre><br>  If everything is set up correctly, we will see something like this: <br><br><pre> <code class="bash hljs">Nov 11 16:28:51.685: SNMP: Queuing packet to xxx.xxx.xxx.xxx Nov 11 16:28:51.685: SNMP: V1 Trap, ent cmnMIBNotificationPrefix, addr 10.0.28.18, gentrap 6, spectrap 1 cmnHistMacChangedMsg.37 = 01 00       00 14 00 cmnHistTimestamp.37 = 113588548 Nov 11 16:28:51.937: SNMP: Packet sent via UDP to xxx.xxx.xxx.xxx</code> </pre><br>  Consider the cmnHistMacChangedMsg object in more detail, which transmits a <b>hexadecimal string</b> of 11 octets (the last two zeros are always the end of the record).  The first octet is the state (01 is the device is added, 02 is the device is disabled), the next 2 octets are the vlan's number, 6 octets are the MAC address (in our case, it is xxxx.xxxxx.xxxx), and 2 octets (00 14) - port number. <br>  I want to draw attention to the following: according to the <a href="http://tools.cisco.com/Support/SNMP/do/BrowseOID.do%3FobjectInput%3DcmnHistMacChangedMsg%26translate%3DTranslate%26submitValue%3DSUBMIT%26submitClicked%3Dtrue">documentation</a> , the cmnHistMacChangedMsg object can transmit several mac-addresses in one trap.  In this case, the records go in a row, without any separation, a pair of zeros will be added to the end of the message. <br><br>  Setting up a server consists of several steps: <br><br>  <i>Before setting up, I strongly recommend checking whether the udp packets reach the server using the tcpdump udp | grep IP_switch command.</i> <br><ol><li>  Install snmp server and standard mib: <br><br><pre> <code class="bash hljs">sudo apt-get install snmpd snmp snmptt snmp-mibs-downloader</code> </pre><br></li><li>  Installing the required MIB files <br>  By default, the snmp server does not know about the mac-notification object in Cisco.  In order for the server to recognize this trap, you need to download .mib files from <a href="http://tools.cisco.com/Support/SNMP/do/BrowseMIB.do%3Flocal%3Den%26step%3D2%26mibName%3DCISCO-MAC-NOTIFICATION-MIB">ftp</a> and put them in / var / lib / mibs. <br>  You must download the following files: <br><br><pre> <code class="bash hljs">CISCO-MAC-NOTIFICATION-MIB CISCO-QOS-PIB-MIB CISCO-SMI CISCO-TC CISCO-VTP-MIB</code> </pre>  In case of successful installation of new mib, per command <pre> <code class="bash hljs">snmptranslate -m CISCO-MAC-NOTIFICATION-MIB .1.3.6.1.4.1.9.9.215</code> </pre>  the server will respond <pre> <code class="bash hljs">CISCO-MAC-NOTIFICATION-MIB::ciscoMacNotificationMIB</code> </pre> <br></li><li>  Configuring configuration files <br><br><div class="spoiler">  <b class="spoiler_title">/ etc / default / snmpd:</b> <div class="spoiler_text">  SNMPDRUN = yes <br>  SNMPDOPTS = '- Lsd -Lf / dev / null -u snmp -g snmp -I -smux, mteTrigger, mteTriggerConf -p /var/run/snmpd.pid' <br>  TRAPDRUN = yes <br>  TRAPDOPTS = '- On -Lsd -p /var/run/snmptrapd.pid' <br></div></div><br><div class="spoiler">  <b class="spoiler_title">/etc/snmp/snmptrapd.conf:</b> <div class="spoiler_text">  # redirect all traps to the snmptt daemon by default <br>  traphandle default snmptt <br>  # Allow all traps <br>  disableAuthorization yes <br></div></div><br><div class="spoiler">  <b class="spoiler_title">/etc/snmp/snmptt.conf:</b> <div class="spoiler_text">  # Search for the desired OID <br>  EVENT CISCO-MAC-NOTIFICATION-MIB :: cmnMacChangedNotification .1.3.6.1.4.1.9.9.215.2.0.1 "Status Events" Normal <br>  Cisco FORMAT <br>  # Redirect to script. The first parameter is $ aA-Ip device address, the second parameter is $ 1 - OID cmnHistMacChangedMsg, <br>  # in the cat there is information about the status, mac address, vlan and device interface. <br>  # ATTENTION !! Cisco can transfer several cmnHistMacChangedMsg records in one trap. <br>  EXEC php /opt/script.php $ aA $ 1 <br>  SDESC <br>  EDESC <br></div></div><br><div class="spoiler">  <b class="spoiler_title">/etc/snmp/snmptt.ini:</b> <div class="spoiler_text">  # <br>  # SNMPTT v1.4 Configuration File <br>  # <br>  # Linux / Unix <br>  # <br><br>  [General] <br>  # Name of this system for $ H variable.  If blank, the system name will be the computer's <br>  # hostname via Sys :: Hostname. <br>  snmptt_system_name = <br><br>  # Set to either 'standalone' or 'daemon' <br>  # standalone: ‚Äã‚Äãsnmptt called from snmptrapd.conf <br>  # daemon: snmptrapd.conf calls snmptthandler <br>  # Ignored by Windows.  See documentation <br>  mode = standalone <br><br>  Set <br>  # Set to 0 to have it after the first match. <br>  # This option should be set to 1. See the section 'SNMPTT.CONF Configuration <br>  # file Notes' in the SNMPTT documentation for more information. <br>  # Note: Wildcard matches are only matched if there are NO exact matches.  This takes <br>  # into consideration the NODES list.  Therefore, if there is a matching trap, but <br>  # of NODES list <br>  # only be used if there are no other exact matches. <br>  multiple_event = 1 <br><br>  #SNMPTRAPD passes the IP address for the device <br>  # actual SNMP agent.  If you want <br>  # device (relay, proxy etc). <br>  # If DNS is enabled, the IP address is assigned to the agent. <br>  # (which includes the local hosts file is configured, the OS is configured).  This name <br>  # will be used for: NODES entry matches, hostname field in logged traps (file / database), <br>  # and the $ A variable.  Host names on the NODES line will be resolved and the IP address <br>  # will then be used for comparing. <br>  # Set to 0 to disable DNS resolution <br>  # Set to 1 to enable DNS resolution <br>  dns_enable = 0 <br><br>  # Set to 0 to enable the Fully Qualified Domain Names (FQDN).  If a host name is <br>  # passed to SNMPTT <br>  # SNMPTT.  This also affects resolve_value_ip_addresses. <br>  # Set to 1 SNMPTT strip to go.  For <br>  # example, server01.domain.com would be changed to server01 <br>  # Set SNMPTT to 2 to have a strip <br>  # based on the list of domains in strip_domain_list <br>  strip_domain = 0 <br><br>  # It is stripped when strip_domain is set to 2. <br>  # List can contain one or more domains.  For example, if the FQDN of a host is <br>  # server01.city.domain.com and the list contains domain.com, the 'host' will be <br>  # set as server01.city. <br>  strip_domain_list = &lt;&lt; END <br>  domain.com <br>  END <br><br>  Configures of the bindings of the variable bindings are handled. <br>  This is the case for $ n, $ + n, $ -n, $ vn, $ + *, $ - *. <br>  # Set to 0 to disable resolving ip address to host names <br>  # Set to 1 to enable resolving ip address to host names <br>  # Note: net_snmp_perl_enable * must * be enabled.  The strip_domain settings influence the <br>  # format of the resolved host name.  DNS must be enabled (dns_enable) <br>  resolve_value_ip_addresses = 0 <br><br>  Set the module from the UCD-SNMP / NET-SNMP package. <br>  # This is a $ v variable substitution for work, and also for some other options <br>  # that are enabled in this .ini file. <br>  Set the module from the UCD-SNMP / NET-SNMP package. <br>  # Note: Enabling this mode can cause SNMPTT to run very slowly due to <br>  # the loading of the MIBS at startup. <br>  net_snmp_perl_enable = 0 <br><br>  # Set to 1 to enable caching of OID and ENUM translations when net_snmp_perl_enable is <br>  # enabled.  Enabling this should result in faster translations. <br>  # Set to 0 to disable caching. <br>  # Note: Restart SNMPTT after updating the MIB files for Net-SNMP, otherwise the cache may <br>  # contain inaccurate data.  Defaults to 1. <br>  net_snmp_perl_cache_enable = 1 <br><br>  # This sets the best_guess parameter used by the UCD-SNMP / NET-SNMP perl module for <br>  # translating symbolic nams to OIDs and vice versa. <br>  # For UCD-SNMP, and Net-SNMP 5.0.8 and previous versions, set this value to 0. <br>  # For Net-SNMP 5.0.9, or any Net-SNMP with patch 722075 applied, set this value to 2. <br>  # A value of 2 is equivalent to -IR on Net-SNMP command line utilities. <br>  # UCD-SNMP and Net-SNMP 5.0.8 <br>  # symbolic names such as RFC1213-MIB :: sysDescr.  Net-SNMP 5.0.9 or patch 722075 will allow <br>  # all possibilities to be translated.  See the FAQ section in the README for more info <br>  net_snmp_perl_best_guess = 0 <br><br>  # Configures how the OID of the received trap is handled when outputting to a log file / <br>  # database.  It does NOT apply to the $ O variable. <br>  # Set to 0 to use the default of numerical OID <br>  # Set to 1 for translate the short message (symbolic form) (eg: linkUp) <br>  # Set to translate the trap OID to short text with the module name (eg: IF-MIB :: linkUp) <br>  # Set to 3 to translate the trap OID to long text (eg: iso ... snmpTraps.linkUp) <br>  # Set to translate the trap OID to long text with the module name (eg: <br>  # IF-MIB :: iso ... snmpTraps.linkUp) <br>  # Note: -The output of the Net-SNMP you <br>  # are using. <br>  # -net_snmp_perl_enable * must * be enabled <br>  # -If using database logging, ensure the trapoid column is large enough to hold the <br>  # entire line <br>  translate_log_trap_oid = 0 <br><br>  # Configures how the OIDs contained in the VALUE of the variable bindings are handled. <br>  This is the case for $ n, $ + n, $ -n, $ vn, $ + *, $ - *.  For substitutions <br>  # that include variable NAMES ($ + n etc), only the variable VALUE is affected. <br>  # Set to 0 to disable translating OID values ‚Äã‚Äãto text (symbolic form) <br>  # Set to 1 to translate OID values ‚Äã‚Äãto short text (symbolic form) (eg: BuildingAlarm) <br>  # Set to 2 to translate OID values ‚Äã‚Äãto short text with module name (eg: UPS-MIB :: BuildingAlarm) <br>  # Set to 3 to translate OID values ‚Äã‚Äãto long text (eg: iso ... upsAlarm.BuildingAlarm) <br>  # Set to 4 to translate OID values ‚Äã‚Äãto long text with module name (eg: <br>  # UPS-MIB :: iso ... upsAlarm.BuildingAlarm) <br>  # For example, if the value contained: 'A UPS Alarm (.1.3.6.1.4.1.534.1.7.12) has cleared.', <br>  # it could be translated to: 'A UPS Alarm (UPS-MIB :: BuildingAlarm) has cleared.' <br>  # Note: net_snmp_perl_enable * must * be enabled <br>  translate_value_oids = 1 <br><br>  # Configures how the symbolic enterprise OID will be displayed for $ E. <br>  # Set to 1, 2, 3 or 4. See translate_value_oids options 1,2,3 and 4. <br>  # Note: net_snmp_perl_enable * must * be enabled <br>  translate_enterprise_oid_format = 1 <br><br>  # Configures how the symbolic trap OID will be displayed for $ O. <br>  # Set to 1, 2, 3 or 4. See translate_value_oids options 1,2,3 and 4. <br>  # Note: net_snmp_perl_enable * must * be enabled <br>  translate_trap_oid_format = 1 <br><br>  # Configures how the symbolic trap OID will be displayed for $ v, $ -n, $ + n, $ - * and $ + *. <br>  # Set to 1, 2, 3 or 4. See translate_value_oids options 1,2,3 and 4. <br>  # Note: net_snmp_perl_enable * must * be enabled <br>  translate_varname_oid_format = 1 <br><br>  # Set to 0 to disable converting values ‚Äã‚Äãto enumeration tags <br>  # MIB files <br>  # Set to 1 to enable converting values ‚Äã‚Äãto enumeration tags <br>  # MIB files <br>  # Example: moverDoorState: open instead of moverDoorState: 2 <br>  # Note: net_snmp_perl_enable * must * be enabled <br>  translate_integers = 1 <br><br>  # Allows you to set the environment variable used by SNMPTT <br>  # Leave your system settings <br>  # To have all MIBS processed, set to ALL <br>  # See the snmp.conf manual page for more info <br>  mibs_environment = ALL <br><br>  # Set what is used to separate variables when wildcards are / <br>  # EXEC line.  Defaults to a space.  Value MUST be within quotes.  Can contain 1 or <br>  # more characters <br>  wildcard_expansion_separator = "" <br><br>  # Set to 1 unsafe REGEX code to be executed. <br>  # Set to 0 to prevent unsafe REGEX code from being executed (default). <br>  # Enabling unsafe REGEX code <br>  # modifier to allow statements such as substitution with captures such <br>  # as: (one (two) three) (five $ 1 six) <br>  # which outputs: five two six <br>  # or: (one (two) three) ("five" .length ($ 1). "six") e <br>  # which outputs: five 3 six <br>  # <br>  # This is considered unsafe <br>  # (right) is executed (eval) by Perl which * could contain unsafe code *. <br>  # BE SURE THAT THE SNMPTT CONFIGURATION FILES ARE SECURE! <br>  allow_unsafe_regex = 0 <br><br>  # Set to 1 to have the backslash (escape) removed from quotes passed from <br>  # snmptrapd.  For example, \ "would be changed to just" <br>  # Set to 0 to disable <br>  remove_backslash_from_quotes = 0 <br><br>  # Set to 1 to have NODES files loaded each time a trap is processed. <br>  # Set to 0 to have all NODES files loaded when the snmptt.conf files are loaded. <br>  # If NODES files are used (files that contain lists of NODES), then setting to 1 <br>  # this is an EVENT processed <br>  # NODES files.  SNMPTT is <br>  depending on the number of traps <br>  # received.  Defaults to 0 <br>  dynamic_nodes = 0 <br><br>  $ D substitution variable to include the <br>  # description text from the SNMPTT.CONF or MIB files. <br>  # Set to 0 to disable the $ D substitution variable.  If $ D is used, nothing <br>  # will be outputted. <br>  # Set to 1 <br>  # descriptions stored in the SNMPTT .conf files.  Enabling this option can <br>  # greatly increase the amount of memory used by SNMPTT. <br>  # Set to 2 to enable the $ d substitution variable <br>  # description from the MIB files.  This enables the UCD-SNMP / NET-SNMP Perl <br>  # module save_descriptions variable.  Enabling this option can greatly <br>  # increase the amount of memory used by the Net-SNMP SNMP Perl module, which <br>  # will result in an increase in memory usage by SNMPTT. <br>  description_mode = 0 <br><br>  Set the line to each line from the MIB <br>  # or SNMPTT.CONF description when description_mode is set to 1 or 2. <br>  description_clean = 1 <br><br>  # Warning: Experimental.  Not recommended for production environments. <br>  # When threads are enabled, SNMPTT may quit unexpectedly. <br>  # Set to 1 to enable threads (ithreads) in Perl 5.6.0 or higher.  If enabled, <br>  # EXEC will start SNMPTT to continue processing other <br>  # traps.  See also threads_max. <br>  # Set to 0 to disable threads (ithreads). <br>  # Defaults to 0 <br>  threads_enable = 0 <br><br>  # Warning: Experimental.  Not recommended for production environments. <br>  # When threads are enabled, SNMPTT may quit unexpectedly. <br>  # This option <br>  # execute at once.  Defaults to 10 <br>  threads_max = 10 <br><br>  # The date format for $ x in strftime () format.  If not defined, defaults <br>  # to% a% b% e% Y. <br>  #date_format =% a% b% e% Y <br><br>  # The time format for $ X in strftime () format.  If not defined, defaults <br>  # to% H:% M:% S. <br>  #time_format =% H:% M:% S <br><br>  # For date / time when logging <br>  # to standard output, snmptt log files (log_file) and the unknown log file <br>  # (unknown_trap_log_file).  Defaults to localtime ().  For SQL, see <br>  # date_time_format_sql. <br>  # Example:% a% b% e% Y% H:% M:% S <br>  date_time_format =% H:% M:% S% Y /% m /% d <br><br>  [DaemonMode] <br>  # Set to 1 <br>  # Ignored by Windows.  See documentation <br>  daemon_fork = 1 <br><br>  # Set to numeric user id (eg: 500) or textual user id (eg: snmptt) <br>  # that snmptt should be running in daemon mode.  Leave blank <br>  # to disable.  Used to have log <br>  # files, the spool folder, read the configuration files. <br>  # Only use this if you are starting snmptt as root. <br>  # A second (child) process will be started <br>  # there will be two snmptt processes running.  The first process will <br>  # continue to run as root, waiting for the <br>  # child to quit.  After the child quits <br>  # the snmptt.pid file and exit. <br>  daemon_uid = snmptt <br><br>  # Running path when running in daemon mode. <br>  pid_file = /var/run/snmptt.pid <br><br>  # Directory to read received traps from.  Ex: / var / spool / snmptt / <br>  # Don't forget the trailing slash! <br>  spool_directory = / var / spool / snmptt / <br><br>  # Amount of time to sleep between processing spool files <br>  sleep = 5 <br><br>  # Set to 1 to have SNMPTT use the SNMPTTHLANDLER <br>  # Set to 0 to have SNMPTT use the time the trap was processed.  Note: Using 0 can <br>  # result in the number of seconds used <br>  use_trap_time = 1 <br><br>  # Set to 0 to have a SNMPTT attempt to process <br>  The trap even if it was not logged in. <br>  # Set to 1 to have SNMPTT erase the spooled trap file only after it successfully <br>  # logs to at least ONE log system. <br>  # Set to 2 to have SNMPTT erase the spooled trap file only after it successfully <br>  # logs for ALL of the enabled log systems.  Warning: If multiple log systems are <br>  will be logged to <br>  # until ALL of the log systems function. <br>  # The recommended setting is 1 with only one log system enabled. <br>  keep_unlogged_traps = 1 <br><br>  # How often duplicate traps will be processed.  An MD5 hash of all incoming traps <br>  # is stored in memory and is used to check for duplicates.  All variables except for <br>  # the uptime variable are used when calculating the MD5.  The larger this variable, <br>  # the more memory snmptt will require. <br>  # Note: it can be a good idea. <br>  # negative effect.  For example, if you are trying to connect to a wireless device <br>  # that keeps you losing <br>  # all the associations and disassociations. <br>  # 5 minutes = 300 <br>  # 10 minutes = 600 <br>  # 15 minutes = 900 <br>  duplicate_trap_window = 0 <br><br>  [Logging] <br>  Set to 1 to enable output. <br>  # Would normally be disabled unless you are <br>  stdout_enable = 0 <br><br>  # Set to 1 to enable text logging of * TRAPS *.  Make sure you specify a log_file <br>  # location <br>  log_enable = 1 <br><br>  # Log file location.  The COMPLETE path and filename.  Ex: '/var/log/snmptt/snmptt.log' <br>  log_file = /tmp/my_traps.tmp <br><br>  # Set to 1 to enable text logging of * SNMPTT system errors *.  Make sure you <br>  # specify a log_system_file location <br>  log_system_enable = 0 <br><br>  # Log file location.  The COMPLETE path and filename. <br>  # Ex: '/var/log/snmptt/snmpttsystem.log' <br>  log_system_file = /var/log/snmptt/snmpttsystem.log <br><br>  # Set to 1 to enable logging of unknown traps.  This should normally be left off <br>  # as the file could grow large quickly.  Used primarily for troubleshooting.  If <br>  # you have defined a trap in snmptt.conf, but it isn‚Äôt executing, enable this to <br>  # see if it is a trap <br>  # simply missing from the snmptt.conf file. <br>  # Unknown traps can be logged either a text file or a SQL table or both. <br>  # See SQL section to define a SQL table to log unknown traps to. <br>  unknown_trap_log_enable = 1 <br><br>  # Unknown trap log file location.  The COMPLETE path and filename. <br>  # Ex: '/var/log/snmptt/snmpttunknown.log' <br>  # Leave blank to disable logging to text if logging to SQL is enabled <br>  # for unknown traps <br>  unknown_trap_log_file = /var/log/snmptt/snmpttunknown.log <br><br>  # How often statistics statistics should be logged in syslog or the event log. <br>  # Set to 0 to disable <br>  # 1 hour = 216000 <br>  # 12 hours = 2592000 <br>  # 24 hours = 5184000 <br>  statistics_interval = 0 <br><br>  # Set to 1 to enable logging of * TRAPS * to syslog.  If you do not have the Sys :: Syslog <br>  # module then disable this.  Windows users should disable this. <br>  syslog_enable = 1 <br><br>  # Syslog facility to use for logging of * TRAPS *.  For example: 'local0' <br>  syslog_facility = local0 <br><br>  # Set the syslog level for * TRAPS * based on the severity level of the trap <br>  # as defined in the snmptt.conf file.  Values ‚Äã‚Äãmust be one per line between <br>  # the syslog_level_ * and END lines, and are not case sensitive.  For example: <br>  # Warning <br>  # Critical <br>  # Duplicate definitions will be defined with the higher severity. <br>  syslog_level_debug = &lt;&lt; END <br>  END <br>  syslog_level_info = &lt;&lt; END <br>  END <br>  syslog_level_notice = &lt;&lt; END <br>  END <br>  syslog_level_warning = &lt;&lt; END <br>  END <br>  syslog_level_err = &lt;&lt; END <br>  END <br>  syslog_level_crit = &lt;&lt; END <br>  END <br>  syslog_level_alert = &lt;&lt; END <br>  END <br><br>  # Syslog default level for * TRAPS *.  For example: warning <br>  # Valid values: emerg, alert, crit, err, warning, notice, info, debug <br>  syslog_level = warning <br><br>  # Set to 1 to enable logging of * SNMPTT system errors * to syslog.  If you do not have the <br>  # Sys :: Syslog module then disable this.  Windows users should disable this. <br>  syslog_system_enable = 1 <br><br>  # Syslog facility to use SNMPTT system errors *.  For example: 'local0' <br>  syslog_system_facility = local0 <br><br>  # SNMPTT system errors * ... For example: 'warning' <br>  # Valid values: emerg, alert, crit, err, warning, notice, info, debug <br>  syslog_system_level = warning <br><br>  [SQL] <br>  # Determines the OID or symbolic OID <br>  # Set to 0 for numeric OID <br>  # Set to 1 for symbolic OID <br>  # Uses translate_enterprise_oid_format to determine format <br>  # Note: net_snmp_perl_enable * must * be enabled <br>  db_translate_enterprise = 0 <br><br>  # FORMAT line to use for unknown traps.  If not defined, defaults to $ - *. <br>  db_unknown_trap_format = '$ - *' <br><br>  # Of custom SQL <br>  # (defined by * _table below).  The format is <br>  # column name <br>  # value <br>  # <br>  # For example: <br>  # <br>  # binding_count <br>  # $ # <br>  # uptime2 <br>  # The agent has been up for $ T. <br>  sql_custom_columns = &lt;&lt; END <br>  END <br><br>  # Of custom SQL <br>  # (defined by * _table_unknown below).  See sql_custom_columns for the format. <br>  sql_custom_columns_unknown = &lt;&lt; END <br>  END <br><br>  # MySQL: Set to 1 to enable logging to a MySQL database via DBI (Linux / Windows) <br>  # This requires DBI :: and DBD :: mysql <br>  mysql_dbi_enable = 0 <br><br>  # MySQL: Hostname of database server (optional - default localhost) <br>  mysql_dbi_host = localhost <br><br>  # MySQL: Port number of database server (optional - default 3306) <br>  mysql_dbi_port = 3306 <br><br>  # MySQL: Database to use <br>  mysql_dbi_database = snmptt <br><br>  # MySQL: Table to use <br>  mysql_dbi_table = snmptt <br><br>  # MySQL: Table to use for unknown traps <br>  # Leave blank to disable logging of unknown to MySQL <br>  # Note: unknown_trap_log_enable must be enabled. <br>  mysql_dbi_table_unknown = snmptt_unknown <br><br>  # MySQL: Table to use for statistics <br>  # Note: statistics_interval must be set.  See also stat_time_format_sql. <br>  #mysql_dbi_table_statistics = snmptt_statistics <br>  mysql_dbi_table_statistics = <br><br>  # MySQL: Username to use <br>  mysql_dbi_username = snmpttuser <br><br>  # MySQL: Password to use <br>  mysql_dbi_password = password <br><br>  # MySQL: ping the database before attempting an INSERT <br>  # to ensure the connection is still valid.  If * any * error is generate by <br>  # the ping such as 'Unable to connect to database', it will attempt to <br>  # re-create the database connection. <br>  # Set to 0 to disable <br>  # Set to 1 to enable <br>  # Note: This has no effect on mysql_ping_interval. <br>  mysql_ping_on_insert = 1 <br><br>  # MySQL: How often in seconds to ensure the database should be pinged <br>  # connection is still valid.  If * any * error is generate by the ping such as <br>  # 'Unable to connect to database', the database <br>  # connection.  Set to 0 to disable pinging. <br>  # Note: This has no effect on mysql_ping_on_insert. <br>  # disabled = 0 <br>  # 5 minutes = 300 <br>  # 15 minutes = 900 <br>  # 30 minutes = 1800 <br>  mysql_ping_interval = 300 <br><br>  # PostgreSQL: Set to 1 to enable logging to a PostgreSQL database via DBI (Linux / Windows) <br>  # This requires DBI :: and DBD :: PgPP <br>  postgresql_dbi_enable = 0 <br><br>  # Set to 0 to use the DBD :: PgPP module <br>  # Set to 1 to use the DBD :: Pg module <br>  postgresql_dbi_module = 0 <br><br>  # Set to 0 to disable host and port network support <br>  # Set to 1 to enable host and port network support <br>  # If set to 1, ensure PostgreSQL is configured to allow connections via TCPIP by setting <br>  # tcpip_socket = true in the $ PGDATA / postgresql.conf file <br>  # the SNMPTT server to $ PGDATApg_hba.conf.  The common location for the config files for <br>  # RPM installations of PostgreSQL is / var / lib / pgsql / data. <br>  postgresql_dbi_hostport_enable = 0 <br><br>  # PostgreSQL: Hostname of database server (optional - default localhost) <br>  postgresql_dbi_host = localhost <br><br>  # PostgreSQL: Port number of database server (optional - default 5432) <br>  postgresql_dbi_port = 5432 <br><br>  # PostgreSQL: Database to use <br>  postgresql_dbi_database = snmptt <br><br>  # PostgreSQL: Table to use for unknown traps <br>  # Leave blank to disable logging of unknown traps to PostgreSQL <br>  # Note: unknown_trap_log_enable must be enabled. <br>  postgresql_dbi_table_unknown = snmptt_unknown <br><br>  # PostgreSQL: Table to use for statistics <br>  # Note: statistics_interval must be set.  See also stat_time_format_sql. <br>  #postgresql_dbi_table_statistics = snmptt_statistics <br>  postgresql_dbi_table_statistics = <br><br>  # PostgreSQL: Table to use <br>  postgresql_dbi_table = snmptt <br><br>  # PostgreSQL: Username to use <br>  postgresql_dbi_username = snmpttuser <br><br>  # PostgreSQL: Password to use <br>  postgresql_dbi_password = password <br><br>  # PostgreSQL: whether or not to ping the database before attempting an INSERT <br>  # to ensure the connection is still valid.  If * any * error is generate by <br>  # the ping such as 'Unable to connect to database', it will attempt to <br>  # re-create the database connection. <br>  # Set to 0 to disable <br>  # Set to 1 to enable <br>  # Note: This has no effect on postgresqll_ping_interval. <br>  postgresql_ping_on_insert = 1 <br><br>  # PostgreSQL: How often in seconds should the database be pinged to ensure the <br>  # connection is still valid.  If * any * error is generate by the ping such as <br>  # 'Unable to connect to database', the database <br>  # connection.  Set to 0 to disable pinging. <br>  # Note: This has no effect on postgresql_ping_on_insert. <br>  # disabled = 0 <br>  # 5 minutes = 300 <br>  # 15 minutes = 900 <br>  # 30 minutes = 1800 <br>  postgresql_ping_interval = 300 <br><br>  # ODBC: Set to 1 to enable database via ODBC using DBD :: ODBC. <br>  # This requires both DBI :: and DBD :: ODBC <br>  dbd_odbc_enable = 0 <br><br>  # DBD: ODBC: Database to use <br>  dbd_odbc_dsn = snmptt <br><br>  # DBD: ODBC: Table to use <br>  dbd_odbc_table = snmptt <br><br>  # DBD: ODBC: Table to use for unknown traps <br>  # Leave blank to disable logging of unknown traps to DBD: ODBC <br>  # Note: unknown_trap_log_enable must be enabled. <br>  dbd_odbc_table_unknown = snmptt_unknown <br><br>  # DBD: ODBC: Table to use for statistics <br>  # Note: statistics_interval must be set.  See also stat_time_format_sql. <br>  #dbd_odbc_table_statistics = snmptt_statistics <br>  dbd_odbc_table_statistics = <br><br>  # DBD: ODBC: Username to use <br>  dbd_odbc_username = snmptt <br><br>  # DBD: DBC :: Password to use <br>  dbd_odbc_password = password <br><br>  # DBD: ODBC: whether or not to ping the database before attempting an INSERT <br>  # to ensure the connection is still valid.  If * any * error is generate by <br>  # the ping such as 'Unable to connect to database', it will attempt to <br>  # re-create the database connection. <br>  # Set to 0 to disable <br>  # Set to 1 to enable <br>  # Note: This has no effect on dbd_odbc_ping_interval. <br>  dbd_odbc_ping_on_insert = 1 <br><br>  # DBD: ODBC :: How often in seconds the database should be pinged to ensure the <br>  # connection is still valid.  If * any * error is generate by the ping such as <br>  # 'Unable to connect to database', the database <br>  # connection.  Set to 0 to disable pinging. <br>  # Note: This has no effect on dbd_odbc_ping_on_insert. <br>  # disabled = 0 <br>  # 5 minutes = 300 <br>  # 15 minutes = 900 <br>  # 30 minutes = 1800 <br>  dbd_odbc_ping_interval = 300 <br><br>  # The date time format for the traptime column in SQL.  Defaults to <br>  # localtime ().  When a date / time field is used in SQL, this should <br>  # be changed to follow a standard that is supported by the SQL server. <br>  # Example: For a MySQL DATETIME, use% Y-% m-% d% H:% M:% S. <br>  #date_time_format_sql = <br><br>  # The date format for the stat_time column in SQL.  Defaults to <br>  # localtime ().  When a date / time field is used in SQL, this should <br>  # be changed to follow a standard that is supported by the SQL server. <br>  # Example: For a MySQL DATETIME, use% Y-% m-% d% H:% M:% S. <br>  #stat_time_format_sql = <br><br>  [Exec] <br><br>  # Set to 1 to allow EXEC statements to execute.  Should normally be left on unless you <br>  # want to temporarily disable all EXEC commands <br>  exec_enable = 1 <br><br>  # Set to 1 to allow PREEXEC statements to execute.  Should normally be left on unless you <br>  # want to temporarily disable all PREEXEC commands <br>  pre_exec_enable = 1 <br><br>  # If defined, for all unknown traps.  Passed to the <br>  # command will be the standard <br>  # but without the newlines. <br>  unknown_trap_exec = <br><br>  # FORMAT line that is passed to the unknown_trap_exec command.  If not defined, it <br>  # defaults to what is described in the unknown_trap_exec setting.  The following <br>  # would be * similar * to the default setting described in the unknown_trap_exec setting <br>  # (all on one line): <br>  # $ x !!!  $ X: Unknown trap ($ o) received from $ A at: Value 0: $ A Value 1: $ aR <br>  # Value 2: $ T Value 3: $ o Value 4: $ aA Value 5: $ C Value 6: $ e Ent Values: $ + * <br>  unknown_trap_exec_format = <br><br>  # Set to 1 to escape wildards (* and?) In EXEC, PREEXEC and the unknown_trap_exec <br>  # commands.  Enable this to prevent the shell from expanding the wildcard <br>  # characters.  The default is 1. <br>  exec_escape = 1 <br><br>  [Debugging] <br>  # 0 - do not output messages <br>  # 1 - output some basic messages <br>  # 2 - out all messages <br>  DEBUGGING = 2 <br><br>  # Debugging file - SNMPTT <br>  # Location of debugging output file.  Leave blank to default to STDOUT (good for <br>  # standalone mode, or daemon mode without forking) <br>  DEBUGGING_FILE = /tmp/snmptt.debug <br>  # DEBUGGING_FILE = /var/log/snmptt/snmptt.debug <br><br>  # Debugging file - SNMPTTHANDLER <br>  # Location of debugging output file.  Leave blank to default to STDOUT <br>  DEBUGGING_FILE_HANDLER = <br>  # DEBUGGING_FILE_HANDLER = /var/log/snmptt/snmptthandler.debug <br><br>  [TrapFiles] <br>  # A list of snmptt.conf files (this is NOT the snmptrapd.conf file).  The COMPLETE path <br>  # and filename.  Ex: '/etc/snmp/snmptt.conf' <br>  snmptt_conf_files = &lt;&lt; END <br>  /etc/snmp/snmptt.conf <br>  END <br></div></div><br>  Thus, the snmpd daemon listens on the udp port 162 and redirects messages to snmptt. It processes the trap and runs the php script for execution.  In the snmptt.ini config, debug mode is enabled, so all incoming traps will be recorded in /tmp/snmptt.debug. <br><br></li><li>  Actually, the processing script itself (I suppose that php and mysql are already installed and configured on the server): <br><div class="spoiler">  <b class="spoiler_title">/opt/script.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/php -q &lt;?php // argv  ,    //$argv[0]       //. /etc/snmp/snmptt.conf . -ip,-Mac-Notification. //ip- $ip=$argv[1]; // mac-notification   mac_msg for($i=2;$i&lt;=count($argv)-2;$i++) { $mac_msg .= $argv[$i]; } //  mac_msg   mac-notification $mac_notification = str_split($mac_msg,22); //   /*  CREATE TABLE IF NOT EXISTS `mac_notification` ( `id` int(11) NOT NULL AUTO_INCREMENT, `date_create` datetime NOT NULL, `status` varchar(20) NOT NULL, `vlan` varchar(250) NOT NULL, `mac` varchar(20) NOT NULL, `interface` int(11) NOT NULL, `ip` varchar(250) NOT NULL, PRIMARY KEY (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf32 ; */ $CONF_DB = array ( 'host' =&gt; 'localhost', 'username' =&gt; 'USERNAME', 'password' =&gt; 'PASSWORD', 'db_name' =&gt; 'mac' ); $dbConnection = new PDO( 'mysql:host='.$CONF_DB['host'].';dbname='.$CONF_DB['db_name'], $CONF_DB['username'], $CONF_DB['password'], array(PDO::MYSQL_ATTR_INIT_COMMAND =&gt; "SET NAMES utf8") ); $dbConnection-&gt;setAttribute(PDO::ATTR_EMULATE_PREPARES, false); $dbConnection-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION); foreach($mac_notification as $value) { //  mac-notification $status=substr($value,0,2); $vlan=hexdec(substr($value,2,4)); $mac=substr($value,6,12); $mac = mb_strtolower(substr_replace($mac,".",4).substr_replace(substr($mac,4,8),".",4).substr($mac,8,12)); $interface=hexdec(substr($value,20,2)); $stmt = $dbConnection-&gt;prepare('INSERT INTO mac_notification (date_create,status,mac,interface,ip,vlan) VALUES (now(), :status, :mac, :interface, :ip, :vlan)'); $stmt-&gt;execute(array(':status'=&gt;$status,':mac'=&gt;$mac,':interface'=&gt;$interface,':ip'=&gt;$ip,':vlan'=&gt;$vlan)); } ?&gt;</span></span></code> </pre><br></div></div><br></li></ol><br><br>   ‚Äî       snmp .  <a href="">Cisco ftp</a>      . <br><br> ,      . </habracut></div><p>Source: <a href="https://habr.com/ru/post/243035/">https://habr.com/ru/post/243035/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../243021/index.html">Vibration of the XboxOne gamepad for Unity3d</a></li>
<li><a href="../243023/index.html">Why Spritz has become so popular over the past few weeks.</a></li>
<li><a href="../243025/index.html">New on VPS Search: Notepad Domains and Notepad Servers</a></li>
<li><a href="../243027/index.html">Wargaming Developers Contest: Winners Announcement</a></li>
<li><a href="../243033/index.html">How and why does Yandex disable its own data centers</a></li>
<li><a href="../243037/index.html">Decorative decorative lamp SDB-Z "Evlampiya"</a></li>
<li><a href="../243039/index.html">Sandcastle and SHFB</a></li>
<li><a href="../243045/index.html">NetApp FAS performance optimization</a></li>
<li><a href="../243047/index.html">A 19-year-old vulnerability can capture a computer through Internet Explorer.</a></li>
<li><a href="../243049/index.html">Which GIS to use after the actual death of Google Maps?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>