<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mobile printing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In our time, no one will be surprised by printing pictures on a sheet of paper. There is a huge selection of printers (including pocket). Many of my f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mobile printing</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/591/700/86c/59170086cbda4e0893e8afd76a8db6ae.JPG"><br><br>  In our time, no one will be surprised by printing pictures on a sheet of paper.  There is a huge selection of printers (including pocket).  Many of my friends are buying or collecting 3D printers.  I want to tell you how I reinvent the wheel.  So, again, a step back is a story about 2D printing.  A story about how I made a mobile printer for a phone based on a thermal printer (a printer that prints on thermal paper ‚Äî no ink is needed, only special paper and electricity), a bluetooth module, and a few other little things. <br>  I want to immediately warn you that in electronics and electrical engineering I don‚Äôt understand anything, that I basically did not use ready-made solutions and libraries.  Therefore, this is a story about the handle and bicycles, about the problems I encountered.  Continue reading at your own risk. <br><a name="habracut"></a><br><h4>  Super technology device </h4><br>  I think I don‚Äôt need to be reminded that we live in the age of mobile technology.  I remember how about 20 years ago I thought that there would be a little more and the world would be full of robots, flying cars and many, many more amazing things.  Taking into account the fact that I thought that some more and everyone will have their own robots, it‚Äôs also symbolic that we really don‚Äôt have any robots (I‚Äôm sorry for the vacuum cleaner advocates, please forgive me the last sentence), but there‚Äôs something else ... I believed if I was then told that almost every person on earth would have a supertechnological device in his pocket, with which people would sit on the toilet, run a simulation of the physical interactions of the process of stuffing birds in pigs.  And if they told me that this device would be called a telephone, I would have laughed at all in the face of the narrator. <br><br><h4>  A bit of history </h4><br>  The 95th year was on the nose (maybe earlier, but I already wrote in the last paragraph about ‚Äú20 years ago‚Äù, and ‚Äú20‚Äù is a beautiful and round number, so I will stay with him) and one of my acquaintances from the yard had Gameboy (DMG-001).  I don‚Äôt think it‚Äôs worth telling how cool he was by the standards of the time and what queue lined up to watch and hold this miracle of technology in hand.  In the early 2000s, this device again reminded of itself, because  additional peripherals appeared to him, namely the camera and the printer.  There was no real need for such a camera or printer (even more so of such quality), but the very idea of ‚Äã‚Äãa mobile device from which it was possible to print a small picture seemed a step into the future. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/973/f17/04a/973f1704a595417b85f92dfa656bfcf2.JPG"><br><br><h4>  Back to topic </h4><br>  So, 20 years have passed and I thought that it would be possible to make a similar device, only for a super-technological device - a telephone. <br><br>  The idea was quite simple and was based on the following things: <br><ol><li>  Thermal Printer (A2 Micro Panel Thermal Printer). </li><li>  Bluetooth module (JY-MCU BT_BOARD V1.06). </li><li>  Controller (Stellaris Launchpad LM4F120XL. To avoid the ‚Äúwhy?‚Äù Questions, I will immediately reply that I just had this particular board at hand). </li><li>  Screen (LCD 84x48 Nokia 5110) and several led diodes for status indication. </li><li>  Battery and regulator (Turnigy UBEC 5A). </li><li>  Application for Android to manage the printer (read as "print"). </li><li>  Discharge on the handle and poor knowledge of the fundamentals of electrical engineering. </li></ol><br>  It is because of the 7th point that I have to ask for forgiveness from everyone who is upset by my implementation.  Forgive me, but you will not find an adequate development of devices in this narration for making printed circuit boards, debugging a device using an oscilloscope and other goodies.  I don't have the necessary tools either, because  in everyday life, I don‚Äôt work in this area, and I don‚Äôt want to lose my job in handcuffing.  I tried to improve my knowledge of the subject area a little, but somehow, I understand that I can be mistaken in terminology.  I myself find it painful to look at the code of people far from programming, therefore, in order not to take more time from lovers of the beautiful in the field of electrical engineering, I post a photo of how everything was collected: <br><br><img src="https://habrastorage.org/files/0ac/19c/371/0ac19c37135841bcb5dda241c747954b.JPG"><br><br>  Well, for everyone who continued reading after the last photo, the achiveka ‚ÄúExperienced the hell of the perfectionist electrical engineer‚Äù is available ... <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a03/975/d70/a03975d703b047d1b7fe851d1a8e9074.png"></div><br><br>  So, as I said, the idea was simple: there is a picture on the phone (it doesn't matter what the source of the picture is, just accept that there is a picture), you need to reduce it, manipulate brightness and contrast (if necessary), then dither (dither) to get a black and white image, then send via bluetooth to the printer and directly print. <br><br>  Since I am developing software, there were no problems or problems with the software.  A simple protocol of data exchange between the printer and the control device was implemented (since the printer accepts commands via bluetooth, it makes no sense to be limited to just the phone): <br><ol><li>  Binary protocol is used to deceive data. </li><li>  Data is transmitted in the form of packets, each of which begins with a header (what a packet, how much data). </li><li>  There are two replies for each request packet (‚Äúrequest received‚Äù and ‚Äúrequest execution complete‚Äù).  It would have been possible to do with one answer, but in this mode it was possible to better control the state of the printer ‚Äî there is no need to implement a command queue on the controller side, since  the controller itself reports that it is ready to execute a new request. </li></ol><br>  In addition to service commands such as ‚Äúis the printer alive?‚Äù, Only a few commands were implemented that are directly related to printing (image printing and paper feed). <br><br>  Since the printer is capable of printing only monochrome images, a simplified Bitmap analogue with 1bpp (1 bit per pixel) was chosen as the image format.  The printer is capable of printing 384 dots per line, which means that 48 bytes are needed to print one full line (not counting the header). <br><br><h4>  Communication problems </h4><br>  I will not focus on the fact that the controller refused to receive data from the bluetooth module due to too low voltage on the leg of the TX module, since  I spent a lot of time debugging this part.  I killed about two days for this, because  first I checked everything I could and only then went to read the Internet, from where I found out that this is a feature of the selected module and that I would have to tighten the level to the required 3.3V myself, or I would have to force the module and solder the diode from it (which I decided not to do). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/219/dda/66d/219dda66d9184bdeaf1f363d22f16416.JPG"></div><br><br>  After I was able to receive packets on the controller side, another problem appeared: the data came in part.  Until now, I can‚Äôt say exactly what the problem was, but here the toli is the buffer limit of the bluetooth module, toli is its data transfer / processing speed.  The problem was this: we send a packet (for example, kilobytes of data), on the controller side we get 990-1023 bytes with losses in a random range (random data area, random number).  Data loss occurred in about 50% of cases and was always a small percentage of the original data (no more than 50 bytes, even when sending a few kilobytes).  The problem was repeated at all data exchange rates (not that I checked everything, but checked both the mean and the boundaries - 1200 and 115200 baud), but disappeared when adding the delay between sending data.  In order not to embed synthetic delays, I decided that I would simply supplement the data exchange protocol: <br><ol><li>  A checksum of the packet has been added. </li><li>  Data within the packet was transmitted by fragments, after the transmission of a fragment of data, a response was expected from the controller, which sent the sequence number of the received fragment. </li><li> A service pack was added to set the fragment size (usually 128 bytes are used, but I left the ability to change the size of the fragment). </li></ol><br>  So, the first thing that was needed to determine the beginning of a packet is the signature (a certain sequence of bytes): <br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _receiveSignature( ) { <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> character; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> offset = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>( offset != SIGNATURE_SIZE ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( _readByte( &amp;character ) ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( character != SIGNATURE[offset] ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( character == SIGNATURE[<span class="hljs-number"><span class="hljs-number">0</span></span>] ) offset = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> offset = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> offset++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> <br><br>  The idea with the signature is not new.  In the event that one of the parties, for some reason, interrupted reception of the packet in the middle of the transmission, the remaining packet data should not be interpreted as the next packet.  Thus, reception begins with the fact that all bytes are removed (ignored) from the buffer, before the signature - the beginning of the packet header.  Thus, it is ensured that random garbage in the buffer (remnants of the past packet) will not be considered the header of the new packet. <br><br>  The code for receiving data by fragments (data area, after receiving and checking the header): <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *buffer = m_buffer; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> size = m_header.size; _sendCallback( <span class="hljs-number"><span class="hljs-number">0</span></span> ); <span class="hljs-comment"><span class="hljs-comment">// resets fragment id while( size &gt; 0 ) { unsigned int fragmentSize = _min( size, m_fragmentSize ); if( read( buffer, fragmentSize ) ) { size -= fragmentSize; buffer += fragmentSize; _sendCallback( ); } else { _sendCallback( 0 ); // sends wrong fragment id _setError( READ_ERROR ); return false; } //      callback (  ) } unsigned int checksum = _getChecksum( m_buffer, m_header.size ); if( m_header.checksum != checksum ) { send( COMMAND_ERROR ); _setError( INVALID_CHECKSUM ); return false; }</span></span></code> </pre><br><br>  Since there is a possibility that there will be losses during data transmission, it is necessary to check the sequence number of the packet.  For example, a print request has been sent, and no response has been received.  In this case, the request will be sent again, but you do not need to fulfill it, because  simply answer the status of the previous request.  Each of the parties considers the packages and if the sequence number of the package is incorrect, then you should start the communication ‚Äúfrom scratch‚Äù (reset the counters). <br><br><h4>  In addition to the printer itself </h4><br>  In addition to the printer, controller and communication module (bluetooth), several elements were added to indicate the status.  3 LEDs have been added: <br><ol><li>  Power indicator. </li><li>  Indicator of the connection with the phone (it is on, if during the last 5 seconds there was data transfer). </li><li>  Print Indicator (lit when printing occurs). </li></ol><br><div style="text-align:center;"><img src="https://habrastorage.org/files/4ec/f44/e2e/4ecf44e2e3fb480a983bd48564f5b7e8.JPG"></div><br><br>  In addition to simple indicators, a monochrome screen was added to display progress, status and other trifles. <br><br>  The general scheme looks like this: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/a87/246/16d/a8724616df4d49b4a1ddaaffc0df37fd.png"></div><br><br><h4>  Appearance </h4><br>  For the case, I decided to use 4mm plywood, I trusted the plywood cutting machine with a laser.  All I needed was a vector drawing and money for the work.  The drawing came out like this: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/d00/cf2/69d/d00cf269d0164116805e0dbcc888205c.png"></div><br><br>  Red marked areas that were necessary to burn, not cut.  The result pleased.  Of the minuses of this box, I can only name the fact that it is glued together and can not be parsed.  Fortunately, I brought out the port for the new firmware of the controller and the port for charging the battery, so there is no need to disassemble the box: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/d3e/a9a/81d/d3ea9a81d2b8425d972c845b3d040702.jpg"></div><br><br>  It should be clarified that the box turned out the third time.  At first, the box simply did not agree - I hurried, did not check the dimensions, and one face did not fit.  Then I redid the drawing, but made a rather stupid choice in how to fix the glass protecting the screen: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/bcd/e20/8fd/bcde208fd67046b1a4fd2fee08a225fa.jpg"></div><br><br>  As a result, the glass was hidden in the case and did not stick out from the outside (I will not insert the picture from the beginning of the article here again). <br><br><h4>  application </h4><br>  On the side of the phone, I made a rather primitive interface: <br>  Select images for printing (from the camera or from the file system): <br><div style="text-align:center;"><img src="https://habrastorage.org/files/f71/0fc/976/f710fc976f854215bbe257733231e9d4.png"></div><br><br>  Image settings - brightness and contrast: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/33e/a7b/c1a/33ea7bc1a7e043bbb0172e51970384a2.png"></div><br><br>  Several controls (connect to printer, print, feed paper, rotate image): <br><div style="text-align:center;"><img src="https://habrastorage.org/files/6b6/e51/630/6b6e51630f0b494da8d88c40249e6aee.png"></div><br><br><h4>  results </h4><br>  Print quality is pretty decent (for a thermal printer): <br><div style="text-align:center;"><img src="https://habrastorage.org/files/712/d90/989/712d909895374e0588268f28f3f37819.JPG"></div><br><br>  Like many printers, this is not an exception and a little bit of ‚Äústriped‚Äù: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/b5d/dd4/478/b5ddd447878a440da49dcebdbf160cf9.jpg"></div><br><br>  In general, what I would like to say with this story is that you should not be afraid to do things yourself, you should not be afraid of bicycles.  Nowadays, the development of its devices has become much easier.  Controllers are not so limited in resources, unpretentious in work and forgive some mistakes (which a person who understands in electrical engineering would not allow).  Do things yourself, reinvent your bikes.  Thanks to everyone who read to the end. </div><p>Source: <a href="https://habr.com/ru/post/264829/">https://habr.com/ru/post/264829/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264815/index.html">As we raised the IT infrastructure [from the bottom]</a></li>
<li><a href="../264819/index.html">Asterisk Manager Interface in dialplan</a></li>
<li><a href="../264821/index.html">DMP Part 1. Microsegmentation of the audience using keywords</a></li>
<li><a href="../264823/index.html">We write Observer implementation over KVO on objective-c</a></li>
<li><a href="../264827/index.html">Training in the field of practical information security: "Corporate laboratories". New set</a></li>
<li><a href="../264839/index.html">15 Important Developer Career Tips</a></li>
<li><a href="../264841/index.html">How to write software for the whole world</a></li>
<li><a href="../264843/index.html">Exploring OpenWRT: what is the difference between the uImage and sysupgrade images</a></li>
<li><a href="../264845/index.html">The digest of interesting materials for the mobile # 116 developer (on August 10-16)</a></li>
<li><a href="../264849/index.html">Megaphone - anyone can manage your account</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>