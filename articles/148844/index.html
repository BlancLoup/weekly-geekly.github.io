<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The first experience of writing plugins for Autocad in C #</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 I am a novice developer, ‚Äúschool‚Äù level of knowledge of C ++, a small (2 years) programming experience in C #, zero experience in autocad...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The first experience of writing plugins for Autocad in C #</h1><div class="post__text post__text-html js-mediator-article"><h3>  Prehistory </h3><br>  I am a novice developer, ‚Äúschool‚Äù level of knowledge of C ++, a small (2 years) programming experience in C #, zero experience in autocade <br>  Recently they asked me to change the LISP autocad programs for creating / modifying land-bound plans and preparing the corresponding MS Word / XML documents - fix the bugs and add new functionality. <br>  Since the readability of Lisp programs (at least for me) leaves much to be desired, I decided to rewrite it into a more understandable language. <br>  Because  I didn‚Äôt need a millisecond increase in speed, I missed C ++ and stopped at C # <br><br><a name="habracut"></a><br><br><h4>  I am writing this article to: </h4><br>  1. Arrange in my head on the shelves that I learned about Autocad. <br>  2. Help those who, like me, break through a very small amount of documentation. <br>  3. Get in the comments information like "you do it wrong, it will be easier and better to do so ..." 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Beginning of work.  Creating a plugin. </h3><br>  Create a C # project using the ClassLibrary template <br>  Add links to the Autocad API libraries managed library, which are in the program folder. <br>  In my case it is: <br>  C: \ Program Files \ AutoCAD 2007 \ acdbmgd.dll <br>  C: \ Program Files \ AutoCAD 2007 \ acmgd.dll <br><br><div class="spoiler">  <b class="spoiler_title">Create a class that does something:</b> <div class="spoiler_text"><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Autodesk.AutoCAD.Runtime; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Autodesk.AutoCAD.ApplicationServices; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">AutocadPlugin</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">test</span></span> : <span class="hljs-title"><span class="hljs-title">IExtensionApplication</span></span> { [CommandMethod(<span class="hljs-string"><span class="hljs-string">"hello"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Helloworld</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> editor = Application.DocumentManager.MdiActiveDocument.Editor; editor.WriteMessage(<span class="hljs-string"><span class="hljs-string">"  Autocad "</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Initialize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> editor = Application.DocumentManager.MdiActiveDocument.Editor; editor.WriteMessage(<span class="hljs-string"><span class="hljs-string">" .."</span></span>+Environment.NewLine); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Terminate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } } }</code> </pre> <br></div></div><br>  Inheritance from IExtensionApplication is optional, Autocad will automatically hook all public classes into libraries, but, as I was told, it will be faster.  Plus you can control the Initialize / Terminate plugin. <br><br>  We compile, launch the autoCAD, load the plugin with the netload command (the managed dll selection window opens) <br>  Now when you enter the hello command, we will receive the expected response. <br><br><h3>  The structure of the Autocad application: </h3><br>  What we see on the screen are graphical objects inherited from <i>Entity</i> <br>  In addition to the visible, there are invisible information objects - <i>Layers</i> , <i>Line Types</i> , <i>Dimension</i> <i>Styles, Table Styles</i> , etc. <br>  All this is stored in the <i>Database Table Records</i> , in storages of the type <i>TYPETable</i> and classes of the type <i>TYPETableRecord</i> . <br><br><h4>  Object IDs </h4><br><ul><li>  <b>ObjectId</b> , also known as EName (entity name).  The number created when opening a picture. <br>  Use - identification of the object in the database within one session, the object is requested from the base by its ObjectId <br>  <u><b>May vary between different discoveries, it is better not to use to save references to objects.</b></u> <br></li><li>  <b>Handle</b> - a number that does not change between different openings of a document, it is convenient to use to save links between objects when saving a file. <br></li></ul><br>  <a href="http://docs.autodesk.com/ACD/2010/ENU/AutoCAD%2520.NET%2520Developer%2527s%2520Guide/index.html%3Furl%3DWS73099cc142f48755-5c83e7b1120018de8c0-23ce.htm,topicNumber%3Dd0e351">For more information on</a> <i>how to access a drawing, it can be used.</i>  <i>In the database there is only a while the database is loaded into memory.</i>  <i>Once the database is closed, the object has been assigned.</i> <br><br><h3>  Work with database </h3><br>  Usually work with the database is through a transaction.  Objects are queried from the database, modified, and commit transactions are saved back. <br>  During the transaction, the object is requested from the database in one of the 3 modes ForRead, ForWrite, ForNotify. <br>  The purpose of the first two is obvious, the third is somehow used for the mechanism of events, with which I have not yet intersected <br>  In the ForWrite mode, an autocad creates additional objects that allow you to undo the changes in the transaction. <br>  If you need to change an object opened as ‚ÄúForRead‚Äù, its UpgradeOpen () method is called. <br>  If you call this method on an object that is already open in change mode, the method will throw an exception. <br><br><div class="spoiler">  <b class="spoiler_title">An example of getting a Polyline object by its ObjectId</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">// <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span>:     ,   .     ,     UpgradeOpen  , ..    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static Polyline GetPolylineByEname(ObjectId ename) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ename == ObjectId.<span class="hljs-keyword"><span class="hljs-keyword">Null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; Polyline polyline = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; var db = Application.DocumentManager.MdiActiveDocument.<span class="hljs-keyword"><span class="hljs-keyword">Database</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span> = db.TransactionManager.StartTransaction()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span>.GetObject(ename, OpenMode.ForRead) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Polyline; } }</code> </pre><br></div></div><br>  Transactions can be nested, if you cancel a high-level transaction, all children are canceled. <br>  In the beginning, for a long time I could not make out where the error was - the changes in the drawing were not saved.  As it turned out, I forgot to close the upper tranz. <br><div class="spoiler">  <b class="spoiler_title">Illustration</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> OwnerTransFunction() { var db = Application.DocumentManager.MdiActiveDocument.<span class="hljs-keyword"><span class="hljs-keyword">Database</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span> = db.TransactionManager.StartTransaction()) { //   ChangePolylineInChildTransation() } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> ChangePolyline() { var db = Application.DocumentManager.MdiActiveDocument.<span class="hljs-keyword"><span class="hljs-keyword">Database</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span> = db.TransactionManager.StartTransaction()) { //   //   <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Commit</span></span>(); //       ,       <span class="hljs-keyword"><span class="hljs-keyword">Commit</span></span><span class="hljs-string"><span class="hljs-string">'a    } }</span></span></code> </pre><br></div></div><br>  UPDATE: As I was told in the comments, it is preferable to always call transaction.Commit (), unless you need to cancel the transaction.  If the transaction does not commit, transaction.Abort () is automatically called, incurring additional costs. <br><br><h3>  Dictionaries </h3><br>  I used dictionaries to save my data in DWG, so as not to create unnecessary files <br>  I ran into two kinds of dictionaries in a drawing - <b>NamedObjectDictionary</b> and <b>ExtensionDictionary</b> <br>  Data in dictionaries is stored in records (Record), which in turn store typed values. <br>  Data is sent by text keys. <br><br>  NamedObjectDictionary - global drawing dictionary.  It is created automatically when creating a document. <br>  I used it to store references to the main objects I used. <br><br>  ExtensionDictionary - a dictionary, its own for each object, you need to create it manually. <br>  You can check its existence by comparing the entity.ExtensionDictionary field with ObjectId.Null <br><br><div class="spoiler">  <b class="spoiler_title">Example of writing and retrieving a string value from ExtensionDictionary</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">void</span></span> SetExtDictionaryValueString(ObjectId ename, string key, string <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ename == ObjectId.<span class="hljs-keyword"><span class="hljs-keyword">Null</span></span>) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ArgumentNullException("ename"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String.IsNullOrEmpty(key)) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ArgumentNullException("key"); var doc = Application.DocumentManager.MdiActiveDocument; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span> = doc.<span class="hljs-keyword"><span class="hljs-keyword">Database</span></span>.TransactionManager.StartTransaction()) { var entity = <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span>.GetObject(ename, OpenMode.ForWrite); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entity == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> DataException("      ExtensionDictionary: entity  ObjectId=" + ename + "  "); //    extDictionary var extensionDictionaryId = entity.ExtensionDictionary; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (extensionDictionaryId == ObjectId.<span class="hljs-keyword"><span class="hljs-keyword">Null</span></span>) { entity.CreateExtensionDictionary(); extensionDictionaryId = entity.ExtensionDictionary; } var extDictionary = (DBDictionary) <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span>.GetObject(extensionDictionaryId, OpenMode.ForWrite); //     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String.IsNullOrEmpty(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (extDictionary.Contains(key)) extDictionary.Remove(key); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } var xrec = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Xrecord(); xrec.Data = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ResultBuffer(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> TypedValue((<span class="hljs-type"><span class="hljs-type">int</span></span>) DxfCode.ExtendedDataAsciiString, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)); extDictionary.SetAt(key, xrec); <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span>.AddNewlyCreatedDBObject(xrec, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.WriteLine(entity.Handle+"['" + key + "'] = '" + <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> + "'"); <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Commit</span></span>(); } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static string GetExtDictionaryValueString(ObjectId ename, string key) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ename == ObjectId.<span class="hljs-keyword"><span class="hljs-keyword">Null</span></span>) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ArgumentNullException("ename"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String.IsNullOrEmpty(key)) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ArgumentNullException("key"); var doc = Application.DocumentManager.MdiActiveDocument; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span> = doc.<span class="hljs-keyword"><span class="hljs-keyword">Database</span></span>.TransactionManager.StartTransaction()) { var entity = <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span>.GetObject(ename, OpenMode.ForRead); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entity == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> DataException("      ExtensionDictionary:   ObjectId=" + ename + "  "); var extDictionaryId = entity.ExtensionDictionary; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (extDictionaryId == ObjectId.<span class="hljs-keyword"><span class="hljs-keyword">Null</span></span>) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> DataException("      ExtensionDictionary:   "); var extDic = (DBDictionary)<span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span>.GetObject(extDictionaryId, OpenMode.ForRead); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!extDic.Contains(key)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; var myDataId = extDic.GetAt(key); var readBack = (Xrecord)<span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span>.GetObject(myDataId, OpenMode.ForRead); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (string)readBack.Data.AsArray()[<span class="hljs-number"><span class="hljs-number">0</span></span>].<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>; } }</code> </pre><br></div></div><br>  Working with the global dictionary is almost the same, only the DBDictionary object is obtained as follows: <br><pre> <code class="hljs pgsql">var <span class="hljs-keyword"><span class="hljs-keyword">dictionary</span></span> = (DBDictionary) <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span>.GetObject(db.NamedObjectsDictionaryId, OpenMode.ForWrite);</code> </pre><br><br><h3>  What else have I encountered </h3><br><div class="spoiler">  <b class="spoiler_title">1. Autoload plugin</b> <div class="spoiler_text">  After a couple of dozen times entering the netload for a five-second verification of the plug-in, I got bored and I began to look for how to simplify the procedure. <br>  During the search, I came across an article about autoloading .NET plug-ins.  In short - you need to add the key to the registry <br><pre> <code class="hljs tex">Windows Registry Editor Version 5.00 [HKEY_LOCAL_MACHINE<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SOFTWARE</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Autodesk</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AutoCAD</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">R</span></span></span></span>17.0<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ACAD</span></span></span></span>-5001:419<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Applications</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GeocomplexPlugin</span></span></span></span>] "LOADCTRLS"=dword:00000002 "MANAGED"=dword:00000001 "LOADER"="C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>GeoComplexAutocadPlugin<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>AutocadGeocomplexPlugin.dll"</code> </pre><br>  <b>Explanations:</b> <br>  R17.0 - Autocad 2007 <br>  419 for the Russian version <br>  409 for the English version <br>  GeocomplexPlugin - created section <br>  LOADCTRLS = 2 - load auto-launch at start.  Certain keys can be run on demand, the plugin is loaded when one of its commands is entered <br>  LOADER - the path to the plugin <br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">2. Debug</b> <div class="spoiler_text">  <s>Because</s>  <s>In the plugin, you cannot start step-by-step debugging in VS, I had to display debug messages at some stages.</s> <s><br></s>  <s>Since it‚Äôs inconvenient to use the editor of an auto-cadre for these purposes, I output messages using standard tools Debug.WriteMessage ()</s> <s><br></s>  <s>Debug will be displayed only when compiling in debug mode, the output data can be viewed by running the DebugView program.</s> <br><br>  UPDATE: Solved the problem of step by step debugging: <br>  He defeated this problem in this way: <br>  In the autocad configuration file, acad.exe.config installed the runtime on v4.0: <br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">startup</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">useLegacyV2RuntimeActivationPolicy</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">supportedRuntime</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"v4.0"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">startup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">runtime</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">generatePublisherEvidence</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">enabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">runtime</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Changed the execution environment of the plugin to 4.0 client profile <br>  And AssemblyInfo.cs assembly settings commented out the attribute AllowPartiallyTrustedCallers <br><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">3. Sending a command to the Editor</b> <div class="spoiler_text">  Some actions are not implemented in the Autocad .NET API, or they are much easier to do with the command line. <br>  The easiest way to execute a command is to execute a function, an example for ZoomExtents: <br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> doc = <span class="hljs-type"><span class="hljs-type">Application</span></span>.<span class="hljs-type"><span class="hljs-type">DocumentManager</span></span>.<span class="hljs-type"><span class="hljs-type">MdiActiveDocument</span></span>; doc.<span class="hljs-type"><span class="hljs-type">SendStringToExecute</span></span>(<span class="hljs-string"><span class="hljs-string">"_zoom _e "</span></span>,<span class="hljs-literal"><span class="hljs-literal">false</span></span>,<span class="hljs-literal"><span class="hljs-literal">false</span></span>,<span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre><br>  In autocade, the space is equivalent to Enter, so if you send a command without a trailing space, as a result, _e will be entered in the editor, and he will wait for further input <br><br>  However, this method is not always possible to use.  The principle of the SendStringToExecute command is such that the command is sent only after the function, called by the command, completes.  Therefore, if you first call this command, and then, for example, prompt the user to select an object in the figure, two lines "_zoom", "_e" will be sent to the selection function, which it will perceive as incorrect objects. <br>  We have to look for analogues that run immediately.  In this case: <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> acad = Application.AcadApplication; acad.GetType().InvokeMember("ZoomExtents", BindingFlags.DeclaredOnly | BindingFlags.<span class="hljs-built_in"><span class="hljs-built_in">Public</span></span> | BindingFlags.Instance | BindingFlags.InvokeMethod, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, acad, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>);</code> </pre><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">4. Selection of objects by the user</b> <div class="spoiler_text">  To select objects, use the functions of the editor'a Get * <br>  For example, the choice of several objects - GetSelection, the choice of one object GetEntity ... <br><pre> <code class="hljs mel">var <span class="hljs-keyword"><span class="hljs-keyword">editor</span></span> = Application.DocumentManager.MdiActiveDocument.Editor; var promtResult = <span class="hljs-keyword"><span class="hljs-keyword">editor</span></span>.GetEntity(<span class="hljs-string"><span class="hljs-string">" "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">editor</span></span>.WriteMessage(Environment.NewLine); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (promtResult.Status == PromptStatus.OK) { <span class="hljs-keyword"><span class="hljs-keyword">editor</span></span>.WriteMessage(<span class="hljs-string"><span class="hljs-string">"Selected Object's ID: "</span></span> + promtResult.ObjectId+Enviropment.NewLine); }</code> </pre><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Getting the path to the document folder</b> <div class="spoiler_text">  An Internet search gave two ways to access the full file name: <br>  MdiActiveDocument.Database.Filename <br>  MdiActiveDocument.Name <br>  At first glance, they are the same, but <br><blockquote>  On the topic - I do not recommend using the property Database.Filename.  After autosave, it points not to the file itself, but to the autosave copy - unlike Document.Name </blockquote><br>  I got the path to the folder using standard .NET tools: <br>  Path.GetDirectoryName (Application.DocumentManager.MdiActiveDocument.Name); <br>  if the returned string is empty, then the document is created but not saved <br></div></div><br><br><h3>  And more useful code snippets: </h3><br><div class="spoiler">  <b class="spoiler_title">Changing coordinates of a polyline (extension method)</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">//    ( ): <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">void</span></span> UpdatePoints(this Polyline polyline, List&lt;Point2d&gt; newPoints) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (polyline == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ArgumentNullException("polyline"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newPoints.Count &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ArgumentException("     "); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span> = Application.DocumentManager.MdiActiveDocument.<span class="hljs-keyword"><span class="hljs-keyword">Database</span></span>.TransactionManager.StartTransaction()) { //    ,      var pline = <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span>.GetObject(polyline.ObjectId,OpenMode.ForWrite) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Polyline; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pline == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> DataException("!     "); var bulge = pline.GetBulgeAt(<span class="hljs-number"><span class="hljs-number">0</span></span>); var start_width = pline.GetStartWidthAt(<span class="hljs-number"><span class="hljs-number">0</span></span>); var end_width = pline.GetEndWidthAt(<span class="hljs-number"><span class="hljs-number">0</span></span>); var prevPointsCount = pline.NumberOfVertices; //    //     ,    , .. Autocad      <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">1</span></span>  //    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i = prevPointsCount; i &lt; prevPointsCount + newPoints.Count; i++) pline.AddVertexAt(i, newPoints[i - prevPointsCount], bulge, start_width, end_width); //    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i = prevPointsCount - <span class="hljs-number"><span class="hljs-number">1</span></span>; i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; i<span class="hljs-comment"><span class="hljs-comment">--) pline.RemoveVertexAt(i); transaction.Commit(); } }</span></span></code> </pre><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Getting the coordinates of a polyline (extension method):</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">//    ( ): <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static Point2d[] GetPoints(this Polyline polyline) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (polyline == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.WriteLine(" !      "); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (polyline.NumberOfVertices == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; var points = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> List&lt;Point2d&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; polyline.NumberOfVertices; i++) points.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(polyline.GetPoint2dAt(i)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> points.ToArray(); }</code> </pre><br></div></div><br><h3>  useful links </h3><br>  1. <a href="http://docs.autodesk.com/ACD/2010/ENU/AutoCAD%2520.NET%2520Developer%2527s%2520Guide/index.html">AutoCAD .NET Developer's Guide</a> <br>  English mini-reference, describes the essence of the device Autocad with code examples on VB.NET, C # .NET, VBA <br>  2. <a href="http://through-the-interface.typepad.com/">Through the interface</a> <br>  Kean Walmsley's blog, a lot of Howto.  There are examples in C #, C # + COM, VB.NET, C ++.  It‚Äôs impossible to search me there, but half of my requests in Google ‚Äúhow to do this ..‚Äù led to this site <br>  3. <a href="http://www.caduser.ru/forum/index.php%3FPAGE_NAME%3Dlist%26FID%3D49">caduser.ru, subforum ".NET"</a> <br>  Communication with Russian-speaking people well versed in the subject.  Many times they helped me in difficult places. </div><p>Source: <a href="https://habr.com/ru/post/148844/">https://habr.com/ru/post/148844/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148839/index.html">Experimental Determination of Cache Memory Characteristics</a></li>
<li><a href="../148840/index.html">Font for registration number plates (license plates)</a></li>
<li><a href="../148841/index.html">Apache Maven - web application</a></li>
<li><a href="../148842/index.html">Simplify your life with Sublime Text 2</a></li>
<li><a href="../148843/index.html">Database Migration in Zend Framework: Akrabat_Db_Schema_Manager</a></li>
<li><a href="../148845/index.html">.NET is more valuable than .COM?</a></li>
<li><a href="../148846/index.html">Sieve method in the game "Bulls and Cows"</a></li>
<li><a href="../148847/index.html">Get structured data from PostgreSQL</a></li>
<li><a href="../148849/index.html">Summary of the problem of ‚Äútwo or more teachers‚Äù and a subjective opinion about the AI ‚Äã‚Äãcommunity</a></li>
<li><a href="../148850/index.html">Qt + OpenCV. New device GigE interface access to network cameras as CvCapture</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>