<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>20 Eloquent ORM tricks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Eloquent ORM seems simple, but under the hood there are many half-hidden functions and less well-known methods. In this article I will show you a few ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>20 Eloquent ORM tricks</h1><div class="post__text post__text-html js-mediator-article"><p>  Eloquent ORM seems simple, but under the hood there are many half-hidden functions and less well-known methods.  In this article I will show you a few tricks. </p><a name="habracut"></a><br><h3 id="1-inkrementaciya-i-dekrementaciya">  1. Increment and decrement </h3><br><p>  Instead of this: </p><br><pre><code class="hljs php">$article = Article::find($article_id); $article-&gt;read_count++; $article-&gt;save();</code> </pre> <br><p>  You can do this: </p><br><pre> <code class="hljs php">$article = Article::find($article_id); $article-&gt;increment(<span class="hljs-string"><span class="hljs-string">'read_count'</span></span>);</code> </pre> <br><p>  So it will also work: </p><br><pre> <code class="hljs ruby">Article::find($article_id)-&gt;increment(<span class="hljs-string"><span class="hljs-string">'read_count'</span></span>); Article::find($article_id)-&gt;increment(<span class="hljs-string"><span class="hljs-string">'read_count'</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> +<span class="hljs-number"><span class="hljs-number">10</span></span> Product::find($produce_id)-&gt;decrement(<span class="hljs-string"><span class="hljs-string">'stock'</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> -<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><hr><br><h3 id="2-x-ili-y-metody">  2. X or Y methods </h3><br><p>  Eloquent has several functions that combine two methods, for example ‚Äúplease make X, otherwise make Y‚Äù. </p><br><p>  <strong>Example 1</strong> - <code>findOrFail()</code> : </p><br><p>  Instead of this: </p><br><pre> <code class="hljs ruby">$user = User::find($id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$user) { abort (<span class="hljs-number"><span class="hljs-number">404</span></span>); }</code> </pre> <br><p>  We do it: </p><br><pre> <code class="hljs ruby">$user = User::findOrFail($id);</code> </pre> <br><p>  <strong>Example 2</strong> - <code>firstOrCreate()</code> : </p><br><p>  Instead of this: </p><br><pre> <code class="hljs php">$user = User::where(<span class="hljs-string"><span class="hljs-string">'email'</span></span>, $email)-&gt;first(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$user) { User::create([ <span class="hljs-string"><span class="hljs-string">'email'</span></span> =&gt; $email ]); }</code> </pre> <br><p>  We do it: </p><br><pre> <code class="hljs php">$user = User::firstOrCreate([<span class="hljs-string"><span class="hljs-string">'email'</span></span> =&gt; $email]);</code> </pre> <br><hr><br><h3 id="3-metod-boot-modeli">  3. The boot () method of the model </h3><br><p>  The Eloquent model has a magic <code>boot()</code> method, where you can override the default behavior: </p><br><pre> <code class="hljs php"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">boot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::boot(); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::updating(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($model)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  -  //  - ,  $model-&gt;something = transform($something); }); } }</span></span></code> </pre> <br><p>  Probably one of the most popular examples is setting a field value at the time the model object is created.  Suppose you want to generate a <a href="https://github.com/webpatser/laravel-uuid">UUID</a> field at this moment. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">static</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">function</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">boot</span></span>() { <span class="hljs-attribute"><span class="hljs-attribute">parent</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">boot</span></span>(); <span class="hljs-attribute"><span class="hljs-attribute">self</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">creating</span></span>(function ($model) { $model-&gt;uuid = (string)Uuid::<span class="hljs-built_in"><span class="hljs-built_in">generate</span></span>(); }); }</code> </pre> <br><hr><br><h3 id="4-otnosheniya-s-usloviem-i-sortirovkoy">  4. Relationship with condition and sorting </h3><br><p>  This is the typical way to define relationships: </p><br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">users</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;hasMany(<span class="hljs-string"><span class="hljs-string">'App\User'</span></span>); }</code> </pre> <br><p>  But did you know that we can add <code>where</code> or <code>orderBy</code> ? <br>  For example, if you need a special relationship for certain types of users, organized by email, you can do this: </p><br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">approvedUsers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;hasMany(<span class="hljs-string"><span class="hljs-string">'App\User'</span></span>)-&gt;where(<span class="hljs-string"><span class="hljs-string">'approved'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)-&gt;orderBy(<span class="hljs-string"><span class="hljs-string">'email'</span></span>); }</code> </pre> <br><hr><br><h3 id="5-svoystva-modeli-timestamps-appends-i-td">  5. Model properties: timestamps, appends, and so on. </h3><br><p>  There are several ‚Äúparameters‚Äù of the Eloquent model in the form of class properties.  The most popular ones are probably the following: </p><br><pre> <code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $table = <span class="hljs-symbol"><span class="hljs-symbol">'user</span></span>s'; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $fillable = [<span class="hljs-symbol"><span class="hljs-symbol">'emai</span></span>l', <span class="hljs-symbol"><span class="hljs-symbol">'passwor</span></span>d']; <span class="hljs-comment"><span class="hljs-comment">//       User::create() protected $dates = ['created_at', 'deleted_at']; //     Carbon protected $appends = ['field1', 'field2']; //     JSON }</span></span></code> </pre> <br><p>  But wait, there is more: </p><br><pre> <code class="hljs ruby">protected $primaryKey = <span class="hljs-string"><span class="hljs-string">'uuid'</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    <span class="hljs-string"><span class="hljs-string">"id"</span></span> public $incrementing = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      protected $perPage = <span class="hljs-number"><span class="hljs-number">25</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ,       (  <span class="hljs-number"><span class="hljs-number">15</span></span>) const CREATED_AT = <span class="hljs-string"><span class="hljs-string">'created_at'</span></span>; const UPDATED_AT = <span class="hljs-string"><span class="hljs-string">'updated_at'</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ,        public $timestamps = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    </code> </pre> <br><p>  And there are even more, I listed the most interesting of them, for more information, read the default code of the <a href="https://github.com/laravel/framework/blob/5.6/src/Illuminate/Database/Eloquent/Model.php">abstract Model class</a> and see all the used traits. </p><br><hr><br><h3 id="6-poisk-neskolkih-zapisey">  6. Search multiple entries </h3><br><p>  Everyone knows the <code>find ()</code> method, right? </p><br><pre> <code class="hljs ruby">$user = User::find(<span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br><p>  I was surprised how few people know that it can accept multiple IDs as an array: </p><br><pre> <code class="hljs ruby">$users = User::find([<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>]);</code> </pre> <br><hr><br><h3 id="7-wherex">  7. WhereX </h3><br><p>  There is an elegant way to transform this: </p><br><pre> <code class="hljs php">$users = User::where(<span class="hljs-string"><span class="hljs-string">'approved'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)-&gt;get();</code> </pre> <br><p>  In it: </p><br><pre> <code class="hljs php">$users = User::whereApproved(<span class="hljs-number"><span class="hljs-number">1</span></span>)-&gt;get();</code> </pre> <br><p>  Yes, you can change the name of any field and add it as a suffix to the ‚Äúwhere‚Äù, and it will work like magic. <br>  Also in the Eloquent ORM there are predefined methods related to the date and time: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">User</span></span>::whereDate(<span class="hljs-string"><span class="hljs-string">'created_at'</span></span>, <span class="hljs-type"><span class="hljs-type">date</span></span>(<span class="hljs-string"><span class="hljs-string">'Ym-d'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>::whereDay(<span class="hljs-string"><span class="hljs-string">'created_at'</span></span>, <span class="hljs-type"><span class="hljs-type">date</span></span>(<span class="hljs-string"><span class="hljs-string">'d'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>::whereMonth(<span class="hljs-string"><span class="hljs-string">'created_at'</span></span>, <span class="hljs-type"><span class="hljs-type">date</span></span>(<span class="hljs-string"><span class="hljs-string">'m'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>::whereYear(<span class="hljs-string"><span class="hljs-string">'created_at'</span></span>, <span class="hljs-type"><span class="hljs-type">date</span></span>(<span class="hljs-string"><span class="hljs-string">'Y'</span></span>));</code> </pre> <br><hr><br><h3 id="8-sortirovka-s-otnosheniyami">  8. Sorting with relationships </h3><br><p>  A little more than a "trick."  What if you have forum threads, but you want to sort them, by their latest <strong>posts</strong> ?  Quite a popular requirement in the forums with the latest updated topics at the top, right? </p><br><p>  First describe a separate link for the <strong>last post</strong> in the topic: </p><br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">latestPost</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;hasOne(\App\Post::class)-&gt;latest(); }</code> </pre> <br><p>  And then, in your controller, you can perform this "magic": </p><br><pre> <code class="hljs php">$users = Topic::with(<span class="hljs-string"><span class="hljs-string">'latestPost'</span></span>)-&gt;get()-&gt;sortByDesc(<span class="hljs-string"><span class="hljs-string">'latestPost.created_at'</span></span>);</code> </pre> <br><hr><br><h3 id="9-eloquentwhen--bez-if-else">  9. Eloquent :: when () - without ‚Äúif-else‚Äù </h3><br><p>  Many of us write conditional requests with "if-else", something like this: </p><br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request(<span class="hljs-string"><span class="hljs-string">'filter_by'</span></span>) == <span class="hljs-string"><span class="hljs-string">'likes'</span></span>) { $query-&gt;where(<span class="hljs-string"><span class="hljs-string">'likes'</span></span>, <span class="hljs-string"><span class="hljs-string">'&gt;'</span></span>, request(<span class="hljs-string"><span class="hljs-string">'likes_amount'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request(<span class="hljs-string"><span class="hljs-string">'filter_by'</span></span>) == <span class="hljs-string"><span class="hljs-string">'date'</span></span>) { $query-&gt;orderBy(<span class="hljs-string"><span class="hljs-string">'created_at'</span></span>, request(<span class="hljs-string"><span class="hljs-string">'ordering_rule'</span></span>, <span class="hljs-string"><span class="hljs-string">'desc'</span></span>)); }</code> </pre> <br><p>  But the best way is to use <code>when()</code> : </p><br><pre> <code class="hljs php">$query = Author::query(); $query-&gt;when(request(<span class="hljs-string"><span class="hljs-string">'filter_by'</span></span>) == <span class="hljs-string"><span class="hljs-string">'likes'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($q)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $q-&gt;where(<span class="hljs-string"><span class="hljs-string">'likes'</span></span>, <span class="hljs-string"><span class="hljs-string">'&gt;'</span></span>, request(<span class="hljs-string"><span class="hljs-string">'likes_amount'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)); }); $query-&gt;when(request(<span class="hljs-string"><span class="hljs-string">'filter_by'</span></span>) == <span class="hljs-string"><span class="hljs-string">'date'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($q)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $q-&gt;orderBy(<span class="hljs-string"><span class="hljs-string">'created_at'</span></span>, request(<span class="hljs-string"><span class="hljs-string">'ordering_rule'</span></span>, <span class="hljs-string"><span class="hljs-string">'desc'</span></span>)); });</code> </pre> <br><p>  This example may not seem shorter or more elegant, but it would be more correct to forward parameters: </p><br><pre> <code class="hljs php">$query = User::query(); $query-&gt;when(request(<span class="hljs-string"><span class="hljs-string">'role'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>), <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($q, $role)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $q-&gt;where(<span class="hljs-string"><span class="hljs-string">'role_id'</span></span>, $role); }); $authors = $query-&gt;get();</code> </pre> <br><hr><br><h3 id="10-model-po-umolchaniyu-dlya-otnosheniy">  10. Default model for relationships </h3><br><p>  Suppose you have a post belonging to the author, and the Blade code: </p><br><pre> <code class="hljs php">{{ $post-&gt;author-&gt;name }}</code> </pre> <br><p>  But what if the author is removed or not installed for any reason?  You will get an error like "property of non-object". </p><br><p>  Of course, you can prevent this by doing the following: </p><br><pre> <code class="hljs php">{{ $post-&gt;author-&gt;name ?? <span class="hljs-string"><span class="hljs-string">''</span></span> }}</code> </pre> <br><p>  But you can do it at the level of an eloquent relationship: </p><br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">author</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;belongsTo(<span class="hljs-string"><span class="hljs-string">'App\Author'</span></span>)-&gt;withDefault(); }</code> </pre> <br><p>  In this example, the relationship <code>author()</code> returns an empty <code>App\Author</code> model, if the author is not attached to the post. </p><br><p>  In addition, we can assign default property values ‚Äã‚Äãfor this model. </p><br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">author</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;belongsTo(<span class="hljs-string"><span class="hljs-string">'App\Author'</span></span>)-&gt;withDefault([ <span class="hljs-string"><span class="hljs-string">'name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Guest Author'</span></span> ]); }</code> </pre> <br><hr><br><h3 id="11-sortirovka-po-preobrazovatelyu">  11. Sort by converter </h3><br><p>  Imagine that you have such a converter: </p><br><pre> <code class="hljs php"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFullNameAttribute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;attributes[<span class="hljs-string"><span class="hljs-string">'first_name'</span></span>] . <span class="hljs-string"><span class="hljs-string">' '</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;attributes[<span class="hljs-string"><span class="hljs-string">'last_name'</span></span>]; }</code> </pre> <br><p>  Do you need to sort entries by the <code>full_name</code> field?  This solution will not work: </p><br><pre> <code class="hljs php">$clients = Client::orderBy(<span class="hljs-string"><span class="hljs-string">'full_name'</span></span>)-&gt;get(); <span class="hljs-comment"><span class="hljs-comment">//  </span></span></code> </pre> <br><p>  The solution is quite simple.  We need to sort the records <strong>after</strong> we receive them. </p><br><pre> <code class="hljs php">$clients = Client::get()-&gt;sortBy(<span class="hljs-string"><span class="hljs-string">'full_name'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// !</span></span></code> </pre> <br><p>  Please note that the function name is different - this is not <strong>orderBy</strong> , this is <strong>sortBy</strong> . </p><br><hr><br><h3 id="12-sortirovka-po-umolchaniyu">  12. Sort by default </h3><br><p>  What if you want <code>User::all()</code> always be sorted by the <code>name</code> field?  You can assign a global stub (Global Scope).  Let us return to the <code>boot ()</code> method, which we have already mentioned above. </p><br><pre> <code class="hljs lua">protected static <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">boot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { parent::boot(); //    name    static::addGlobalScope(<span class="hljs-string"><span class="hljs-string">'order'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Builder $builder)</span></span></span></span> { $builder-&gt;orderBy(<span class="hljs-string"><span class="hljs-string">'name'</span></span>, <span class="hljs-string"><span class="hljs-string">'asc'</span></span>); }); }</code> </pre> <br><hr><br><h3 id="13-syrye-vyrazheniya">  13. Raw expressions </h3><br><p>  Sometimes we need to add raw expressions to our Eloquent request. <br>  Fortunately, there are functions for this. </p><br><pre> <code class="hljs erlang-repl">// whereRaw $orders = DB::table(<span class="hljs-string"><span class="hljs-string">'orders'</span></span>) -&gt;whereRaw(<span class="hljs-string"><span class="hljs-string">'price &gt; IF(state = "TX", ?, 100)'</span></span>, [<span class="hljs-number"><span class="hljs-number">200</span></span>]) -&gt;get(); // havingRaw Product::groupBy(<span class="hljs-string"><span class="hljs-string">'category_id'</span></span>)-&gt;havingRaw(<span class="hljs-string"><span class="hljs-string">'COUNT(*) &gt; 1'</span></span>)-&gt;get(); // orderByRaw User::where(<span class="hljs-string"><span class="hljs-string">'created_at'</span></span>, <span class="hljs-string"><span class="hljs-string">'&gt;'</span></span>, <span class="hljs-string"><span class="hljs-string">'2016-01-01'</span></span>) -&gt;orderByRaw(<span class="hljs-string"><span class="hljs-string">'(updated_at - created_at) desc'</span></span>) -&gt;get();</code> </pre> <br><hr><br><h3 id="14-replikaciya-sdelat-kopiyu-zapisi">  14. Replication: make a copy of the record </h3><br><p>  Without a deep explanation, here is the best way to make a copy of the record in the database: </p><br><pre> <code class="hljs php">$task = Tasks::find(<span class="hljs-number"><span class="hljs-number">1</span></span>); $newTask = $task-&gt;replicate(); $newTask-&gt;save();</code> </pre> <br><hr><br><h3 id="15-chunk-metod-dlya-bolshih-tablic">  15. Chunk () method for large tables </h3><br><p>  Not really about Eloquent, it's more about collections, but still a powerful method ‚Äî to handle large data sets.  You can break them into pieces. </p><br><p>  Instead of this: </p><br><pre> <code class="hljs php">$users = User::all(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($users <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $user) { <span class="hljs-comment"><span class="hljs-comment">// ...</span></span></code> </pre> <br><p>  You can do it: </p><br><pre> <code class="hljs php">User::chunk(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($users)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($users <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $user) { <span class="hljs-comment"><span class="hljs-comment">// ... } });</span></span></code> </pre> <br><hr><br><h3 id="16-sozdanie-dopolnitelnyh-faylov-pri-sozdanii-modeli">  16. Creating additional files when creating a model </h3><br><p>  We all know the Artisan team: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">php</span></span> artisan make:model Company</code> </pre> <br><p>  But did you know that there are three useful flags for creating additional model files? </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">php</span></span> artisan make:model Company -mcr</code> </pre> <br><ul><li>  -m will create a migration file </li><li>  -c will create a controller ( <strong>controller</strong> ) </li><li><p>  -r indicates that the controller must be a resource ( <strong>resourceful</strong> ) </p><br></li><li><ul><li>  * </li></ul><br></li></ul><br><h3 id="17-perezapis-updated_at-vo-vremya-sohraneniya">  17. Overwriting updated_at during save </h3><br><p>  Did you know that the method <code>-&gt;save()</code> can take parameters?  As a result, we can ‚Äúignore‚Äù the <code>updated_at</code> functionality, which by default should have set the current timestamp. </p><br><p>  Look at the following example: </p><br><pre> <code class="hljs php">$product = Product::find($id); $product-&gt;updated_at = <span class="hljs-string"><span class="hljs-string">'2019-01-01 10:00:00'</span></span>; $product-&gt;save([<span class="hljs-string"><span class="hljs-string">'timestamps'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>]);</code> </pre> <br><p>  Here we rewrote <code>updated_at</code> our preset value. </p><br><hr><br><h3 id="18-chto-yavlyaetsya-rezultatom-metoda-update">  18. What is the result of the update () method? </h3><br><p>  Have you ever thought about what this code returns? </p><br><pre> <code class="hljs php">$result = $products-&gt;whereNull(<span class="hljs-string"><span class="hljs-string">'category_id'</span></span>)-&gt;update([<span class="hljs-string"><span class="hljs-string">'category_id'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>]);</code> </pre> <br><p>  I mean that the update is running in the database, but what will this <code>$result</code> contain? </p><br><p>  Answer: <strong>affected lines</strong> .  Therefore, if you need to check how many rows have been affected, you do not need to call anything - the <code>update()</code> method will return this number for you. </p><br><hr><br><h3 id="19-preobrazuem-skobki-v-eloquent-zapros">  19. Convert brackets to Eloquent request. </h3><br><p>  What to do if you have AND and OR in your SQL query, like this: </p><br><pre> <code class="hljs python"><span class="hljs-meta"><span class="hljs-meta">... </span></span>WHERE (gender = <span class="hljs-string"><span class="hljs-string">'Male'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> age &gt;= <span class="hljs-number"><span class="hljs-number">18</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (gender = <span class="hljs-string"><span class="hljs-string">'Female'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> age &gt;= <span class="hljs-number"><span class="hljs-number">65</span></span>)</code> </pre> <br><p>  How to convert this query to an eloquent query?  This is the <strong>wrong</strong> way: </p><br><pre> <code class="hljs php">$q-&gt;where(<span class="hljs-string"><span class="hljs-string">'gender'</span></span>, <span class="hljs-string"><span class="hljs-string">'Male'</span></span>); $q-&gt;orWhere(<span class="hljs-string"><span class="hljs-string">'age'</span></span>, <span class="hljs-string"><span class="hljs-string">'&gt;='</span></span>, <span class="hljs-number"><span class="hljs-number">18</span></span>); $q-&gt;where(<span class="hljs-string"><span class="hljs-string">'gender'</span></span>, <span class="hljs-string"><span class="hljs-string">'Female'</span></span>); $q-&gt;orWhere(<span class="hljs-string"><span class="hljs-string">'age'</span></span>, <span class="hljs-string"><span class="hljs-string">'&gt;='</span></span>, <span class="hljs-number"><span class="hljs-number">65</span></span>);</code> </pre> <br><p>  The order will be wrong.  The correct way is a little more complicated, using closures as subqueries: </p><br><pre> <code class="hljs php">$q-&gt;where(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($query)</span></span></span><span class="hljs-function"> </span></span>{ $query-&gt;where(<span class="hljs-string"><span class="hljs-string">'gender'</span></span>, <span class="hljs-string"><span class="hljs-string">'Male'</span></span>) -&gt;where(<span class="hljs-string"><span class="hljs-string">'age'</span></span>, <span class="hljs-string"><span class="hljs-string">'&gt;='</span></span>, <span class="hljs-number"><span class="hljs-number">18</span></span>); })-&gt;orWhere(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($query)</span></span></span><span class="hljs-function"> </span></span>{ $query-&gt;where(<span class="hljs-string"><span class="hljs-string">'gender'</span></span>, <span class="hljs-string"><span class="hljs-string">'Female'</span></span>) -&gt;where(<span class="hljs-string"><span class="hljs-string">'age'</span></span>, <span class="hljs-string"><span class="hljs-string">'&gt;='</span></span>, <span class="hljs-number"><span class="hljs-number">65</span></span>); })</code> </pre> <br><hr><br><h3 id="20-orwhere-s-neskolkimi-parametrami">  20. orWhere with several parameters </h3><br><p>  You can pass an array of parameters in <code>orWhere()</code> . <br>  ‚ÄúNormal‚Äù method: </p><br><pre> <code class="hljs php">$q-&gt;where(<span class="hljs-string"><span class="hljs-string">'a'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); $q-&gt;orWhere(<span class="hljs-string"><span class="hljs-string">'b'</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); $q-&gt;orWhere(<span class="hljs-string"><span class="hljs-string">'c'</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>);</code> </pre> <br><p>  You can do it like this: </p><br><pre> <code class="hljs php">$q-&gt;where(<span class="hljs-string"><span class="hljs-string">'a'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); $q-&gt;orWhere([<span class="hljs-string"><span class="hljs-string">'b'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'c'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">3</span></span>]);</code> </pre> <br><hr></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/354036/">https://habr.com/ru/post/354036/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354026/index.html">Review of OpenDay JetBrains mitap</a></li>
<li><a href="../354028/index.html">Understand Implicits in Scala</a></li>
<li><a href="../354030/index.html">Mobile application in Python with kivy / buildozer. Lecture in Yandex</a></li>
<li><a href="../354032/index.html">Fuzzy search in relational databases</a></li>
<li><a href="../354034/index.html">Reindexer site search is easy. Or how to make an "instant search" throughout the Habrahabr</a></li>
<li><a href="../354038/index.html">Top VSCode Extensions That Speed ‚Äã‚ÄãUp Your JavaScript Development</a></li>
<li><a href="../354040/index.html">We apply the Deep Watershed Transform in the Kaggle Data Science Bowl 2018 competition.</a></li>
<li><a href="../354044/index.html">Next generation video: introducing AV1</a></li>
<li><a href="../354046/index.html">Inheritance, composition, aggregation</a></li>
<li><a href="../354048/index.html">Atlassian Jira Software functionality in Jira plugin</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>