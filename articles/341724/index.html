<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Self-testing system with alerts on Laravel + Bitbucket + HipChat</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will tell you how you can quickly set up an automatic tightening of the new code on the test server of your laravel application, aut...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Self-testing system with alerts on Laravel + Bitbucket + HipChat</h1><div class="post__text post__text-html js-mediator-article">  In this article I will tell you how you can quickly set up an automatic tightening of the new code on the test server of your laravel application, autostart of tests and notification of the result in the corresponding corporate chat.  And also catching new bugs in laravel.log <br><a name="habracut"></a><br>  Hi, my name is Dmitry Korets, and I am a PHP developer in a small grocery company. <br>  We use Bitbucket as the hosting code, the team communicates via HipChat, so it will work with them. <br><br>  As we know, one of the basic requirements for the implementation of continuous integration is the self-testing system.  And when the application is not too large, it is not developed by several independent teams, setting up different Bamboo and Jenkins seems rather expensive. <br><br>  <b>So what do we want?</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When pushing to the repository, the following should occur: <br><br><ul><li>  Alert in HipChat room about changes in the code </li><li>  New commit pulled on server </li><li>  Running tests on the server </li><li>  If successful, send a success message, in case of errors, a short stacktrace </li></ul><br>  <b>Moreover:</b> <br><br><ul><li>  Catching errors in laravel.log followed by notification to the corporate chat </li><li>  Commit string parsing for additional server manipulations </li><li>  Analysis of the branch to which the commit was made </li></ul><br>  <b>Let's start!</b> <br><br>  In the beatback, as in the githaba, there are so-called webhooks (webhooks).  This implies sending an HTTP request with certain data in JSON format to the URL you specified for certain changes in the repository. <br><br>  Go to Settings -&gt; Webhooks -&gt; Add Webhook <br><br><img src="https://habrastorage.org/webt/ad/7x/p4/ad7xp4drvtomjiplt-avhybqzv0.png" alt="image"><br><br>  As you can see, the list is quite large.  For now, we are only interested in Push (when the branches merge, the push event will also work), we specify the url we need, save - ready! <br><br>  Now, when pushing to the repository, the above request will be sent.  Even if we have not yet configured the necessary routes in our application, we can see everything from the beatback itself: Settings -&gt; Webhooks -&gt; View requests in front of the hook we created. <br><br><img src="https://habrastorage.org/webt/hg/ub/_v/hgub_vuoohsu7fhxidc6hrettl0.png"><br><br>  Let's go into View details and see, in fact, the object itself that was sent, the response from our server, the status code, the response time, and more. <br><br><h4>  Adding HipChat Room Integration </h4><br>  Hippat has built-in bitbeat integration.  But all that is available there is the connection of notifications about changes in the repository.  I was faced with the task of receiving notifications only when a specific branch was updated, since in my company the core of the product is constantly being updated, in parallel with this, new projects are released on the already existing core. <br><br>  Therefore, at the development stage we have the following structure of branches in the repository with the kernel (conditionally): <br><br><ul><li>  staging </li><li>  master </li><li>  master_project1 </li><li>  master_project1 </li></ul> <br>  The room itself, I think, you know how to create it, then go into it and click Add integration -&gt; Build your own integration, create a name, and chat messages will come on behalf of this integration.  We confirm.  On the next page we get the most important thing - the URL with the token and immediately an example of the curl command for the test. <br><br> <code>curl -d '{"color":"green","message":"My first notification (yey)","notify":false,"message_format":"text"}' -H 'Content-Type: application/json' https://youcompany.hipchat.com/v2/room/{roomId}/notification?auth_token={token}</code> <br> <br><h4>  The hook is configured, the HipChat room is created, we write the logic </h4><br>  Create a route: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> Route::group([<span class="hljs-string"><span class="hljs-string">'prefix'</span></span> =&gt; LaravelLocalization::setLocale()], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Route::group( [ <span class="hljs-string"><span class="hljs-string">'prefix'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'development'</span></span>, ], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Route::group([<span class="hljs-string"><span class="hljs-string">'prefix'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'bitbucket'</span></span>, <span class="hljs-string"><span class="hljs-string">'namespace'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'\BE\Dev\Backend\Http\Controllers'</span></span>], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Route::post(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'as'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'bitbucket.push_event'</span></span>, <span class="hljs-string"><span class="hljs-string">'uses'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'BitbucketEventsController@pushEvent'</span></span> ]); }); } ); } );</code> </pre><br>  Controller: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">BE</span></span>\<span class="hljs-title"><span class="hljs-title">Dev</span></span>\<span class="hljs-title"><span class="hljs-title">Backend</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Controllers</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Controllers</span></span>\<span class="hljs-title"><span class="hljs-title">Controller</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">BE</span></span>\<span class="hljs-title"><span class="hljs-title">Dev</span></span>\<span class="hljs-title"><span class="hljs-title">Services</span></span>\<span class="hljs-title"><span class="hljs-title">Bitbucket</span></span>\<span class="hljs-title"><span class="hljs-title">BitbucketPushEventService</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">BE</span></span>\<span class="hljs-title"><span class="hljs-title">Dev</span></span>\<span class="hljs-title"><span class="hljs-title">Services</span></span>\<span class="hljs-title"><span class="hljs-title">HipChat</span></span>\<span class="hljs-title"><span class="hljs-title">HipChatService</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Request</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BitbucketEventsController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">BE</span></span>\<span class="hljs-title"><span class="hljs-title">Dev</span></span>\<span class="hljs-title"><span class="hljs-title">Backend</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Controllers</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Controllers</span></span>\<span class="hljs-title"><span class="hljs-title">Controller</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">BE</span></span>\<span class="hljs-title"><span class="hljs-title">Dev</span></span>\<span class="hljs-title"><span class="hljs-title">Services</span></span>\<span class="hljs-title"><span class="hljs-title">Bitbucket</span></span>\<span class="hljs-title"><span class="hljs-title">BitbucketPushEventService</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">BE</span></span>\<span class="hljs-title"><span class="hljs-title">Dev</span></span>\<span class="hljs-title"><span class="hljs-title">Services</span></span>\<span class="hljs-title"><span class="hljs-title">HipChat</span></span>\<span class="hljs-title"><span class="hljs-title">HipChatService</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Request</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BitbucketEventsController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> $hipchatService HipChatService */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $hipchatService; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> $pushService BitbucketPushEventService */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $pushService; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $config; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Request $request)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config = config(<span class="hljs-string"><span class="hljs-string">'be_dev'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;hipchatService = app(HipChatService::class); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;pushService = app(BitbucketPushEventService::class, [$request-&gt;all()]); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pushEvent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Request $request)</span></span></span><span class="hljs-function"> </span></span>{ $data = $request-&gt;all(); <span class="hljs-comment"><span class="hljs-comment">//      staging -    if ($this-&gt;pushService-&gt;getBranch() != 'staging') { return false; } //   $comment = strtolower($data['push']['changes'][0]['commits'][0]['message']); //    $author = $data['actor']['display_name']; $data = [ 'color' =&gt; 'green', 'message' =&gt; "&lt;strong&gt;{$author}&lt;/strong&gt;      BE   \"{$comment}\"", 'notify' =&gt; true, 'message_format' =&gt; 'html', ]; //   $this-&gt;hipchatService-&gt;sendNotification($data); //      no tests -    if (strpos($comment, 'no tests')) { return response()-&gt;json([ 'success' =&gt; true, 'message' =&gt; 'tests was not executed' ])-&gt;setStatusCode(200); } // git pull +   +    $service = new \BE\Dev\Services\RuntTestsInQueueAndNotifyHipChatRoom(); $service-&gt;handle(); return response()-&gt;json([ 'success' =&gt; true ])-&gt;setStatusCode(200); } }</span></span></code> </pre><br>  Let's see.  Here I immediately scattered the service code a bit, so as not to put a lot of logic in the controller.  The main part of the action is written in RuntTestsInQueueAndNotifyHipChatRoom. <br><br>  Content RuntTestsInQueueAndNotifyHipChatRoom: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">BE</span></span>\<span class="hljs-title"><span class="hljs-title">Dev</span></span>\<span class="hljs-title"><span class="hljs-title">Services</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">BE</span></span>\<span class="hljs-title"><span class="hljs-title">Dev</span></span>\<span class="hljs-title"><span class="hljs-title">Services</span></span>\<span class="hljs-title"><span class="hljs-title">HipChat</span></span>\<span class="hljs-title"><span class="hljs-title">HipChatService</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Bus</span></span>\<span class="hljs-title"><span class="hljs-title">Queueable</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">BE</span></span>\<span class="hljs-title"><span class="hljs-title">Jobs</span></span>\<span class="hljs-title"><span class="hljs-title">Job</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Queue</span></span>\<span class="hljs-title"><span class="hljs-title">SerializesModels</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Contracts</span></span>\<span class="hljs-title"><span class="hljs-title">Queue</span></span>\<span class="hljs-title"><span class="hljs-title">ShouldQueue</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RuntTestsInQueueAndNotifyHipChatRoom</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Job</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ShouldQueue</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Queueable</span></span>, <span class="hljs-title"><span class="hljs-title">SerializesModels</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> $deployService DeployService */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $deployService; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> $tests RunTests */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $tests; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> $hipchatService HipChatService */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $hipchatService; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;deployService = app(DeployService::class); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;tests = app(RunTests::class); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;tests = app(HipChatService::class); } <span class="hljs-comment"><span class="hljs-comment">/** * Execute the job. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// git pull   $this-&gt;deployService-&gt;pullPackagesChanges(); //   $outputTests = $this-&gt;tests-&gt;run(); if ($outputTests === true) { $outputTests = '  '; $colorTests = 'green'; } else { $colorTests = 'red'; } //           $this-&gt;hipchatService-&gt;sendNotification([ 'color' =&gt; $colorTests, 'message' =&gt; $outputTests, 'notify' =&gt; true, 'message_format' =&gt; 'html', ]); } catch (\Exception $exception) { \Log::error($exception-&gt;getMessage()); } } }</span></span></code> </pre><br>  How are we going to run the commands on the server in the command line?  Laravel uses the Symfony Process component ( <a href="https://symfony.com/doc/current/components/process.html">documentation</a> ).  The important point is, on behalf of which user commands will be run, keep this in mind! <br><br>  Further the code with comments of our services. <br><br>  Shrinking changes from the beatback: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">BE</span></span>\<span class="hljs-title"><span class="hljs-title">Dev</span></span>\<span class="hljs-title"><span class="hljs-title">Services</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Process</span></span>\<span class="hljs-title"><span class="hljs-title">Exception</span></span>\<span class="hljs-title"><span class="hljs-title">ProcessFailedException</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Process</span></span>\<span class="hljs-title"><span class="hljs-title">Process</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DeployService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pullPackagesChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// cd ../ ,     index.php    public, //        $process = new Process('cd ../ &amp;&amp; git pull'); $process-&gt;run(); // executes after the command finishes if (!$process-&gt;isSuccessful()) { throw new ProcessFailedException($process); } return $process-&gt;getOutput(); } }</span></span></code> </pre><br>  Run the tests: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">BE</span></span>\<span class="hljs-title"><span class="hljs-title">Dev</span></span>\<span class="hljs-title"><span class="hljs-title">Services</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Process</span></span>\<span class="hljs-title"><span class="hljs-title">Exception</span></span>\<span class="hljs-title"><span class="hljs-title">ProcessFailedException</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Process</span></span>\<span class="hljs-title"><span class="hljs-title">Process</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RunTests</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $process = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Process(<span class="hljs-string"><span class="hljs-string">'cd ../ &amp;&amp; vendor/bin/phpunit --tap'</span></span>); $process-&gt;run(); <span class="hljs-comment"><span class="hljs-comment">// executes after the command finishes if (!$process-&gt;isSuccessful()) { return $process-&gt;getIncrementalOutput(); } return true; } }</span></span></code> </pre><br>  Sending notifications is done using a regular curl request, using json_encode () on the data array <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">BE</span></span>\<span class="hljs-title"><span class="hljs-title">Dev</span></span>\<span class="hljs-title"><span class="hljs-title">Services</span></span>\<span class="hljs-title"><span class="hljs-title">HipChat</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HipChatService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> $config array Service config */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $config; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config = config(<span class="hljs-string"><span class="hljs-string">'be_dev.hipchat'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendNotification</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// create curl resource $ch = curl_init(); // set url curl_setopt($ch, CURLOPT_URL, $this-&gt;config['url']); curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']); //return the transfer as a string curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data)); // $output contains the output string $output = curl_exec($ch); // close curl resource to free up system resources curl_close($ch); return $output; } }</span></span></code> </pre><br>  An example of what should get: <br><br><img src="https://habrastorage.org/webt/5t/eu/ol/5teuol5v5ehukw766c-qcdnwhmc.png"><br><br>  And finally, add another event. <br><br><pre> <code class="php hljs">Log::getMonoLog()-&gt;pushHandler(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \Monolog\Handler\HipChatHandler( <span class="hljs-string"><span class="hljs-string">'AUTH_TOKEN'</span></span>, <span class="hljs-string"><span class="hljs-string">'ROOM_ID'</span></span>, <span class="hljs-string"><span class="hljs-string">'hipchat-app'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, \Monolog\Logger::CRITICAL, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-string"><span class="hljs-string">'text'</span></span>, <span class="hljs-string"><span class="hljs-string">'COMPANY_NAME'</span></span>.hipchat.com, <span class="hljs-string"><span class="hljs-string">'v2'</span></span> ));</code> </pre><br>  Now, each time a CRITICAL message is added to laravel.log, we will send a message to our room.  This code must be placed in one of your service providers.  Let me remind you that there are such types of messages in the logs: <br><br><ol><li>  debug </li><li>  info </li><li>  notice </li><li>  warning </li><li>  error </li><li>  critical </li><li>  alert </li><li>  emergency </li></ol><br><h4>  Conclusion </h4><br>  I have it all.  Please forgive me for the possible poorly structured information, my first post.  The code is available <a href="https://bitbucket.org/koretsweb/laravelatlassian-integration">here</a> .  In the form of a separate composer package did not make out, laziness took over me.  Also, you can add additional logic.  For example, if you actively use Atlassian products, in addition to the beats and hippats, there is also a gir, then you can add the ability to automatically close a task in dir and translate it for review to testers if the commit text contains a task code in dir.  Or, if a git pull project is not enough for a project, you need to publish configs, rebuild the database, fill it with initial data, etc., then you can write a bash script for the project deployment and run it on the server if the commit text contains a certain substring. <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/341724/">https://habr.com/ru/post/341724/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341714/index.html">Resource planning. Parts 2 and 3. What depends on the resource plan. What determines the resource plan</a></li>
<li><a href="../341716/index.html">People monitoring ESP8266 MQTT Micropython</a></li>
<li><a href="../341718/index.html">Prediction of connections in social networks: use transition points</a></li>
<li><a href="../341720/index.html">What we will tell on Highload ++ 2017</a></li>
<li><a href="../341722/index.html">Tabs or spaces: solve with Visual Studio</a></li>
<li><a href="../341726/index.html">Bitrix24 - CRM or not only?</a></li>
<li><a href="../341728/index.html">ScadaPy - using OPC UA</a></li>
<li><a href="../341730/index.html">Simulation of the planet daisies</a></li>
<li><a href="../341732/index.html">ICO: HYIP will go, and we will stay, or time against tokens</a></li>
<li><a href="../341736/index.html">Overview of the new high-performance RDP codec</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>