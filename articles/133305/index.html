<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The State Duma launched an open API to search for bills</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is the second of a series of articles on innovations on the website of the State Duma ( Article 1 ). 

 At the moment, the concept of ope...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The State Duma launched an open API to search for bills</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/b06326c0/4cabfd4d/6a6e18e3/5136283f.png" align="left">  This article is the second of a series of articles on innovations on the website of the State Duma ( <a href="http://habrahabr.ru/blogs/e_gov/130238/">Article 1</a> ). <br><br>  At the moment, the concept of <b>open government</b> is gaining popularity.  For example, <a href="http://www.data.gov/">data.gov</a> publishes large amounts of US government data, and similar UK material is published on <a href="http://data.gov.uk/">data.gov.uk.</a>  An important aspect of the publication of structured information is the possibility of its receipt in a machine-readable form.  It is clear that the HTML table can be parsed quite successfully, but the provision of information in a convenient form for integration with external systems is a very important indicator of openness.  Therefore, the development of an <a href="http://api.duma.gov.ru/">API for the search for bills system</a> has become an important stage in the implementation of the ‚Äúopen state‚Äù concept within <a href="http://intaro.ru/portfolio/gosduma/">the State Duma website</a> .  Now data on bills can be easily integrated into external information systems.  For example, an analytical portal can place a widget next to an article devoted to a bill, which will reflect current information on the progress of the bill. <a name="habracut"></a><br><br><h3>  API features </h3><br>  The provided API implements, in fact, the search for bills, taking into account a variety of parameters.  In addition, it provides access to all sorts of directories and viewing transcripts for each bill.  The list of requests and their parameters can be found in the <a href="http://api.duma.gov.ru/pages/dokumentatsiya">documentation</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Consider a few examples of search queries processed by the API: <br><ul><li>  Rejected bills proposed by the deputy of the State Duma Zhirinovsky VV; </li><li>  The draft law ‚ÄúOn Police‚Äù and its amendments; </li><li>  Bills submitted by the President of the Russian Federation, currently awaiting consideration by the State Duma committees. </li></ul><br>  Search results for these queries can be viewed <a href="http://api.duma.gov.ru/examples/ex_php.php">here</a> , and the source code for PHP is <a href="http://api.duma.gov.ru/pages/dokumentatsiya/ispolzovanie-api-ais-zakonoproekt-v-php">in the documentation</a> . <br><br>  The interaction with the API is carried out in accordance with the REST architecture style, that is, the HTTP protocol is used, the response is given in XML, JSON (including JSONP) and RSS formats.  A wide range of supported formats allows you to apply the API in various situations.  It can be accessed directly from the browser's JavaScript.  You can send requests from the server side of the application or even from a fat client.  And you can subscribe to a specific search query via RSS, and directly follow the latest information. <br><br><h3>  Statistics </h3><br>  Since the launch of the new website of the State Duma, more than 70 thousand people have used the search system on bills.  With the introduction of the API, the search promises to be even more in demand, so it was important that it not only worked, but also worked quickly.  Before direct optimization, statistics were collected on what queries users make in the existing form of searching for bills. <br><br>  First, the frequency of using search parameters was analyzed (the sum of percents is greater than 100, since several parameters can be used in one query). <br><br><img src="https://habrastorage.org/storage1/7bed26bd/c02f4da4/2be9dda9/95ed985f.png"><br><br>  As you can see, the distribution is very uneven, it is immediately clear by what parameters the data should be indexed first.  Of course, after the publication of the API, the distribution of requests may turn out to be somewhat different than the form for searching bills on the site, but a good guide was obtained. <br><br>  Now let's see how users use pagination. <br><br><img src="https://habrastorage.org/storage1/da62324c/0b3b22fe/84625a1d/c460a9e6.png"><br><br>  The graph well reflects the fact that users rarely flip through the results far: more than 97% of requests fall on the first 3 pages.  Thus, it was possible to neglect the optimization of the issuance of pages with a large number. <br><br>  Next was considered the distribution of queries by type of sorting. <br><br><img src="https://habrastorage.org/storage1/a644a3df/321be62d/ade1d320/cb699ae5.png"><br><br>  As you can see, very few people change the default sorting, so this sorting should first be issued by index. <br><br>  One method of optimizing performance is caching the results of search queries.  In order for caching to make sense, queries must be repeated often enough.  How the number of queries with the same search parameters was distributed can be seen in the graph below. <br><br><img src="https://habrastorage.org/storage1/b0a6a66c/9e7f997b/f25df247/11b59f16.png"><br><br>  It can be seen that requests are repeated often enough, so caching is justified. <br><br>  And in the completion of statistics, TOP-10 search queries. <br><br><img src="https://habrastorage.org/storage1/23acb74d/80b213c3/383d78a5/f57a2928.png"><br><br>  One of the hottest topics at the time of collecting statistics was the law on education. <br><br><h3>  Optimization </h3><br>  Along with the development of the API, there was also the task of transferring the Draft Law database from Oracle to PostgreSQL (data was imported using ora2pg).  The following optimization methods were applied. <br><br>  Uses PostgreSQL built-in full-text search using GIN indexes. <br><br>  The indices were constructed for the fields for which sorting is available, and for those for which filtering is most often performed. <br><br>  Previously, when using Oracle DBMS, for paged navigation, a restriction was imposed on the rownum virtual column, reflecting the row number in the sample.  Those.  if you want to show, for example, the first 20 lines returned by some query, the following construct was used. <br><br><pre> SELECT 
   x. * 
 FROM 
   (main_query) x
 WHERE
   rownum &lt;= 20
</pre><br><br>  It was, in general, not the most correct way, but in the version used (Oracle 9i) it worked fine.  And when it was necessary to show, for example, 20 lines starting from 100, the following construction was used.  In it, the internal query selects the first 120 lines, and the external leaves only the last 20 of them. <br><br><pre> SELECT 
   * 
 FROM (
   SELECT 
     rownum AS xrownum, 
     x. * 
   FROM 
     (main_query) x
   WHERE
     rownum &lt;= 120)
 WHERE
   xrownum&gt; 100;
</pre><br><br>  With the transition to PostgreSQL, LIMIT and OFFSET constructions began to be applied.  In addition, for optimization purposes, the LIMIT and OFFSET constructs were located as far as possible in the table joins.  Consider an example.  Let us have tables <b>a</b> and <b>b</b> unite, sorting follows the field with the index.  Then if you apply LIMIT and OFFSET to the entire request, you get the following query plan. <br><br><pre> SELECT
   *
 FROM
     b
   JOIN
     a
   ON
     b.a_id = a.id
 ORDER BY
   b.value
   b.id
 LIMIT 20
 OFFSET 100;
</pre><br><br><pre>                                            QUERY PLAN                                           
 -------------------------------------------------- ----------------------------------------------
  Limit (cost = 52.30..62.76 rows = 20 width = 39)
    -&gt; Nested Loop (cost = 0.00..522980.13 rows = 1000000 width = 39)
          -&gt; Index Scan using b_value_id_idx on b (cost = 0.00 ..242736.13 rows = 1000000 width = 27)
          -&gt; Index Scan using a_pkey on a (cost = 0.00 ..0.27 rows = 1 width = 12)
                Index Cond: (a.id = b.a_id)
</pre><br><br>  Those.  the b_value_id_idx index is traversed, and for each found record of table <b>b</b> , the records of table <b>a are</b> added at index <b>a_pkey</b> .  The first 100 records found in this way are skipped and the next 20 are taken. Now let's see what happens if we apply LIMIT and OFFSET exclusively to table <b>b</b> .  In more detail about the organization of page navigation you can read <a href="http://intaro.ru/magazine/2010/05/14/pagination/">here</a> . <br><br><pre> SELECT
   *
 FROM
   (
     SELECT
       *
     FROM
       b
     ORDER BY
       b.value
       b.id
     LIMIT 20
     OFFSET 100
   ) b
   JOIN
     a
   ON
     b.a_id = a.id;
</pre><br><br><pre>                                               QUERY PLAN                                              
 -------------------------------------------------- -------------------------------------------------- -
  Hash Join (cost = 29.44..49.39 rows = 20 width = 60)
    Hash Cond: (a.id = public.b.a_id)
    -&gt; Seq Scan on a (cost = 0.00..16.00 rows = 1000 width = 12)
    -&gt; Hash (cost = 29.19..29.19 rows = 20 width = 48)
          -&gt; Limit (cost = 24.16..28.99 rows = 20 width = 27)
                -&gt; Index Scan using b_value_id_idx on b (cost = 0.00 ..241620.14 rows = 1000000 width = 27)
</pre><br><br>  As you can see, now the connection with table <b>a</b> is already taken after selecting only the necessary rows of table <b>b</b> , thereby saving.  And if it joins in such a way not 2, suppose 10 tables, then the effect can be very significant.  In principle, the airframe has all the necessary information to carry out such optimization itself, given that the <b>b.a_id</b> field <b>is</b> not null, and the <b>a.id</b> field is the primary key.  But he does not know how to do it, perhaps the situation will change in future versions.  So you can take as a rule to place LIMIT and OFFSET as ‚Äúdeeper‚Äù as possible, it won't get any worse. <br><br>  Query results caching is organized using memcached.  Each request to search for bills is characterized by: <br><ul><li>  a set of superimposed filters, </li><li>  sorting method </li><li>  number of the displayed page. </li></ul><br>  There were two types of cache: <br><ul><li>  The key is a set of superimposed filters, and the value is the number of satisfying its results. </li><li>  The key is the set of superimposed filters, the sorting method and the page number (ie all search parameters), and the value is the id of the bills found. </li></ul><br>  Thus, the data is stored in the cache compactly, thereby increasing the number of cached requests, although the cost of processing them increases because  part of the data is loaded from the main database. <br><br>  Optimization of the database allowed us to reduce the processing time of the test sample of 65 thousand search queries from 10 hours to 15 minutes. <br><br><h3>  Total </h3><br>  Thanks to the work done, everything that could be done earlier through the search form on the draft laws on the site can now be done programmatically and used in a variety of situations.  We hope that our efforts were not made in vain, and the developed API will become a useful and sought-after service. <br><br>  As an example, we decided to develop a mobile application ‚ÄúSearch by Draft Laws‚Äù, where all the features that are available in the API, as well as the functions of subscribing to search queries with receiving notifications about new draft laws, will be used.  Soon we will publish it. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage1/eadf14b9/5eb2820c/06469879/326412ec.jpg"></div></div><p>Source: <a href="https://habr.com/ru/post/133305/">https://habr.com/ru/post/133305/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../133300/index.html">YouTube agreed with Walt Disney on the use of films</a></li>
<li><a href="../133301/index.html">Ice Cream Sandwich on HTC Dream</a></li>
<li><a href="../133302/index.html">New qualities of the Asus Eee T101MT-BLK120S netbook transformer</a></li>
<li><a href="../133303/index.html">Timsort sorting algorithm</a></li>
<li><a href="../133304/index.html">Lenovo introduced the smallest desktop in the world</a></li>
<li><a href="../133306/index.html">Another open source analogue of Github</a></li>
<li><a href="../133307/index.html">Styling applications part one</a></li>
<li><a href="../133308/index.html">Small devices with big problems</a></li>
<li><a href="../133309/index.html">Habrarebest in Kiev</a></li>
<li><a href="../133311/index.html">Planning poker in their own colors</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>