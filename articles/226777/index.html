<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The first development experience for Windows Phone: In-App Purchasing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article discusses the possibility of using internal payments in your mobile Windows Phone 8 applications using the example of the Daily Horoscope...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The first development experience for Windows Phone: In-App Purchasing</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/74b/9a2/625/74b9a262535f3e597942da01e2d5fc7b.jpg"><br><br>  This article discusses the possibility of using internal payments in your mobile Windows Phone 8 applications using the example of the Daily Horoscope own application. <br>  If this topic is interesting, then please under the cat. <br><a name="habracut"></a><br>  At the moment in dev.windowsphone.com there is an opportunity to create free, paid, trial / demo versions of applications, as well as in-app purchases.  In turn, in-app purchases are - consumable and permanent.  In my application, I used the "permanent" (Fig. 1), that is, the user installed the application, and pays for additional functionality once.  "Permanent" can also have a term of its action, or without urgent.  An example of "permanent" is the purchase of a weapon or a unique recipe, and with a validity period - a subscription to read a magazine or a license.  By "consumable" can be attributed to the currency of the application (crystals).  If you have many recipes, and in order not to create an ‚Äúinternal product‚Äù for each recipe, you can use the consumable purchase, then the control of the purchase lies with the developer.  The most important thing in the implementation of any code, try everything that is done for a long time to make asynchronous requests, otherwise the moderators will not miss such an application. <br><br>  <i>Note: if you have a trial version of the program, until the user purchases it - In-App payments will not work.</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/e86/786/f6d/e86786f6ddc0d112942c237a721d904b.png" alt="image"><br>  rice  1 - UI In-App Purchasing Example <br><br>  In order to test your payments, you can use the special MockIAPLib library - <a href="http://msdn.microsoft.com/en-us/library/windowsphone/develop/jj681689%2528v%3Dvs.105%2529.aspx">read more [EN]</a> , but for a simple application there is a way out much easier - just publish your application in the dev center as Beta, then all your purchases will be equal to 0 rubles, and Tests are as close as possible to combat conditions. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a86/5b2/a41/a865b2a413ff15515a2c956ece263a1f.jpg"><br>  Fig.2 - purchase in Beta version <br><br>  And so, how to create In-App Purchasing? <br><br>  1. Go to the Dev Center WP and click on the link "Send application". <br>  2. Fill out the ‚ÄúApplication Details‚Äù (in my case, the application is completely free), immediately release or beta, etc. is indicated in the ‚ÄúAdvanced Settings‚Äù section, etc. <br>  3. In the left menu, select "Applications", we find there the newly created.  And go to the tab "Products", there we create our product, the main thing that we need is the "Product ID". <br>  4. Now open your project and open the WMAppManifest.xml file in it, then go to the ‚ÄúPacking‚Äù tab.  Look at the contents of the Product ID, it should correspond to what is specified in the information about your application in the Dev Center WP - "Application ID". <br><br>  Done, you have a blank application, and the products of this application.  If screenshots are interesting, you can <a href="http://developer.nokia.com/community/wiki/Increase_your_revenue_with_In-App_Purchase_on_Windows_Phone_8">see them here [EN]</a> . <br><br>  Dependencies: <br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Windows.ApplicationModel.Store; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Store = Windows.ApplicationModel.Store;</code> </pre> <br><br>  View the list of your products in the application, in case the products appear dynamically: <br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btnListAllProducts_Click_1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, RoutedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { StringBuilder sb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> listing = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> CurrentApp.LoadListingInformationAsync(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> product <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> listing.ProductListings) { sb.AppendLine(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"{0}, {1}, {2},{3}, {4}"</span></span>, product.Key, product.Value.Name, product.Value.FormattedPrice, product.Value.ProductType, product.Value.Description)); } MessageBox.Show(sb.ToString(), <span class="hljs-string"><span class="hljs-string">"List all products"</span></span>, MessageBoxButton.OK); }</code> </pre></div></div><br>  Remember that the user can have bad internet, so show him that the application is working, and not hung! <br><br>  Realization of a permanent purchase: <br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">async private <span class="hljs-type"><span class="hljs-type">void</span></span> btnBuy_Click_1(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, RoutedEventArgs e) { //     var listing=await CurrentApp.LoadListingInformationAsync(); var superweapon= listing.ProductListings.FirstOrDefault( p =&gt; p.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>.ProductId == "  ID " ); try { //,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (CurrentApp.LicenseInformation.ProductLicenses[superweapon.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>.ProductId].IsActive) { MessageBox.<span class="hljs-keyword"><span class="hljs-keyword">Show</span></span>("  !"); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { //  UI    .  receipt = await CurrentApp.RequestProductPurchaseAsync(superweapon.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>.ProductId, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); //  -   var productLicenses = CurrentApp.LicenseInformation.ProductLicenses; ProductLicense tokenLicense = productLicenses["  ID "]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tokenLicense.IsActive)//    { //  ,   IsolatedStorageSettings,    txtBoughtSW.Visibility=<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Windows.Visibility.Visible; txtBoughtSW.Text="  "; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { //    } } } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { //        MessageBox.<span class="hljs-keyword"><span class="hljs-keyword">Show</span></span>(ex.ToString()); } }</code> </pre></div></div><br>  How to keep everything simple, received a list with information and treat as we please.  Showed the user UI purchase and wait for the result. <br><br>  Example of a Consumable Purchase: <br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">async private <span class="hljs-type"><span class="hljs-type">void</span></span> btnBuy50Points_Click_1(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, RoutedEventArgs e) { // <span class="hljs-number"><span class="hljs-number">50</span></span> Points -      var listing=await CurrentApp.LoadListingInformationAsync(); var fiftypoints= listing.ProductListings.FirstOrDefault( p =&gt; p.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>.ProductId == "  ID " ); try { // UI  receipt=await CurrentApp.RequestProductPurchaseAsync(fiftypoints.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>.ProductId, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (CurrentApp.LicenseInformation.ProductLicenses[fiftypoints.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>.ProductId].IsActive) { // <span class="hljs-number"><span class="hljs-number">50</span></span>  m_pointCount+=<span class="hljs-number"><span class="hljs-number">50</span></span>; //  ,  "",         <span class="hljs-number"><span class="hljs-number">50</span></span>  CurrentApp.ReportProductFulfillment(fiftypoints.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>.ProductId); txtBought50Pts.Visibility=<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Windows.Visibility.Visible; txtBought50Pts.Text= "Bought 50 Points " + i++ + " times for a total of " + m_pointCount + "!"; } } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { MessageBox.<span class="hljs-keyword"><span class="hljs-keyword">Show</span></span>(ex.ToString()); } }</code> </pre></div></div><br>  The only difference in the consumable and permanent purchase, what in the consumable MUST be reported to the ‚Äústore‚Äù that you have processed the purchase response.  Otherwise, the user will not be able to buy your product (crystals) again until you issue the command: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">CurrentApp</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ReportProductFulfillment</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">fiftypoints</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Value</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ProductId</span></span>);</code> </pre><br>  As well as storage of purchased products falls on the developer.  He needs to worry that the user can remove the application and re-install it, and the developer must correctly identify it. <br><br>  An example of a permanent purchase in my application: <br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">private async <span class="hljs-type"><span class="hljs-type">void</span></span> Button_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, RoutedEventArgs e) { //,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Net.NetworkInformation.NetworkInterface.GetIsNetworkAvailable()) { ******     ***** try { //      ListingInformation LicensePremiumID = await Store.CurrentApp.LoadListingInformationByProductIdsAsync(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> string[] { "ID" }); //  string x = await CurrentApp.RequestProductPurchaseAsync(LicensePremiumID.ProductListings.ToList()[<span class="hljs-number"><span class="hljs-number">0</span></span>].<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>.ProductId, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); //  var productLicenses = CurrentApp.LicenseInformation.ProductLicenses; ProductLicense tokenLicense = productLicenses["ID"]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tokenLicense.IsActive)//    { IsolatedStorageSettings.ApplicationSettings[" "] = "1";// AppSetting.ApplicationFullVersiy = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; // ,    !      //CurrentApp.ReportProductFulfillment(tokenLicense.ProductId); MessageBox.<span class="hljs-keyword"><span class="hljs-keyword">Show</span></span>("¬´  Premium¬ª  .   !"); *** } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { MessageBox.<span class="hljs-keyword"><span class="hljs-keyword">Show</span></span>("IsActive - false"); *** } } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { //MessageBox.<span class="hljs-keyword"><span class="hljs-keyword">Show</span></span>(ex.ToString()); MessageBox.<span class="hljs-keyword"><span class="hljs-keyword">Show</span></span>("*****"); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { MessageBox.<span class="hljs-keyword"><span class="hljs-keyword">Show</span></span>("  ..."); } }</code> </pre></div></div><br><br>  If the user has already bought before, then: <br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"> private <span class="hljs-type"><span class="hljs-type">void</span></span> Button_Click_1(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, RoutedEventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Net.NetworkInformation.NetworkInterface.GetIsNetworkAvailable()) { *** try { var productLicenses = CurrentApp.LicenseInformation.ProductLicenses; ProductLicense tokenLicense = productLicenses["ID"]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tokenLicense.IsActive)//    { IsolatedStorageSettings.ApplicationSettings["ept"] = "1";// AppSetting.ApplicationFullVersiy = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; **** MessageBox.<span class="hljs-keyword"><span class="hljs-keyword">Show</span></span>("¬´  Premium¬ª  ."); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { MessageBox.<span class="hljs-keyword"><span class="hljs-keyword">Show</span></span>("¬´  Premium¬ª  ."); } } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { //MessageBox.<span class="hljs-keyword"><span class="hljs-keyword">Show</span></span>(ex.ToString()); MessageBox.<span class="hljs-keyword"><span class="hljs-keyword">Show</span></span>("****.."); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { MessageBox.<span class="hljs-keyword"><span class="hljs-keyword">Show</span></span>("  ..."); } }</code> </pre></div></div><br><br>  Result: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/529/b9b/743/529b9b74379caea08bd2a2e2b92df277.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/0b4/2b4/e77/0b42b4e772cf87013fd732f8890062a8.png"><br></div></div><br><br>  In games, the implementation is similar, as in Windows Stor.  If you forgot to describe something, write in the comments, I will be glad to answer all your questions. <br><br><div class="spoiler">  <b class="spoiler_title">off top</b> <div class="spoiler_text">  I decided to tell about In-App Purchasing, because I did not find exhaustive information on the Russian Internet, including habr, I decided to skip the rest of the development stages (UI, Async / await, JSON) because there are similar articles on Habr√©, but if there will be those who want to know about it, write in the comments, I also don‚Äôt leave links to my application, so that I don‚Äôt think that I am promoting, it can be easily found by name </div></div></div><p>Source: <a href="https://habr.com/ru/post/226777/">https://habr.com/ru/post/226777/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../226763/index.html">Zero Downtime Upgrade for an application in Microsoft Azure. Part 2: IaaS</a></li>
<li><a href="../226765/index.html">Interview. Where to find an investor for your Internet project?</a></li>
<li><a href="../226769/index.html">How to find an idea for a startup in robotics?</a></li>
<li><a href="../226773/index.html">Multicellular processor is what?</a></li>
<li><a href="../226775/index.html">Key parameters and certification of optical SFP modules</a></li>
<li><a href="../226779/index.html">Quaternion Encryption Scheme (QES) on FPGA, XeonPhi, GPU</a></li>
<li><a href="../226783/index.html">The Ministry of Industry and Trade orders the development of a domestic processor</a></li>
<li><a href="../226787/index.html">Grid Tiling: Mixing Multiple Tiles</a></li>
<li><a href="../226789/index.html">Robot Hitchbot is hitchhiking</a></li>
<li><a href="../226791/index.html">Spring Security Hello World Java Config</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>