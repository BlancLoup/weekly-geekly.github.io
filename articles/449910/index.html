<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>GitLab Shell Runner. Competitive launch of test services with Docker Compose</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article will be of interest to both testers and developers, but it is designed mostly for automators who are faced with the problem of setting up...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>GitLab Shell Runner. Competitive launch of test services with Docker Compose</h1><div class="post__text post__text-html js-mediator-article"><p> <a href=""><img src="https://habrastorage.org/webt/ub/dc/bf/ubdcbfrlztg3eqofpqbs6w1u9sw.png"></a> </p><br><p>  This article will be of interest to both testers and developers, but it is designed mostly for automators who are faced with the problem of setting up GitLab CI / CD for integration testing under conditions of insufficient infrastructure resources and / or lack of container orchestration platform.  I will tell you how to configure the deployment of test environments using docker compose on a single GitLab shell runner so that when deploying several environments, the services that are started do not interfere with each other. </p><a name="habracut"></a><br><a name="toc"></a><br><h2 id="soderzhanie">  Content </h2><br><ul><li>  <a href="https://habr.com/ru/post/449910/">Prerequisites</a> </li><li>  <a href="https://habr.com/ru/post/449910/">GitLab Shell Runner</a> </li><li>  <a href="https://habr.com/ru/post/449910/">Docker-compose.yml preparation</a> </li><li>  <a href="https://habr.com/ru/post/449910/">Makefile Preparation</a> </li><li>  <a href="https://habr.com/ru/post/449910/">Preparing .gitlab-ci.yml</a> <br><ul><li>  <a href="https://habr.com/ru/post/449910/">Running integration tests</a> </li><li>  <a href="https://habr.com/ru/post/449910/">Runner cleaning</a> </li></ul></li><li>  <a href="https://habr.com/ru/post/449910/">Result</a> </li></ul><br><a name="prerequisites"></a><br><h2 id="predposylki">  Prerequisites </h2><br><ol><li><p>  In my practice, it often happened to "heal" integration testing on projects.  And often the first and most significant problem is the CI pipeline, in which integration testing of the service <strong>being developed</strong> (s) is performed in the dev / stage environment.  This caused quite a few problems: </p><br><ul><li>  Due to defects in a particular service, in the course of integration testing, the test loop may be corrupted by broken data.  There were cases when sending a request with a broken JSON format hung the service, which caused the stand to be completely inoperable. </li><li>  The slowdown of the test circuit with the growth of test data.  I think, to describe an example with cleaning / rollback of a DB does not make sense.  In my practice, I have not met a project where this procedure would go smoothly. </li><li>  The risk of disrupting the performance of the test circuit when testing general system settings.  For example, user / group / password / application policy. </li><li>  Test data from autotests interfere with live testers. </li></ul><br><p>  Someone will say that good auto tests should clean the data after themselves.  I have arguments against: </p><br><ul><li>  Dynamic stands are very convenient to use. </li><li>  Not every object can be removed from the system through the API.  For example, the call to delete an object is not implemented, since it contradicts business logic. </li><li>  When creating an object through the API, a huge amount of metadata can be created, which is difficult to delete. </li><li>  If tests have dependencies among themselves, then the process of clearing data after performing tests turns into a headache. </li><li>  Additional (and, in my opinion, not justified) calls to the API. </li><li>  And the main argument: when the test data starts to clean directly from the database.  It turns into a real PK / FK circus!  From the developers you can hear: "I just added / deleted / renamed the nameplate, why did 100500 integration tests end up?" </li></ul><br><p>  In my opinion, the most optimal solution is a dynamic environment. </p><br></li><li>  Many people use docker-compose to run a test environment, but very few people use docker-compose when performing integration testing in CI / CD.  And here I do not take into account kubernetes, swarm and other container orchestration platforms.  Not every company they are.  It would be nice if docker-compose.yml were universal. </li><li>  Even if we have our own QA runner, how can we ensure that the services launched via docker-compose do not interfere with each other? </li><li>  How to collect logs of tested services? </li><li>  How to clean a runner? </li></ol><br><p>  I have my own GitLab runner for my projects and I encountered these questions when developing a <a href="https://gitlab.com/TouchBIT/testrail4j">Java client</a> for <a href="https://www.gurock.com/testrail">TestRail</a> .  Or rather, when you run the integration tests.  Here we will solve these issues with examples from this project. </p><br><p>  <a href="https://habr.com/ru/post/449910/">To the content</a> </p><br><a name="gitlab_shell_runner"></a><br><h3 id="gitlab-shell-runner">  GitLab Shell Runner </h3><br><p>  For a runner, I recommend a Linux virtual machine with 4 vCPU, 4 GB RAM, 50 GB HDD. <br>  On the Internet, a lot of information on how to configure gitlab-runner, so briefly: </p><br><ul><li>  Go to the machine for SSH </li><li><p>  If you have less than 8 GB of RAM, then I recommend <a href="https://linuxize.com/post/how-to-add-swap-space-on-centos-7/">to make a swap 10 GB</a> , so that the OOM killer does not come and do not kill us due to lack of RAM.  This can happen when more than 5 tasks are running simultaneously.  Tasks will be slower, but stable. </p><br><div class="spoiler">  <b class="spoiler_title">Example with OOM killer</b> <div class="spoiler_text"><p> If in the task logs you see <code>bash: line 82: 26474 Killed</code> , then simply execute <code>sudo dmesg | grep 26474</code> <code>sudo dmesg | grep 26474</code> </p><br><pre> <code class="plaintext hljs">[26474] 1002 26474 1061935 123806 339 0 0 java Out of memory: Kill process 26474 (java) score 127 or sacrifice child Killed process 26474 (java) total-vm:4247740kB, anon-rss:495224kB, file-rss:0kB, shmem-rss:0kB</code> </pre> <br><p>  And if the picture looks something like this, then either add a swap, or drop RAM. </p><br></div></div><br></li></ul><br><ul><li>  Install <a href="https://docs.gitlab.com/runner/install/">gitlab-runner</a> , <a href="https://docs.docker.com/install/">docker</a> , <a href="https://docs.docker.com/compose/install/">docker-compose</a> , make. </li><li>  Add user <code>gitlab-runner</code> to <code>docker</code> group <br><pre> <code class="bash hljs">sudo groupadd docker sudo usermod -aG docker gitlab-runner</code> </pre> </li><li>  <a href="https://docs.gitlab.com/runner/register/">Register</a> gitlab-runner. </li><li><p>  Open for editing <code>/etc/gitlab-runner/config.toml</code> and add </p><br><pre> <code class="plaintext hljs">concurrent=20 [[runners]] request_concurrency = 10</code> </pre> <br><p>  This will allow to run parallel tasks on one runner.  Read more <a href="https://docs.gitlab.com/runner/configuration/advanced-configuration.html">here</a> . <br>  If your machine is more powerful, for example, 8 vCPU, 16 GB RAM, then these numbers can be made at least 2 times larger.  But it all depends on what exactly will run on this runner and in what quantity. </p><br></li></ul><br><p>  It's enough. </p><br><p>  <a href="https://habr.com/ru/post/449910/">To the content</a> </p><br><a name="docker_compose_yml_preparation"></a><br><h2 id="podgotovka-docker-composeyml">  Docker-compose.yml preparation </h2><br><p>  The main task is the docker-compose.yml, which will be used both locally and in the CI pipeline. </p><br><p>  To run multiple instances of the environment, the <a href="https://docs.docker.com/compose/reference/envvars/">COMPOSE_PROJECT_NAME</a> variable will be used (see <a href="https://habr.com/ru/post/449910/">makefile</a> ). </p><br><p>  An example of my docker-compose.yml </p><br><pre> <code class="plaintext hljs">version: "3" #    web (php)  fmt , #      . #   ,   /var/www/testrail volumes: static-content: services: db: image: mysql:5.7.22 environment: MYSQL_HOST: db MYSQL_DATABASE: mydb MYSQL_ROOT_PASSWORD: 1234 SKIP_GRANT_TABLES: 1 SKIP_NETWORKING: 1 SERVICE_TAGS: dev SERVICE_NAME: mysql migration: image: registry.gitlab.com/touchbit/image/testrail/migration:latest links: - db depends_on: - db fpm: image: registry.gitlab.com/touchbit/image/testrail/fpm:latest container_name: "testrail-fpm-${CI_JOB_ID:-local}" volumes: - static-content:/var/www/testrail links: - db web: image: registry.gitlab.com/touchbit/image/testrail/web:latest #   TR_HTTP_PORT  TR_HTTPS_PORTS  , #     80  443  . ports: - ${TR_HTTP_PORT:-80}:80 - ${TR_HTTPS_PORT:-443}:443 volumes: - static-content:/var/www/testrail links: - db - fpm</code> </pre> <br><p>  <a href="https://habr.com/ru/post/449910/">To the content</a> </p><br><a name="makefile_preparation"></a><br><h2 id="podgotovka-makefile">  Makefile Preparation </h2><br><p>  I use the Makefile, as it is very convenient for both local control of the environment, and in CI. </p><br><p>  Further comments inline </p><br><pre> <code class="plaintext hljs">#           `.indirect`, #     `docker-compose.yml` #  bash   pipefail # pipefail -   ,      SHELL=/bin/bash -o pipefail #   CI_JOB_ID   ifeq ($(CI_JOB_ID),) #   local CI_JOB_ID := local endif #    export COMPOSE_PROJECT_NAME = $(CI_JOB_ID)-testrail #    , , volumes docker-down: docker-compose -f .indirect/docker-compose.yml down #   docker-down () docker-up: docker-down #     docker-registry docker-compose -f .indirect/docker-compose.yml pull #   # force-recreate -    # renew-anon-volumes -   volumes   docker-compose -f .indirect/docker-compose.yml up --force-recreate --renew-anon-volumes -d #  ,   ,           docker ps #    docker-logs: mkdir -p ./logs docker logs $${COMPOSE_PROJECT_NAME}_web_1 &gt;&amp; logs/testrail-web.log || true docker logs $${COMPOSE_PROJECT_NAME}_fpm_1 &gt;&amp; logs/testrail-fpm.log || true docker logs $${COMPOSE_PROJECT_NAME}_migration_1 &gt;&amp; logs/testrail-migration.log || true docker logs $${COMPOSE_PROJECT_NAME}_db_1 &gt;&amp; logs/testrail-mysql.log || true #   docker-clean: @echo   testrail- docker kill $$(docker ps --filter=name=testrail -q) || true @echo    docker rm -f $$(docker ps -a -f --filter=name=testrail status=exited -q) || true @echo  dangling  docker rmi -f $$(docker images -f "dangling=true" -q) || true @echo  testrail  docker rmi -f $$(docker images --filter=reference='registry.gitlab.com/touchbit/image/testrail/*' -q) || true @echo    volume docker volume rm -f $$(docker volume ls -q) || true @echo   testrail  docker network rm $(docker network ls --filter=name=testrail -q) || true docker ps</code> </pre><br><div class="spoiler">  <b class="spoiler_title">We check local start</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">$ make docker-up docker-compose -f .indirect/docker-compose.yml pull Pulling db ... done Pulling migration ... done Pulling fpm ... done Pulling web ... done docker-compose -f .indirect/docker-compose.yml up --force-recreate --renew-anon-volumes -d Creating network "local-testrail_default" with the default driver Recreating local-testrail_db_1 ... done Recreating local-testrail_migration_1 ... done Recreating local-testrail_fpm_1 ... done Recreating local-testrail_web_1 ... done docker ps CONTAINER ID NAMES 3b8f9d4af29c local-testrail_web_1 5622c7d742d5 local-testrail_fpm_1 b580e3392038 local-testrail_migration_1 e467630bd3a5 local-testrail_db_1</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Checking CI launch</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">$ export CI_JOB_ID=123456789 $ make docker-up docker-compose -f .indirect/docker-compose.yml pull Pulling db ... done Pulling migration ... done Pulling fpm ... done Pulling web ... done docker-compose -f .indirect/docker-compose.yml up --force-recreate --renew-anon-volumes -d Creating network "123456789-testrail_default" with the default driver Creating volume "123456789-testrail_static-content" with default driver Creating 123456789-testrail_db_1 ... done Creating 123456789-testrail_fpm_1 ... done Creating 123456789-testrail_migration_1 ... done Creating 123456789-testrail_web_1 ... done docker ps CONTAINER ID NAMES ccf1ad33d0e8 123456789-testrail_web_1 bc079964f681 123456789-testrail_fpm_1 10dc9d4d8f2a 123456789-testrail_migration_1 fe98d43c380e 123456789-testrail_db_1</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">We check the collection of logs</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">$ make docker-logs mkdir -p ./logs docker logs ${COMPOSE_PROJECT_NAME}_web_1 &gt;&amp; logs/testrail-web.log || true docker logs ${COMPOSE_PROJECT_NAME}_fpm_1 &gt;&amp; logs/testrail-fpm.log || true docker logs ${COMPOSE_PROJECT_NAME}_migration_1 &gt;&amp; logs/testrail-migration.log || true docker logs ${COMPOSE_PROJECT_NAME}_db_1 &gt;&amp; logs/testrail-mysql.log || true</code> </pre> <br><p><img src="https://habrastorage.org/webt/e0/jx/a2/e0jxa2mkfygvn7kn5fpu3xlcnl0.png"></p></div></div><br><p>  <a href="https://habr.com/ru/post/449910/">To the content</a> </p><br><a name="gitlab_ci_yml_preparation"></a><br><h2 id="podgotovka-gitlab-ciyml">  Preparing .gitlab-ci.yml </h2><br><a name="integration_tests_run"></a><br><h3 id="zapusk-integracionnyh-testov">  Running integration tests </h3><br><pre> <code class="plaintext hljs">Integration: stage: test tags: - my-shell-runner before_script: #   registry - docker login -u gitlab-ci-token -p ${CI_JOB_TOKEN} ${CI_REGISTRY} #   TR_HTTP_PORT  TR_HTTPS_PORT - export TR_HTTP_PORT=$(shuf -i10000-60000 -n1) - export TR_HTTPS_PORT=$(shuf -i10000-60000 -n1) script: #    - make docker-up #    jar (  ) - java -jar itest.jar --http-port ${TR_HTTP_PORT} --https-port ${TR_HTTPS_PORT} #    - docker run --network=testrail-network-${CI_JOB_ID:-local} --rm itest after_script: #   - make docker-logs #   - make docker-down artifacts: #   when: always paths: - logs expire_in: 30 days</code> </pre> <br><p>  As a result of launching such a task, the logs directory will contain logs of services and tests in artifacts.  Which is very convenient in case of errors.  In my case, each test in parallel writes its own log, but I will tell you about it separately. </p><br><p><img src="https://habrastorage.org/webt/xh/s2/yj/xhs2yjdigikkpaoxxi49ocdhink.png"></p><br><p>  <a href="https://habr.com/ru/post/449910/">To the content</a> </p><br><a name="clean_runner"></a><br><h3 id="ochistka-rannera">  Runner cleaning </h3><br><p>  The task will run only on schedule. </p><br><pre> <code class="plaintext hljs">stages: - clean - build - test Clean runner: stage: clean only: - schedules tags: - my-shell-runner script: - make docker-clean</code> </pre> <br><p>  Next, go to our GitLab project -&gt; CI / CD -&gt; Schedules -&gt; New Schedule and add a new schedule </p><br><p> <a href=""><img src="https://habrastorage.org/webt/md/40/9y/md409yjzjctken7qcjh5gkj0u4y.png"></a> </p><br><p>  <a href="https://habr.com/ru/post/449910/">To the content</a> </p><br><a name="result"></a><br><h3 id="rezultat">  Result </h3><br><p>  Run 4 tasks in GitLab CI <br> <a href=""><img src="https://habrastorage.org/webt/2t/yt/nt/2tytntlg2we6ikmh4ef3p6noxwe.png"></a> </p><br><p>  In the logs of the last task with integration tests we see containers from different tasks. </p><br><pre> <code class="plaintext hljs">CONTAINER ID NAMES c6b76f9135ed 204645172-testrail-web_1 01d303262d8e 204645172-testrail-fpm_1 2cdab1edbf6a 204645172-testrail-migration_1 826aaf7c0a29 204645172-testrail-mysql_1 6dbb3fae0322 204645084-testrail-web_1 3540f8d448ce 204645084-testrail-fpm_1 70fea72aa10d 204645084-testrail-mysql_1 d8aa24b2892d 204644881-testrail-web_1 6d4ccd910fad 204644881-testrail-fpm_1 685d8023a3ec 204644881-testrail-mysql_1 1cdfc692003a 204644793-testrail-web_1 6f26dfb2683e 204644793-testrail-fpm_1 029e16b26201 204644793-testrail-mysql_1 c10443222ac6 204567103-testrail-web_1 04339229397e 204567103-testrail-fpm_1 6ae0accab28d 204567103-testrail-mysql_1 b66b60d79e43 204553690-testrail-web_1 033b1f46afa9 204553690-testrail-fpm_1 a8879c5ef941 204553690-testrail-mysql_1 069954ba6010 204553539-testrail-web_1 ed6b17d911a5 204553539-testrail-fpm_1 1a1eed057ea0 204553539-testrail-mysql_1</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">More detailed log</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">$ docker login -u gitlab-ci-token -p ${CI_JOB_TOKEN} ${CI_REGISTRY} WARNING! Using --password via the CLI is insecure. Use --password-stdin. WARNING! Your password will be stored unencrypted in /home/gitlab-runner/.docker/config.json. Configure a credential helper to remove this warning. See https://docs.docker.com/engine/reference/commandline/login/#credentials-store Login Succeeded $ export TR_HTTP_PORT=$(shuf -i10000-60000 -n1) $ export TR_HTTPS_PORT=$(shuf -i10000-60000 -n1) $ mkdir ${CI_JOB_ID} $ cp .indirect/docker-compose.yml ${CI_JOB_ID}/docker-compose.yml $ make docker-up docker-compose -f ${CI_JOB_ID:-.indirect}/docker-compose.yml kill docker network rm testrail-network-${CI_JOB_ID:-local} || true Error: No such network: testrail-network-204645172 docker network create testrail-network-${CI_JOB_ID:-local} 0a59552b4464b8ab484de6ae5054f3d5752902910bacb0a7b5eca698766d0331 docker-compose -f ${CI_JOB_ID:-.indirect}/docker-compose.yml pull Pulling web ... done Pulling fpm ... done Pulling migration ... done Pulling db ... done docker-compose -f ${CI_JOB_ID:-.indirect}/docker-compose.yml up --force-recreate --renew-anon-volumes -d Creating volume "204645172-testrail_static-content" with default driver Creating 204645172-testrail-mysql_1 ... Creating 204645172-testrail-mysql_1 ... done Creating 204645172-testrail-migration_1 ... done Creating 204645172-testrail-fpm_1 ... done Creating 204645172-testrail-web_1 ... done docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES c6b76f9135ed registry.gitlab.com/touchbit/image/testrail/web:latest "nginx -g 'daemon of‚Ä¶" 13 seconds ago Up 1 second 0.0.0.0:51148-&gt;80/tcp, 0.0.0.0:25426-&gt;443/tcp 204645172-testrail-web_1 01d303262d8e registry.gitlab.com/touchbit/image/testrail/fpm:latest "docker-php-entrypoi‚Ä¶" 16 seconds ago Up 13 seconds 9000/tcp 204645172-testrail-fpm_1 2cdab1edbf6a registry.gitlab.com/touchbit/image/testrail/migration:latest "docker-entrypoint.s‚Ä¶" 16 seconds ago Up 13 seconds 3306/tcp, 33060/tcp 204645172-testrail-migration_1 826aaf7c0a29 mysql:5.7.22 "docker-entrypoint.s‚Ä¶" 18 seconds ago Up 16 seconds 3306/tcp 204645172-testrail-mysql_1 6dbb3fae0322 registry.gitlab.com/touchbit/image/testrail/web:latest "nginx -g 'daemon of‚Ä¶" 36 seconds ago Up 22 seconds 0.0.0.0:44202-&gt;80/tcp, 0.0.0.0:20151-&gt;443/tcp 204645084-testrail-web_1 3540f8d448ce registry.gitlab.com/touchbit/image/testrail/fpm:latest "docker-php-entrypoi‚Ä¶" 38 seconds ago Up 35 seconds 9000/tcp 204645084-testrail-fpm_1 70fea72aa10d mysql:5.7.22 "docker-entrypoint.s‚Ä¶" 40 seconds ago Up 37 seconds 3306/tcp 204645084-testrail-mysql_1 d8aa24b2892d registry.gitlab.com/touchbit/image/testrail/web:latest "nginx -g 'daemon of‚Ä¶" About a minute ago Up 53 seconds 0.0.0.0:31103-&gt;80/tcp, 0.0.0.0:43872-&gt;443/tcp 204644881-testrail-web_1 6d4ccd910fad registry.gitlab.com/touchbit/image/testrail/fpm:latest "docker-php-entrypoi‚Ä¶" About a minute ago Up About a minute 9000/tcp 204644881-testrail-fpm_1 685d8023a3ec mysql:5.7.22 "docker-entrypoint.s‚Ä¶" About a minute ago Up About a minute 3306/tcp 204644881-testrail-mysql_1 1cdfc692003a registry.gitlab.com/touchbit/image/testrail/web:latest "nginx -g 'daemon of‚Ä¶" About a minute ago Up About a minute 0.0.0.0:44752-&gt;80/tcp, 0.0.0.0:23540-&gt;443/tcp 204644793-testrail-web_1 6f26dfb2683e registry.gitlab.com/touchbit/image/testrail/fpm:latest "docker-php-entrypoi‚Ä¶" About a minute ago Up About a minute 9000/tcp 204644793-testrail-fpm_1 029e16b26201 mysql:5.7.22 "docker-entrypoint.s‚Ä¶" About a minute ago Up About a minute 3306/tcp 204644793-testrail-mysql_1 c10443222ac6 registry.gitlab.com/touchbit/image/testrail/web:latest "nginx -g 'daemon of‚Ä¶" 5 hours ago Up 5 hours 0.0.0.0:57123-&gt;80/tcp, 0.0.0.0:31657-&gt;443/tcp 204567103-testrail-web_1 04339229397e registry.gitlab.com/touchbit/image/testrail/fpm:latest "docker-php-entrypoi‚Ä¶" 5 hours ago Up 5 hours 9000/tcp 204567103-testrail-fpm_1 6ae0accab28d mysql:5.7.22 "docker-entrypoint.s‚Ä¶" 5 hours ago Up 5 hours 3306/tcp 204567103-testrail-mysql_1 b66b60d79e43 registry.gitlab.com/touchbit/image/testrail/web:latest "nginx -g 'daemon of‚Ä¶" 5 hours ago Up 5 hours 0.0.0.0:56321-&gt;80/tcp, 0.0.0.0:58749-&gt;443/tcp 204553690-testrail-web_1 033b1f46afa9 registry.gitlab.com/touchbit/image/testrail/fpm:latest "docker-php-entrypoi‚Ä¶" 5 hours ago Up 5 hours 9000/tcp 204553690-testrail-fpm_1 a8879c5ef941 mysql:5.7.22 "docker-entrypoint.s‚Ä¶" 5 hours ago Up 5 hours 3306/tcp 204553690-testrail-mysql_1 069954ba6010 registry.gitlab.com/touchbit/image/testrail/web:latest "nginx -g 'daemon of‚Ä¶" 5 hours ago Up 5 hours 0.0.0.0:32869-&gt;80/tcp, 0.0.0.0:16066-&gt;443/tcp 204553539-testrail-web_1 ed6b17d911a5 registry.gitlab.com/touchbit/image/testrail/fpm:latest "docker-php-entrypoi‚Ä¶" 5 hours ago Up 5 hours 9000/tcp 204553539-testrail-fpm_1 1a1eed057ea0 mysql:5.7.22 "docker-entrypoint.s‚Ä¶" 5 hours ago Up 5 hours 3306/tcp 204553539-testrail-mysql_1</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">All tasks completed successfully</b> <div class="spoiler_text"><p>  Task artifacts contain logs of services and tests. <br> <a href=""><img src="https://habrastorage.org/webt/xu/gp/kh/xugpkhzugu-9olo8bz5qyorlbdc.png"></a> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/1h/cr/b8/1hcrb8n8awyjugdbbhvyn9axiv8.png"></a> </p></div></div><br><p>  It seems everything is beautiful, but there is a nuance.  Pipeline can be forcibly canceled during the execution of integration tests, in which case running containers will not be stopped.  From time to time you need to clean the runner.  Unfortunately, the revision task in GitLab CE is still in <a href="https://gitlab.com/gitlab-org/gitlab-ce/issues/20727">Open</a> status. </p><br><p>  But we added the launch of the task on a schedule, and no one forbids us to start it manually. <br>  Go to our project -&gt; CI / CD -&gt; Schedules and run the task <code>Clean runner</code> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/sg/ia/nv/sgianvitqqnsknbmmgupakud62k.png"></a> </p><br><p>  Total: </p><br><ul><li>  We have one shell runner. </li><li>  There are no conflicts between tasks and the environment. </li><li>  We have a parallel launch of tasks with integration tests. </li><li>  You can run integration tests both locally and in a container. </li><li>  Logs of services and tests are collected and attached to the pipeline-task. </li><li>  It is possible to clean the runner from the old docker-images. </li></ul><br><p>  Setup time is ~ 2 hours. <br>  That's all.  I would be happy to feedback. </p><br><p>  PS <br>  Special thanks to <a href="https://habr.com/ru/users/freeseacher/" class="user_link">freeseacher</a> <a href="https://habr.com/ru/users/vvasilenok/" class="user_link">vvasilenok</a> <a href="https://habr.com/ru/users/ivanych/" class="user_link">ivanych</a> .  Your comments have been very valuable in the context of publication. </p><br><p>  <a href="https://habr.com/ru/post/449910/">To the content</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/449910/">https://habr.com/ru/post/449910/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../4499/index.html">Promo site - inside or outside?</a></li>
<li><a href="../44990/index.html">Results of the NORD industrial design competition</a></li>
<li><a href="../449906/index.html">Self-documenting REST server (Node.JS, TypeScript, Koa, Joi, Swagger)</a></li>
<li><a href="../449908/index.html">DDR3 or DDR4? Why did we offer the Dell R420 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps at $ 99 in the Netherlands?</a></li>
<li><a href="../44991/index.html">Triumph of Belarusians in the final of Code Jam 2008</a></li>
<li><a href="../449916/index.html">5 ways to deploy PHP code in terms of hayload</a></li>
<li><a href="../449918/index.html">Infrared Thermometer with Sensor MLX90614</a></li>
<li><a href="../44992/index.html">Live game without graphics</a></li>
<li><a href="../449922/index.html">Test drive nanoCAD SPDS Metal structures 1.2. Part 3</a></li>
<li><a href="../449926/index.html">The digest of fresh materials from the world of the frontend for the last week No. 362 (April 22 - 28, 2019)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>