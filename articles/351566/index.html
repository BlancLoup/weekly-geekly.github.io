<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A few tips on organizing a Python application on the server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I want to share several convenient ways to organize your project on a working (even production) server. 


 I work mainly with the Pyt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A few tips on organizing a Python application on the server</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/jy/vy/pt/jyvyptrxht51oujs8v8h5p_hjd0.jpeg"></p><br><p>  In this article I want to share several convenient ways to organize your project on a working (even production) server. </p><br><p>  I work mainly with the Python / Django stack, so all the examples will be, first of all, applied to this set.  Also key technologies: Ubuntu (17.10), Python3 (3.6). </p><br><p>  Content: </p><br><ul><li>  Logs (logrotate) </li><li>  Daemons (systemd) </li><li>  local settings </li></ul><a name="habracut"></a><br><p>  It is assumed that you are doing everything correctly, the application is stored in the repository, is deposited in a separate folder on the server, using, for example, virtualenv.  To start, a separately created user is used, which has enough rights, but not too much (for example, it does not have sudo and login via ssh is not allowed). </p><br><p>  To begin with, I will repeat the truisms that all that is stored in the repository is only pure code and static data.  All settings contain only defaults, no passwords and keys, even in unused files. </p><br><p>  Even on the work computer (laptop) where you write the code in your project folder there should not be anything that you could not upload to production.  This refers to the vicious practice of using the file "local_settings.py" in the settings folder inside the project (as an option - development_settings.py).  I will analyze this example below. </p><br><h3 id="logi">  Logs </h3><br><p>  Surely you use logging.  The built-in logging module is very good, but it is not always worth it to refine and use it for everything in the world. </p><br><p>  For example, the rotation of the logs.  The Internet comes across complex and sophisticated methods ranging from the standard RotatingFileHandler and ending with writing your own demon on sockets for recording logs from several sources.  Problems begin because of the desire to do everything in "pure Python".  This is stupid and inefficient, but it brings a bunch of possible places of occurrence of errors. </p><br><p>  Use the logrotate service.  Below is a simple config for celery logs. </p><br><p>  Using standard tools, we write the file /var/log/myproject/celery.log, every day it is placed in the / var / log / myproject / archive / folder and the previous day suffix is ‚Äã‚Äãadded to the name. </p><br><pre><code class="hljs mel">/var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/myproject/celery.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> su myuser myuser copytruncate create <span class="hljs-keyword"><span class="hljs-keyword">rotate</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> missingok postrotate timeext=<span class="hljs-string"><span class="hljs-string">`date -d '1 day ago' "+%Y-%m-%d"`</span></span> # daily # timeext=$(<span class="hljs-keyword"><span class="hljs-keyword">date</span></span> +%Y-%m-%d_%H) # hourly mv /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/myproject/celery.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/myproject/archive/celery_$timeext.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> endscript }</code> </pre> <br><p>  If your log is written very quickly and you want to rotate it every hour, then comment the lines "daily" and "hourly" in the config.  You also need to configure logrotate so that it runs every hour (by default, usually daily).  Run in bash: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sudo</span></span> cp /etc/cron.daily/logrotate /etc/cron.hourly/logrotate sudo sed -i -r <span class="hljs-string"><span class="hljs-string">"s/^[[:digit:]]*( .+cron.hourly)/0\1/"</span></span> /etc/crontab</code> </pre> <br><p>  Config (file myservice) must be put in the logrotate folder </p><br><pre> <code class="hljs lua">sudo cp <span class="hljs-built_in"><span class="hljs-built_in">config</span></span>/logrotate/myservice /etc/logrotate.d/myservice</code> </pre> <br><p>  important points: </p><br><ul><li>  the config should be copied exactly, simlinks will not work </li><li>  in principle, the config is almost taken from the docks by logrotate, but it is very important to put the <code>copytruncate</code> directive </li><li>  (added from <a href="https://habrahabr.ru/users/rusnasonov/" class="user_link">rusnasonov</a> comment) logrotate is stupid and uses the simplest rotation system, without buffers.  The rotation takes place in two steps - the old file is first copied, and then it is cut off at the old place.  This <em>can lead to loss of logs</em> that were recorded in between (as <a href="https://linux.die.net/man/8/logrotate">reflected in the documentation</a> ) </li></ul><br><p>  copytruncate is important because the file will not be closed when rotated.  Since we rotate the file on a live system, the file is open and the services that write to it, do it on some file descriptor.  If you just move the file and create a new one, it will not be used.  copytruncate says that you need to copy the contents, and then clear the file, but not close it. </p><br><h3 id="servisy">  Services </h3><br><p>  How do you run your app?  There are a lot of different ways.  According to my observations, the main ones are: </p><br><ul><li>  we launch screen / tmux and inside we launch an interactive script </li><li>  "-D" daemon mode for gunicorn or celery </li><li>  supervisord </li><li>  init.d script </li><li>  Docker </li></ul><br><p>  All of them have their advantages, but, in my opinion, they have even more disadvantages. </p><br><p>  I will not consider Docker here.  First, I don't have much experience with it.  And secondly, if you use containers, then you and the rest of the tips in this article are not very necessary.  There is another approach. </p><br><p>  I believe that if the system provides us with a convenient tool, then why not use it. </p><br><p>  In Ubuntu, starting from version 15.04, systemd is supplied by default to manage services (and not only). </p><br><p>  systemd is very convenient because it does everything right: </p><br><ul><li>  runs the application under the desired user and sets the environment variables, if necessary </li><li>  when the application suddenly stops - restarts its specified number of times </li><li>  very flexible and allows you to customize dependencies and launch order </li></ul><br><p>  Of course, if you do not have systemd, then you can look towards the supervisord, but I have a rather big dislike for this tool and I avoid using it. <br>  I hope there will be no people who will doubt that in the presence of systemd it is harmful to use supervisord. </p><br><p>  Below I will give an example of the config to run. </p><br><p>  Run gunicorn (proxied through local nginx, but this is not important here). </p><br><pre> <code class="hljs ruby">[Unit] Description=My Web service Documentation= StartLimitIntervalSec=<span class="hljs-number"><span class="hljs-number">11</span></span> [Service] Type=simple Environment=DJANGO_SETTINGS_MODULE=myservice.settings.production ExecStart=<span class="hljs-regexp"><span class="hljs-regexp">/opt/venv</span></span><span class="hljs-regexp"><span class="hljs-regexp">/bin/python</span></span>3 -W ignore /opt/venv/bin/gunicorn -c /opt/myservice/config/gunicorn/gunicorn.conf.py --chdir /opt/myservice myservice.<span class="hljs-symbol"><span class="hljs-symbol">wsgi:</span></span>application Restart=always RestartSec=<span class="hljs-number"><span class="hljs-number">2</span></span> StartLimitBurst=<span class="hljs-number"><span class="hljs-number">5</span></span> User=myuser Group=myuser ExecStop=<span class="hljs-regexp"><span class="hljs-regexp">/bin/kill</span></span> -s TERM $MAINPID WorkingDirectory=<span class="hljs-regexp"><span class="hljs-regexp">/opt/myservice</span></span> ReadWriteDirectories=<span class="hljs-regexp"><span class="hljs-regexp">/opt/myservice</span></span> [Install] WantedBy=multi-user.target Alias=my-web.service</code> </pre> <br><p>  Here it is important not to use the demonization mode.  We start gunicorn with a normal process, and systemd demonizes it itself, it also monitors the restart when it crashes. </p><br><p>  Please note that we use the path to python and gunicorn relative to the virtualenv folder. </p><br><p>  For celery, everything will be the same, but I recommend the start line (put your own paths and values): </p><br><pre> <code class="hljs ruby">ExecStart=<span class="hljs-regexp"><span class="hljs-regexp">/opt/venv</span></span><span class="hljs-regexp"><span class="hljs-regexp">/bin/celery</span></span> worker -A myservice.settings.celery_settings -Ofair --concurrency=<span class="hljs-number"><span class="hljs-number">3</span></span> --queues=celery --logfile=<span class="hljs-regexp"><span class="hljs-regexp">/var/log</span></span><span class="hljs-regexp"><span class="hljs-regexp">/myservice/celery</span></span>.log --max-tasks-per-child <span class="hljs-number"><span class="hljs-number">1</span></span> --pidfile=<span class="hljs-regexp"><span class="hljs-regexp">/tmp/celery</span></span>_myservice.pid -n main.%h -l INFO -B</code> </pre> <br><p>  It is worth paying attention to the parameters for restarting: </p><br><pre> <code class="hljs">StartLimitIntervalSec=11 RestartSec=2 StartLimitBurst=5</code> </pre> <br><p>  In short, this means the following: if the service is down, then start it again after 2 seconds, but no more than 5 times in 11 seconds.  It is important to understand that if the value in StartLimitIntervalSec is, for example, 9 seconds, then if the service stops 5 times in a row (immediately after launch), then after the fifth fall, systemd will give up and will not raise it anymore (2 * 5).  The value 11 is chosen precisely in order to exclude such variations.  If, for example, you had a network failure for 15 seconds and the application crashes immediately after the start (without a timeout), then let it be better to hammer to the victorious than it just stops. </p><br><p>  To install this config into the system, you can simply make a symlink from the working folder: </p><br><pre> <code class="hljs coffeescript">~~sudo ln -s <span class="hljs-regexp"><span class="hljs-regexp">/opt/myservice/config/systemd/</span></span>*.service <span class="hljs-regexp"><span class="hljs-regexp">/etc/systemd/system/</span></span>~~ sudo systemctl daemon-reload</code> </pre> <br><p><del>  However, you need to be careful with the symlinks - if your project is not on the system disk, then there is a possibility that it can be mounted after the start of services (for example, a network disk or memory-mapped).  In this case, it simply will not start.  Here you will have to google how to properly configure dependencies, and indeed the config file is then best copied to the systemd folder. </del><br>  Update: after the <a href="https://habrahabr.ru/users/andreymal/" class="user_link">Andreymal</a> remark <a href="https://habrahabr.ru/users/andreymal/" class="user_link">,</a> I think that it would be more correct to copy the configs to a folder and set them the correct rights: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sudo</span></span> chown root: /opt/myservice/config/systemd/<span class="hljs-regexp"><span class="hljs-regexp">*.service</span></span> sudo chmod <span class="hljs-number"><span class="hljs-number">770</span></span> /opt/myservice/config/systemd/<span class="hljs-regexp"><span class="hljs-regexp">*.service</span></span> sudo cp /opt/myservice/config/systemd/<span class="hljs-regexp"><span class="hljs-regexp">*.service</span></span> /etc/systemd/system/ sudo systemctl daemon-reload</code> </pre> <br><p>  I also advise you to disable the output to the console, otherwise everything will fall into the syslog. </p><br><p>  When you have all the components in systemd, then using each of them comes down to: </p><br><pre> <code class="hljs sql">sudo systemctl <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> my-web.service sudo systemctl <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> my-celery.service sudo systemctl <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> my-web.service sudo systemctl <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> my-celery.service</code> </pre> <br><p>  When there are more than one component, it makes sense to write a <a href="https://gist.github.com/ba1dr/880518177d1260e720f5e30dfbe36fab">script</a> for mass management of the entire farm on the server. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">bash</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">manage</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.sh</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">migrate</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bash</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">manage</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.sh</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">start</span></span></code> </pre> <br><p>  For remote debugging via the console (run shell_plus from django-extensions): </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">bash</span></span> manage.sh <span class="hljs-literal"><span class="hljs-literal">debug</span></span></code> </pre> <br><p>  If you have more than one server, then, of course, you already use your own scripts for deployment, this is just an example. </p><br><h3 id="lokalnye-nastroyki">  Local settings </h3><br><p>  This is a topic for holivar and I want to note that this paragraph is exclusively my point of view, which is based on my experience.  Do what you want, I just advise. </p><br><p>  The essence of the problem is that no matter how you write the application, it will most likely have to deal with data that is stored somewhere.  List of users, the path to the keys, passwords, the path to the database, and so on ... All these settings can not be stored in the repository.  Someone keeps, but this is a vicious practice.  Insecure and inflexible. </p><br><p>  What are the most frequent ways to store such settings and what are the problems with them: </p><br><ul><li>  file local_settings.py, which is stored in the project folder next to the default setting.py <br>  Problem: you can accidentally commit a file, you can wipe it when copying / updating a folder (rsync or archive) </li><li>  environment variables.  Also not very safe, not very convenient (for example, when soft-reload) </li><li>  separate file outside the project folder </li></ul><br><p>  I recommend this method.  Usually I create a yaml file for the project in the folder "/ usr / local / etc /".  I have written a <a href="https://github.com/ba1dr/tplgenerator/blob/master/templates/django/__APPNAME__/apps/utils/dynsettings.py">small module</a> that using <del>  the magic </del>  Hacks loads variables from a file into the <code>locals()</code> or <code>globals()</code> importing module. </p><br><p>  It is used very simply.  Somewhere in the depths of settings.py for Django (better towards the end), just call: </p><br><pre> <code class="hljs lisp">import_settings(<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/myservice.yaml"</span></span>)</code> </pre> <br><p>  And all the content will be mixed into global settings.  I use merge for lists and dictionaries, it may not be convenient for everyone.  It is important to remember that Django imports only UPPERCASE constants, that is, in the first level settings file you should immediately be in upper case. </p><br><p>  That's all folks! </p><br><p>  The rest is discussed in the comments. </p><br><p><img src="https://habrastorage.org/files/219/9c7/24d/2199c724dd3f4ff5b60747eb1252a285.png"></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/351566/">https://habr.com/ru/post/351566/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351554/index.html">Microsoft Announces DirectX Raytracing Ray Tracing API</a></li>
<li><a href="../351556/index.html">We implement our operator in the Entity Framework Core</a></li>
<li><a href="../351558/index.html">Jessica Livingston (Y Combinator): ‚ÄúThe Sound of Silence‚Äù</a></li>
<li><a href="../351562/index.html">From patches in the fight against malware to a holistic strategy</a></li>
<li><a href="../351564/index.html">Wireless LANs or how Wi-Fi works according to IEEE 802.11 standard. Lab at Packet Tracer</a></li>
<li><a href="../351568/index.html">Minimal multiboot bootloader</a></li>
<li><a href="../351570/index.html">Rust: try overloading functions</a></li>
<li><a href="../351572/index.html">CleanTalk Malware Scanner - Heuristic Code Analysis</a></li>
<li><a href="../351574/index.html">Convert IP range to Classless Addressing (CIDR) and back to Go</a></li>
<li><a href="../351576/index.html">13 reasons to switch to Kanban. And no superstition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>