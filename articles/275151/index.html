<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Weak links in PHP 7</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A weak link is a mechanism that allows you to refer to an object, while not prohibiting the garbage collector from deleting an object in programming l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Weak links in PHP 7</h1><div class="post__text post__text-html js-mediator-article">  <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BB%25D0%25B0%25D0%25B1%25D0%25B0%25D1%258F_%25D1%2581%25D1%2581%25D1%258B%25D0%25BB%25D0%25BA%25D0%25B0">A weak link</a> is a mechanism that allows you to refer to an object, while not prohibiting the garbage collector from deleting an object in programming languages ‚Äã‚Äãwith automatic garbage collection. <br><br>  In the first approximation, a weak link indicates that we need an object, of course, but if there is a need, we can delete it as well, we can manage it somehow. <br><br>  Initially, the concept of weak links is missing in PHP, but it is fairly easy to fix.  The following discussion focuses on PHP 7. <br><a name="habracut"></a><br>  It should be noted separately that the solution below only works for objects and this is due to the peculiarity of the work of the garbage collector in PHP. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Recommended for preliminary reading </h4><br><ul><li>  <a href="http://habrahabr.ru/company/mailru/blog/257999/">Internal representation of values ‚Äã‚Äãin PHP 7 (part 1)</a> </li><li>  <a href="http://habrahabr.ru/company/mailru/blog/261131/">Internal representation of values ‚Äã‚Äãin PHP 7 (part 2)</a> </li><li>  <a href="http://blog.ircmaxell.com/2014/12/what-about-garbage.html">What About Garbage?</a>  (eng.) </li></ul><br><h1>  Object Handlers </h1><br>  In PHP, functions for handling various events (operations) on an object are represented by a table of handlers with the structure <a href="">zend_object_handlers</a> . <br><br>  Internal classes can define and redefine object handlers, thus changing the behavior during various typical operations, for example, cloning, comparing, accessing properties of an object, receiving debug information, etc.  A complete list of possible operations for which a handler can be specified is available by reference to the <i>zend_object_handlers</i> structures above. <br><br>  User classes that do not inherit the inner classes get default handlers stored in the variable <a href="">std_object_handlers</a> . <br><br><h1>  Garbage collection </h1><br>  The topic of garbage collection in PHP is discussed in some detail, including in the <a href="http://php.net/manual/ru/features.gc.php">official documentation</a> and is not the subject of this article. <br><br>  In short, the value is to be assembled as soon as the reference counter does not become equal to 0. In normal mode, the destructor is called upon the object during the assembly and then the memory occupied by the object is cleared.  Internally, the handlers <i>dtor_obj</i> and <i>free_obj</i> are responsible for this, respectively. <br><br>  Internally, the implementation of the standard destructor is the <a href="">zend_objects_destroy_object</a> function <a href="">, the</a> essence of which is to call the <i>__destruct ()</i> method, if any. <br><br>  If an exception is thrown or the language construct is called <a href="http://php.net/manual/ru/function.exit.php">exit</a> (or its synonym is <a href="http://php.net/manual/ru/function.die.php">die</a> ), the object's destructor is not called, for example: <br><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Test</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__destruct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'Goodbye Cruel World!'</span></span>, PHP_EOL; } } $test = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Test(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Test exception'</span></span>);</code> </pre> <br>  that will bring <br><br><pre> <code class="bash hljs"> $ php test.php Fatal error: Uncaught Exception: Test exception <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /home/vagrant/Development/php-weak/test.php on line 13 Exception: Test exception <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /home/vagrant/Development/php-weak/test.php on line 13 Call Stack: 0.0011 365968 1. {main}() /home/vagrant/Development/php-weak/test.php:0</code> </pre><br><h1>  Object storage </h1><br>  In order to more fully understand the possible pitfalls in the implementation of weak links, consider where and how all objects are stored in PHP, fortunately, it is very simple - in <a href="">EG (objects_store) .object_buckets</a> which is an array where the key is <a href="">Z_OBJ_HANDLE (zval)</a> - integer index of the object, hereinafter referred to as an object handle.  At each moment of time it is unique for each object, when deleting an object from <i>EG (objects_store) .object_buckets, the</i> value of the object descriptor can be assigned to another object, for example: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $obj1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> stdClass(); $obj2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> stdClass(); debug_zval_dump($obj1); debug_zval_dump($obj2); $obj2 = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">//      EG(objects_store).object_buckets       $obj2 = new SplObjectStorage(); debug_zval_dump($obj2);</span></span></code> </pre><br>  what if given <br><br><pre> <code class="bash hljs">object(stdClass)<span class="hljs-comment"><span class="hljs-comment">#1 (0) refcount(2){ } object(stdClass)#2 (0) refcount(2){ } object(SplObjectStorage)#2 (1) refcount(2){ ["storage":"SplObjectStorage":private]=&gt; array(0) refcount(1){ } }</span></span></code> </pre><br>  The value after the hash symbol (#) is the same object descriptor value.  As you can see, the value of descriptor 2 was reused. <br><br><h1>  Implementation of weak links </h1><br>  Based on the foregoing, a very obvious solution to the implementation of weak references is to wrap the object's destructor to which we refer and add our own logic after the initial destructor is executed.  The pinnacle of mastery would of course be to make weak references at the level of the interpreter itself, however, that is another story. <br><br>  The pointer to the object's handler table has the <a href="">const</a> specifier, to which the standard C90 and <a href="http://c0x.coding-guidelines.com/6.7.3.html">C99</a> say that changing this value by casting to a <b>non-</b> constant type will result in undefined behavior. <br><br><div class="spoiler">  <b class="spoiler_title">References for changing const values</b> <div class="spoiler_text"><ul><li>  <a href="https://www.securecoding.cert.org/confluence/display/c/EXP40-C.%2BDo%2Bnot%2Bmodify%2Bconstant%2Bobjects">EXP40-C.</a>  <a href="https://www.securecoding.cert.org/confluence/display/c/EXP40-C.%2BDo%2Bnot%2Bmodify%2Bconstant%2Bobjects">Do not modify constant objects</a> </li><li>  <a href="http://stackoverflow.com/a/771114/1461984">Changing the value of a const pointer</a> </li></ul></div></div><br>  This is done for a reason.  By changing the value of a single object handler, we change the handler for all objects of a given class, and moreover, subclass handlers, if they are not redefined, and in the case of a custom class object (which is not a descendant of an internal), for all objects created from custom classes. <br><br>  The best solution would be to replace the pointer to the table of the handlers of a single object by copying the original table and replacing the handler we need - <i>dtor_obj</i> .  The abbreviated entry is as follows: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">php_weak_referent_t</span></span> *referent = (<span class="hljs-keyword"><span class="hljs-keyword">php_weak_referent_t</span></span> *) ecalloc(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">php_weak_referent_t</span></span>)); <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(&amp;referent-&gt;custom_handlers, referent-&gt;original_handlers, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(zend_object_handlers)); referent-&gt;custom_handlers.dtor_obj = php_weak_referent_object_dtor_obj; Z_OBJ_P(referent_zv)-&gt;handlers = &amp;referent-&gt;custom_handlers;</code> </pre><br><h2>  Obstacles </h2><br>  The testing process revealed a rather unpleasant fact - changes in the pointer value of the handler table affected the PHP result of the <a href="http://php.net/manual/ru/function.spl-object-hash.php">spl_object_hash ()</a> function, which uses the pointer values ‚Äã‚Äãto the handler table to generate the last 16 characters of id (the first 16 are the object descriptor hash) and, as a result, the return value of the object id will differ before and after creating a weak link for it: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $obj = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> stdClass(); var_dump(spl_object_hash($obj)); <span class="hljs-comment"><span class="hljs-comment">// 0000000046d2e51 a000000003e3e4a43 $ref = new Weak\Reference($obj); var_dump(spl_object_hash($obj)); // 0000000046d2e51 a00007fc62b682d1b</span></span></code> </pre><br>  It can be considered a positive fact that once it has changed, the hash will no longer change (at least this extension). <br><br>  But we will go further.  Through discussions with PHP developers, an idea appeared ... <a href="https://github.com/php/php-src/pull/1724">not to use the pointer value to the table of handlers when generating a hash</a> , since even its first part satisfies the condition of uniqueness for an object hash during its entire life.  The second part <i>now</i> uses just an arbitrary value that was previously used as a mask: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Test</span></span></span><span class="hljs-class"> </span></span>{} <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">X</span></span></span><span class="hljs-class"> </span></span>{} $t = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Test(); $x = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> X(); $s = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SplObjectStorage(); var_dump(spl_object_hash($t)); <span class="hljs-comment"><span class="hljs-comment">// 00000000054acbeb 0000000050eaeb6f var_dump(spl_object_hash($x)); // 00000000054acbe8 0000000050eaeb6f var_dump(spl_object_hash($s)); // 00000000054acbe9 0000000050eaeb6f</span></span></code> </pre><br>  So much better!  This improvement will most likely be available in PHP version&gt; 7.0.2. <br><br>  But it will be only after PHP 7.0.2, and we need to work globally and reliably on earlier versions of PHP 7 as well. <br><br>  Not very beautiful, but a very working way is ... <i>replacing the spl_object_hash ()</i> function with <i>your</i> own implementation: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $spl_hash_function = $EG-&gt;function_table[<span class="hljs-string"><span class="hljs-string">'spl_object_hash'</span></span>]; $custom_hash_function = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(object $obj)</span></span></span><span class="hljs-function"> </span></span>{ $hash = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (weak\refcounted($obj)) { $referent = execute_referent_object_metadata($obj); $obj-&gt;handlers = $referent-&gt;original_handlers; $hash = $spl_hash_function($obj); $obj-&gt;handlers = $referent-&gt;custom_handlers; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> == $hash) { $hash = $spl_hash_function($obj); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $hash; }; $EG-&gt;function_table[<span class="hljs-string"><span class="hljs-string">'spl_object_hash'</span></span>] = $custom_hash_function;</code> </pre><br>  The author of this <a href="https://github.com/colder/php-weakref/commit/2700a032a8f5236408ca9d98407faded88060f17">substitution method</a> is <a href="https://github.com/colder">Etienne Kneuss</a> , the author of the original implementation of weak links in PHP 5 as an extension of <a href="https://github.com/colder/php-weakref">php-weakref</a> .  Unfortunately, I didn‚Äôt wait just a couple of hours before he also implemented support for PHP 7. However, two working extensions are better than none, and at the moment we have a rather different functionality and concept. <br><br><h2>  Notification mechanism for the destruction of the object </h2><br>  When creating a weak link, the mechanism of notification that the object we are referring to was destroyed is rather important to us.  Conceptually, this problem can be solved by polling the weakest link, by storing the weak link into an array, as is done in the implementation of <a href="https://docs.oracle.com/javase/7/docs/api/java/lang/ref/WeakReference.html">WeakReference</a> in Java;  and, what <a href="https://docs.python.org/3.5/library/weakref.html">exactly</a> is of gastronomic interest, the call of a user function, as is done in the implementation of <a href="https://docs.python.org/3.5/library/weakref.html">weakref.ref</a> in the Python language. <br><br>  To do this, after calling the source object's destructor, we call for each weak reference a user-defined function if such was specified when creating a weak reference, or save each weak reference object to an array if it was specified.  It should be noted separately that if an exception is thrown in the destructor or in one of the user-notifier functions, no further notifier functions will be called.  Simplified, the mechanism for notifying the destruction of an object through a call to user-defined functions can be represented as an extension of the base class of an object with a destructor override, where after calling the parent destructor, user functions are called one after the other, from the latest to the very first. <br><br>  As a result, our destructor wrapper can be represented as a meta code: <br><br><pre> <code class="php hljs">run_original_dtor_obj($object); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($weak_references <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $weak_ref_object_handle =&gt; $weak_reference) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_array($weak_reference-&gt;notifier)) { $weak_reference-&gt;notifier[] = $weak_reference; } <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> (is_callable($weak_reference-&gt;notifier) &amp;&amp; $no_exception_thrown) { $weak_reference-&gt;notifier($weak_reference); } <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>($weak_references[$weak_ref_object_handle]); }</code> </pre><br>  The weak link class itself has the following form: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Weak</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reference</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> object $referent     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> callable | array | null $notify        * *     ,         . *                 . *            *  -  . * *    ,         , , *    ,         *  -  . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(object $referent, $notify = null)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-comment"><span class="hljs-comment">/** *     .       null. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> object | null */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-comment"><span class="hljs-comment">/** *       :     . * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">valid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-comment"><span class="hljs-comment">/** *   * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> callable | array | null $notify  .  ,  . * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> callable | array | null    ,        */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifier</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($notify = null)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre><br>  For more information on values ‚Äã‚Äãand objects, this extension provides a number of functions that complement the functionality of the weak reference class and allow you <s>to refuse to</s> create various solutions at the user level in no way. <br><br><div class="spoiler">  <b class="spoiler_title">Listing extension functions</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Weak</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * ,        . * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> mixed $value * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">refcounted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mixed $value)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-comment"><span class="hljs-comment">/** *       .       0. * *             ,  *   weak\refcount(new stdClass())  0,           *  . * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> mixed $value * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> int */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">refcount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mixed $value)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-comment"><span class="hljs-comment">/** * ,         . * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> object $value * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">weakrefcounted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(object $value)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-comment"><span class="hljs-comment">/** *      .      0. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> object $value * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> int */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">weakrefcount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(object $value)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-comment"><span class="hljs-comment">/** *      .       . * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> object $value * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">weakrefs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(object $value)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-comment"><span class="hljs-comment">/** *    . * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> object $value * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> int */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">object_handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(object $value)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{}</code> </pre><br>  These functions are quite specific and should <s>never</s> be used only in cases where the user understands what and why he does. <br></div></div><br><h1>  Practical use </h1><br>  This extension provides the above functionality was the result of work on another extension - integration of the <a href="https://ru.wikipedia.org/wiki/V8_%2528%25D0%25B4%25D0%25B2%25D0%25B8%25D0%25B6%25D0%25BE%25D0%25BA_JavaScript%2529">v8 JavaScript engine</a> in PHP (not v8js, simpler and more powerful, at the moment the source code is not publicly available). <br><br>  When writing an abstraction layer for translating php objects into js objects, it became necessary to unambiguously match and, most importantly, clean the correspondence table of php objects and js representations.  A typical problem is that in different places a situation arises when the same php object is returned to js for which there is already a js view, and in order to have identical views inside the js, you need to store a correspondence table. <br><br>  Initially, a table of correspondence between the id php of the object and the js representation itself was compiled, but as the work progressed, there was a situation when there was a surplus of orphaned js representations: the corresponding php objects were deleted by the garbage collector, since no one referred to them.  The notification mechanism, which is implemented along with weak links, will completely solve this problem. <br><br>  For people not suffering from the symptoms described above and leading a healthy nocturnal lifestyle, this extension may be useful for the following: <br><ul><li>  Implementing caching of objects in runtime. </li><li>  Binding data to an object, for example, adding properties and methods in situations where inheritance and / or composition are not very suitable (hello, Java). </li><li>  deleting the appropriate event listeners after the object has been deleted. </li></ul><br>  I suggest in the comments will share possible ways to use weak links in PHP. <br><br>  For our own needs, we created an implementation of the <a href="https://docs.oracle.com/javase/7/docs/api/java/util/WeakHashMap.html">WeakMap</a> data structure based on <a href="http://php.net/manual/en/class.splobjectstorage.php">SplObjectStorage</a> - <a href="https://github.com/pinepain/php-weak-lib">Weak \ SplObjectStorage</a> <br><br>  The extension is available at <a href="https://github.com/pinepain/php-weak">github.com/pinepain/php-weak</a> and is distributed under the <a href="https://ru.wikipedia.org/wiki/%25D0%259B%25D0%25B8%25D1%2586%25D0%25B5%25D0%25BD%25D0%25B7%25D0%25B8%25D1%258F_MIT">MIT license</a> .  It requires PHP 7 to work. </div><p>Source: <a href="https://habr.com/ru/post/275151/">https://habr.com/ru/post/275151/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275135/index.html">Why am I writing C games (yes, C)</a></li>
<li><a href="../275137/index.html">Serious CVE-2016-0777 vulnerability detected in OpenSSH client</a></li>
<li><a href="../275139/index.html">Collect the best of two worlds - frameworks and CMS (part 3)</a></li>
<li><a href="../275141/index.html">Measuring the weight of minerals in the mining industry. Theoretical basis</a></li>
<li><a href="../275145/index.html">About React Native</a></li>
<li><a href="../275153/index.html">DeepHack.Q & A Starts - International Hackathon for Deep Learning and Machine Intelligence</a></li>
<li><a href="../275155/index.html">HotSpot using Cisco WLC5508, FreeRadius, MySQL and Easyhotspot</a></li>
<li><a href="../275157/index.html">Rust 1.5: Cargo with blackjack</a></li>
<li><a href="../275159/index.html">Resist adding new libraries to your project.</a></li>
<li><a href="../275161/index.html">Hacking bank cards, cars and instant messengers and other features of education at the best magistracy in the Netherlands</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>