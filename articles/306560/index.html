<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cloud storage: new API functions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, we talked about the transition to a new platform , thanks to which we were able to improve the work of cloud storage. We described in detail...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cloud storage: new API functions</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/0a8/a0b/be6/0a8a0bbe6b664ee1929229d5625fdcab.png"><br><br>  Recently, we talked about the <a href="https://habrahabr.ru/company/selectel/blog/304032/">transition to a new platform</a> , thanks to which we were able to improve the work of cloud storage.  We described in detail how we refined the logic and architecture of the repository and rewrote some of the components on Go, so that everything began to work much faster and more stable than before. <br><br>  At the same time, we‚Äôve told far from everything: during the work on the API, we launched several new features that we hope will be useful for you. <br><a name="habracut"></a><br><h2>  Authentication </h2><br>  Our repository fully supports the <a href="http://developer.openstack.org/api-ref-objectstorage-v1.html">OpenStack Swift API</a> , for which there are many third-party clients. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For compatibility with these clients, support for Swift v1 authentication has been implemented, and Keystone v2 and v3 authentication options have been limitedly implemented.  Thus, three methods of authentication are now available in our API. <br>  The first is almost the same as what was used before (only the authorization URI has changed to better conform to the standard): <br><br><pre><code class="bash hljs">$ curl -i https://api.selcdn.ru/auth/v1.0 -H <span class="hljs-string"><span class="hljs-string">"X-Auth-User:[ ]"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Key:[]</span></span></code> </pre> <br><br>  In the second method (Keystone v2 type authentication), a POST request is used, not a GET;  The username and password are passed in the JSON array: <br><br><pre> <code class="bash hljs">$ curl -i -X POST https://api.selcdn.ru/v2.0/tokens -H <span class="hljs-string"><span class="hljs-string">'Content-type: application/json'</span></span> -d <span class="hljs-string"><span class="hljs-string">'{"auth": {"passwordCredentials": {"username": [ ], "password": []}}}'</span></span></code> </pre><br><br>  The response to such an API request will also be returned in JSON format. <br><br>  Authentication according to Keysone v3 looks like this: <br><br><pre> <code class="bash hljs">$ curl -i https://api.selcdn.ru/v3/auth/tokens -XPOST -d <span class="hljs-string"><span class="hljs-string">'{"auth": { "identity": { "methods": ["password"], "password": { "user": { "id": [ ], "password": []}}}}}'</span></span></code> </pre><br><br>  We draw your attention to the fact that the Keystone API in the repository is not fully implemented: only login and password authentication functions work.  No extensions of the Keystone protocol are supported by us. <br><br>  The base address of the repository has also changed.  Now it looks like this: <a href="http://api.selcdn.ru/v1/SEL_XXX">api.selcdn.ru/v1/SEL_XXX</a> (instead of XXX, you must, of course, substitute the user ID). <br><br>  Another change related to the authentication system is a new mechanism for temporary tokens.  Now it is possible to generate additional tokens with a limited validity period, providing access only to a strictly defined container.  Something that reminds <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp_request.html" rel="nofollow">Security Service in Amazon S3</a> : <br><br><pre> <code class="bash hljs">$ curl -i -X GET https://api.selcdn.ru/v1/temptokens -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Token: [  ]"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-Container:[]"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-ExpireAfter: 8600"</span></span></code> </pre><br><br>  The valid token of the main user is transferred in the X-Auth-Token header, the container for which the token will be valid is indicated in the X-Container, and the duration of this token in seconds is indicated in the X-Expire-After. <br><br><h2>  Work with files </h2><br>  The new API expanded file handling capabilities.  So, archives in tar, .tar.gz, gzip formats can be unpacked in the background after the file has been completely downloaded to the storage.  The previous version of unpacking suggested unpacking archives on the fly, i.e.  it was necessary to maintain a connection with our servers until the requests to create all the files from the downloaded archive are executed.  And when the connection was broken, you had to download everything again. <br><br>  Now everything is much easier.  If, for example, you need to upload an archive containing several thousand files to the repository, this can be done using a PUT request to the container address with the optional query parameter extract-archive-v2.  After the archive has been completely sent, code 201 is immediately given and background unpacking is started on the storage side: <br><br><pre> <code class="bash hljs">curl -i -X PUT https://api.selcdn.ru/v1/SEL_XXX/[ ]/?extract-archive-v2=tar.bz2 -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Token: []"</span></span> -T <span class="hljs-string"><span class="hljs-string">"photos.tar.bz2"</span></span> HTTP/1.1 100 Continue HTTP/1.1 201 Created Access-Control-Expose-Headers: X-Backend-Timestamp, Etag, Last-Modified, X-Object-Manifest, X-Timestamp Content-Length: 0 Content-Type: text/html Etag: a1adb438cb26e91228870158a2062ef2 Extract-Id: 6a62579d-9ee2-2a32-26a4-207d5a47af2a</code> </pre><br><br>  Notice the Extract-Id header present in the response.  With its help you can find out at what stage the unpacking operation is: <br><br><pre> <code class="bash hljs">$ curl -i https://api.selcdn.ru/v1/extract-archive/[Extract-Id] -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Token: []"</span></span> HTTP/1.1 200 OK Number Files Created: 1185 Response Body: Response Status: 201 Created Errors:</code> </pre><br><br>  In our case, the response with code 200 indicates that the unpack operation was completed successfully.  The Number Files Created parameter indicates the number of files extracted from the archive. <br><br><h2>  New features </h2><br>  Many new features have appeared in the API, in particular, the management of users, domains, certificates and working with CDNs.  We will tell about them in more detail below. <br><br><h3>  user management </h3><br>  Previously, adding and deleting additional users was possible only through the control panel.  Now it can be done through standard HTTP requests to the API. <br><br>  You can view the list of users as follows: <br><br><pre> <code class="bash hljs">$ curl -i -XGET https://api.selcd.ru/v1/users[?format=json] -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Token: []"</span></span></code> </pre><br><br>  Creating a new user is carried out using the query: <br><br><pre> <code class="bash hljs">$ curl -i -XPUT https://api.selcd.ru/v1/users/new_user -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Token: []"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Key: 123456"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-User-ACL-Containers-W: container1, container2, container3"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-User-ACL-Containers-R: container4"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-User-Store-Password: yes"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-User-Active: on"</span></span></code> </pre><br><br>  We have already received requests to expand rights management for users.  We have fulfilled these requests, and this can be seen from the example of the request just cited: pay attention to the X-User-ACL-Containers-W and X-User-ACL-Containers-R headers.  The first indicates the containers in which the new user can write information, and the second indicates the containers, access to which will be opened only for reading. <br><br>  The X-Auth-Key header indicates the password of the user being created.  X-User-Store-Password is equivalent to the ‚ÄúStore password on Selectel servers‚Äù option in the control panel.  The X-User-Active header with a value of on indicates that the new user will be active. <br><br>  You can change the data of an already created user like this: <br><br><pre> <code class="bash hljs">$ curl -i -XPOST https://api.selcd.ru/v1/users/new_user -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Token: []"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Key: 123456"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-User-ACL-Containers-W: container1, container4"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-User-ACL-Containers-R: container4"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-User-Store-Password: yes"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-User-Active: on"</span></span></code> </pre><br><br>  Deleting a user is done using a DELETE request: <br><br><pre> <code class="bash hljs">$ curl -i -XDELETE https://selcdn.ru/users/[ ] -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Token: []"</span></span></code> </pre><br><br>  For the primary user, only the password can be changed.  This is done using a POST request with an X-Auth-Key <a href="https://api.selcd.ru/v1/users/">header sent to api.selcd.ru/v1/users</a> [primary user name]. <br><br><h3>  Domain Management </h3><br>  Previously, it was also possible to work with domains exclusively through a graphical interface.  Now all operations can be performed through the API. <br><br>  So, for example, you can view a list of all domains associated with containers: <br><br><pre> <code class="bash hljs">$ curl -i https://api.selcdn.ru/v1/domains -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Token: []"</span></span></code> </pre><br><br>  You can attach a domain using a POST request to the corresponding container with the X-Add-Container-Domains header: <br><br><pre> <code class="bash hljs">$ curl -i https://api.selcdn.ru/v1/SEL_XXX/{container_name} -XPOST -H <span class="hljs-string"><span class="hljs-string">"X-Add-Container-Domains: domain1.ru"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Token: []"</span></span></code> </pre><br><br>  To delete a domain, a similar request is used, only the domain name is passed in the X-Remove-Container-Domains header: <br><br><pre> <code class="bash hljs">$ curl -i https://api.selcdn.ru/v1/SEL_XXX/{container_name} -XPOST -H <span class="hljs-string"><span class="hljs-string">"X-Remove-Container-Domains: domain1.ru"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Token: []"</span></span></code> </pre><br><br>  To completely change the list of domains linked to the container, you need to perform a POST request to the address of this container and pass the updated list in the X-Container-Domains header: <br><br><pre> <code class="bash hljs">$ curl -i https://api.selcdn.ru/SEL_XXX/[ ] -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Token: []"</span></span> -XPOST -H <span class="hljs-string"><span class="hljs-string">"X-ontainer-Domains: domain1.ru domain2.ru"</span></span></code> </pre><br><br>  If several domains are attached to the container and they need to be deleted, then in the X-Container-Domains header you can simply pass the number 0: <br><br><pre> <code class="bash hljs">$ curl -i https://.selcdn.ru/[ ] -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Token: []"</span></span> -XPOST -H <span class="hljs-string"><span class="hljs-string">"X-ontainer-Domains: 0"</span></span></code> </pre><br><h2>  Request logs </h2><br>  Through the API, you can request logs of network access to user containers for a specified period: <br><br><pre> <code class="bash hljs">$ curl -i -XPOST https://api.selcdn.ru/v1/logs -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Token: []"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-Start-Time: 2016-02-02 09:00:00"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-End-Time: 2016-05-02 12:00:00"</span></span> -H <span class="hljs-string"><span class="hljs-string">"X-Limit: 10000"</span></span></code> </pre><br><br>  The headings X-Start-Time and X-End-Time, as it is not difficult to guess, indicate the beginning and end of the period. <br><br>  The optional X-Limit header indicates the maximum number of log entries that will be issued in this request (by default, you will receive all the logs for the specified time interval). <br><br>  Upon completion of the sample, a private logs container will be automatically created in the storage, where the logs will be placed. <br><br><h2>  SSL certificate management </h2><br>  Another new feature is the management of SSL certificates.  You can work with certificates both through a graphical interface and through an API. <br><br>  So, for example, you can view a list of all certificates attached to containers: <br><br><pre> <code class="bash hljs">$ curl -i https://api.selcdn.ru/v1/ssl -XGET -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Token: []"</span></span></code> </pre><br><br>  To view information about the certificate, use the following query: <br><br><pre> <code class="bash hljs">$ curl -i https://api.selcdn.ru/v1/ssl/{cert_name} -XGET -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Token: []"</span></span></code> </pre><br><br>  The request to add a certificate looks like this: <br><br><pre> <code class="bash hljs">$ curl -i https://api.selcdn.ru/v1/ssl/{cert_name} -XPUT -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Token: []"</span></span></code> </pre><br><br>  The certificate name ({cert_name}) is transmitted in the format 001_cert1, where the number is the user login and the second component is an arbitrary name.  Certificate names cannot duplicate each other.  The certificate itself and the private key are transmitted in the request body as a single file. <br><br>  To delete a certificate, you need to send a DELETE request of the form: <br><br><pre> <code class="bash hljs">$ curl -I https://api.selcdn.ru/v1/ssl/001_cert1 -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Token: []"</span></span> -XDELETE</code> </pre><br><br><h2>  Work with CDN </h2><br>  Appeared in the API and the ability to work with CDN.  You can send requests to clear the cache (previously this could be done only through a graphical interface), as well as view the status of the execution of these requests. <br><br>  Clearing the CDN cache is done using a PURGE query: <br><br><pre> <code class="bash hljs">$ curl -i -X PURGE https://api.selcdn.ru/v1/cdn -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Token: []"</span></span> -d <span class="hljs-string"><span class="hljs-string">'https://api.selcdn.ru/v1/SEL_XXX/container1/file1\nhttps://XXX.selcdn.ru/container1/file1'</span></span></code> </pre><br><br>  Now we use akamai ccu v3 with fast purge, and after sending such a request, the cache should be cleared for about 5 seconds.  The response to the request looks like this: <br><br><pre> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"estimatedSeconds"</span></span>: 5, <span class="hljs-string"><span class="hljs-string">"purgeId"</span></span>: <span class="hljs-string"><span class="hljs-string">"0bb4d6fa-4ce4-11e6-b75e-9fdde8cfe544"</span></span>, <span class="hljs-string"><span class="hljs-string">"supportId"</span></span>: <span class="hljs-string"><span class="hljs-string">"17PY1468845301403318-210404544"</span></span>, <span class="hljs-string"><span class="hljs-string">"httpStatus"</span></span>: 201, <span class="hljs-string"><span class="hljs-string">"detail"</span></span>: <span class="hljs-string"><span class="hljs-string">"Request accepted"</span></span>}</code> </pre><br><br><h2>  Conclusion </h2><br>  In this article, we talked about new cloud storage API features.  Soon work on improving the storage will continue.  And if you have your own wishes for improving and expanding the functionality - speak out in the comments to this post.  We will take note of the most interesting ideas and try to implement them. </div><p>Source: <a href="https://habr.com/ru/post/306560/">https://habr.com/ru/post/306560/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../306550/index.html">JavaScript in 2016: functional programming has come seriously and for a long time</a></li>
<li><a href="../306552/index.html">Features of application promotion in the CIS, in Western markets and in Asia</a></li>
<li><a href="../306554/index.html">How to optimize the game using polygonal atlases</a></li>
<li><a href="../306556/index.html">Bible movements doom. Part 1</a></li>
<li><a href="../306558/index.html">Is it beneficial for Apple to be an ally of Google in the fight for the online advertising market?</a></li>
<li><a href="../306562/index.html">The story ‚ÄúNIICHOSHI. Duty night "</a></li>
<li><a href="../306564/index.html">Ruby Ecosystem (on Rails) with a bitter aftertaste, or ‚ÄúHow we love to poke PHP‚Äù</a></li>
<li><a href="../306566/index.html">How we made the converter and player for CinemaDNG to CUDA</a></li>
<li><a href="../306568/index.html">Learning machines - fun stuff: modern face recognition with deep learning</a></li>
<li><a href="../306570/index.html">Low cost VDS hosting in Russia and its technical support</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>