<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cooking ORM, without departing from the plate</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is not a call for extremism in the development of bicycles. The purpose of a post is to understand the mechanism well, it is often necess...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cooking ORM, without departing from the plate</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/a49/9f5/447/a499f5447b56ad5c5c86afd417c811e1.jpg" alt="image"><br><br>  This article is not a call for <s>extremism in the</s> development of bicycles.  The purpose of a post is to understand the mechanism well, it is often necessary to create it from scratch.  This is especially true of such a shaky topic as ORM. <br><a name="habracut"></a><br><h3>  Why is this all? </h3><br>  Industrial products such as MS Entity Framework, NHibernate are complex, have great functionality and in fact are a separate thing in themselves.  Often, to obtain the desired behavior from such ORMs, an individual is needed who is well versed in the intricacies of such systems, which is not good in team development. <br><br>  The main theoretical source of the post is <a href="http://www.books.ru/books/arkhitektura-korporativnykh-programmnykh-prilozhenii-156126/">Martin Fowler‚Äôs book Patterns of Enterprise Application Architecture (P of EAA)</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There is a lot of information about what is actually ORM, DDD, TTD, <s>traffic police</s> - on this I will try not to stop, my goal is practical.  It assumes two parts of the article, at the very end there is a link to the full source code in the git hub. <br><cut><br><h3>  What do we want to get? </h3><br>  We will immediately define the terms: tracking means tracking changes in business objects within a single transaction, to further synchronize the data stored <br>  in RAM and bd content. <br><br>  <i>What are the main types of ORM?</i> <br><br><ul><li>  There are two types of ORMs for using tracking in the .NET world: with change tracking and without change tracking. </li><li>  Regarding the approach to the generation of sql queries: with the explicit use of queries and based on query generators from object models. </li></ul><br>  For example, among the well-known ORM without tracking and with the explicit use of queries, the most vivid example is the <a href="https://habrahabr.ru/post/116862/">Dapper ORM from Stack Overflow</a> .  The main functionality of such ORMs is mapping the relational model of the database to the object model, while the client clearly defines how his query to the database will look. <br><br>  The basic concepts of MS Entity Framework and NHibernate in the use of tracking and query generators from object models.  I will not consider here the advantages and disadvantages of these approaches.  All yogurts are equally useful and true in combining approaches. <br><br>  The customer (that is, I) wanted to create an ORM using tracking (with the ability to turn off) and based on query generators from object models.  We will generate sql queries from lambda - C # language expressions, from scratch, without using Linq2Sql, LinqToEntities (yes, only hardcore!). <br><br>  Out of the box, in the MS Entity Framework there is a nuisance with batch updating and deleting data: you must first get all the objects from the database, then update / delete in the cycle, and then apply the changes to the database.  As a result, we get more calls to the database than necessary.  The problem is described <a href="https://habrahabr.ru/post/203214/">here</a> .  We will solve this problem in the second part of the article. <br><br><h3>  Determine the main ingredients </h3><br>  We will immediately determine how the client code will interact with the library being developed.  Highlight the main components of the ORM that will be available from the client code. <br>  The concept of client interaction with ORM will be based on the idea of ‚Äã‚Äãinheriting from an abstract <a href="https://habrahabr.ru/post/263033/">repository.</a>  You also need to define a superclass to restrict the set of business objects with which ORM will work. <br><br>  Each business object must be unique within its type, so a descendant must explicitly redefine its identifier. <br><br><div class="spoiler">  <b class="spoiler_title">Empty repository and business object superclass</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Repository</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">IRepository</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">T</span></span> : <span class="hljs-title"><span class="hljs-title">EntityBase</span></span>,<span class="hljs-title"><span class="hljs-title">new</span></span>() { <span class="hljs-comment"><span class="hljs-comment">//   }</span></span></code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//   public abstract class EntityBase : IEntity { //      public abstract int Id { get; set; } public object Clone() { return MemberwiseClone(); } }</span></span></code> </pre> <br>  The Clone () method is useful to us for copying an object, when tracking, this will be slightly lower. <br></div></div><br>  Let us have a client business object that stores information about the user - the Profile class. <br><br>  <i>To use a business object in ORM, you need three steps:</i> <br><br><ol><li>  Bind a business object to a table in a database based on attributes <br><br><div class="spoiler">  <b class="spoiler_title">Profile class</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-comment"><span class="hljs-comment">//       EntityBase [TableName("profile")] public class Profile : EntityBase { //        [FieldName("profile_id")] public override int Id { get; } [FieldName("userinfo_id")] public int? UserInfoId { get; set; } [FieldName("role_id")] public int RoleId { get; set; } public string Info { get; set; } }</span></span></code> </pre><br></div></div><br></li><li>  Define a repository for each business object. <br><br><div class="spoiler">  <b class="spoiler_title">Profile repository will look like</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProfileRepository</span></span> : <span class="hljs-title"><span class="hljs-title">Repository</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Profile</span></span>&gt; { <span class="hljs-comment"><span class="hljs-comment">//         public ProfileRepository() : base("PhotoGallery") { //  CRUD  } }</span></span></code> </pre> <br></div></div><br></li><li>  To form a connection string to the database <br><br><div class="spoiler">  <b class="spoiler_title">The connection string may look like this.</b> <div class="spoiler_text"><pre> <code class="cs hljs">&lt;connectionStrings&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">add</span></span> name=<span class="hljs-string"><span class="hljs-string">"PhotoGallery"</span></span> providerName=<span class="hljs-string"><span class="hljs-string">"System.Data.SqlClient"</span></span> connectionString=<span class="hljs-string"><span class="hljs-string">"server=PC\SQLEXPRESS; database=db_PhotoGallery"</span></span>/&gt; &lt;/connectionStrings&gt;</code> </pre> <br></div></div></li></ol><br>  For tracking changes made to use the pattern UnitOfWork.  The essence of UnitOfWork is to track actions performed on domain objects to further synchronize data stored in RAM with the contents of the database.  In this case, the changes are recorded at one time - all at once. <br><br><div class="spoiler">  <b class="spoiler_title">Interface UnitOfWork</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IUnitOfWork</span></span> : <span class="hljs-title"><span class="hljs-title">IDisposable</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Commit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre> <br></div></div><br>  It would seem that this is all.  But you need to take into account two points: <br><br><ul><li>  Change tracking should serve the entire current business transaction and should be accessible to all business objects. </li><li>  A business transaction must be performed within a single thread, so you need to associate the work unit with the currently running thread using the local stream storage. </li></ul><br>  If a UnitOfWork object is already associated with a business transaction flow, then it should be placed in this object.  In addition, from a logical point of view, the unit of work belongs to this session. <br><br><div class="spoiler">  <b class="spoiler_title">Let's use the static class Session</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Session</span></span> { <span class="hljs-comment"><span class="hljs-comment">//   private static readonly ThreadLocal&lt;IUnitOfWork&gt; CurrentThreadData = new ThreadLocal&lt;IUnitOfWork&gt;(true); public static IUnitOfWork Current { get { return CurrentThreadData.Value; } private set { CurrentThreadData.Value = value; } } public static IUnitOfWork Create(IUnitOfWork uow) { return Current ?? (Current = uow); } }</span></span></code> </pre><br></div></div><br>  If you need to do without tracking, then you do not need to create an instance of the class UnitOfWork, just like calling Session.Create. <br><br>  So, after determining all the elements necessary for interaction with ORM, we give an example of working with ORM. <br><br><div class="spoiler">  <b class="spoiler_title">An example of working with ORM</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> uow = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnitOfWork(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (Session.Create(uow)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> profileRepo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProfileRepository(); <span class="hljs-comment"><span class="hljs-comment">//   uow.Commit(); }</span></span></code> </pre> <br></div></div><br><cut><br><h3>  Start cooking </h3><br>  Everything we talked about earlier concerned the public part.  Now consider the internal part.  For further development, it is necessary to determine what the structure of the object for tracking is. <br><br>  Do not confuse the business object and the object for tracking: <br><br><ul><li>  A business object has its own type, whereas a tracking object must be suitable for mass manipulations of many business objects, that is, it must not depend on the specific type </li><li>  A tracking object is an entity that exists within a specific business transaction; among a multitude of business objects, its uniqueness must be determined within the framework of this transaction. </li></ul><br>  From which it follows that such an object must have the properties: <br><br><ul><li>  Unique within its type </li><li>  Unchangeable </li></ul><br>  In essence, the tracking object is a <u>container</u> for storing business objects.  As noted earlier, all client business objects must be ancestors of the EntityBase superclass and must have an object identifier redefined for them.  The identifier provides uniqueness within the type, that is, the table in the database. <br><br><div class="spoiler">  <b class="spoiler_title">Implement container object for tracking</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> EntityStruct { <span class="hljs-comment"><span class="hljs-comment">//  internal Type Key { get; private set; } internal EntityBase Value { get; private set; } internal EntityStruct(Type key, EntityBase value) : this() { Key = key; Value = value; } public override bool Equals(object obj) { if (!(obj is EntityStruct)) { throw new TypeAccessException("EntityStruct"); } return Equals((EntityStruct)obj); } public bool Equals(EntityStruct obj) { if (Value.Id != obj.Value.Id) { return false; } return Key == obj.Key; } public override int GetHashCode() { //   ,        // return (unchecked(25 * Key.GetHashCode()) ^ Value.Id.GetHashCode()) &amp; 0x7FFFFFFF; } }</span></span></code> </pre> <br></div></div><br><h4>  Tracking business objects </h4><br>  Registration of objects for tracking will occur at the stage of obtaining these objects from the repository. <br><br>  After receiving business objects from the database, they need to be registered as objects for tracking. <br>  Such objects have two states: immediately after receiving from the database and after receiving, before the changes are committed. <br><br>  The first will be called "clean", the second "dirty" objects. <br><br><div class="spoiler">  <b class="spoiler_title">Example</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> uow = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnitOfWork(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (Session.Create(uow)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> profileRepo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProfileRepository(); <span class="hljs-comment"><span class="hljs-comment">// ""      , //  "" var profiles = profileRepo.Get(x=&gt;x.Info = " "); // ""  foreach (var profile in profiles) { profile.Info = " "; } //  uow.Commit(); }</span></span></code> </pre> <br></div></div><br>  The important point is that to save "clean" objects, copying operations are necessary, which can have a detrimental effect on performance. <br><br>  In the general case, tracking objects should be registered for each type of operation, thus there should be objects for update, delete, insert operations. <br><br>  It is necessary to take into account that it is necessary to register only really changed objects, for which we need to perform comparison operations by value (the implementation of the EntityStruct structure with the overridden Equals method is shown above).  Ultimately, the comparison operation will be reduced to a comparison of their hashes. <br><br>  Events of registration of tracking objects will be fired from the abstract repository class functional in its CRUD methods. <br><br><div class="spoiler">  <b class="spoiler_title">Implementing tracking object registration functionality</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IObjectTracker</span></span> { <span class="hljs-comment"><span class="hljs-comment">//            ICollection&lt;EntityStruct&gt; NewObjects { get; } ICollection&lt;EntityStruct&gt; ChangeObjects { get; } //  void RegInsertedNewObjects(object sender, AddObjInfoEventArgs e); void RegCleanObjects(object sender, DirtyObjsInfoEventArgs e); } internal class DefaultObjectTracker : IObjectTracker { //  - "" ,  - ""  private readonly Dictionary&lt;EntityStruct, EntityStruct&gt; _dirtyCreanPairs; public ICollection&lt;EntityStruct&gt; NewObjects { get; private set; } public ICollection&lt;EntityStruct&gt; ChangeObjects { get { //    return _dirtyCreanPairs.GetChangesObjects(); } } internal DefaultObjectTracker() { NewObjects = new Collection&lt;EntityStruct&gt;(); //   boxing/unboxing    EqualityComparer _dirtyCreanPairs = new Dictionary&lt;EntityStruct, EntityStruct&gt;(new IdentityMapEqualityComparer()); } public void RegInsertedNewObjects(object sender, AddObjInfoEventArgs e) { NewObjects.Add(e.InsertedObj); } public void RegCleanObjects(object sender, DirtyObjsInfoEventArgs e) { var objs = e.DirtyObjs; foreach (var obj in objs) { if (!_dirtyCreanPairs.ContainsKey(obj)) { // ""       MemberwiseClone() var cloneObj = new EntityStruct(obj.Key, (EntityBase)obj.Value.Clone()); _dirtyCreanPairs.Add(obj, cloneObj); } } } }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Functional detection of client-modified objects</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ICollection&lt;EntityStruct&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetChangesObjects</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Dictionary&lt;EntityStruct, EntityStruct&gt; dirtyCleanPairs </span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;EntityStruct&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cleanObj <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dirtyCleanPairs.Keys) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(cleanObj.Key == dirtyCleanPairs[cleanObj].Key)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"incorrect types"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ChangeDirtyObjs(cleanObj.Value, dirtyCleanPairs[cleanObj].Value, cleanObj.Key)) { result.Add(cleanObj); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ChangeDirtyObjs</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">EntityBase cleanObj, EntityBase dirtyObj, Type type</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> props = type.GetProperties(); <span class="hljs-comment"><span class="hljs-comment">//     foreach (var prop in props) { var cleanValue = prop.GetValue(cleanObj, null); var dirtyValue = prop.GetValue(dirtyObj, null); //    ,      if (!cleanValue.Equals(dirtyValue)) { return true; } } return false; }</span></span></code> </pre> <br></div></div><br></div></div><br>  It should be noted that the business objects of a single transaction can be from different databases.  It is logical to assume that for each database a separate tracking instance must be defined (a class that implements IObjectTracker, for example, DefaultObjectTracker). <br><br>  The current transaction must be "know" in advance of for which databases the tracking will be performed.  At the stage of creating an instance of UnitOfWork, it is necessary to initialize instances of tracking objects (an instance of the DefaultObjectTracker class) using the specified connections to the database in the configuration file. <br><br><div class="spoiler">  <b class="spoiler_title">Change the UnitOfWork class</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IDetector</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  -    ,  -   Dictionary&lt;string, IObjectTracker&gt; ObjectDetector { get; } } public sealed class UnitOfWork : IUnitOfWork, IDetector { private readonly Dictionary&lt;string, IObjectTracker&gt; _objectDetector; Dictionary&lt;string, IObjectTracker&gt; IDetector.ObjectDetector { get { return _objectDetector; } } public UnitOfWork() { _objectDetector = new Dictionary&lt;string, IObjectTracker&gt;(); foreach (ConnectionStringSettings conName in ConfigurationManager.ConnectionStrings) { //        _objectDetector.Add(conName.Name, new DefaultObjectTracker()); } } }</span></span></code> </pre> <br></div></div><br>  Information about which instance of tracking to which database will correspond should be available to all instances of the repository as part of the transaction.  It is convenient to create a single access point in the static class Session. <br><br><div class="spoiler">  <b class="spoiler_title">Session class will look like</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Session</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ThreadLocal&lt;IUnitOfWork&gt; CurrentThreadData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ThreadLocal&lt;IUnitOfWork&gt;(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IUnitOfWork Current { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CurrentThreadData.Value; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { CurrentThreadData.Value = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IUnitOfWork </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IUnitOfWork uow</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Current ?? (Current = uow); } <span class="hljs-comment"><span class="hljs-comment">//        //     internal static IObjectTracker GetObjectTracker(string connectionName) { var uow = Current; if (uow == null) { throw new ApplicationException(" Create unit of work context and using Session."); } var detector = uow as IDetector; if (detector == null) { throw new ApplicationException("Create unit of work context and using Session."); } return detector.ObjectDetector[connectionName]; } } }</span></span></code> </pre> <br></div></div><br><h4>  Data access </h4><br>  The data access functional will directly call the access methods of the database.  This functionality will be used by the abstract repository class in its CRUD methods.  In the simple case, the data access class includes CRUD methods for working with data. <br><br><div class="spoiler">  <b class="spoiler_title">DbProvider class implementation</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IDataSourceProvider</span></span> : <span class="hljs-title"><span class="hljs-title">IDisposable</span></span> { State State { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//     ,      void Commit(ICollection&lt;EntityStruct&gt; updObjs); ICollection&lt;T&gt; GetByFields&lt;T&gt;(BinaryExpression exp) where T : EntityBase, new(); } internal class DbProvider : IDataSourceProvider { private IDbConnection _connection; internal DbProvider(IDbConnection connection) { _connection = connection; State = State.Open; } public State State { get; private set; } public ICollection&lt;T&gt; GetByFields&lt;T&gt;(BinaryExpression exp) where T : EntityBase, new() { //    select-   exp Func&lt;IDbCommand, BinaryExpression, string&gt; cmdBuilder = SelectCommandBulder.Create&lt;T&gt;; ICollection&lt;T&gt; result; using (var conn = _connection) { using (var command = conn.CreateCommand()) { command.CommandText = cmdBuilder.Invoke(command, exp); command.CommandType = CommandType.Text; conn.Open(); result = command.ExecuteListReader&lt;T&gt;(); } } State = State.Close; return result; } public void Commit(ICollection&lt;EntityStruct&gt; updObjs) { if (updObjs.Count == 0) { return; } //  -    update-   exp // -   var cmdBuilder = new Dictionary&lt;Func&lt;IDbCommand, ICollection&lt;EntityStruct&gt;, string&gt;, ICollection&lt;EntityStruct&gt;&gt;(); cmdBuilder.Add(UpdateCommandBuilder.Create, updObjs); ExecuteNonQuery(cmdBuilder, packUpdDict, packDeleteDict); } private void ExecuteNonQuery(Dictionary&lt;Func&lt;IDbCommand, ICollection&lt;EntityStruct&gt;, string&gt;, ICollection&lt;EntityStruct&gt;&gt; cmdBuilder) { using (var conn = _connection) { using (var command = conn.CreateCommand()) { var cmdTxtBuilder = new StringBuilder(); foreach (var builder in cmdBuilder) { cmdTxtBuilder.Append(builder.Key.Invoke(command, builder.Value)); } command.CommandText = cmdTxtBuilder.ToString(); command.CommandType = CommandType.Text; conn.Open(); if (command.ExecuteNonQuery() &lt; 1) throw new ExecuteQueryException(command); } } State = State.Close; } private ICollection&lt;T&gt; ExecuteListReader&lt;T&gt;(EntityStruct objs) where T : EntityBase, IEntity, new() { Func&lt;IDbCommand, EntityStruct, string&gt; cmdBuilder = SelectCommandBulder.Create; ICollection&lt;T&gt; result; using (var conn = _connection) { using (var command = conn.CreateCommand()) { command.CommandText = cmdBuilder.Invoke(command, objs); command.CommandType = CommandType.Text; conn.Open(); result = command.ExecuteListReader&lt;T&gt;(); } } State = State.Close; return result; } private void Dispose() { if (State == State.Open) { _connection.Close(); State = State.Close; } _connection = null; GC.SuppressFinalize(this); } void IDisposable.Dispose() { Dispose(); } ~DbProvider() { Dispose(); } }</span></span></code> </pre> <br></div></div><br>  The DbProvider class requires an existing connection to the database.  We delegate the creation of a connection and additional infrastructure to a separate class based on the factory method.  Thus, it is only necessary to create instances of the DbProvider class through the auxiliary factory class. <br><br><div class="spoiler">  <b class="spoiler_title">DbProvider Factory Method</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DataSourceProviderFactory</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> DbConnection </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateDbConnection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionString, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> providerName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(connectionString)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"connectionString is null or whitespace"</span></span>); } DbConnection connection; DbProviderFactory factory; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { factory = DbProviderFactories.GetFactory(providerName); connection = factory.CreateConnection(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (connection != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) connection.ConnectionString = connectionString; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ArgumentException) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { factory = DbProviderFactories.GetFactory(<span class="hljs-string"><span class="hljs-string">"System.Data.SqlClient"</span></span>); connection = factory.CreateConnection(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (connection != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { connection.ConnectionString = connectionString; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"DB connection has been failed."</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> connection; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IDataSourceProvider </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionString</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> settings = ConfigurationManager.ConnectionStrings[connectionString]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbConn = CreateDbConnection(settings.ConnectionString, settings.ProviderName); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbProvider(dbConn); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IDataSourceProvider </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateByDefaultDataProvider</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionString</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbConn = CreateDbConnection(connectionString, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbProvider(dbConn); } }</code> </pre> <br></div></div><br>  Registration of tracking objects should occur in the CRUD methods of the repository, which in turn delegates the functionality to the data access layer.  Thus, it is necessary to implement the IDataSourceProvider interface taking into account tracking  We will register objects on the basis of the mechanism of events that will be excited in this particular class.  The proposed new implementation of the IDataSourceProvider interface should ‚Äúbe able‚Äù both to initialize the registration events for tracking and to access the database.  In this case, it is convenient to decorate the DbProvider class. <br><br><div class="spoiler">  <b class="spoiler_title">TrackerProvider class implementation</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TrackerProvider</span></span> : <span class="hljs-title"><span class="hljs-title">IDataSourceProvider</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> EventHandler&lt;DirtyObjsInfoEventArgs&gt; DirtyObjEvent; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> EventHandler&lt;UpdateObjsInfoEventArgs&gt; UpdateObjEvent; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IDataSourceProvider _dataSourceProvider; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _connectionName; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> _syncObj = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IObjectTracker ObjectTracker { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (_syncObj) { <span class="hljs-comment"><span class="hljs-comment">//     return Session.GetObjectTracker(_connectionName); } } } public TrackerProvider(string connectionName) { _connectionName = connectionName; _dataSourceProvider = DataSourceProviderFactory.Create(_connectionName); //    RegisterEvents(); } public State State { get { return _dataSourceProvider.State; } } private void RegisterEvents() { //       if (Session.Current == null) { throw new ApplicationException("Session has should be used. Create a session."); }; //    DirtyObjEvent += ObjectTracker.RegCleanObjects; UpdateObjEvent += ObjectTracker.RegUpdatedObjects; } public ICollection&lt;T&gt; GetByFields&lt;T&gt;(BinaryExpression exp) where T : EntityBase, IEntity, new() { //        DbProvider var result = _dataSourceProvider.GetByFields&lt;T&gt;(exp); var registratedObjs = result.Select(r =&gt; new EntityStruct(typeof(T), r)).ToList(); //   ""  var handler = DirtyObjEvent; if (handler == null) return result; handler(this, new DirtyObjsInfoEventArgs(registratedObjs)); return result; } public void Commit(ICollection&lt;EntityStruct&gt; updObjs) { //     DbProvider _dataSourceProvider.Commit(updObjs, delObjs, addObjs, packUpdObjs, deleteUpdObjs); } public void Dispose() { _dataSourceProvider.Dispose(); } }</span></span></code> </pre> <br></div></div><br><h3>  Subtotals </h3><br>  Let's figure out how our public classes will look now. <br><br>  As noted above, the repository class must delegate its functionality to the IDataSourceProvider interface implementations.  When initializing the repository class, based on the connection string passed to the constructor, you need to create the necessary IDataSourceProvider implementation depending on the tracking usage.  It is also necessary to take into account that the data access class can ‚Äúlose‚Äù the connection with the database at any time, for which we will monitor this connection using the property. <br><br>  The UnitOfWork class, as mentioned earlier, in its constructor must create a list of objects of the DefaultObjectTracker class for all available in the connection string of the database.  It is logical that all changes should also be committed to all changes: for each tracking instance, a method of fixing its changes will be called. <br><br><div class="spoiler">  <b class="spoiler_title">Public - classes will take the form</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Repository</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">IRepository</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">T</span></span> : <span class="hljs-title"><span class="hljs-title">EntityBase</span></span>, <span class="hljs-title"><span class="hljs-title">IEntity</span></span>, <span class="hljs-title"><span class="hljs-title">new</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> _syncObj = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IDataSourceProvider _dataSourceProvider; <span class="hljs-comment"><span class="hljs-comment">//c   ""    private IDataSourceProvider DataSourceProvider { get { lock (_syncObj) { if (_dataSourceProvider.State == State.Close) { _dataSourceProvider = GetDataSourceProvider(); } return _dataSourceProvider; } } } private readonly string _connectionName; protected Repository(string connectionName) { if (string.IsNullOrWhiteSpace(connectionName)) { throw new ArgumentNullException("connectionName"); } _connectionName = connectionName; var dataSourceProvider = GetDataSourceProvider(); if (dataSourceProvider == null) { throw new ArgumentNullException("dataSourceProvider"); } _dataSourceProvider = dataSourceProvider; } private IDataSourceProvider GetDataSourceProvider() { //      DbProvider' //    ////  - TrackerProvider return Session.Current == null ? DataSourceProviderFactory.Create(_connectionName) : new TrackerProvider(_connectionName); } public ICollection&lt;T&gt; Get(Expression&lt;Func&lt;T, bool&gt;&gt; exp) { return DataSourceProvider.GetByFields&lt;T&gt;(exp.Body as BinaryExpression); } } public sealed class UnitOfWork : IUnitOfWork, IDetector { private readonly Dictionary&lt;string, IObjectTracker&gt; _objectDetector; Dictionary&lt;string, IObjectTracker&gt; IDetector.ObjectDetector { get { return _objectDetector; } } public UnitOfWork() { _objectDetector = new Dictionary&lt;string, IObjectTracker&gt;(); foreach (ConnectionStringSettings conName in ConfigurationManager.ConnectionStrings) { _objectDetector.Add(conName.Name, new DefaultObjectTracker()); } } public void Commit() { SaveChanges(); } private void SaveChanges() { foreach (var objectDetector in _objectDetector) { //         var provider = new TrackerProvider(objectDetector.Key); provider.Commit( objectDetector.Value.ChangeObjects, objectDetector.Value.DeletedObjects, objectDetector.Value.NewObjects, objectDetector.Value.UpdatedObjects, objectDetector.Value.DeletedWhereExp); } } }</span></span></code> </pre> <br></div></div><br>  In the continuation of the article I will consider working with related entities, generating sql queries based on expression trees, methods for batch data deletion / modification (like UpdateWhere, RemoveWhere). <br><br>  Completely all the source code of the project, without simplifications, <a href="https://github.com/lex1112/MapperOrm">lies here</a> . </cut></cut></div><p>Source: <a href="https://habr.com/ru/post/317860/">https://habr.com/ru/post/317860/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317850/index.html">The perfect programmer. Part 2</a></li>
<li><a href="../317852/index.html">How to congratulate customers happy New Year?</a></li>
<li><a href="../317854/index.html">Activity modeling and mythological consciousness</a></li>
<li><a href="../317856/index.html">Cosmos Calling: Need a specialist mathematician in the field of numerical solution of stochastic differential equations</a></li>
<li><a href="../317858/index.html">Use oEmbed to add a phone to the habrapost</a></li>
<li><a href="../317864/index.html">Assembly Architecture Go</a></li>
<li><a href="../317866/index.html">How to keep logs of data changes by users in the database, storing them in another database</a></li>
<li><a href="../317868/index.html">The digest of interesting materials for the mobile # 184 developer (December 12-18)</a></li>
<li><a href="../317870/index.html">CRM pumped for sales</a></li>
<li><a href="../317872/index.html">Does your code speak Russian?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>