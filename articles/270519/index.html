<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Symfony2 two-factor authentication with a certificate</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It's about Symfony2-CertAuthBundle - a bundle for the popular framework Symfony2, which makes it easy to implement two-factor authentication based on ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Symfony2 two-factor authentication with a certificate</h1><div class="post__text post__text-html js-mediator-article">  It's about <a href="https://github.com/zim32/Symfony2-CertAuthBundle">Symfony2-CertAuthBundle</a> - a bundle for the popular framework Symfony2, which makes it easy to implement two-factor authentication based on x509 client certificates. <br><br>  Sometimes standard authentication in the form of a login is not enough to securely protect a project. <br><br>  Someone can spy, search, retrieve a login password in any other way, well, or just hack the site and get access to all accounts. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For those who believe that his project needs a more reliable protection method, welcome under cat. <br><a name="habracut"></a><br>  The installation is described in detail on the githab, below I want to talk about how it works and what are the main features of the bundle. <br><br><h2>  How does symfony2 authentication work at all? </h2><br>  The Security component in a symphony in the beginning seems very complicated and confusing.  But in fact, everything is very simple and logical. <br><br>  Security consists of four basic elements: FirewallListeners, AuthenticationProviders, UserProviders, and AuthenticationManager. <br><br><img src="https://habrastorage.org/files/221/b7a/0ce/221b7a0ce72b45189e8724d2ea25f239.png" alt="image"><br><br>  <b>FirewallListeners</b> are implemented by the Firewall class.  They chain the request at kernel.request.  Their main task is to create an unauthenticated token that will be authenticated by the subsequent AuthenticatedProvider.  They are also responsible for the serialization and deserialization of the token in a session ( <b>ContextListener</b> ), for the redirect of the user to https ( <b>ChannelListener</b> ), for the ACL ( <b>AccessListener</b> ). <br><br>  For each firewall, symphony creates its own set of listener instances.  This is done in SecurityExtension. <br>  In the power of the listener, any manipulations with the session and the token are user logins, adding dynamic roles, changing the token, etc.  etc. <br><br>  Through the <b>AuthenticationManager</b> , the listeners interact with <b>AuthenticationProviders</b> .  The main task of providers is to load the user via UserProvider and return an authenticated token - a token with at least one role. <br><br>  The AuthenticationManager implements a loose relationship between the listeners and providers through the supports () method, which allows you to write universal listeners and providers. <br><br>  All these components are glued together in SecurityExtension. <br><br><h2>  How does the bundle work? </h2><br>  Bundle adds another authentication step in the form of generating and downloading a user certificate. <br><br>  The user is prompted to enter a secret word.  It is necessary to encrypt the certificate before transferring it to the client and storing it on the server. <br><br>  Also, the secret word is used when restoring the certificate, if the user lost it, came for another laptop or simply reinstalled the system.  It is possible to disable this functionality and add your own logic for manual certificate recovery (last call, sms, last operation on the site, etc.) <br><br>  After downloading and installing the certificate in the browser, the user gets full access.  Bundle creates <b>CertifiedUserToken</b> , which is inherited from the standard UserNamePasswordToken, and also adds the ROLE_CERT_AUTHENTICATED_FULLY dynamic role, which is used in the above-mentioned AccessListener for access checking. <br><br>  The main verification of the client certificate lies on the backend server (nginx, apache), which pass the result of the verification and the certificate to symfony.  Variable names are configured in the config.  file.  Bundle only verifies the result of this check.  Verification is performed using Symfony Expression Language and, by default, looks like: <br><br> <code>cert["subject"]["CN"] == token.getUserName() &amp;&amp; request.server.get("CLIENT_CERT_OK") === "SUCCESS" <br></code> <br><br>  In the context of the expression: cert (array in format openssl_x509_parse), the request object and the current token. <br><br>  Since the server automatically validates the validFrom and validTo of the certificate, inactive accounts do not become a potential security gap over time. <br><br>  The storage system ( <b>zim_cert_auth.certificate_storage</b> service) uses three main components: Formatter, Filters, Persister. <br>  <b>Formatter</b> is responsible for converting an x509 resource to a storage format.  Currently only PKCS12 formatter is implemented. <br>  <b>Filter</b> allows you to apply any transformation before saving or retrieving. <br>  <b>Persister</b> is responsible for the physical storage of certificates.  Currently localfs and orm persists are implemented.  Their purpose is clear from the title.  There are plans to add a remotessh persister that will allow storing certificates on any other host using scp. <br><br>  You can implement your services of formatters, persists, filters and define them in config.yml <br><br><h2>  Certificate Management </h2><br>  Bundle adds several cli commands to enable certificate management.  At the moment there are two commands: <br>  zim: cert: dump and zim: cert: remove. <br><br>  Since the bundle is quite young, it may lack the functionality that is needed in real projects, so any suggestions on functionality, general work of the bundle, write in comments or on githabe, we will implement all the necessary features. <br><br>  Thanks to all. </div><p>Source: <a href="https://habr.com/ru/post/270519/">https://habr.com/ru/post/270519/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../270507/index.html">Regular expression searches can be quick and easy.</a></li>
<li><a href="../270509/index.html">GDG DevFest Voronezh 2015: photo and video report from the event</a></li>
<li><a href="../270513/index.html">OpenStreetMap as a geodata source</a></li>
<li><a href="../270515/index.html">‚ÄúBig data‚Äù - is it boring?</a></li>
<li><a href="../270517/index.html">Another virtual interface</a></li>
<li><a href="../270521/index.html">Docker 1.9 + Weave 1.2.1 bridge mode</a></li>
<li><a href="../270523/index.html">Colocation in theory and practice</a></li>
<li><a href="../270525/index.html">Cryptographers invent new ways to blackmail users</a></li>
<li><a href="../270527/index.html">Official Firebird 3.0 Release Candidate 1 and Beta Documentation for Firebird 3.0</a></li>
<li><a href="../270529/index.html">As we wrote AI for the Jackal, and why he has schizophrenia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>