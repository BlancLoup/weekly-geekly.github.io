<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ÄúSweet‚Äù programming, or How to select a label from a can of jam in Mathematica?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Translated from the Mathematica at StackExchange discussion of " How to peel the labels from marmalade jars using Mathematica? " 
 The code in this ar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>‚ÄúSweet‚Äù programming, or How to select a label from a can of jam in Mathematica?</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/8e8/17e/eb1/8e817eeb1e1a431b8d570ac7b1e17864.png"></div><br>  <i>Translated from the Mathematica at StackExchange discussion of " <a href="http://mathematica.stackexchange.com/questions/5676/how-to-peel-the-labels-from-marmalade-jars-using-mathematica">How to peel the labels from marmalade jars using Mathematica?</a> "</i> <i><br></i>  <i>The code in this article can be downloaded <a href="">here</a> (~ 31 MB).</i> <i><br></i>  <i><a href="http://habrahabr.ru/users/kirillguzenko/" class="user_link">Many</a> thanks to Kirill Guzenko <a href="http://habrahabr.ru/users/kirillguzenko/" class="user_link">KirillGuzenko</a> for his help in translating and preparing the publication.</i> <hr>  How can you select the contents of the label from the can specified below (the point where the frame was taken, the geometry of the can, its contents - all of this is unknown to us), <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dda/5f0/2bc/dda5f02bce10706e331c2f2ee766ca89.gif" width="169" height="198"><br><br>  to get something like that ‚Äî the same label as it was before it was on the bank? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/0d8/8f2/ad3/0d88f2ad3e99cd03af9852fb9fe894d8.gif" width="300" height="222"><br><br>  The basic idea is this: <br><br><ul><li>  Find the label. </li><li>  Find the borders of the label. </li><li>  We find the display of the image pixel coordinates on cylindrical coordinates. </li><li>  Transform the image using the found display. </li></ul><br>  The algorithm proposed by us works only for images in which: <br><br><ul><li>  The label is brighter than the background (this is needed to detect the label). </li><li>  The label is rectangular (this is necessary in order to assess the quality of the display). </li><li>  The bank must be in a vertical position (this is necessary in order to preserve the simple form of the display function). </li><li>  The can must be cylindrical (this is necessary in order to preserve the simple form of the display function). </li></ul><br>  It should be noted that the algorithm is modular.  That is, you can add your own label detection algorithm, which will not require a dark background, or you can write your own display quality evaluation function, which will allow you to work with oval or polygonal labels. <br><br>  The resulting algorithm works completely automatically (however, there is an option to manually set the jars' boundaries), that is, it takes the original image, and then displays an image with a grid and a label. <br><a name="habracut"></a><br>  Here is my ‚Äúquick‚Äù solution.  It is a bit like the azdahak user‚Äôs solution, but instead of cylindrical coordinates it uses approximate mapping.  On the other hand, control parameters cannot be set manually - all display coefficients are automatically determined: <br><br>  The label stands out clearly against a dark background, so I can easily find it using binarization: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4a6/065/c87/4a6065c8702901cc56eab882c5cd9a81.png" width="501" height="18"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/dda/5f0/2bc/dda5f02bce10706e331c2f2ee766ca89.gif" width="169" height="198"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/022/aa1/22c/022aa122c76c5a79d75a0be51b8e64e2.png" width="391" height="65"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c01/a71/e8e/c01a71e8ea8bdf28a5a2d55fbbdec008.gif" width="169" height="198"><br><br>  I just choose the largest item and I believe that this is the label: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/043/fb0/893/043fb0893183907d2b66cd5f0abf6fda.png" width="615" height="111"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/9c5/6fb/2eb/9c56fb2eb0698a1be221f2f7c35079e1.gif" width="169" height="198"><br><br>  In the next step, you need to select all the boundaries of this area using the convolution ( <a href="http://reference.wolfram.com/language/ref/ImageConvolve.html">ImageConvolve</a> ) of the resulting label mask: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/664/d52/5ba/664d525ba9ab9db5b68d14c50765af33.png" width="553" height="65"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/6a5/a16/3ba/6a5a163babad97bd8d5ca93fb735c4cc.gif" width="375" height="434"><br><br>  A small auxiliary function, shown below, allows you to find all white pixels in one of these four images and convert their indices to coordinates ( <a href="http://reference.wolfram.com/language/ref/Position.html">Position</a> returns indices, and indices are pairs of numbers <b>{y, x}</b> , which, when <b>y = 1,</b> specify an image bandwidth 1 pixel at the top of the image. But all image processing functions take the coordinates in the form of pairs <b>{x, y}</b> , which, when <b>y = 0,</b> define an image strip with a thickness of 1 pixel from the bottom of the image. This leads to the need to convert the indices produced by Position into Essentially, about  ychnye Cartesian coordinates for further use): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b8a/26a/34d/b8a26a34d59985f36a2bc827a3c3e46a.gif" width="452" height="111"><br><br>  Now I have four separate lists of coordinates for the upper, lower, left, and right borders of the label.  We now define the display of image coordinates into cylindrical coordinates: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/998/bef/242/998bef242ef4988ef62e1bdaec8c41cb.gif" width="591" height="88"><br><br>  This mapping is obviously a rough approximation to cylindrical coordinates.  However, it is very easy to find the optimal values ‚Äã‚Äãof the coefficients c1, c2, ..., c8 using the <a href="http://reference.wolfram.com/language/ref/NMinimize.html">NMinimize</a> function: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/90b/8f9/723/90b8f97234094a7127112540ddf981b3.gif" width="633" height="249"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/73b/169/289/73b1692895fabd4235227010454b4b7f.png" width="512" height="69"><br><br>  Thus, we find a function that produces the optimal display of our label on a rectangle - the points on the left border are displayed in <b>{0, [something]}</b> , and the points on the upper border are displayed in <b>{[something], 1}</b> and so on . <br><br>  The display will look like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/630/c61/9c6/630c619c600db09033e37d361c211b64.png" width="624" height="387"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/7e7/2d1/ec5/7e72d1ec51938ed3261dd7f0ae128b94.gif" width="169" height="198"><br><br>  Now you can transfer this mapping directly to the <a href="http://reference.wolfram.com/language/ref/ImageForwardTransformation.html">ImageForwardTransformation</a> function: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/806/3fc/457/8063fc457b9abbea9ee6dbfac29f81ea.png" width="617" height="42"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/6b5/143/cad/6b5143cadb0785208ebd2ee2a558f861.gif" width="400" height="300"><br><br>  Artifacts in the image we got from the original image.  A higher resolution version of the image would give a better result.  Distortions in the left part occurred due to insufficient quality display function.  This can be corrected by improving it, as will be discussed below. <br><br><h2>  Algorithm operation with larger images </h2><br>  I tried to apply the same algorithm to a higher resolution image and the result looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/39e/2b9/52a/39e2b952a8aa2bbbf903a3fd46c335f8.gif" width="571" height="529"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/955/46d/c3b/95546dc3b13446df1949bfbe65eac1d7.gif" width="571" height="428"><br><br>  The result suggests that it is worth a little tweak the part responsible for detecting the label (first <a href="http://reference.wolfram.com/language/ref/DeleteBorderComponents.html">DeleteBorderComponents</a> , and then <a href="http://reference.wolfram.com/language/ref/FillingTransform.html">FillingTransform</a> ), and add additional conditions in the display formula taking into account the perspective (for low-resolution images, the changes will be almost invisible).  You may notice that closer to the edges of the image, the constructed second-order display function works with some minor distortions. <br><br><h2>  Improved display function </h2><br>  After conducting a series of studies and experiments, we managed to find a mapping that eliminates cylindrical distortions (most of them, at least): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ba1/70f/8ef/ba170f8ef906419382078b3a08bbaa46.gif" width="543" height="226"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/78f/519/b63/78f519b63b84d1fa65a77a4be8bb68a6.png" width="230" height="39"><br><br>  This is a cylindrical mapping that uses the Taylor series to approximate the arcsine, since the direct use of the arcsine function makes symbolic and numerical optimization quite difficult.  The <a href="http://reference.wolfram.com/language/ref/Clip.html">Clip</a> function is used to prevent complex numbers from appearing in the optimization process.  Using NMinimize to solve this non-linear optimization problem will not produce fast results as the function searches the global minimum of functionality using hybrid symbol-numerical methods, so it was decided instead to use the <a href="http://reference.wolfram.com/language/ref/FindMinimum.html">FindMinimium</a> function, which perfectly looks using purely numerical methods minimum. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/eed/2bc/717/eed2bc717f5e43d68034627cb129e5b1.gif" width="574" height="571"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/637/9b4/f32/6379b4f32ad6b73b9c636c1724556720.png" width="590" height="69"><br><br>  Here is what we get as a result of the mapping: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0cb/2fe/4aa/0cb2fe4aad99368ed7b49d6ec9482b66.gif" width="571" height="530"><br><br>  The resulting label image: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/668/108/53d/66810853d6ec63532b46c7905d254d39.gif" width="571" height="428"><br><br>  The obtained boundaries describe the contour of the label quite well.  The characters look the same in size, and therefore the distortion has little effect.  The optimization solution can also be checked directly: by optimizing, we will try to estimate the cylinder radius R and the X coordinate of the cylinder center, and the resulting values ‚Äã‚Äãwill be only a few pixels away from their actual positions in the image. <br><br><h2>  Checking the operation of the algorithm on real data </h2><br>  Similar pictures were found on Google and the developed algorithm was tested.  The results of the algorithm in fully automatic mode are shown below, but some of the images have been cropped a bit beforehand.  The results look very promising: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/811/aba/ec2/811abaec2d1ab136ff388e4b68aa98d3.gif" width="636" height="302"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/642/fcc/10b/642fcc10b28801d3eaa83978fef77436.gif" width="622" height="302"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/fbd/f2c/038/fbdf2c038d9e18ca560e18903d4e7a7f.gif" width="633" height="302"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e14/69b/a1f/e1469ba1f863f33be8dc0364cf312a40.gif" width="661" height="302"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/3b3/4bf/0b6/3b34bf0b63a4b3f8c5630b9adcee94a5.gif" width="784" height="502"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/9b6/82a/4c1/9b682a4c12de82006464a7d54aa23a91.gif" width="571" height="363"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a2b/37e/032/a2b37e032187ce5a3bc39bcfbb8f6342.gif" width="569" height="302"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/8a8/a3d/be8/8a8a3dbe8f623ae252ae1e989ed80bb3.gif" width="571" height="256"><br><br>  As expected, label detection is the least sustainable step of the algorithm, and therefore it was necessary to crop images in some cases.  If you mark the points on the label and outside it, the segmentation based on the boundaries will have to give the best result. <br><br><h2>  Additional algorithm improvements </h2><br>  User Szabolcs <a href="http://mathematica.stackexchange.com/questions/5676/how-to-peel-the-labels-from-marmalade-jars-using-mathematica/5707">offered</a> an interactive version of the code that allows you to improve the result. <br><br>  For my part, I propose to improve the proposed interactive interface by manually selecting the left and right edges of the image, for example, using locators: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bc4/0cf/d99/bc40cfd9934def4e764b9ce12a798906.png" width="502" height="88"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/30d/415/712/30d4157123899d4c0cb96d029a801475.gif" width="171" height="197"><br><br>  Then it will be possible to get the parameters r and cx in an explicit form, and not through optimization: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ff4/d67/fc3/ff4d67fc35242b6c62cba538c6c0cc16.gif" width="574" height="272"><br><br>  Using this solution, the result is practically without distortion: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/84b/5d1/4b8/84b5d14b89e97e21b71f1a79b471a22e.gif" width="571" height="327"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e46/e60/55f/e46e6055fa2710b86ffa9810d32c50dd.gif" width="571" height="226"></div><p>Source: <a href="https://habr.com/ru/post/266517/">https://habr.com/ru/post/266517/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266501/index.html">Seagate Wireless Disc Firmware Vulnerabilities Allow Download and Download Files Remotely</a></li>
<li><a href="../266503/index.html">GNS3 basics. Overview</a></li>
<li><a href="../266509/index.html">RCC 2015 final September 19</a></li>
<li><a href="../266513/index.html">Perfect ERP or controlled blast</a></li>
<li><a href="../266515/index.html">CRM work protocol in a medical institution</a></li>
<li><a href="../266519/index.html">Intel Broadwell Xeon E3-1200 v4 - all you need to know about the new line of Xeon and eDRAM</a></li>
<li><a href="../266521/index.html">Release Phalcon 2.1.0 beta 1</a></li>
<li><a href="../266527/index.html">One customer, two premises, four providers and eight connections</a></li>
<li><a href="../266529/index.html">Zigbee for the little ones. Post number 1</a></li>
<li><a href="../266533/index.html">A variety of network security tests: a review of IXIA solutions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>