<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Efficient DI library on Swift in 200 lines of code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The EasyDi library contains a dependency container for Swift. The syntax of this library has been specifically designed for quick mastering and effici...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Efficient DI library on Swift in 200 lines of code</h1><div class="post__text post__text-html js-mediator-article">  The <b>EasyDi</b> library contains a dependency container for Swift.  The syntax of this library has been specifically designed for quick mastering and efficient use.  It fits in 200 lines, while it can do everything that is necessary for an adult Di library: <br><br>  - Creating objects and introducing dependencies into existing ones <br>  - Division into containers - Assemblies <br>  - Types of dependency resolution: object graph, singleton, prototype <br>  - Resolution of cyclic dependencies <br>  - Substitution of objects and special tests of dependencies for tests <br><br>  EasyDi has no register / resolve.  Instead, dependencies are described like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> apiClient: <span class="hljs-type"><span class="hljs-type">IAPIClient</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> define(<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>: <span class="hljs-type"><span class="hljs-type">APIClient</span></span>()) { $<span class="hljs-number"><span class="hljs-number">0</span></span>.baseURl = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.baseURL } }</code> </pre> <br>  ‚Üí <a href="https://cocoapods.org/pods/EasyDi">Cocoapods / EasyDi</a> <br>  ‚Üí <a href="https://github.com/AndreyZarembo/EasyDi">Github / EasyDi</a> <br><br>  Under the cut there is a very brief description of ‚ÄúWhy DI and what it is‚Äù, as well as examples of using the library: <br><br><ul><li>  How to use and types of dependencies </li><li>  How to test with the substitution of objects </li><li>  How can this be used for A / B tests </li><li>  How to build a VIPER module </li></ul><a name="habracut"></a><br><h2>  Why DI and what is it? (Very briefly) </h2><br>  Inverting dependencies in a project is very important if it contains more than 5 screens and will be supported for more than a year. <br><br>  Here are three basic scenarios where DI makes life better: <br><br><ul><li>  <b>Parallel development</b> .  One developer will be able to deal with the UI, and the second data, if you agree in advance on the protocol of work.  The UI can then be developed with test data, and the data layer can be invoked from the test UI. </li><li>  <b>Tests</b>  By replacing the network layer with objects with fixed answers, you can check all UI behaviors, including in case of errors. </li><li>  <b>Refactoring</b> .  The network layer can be replaced with a new one, fast with cache and another API, if you leave the protocol with the UI unchanged. </li></ul><br>  The essence of DI can be described as one sentence: <br><br><blockquote>  Dependencies for objects must be closed by protocols and transferred to the object from the outside. </blockquote><br>  Those.  instead: <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OrderViewController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">didClickShopButton</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender: UIButton?)</span></span></span></span> { <span class="hljs-type"><span class="hljs-type">APIClient</span></span>.sharedInstance.purchase(...) } }</code> </pre><br>  Worth using: <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IPurchaseService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">perform</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OrderViewController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> purchaseService: <span class="hljs-type"><span class="hljs-type">IPurchaseService?</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">didClickShopButton</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender: UIButton?)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.purchaseService?.perform(...) } }</code> </pre><br>  You can learn more about dependency inversion and the SOLID concept. <br>  <a href="https://www.objc.io/issues/15-testing/dependency-injection/">here (objc.io # 15 DI)</a> and <a href="https://en.wikipedia.org/wiki/SOLID_(object-oriented_design)">here (wikipedia. SOLID)</a> . <br><br><h2>  How to work with EasyDi (simple example) </h2><br>  A simple example of using the library: remove work from the network into the services from ViewController and place their creation and dependencies in a separate container.  This is an easy and effective way to start dividing an application into layers.  In the example, consider the service and controller from the example above. <br><br><div class="spoiler">  <b class="spoiler_title">Sample service code and controller</b> <div class="spoiler_text"><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IPurchaseService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">perform</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(with objectId: String, then completion: </span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(success: Bool)</span></span></span></span></span></span>-&gt;<span class="hljs-type"><span class="hljs-type">Void</span></span>) } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseService</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IPurchaseService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> baseURL: <span class="hljs-type"><span class="hljs-type">URL?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> apiPath = <span class="hljs-string"><span class="hljs-string">"/purchase/"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> apiClient: <span class="hljs-type"><span class="hljs-type">IAPIClient?</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">perform</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(with objectId: String, then completion: </span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"> success: Bool)</span></span></span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> apiClient = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.apiClient, <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> url = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.baseURL <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">fatalError</span></span>(<span class="hljs-string"><span class="hljs-string">"Trying to do something with uninitialized purchase service"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> purchaseURL = baseURL.appendingPathComponent(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.apiPath).appendingPathComponent(objectId) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> urlRequest = <span class="hljs-type"><span class="hljs-type">URLRequest</span></span>(url: purchaseURL) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.apiClient.post(urlRequest) { (<span class="hljs-number"><span class="hljs-number">_</span></span>, error) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> success: <span class="hljs-type"><span class="hljs-type">Bool</span></span> = (error == <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) completion( success ) } } }</code> </pre><br>  Controller: <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OrderViewController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> purchaseService: <span class="hljs-type"><span class="hljs-type">IPurchaseService?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> purchaseId: <span class="hljs-type"><span class="hljs-type">String?</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">didClickShopButton</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender: UIButton?)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> purchaseService = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.purchaseService, <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> purchaseId = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.purchaseId <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">fatalError</span></span>(<span class="hljs-string"><span class="hljs-string">"Trying to do something with uninitialized order view controller"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.purchaseService.perform(with: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.purchaseId) { (success) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.presenter(showOrderResult: success) } } }</code> </pre><br></div></div><br>  Service dependencies: <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceAssembly</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Assembly</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> purchaseService: <span class="hljs-type"><span class="hljs-type">IPurchaseService</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> define(<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>: <span class="hljs-type"><span class="hljs-type">PurchaseService</span></span>()) { $<span class="hljs-number"><span class="hljs-number">0</span></span>.baseURL = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.apiV1BaseURL $<span class="hljs-number"><span class="hljs-number">0</span></span>.apiClient = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.apiClient } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> apiClient: <span class="hljs-type"><span class="hljs-type">IAPIClient</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> define(<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>: <span class="hljs-type"><span class="hljs-type">APIClient</span></span>()) } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> apiV1BaseURL: <span class="hljs-type"><span class="hljs-type">URL</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> define(<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>: <span class="hljs-type"><span class="hljs-type">URL</span></span>(<span class="hljs-string"><span class="hljs-string">"http://someapi.com/"</span></span>)!) } }</code> </pre><br>  And this is how we implement the service in the controller: <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> orderViewAssembly: <span class="hljs-type"><span class="hljs-type">Assembly</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serviceAssembly: <span class="hljs-type"><span class="hljs-type">ServiceAssembly</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.context.assembly() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(into controller: OrderViewController, purchaseId: String)</span></span></span></span> { define(<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>: controller) { $<span class="hljs-number"><span class="hljs-number">0</span></span>.purchaseService = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.serviceAssembly.purchaseService $<span class="hljs-number"><span class="hljs-number">0</span></span>.purchaseId = purchaseId } } }</code> </pre><br>  Now you can change the class of service without getting into the ViewController. <br><br><h2>  Types of dependency resolution (Example of average complexity) </h2><br><h3>  ObjectGraph </h3><br>  By default, all dependencies are resolved through the object graph.  If the object is already on the stack of the current object graph, then it is used again.  This allows you to embed the same object in several, as well as allow circular dependencies.  For example, let's take objects A, B and C with links A-&gt; B-&gt; C. (Let's not pay attention to the RetainCycle, it is needed for completeness of the example). <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b: <span class="hljs-type"><span class="hljs-type">B?</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">B</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>: <span class="hljs-type"><span class="hljs-type">C?</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">C</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a: <span class="hljs-type"><span class="hljs-type">A?</span></span> }</code> </pre><br>  Here is the Assembly and here is the dependency graph for two requests A. <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ABCAssembly</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Assembly</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a:<span class="hljs-type"><span class="hljs-type">A</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> define(<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>: <span class="hljs-type"><span class="hljs-type">A</span></span>()) { $<span class="hljs-number"><span class="hljs-number">0</span></span>.b = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>() } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b:<span class="hljs-type"><span class="hljs-type">B</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> define(<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>: <span class="hljs-type"><span class="hljs-type">B</span></span>()) { $<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-type"><span class="hljs-type">C</span></span>() } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:<span class="hljs-type"><span class="hljs-type">C</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> define(<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>: <span class="hljs-type"><span class="hljs-type">C</span></span>()) { $<span class="hljs-number"><span class="hljs-number">0</span></span>.a = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-type"><span class="hljs-type">A</span></span>() } } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a1 = <span class="hljs-type"><span class="hljs-type">ABCAssembly</span></span>.instance().a <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a2 = <span class="hljs-type"><span class="hljs-type">ABCAssembly</span></span>.instance().a</code> </pre><br><img src="https://habrastorage.org/web/758/4ee/79f/7584ee79faa2437d8df3b0f59facef60.png"><br>  It turned out two independent graphs. <br><br><h3>  Singleton </h3><br>  But it happens that you need to create one object, which will then be used everywhere, for example, an analytics system or a repository.  You should not use classic Singleton with SharedInstance, since  it will be impossible to replace it.  For these purposes, EasyDi has scope: singleton.  This object is created once, dependencies are injected into it once, and more than EasyDi does not change it, only returns.  For example, make B a singleton. <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ABCAssembly</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Assembly</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a:<span class="hljs-type"><span class="hljs-type">A</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> define(<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>: <span class="hljs-type"><span class="hljs-type">A</span></span>()) { $<span class="hljs-number"><span class="hljs-number">0</span></span>.b = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>() } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b:<span class="hljs-type"><span class="hljs-type">B</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> define(scope: .lazySingleton, <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>: <span class="hljs-type"><span class="hljs-type">B</span></span>()) { $<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-type"><span class="hljs-type">C</span></span>() } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:<span class="hljs-type"><span class="hljs-type">C</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> define(<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>: <span class="hljs-type"><span class="hljs-type">C</span></span>()) { $<span class="hljs-number"><span class="hljs-number">0</span></span>.a = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-type"><span class="hljs-type">A</span></span>() } } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a1 = <span class="hljs-type"><span class="hljs-type">ABCAssembly</span></span>.instance().a <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a2 = <span class="hljs-type"><span class="hljs-type">ABCAssembly</span></span>.instance().a</code> </pre><br><img src="https://habrastorage.org/web/f51/b38/e84/f51b38e842804c9992bd338eb92a40ac.png"><br><br>  This time we got one graph of objects, since  B has become common. <br><br><h3>  Prototype </h3><br>  And sometimes you need to get a new object with each call.  Using the example of ABC objects for an A-prototype, it would look like this: <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ABCAssembly</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Assembly</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a:<span class="hljs-type"><span class="hljs-type">A</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> define(scope: .prototype, <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>: <span class="hljs-type"><span class="hljs-type">A</span></span>()) { $<span class="hljs-number"><span class="hljs-number">0</span></span>.b = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>() } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b:<span class="hljs-type"><span class="hljs-type">B</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> define(<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>: <span class="hljs-type"><span class="hljs-type">B</span></span>()) { $<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-type"><span class="hljs-type">C</span></span>() } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:<span class="hljs-type"><span class="hljs-type">C</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> define(<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>: <span class="hljs-type"><span class="hljs-type">C</span></span>()) { $<span class="hljs-number"><span class="hljs-number">0</span></span>.a = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-type"><span class="hljs-type">A</span></span>() } } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a1 = <span class="hljs-type"><span class="hljs-type">ABCAssembly</span></span>.instance().a <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a2 = <span class="hljs-type"><span class="hljs-type">ABCAssembly</span></span>.instance().a</code> </pre><br><img src="https://habrastorage.org/web/473/7f7/f49/4737f7f491b54f809397918910a65028.png"><br><br>  It turns out that two object graphs give 4 copies of object A <br><br>  It is important to understand that this is the entry point to the graph and other dependencies do not need to be made prototypes.  If you combine the prototypes into a loop, the stack will overflow and the application will crash. <br><br><h3>  Patches and contexts for tests (Complicated example) </h3><br>  When testing it is important to maintain the independence of tests.  In EasyDi, this is provided by the Assemblies contexts.  For example, integration tests where singletons are used.  They are used like this: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> context: DIContext = DIContext() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> assemblyInstance2 = TestAssembly.instance(<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>: context)</code> </pre><br>  It is important to ensure that the contexts of shared Assemblies match. <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FeedViewAssembly</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Assembly</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">lazy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serviceAssembly:<span class="hljs-type"><span class="hljs-type">ServiceAssembly</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.context.assembly() }</code> </pre><br>  Another important part of testing is moki and stubs, that is, objects with known behavior.  With known input data, the tested object gives a known result.  If it does not, then the test fails.  You can learn more about testing <a href="https://www.objc.io/issues/15-testing/">here (objc.io # 15 is all)</a> .  And this is how you can replace the object: <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ITheObject</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> intParameter: <span class="hljs-type"><span class="hljs-type">Int</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyAssembly</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Assembly</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> theObject: <span class="hljs-type"><span class="hljs-type">ITheObject</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> define(<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>: <span class="hljs-type"><span class="hljs-type">TheObject</span></span>()) { $<span class="hljs-number"><span class="hljs-number">0</span></span>.intParameter = <span class="hljs-number"><span class="hljs-number">10</span></span> } } } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> myAssembly = <span class="hljs-type"><span class="hljs-type">MyAssembly</span></span>.instance() myAssembly.addSubstitution(<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>: <span class="hljs-string"><span class="hljs-string">"theObject"</span></span>) { () -&gt; <span class="hljs-type"><span class="hljs-type">ITheObject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-type"><span class="hljs-type">FakeTheObject</span></span>() result.intParameter = <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result }</code> </pre><br>  Now theObject property will return a new object of a different type with a different intParameter. <br><br><div class="spoiler">  <b class="spoiler_title">about A / B tests</b> <div class="spoiler_text"><h3>  about A / B tests </h3><br>  The same mechanism can be used for a / b testing in the application.  For example, like this: <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-type"><span class="hljs-type">FeatureAssembly</span></span>: <span class="hljs-type"><span class="hljs-type">Assembly</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> feature: <span class="hljs-type"><span class="hljs-type">IFeature</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> define(<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>: <span class="hljs-type"><span class="hljs-type">Feature</span></span>) { ... } } } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-type"><span class="hljs-type">FeatureABTestAssembly</span></span>: <span class="hljs-type"><span class="hljs-type">Assembly</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">lazy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> featureAssembly: <span class="hljs-type"><span class="hljs-type">FeatureAssembly</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.context.assembly() <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> feature: <span class="hljs-type"><span class="hljs-type">IFeature</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> define(<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>: <span class="hljs-type"><span class="hljs-type">FeatureV2</span></span>) { ... } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">activate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(firstTest: Bool)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstTest) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.featureAssembly.addSubstitution(<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>: <span class="hljs-string"><span class="hljs-string">"feature"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.feature } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.featureAssembly.removeSubstitution(<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>: <span class="hljs-string"><span class="hljs-string">"feature"</span></span>) } } }</code> </pre><br>  Here a separate container is created for the test, which creates the second version of the object and allows you to enable / disable the substitution of this object. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">VIPER dependency injection</b> <div class="spoiler_text"><h2>  VIPER dependency injection </h2><br><br>  It so happens that it is necessary to inject dependencies into an existing object, and someone also depends on it.  The most obvious example is VIPER, when you need to add a Presenter to the ViewController, and he must get a link to the ViewController. <br><br>  To do this, EasyDi has 'keys' and placeholders with which you can return the same object from different methods.  It looks like this: <br><br><pre> <code class="hljs swift">lass <span class="hljs-type"><span class="hljs-type">ModuleAssembly</span></span>: <span class="hljs-type"><span class="hljs-type">Assembly</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(into view: ModuleViewController)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> define(key: <span class="hljs-string"><span class="hljs-string">"view"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>: view) { $<span class="hljs-number"><span class="hljs-number">0</span></span>.presenter = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.presenter } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> view: <span class="hljs-type"><span class="hljs-type">IModuleViewController</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> definePlaceholder() } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> presenter: <span class="hljs-type"><span class="hljs-type">IModulePresenter</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> define(<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>: <span class="hljs-type"><span class="hljs-type">ModulePresenter</span></span>()) { $<span class="hljs-number"><span class="hljs-number">0</span></span>.view = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.view $<span class="hljs-number"><span class="hljs-number">0</span></span>.interactor = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.interactor } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> interaction: <span class="hljs-type"><span class="hljs-type">IModuleInteractor</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> define(<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>: <span class="hljs-type"><span class="hljs-type">ModuleInteractor</span></span>()) { $<span class="hljs-number"><span class="hljs-number">0</span></span>.presenter = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.presenter ... } } }</code> </pre><br>  Here, injecting dependencies into the ViewController uses the inject method, which is keyed with the viewController property.  Now this property returns the object passed to the inject method.  And only when resolving dependencies of the object graph, which begins with the inject method. <br></div></div><br><h2>  Instead of conclusion </h2><br>  I didn‚Äôt have a goal to pack everything in 200 lines, it just happened.  Typhoon had the most impact on this library, I really wanted to have something similar, but Swift was even simpler. <br><br>  The longest was formed syntax, such as to write a minimum of code and with a minimum of space for the flight of thought.  This is especially important when working in a team. <br><br>  The library is packed into 1 file to make it easier to add to transitional projects where use_frameworks is not used yet, but Swift is already there. <br><br>  Links to the library: <br><br><ul><li>  <a href="https://cocoapods.org/pods/EasyDi">Cocoapods / EasyDi</a> </li><li>  <a href="https://github.com/AndreyZarembo/EasyDi">Github / EasyDi</a> </li></ul><br>  Current version is <b>'1.1.1'</b> <br> <code>pod 'EasyDi', '~&gt;1.1'</code> <br> <br>  It should work equally well on <b>Swift 3/4</b> , in <b>iOS 8+</b> . <br>  On iOS 7 - I do not know, I can not check. <br><br>  And the depot app is the XKCD comic reader. </div><p>Source: <a href="https://habr.com/ru/post/331710/">https://habr.com/ru/post/331710/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../331698/index.html">Integration of statistical code analysis tools for OpenStack to Jenkins CI</a></li>
<li><a href="../331700/index.html">An integrated approach to protection against targeted attacks and extortionate software such as Ransomware</a></li>
<li><a href="../331704/index.html">What happens if you cross React and Angular?</a></li>
<li><a href="../331706/index.html">Alternatives to the blockchain for maintaining secure registries</a></li>
<li><a href="../331708/index.html">Results of the Stepik Contest and new adaptive online courses</a></li>
<li><a href="../331712/index.html">Evolution after evolution</a></li>
<li><a href="../331714/index.html">Translation of the Appium Essentials book. Chapter 3</a></li>
<li><a href="../331718/index.html">How to earn $ 80,000 on the App Store</a></li>
<li><a href="../331720/index.html">Tuning a Linux network stack for the lazy</a></li>
<li><a href="../331722/index.html">Training at PG Day'17 Russia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>