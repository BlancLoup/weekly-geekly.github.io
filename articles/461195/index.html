<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>IR interface, Raspberry and LIRC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="My task now is to learn how to send commands to air conditioners and other devices in the house. Initially, these devices have only IR remote control....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>IR interface, Raspberry and LIRC</h1><div class="post__text post__text-html js-mediator-article"><p>  My task now is to learn how to send commands to air conditioners and other devices in the house.  Initially, these devices have only IR remote control.  To solve this problem, I have a Raspberry Pi and IR transceiver shield.  In the article you can find configs, teams, tips and a little theory.  From the software will be LIRC (Linux Infrared Remote Control) and Python. </p><a name="habracut"></a><br><p>  I found <a href="http://www.lirc.org/">LIRC</a> with the help of Google.  In the process of research, I found out that LIRC works with both transmitters and receivers of IR signals, can decode the received signal and perform some actions in connection with this.  Now I do not need signal reception, but in the future it may be useful.  If you mess with LIRC yourself, reading the <a href="http://www.lirc.org/html/configuration-guide.html">LIRC Configuration Guide is</a> highly recommended. </p><br><h3 id="konfiguraciya">  Configuration </h3><br><pre><code class="bash hljs">apt-get update apt-get install lirc</code> </pre> <br><pre> <code class="plaintext hljs"># /etc/modules (  ) lirc_dev lirc_rpi gpio_in_pin=18 gpio_out_pin=17</code> </pre> <br><pre> <code class="plaintext hljs"># /etc/lirc/hardware.conf (   ,  ) LIRCD_ARGS="--uinput --listen" LOAD_MODULES=true DRIVER="default" DEVICE="/dev/lirc0" MODULES="lirc_rpi"</code> </pre> <br><pre> <code class="plaintext hljs"># /boot/config.txt (       lirc,  ) dtoverlay=lirc-rpi,gpio_in_pin=18,gpio_out_pin=17</code> </pre><br><pre> <code class="plaintext hljs"># /etc/lirc/lirc_options.conf (    ) driver = default device = /dev/lirc0</code> </pre> <br><pre> <code class="bash hljs">reboot sudo /etc/init.d/lircd status</code> </pre> <br><h3 id="zapis">  Record </h3><br><p>  First you need to create a configuration file with data sequences for all the necessary commands.  I continue to call this file <code>lircd.conf</code> , but on each device itself it creates its own file <code>my_device_name.lircd.conf</code> in the <code>/etc/lirc/lircd.conf.d</code> directory. </p><br><p>  The file format is described <a href="http://www.lirc.org/html/lircd.conf.html">here</a> .  If you have a remote control, you can write the signals transmitted by it to a file using the <a href="http://www.lirc.org/html/irrecord.html">irrecord</a> utility. </p><br><pre> <code class="bash hljs">/etc/init.d/lircd stop irrecord -d /dev/lirc0 ~/my_device.lircd.conf mv ~/my_device.lircd.conf /etc/lirc/lircd.conf.d/</code> </pre> <br><p>  <code>irrecord</code> analyzes the sequences and tries to determine the protocol and time parameters.  In some cases, <code>irrecord</code> fails in the analysis, so it is possible to save the sequence as it was accepted in a raw form, there is a <code>--force</code> switch for this. </p><br><p>  But even with <code>--force</code> <code>irrecord</code> tries to analyze something, and may also fail.  Then you can record the sequences using <code>mode2</code> and create the file yourself. </p><br><p>  <code>mode2</code> prints sequentially the duration of the presence and absence of a signal, from which the transmitted data is composed.  Duration is measured in microseconds (1e-6 seconds).  In the raw format, the same durations are indicated in lircd.conf, starting with 'pulse' (the leading 'space' is not needed).  Accordingly, there should always be an odd number of numbers (it starts and ends with the presence of a signal - 'pulse'). </p><br><p>  For automation, I made a script for recording that asks for the name of the command, runs <code>mode2</code> for 5 seconds, remembers and finally prints the result in the format ready for lircd.conf (see under the spoiler). </p><br><div class="spoiler">  <b class="spoiler_title">Script</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python3 import io import sys import os r = """begin remote name DEVICE_NAME_CHANGE_ME flags RAW_CODES eps 30 aeps 100 gap 19037 begin raw_codes """ while True: print() print("enter the command name, or just press Enter to finish") a = sys.stdin.readline().rstrip("\n\r") if not a: break first_space = True n = 0 r += " name " + a + "\n" for line in os.popen('timeout 5s mode2 -d /dev/lirc0 2&gt; /dev/null').read().split('\n'): words = line.split() if len(words) &lt; 2: continue if words[0] != 'space' and words[0] != 'pulse': continue if first_space and words[0] == 'space': first_space = False continue if n % 4 == 0: r += "\n " r += words[1] + " " n = n+1 if n &gt; 5: print ("got", n, "values, looks good") else: print ("no signal, something went wrong") r += "\n\n" r += """ end raw_codes end remote """ print() print(r) print()</span></span></code> </pre> </div></div><br><p>  <code>irrecord --analyse</code> file, you can try to "recognize" it again using <code>irrecord --analyse</code> .  This is not always successful, do not rush to throw away the old file.  My statistics are as follows: the remote control from the LG TV was easy to understand, all air conditioners and a vacuum cleaner required manual creation, the vacuum cleaner was then processed by <code>--analyse</code> . </p><br><p>  Just as an example: <a href="https://gist.github.com/tseglevskiy/6d9bf05b57ec7cf351b91466fba19390">this is what the file for my vacuum cleaner looks like</a> . </p><br><h4 id="standartnye-imena-komand">  Standard Team Names </h4><br><p>  For its intended purpose, the LIRC should turn the received and recognized IR signal into a <em>Linux input</em> event.  Therefore, by default, we are required to have the command names in lircd.conf from the standard list.  You can see a list of valid names: </p><br><pre> <code class="bash hljs">irrecord --list-namespace</code> </pre> <br><p>  Air conditioners do not fall under this pattern.  The requirement for names can be turned off by adding a parameter when writing: </p><br><pre> <code class="bash hljs">irrecord --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-namespace ....</code> </pre> <br><h3 id="otladka">  Debugging </h3><br><p>  Check the receiver helps <code>mode2</code> utility, which prints all visible signals. </p><br><pre> <code class="bash hljs">/etc/init.d/lircd stop mode2 -d /dev/lirc0</code> </pre> <br><p>  It is easiest to check the transmission if there is another receiver and <code>mode2</code> running on it.  In especially hopeless cases, you can change the value at the output of the GPIO and check with a tester or oscilloscope where the signal goes.  The <code>gpio</code> team is part of the <a href="http://wiringpi.com/the-gpio-utility/">wiringpi</a> package. </p><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> sleep 1; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> gpio -g toggle 17 <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><p>  You can look at the logs using <code>journalctl</code> , in particular, this allows you to see errors in the configuration file: </p><br><pre> <code class="bash hljs">journalctl -b 0 /usr/sbin/lircd</code> </pre> <br><h3 id="otpravka-komand">  Sending commands </h3><br><p>  There is an <code>irsend</code> utility for transmitting recorded commands.  She can also show a list of known devices, and a list of known commands for each device.  Pay attention to the "empty arguments" in the example below, they are needed there. </p><br><p>  <code>irsend</code> is a client for <code>lircd</code> , so if something went wrong, look in the logs (see above). </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   irsend LIST "" "" #     LG_TV irsend LIST LG_TV "" #   ON irsend SEND_ONCE LG_TV ON</span></span></code> </pre> <br><p>  Theoretically, there is another possibility - send commands to <em>lircd</em> through its socket.  I did not understand. </p><br><h3 id="vyzov-iz-python">  Call from Python </h3><br><p>  Almost all libraries are just a kit over <code>irsend</code> .  The only library I found that compiles the client for the API via the socket does not work on Raspberry (another version of lircd is needed).  Therefore, there is little sense in them; I can call the command myself: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> subprocess subprocess.call([<span class="hljs-string"><span class="hljs-string">"irsend"</span></span>, <span class="hljs-string"><span class="hljs-string">"send_once"</span></span>, <span class="hljs-string"><span class="hljs-string">"BEDROOM_AC"</span></span>, <span class="hljs-string"><span class="hljs-string">"OFF"</span></span>])</code> </pre> <br><h3 id="hardware">  Hardware </h3><br><img src="https://habrastorage.org/webt/ra/6g/qw/ra6gqwfqx5ksnzpyoaqefa4c6_4.png" alt="IR hat" align="left"><br><p>  I use a ready-made board, there are a lot of them on <a href="https://www.amazon.com/IR-Remote-Control-Transceiver-Raspberry/dp/B0713SK7RJ">Amazon</a> and <a href="https://www.aliexpress.com/wholesale%3FcatId%3D0%26SearchText%3Draspberry%2Binfrared%2Btransmitter%2Bshield">AliExpress</a> .  You can google it like "Raspberry infrared sheild."  It uses GPIO 17 for output, and GPIO 18 for input, as can be seen from the configs above. </p><br><p>  There is a place on the board for the second (additional) LED D2, which is not installed by default.  When using two LEDs, they are connected in <strong>series</strong> .  Therefore, in the absence of LED D2, you must close the jumper SJ1.  I was surprised to find that on all my boards the jumper was initially open.  I had to modify the soldering iron. </p><br><div class="spoiler">  <b class="spoiler_title">Larger photo for those wishing to take a look</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/mw/zx/cv/mwzxcvky2udvljqqbz1kgff8ytg.jpeg" alt="IRDA Hat"></p></div></div><br><h3 id="itogi">  Summary </h3><br><p>  It works: the signal is transmitted, the devices see it and react correctly to it. </p><br><p>  Much depends on the position of the diode emitter, it must be precisely aimed at the receiver.  One fixed transmitter cannot control all the devices in the room.  Cloning a Raspberry Pi-based solution for each gadget is expensive, you need to either modify the emitter to "cover a larger area" or find a cheaper platform. </p><br><p>  LIRC was originally created to convert IR signals into standard Linux events of input devices.  Therefore, it is natural for him that one button is one code.  For some devices (most Air conditioner) this is not so: when you click on any button, the remote control transmits a data packet containing the complete state of the device (on, operating mode, temperature, fan operation modes, time, timer, etc.).  There is no way to build a multi-component package based on several parameters in LIRC, therefore, it helps as a quick tool out of the box, but then you will have to look for something else.  Although for most cases, the recorded data with the usual fan settings and without exotic modes is enough. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/461195/">https://habr.com/ru/post/461195/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../46118/index.html">Sega on your mobile</a></li>
<li><a href="../461181/index.html">We introduce IdM. View from the implementation engineer</a></li>
<li><a href="../461185/index.html">JsonDiscovery: Changing browsing experience for JSON</a></li>
<li><a href="../461191/index.html">Recordings from summer DIYorDIE Meetup June 16th</a></li>
<li><a href="../461193/index.html">With you FizTech.Science: eliminate cognitive distortion and comprehend the secrets of the mind</a></li>
<li><a href="../461197/index.html">Tales about the harsh Russian IT and digitalization victims</a></li>
<li><a href="../461199/index.html">How to use PAM-modules for local authentication in Linux using GOST-2012 keys on Rutoken</a></li>
<li><a href="../4612/index.html">GooYahoo or MicroYahoo? Terry camel time to think about the future</a></li>
<li><a href="../46120/index.html">Facebook Connect. Universal Internet Passport.</a></li>
<li><a href="../461201/index.html">Themes and styles in Android apps</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>