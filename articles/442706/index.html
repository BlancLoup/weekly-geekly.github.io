<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MySQL - Using Variables in Query</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quite often they ask whether there are analogues of analytical (window) functions in MySQL. Note. At the time of writing, there were no such analogues...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MySQL - Using Variables in Query</h1><div class="post__text post__text-html js-mediator-article">  Quite often they ask whether there are analogues of analytical (window) functions in MySQL.  <b>Note.</b>  <i>At the time of writing, there were no such analogues, however, the article still represents academic interest in terms of analyzing the original MySQL approach to using variables.</i> <br><br>  To replace analytic functions, often use queries with self-connections, complex subqueries, and so on.  Most of these solutions are inefficient in terms of performance. <br><br>  Also in MySQL there is no recursion.  However, with some of the problems that are usually solved by analytical functions or recursion, you can cope with the tools of MySQL. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      One of these tools is a unique, uncharacteristic for other DBMS, mechanism for working with variables within an SQL query.  We can declare a variable inside a query, change its value and substitute it in a SELECT for output.  Moreover, the order of processing the rows in the query and, as a result, the order in which values ‚Äã‚Äãare assigned to variables can be specified in custom sorting! <br><br>  A warning.  The article assumes that the processing of expressions in the SELECT clause is carried out from left to right, but there is no official confirmation of such processing order in the MySQL documentation.  This must be borne in mind when changing the server version.  To guarantee the calculation sequence, you can use a dummy CASE or IF statement. <br><br><h2>  Analogue of recursion </h2><br>  Consider a simple example that generates the Fibonacci sequence (in the Fibonacci sequence, each term is equal to the sum of the two previous ones, and the first 2 are equal to one): <br><a name="habracut"></a><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(X=<span class="hljs-number"><span class="hljs-number">1</span></span>, Fn_1, Fn_2) F <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @I := @I + @J Fn_1, @J := @I + @J Fn_2 <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> dummy <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>)a, (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> dummy <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>)b, (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @I := <span class="hljs-number"><span class="hljs-number">1</span></span>, @J := <span class="hljs-number"><span class="hljs-number">1</span></span>)IJ )T, <span class="hljs-comment"><span class="hljs-comment">/* ,     1 */</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> X <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>)X;</code> </pre> <br>  This query generates 18 Fibonacci numbers, not counting the first two: <br><br><pre> <code class="plaintext hljs">2,3,5,8,13,21,34,55,89,144,233,377,610,987,1597,2584,4181,6765</code> </pre> <br>  We now analyze how it works. <br><br>  In lines 5) 6) 9 entries are generated.  There is nothing unusual. <br><br>  In line 7) we declare two variables @I, @J and assign them 1. <br><br>  In line 3) the following happens: first, the sum of two variables is assigned to the variable @I.  Then we assign the same to the @J variable, taking into account the fact that the value of @I has already changed. <br><br>  In other words, calculations in SELECT are performed from left to right - see also the remark at the beginning of the article. <br><br>  And change of variables is carried out in each of our 9 records, i.e.  during the processing of each new line, the variables @I and @J will contain the values ‚Äã‚Äãcalculated during the processing of the previous line. <br><br>  To solve this problem using other DBMS, we would have to write a <u>recursive query!</u> <br><br>  <b>Note:</b> <br>  <i>Variables need to be declared in a separate subquery (line 7), if we declared a variable in the SELECT clause, it would most likely be calculated only once (although the specific behavior will depend on the version of the server).</i>  <i>The type of a variable is determined by the value by which it is initialized.</i>  <i>This type may change dynamically.</i>  <i>If a variable is assigned NULL, its type will be BLOB.</i> <br><br>  The order in which rows are processed in SELECT, as mentioned above, depends on custom sorting.  A simple example of numbering lines in a given order: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> val, @I:=@I+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Num</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> val <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span>)a, (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @I := <span class="hljs-number"><span class="hljs-number">0</span></span>)I <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> val;</code> </pre><br><pre> <code class="plaintext hljs">Val Num 10 1 20 2 30 3 50 4</code> </pre> <br><h2>  Analogs of analytical functions </h2><br>  Variables can also be used to replace analytic functions.  Further some examples.  For simplicity, we assume that all fields are NOT NULL, and sorting and partitioning (PARTITION BY) occur in a single field.  Using NULL values ‚Äã‚Äãand more complex sorts will make the examples more cumbersome, but the essence does not change. <br><br>  For examples, create a TestTable table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> TestTable( <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, order_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> );</code> </pre><br>  Where <br>  group_id - group identifier (analogue of the analytic function window); <br>  order_id is a unique field that will be sorted; <br>  value is a numeric value. <br><br>  Fill out our table with test data: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> TestTable(order_id, <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> order_id, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span> )T;</code> </pre> <br>  Examples of the replacement of some analytical functions. <br><br><h3>  1) ROW_NUMBER () OVER (ORDER BY order_id) </h3><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> T.*, @I:=@I+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RowNum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable T,(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @I:=<span class="hljs-number"><span class="hljs-number">0</span></span>)I <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> order_id;</code> </pre> <br> <code>group_id order_id value RowNum <br> 1 1 1 1 <br> 1 2 2 2 <br> 1 3 2 3 <br> 2 4 1 4 <br> 2 5 2 5 <br> 2 6 3 6 <br> 3 7 1 7 <br> 3 8 2 8 <br> 4 9 1 9 <br> 3 11 2 10 <br></code> <br><h3>  2) ROW_NUMBER () OVER (PARTITION BY group_id ORDER BY order_id) </h3><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">RowNum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> T.*, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(@last_group_id = <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, @I:=@I+<span class="hljs-number"><span class="hljs-number">1</span></span>, @I:=<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RowNum</span></span>, @last_group_id := <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable T,(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @last_group_id:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @I:=<span class="hljs-number"><span class="hljs-number">0</span></span>)I <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id )T;</code> </pre> <br> <code>group_id order_id value RowNum <br> 1 1 1 1 <br> 1 2 2 2 <br> 1 3 2 3 <br> 2 4 1 1 <br> 2 5 2 2 <br> 2 6 3 3 <br> 3 7 1 1 <br> 3 8 2 2 <br> 3 11 2 3 <br> 4 9 1 1 <br></code> <br><h3>  3) SUM (value) OVER (PARTITION BY group_id ORDER BY order_id) </h3><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, RunningTotal <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> T.*, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(@last_group_id = <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, @I:=@I+<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, @I:=<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) RunningTotal, @last_group_id := <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable T, (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @last_group_id:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @I:=<span class="hljs-number"><span class="hljs-number">0</span></span>)I <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id )T;</code> </pre> <br> <code>group_id order_id value RunningTotal <br> 1 1 1 1 <br> 1 2 2 3 <br> 1 3 2 5 <br> 2 4 1 1 <br> 2 5 2 3 <br> 2 6 3 6 <br> 3 7 1 1 <br> 3 8 2 3 <br> 3 11 2 5 <br> 4 9 1 1 <br></code> <br><h3>  4) LAG (value) OVER (PARTITION BY group_id ORDER BY order_id) </h3><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, LAG <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> T.*, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(@last_group_id = <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">last_value</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) LAG, @last_group_id := <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">last_value</span></span> := <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable T,(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">last_value</span></span>:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @last_group_id:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)I <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id )T;</code> </pre> <br> <code>group_id order_id value LAG <br> 1 1 1 NULL <br> 1 2 2 1 <br> 1 3 2 2 <br> 2 4 1 NULL <br> 2 5 2 1 <br> 2 6 3 2 <br> 3 7 1 NULL <br> 3 8 2 1 <br> 3 11 2 2 <br> 4 9 1 NULL <br></code> <br>  For LEAD, everything is the same, only you need to change the sorting to ORDER BY group_id, order_id DESC <br><br>  For the COUNT, MIN, MAX functions, everything is somewhat more complicated, since until we analyze all the lines in the group (window), we will not be able to find out the meaning of the function.  MS SQL, for example, ‚Äúspools‚Äù a window for this purpose (temporarily places the rows of a window in a hidden buffer table for repeated access to them), in MySQL there is no such possibility.  But for each window we can calculate the value of the function in the last line for a given sort (that is, after analyzing the entire window), and then, sorting the lines in the window in reverse order, put the calculated value over the entire window. <br><br>  So we need two sorts.  To ensure that the final sorting remains the same as in the examples above, first sort by ASC group_id, order_id DESC fields, then ASC by group_id field, ASC order_id. <br><br><h3>  5) COUNT (*) OVER (PARTITION BY group_id) </h3><br>  In the first sort, we simply number the entries.  In the second window we assign the maximum number to all the lines, which will correspond to the number of lines in the window. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, Cnt <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(@last_group_id = <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, @MaxRowNum, @MaxRowNum := RowNumDesc) Cnt, @last_group_id := <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> T.*, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(@last_group_id = <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, @I:=@I+<span class="hljs-number"><span class="hljs-number">1</span></span>, @I:=<span class="hljs-number"><span class="hljs-number">1</span></span>) RowNumDesc, @last_group_id := <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable T,(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @last_group_id:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @I:=<span class="hljs-number"><span class="hljs-number">0</span></span>)I <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-comment"><span class="hljs-comment">/* */</span></span> )T,(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @last_group_id:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @MaxRowNum:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)I <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id <span class="hljs-comment"><span class="hljs-comment">/* */</span></span> )T;</code> </pre> <br> <code>group_id order_id value Cnt <br> 1 1 1 3 <br> 1 2 2 3 <br> 1 3 2 3 <br> 2 4 1 3 <br> 2 5 2 3 <br> 2 6 3 3 <br> 3 7 1 3 <br> 3 8 2 3 <br> 3 11 2 3 <br> 4 9 1 1 <br></code> <br>  The functions MAX and MIN are calculated by analogy.  I will give only an example for MAX: <br><br><h3>  6) MAX (value) OVER (PARTITION BY group_id) </h3><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, MaxVal <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(@last_group_id = <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, @MaxVal, @MaxVal := MaxVal) MaxVal, @last_group_id := <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> T.*, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(@last_group_id = <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GREATEST</span></span>(@MaxVal, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>), @MaxVal:=<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) MaxVal, @last_group_id := <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable T,(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @last_group_id:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @MaxVal:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)I <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> )T,(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @last_group_id:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @MaxVal:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)I <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id )T;</code> </pre> <br> <code>group_id order_id value MaxVal <br> 1 1 1 2 <br> 1 2 2 2 <br> 1 3 2 2 <br> 2 4 1 3 <br> 2 5 2 3 <br> 2 6 3 3 <br> 3 7 1 2 <br> 3 8 2 2 <br> 3 11 2 2 <br> 4 9 1 1 <br></code> <br><h3>  7) COUNT (DISTINCT value) OVER (PARTITION BY group_id) </h3><br>  An interesting thing that is missing in MS SQL Server, but it can be calculated with a subquery, taking MAX from RANK.  So do the same here.  In the first sorting, we calculate RANK () OVER (PARTITION BY group_id ORDER BY value DESC), then in the second sort we set the maximum value to all the rows in each window: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, Cnt <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(@last_group_id = <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span> := <span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>) Cnt, @last_group_id := <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> T.*, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(@last_group_id = <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(@<span class="hljs-keyword"><span class="hljs-keyword">last_value</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>:=@<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>) , @<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>:=<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>, @last_group_id := <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">last_value</span></span> := <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable T,(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">last_value</span></span>:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @last_group_id:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>:=<span class="hljs-number"><span class="hljs-number">0</span></span>)I <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>, order_id <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> )T,(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @last_group_id:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)I <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, order_id )T;</code> </pre> <br> <code>group_id order_id value Cnt <br> 1 1 1 2 <br> 1 2 2 2 <br> 1 3 2 2 <br> 2 4 1 3 <br> 2 5 2 3 <br> 2 6 3 3 <br> 3 7 1 2 <br> 3 8 2 2 <br> 3 11 2 2 <br> 4 9 1 1 <br></code> <br><h2>  Performance </h2><br>  To begin with, the numbering of lines in a query is comparable in performance using a self-join and using variables. <br><br><h4>  1) The classic self-joining method </h4><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*)N, T1.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable T1 <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> TestTable T2 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> T1.order_id &gt;= T2.order_id <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> T1.order_id;</code> </pre> <br>  With 10,000 entries in the table, TestTable gives: <br><br>  Duration / Fetch <br>  16.084 sec / 0.016 sec <br><br><h4>  2) Using variables: </h4><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @N:=@N+<span class="hljs-number"><span class="hljs-number">1</span></span> N, T1.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable T1, (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @N := <span class="hljs-number"><span class="hljs-number">0</span></span>)M <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> T1.order_id;</code> </pre> <br>  Issues: <br><br>  Duration / Fetch <br>  0.016 sec / 0.015 sec <br><br>  The result speaks for itself.  However, it should be understood that the values ‚Äã‚Äãcalculated using variables are not optimal for use in filtering conditions.  Sorting and computing will occur for ALL rows, despite the fact that in the end we need only a small part of them. <br><br>  Let us consider in more detail on the example of such a task: <br><br>  <b>Print the first 2 lines from the TestTable table for each group_id, sorted by order_id.</b> <br><br>  Here is how this task would be solved in a DBMS with the support of analytical functions: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *, ROW_NUMBER()<span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> order_id) <span class="hljs-keyword"><span class="hljs-keyword">RowNum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable )T <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RowNum</span></span> &lt;= <span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre> <br>  However, the MySQL optimizer knows nothing about the rules for calculating the RowNum field.  He will have to number all the lines, and only then select the necessary ones. <br><br>  Now imagine that we have 1 million records and 20 unique group_id values.  Those.  To select 40 rows, MySQL will calculate the RowNum value for a million rows!  There is no beautiful solution to this problem in one query in MySQL.  But you can first get a list of unique group_id values, for example, like this: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable;</code> </pre> <br>  Then by means of any other programming language to generate a query of the form: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> order_id <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> order_id <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>=<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> order_id <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre> <br>  20 light queries will work much faster than calculating the RowNum for a million rows. </div><p>Source: <a href="https://habr.com/ru/post/442706/">https://habr.com/ru/post/442706/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../442694/index.html">One of the streaming giants launched in India and attracted a million users in a week.</a></li>
<li><a href="../442696/index.html">S for Security: Internet Security of Things and reports on InoThings ++ 2019</a></li>
<li><a href="../442698/index.html">Moscow Metro application for Windows Store</a></li>
<li><a href="../442700/index.html">Should I engage in mobile solar power?</a></li>
<li><a href="../442704/index.html">Design, development and testing cycles</a></li>
<li><a href="../442712/index.html">According to sources: the controversial program of interception of the NSA is curtailed</a></li>
<li><a href="../442714/index.html">Like Defects</a></li>
<li><a href="../442716/index.html">Footcloths</a></li>
<li><a href="../442718/index.html">Google employees have discovered that work on a search engine version for China is ongoing.</a></li>
<li><a href="../442720/index.html">Fast generalization of markers on a WebGL card</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>