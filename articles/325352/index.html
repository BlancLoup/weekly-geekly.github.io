<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Guide to creating a simple photo editor</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today, we offer readers a detailed guide to creating a simple photo editor on iOS. For experienced developers, the task is simple, but for beginners, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Guide to creating a simple photo editor</h1><div class="post__text post__text-html js-mediator-article">  Today, we offer readers a detailed guide to creating a simple photo editor on iOS.  For experienced developers, the task is simple, but for beginners, a similar step-by-step analysis of the whole process may be useful.  We preferred the classic development environment for the chosen operating system - Xcode version 8.2.1.  The development will be carried out, again, in the classical object-oriented programming language Objective-C. <br><br>  Before embarking on the actual development, we suggest first splitting the task into subtasks. <br><br><ol><li>  Upload a photo from the gallery </li><li>  Create a collection with filters </li><li>  Implement the ability to apply any of the filters on the selected photo </li><li>  Save the result to the gallery. </li></ol><a name="habracut"></a><br>  So let's get started.  Open Xcode and select a template for iOS development in the Application ‚Üí Single View Application tab.  Let's call our project My First Photo Editor.  Next, we specify the directory where we want to save the project. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/446/e94/447/446e94447d334efb8ed66fe82d0d4d3e.PNG"><br><br><img src="https://habrastorage.org/files/ec1/625/9ce/ec16259ce06842b98b868a897809a8b6.PNG"><br><br>  Choose a mechanism for developing the interface program main.storyboard. <br><br><img src="https://habrastorage.org/files/b3f/a8e/934/b3fa8e934edb4a0a96369af1c61f32c7.PNG"><br><br>  We will have to move on to other scenes that will be added later.  To do this, drag the Navigation Controller onto the storyboard. <br><br><img src="https://habrastorage.org/files/41a/05e/4db/41a05e4db7bf45eea4152a1a93f5fe9f.PNG"><br><br>  Remove the Root View Controller Scene - we will not need it.  It now remains to associate the Navigation Controller with the original View Controller. <br><br><img src="https://habrastorage.org/files/e20/f4d/71b/e20f4d71b49e47f3b7df5ab9ed80a40b.PNG"><br><br><img src="https://habrastorage.org/files/cf1/fe1/bbe/cf1fe1bbeca344e5ba56df1d2182c9ed.PNG"><br><br>  Select the Navigation Controller, tick the checkbox ‚ÄúIs Initial View Controller‚Äù (Navigation Controller ‚Üí Attributes Inspector ‚Üí View Controller ‚Üí Is Initial View Controller; you can see how to do this in the pictures) and connect the Navigation Controller with View Controller. <br><br>  On the View Controller, we need a button to open the gallery window.  Transfer it from the Object Library. <br><br><img src="https://habrastorage.org/files/bd1/dcf/c5d/bd1dcfc5d686473bb2d6a848c9ddec2b.PNG"><br><br>  Create a button click event and add it to the controller properties. <br><br><img src="https://habrastorage.org/files/c35/4b6/e4e/c354b6e4e00a4cef8a334b3603111a96.PNG"><br><br><img src="https://habrastorage.org/files/d39/bd2/dc7/d39bd2dc7315400e91571fe8d6f28f52.PNG"><br><br>  Since we are going to use delegate methods, we‚Äôll add delagate UIImagePickerControllerDelegate, UINavigationControllerDelegate protocols to the interface of the ViewConroller.h controller. <br><br>  It turns out: <br><br><pre><code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewController</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIViewController</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIImagePickerControllerDelegate</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UINavigationControllerDelegate</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre> <br>  Let's write the following lines in the action of the button: <br><br><pre> <code class="objectivec hljs"> - (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)btnOpen_pressed:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)sender { <span class="hljs-built_in"><span class="hljs-built_in">UIImagePickerController</span></span> *picker = [[<span class="hljs-built_in"><span class="hljs-built_in">UIImagePickerControlleralloc</span></span>] init]; picker.delegate = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; [pickersetSourceType:<span class="hljs-built_in"><span class="hljs-built_in">UIImagePickerControllerSourceTypePhotoLibrary</span></span>]; [selfpresentViewController:picker animated:YEScompletion:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>];<span class="hljs-comment"><span class="hljs-comment">//    }</span></span></code> </pre> <br><br>  Run the project and see our button on the simulator.  Let's try to click and ... get a crash.  Why?  We forgot to add the property to the info.plist NSPhotoLibraryUsageDescription.  Correct this error. <br><br><img src="https://habrastorage.org/files/116/9c9/925/1169c9925a204abca5300c333d4fecef.png"><br><br>  Now you need to add another View Controller to the storyboard.  Let's make a connection according to the scheme shown in the screenshots. <br><br><img src="https://habrastorage.org/files/aac/2a6/a4e/aac2a6a4e6754f2ea9b9e0296b18b287.PNG"><br><br><img src="https://habrastorage.org/files/523/a54/9cc/523a549cc943479683bcf7acafa4b53b.PNG"><br><br>  Let's write the Indetifier key ‚ÄútoFilters‚Äù.  The illustration shows how this can be done.  Select the link on Storyboard ‚Üí Attributes Inspector ‚Üí Storyboard ‚Üí identifier ‚Üí toFilters. <br><br><img src="https://habrastorage.org/files/acc/eff/fd5/accefffd584f4be688b132c04ebd6b61.PNG"><br><br>  Now let's add to the ViewController.m methods of selecting a photo and switching to a new controller. <br><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">//  ,      -(void)imagePickerController:(UIImagePickerController *)picker didFinishPickingImage:(UIImage *)image editingInfo:(NSDictionary *)editingInfo { [pickerdismissViewControllerAnimated:YEScompletion:nil]; self.btnOpenPhoto.enabled = NO; dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{ self.selectedImage = image; dispatch_async(dispatch_get_main_queue(), ^{ [selfperformSegueWithIdentifier:kFiltersSegueIdsender:self]; self.btnOpenPhoto.enabled = YES; }); }); } //  ,       -(void) imagePickerControllerDidCancel:(UIImagePickerController *)picker { [pickerdismissViewControllerAnimated:YEScompletion:nil]; } #pragma mark - segue //      ,      -(void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {//kFiltersSegueId ‚Äì    String    ¬´toFilters¬ª if ([segue.identifierisEqualToString:kFiltersSegueId]) { FiltersViewController *destinationController = (FiltersViewController *)segue.destinationViewController; destinationController.image = self.selectedImage; } }</span></span></code> </pre> <br><img src="https://habrastorage.org/files/12d/772/67a/12d77267af1a44149838c0248c3902b5.PNG"><br><br><img src="https://habrastorage.org/files/ab0/49a/f00/ab049af00c0f412991aba1b84030192f.PNG"><br><br>  For the new controller, we need to create a special class.  To do this, in the top panel, select File ‚Üí New ‚Üí File ‚Üí Cocoa Touch Class ‚Üí Next.  Let's call it FiltersViewController and be sure to select in the column Subclass UIViewController.  In the Indetity inspector we register our class. <br><br><img src="https://habrastorage.org/files/c87/0c7/1ef/c870c71efe13408eae26f9ef5ecbc28a.PNG"><br><br>  Add to the controller Scroll View (or any other View, at your discretion), it will display an image with the applied filter.  Create a link to FiltersViewController. <br><br><img src="https://habrastorage.org/files/65d/738/a87/65d738a87bb54deea146f15fde56c870.PNG"><br><br><img src="https://habrastorage.org/files/401/c53/929/401c53929cd74d9bbb972938137b8961.png"><br><br>  Add Scroll View to the properties of the controller, as was done earlier.  Add the UIImageView and UIimage properties. <br><br><img src="https://habrastorage.org/files/1d0/66a/4e0/1d066a4e0b2d4f439cb9b72ca603221e.PNG"><br><br>  In this case, the UIImage property needs to be added to FiltersViewController.h, since we plan to use it in another class. <br><br>  Now create a collection with filters.  Find the Object Object Collection View in the Object Library. <br><br><img src="https://habrastorage.org/files/5fb/72f/67c/5fb72f67cd29455e84ed12318b23a005.PNG"><br><br><img src="https://habrastorage.org/files/c04/bff/283/c04bff28334b4b2f976fd8e144ef8e2d.PNG"><br><br><img src="https://habrastorage.org/files/93c/37d/db9/93c37ddb9d344dad8f51e0c5402ab4fd.PNG"><br><br>  Create a new class for the collection.  Go to the xib file, add UIimageView and Label. <br>  Next we set the size of the UIImageView.  The easiest way to do this is to right-click the object and drag it onto the one you want to link to.  Select the connection, as shown in the screenshot.  Then go to the Size inspector of this object and change the settings.  Set all constraints to 0. <br><br><img src="https://habrastorage.org/files/45e/648/664/45e648664fdf420a8365e64b5338c629.PNG"><br><br>  We establish communication between elements. <br><br><img src="https://habrastorage.org/files/552/677/588/552677588d304c7cb3c6b6534a8274af.PNG"><br><br>  Import a new class into FiltersViewController <br><br><img src="https://habrastorage.org/files/927/da8/227/927da8227420474c8b0f631eb26d16a5.PNG"><br><br>  and add FiltersViewControllerCell to this class like this: <br><br><img src="https://habrastorage.org/files/241/db8/7f0/241db87f0cfe4048b2f6e3f8a26d0b82.PNG"><br><br>  Now let's add the NSMutableArray array and the NSOperationQueue operator to the FiltersViewController properties ‚Äî they will be useful to us a little later. <br><br><img src="https://habrastorage.org/files/6a9/2ae/6a6/6a92ae6a64634803be9afda9b4b97ea4.PNG"><br><br>  The UIViewController life cycle begins with the loadView method.  So, in this method, we need to transfer the image that we chose in the last scene, and add a preview to the collection. <br><br>  As a result, the loadView will look like this: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)loadView{ [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> loadView]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.automaticallyAdjustsScrollViewInsets = <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; [[<span class="hljs-built_in"><span class="hljs-built_in">NSNotificationCenter</span></span> defaultCenter] addObserver:selfselector:<span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(orientationChanged:) name:<span class="hljs-built_in"><span class="hljs-built_in">UIDeviceOrientationDidChangeNotificationobject</span></span>:[<span class="hljs-built_in"><span class="hljs-built_in">UIDevice</span></span> currentDevice]]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.navigationController respondsToSelector:<span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(interactivePopGestureRecognizer)]) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.navigationController.interactivePopGestureRecognizer.enabled = <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } _imageView = [[<span class="hljs-built_in"><span class="hljs-built_in">UIImageView</span></span> alloc] init]; [_scrollView addSubview:_imageView]; _imageView.image = _image; _imageView.frame = <span class="hljs-built_in"><span class="hljs-built_in">CGRectMake</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, _image.size.width, _image.size.height); _filteringQueue = [<span class="hljs-built_in"><span class="hljs-built_in">NSOperationQueue</span></span> new]; _filteringQueue.maxConcurrentOperationCount = <span class="hljs-number"><span class="hljs-number">1</span></span>; _filteringQueue.qualityOfService = <span class="hljs-built_in"><span class="hljs-built_in">NSQualityOfServiceUserInitiated</span></span>; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.filtersCollection registerNib:[<span class="hljs-built_in"><span class="hljs-built_in">UINib</span></span> nibWithNibName:<span class="hljs-string"><span class="hljs-string">@"FiltersCollectionViewCell"</span></span> bundle:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>] forCellWithReuseIdentifier:<span class="hljs-string"><span class="hljs-string">@"filtersCollectionCell¬ª];// xib   . // Do any additional setup after loading the view. }</span></span></code> </pre><br>  In order not to reboot the controller, we will create the Extension class and add methods to it that will perform the function of applying a filter to the image: <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Extension.h"</span></span></span><span class="hljs-meta"> @implementation CIImage (Extension) -(CIImage *)applyFilter:(long)i { CIFilter *filter; switch (i) { case 0: return [self copy]; break; case 1: filter = [CIFilter filterWithName:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CISepiaTone"</span></span></span><span class="hljs-meta">]; break; case 2: filter = [CIFilter filterWithName:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CIColorMonochrome"</span></span></span><span class="hljs-meta">]; break; case 3: filter = [CIFilter filterWithName:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CIPhotoEffectMono"</span></span></span><span class="hljs-meta">]; break; case 4: filter = [CIFilter filterWithName:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CIPhotoEffectInstant"</span></span></span><span class="hljs-meta">]; break; case 5: filter = [CIFilter filterWithName:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CIHueAdjust"</span></span></span><span class="hljs-meta">]; [filter setDefaults]; [filter setValue: [NSNumber numberWithFloat: M_PI] forKey: kCIInputAngleKey]; break; case 6: filter = [CIFilter filterWithName:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CIHueAdjust"</span></span></span><span class="hljs-meta">]; [filter setDefaults]; [filter setValue: [NSNumber numberWithFloat: M_PI_2] forKey: kCIInputAngleKey]; break; case 7: filter = [CIFilter filterWithName:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CIColorInvert"</span></span></span><span class="hljs-meta">]; break; case 8: filter = [CIFilter filterWithName:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CIFalseColor"</span></span></span><span class="hljs-meta">]; break; case 9: filter = [CIFilter filterWithName:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CIPhotoEffectTonal"</span></span></span><span class="hljs-meta">]; break; case 10: filter= [CIFilter filterWithName:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CIPhotoEffectTransfer"</span></span></span><span class="hljs-meta">]; break; case 11: filter= [CIFilter filterWithName:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CIPhotoEffectProcess"</span></span></span><span class="hljs-meta">]; break; case 12: filter= [CIFilter filterWithName:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CIPhotoEffectChrome"</span></span></span><span class="hljs-meta">]; break; case 13: filter = [CIFilter filterWithName:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CIGaussianBlur"</span></span></span><span class="hljs-meta">]; [filter setDefaults]; [filter setValue: [NSNumber numberWithFloat:(self.extent.size.width + self.extent.size.height)/30.] forKey:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"inputRadius"</span></span></span><span class="hljs-meta">]; default: break; } [filter setValue:self forKey:kCIInputImageKey]; CIImage *result = [filter valueForKey:kCIOutputImageKey]; return result; } @end @implementation UIImage (Extension) +(NSArray *)filterNames { static NSArray *names; static dispatch_once_t onceToken; dispatch_once(&amp;onceToken, ^{ names = @[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Original"</span></span></span><span class="hljs-meta">,@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Sepia"</span></span></span><span class="hljs-meta">, @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Old Photo"</span></span></span><span class="hljs-meta">, @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Mono"</span></span></span><span class="hljs-meta">, @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Instant"</span></span></span><span class="hljs-meta">, @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Shift"</span></span></span><span class="hljs-meta">, @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Hue"</span></span></span><span class="hljs-meta">, @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Invert"</span></span></span><span class="hljs-meta">, @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Falce"</span></span></span><span class="hljs-meta">, @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Tonal"</span></span></span><span class="hljs-meta">, @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Transfer"</span></span></span><span class="hljs-meta">, @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Process"</span></span></span><span class="hljs-meta">, @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Chrome"</span></span></span><span class="hljs-meta">]; }); return names; } - (UIImage *)applyFilter:(long)i { CIImage *ciImage = [[CIImage alloc] initWithImage: self]; CIImage *result = [ciImage applyFilter:i]; CGRect extent1 = [result extent]; CIContext *context = [CIContext contextWithOptions:nil]; CGImageRef cgImage1 = [context createCGImage:result fromRect:extent1]; UIImage *img = [UIImage imageWithCGImage:cgImage1]; CGImageRelease(cgImage1); return img; } + (instancetype)imageWithCIImageImproved:(CIImage *)img { CGRect extent = [img extent]; CIContext *context = [CIContext contextWithOptions:nil]; CGImageRef cgImage = [context createCGImage:img fromRect:extent]; UIImage *image = [UIImage imageWithCGImage:cgImage]; CGImageRelease(cgImage); return image; } @end</span></span></code> </pre> <br>  Further we will write the interface of calls in Extension.h: <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><span class="hljs-meta"> @interface CIImage (Extension) -(CIImage *)applyFilter:(long)i; @end @interface UIImage (Extension) @property (class, readonly) NSArray * filterNames; + (NSArray *)filterNames; - (UIImage *)applyFilter:(long)i; + (instancetype)imageWithCIImageImproved:(CIImage *)img; @end</span></span></code> </pre> <br>  Add the following methods for the collection and for the Scroll View to the FiltersViewController.m class: <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#pragma mark - Collection //     ,   -(NSInteger)collectionView:(UICollectionView *)collectionView numberOfItemsInSection:(NSInteger)section { returnself.filterPreviews.count; } //    - (CGSize)collectionView:(UICollectionView *)collectionView layout:(UICollectionViewLayout *)collectionViewLayout sizeForItemAtIndexPath:(NSIndexPath *)indexPath { CGFloat sz = collectionView.frame.size.height - 6; returnCGSizeMake(sz, sz); } // ,          UICollectionViewCell -(UICollectionViewCell *)collectionView:(UICollectionView *)collectionView cellForItemAtIndexPath:(NSIndexPath *)indexPath { long index = [indexPath item]; FiltersCollectionViewCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"filtersCollectionCell"</span></span></span><span class="hljs-meta">forIndexPath:indexPath]; UIImageView *ivPreview = cell.imageFilter; ivPreview.image = self.filterPreviews[index]; ivPreview.clipsToBounds = YES; ivPreview.layer.cornerRadius = 3.; UILabel *labelName = cell.nameFilter; labelName.text = [UIImagefilterNames][index]; return cell; } // ,  ,      - (void)collectionView:(UICollectionView *)collectionView didSelectItemAtIndexPath:(NSIndexPath *)indexPath { [self.filteringQueuecancelAllOperations]; __blockUIImage *filtered = nil; NSBlockOperation *operation1 = [NSBlockOperationblockOperationWithBlock:^{ filtered = [self.imageapplyFilter:[indexPath item]]; }]; NSBlockOperation *operation2 = [NSBlockOperationblockOperationWithBlock:^{ [CATransactionbegin]; dispatch_sync(dispatch_get_main_queue(), ^{ if (filtered) { _imageView.image = filtered; } }); }]; [operation2addDependency:operation1]; [self.filteringQueueaddOperation:operation1]; [self.filteringQueueaddOperation:operation2]; } #pragma mark - Scroll View //    UIView,     -(UIView *)viewForZoomingInScrollView:(UIScrollView *)scrollView { returnself.imageView; } //  ,       - (void)scrollViewDidZoom:(UIScrollView *)scrollView { CGSize sz = scrollView.contentSize; float xInsets = MAX(0, scrollView.frame.size.width/2.-sz.width/2.); float yInsets = MAX(0, scrollView.frame.size.height/2.-sz.height/2.); [scrollViewsetContentInset:UIEdgeInsetsMake(yInsets,xInsets,yInsets,xInsets)]; } // ,      - (void) orientationChanged:(NSNotification *)note { [self.viewlayoutSubviews]; [selfupdateScaleInScrollView:self.scrollView]; } // ,     ScrollView    -(void)updateScaleInScrollView:(UIScrollView *)scrollView { UIImage *image = _image; float minScale = sizeFit(image.size,scrollView.frame.size).width/image.size.width; scrollView.maximumZoomScale = MAX(1,minScale); scrollView.minimumZoomScale = minScale; scrollView.zoomScale = minScale; if (scrollView.zoomScale&gt; scrollView.maximumZoomScale) scrollView.zoomScale = scrollView.maximumZoomScale; elseif (scrollView.zoomScale</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; scrollView.minimumZoomScale) scrollView.zoomScale = scrollView.minimumZoomScale; [selfscrollViewDidZoom:scrollView]; } #pragma mark - other //       CGSizesizeFill(CGSize size, CGSize sizeToFill) { CGSize newSize; if (size.width / sizeToFill.width&lt; size.height / sizeToFill.height) newSize = CGSizeMake(sizeToFill.width, sizeToFill.width*size.height/size.width); else newSize = CGSizeMake(sizeToFill.height*size.width/size.height, sizeToFill.height); return newSize; } CGSizesizeFit(CGSize size, CGSize sizeToFit) { float w = size.width/sizeToFit.width; float h = size.height/sizeToFit.height; return w &gt;</span></span></span><span class="hljs-meta"> h ? CGSizeMake(sizeToFit.width, size.height/w) : CGSizeMake(size.width/h, sizeToFit.height); } CGRectframeFill(CGSize size, CGSize sizeToFill) { CGSize szFill = sizeFill(size, sizeToFill); CGPoint pntFill = CGPointMake(sizeToFill.width/2.-szFill.width/2., sizeToFill.height/2.-szFill.height/2.); returnCGRectMake(pntFill.x, pntFill.y, szFill.width, szFill.height); }</span></span></code> </pre> <br>  The following ViewController lifecycle method is viewDidLoad.  viewDidLoad is a good place to continue controller initialization.  We will not need it because the initialization of all design elements is already defined.  However, the dimensions of the view are not specified, so we will add ScrollView processing in the next stage of the viewWillAppear life cycle: <br><br><pre> <code class="objectivec hljs">-(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)viewWillAppear:(<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)animated { [superviewWillAppear:animated]; <span class="hljs-built_in"><span class="hljs-built_in">dispatch_async</span></span>(dispatch_get_main_queue(), ^{ [selfupdateScaleInScrollView:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.scrollView]; }); }</code> </pre><br>  Create a method for displaying a preview of the filters: <br><br><pre> <code class="objectivec hljs">-(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)makeFilterPreviews { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.filterPreviews = [[<span class="hljs-built_in"><span class="hljs-built_in">NSMutableArrayalloc</span></span>] init]; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> size = <span class="hljs-number"><span class="hljs-number">90</span></span> * [<span class="hljs-built_in"><span class="hljs-built_in">UIScreenmainScreen</span></span>].scale; <span class="hljs-built_in"><span class="hljs-built_in">CGRect</span></span> cropRect = frameFill(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.image.size,<span class="hljs-built_in"><span class="hljs-built_in">CGSizeMake</span></span>(size, size)); <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsBeginImageContext</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">CGSizeMake</span></span>(size, size)); [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.imagedrawInRect:cropRect]; <span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> *cropped = <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsGetImageFromCurrentImageContext</span></span>(); <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsEndImageContext</span></span>(); <span class="hljs-built_in"><span class="hljs-built_in">CIImage</span></span> *ciimg = [[<span class="hljs-built_in"><span class="hljs-built_in">CIImagealloc</span></span>] initWithImage:cropped]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; [<span class="hljs-built_in"><span class="hljs-built_in">UIImagefilterNames</span></span>].count; i++) { <span class="hljs-built_in"><span class="hljs-built_in">CIImage</span></span> *ciFiltered = [ciimg applyFilter:i]; <span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> *filtered = [<span class="hljs-built_in"><span class="hljs-built_in">UIImageimageWithCIImageImproved</span></span>:ciFiltered]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.filterPreviewsaddObject:filtered]; } }</code> </pre><br>  and write the call to this method in loadView <br><br><pre> <code class="objectivec hljs">[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> makeFilterPreviews];</code> </pre> <br><img src="https://habrastorage.org/files/e4b/12c/83a/e4b12c83ab5140c488152b898c4ea5ef.PNG"><br><br>  Run our project.  After selecting an image, the application freezes for a while.  This is because the application of filters to the image takes time.  After applying all the filters, the controller will be loaded with an image and a collection with filters. <br><br>  To ensure the responsiveness of the interface, we add asynchrony when the method is executed. <br><br><pre> <code class="objectivec hljs">-(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)makeFilterPreviews { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.filterPreviews = [[<span class="hljs-built_in"><span class="hljs-built_in">NSMutableArrayalloc</span></span>] init]; <span class="hljs-comment"><span class="hljs-comment">//         -&gt; for (long i = 0; i &lt; [UIImagefilterNames].count; i++) { [self.filterPreviews addObject:[[UIImage alloc]init]]; } float size = 90 * [UIScreenmainScreen].scale; CGRect cropRect = frameFill(self.image.size,CGSizeMake(size, size)); UIGraphicsBeginImageContext(CGSizeMake(size, size)); [self.imagedrawInRect:cropRect]; UIImage *cropped = UIGraphicsGetImageFromCurrentImageContext(); UIGraphicsEndImageContext(); CIImage *ciimg = [[CIImagealloc] initWithImage:cropped]; //         NSOperationQueue *queue = [[NSOperationQueuealloc]init]; queue.maxConcurrentOperationCount = 2; for (int i = 0; i &lt; [UIImagefilterNames].count; i++) { [queueaddOperationWithBlock:^{ CIImage *ciFiltered = [ciimg applyFilter:i]; UIImage *filtered = [UIImageimageWithCIImageImproved:ciFiltered]; @synchronized (self.filterPreviews) { [self.filterPreviewsreplaceObjectAtIndex:i withObject:filtered]; dispatch_sync(dispatch_get_main_queue(), ^{ [self.filtersCollectionreloadData]; }); } }]; } }</span></span></code> </pre><br>  @synchronized (self.filterPreviews) blocks editing of the filterPreviews array for all elements except the current one. <br><br>  To update the collection correctly, you need to do this in the dispatch_get_main_queue () stream. <br><br>  The remaining methods of the ViewController life cycle: <br><br><ul><li>  viewDidAppear: (BOOL) animated - called after drawing all interface elements </li><li>  viewWillDisappear: (BOOL) animated - called before deleting all interface elements </li><li>  viewDidDisappear: (BOOL) animated - called after deletion </li><li>  viewDidUnload - called when the view is unloaded from memory </li></ul><br>  We have not used. <br><br>  Now create a Save button. <br><br>  Add a Navigation Item. <br><br><img src="https://habrastorage.org/files/deb/514/10a/deb51410ac0e4313864dde0dbb01261c.PNG"><br><br><img src="https://habrastorage.org/files/9f0/fe8/6e5/9f0fe86e585e4154b99c1b7ab21a78cb.PNG"><br><br>  Add a button to the Navigation Item. <br><br><img src="https://habrastorage.org/files/7fd/7a2/ce5/7fd7a2ce541841b78d694e991779f634.PNG"><br><br>  And write the buttons in action: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)saveBtn:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)sender { <span class="hljs-built_in"><span class="hljs-built_in">UIImageWriteToSavedPhotosAlbum</span></span>(_imageView.image, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>); }</code> </pre> <br>  Run the application, select the image and filter.  When the filter is applied, click Save.  On the simulator, we can use the cmd + shift + h key combination (this is the same as the ‚ÄúHome‚Äù button on the iPhone), open the Gallery - and find the same image there. </div><p>Source: <a href="https://habr.com/ru/post/325352/">https://habr.com/ru/post/325352/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325342/index.html">CSS animation will wait</a></li>
<li><a href="../325344/index.html">HotSpot organization on MikroTik equipment with SMS authorization</a></li>
<li><a href="../325346/index.html">ITMO University will start developing unbreakable storage systems</a></li>
<li><a href="../325348/index.html">What devices today is the market of "Internet of things" in Russia</a></li>
<li><a href="../325350/index.html">Programmer Identity</a></li>
<li><a href="../325354/index.html">AP Failover and AP Fallback in Cisco Unified Wireless Implementation</a></li>
<li><a href="../325356/index.html">Linux mail server</a></li>
<li><a href="../325358/index.html">Why do you need containerd and why it was separated from Docker</a></li>
<li><a href="../325360/index.html">Comparing OpenMP on different platforms</a></li>
<li><a href="../325362/index.html">Do not stay in the cold on April 1st - make a backup</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>