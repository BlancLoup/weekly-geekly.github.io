<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tagging EXE files without damaging the digital signature</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 We want to tell about our experience in the study of digital signatures of Windows PE files and the possible use of their features for their...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tagging EXE files without damaging the digital signature</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/37f/84f/55f/37f84f55fe14ad7cf2ab75b3b837871e.jpg"><br><br>  Hello! <br><br>  We want to tell about our experience in the study of digital signatures of Windows PE files and the possible use of their features for their own purposes.  If you are interested in technical details or just reading about what seems to be well-known things, welcome to Cat. <br><a name="habracut"></a><br><h2>  User Account Control </h2><br>  Many of you know that with the advent of Windows Vista, there was such an interesting thing called UAC (User Account Control).  This mechanism is designed to increase security, and its essence is to restrict application access to critical parts of the operating system.  However, the opportunity to get to these parts still exists, and the user has control over this. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Any Windows application can contain a manifest - an XML file used by Windows when launching the application.  In this manifest, the requirement to launch an application with elevated privileges can be described, and in this case, when the application is launched, the user will see the same UAC window asking whether to trust the application and allow it to start with maximum permissions? <br><br><img src="https://habrastorage.org/storage2/983/cad/656/983cad656510379b8d6b9667a18da98e.png"><br><br>  In order to make the task easier for the user at this stage, and to allow developers to be confident in the integrity and originality of the transferred files, Microsoft offers the authors of legal and harmless software to use digital signatures.  They certify the author, and, more importantly, the authenticity of the original file. <br><br><img src="https://habrastorage.org/storage2/8d0/ba2/399/8d0ba2399c6697e7128e07bc21c13a34.png"><br><br>  Seeing a launch request with information about a verified publisher, the user can be sure that the contents of the <i>executable</i> part of this file have not changed and can be run with a clear conscience (if he, of course, trusts this author).  However, when requesting to launch an application from an unverified publisher, it is worth thinking about, analyzing possible causes and consequences. <br><br><h2>  Closer to the topic </h2><br>  But what if we (the authors of these applications) want to transfer to them any additional information that will be known only at the moment of downloading?  After all, any change to the file automatically makes the digital signature invalid.  What options do we have? <br><br><ol><li>  Add the required data to the name of the file to be transferred, and redirect such requests to a single physical file via a regular server via regular expressions. <br>  <b>+</b> easy to implement; <br>  <b>+</b> the file internals remain intact and the signature is always correct; <br>  <b>-</b> you can send only a small set of data (for example, several identifiers); <br>  <b>-</b> at file renaming the information disappears. <br><br></li><li>  Modify the data inside the file and re-sign it upon release. <br>  <b>+</b> you can transfer any amount of data; <br>  <b>+</b> when you rename nothing is lost; <br>  <b>-</b> re <b>-</b> signing is a very long process if we are talking about the return of hundreds of large (100 MB +) distributions of games per second, as in our case. <br><br></li><li>  Change the data inside the file and <b>DO NOT</b> re-sign it, while maintaining the correct digital signature. <br>  <b>+</b> you can transfer any amount of data; <br>  <b>+</b> when you rename nothing is lost; <br>  <b>+</b> no need to re-sign the file; <br>  <b>-</b> this is impossible (or possible?). <br></li></ol><br><h2>  Some theory </h2><br>  Below is the structure of a Windows <a href="http://ru.wikipedia.org/wiki/Portable_Executable">PE file</a> with information about which parts of it a digital signature is formed, and which blocks are skipped in this process. <br>  Also shown is the digital signature block format ( <a href="http://ru.wikipedia.org/wiki/PKCS">PKCS</a> # 7 structure) used by Microsoft. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/5fa/e91/375/5fae9137566e0506fd7cc1a622cf726d.png"></div><br><br>  The key point in this scheme is the presence of blocks that are excluded when generating and verifying a digital signature.  These blocks are described by the simplest C structures: <br><br>  The ‚ÄúCertificate Table‚Äù in the ‚ÄúData Directories‚Äù section is an IMAGE_DATA_DIRECTORY structure: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IMAGE_DATA_DIRECTORY</span></span></span><span class="hljs-class"> {</span></span> DWORD VirtualAddress; DWORD Size; } IMAGE_DATA_DIRECTORY, *PIMAGE_DATA_DIRECTORY;</code> </pre> <br>  Where: <br><ul><li>  VirtualAddress - a direct pointer to the attributes of the table of certificates in the PE file; </li><li>  Size - the size of this block in the PE file. </li></ul><br>  The ‚ÄúCertificate Table Attributes‚Äù is a WIN_CERTIFICATE structure: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WIN_CERTIFICATE</span></span></span><span class="hljs-class"> {</span></span> DWORD dwLength; WORD wRevision; WORD wCertificateType; BYTE bCertificate[ANYSIZE_ARRAY]; } WIN_CERTIFICATE, *LPWIN_CERTIFICATE;</code> </pre><br>  elements of which contain the following values: <br><ul><li>  dwLength - the size of the binary data section of the certificate; </li><li>  wRevision - the used version of the WIN_CERTIFICATE structure; </li><li>  wCertificateType - set to 0x0002 for digital signatures of PE files.  The value is defined in Wintrust.h as WIN_CERT_TYPE_PKCS_SIGNED_DATA; </li><li>  bCertificate is a dataset containing a digital signature in the format PKCS # 7. </li></ul><br>  When a PE file is signed, the attribute section of the certificate table is always placed at the end of the file (the ‚ÄúRemaining Content‚Äù block is absent).  Knowing this feature, you can crank up a little trick with very attractive results. <br><br><h2>  Impossible is possible </h2><br>  The focus is this: the <b>size of the section described in IMAGE_DATA_DIRECTORY may differ from the actual size of the WIN_CERTIFICATE structure</b> , and when checking the digital signature, the <b>entire</b> section is excluded, the size of which is described in IMAGE_DATA_DIRECTORY.  At the same time, manually added content to this section is no longer part of the digital signature and, in fact, can contain any data set.  Thus, you can easily add any data to the contents of the ‚ÄúCertificate Table Attributes‚Äù block by first changing the section size in the IMAGE_DATA_DIRECTORY structure without damaging the file‚Äôs digital signature.  Do not forget about file padding up to a size multiple of 8 bytes. <br><br>  You should understand the possible consequences of using this method, keep in mind the type of data transferred, the volume, the possible processing of them, and the potential holes associated with it.  It is in your interest to transfer there only such information that can be painlessly <nobr>deleted / replaced / spoiled</nobr> (in case someone wants to do this intentionally), but without losing the main functionality. <br><br>  ‚ÄúOf course, what about the checksum of the PE file?‚Äù You ask.  I hasten to reassure you - it does not play any role when starting and running regular EXE files.  The checksum is checked only on critical system files, for example, the System File Checker service (for diagnosing missing or damaged system files) is oriented towards it. <br><br><h2>  As a conclusion: who uses it and how? </h2><br>  This feature is used by Google when distributing its products through the automatic Google Omaha update.  You may have noticed that when you download Google Chrome or Google Earth, you are prompted to make some settings before downloading, for example, install the Chrome browser with Earth.  These settings are transmitted using the distribution tagging - the process of adding data to an EXE file, which Omaha subsequently processes on the user's local machine. <br><br>  It is also convenient to use this opportunity in various partner networks - distribution of distributions with partner tracking - the need for different companies. <br><br>  The mechanism for uploading files from a web server using this feature can be implemented using a self-written nginx plug-in, a virtual file system based on FUSE, or some other more exotic way (tell us in the comments if you‚Äôve come up with your own version). <br><br>  Information on digital signatures of PE files can be found in this document: <a href="http://msdn.microsoft.com/en-us/windows/hardware/gg463180.aspx">Windows Authenticode Portable Executable Signature Format</a> . </div><p>Source: <a href="https://habr.com/ru/post/155365/">https://habr.com/ru/post/155365/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../155347/index.html">Star program Windows 8 Summit</a></li>
<li><a href="../155349/index.html">Image Online Design sues ICANN</a></li>
<li><a href="../155353/index.html">Image Filter with CSS Filter Effects</a></li>
<li><a href="../155359/index.html">Genome hunters go for Martian DNA</a></li>
<li><a href="../155363/index.html">S02.07. Windows Eyt</a></li>
<li><a href="../155367/index.html">Behind the Scenes of Formula 1</a></li>
<li><a href="../155369/index.html">AWS: VPC now supports Micro instances</a></li>
<li><a href="../155371/index.html">How does microelectronic production work and what should we build a house?</a></li>
<li><a href="../155373/index.html">In France, they want to force search engines to pay for content. Google threatened to remove French sites from its index</a></li>
<li><a href="../155375/index.html">Stream from mpd to smartphone or the entire music collection in your pocket</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>