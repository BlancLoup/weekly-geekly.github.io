<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementation of morphological search on Kohana (phpMorphy library)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, Habrasoobschestvo! 
 Recently I set out to make a search on my site, written in the Kohana Framework. I decided to use exactly the morpholog...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementation of morphological search on Kohana (phpMorphy library)</h1><div class="post__text post__text-html js-mediator-article">  Good day, Habrasoobschestvo! <br>  Recently I set out to make a search on my site, written in the Kohana Framework.  I decided to use exactly the morphological search, because  I think it is more correct (regarding full-text search using LIKE).  Searches for ready-made modules for Kohana with the required functionality did not succeed, but I found an excellent library: <a href="http://sourceforge.net/projects/phpmorphy/">phpMorphy</a> , which was great for solving my problems. <br><a name="habracut"></a><br><h5>  The search operation logic includes 2 blocks: </h5><ul><li>  Indexing (and reindexing) existing content </li><li>  Search index search </li></ul><br><h6>  Content Indexing </h6>  On the site we have the following structure: <br><img src="https://habrastorage.org/storage2/069/782/4b6/0697824b6cc4c5123fe986c6a8f8b35b.png"><br>  As can be seen from the attached scheme, there are 2 types of content on the site: <br><ul><li>  Posts (may have comments - one-to-many links) </li><li>  Recipes (can have ingredients (one to many), cooking steps (one to many), comments (similar)) </li></ul><br>  We are going to index all of this content, and due to the fact that comments can appear throughout the life of the content - the need to re-index the content on an ongoing basis.  From the point of view of logic, content indexing is as follows: Alternately, we get all the content, we search for content-related additional materials (comments, ingredients, cooking steps).  Further we carry out such operations: <br><ul><li>  We clear the content from html-tags; </li><li>  We break into separate words; </li><li>  We result in a uniform register (I used upper case); </li><li>  Replace the letter E to E <i>(so that when indexing and assigning each word of weight, it is not perceived as different, words such as, for example, "green" and "green")</i> ; </li><li>  Based on the position of the word in the structure and the number of references to this word in the post we put down the weight (for example: the word from the title has a weight of 3, from the text field of the post has a weight of 2, and the word from the comment has a weight of 1, while weights are added together); </li><li>  We save in the database the resulting index (post id, word, weight). </li></ul><br><br><h6>  Search index search </h6>  After all the content is indexed, the simplest thing remains - search by the created search index.  To do this, we act in a similar way: <br><ul><li>  We receive and filter the user's request (we cut off html-tags and other attempts xss); </li><li>  We split the query into words; </li><li>  Bring each word to uppercase; </li><li>  Replace E with E; </li><li>  We carry out the search for the words obtained by the search index; </li><li>  Group the results by post id, summarize the weights; </li><li>  Sort the results by total weight (it can already be called relevance); </li><li>  Alternately, select from the database information on the received id, form and output the output. </li></ul><br>  Once the logical component of the question has become clear - you can proceed to the analysis of the code. <br><br><h5>  Write the code </h5><br><h6>  Start </h6>  To get started, go to the <a href="http://phpmorphy.sourceforge.net/dokuwiki/download">Sourceforge</a> project page and download the current version of the library, as well as the dictionary database (since Kohana works with utf-8 - download the dictionaries for this encoding). <br>  The developers recommend placing the library files so that they are not directly accessible from the web.  I didn‚Äôt specify for what reasons, so I suggest not abusing the recommendation and uploading files either above the / www directory or (if you upload to any directory inside / www) to prohibit direct access to the folder from the web.  This can be done by placing the .htaccess file in a folder: <br><pre><code class="apache hljs"><span class="hljs-attribute"><span class="hljs-nomarkup"><span class="hljs-attribute"><span class="hljs-nomarkup">Options</span></span></span></span> -Indexes &lt;Files ~ <span class="hljs-string"><span class="hljs-string">"\.(php|php3|php4|php5|pl|cgi|sh|bash)$"</span></span>&gt; Deny from <span class="hljs-literal"><span class="hljs-literal">all</span></span> &lt;/Files&gt;</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h6>  Library initialization </h6>  To use the library functionality, you need to include the necessary files and create an instance of the class with which further actions will be taken: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span>(<span class="hljs-string"><span class="hljs-string">'{    }/src/common.php'</span></span>); $dir = <span class="hljs-string"><span class="hljs-string">'{  ,     }/dicts'</span></span>; $lang = <span class="hljs-string"><span class="hljs-string">'ru_RU'</span></span>; $opts = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'storage'</span></span> =&gt; PHPMORPHY_STORAGE_FILE, ); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $morphy = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> phpMorphy($dir, $lang, $opts); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(phpMorphy_Exception $e) { <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(<span class="hljs-string"><span class="hljs-string">'Error occured while creating phpMorphy instance: '</span></span> . $e-&gt;getMessage()); }</code> </pre><br><br><h6>  Integrating the library in Kohana </h6>  In the proposed solution, I use 2 controllers: <br><ul><li>  Admin part - on its side content indexing / reindexing occurs; </li><li>  Search controller - responsible for searching by index and displaying content to users. </li></ul><br>  In addition, for convenience (I personally use ORM), you need to create a model: <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model_Searchindex</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ORM</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $_table_name = <span class="hljs-string"><span class="hljs-string">'searchindex'</span></span>; }</code> </pre><br>  Well and, accordingly, the 'searchindex' table, consisting of fields: <br><ul><li>  word - varchar (32) COLLATE utf8_bin NOT NULL - PRIMARY KEY </li><li>  post_id - int (100) NOT NULL - PRIMARY KEY </li><li>  weight - int (100) NOT NULL </li></ul><br>  The table must be of the MyISAM type. <br>  Let's talk more about each of the controllers. <br><br><h6>  Indexing Controller </h6>  In my case, this controller is used as a handler, to which I address asynchronous requests from the control panel of the site (of course, the controller is accessible only to a user with administrator rights). <br>  We configure the possibility of obtaining an additional parameter in routs (since the operation is difficult and I would like to break it into portions): <br><pre> <code class="php hljs">Route::set(<span class="hljs-string"><span class="hljs-string">'index'</span></span>, <span class="hljs-string"><span class="hljs-string">'updateindex(/&lt;offset&gt;)'</span></span>) -&gt;defaults(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'directory'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'admin'</span></span>, <span class="hljs-string"><span class="hljs-string">'controller'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'updateindex'</span></span>, <span class="hljs-string"><span class="hljs-string">'action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'index'</span></span>, ));</code> </pre><br>  Well, with routs, I think everyone understood what was meant.  Further, in the controller itself, in action_index (), we take the offset parameter, create an instance of the phpMorphy class, and perform all the operations described in the logic diagram: <br><pre> <code class="php hljs"> $offset = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;request-&gt;param(<span class="hljs-string"><span class="hljs-string">'offset'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//       if ($offset == 1) { $index = DB::query(Database::DELETE, 'DELETE FROM `searchindex`'); $index-&gt;execute(); } $data = array(); //     $posts = ORM::factory('post')-&gt;where('delete', '=', 0)-&gt;offset(100*$offset)-&gt;limit(100)-&gt;find_all(); foreach ($posts as $post) { $words = array(); //   html,          $title = mb_strtoupper(str_ireplace("", "", strip_tags($post-&gt;title)), "UTF-8"); $comments = ORM::factory('comment')-&gt;where('post_id', '=', $post-&gt;id)-&gt;order_by('id', 'ASC')-&gt;find_all(); //  ,    $text = $post-&gt;text; if ($post-&gt;type == 1) { //    ,      . ,     ... } foreach ($comments as $comment) { //    ,         $text = $text.' '.$comment-&gt;text; } $text = mb_strtoupper (str_ireplace("", "", strip_tags($text)), "UTF-8"); preg_match_all ('/([a-z-]+)/ui', $title, $word_title); //     preg_match_all ('/([a-z-]+)/ui', $text, $word_text); //    ,   =&gt;  $start_form_title = $morphy-&gt;lemmatize($word_title[1]); $start_form_text = $morphy-&gt;lemmatize($word_text[1]); foreach ($start_form_title as $k=&gt;$w) { if (!$w) { //       ,    $w[0] = $k; } if (mb_strlen($w[0], "UTF-8") &gt; 2) //   ,     { if (! isset ( $words[$w[0]]))$words[$w[0]] = 0; $words[$w[0]]+= 3; //     } } foreach ($start_form_text as $k=&gt;$w) { //     } //          foreach ($words as $word=&gt;$weight) { $data['post_id'] = $post-&gt;id; $data['word'] = $word; $data['weight'] = $weight; $addindex = ORM::factory('searchindex'); $addindex-&gt;values($data); try { $addindex-&gt;save(); } catch (ORM_Validation_Exception $e) { $errors = $e-&gt;errors('validation'); } } } /*      json,       ,      */ $pcount = ORM::factory('post')-&gt;where('delete', '=', 0)-&gt;count_all(); if (($pcount - (100*$offset)) &gt; 0) { $complateu = ($offset) * 100; $percent = ($complateu / $pcount) * 100; $percent = round($percent, 0); $json = array('status'=&gt;'next', 'nextid'=&gt;1+$offset, 'percent'=&gt;$percent); $this-&gt;response-&gt;body(json_encode($json)); } else { $json = array('status'=&gt;'finish', 'percent'=&gt;100); $this-&gt;response-&gt;body(json_encode($json)); }</span></span></code> </pre><br>  I think that it is not necessary to give the implementation code of the control panel (considering that even now the volume of the article is not small).  There everything is quite banal - a button, and a jquery handler, accessing the controller described above and processing the resulting response accordingly. <br><br><h6>  The controller responsible for searching the site </h6>  For the operation of this controller in the same way we create a route.  The controller accepts the search phrase entered by the user.  The phrase is transmitted using the GET method.  This is what the controller looks like: <br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">action_search</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $data = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; $request = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; $errors = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($_GET[<span class="hljs-string"><span class="hljs-string">'text'</span></span>])) <span class="hljs-comment"><span class="hljs-comment">//    { //   html-   $search = $this-&gt;_clear_var($_GET['text']); $request = $search; } /*   phpMorphy */ if (!empty($search)) { //        if (mb_strlen($search, "UTF-8") &gt; 2) { preg_match_all('/([a-z-]+)/ui', mb_strtoupper($search, "UTF-8"), $search_words); $words = $morphy-&gt;lemmatize($search_words[1]); $s_words = array(); $pre_result = array(); foreach ($words as $k =&gt; $w) { if (!$w)$w[0] = $k; if (mb_strlen($w[0], "UTF-8") &gt; 2) { $s_words[] = $w[0]; } } if (!count($s_words)) { //   (     2 ) } else { foreach($s_words as $s_word) { $search_index = ORM::factory('searchindex')-&gt;where('word', '=', $s_word)-&gt;find_all(); foreach ($search_index as $si) { if (!empty($pre_result[$si-&gt;post_id])) { $pre_result[$si-&gt;post_id] = (int) $si-&gt;weight + $pre_result[$si-&gt;post_id]; } else { $pre_result[$si-&gt;post_id] = (int) $si-&gt;weight; } } } arsort($pre_result); //      foreach ($pre_result as $id =&gt; $weight) { // , ,         $data[] = $result; } } } else { //   -     } } else { //   -    } $this-&gt;template-&gt;content = View::factory('content/v_search') -&gt;bind('data', $data) -&gt;bind('errors', $errors) -&gt;bind('request', $request) }</span></span></code> </pre><br>  Well, I think there‚Äôs no point in describing the big information - everything is as usual.  I tried to reduce the code listings as much as possible so as not to clutter up the article with very simple and trivial things (such as getting information from the database or handling errors, everyone already knows how to do it ...). <br>  Hope my article will be helpful  An example of how this search implementation works can be found <a href="http://cook-room.com/">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/165715/">https://habr.com/ru/post/165715/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../165705/index.html">A couple of words about application internationalization</a></li>
<li><a href="../165707/index.html">SoapServer in PHP. Let array be always Map</a></li>
<li><a href="../165709/index.html">GCW Zero on Kickstarter</a></li>
<li><a href="../165711/index.html">Prototyping with Wireframesketcher</a></li>
<li><a href="../165713/index.html">Degrees - the key to fast hierarchy (Django example)</a></li>
<li><a href="../165719/index.html">Find an idea: the ideal object</a></li>
<li><a href="../165723/index.html">Advanced VIM Setup</a></li>
<li><a href="../165725/index.html">Like I had for the first time with Kiwi</a></li>
<li><a href="../165727/index.html">How and why we made our micro markup validator</a></li>
<li><a href="../165729/index.html">Ultimate performance: C #</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>