<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Talkpad inside</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Almost a year after the publication of the first introductory article on TalkPad . During the operation and development of the service, we faced many ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Talkpad inside</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://talkpad.ru/"><img src="http://talkpad.ru/static/img/logo.png"></a> <br><br>  Almost a year after the publication of the <a href="http://habrahabr.ru/blogs/voip/91902/">first introductory article</a> on <a href="http://talkpad.ru/">TalkPad</a> .  During the operation and development of the service, we faced many technological problems, some of which were successfully overcome.  Today we want to tell you about how the server side TalkPad. <br><br>  Let me remind you that TalkPad is a service that provides an opportunity to call landline and mobile phones directly from the browser, installing the plugin. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, how can the backend of a high-load telephony service be arranged? <br><a name="habracut"></a><br>  TalkPad is built on multiple data transfer protocols.  We use SIP (Session Initiation Protocol) and SDP (Session Description Protocol) to establish a session between users and transmit metadata, and use RTP (Real-Time Transport Protocol) to transfer voice data directly.  There are other protocols for the task of establishing a connection (Jingle, H.323, ...), but SIP is currently the most popular. <br><br>  <b>1. Locate users</b> <br>  In the project, we use <a href="http://opensips.org/">OpenSIPS</a> high-performance software SIP switch, which among other things discusses the registration base. <br><br>  In order for the server to know exactly where to send incoming calls, each client sends a REGISTER SIP message to the server in which it reports its network address and port.  Authentication and authorization is required to prevent the user from accepting other people's calls in SIP registration. <br><br>  The registration database is maintained in the memory of each OpenSIPS server with a periodic dropping (by timer) of the state into the local PostgreSQL (how the data in the memory is synchronized just below). <br><br>  <b>2. And if the user is behind a NAT router?</b> <br>  Almost all users are behind home / office / public routers (NAT routers).  In this case, the client does not know its external network address.  To solve this problem, there is a protocol STUN (Session Traversal Utilities for NAT).  The user's STUN client simply sends a request to the STUN server (one of the OpenSIPS modules), and the server responds with the information from which network address the packet came from.  By combining various STUN tests, the user can determine his NAT type. <br><br>  The type of NAT that we defined is recorded in the RIP and INVITE SIP messages.  In general, voice traffic goes between clients directly in P2P mode.  However, if the NAT type of one of the users was defined as symmetrical, we cannot do this.  To do this, OpenSIPS rewrites SIP messages so that traffic between users goes through the RTPProxy server (the OpenSIPS module).  According to TalkPad statistics, voice traffic passes through the server for approximately 28-30% of users. <br><br>  <b>3. SBC &amp; Billing</b> <br>  In order for TalkPad users to communicate not only with each other, but also make calls to landline and mobile phones, we cooperate with local telephone operators, which also communicate using SIP and RTP protocols. <br><br>  To correctly calculate the user's cash flow, it is not enough just to proxy the user's SIP messages to the operator, since in this case we will lose control over the call progress.  A more appropriate solution is to establish a new SIP session with the operator, but in such a way that the RTP traffic is still directed directly between the user and the operator (or through the server if voice transcoding is necessary). <br><br>  These functions are performed by the Session Border Controller (or B2BUA).  In the latest versions of OpenSIPS, the B2BUA module is already integrated.  In addition, you can use <a href="http://www.b2bua.org/">B2BUA from Sippy Software</a> .  However, for TalkPad, we settled on using <a href="http://yate.null.ro/">YATE</a> , the classic ATC of the company Null Team, which naturally combines PBX and SBC functionality. <br><br>  One of the advantages of YATE is the Extmodule module, which makes it easy to write your own extensions in Python.  <a href="http://www.twistedmatrix.com/">Twisted is</a> used as the engine for handling asynchronous events.  In this way, we wrote a billing for TalkPad, which allows you to control the user's balance with second accuracy, even in the case of several simultaneous calls.  This distinguishes our billing from solutions based on the RADIUS protocol. <br><br>  <b>4. Failover</b> <br>  TalkPad combines DNS balancing with <a href="http://www.freebsd.org/doc/handbook/carp.html">CARP fault tolerance</a> as shown in the picture. <br>  OpenSIPS can proxy both in stateless proxy mode and statefull proxy mode, depending on the modules used.  In our case, this is a statefull and therefore we need the SIP client (voip plugin) to communicate with the same OpenSIPS during the session.  Thus, the SIP client must remove the DNS record 1 time at startup and use it until the end of the session. <br><br><img src="http://talkpad.ru/static/img/talkpad-schema.png" alt="image"><br><br>  Each OpenSIPS server replicates the REGISTER to a neighboring server, appending itself to the Path header.  This is necessary in order for another OpenSIPS to know from which address it is necessary to respond to the client, if necessary. <br><br>  What happens if OpenSIPS-Server # 1 crashes? <br>  In this case, the CARP1 interface on Server # 2 will automatically switch to the Master position, and both IP addresses of the DNS records will already be routed to Server # 2.  This is most clearly shown in the picture: <br><br><img src="http://talkpad.ru/static/img/talkpad-schema-server1fail.png" alt="image"><br><br>  If one of the YATE servers fails, the loadbalancer module in OpenSIPS recognizes this situation and will use only the second server, and the fallen one will be periodically checked to see if it has come to life. <br><br>  The scheme when just two users cut off two different IP and speak through the browser: <br><br><img src="http://talkpad.ru/static/img/talkpad-user1touser2.png" alt="image"><br><br>  <b>5. Databases</b> <br>  In the project, we use PostgreSQL and applications from the open-source <a href="http://pgfoundry.org/projects/skytools/">Skytools suite</a> (from Skype): a pgbouncer connection puller and a walmanager replication manager. <br><br>  In this article, we briefly mentioned the main points of operation of the TalkPad.  Next time we will talk about the features of cross-platform development of VoIP-plug-ins for browsers. <br><br>  Taking this opportunity, we want to inform you that the TalkPad team is actively looking for talented retailers, partners who would like to integrate telephony into their service, and investors. </div><p>Source: <a href="https://habr.com/ru/post/116658/">https://habr.com/ru/post/116658/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../116650/index.html">Instant Network Transmission</a></li>
<li><a href="../116652/index.html">Spring update, part 2 "Program of Encouragement of Authors"</a></li>
<li><a href="../116653/index.html">Mutulz is now a little dearer</a></li>
<li><a href="../116654/index.html">Minsk "Integral" showed a prototype tablet for schoolchildren</a></li>
<li><a href="../116657/index.html">Startups: that Russian is good, then German is death?</a></li>
<li><a href="../116659/index.html">Nuclear reactor - home from scratch</a></li>
<li><a href="../116660/index.html">Programming languages: first joke</a></li>
<li><a href="../116661/index.html">Earn with Opera!</a></li>
<li><a href="../116662/index.html">Google rolled out localized search in Iraq and Tunisia</a></li>
<li><a href="../116666/index.html">Introduction to F #, or useful about useless</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>