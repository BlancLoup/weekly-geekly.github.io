<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Another implementation of case-insensitive search for Cyrillic characters in SQLite</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, Habrovchane! 

 The problem of searching for Russian characters in SQLite has long been a talk of the town, the reasons for its appearance a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Another implementation of case-insensitive search for Cyrillic characters in SQLite</h1><div class="post__text post__text-html js-mediator-article">  Good day, Habrovchane! <br><br>  The problem of searching for Russian characters in SQLite has long been a talk of the town, the reasons for its appearance are described in some detail <a href="https://habrahabr.ru/post/150543/">here</a> .  However, there are quite common solutions to this problem, the most popular of which is to connect ICU, a library, with which you can implement a full Unicode search.  But I wanted a shorter solution code in terms of the result that the search was: <br><br><ul><li>  case-insensitive; </li><li>  in Russian and English characters; </li><li>  ignoring the  /  character while searching; </li><li>  fast; </li><li>  used inline NOCASE collation. </li></ul><a name="habracut"></a><br>  As a result, the idea came to dig into the source code of SQLite and fix it a little.  The toolkit was as follows: the System.Data.Sqlite assembly in which the SQLite Amalgamation source code is included (where all the kernel source code is stored in one file), Visual Studio 2017 and the test database. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To compare strings in the database core there is a function patternCompare.  As you know, it implements the nocase comparison only for the first 128 UTF-8 characters, for which there are corresponding checks in the code.  The idea was to write another small block of code that checks whether the character is Cyrillic.  If you look at the UTF-8 table, then for familiar characters to the heart, positions from 0x400 to 0x45F are highlighted.  Now we will create a test for the Cyrillic character and upper and lower case translation tables.  Some code. <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> IsCyrillic(A)(A &gt;= 0x400 &amp;&amp; A &lt;= 0x45F) static const unsigned short CyrillicUpper[128] = { 1024, 1045, 1026, 1027, 1028, 1029, 1030, 1031, 1032, 1033, 1034, 1035, 1036, 1037, 1038, 1039, 1040, 1041, 1042, 1043, 1044, 1045, 1046, 1047, 1048, 1049, 1050, 1051, 1052, 1053, 1054, 1055, 1056, 1057, 1058, 1059, 1060, 1061, 1062, 1063, 1064, 1065, 1066, 1067, 1068, 1069, 1070, 1071, 1040, 1041, 1042, 1043, 1044, 1045, 1046, 1047, 1048, 1049, 1050, 1051, 1052, 1053, 1054, 1055, 1056, 1057, 1058, 1059, 1060, 1061, 1062, 1063, 1064, 1065, 1066, 1067, 1068, 1069, 1070, 1071, 1104, 1045, 1106, 1107, 1108, 1109, 1110, 1111, 1112, 1113, 1114, 1115, 1116, 1117, 1118, 1119, 1120, 1121, 1122, 1123, 1124, 1125, 1126, 1127, 1128, 1129, 1130, 1131, 1132, 1133, 1134, 1135, 1136, 1137, 1138, 1139, 1140, 1141, 1142, 1143, 1144, 1145, 1146, 1147, 1148, 1149, 1150, 1151 }; static const unsigned short CyrillicLower[128] = { 1024, 1177, 1026, 1027, 1028, 1029, 1030, 1031, 1032, 1033, 1034, 1035, 1036, 1037, 1038, 1039, 1072, 1073, 1074, 1075, 1076, 1077, 1078, 1079, 1080, 1081, 1082, 1083, 1084, 1085, 1086, 1087, 1088, 1089, 1090, 1091, 1092, 1093, 1094, 1095, 1096, 1097, 1098, 1099, 1100, 1101, 1102, 1103, 1072, 1073, 1074, 1075, 1076, 1077, 1078, 1079, 1080, 1081, 1082, 1083, 1084, 1085, 1086, 1087, 1088, 1089, 1090, 1091, 1092, 1093, 1094, 1095, 1096, 1097, 1098, 1099, 1100, 1101, 1102, 1103, 1104, 1177, 1106, 1107, 1108, 1109, 1110, 1111, 1112, 1113, 1114, 1115, 1116, 1117, 1118, 1119, 1120, 1121, 1122, 1123, 1124, 1125, 1126, 1127, 1128, 1129, 1130, 1131, 1132, 1133, 1134, 1135, 1136, 1137, 1138, 1139, 1140, 1141, 1142, 1143, 1144, 1145, 1146, 1147, 1148, 1149, 1150, 1151 }; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CyrillicToUpper(ch)(CyrillicUpper[(unsigned char)(ch&amp;~0x400)]) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CyrillicToLower(ch)(CyrillicLower[(unsigned char)(ch&amp;~0x400)])</span></span></code> </pre> <br>  Things are easy, look at all the checks that the character is less than 0x80 and add another check for Cyrillicity.  This happens in two places, when checking the first character and all the rest.  I will not give the whole function of patternCompare, only these two places (already carefully corrected). <br><br>  The first block of code: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( c&lt;=<span class="hljs-number"><span class="hljs-number">0x80</span></span> ){ u32 cx; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bMatch; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( noCase ){ cx = sqlite3Toupper(c); c = sqlite3Tolower(c); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ cx = c; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>( (c2 = *(zString++))!=<span class="hljs-number"><span class="hljs-number">0</span></span> ){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( c2!=c &amp;&amp; c2!=cx ) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; bMatch = patternCompare(zPattern,zString,pInfo,matchOther); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( bMatch!=SQLITE_NOMATCH ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bMatch; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noCase &amp;&amp; IsCyrillic(c)) { u32 cx; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bMatch; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noCase) { cx = CyrillicToUpper(c); c = CyrillicToLower(c); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { cx = c; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((c2 = Utf8Read(zString)) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c2 != c &amp;&amp; c2 != cx) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; bMatch = patternCompare(zPattern, zString, pInfo, matchOther); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bMatch != SQLITE_NOMATCH) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bMatch; } }</code> </pre> <br>  The second block of code: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( noCase &amp;&amp; sqlite3Tolower(c)==sqlite3Tolower(c2) &amp;&amp; c&lt;<span class="hljs-number"><span class="hljs-number">0x80</span></span> &amp;&amp; c2&lt;<span class="hljs-number"><span class="hljs-number">0x80</span></span> ){ <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noCase &amp;&amp; CyrillicToLower(c) == CyrillicToLower(c2) &amp;&amp; IsCyrillic(c) &amp;&amp; IsCyrillic(c2)) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; }</code> </pre> <br><br>  The case-insensitive search for Russian and English text now works properly for the <i>WHERE LIKE '% xxx%'</i> Pattern but will not work for <i>WHERE LIKE 'xxx%'</i> if the field is indexed by the standard NOCASE function.  So if you want the indexed search to work too, you have to tinker a little more.  Let's look deeper into the library code and see that the sqlite3_strnicmp function is responsible for creating the index with c collation NOCASE.  In general, there are two of them, one with the parameter responsible for checking the length of the text, the other without.  We need the first.  But only the text in it, unlike patternCompare, is not decoded from UTF-8, so we realize one more test that the first byte is the highest for the Cyrillic character encoded in UTF-8, and also we realize decoding of the Cyrillic character from UTF- 8 with converting it to lower case. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsigned</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsCyrillcByte</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !((b &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) ^ <span class="hljs-number"><span class="hljs-number">0x68</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsigned</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">short</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadLowerCyrillic</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* in)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> b1, b2; b1 = *in; in++; b2 = *in; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CyrillicLower[(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)(b1 &lt;&lt; <span class="hljs-number"><span class="hljs-number">6</span></span>) | (b2 &amp;~ <span class="hljs-number"><span class="hljs-number">0x80</span></span>)]; }</code> </pre> <br><br>  Unfortunately, the sqlite3_strnicmp function had to be rewritten, since it was largely optimized for ASCII, now it looks like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">SQLITE_API </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sqlite3_strnicmp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *zLeft, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *zRight, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> N)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">register</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *a, *b; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> cLeft, cRight; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( zLeft==<span class="hljs-number"><span class="hljs-number">0</span></span> ){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> zRight ? <span class="hljs-number"><span class="hljs-number">-1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( zRight==<span class="hljs-number"><span class="hljs-number">0</span></span> ){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } a = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)zLeft; b = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)zRight; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(;N &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; N--) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*a &lt;= <span class="hljs-number"><span class="hljs-number">0x80</span></span> &amp;&amp; *b &lt;= <span class="hljs-number"><span class="hljs-number">0x80</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*a != <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; UpperToLower[*a] == UpperToLower[*b]) { a++; b++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UpperToLower[*a] - UpperToLower[*b]; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsCyrillcByte(*a) &amp;&amp; IsCyrillcByte(*b)) { cLeft = ReadLowerCyrillic(a); cRight = ReadLowerCyrillic(b); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cLeft == cRight) { a += <span class="hljs-number"><span class="hljs-number">2</span></span>; b += <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cLeft - cRight; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*a == *b) { a++; b++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> *a - *b; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><br>  Everything, it is possible to <s>water with sauce and to</s> compile.  It is also necessary at the end to perform a simple query to the database <b>REINDEX NOCASE;</b>  to re-create all case-insensitive indexes. </div><p>Source: <a href="https://habr.com/ru/post/344478/">https://habr.com/ru/post/344478/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../344462/index.html">I am drooling, writing code</a></li>
<li><a href="../344466/index.html">Integration - bikes</a></li>
<li><a href="../344470/index.html">Clean Code Tips for Java / Android Newbies</a></li>
<li><a href="../344474/index.html">Creating an Ionic application using the API</a></li>
<li><a href="../344476/index.html">Opportunities for non-integrated communications</a></li>
<li><a href="../344480/index.html">Perfect maven. Part 2: project structure</a></li>
<li><a href="../344482/index.html">Intel AI Academy - New Year's gift for all developers of AI</a></li>
<li><a href="../344484/index.html">Click, trade, deposit. Our online tools for corporate clients</a></li>
<li><a href="../344486/index.html">Parcel - a very fast bandler that does not require configuration.</a></li>
<li><a href="../344488/index.html">Monitoring Trassir Servers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>