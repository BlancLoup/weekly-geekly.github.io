<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Microcontroller Stapler</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the course of work as an ‚Äúengineer of everything‚Äù in a printing house, one has to deal with the repair and upgrade of some tricky devices that are ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Microcontroller Stapler</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/370/88c/d76/37088cd76db74b7e919a939bae1061fc.jpg"><br><br>  In the course of work as an ‚Äúengineer of everything‚Äù in a printing house, one has to deal with the repair and upgrade of some tricky devices that are not commonly found in everyday life.  One of my ‚Äúfavorites‚Äù is the brainchild of the gloomy Swedish genius, the electric <a href="http://www.rapid.com/en-US/Products/Rapid-Classic-Electric-Stapler-106E_10875325/">Rapid 106</a> stapler.  On the one hand, the oldest Rapid works for us from the beginning of the two thousandth, this is an indicator.  On the other hand, there are enough problems with them.  Some jokes are associated with specific electronics. <br><br>  One day, the cup of patience was overflowing.  At that time, I knew that Rapids were not good at network interference (and there are powerful frequency drives nearby), that one of them recently said: ‚ÄúWASTE!‚Äù And did not turn on anymore, and that the new device costs about 40 thousand rubles . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br>  At first, I wanted to conduct reverse engineering of the native board.  But in the process I decided that I absolutely did not like some of the technical solutions of the original.  Yes, it is presumptuous, but the concept of ‚Äúhow to make it easier‚Äù was already taking shape in my head.  Here are some features of the circuit design, it would seem, such a simple device as an electric stapler: <br><br>  1. Four chips - two multivibrators, one counter, one set of triggers. <br>  2. Under a hundred other items. <br>  3. The power supply of microcircuits (for a minute, CMOS!) Is realized without galvanic isolation from the network. <br>  4. There is a scheme of optical synchronization of the stapler with other equipment.  You can use two staplers "in line".  Never been used. <br>  5. The electromagnet of the stapler is switched by the triac. <br><br><img src="https://habrastorage.org/files/b94/35a/da8/b9435ada878d42108a83b87ad336a437.jpg"><br>  <i>Native electronics stapler</i> <br><br>  Of these points, the willful decision of the first four is considered unnecessary.  Formed a new principle of work: <br><br>  1. To control the electromagnet uses a typical inclusion optocoupler MOC3052.  Power triac and snubber (resistor and capacitor) migrate to the new circuit. <br>  2. The control pulse on the optocoupler is given by the microcontroller. <br><br>  Thus, we have ATTiny13A, which uses a comparator (to detect a mains voltage transition through zero), an ADC (a variable resistor on it sets the delay for outputting a shock pulse), one input (pedal-button) and one output (for issuing a pulse). <br><br>  <b>About cutting a sine wave</b> <br><br>  The triac, which controls the electromagnet, opens when the control voltage is applied, and closes when the mains voltage goes through zero (in the absence of the control voltage).  You can open the triac either in zero or in some part of the half period.  If we open in zero, then everything turns out very nicely and humanely, there is no interference from a sharp increase in voltage, but then we can operate only with a whole number of half-periods.  The MOC306x optocoupler is equipped with a built-in zero detector, i.e., it turns on and off only at zero.  In fact, combining it with a power triac, we get a solid-state AC relay. <br><br><img src="https://habrastorage.org/files/ad7/5ff/438/ad75ff4384c543a79bde370761fb5434.jpg"><br>  <i>Actuator</i> <br><br>  But in our case, everything is worse.  "Rapid" by the principle of control is not like a solid-state relay, but a dimmer.  That is, at the command of the operator, our control unit must turn on the triac at a specific place in the half period.  It will turn itself off when it reaches zero.  The impact force depends in the end on how large the half cycle period is involved.  So, we use the optocoupler MOC305x, in which there is no zero detection circuit. <br><br>  <b>Concrete</b> <br><br>  So, the operation algorithm is defined: <br>  1. Pushing the pedal by the operator. <br>  2. Determination of the triac inclusion.  Depending on the position of the variable resistor (enabled by the divider between Vcc and GND, the average output at the ADC input), the delay (ms) is calculated, which lies in the specified range (selected by experience, 3-5 ms). <br>  3. Detection of mains voltage zero (using a microcontroller comparator). <br>  4. Testing the delay. <br>  5. Issuance of a control pulse with a duration of 1 ms to the optocoupler. <br><br>  Rakes were in point number 3.  How to catch zero with a microcontroller?  The simplest solution is to supply the mains voltage to one input of the comparator from the divider, to the second - a little more than zero (from the other divider).  In this case, the galvanic isolation of the high- and low-voltage parts of the circuit is violated, and in real conditions we get disgusting noise immunity and accidental operation.  On this inner Jedi said to me: "Solve the problem in the forehead."  The solution is as follows: a small dirty transformer, issuing 9 VAC, is pulled out from somewhere.  Two low-power diode bridges are placed on its exit.  From one we take the measured pulsating voltage, on the other we put a capacitor and a stabilizer - this is the power supply of the microcontroller.  And now, she, stability! <br><br>  <b>Implementation details</b> <br><br><img src="https://habrastorage.org/files/eaf/c82/07d/eafc8207d8794c07b759ffb950feb386.jpg"><br>  <i>New board</i> <br><br>  Scheme - Eagle, layout - Sprint Layout.  Firmware Development - Sublime Text (Sublime-AVR).  Programming MK - ChipProg-40.  ISP on the board is not divorced to simplify - debugging in the gland took a little time, with a maximum of a dozen distortions of the MK from the board to the programmer and back. <br><br><div class="spoiler">  <b class="spoiler_title">Firmware code</b> <div class="spoiler_text"><pre><code class="hljs lua">#include &lt;avr/<span class="hljs-built_in"><span class="hljs-built_in">io</span></span>.h&gt; #include &lt;util/delay.h&gt; #define F_CPU <span class="hljs-number"><span class="hljs-number">1200000</span></span>UL //       #define MINDELAY <span class="hljs-number"><span class="hljs-number">3</span></span> #define MAXDELAY <span class="hljs-number"><span class="hljs-number">5</span></span> //      PB4.   - . #define PEDAL PB4 //  - PB3.   - . #define FIRE PB3 void delaymsMod(unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> ms) //  ,   _delay_ms  . //    . { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> counter=<span class="hljs-number"><span class="hljs-number">0</span></span>; counter&lt;ms; counter++) { _delay_ms(<span class="hljs-number"><span class="hljs-number">1</span></span>); } } unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> fireDelay(void) //  .  .     . //  ,      <span class="hljs-number"><span class="hljs-number">0</span></span>     //    ,       , // ,  .  . { // ACD -    ACSR |= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; ACD); //  <span class="hljs-number"><span class="hljs-number">5</span></span> - ADLAR,  .    <span class="hljs-number"><span class="hljs-number">8</span></span>  ADCH //  <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span> -  . <span class="hljs-number"><span class="hljs-number">01</span></span> . ADC1 (PB2) ADMUX |= <span class="hljs-number"><span class="hljs-number">0</span></span>b00100001; // ADPS2<span class="hljs-number"><span class="hljs-number">-1</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span>    . <span class="hljs-number"><span class="hljs-number">011</span></span> .  <span class="hljs-number"><span class="hljs-number">8</span></span> //    <span class="hljs-number"><span class="hljs-number">150</span></span>  (<span class="hljs-number"><span class="hljs-number">1.2</span></span>  / <span class="hljs-number"><span class="hljs-number">8</span></span>) ADCSRA |= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; ADPS1) | (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; ADPS0); //   ADCSRA |= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; ADEN); //   ADCSRA |= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; ADSC); // ,      <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (ADCSRA &amp; (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; ADSC)); //  <span class="hljs-number"><span class="hljs-number">8</span></span>   unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> rawADC = ADCH; //   ADCSRA &amp;= ~(<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; ADEN); //   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MINDELAY + rawADC * (MAXDELAY - MINDELAY) / <span class="hljs-number"><span class="hljs-number">255</span></span>; } void waitForZero(void) //  .    .  . { ACSR &amp;= ~(<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; ACD); _delay_ms(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((ACSR &amp; <span class="hljs-number"><span class="hljs-number">0</span></span>b00100000) == <span class="hljs-number"><span class="hljs-number">0</span></span>b00100000); ACSR |= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; ACD); } unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> pedal(void) //   .   .    . { unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> pressed = <span class="hljs-number"><span class="hljs-number">0</span></span>; //   // ,        unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> pressedTime = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PINB &amp; (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; PEDAL)) //  ,  ,   <span class="hljs-number"><span class="hljs-number">1</span></span> { pressed = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> counter=<span class="hljs-number"><span class="hljs-number">0</span></span>; counter &lt; pressedTime; counter++) { //       ,  // ,   <span class="hljs-number"><span class="hljs-number">0</span></span> -    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !(PINB &amp; (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; PEDAL))) { pressed = <span class="hljs-number"><span class="hljs-number">0</span></span>; } _delay_ms(<span class="hljs-number"><span class="hljs-number">1</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; } void fire(void) //    <span class="hljs-number"><span class="hljs-number">1</span></span>  { PORTB |= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; FIRE); _delay_ms(<span class="hljs-number"><span class="hljs-number">1</span></span>); PORTB &amp;= ~(<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; FIRE); } void setup(void) { //   DDRB=<span class="hljs-number"><span class="hljs-number">0</span></span>b00001000; } int main(void) { setup(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pedal()) { waitForZero(); delaymsMod(fireDelay()); fire(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(pedal()); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; //  }</code> </pre> <br></div></div><br><br>  SMD resistors (1206) and capacitors (0805) in the low-voltage part of the circuit were used to acquire additional installation skills.  Board manufacturing techniques: <br><br>  1. A piece of some PCB.  Cleaning with a hard dish cloth and Pemolux. <br>  2. Film photoresist (Ordyl Alpha 350).  Prikatka GMP laminator (120 degrees, min. Speed). <br>  3. Photomask (transparent film, Oki 9655 printer). <br>  4. Highlights a 20-watt UV savings (6 minutes). <br>  5. Remover excess (potash). <br>  6. Etching (ferric chloride, water bath, periodic exposure with a soft brush). <br>  7. Drilling, tinning, sealing, testing. <br><br><img src="https://habrastorage.org/files/895/e77/b73/895e77b73356461daacbfd572c572168.jpg"><br>  <i>SMD-on-the-knee and wiring error correction</i> <br><br>  <b>Total</b> <br><br>  Spent a lot of time.  Two weeks passed from idea to implementation, was engaged in the project in ‚Äúfree time‚Äù.  But now there is a simple, clear, cheap and easily repeatable control unit stapler.  Received additional skill - the use of optocouplers and triacs for load control. <br><br>  <a href="https://github.com/eta4ever/rapid-rework">All developments - on githabe.</a> <br><br>  UPD.  Added video.  Filmed on a tea-bag with a bad camera, but it gives a general idea.  The first two blows are ‚Äúidle‚Äù because of the almost complete death of the stepping head, it was used to debug the general concept. <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/AI0m0vtea6c%3Ffeature%3Doembed&amp;xid=17259,1500004,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhijwJtPaXXe8g3dGdFmqOH0O16Iiw" frameborder="0" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/256763/">https://habr.com/ru/post/256763/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256747/index.html">Analytical review of the Big Data market</a></li>
<li><a href="../256749/index.html">Data loss and downtime cost Russian companies more than $ 29 billion</a></li>
<li><a href="../256753/index.html">Vivaldi 1.0.162.2 TP3 Candidate</a></li>
<li><a href="../256755/index.html">May the words of power be with you</a></li>
<li><a href="../256761/index.html">Creating HANA Applications Using the Eclipse Development Environment</a></li>
<li><a href="../256769/index.html">Wedding Night with Ardour 4.0 + Calf 0.0.60 New Lv2 Plugin Review</a></li>
<li><a href="../256771/index.html">Metal Gear Rising - cutting</a></li>
<li><a href="../256775/index.html">Krovi: Big Data - as dream. 8th series. Non-technical. Modular journalism</a></li>
<li><a href="../256777/index.html">Yes, what the hell, horseradish, D-Link‚Åà</a></li>
<li><a href="../256779/index.html">1 year in ABBYY: Part 2 - Base Complaints, Slippers and ABBYY Road</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>