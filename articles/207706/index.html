<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Build Android on Mac OS X</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introductory  For one of the projects, it was necessary to revise the original Android code to create the firmware for a specific piece of hardware. T...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Build Android on Mac OS X</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/62d/df7/453/62ddf74532d7222c31bccaaca1f22c24.jpg" alt="image"><br><br><h4>  Introductory </h4>  For one of the projects, it was necessary to revise the original Android code to create the firmware for a specific piece of hardware.  The version for the assembly was chosen already relatively old - AOSP 4.0.4, but it is based on a stable code branch from the manufacturer of the piece of iron, therefore the condition is necessary.  In addition to developing for Android, I develop iOS applications, respectively, I work under Mac OS X and use Xcode as one of the development environments. <br><br>  The main problem in my case was that the old versions of AOSP are not tracked by anyone and new edits are not made to the build system.  Therefore, if the assembly of the master is not particularly difficult, then the assembly of previous versions of Android for more recent versions of MacOS requires fixing a number of problems. <br><a name="habracut"></a><br>  In my case, the working environment looks like this: <br><ul><li>  AOSP 4.0.4 r1.1 (as well as 4.0.3 and 4.1.1) </li><li>  Mac OS X 10.7.5 </li><li>  Xcode 4.6.3 and command line tools </li><li>  GNU Make 3.81 </li></ul><br>  All the highlights and difficulties of assembling AOSP are well described in the official <a href="http://source.android.com/source/">documentation</a> .  It also indicates that MacOS 10.5 or 10.6 is required for building 4.0.x branch and Xcode 3.14 is recommended, and in the ‚ÄúKnown issues‚Äù section it is <a href="http://source.android.com/source/known-issues.html">indicated</a> that 4.0.x branch is not compatible with MacOS 10.7. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I use MacOS and Xcode for development and did not want to roll back to previous versions.  In addition, there was a purely sporting interest to deal with the assembly without any fundamental changes in the environment. <br><br><h4>  Decision </h4>  Directly all the initial steps for assembly are described in the documentation and were performed in accordance with it: a case-sensitive disk image was created, the necessary utilities were installed, the Android code was downloaded.  Then the build with the full-eng profile was launched. <br><br>  Below I give the error texts from the console and the methods of correction.  Depending on the version of AOSP and your environment, they may appear all or in part.  Most of the solutions can be found on the Internet, I give only a brief description of the necessary actions.  In addition to AOSP 4.0.4, versions 4.0.3 and 4.1.1 were also checked.  The newer the version, the fewer errors occurred, but the first 2 took place everywhere.  Separately, it is worth noting that when making the described changes, the emulator is going to correctly and I have not encountered problems with running the emulator specified in the same official ‚ÄúKnown issues‚Äù. <br><br>  Running the assembly to solve problems with the compiler is done by the command below.  Here the important part is <b>CC = "gcc" CXX = "g ++"</b> , the rest can be standard parameters in any order and combination. <br><pre><code class="bash hljs">make CC=<span class="hljs-string"><span class="hljs-string">"gcc"</span></span> CXX=<span class="hljs-string"><span class="hljs-string">"g++"</span></span> -j4</code> </pre> <br>  In the course of the assembly, apart from the one described in the documentation, the following problems arose: <br><br><h5>  Error 1 </h5><br><pre> <code class="bash hljs">external/webkit/Source/WebCore/xml/XPathParser.cpp: In member <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-string"><span class="hljs-string">'WebCore::XPath::Expression* WebCore::XPath::Parser::parseStatement(const WTF::String&amp;, WTF::PassRefPtr&lt;WebCore::XPathNSResolver&gt;, WebCore::ExceptionCode&amp;)'</span></span>: external/webkit/Source/WebCore/xml/XPathParser.cpp:480:39: error: too many arguments to <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-string"><span class="hljs-string">'int WebCore::XPath::xpathyyparse()'</span></span> out/target/product/generic/obj/STATIC_LIBRARIES/libwebcore_intermediates/Source/WebCore/XPathGrammar.hpp:106:5: note: declared here make: *** [out/target/product/generic/obj/STATIC_LIBRARIES/libwebcore_intermediates/Source/WebCore/xml/XPathParser.o] Error 1</code> </pre><br><h6>  Correction </h6>  Apply the patch <a href="https://bugs.webkit.org/show_bug.cgi%3Fid%3D92264">https://bugs.webkit.org/show_bug.cgi?id=92264</a> .  The patch falls with a small error, due to the discrepancy of the context, you need to look at the rej and remove a couple of old lines that the patch could not remove.  Apply patch in external / webkit / directory. <br><br><h6>  Important </h6>  During linking, at the final stage of the assembly, errors like this may appear: <br><pre> <code class="bash hljs">prebuilt/darwin-x86/toolchain/arm-linux-androideabi-4.4.x/bin/../lib/gcc/arm-linux-androideabi/4.4.3/../../../../arm-linux-androideabi/bin/ld: out/target/product/generic/obj/STATIC_LIBRARIES/libwebcore_intermediates/libwebcore.a(CSSParser.o): <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> WebCore::CSSParser::parseMediaQuery(WebCore::MediaList*, WTF::String const&amp;):external/webkit/Source/WebCore/css/CSSParser.cpp:621: error: undefined reference to <span class="hljs-string"><span class="hljs-string">'cssyyparse(WebCore::CSSParser*)'</span></span></code> </pre><br>  Depending on whether you added changes to CSSParser.  A certain mystic linker appears here (for the 4.1.1 version with the build with these corrections, there are no such problems).  To fix the problem, you need to make some changes in CSSParser (read by the compiler, ie, not comments).  I changed the definition of this function from cssyyparse (void *) to cssyyparse (WebCore :: CSSParser *) or vice versa.  Then start rebuilding - everything will run smoothly from this place. <br><br><h5>  Error 2 </h5><br><pre> <code class="bash hljs">host SharedLib: libSR_Recognizer (out/host/darwin-x86/obj/lib/libSR_Recognizer.dylib) Undefined symbols <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> architecture i386: <span class="hljs-string"><span class="hljs-string">"_canPushAudioIntoRecognizer"</span></span>, referenced from: _SR_RecognizerAdvanceImpl <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> RecognizerImpl.o _detectBeginningOfSpeech <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> RecognizerImpl.o ... ld: symbol(s) not found <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> architecture i386 collect2: ld returned 1 <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> status make: *** [out/host/darwin-x86/obj/lib/libSR_Recognizer.dylib] Error 1</code> </pre><br><h6>  Correction </h6>  Transfer definition to external / srec / portable / include / PortExport.h from master branch to ours. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> defined(__APPLE_CC__) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> __APPLE_CC__ &gt;= 5621 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">undef</span></span></span><span class="hljs-meta"> PINLINE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PINLINE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre><br><br><h5>  Error 3 </h5><br><pre> <code class="bash hljs">host Executable: triangleCM (out/host/darwin-x86/obj/EXECUTABLES/ triangleCM_intermediates/triangleCM) Undefined symbols: <span class="hljs-string"><span class="hljs-string">"__dyld_func_lookup"</span></span>, referenced from: _promoteLocalToGlobal <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> libSDL.a(SDL_dlcompat.o) _dlcompat_init_func <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> libSDL.a(SDL_dlcompat.o) ... ld: symbol(s) not found collect2: ld returned 1 <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> status make: *** [out/host/darwin-x86/obj/EXECUTABLES/ triangleCM_intermediates/triangleCM] Error 1</code> </pre><br><h6>  Correction </h6>  Add the LOCAL_SDL_LDLIBS + = /usr/lib/dylib1.o library to / development / tools / emulator / opengl / tests / translator_tests / for GLES_V2 / Android.mk and GLES_CM / Android.mk. <br><br><h5>  Error 4 </h5>  Different definition of the strnlen function in the system and in local files.  Unfortunately for this error the log is not recorded, but the essence will be clear at the mention of the function strnlen. <br><br><h6>  Correction </h6>  Add a condition for the strnlen function to external / elfutils / config-compat-darwin.h: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> __MAC_OS_X_VERSION_MIN_REQUIRED &lt; 1070 static inline size_t strnlen (const char *__string, size_t __maxlen) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre><br><br><h5>  Error 5 </h5>  Select the version of the SDK version of Mac OS to build the emulator.  Similar to the previous error without the log, but the mention of the emulator qemu in the log will indicate here. <br><br><h6>  Correction </h6>  Replace the condition for the Mac OS version external / qemu / Makefile.android: <br><pre> <code class="bash hljs">- ifeq ($(filter 10.5 10.5.%,$(DARWIN_VERSION)),) + ifneq ($(filter 10.6 10.6.%,$(DARWIN_VERSION)),)</code> </pre><br>  And add connection libraries for MacOS: <br><pre> <code class="bash hljs"> ifeq ($(HOST_OS),darwin) QEMU_SYSTEM_LDLIBS += -Wl,-framework,Cocoa,-framework,QTKit,-framework,CoreVideo + ifneq ($(filter 10.7 10.7.%,$(DARWIN_VERSION)),) + <span class="hljs-comment"><span class="hljs-comment"># Lion/XCode4 needs to be explicitly told the dynamic library + # lookup symbols in the precompiled libSDL are resolved at + # runtime + QEMU_SYSTEM_LDLIBS += -undefined dynamic_lookup + endif endif</span></span></code> </pre><br><br><h5>  Error 6 </h5>  If your operating system is on a disk with a case-sensitive file system, then this error may occur: <br><pre> <code class="bash hljs">external/qemu/android/camera/camera-capture-mac.m:24:24: error: QTKit/QTkit.h: No such file or directory</code> </pre><br><h6>  Correction </h6>  The essence of the problem is simple - there is a typo in the name of the .h file, instead of the large K a small k is printed.  Usually does not appear, because  MacOS is installed on a disk with a case-insensitive file system.  It fixes simply by replacing in the code with the correct file name "QTKit.h". <br><br><h4>  Conclusion </h4>  The main conclusion can be made that still collect Android better on Linux systems, or in a virtual machine, if you allow the power.  In this case, MacOS is only an alternative and, as the developers themselves write, when updating the build system, all versions of the OS are not checked, and often they do not even have such an opportunity. </div><p>Source: <a href="https://habr.com/ru/post/207706/">https://habr.com/ru/post/207706/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../207690/index.html">Using Portable Class Libraries with Windows Phone 7.5 Support in Visual Studio 2013</a></li>
<li><a href="../207694/index.html">Stranger than life? Reality TV as a mirror of morals</a></li>
<li><a href="../207698/index.html">Some interesting and useful things for web developer # 10</a></li>
<li><a href="../207700/index.html">Highload information blocks and work with them</a></li>
<li><a href="../207702/index.html">Internet Archive laid out the classic games of the 70s and 80s for free</a></li>
<li><a href="../207708/index.html">Development of technical specifications (TZ) for a software product from the point of view of the customer. We work on bugs</a></li>
<li><a href="../207710/index.html">The release of the beta version of the trading application on major Bitcoin exchanges raised WPCS shares by 20%</a></li>
<li><a href="../207716/index.html">Chuck Norris and Google Glass - what is in common, but ...</a></li>
<li><a href="../207720/index.html">Sherlock Holmes is in the public domain</a></li>
<li><a href="../207722/index.html">Do you use social buttons?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>