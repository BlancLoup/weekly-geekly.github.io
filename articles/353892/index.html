<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Splunk Scripted Input. Or how to use scripts to obtain data on the operation of systems and analyze them in Splunk</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Earlier we wrote how to upload logs to Splunk from the catalog or using syslog, how to pick up standard Windows and Linux events, but what if we need ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Splunk Scripted Input. Or how to use scripts to obtain data on the operation of systems and analyze them in Splunk</h1><div class="post__text post__text-html js-mediator-article">  Earlier we <a href="https://habrahabr.ru/company/tssolution/blog/353426">wrote</a> how to upload logs to Splunk from the catalog or using syslog, how to pick up standard Windows and Linux events, but what if we need to get more granular information about the operation of our systems? <br>  In this case, scripts come to the rescue! <br><br><img src="https://habrastorage.org/webt/zd/zh/on/zdzhonxyhgmeh1zsaz5s6_vqrwa.png"><br><br>  When, what and how you can use Splunk scripts to get data - you can find out under the cat. <br><a name="habracut"></a><br><h2>  <font color="#0075a9">Typical Uses</font> </h2><br>  Scripts are often used in cases where: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Requires access to information that is <b>not written to the log</b> ; </li><li>  We need <b>data generated via the command line</b> , for example, using vmstat or iostat; </li><li>  We <b>need specific data</b> or results from databases, web services or APIs; </li><li>  Data needs <b>preprocessing</b> for easier parsing of events and fields; </li><li>  Data sources with slow and <b>resource-intensive startup procedures are used</b> ; </li><li>  And etc. </li></ul><br>  For a script, you can set the <b>interval</b> at which it will be played and transfer data to Splunk. <br><br>  As scripts, you can use <i>shell scripts, python scripts, Windows command files, PowerShell,</i> or any other utilities that can generate and transmit data. <br><br><h2>  <font color="#0075a9">Example</font> </h2><br>  Within the framework of the article we will consider an example of loading data using a script. <br><br>  Suppose we have a file server and a directory, the size of which we need to monitor for some reason, and we also want it not to exceed the threshold value (for a test of 45 MB).  Let's write a script that will consider the size of this directory at an interval of 30 seconds, and also make an alert that will notify us if the threshold value is exceeded. <br>  The size of the folder will be read using the script below, which will output a timestamp, the path to the folder and its size in bytes. <br><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime dir_path="///for_script" def get_size(start_path = <span class="hljs-string"><span class="hljs-string">'.'</span></span>): total_size = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> dirpath, dirnames, filenames <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> os.walk(start_path): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> f <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> filenames: fp = os.path.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(dirpath, f) total_size += os.path.getsize(fp) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> total_size time_of_event=datetime.strftime(datetime.now(), "%Y.%m.%d %H:%M:%S") print time_of_event, dir_path, get_size(dir_path)</code> </pre> <br>  For more information on downloading data from remote sources, we discussed in previous articles ( <a href="https://habrahabr.ru/company/tssolution/blog/353426/">here</a> and <a href="https://habrahabr.ru/company/tssolution/blog/352944/">here</a> ).  Therefore, we now discuss this briefly. <br><br>  <b>We need:</b> <br><br>  ‚Ä¢ Remote machine where <b>Splunk Universal Forwarder</b> is installed <br>  ‚Ä¢ Splunk-indexer, on which we create the <b>send-to-indexer</b> application, transfer it to <b>deployment-apps</b> and configure <b>Forwarder managemen</b> t. <br><br>  Also on the Splunk indexer, we <b>create the monitor_scripts application</b> , transfer it to the <b>deployment-apps</b> folder.  In the application, we create the <b>local</b> folder and the <b>inputs.conf</b> file with the following contents: <br><br><pre> <code class="hljs pgsql">[script://./bin/scripts/foldersize.py] disabled = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = test_script <span class="hljs-type"><span class="hljs-type">interval</span></span> = <span class="hljs-number"><span class="hljs-number">30.0</span></span> sourcetype = test_script</code> </pre> <br>  We also add our script there to the <b>/ bin directory</b> <br><br>  Restarting the deployment server <br> <code>.../splunk/bin/splunk reload deploy-server</code> <br> <br>  And ... get the data! <br><br><h3>  Data processing and creating an alert </h3><br>  Splunk automatically chose a timestamp, but the rest of the information remained in the form of raw data, so you need to select the fields (We wrote about how to do this <a href="https://habrahabr.ru/company/tssolution/blog/353426/">in the previous article</a> ) In this case, we selected 2 fields: folder path (folder_path) and size (size) <br><br>  Folder size is represented in bytes, let's translate this number in MB.  (This can be done in the script, but we will show how to do it in Splunk) <br><br>  Create a new calculated field <i><b>(Settings - Fields - Calculated fields - New)</b></i> <br>  Specify the source type of our data, the name of the new field and the expression to calculate.  Now this calculated field will be added to the data with the specified source type. <br><br><img src="https://habrastorage.org/webt/rt/8p/fg/rt8pfg8zyzsxmyegyke6k7e8-4q.png"><br><br>  We have received all the fields of interest to us, let's <b>create a graph</b> that shows the dynamics of the folder resizing and whether it reaches the threshold value. <br><br><img src="https://habrastorage.org/webt/ov/0b/pl/ov0bplm05og9kdzz9e-xajcttik.png"><br><br>  <b>Create an alert.</b>  Let, when the size of the folder exceeds 45 MB, Splunk will send us an email.  For more information on how to send an e-mail alert, we wrote <a href="https://habrahabr.ru/company/tssolution/blog/351038/">here</a> , and in Slack - <a href="https://habrahabr.ru/company/tssolution/blog/351798/">here</a> . <br><br>  The alert will be based on a new query, so that you can insert fields from the query into the messages. <br><br><img src="https://habrastorage.org/webt/d_/hb/hn/d_hbhnwg4rtmdwcfljtujnoz0e8.png"><br><br>  We save the request as an alert and prescribe its conditions: <br><br><img src="https://habrastorage.org/webt/vb/58/gx/vb58gxg5_utyxfj6p1wal0ruvm0.png"><br><img src="https://habrastorage.org/webt/0_/jk/nm/0_jknme1sx6fqrrlr__0pls9-s8.png"><br><br>  And we get a letter: <br><br><img src="https://habrastorage.org/webt/en/w7/hn/enw7hnubfrspsjkhmjhg7vzycyg.png"><br><br>  In the settings of the alert, we found that if the folder size does not decrease within 15 minutes, the alert will come again. <br><br><h2>  <font color="#0075a9">Conclusion</font> </h2><br>  In this simple example, we showed the principle of loading data into Splunk through scripts.  You can create a script that will solve your problem: upload the necessary information to Splunk and quickly get the result. <br><br>  We hope that this information will be useful for you. <br><br>  We are happy to answer all your questions and comments on this topic.  Also, if you are interested in something specifically in this area, or in the field of machine data analysis in general, we are ready to refine the existing solutions for you, for your specific task.  To do this, you can write about it in the comments or simply send us a request through the form on our <a href="https://tssolution.ru/splunk/">website</a> . <br><br>  We are the official <a href="https://partners.splunk.com/locator/partner/333601/ts-solution">Premier Splunk Partner</a> . <br><br><img src="https://habrastorage.org/webt/ey/yy/9n/eyyy9nzwq4rf9kolg17ihjq5bik.png"><br><br><h2>  PS </h2><br>  <b>On June 28, 2018,</b> ‚Äú <a href="http://tssolution.tilda.ws/study-splunk">Splunk Getting Started</a> ‚Äù will be taught <b>in Moscow</b> , where in 6 hours the participants will receive a theoretical base and practical skills for working in Splunk.  Learn more about learning and register at this <a href="http://tssolution.tilda.ws/study-splunk">link</a> . </div><p>Source: <a href="https://habr.com/ru/post/353892/">https://habr.com/ru/post/353892/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353880/index.html">Telegram and AWS Blocking - Morning does not start with coffee</a></li>
<li><a href="../353884/index.html">Sophisticated javascript call center</a></li>
<li><a href="../353886/index.html">Asynchronous Loops and Stream APIs in Node.js 10</a></li>
<li><a href="../353888/index.html">Where and how to grow talents?</a></li>
<li><a href="../353890/index.html">A simple filter to automatically remove the background from images</a></li>
<li><a href="../353896/index.html">SvelteJS: Second Version Release</a></li>
<li><a href="../353898/index.html">From custom websites to enterprise products</a></li>
<li><a href="../353902/index.html">Newman and Continuous Integration on the example of Atlassian Bamboo. The invention of the bicycle</a></li>
<li><a href="../353904/index.html">Pedro Uria: "The problem for information security will not be malware, but hackers"</a></li>
<li><a href="../353906/index.html">CIO or how to build an IT department of the organization</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>