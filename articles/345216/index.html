<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Expanding Ansible with plugins: part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Under the hood of the d2c.io service , we actively use Ansible ‚Äî from creating virtual machines in the clouds of providers and installing the necessar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Expanding Ansible with plugins: part 2</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/webt/cy/j5/td/cyj5tdhdz488v-z69nz_ebzj1cu.jpeg"><br><p>  Under the hood of the <a href="https://d2c.io/">d2c.io</a> service <a href="https://d2c.io/">,</a> we actively use Ansible ‚Äî from creating virtual machines in the clouds of providers and installing the necessary software, to managing Docker containers with client applications. </p><br><p>  <a href="https://habrahabr.ru/company/d2cio/blog/344046/">In the first part,</a> we looked at the types of plug-ins that Ansible supports and made some of their plug-ins: test, filter, action and callback.  In this article we will try more complex modifications. </p><a name="habracut"></a><br><h3 id="callback-s-mutaciey">  Callback with "mutation" </h3><br><p>  The most frequent use of callback plug-ins are logging and alerting systems.  However, with their help, you can not only perform passive observation of events, but also actively influence the progress of the playbook. </p><br><p> In order to be able to perform only some tasks from some roles, we actively use tags in D2C.  For example, when you start a role with the <code>build</code> tag, the service will be fully assembled from scratch, and when started with the <code>update-configs</code> tag, only the configuration files will be updated and applied.  In the out-of-the-box version, Ansible can apply a single set of tags to the entire playbook. </p><br><p>  Let us analyze the task of launching Master-Slave replication for the MySQL service: </p><br><ul><li>  need to update primary server configuration </li><li>  make a copy of the base for the initial replica filling </li><li>  make a second server, set up replication </li><li>  restore original base on cue </li><li>  delete temporary data </li></ul><br><p>  Each task has its own tags.  To combine this process into one playbook, we can describe three playa (play is a configuration unit of which a playbook consists): to prepare a wizard, to prepare a replica, to clear it.  However, we cannot specify the tags for each part separately, as they are set through the <code>tags</code> parameter for the entire playbook.  Let's fix this by using the callback plugin: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ansible.plugins.callback <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> CallbackBase <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ansible.parsing.yaml.objects <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> AnsibleUnicode <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ansible.compat.six <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> string_types <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-type"><span class="hljs-type">json</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> CallbackModule(CallbackBase): CALLBACK_VERSION = <span class="hljs-number"><span class="hljs-number">2.0</span></span> CALLBACK_NAME = <span class="hljs-string"><span class="hljs-string">'use_tags'</span></span> def __init__(self): super(CallbackModule, self).__init__() self.tmp_context = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> self.warn = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> os.environ.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">'ANSIBLE_D2C_NO_WARN'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> def v2_playbook_on_play_start(self, play): vm = play.get_variable_manager() extra_vars = vm.extra_vars enable_use_tags = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'enable_use_tags'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> extra_vars: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> extra_vars[<span class="hljs-string"><span class="hljs-string">'enable_use_tags'</span></span>]: enable_use_tags = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> play_vars = vm.get_vars(play._loader, play=play) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> enable_use_tags: tags = self.tmp_context.only_tags tags.clear() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'use_tags'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> play_vars: use_tags = play_vars[<span class="hljs-string"><span class="hljs-string">'use_tags'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(use_tags, (string_types, AnsibleUnicode)): use_tags = [t.strip() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> use_tags.split(<span class="hljs-string"><span class="hljs-string">','</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(use_tags, list): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> use_tags: tags.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(t) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: tags.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">'all'</span></span>) self._display.display(<span class="hljs-string"><span class="hljs-string">' [INFO]: "use_tags" variable is set, but unparsable (type "{}" is not a list or a string): {}'</span></span>.format(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>(use_tags),use_tags), color=<span class="hljs-string"><span class="hljs-string">'cyan'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: self._display.display(<span class="hljs-string"><span class="hljs-string">' [INFO]: "use_tags" variable is not set, but "enable_use_tags" is set'</span></span>, color=<span class="hljs-string"><span class="hljs-string">'cyan'</span></span>) tags.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">'all'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.warn: self._display.<span class="hljs-built_in"><span class="hljs-built_in">warning</span></span>(<span class="hljs-string"><span class="hljs-string">'Tags modified to: {}'</span></span>.format(<span class="hljs-type"><span class="hljs-type">json</span></span>.dumps(list(tags)))) def set_play_context(self, play_context): self.tmp_context = play_context</code> </pre> <br><p>  In our plugin, the main character is the <code>v2_playbook_on_play_start</code> method.  It is called after the initialization of the play (filling with variables, determining the list of hosts, etc.) and before starting the execution of the tasks themselves. </p><br><p>  We use the extra variable (extra var) <code>enable_use_tags</code> as a sign that we will use the modification of the tags ‚Äúon the fly‚Äù and the variable of the play level (play var) <code>use_tags</code> to generate a list of the necessary tags. </p><br><p>  Everything is good, but the tags, along with many other runtime information, are copied to the <code>PlayContext</code> object, the link to which is not in the <code>v2_playbook_on_play_start</code> method.  To combat this, we note that the queue manager in Ansible <a href="https://github.com/ansible/ansible/blob/64db935b25bbaad0fe290e3ef39f34e5a3ac5a9c/lib/ansible/executor/task_queue_manager.py">checks</a> for the presence of the <code>set_play_context</code> method in the connected plugins and, if it exists, calls it, passing this same context. </p><br><p>  Using the circumstances that <code>PlayContext</code> mutable and that Ansible only works with one play at a time, we implement the following algorithm in the plugin: </p><br><ul><li>  upon initial initialization of the plugin, <code>tmp_context</code> inside the plugin </li><li>  every time <code>set_play_context</code> call <code>set_play_context</code> remember the current context in <code>tmp_context</code> </li><li>  on a subsequent call to <code>v2_playbook_on_play_start</code> analyze the <code>enable_use_tags</code> and <code>use_tags</code> variables and change the original <code>PlayContext</code> object (more precisely, we get the ‚Äúlink‚Äù to the mutable list of tags via <code>self.tmp_context.only_tags</code> and modify the list) </li><li>  display appropriate warnings that the list of tags has been changed (so that there are no surprises for the user) </li></ul><br><p>  Now we can run this playbook: </p><br><p> <code>ansible-playbook -e enable_use_tags=1 make_mysql_slave.yml</code> </p> <br><pre> <code class="hljs sql">- hosts: master vars: use_tags: <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>-configs, <span class="hljs-keyword"><span class="hljs-keyword">replication</span></span>-init, <span class="hljs-keyword"><span class="hljs-keyword">replication</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">sync</span></span> <span class="hljs-keyword"><span class="hljs-keyword">roles</span></span>: - mysql - <span class="hljs-keyword"><span class="hljs-keyword">hosts</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">slave</span></span> vars: use_tags: <span class="hljs-keyword"><span class="hljs-keyword">build</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">replication</span></span>-init, <span class="hljs-keyword"><span class="hljs-keyword">replication</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">sync</span></span> <span class="hljs-keyword"><span class="hljs-keyword">roles</span></span>: - mysql - <span class="hljs-keyword"><span class="hljs-keyword">hosts</span></span>: all vars: use_tags: <span class="hljs-keyword"><span class="hljs-keyword">replication</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">sync</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">cleanup</span></span> <span class="hljs-keyword"><span class="hljs-keyword">roles</span></span>: - mysql</code> </pre> <br><p>  In this case, Ansible will use its own set of tags for each play.  This gives us the opportunity to compose orchestration of complex configurations with single playbooks. </p><br><h3 id="connection">  Connection </h3><br><p>  Connection plugins are used to connect to target hosts.  In short: the plugin should provide the ability to establish and terminate the connection, send a file, run a remote command.  Examples of plug-ins out of the box are: <code>local</code> , <code>ssh</code> (used by default), <code>winrm</code> , <code>docker</code> . </p><br><p>  If you have very special target hosts, for example, any proprietary virtualization system, then you will have to write your plugin from scratch.  But if you need to add a bit of functionality to the existing, you can inherit from the plug-in "out of the box" and override the necessary methods. </p><br><p>  Consider an example of an SSH connection using <a href="https://en.wikipedia.org/wiki/Port_knocking">port knoking</a> .  Basically, these ssh sessions are no different from normal ones, but before trying to connect to a remote machine, you need to ‚Äúknock‚Äù on certain ports in order for the server to open port 22 and accept an ssh connection. </p><br><p>  Let's finish the basic <code>ssh</code> plugin (put in ./connection_plugins/ssh_pkn.py): </p><br><pre> <code class="hljs python"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ansible.plugins.connection.ssh <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Connection <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ConnectionSSH <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ansible.errors <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> AnsibleError <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> socket <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> create_connection <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sleep <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> __main__ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> display <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ImportError: <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ansible.utils.display <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Display display = Display() <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Connection</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ConnectionSSH)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> super(Connection, self).__init__(*args, **kwargs) display.vvv(<span class="hljs-string"><span class="hljs-string">"SSH_PKN (Port KNock) connection plugin is used for this host"</span></span>, host=self.host) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_host_overrides</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, host, hostvars=None)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'knock_ports'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> hostvars: ports = hostvars[<span class="hljs-string"><span class="hljs-string">'knock_ports'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isinstance(ports, list): <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> AnsibleError(<span class="hljs-string"><span class="hljs-string">"knock_ports parameter for host '{}' must be list!"</span></span>.format(host)) delay = <span class="hljs-number"><span class="hljs-number">0.5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'knock_delay'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> hostvars: delay = hostvars[<span class="hljs-string"><span class="hljs-string">'knock_delay'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ports: display.vvv(<span class="hljs-string"><span class="hljs-string">"Knocking to port: {0}"</span></span>.format(p), host=self.host) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: create_connection((self.host, p), <span class="hljs-number"><span class="hljs-number">0.5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> display.vvv(<span class="hljs-string"><span class="hljs-string">"Waiting for {0} seconds after knock"</span></span>.format(delay), host=self.host) sleep(delay)</code> </pre> <br><p>  We use the <code>set_host_overrides</code> method, which allows plugins to change their behavior depending on host / group variables.  This method is called when creating a new connection when not using reuse.  In our case, it should not once again "knock" the ports. </p><br><p>  An example of an inventory file to use this plugin: </p><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">pkn</span></span>] myserver ansible_host=my.server.at.example.com [pkn:vars] ansible_connection=ssh_pkn knock_ports=[<span class="hljs-number"><span class="hljs-number">8000</span></span>,<span class="hljs-number"><span class="hljs-number">9000</span></span>] knock_delay=<span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br><p>  We have indicated that the connection plug-in <code>ssh_pkn</code> will be used for all the hosts in the <code>pkn</code> group.  When initializing our plugin inside the <code>set_host_overrides</code> method, the condition that the <code>knock_ports</code> variable is defined will work.  Then, for each of the ports in the list, an attempt will be made to connect at <code>knock_delay</code> intervals of 2 seconds.  We also intercept all exceptions from <code>create_connection</code> , since most likely the ports for ‚Äútapping‚Äù are closed and connection attempts will fail.  However, for us it is not particularly important - the server will see attempts in any case. </p><br><h3 id="strategy">  Strategy </h3><br><p>  Strategy-type plug-ins define the order in which tasks are launched and do a lot of engine work: including dynamically adding facts, monitoring the status of hosts (healty / failed / unreachable), and invoking callbacks.  I wrote about strategy out-of-box plugins in the <a href="https://habrahabr.ru/company/d2cio/blog/344046/">first part</a> . </p><br><p>  Such custom plugins are extremely rare.  In an unaccepted <a href="https://github.com/ansible/ansible/pull/18460">pull request</a> , <a href="https://github.com/ansible/ansible/pull/18460">18460</a> , for example, offered a plugin with the possibility of injecting tasks into an arbitrary place of a playbook, in order to increase the flexibility of distributed roles.  We will make a more landed strategy-plugin. </p><br><p>  Put in ./strategy_plugins/step_critical.py: </p><br><pre> <code class="hljs python"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ansible.plugins.strategy.linear <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> StrategyModule <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> LinearStrategyModule <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> __main__ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> display <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ImportError: <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ansible.utils.display <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Display display = Display() <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StrategyModule</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(LinearStrategyModule)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, tqm)</span></span></span><span class="hljs-function">:</span></span> super(StrategyModule, self).__init__(tqm) display.vv(<span class="hljs-string"><span class="hljs-string">'Safenet strategy: will give a prompt at critical tasks!'</span></span>) force_step = os.environ.get(<span class="hljs-string"><span class="hljs-string">'ANSIBLE_FORCE_STEP'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> force_step <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> force_step.lower() <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-string"><span class="hljs-string">'1'</span></span>,<span class="hljs-string"><span class="hljs-string">'y'</span></span>,<span class="hljs-string"><span class="hljs-string">'yes'</span></span>,<span class="hljs-string"><span class="hljs-string">'true'</span></span>,<span class="hljs-string"><span class="hljs-string">'on'</span></span>]: display.vv(<span class="hljs-string"><span class="hljs-string">'Safenet: "step" option is forced via environment!'</span></span>) self._step = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_take_step</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, task, host=None)</span></span></span><span class="hljs-function">:</span></span> v = task.get_vars() ret = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'is_critical'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> v: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> v[<span class="hljs-string"><span class="hljs-string">'is_critical'</span></span>]: display.vv(<span class="hljs-string"><span class="hljs-string">'Safenet: critical task detected!'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super(StrategyModule, self)._take_step(task, host) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret</code> </pre> <br><p>  This plugin changes the behavior of the <code>--step</code> parameter <code>--step</code> such a way that Ansible asks permission only for tasks that have the <code>is_critical</code> variable and its value <code>True</code> , and not for everyone, as it happens out of the box. </p><br><p>  We can also force the confirmation mode through the environment variable <code>ANSIBLE_FORCE_STEP</code> , and not only through the <code>--step</code> parameter.  Otherwise, this plugin inherits the behavior of a <code>linear</code> plugin. </p><br><p>  You can check the behavior of the plugin with the following playbook: </p><br><pre> <code class="hljs delphi">--- - hosts: localhost strategy: step_critical gather_facts: no tasks: - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Ensure user exists debug: msg: user_module - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Drop database debug: msg: db_module vars: is_critical: yes - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Ensure permissions debug: msg: permission_module</code> </pre> <br><hr><br><h3 id="itogo">  Total </h3><br><p>  In two articles on the expansion capabilities of Ansible, we looked at all types of plug-ins that are supported in Ansible 2.3.  And also I gave examples for most of them. </p><br><p>  If any questions about the plugins are not disclosed, write in the comments - I will try to answer. </p><br><p>  In the meantime, I'm starting to prepare an article about creating modules for Ansible.  Stay tuned! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/345216/">https://habr.com/ru/post/345216/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345206/index.html">We tried to hire these two for five years. And every minute of our waiting paid off.</a></li>
<li><a href="../345208/index.html">1Kb autocomplete</a></li>
<li><a href="../345210/index.html">Anonymous Father Frost 2017-2018: post boasting New Year's gifts</a></li>
<li><a href="../345212/index.html">Can you afford it? Real-world web performance budget</a></li>
<li><a href="../345214/index.html">How to quit graduate school and become a developer</a></li>
<li><a href="../345218/index.html">Not soon the fence is built, especially a beautiful data center. How we build the data center "Avantage". Part 2</a></li>
<li><a href="../345222/index.html">Deploying ElectrumX Server</a></li>
<li><a href="../345224/index.html">Live broadcast of the Waves Platform in Digital October</a></li>
<li><a href="../345226/index.html">10 RecSys materials on recommendation systems that everyone should read</a></li>
<li><a href="../345228/index.html">How we raiffeisen.ru redesigned</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>