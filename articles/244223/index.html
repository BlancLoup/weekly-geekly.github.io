<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Script on NodeJS for Backup data: Start</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have long been looking for a program to save my projects. In this case, the mandatory requirement was: 

 1. Save only changed files in the storage;...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Script on NodeJS for Backup data: Start</h1><div class="post__text post__text-html js-mediator-article">  I have long been looking for a program to save my projects.  In this case, the mandatory requirement was: <br><br>  1. Save only changed files in the storage; <br>  2. Pack the changed files; <br>  3. To be free. <br><br>  However, the search did not give anything.  Rather, the search gave, but usually one of the items was missing.  Therefore, I decided to write my own, and at the same time ‚Äúfeel live‚Äù NodeJS.  2 days wrote.  And even screwed encryption to the program.  That did not cause any special difficulties, since the encryption module is included in the standard delivery of the node.  At the same time, the packaging, encryption, and storage management modules are extensible  So that you can simply add new features, expanding the functionality.  In the current version, saving works only in the file system, without packaging, but with encryption. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      View help on the use <a href="http://shasoft.com/ShasoftNodeJSBackup/help.html">here</a> . <br><br>  This could be the end - it's done.  But there is one drawback - the program works SYNCHRONNO.  And although it works quite quickly (if you do not save gigabytes of information), but still the node is focused on ASYNCHRONOUS work.  So I looked at the <a href="http://learn.javascript.ru/nodejs-screencast">Screencast on Node.JS</a> and decided to do everything on the "right", taking into account the features of the node. <br><a name="habracut"></a><br>  Since I decided to write ‚Äúcorrectly‚Äù, I will start with a general scheme of work: <br><br><img src="https://habrastorage.org/files/ff4/382/082/ff4382082a4147beafd2ee5a35c649da.png" alt="image"><br><br>  The diagram clearly shows which operations can be performed in parallel, and which cannot. <br>  Let's start to implement the blocks.  Each block will be written in a separate file so that it is clearer and clearer. <br><br><h4>  1. Determine the list of files to save. </h4><br>  The task is simple - we have a directory at the entrance, we need to get the following properties for each element: size, checksum (we will use md5), date of change.  This we need to further determine the changed elements.  I write items, not files, not by chance.  We will determine these values ‚Äã‚Äãfor directories.  The directory size is the size of all nested items.  The directory checksum is the checksum of all checksums of the children.  Accordingly, in order to understand whether there have been changes in the directory or not, it will be enough just to compare the checksums of this directory in the storage and on the disk. <br><br><div class="spoiler">  <b class="spoiler_title">Synchronous implementation of this functionality</b> <div class="spoiler_text"><pre><code class="javascript hljs">(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    var fs = require('fs'); var path = require('path'); var crypto = require('crypto'); //    function _get_attributes(itemName,basePath) { //    //console.info(basePath,"\t\t\t",itemName); //   var retSize = 0; //       var retHash = crypto.createHash('md5'); //    .          var retInfo; //    var filepath = path.join(basePath,itemName); //    var stat = fs.statSync(filepath); //    if( stat.isDirectory() ) { //       retInfo = {}; //     var items = fs.readdirSync(filepath); var hashs = []; for(var i in items) { //     var attr = _get_attributes(items[i],filepath); //     retSize += attr[0]; //          hashs.push(attr[1]); //      retInfo[ items[i] ] = attr; } //    hashs.sort(); for(var j in hashs) { retHash.update(hashs[j]); } } else { //  retSize = stat.size; //     //      var buffer = new Buffer(64*1024); //      var fdr = fs.openSync(filepath, 'rs'); while(true) { //    var bytesRead = fs.readSync(fdr, buffer,0,buffer.length); if(bytesRead&gt;0) { //      retHash.update(buffer.slice(0,bytesRead)); } else { //     break; } } //   fs.closeSync(fdr); //    retInfo = stat.mtime.toISOString(); } //     //       base64      '='.        return [retSize,retHash.digest('base64').replace(/=/g,''),retInfo]; } //      module.exports = function(_basepath) { return _get_attributes('',_basepath); } })();</span></span></code> </pre> <br></div></div><div class="spoiler">  <b class="spoiler_title">Asynchronous implementation of this functionality.</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    var fs = require('fs'); var path = require('path'); var crypto = require('crypto'); var async = require('async'); //      .          var qHashFile = async.queue(function (args, cb) { //       var oHash = crypto.createHash('md5'); //      var rs = fs.createReadStream(args.filePath); //  -    ,    rs.on('error', args.callback); //        rs.on('data', function (data) { oHash.update(data); }); //          rs.on('end', function () { //     args.callback(null,oHash.digest('base64').replace(/=/g,'')); //    cb(); }); }, 16); //         //    function getAttrDir(dirPath,callback) { //console.log("getAttrDir",dirPath); //     fs.readdir(dirPath,function(err,items) { //  ,   if (err) return callback(err); //     var ret={ size : 0, //      items:{} //    }; var hashs=[]; //     async.each(items, function(itemName,cb){ //    getAttrItem(path.join(dirPath,itemName),function(err,attr){ //  ,   if (err) return callback(err); //    ret.size += attr.size; //     ret.items[itemName] = attr; //       hashs.push(attr.hash); //   cb(); }); }, function(err) { //  ,   if (err) return callback(err); //   ,     //           hashs.sort(); var oHash = crypto.createHash('md5'); hashs.forEach(function(hash) { oHash.update(hash); }); //    ret.hash = oHash.digest('base64').replace(/=/g,''); //   //console.log("getHashFile",dirPath,ret); callback(null,ret); }); }); } //    function getAttrItem(itemPath,callback) { //    fs.stat(itemPath, function(err,stat) { //  ,   if (err) return callback(err); //    if( stat.isDirectory() ) { //    getAttrDir(itemPath,callback); } else { //        qHashFile.push( { filePath : itemPath, callback : function(err,hash) { //   callback(err,{ size : stat.size, //   hash : hash, //    mtime : stat.mtime.toISOString() //     }); } }, function(err){ //  ,   if(err) return callback(err); }); } }); } //      module.exports = getAttrItem;</span></span></code> </pre> <br></div></div><br>  When measuring the speed of the asynchronous implementation always wins.  In order to speed up the work process, I did a checksum calculation by redirecting flows using the pipe () function.  The calculation was that then the reading of the file and the calculation will take place not in javascrip, but in the core of the node.  However, this step did not justify itself.  For some reason, a variant of the form: <br><br><pre> <code class="javascript hljs"> <span class="hljs-comment"><span class="hljs-comment">//       var oHash = crypto.createHash('md5'); //      var rs = fs.createReadStream(args.filePath); //  -    ,    rs.on('error', args.callback); //        rs.on('data', function (data) { oHash.update(data); }); //          rs.on('end', function () { //     args.callback(null,oHash.digest('base64').replace(/=/g,'')); //    cb(); });</span></span></code> </pre>  Always won the option: <br><pre> <code class="javascript hljs"> <span class="hljs-comment"><span class="hljs-comment">//       var oHash = crypto.createHash('md5'); oHash.setEncoding('base64'); //      var rs = fs.createReadStream(args.filePath); //          rs.on('end', function() { //     oHash.end(); //     args.callback(null,oHash.read().replace(/=/g,'')); //    cb(); }); //            rs.pipe(oHash);</span></span></code> </pre><br>  Although I was hoping for a different result.  I hope in the comments I will point out errors.  I also imposed a limit on the number of simultaneously processed files for checksum calculation.  Great value does not give a significant gain in speed, but at a certain threshold value (I had it = 2.5 thousand), the program fell with an error when creating a new stream to open a file: <br><pre> <code class="javascript hljs">events.js:<span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> er; <span class="hljs-comment"><span class="hljs-comment">// Unhandled 'error' event ^ Error: EMFILE, open '&lt;-  &gt;'</span></span></code> </pre> <br><br><h4>  2. Determine the files that have changed. </h4><br>  This block is fully implemented in javascript and we will not consider it in detail.  There is nothing difficult in comparing two objects with attributes of elements.  It is worth mentioning that it is enough for us to compare the old and new attributes of a directory in order to understand whether there are changes in it or not.  And do not forget that if the element is not in the old version, it means that it was added, which means it should be included in the list of changed elements. <br><br>  All sources mentioned in the article are <a href="">here</a> .  Also in the archive there is a test.js file for running time measurement tests (just do not forget to change the path to the one you have on the disk). <br><br>  In the next article we will look at block number 3. There we will use Transform streams for packing / unpacking and encrypting / decrypting data.  And also we will make an interface for working with different repositories of backups. <br><br><br>  psUpdated article.  The comments given in the comments were taken into account. <br><ul><li>  Removed shielding of js code, as indicated that it is already <a href="http://nodejs.org/api/modules.html">shielded</a> . </li><li>  Code rewritten using the library <a href="https://github.com/caolan/async">async</a> .  With it, the code became pleasing to the eye (although it could not overtake my initial version on the tests :)).  I used the <a href="https://github.com/caolan/async">async.each</a> method to work with the list of directory entries.  As well as the <a href="https://github.com/caolan/async">async.queue</a> method for calculating checksums of files. </li><li>  Added error handling when creating a stream for reading.  That allowed to make sure that the error occurs precisely because of the creation of a large number of these same stream for reading files. </li><li>  Now attributes are returned in the form of an object with talking names (size, hash, items, mdate), and not in the form of arrays with obscure indices. </li><li>  The code itself tried to make it more uniform. </li></ul><br><br>  <a href="">Link to all source codes</a> - these are all source codes mentioned (and not mentioned) in the following articles: <a href="http://habrahabr.ru/post/244223/">Script for NodeJS for Backup and data: Start</a> , <a href="http://habrahabr.ru/post/244435/">Script for NodeJS for Backup for data: End</a> . <br>  <a href="http://shasoft.com/ShasoftNodeJSBackup/help.html">Help on the manufacturer's website</a> <br>  <a href="">The link for downloading the program</a> is a link to the final program.  Unlike the source code, the data in this archive will change.  In particular, it is planned to add support for FTP and yandex-disk.  Currently, the work with the file system is supported as storage - i.e.  saving occurs in the specified folder. </div><p>Source: <a href="https://habr.com/ru/post/244223/">https://habr.com/ru/post/244223/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../244213/index.html">VoCore firmware update: UART</a></li>
<li><a href="../244215/index.html">How support for message formatting makes the messenger better</a></li>
<li><a href="../244217/index.html">How I drove Balda on Visual Basic for Applications for MS Access</a></li>
<li><a href="../244219/index.html">In one harness Polymers, Dart and Firebase</a></li>
<li><a href="../244221/index.html">Computer from little fairies</a></li>
<li><a href="../244225/index.html">My password rules</a></li>
<li><a href="../244227/index.html">Master Keith reanimates his blog about DIY electronics on Habr√©</a></li>
<li><a href="../244229/index.html">Routes on Google Maps in the Android application</a></li>
<li><a href="../244231/index.html">Runet Prize 2014</a></li>
<li><a href="../244233/index.html">Router management: small joys of technical support</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>