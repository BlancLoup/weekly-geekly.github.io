<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Downloading Phonebooks to Polycom IP Phones</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Our organization uses ip telephony based on Trixbox (essentially the same FreePBX with some differences), as well as telephone sets from Polycom. Ever...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Downloading Phonebooks to Polycom IP Phones</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/21c/241/83a/21c24183ab19fe3a843cc1ed42eab3fa.jpg"><br>  Our organization uses ip telephony based on Trixbox (essentially the same FreePBX with some differences), as well as telephone sets from Polycom.  Every day the company's staff grew and it became harder to remember a bunch of internal numbers of employees.  Some of the employees started manually entering the address book in the phone, but more than half of it spent tons of paper on a printout of the next changed directory, as well as more time searching for the necessary number.  It was necessary to do something with it. <br>  All phones get their configuration through the tftp server, and go there.  It was found that when downloading, the phone checks the presence of * macaddr * -directory.xml in the * tftpserver_dir * / polycom / contacts / directory, and loads it if it finds one.  We will use this. <br><a name="habracut"></a><br>  Form an action plan: <br><ol><li>  Formation of the xml file with contacts.  In order not to fence services, it is necessary to achieve the formation of bash scripts. </li><li>  You need to get information about existing phones from the asterisk CLI.  # Problem number 1. </li><li>  Download directories by rebooting phones 1 time per night. </li></ol><br><br><div class="spoiler">  <b class="spoiler_title">Problem number 1</b> <div class="spoiler_text">  By default, trixbox, when writing information to the asterisk config file, does not write the caller id anywhere, but stores it only in its mysql database.  Based on this, we see the following picture: <br><pre><code class="hljs pgsql">trixbox1*CLI&gt; sip <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> peer <span class="hljs-number"><span class="hljs-number">114</span></span> trixbox1*CLI&gt; * <span class="hljs-type"><span class="hljs-type">Name</span></span> : <span class="hljs-number"><span class="hljs-number">114</span></span> Secret : &lt;<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>&gt; MD5Secret : &lt;<span class="hljs-keyword"><span class="hljs-keyword">Not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>&gt; Context : <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>-<span class="hljs-type"><span class="hljs-type">internal</span></span> Subscr.Cont. : &lt;<span class="hljs-keyword"><span class="hljs-keyword">Not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">Language</span></span> : ru AMA flags : <span class="hljs-type"><span class="hljs-type">Unknown</span></span> Transfer mode: <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> CallingPres : Presentation Allowed, <span class="hljs-keyword"><span class="hljs-keyword">Not</span></span> Screened Callgroup : Pickupgroup : Mailbox : <span class="hljs-number"><span class="hljs-number">114</span></span>@device VM <span class="hljs-keyword"><span class="hljs-keyword">Extension</span></span> : *<span class="hljs-number"><span class="hljs-number">97</span></span> LastMsgsSent : <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Call</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> : <span class="hljs-number"><span class="hljs-number">50</span></span> Dynamic : Yes Callerid : "device" &lt;<span class="hljs-number"><span class="hljs-number">114</span></span>&gt; MaxCallBR : <span class="hljs-number"><span class="hljs-number">384</span></span> kbps Expire : <span class="hljs-number"><span class="hljs-number">1410</span></span> Insecure : <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> Nat : <span class="hljs-keyword"><span class="hljs-keyword">Always</span></span> ACL : Yes T38 pt UDPTL : <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> CanReinvite : <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> PromiscRedir : <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>=Phone : <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> Video Support: Yes Trust RPID : <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> Send RPID : <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> Subscriptions: Yes Overlap dial : Yes DTMFmode : rfc2833 LastMsg : <span class="hljs-number"><span class="hljs-number">0</span></span> ToHost : Addr-&gt;IP : <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.95</span></span> Port <span class="hljs-number"><span class="hljs-number">5060</span></span> Defaddr-&gt;IP : <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> Port <span class="hljs-number"><span class="hljs-number">5060</span></span> Def. Username: <span class="hljs-number"><span class="hljs-number">114</span></span> SIP <span class="hljs-keyword"><span class="hljs-keyword">Options</span></span> : (<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>) Codecs : <span class="hljs-number"><span class="hljs-number">0x28000c</span></span> (ulaw|alaw|h263|h264) Codec <span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> : (ulaw:<span class="hljs-number"><span class="hljs-number">20</span></span>,alaw:<span class="hljs-number"><span class="hljs-number">20</span></span>) Auto-Framing: <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> Status : OK (<span class="hljs-number"><span class="hljs-number">18</span></span> ms) Useragent : PolycomSoundPointIP-SPIP_321-UA/<span class="hljs-number"><span class="hljs-number">3.1</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.0507</span></span> Reg. Contact : sip:<span class="hljs-number"><span class="hljs-number">114</span></span>@<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.95</span></span></code> </pre> <br><br>  We are interested in the string Callerid: ‚Äúdevice‚Äù &lt;114&gt; Instead of the information about the CallerID (name) of the employee, we see the ill-fated ‚Äúdevice‚Äù. <br>  You can solve in two ways.  The first one is found in the MySQL database where it stores information on CallerID and, on the fly, when generating XML, receive data through queries.  Or the second less labor-intensive and less resource-intensive. <br>  Knowing that the trixbox entirely in php, we can try to find in the source code where the trixbox writes this ‚Äúdevice‚Äù.  Picked up a bit in / var / www / find the file /var/www/html/admin/modules/core/functions.inc.php with a very interesting comment from the developers. <br><pre> <code class="hljs perl">// Very bad $iaxfields[] = array($account,<span class="hljs-string"><span class="hljs-string">'account'</span></span>,$account); $iaxfields[] = array($account,<span class="hljs-string"><span class="hljs-string">'callerid'</span></span>,(isset($_REQUEST[<span class="hljs-string"><span class="hljs-string">'description'</span></span>]) &amp;&amp; $_REQUEST[<span class="hljs-string"><span class="hljs-string">'description'</span></span>] != <span class="hljs-string"><span class="hljs-string">''</span></span>)?$_REQUEST[<span class="hljs-string"><span class="hljs-string">'description'</span></span>].<span class="hljs-string"><span class="hljs-string">" &lt;"</span></span>.$account.<span class="hljs-string"><span class="hljs-string">'&gt;'</span></span>:<span class="hljs-string"><span class="hljs-string">'device'</span></span>.<span class="hljs-string"><span class="hljs-string">" &lt;"</span></span>.$account.<span class="hljs-string"><span class="hljs-string">'&gt;'</span></span>);</code> </pre> <br>  We will not think and look for where the developers take this description, when creating an extension, the required Display name field and just there we enter the full name of the employee, based on this we will correct a little file. <br>  Do not forget about the backup file that suddenly goes wrong or too much hooked, and yes you should not do it right away on the combat server. <br>  Change in line <br><pre> <code class="hljs perl">$_REQUEST[<span class="hljs-string"><span class="hljs-string">'description'</span></span>]</code> </pre> <br>  on <br><pre> <code class="hljs perl">$_REQUEST[<span class="hljs-string"><span class="hljs-string">'name'</span></span>]</code> </pre> <br>  we get: <br><pre> <code class="hljs php">$sipfields[] = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($account,<span class="hljs-string"><span class="hljs-string">'callerid'</span></span>,(<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_REQUEST[<span class="hljs-string"><span class="hljs-string">'name'</span></span>]) &amp;&amp; $_REQUEST[<span class="hljs-string"><span class="hljs-string">'name'</span></span>])?$_REQUEST[<span class="hljs-string"><span class="hljs-string">'name'</span></span>].<span class="hljs-string"><span class="hljs-string">" &lt;"</span></span>.$account.<span class="hljs-string"><span class="hljs-string">'&gt;'</span></span>:<span class="hljs-string"><span class="hljs-string">'device'</span></span>.<span class="hljs-string"><span class="hljs-string">" &lt;"</span></span>.$account.<span class="hljs-string"><span class="hljs-string">'&gt;'</span></span>);</code> </pre> <br>  Save, go to the web and resave the extension. <br>  We go to the asterisk CLI and look happy: <br><pre> <code class="hljs pgsql">trixbox1*CLI&gt; sip <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> peer <span class="hljs-number"><span class="hljs-number">114</span></span> trixbox1*CLI&gt; * <span class="hljs-type"><span class="hljs-type">Name</span></span> : <span class="hljs-number"><span class="hljs-number">114</span></span> Secret : &lt;<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>&gt; MD5Secret : &lt;<span class="hljs-keyword"><span class="hljs-keyword">Not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>&gt; Context : <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>-<span class="hljs-type"><span class="hljs-type">internal</span></span> Subscr.Cont. : &lt;<span class="hljs-keyword"><span class="hljs-keyword">Not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">Language</span></span> : ru AMA flags : <span class="hljs-type"><span class="hljs-type">Unknown</span></span> Transfer mode: <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> CallingPres : Presentation Allowed, <span class="hljs-keyword"><span class="hljs-keyword">Not</span></span> Screened Callgroup : Pickupgroup : Mailbox : <span class="hljs-number"><span class="hljs-number">114</span></span>@device VM <span class="hljs-keyword"><span class="hljs-keyword">Extension</span></span> : *<span class="hljs-number"><span class="hljs-number">97</span></span> LastMsgsSent : <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Call</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> : <span class="hljs-number"><span class="hljs-number">50</span></span> Dynamic : Yes Callerid : "Ivan Petrov" &lt;<span class="hljs-number"><span class="hljs-number">114</span></span>&gt; MaxCallBR : <span class="hljs-number"><span class="hljs-number">384</span></span> kbps Expire : <span class="hljs-number"><span class="hljs-number">1410</span></span> Insecure : <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> Nat : <span class="hljs-keyword"><span class="hljs-keyword">Always</span></span> ACL : Yes T38 pt UDPTL : <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> CanReinvite : <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> PromiscRedir : <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>=Phone : <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> Video Support: Yes Trust RPID : <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> Send RPID : <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> Subscriptions: Yes Overlap dial : Yes DTMFmode : rfc2833 LastMsg : <span class="hljs-number"><span class="hljs-number">0</span></span> ToHost : Addr-&gt;IP : <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.95</span></span> Port <span class="hljs-number"><span class="hljs-number">5060</span></span> Defaddr-&gt;IP : <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> Port <span class="hljs-number"><span class="hljs-number">5060</span></span> Def. Username: <span class="hljs-number"><span class="hljs-number">114</span></span> SIP <span class="hljs-keyword"><span class="hljs-keyword">Options</span></span> : (<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>) Codecs : <span class="hljs-number"><span class="hljs-number">0x28000c</span></span> (ulaw|alaw|h263|h264) Codec <span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> : (ulaw:<span class="hljs-number"><span class="hljs-number">20</span></span>,alaw:<span class="hljs-number"><span class="hljs-number">20</span></span>) Auto-Framing: <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> Status : OK (<span class="hljs-number"><span class="hljs-number">18</span></span> ms) Useragent : PolycomSoundPointIP-SPIP_321-UA/<span class="hljs-number"><span class="hljs-number">3.1</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.0507</span></span> Reg. Contact : sip:<span class="hljs-number"><span class="hljs-number">114</span></span>@<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.95</span></span></code> </pre><br>  The problem is solved, it remains only to go through all the extensions and re-save them so that the trixbox rewrote the config files with the correct caller id. <br></div></div><br>  We go further. <br>  Teach asterisk to remotely overload Polycom phones.  To do this, add the following lines to the /etc/asterisk/sip_notify.conf file: <br><pre> <code class="hljs sql">[polycom-<span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-cfg] <span class="hljs-keyword"><span class="hljs-keyword">Event</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">sync</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Content</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">Length</span></span>=&gt;<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  Restart asterisk. <br>  After that if in the asterisk CLI <br><pre> <code class="hljs pgsql">sip <span class="hljs-keyword"><span class="hljs-keyword">notify</span></span> polycom-<span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-cfg <span class="hljs-number"><span class="hljs-number">114</span></span></code> </pre> <br>  The Polycom telephone set on which extension 114 is registered will reboot. <br>  Next we get a list of registered phones, we need it to remotely reboot them. <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">asterisk</span></span> -rx <span class="hljs-string"><span class="hljs-string">'sip show peers'</span></span></code> </pre> <br>  we get <br><pre> <code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">354</span></span>/<span class="hljs-number"><span class="hljs-number">354</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.226</span></span> DNA <span class="hljs-number"><span class="hljs-number">5060</span></span> OK (<span class="hljs-number"><span class="hljs-number">19</span></span> ms) <span class="hljs-number"><span class="hljs-number">353</span></span>/<span class="hljs-number"><span class="hljs-number">353</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.108</span></span> DNA <span class="hljs-number"><span class="hljs-number">5060</span></span> OK (<span class="hljs-number"><span class="hljs-number">15</span></span> ms) <span class="hljs-number"><span class="hljs-number">352</span></span> (Unspecified) DNA <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">UNKNOWN</span></span> <span class="hljs-number"><span class="hljs-number">351</span></span> (Unspecified) DNA <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">UNKNOWN</span></span> <span class="hljs-number"><span class="hljs-number">342</span></span>/<span class="hljs-number"><span class="hljs-number">342</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.138</span></span> DNA <span class="hljs-number"><span class="hljs-number">5061</span></span> OK (<span class="hljs-number"><span class="hljs-number">7</span></span> ms) <span class="hljs-number"><span class="hljs-number">341</span></span>/<span class="hljs-number"><span class="hljs-number">341</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.138</span></span> DNA <span class="hljs-number"><span class="hljs-number">5060</span></span> OK (<span class="hljs-number"><span class="hljs-number">7</span></span> ms)</code> </pre> <br>  Using grep, we remove the excess (we are only interested in devices that are currently registered in the list with the ‚ÄúOK‚Äù status and only separate phone numbers) <br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">asterisk</span></span> -rx <span class="hljs-string"><span class="hljs-string">'sip show peers'</span></span> |grep OK |awk <span class="hljs-string"><span class="hljs-string">'{print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>|awk -F<span class="hljs-string"><span class="hljs-string">'/'</span></span> <span class="hljs-string"><span class="hljs-string">'{print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span></code> </pre> <br>  we get <br><pre> <code class="hljs">400 363 362 361 359 357 356 355 354 353 342</code> </pre><br>  Directing the result to a temporary file from there will be easier to read line by line. <br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">asterisk</span></span> -rx <span class="hljs-string"><span class="hljs-string">'sip show peers'</span></span> |grep OK |awk <span class="hljs-string"><span class="hljs-string">'{print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>|awk -F<span class="hljs-string"><span class="hljs-string">'/'</span></span> <span class="hljs-string"><span class="hljs-string">'{print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span> &gt; numbers.txt</code> </pre> <br>  In this list, we received those phones that need to be rebooted and a directory loaded into them. <br>  By the second run, we form the xml file itself (again excluding the unnecessary) and write to the file. <br><pre> <code class="hljs sql">asterisk -rx 'sip <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> peers<span class="hljs-string"><span class="hljs-string">' |egrep '</span></span>OK|<span class="hljs-literal"><span class="hljs-literal">UNKNOWN</span></span><span class="hljs-string"><span class="hljs-string">' |grep -v '</span></span>GSM<span class="hljs-string"><span class="hljs-string">' &gt; extensions.txt</span></span></code> </pre> <br>  Caller id is obtained as follows <br><pre> <code class="hljs perl">asterisk -rx <span class="hljs-string"><span class="hljs-string">'sip show peer 114'</span></span> |<span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> Callerid</code> </pre> <br>  Next, we need to read extensions.txt line by line to get the caller id and write to the file forming pieces xml on the fly. <br>  To begin with, let's create a reference 000000000000-directory.xml, it is loaded by phones by default only once when the phone is first loaded, then the file macaddress-directory.xml is created in the / tftpboot / polycom / contacts / folder, which will be constantly loaded later ( forget to replace the current ones after the formation of the reference file so that they are loaded into the phone).  Since this xml need headings and structure that the phone understands.  We collect: <br><pre> <code class="hljs xml">echo '<span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span></span>' &gt; 000000000000-directory.xml echo '<span class="hljs-comment"><span class="hljs-comment">&lt;!-- $RCSfile$ $Revision: 35928 $ --&gt;</span></span>' &gt;&gt; 000000000000-directory.xml echo '<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">directory</span></span></span><span class="hljs-tag">&gt;</span></span>' &gt;&gt; 000000000000-directory.xml echo ' <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">item_list</span></span></span><span class="hljs-tag">&gt;</span></span>' &gt;&gt; 000000000000-directory.xml</code> </pre> <br>  Note the last line with a tab, so that the file is beautiful when formed, and structured. <br>  Next reading loop extensions.txt <br><pre> <code class="hljs pgsql">cat extensions.txt | <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span></code> </pre> <br>  First we get rid of all the excess (faxes, free extensinons, spare numbers starting with 1000x, etc.) <br><pre> <code class="hljs perl">RES=$(asterisk -rx <span class="hljs-string"><span class="hljs-string">"sip show peer $line"</span></span> |<span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> Callerid |<span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> -v <span class="hljs-string"><span class="hljs-string">'Free'</span></span> |<span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> -v <span class="hljs-string"><span class="hljs-string">'free'</span></span> |<span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> -v <span class="hljs-string"><span class="hljs-string">'fax'</span></span> |<span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> -v <span class="hljs-string"><span class="hljs-string">'1000'</span></span> |<span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> -v <span class="hljs-string"><span class="hljs-string">'device'</span></span> |<span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> -v <span class="hljs-string"><span class="hljs-string">'FAX'</span></span> |<span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> -v <span class="hljs-string"><span class="hljs-string">'Test'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"$RES"</span></span> != <span class="hljs-string"><span class="hljs-string">""</span></span> ]; then</code> </pre> <br>  and here we are forming a beautiful piece of xml code <br><pre> <code class="hljs tex">asterisk -rx "sip show peer <span class="hljs-formula"><span class="hljs-formula">$line" |grep Callerid | awk -F': "' '{print $</span></span>2}' | awk -F'" &lt;' '{print <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>"<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">t</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">t</span></span></span></span>&lt;item&gt;<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">t</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">t</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">t</span></span></span></span>&lt;ln&gt;"<span class="hljs-formula"><span class="hljs-formula">$1"&lt;/ln&gt;</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">t</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">t</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">t</span></span></span></span></span><span class="hljs-formula">&lt;ct&gt;"$</span></span>2"&lt;/ct&gt;<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">t</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">t</span></span></span></span>&lt;/item&gt;"}' &gt;&gt; 000000000000-directory.xml</code> </pre> <br>  example <br><pre> <code class="hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">item</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ln</span></span></span><span class="hljs-tag">&gt;</span></span>Ivan Petrov<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ln</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ct</span></span></span><span class="hljs-tag">&gt;</span></span>114&gt;<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ct</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">item</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  well and we add structure xml <br><pre> <code class="hljs pgsql">echo <span class="hljs-string"><span class="hljs-string">' &lt;/item_list&gt;'</span></span> &gt;&gt; <span class="hljs-number"><span class="hljs-number">000000000000</span></span>-directory.xml echo <span class="hljs-string"><span class="hljs-string">'&lt;/directory&gt;'</span></span> &gt;&gt; <span class="hljs-number"><span class="hljs-number">000000000000</span></span>-directory.xml</code> </pre><br>  The complete code for generating the xml file: <br><pre> <code class="hljs perl">echo <span class="hljs-string"><span class="hljs-string">'&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;'</span></span> &gt; <span class="hljs-number"><span class="hljs-number">000000000000</span></span>-directory.xml echo <span class="hljs-string"><span class="hljs-string">'&lt;!-- $RCSfile$ $Revision: 35928 $ --&gt;'</span></span> &gt;&gt; <span class="hljs-number"><span class="hljs-number">000000000000</span></span>-directory.xml echo <span class="hljs-string"><span class="hljs-string">'&lt;directory&gt;'</span></span> &gt;&gt; <span class="hljs-number"><span class="hljs-number">000000000000</span></span>-directory.xml echo <span class="hljs-string"><span class="hljs-string">' &lt;item_list&gt;'</span></span> &gt;&gt; <span class="hljs-number"><span class="hljs-number">000000000000</span></span>-directory.xml cat extensions.txt | <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> RES=$(asterisk -rx <span class="hljs-string"><span class="hljs-string">"sip show peer $line"</span></span> |<span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> Callerid |<span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> -v <span class="hljs-string"><span class="hljs-string">'Free'</span></span> |<span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> -v <span class="hljs-string"><span class="hljs-string">'free'</span></span> |<span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> -v <span class="hljs-string"><span class="hljs-string">'fax'</span></span> |<span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> -v <span class="hljs-string"><span class="hljs-string">'1000'</span></span> |<span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> -v <span class="hljs-string"><span class="hljs-string">'device'</span></span> |<span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> -v <span class="hljs-string"><span class="hljs-string">'FAX'</span></span> |<span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> -v <span class="hljs-string"><span class="hljs-string">'Test'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"$RES"</span></span> != <span class="hljs-string"><span class="hljs-string">""</span></span> ]; then asterisk -rx <span class="hljs-string"><span class="hljs-string">"sip show peer $line"</span></span> |<span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> Callerid | awk -F<span class="hljs-string"><span class="hljs-string">': "'</span></span> <span class="hljs-string"><span class="hljs-string">'{print $2}'</span></span> | awk -F<span class="hljs-string"><span class="hljs-string">'" &lt;'</span></span> <span class="hljs-string"><span class="hljs-string">'{print \ "\t\t&lt;item&gt;\n\t\t\t&lt;ln&gt;"$1"&lt;/ln&gt;\n\t\t\t&lt;ct&gt;"$2"&lt;/ct&gt;\n\t\t&lt;/item&gt;"}'</span></span> &gt;&gt; <span class="hljs-number"><span class="hljs-number">000000000000</span></span>-directory.xml fi done echo <span class="hljs-string"><span class="hljs-string">' &lt;/item_list&gt;'</span></span> &gt;&gt; <span class="hljs-number"><span class="hljs-number">000000000000</span></span>-directory.xml echo <span class="hljs-string"><span class="hljs-string">'&lt;/directory&gt;'</span></span> &gt;&gt; <span class="hljs-number"><span class="hljs-number">000000000000</span></span>-directory.xml</code> </pre><br>  All Polycom devices have a mac-address starting at 00: 04: F, from here you can find all the phones on the network via arp <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">arp</span></span> -a |grep <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span>:F |awk <span class="hljs-string"><span class="hljs-string">'{print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$4</span></span></span><span class="hljs-string">}'</span></span> &gt; mac.txt</code> </pre><br>  cycle copy 000000000000-directory.xml to macaddress-directory.xml <br><pre> <code class="hljs pgsql">cat mac.txt |<span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> phonemac <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> MAC=${phonemac//:/}; #     ":"   cp /tftpboot/polycom/contacts/<span class="hljs-number"><span class="hljs-number">000000000000</span></span>-directory.xml /tftpboot/polycom/contacts/$MAC-directory.xml done</code> </pre><br>  Well, almost the finish line in a cycle from the numbers.txt file obtained at the beginning by rebooting the phones: <br><pre> <code class="hljs bash">cat numbers.txt |<span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> number <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> asterisk -rx <span class="hljs-string"><span class="hljs-string">"sip notify polycom-check-cfg </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$number</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br>  Full script code: <br><pre> <code class="hljs pgsql">#!/bin/sh asterisk -rx <span class="hljs-string"><span class="hljs-string">'sip show peers'</span></span> |grep OK |awk <span class="hljs-string"><span class="hljs-string">'{print $1}'</span></span>|awk -F<span class="hljs-string"><span class="hljs-string">'/'</span></span> <span class="hljs-string"><span class="hljs-string">'{print $1}'</span></span> &gt; numbers.txt asterisk -rx <span class="hljs-string"><span class="hljs-string">'sip show peers'</span></span> |egrep <span class="hljs-string"><span class="hljs-string">'OK|UNKNOWN'</span></span> |grep -v <span class="hljs-string"><span class="hljs-string">'GSM'</span></span> |awk <span class="hljs-string"><span class="hljs-string">'{print $1}'</span></span>|awk -F<span class="hljs-string"><span class="hljs-string">'/'</span></span> <span class="hljs-string"><span class="hljs-string">'{print $1}'</span></span> &gt; extensions.txt arp -a |grep <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span>:F |awk <span class="hljs-string"><span class="hljs-string">'{print $4}'</span></span> &gt; mac.txt echo <span class="hljs-string"><span class="hljs-string">'&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;'</span></span> &gt; <span class="hljs-number"><span class="hljs-number">000000000000</span></span>-directory.xml echo <span class="hljs-string"><span class="hljs-string">'&lt;!-- $RCSfile$ $Revision: 35928 $ --&gt;'</span></span> &gt;&gt; <span class="hljs-number"><span class="hljs-number">000000000000</span></span>-directory.xml echo <span class="hljs-string"><span class="hljs-string">'&lt;directory&gt;'</span></span> &gt;&gt; <span class="hljs-number"><span class="hljs-number">000000000000</span></span>-directory.xml echo <span class="hljs-string"><span class="hljs-string">' &lt;item_list&gt;'</span></span> &gt;&gt; <span class="hljs-number"><span class="hljs-number">000000000000</span></span>-directory.xml cat extensions.txt | <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> RES=$(asterisk -rx "sip show peer $line" |grep Callerid |grep -v <span class="hljs-string"><span class="hljs-string">'Free'</span></span> |grep -v <span class="hljs-string"><span class="hljs-string">'free'</span></span> |grep -v <span class="hljs-string"><span class="hljs-string">'fax'</span></span> |grep -v <span class="hljs-string"><span class="hljs-string">'1000'</span></span> |grep -v <span class="hljs-string"><span class="hljs-string">'device'</span></span> |grep -v <span class="hljs-string"><span class="hljs-string">'FAX'</span></span> |grep -v <span class="hljs-string"><span class="hljs-string">'Test'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ "$RES" != "" ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> asterisk -rx "sip show peer $line" |grep Callerid | awk -F<span class="hljs-string"><span class="hljs-string">': "'</span></span> <span class="hljs-string"><span class="hljs-string">'{print $2}'</span></span> | awk -F<span class="hljs-string"><span class="hljs-string">'" &lt;'</span></span> <span class="hljs-string"><span class="hljs-string">'{print "\t\t&lt;item&gt;\n\t\t\t&lt;ln&gt;"$1"&lt;/ln&gt;\n\t\t\t&lt;ct&gt;"$2"&lt;/ct&gt;\n\t\t&lt;/item&gt;"}'</span></span> &gt;&gt; <span class="hljs-number"><span class="hljs-number">000000000000</span></span>-directory.xml fi done echo <span class="hljs-string"><span class="hljs-string">' &lt;/item_list&gt;'</span></span> &gt;&gt; <span class="hljs-number"><span class="hljs-number">000000000000</span></span>-directory.xml echo <span class="hljs-string"><span class="hljs-string">'&lt;/directory&gt;'</span></span> &gt;&gt; <span class="hljs-number"><span class="hljs-number">000000000000</span></span>-directory.xml cp <span class="hljs-number"><span class="hljs-number">000000000000</span></span>-directory.xml /tftpboot/polycom/contacts/<span class="hljs-number"><span class="hljs-number">000000000000</span></span>-directory.xml cat mac.txt |<span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> phonemac <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> MAC=${phonemac//:/}; cp /tftpboot/polycom/contacts/<span class="hljs-number"><span class="hljs-number">000000000000</span></span>-directory.xml /tftpboot/polycom/contacts/$MAC-directory.xml done cat numbers.txt |<span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> number <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> asterisk -rx "sip notify polycom-check-cfg $number" done rm numbers.txt rm extensions.txt rm mac.txt rm <span class="hljs-number"><span class="hljs-number">000000000000</span></span>-directory.xml</code> </pre><br>  We save the script in the /etc/cron.daily folder and after that every night all changes will be uploaded to the phone directory of the desk phone with the ability to quickly search it.  Users are satisfied, paper in the office is not in vain translated. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/211606/">https://habr.com/ru/post/211606/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211582/index.html">Results of CES 2014: Samsung AV News</a></li>
<li><a href="../211584/index.html">Dr.Web for licensed content</a></li>
<li><a href="../211588/index.html">Live webcast ALM Summit</a></li>
<li><a href="../211590/index.html">Repeatable, another way to render lists</a></li>
<li><a href="../211594/index.html">Toothpick-detective reveals the secret of the radio protocol</a></li>
<li><a href="../211608/index.html">Work with usb video camera in Linux. Part 1</a></li>
<li><a href="../211610/index.html">Neural networks, "bad" tips</a></li>
<li><a href="../211612/index.html">‚ÄúFont-weight: bolder‚Äù for fonts with a variety of styles</a></li>
<li><a href="../211614/index.html">Games under threat</a></li>
<li><a href="../211618/index.html">Algorithm and tactics of finding words in the game Balda</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>