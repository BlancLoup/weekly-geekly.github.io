<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We do well with Swift 4, Perfect, Protobuf and MySQL on a Linux server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="You can look at three things for a long time: how water flows, how CoreFoundation is implemented in Linux Swift, and how Perfect documentation is not ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We do well with Swift 4, Perfect, Protobuf and MySQL on a Linux server</h1><div class="post__text post__text-html js-mediator-article"><p>  You can look at three things for a long time: how water flows, how <a href="https://github.com/apple/swift-corelibs-foundation">CoreFoundation is implemented</a> in Linux Swift, and how <a href="http://perfect.org/">Perfect</a> documentation is not updated. </p><br><p>  First, briefly for those who do not know: <strong>Perfect</strong> is one of the most stable Swift server frameworks.  ( <a href="https://medium.com/%40rymcol/updated-benchmarks-for-the-top-server-side-swift-frameworks-vs-node-js-9da4a0491eca">benchmark</a> ) </p><br><h3 id="zadacha">  Task: </h3><br><p>  Perfect Server on Linux with MySQL and Protocol Buffers to communicate with the client application </p><br><h3 id="vazhnoe-trebovanie">  Important requirement: </h3><br><p>  We are progressive hipsters with swifts (sarcasm), so give the latest version of <strong>Swift 4.0.2</strong> </p><a name="habracut"></a><br><h2 id="shag-0-ustanovka-instrumentariya">  Step 0. Installing the toolkit </h2><br><ol><li>  Install directly <strong>Swift 4.0.2</strong> ( <a href="https://swift.org/download/">described in detail here</a> ) </li><li>  It is assumed that you already have <strong>MySQL</strong> installed.  If not, there are a lot of tutorials (for example, for Ubuntu) </li><li>  Also, we need the <strong>Protocol Buffers</strong> compiler package (you can build from source, or you can) </li></ol><br><h2 id="shag-1-nastroyka-perfect">  Step 1. Set Up Perfect </h2><br><p>  Perfect has a great example of <em>PerfectTemplate</em> , which we will use.  However, in the official Pull Request repository with the updated syntax and Russian documentation in the approval process, so we will use my fork. </p><br><pre><code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/nickaroot/PerfectTemplate.git</code> </pre> <br><p>  We will not wait and immediately try to run it. </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> PerfectTemplate swift run</code> </pre> <br><p>  If everything went smoothly, then we will see a collector, and then </p><br><pre> <code class="bash hljs">[INFO] Starting HTTP server localhost on 0.0.0.0:8181</code> </pre> <br><h4 id="ura-server-dolzhen-otdat-nam-hello-world-po-http1270018181">  Hooray!  The server should give us "Hello, World!"  at <a href="http://127.0.0.1:8181/">http://127.0.0.1:8181</a> </h4><br><h2 id="shag-20-tablica-test-v-mysql">  Step 2.0 Table test in MySQL </h2><br><p><img src="https://nickaroot.me/habr_table_screen.png" alt="image"></p><br><h2 id="shag-21-podgotovka-mysql-modulya">  Step 2.1.  MySQL Module Preparation </h2><br><p>  Open the <strong>Package.swift</strong> and add the <em>PerfectMySQL</em> dependency so that it turns out </p><br><pre> <code class="hljs sql">// Dependencies <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> other packages that this <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> depends on. .package(<span class="hljs-keyword"><span class="hljs-keyword">url</span></span>: <span class="hljs-string"><span class="hljs-string">"https://github.com/PerfectlySoft/Perfect-HTTPServer.git"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>: <span class="hljs-string"><span class="hljs-string">"3.0.3"</span></span>), .package(<span class="hljs-keyword"><span class="hljs-keyword">url</span></span>: <span class="hljs-string"><span class="hljs-string">"https://github.com/PerfectlySoft/Perfect-MySQL"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>: <span class="hljs-string"><span class="hljs-string">"3.0.0"</span></span>),</code> </pre> <br><p>  And </p><br><pre> <code class="hljs objectivec">dependencies: [<span class="hljs-string"><span class="hljs-string">"PerfectHTTPServer"</span></span>, <span class="hljs-string"><span class="hljs-string">"PerfectMySQL"</span></span>],</code> </pre> <br><p>  Next, after all the <strong>import'ov</strong> add to <strong>main.swift</strong> </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PerfectMySQL</code> </pre> <br><p>  We declare variables for the connection with the base, not forgetting to substitute our values </p><br><pre> <code class="hljs bash"><span class="hljs-built_in"><span class="hljs-built_in">let</span></span> testHost = <span class="hljs-string"><span class="hljs-string">"example.com"</span></span> //   /  IP <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> testUser = <span class="hljs-string"><span class="hljs-string">"foo"</span></span> //   <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> testPassword = <span class="hljs-string"><span class="hljs-string">"bar"</span></span> //  <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> testDB = <span class="hljs-string"><span class="hljs-string">"swift_example_db"</span></span> //   </code> </pre> <br><h2 id="shag-22-obrabotka-zaprosa-i-poluchenie-dannyh-iz-bd">  Step 2.2.  Processing the request and receiving data from the database </h2><br><p>  Although this process is described in the documentation, the <em>PerfectMySQL</em> module has already gone far beyond the documentation, and it turned out to collect the code only after studying commits (it‚Äôs not necessary) </p><br><p>  Create a request handler fetchDataHandler (), to do this, after the handler () function, insert </p><br><pre> <code class="hljs swift"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchDataHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data: [String:</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">Any</span></span></span></span><span class="hljs-function"><span class="hljs-params">])</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">RequestHandler</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { request, response <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Request Handled!"</span></span>) response.completed() } }</code> </pre> <br><p>  In the configuration, add the event handler </p><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"method"</span></span></span><span class="hljs-meta">:</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"get"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"uri"</span></span></span><span class="hljs-meta">:</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/fetchDataHandler"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"handler"</span></span></span><span class="hljs-meta">:fetchDataHandler</span></span>],</code> </pre> <br><p>  before </p><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"method"</span></span></span><span class="hljs-meta">:</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"get"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"uri"</span></span></span><span class="hljs-meta">:</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"handler"</span></span></span><span class="hljs-meta">:handler</span></span>],</code> </pre> <br><p>  Connect to the database.  To do this, insert the code after <em>print ("Request Handled!")</em> </p><br><pre> <code class="hljs pgsql">let mysql = MySQL() // c  MySQL     let connected = mysql.<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>(host: testHost, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: testUser, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: testPassword) guard connected <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // ,    print(mysql.errorMessage()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } defer { mysql.<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>() //    ,            } //    guard mysql.selectDatabase(named: testDB) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">Log</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>(message: "Failure: \(mysql.errorCode()) \(mysql.errorMessage())") <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> }</code> </pre> <br><p>  Next, create a prepared request to the database and execute it. </p><br><pre> <code class="hljs bash"><span class="hljs-built_in"><span class="hljs-built_in">let</span></span> stmt = MySQLStmt(mysql) //   _ = stmt.prepare(statement: <span class="hljs-string"><span class="hljs-string">"SELECT * FROM test"</span></span>) //     <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> querySuccess = stmt.execute() //   // ,    guard querySuccess <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(mysql.errorMessage()) <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> }</code> </pre> <br><p>  Things are going well - it remains only to process the results </p><br><pre> <code class="hljs markdown">let results = stmt.results() let fieldNames = stmt.fieldNames() //     ,      var arrayResults: [<span class="hljs-string"><span class="hljs-string">[String:Any</span></span>]] = [<span class="hljs-string"></span><span class="hljs-string"></span>] //     <span class="hljs-emphasis"><span class="hljs-emphasis">_ = results.forEachRow { row in var rowDictionary = [String: Any]() var i = 0 //       while i != results.numFields { rowDictionary[fieldNames[i]!] = row[i] //        ["_</span></span>":""] i += 1 } arrayResults.append(rowDictionary) }</code> </pre> <br><p>  Now simply output the resulting data array. </p><br><pre> <code class="hljs xml">print(arrayResults) response.setHeader(.contentType, value: "text/html") response.appendBody(string: "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Testing...<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span>\(arrayResults)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span>")</code> </pre> <br><p>  Check handler </p><br><pre> <code class="bash hljs">swift run</code> </pre> <br><h4 id="esli-vse-skompilirovalos-bez-oshibok-i-zapustilos-togda-na-http1270018181fetchdata-my-uvidim-poluchennyy-iz-mysql-massiv">  If everything compiled without errors and started, then on <a href="http://127.0.0.1:8181/fetchData">http://127.0.0.1:8181/fetchData</a> we will see the array obtained from MySQL </h4><br><h2 id="shag-31-podgotovka-protocol-buffers">  Step 3.1.  Preparation Protocol Buffers </h2><br><p>  Create a file Person.proto with the help of an example </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">syntax</span></span> = <span class="hljs-string"><span class="hljs-string">"proto3"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Person { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> name = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> id = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> email = <span class="hljs-number"><span class="hljs-number">3</span></span>; }</code> </pre> <br><p>  Compile the swift file </p><br><pre> <code class="bash hljs">protoc --swift_out=. Person.proto</code> </pre> <br><p>  Open <strong>Package.swift</strong> and add the <em>SwiftProtobuf</em> dependency so that we can </p><br><pre> <code class="hljs sql">// Dependencies <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> other packages that this <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> depends on. .package(<span class="hljs-keyword"><span class="hljs-keyword">url</span></span>: <span class="hljs-string"><span class="hljs-string">"https://github.com/PerfectlySoft/Perfect-HTTPServer.git"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>: <span class="hljs-string"><span class="hljs-string">"3.0.3"</span></span>), .package(<span class="hljs-keyword"><span class="hljs-keyword">url</span></span>: <span class="hljs-string"><span class="hljs-string">"https://github.com/PerfectlySoft/Perfect-MySQL"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>: <span class="hljs-string"><span class="hljs-string">"3.0.0"</span></span>), .package(<span class="hljs-keyword"><span class="hljs-keyword">url</span></span>: <span class="hljs-string"><span class="hljs-string">"https://github.com/apple/swift-protobuf.git"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.1"</span></span>),</code> </pre> <br><p>  And </p><br><pre> <code class="hljs objectivec">dependencies: [<span class="hljs-string"><span class="hljs-string">"PerfectHTTPServer"</span></span>, <span class="hljs-string"><span class="hljs-string">"PerfectMySQL"</span></span>, <span class="hljs-string"><span class="hljs-string">"SwiftProtobuf"</span></span>],</code> </pre> <br><p>  Import the module into <strong>main.swift</strong> </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> SwiftProtobuf</code> </pre> <br><h2 id="shag-32-sozdanie-obrabotchika-dlya-priema-i-otpravki-protobuf">  Step 3.2.  Creating a handler for receiving and sending Protobuf </h2><br><p>  Immediately add two ways </p><br><pre> <code class="hljs ruby">[<span class="hljs-string"><span class="hljs-string">"method"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">"post"</span></span></span></span>, <span class="hljs-string"><span class="hljs-string">"uri"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">"/send"</span></span></span></span>, <span class="hljs-string"><span class="hljs-string">"handler"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:sendHandler</span></span>], [<span class="hljs-string"><span class="hljs-string">"method"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">"post"</span></span></span></span>, <span class="hljs-string"><span class="hljs-string">"uri"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">"/receive"</span></span></span></span>, <span class="hljs-string"><span class="hljs-string">"handler"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:receiveHandler</span></span>],</code> </pre> <br><p>  <em>SendHandler (data :)</em> method to send protobuf </p><br><pre> <code class="hljs lua">func sendHandler(data: [String:Any]) throws -&gt; RequestHandler { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { request, response <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> !request.postParams.isEmpty { var name: String? = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> var id: Int32? = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> var email: String? = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> param <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> request.postParams { //  POST-   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> param<span class="hljs-number"><span class="hljs-number">.0</span></span> == <span class="hljs-string"><span class="hljs-string">"name"</span></span> { name = param<span class="hljs-number"><span class="hljs-number">.1</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> param<span class="hljs-number"><span class="hljs-number">.0</span></span> == <span class="hljs-string"><span class="hljs-string">"id"</span></span> { id = Int32(param<span class="hljs-number"><span class="hljs-number">.1</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> param<span class="hljs-number"><span class="hljs-number">.0</span></span> == <span class="hljs-string"><span class="hljs-string">"email"</span></span> { email = param<span class="hljs-number"><span class="hljs-number">.1</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> let personName = name, let personId = id, let personEmail = email { var person = Person() person.name = personName person.id = personId person.email = personEmail <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { let data = try person.serializedData() //    Data <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Serialized Proto into Data"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Sending Proto‚Ä¶"</span></span>) ProtoSender().send(data) //    } catch { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Failed to Serialize Protobuf Object into Data"</span></span>) } } } response.setHeader(.contentType, value: <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>) response.appendBody(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>) response.completed() } }</code> </pre> <br><p>  The question arises: What is <em>ProtoSender</em> and where to get it <br>  Remember something important: As stated at the beginning, the Foundation is in the implementation stage, and you could gladly send all the data through the <em>URLSession</em> , but its <em>shared ()</em> method is <strong>not available</strong> ( <a href="">yet</a> ) on the Linux platform </p><br><h4 id="reshenie-est">  There is a solution </h4><br><p>  The solution is called cURL, and its wrapper is already implemented in <em>PerfectCURL</em> , which we will use </p><br><p>  Already familiarly open <strong>Package.swift</strong> and add the <em>PerfectCURL</em> dependency </p><br><pre> <code class="hljs sql">// Dependencies <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> other packages that this <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> depends on. .package(<span class="hljs-keyword"><span class="hljs-keyword">url</span></span>: <span class="hljs-string"><span class="hljs-string">"https://github.com/PerfectlySoft/Perfect-HTTPServer.git"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>: <span class="hljs-string"><span class="hljs-string">"3.0.3"</span></span>), .package(<span class="hljs-keyword"><span class="hljs-keyword">url</span></span>: <span class="hljs-string"><span class="hljs-string">"https://github.com/PerfectlySoft/Perfect-MySQL"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>: <span class="hljs-string"><span class="hljs-string">"3.0.0"</span></span>), .package(<span class="hljs-keyword"><span class="hljs-keyword">url</span></span>: <span class="hljs-string"><span class="hljs-string">"https://github.com/apple/swift-protobuf.git"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.1"</span></span>), .package(<span class="hljs-keyword"><span class="hljs-keyword">url</span></span>: <span class="hljs-string"><span class="hljs-string">"https://github.com/PerfectlySoft/Perfect-CURL.git"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>: <span class="hljs-string"><span class="hljs-string">"3.0.1"</span></span>),</code> </pre> <br><p>  And </p><br><pre> <code class="hljs objectivec">dependencies: [<span class="hljs-string"><span class="hljs-string">"PerfectHTTPServer"</span></span>, <span class="hljs-string"><span class="hljs-string">"PerfectMySQL"</span></span>, <span class="hljs-string"><span class="hljs-string">"SwiftProtobuf"</span></span>, <span class="hljs-string"><span class="hljs-string">"PerfectCURL"</span></span>],</code> </pre> <br><p>  Import the module into <strong>main.swift</strong> </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PerfectCURL</code> </pre> <br><p>  Add a <em>ProtoSender</em> structure </p><br><pre> <code class="hljs pgsql">struct ProtoSender { func send(_ data: Data) { let url = "http://localhost:8181/receive" //     <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { _ = try CURLRequest(url, .failOnError, .postData(<span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>(data))).<span class="hljs-keyword"><span class="hljs-keyword">perform</span></span>() // <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>(data) ..  [UInt8] } catch { print("Sending failed") } } }</code> </pre> <br><p>  You are almost at the very end of the article, it remains only to add </p><br><pre> <code class="hljs pgsql">func receiveHandler(data: [String:<span class="hljs-keyword"><span class="hljs-keyword">Any</span></span>]) throws -&gt; RequestHandler { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { request, response <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> print("Proto Received!") <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> let bytes = request.postBodyBytes { let data = Data(bytes: bytes) // Protobuf    ,   Data <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { let person = try Person(serializedData: data) //  Protobuf print("Proto was received and converted into a person with: \nname: \(person.name) \nid: \(person.id) \nemail: \(person.email)") let mysql = MySQL() //        let connected = mysql.<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>(host: testHost, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: testUser, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: testPassword) guard connected <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { print(mysql.errorMessage()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } defer { mysql.<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>() } guard mysql.selectDatabase(named: testDB) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">Log</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>(message: "Failure: \(mysql.errorCode()) \(mysql.errorMessage())") <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } let stmt = MySQLStmt(mysql) _ = stmt.<span class="hljs-keyword"><span class="hljs-keyword">prepare</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">statement</span></span>: "INSERT INTO test (id, name, email) VALUES (?, ?, ?)") //      stmt.bindParam(<span class="hljs-type"><span class="hljs-type">Int</span></span>(person.id)) //   ,   php stmt.bindParam(person.name) stmt.bindParam(person.email) let querySuccess = stmt.<span class="hljs-keyword"><span class="hljs-keyword">execute</span></span>() guard querySuccess <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { print(mysql.errorMessage()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } } catch { print("Failed to Decode Proto") } } response.setHeader(.contentType, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: "text/plain") response.appendBody(string: "1") response.completed() } }</code> </pre> <br><h4 id="proverim-rabotosposobnost">  Check performance </h4><br><pre> <code class="bash hljs">swift run</code> </pre> <br><p>  If everything started, we will open another terminal window and send a POST request. </p><br><pre> <code class="bash hljs">curl 127.0.0.1:8181/send --data <span class="hljs-string"><span class="hljs-string">"name=foobar&amp;id=8&amp;email=foobar@example.com"</span></span> -X POST</code> </pre> <br><p>  The first console window should display the data in the form </p><br><pre> <code class="bash hljs">Serialized Proto into Data Sending Proto‚Ä¶ Proto Received! Proto was received and converted into a person with: name: foobar id: 8 email: foobar@example.com</code> </pre> <br><p>  For additional verification, you can open 127.0.0.1/fetchData, but when sending data, do not forget that all id must be unique (id we pass as part of testing) </p><br><h4 id="teper-my-umeem-delat-swift-na-servere">  Now we can do Swift on the server </h4><br><p>  <a href=""><strong>Repository with a ready project</strong></a> </p><br><p>  Write wishes and criticism.  The material was created in order to introduce the technique, so during the article everything was in one file (see the finished project). </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/341980/">https://habr.com/ru/post/341980/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341970/index.html">Emercoin One Web Mesh - as safe as possible</a></li>
<li><a href="../341972/index.html">Dashboard - what it is and why it will be useful to you or a modern way to make the secret explicit</a></li>
<li><a href="../341974/index.html">Caesar3 all the same open</a></li>
<li><a href="../341976/index.html">Hackathon for all from GDG & WTM Moscow</a></li>
<li><a href="../341978/index.html">How to search for IT jobs in the EU</a></li>
<li><a href="../341982/index.html">Laboratory: welcome to C ++ User Group Meetup</a></li>
<li><a href="../341984/index.html">Olympiad tasks in industrial programming. Part 1</a></li>
<li><a href="../341986/index.html">Integrating the equations of motion</a></li>
<li><a href="../341988/index.html">Model-Update-View pattern and dependent types</a></li>
<li><a href="../341990/index.html">How Badoo is gaining developers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>