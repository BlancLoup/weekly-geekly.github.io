<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Part 2: MVVM: Complete Understanding (+ WPF)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, as an example, we will have a slightly more complicated program, namely, a vending machine, the implementation of which is often foun...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Part 2: MVVM: Complete Understanding (+ WPF)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/59/d7/bb/59d7bb46ad379168242665.jpeg" alt="image"><br><br>  In this article, as an example, we will have a slightly more complicated program, namely, a vending machine, the implementation of which is often found as a test task before the interview.  The interaction of several View with one VM and vice versa will be shown, the ‚ÄúView first‚Äù approach will be shown and not the final code will be shown, with a story which part is needed (download link, by the way, <a href="https://yadi.sk/d/F8XfnjR03NXuus">Vending Machine (program code)</a> , but the whole process of creating and, most importantly, a consistent train of thought. <br><br>  But before that, I will try once again to answer the question, which is usually not asked by people who have experience in debugging unstructured projects, namely: <b>‚ÄúSo why do we still need the MVVM pattern?‚Äù</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Formally and briefly, the MVVM pattern is used primarily to share responsibility, to increase readability, manageability, maintainability, and code testability.  A software product consists of a model (domain model and business logic) and an infrastructure code in a ratio of, say, 20% to 80%.  The infrastructure code should be simple, understandable, almost automatic, like Scaffolding.  But the model ... <br><a name="habracut"></a><br>  it's good to have it not evenly distributed across the infrastructure code, but grouped in one place.  Then it is readable - i.e.  one can see the business logic of the processes of the subject area, which is not spread over the event handlers of the heap of controls that are collecting dust in different places.  It is controlled - that is,  I can, for example, change the access modifier in one place - prevent client code from changing a certain factor in the entire program.  It is supported and expandable, i.e.  You can easily fix the program, according to the new requirements, and introduce new functionality.  And increased testability allows us to cover the model with unit and integration tests, so that when we introduce this new functionality, the old functionality will not fall off.  And if it fell off, we would have noticed it right away, and not at the customer‚Äôs acceptance.  People who have been debugging three thoughtful evenings for three days before the deadline do not ask the question about the benefits of all of the above. <br><br>  Specifically, MVVM, rather than, say, MVP or MVC, is used in WPF because MVVM is ‚Äúhardware‚Äù supported by WPF.  View understands and INotifyPropertyChange, and Observable, etc. - do not need to update anything by hand through the presenter, etc.  For example, WinForm's MVP required more infrastructure code, moreover a manual one, and there the advantages of sharing responsibility were overshadowed by a large amount of rough work. <br><br><h2>  Task </h2><br>  Let's return to the task.  She has the following wording: create a program that emulates the interaction of a person with a snack / drinks vending machine. <br><br>  The program interface should display: <br><br><ol><li>  The contents of the user's wallet (initially 10 bills / coins of the same value) and his purchases. </li><li>  Contents of the automatic deposit box (initially 100 bills / coins of the same value) </li><li>  List of products available for purchase in the machine (in the machine initially 100 units of each item) </li><li>  Current credit in the machine (how much money the user has invested there) </li></ol><br>  The program interface should allow: <br><br><ol><li>  Depositing funds by the user into the machine </li><li>  Making purchases of products in the machine </li><li>  Require and receive, sometimes, change </li></ol><br>  Plus will be: <br><br><ol><li>  The list of products with prices is not fixed in the code </li><li>  The values ‚Äã‚Äãof coins / bills are not fixed in the code </li><li>  Compliance with the MVVM formal pattern </li><li>  Setting minimum access to fields and properties of model classes </li><li>  Beautiful design! </li></ol><br>  We will hardly do the last, but everything else is completely. <br><br>  In the first part, we used the ‚ÄúModel first‚Äù technique: <br><br><ol><li>  Develop a program model. </li><li>  Draw the program interface. </li><li>  Connect interface and model with VM layer. </li></ol><br>  The peculiarity of this approach is that we must clearly present the model and its capabilities in advance.  What properties and methods it will provide to the outside, how its interaction with the interface will be arranged.  But at the first stage of development, we do not even know whether this or that interaction will be necessary.  We need additional points of support, in addition to the described behavior in TK.  Such points of support can provide us with an interface, i.e.  View and VM to it.  In VM, we could formulate client code, i.e.  that public access code (public) that we would like to see in the model.  Those.  The technique is as follows: <br><br>  Method "View first": <br><br><ol><li>  Draw the program interface - View </li><li>  Develop a VM to this View, and generate client code (model call code) </li><li>  Having a model interaction interface, implement its structure and internal logic </li></ol><br>  Sketches in the morning, model in the evening. <br><br>  In creating the user interface there is little MVVM-specific, but this point is not bypassed, so let's proceed to item # 1. <br><br><h2>  Interface creation </h2><br>  In TZ we read that we need to display the user's wallet and its purchases and the interface of the machine.  Let's physically divide the interface (i.e., according to different files) into two parts: one for the user, the other for the machine.  This is necessary so that the XAML files are smaller.  Working with large XAML files is (personally) uncomfortable.  Moreover, such a partition will not cost us anything, in WPF it is very easy to do: create a pair of UserControls - UserView.xaml and AutomatView.xaml, and use them in the main View - MainView.xaml.  And they (UserView.xaml and AutomatView.xaml) will use DataContext from the main form.  Those.  if they do not specify the DataContext, they seem to go up the logical tree and stumble upon the DataContext of the main form in which they are located, and use it. <br><br>  Let's start with UserView.xaml.  We need here to display the contents of the wallet and purchase.  Shopping is uniquely a ListBox.  Is a wallet just a number?  Amount of cash?  Not.  The TK says that the user has 10 bills of each denomination.  Those.  This is also a ListBox of different bills with an indication of the quantity.  Let's release it: <br><br>  UserView.xaml: <br><br><pre><code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- / --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ListBox</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ItemsSource</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding UserWallet}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ListBox.ItemTemplate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DataTemplate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Orientation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Horizontal"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Image</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"32"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"32"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Source</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding Icon}"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Image</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding Name}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding Amount}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DataTemplate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ListBox.ItemTemplate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ListBox</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  The listbox itself binds to the non-existent while UserWallet property (user‚Äôs wallet), and its Item also shows non-existent Name (‚Äú5 rubles‚Äù or ‚Äú2 rubles‚Äù, for example), Amount and Icon (banknote icon, if it is a banknote or coin, respectively ).  Icon - just a deliberately unsuccessful attempt to perform an additional paragraph 5 of the TK: "Beautiful design."  By the way, add this pair of pictures to the project in the ‚ÄúSolution folder‚Äù of the ‚ÄúImages‚Äù.  In the properties, specify Build action: resource.  "Coin.png" and "Banknote.png" respectively. <br><br>  Listbox with purchases will not be fundamentally different (unless we will not add icons) <br><br>  UserView.xaml: <br><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!----&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DockPanel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DockPanel.Dock</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Top"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" "</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ListBox</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ItemsSource</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding UserBuyings}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ListBox.ItemTemplate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DataTemplate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Orientation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Horizontal"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding Name}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">FontWeight</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DemiBold"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding Price}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding Amount}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DataTemplate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ListBox.ItemTemplate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ListBox</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DockPanel</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Let's frame this, as expected, in the two columns of the Grid and UserControl.  And add the amount of user's cash: <br><br>  UserView.xaml: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">UserControl</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid.ColumnDefinitions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ColumnDefinition</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ColumnDefinition</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid.ColumnDefinitions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!----&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DockPanel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DockPanel.Dock</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Top"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" "</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!----&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DockPanel.Dock</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Bottom"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Orientation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Horizontal"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" :"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding UserSumm}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- / --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ListBox</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DockPanel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!----&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DockPanel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Grid.Row</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Grid.Column</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">UserControl</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  So, the user is ready.  Now we will start implementation of the interface for the automatic machine.  According to the TK, it is necessary to show the depository and possible purchases -  as well as the user.  Therefore, let's try to cut these DataTemplates from UserView.xaml file for reuse.  These DataTemplates can be laid out in separate files and used as the Merged Resource Dictionary, but we simply put them in the resources in the main View. <br><br>  MainView.xaml: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Window</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Window.Resources</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--      /  --&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--     DataType (  ) --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DataTemplate</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DataType</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{x:Type local:ProductVM}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Orientation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Horizontal"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding Name}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">FontWeight</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DemiBold"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding Price}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding Amount}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DataTemplate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--      / --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DataTemplate</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DataType</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{x:Type local:MoneyVM}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Orientation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Horizontal"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Image</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"32"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"32"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Source</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding Icon}"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Image</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding Name}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding Amount}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DataTemplate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Window.Resources</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--    ( )  VM - MainViewVM.cs --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Window.DataContext</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">local:MainViewVM</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Window.DataContext</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--    ,   ,  -   ( ) --&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--   DataContext       DataContext   --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid.ColumnDefinitions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ColumnDefinition</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ColumnDefinition</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid.ColumnDefinitions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">local:UserView</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Margin</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"10"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">local:AutomatView</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Grid.Column</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Margin</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"10"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Window</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Pay attention to DataType in DataTemplates.  This is such a tricky thing in WPF that does the following: when an item of the specified type is assigned as the content of an item (in this case ListBoxItem), then this object becomes the DataContext of that item, and as Content is favored by this template.  ProductVM or MoneyVM are VMs for these templates that we have not yet created.  You can create all three VMs for now: <br><br>  MainViewVM.cs file: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MainViewVM</span></span> : <span class="hljs-title"><span class="hljs-title">BindableBase</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProductVM</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MoneyVM</span></span> { }</code> </pre><br>  Yes, connect Prism (6.3.0, the seven under Wpf is not working yet) and follow MainViewVM from BindableBase. <br><br>  Those.  again, what happens: ListBox as an ItemsSource uses a List for example.  For each item in this sheet, a ListBoxItem is created and its contents are assigned this object of type ProductVM.  WPF sees that it has a DataTemplate for the ProductVM type, and this DataTemplate assigns the contents for this ListBoxItem, and the ProductVM object itself is used as the DataContext and is bound to it by Binding.  If an array is used as an ItemsSource ListBox, where not only ProductVM but also MoneyVM are located (if both are inherited from a common base class, for example BindableBase), then DataTemplates will be applied to them different! <br><br>  It remains to implement AutomatView.xaml. <br><br>  AutomatView.xaml: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">UserControl</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid.ColumnDefinitions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ColumnDefinition</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ColumnDefinition</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid.ColumnDefinitions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!----&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DockPanel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Grid.Row</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Grid.Column</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DockPanel.Dock</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Top"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!----&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Orientation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Horizontal"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DockPanel.Dock</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Bottom"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">":"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding Credit}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!----&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ListBox</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ItemsSource</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding AutomataBank}"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DockPanel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DockPanel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Grid.Row</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Grid.Column</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DockPanel.Dock</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Top"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ListBox</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ItemsSource</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding ProductsInAutomata}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DockPanel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">UserControl</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  We read TK further: the program should allow ... to deposit money into the machine, make purchases and receive change. <br><br>  It is possible to attach a button next to each product in ListBox'e ‚ÄúAutomaton Products‚Äù, by clicking on which purchase will be made. <br><br>  Similarly, in the coin acceptor, in the ‚ÄúMoney Deposit‚Äù ListBox, you can attach a button to each bill / coin, according to which the user will deposit money into the machine. <br><br>  To prevent these buttons from being displayed in the user interface part, you need to set the necessary properties ‚ÄúShow ...‚Äù. <br><br>  And next to the text field denoting a loan, you can create a button ‚ÄúReturn the change‚Äù. <br><br>  Make the necessary changes: <br><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!--      /  --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DataTemplate</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DataType</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{x:Type local:ProductVM}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Orientation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Horizontal"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Visibility</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding IsBuyVisible}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Command</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding BuyCommand}"</span></span></span><span class="hljs-tag">&gt;</span></span>+<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-comment"><span class="hljs-comment">&lt;!--      / --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DataTemplate</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DataType</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{x:Type local:MoneyVM}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Orientation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Horizontal"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Visibility</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding IsInsertVisible}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Command</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding InsertCommand}"</span></span></span><span class="hljs-tag">&gt;</span></span>+<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-comment"><span class="hljs-comment">&lt;!----&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Orientation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Horizontal"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DockPanel.Dock</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Bottom"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Command</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding GetChange}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Margin</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag">&gt;</span></span> ...</code> </pre> <br>  All stage number 1 is generally over.  Moving on to create a VM. <br><br><h2>  Creating ViewModels </h2><br>  We have already created (create, if not already) the classes MainViewVM, ProductVM and MoneyVM. <br>  If you have ReSharper, and if you add the following line to UserView.xaml and AutomatView.xaml files in the top grid: <br><br> <code>&lt;Grid d:DataContext="{d:DesignInstance {x:Type local:MainViewVM}}"&gt;</code> <br> <br>  which will indicate to the WPF editor the DataContext type (but this will not affect runtime), then through Alt + Enter you can add the corresponding fields to the VM classes.  If you don‚Äôt have ReSharper, you can do it with your hands: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MainViewVM</span></span> : <span class="hljs-title"><span class="hljs-title">BindableBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> UserSumm { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ObservableCollection&lt;MoneyVM&gt; UserWallet { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ObservableCollection&lt;ProductVM&gt; UserBuyings { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DelegateCommand GetChange { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Credit { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ReadOnlyObservableCollection&lt;MoneyVM&gt; AutomataBank { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ReadOnlyObservableCollection&lt;ProductVM&gt; ProductsInAutomata { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProductVM</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Visibility IsBuyVisible { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DelegateCommand BuyCommand { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Price { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Amount { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MoneyVM</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Visibility IsInsertVisible { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DelegateCommand InsertCommand { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Icon { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Amount { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } }</code> </pre> <br>  You see, we almost created three VMs.  Now you can implement them sequentially, property by property.  We are free to write such client code that we would like it to be.  For example: UserSumm =&gt; _user.UserSumm;  Those.  implies that there is some _user object of the class of the User model, which has the UserSumm property.  Let's even create such a class.  We will now have a model, or rather, a point of contact between the model and VM, which will form some of the external boundaries of the model. <br>  Only now a small digression. <br><br>  The TOR states that we must provide "... the minimum necessary access to the fields and properties of the model classes" (from the client code).  Such a requirement should not only be in this TZ, but generally should occupy an honorable place in the principles of your software structure.  Client code should not accidentally (or deliberately) intrude into the model, forcing it to come to an unplanned state.  Especially since you are currently developing a code related to anonymous cash transactions.  Imagine that you will now make an error in the code, using which users across the country drink free coffee for 6 million rubles, and this loss will be imposed on you through the court, you will work forcibly on this software company and, until the end of their life, code on the Delphi + bundle 1C for cookies. <br><br>  In general, our model will consist of several classes.  And it is necessary to make so that from the one class 'A' of the model it was possible to call the method SomeMethod () of another class 'B' of the model, and from our client code this method B.SomeMethod () could not be called. <br><br>  In order to achieve this, you can of course make class B an internal class of class A, and implement an interface in it that is exposed to the outside ... But in general there is a specially designed solution for such purposes - the access modifier internal.  Those.  you just need to select the model in a separate project in the solution.  Thus, we will be able to use the internal modifier, physically separate our client code from the model code.  Now this separate model can be easily used, for example, in a web solution. <br><br>  Create a project class library, call it VendingMachine.Model, add the User model class there and create the UserSumm property for it <br><br>  In MainViewVM, we will declare a private user type _user variable and create it in the constructor: <br>  MainViewVM file: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MainViewVM</span></span> : <span class="hljs-title"><span class="hljs-title">BindableBase</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainViewVM</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> UserSumm =&gt; _user.UserSumm; <span class="hljs-comment"><span class="hljs-comment">//... private User _user; }</span></span></code> </pre> <br>  The next item we come across the money - UserWallet, which for us is a collection of MoneyVM.  We read the statement of work: "... The denominations of coins / bills are not fixed rigidly in the code." <br><br>  Those.  there is some set of denominations (ruble, two, five, ten) that comes from somewhere (from a database, from a configuration file, from a web service, etc.).  We need the user and the machine to have the same set of denominations, and so that it could not suddenly create some of its denomination (a coin of 8 rubles, for example).  If it is necessary to prohibit the creation, then a private constructor will work well.  If, however, a certain set of denominations is needed, then a factory method suitable for such a list of denominations will do.  Or, if multithreading is not planned (and it is not planned), you can use a static list.  Let's do it. <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//,   ,      ,     public struct Banknote { //,       public static readonly IReadOnlyList&lt;Banknote&gt; Banknotes = new[] { new Banknote("", 1, true), new Banknote(" ", 2, true), new Banknote(" ", 5, true), new Banknote(" ", 10, false), new Banknote(" ", 50, false), new Banknote(" ", 100, false), }; private Banknote(string name, int nominal, bool isCoin) { Name = name; Nominal = nominal; IsCoin = isCoin; } public string Name { get; } public int Nominal { get; } public bool IsCoin { get; } //  .    }</span></span></code> </pre><br>  Now the second.  We have a face value, but we have a UserWallet - this is such an array of pairs of face value / quantity.  Like stacks of casino chips: a stack of $ 1, a stack of chips of $ 250, etc.  We need just such a pile (Stack): <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MoneyStack</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MoneyStack</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Banknote banknote, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> amount</span></span></span><span class="hljs-function">)</span></span> { Banknote = banknote; Amount = amount; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Banknote Banknote { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Amount { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } }</code> </pre><br>  We could use structures like Dictionary, but the programmer's instinct tells us that we need functions like reduce, increase, etc.  Now we do not add them, because  no client code calling them.  While there is no such code, we do not add these functions.  This is like with events - we do not add events to the control we are developing (for example, double-click with the mouse) until there is a handler for it.  Otherwise, we can create dozens of events, of which we will need two or three.  The same with the class: we can create many different external functions, of which we will need only a couple, and even then not with that signature. <br><br>  Now, accordingly, update the User class and add the UserWallet there.  As it should be, the UserWallet will be a ReadOnlyObservableCollection and to ensure this collection will be another - a private collection.  In addition, the user is supposed to issue 10 bills of each value at initialization.  We do this in the user constructor. <br><br>  User.cs: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">User</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">User</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  _userWallet = new ObservableCollection&lt;MoneyStack&gt; (Banknote.Banknotes.Select(b =&gt; new MoneyStack(b, 10))); UserWallet = new ReadOnlyObservableCollection&lt;MoneyStack&gt;(_userWallet); } public ReadOnlyObservableCollection&lt;MoneyStack&gt; UserWallet { get; } private readonly ObservableCollection&lt;MoneyStack&gt; _userWallet; ... }</span></span></code> </pre><br>  Now update the MainViewVM constructor.  Since  in User, we have a collection of objects of the MoneyStack model class, and in MainViewVK a collection of VM classes, MoneyVM, then we need to do some transformations.  In MoneyVM, create a constructor that accepts MoneyStack. <br><br>  Then, first at initialization, and then when changing the collection, we have to add the appropriate VM (model changes are single, so the a.NewItems? ?Count == 1 construction works): <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainViewVM</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(); <span class="hljs-comment"><span class="hljs-comment">//    UserWallet = new ObservableCollection&lt;MoneyVM&gt;(_user.UserWallet.Select(ms =&gt; new MoneyVM(ms))); //        ((INotifyCollectionChanged) _user.UserWallet).CollectionChanged += (s, a) =&gt; { if(a.NewItems?.Count == 1) UserWallet.Add(new MoneyVM(a.NewItems[0] as MoneyStack)); if (a.OldItems?.Count == 1) UserWallet.Remove(UserWallet.First(mv =&gt; mv.MoneyStack == a.OldItems[0])); }; }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We make the corresponding changes in MoneyVM. </font><font style="vertical-align: inherit;">We accept MoneyStack as a parameter and assign it to the MoneyStack property for reading for easy retrieval. </font><font style="vertical-align: inherit;">The visibility of the button depends on the presence of the InsertCommand command. </font><font style="vertical-align: inherit;">We also return the image, quantity, name of the banknote:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MoneyVM</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MoneyStack MoneyStack { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MoneyVM</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MoneyStack moneyStack</span></span></span><span class="hljs-function">)</span></span> { MoneyStack = moneyStack; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Visibility IsInsertVisible =&gt; InsertCommand == <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? Visibility.Collapsed : Visibility.Visible; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DelegateCommand InsertCommand { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Icon =&gt; MoneyStack.Banknote.IsCoin ? <span class="hljs-string"><span class="hljs-string">"..\\Images\\coin.jpg"</span></span> : <span class="hljs-string"><span class="hljs-string">"..\\Images\\banknote.png"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name =&gt; MoneyStack.Banknote.Name; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Amount =&gt; MoneyStack.Amount; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We continue to implement MainViewVM. </font><font style="vertical-align: inherit;">Next in line is the ObservableCollection UserBuyings. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UserBuyings is implemented very similar to the previous construction. </font><font style="vertical-align: inherit;">We also create a class of the Product model with a closed constructor. </font><font style="vertical-align: inherit;">There we also create a collection of products available in the program (such as from a database). </font><font style="vertical-align: inherit;">In the same way we create ProductStack. </font><font style="vertical-align: inherit;">And in the same way we transform from ProductStack to ProductVM. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Product.cs:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Product</span></span> { <span class="hljs-comment"><span class="hljs-comment">//,    web service public static IReadOnlyList&lt;Product&gt; Products = new List&lt;Product&gt;() { new Product("",12), new Product(" ", 25), new Product("",6), new Product("",23), new Product("",19), new Product("",670), }; private Product(string name, int price) { Name = name; Price = price; } public string Name { get; } public int Price { get; } } ProductStack.cs: public class ProductStack { public ProductStack(Product product, int amount) { Product = product; Amount = amount; } public Product Product { get; } public int Amount { get; } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the User class, we create approximately the same ReadOnlyObservableCollection. </font><font style="vertical-align: inherit;">Is that the designer now does not supply the user with all the names of goods for 10 pieces, because </font><font style="vertical-align: inherit;">this is not specified in the statement of work:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">User</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">User</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ... <span class="hljs-comment"><span class="hljs-comment">//  UserBuyings = new ReadOnlyObservableCollection&lt;ProductStack&gt;(_userBuyings); } public ReadOnlyObservableCollection&lt;ProductStack&gt; UserBuyings { get; } private readonly ObservableCollection&lt;ProductStack&gt; _userBuyings = new ObservableCollection&lt;ProductStack&gt;(); ... }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Update ProductVM accordingly: </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProductVM</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ProductStack ProductStack { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProductVM</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ProductStack productStack</span></span></span><span class="hljs-function">)</span></span> { ProductStack = productStack; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Visibility IsBuyVisible =&gt; BuyCommand == <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? Visibility.Collapsed : Visibility.Visible; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DelegateCommand BuyCommand { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name =&gt; ProductStack.Product.Name; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Price =&gt; <span class="hljs-string"><span class="hljs-string">$"(</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{ProductStack.Product.Price}</span></span></span><span class="hljs-string"> .)"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Visibility IsAmountVisible =&gt; BuyCommand == <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? Visibility.Collapsed : Visibility.Visible; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Amount =&gt; ProductStack.Amount; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And finally, the constructor in MainViewVM: </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainViewVM</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ... <span class="hljs-comment"><span class="hljs-comment">//  UserBuyings = new ObservableCollection&lt;ProductVM&gt;(_user.UserBuyings.Select(ub =&gt; new ProductVM(ub))); ((INotifyCollectionChanged)_user.UserBuyings).CollectionChanged += (s, a) =&gt; { if (a.NewItems?.Count == 1) UserBuyings.Add(new ProductVM(a.NewItems[0] as ProductStack)); if (a.OldItems?.Count == 1) UserBuyings.Remove(UserBuyings.First(ub =&gt; ub.ProductStack == a.OldItems[0])); }; }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Synchronization of the model and VM of the user's purchases - and the models and VM of the user's wallet - are almost identical. </font><font style="vertical-align: inherit;">Moreover, the queues are the same synchronization in the case of money storage and goods inside the machine. </font><font style="vertical-align: inherit;">Therefore, to avoid duplication of the code, we will write the following synchronization function:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Watch&lt;T, T2&gt; (ReadOnlyObservableCollection&lt;T&gt; collToWatch, ObservableCollection&lt;T2&gt; collToUpdate, Func&lt;T2, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; modelProperty) { ((INotifyCollectionChanged)collToWatch).CollectionChanged += (s, a) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (a.NewItems?.Count == <span class="hljs-number"><span class="hljs-number">1</span></span>) collToUpdate.Add((T2)Activator.CreateInstance(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T2), (T) a.NewItems[<span class="hljs-number"><span class="hljs-number">0</span></span>])); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (a.OldItems?.Count == <span class="hljs-number"><span class="hljs-number">1</span></span>) collToUpdate.Remove(collToUpdate.First(mv =&gt; modelProperty(mv) == a.OldItems[<span class="hljs-number"><span class="hljs-number">0</span></span>])); }; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And we will use it in the constructor as follows: </font></font><br><br><pre> <code class="cs hljs">Watch(_user.UserWallet, UserWallet, um =&gt; um.MoneyStack); Watch(_user.UserBuyings, UserBuyings, ub =&gt; ub.ProductStack);</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The function uses templates, delegates and Activator, to create an instance of the specified type - i.e. </font><font style="vertical-align: inherit;">the function departs from ‚Äúsimplicity and planarity‚Äù, in which it is necessary to contain VM. </font><font style="vertical-align: inherit;">However, duplication of the code, in which so annoying typos are so often encountered (especially if it is necessary to make small but numerous changes to duplicate fragments), requires such a separation. </font><font style="vertical-align: inherit;">In this case, such a function should provide a clear comment.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next: in the MainViewVM class, which we consistently implement, the properties and commands related to the automaton are still unimplemented. </font><font style="vertical-align: inherit;">Let's implement them, the good thing is now going faster, because </font><font style="vertical-align: inherit;">for money and product models we have already created. </font><font style="vertical-align: inherit;">As in the case of the User class, we will create a class of the Automata model and in it the same two collections for products and money. </font><font style="vertical-align: inherit;">We also implement the Credit property in it.</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Automata</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Automata</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  _automataBank = new ObservableCollection&lt;MoneyStack&gt; (Banknote.Banknotes.Select(b =&gt; new MoneyStack(b, 100))); AutomataBank = new ReadOnlyObservableCollection&lt;MoneyStack&gt;(_automataBank); //  _productsInAutomata = new ObservableCollection&lt;ProductStack&gt;(Product.Products.Select(p =&gt; new ProductStack(p, 100))); ProductsInAutomata = new ReadOnlyObservableCollection&lt;ProductStack&gt;(_productsInAutomata); } public ReadOnlyObservableCollection&lt;MoneyStack&gt; AutomataBank { get; } private readonly ObservableCollection&lt;MoneyStack&gt; _automataBank; public ReadOnlyObservableCollection&lt;ProductStack&gt; ProductsInAutomata { get; } private readonly ObservableCollection&lt;ProductStack&gt; _productsInAutomata; public int Credit { get; } }</span></span></code> </pre> <br>    MainViewVM     Automata     : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MainViewVM</span></span> : <span class="hljs-title"><span class="hljs-title">BindableBase</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainViewVM</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ... _automata = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Automata(); <span class="hljs-comment"><span class="hljs-comment">//  AutomataBank = new ObservableCollection&lt;MoneyVM&gt;(_automata.AutomataBank.Select(a =&gt; new MoneyVM(a))); Watch(_automata.AutomataBank, AutomataBank, a =&gt; a.MoneyStack); //  ProductsInAutomata = new ObservableCollection&lt;ProductVM&gt;(_automata.ProductsInAutomata.Select(ap =&gt; new ProductVM(ap))); Watch(_automata.ProductsInAutomata, ProductsInAutomata, p =&gt; p.ProductStack); } ... private Automata _automata; }</span></span></code> </pre> <br><h2>   </h2><br>          ,    . <br><br>  ,         .             MVVM.       ,  VM     .     VM  ,        .   (View first)      ,  ,        ,  ,  . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now, in order to continue development, we need to combine the user and the machine within one entity. This association is usually dictated by this preliminary sketch. We, in our case, simply create a hard connection of one arbitrary user and one automaton within a class object, for example, PurchaseManager. Accordingly, we will address our, not yet implemented, requests for the behavior of the model to the object of this particular class. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why can't we stay within the User and Automata classes? In principle, of course, possible. See: we need the opportunity to take a certain amount of money from the user and deposit this amount of money into the machine. We cannot perform such an operation in the VM, since this is valid only in the model.</font></font> Those.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This operation must be performed by either the User class or the Automata class. According to the principle of separation of Single responsibility, this responsibility should be assigned to the third class, carrying out their interaction. Therefore, we will create a class PurchaseManager and edit our MainViewVM.cs to use this class, instead of creating User and Automat ourselves.</font></font><br><br><pre> <code class="cs hljs">PurchaseManager.cs: <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PurchaseManager</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> User User { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Automata Automata { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Automata(); } MainView.cs: <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MainViewVM</span></span> : <span class="hljs-title"><span class="hljs-title">BindableBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PurchaseManager _manager; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainViewVM</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _manager = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PurchaseManager(); _user = _manager.User; _automata = _manager.Automata; ... } ... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now, we deposit money by clicking on the button and then invoking the DelegateCommand InsertCommand view of the MoneyVM view model. There are different ways to forward such communication between the VM and the model. You can pass DelegateCommand in the VM constructor. It is possible to transfer the entire model (PurchaseManager), this is generally the most universal way and we can do it quite safely, the device of the model, thanks to encapsulation, it allows us quite well. Let's make the appropriate edits: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MoneyVM Constructor:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MoneyVM</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MoneyStack moneyStack, PurchaseManager manager = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { MoneyStack = moneyStack; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (manager != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-comment"><span class="hljs-comment">//  Null,   ,    DelegateCommand InsertCommand = new DelegateCommand(()=&gt;{ manager.InsertMoney(MoneyStack.Banknote); }); }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accordingly, we change the call of the Watch function to transfer the model in the constructor of the MainViewVM class. </font><font style="vertical-align: inherit;">But only for the user, for the machine, this is not necessary. </font><font style="vertical-align: inherit;">(Although nothing terrible will happen, there will even be an unplanned opportunity to make money on both the right and left sides of the interface). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now you need to implement the InsertMoney function. </font><font style="vertical-align: inherit;">It must extract a certain banknote from the user, and, if successful, enter it into the machine. </font><font style="vertical-align: inherit;">The function of extracting banknotes from the user should be accessible from the model, but not available from the client code - the already mentioned internal access modifier will help us with this. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PurchaseManager.cs:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InsertMoney</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Banknote banknote</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (User.GetBanknote(banknote)) <span class="hljs-comment"><span class="hljs-comment">//     , Automata.InsertBanknote(banknote); //     }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> User.cs: </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//  MoneyStack  ,       / // false    internal bool GetBanknote(Banknote banknote) { if(_userWallet.FirstOrDefault(ms =&gt; ms.Banknote.Equals(banknote))?.PullOne() ?? false) { RaisePropertyChanged(nameof(UserSumm)); //   ! return true; } return false; } //   public int UserSumm { get { return _userWallet.Select(b =&gt; b.Banknote.Nominal * b.Amount).Sum(); } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MoneyStack.cs: </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PullOne</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Amount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { --Amount; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Automata.cs: </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//       internal void InsertBanknote(Banknote banknote) { _automataBank.First(ms =&gt; ms.Banknote.Equals(banknote)).PushOne(); Credit += banknote.Nominal; } // private int credit; public int Credit { get { return credit; } set { SetProperty(ref credit, value); }}</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and again MoneyStack.cs: </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PushOne</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; ++Amount;</code> </pre> <br><br>    INotifyPropertyChanged   View. <br><br>  MoneyStack   BindableBase  Amount  : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MoneyStack</span></span> : <span class="hljs-title"><span class="hljs-title">BindableBase</span></span> { ... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _amount; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Amount { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _amount; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { SetProperty(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _amount, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } } }</code> </pre><br>  MoneyVM    BindableBase     ‚Äî  MoneyVM: <br><br><pre> <code class="cs hljs">... moneyStack.PropertyChanged += (s, a) =&gt; { RaisePropertyChanged(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(Amount)); };</code> </pre><br>         UserSumm  Credit   MainViewVM: <br><br> <code>_user.PropertyChanged += (s, a) =&gt; { RaisePropertyChanged(nameof(UserSumm)); }; <br> _automata.PropertyChanged += (s, a) =&gt; { RaisePropertyChanged(nameof(Credit)); }; <br></code> <br>          /- !      .   - .        ,    .    ProductVM         . <br><br>  ProductVM: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProductVM</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ProductStack productStack, PurchaseManager manager = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { ProductStack = productStack; productStack.PropertyChanged += (s, a) =&gt; { RaisePropertyChanged(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(Amount)); }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (manager != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) BuyCommand = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DelegateCommand(() =&gt; { manager.BuyProduct(ProductStack.Product); }); }</code> </pre> <br> PurchaseManager.cs: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuyProduct</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Product product</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Automata.BuyProduct(product)) User.AddProduct(product); }</code> </pre> <br> Automata.cs: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuyProduct</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Product product</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Credit &gt;= product.Price &amp;&amp; _productsInAutomata.First(p=&gt;p.Product.Equals(product)).PullOne()) { Credit -= product.Price; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre> <br> User.cs: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddProduct</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Product product</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stack = _userBuyings.FirstOrDefault(b =&gt; b.Product == product); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stack == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) _userBuyings.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductStack(product, <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> stack.PushOne(); }</code> </pre><br> ProductStack.cs: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Amount { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _amount; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { SetProperty(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _amount, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PullOne</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Amount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { --Amount; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PushOne</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; ++Amount;</code> </pre> <br> INotifyPropertyChanged  View   ProductVM: <br><br><pre> <code class="cs hljs">... productStack.PropertyChanged += (s, a) =&gt; { RaisePropertyChanged(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(Amount)); };</code> </pre> <br><h2>   ‚Äî   </h2><br>    ‚Äî  ,        ,    ‚Äî    ( ,   )   . <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PurchaseManager</span></span> { ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetChange</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { IEnumerable&lt;MoneyStack&gt; change; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Automata.GetChange(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> change)) User.AppendMoney(change); } } <span class="hljs-comment"><span class="hljs-comment">// Automata internal bool GetChange(out IEnumerable&lt;MoneyStack&gt; change) { change = new List&lt;MoneyStack&gt;(); if (Credit == 0) return false; var creditToReturn = Credit; var toReturn = new List&lt;MoneyStack&gt;(); foreach (var ms in _automataBank.OrderByDescending(m =&gt; m.Banknote.Nominal)) { if (creditToReturn &gt;= ms.Banknote.Nominal) { toReturn.Add(new MoneyStack(ms.Banknote, creditToReturn / ms.Banknote.Nominal)); creditToReturn -= (creditToReturn / ms.Banknote.Nominal) * ms.Banknote.Nominal; } } if (creditToReturn != 0) return false; //  ,    foreach (var ms in toReturn) // for (int i = 0; i &lt; ms.Amount; ++i) //    _automataBank.First(m =&gt; Equals(m.Banknote, ms.Banknote)).PullOne(); change = toReturn; Credit = 0; return true; } // User internal void AppendMoney(IEnumerable&lt;MoneyStack&gt; change) { foreach (var ms in change) for(int i=0; i&lt;ms.Amount;++i) UserWallet.First(m =&gt; Equals(m.Banknote.Nominal, ms.Banknote.Nominal)).PushOne(); RaisePropertyChanged(nameof(UserSumm)); }</span></span></code> </pre> <br>  Everything.     : <a href="https://yadi.sk/d/F8XfnjR03NXuus">Vending Machine ( )</a> </div><p>Source: <a href="https://habr.com/ru/post/339538/">https://habr.com/ru/post/339538/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../339526/index.html">Money pumping machine: miner Monero</a></li>
<li><a href="../339528/index.html">How to become a programmer</a></li>
<li><a href="../339532/index.html">Multimodal Emotion Recognition Challenge by Neurodata Lab</a></li>
<li><a href="../339534/index.html">Classic 2D quest or how our two years of development went. Part of the final</a></li>
<li><a href="../339536/index.html">Security Week 40: Yahoo, do not leak, Google is caulking holes, as Netgear bugs catches</a></li>
<li><a href="../339544/index.html">ruby -e for easy console operation</a></li>
<li><a href="../339546/index.html">Program copy counter or usage statistics collection</a></li>
<li><a href="../339548/index.html">Will high-frequency trading disappear?</a></li>
<li><a href="../339550/index.html">Uneducated youth. Life in the outback</a></li>
<li><a href="../339552/index.html">Lower bones? Easy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>