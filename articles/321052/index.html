<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>BLE under the microscope. Part 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="BLE under the microscope. Part 3 
 In the first and second parts, we reviewed the principles of building BLE networks, as well as touched upon the nec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>BLE under the microscope. Part 3</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/408/ea7/79a/408ea779ab2a443c93e61c1166a27615.png" alt="image"><br><br><h2>  BLE under the microscope.  Part 3 </h2><br>  In the <a href="https://habrahabr.ru/post/319244/">first</a> and <a href="https://habrahabr.ru/post/319388/">second</a> parts, we reviewed the principles of building BLE networks, as well as touched upon the necessary tools for working with them.  In the third part we will deal with the practical application of the knowledge gained.  For these purposes, we consider <a href="https://drive.google.com/open%3Fid%3D0B8HkwIH0fZkJaFJKeEdVVTZBWXc">this project</a> on the nRF51822 chip from <a href="http://www.nordicsemi.com/eng/Products/Bluetooth-low-energy/nRF51822">Nordic</a> . <br><a name="habracut"></a><br>  The project implements the transfer of data on advertising channels without using a stack. <br>  In order to run the project, you need the nrf51822 chip on any KIT, the J-LINK programmer, as well as the installed SDK.  We unpack the project and place it in the SDK directory, in the folder where the peripherals are located.  This is necessary in order not to rewrite the paths to the libraries.  Received data can be viewed using the nRF Connect program. <br><br><img src="https://habrastorage.org/files/a06/8a1/45c/a068a145cd204bf686d535f363b43118.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Today we will look at how a packet is formed for transmission over BLE channels.  The most interesting thing for us is in the ble_radio.c file.  I borrowed the function radio_init () in the sniffer program from Nordic-a.  This is the most crucial part.  Without the correct initialization of the radio channel, we will not see any parcels at all.  Every 100 ms the program sends three frames on the air on advertising channels.  How parcels are formed, we now consider. <br><br>  The parcel starts with a header.  Depending on the ble_adv_conn flag, our device will be seen as being attached (ADV_IND) or not being connected (ADV_NONCONN_IND).  The difference between them was given in the <a href="https://habrahabr.ru/post/319244/">first</a> part.  Here I just want to note that in both cases the randon MAC address flag has already been set.  If we want to get a public MAC address, then the header byte will be 0x00 and 0x02, respectively.  The following is a byte of the length of the entire packet and a service zero byte.  I did not understand why it is needed.  It is not put on the air, but if it is not there, we will get a byte shift in the package. <br><br>  This is followed by six bytes of the MAC address and a block of flags.  Here you need to specify the general format of the data to be filled.  First comes the length byte (LEN), then the content identifier (TYPE), and then the data itself (VALUE).  The flag block is the first block of data that we can see in the nRF Connect program. <br><br><img src="https://habrastorage.org/files/d57/393/cc2/d57393cc2da74260b84336fec8625a3c.png" alt="image"><br><br>  Next, the device name is recorded.  In this case, after the length byte, the identifier is 0x08.  It means that this is an abbreviated device name.  If you make the identifier equal to 0x09, the name will be seen as full.  For us, it does not matter, because  we work without a stack and work out all the requests ourselves.  In the case of working with the stack, to the request of the phone with the full name, it will be displayed in the response package.  Behind the name is a block of factory data and a checksum.  It should be noted that the factory data identifier is byte 0xFF, followed by 2 bytes of the manufacturer ID and the data itself.  This is the field in which we can transmit any of our data. <br><br><img src="https://habrastorage.org/files/0d8/089/25c/0d808925c2f44a4ea004cd9ed37ce562.png" alt="image"><br><br>  Similarly, sending a BLE may contain other data, such as a device UUID or device power (TYPE = 0x0A).  View all IDs <a href="https://www.bluetooth.com/specifications/assigned-numbers/generic-access-profile">here</a> .  But what this package looks like in Wireshark.  We see that this program provides significantly more information for the developer than nRF Connect. <br><br><img src="https://habrastorage.org/files/7d9/3b6/e10/7d93b6e10c9c43d59c0534632fb2940d.png" alt="image"><br><br>  However, this is not all.  If we form a package in the format of a beacon (ADV_NONCONN_IND), then it will be received on the phone by a special program.  In order for the phone to see the device in the ADV_IND format, it is necessary to correctly process the SCAN_REQ request.  As mentioned in the <a href="https://habrahabr.ru/post/319388/">second</a> part for this we must promptly set the answer SCAN_RSP.  We can see these packages only with the help of a sniffer.  They look like this. <br><br><img src="https://habrastorage.org/files/db8/aac/991/db8aac9919a24d85abed588b36bcd245.png" alt="image"><br><br>  In this case, there is nothing interesting in them.  The first (SCAN_REQ), besides the header, contains the MAC addresses of the phone itself and our device.  The second (SCAN_RSP) - only the header and MAC address of the gadget.  However, the parcel may contain data.  As mentioned earlier, this allows you to transfer more information to the phone.  In this case, the principle of filling the parcel is similar to what we considered above.  The third part devoted to the study of BLE packages has been completed. <br><br>  Pecherskikh Vladimir <br><br>  PS If you look closely at the CheckData () function, you can see that it has two parts.  It handles both the SCAN_REQ requests (header 0x03) and CONNECT_REQ (header 0x05). This makes it possible not only to receive data on the phone, but also to send one command to the gadget.  In this case, the device beeps and blinks the LED.  Unfortunately, the team will be only one and will be executed when you try to join the device.  Thus, we can, for example, enable / disable a light bulb without installing any applications on your smartphone.  This can be done directly from the menu ‚ÄúSettings-&gt; Bluetooth‚Äù of the phone. </div><p>Source: <a href="https://habr.com/ru/post/321052/">https://habr.com/ru/post/321052/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321038/index.html">The history of the creation of the first game on Unity - from idea to release</a></li>
<li><a href="../321040/index.html">Russian 4Gap: distribution of 4G networks in Russia and in the world</a></li>
<li><a href="../321044/index.html">How I parsed docx using XSLT</a></li>
<li><a href="../321048/index.html">Analysis and translation of the alien language using the Wolfram Language</a></li>
<li><a href="../321050/index.html">The hunt for the mythical MVC. Review, return to the original sources and how to analyze and display patterns yourself</a></li>
<li><a href="../321054/index.html">How to get a discount from 20 to 60% for posting vacancies and free access to the resume database on My Circle</a></li>
<li><a href="../321056/index.html">First steps with STM32 and mikroC compiler for ARM architecture - Part 3 - UART and GSM module</a></li>
<li><a href="../321058/index.html">Welcome to Game Design meetup February 4</a></li>
<li><a href="../321060/index.html">Bypass restrictions in Calabash-Android with UIAutomator</a></li>
<li><a href="../321062/index.html">Using GlusterFS with Docker swarm cluster</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>