<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Web scraper development to extract data from the open data portal of Russia data.gov.ru</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sometimes it is necessary to obtain data from web pages and save it in a structured form. 

 Web scraping tools ( web scraping ) are developed to extr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Web scraper development to extract data from the open data portal of Russia data.gov.ru</h1><div class="post__text post__text-html js-mediator-article">  Sometimes it is necessary to obtain data from web pages and save it in a structured form. <br><br>  Web scraping tools ( <a href="https://en.wikipedia.org/wiki/Web_scraping">web scraping</a> ) are developed to extract data from websites.  These tools are useful to those who are trying to get data from the Internet.  Web scraping is a technology that allows you to get data without having to open many pages and do copy-paste.  These tools allow you to manually or automatically retrieve new or updated data and save it for later use.  For example, using web scraping tools you can extract information about products and prices from online stores. <br><a name="habracut"></a><br>  Possible scenarios for using web scraping tools: <br><br><ul><li>  Data collection for marketing research </li><li>  Retrieve contact information (email addresses, phone numbers, etc.) from different sites to create your own lists of suppliers, manufacturers, or any other persons of interest. </li><li>  Downloading solutions from StackOverflow (or other similar sites with questions and answers) to enable offline reading or storing data from various sites - thereby reducing dependence on Internet access. </li><li>  Job search or job openings. </li><li>  Tracking the prices of goods in various stores. </li></ul><br>  There are a large number of tools that allow you to extract data from websites without writing a single line of ‚Äú <a href="http://www.hongkiat.com/blog/web-scraping-tools/">10 Web Scraping Tools to Extract Online Data</a> ‚Äù code.  Tools can be standalone applications, web sites or browser plugins.  Before you write your own web scraper, it is worth exploring existing tools.  At a minimum, this is useful from the point of view that many of them have very good video tutorials explaining how it all works. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Web scraper can be written in Python ( <a href="https://habrahabr.ru/post/280238/">Web Scraping using python</a> ) or R ( <a href="https://habrahabr.ru/post/315870/">More examples of using R to solve practical business problems</a> ). <br><br>  I will write in C # (although, I believe that the approach used will not depend on the development language).  I will try to pay special attention to those annoying mistakes that I made by believing that everything will work easily and simply. <br><br>  Why I did it and how I used it, you can read here: <br><br><ul><li>  <a href="https://geektimes.ru/sandbox/4830/">Downloading data from open data.gov.ru</a> </li><li>  <a href="https://geektimes.ru/post/285576/">Analyzing data sets from open data portal data.gov.ru</a> </li><li>  <a href="https://geektimes.ru/post/285824/">Using data sets from the open data portal of Russia data.gov.ru</a> </li></ul><br><div class="spoiler">  <b class="spoiler_title">And briefly</b> <div class="spoiler_text">  I was interested in how useful the open data from data.gov.ru can be, and the existing api and links on the portal itself did not allow downloading the actual data. <br></div></div><br>  So, I want to extract information about the data sets from the open data portal of Russia data.gov.ru and save for further processing as a simple text file in the csv format.  Data sets are displayed page by page in the form of a list, each element of which contains brief information about the data set. <br><br><img src="https://habrastorage.org/files/8dd/172/6a4/8dd1726a49654ec2acbeee017a2a9278.PNG"><br><br>  To get more information, you must click on the link. <br><br><img src="https://habrastorage.org/files/841/6b3/409/8416b34093cf48d7bacbb92a006595d2.PNG"><br><br>  Thus, in order to get information about data sets, I need to: <br><br><ol><li>  Go through all pages containing data sets. </li><li>  Extract brief information about the dataset and link to the page with complete information. </li><li>  Open each page with complete information. </li><li>  Extract full information from the page. </li></ol><br>  What I will not do is to load the page myself using HttpClient or WebRequest, self-parse the page. <br><br>  I will use the <a href="https://bitbucket.org/rflechner/scrapysharp/wiki/Home">ScrapySharp</a> framework.  ScrapySharp has a built-in web client that can emulate a real web browser.  Also, ScrapySharp allows you to easily parse Html using CSS selectors and Linq.  The framework is an add-on over the <a href="http://htmlagilitypack.codeplex.com/">HtmlAgilityPack</a> .  Alternatively, consider, for example, <a href="https://github.com/AngleSharp/AngleSharp">AngleSharp</a> . <br><br>  To start using ScrapySharp, just add the corresponding <a href="https://www.nuget.org/packages/ScrapySharp">nuget package</a> . <br><br>  Now you can use the built-in web browser to load the page: <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// - ScrapingBrowser browser = new ScrapingBrowser(); // - WebPage page = browser.NavigateToPage(new Uri("http://data.gov.ru/opendata/"));</span></span></code> </pre> <br>  Page returned as an object of type WebPage.  The page is represented as a set of nodes of the HtmlNode type.  Using the InnerHtml property, you can view the Html code of the element, and using the InnerText, you can get the text inside the element. <br><br>  Actually, in order to extract the necessary information, I need to find the necessary element of the page and extract the text from it. <br><br>  Question: how to view the page code and find the item you want? <br><br>  You can simply see the page code in the browser.  You can, as recommended in some articles, use a tool like <a href="http://www.telerik.com/fiddler">Fiddler</a> . <br><br><img src="https://habrastorage.org/files/3ee/363/540/3ee363540f064867982d49c08f3c92ca.png"><br><br>  But it seemed to me more convenient to use the Developer Tools in Google Chrome. <br><br><img src="https://habrastorage.org/files/6f5/2d6/fd6/6f52d6fd6c914481b94d891ec984f007.png"><br><br>  For the convenience of analyzing the page code, I installed the XPath Helper extension for Chrome.  Almost immediately it is clear that all the elements of the list contain the same CSS class .node-dataset.  To verify this, you can use one of the console functions to search for CSS style. <br><br><img src="https://habrastorage.org/files/87b/fa6/6f2/87bfa66f2f734b01b6c5c45a5b393cd3.PNG"><br><br>  The specified style is found on the page 30 times and exactly corresponds to the element of the list containing brief information about the data set. <br><br>  I get all the list items containing .node-dataset using ScrapySharp. <br><br><pre> <code class="cpp hljs">var Table1 = page.Html.CssSelect(<span class="hljs-string"><span class="hljs-string">".node-dataset"</span></span>)</code> </pre> <br>  and extract all the div elements that contain the text. <br><br><pre> <code class="cpp hljs">var divs = item.SelectNodes(<span class="hljs-string"><span class="hljs-string">"div"</span></span>)</code> </pre> <br>  In fact, there are many options for extracting the necessary data.  And I acted on the principle ‚Äúif something works, then don't touch it.‚Äù <br><br>  For example, a link to extended information can be obtained from the about attribute <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dc:hasPart"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">about</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/opendata/1435111685-maininfo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">typeof</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sioc:Item foaf:Document dcat:Dataset"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ds-1col node node-dataset node-teaser gosudarstvo view-mode-teaser clearfix"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">property</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dc:title"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"       ()     ()"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  In ScrapySharp this can be done as follows: <br><br><pre> <code class="cpp hljs">String link = item.Attributes[<span class="hljs-string"><span class="hljs-string">"about"</span></span>]?.Value</code> </pre> <br>  Actually, this is all that is needed to extract information about a data set from the list. <br><br>  It would seem that all is well, but it is not. <br><br>  <b>Error number 1.</b>  I believe that the data is always the same and there can be no errors in them (I already wrote here about the quality of the loaded data here <a href="https://geektimes.ru/post/285576/">Analysis of data sets from the open data portal data.gov.ru</a> ). <br><br>  For example, the text ‚ÄúRecommended‚Äù is present for some data sets.  I do not need this information.  I had to add a check: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (innerText != <span class="hljs-string"><span class="hljs-string">""</span></span>) { items.Add(innerText); }</code> </pre> <br>  I save the received information in the usual lists: <br><br><pre> <code class="cpp hljs">List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; items = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;()</code> </pre> <br>  because there are errors in the data.  If I create a typed structure, I will immediately have to handle these errors.  I did it easier - I saved the data in a csv file.  What will happen to them next, I do not really care now. <br><br>  To go through all the pages, I did not reinvent the wheel.  Just look at the link structure: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"item-list"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pager"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pager-first first"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"  "</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/opendata?query="</span></span></span><span class="hljs-tag">&gt;</span></span>¬´ <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pager-previous"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"  "</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/opendata?query=&amp;page=32"</span></span></span><span class="hljs-tag">&gt;</span></span>‚Äπ <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pager-item"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"   30"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/opendata?query=&amp;page=29"</span></span></span><span class="hljs-tag">&gt;</span></span>30<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pager-item"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"   31"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/opendata?query=&amp;page=30"</span></span></span><span class="hljs-tag">&gt;</span></span>31<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pager-item"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"   37"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/opendata?query=&amp;page=36"</span></span></span><span class="hljs-tag">&gt;</span></span>37<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pager-item"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"   38"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/opendata?query=&amp;page=37"</span></span></span><span class="hljs-tag">&gt;</span></span>38<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pager-next"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"  "</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/opendata?query=&amp;page=34"</span></span></span><span class="hljs-tag">&gt;</span></span> ‚Ä∫<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pager-last last"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"  "</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/opendata?query=&amp;page=423"</span></span></span><span class="hljs-tag">&gt;</span></span> ¬ª<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  To go to the desired page, you can use a direct link: <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">http</span></span>://<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">.gov.ru/opendata?query=&amp;page={0}</span></span></code> </pre> <br>  Of course, it was possible to search for a link to the next page, but, then how will I request pages in parallel?  All I need is to determine how many pages there are. <br><br><pre> <code class="cpp hljs">WebPage page = _Browser.NavigateToPage(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(<span class="hljs-string"><span class="hljs-string">"http://data.gov.ru/opendata"</span></span>)); var lastPageLink = page.Html.SelectSingleNode(<span class="hljs-string"><span class="hljs-string">"//li[@class='pager-last last']/a"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastPageLink != null) { <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> href = lastPageLink.Attributes[<span class="hljs-string"><span class="hljs-string">"href"</span></span>].Value; ‚Ä¶</code> </pre> <br>  I use a simple <a href="https://www.w3schools.com/xml/xpath_intro.asp">XPath</a> query to get the required item. <br><br>  I previously checked it in the Chrome developer tools console. <br><br><img src="https://habrastorage.org/files/f4d/a72/621/f4da72621e9748a2ac3cb8f0afe87278.PNG"><br><br>  I can go through all the pages and extract brief information about the data sets and get links to full information pages (data sheet). <br><br>  <b>Error number 2.</b>  The server always returns the desired page. <br><br>  It would be naive to believe that everything will work as intended.  Internet connection may be lost, the last page can be deleted (I had it that way), the server may decide that this is a DDOS attack.  Yes, at some point the server stopped responding to me - too many requests. <br><br>  To defeat the mistake, I used the following strategy: <br><br><ol><li>  If the server did not return the page, repeat n times (not endlessly, the page may no longer exist). </li><li>  If the server did not return the page, do not request it immediately, but make a timeout of k milliseconds.  And with the next error for the same page, increase it. </li><li>  Request not all pages at once, but with a slight delay. </li></ol><br>  And the only way I could really get all the pages. <br><br>  Getting a passport dataset turned out to be a simple task.  All information lay in the table.  And I just had to extract the text from the desired column. <br><br><pre> <code class="cpp hljs">List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; passport = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;(); var table = page.Html.CssSelect(<span class="hljs-string"><span class="hljs-string">".sticky-enabled"</span></span>).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (table != null) { foreach (var row in table.SelectNodes(<span class="hljs-string"><span class="hljs-string">"tbody/tr"</span></span>)) { foreach (var cell in row.SelectNodes(<span class="hljs-string"><span class="hljs-string">"td[2]"</span></span>)) { passport.Add(cell.InnerText); } } }</code> </pre><br>  Each data set has an estimate, which is determined by the vote of the portal users.  The score is not in the table, but in a separate p tag. <br><br>  To extract the score, you need to find the p tag with the class .vote-current-score. <br><br><pre> <code class="cpp hljs">var score = PageResult.Html.SelectSingleNode(<span class="hljs-string"><span class="hljs-string">"//p[@class='vote-current-score']"</span></span>);</code> </pre> <br>  Problem solved.  Data retrieved.  You can save them to a text file. <br><br>  To fully test the resulting web-scraper, I wrapped it in a simple REST service, within which I run the <a href="https://habrahabr.ru/post/321502/">background download process</a> . <br><br><img src="https://habrastorage.org/files/9fc/f2b/393/9fcf2b393f004d5c86676358b61e18c1.PNG"><br><br>  And placed it in Azure. <br><br>  So that it was convenient to control the process, added a simple interface. <br><br><img src="https://habrastorage.org/files/dac/98b/4cb/dac98b4cb1a843d5b3e8b523e44748dc.PNG"><br><br>  The service retrieves data and saves as files.  In addition, the service compares the extracted data with the previous version and stores information about the number of added, deleted, modified data sets. <br><br>  <b>findings</b> <br><br>  Creating a web scraper is not an overly complex task. <br><br>  To create a web scraper, it‚Äôs enough to understand what Html is, how CSS and XPath are used. <br><br>  There are ready-made frameworks that greatly simplify the task, allowing you to concentrate directly on extracting data. <br><br>  Google Chrome‚Äôs developer tools are enough to figure out what to get and how. <br><br>  There are many options for how to extract data, and all of them are correct if the result is achieved. </div><p>Source: <a href="https://habr.com/ru/post/323202/">https://habr.com/ru/post/323202/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../323188/index.html">Programmers can not write algorithms without help: once again about the interview</a></li>
<li><a href="../323192/index.html">Z-order vs R-tree, optimization and 3D</a></li>
<li><a href="../323194/index.html">What are the authors of ‚ÄúHello World?‚Äù Silent</a></li>
<li><a href="../323198/index.html">Dagaz: From simple to complex</a></li>
<li><a href="../323200/index.html">Power BI Embedded, IoT and machine learning for processing brain thermograms</a></li>
<li><a href="../323204/index.html">Apache Ant - quick start</a></li>
<li><a href="../323206/index.html">Program on PYTHON to determine the authorship of the text by the frequency of occurrence of new words</a></li>
<li><a href="../323208/index.html">Nginx + PHP 7.1.1 FPM vs Node.js 7.7.1 as part 2 backend</a></li>
<li><a href="../323210/index.html">Open machine learning course. Topic 2: Data Visualization with Python</a></li>
<li><a href="../323212/index.html">Where the games go: the problem of preserving old video games. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>