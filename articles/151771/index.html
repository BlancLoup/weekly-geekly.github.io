<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bash: we start the demon with child processes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good all the mood! 
 I read this article , and decided to take the checkers in my hands for a bit, and try to do something pleasant for myself and for...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bash: we start the demon with child processes</h1><div class="post__text post__text-html js-mediator-article">  Good all the mood! <br>  I read this <a href="http://habrahabr.ru/post/151684/">article</a> , and decided to take the checkers in my hands for a bit, and try to do something pleasant for myself and for others. <br>  My script does not do any useful things, but I think for less novice writers on bash, he will teach something, and even if there are comments, then I will learn from those people who point out my mistakes. <br><br><h5>  Introductory </h5><br>  The script will be run in the background by the daemon.  Immediately I think it is necessary to agree that the process itself which will hang in my memory all the time I will call ‚ÄúParent‚Äù.  The parent will search for a specific file in a specific directory, and if it exists, the file will be deleted and a process will be launched, which I will call the ‚ÄúDescendant‚Äù, the purpose of which will simply sleep for a while and then end.  But the Parent will not have to run more than one Descendant per unit of time.  In principle, if you read the above article, then I think the meaning is clear. <br><a name="habracut"></a><br><h5>  Let's start with </h5><br>  So, we define our variables. <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#        FILE_NAME="run_Lola_run" #       WATCH_DIR="/home/mcleod/test" #           LOCK_FILE="${WATCH_DIR}/monitor_file.lock" #         PID_FILE="${WATCH_DIR}/monitor_file.pid" #          JOB_LOCK_FILE="${WATCH_DIR}/job_monitor_file.lock" #         LOG="${WATCH_DIR}/monitor_file_work.log" #          ERR_LOG="${WATCH_DIR}/monitor_file_error.log" #        RANGE=100</span></span></code> </pre> <br><br>  Next, for convenient management of starting and stopping the Parent, we will write a small condition <br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-variable"><span class="hljs-variable">$1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">"start"</span></span>) start ;; <span class="hljs-string"><span class="hljs-string">"stop"</span></span>) stop ;; *) usage ;; <span class="hljs-keyword"><span class="hljs-keyword">esac</span></span> <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The frame is ready, all the variables are also defined, now we need to describe the functions used <br><ul><li>  start - a start function that puts the script into daemon mode </li><li>  stop - stop daemon function </li><li>  usage - help display function </li><li>  _log - logging function </li><li>  run_job - Descendant launch function </li></ul><br><br>  Now I will describe the functions as they become more complex.  The simplest of them is the usage function, it looks like this <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   usage() { echo "$0 (start|stop)" }</span></span></code> </pre><br>  Next comes the _log function. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   _log() { process=$1 shift echo "${process}[$$]: $*" }</span></span></code> </pre><br>  Now the daemon stop function <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    stop() { #   pid ,       pid  if [ -e ${PID_FILE} ] then _pid=$(cat ${PID_FILE}) kill $_pid rt=$? if [ "$rt" == "0" ] then echo "Daemon stop" else echo "Error stop daemon" fi else echo "Daemon is't running" fi }</span></span></code> </pre><br>  Here I do not use the logging function, since  here messages should be displayed on the console. <br>  Now perhaps bring the most complex function start.  It contains all the logic of the work and the very moment of the demonization of the script. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    start() { #     pid        if [ -e $PID_FILE ] then _pid=$(cat ${PID_FILE}) if [ -e /proc/${_pid} ] then echo "Daemon already running with pid = $_pid" exit 0 fi fi #    touch ${LOG} touch ${ERR_LOG} #   ,      cd / #   ,      exec &gt; $LOG exec 2&gt; $ERR_LOG exec &lt; /dev/null #    ,  .      ( #             trap "{ rm -f ${PID_FILE}; exit 255; }" TERM INT EXIT #     while [ 1 ] do #      if ls -1 ${WATCH_DIR} | grep "^${FILE_NAME}$" 2&gt;&amp;1 &gt;/dev/null then _log "parent" "File found" rm -f ${WATCH_DIR}/${FILE_NAME} _log "parent" "File deleted" #            number=$RANDOM let "number %= $RANGE" _log "parent" "Genereated number $number" JOBS[${#JOBS[@]}]=$number fi #     0,   ,       if [ "${#JOBS[@]}" -gt "0" ] then if [ ! -e ${JOB_LOCK_FILE} ] then run_job _log "parent" "Running job with pid $!" unset JOBS[0] JOBS=("${JOBS[@]}") _log "parent" "Jobs in queue [${#JOBS[@]}]" fi fi #    sleep 1 done exit 0 )&amp; #  pid   ,    echo $! &gt; ${PID_FILE} }</span></span></code> </pre><br>  Well, the launch function itself <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   .       JOBS,   run_job() { #    .          /, ..      ( #        trap "{ rm -f ${JOB_LOCK_FILE}; exit 255; }" TERM INT EXIT #         if [ ! -e ${JOB_LOCK_FILE} ] then #   pid   ,    echo "$$" &gt; ${JOB_LOCK_FILE} _log "child" "Job with pid $$" #     seconds=${JOBS[0]} #  ,     ,      unset JOBS _log "child" "Sleep seconds $seconds" sleep ${seconds} else _log "child" "Lock file is exists" fi #  exit 0 )&amp; }</span></span></code> </pre><br>  Well, now if all of the above merged into a file and give it the right to execute, I think it will not be difficult for you.  By the way, before launching, I advise you to change the value of the WATCH_DIR variable to the path to the directory in which the script will look for a file named run_Lola_run. <br>  Here is my log file output <br><pre> <code class="bash hljs">parent[32338]: File found parent[32338]: File deleted parent[32338]: Genereated number 96 parent[32338]: Running job with pid 32385 parent[32338]: Jobs <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> queue [0] child[32338]: Job with pid 32338 child[32338]: Sleep seconds 96 parent[32338]: File found parent[32338]: File deleted parent[32338]: Genereated number 46 parent[32338]: File found parent[32338]: File deleted parent[32338]: Genereated number 1 parent[32338]: Running job with pid 32694 parent[32338]: Jobs <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> queue [1] child[32338]: Job with pid 32338 child[32338]: Sleep seconds 46 parent[32338]: Running job with pid 371 parent[32338]: Jobs <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> queue [0] child[32338]: Job with pid 32338 child[32338]: Sleep seconds 1</code> </pre><br>  I hope someone this post will help in the development of bash. <br><br>  PS: The attentive reader probably saw that there is the same process number everywhere in the log.  Since  There is no clean fork in bash, here it happens, it can be said to emulate by running the necessary code in () &amp;, which runs it in a separate process, but at the same time keeps the variables unchanged.  And we know that the number of the current process in bash is stored in the $$ variable.  Therefore, the same process number is displayed in the log file.  That is why the start function ends with the line echo $!  &gt; $ {PID_FILE}. </div><p>Source: <a href="https://habr.com/ru/post/151771/">https://habr.com/ru/post/151771/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../151762/index.html">As I wrote Futboloid under iOS</a></li>
<li><a href="../151763/index.html">Using the Android Tablet PC as a Personal GPS Tracker</a></li>
<li><a href="../151764/index.html">William Gibson Interview Wired. Part 1</a></li>
<li><a href="../151765/index.html">Intel forecast - the transition to 5-nm technology will allow Gordon Moore's law to hold on for at least another decade</a></li>
<li><a href="../151769/index.html">Runetology (165): Yuri Virovets and Alexey Babin, investor and founder of Clickberry</a></li>
<li><a href="../151773/index.html">Creating a cloud-based PHP site with SQL Database and deploying it with Git</a></li>
<li><a href="../151774/index.html">Sidebar Gadget Sticky Notes with dock synchronization via DropBox for Windows 7 do it yourself</a></li>
<li><a href="../151775/index.html">RCC 2012 Through the eyes of a mere mortal</a></li>
<li><a href="../151776/index.html">The European Union is preparing a new antitrust investigation against Microsoft</a></li>
<li><a href="../151777/index.html">Podcast "Notes on Qt" s02e01</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>