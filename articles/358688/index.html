<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ESET discovered two 0-day vulnerabilities in Adobe Reader and Microsoft Windows</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the end of March 2018, ESET experts discovered an unusual malicious PDF file. Upon closer inspection, it turned out that the sample uses two previo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ESET discovered two 0-day vulnerabilities in Adobe Reader and Microsoft Windows</h1><div class="post__text post__text-html js-mediator-article">  At the end of March 2018, ESET experts discovered an unusual malicious PDF file.  Upon closer inspection, it turned out that the sample uses two previously unknown vulnerabilities: the remote code execution vulnerability (RCE) in Adobe Reader and the privilege elevation vulnerability (LPE) in Microsoft Windows. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/l2/ps/ig/l2psigfrgjqu7jxtdskk9xlx7cg.jpeg"></div><br>  The combination of two 0-days is quite dangerous because it opens up the ability of an attacker to execute arbitrary code on the target system with maximum privileges and minimal user participation.  ART groups often use similar combinations of tools ‚Äî for example, in <a href="https://www.welivesecurity.com/2017/05/09/sednit-adds-two-zero-day-exploits-using-trumps-attack-syria-decoy/">the Sednit campaign</a> last year. <br><br>  Having detected a malicious PDF, ESET experts contacted the Microsoft Security Response Center, Windows Defender ATP and the Adobe Product Security Incident Response Team to close the vulnerabilities. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Patches and recommendations of Adobe and Microsoft are available at the following links: <br><br>  ‚Ä¢ <a href="https://helpx.adobe.com/security/products/acrobat/apsb18-09.html">APSB18-09</a> <br>  ‚Ä¢ <a href="https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2018-8120">CVE-2018-8120</a> <br><br><a name="habracut"></a>  The following products are subject to vulnerabilities: <br><br>  ‚Ä¢ Acrobat DC (2018.011.20038 and earlier versions) <br>  ‚Ä¢ Acrobat Reader DC (2018.011.20038 and earlier versions) <br>  ‚Ä¢ Acrobat 2017 (011.30079 and earlier versions) <br>  ‚Ä¢ Acrobat Reader DC 2017 (2017.011.30079 and earlier versions) <br>  ‚Ä¢ Acrobat DC (Classic 2015) (2015.006.30417 and earlier) <br>  ‚Ä¢ Acrobat Reader DC (Classic 2015) (2015.006.30417 and earlier) <br>  ‚Ä¢ Windows 7 for 32-bit Systems Service Pack 1 <br>  ‚Ä¢ Windows 7 for x64-based Systems Service Pack 1 <br>  ‚Ä¢ Windows Server 2008 for 32-bit Systems Service Pack 2 <br>  ‚Ä¢ Windows Server 2008 for Itanium-Based Systems Service Pack 2 <br>  ‚Ä¢ Windows Server 2008 for x64-based Systems Service Pack 2 <br>  ‚Ä¢ Windows Server 2008 R2 for Itanium-Based Systems Service Pack 1 <br>  ‚Ä¢ Windows Server 2008 R2 for x64-based Systems Service Pack 1 <br><br>  Next is a technical description of the malware sample and vulnerabilities. <br><br><h3>  Introduction </h3><br>  PDF files are often used to deliver malware to the target computer.  To execute malicious code, an attacker has to search for and use vulnerabilities in PDF viewing software.  One of the most popular similar programs is Adobe Reader. <br><br>  The Adobe Reader introduced the technology of isolated execution, better known as the sandbox - Protected Mode.  Its detailed description is published on the Adobe blog ( <a href="http://blogs.adobe.com/security/2010/10/inside-adobe-reader-protected-mode-part-1-design.html">part 1</a> , <a href="http://blogs.adobe.com/security/2010/10/inside-adobe-reader-protected-mode-part-2-the-sandbox-process.html">part 2</a> , <a href="http://blogs.adobe.com/security/2010/11/inside-adobe-reader-protected-mode-part-3-broker-process-policies-and-inter-process-communication.html">part 3</a> , <a href="http://blogs.adobe.com/security/2010/11/inside-adobe-reader-protected-mode-part-4-the-challenge-of-sandboxing.html">part 4</a> ).  Sandbox complicates the implementation of the attack: even if the malicious code is executed, an attacker will have to bypass the sandbox protection in order to compromise a computer running Adobe Reader.  Typically, vulnerabilities in the operating system itself are used to bypass the sandbox. <br><br>  A rare case where attackers managed to find vulnerabilities and write exploits for both Adobe Reader and the operating system. <br><br><h3>  CVE-2018-4990 - RCE Vulnerability in Adobe Reader </h3><br>  JavaScript is embedded in the malicious PDF to control the exploitation process.  The code is executed after opening the PDF file. <br><br>  At the beginning of the exploitation process, JavaScript code manipulates a <code>Button1</code> object.  The object contains a specially crafted JPEG2000 image that triggers a double vulnerability. <br><br><img src="https://habrastorage.org/webt/_e/_z/qe/_e_zqe0zykjachxm90apa9i9ydy.png"><br>  <i>Figure 1. JavaScript that manipulates a Button object.</i> <br><br>  JavaScript uses the heap-spraying technique to break internal data structures.  After these manipulations, the attackers reach the main goal - access to the memory with read and write permissions. <br><br><img src="https://habrastorage.org/webt/mx/w3/ne/mxw3neenzdl3ovsczpe4vtrfem4.png"><br>  <i>Figure 2. JavaScript code used to read and write memory.</i> <br><br>  Using two primitives, attackers find the memory address of the plugin <code>EScript.api</code> , which is the Adobe JavaScript engine.  Using ROP gadgets from this module, malicious JavaScript establishes the ROP chain, which will lead to the execution of native shellcode. <br><br><img src="https://habrastorage.org/webt/wc/-e/ra/wc-erau59m4ctolylrkr77eovi8.png"><br>  <i>Figure 3. Malicious JavaScript that sets the ROP chain.</i> <br><br>  As a final step, the shellcode initializes the PE file embedded in the PDF and passes it the execution. <br><br><h3>  CVE-2018-8120 - privilege elevation in Microsoft Windows </h3><br>  After exploiting the Adobe Reader vulnerability, an attacker needs to get rid of the sandbox.  This is the task of the second exploit. <br><br>  At the core of this previously unknown vulnerability is the <code>win32k</code> Windows kernel component component of the <code>NtUserSetImeInfoEx</code> component of the Windows <code>win32k</code> .  In particular, <code>SetImeInfoEx</code> , the <code>NtUserSetImeInfoEx</code> routine, does not check the data pointer, allowing dereferencing a null (NULL) pointer. <br><br><img src="https://habrastorage.org/webt/b_/uk/2b/b_uk2bmocbsnbbiz_qt4zbgiipi.png"><br>  <i>Figure 4. Disassembled function SetImeInfoEx.</i> <br><br>  As you can see in Figure 4, the <code>SetImeInfoEx</code> function expects a pointer to the initialized WINDOWSTATION object as the first argument.  <code>SpklList</code> can be zero if the attacker creates a new WS object and assigns it to the current process in user mode.  Thus, mapping a zero page and setting a pointer to an offset (offset) 0x2C allows attackers to use the vulnerability to write to an arbitrary address in kernel space.  It is worth noting that, starting with Windows 8, the user process cannot convert zero page data. <br><br>  Since the attackers have an arbitrary writing primitive, they can use different techniques.  But in our case, the attackers choose the technique described by <a href="http://www.ivanlef0u.tuxfamily.org/%3Fp%3D86">Ivanlef0u</a> , as well as <a href="http://j00ru.vexillium.org/%3Fp%3D290">Mateusz "j00ru" Jurczyk and Gynvael Coldwin</a> .  They set the call gateway to Ring 0, overwriting the global descriptor table (GDT).  To do this, attackers obtain the address of the original GDT using the SGDT assembly instructions, create their own table and then rewrite the original using the mentioned vulnerability. <br><br>  The exploit then uses the <code>CALL FAR</code> command to invoke the privilege level. <br><br><img src="https://habrastorage.org/webt/vo/nm/wx/vonmwx47j_p9mna9eyjdi9e7zrk.png"><br>  <i>Figure 5. Disassembled CALL FAR command.</i> <br><br>  When code is executed in kernel mode, the exploit replaces the current process token with the system token. <br><br><h3>  findings </h3><br>  ESET specialists discovered a malicious PDF when it was uploaded to a public repository of malicious samples.  The sample does not contain the final payload, which may indicate that it was detected in the early stages of development.  Despite this, the authors demonstrated high qualifications in the field of searching for vulnerabilities and writing exploits. <br><br><h3>  Compromise Indicators (IoC) </h3><br>  <b>Detection by ESET products:</b> <br>  JS / Exploit.Pdfka.QNV trojan <br>  Win32 / Exploit.CVE-2018-8120.A trojan <br><br>  <b>SHA-1:</b> <br>  C82CFEAD292EECA601D3CF82C8C5340CB579D1C6 <br>  0D3F335CCCA4575593054446F5F219EBA6CD93FE </div><p>Source: <a href="https://habr.com/ru/post/358688/">https://habr.com/ru/post/358688/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358676/index.html">Mathematical modeling haboo-future</a></li>
<li><a href="../358678/index.html">FAS rendered YouTube and torrents from Russian jurisdiction</a></li>
<li><a href="../358680/index.html">Troubleshooting Node.js Applications Under the Hood</a></li>
<li><a href="../358682/index.html">ARM MBED OS. Work with arbitrary MK STM32 under PlatformIO</a></li>
<li><a href="../358686/index.html">Megafon ordered the Kupol storage complex to store traffic according to the law of Spring</a></li>
<li><a href="../358690/index.html">We pack in containers, deploy, monitor - the program Root Conf</a></li>
<li><a href="../358692/index.html">Selection: 6 open frameworks for creating backtesters of trading strategies in Python</a></li>
<li><a href="../358694/index.html">UPD Broadcast. We invite you to the New PostgreSQL 11 features mitap</a></li>
<li><a href="../358696/index.html">We update Angular to the 6th version in the project without use of CLI</a></li>
<li><a href="../358698/index.html">13 interesting points from the javascript style guide from google</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>