<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Old school, hardcore, AY-3-8912. "Iron" chiptune with sequential input</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Clone Spectrum 128K, equipped with a music coprocessor AY-3-8910 (YM2149F) I did not have. There was 48K with an extended keyboard and a poor power su...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Old school, hardcore, AY-3-8912. "Iron" chiptune with sequential input</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/0cc/e64/84b/0cce6484bf3a46b6966292a55944113b.jpg"><br><br>  Clone Spectrum 128K, equipped with a music coprocessor AY-3-8910 (YM2149F) I did not have.  There was 48K with an extended keyboard and a poor power supply that overheats the insides in an hour or two of work.  From this, I remember.  houses in the middle of the sea in Sim City were formed and other funny artifacts.  But these memories are irrelevant.  Inspired by the <a href="http://geektimes.ru/users/tronix286/" class="user_link">tronix286</a> <a href="http://habrahabr.ru/post/248115/">material</a> , I decided to fill the gap in retro-education and rivet something on the legendary (and at the same time, easily mined and inexpensive) chip. <br><br>  During the study of various handicrafts, the idea was formed as follows: it is necessary to make a module with a serial (UART) input.  So that it can already be connected with minimal cost to any device, thereby adding +146 to the chip tune.  In the process, it was also decided to master a couple of additional skills, such as programming AVR and making printed circuit boards using photoresist. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I will immediately describe the results: the module has been developed and crooks, side skills have been pumped up, rakes have been collected, you can be happy, expand and deepen. <br><a name="habracut"></a><br>  <b>Synthesizer</b> <br><br>  AY-3-8910 is a big beautiful 40-foot DIP chip.  In addition to the necessary things, there are two more 8-bit ports that are not used by normal people (who are not trying to make a hellish analog of Covox) for sound output.  AY-3-8912 is not less beautiful, but one ‚Äúextra‚Äù port is deprived and packed already in DIP28.  And still happens AY-3-8913, generally without a parallel port (DIP24).  And this is only General Instrument / Microchip.  Yamaha riveted even more variations: from YM2149F (analogue AY-3-8910 with a clock frequency divider) to YMZ284 (DIP16, one mixed output channel).  <a href="http://en.wikipedia.org/wiki/General_Instrument_AY-3-8910">Learn more about chips on the wiki</a> . <br><br>  <b>Control</b> <br><br>  To download data using an 8-bit parallel port.  Plus, three control lines (one, which is BC2, we pull up to the power supply).  The logic is as follows: <br><br>  1. The initial state - BC1 = 0, BDIR = 0. <br>  2. Set the address of the register on the legs of the port AY. <br>  3. BC1 = 1, BDIR = 1.  Download address.  The delay between switching on the lines should be no more than 50 ns, so any slow twitching of the legs (such as Arduinsky DigitalWrite) is not suitable, for example, PORTC | = 0b00110000; <br>  4. BC1 = 0, BDIR = 0. <br>  5. Set the value of the register on the legs of the port AY. <br>  6. BC1 = 0, BDIR = 1.  Loading values. <br><br>  Repeat the sequence 14 times (for each desired register).  And all this - 50 times per second.  We get the music. <br><br>  <b>Choosing a specific iron</b> <br><br>  In my case the following: <br>  1. AY-3-8912 - was cheaper. <br>  2. Atmega8A (DIP28) - available, enough conclusions. <br>  3. Quartz oscillator at 4 MHz - for clocking AY. <br>  4. Counter K555IE5 - as a frequency divider for clocking AY. <br>  5. Quartz at 16 MHz - for Atmega8A. <br>  6. For connection to PC - USB UART on FT232R. <br><br><img src="https://habrastorage.org/files/e8d/fab/453/e8dfab453e014997b597adc0b5cf73cb.jpg"><br><br>  Fee divorced just for this business.  In the process of debugging and more thoughtful study, the following thoughts emerged: <br><br>  1. If you use YM2149F, then you do not need a counter, because  This chip has a built-in frequency divider by 2. <br>  2. It seems that Atmega does not need quartz either - everything works decently from the internal 8 MHz generator. <br>  3. In theory, you can try to get rid of the quartz oscillator for AY altogether, if you look through the hardware timers and Atmega counters.  But!  In this case, we can only clock AY at 2 MHz.  And in a good way, you must be able to clocking at 1.7 (many digits) MHz - as is done in the Speccy.  I have a 4 MHz crystal oscillator in a DIP-block in order to replace it with 3.5 (many digits) MHz. <br><br>  The sound output is sketched at <a href="http://geektimes.ru/users/tronix286/" class="user_link">tronix286</a> , there are a handful of resistors and two capacitors. <br><br>  <b>Soft</b> <br><br>  This inspiration has been studied for inspiration.  It describes the general principle of operation of the ‚Äúsource - UART - Atmega - AY‚Äù bundle, but the use of the Arduino loader on the mega in this case seemed to me completely superfluous.  Well, the program on the PC, written in C #, I did not like.  Sharp here is about as ‚Äúneeded‚Äù as the Arduino.  YM format is laid out <a href="http://leonard.oxg.free.fr/ymformat.html">here</a> . <br><br>  <b>Atmega firmware</b> <br><br>  The source code and hex are available on the githab (link at the end of the material), I‚Äôll just go over the main functions. <br><br>  <u>valToPort</u> - write an 8-bit value to the ‚Äúport‚Äù, consisting of half port B and half C. It was more convenient to plant. <br>  <u>sendToAY</u> - write an 8-bit value to the AY register.  Here the logic described in the ‚ÄúControl‚Äù section is implemented. <br>  <u>setup</u> - initialization of ports and UART. <br>  <u>main</u> - looped "get 16 bytes - write to AY". <br><br>  <b>Demo on PC</b> <br><br><img src="https://habrastorage.org/files/d69/b33/eea/d69b33eeaa5445c3b72865843c038a31.png"><br><br>  Written in Python 3 using PySerial.  Like the firmware, it lies on the githaba.  Takes the 1.ym file (uncompressed!) From the current directory, parses it and pushes it into COM6.  For the sake of interest, the example has been tested on OS X, it works out of the box, you just need to change the port name.  I suspect that it will work just as successfully on Linux, incl.  on the "raspberry". <br><br>  In issuing a dump of registers on AY there is one nuance.  The YM format stores data in the form of ‚Äúall register values ‚Äã‚Äã0, all values ‚Äã‚Äãof register 1 ...‚Äù.  This is very correct in terms of further compression.  I work with uncompressed YM, and I need to issue packets of bytes "register 0, register 1 ...".  For a PC, the problem is solved in the forehead - we read the data from the file in the right order into a large array, then from it we consistently give it to the controller.  When you need to make a "head unit" based on a chip with a small memory size, you will have to invent some kind of buffers. <br><br>  <b>Total</b> <br><br>  It is worth remembering that before starting playback, it would be nice to reset ‚Äúmegu‚Äù and AY.  Because if there is something in the controller's buffer, when transferring new data, the entire stream will shift, and the sounds will be truly heartbreaking.  A reset pin on the module is provided, but is not used in the demo.  The reset is carried out by poking the wire into the quartz oscillator case sitting on the ground. <br><br>  There is also a misunderstood bug.  Which, probably, hides somewhere around "Windows 10 - Python 3 - UART".  Periodically, the update rate drops from 50 Hz to 20 (oscilloscoped).  The system was not detected in the phenomenon, the glitch was not reproduced on another computer.  If I catch sometime, I will do UPD. <br><br>  In the future, the module will be bolted to the handicraft development, an article about this in the relatively foreseeable future.  Well, and to the "Malinka" should try to pick up.  There is room for experimentation. <br><br>  <a href="https://github.com/eta4ever/ay-serial">Sources, board layout (SL6), module scheme (Eagle) on github.</a> <br><br>  UPD1.  Convert to YM with <a href="http://bulba.untergrund.net/emulator.htm">AYEmul</a> . <br>  UPD2.  <a href="">Here</a> is taken the .torrent to download the archive Modland.com.  There are many. <br>  UPD3.  <a href="http://www.worldofspectrum.org/projectay/gdmusic.htm">ProjectAY</a> .  There is a lot of music in AY.  At the time of publication the site lay. <br><br>  <b>Now everything is more or less cultural</b> <br><br>  UPD4.  03/18/2015 redid the Atmega code and demo (pythonium).  Now the logic is this: Atmega requests data from the host, fills the ring buffer (512 bytes), then as half loses, asks for more (i.e. request points 256 and 512 (0)).  The host responds to the request with a packet of 256 bytes, Atmega consumes them through an interrupt handler.  Not everything is polished, but it plays much more stable than the original version. <br><br>  UPD5.  I tried on the malinka.  Works almost out of the box. <br>  0. Disable the console on the serial port (etc / inittab at the end). <br>  1. comPort = "/ dev / ttyAMA0" (serial port) <br>  2. regState = bytes ([registerDump [currentPos + currByte]]) (so serial.write works fine) </div><p>Source: <a href="https://habr.com/ru/post/253069/">https://habr.com/ru/post/253069/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253049/index.html">Two points</a></li>
<li><a href="../253051/index.html">Creating objects inherited from null on Node.js</a></li>
<li><a href="../253053/index.html">Computer graphics, online course</a></li>
<li><a href="../253063/index.html">Our experience using AWS at launch</a></li>
<li><a href="../253067/index.html">Phase AC load control with FLProg</a></li>
<li><a href="../253073/index.html">Protection from listening to conversations - we build secure SIP telephony with our own hands</a></li>
<li><a href="../253075/index.html">Goodbye MongoDB Hello PostgreSQL</a></li>
<li><a href="../253077/index.html">Metaperators X and Z in Perl 6</a></li>
<li><a href="../253079/index.html">Create a fully automatic farm.</a></li>
<li><a href="../253081/index.html">5 functions of the Console object that you did not know about</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>