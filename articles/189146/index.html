<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Flashing LED string for stop light on Arduino Pro Mini</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I just did not want to stick any stickers on the rear window of the car - it‚Äôs not known who passes by the car at night and what will be the reaction ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Flashing LED string for stop light on Arduino Pro Mini</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/229/f72/551/229f725519bbb0c277503377cbe2e1b7.jpg" alt="Flashing LED string for stop light on Arduino Mini" align="left">  I just did not want to stick any stickers on the rear window of the car - it‚Äôs not known who passes by the car at night and what will be the reaction to the inscription.  It was decided to make the inscription LEDs under the rear window.  In the inactive time it is not visible at all (tinted glass behind), besides, you can turn it off / on when necessary.  Well, a little later the idea came to include the inscription only when the stop signal lights up and make an inscription out of red LEDs - it turns out a simple duplication of the stop signal, but with additional information.  All work took 3 pm, that's what happened. <br><br>  Of course, you can simply buy a running line or a light board and put it under the rear window ... But quickly running through the prices of these devices immediately immediately felt like a little money and it was decided to do everything with your own hands. <br><a name="habracut"></a><br>  First, I decided on the iron - this is the Arduino Pro Mini, which costs $ 4 on eBay.  Why precisely she?  Because it is quite enough, even in abundance.  The LEDs were planned to be connected to the PWM channels so that the brightness of the LEDs could be controlled.  The Arduino Mini has only 6 such outputs - quite enough for us.  In fact, absolutely any Arduina will be suitable for our task. <br><br><img src="https://habrastorage.org/storage2/7f1/dc4/327/7f1dc4327851fc98959c6b110ac6212c.jpg" alt="Arduino Pro Mini" align="right">  Then I decided on the inscription and broke it into 6 independent sections.  This turned out to be even a lot, so I left only 5 active and one channel had planned for ‚Äúprozapas‚Äù.  In each section it turned out from 2 to 4 letters, for each letter you need about 10-20 LEDs. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As you know, the Arduino output pulls only 40ma, because of this, connecting such a horizon of LEDs directly to the Arduino outputs will not work.  To solve the problem, the P16NF06 mosfets were used - powerful field workers, whom I found in the store of 20 pieces. Of course, using mosfets for such a task is a brute force, since  They can switch currents up to 1 amp (for example, they pull quietly LED strip of good length).  Instead, you can use simple bipolar transistors, which are cheaper.  But the mosfets can be connected directly to the Arduino terminals, since  they have a high input resistance and for the same reason they do not require a body kit in the form of a resistor (s). <br><br>  Then I had to select about 130 red LEDs from the stock of 5mm.  Unfortunately, I didn‚Äôt have that many red LEDs, so I had to make some letters green.  As you know, LEDs need to be connected through a resistor to limit the current.  It was decided to connect in series of 6 pieces and connect this block of LEDs through a resistor to + 12V.  It was calculated and chosen empirically that for 6 LEDs and a supply voltage of 12V, a resistor of approximately 50 Ohms is needed. <br><br>  The main points of the future device are marked, now let's get down to business. <br><br>  As a basis for the panel was taken plain cardboard from the old box.  Two strips of 80x15 cm were cut out. This size turned out to be optimal for placement under the rear window of the car.  Next, the printer printed a text line and selected a font for letters - Calibri, 300 in size. By attaching to the cardboard, the inscription was transferred to a strip.  With the help of tweezers holes were made for LEDs.  Here it is necessary to take into account that the LEDs are connected in blocks of 6 pieces, so each channel must be connected to a number of LEDs multiple of 6.  In principle, this can be circumvented by creating a series of LEDs from any other number and calculating a resistor for connecting them to 12V. <br><br><img src="https://habrastorage.org/storage2/7c6/95c/045/7c695c04565bdc02c8d3b97dffc02381.jpg" alt="LED panel do it yourself"><br><br>  Also for me it was very important to keep the legs of the LEDs safe and sound, so that you can use them in other designs.  Therefore, to connect the legs only slightly bent back and soldered to each other.  In short, the construction was assembled and sealed in about 3 hours. <br><br><img src="https://habrastorage.org/storage2/a5e/021/e74/a5e021e74154df9c310bbdb1c5ca0c12.jpg" alt="LED panel do it yourself"><br><br>  Arduino Mini is usually sold without legs, so the first thing soldered to her legs.  It turns out almost Arduino Nano, but without 3.3V :) <br><br><img src="https://habrastorage.org/storage2/2f2/8b9/e18/2f28b9e18dc945eea4765c70b0908838.jpg" alt="image"><br><br>  Connectors are also soldered onto the breadboard to insert the controller board.  Next, the mosfets are soldered so that a single heat sink can be screwed to them (although no heat sink is needed here, since very small currents).  The PWM outputs 3, 5, 6, 9, 10, and 11 from the Arduino Mini are soldered to the corresponding inputs of the corresponding mosfets. <br><br><img src="https://habrastorage.org/storage2/d56/b21/fec/d56b21fece4f5d50d76dfbd4a437ef86.jpg" alt="image"><br><br><img src="https://habrastorage.org/storage2/db3/518/32e/db351832e03f2dbb9ec7c3cdf2160c31.jpg" align="right" alt="DC to DC converter">  Next came the challenge of providing the Arduino Mini with stable power.  As you know, from the cigarette lighter car, we have 12V, but this voltage may well be 13 and 14 volts at certain points in the use of the car.  The Arduino Mini documentation says that the maximum supply voltage can be no more than 12V, and the forum read that even a small excess can damage the board.  Therefore, it was decided to use a separate adjustable DC-DC stabilizer to power the Arduino.  It can also be ordered on EBay (costs $ 1), but you can collect it yourself.  I have such blocks, so I used ready.  Thus, 12V is supplied to a separate stabilizer (or maybe up to 30V), and the output is set to, say, 6V, which are fed to the RAW output of the Arduino Mini.  Power LEDs also comes directly from 12V (via mosfets). <br><br><br clear="all">  As a result of the PCB design in mind, the following arrangement of the elements was obtained: <br><br><img src="https://habrastorage.org/storage2/561/9f7/45d/5619f745d75892b5fa9e6edaccc10bc4.jpg" alt="image"><br><br>  Now it is time to decide on what signal all this will turn on.  At first, it was planned to connect the entire device directly parallel to the brake light on the car.  But, unfortunately, when the voltage is applied to the Arduino, the controller initializes and lasts for quite a long time&gt; 1 sec.  Moreover, immediately after switching on, the Arduino outputs are in the Z state and the Mosfets react to this in a very random way.  As a result, after switching on, an arbitrary indication occurs during the entire period of the controller initialization.  Of course, with the help of an additional body kit, you can set the initial state of the keys, but this requires more details and time ... <br><br>  The second option was to connect to the digital input of the Arduino signal from the car's brake light.  To do this, it was necessary to lower the voltage on the stoplight lamp to 5V, which, in principle, is not difficult.  But this option was also impractical due to the fact that it would have had to unwind the back panel and somehow connect to the stoplight ... <br><br><img src="https://habrastorage.org/storage2/c73/b49/40d/c73b4940d7c17e35ca0853e18892ae3e.jpg" align="right" alt="Photoresistor">  I wanted a very simple solution and it was found!  It was decided to use a simple photoresistor connected to the analog input of the Arduino.  The photoresistor itself is simply placed in a box with a stoplight.  It turns out such a kind of opto-couple :) This solution allows you not to intervene in the electric car.  True, this is only possible when the brake light is in the cabin under the glass and you can push our photoresistor to it.  In short, I have such access, so I did just that. <br><br>  Moreover, the option with a photoresistor made it possible to solve one more problem - the brightness of the glow depending on the ambient light.  Using the photoresistor, you can roughly estimate the illumination on the street and turn on the backlight brighter in the daytime and darker at night.  I took this into account in the program, although in practice it turned out that even at night LEDs are far from blind behind riding drivers. <br><br>  The photoresistor is connected to the output of A0 and to + 5V.  A resistor of 10 kŒ© from A0 to ground is also required.  The type of photoresistor and the value of the resistor in the divider affect the constants that will be specified in the program (they can be selected experimentally). <br><br>  As a result, such a fee was obtained: <br><br><img src="https://habrastorage.org/storage2/63c/920/7ef/63c9207efe6466c92873ad12a2db85ef.jpg" alt="image"><br><br><img src="https://habrastorage.org/storage2/46c/ba4/a3a/46cba4a3aceee2b7aad7c8104cea4008.jpg" align="right" alt="FTDI Basic">  Now we will start the most favorite occupation - programming.  In order to fill the program in the Arduino Pro Mini, we need a USB Serial converter.  I use FTDI Basic for this purpose, which can also be purchased on eBay. <br><br>  This is how the Arduino Pro Mini should look like before starting the firmware: <br><br><img src="https://habrastorage.org/storage2/09b/1a4/c40/09b1a4c406cc15469b75a7d18338b0e3.jpg" alt="Arduino Pro Mini Firmware"><br><br>  To do this, load the Arduino development environment.  If everything is set correctly for you, then the COM port should appear in the Service / Serial Port menu.  If it is not there, then you need to install the appropriate driver from the drivers folder of the platform itself. <br><br>  After selecting the port, you must select the Service / Card / Arduino Mini.  Unfortunately, it is not so simple.  Depending on the version of the bootloader, you may not be able to write a program to the controller.  If after compilation an error of the type will be issued <br><br> <code>stk500_getsync(): not in sync: resp=0x00</code> <br> <br>  , then most likely the COM port speed of the development environment does not match the same parameter specified in the bootloader.  To fix this, it is recommended: <br><br><ol><li>  Select Service / Board / Arduino Nano.  This usually helps, but if it doesn't work, then see the next paragraph. </li><li>  In the folder of the development environment we find the file "\ hardware \ arduino \ avr \ boards.txt".  In this file we find the section ‚Äúmini.name = Arduino Mini‚Äù and further the parameter ‚Äúmenu.cpu.mini.atmega328.upload.speed = 57600‚Äù.  Here we are trying to change the value 57600 (you may have something else) to others.  All possible values ‚Äã‚Äãof speeds can be found in the monitor: the menu Service / Port Monitor and here the choice is in the lower right corner.  Before testing, you need to overload the development environment. </li></ol><br><br><div class="spoiler">  <b class="spoiler_title">The program itself is hidden here.</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> pinZA 3 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> pinNA 5 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> pinVAL 6 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> pinNO 9 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> pinGO 10 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> pinEMPTY 11 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> pinSTOPSIGNAL 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> sensValue 900 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//  .  0-1024 #define sensNight 200 //    ,    .  0-1024 #define lightDay 255 //  .  0-255 #define lightNight 150 //  .  0-255 int currentMaxValueLight = 255; void setup() { Serial.begin(9600); pinMode(pinZA, OUTPUT); pinMode(pinNA, OUTPUT); pinMode(pinVAL, OUTPUT); pinMode(pinNO, OUTPUT); pinMode(pinGO, OUTPUT); setAll(0); } int currentEffect = 1; int maxEffects = 2; //     void loop() { if(checkState()){ switch(currentEffect){ case 1: //  1 effect_1(); delayWithStateCheck(2000); effect_off(); break; case 2: //  2 effect_2(); delayWithStateCheck(2000); effect_off(); break; case 3: //  3...  . // ................... break; } currentEffect++; if(currentEffect &gt; maxEffects){ //   ,    currentEffect = 1; } } } void effect_2(){ for(int i=0; i &lt;= 1; i++){ fade(pinZA, 3, true); fade(pinNA, 3, true); fade(pinVAL, 3, true); fade(pinNO, 3, true); fade(pinGO, 3, true); fade(pinZA, 3, false); fade(pinNA, 3, false); fade(pinVAL, 3, false); fade(pinNO, 3, false); fade(pinGO, 3, false); fade(pinGO, 3, true); fade(pinNO, 3, true); fade(pinVAL, 3, true); fade(pinNA, 3, true); fade(pinZA, 3, true); fade(pinGO, 3, false); fade(pinNO, 3, false); fade(pinVAL, 3, false); fade(pinNA, 3, false); fade(pinZA, 3, false); } setAll(currentMaxValueLight); delayWithStateCheck(200); setAll(0); delayWithStateCheck(100); setAll(currentMaxValueLight); delayWithStateCheck(200); } void effect_1(){ fade(pinZA, 10, true); fade(pinNA, 10, true); fade(pinVAL, 10, true); fade(pinNO, 10, true); fade(pinGO, 10, true); fade(pinGO, 3, false); fade(pinGO, 3, true); fade(pinGO, 3, false); fade(pinGO, 3, true); } void effect_off(){ fade(pinGO, 3, false); fade(pinNO, 3, false); fade(pinVAL, 3, false); fade(pinNA, 3, false); fade(pinZA, 3, false); } void fade(int pin, int d, boolean side){ // /   fade if(side){ for(int value = 0 ; value &lt;= currentMaxValueLight; value+=5){ if(!checkState()) break; analogWrite(pin, value); delay(d); } }else{ for(int value = currentMaxValueLight; value &gt;=0; value-=5){ if(!checkState()) break; analogWrite(pin, value); delay(d); } } } void delayWithStateCheck(int d){ //         for(int value = 0 ; value &lt;= d; value++){ if(!checkState()) break; delay(1); } } boolean checkState(){ //    - int val = analogRead(pinSTOPSIGNAL); boolean state = val &gt; sensValue; if(!state){ // -   setAll(0); if(val &lt; sensNight){ //       currentMaxValueLight = lightNight; //    }else{ currentMaxValueLight = lightDay; //   } } return state; } void setAll(int val){ //      analogWrite(pinZA, val); analogWrite(pinNA, val); analogWrite(pinVAL, val); analogWrite(pinNO, val); analogWrite(pinGO, val); }</span></span></span></span></code> </pre><br><br></div></div><br><br>  The main "complexity" in the program is a detour of the standard delay function.  The fact is that we need to turn everything off immediately after the brake light goes out.  To do this, you need to use either interrupts or constantly poll the luminance of the photoresistor.  Since  humanity has not yet invented interruptions on the analog input (or we need to make a body kit and sew up threshold values ‚Äã‚Äãinto the circuit), then we simply use the self-made delayWithStateCheck function that ‚Äúflies out‚Äù when the stop signal goes off. <br><br>  The result is the following: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/s9pT8qQD7FE%3Ffeature%3Doembed&amp;xid=25657,15700023,15700186,15700190,15700253,15700258&amp;usg=ALkJrhi_eQFi8-mrUZyHsAzlZUXmcLY6BA" frameborder="0" allowfullscreen=""></iframe><br><br>  Device assembly, ready to install: <br><br><img src="https://habrastorage.org/storage2/1c1/31a/249/1c131a249b841e371405ea8ddb8d9235.jpg" alt="image"><br><br>  Brake light with integrated photoresistor: <br><br><img src="https://habrastorage.org/storage2/9bc/c8d/90e/9bcc8d90ebc710fc15305ee1d7557745.jpg" alt="image"><br><br>  Night view: <br><br><img src="https://habrastorage.org/storage2/ab1/63b/cd3/ab163bcd38d8caa30fc7237423960c7e.jpg" alt="image"><br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/G8vKuWaSVek%3Ffeature%3Doembed&amp;xid=25657,15700023,15700186,15700190,15700253,15700258&amp;usg=ALkJrhj_g9ne_8bXmcgRYlIfr9bejhKhsQ" frameborder="0" allowfullscreen=""></iframe><br><br><h4>  <b>Cost of</b> </h4><br>  All components were bought on eBay in China or Hong Kong in advance. <br><ul><li>  Arduino Pro Mini - 150 rub </li><li>  6 pcs P16NF06 - 120 rub </li><li>  130 pcs LEDs - 90 rubles </li><li>  Photoresistor - 3 rubles </li><li>  Converter DCDC - 30 rubles </li><li>  Resistors 20 pcs - 10 rubles </li><li>  Wires from a pair of old Ethernet cable - 0 rub </li></ul><br>  Total: 403 rubles. <br><br><h4>  <b>findings</b> </h4><br>  Good luck and success in the development of Arduino.  And, of course, do not lie and steal :) </div><p>Source: <a href="https://habr.com/ru/post/189146/">https://habr.com/ru/post/189146/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../189136/index.html">Minnowboard Now Available</a></li>
<li><a href="../189138/index.html">Overview of the projector Aiptek PocketCinema V60: 60 inches, inexpensive</a></li>
<li><a href="../189140/index.html">Rover Curiosity sang "Happy Birthday" to himself</a></li>
<li><a href="../189142/index.html">IR controller for domestic air conditioner or reverse engineering remote control</a></li>
<li><a href="../189144/index.html">Running Siesta tests from the console using PhantomJS</a></li>
<li><a href="../189148/index.html">Implementing a VoIP card platform on FreeSWITCH using RADIUS</a></li>
<li><a href="../189150/index.html">Value of beauty</a></li>
<li><a href="../189154/index.html">New experiment from NASA: one twin brother in orbit, the second - on Earth</a></li>
<li><a href="../189158/index.html">CloudLinux - divide and conquer</a></li>
<li><a href="../189160/index.html">Quickly create basic vagrant images using veewee</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>