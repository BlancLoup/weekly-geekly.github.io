<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>csync2 or how to facilitate the work with the cluster</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, I had to raise a Linux cluster for one fairly loaded project. Rather, the issue of resiliency was more important than the load, but u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>csync2 or how to facilitate the work with the cluster</h1><div class="post__text post__text-html js-mediator-article"> Not so long ago, I had to raise a Linux cluster for one fairly loaded project.  Rather, the issue of resiliency was more important than the load, but usually the cluster is designed to solve both of these problems at the same time. <br>  In this case, I'm not going to consider the cluster architecture or debugging nuances, but tell you about a very convenient way to manage the cluster, speeding up its configuration and debugging. <br><br>  Agree, it is convenient to have a set of files (for example, configs), which will always look the same on servers with the same role?  Under the cut, I'll tell you how to achieve this in the shortest possible time. <br><a name="habracut"></a><br>  In the described cluster, seven dedicated servers that communicate with each other over the internal network with the following hostname: <br><br> <code>Load Balancers <b>lb1 lb2</b> <br> Application Servers <b>app1 app2</b> <br> Database Servers <b>db1 db2</b> <br> Backup server <b>bckp1</b></code> <br> <br>  And the hero of today's story is <a href="http://oss.linbit.com/csync2/">csync2</a> , a rather old program that is available in many nix repositories, and can also be downloaded as a <a href="http://oss.linbit.com/csync2/">tarball</a> or from a <a href="http://git.linbit.com/csync2.git/">git repository</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, step by step guide to installing, configuring and deriving benefit from csync2. <br><br><h4>  Installation </h4><br>  The installation must be performed on all nodes of the cluster: <br><br><h6>  From debian \ ubuntu repositories </h6><br> <code>apt-get install csync2 -y</code> <br> <br><h6>  From source </h6><br>  Before installing, make sure that you have <a href="http://librsync.sourceforge.net/">librsync</a> on your system <br>  Otherwise, you need to download <a href="http://sourceforge.net/projects/librsync/files/">librsync-0.9.7.tar.gz</a> , <br>  and install it <br> <code>tar -xf librsync-0.9.7.tar.gz &amp;&amp; cd librsync-0.9.7 <br> ./configure &amp;&amp; make <br> make install</code> <br> <br>  Also, csync2 hopes for <a href="http://www.sqlite.org/download.html">libsqlite</a> , which can also be compiled from source codes: <br> <code><a href=""></a> wget www.sqlite.org/sqlite-autoconf-3070603.tar.gz &amp;&amp; tar -xf sqlite-autoconf-3070603.tar.gz &amp;&amp; cd sqlite-autoconf-3070603 <br> ./configure &amp;&amp; make <br> make install</code> <br> <br>  Or you can use a rather unusual way, specifying the path to the tarball with the library when configuring (./configure) csync2: <br> <code>./configure --with-libsqlite-source=/path/to/libsqlite.tar.gz</code> <br> <br>  I did not receive any other requirements, and due to age, the program has precompiled packages for most OSs ( <a href="http://rpm.pbone.net/index.php3/stat/4/idpl/12103556/dir/redhat_el_5/com/csync2-1.34-4.el5.i386.rpm.html">RedHat RPM</a> , apt-get \ aptitude install csync2, <a href="http://www.freebsdports.info/ports/net/csync2.html">FreeBSD ports</a> ) <br><br>  Compile csync2 itself <br> <code><a href=""></a> cd /usr/local/src &amp;&amp; wget oss.linbit.com/csync2/csync2-1.34.tar.gz <br> tar -xf csync2-1.34.tar.gz &amp;&amp; cd csync2-1.34 <br> ./configure &amp;&amp; make <br> make install <br></code> <br><br>  I performed all operations under Ubuntu 10.04 LTS, where csync2 is installed in one line. <br>  If something went wrong in your OS - write in the comments, I will try to help. <br><br><h4>  Primary setup </h4><br>  So, we have installed csync2 on all nodes, we need to connect them together and make them exchange files with each other. <br><br>  csync2 exchanges files through an encrypted SSL connection, so you need to create a single csync2 certificate that will allow servers to ‚Äútrust‚Äù each other: <br><br>  According to the instructions, you can execute the command in the source folder. <br> <code>make cert</code> <br>  or (as I did) generate the certificate manually: <br> <code>openssl genrsa -out /etc/csync2_ssl_key.pem 1024 <br> openssl req -new -key /etc/csync2_ssl_key.pem -out /etc/csync2_ssl_cert.csr <br> openssl x509 -req -days 600 -in /etc/csync2_ssl_cert.csr -signkey /etc/csync2_ssl_key.pem -out /etc/csync2_ssl_cert.pem</code> <br> <br>  After that, you need to start generating the csync2 key: <br> <code>csync2 -k /etc/csync2.cluster.key</code> <br> <br>  This command takes quite a long time, after which the file <b>/etc/csync2.cluster.key</b> appears <br><br>  Now you need to copy it to all the nodes of your cluster so that they will be in a single sync cloud.  You can create several keys so that, for example, the database servers cannot communicate with the Application servers, but in my opinion it is not at all necessary if you do not build a cluster for the bank. <br><br><h4>  First sync </h4><br>  The most important program file is <b>/etc/csync2.cnf</b> <br>  It works on the following principle. <br>  You specify logical groups of servers and indicate what they have in common? <br>  For example, I use internal addressing not by IP, but by hostname, respectively, I want the <b>/ etc / hosts file</b> on all machines to be the same, and when adding a new node, it was enough for me to change it once, all changes would leak to the rest of the cluster nodes and they knew who <b>app3 was</b> , for example. <br>  On LoadBalancers, I have nginx, which should also have the same config on different machines. <br><br>  So in the config file, I combine my servers into logical groups: <br>  # All servers synchronize the base set of configs <br> <code>group all { <br> #    IP,       <br> host app1 app2; <br> host db1 db2; <br> host lb1 lb2; <br> host bckp1; <br> <br> #   <br> key /etc/csync2.cluster.key; <br> <br> #   \   ? <br> include /etc/hosts; #  hosts <br> include /etc/csync2.cfg; # !   csync2    ! ;) <br> <br> auto younger;#   ?    -    <br> } <br> <br> #    LoadBalancer'       nginx <br> group lb { <br> host lb1 lb2; <br> <br> key /etc/csync2.cluster.key; <br> <br> include /etc/nginx/*; <br> auto younger; <br> }</code> <br> <br>  Now run csync2 with the instruction to synchronize everything that can be synchronized: <br> <code>csync2 -x</code> <br> <br>  After the initial authorization, all hosts are synchronized and the files you specify will be the same on all nodes. <br><br><h6>  Possible problems </h6><br>  If something went wrong, run <br> <code>csync2 -xv <br> csync2 -xvv</code> <br>  etc. <br><br>  I csync2 swore at the lack of access to the <b>/ etc / hosts</b> entry on other machines, this problem resolved itself after csync2 was also running on them for the first time. <br>  If csync2 swears on SSL - check whether the file <b>/etc/csync2.cluster.key is</b> copied to all hosts and correctly specified in the config. <br><br>  I didn‚Äôt have any other problems, if you have something else - write, let's see. <br><br><h4>  Goodies </h4><br>  Synchronization of all necessary configs is cool, I put configs from mysql, php, nginx and so on in csync2.  It turned out to be very convenient to put the config from csync2 into csync2 itself (almost recursion). <br>  But just syncing files is not everything. <br>  After changing the nginx files, you must restart it!  And if it needs to be done on a hundred machines? <br><br>  We add to the group of servers with the same role on which nginx is installed: <br> <code>group lb { <br> host lb1; <br> host lb2; <br> key /etc/csync2.cluster.key; <br> <br> include /etc/nginx; #       <br> action { <br> pattern /etc/nginx/*; #    ,   ? <br> exec "/etc/init.d/nginx <b>reload</b> "; #    ? <br> logfile "/var/log/csync2.actions.log"; #   ? <br> do-local; #    ,      ,     ,    ,    <br> } <br> auto younger; <br> }</code> <br> <br>  The remarkable <b>action</b> item allows us to execute an arbitrary <u>bash</u> command after changes in certain files, in the specified example it will restart nginx. <br><br>  I pay attention that the <b>reload</b> command, but not <b>restart</b> is executed.  If, God forbid, you do not put a comma in the nginx config and it falls on a hundred machines, you will also quickly correct the error and on a hundred machines it will recover.  In principle, it will be possible to change the config csync2, but this will take precious time downtime. <br><br><h4>  Conclusion </h4><br>  So, we got a very safe opportunity to edit the configs we are used to without any tricks, as if we had only one server, and change the changes to N other servers. <br>  I note that csync2 does not have a head server, so changes can be made to any node and after running csync2 -x, changes will spill over to the others. <br><br>  I synchronize via csync2 not only configs, but the actual project files themselves, some of which are uploaded by users, so I simply put csync2 in kroner (chase how many nodes I did? Right, on one and one time! <br><br><h6>  Lotions: </h6><br>  The other day I put the <b>authorized_keys</b> file in csync2 and now from my machine I go to any node without entering a password.  It's great when passwords on all nodes are complex and different.  You can also copy the <b>hosts</b> file to your computer and go to the nodes by their internal names. <br>  Believe me, when you install, configure and debug a cluster of even seven, like my machines, it will save you a ton of time. <br><br><h5>  Little about the device </h5><br>  Running csync2 is very simple.  The list of all files that you synchronize is stored in a local sqlite database and checked by the timestamp.  It will not work to store hundreds of gigabytes of files there, but he scatters my 5-6 Gb scattered across several tens of thousands of files quite successfully.  If you have more files, do not put csync2 in frequent crowns, it will start a bunch of copies and the servers will start to slow down.  The base csync2 can be cleaned and generally carried out with it all sorts of manipulations.  The program documentation (link below) also indicates the structure of the database used, so there is a lot of scope for creativity. <br><br><h5>  Analogs </h5><br>  There are systems that allow nodes to load remote configs.  I didn't like them, but if you change cars in a cluster every day, you should look at them: <a href="http://wiki.opscode.com/display/chef/Home">Chef</a> , <a href="http://www.puppetlabs.com/">Puppet</a> . <br><br>  ============================ <br>  Useful links: <br>  Csync2 documentation ( <a href="http://oss.linbit.com/csync2/paper.pdf">PDF</a> ) <br>  Official csync2 website: <a href="http://oss.linbit.com/csync2/">http://oss.linbit.com/csync2/</a> </div><p>Source: <a href="https://habr.com/ru/post/120702/">https://habr.com/ru/post/120702/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../120696/index.html">IPv6 Day Scalax Cloud Ready</a></li>
<li><a href="../120697/index.html">The life cycle of cryptographic hash algorithms</a></li>
<li><a href="../120698/index.html">SkypeTab - tabs for Linux Skype. Now for any window manager and panel</a></li>
<li><a href="../120700/index.html">Safe and secure Linux (our response to Chamberlain)</a></li>
<li><a href="../120701/index.html">The axis of evil: what George W. Bush meant or the star wars in the IT world - ‚Äúthe second coming of Apple‚Äù</a></li>
<li><a href="../120703/index.html">Email Marketing Basics</a></li>
<li><a href="../120704/index.html">Smart home: planning and preparing yourself</a></li>
<li><a href="../120706/index.html">Internet sample 1985-1990 (simulator)</a></li>
<li><a href="../120707/index.html">Creating a parser (parser) for context-free grammars</a></li>
<li><a href="../120708/index.html">Taxer - Online Electronic Reporting</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>