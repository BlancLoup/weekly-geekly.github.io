<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bobaos - KNX TP / UART, Raspberry Pi and Apple HomeKit</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this publication, I will show how to set up and run homebridge (implementation of HomeKit Accessory Protocol on nodejs) based on Raspberry Pi, Wein...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bobaos - KNX TP / UART, Raspberry Pi and Apple HomeKit</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/qi/df/j9/qidfj9okqlufa_jbiop9wxbyqna.png"></p><br><p>  In this publication, I will show how to set up and run homebridge (implementation of HomeKit Accessory Protocol on nodejs) based on Raspberry Pi, Weinzierl KNX BAOS 838 module kBerry and bobaos from scratch. </p><a name="habracut"></a><br><h3 id="predvaritelnye-trebovaniya">  Preliminary requirements. </h3><br><ol><li>  Raspberry Pi with <a href="https://www.weinzierl.de/index.php/en/all-knx/knx-module-en/knx-baos-module-838-en">BAOS 838 kBerry</a> module installed. </li><li>  Raspbian with installed: nodejs, npm (in my case raspbian stretch lite, nodejs version 8). </li></ol><br><h3 id="poehali">  Go </h3><br><h4 id="nastraivaem-seriynyy-port">  Configure the serial port </h4><br><p>  For Raspberry Pi 3: </p><br><pre><code class="bash hljs">sudo sh -c <span class="hljs-string"><span class="hljs-string">"echo dtoverlay=pi3-miniuart-bt &gt;&gt;/boot/config.txt"</span></span></code> </pre> <br><p>  From the file / boot / cmdline.txt we remove the entry <strong>console = ttyAMA0,115200</strong> . </p><br><p>  Add a user to the <strong>dialout</strong> group, reboot </p><br><pre> <code class="bash hljs">sudo usermod -a -G dialout pi sudo reboot</code> </pre> <br><h4 id="ustanavlivaem-bdsdsock">  Install bdsd.sock </h4><br><pre> <code class="bash hljs">curl -L https://raw.githubusercontent.com/bobaos/bdsd.sock/master/bdsd_install.sh | bash</code> </pre> <br><p>  Script content: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash sudo npm install -g bdsd.sock --unsafe-perm sudo npm install -g bdsd-cli --unsafe-perm SERVICE_NAME=bdsd.service mkdir $HOME/.config/systemd mkdir $HOME/.config/systemd/user touch $HOME/.config/systemd/user/$SERVICE_NAME SERVICE_PATH=$HOME/.config/systemd/user/$SERVICE_NAME echo "[Unit]" &gt; $SERVICE_PATH echo "Description=Bobaos Datapoint Sdk Daemon" &gt;&gt; $SERVICE_PATH echo "[Service]" &gt;&gt; $SERVICE_PATH echo "ExecStart=/usr/bin/env bdsd.sock" &gt;&gt; $SERVICE_PATH echo "[Install]" &gt;&gt; $SERVICE_PATH echo "WantedBy=default.target" &gt;&gt; $SERVICE_PATH systemctl --user daemon-reload systemctl --user enable $SERVICE_NAME sudo loginctl enable-linger pi systemctl --user start $SERVICE_NAME</span></span></code> </pre> <br><p>  The script will install the latest version of bdsd.sock from npm, create a <strong>bdsd.service</strong> file in <strong>$ HOME / .config / systemd / user /</strong> , configure autorun, start the service. </p><br><p>  We check with bdsd-cli, translate the KNX module into programming mode: </p><br><pre> <code class="bash hljs">bdsd-cli connected bobaos&gt; setProgrammingMode -v 1 Set programming mode: success bobaos&gt;</code> </pre> <br><p>  On the board, the red LED should turn on, indicating that the device is in programming mode.  Go to the next step. </p><br><h4 id="konfiguraciya-v-ets">  Configuration in ETS </h4><br><p>  Any KNX installation is configured in ETS (Engineering Tool Software), ours is no exception.  We are interested in the KNX BAOS 830 appliqu√© from Weinzierl.  Add, customize.  In my case, 4 relays, with objects 101-108. <br>  We write the physical address, further partial loading.  After that go to the next step. </p><br><p><img src="https://habrastorage.org/webt/cd/5p/nd/cd5pndzkt9cs4xq-d7txvv-mtaq.png"></p><br><h4 id="ustanovka-i-nastroyka-homebridge">  Install and configure homebridge </h4><br><p>  Install the <a href="https://github.com/nfarina/homebridge">homebridge</a> from npm: </p><br><pre> <code class="bash hljs">sudo npm install -g homebridge --unsafe-perm</code> </pre> <br><p>  Install <a href="https://github.com/bobaos/homebridge-bobaos">homebridge-bobaos</a> .  At the moment, version 0.0.1, since  The plugin is in the initial stages of development. </p><br><pre> <code class="bash hljs">sudo npm install -g homebridge-bobaos</code> </pre> <br><p>  Next, we need to create a config.json configuration file located in <strong>$ HOME / .homebridge / config.json</strong> . </p><br><p>  Minimum content: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"bridge"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Homebridge"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"CC:22:3D:E1:CE:36"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span>: <span class="hljs-number"><span class="hljs-number">51822</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pin"</span></span>: <span class="hljs-string"><span class="hljs-string">"031-45-154"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"accessories"</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">"platforms"</span></span>: [] }</code> </pre> <br><p>  Next, we need to add the Bobaos platform to the configuration file, register the accessories, services, specifications.  JSON editing manually is quite problematic - unreadable, high probability of error - you can forget quotes, extra commas, nesting.  Therefore, I use YAML for configuration.  A typical config might look like this: </p><br><pre> <code class="hljs pgsql">accessories: - <span class="hljs-type"><span class="hljs-type">name</span></span>: Livroom lights services: - <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Lightbulb <span class="hljs-type"><span class="hljs-type">name</span></span>: Livroom lights <span class="hljs-keyword"><span class="hljs-keyword">characteristics</span></span>: - <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">On</span></span> control: <span class="hljs-number"><span class="hljs-number">101</span></span> status: <span class="hljs-number"><span class="hljs-number">105</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: Livroom lights <span class="hljs-number"><span class="hljs-number">2</span></span> services: - <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Switch <span class="hljs-type"><span class="hljs-type">name</span></span>: Livroom lights <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">characteristics</span></span>: - <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">On</span></span> control: <span class="hljs-number"><span class="hljs-number">102</span></span> status: <span class="hljs-number"><span class="hljs-number">106</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: Kitchen lights services: - <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Lightbulb <span class="hljs-type"><span class="hljs-type">name</span></span>: Kitchen lights <span class="hljs-keyword"><span class="hljs-keyword">characteristics</span></span>: - <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">On</span></span> control: <span class="hljs-number"><span class="hljs-number">6</span></span> status: <span class="hljs-number"><span class="hljs-number">6</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Brightness control: <span class="hljs-number"><span class="hljs-number">2</span></span> status: <span class="hljs-number"><span class="hljs-number">2</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: Kitchen Fan services: - <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Fan <span class="hljs-type"><span class="hljs-type">name</span></span>: Kitchen Fan <span class="hljs-keyword"><span class="hljs-keyword">characteristics</span></span>: - <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">On</span></span> control: <span class="hljs-number"><span class="hljs-number">103</span></span> status: <span class="hljs-number"><span class="hljs-number">107</span></span></code> </pre> <br><p>  There are so few services supported: Switch (On), LightBulb (On, Brightness), Fan (On), in the process of adding the rest. </p><br><p>  We save in a separate file, for example <strong>homebridge.yml</strong> .  Now we need to translate the YAML document in JSON format.  The homebridge-bobaos package includes the genBobaosAccessories utility.  We use it: </p><br><pre> <code class="bash hljs">genBobaosAccessories homebridge.yml ~/.homebridge/config.json { <span class="hljs-string"><span class="hljs-string">"bridge"</span></span>: { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Homebridge"</span></span>, <span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"CC:22:3D:E1:CE:36"</span></span>, <span class="hljs-string"><span class="hljs-string">"port"</span></span>: 51822, <span class="hljs-string"><span class="hljs-string">"pin"</span></span>: <span class="hljs-string"><span class="hljs-string">"031-45-154"</span></span> }, <span class="hljs-string"><span class="hljs-string">"accessories"</span></span>: [], <span class="hljs-string"><span class="hljs-string">"platforms"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"platform"</span></span>: <span class="hljs-string"><span class="hljs-string">"Bobaos"</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"bobaos"</span></span>, <span class="hljs-string"><span class="hljs-string">"accessories"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Livroom lights"</span></span>, <span class="hljs-string"><span class="hljs-string">"services"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"Lightbulb"</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Livroom lights"</span></span>, <span class="hljs-string"><span class="hljs-string">"characteristics"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"On"</span></span>, <span class="hljs-string"><span class="hljs-string">"control"</span></span>: 101, .... ....</code> </pre> <br><p>  The first argument is the yml config file, the second is the existing config.json.  Script parsit both files, add a new one to the list of platforms, if there are no Bobaos platforms, or update an element in the array if present.  If the output of the utility is without errors, redirect to config.json: </p><br><pre> <code class="bash hljs">genBobaosAccessories homebridge.yml ~/.homebridge/config.json &gt; ~/.homebridge/config.json</code> </pre> <br><p>  Start the homebridge and proceed to the next step. </p><br><pre> <code class="bash hljs">homebridge</code> </pre> <br><h4 id="avtozapusk">  Autostart </h4><br><p>  For autorun, configure the systemd service.  To do this, create a service file on the path <strong>$ HOME / .config / systemd / user / homebridge.service</strong> with the following contents: </p><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">Unit</span></span>] Description=Homebridge service [Service] ExecStart=/usr/bin/env homebridge [Install] WantedBy=<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.target</code> </pre> <br><p>  Next, run: </p><br><pre> <code class="bash hljs">systemctl --user daemon-reload systemctl --user start homebridge.service</code> </pre> <br><p>  We are checking.  If everything works well, assign autorun: </p><br><pre> <code class="bash hljs">systemctl --user <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> homebridge.service</code> </pre> <br><p>  This article comes to an end.  It remains to express my gratitude, and say goodbye to this. </p><br><h4 id="predyduschie-publikacii">  Previous publications </h4><br><ol><li>  <a href="https://habr.com/post/346680/">Bobaos - access to the KNX TP / UART bus with the Raspberry Pi</a> </li><li>  <a href="https://habr.com/post/354246/">Bobaos - KNX TP / UART, Raspberry Pi and Unix Domain Socket</a> </li></ol><br><h3 id="blagodarnosti">  Thanks </h3><br><ol><li>  First of all, Weinzierl is for excellent KNX equipment, without it there would not be this project. </li><li>  Raspberry Pi for a great computer. </li><li>  The entire open-source community for Linux, nodejs, git, vim, and so on. </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/354480/">https://habr.com/ru/post/354480/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354468/index.html">Automating log downloads from Kibana to Redmine</a></li>
<li><a href="../354472/index.html">Backup telegram</a></li>
<li><a href="../354474/index.html">Splunk 7.1. What's new? New web interface, integration with Apache Kafka and much more ...</a></li>
<li><a href="../354476/index.html">PDF generation for downloading server configs</a></li>
<li><a href="../354478/index.html">When computers were people ...</a></li>
<li><a href="../354484/index.html">Block the entire Internet, or a monkey with a grenade</a></li>
<li><a href="../354486/index.html">Apache Kafka - my summary</a></li>
<li><a href="../354488/index.html">As an entrepreneur to submit reports on the simplified taxation system</a></li>
<li><a href="../354490/index.html">Configure VPN server (GRE / IPSec StrongSwan, OSPF Quagga)</a></li>
<li><a href="../354492/index.html">How to develop a system that recognizes a person by keyboard writing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>