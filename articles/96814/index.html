<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Linux usb phone howto</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The document describes the installation and configuration of the USB phone for Linux, based on Yealink P1K. As a result, full control of calls from th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Linux usb phone howto</h1><div class="post__text post__text-html js-mediator-article">  The document describes the installation and configuration of the USB phone for Linux, based on Yealink P1K.  As a result, full control of calls from the phone was achieved, without the participation of the mouse and keyboard. <br><br><h5>  Introduction </h5><br>  I always wanted to have a mobile VoIP phone.  This is a phone that is always with you, just like a mobile phone, but at the same time it is a VoIP phone, i.e.  connected to your own IP PBX server (options like Nokia E65 and similar ones are not offered, I don‚Äôt want to warm the ears of mobile Wi-Fi with a microwave, so only USB phones remain).  Windows users live simply, everyone there X-Lite and others include drivers for all kinds of USB phones, and all kinds of USB phones come with a disc with different softphones.  But for those who have Linux on the desktop, the easy ways are ordered But nevertheless, go! <a name="habracut"></a><br><br><h5>  USB phone selection </h5><br>  Googling on ‚Äúlinux usb phone‚Äù showed that practically the only phone that was successfully connected was Yealink P1K USB phone.  At the same time, half of those who tried and could not connect it.  Well, let's try. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Installation </h5><br>  I will not describe the long way done in the process of walking on a rake.  I can only say thanks to Thomas Reitmire, the author of the package Yeaphone <a href="http://www.devbase.at/voip/yeaphone.php">www.devbase.at/voip/yeaphone.php</a> , for his responsiveness and help.  So, to get a mobile VoIP phone, we need the following components: - USB phone P1K - kernel module p1k yealink.ko - softphone linphone.  - package yeaphone. <br><br><h5>  Yealink P1K USB phone and yealink.ko kernel module </h5><br>  Starting with some version of Linux, see section Device drivers ‚Üí Input device support ‚Üí Miscellaneous devices ‚Üí Yealink usb-p1k voip phone.  However, this module is outdated!  It is necessary to take the module from the site of Thomas.  Apparently, this is his home machine, so a copy of the files, relevant at the time of this writing, is attached here (Revision: 142).  As Thomas said: <br><br> <code>You might own a P1KH (USB ID 6993:b700) which uses a slightly different <br> communication protocol compared to the P1K. The P1K is the only model <br> supported by the kernel module shipped with the regular Linux kernel. <br> However if yours is a P1KH (or a B2K, B3G, P4K) then you should try my <br> version of this module: <br> <br> svn co --username guest --password readonly svn://devbase.homelinux.org:5070/voip/yealink-module</code> <br> <br>  This was just my case, and the output of lsusb proved this: <br><br> <code>explorer t2-trunk # lsusb <br> ... <br> Bus 003 Device 019: ID 6993:b700 Freshtel</code> <br> <br>  The module was assembled on my relatively fresh 2.6.31-gentoo without any problems. The assembly is simple: <br><br> <code>max@explorer /tmp/yealink-module/trunk $ make <br> make -C /usr/src/linux SUBDIRS=`pwd` modules <br> make[1]: Entering directory `/usr/src/linux-2.6.31-gentoo-r6' <br> CC [M] /tmp/yealink-module/trunk/yealink.o <br> Building modules, stage 2. <br> MODPOST 1 modules <br> CC /tmp/yealink-module/trunk/yealink.mod.o <br> LD [M] /tmp/yealink-module/trunk/yealink.ko <br> make[1]: Leaving directory `/usr/src/linux-2.6.31-gentoo-r6' <br> max@explorer /tmp/yealink-module/trunk $</code> <br> <br>  The resulting file must be sent to the right place: <br><br> <code>cp yealink.ko /lib/modules/2.6.31-gentoo-r6/kernel/drivers/input/</code> <br> <br><h5>  Softphone linphone and yeaphone wrapper </h5><br>  Another ‚Äúfalse road‚Äù is the linphone softphone version.  The fact is that all the packages published on the sites are for versions of the 2.x branch, and all the latest distributions install the linphone version 3.x.  For example, I have net-voip / linphone-3.1.1 installed.  The version of the yeaphone build is related to the version, something like this: <br><br> <code>home/adyna/Desktop/yeaphone-0.1.6/src/ylcontrol.c:578: undefined reference to `gstate_get_state' <br> /home/adyna/Desktop/yeaphone-0.1.6/src/ylcontrol.c:579: undefined reference to `gstate_get_state' <br> /home/adyna/Desktop/yeaphone-0.1.6/src/ylcontrol.c:580: undefined reference to `gstate_get_state'</code> <br> <br>  The fact is that in the 3rd branch changed the API.  Thomas made the patch, but for some reason did not update the tar.gz packages, and the normally compiled code is only in svn.  If there is any problem with the assembly, I recommend reading the comments section on the Thomas website.  For your convenience, also attached to the article and the package with yaphone. <br><br><h5>  Fighting usbhid </h5><br>  Even after I got everything together, trying to start yaphone led to the message: <br><br> <code>No appropriate handset found, exiting...</code> <br> <br>  And it looked like this: <br><br> <code>usbcore: registered new interface driver yealink <br> yealink: Yealink phone driver: 20090418 (C) Thomas Reitmayr, Henk Vergonet <br> usb 3-1: USB disconnect, address 22 <br> usb 3-1: new full speed USB device using uhci_hcd and address 23 <br> usb 3-1: configuration #1 chosen from 1 choice <br> generic-usb 0003:6993:B700.0020: hiddev0,hidraw3: USB HID v1.10 Device [Yealink Network Technology Ltd. VOIP USB Phone ] on usb-0000:00:1a.1-1/input3</code> <br> <br>  The thing is that the usbhid module "takes" the device for itself, and the yealink module does not see it.  If we ship the usbhid module (attention, we are left without a mouse), and temporarily move usbhid.ko, say to tmp, reload the yealink module, and plug in the phone, the dmesg message will be like this: <br><br> <code>yealink: Yealink phone driver: 20090418 (C) Thomas Reitmayr, Henk Vergonet <br> usb 3-1: new full speed USB device using uhci_hcd and address 19 <br> usb 3-1: configuration #1 chosen from 1 choice <br> yealink: Detected Model USB-P1KH (Version 0x1005) <br> yealink: Serial Number ff0adb4abc96 <br> input: Yealink USB-P1KH as /devices/pci0000:00/0000:00:1a.1/usb3/3-1/3-1:1.3/input/input20</code> <br> <br>  As you can see, the phone was determined, and showed its serial number.  In order not to have to play manually with the module each time, you need to add a rule to udev, which will call the script, ‚Äúunlink‚Äù the phone from usbhid and ‚Äúattach‚Äù it to yealink.  The script is given in the appendix, but the output of his work: <br><br> <code>explorer /tmp # sh /tmp/rebind-yealink.sh <br> Found Yealink phone at /sys/devices/pci0000:00/0000:00:1a.1/usb3/3-1 <br> found HID interface at 3-1:1.3 <br> successfully detached driver 'usbhid' <br> successfully reattached driver 'yealink' <br> explorer /tmp #</code> <br> <br>  The output of dmesg will confirm that everything went well. <br><br><h5>  udev and permissions </h5><br>  The final touch is the adaptation /etc/udev/rules.d/99-yealink.rules <br><br> <code>explorer ~ # cat /etc/udev/rules.d/99-yealink.rules <br> KERNEL=="event*", ATTRS{name}=="Yealink*", GROUP="max", RUN+="/bin/sh -c '/bin/chgrp max /sys$env{DEVPATH}/device/device/*'" <br> ACTION=="add|change", SUBSYSTEMS=="usb", ATTRS{idVendor}=="6993", ATTRS{idProduct}=="b700", RUN+="/usr/local/sbin/rebind-yealink.sh"</code> <br> <br>  Please note that instead of max you need to insert the group under which your account works.  To see your groups, run the groups command.  Script rebind-yealink.sh is in the application.  If at startup the phone issues something like this: <br><br> <code>opmascha@explorer ~ $ yeaphone <br> path_sysfs = /sys/bus/usb/drivers/yealink/5-1:1.3/ <br> path_event = /dev/input/event11 <br> /sys/bus/usb/drivers/yealink/5-1:1.3/model: Permission denied <br> Detected handset Yealink USB-P1K <br> /sys/bus/usb/drivers/yealink/5-1:1.3/line2: Permission denied <br> /sys/bus/usb/drivers/yealink/5-1:1.3/line1: Permission denied <br> /sys/bus/usb/drivers/yealink/5-1:1.3/line3: Permission denied <br> /sys/bus/usb/drivers/yealink/5-1:1.3/hide_icon: Permission denied</code> <br> <br>  This means that it is necessary to deal with 99-yealink.rules - it either does not work out because of a syntax error, or an error is made in the account.  cd / sys / bus / usb / and watch permissions. <br><br><h5>  Startup </h5><br>  Register the start of the phone in a startup (rc.local, local.start or as it is correct in your distribution): <br><br> <code>su - max -c '/usr/local/bin/yeaphone -w' &gt; /dev/null 2&gt;&amp;1 &amp;</code> <br> <br>  Here you also need to change the max to the name of your account. <br><br><h5>  Customization </h5><br>  After installing all the components, you can proceed to setup.  You need to configure: <br><ul><li>  SIP account (by the way, this is one of the limitations: if linphone supports an unlimited number of accounts, then yeaphone is only one, since it doesn‚Äôt know how to sort through them); </li><li>  Audio Device - USB VoIP Phone </li><li>  additional  yaphone settings (ringtone, dialing options, etc.). </li></ul><br><h5>  SIP account </h5><br><ul><li>  This can be done in two ways: </li><li>  Run the linphone-3 GUI (if compiled), and set up an account in it. </li><li>  perform configuration from the console.  Let's give an example from the console: </li></ul><br> <code>linphonec&gt; proxy add <br> Adding new proxy setup. Hit ^D to abort. <br> Enter proxy sip address: sip:sipnet.ru <br> Your identity for this proxy: sip:1234567890@sipnet.ru <br> Do you want to register on this proxy (yes/no): yes <br> Specify register expiration time in seconds (default is 600): 180 <br> Expiration: 180 seconds <br> Specify route if needed: <br> No route specified. <br> -------------------------------------------- <br> sip address: sip:sipnet.ru <br> route: <br> identity: sip:1234567890@sipnet.ru <br> register: yes <br> expires: 180 <br> registered: no <br> -------------------------------------------- <br> Accept the above proxy configuration (yes/no) ?: yes <br> Proxy added. <br> linphonec&gt; Registration on sip:sipnet.ru successful. <br> linphonec&gt; Registration on sip:sipnet.ru successful. <br> linphonec&gt;</code> <br> <br><h5>  Audio configuration </h5><br>  Next, you need to configure your audio device.  If you are going to GTK interface, you can do it in it, otherwise as follows: <br><br> <code>linphonec&gt; soundcard list <br> 0: ALSA: default device <br> 1: ALSA: HDA Intel <br> 2: ALSA: VOIP USB Phone <br> linphonec&gt; soundcard use 2 <br> Using sound device ALSA: VOIP USB Phone <br> linphonec&gt;</code> <br> <br>  This command will set all audio channels (playback, capture &amp; ring) to use the USB of the phone. <br><br><h5>  Setting Yeaphone </h5><br>  Well, in conclusion, I will give an example of settings.  The ~ / .yeahonerc file contains the configuration, and the ~ / .yaphone / ringtone / folder contains ringtones. <br><br> <code>max@explorer /tmp $ cat ~/.yeaphonerc <br> intl-access-code 810 <br> natl-access-code 8 <br> country-code 7 <br> display-id " --123--" <br> ringtone_default default_p1k.bin <br> #ringtone_default default_p1kh.bin <br> #ringtone_default falling2_p1k.bin <br> #ringtone_default falling_p1k.bin <br> #ringtone_default rising_p1k.bin <br> #ringtone_default special_p1k.bin</code> <br> <br>  Ringtones are nasty, it would be great if someone added their own more melodic ones, like ‚Äúa grasshopper was sitting in the grass‚Äù ... <br>  Also, you need to make sure that only one proxy server is configured, and it is also selected as default in the ~ / .linphonerc file.  If you receive such a message <br><br> <code>Warning: Could not parse given sip address. A sip url usually looks like sip:user@domain</code> <br> <br>  This means that you need to edit the pens ~ / .linphonerc. <br><br><h5>  Conclusion </h5><br>  As a result, as soon as I connect the USB phone Skype mate P1K to my laptop, for a maximum of 10 seconds it connects to the server.  As soon as I pull out the USB cable from the laptop, the softphone removes the registration.  For the 3rd day of operation no problems were found. <br><br><h5>  Applications </h5><br>  <a href="http://asteriskpbx.ru/raw-attachment/wiki/voip-linux-usb-phone-p1k-howto/99-yealink.rules">Udev rules</a> <br>  <a href="">Script for udev on webhid phone weaning</a> <br>  <a href="">Yaphone 0.1.8</a> <br>  <a href="">Core module</a> </div><p>Source: <a href="https://habr.com/ru/post/96814/">https://habr.com/ru/post/96814/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../96806/index.html">Kaspersky in Uryupinsk: Internet in the forest</a></li>
<li><a href="../96808/index.html">Toshiba Satellite T230 and T210</a></li>
<li><a href="../96810/index.html">Recommendations for designing user interfaces (according to the book by Ruskin "Interface"). Part 1</a></li>
<li><a href="../96811/index.html">Aptana Studio 3 Beta Release</a></li>
<li><a href="../96813/index.html">Visual Studio 2010 Competition</a></li>
<li><a href="../96815/index.html">Forismatic. Android application</a></li>
<li><a href="../96817/index.html">On the illegitimacy of copyright</a></li>
<li><a href="../96818/index.html">Cardapio is a great replacement for the Ubuntu main menu.</a></li>
<li><a href="../96820/index.html">Rating of domain zones according to Verisign</a></li>
<li><a href="../96821/index.html">Updated free fonts for Linux Libertine, Linux Biolinum, as well as some of the Arkandis Digital Foundry fonts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>