<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How Reddit created r / Place</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Several teams worked on the project - frontend, backend, mobile development. For the most part, it was implemented on technologies that already existe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How Reddit created r / Place</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/0f4/7c9/e58/0f47c9e58d7a480abc028db4a40b22e3.png" alt="enter image description here"></p><br><p>  Several teams worked on the project - frontend, backend, mobile development.  For the most part, it was implemented on technologies that already existed in Reddit.  In this article we will look at how Place was created from the technical side.  If you want to see the Place code, then <a href="http://github.com/reddit/reddit-plugin-place-opensource">it is here</a> . </p><a name="habracut"></a><br><h3 id="trebovaniya">  Requirements </h3><br><p>  To begin with, it was extremely important to determine the requirements for the April Fools project, because it was necessary to start it without ‚Äúoverclocking‚Äù, so that all Reddit users could immediately access it.  If he had not worked perfectly from the very beginning, he would hardly have attracted the attention of a large number of people. </p><br><ul><li><p>  The board must be 1000x1000 tiles in order to look very large. </p><br></li><li><p>  All clients must be synchronized and display a single board status.  After all, if different users have different versions, it will be difficult for them to interact. </p><br></li><li><p>  You need to support at least 100,000 users at the same time. </p><br></li><li><p>  Users can post one tile per five minutes.  Therefore, it is necessary to maintain an average update rate of 100,000 tiles per five minutes (333 updates per second). </p><br></li><li><p>  The project should not adversely affect the operation of the other parts and functions of the site (even if the traffic is high at r / Place). </p><br></li><li>  In the event of unforeseen bottlenecks or failures, flexible configuration is necessary.  That is, you need to be able to adjust the size of the board and the allowed drawing frequency on the fly, if the data volume is too large or the update frequency is too high. </li></ul><br><h3 id="bekend">  Backend </h3><br><h4 id="resheniya-po-realizacii">  Implementation Solutions </h4><br><p>  The main difficulty in creating the backend was to synchronize the board status display for all clients.  It was decided to make clients listen in real time to the events of placing tiles and immediately request the status of the entire board.  Having a slightly outdated full state is valid in the case of a subscription to updates before this full state has been generated.  When the client receives the full status, it displays all the tiles that he received during the wait;  all subsequent tiles should be displayed on the board immediately upon receipt. </p><br><p>  For this scheme to work, the request for the complete state of the board must be executed as quickly as possible.  At first, we wanted to store the entire board on <a href="https://pandaforme.gitbooks.io/introduction-to-cassandra/content/understand_the_cassandra_data_model.html">one line in Cassandra</a> , and for each query to simply read this line.  The format of each column in this line was: </p><br><pre><code class="hljs mel">(x, y): {<span class="hljs-string"><span class="hljs-string">'timestamp'</span></span>: epochms, <span class="hljs-string"><span class="hljs-string">'author'</span></span>: user_name, <span class="hljs-string"><span class="hljs-string">'color'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">color</span></span>}</code> </pre> <br><p>  But since the board contains a million tiles, we needed to read a million columns.  In our work cluster, this took up to 30 seconds, which was unacceptable and could lead to an excessive load on Cassandra. </p><br><p>  Then we decided to keep the whole board in Redis.  We took a bit field per million of four-bit numbers, each of which could encode a four-bit color, and the x and y coordinates were determined by the offset ( <code>offset = x + 1000y</code> ) in the bit field.  To obtain the full state of the board, it was necessary to count the entire bit field. </p><br><p>  It was possible to update the tiles by updating the values ‚Äã‚Äãwith specific offsets (no need to block or carry out the whole read / update / write procedure).  But all the details still need to be stored in Cassandra, so that users can find out who and when placed each of the tiles.  We also planned to use Cassandra to restore the board when Redis crashes.  Reading the entire board from it took less than 100 ms, which was fast enough. </p><br><p>  <em>Here is how we stored the colors in Redis using the 2x2 board as an example:</em> </p><br><p><img src="https://habrastorage.org/files/fbf/48c/9d6/fbf48c9d6fc54c19afba5ccd3a6588a2.png" alt="enter image description here"></p><br><p>  We were worried that we could rest against reading throughput in Redis.  If many clients were simultaneously connected or updated, then all of them simultaneously sent requests for a full board status.  Since the board was a general global state, the obvious solution was to use caching.  We decided to cache at the CDN (Fastly) level, because it was easier to implement, and the cache was the closest to the clients, which reduced the time for receiving the answer. </p><br><p>  Full board status requests were cached Fastly with a timeout per second.  To prevent a large number of requests when the timeout expires, we used the <a href="https://docs.fastly.com/guides/performance-tuning/serving-stale-content"><code>stale-while-revalidate</code></a> .  <a href="https://www.fastly.com/network-map">Fastly supports about 33 POPs,</a> which independently carry out caching, so we expected to receive up to 33 requests for the full state of the board per second. </p><br><p>  For the publication of updates for all clients, we used our <a href="https://github.com/reddit/reddit-service-websockets">web service</a> .  Before that, we successfully used it to make <a href="https://www.reddit.com/live">Reddit.Live</a> work with more than 100,000 simultaneous users for notifications about personal messages in Live and other features.  The service was also the cornerstone of our past April Fools projects - The Button and Robin.  In the case of r / Place, clients supported web socket connections to receive updates about real-time tile placement. </p><br><h3 id="api">  API </h3><br><h4 id="poluchenie-polnogo-sostoyaniya-doski">  Getting full board status </h4><br><p><img src="https://habrastorage.org/files/c6b/c1b/5e7/c6bc1b5e76f443d5867d93cd0fb120c0.png" alt="enter image description here"></p><br><p>  At first, requests got into Fastly.  If he had a valid copy of the board, he immediately returned it without contacting the Reddit application servers.  If not, or the copy was too old, then the Reddit application read the complete board from Redis and returned it to Fastly so that it caches and returns to the client. </p><br><p>  <em>The frequency of requests and response times measured by the Reddit application:</em> </p><br><p><img src="https://habrastorage.org/files/16e/ee3/8bc/16eee38bcb1c43d99700a9d1425e2dcd.png" alt="enter image description here"></p><br><p>  Note that the request rate never reached 33 per second, that is, caching with Fastly was a very effective means of protecting the Reddit application from most requests. </p><br><p><img src="https://habrastorage.org/files/245/f4c/700/245f4c7007914e29a61c9c8cef1f0fdb.png" alt="enter image description here"></p><br><p>  And when requests still reached the application, Redis responded very quickly. </p><br><h4 id="otrisovka-tayla">  Tile rendering </h4><br><p><img src="https://habrastorage.org/files/7ce/d3f/c1e/7ced3fc1e0e7426592a3d1afe77543d5.png" alt="enter image description here"></p><br><p>  Tile rendering stages: </p><br><ol><li>  From Cassandra, the timestamp of the last placement by the user of the tile is read.  If it was less than five minutes ago, then we do nothing, and an error is returned to the user. </li><li>  Details about the tile are recorded in Redis and Cassandra. </li><li>  The current time is recorded in Cassandra as the last tile placement by the user. </li><li>  The web socket service sends a message about the new tile to all connected clients. </li></ol><br><p>  In order to maintain strict consistency, all writing and reading in Cassandra was performed using <a href="http://docs.datastax.com/en/archived/cassandra/1.2/cassandra/dml/dml_config_consistency_c.html">QUORUM consistency level</a> . </p><br><p>  In fact, here we had a race, because of which users could place several tiles at a time.  At stages 1-3, there was no blocking, so simultaneous attempts to draw tiles could be checked at the first stage and be drawn at the second.  It seems that some users discovered this bug (or they used bots that neglected the limit on the frequency of sending requests) - and as a result, about 15,000 tiles were placed (~ 0.09% of the total). </p><br><p>  <em>The frequency of requests and response times measured by the Reddit application:</em> </p><br><p><img src="https://habrastorage.org/files/360/16d/850/36016d850d0349d88b12e971c372a723.png" alt="enter image description here"></p><br><p>  The peak frequency of placing tiles was almost 200 per second.  This is below our calculated limit of 333 tiles / s (average value, provided that 100,000 users post their tiles every five minutes). </p><br><p><img src="https://habrastorage.org/files/ecd/ca9/7a7/ecdca97a7ee64bf5ad6c982938365598.png" alt="enter image description here"></p><br><h4 id="poluchenie-podrobnostey-po-konkretnomu-taylu">  Get details on a specific tile </h4><br><p><img src="https://habrastorage.org/files/12f/b92/563/12fb925631094e738354c4ad3b186320.png" alt="enter image description here"></p><br><p>  When requesting specific tiles, the data was read directly from Cassandra. </p><br><p>  <em>The frequency of requests and response times measured by the Reddit application:</em> </p><br><p><img src="https://habrastorage.org/files/49b/157/286/49b157286eed4041962eae41c0337de8.png" alt="enter image description here"></p><br><p>  This query has proven very popular.  In addition to regular client requests, people wrote scripts to extract the entire board one tile at a time.  Since this request was not cached in the CDN, all requests were serviced by the Reddit application. </p><br><p><img src="https://habrastorage.org/files/730/443/62b/73044362b2b44ab0805a5fad19639cdd.png" alt="enter image description here"></p><br><p>  The response time to these requests was rather short and kept at the same level during the whole existence of the project. </p><br><h4 id="vebsokety">  Web sockets </h4><br><p>  We do not have separate metrics showing how r / Place influenced the work of the web socket service.  But we can estimate the values ‚Äã‚Äãby comparing the data before the launch of the project and after its completion. </p><br><p>  <em>Total number of connections to the web service:</em> </p><br><p><img src="https://habrastorage.org/files/7f0/a07/fdb/7f0a07fdbf164baba18d5f3749fad963.png" alt="enter image description here"></p><br><p>  The base load before launching r / Place was about 20,000 connections, the peak being 100,000 connections.  So at the peak we probably had about 80,000 users simultaneously connected to r / Place. </p><br><p>  <em>Bandwidth of a web socket service:</em> </p><br><p><img src="https://habrastorage.org/files/b72/cfb/6d4/b72cfb6d4b054a538711d760008d1448.png" alt="enter image description here"></p><br><p>  At the peak of the load on r / Place, the website service transmitted more than 4 Gbit / s (150 Mbit / s for each instance, a total of 24 instances). </p><br><h3 id="frontend-veb--i-mobilnye-klienty">  Front-end: web and mobile clients </h3><br><p>  In the process of creating a frontend for Place, we had to solve many complex problems associated with cross-platform development.  We wanted the project to work equally on all major platforms, including desktops and mobile devices on iOS and Android. </p><br><p>  The user interface had three important functions: </p><br><ol><li>  Display board status in real time. </li><li>  Allow users to interact with the board. </li><li>  Work on all platforms, including mobile applications. </li></ol><br><p>  The main interface object was the canvas, and the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API">Canvas API</a> was perfect for it.  We used a <code>&lt;canvas&gt;</code> element of <code>&lt;canvas&gt;</code> size, and each tile was drawn as a single pixel. </p><br><h3 id="otrisovka-kanvasa">  Canvas drawing </h3><br><p>  Canvas was supposed to reflect the state of the board in real time.  It was necessary to draw the entire board when loading the page and to draw the updates coming through the web sockets.  The canvas element using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D"><code>CanvasRenderingContext2D</code></a> interface can be updated in three ways: </p><br><ol><li>  Draw an existing image in canvas with <a href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/drawImage"><code>drawImage()</code></a> . </li><li>  Draw forms using different form rendering methods.  For example, <a href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/fillRect"><code>fillRect()</code></a> fills a rectangle with some color. </li><li>  Construct an <code>ImageData</code> object and draw it in a canvas using <a href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/putImageData"><code>putImageData()</code></a> . </li></ol><br><p>  The first option did not suit us, because we did not have a board in the form of a finished image.  Options 2 and 3 remained. The easiest way was to update the individual tiles with <code>fillRect()</code> : when the update comes through the web socket, simply draw a 1x1 rectangle on the position (x, y).  In general, the method worked, but was not very convenient for drawing the initial state of the board.  The <code>putImageData()</code> method came up much better: we could define the color of each pixel in a single <code>ImageData</code> object and draw the entire canvas at a time. </p><br><h4 id="otrisovka-nachalnogo-sostoyaniya-doski">  Drawing the initial state of the board </h4><br><p>  Using <code>putImageData()</code> requires determining the state of the board as <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8ClampedArray"><code>Uint8ClampedArray</code></a> , where each value is an eight-bit unsigned number in the range from 0 to 255. Each value represents a color channel (red, green, blue, alpha), and for each pixel you need four element in the array.  For a 2x2 canvas, a 16-byte array is needed, in which the first four bytes represent the upper left pixel of the canvas, and the last four are the lower right. </p><br><p>  <em>This shows how the pixels of the canvas are related to their Uint8ClampedArray views:</em> </p><br><p><img src="https://habrastorage.org/files/5d9/738/4f0/5d97384f09ef4b648f3b5a97338b5199.png" alt="enter image description here"></p><br><p>  For the canvas of our project, we needed an array of four million bytes - 4 MB. </p><br><p>  In the backend, the state of the board is stored as a four-bit bit field.  Each color is represented by a number from 0 to 15, which allowed us to pack two pixels in each byte.  To use it on a client device, you need to do three things: </p><br><ol><li>  To transfer to the client binary data from our API. </li><li>  Unpack the data. </li><li>  Convert four-bit colors to 32-bit. </li></ol><br><p>  To transfer binary data, we used the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API"><code>Fetch API</code></a> in those browsers that support it.  And in those that do not support, they used <a href="https://www.youtube.com/watch%3Fv%3DPubd-spHN-0"><code>XMLHttpRequest</code></a> with a <code>responseType</code> that has the value <code>‚Äúarraybuffer‚Äù</code> . </p><br><p>  The binary data received from the API contains two pixels in each byte.  The smallest constructor <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray"><code>TypedArray</code></a> that we had, allows you to work with binary data in the form of single-byte units.  But they are inconvenient to use on client devices, so we unpacked the data to make it easier to work with.  The process is simple: we iterate over the packed data, pull out the bits and bits, and then copy them into separate bytes into another array. </p><br><p>  Finally, four-bit colors needed to be converted to 32-bit. </p><br><p><img src="https://habrastorage.org/files/890/500/cb8/890500cb8f6b4dfd82ea1f708753935b.png" alt="enter image description here"></p><br><p>  The <code>ImageData</code> structure that we needed to use <code>putImageData()</code> requires that the final result be in the form of a <code>Uint8ClampedArray</code> with bytes encoding the color channels in the RGBA order.  This means that we needed to do another unpacking, breaking each color into component channel bytes and putting them in the correct index.  It's not very convenient to make four entries per pixel.  But fortunately, there was another option. </p><br><p>  <code>TypedArray</code> objects are essentially <code>ArrayBuffer</code> representations in the form of arrays.  There is one nuance: multiple <code>TypedArray</code> instances can read and write to the same <code>ArrayBuffer</code> instance.  Instead of writing four values ‚Äã‚Äãto an eight-bit array, we can write one value to 32-bit!  Using <code>Uint32Array</code> for writing, we were able to easily update tile colors by simply updating one array index.  True, we had to save our color palette in reverse byte order (ABGR), so that the bytes automatically fall into the right places when read using <code>Uint8ClampedArray</code> . </p><br><p><img src="https://habrastorage.org/files/f10/6bd/3d0/f106bd3d01b84a699a11d40a5904c6bd.png" alt="enter image description here"></p><br><h4 id="obrabotka-obnovleniy-poluchennyh-cherez-vebsoket">  Processing updates received via the web socket </h4><br><p>  The <code>drawRect()</code> method was well suited for drawing updates on individual pixels as they were received, but there was one weak point: large portions of updates coming at the same time could cause braking in browsers.  And we understood that updates to the state of the board can come very often, so the problem had to be somehow solved. </p><br><p>  Instead of immediately redrawing the canvas every time we receive an update via a web socket, we decided to make it so that web updates that come at the same time can be bundled and immediately drawn in a crowd.  For this, two changes were made: </p><br><ol><li>  Terminating the use of <code>drawRect()</code> - we have found a convenient way to update many pixels at once with <code>putImageData()</code> . </li><li>  Moving canvas rendering to the requestAnimationFrame loop. </li></ol><br><p>  Thanks to the transfer of the rendering to the animation loop, we were able to immediately record the web sock-update into the <code>ArrayBuffer</code> , while postponing the actual rendering.  All website updates coming between frames (about 16 ms) were combined into packages and rendered simultaneously.  Using <code>requestAnimationFrame</code> , if drawing took too much time (longer than 16 ms), it would only affect the refresh rate of the canvas (and would not degrade the performance of the entire browser). </p><br><h3 id="vzaimodeystvie-s-kanvasom">  Interaction with Canvas </h3><br><p>  It is important to note that the canvas were needed to make it easier for users to interact with the system.  The main interaction scenario is placement of tiles on canvas. </p><br><p>  But it would be extremely difficult to do accurate rendering of each pixel on a 1: 1 scale, and we would not avoid errors.  So we needed a zoom (big!).  In addition, users needed the ability to easily navigate the canvas, because it was too large for most screens (especially when using the zoom). </p><br><h4 id="zum">  Zoom </h4><br><p>  Since users could place tiles once every five minutes, errors in placement would be especially unpleasant for them.  It was necessary to realize a zoom of such a multiplicity, so that the tile would be large enough, and it could be easily placed in the right place.  This was especially important on touchscreen devices. </p><br><p>  We implemented a 40x zoom, that is, each tile had a size of 40x40.  We wrapped the <code>&lt;canvas&gt;</code> in a <code>&lt;div&gt;</code> , to which we applied the CSS <code>transform: scale(40, 40)</code> .  It was a great solution for placing tiles, but made it difficult to view the board (especially on small screens), so we made a two-step zoom: 40x - for drawing tiles, 4x - for viewing the board. </p><br><p>  Using CSS to scale the canvas made it easy to separate the code responsible for drawing the board from the code responsible for scaling.  But this approach had several drawbacks.  When scaling a picture (canvas), browsers by default use image smoothing algorithms.  In some cases, it does not cause inconvenience, but pixel graphics simply destroys it, turning it into soapy porridge.  The good news is the CSS <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/image-rendering"><code>image-rendering</code></a> property, with which we were able to ‚Äúask‚Äù browsers not to apply anti-aliasing.  The bad news is that not all browsers have full support for this property. </p><br><p>  <em>Blur at zoom:</em> </p><br><p><img src="https://habrastorage.org/files/756/777/94a/75677794a1fb45b5b1ab90bcab3fd798.png" alt="enter image description here"></p><br><p>  For such browsers, it was necessary to find another way to scale.  I mentioned above that there are three ways to draw in canvas.  The first, <code>drawImage()</code> , supports the rendering of an existing image or another canvas.  It also supports image scaling when drawing (with increasing or decreasing).  And although the increase has the same blurring problems as the above-mentioned CSS, they can be solved in a more universal way from the point of view of browser support by removing the <a href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/imageSmoothingEnabled"><code>CanvasRenderingContext2D.imageSmoothingEnabled</code></a> flag. </p><br><p>  So, we solved the problem with blur of canvas, adding another step to the rendering process.  To do this, we have made another <code>&lt;canvas&gt;</code> element that coincides in size and position with the container element (that is, with the visible area of ‚Äã‚Äãthe board).  After redrawing the canvas with <code>drawImage()</code> , the visible part of it is drawn at the desired scale in the new canvas.  Since this additional step slightly increases the rendering cost, we only used it in browsers that do not support the <code>image-rendering</code> CSS property. </p><br><h3 id="peremeschenie-po-kanvasu">  Canvas moving </h3><br><p>  Canvas is a rather large image, especially in approximate form, so we needed to provide the ability to move around it.  To adjust the position of the canvas on the screen, we applied the same approach as in the case of scaling: we wrapped the <code>&lt;canvas&gt;</code> in another <code>&lt;div&gt;</code> , to which we applied the CSS <code>transform: translate(x, y)</code> .  Thanks to a separate div, we were able to easily manage the order of transformations to the canvas, which was necessary to prevent the ‚Äúcamera‚Äù from moving when the zoom was changed. </p><br><p>  As a result, we have provided support for various ways to adjust the position of the ‚Äúcamera‚Äù: </p><br><ul><li>  Click and drag (click-and-drag, or touch-to-drag); </li><li>  "Click to move" (click-to-move); </li><li>  keyboard navigation. </li></ul><br><p>  Each of these methods is implemented differently. </p><br><h4 id="nazhat-i-peretaschit">  "Click and drag" </h4><br><p>  This is the primary way to navigate.  We saved the <code>x</code> and <code>y</code> coordinates of the <code>mousedown</code> event.  For each of these events, we found the offset position of the mouse cursor relative to the initial position, and then added this offset to the existing displacement of the canvas.  The camera position was immediately updated, so the navigation was very responsive. </p><br><h4 id="nazhat-dlya-peremescheniya">  "Click to move" </h4><br><p>  When clicking on a tile, it was placed in the center of the screen.  To implement this mechanism, we had to track the distance between the <code>mousedown</code> and <code>mouseup</code> events in order to separate the ‚Äúclicks‚Äù from the ‚Äúmoves‚Äù.  If the distance the mouse moved was not enough to be considered a ‚Äúmove‚Äù, the position of the ‚Äúcamera‚Äù changed based on the difference between the position of the mouse and the point in the center of the screen.  Unlike the previous navigation method, the ‚Äúcamera‚Äù position was updated using the smoothness function.  Instead of immediately setting a new position, we saved it as a ‚Äútarget‚Äù one.  Inside the animation loop (the same one that was used to redraw the canvas), the current position of the ‚Äúcamera‚Äù was moved closer to the target using the smoothness function.  This allowed to get rid of the effect of too sharp movement. </p><br><h4 id="navigaciya-s-klaviatury">  Keyboard navigation </h4><br><p>  You could navigate the canvas using the keyboard arrows or WASD.  These keys controlled the internal motion vector.  If none of the keys were pressed, then the default vector had coordinates (0, 0).  Pressing any of the navigation keys adds 1 to <code>x</code> or <code>y.</code>  For example, if you press "right" and "up", then the coordinates of the vector will be (1, -1).  Then this vector was used inside the animation loop to move the ‚Äúcamera‚Äù. </p><br><p>  In the process of animation, the speed of movement was calculated depending on the level of approximation using the following formula: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">movementSpeed</span></span> = maxZoom / currentZoom * speedMultiplier</code> </pre> <br><p>  When the zoom was turned off, it was faster and much more natural to control the buttons. </p><br><p>  Then the motion vector was normalized, multiplied by the speed of movement and applied to the current position of the ‚Äúcamera‚Äù.  Normalization was used so that the speed of the diagonal and orthogonal displacements coincided.  Finally, we applied the smoothness function to changes in the motion vector itself.       ,   ¬´¬ª   <a href="https://www.youtube.com/watch%3Fv%3DFy0aCDmgnxg"></a> . </p><br><h3 id="podderzhka-mobilnyh-prilozheniy">    </h3><br><p>     iOS-  Android-     . -,     ,     .    -,     ,      OAuth:         WebView   .           OAuth  JS-    WebView.         .           API: </p><br><pre> <code class="hljs cs">r.place.injectHeaders({<span class="hljs-string"><span class="hljs-string">'Authorization'</span></span>: <span class="hljs-string"><span class="hljs-string">'Bearer &lt;access token&gt;'</span></span>});</code> </pre> <br><p>    iOS     ,         .      WebView,      .  ,  iOS 8        JS-: </p><br><pre> <code class="hljs kotlin">webkit.messageHandlers.tilePlacedHandler.postMessage(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.cooldown / <span class="hljs-number"><span class="hljs-number">1000</span></span>);</code> </pre> <br><p>             . </p><br><p><img src="https://habrastorage.org/files/7e8/8af/521/7e88af5218af48d6aa7ca436e0634480.png" alt="enter image description here"></p><br><h3 id="chto-my-uznali">    </h3><br><h4 id="vsegda-chto-to-upuskaesh-iz-vidu">  -    </h4><br><p>    .  ,   .       .         . , ,      - . ? </p><br><p>    .        r/Place         : </p><br><p><img src="https://habrastorage.org/files/faf/53f/0bb/faf53f0bb2c04a6ca8266d055d5e1d96.png" alt="enter image description here"></p><br><p><img src="https://habrastorage.org/files/c61/759/337/c617593377764bd188bad05942aa5517.png" alt="enter image description here"></p><br><p>   .    ,          .  ,      . ,    ,     : </p><br><p><img src="https://habrastorage.org/files/3f2/38b/f12/3f238bf1240647eea1e10cdcdbd0b612.png" alt="enter image description here"></p><br><p>   ,    ,     .   ¬´¬ª    ?  ,   Place        ,   .  ,      ,             Live-  . ,  ,      ,      .        . </p><br><p>  ,     :  ‚Äì    .             . </p><br><p>    : </p><br><p><img src="https://habrastorage.org/files/88c/295/19a/88c29519a4fe4209b5cca988222e5849.png" alt="enter image description here"></p><br><p>   ,  .     ,     production- RabbitMQ,    -,    ,     reddit.com.    .  . </p><br><p>   ,              .    - ,   ,      <a href="https://github.com/python-diamond/Diamond/blob/master/src/collectors/rabbitmq/rabbitmq.py">Rabbit Diamond collector</a> .  ,    ,     -,     ,      ,    Rabbit,       .      ‚Äì   . </p><br><p>       ,        : </p><br><pre> <code class="hljs javascript">$ cat s****y_diamond.sh #!<span class="hljs-regexp"><span class="hljs-regexp">/bin/</span></span>bash /usr/sbin/rabbitmqctl list_queues | <span class="hljs-regexp"><span class="hljs-regexp">/usr/</span></span>bin/awk <span class="hljs-string"><span class="hljs-string">'$2~/[0-9]/{print "servers.foo.bar.rabbit.rabbitmq.queues." $1 ".messages " $2 " " systime()}'</span></span> | <span class="hljs-regexp"><span class="hljs-regexp">/bin/g</span></span>rep -v <span class="hljs-string"><span class="hljs-string">'amq.gen'</span></span> | <span class="hljs-regexp"><span class="hljs-regexp">/bin/</span></span>nc <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> <span class="hljs-number"><span class="hljs-number">2013</span></span></code> </pre> <br><p>   ,     -  ,   :       .       -        . </p><br><p>  ,    : </p><br><p><img src="https://habrastorage.org/files/b34/af4/0ba/b34af40ba7c94d22b3b9337309d21a01.png"></p><br><p>         .         r/place/new: </p><br><p><img src="https://habrastorage.org/files/21c/8b1/6b1/21c8b16b146441628e26ef02f3dcfc98.png" alt="enter image description here"></p><br><p> ,     . </p><br><h3 id="boty-ostanutsya-botami">    </h3><br><p>           .       ,         .  ,   ,    .  .  .       - ,        ,   ,   . </p><br><p>    Place,   ,     ,   ¬´ ¬ª .      .  ,          Fastly. </p><br><h3 id="sozdanie-chego-to-bolshego">  -  </h3><br><p> r/Place     ,      .     u/gooeyblob, u/egonkasper, u/eggplanticarus, u/spladug, u/thephilthe, u/d3fect   ,         . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/326984/">https://habr.com/ru/post/326984/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326974/index.html">SAP Forum 2017: New Scenarios for the Future with the Internet of Things</a></li>
<li><a href="../326976/index.html">What we should build an application: the reasoning of the interface</a></li>
<li><a href="../326978/index.html">Huawei CloudEngine 6800: Overview and Experience</a></li>
<li><a href="../326980/index.html">Generally available accounting software tools for SAM</a></li>
<li><a href="../326982/index.html">Private cloud for video and photos for half an hour "on the knee"</a></li>
<li><a href="../326986/index.html">What is this GraphQL?</a></li>
<li><a href="../326990/index.html">Looking for fast local storage</a></li>
<li><a href="../326994/index.html">Guide for a novice project manager: drive a bike that burns</a></li>
<li><a href="../326996/index.html">Logical replication in PostgreSQL 10</a></li>
<li><a href="../326998/index.html">Extreme migration to PostgreSQL: without stopping, losing and testing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>