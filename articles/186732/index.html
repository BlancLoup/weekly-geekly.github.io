<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using screen to log user actions (auditing) on ‚Äã‚ÄãLinux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Task: 
 Collect information about user actions (auditing) in the Linux console, namely the commands entered by him and the information displayed on th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using screen to log user actions (auditing) on ‚Äã‚ÄãLinux</h1><div class="post__text post__text-html js-mediator-article"><h4>  Task: </h4><br>  Collect information about user actions (auditing) in the Linux console, namely the commands entered by him <b>and the information displayed on the screen.</b> <br><br><h4>  Proposed solution: </h4><br>  default screen for all users on Linux with logging <br><br><h4>  The necessary conditions: </h4><br><ol><li>  Full logging of all users in the console, including the information output by the processes, so that you can evaluate why the user made this or that decision </li><li>  Without the ability to disable logging </li><li>  Since I chose screen, we use its capabilities to the maximum (opening new windows, shutting down by ^ a + d, leaving workflows running and other amenities) </li><li>  Maximum convenience - there should not be any incompatibilities with applications </li><li>  In the case of use by users not familiar with the screen - to make the work as familiar as possible and close to the usual command shell (shell) </li></ol><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Possible options: </h4><br>  1) <a href="http://habrahabr.ru/sandbox/65904/">The option offered on Habr√©</a> .  Work, but there are a few points: <br><ul><li>  In an amicable way, one would have to specify the user's shell in / etc / shells </li><li>  screen as such does not work.  In other words, additional windows do not open. </li><li>  Logging is disabled by the commonplace ^ a + H (capital) </li></ul><br>  2) <a href="http://superuser.com/questions/52297/use-gnu-screen-as-login-shell">Here, too, options are offered, but this is more raw billet</a> <br><br><h4>  So let's get started: </h4><br>  There are 2 possible uses of screen for our task: <br><ul><li>  Use the native command shell (shell), and then call screen automatically by the script </li><li>  Using screen as a user command shell </li></ul><br>  Judging by the quotes on the link, the second option is not good <div class="spoiler">  <b class="spoiler_title">certain reasons</b> <div class="spoiler_text">  ... this may be broken programs which run in / etc / passwd for various commands ... <br>  ... It then becomes hard to do anything with your account.  Also, your sysadmin probably doesn't have screen in / etc / shells ... </div></div><br><br>  Create a script to start screen so that when you start the bash command shell (after all, you have bash, right?), All users use this file and load it into the default screen with logging enabled.  When you exit the screen - the session closes: <br> <code>vi /usr/local/bin/get_in.sh</code> <br> <pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh SCREEN=/usr/bin/screen KILL=/bin/kill ## Check if we are already in screen ($STY is set) if [ -z "$STY" ]; then $SCREEN -LARR -S Shared -c /etc/screenrc ## Force SHELL close on exit - we don't want to allow users to escape logging outside screen $KILL -SIGHUP $PPID fi</span></span></code> </pre><br>  What we have: <br>  -L - send the entire log to a file (where exactly - see the logfile directive in the / etc / screenrc file below) <br>  -A - Adapt the size of the windows to the size of the current terminal.  Taken <a href="http://superuser.com/questions/52297/use-gnu-screen-as-login-shell%3Fanswertab%3Dvotes">from here</a> . <br>  -RR - reconnect the session and, if necessary, detach it or re-create it.  The first session is used if more than one is available.  In case of disconnection by ^ a + d, when you log in again, the same session of the same user will open. <br>  -c - we clearly indicate which configuration file to use to avoid the possibility of disabling logging and reassigning options by users, for example, by creating a file in ~ / .screenrc. <br>  -S - Assign session a friendly name.  Each user can have the same name. <br><br>  Making the script executable: <br> <code>chmod 0755 /usr/local/bin/get_in.sh</code> <br> <br>  Make it so that everyone uses this script.  To do this, add the line to the end of the /etc/bash.bashrc file: <br> <code>/usr/local/bin/get_in.sh</code> <br> <br>  Correct the / etc / screenrc file: <br><br><pre> <code class="hljs mel">## ,          .    (on),   . startup_message off # <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: on ##    -   <span class="hljs-string"><span class="hljs-string">""</span></span>   shell vbell off ##      <span class="hljs-number"><span class="hljs-number">4096.</span></span>    - <span class="hljs-number"><span class="hljs-number">100.</span></span> defscrollback <span class="hljs-number"><span class="hljs-number">4096</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span> ##    (shell),       .     $SHELL.      <span class="hljs-string"><span class="hljs-string">'-'</span></span> ,       login-shell. defshell -/bin/bash ##      ^a+[ . crlf off # <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: off ##      . caption always <span class="hljs-string"><span class="hljs-string">"%{= kg} %H | %{kc}%?%-w%?%{kY}%n*%f %t%?(%u)%?%{= kc}%?%+w%? %=|%{kW} %l %{kw}| %{kc}%{-b}%D, %m/%d/%Y | %{kW}%{+b}%c %{wk}"</span></span> ## Set terminal cap info termcapinfo xterm* <span class="hljs-string"><span class="hljs-string">'hs:ts=\E]0;:fs=\007:ds=\E]0;\007'</span></span> hardstatus off ##        screen (^a + H) bind H ##     - logfile /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/screen/$USER@%H-%Y%m%d-%c:%s.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> ## By <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>, screen uses an <span class="hljs-number"><span class="hljs-number">8</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">color</span></span> terminal emulator. Use the following line to enable more colors, which is useful <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> you are using a more-capable terminal emulator: term screen<span class="hljs-number"><span class="hljs-number">-256</span></span><span class="hljs-keyword"><span class="hljs-keyword">color</span></span> ##       - logtstamp on</code> </pre><br><br>  Do not forget to create a directory for logs: <br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">mkdir</span></span> /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/screen</code> </pre> <br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">chmod</span></span> <span class="hljs-number"><span class="hljs-number">0777</span></span> /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/screen</code> </pre> <br>  By this we achieve that all commands will be logged in log files of the form: <br><blockquote>  /var/log/screen/user@server-20130716-19:52:34 min4.log </blockquote><br><br>  In Debian, in order for command completion to work (bash_completion) to work in screen, you need to uncomment it in /etc/bash.bashrc: <br><pre> <code class="hljs pgsql"># <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> bash completion <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> interactive shells <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -f /etc/bash_completion ] &amp;&amp; ! shopt -oq posix; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> . /etc/bash_completion fi</code> </pre> <br><br>  Dear <a href="https://habrahabr.ru/users/1ex/" class="user_link">1ex</a> suggested the <a href="http://habrahabr.ru/post/186732/">solution</a> , how to use the wrapper for ssh to log commands that are executed without entering the interactive mode of bash like: ssh user @ host "ls -l".  For this you need: <br>  in / etc / ssh / sshd_config specify the reference to the wrapper processing: <br><pre> <code class="bash hljs">ForceCommand /etc/ssh/hook.sh</code> </pre><br>  Then create the wrapper itself /etc/ssh/hook.sh: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh if [ ! -z "${SSH_ORIGINAL_COMMAND}" ]; then echo "User "${USER}" remotely runs a command: ${SSH_ORIGINAL_COMMAND}" &gt;&gt; /var/log/screen/$USER@`hostname`-`date +%Y%m%d-%H:%M:%S`-command.log bash -c "$SSH_ORIGINAL_COMMAND" else cat /etc/motd ${SHELL} fi</span></span></code> </pre><br>  Do not forget to make it executable: <br><pre> <code class="bash hljs">chmod +x /etc/ssh/hook.sh</code> </pre><br>  By this we ensure that all such commands (and only commands - without information that is displayed on the screen) are logged in the same directory and will be supplemented with the suffix "-command": <br><blockquote>  /var/log/screen/user@server-20130717-12:47:53-command.log </blockquote><br><br>  Well that's all.  Now, when connecting, all users (including root - be careful if you lose the ability to log in!) Will work in the screen, which runs from bash.  When you exit the screen, the parent bash is closed and the connection is terminated.  If it is necessary to leave the processes running in the background, then to exit use ^ a + d.  The next time you connect, this session will connect <b>automatically</b> . <br><br><h4>  For further study: </h4><br><ul><li>  Since the output of commands is written to logs, they can take up a large amount of space.  It is necessary to provide compression methods to reduce the volume / traffic. </li><li>  The best place for logs is the remote machine and further processing is done there, since the logs on the local machine are created with the user's uid / guid and can be deleted / changed by it.  It is supposed to use syslog. </li><li>  Perhaps there are methods to bypass the screen and, accordingly, logging with this configuration.  I would like to hear them and make changes </li></ul><br><br><h4>  Sources used: </h4><br><ul><li>  <a href="http://habrahabr.ru/sandbox/65904/">http://habrahabr.ru/sandbox/65904/</a> </li><li>  <a href="http://superuser.com/questions/52297/use-gnu-screen-as-login-shell">http://superuser.com/questions/52297/use-gnu-screen-as-login-shell</a> </li><li>  <a href="https://spaces.seas.harvard.edu/display/USERDOCS/How%2Bto%2Buse%2B%2527screen%2527%2Bfor%2Bremote%2Bshell%2Bsessions">https://spaces.seas.harvard.edu/display/USERDOCS/How+to+use+%2727screen%27+for+remoteshell+sessions</a> </li><li>  <a href="http://www.linuxjournal.su/%3Fp%3D3495">http://www.linuxjournal.su/?p=3495</a> </li><li>  <a href="http://www.howtoforge.com/options-for-user-auditing-on-linux-platforms">http://www.howtoforge.com/options-for-user-auditing-on-linux-platforms</a> </li></ul><br><br><h4>  Update: </h4><br>  1) By remarks <a href="https://habrahabr.ru/users/joneleth/" class="user_link">joneleth</a> paths are changed to hard: <br>  Paragraph: <br><pre> <code class="bash hljs">SCREEN=`<span class="hljs-built_in"><span class="hljs-built_in">which</span></span> screen` KILL=`<span class="hljs-built_in"><span class="hljs-built_in">which</span></span> <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span>`</code> </pre>  Replaced by: <br><pre> <code class="bash hljs">SCREEN=/usr/bin/screen KILL=/bin/<span class="hljs-built_in"><span class="hljs-built_in">kill</span></span></code> </pre><br><br><h4>  At the moment there are 2 ways to bypass the command logging: </h4><br>  <s>1) <a href="https://habrahabr.ru/users/kiltum/" class="user_link">Promoted by kiltum</a> : commands like ssh user @ host "ls -l" are not logged.</s>  <s>In this case, the commands are executed as / bin / bash -c &lt;command&gt;, and the desired /etc/bash.bashrc is not readable.</s> <br>  <i>Dear <a href="https://habrahabr.ru/users/1ex/" class="user_link">1ex</a> suggested <a href="http://habrahabr.ru/post/186732/">solution</a> using wrapper for ssh.</i>  <i>Now all commands of this type are logged.</i>  <i>Changes to the text made.</i> <br>  2) <a href="https://habrahabr.ru/users/foreveryoung/" class="user_link">ForeverYoung is prompted</a> : the screen -X log command disables logging. <br>  <i>There is no possibility to disable this feature, so it is necessary to apply administrative measures to users who run this command (this command itself will still be recorded in the log).</i> <br>  Best solutions are welcome. <br><br><h4>  RESULTS: </h4><br>  As it turned out, the screen is not exactly intended for solving such tasks, namely, forced logging of commands and their output without the possibility of disabling logging.  This leads to the fact that you have to additionally edit other files. <br>  As recommended by the respected <a href="https://habrahabr.ru/users/amarao/" class="user_link">amarao</a> for solving such problems, it is better to look at other solutions: <br>  a) sniffing all traffic passing through pseudo-terminals (more seriously).  <a href="https://habrahabr.ru/users/kiltum/" class="user_link">kiltum</a> prompted <a href="http://ace-host.stuart.id.au/russell/files/conspy/">conspy</a> .  <a href="https://habrahabr.ru/users/slipeer/" class="user_link">Slipeer</a> suggested <a href="https://github.com/a2o/snoopy">Snoopy Logger</a> . <br>  b) audit systems (SELinux / Apparmor / etc), which will actually record everything being executed. <br>  But these decisions are beyond the scope of this article. <br><br>  <b>I believe that despite the shortcomings, using screen for logging user actions and displaying information on Linux is justified, due to the ease of implementation, and most importantly, ease of reading logs (unlike auditd, for example).</b> </div><p>Source: <a href="https://habr.com/ru/post/186732/">https://habr.com/ru/post/186732/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../186720/index.html">Video review of Asus N550JV and N750JV laptops</a></li>
<li><a href="../186722/index.html">Creating a native extension library for OpenFL, part two</a></li>
<li><a href="../186724/index.html">Harvard Master's Degree - Reality</a></li>
<li><a href="../186728/index.html">Interesting and informative: we are witnessing milestones in the history of astronautics with the Orbiter</a></li>
<li><a href="../186730/index.html">Game "sea battle": the placement of ships</a></li>
<li><a href="../186736/index.html">The most antimagnetic watch in the world</a></li>
<li><a href="../186738/index.html">"Thread" - a real rope for cultural, educational and social projects</a></li>
<li><a href="../186740/index.html">Flying robot to the competition and a bunch of rake with him</a></li>
<li><a href="../186744/index.html">New backdoors in HP server products</a></li>
<li><a href="../186746/index.html">What would the modern world look like without smartphones?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>