<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As I was increasing machine learning conversion</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will try to answer these questions: 


- Can one report from an intelligent person make another person obsessed? 
- how to dip into ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As I was increasing machine learning conversion</h1><div class="post__text post__text-html js-mediator-article">  In this article I will try to answer these questions: <br><ul><li>  Can one report from an intelligent person make another person obsessed? </li><li>  how to dip into machine learning (almost) from scratch? </li><li>  why not underestimate the many-armed gangsters? </li><li>  Is there a silver bullet for a / b tests? </li></ul><br>  The answer to the first question will be the most concise - "yes."  After hearing <a href="https://events.yandex.ru/lib/talks/823/">this</a> <a href="http://habrahabr.ru/users/bobuk/" class="user_link">bobuk</a> <a href="https://events.yandex.ru/lib/talks/823/">performance</a> at YaC / M, I admired the elegance of the approach and wondered how to implement a similar solution.  I then worked as a product manager in the company Wargaming and was just engaged in the so-called.  user acquisition services - technological solutions to attract users, which included a system for A / B testing of landings.  So the grain lay on fertile soil. <br><br>  Unfortunately, for all reasons I could not tightly engage in this project in the normal operating mode.  But when I burned out a bit at work and decided to make myself a long creative vacation, my obsession turned into a desire to make such a service of intelligent landing page rotation on my own. <br><a name="habracut"></a><br><br><h2>  What is it all about? </h2><br>  The concept of the service was quite simple: at the prototype stage, I decided to limit myself to a router that would predict a conversion for each new user on different landings and send it to the best.  All whistles postponed for later, because  it was necessary to hone the predictive technology first. <br><img src="https://habrastorage.org/files/575/d4c/19b/575d4c19bf504230b43db4dccb194da2.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The level of my knowledge of machine learning was somewhere between "absent" and "scarce".  Because I had to start with a minimum educational program: <br><ul><li>  ‚ÄúWe <a href="http://www.ozon.ru/context/detail/id/4877842/">program the collective mind</a> ‚Äù; </li><li>  <a href="http://www.amazon.com/Mastering-Machine-Learning-With-scikit-learn/dp/1783988363">Mastering Machine Learning With scikit-learn</a> ; </li><li>  <a href="http://www.amazon.com/Scikit-Learn-Cookbook-Trent-Hauck/dp/1783989483/">scikit-learn Cookbook</a> ; </li><li>  <a href="https://www.coursera.org/course/ml">classic course on Coursera from Andrew Ng</a> ; </li><li>  <a href="http://scikit-learn.org/">scikit-learn</a> documentation (perhaps the most valuable source of information); </li></ul><br>  Python was a good fit for implementation, since  on the one hand, it is a general-purpose language, on the other - its ecosystem has generated quite a few data libraries (in particular, scikit-learn, pandas, Lasagne came in handy to me).  For web wrappers, I used Django - this is clearly a non-optimal choice, but on the other hand, this did not require additional time to master the new framework.  Looking ahead, I note that there were no problems with Django speed, and on my relatively small load up to 3000 RPM server requests were processed for 20-30 ms. <br><br><img src="https://habrastorage.org/files/4f7/7c1/be8/4f77c1be8b23493ea91477651d418c36.png"><br>  <i>What happens if you suddenly connect to the test client with a large amount of traffic.</i> <br><br>  Workflow was this: <br><ul><li>  user comes to the router; </li><li>  the service collects the maximum amount of information about it (since at the prototype stage it would be foolish to integrate with information providers like DMP, I started with technical data ‚Äî HTTP headers, geolocation, screen resolution, etc.); </li><li>  classifier predicts conversion on possible landing options; </li><li>  the router gives 302 Redirect to a potentially better landing page. </li></ul><br><br><h2>  Classifying classifiers </h2><br>  To select the best landing pages, you need to start to find the right classifier.  For each project (a set of landing pages for one client), the classifiers would most likely differ, so I needed: <br><ul><li>  to train a number of classifiers on historical data, selecting <a href="http://www.quora.com/Machine-Learning/What-are-hyperparameters">hyper parameters</a> ; </li><li>  choose the best classifier at the moment; </li><li>  periodically repeat this operation. </li></ul><br>  The undoubted advantage was that it is possible to train classifiers in the background, regardless of the part of the system that directly assigned users to the landings.  For example, at the beginning of the experiments, users were distributed in the a / b test mode in order to simultaneously collect data for training the model and not to spoil the existing conversion. <br><br>  Learning a classifier with scikit-learn is a fairly simple thing.  It is enough first to vectorize the data with the help of DictVectorizer from scikit-learn, divide the sample into training and test, train the classifier, make predictions and evaluate their accuracy. <br><br><div class="spoiler">  <b class="spoiler_title">This is the basic data:</b> <div class="spoiler_text"><pre><code class="python hljs">[{<span class="hljs-string"><span class="hljs-string">'1_lang'</span></span>: <span class="hljs-string"><span class="hljs-string">'pl-PL'</span></span>, <span class="hljs-string"><span class="hljs-string">'browser_full'</span></span>: <span class="hljs-string"><span class="hljs-string">'IE8'</span></span>, <span class="hljs-string"><span class="hljs-string">'country'</span></span>: <span class="hljs-string"><span class="hljs-string">'Poland'</span></span>, <span class="hljs-string"><span class="hljs-string">'day'</span></span>: <span class="hljs-string"><span class="hljs-string">'5'</span></span>, <span class="hljs-string"><span class="hljs-string">'hour'</span></span>: <span class="hljs-string"><span class="hljs-string">'9'</span></span>, <span class="hljs-string"><span class="hljs-string">'is_bot'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, <span class="hljs-string"><span class="hljs-string">'is_mobile'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, <span class="hljs-string"><span class="hljs-string">'is_pc'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">'is_tablet'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, <span class="hljs-string"><span class="hljs-string">'is_touch_capable'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, <span class="hljs-string"><span class="hljs-string">'month'</span></span>: <span class="hljs-string"><span class="hljs-string">'6'</span></span>, <span class="hljs-string"><span class="hljs-string">'os'</span></span>: <span class="hljs-string"><span class="hljs-string">'Windows 7'</span></span>, <span class="hljs-string"><span class="hljs-string">'timezone'</span></span>: <span class="hljs-string"><span class="hljs-string">'+0200'</span></span>, <span class="hljs-string"><span class="hljs-string">'utm_campaign'</span></span>: <span class="hljs-string"><span class="hljs-string">'11766_'</span></span>, <span class="hljs-string"><span class="hljs-string">'utm_medium'</span></span>: <span class="hljs-string"><span class="hljs-string">'543'</span></span>, <span class="hljs-string"><span class="hljs-string">'used_landing'</span></span> : <span class="hljs-string"><span class="hljs-string">'1'</span></span> }, {<span class="hljs-string"><span class="hljs-string">'1_lang'</span></span>: <span class="hljs-string"><span class="hljs-string">'en-US'</span></span>, <span class="hljs-string"><span class="hljs-string">'REFERER_HOST'</span></span>: <span class="hljs-string"><span class="hljs-string">'somedomain.com'</span></span>, <span class="hljs-string"><span class="hljs-string">'browser'</span></span>: <span class="hljs-string"><span class="hljs-string">'Firefox'</span></span>, <span class="hljs-string"><span class="hljs-string">'browser_full'</span></span>: <span class="hljs-string"><span class="hljs-string">'Firefox38'</span></span>, <span class="hljs-string"><span class="hljs-string">'city'</span></span>: <span class="hljs-string"><span class="hljs-string">'Raleigh'</span></span>, <span class="hljs-string"><span class="hljs-string">'country'</span></span>: <span class="hljs-string"><span class="hljs-string">'United States'</span></span>, <span class="hljs-string"><span class="hljs-string">'day'</span></span>: <span class="hljs-string"><span class="hljs-string">'5'</span></span>, <span class="hljs-string"><span class="hljs-string">'hour'</span></span>: <span class="hljs-string"><span class="hljs-string">'3'</span></span>, <span class="hljs-string"><span class="hljs-string">'is_bot'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, <span class="hljs-string"><span class="hljs-string">'is_mobile'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, <span class="hljs-string"><span class="hljs-string">'is_pc'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">'is_tablet'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, <span class="hljs-string"><span class="hljs-string">'is_touch_capable'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, <span class="hljs-string"><span class="hljs-string">'month'</span></span>: <span class="hljs-string"><span class="hljs-string">'6'</span></span>, <span class="hljs-string"><span class="hljs-string">'os'</span></span>: <span class="hljs-string"><span class="hljs-string">'Windows 8.1'</span></span>, <span class="hljs-string"><span class="hljs-string">'timezone'</span></span>: <span class="hljs-string"><span class="hljs-string">'-0400'</span></span>, <span class="hljs-string"><span class="hljs-string">'utm_campaign'</span></span>: <span class="hljs-string"><span class="hljs-string">'pff_r.search.yahoo.com'</span></span>, <span class="hljs-string"><span class="hljs-string">'utm_medium'</span></span>: <span class="hljs-string"><span class="hljs-string">'1822'</span></span>, <span class="hljs-string"><span class="hljs-string">'used_landing'</span></span> : <span class="hljs-string"><span class="hljs-string">'2'</span></span> }, ..., {<span class="hljs-string"><span class="hljs-string">'1_lang'</span></span>: <span class="hljs-string"><span class="hljs-string">'ru-RU'</span></span>, <span class="hljs-string"><span class="hljs-string">'HTTP_REFERER'</span></span>: <span class="hljs-string"><span class="hljs-string">'somedomain.ru'</span></span>, <span class="hljs-string"><span class="hljs-string">'browser'</span></span>: <span class="hljs-string"><span class="hljs-string">'IE'</span></span>, <span class="hljs-string"><span class="hljs-string">'browser_full'</span></span>: <span class="hljs-string"><span class="hljs-string">'IE11'</span></span>, <span class="hljs-string"><span class="hljs-string">'screen'</span></span>: <span class="hljs-string"><span class="hljs-string">'1280x960x24'</span></span>, <span class="hljs-string"><span class="hljs-string">'country'</span></span>: <span class="hljs-string"><span class="hljs-string">'Ukraine'</span></span>, <span class="hljs-string"><span class="hljs-string">'day'</span></span>: <span class="hljs-string"><span class="hljs-string">'5'</span></span>, <span class="hljs-string"><span class="hljs-string">'hour'</span></span>: <span class="hljs-string"><span class="hljs-string">'7'</span></span>, <span class="hljs-string"><span class="hljs-string">'is_bot'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, <span class="hljs-string"><span class="hljs-string">'is_mobile'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, <span class="hljs-string"><span class="hljs-string">'is_pc'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">'is_tablet'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, <span class="hljs-string"><span class="hljs-string">'is_touch_capable'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, <span class="hljs-string"><span class="hljs-string">'month'</span></span>: <span class="hljs-string"><span class="hljs-string">'6'</span></span>, <span class="hljs-string"><span class="hljs-string">'os'</span></span>: <span class="hljs-string"><span class="hljs-string">'Windows 7'</span></span>, <span class="hljs-string"><span class="hljs-string">'timezone'</span></span>: <span class="hljs-string"><span class="hljs-string">'N/A'</span></span>, <span class="hljs-string"><span class="hljs-string">'utm_campaign'</span></span>: <span class="hljs-string"><span class="hljs-string">'62099'</span></span>, <span class="hljs-string"><span class="hljs-string">'utm_medium'</span></span>: <span class="hljs-string"><span class="hljs-string">'1077'</span></span>, <span class="hljs-string"><span class="hljs-string">'used_landing'</span></span> : <span class="hljs-string"><span class="hljs-string">'1'</span></span> }]</code> </pre> <br>  (part of key-value pairs removed) </div></div><br><br>  And something like this - transformed into the numpy array: <br><pre> <code class="python hljs">[[ <span class="hljs-number"><span class="hljs-number">0.</span></span> <span class="hljs-number"><span class="hljs-number">0.</span></span> <span class="hljs-number"><span class="hljs-number">0.</span></span> ..., <span class="hljs-number"><span class="hljs-number">0.</span></span> <span class="hljs-number"><span class="hljs-number">0.</span></span> <span class="hljs-number"><span class="hljs-number">1.</span></span>] [ <span class="hljs-number"><span class="hljs-number">0.</span></span> <span class="hljs-number"><span class="hljs-number">0.</span></span> <span class="hljs-number"><span class="hljs-number">0.</span></span> ..., <span class="hljs-number"><span class="hljs-number">0.</span></span> <span class="hljs-number"><span class="hljs-number">0.</span></span> <span class="hljs-number"><span class="hljs-number">1.</span></span>] [ <span class="hljs-number"><span class="hljs-number">0.</span></span> <span class="hljs-number"><span class="hljs-number">0.</span></span> <span class="hljs-number"><span class="hljs-number">0.</span></span> ..., <span class="hljs-number"><span class="hljs-number">0.</span></span> <span class="hljs-number"><span class="hljs-number">1.</span></span> <span class="hljs-number"><span class="hljs-number">0.</span></span>] ..., [ <span class="hljs-number"><span class="hljs-number">0.</span></span> <span class="hljs-number"><span class="hljs-number">0.</span></span> <span class="hljs-number"><span class="hljs-number">0.</span></span> ..., <span class="hljs-number"><span class="hljs-number">0.</span></span> <span class="hljs-number"><span class="hljs-number">1.</span></span> <span class="hljs-number"><span class="hljs-number">0.</span></span>] [ <span class="hljs-number"><span class="hljs-number">0.</span></span> <span class="hljs-number"><span class="hljs-number">0.</span></span> <span class="hljs-number"><span class="hljs-number">0.</span></span> ..., <span class="hljs-number"><span class="hljs-number">0.</span></span> <span class="hljs-number"><span class="hljs-number">0.</span></span> <span class="hljs-number"><span class="hljs-number">1.</span></span>] [ <span class="hljs-number"><span class="hljs-number">0.</span></span> <span class="hljs-number"><span class="hljs-number">0.</span></span> <span class="hljs-number"><span class="hljs-number">0.</span></span> ..., <span class="hljs-number"><span class="hljs-number">0.</span></span> <span class="hljs-number"><span class="hljs-number">0.</span></span> <span class="hljs-number"><span class="hljs-number">1.</span></span>]]</code> </pre> <br><br>  By the way, for many classification methods it is more rational to leave the data in the form of a sparse-matrix, and not a numpy array, since  This reduces memory consumption. <br><br>  The result to be predicted from this data is a list of zeros (no conversion has happened) and units (hooray, the user has registered!). <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sklearn.feature_extraction <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> DictVectorizer <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sklearn.cross_validation <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> train_test_split <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json clicks = Click.objects.filter(project=<span class="hljs-number"><span class="hljs-number">42</span></span>) <span class="hljs-comment"><span class="hljs-comment"># deserializing data stored as json X = DictVectorizer().fit_transform([json.loads(x.data) for x in clicks]) Y = [1 if click.conversion_time else 0 for click in clicks] # getting train and test subsets for model fitting and scoring X1, X2, Y1, Y2 = train_test_split(X, Y, test_size=0.3)</span></span></code> </pre><br>  Let's make the simplest logistic regression: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sklearn.linear_model <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> LogisticRegression clf = LogisticRegression(class_weight=<span class="hljs-string"><span class="hljs-string">'auto'</span></span>) clf.fit(X1, Y1) predicted = clf.predict(X2)</code> </pre><br>  Let's estimate the quality of predictions.  The choice of the evaluation criterion is perhaps the most difficult part of the project.  Intuitively, it seems that there is no need to invent anything and it is enough to estimate the proportion of correct predictions, but this is an incorrect approach.  The simplest counterargument: if our landings have an average conversion of 1%, then the most stupid classifier, predicting the lack of conversion for any user, will show 99% accuracy. <br><br>  For binary classification problems, such metrics as <a href="http://en.wikipedia.org/wiki/F1_score">f1-score</a> or <a href="http://en.wikipedia.org/wiki/Matthews_correlation_coefficient">Matthews coefficient</a> are often used.  But in my case, it is not so much the correctness of the binary prediction that is important (conversion happens or not), but how close the predicted probability is.  In such cases, you can use the <a href="http://scikit-learn.org/stable/modules/generated/sklearn.metrics.roc_auc_score.html">ROC AUC score</a> or <a href="http://scikit-learn.org/stable/modules/generated/sklearn.metrics.log_loss.html">log_loss</a> ;  If you study similar tasks on Kaggle (for example, the <a href="https://www.kaggle.com/c/avazu-ctr-prediction">Avazu</a> or <a href="https://www.kaggle.com/c/avito-context-ad-clicks">Avito</a> contest), you can see that it is these metrics that are often used. <br><br><pre> <code class="python hljs">In [<span class="hljs-number"><span class="hljs-number">21</span></span>]: roc_auc_score(Y2, clf.predict(X2)) Out[<span class="hljs-number"><span class="hljs-number">21</span></span>]: <span class="hljs-number"><span class="hljs-number">0.76443388650963591</span></span></code> </pre><br>  Hmm, the quality is so-so.  Why not try to iterate over the hyperparameters of the model?  For this, scikit-learn also has a ready-made tool - the grid_search module and the GridSearchCV classes for brute force and RandomizedSearchCV for many random selections (useful if the number of possible options is too large). <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sklearn.metrics <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> roc_auc_score, make_scorer <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sklearn.grid_search <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> RandomizedSearchCV clfs = ((DecisionTreeClassifier(), {<span class="hljs-string"><span class="hljs-string">'max_features'</span></span>: [<span class="hljs-string"><span class="hljs-string">'auto'</span></span>, <span class="hljs-string"><span class="hljs-string">'sqrt'</span></span>, <span class="hljs-string"><span class="hljs-string">'log2'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>], <span class="hljs-string"><span class="hljs-string">'max_depth'</span></span>: range(<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>), <span class="hljs-string"><span class="hljs-string">'criterion'</span></span>: [<span class="hljs-string"><span class="hljs-string">'gini'</span></span>, <span class="hljs-string"><span class="hljs-string">'entropy'</span></span>], <span class="hljs-string"><span class="hljs-string">'splitter'</span></span>: [<span class="hljs-string"><span class="hljs-string">'best'</span></span>, <span class="hljs-string"><span class="hljs-string">'random'</span></span>], <span class="hljs-string"><span class="hljs-string">'min_samples_leaf'</span></span>: range(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>), <span class="hljs-string"><span class="hljs-string">'class_weight'</span></span>: [<span class="hljs-string"><span class="hljs-string">'auto'</span></span>], <span class="hljs-string"><span class="hljs-string">'min_samples_split'</span></span>: range(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>), }), (LogisticRegression(), {<span class="hljs-string"><span class="hljs-string">'penalty'</span></span>: [<span class="hljs-string"><span class="hljs-string">'l1'</span></span>, <span class="hljs-string"><span class="hljs-string">'l2'</span></span>], <span class="hljs-string"><span class="hljs-string">'C'</span></span>: [x / <span class="hljs-number"><span class="hljs-number">10.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>)], <span class="hljs-string"><span class="hljs-string">'fit_intercept'</span></span>: [<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>], <span class="hljs-string"><span class="hljs-string">'class_weight'</span></span>: [<span class="hljs-string"><span class="hljs-string">'auto'</span></span>], }), (SGDClassifier(), {<span class="hljs-string"><span class="hljs-string">'loss'</span></span>: [<span class="hljs-string"><span class="hljs-string">'modified_huber'</span></span>, <span class="hljs-string"><span class="hljs-string">'log'</span></span>], <span class="hljs-string"><span class="hljs-string">'alpha'</span></span>: [<span class="hljs-number"><span class="hljs-number">1.0</span></span> / <span class="hljs-number"><span class="hljs-number">10</span></span> ** x <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>)], <span class="hljs-string"><span class="hljs-string">'penalty'</span></span>: [<span class="hljs-string"><span class="hljs-string">'l2'</span></span>, <span class="hljs-string"><span class="hljs-string">'l1'</span></span>, <span class="hljs-string"><span class="hljs-string">'elasticnet'</span></span>], <span class="hljs-string"><span class="hljs-string">'n_iter'</span></span>: range(<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>), <span class="hljs-string"><span class="hljs-string">'learning_rate'</span></span>: [<span class="hljs-string"><span class="hljs-string">'constant'</span></span>, <span class="hljs-string"><span class="hljs-string">'optimal'</span></span>, <span class="hljs-string"><span class="hljs-string">'invscaling'</span></span>], <span class="hljs-string"><span class="hljs-string">'class_weight'</span></span>: [<span class="hljs-string"><span class="hljs-string">'auto'</span></span>], <span class="hljs-string"><span class="hljs-string">'eta0'</span></span>: [<span class="hljs-number"><span class="hljs-number">0.01</span></span>], })) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> clf, param <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> clfs: logger.debug(<span class="hljs-string"><span class="hljs-string">'Parameters search started for {0}'</span></span>.format(clf.__class__.__name__)) grid = RandomizedSearchCV(estimator=clf, param_distributions=param, scoring=make_scorer(roc_auc_score), n_iter=<span class="hljs-number"><span class="hljs-number">200</span></span>, n_jobs=<span class="hljs-number"><span class="hljs-number">2</span></span>, iid=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, refit=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, cv=<span class="hljs-number"><span class="hljs-number">2</span></span>, verbose=<span class="hljs-number"><span class="hljs-number">0</span></span>, pre_dispatch=<span class="hljs-string"><span class="hljs-string">'2*n_jobs'</span></span>, error_score=<span class="hljs-number"><span class="hljs-number">0</span></span>) grid.fit(X, Y) logger.info(<span class="hljs-string"><span class="hljs-string">'Best estimator is {} with score {} using params {}'</span></span>.format(clf.__class__.__name__, grid.best_score_, grid.best_params_))</code> </pre><br>  <i>This code snippet, like the others, is simplified as much as possible for clarity: for example, it is recommended to transfer scipy.stats distributions, not lists, as numeric parameters for iteration into RandomizedSearchCV.</i> <br><br>  In principle, it would be possible not to stop at what has been accomplished and fasten genetic algorithms to this happiness.  But it seems that the quality of predictions is already becoming more or less adequate: <br><br><pre> <code class="python hljs">In [<span class="hljs-number"><span class="hljs-number">27</span></span>]: roc_auc_score(Y2, clf.predict(X2)) Out[<span class="hljs-number"><span class="hljs-number">27</span></span>]: <span class="hljs-number"><span class="hljs-number">0.95225886338947252</span></span></code> </pre><br>  Unfortunately, there is no clear criterion when the model is already good or still needs tuning.  The possibilities for tuning are endless: you can add polynomial combinations of features, you can construct features based on existing ones (for example, determine the topics of the referrer site).  However, when various kinds of manipulations no longer give a tangible effect, it is time to proceed to the next stage, otherwise you can spend a lot of time improving the classifier by another 0.00001%. <br><br>  After the hyperparameters are defined, the classifier can be trained on the entire sample and put in the cache for quick access. <br><br><h2>  From sandbox to production </h2><br>  So, we have some working classifiers.  It's time for production!  Just before that, you need to decide what is good and what is bad - no longer from the point of view of mathematics and machine learning, but for business. <br><br>  Since  the whole project is about increasing the conversion, you must again arrange the A / B test.  More precisely, the metattest: <br><ul><li>  Part of the traffic will be distributed between the landing pages randomly; </li><li>  for the part, the A / B test will work on the simplest model of a <a href="https://support.google.com/analytics/answer/2844870%3Fhl%3Den">multi-armed bandit</a> ; </li><li>  and finally, the remaining traffic will be distributed using classifiers. </li></ul><br>  Depla, discussion of the launch with test clients, debugging minor bugs - and you can look forward to the result. <br><br>  For me personally, the most unpleasant thing in the process of A / B tests is intermediate results.  The situation regularly happens that at first one option gets ahead, it seems that a good result has been achieved, although there is still no statistical significance.  After some time, the data becomes more, and comes the understanding that everything is not so rosy. <br><br>  It was about the same this time.  ‚ÄúSmart‚Äù routing with the help of classifiers first got ahead, and then the results were almost equal to the multi-armed gangster.  Both models of a choice of a landing proved to be approximately equally effective, having left random behind (it is not surprising).  Only one of the six experiments showed a statistically significant advantage of such routing over the A / B test. <br><br><img src="https://habrastorage.org/files/c0f/ab7/acf/c0fab7acffef43f695084ec4ce84f5d8.png"><br><br>  Separately, I want to note that I did not notice any correlation between the quality of the classifier (ROC AUC / log_loss) and conversion, which made it very difficult to somehow improve the situation. <br><br><h2>  Is there life on Mars? </h2><br>  More relevant is the question, can this technology bring tangible benefits, and not fluctuate on the verge of statistical error?  I cannot confirm or disprove this hypothesis, but it looks as if such an approach with machine learning may be useful when working with the whole chain of attracting users. <br><br>  Probably, if you make a variety of landings (I tested the system on very similar pages), integrate more data sources (ad network macros, client CRM and even DMP), the technology may be useful and increase the conversion in situations where usual a / b tests do not give effect.  To make a silver bullet, so that anyone who wants to get on level ground + N% conversion from existing pages without thoughtful work is more likely unrealistic. <br><br>  Some scikit-learn classifiers (in particular, based on decision trees) have an interesting attribute feature_importances_, which shows the weight of a particular attribute for the final prediction.  My test classifiers rarely gave a selected landing page a weight of more than 2% and have never broken the threshold of 5%.  At the same time, such parameters as country, referrer and browser could select 20-25% for themselves.  I tend to interpret it this way: the importance of a good landing page is somewhat exaggerated, and working with targeting in an advertising campaign could have been better. <br><br>  Nevertheless, if among the readers there are those who wish to try my development on their project, write, I will be happy to conduct some more joint experiments.  For the test, you will need several options for transactional pages and a sufficient number of users (from 10 thousand). <br><br>  I plan to finish my sabbatical on this and return to normal work, therefore I would like to know the opinion of the community about the relevance of such a project in order to reach a logical conclusion. </div><p>Source: <a href="https://habr.com/ru/post/259771/">https://habr.com/ru/post/259771/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259755/index.html">Oberon system implemented on an affordable FPGA board</a></li>
<li><a href="../259761/index.html">The device of the game engine for NES on the example of the games "Capcom"</a></li>
<li><a href="../259763/index.html">Confusion with job titles</a></li>
<li><a href="../259765/index.html">Views on Zend PHP Certification</a></li>
<li><a href="../259767/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ163 (June 1 - 7, 2015)</a></li>
<li><a href="../259773/index.html">Digest of grocery design, May 2015</a></li>
<li><a href="../259777/index.html">C ++ in the modern world</a></li>
<li><a href="../259779/index.html">Major changes in ASP.NET 5 and MVC 6</a></li>
<li><a href="../259781/index.html">Evil maid attack on encrypted hard drive</a></li>
<li><a href="../259783/index.html">Flexbox on the example of the dice</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>