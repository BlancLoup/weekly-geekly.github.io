<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Get structured data from PostgreSQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Have you ever puzzled over how to return a complicated structure with a clever hierarchy from a PostgreSQL stored procedure and not to write a huge cr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Get structured data from PostgreSQL</h1><div class="post__text post__text-html js-mediator-article"> Have you ever puzzled over how to return a complicated structure with a clever hierarchy from a PostgreSQL stored procedure and not to write a huge crutch for parsing a tree structure that has been developed by the developer into a flat relational table?  If the answer is yes, then I ask under the cat ... <br><br><a name="habracut"></a><br>  Good day! <br>  Everyone knows that the result of a query to a relational database is a table.  The tabular container, in view of its rigid structure, imposes a number of restrictions on the data presented.  For example, the result of a sample that has in its composition a join is a denormalized structure that hides the original data topology, which makes it difficult for an application to handle such a result.  With the increase in the number of joines, the situation only worsens <br>  But not everything is as bad as it may seem, because the PostgreSQL developer has at its disposal flexible data structures that can encapsulate a dataset of any complexity.  Speech about arrays (arrays) and structures (record, composite type). <br>  The result of the above sample with associations, turns into an elegant, strictly hierarchical structure of the form: <br><br> <code>( <br> table1_column1 int, <br> table1_column2 varchar, <br> table1_column3 numeric, <br> table2_columns t2_columns[] <br> ) <br></code> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      where t2_columns is a view structure <br> <code>( <br> table2_column1 double precision, <br> table2_column2 timestamp <br> ) <br></code> <br><br>  Thus, by increasing the level of nesting you can transfer arbitrarily complex hierarchical structures. <br>  In my case, the application was written in PL / pgSQL and provided stored procedures for the interface that return the most complexly organized data.  Actually this article is about the approach to parsing serialized PostgreSQL datasets. <br><br>  Directly from parsing the data serialized into a PostgreSQL string (the same string that is obtained by casting the record to varchar), it was decided to refuse immediately, because there is no means for such parsing anywhere except for the postgres kernel. <br>  The idea to change the presentation of the data, which did not take long to wait, in order to use more standardized means of analysis, was developed. <br>  Having spent some time searching for a ready-made solution, and discarding such candidates as the built-in xml and hstore types, I came to the conclusion (perhaps erroneous) that there is no suitable way to transfer data to the application in all respects. <br><br>  JSON (for compactness and textual reasons) was chosen as the data representation for the future bike, and the native library for PostgreSQL (on pure C) became the implementation method.  I will not go into the internal structure of the resulting instrument, especially since it is quite simple and anyone who wants can easily figure it out.  Consider the library from a utilitarian point of view.  A set of functions is provided as an interface. <br><br>  Examples of using: <br><br>  Serialize the structure: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> to_json( <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>( <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">'Some text'</span></span>, <span class="hljs-number"><span class="hljs-number">12.5</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>( <span class="hljs-string"><span class="hljs-string">'text in nested record'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>[ <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span> ] )::text_and_array, <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>[ <span class="hljs-string"><span class="hljs-string">'array'</span></span>, <span class="hljs-string"><span class="hljs-string">'of'</span></span>, <span class="hljs-string"><span class="hljs-string">'text'</span></span> ] ) )</code> </pre><br><br>  Query result: <br><pre> <code class="javascript hljs">{<span class="hljs-string"><span class="hljs-string">"f1"</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-string"><span class="hljs-string">"f2"</span></span>:<span class="hljs-string"><span class="hljs-string">"Some text"</span></span>,<span class="hljs-string"><span class="hljs-string">"f3"</span></span>:<span class="hljs-number"><span class="hljs-number">12.5</span></span>,<span class="hljs-string"><span class="hljs-string">"f4"</span></span>:{<span class="hljs-string"><span class="hljs-string">"str"</span></span>:<span class="hljs-string"><span class="hljs-string">"text in nested record"</span></span>,<span class="hljs-string"><span class="hljs-string">"arr"</span></span>:[<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>]},<span class="hljs-string"><span class="hljs-string">"f5"</span></span>:[<span class="hljs-string"><span class="hljs-string">"array"</span></span>,<span class="hljs-string"><span class="hljs-string">"of"</span></span>,<span class="hljs-string"><span class="hljs-string">"text"</span></span>]}</code> </pre><br><br>  Serialize the datasets: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> json_agg( q.*, <span class="hljs-string"><span class="hljs-string">'json_field_name1'</span></span> ), json_agg_plain( q.*, <span class="hljs-string"><span class="hljs-string">'json_field_name2'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> q;</code> </pre><br><br>  Query result: <br><pre> <code class="javascript hljs">{<span class="hljs-string"><span class="hljs-string">"json_field_name1"</span></span>:[{ ... },{ ... }, ...]} <span class="hljs-string"><span class="hljs-string">"json_field_name2"</span></span>:[{ ... },{ ... }, ...]</code> </pre><br><br>  Later, the library was expanded with functionality that allows you to perform the reverse operation of parsing JSON and filling in the fields of structures. <br><br>  We deserialize the structures and arrays: <br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> from_json( <span class="hljs-string"><span class="hljs-string">'some_record_type'</span></span>, <span class="hljs-string"><span class="hljs-string">'{"field1":"some text","field2":123,"field3":["this","is","array","of","text"]}'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> arr_from_json( <span class="hljs-string"><span class="hljs-string">'some_type[]'</span></span>, <span class="hljs-string"><span class="hljs-string">'[{"this is array of"},{"records with one field"}]'</span></span> );</code> </pre><br><br>  Query results: <br> <code>("some text",123,"{\"this\",\"is\",\"array\",\"of\",\"text\"}") <br></code> <br> <code>{("this is array of"),("records with one field")} <br></code> <br><br>  The described serializer can be used in conjunction with any runtime environment containing JSON parser (we have C ++ and PHP).  Benchmarks show performance comparable to the serializer built into PostgreSQL. <br><br>  Thank you for your attention, comments and constructive criticism are welcome. <br><br>  <a href="https://code.google.com/p/pg-to-json-serializer/">Link to the library</a> <br><habracut></habracut></div><p>Source: <a href="https://habr.com/ru/post/148847/">https://habr.com/ru/post/148847/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148842/index.html">Simplify your life with Sublime Text 2</a></li>
<li><a href="../148843/index.html">Database Migration in Zend Framework: Akrabat_Db_Schema_Manager</a></li>
<li><a href="../148844/index.html">The first experience of writing plugins for Autocad in C #</a></li>
<li><a href="../148845/index.html">.NET is more valuable than .COM?</a></li>
<li><a href="../148846/index.html">Sieve method in the game "Bulls and Cows"</a></li>
<li><a href="../148849/index.html">Summary of the problem of ‚Äútwo or more teachers‚Äù and a subjective opinion about the AI ‚Äã‚Äãcommunity</a></li>
<li><a href="../148850/index.html">Qt + OpenCV. New device GigE interface access to network cameras as CvCapture</a></li>
<li><a href="../148851/index.html">VKontakte messenger for Windows Phone, prize pool 2 000 000 rubles!</a></li>
<li><a href="../148853/index.html">Runetology (158): founder of the online hotel booking service Oktogo.ru Marina Kolesnik</a></li>
<li><a href="../148854/index.html">Internet marketing: how to make content relevant</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>