<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>WG Contract API: zoo of services</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="With an increase in the number of components in a software system, the number of people participating in its development usually increases. As a resul...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>WG Contract API: zoo of services</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/iz/gg/o8/izggo8dsjxgjso5tku-q65ezmwq.jpeg"><br><br>  With an increase in the number of components in a software system, the number of people participating in its development usually increases.  As a result, in order to maintain the pace of development and ease of maintenance, approaches to organizing the API should be the subject of special attention. <br><br>  If you want to learn more about how the Wargaming Platform team copes with the complexity of the system from more than a hundred web services interacting with each other, then welcome to Cat. <br><a name="habracut"></a><br>  Hello!  My name is Valentin and I am an engineer on ‚ÄúPlatform‚Äù at Wargaming.  For those who do not know what a platform is and what it does, I will leave here a <a href="https://habr.com/en/company/wargaming/blog/434004/">link</a> to the recent publication of one of my colleagues - <a href="https://habr.com/ru/users/max_posedon/">max_posedon</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At the moment I have been working in the company for more than five years and partially found the period of active growth of World of Tanks.  To uncover the issues raised in this article, I need to start with a brief insight into the history of the Wargaming Platform. <br><br><h2>  A bit of history </h2><br>  The growth of the popularity of ‚Äútanks‚Äù turned out to be avalanche-like, and as is usually the case in such cases, the infrastructure around the game began to grow rapidly.  As a result, the game very quickly became overgrown with various web services, and at the time of my joining the team, their account was already running for dozens (now, by the way, more than 100 platform components work and benefit the company). <br><br>  As time went on, new games came out, and it was no longer easy to understand the intricacies of integration between web services.  The situation only worsened when teams from other offices of Wargaming joined the development of the platform.  Development has become distributed, with all the consequences in the form of distance, time zones and language barrier.  And the service has become even more.  Finding someone who understood well how the platform as a whole works was not so easy.  Information often had to be collected in parts from different sources. <br><br>  The interfaces of various web services could be very different from each other in a stylistic design, which made the process of integration with the platform even more difficult.  And direct inter-component dependencies reduced development flexibility by complicating the decomposition of functionality within the platform.  Worse, the games ‚Äî platform clients ‚Äî knew our topology well, since they had to integrate directly with each platform service.  This gave them the opportunity, using horizontal links, to lobby for the implementation of certain improvements directly in the component with which they are integrated.  This led to the appearance of duplicate functionality in various components of the platform, as well as to the impossibility of extending the existing functionality to other games.  It became obvious that to continue to build a platform around each specific game is a dead-end branch of development.  We needed technical and organizational changes, as a result of which we would be able to control the growing complexity of a fast-growing system and make the entire functionality of the platform usable by any game. <br><br>  At this point, I want to finish the historical excursion and, finally, to talk about one of our technical solutions, which helps to keep under control the complexity caused by the ever-growing number of services.  In addition, it reduces the cost of developing new functionality and greatly simplifies integration with the platform. <br><br><h2>  Meet the Contract API </h2><br>  Inside the platform, we call it the Contract API.  At its core, this is an integration framework, represented by a set of documentation and client libraries for each technology from our stack (Erlang / Elixir, Java / Scala, Python).  It is developed, first of all, in order to simplify the integration of platform components with each other.  Secondly, to help us solve a number of the following problems: <br><br><ul><li>  stylistic differences of software interfaces </li><li>  the presence of direct inter-component dependencies </li><li>  keeping documentation up to date </li><li>  introspection and debugging of end-to-end functionality </li></ul><br>  So, first things first. <br><br><h2>  Stylistic differences in software interfaces </h2><br>  In my opinion, this problem arose as a result of a combination of several factors: <br><br><ul><li>  <b>No strict standard on how the API should look.</b>  The code of recommendations often has no proper effect, the API still turns out to be different.  Especially if the development is conducted by teams from different offices of the company.  Each team has its own habits and practices.  In aggregate, such APIs often do not look like parts of a whole. </li><li>  <b>The lack of a single directory with the names and formats of business-specific entities.</b>  As a rule, it is impossible to take an entity from the result of the work of one API and transfer it to the API of another service.  This requires transformation. </li><li>  <b>The lack of a mandatory centralized review system for the API.</b>  There are always tight deadlines and there is no time for collecting uprudes and, moreover, making changes to the API, which in fact often turns out to be already half tested. </li></ul><br>  The first thing we did when designing the Contract API was to state that from now on the API belongs to the platform, and not to a single component.  This led to the fact that the development of new functionality begins with a pull-request to the centralized API repository.  At the moment we use the GIT repository as a repository.  For convenience, we have divided the entire API into separate business functions, formalized the structure of this function and called its Contract. <br><br>  Since then, each new business function in our contract API should be described in a special format and pass through a pull request with a mandatory review.  There is no other way to publish a new API in the Contract API.  In the same repository, we identified a directory of business-specific entities and suggested that contract developers reuse them instead of describing these entities on their own. <br><br>  So we got the conceptually holistic API of the platform, which looked like a single product, despite the fact that it was actually implemented on a variety of platform components using different technological stacks. <br><br><h2>  The presence of direct inter-component dependencies </h2><br>  This problem of ours manifested itself in that each platform component was required to know who specifically serves the necessary functionality. <br><br>  And the matter was not even in the difficulty of keeping this reference book up to date, but in the fact that direct dependencies significantly complicated the migration of business functionality from one component of the platform to another.  The problem was especially acute when we began decomposing our monoliths into smaller components.  It turned out that convincing the client to replace the working integration with any functionality with the same from a business point of view, but another from a technical point of view, is a rather not trivial managerial task.  The client simply does not see the point, since everything is fine with him.  As a result, bad-smelling layers of backward compatibility were written, which only complicated the support of the platform and had a bad effect on the quality of service.  And since we are already going to standardize the platform API, it was necessary to solve this problem along the way. <br><br>  We faced a choice of several options.  Of these, we carefully considered: <br><br><ul><li>  Implementation of <i>service discovery</i> protocols on each of the components. </li><li>  The use of a <i>mediator</i> , which would redirect client requests to the correct component of the platform. </li><li>  Using a <i>message broker</i> as a messaging bus. </li></ul><br>  As a result of some thought and experimentation, the choice fell on the message broker, despite the fact that it was seen as a potential single point of failure and increased the overhead of operating the platform.  An important role in the selection was played by the fact that the platform at that time already had expertise in working with RabbitMQ.  And the broker itself was well scaled and had built-in mechanisms for ensuring fault tolerance.  As a bonus, we were able to implement an <i>event-driven architecture</i> ( <i>event-driven architecture</i> or <i>EDA</i> ) ‚Äúunder the hood‚Äù.  What subsequently opened up to us more opportunities for interservice interaction, compared with the interaction of the type ‚Äúpoint-to-point‚Äù. <br><br>  So, topologically, the platform began to turn from a graph with random connectivity into a star.  And the platform components inverted their dependencies and got the opportunity to interact with each other exclusively through contracts registered in the centralized repository, without having to know who specifically implements this or that contract.  In other words, all components within the platform were able to interact with each other using a single point of integration, which significantly simplified the life of the developers. <br><br><h2>  Keeping documentation up to date </h2><br>  Problems associated with the lack of documentation or the loss of its relevance are almost always encountered.  And the higher the pace of development, the more often it appears.  After the fact, it is difficult to assemble all API specifications for more than a hundred services in a distributed and multinational team in a single place and format. <br><br>  Developing the Contract API, we set a goal to solve this problem as well.  And we did it.  A strictly defined contract description format allowed for the construction of a process in accordance with which, immediately after the appearance of a new contract, the automatic assembly of documentation is launched.  This gives us confidence that our API documentation is always up to date.  This process is fully automated and does not require any effort on the part of development or management. <br><br><h2>  Introspection and debugging end-to-end functionality </h2><br>  As we crushed our monoliths into smaller components, quite naturally difficulties began to arise with debugging through-functionality.  If the maintenance of the business function was distributed across several platform components, then for localization and debugging of the problem, it was necessary to look for representatives from each of the components.  That at times it was difficult to achieve, given the 11-hour time difference with some of our colleagues. <br><br>  With the advent of the Contract API, and in particular thanks to the underlying message broker, we were able to receive copies of the messages involved in the execution of the business function, without side effects on the interaction participants.  To do this, it is not even necessary to know which of the platform components is responsible for processing a particular contract.  And after the problem is localized, we can get the identifier of the broken component from the metadata of the problem message. <br><br><h2>  What else have we developed on top of the Contract API </h2><br>  In addition to its main purpose and solving the above problems, the Contract API allowed us to implement a number of useful services. <br><br><h3>  Gateway to access platform functionality </h3><br>  Standardization of API in the form of contracts allowed us to develop a single point of access to platform functionality via HTTP.  Moreover, when new functionality (contracts) appears, we do not need to modify this access point in any way.  It is compatible in advance with all future contracts.  This allows you to work with the platform as a single product using the usual HTTP interface. <br><br><h3>  Bulk operations service </h3><br>  Any contract can be launched as part of a mass operation, with the ability to track its status and then receive a report on the results of this operation.  This service, just like the previous one, is compatible with all future contracts in advance. <br><br><h3>  Single processing platform errors </h3><br>  Protocol Contract API standardizes including errors.  This allowed us to implement an error interceptor that analyzes their severity and notifies the monitoring system of potential problems on the platform components.  And in the future will be able to make a decision about opening a bug on the platform component.  The error interceptor catches them directly from the message broker and does not know anything about the appointment of a contract or error, acting only on the basis of meta-information.  This allows him, as well as all the services described in this section, to be compatible with all future contracts in advance. <br><br><h3>  Automatic user interface generation </h3><br>  Strictly formalized contracts allow you to automatically build components of the user interface.  We developed a service that allows you to generate an administrative interface based on a collection of contracts, and then embed this interface in any of our platform tools.  Thus, those admins that we previously wrote with our hands can now be generated (albeit only partially) in automatic mode. <br><br><h3>  Logging of platform interactions </h3><br>  This component is currently not yet implemented and is at the stage of elaboration.  But in perspective, it will allow ‚Äúon the fly‚Äù to turn on and off logging of any business function in the platform, extracting this information directly from the message broker, without any side effects that adversely affect the interacting components. <br><br><h2>  The main purpose of the Contract API </h2><br>  But still, the main purpose of the Contract API is to reduce the costs of integrating the platform components. <br><br>  The developers are abstracted from the transport level by the libraries that we developed for each of our technological stacks.  This gives us some room for maneuver in case you have to change the message broker or even switch to point-to-point interaction.  The external interface of the library will remain unchanged. <br><br>  The library under the hood generates a message according to certain rules and sends it to the broker, after which, waiting for a response message, returns the result to the developer.  From the outside, it looks like a normal synchronous (or asynchronous, implementation-dependent) request.  I will give a few examples as a demonstration. <br><br>  An example of calling a contract using Python <br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> platform_client <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Client client = Client(contracts_path=CONTRACTS_PATH, url=AMQP_URL, app_id=<span class="hljs-string"><span class="hljs-string">'client'</span></span>) client.call(<span class="hljs-string"><span class="hljs-string">"ban-management.create-ban.v1"</span></span>, { <span class="hljs-string"><span class="hljs-string">"wgid"</span></span>: <span class="hljs-number"><span class="hljs-number">1234567890</span></span>, <span class="hljs-string"><span class="hljs-string">"reason"</span></span>: <span class="hljs-string"><span class="hljs-string">"Fraudulent activity"</span></span>, <span class="hljs-string"><span class="hljs-string">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"ru.wot"</span></span>, <span class="hljs-string"><span class="hljs-string">"component"</span></span>: <span class="hljs-string"><span class="hljs-string">"game"</span></span>, <span class="hljs-string"><span class="hljs-string">"bantype"</span></span>: <span class="hljs-string"><span class="hljs-string">"access_denied"</span></span>, <span class="hljs-string"><span class="hljs-string">"author_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"v_nikonovich"</span></span>, <span class="hljs-string"><span class="hljs-string">"expires_at"</span></span>: <span class="hljs-string"><span class="hljs-string">"2038-01-19 03:14:07Z"</span></span> }) { <span class="hljs-string"><span class="hljs-string">u'ban_id'</span></span>: <span class="hljs-number"><span class="hljs-number">31415926</span></span>, <span class="hljs-string"><span class="hljs-string">u'wgid'</span></span>: <span class="hljs-number"><span class="hljs-number">1234567890</span></span>, <span class="hljs-string"><span class="hljs-string">u'title'</span></span>: <span class="hljs-string"><span class="hljs-string">u'ru.wot'</span></span>, <span class="hljs-string"><span class="hljs-string">u'component'</span></span>: <span class="hljs-string"><span class="hljs-string">u'game'</span></span>, <span class="hljs-string"><span class="hljs-string">u'reason'</span></span>: <span class="hljs-string"><span class="hljs-string">u'Fraudulent activity'</span></span>, <span class="hljs-string"><span class="hljs-string">u'bantype'</span></span>: <span class="hljs-string"><span class="hljs-string">u'access_denied'</span></span>, <span class="hljs-string"><span class="hljs-string">u'status'</span></span>: <span class="hljs-string"><span class="hljs-string">u"active"</span></span>, <span class="hljs-string"><span class="hljs-string">u'started_at'</span></span>: <span class="hljs-string"><span class="hljs-string">u"2019-02-15T15:15:15Z"</span></span>, <span class="hljs-string"><span class="hljs-string">u'expires_at'</span></span>: <span class="hljs-string"><span class="hljs-string">u"2038-01-19 03:14:07Z"</span></span> }</code> </pre> <br>  The same contract call, but using Elixir <br><pre> <code class="plaintext hljs">:platform_client.call("ban-management.create-ban.v1", %{ "wgid" =&gt; 1234567890, "reason" =&gt; "Fraudulent activity", "title" =&gt; "ru.wot", "component" =&gt; "game", "bantype" =&gt; "access_denied", "author_id" =&gt; "v_nikonovich", "expires_at" =&gt; "2038-01-19 03:14:07Z" }) {:ok, %{ "ban_id" =&gt; 31415926, "wgid" =&gt; 1234567890, "title" =&gt; "ru.wot", "conponent" =&gt; "game", "reason" =&gt; "Fraudulent activity", "bantype" =&gt; "access_denied", "status" =&gt; "active", "started_at" =&gt; "2019-02-15T15:15:15Z", "expires_at" =&gt; "2038-01-19 03:14:07Z" }}</code> </pre><br>  At the place of the contract ‚Äúban-management.create-ban.v1‚Äù there can be any other platform functionality, for example: ‚Äúaccount-management.rename-account.v1‚Äù or ‚Äúnotification-center.create-sms-notification.v1‚Äù.  And all of it will be available through this single point of integration with the platform. <br><br>  The overview will be incomplete if not to demonstrate the Contract API from the point of view of the server developer.  Consider a situation in which a developer needs to implement a handler for the same ban-management.create-ban.v1 contract. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> platform_server <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> BlockingServer, handler <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomServer</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(BlockingServer)</span></span></span><span class="hljs-class">:</span></span> @handler(<span class="hljs-string"><span class="hljs-string">'ban-management.create-ban.v1'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle_create_ban</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, params, context)</span></span></span><span class="hljs-function">:</span></span> response = do_some_usefull_job(params) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response d = CustomServer(app_id=<span class="hljs-string"><span class="hljs-string">"server"</span></span>, amqp_url=AMQP_URL, contracts_path=CONTRACTS_PATH) d.serve()</code> </pre><br>  This code will be enough to start servicing the specified contract.  The server library will unpack and check the parameters of the request for correctness, and then call the contract handler with the request parameters already ready for processing.  Thus, the server developer is protected by the library, which, in case of receiving incorrect request parameters, will send a validation error to the client and register the fact of the problem. <br><br>  Due to the fact that the Contract API is implemented on the basis of events, we are able to go beyond the Query / Response scenario and implement a wider range of interservice interactions. <br><br>  For example: <br><br><ul><li>  make a request and forget (without waiting for an answer) </li><li>  make requests to several contracts simultaneously (even without using the event loop) </li><li>  make a request and get answers at once from several handlers (if provided for by the integration script) </li><li>  register the response handler (it works if the contract handler has reported completion, accepts the result of the contract handler, that is, his answer) </li></ul><br>  And this is not a complete list of scenarios that can be expressed through an event-based interaction model.  This is a list of those that we are currently using. <br><br><h2>  Instead of conclusion </h2><br>  We have been using the Contract API for several years.  Therefore, it is not possible to talk about all the scenarios for its use in a single review article.  For the same reason, I did not overload the article with technical details.  She already turned out quite voluminous.  Ask questions, and I will try to answer them right in the comments.  If any topic is particularly interesting, it will be possible to reveal it in more detail in a separate article. </div><p>Source: <a href="https://habr.com/ru/post/441708/">https://habr.com/ru/post/441708/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../441694/index.html">Why traffic graphics "lie"</a></li>
<li><a href="../441696/index.html">The history of Cyrillic LJ: how Russian management crushed the rise of Russian-language blogging</a></li>
<li><a href="../441698/index.html">Disconnection: what happens when you give up on Facebook?</a></li>
<li><a href="../441700/index.html">How a children's puzzle helps unlock the secrets of magnetism.</a></li>
<li><a href="../441702/index.html">About the storage of personal data, Roskomnadzor and dating sites</a></li>
<li><a href="../441710/index.html">Browser mobile games challenge you</a></li>
<li><a href="../441712/index.html">Mathematical solution of the problems of relativity</a></li>
<li><a href="../441714/index.html">How the locomotives were arranged</a></li>
<li><a href="../441716/index.html">Programming for non-programmers. Biography of June</a></li>
<li><a href="../441718/index.html">Security Week 09: 19-year vulnerability in WinRAR</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>