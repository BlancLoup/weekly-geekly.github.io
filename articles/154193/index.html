<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Recognition of custom gestures</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, when developing a game for Android, I was faced with the problem of implementing work with custom gestures. The standard Android SDK has a G...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Recognition of custom gestures</h1><div class="post__text post__text-html js-mediator-article">  Recently, when developing a game for Android, I was faced with the problem of implementing work with custom gestures.  The standard Android SDK has a GestureDetector class <i>( <a href="http://www.androidsnippets.com/gesturedetector-and-gesturedetectorongesturelistener">here is a</a> demonstration of working with this class)</i> , however, not all the gestures I needed were implemented, and some of them did not work as I should <i>(onLongPress, for example, did not work only on a long touch, but also on a long touch with a finger on the screen)</i> .  In addition to games, gestures can also be used in ordinary applications.  They can replace some interface elements, thus making it easier.  Gestures are already used in so many applications for touch input devices and this gives us the right to assume that the user is already familiar with them.  Today we are implementing in our application the recognition of <a href="">long press</a> , <a href="">double touch</a> , <a href="">pinch open</a> , <a href="">pinch close</a> and others. <br><br><img src="https://habrastorage.org/storage2/346/10f/dc2/34610fdc28a4d29cab21ceed1787c509.png" alt="Hello, Habr!"><a name="habracut"></a><br><br><h4>  Preproduction </h4><br>  For an example of working with a touch screen, multitouch and gestures, I decided to implement a simple graphic editor.  What should be our graphic editor?  A small dragging canvas, the distance to which you can change, spreading and bringing your fingers.  Also, in order not to confuse dragging the canvas and drawing on it, we must implement a mode change on a long touch.  By double-tapping you can display the color selection window. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Application Basis </h4><br>  First, create the Android Application Project in Eclipse.  Our project will not use any features from the new SDKs, so API 8 <i>(Android 2.2)</i> , for example, can be supplied as the Minimum Required SDK.  MainActivity <i>(if it is not</i> present <i>, then it will need to be created)</i> we <i>will result</i> in the following form: <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.Bundle; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.app.Activity; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApplicationView(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); } }</code> </pre> <br><br>  Accordingly, we need to create an ApplicationView class that will inherit from View: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.view.View; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.content.Context; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.graphics.Color; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.graphics.Paint; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.graphics.Canvas; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationView</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">View</span></span></span><span class="hljs-class"> </span></span>{ Paint paint = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Paint(); <span class="hljs-comment"><span class="hljs-comment">//  ,  static float density; public ApplicationView(Context context) { super(context); density = getResources().getDisplayMetrics().density; this.setBackgroundColor(Color.GRAY); //     paint.setStrokeWidth(5*density); //     5dp } @Override protected void onDraw(Canvas canvas) { } }</span></span></code> </pre><br><br>  Now we need to figure out how we will display the canvas.  We create a Canvas by passing it to the Bitmap parameters.  In this case, when drawing something on our canvas, it is displayed on a bitmap.  We also need a variable position of our canvas and the distance to it.  Add several variables to the class ApplicationView: <br><br><pre> <code class="java hljs">Canvas canvas; <span class="hljs-comment"><span class="hljs-comment">//  Bitmap image; //   float zoom = 500; //    Point position = new Point(50, 50); //  </span></span></code> </pre><br><br>  In the class constructor, initialize the canvas and its contents, and also paint it with white: <br><br><pre> <code class="java hljs">image = Bitmap.createBitmap(<span class="hljs-number"><span class="hljs-number">500</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>, Config.ARGB_4444); <span class="hljs-comment"><span class="hljs-comment">//    canvas = new Canvas(image); //   canvas.drawColor(Color.WHITE); //    </span></span></code> </pre><br><br>  In the onDraw method, display it: <br><br><pre> <code class="java hljs">canvas.translate(position.x, position.y); <span class="hljs-comment"><span class="hljs-comment">//   canvas.scale(zoom / 500, zoom / 500); //     canvas.drawBitmap(image, 0, 0, paint); //  </span></span></code> </pre><br><br>  If we launch our application now, we will see a white square on a gray background. <br><br><div class="spoiler">  <b class="spoiler_title">To make better</b> <div class="spoiler_text">  You can enhance the application by making it fullscreen and adding landscape orientation.  To do this, change the parameters of our Activity: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">activity</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".MainActivity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:label</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@string/title_activity_main"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:screenOrientation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"landscape"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  And also, for full screen, change the style-files.  For API 10 and below <i>(values ‚Äã‚Äã/ styles.xml)</i> : <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">resources</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"AppTheme"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">parent</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android:Theme.Light.NoTitleBar.Fullscreen"</span></span></span><span class="hljs-tag"> /&gt;</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">resources</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br><br>  For API 11 and higher <i>(values-v11 / styles.xml)</i> : <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">resources</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"AppTheme"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">parent</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android:Theme.Holo.Light.NoActionBar.Fullscreen"</span></span></span><span class="hljs-tag"> /&gt;</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">resources</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br><br>  For API 14 <i>(values ‚Äã‚Äã/ styles-v14.xml)</i> : <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">resources</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"AppTheme"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">parent</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android:Theme.DeviceDefault.Light.NoActionBar.Fullscreen"</span></span></span><span class="hljs-tag"> /&gt;</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">resources</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> </div></div><br><br><h4>  The implementation of the touch screen </h4><br>  We need to start interacting with the touchscreen by overriding the onTouchEvent method <i>(for more on working with the touchscreen <a href="http://habrahabr.ru/post/111405/">here</a> )</i> : <br><br><pre> <code class="java hljs">ArrayList&lt;Finger&gt; fingers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;Finger&gt;(); <span class="hljs-comment"><span class="hljs-comment">//  ,    @Override public boolean onTouchEvent(MotionEvent event) { int id = event.getPointerId(event.getActionIndex()); //   int action = event.getActionMasked(); //  if(action == MotionEvent.ACTION_DOWN || action == MotionEvent.ACTION_POINTER_DOWN) fingers.add(event.getActionIndex(), new Finger(id, (int)event.getX(), (int)event.getY())); else if(action == MotionEvent.ACTION_UP || action == MotionEvent.ACTION_POINTER_UP) fingers.remove(fingers.get(event.getActionIndex())); //  ,    else if(action == MotionEvent.ACTION_MOVE){ for(int n = 0; n &lt; fingers.size(); n++){ //     fingers.get(n).setNow((int)event.getX(n), (int)event.getY(n)); } //checkGestures(); invalidate(); } return true; }</span></span></code> </pre> <br><br>  We see that when you touch your finger, we add an object of the Finger type to the list of fingers.  When we lift a finger, we remove this object, and when we move our fingers, we update the coordinates of all objects.  As a result, the fingers list contains all the touches with the current and previous coordinates.  Finger class: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.graphics.Point; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Finger</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ID; <span class="hljs-comment"><span class="hljs-comment">//   public Point Now; public Point Before; boolean enabled = false; //      public Finger(int id, int x, int y){ ID = id; Now = Before = new Point(x, y); } public void setNow(int x, int y){ if(!enabled){ enabled = true; Now = Before = new Point(x, y); }else{ Before = Now; Now = new Point(x, y); } } }</span></span></code> </pre> <br><br><div class="spoiler">  <b class="spoiler_title">Validation</b> <div class="spoiler_text">  We can display all touches by simple manipulations.  To do this, in the onDraw method, enter this: <br><br><pre> <code class="java hljs">canvas.restore(); <span class="hljs-comment"><span class="hljs-comment">//      for(int i = 0; i &lt; fingers.size(); i++){ //       canvas.drawCircle(fingers.get(i).Now.x, fingers.get(i).Now.y, 40 * density, paint); }</span></span></code> </pre> </div></div><br><br><h4>  Moving the canvas </h4><br>  To implement the canvas transfer, we need to call the checkGestures method, which will work with touches, in the onTouchEvent method, in the object transfer unit.  The call to this method is already there, but under the comment.  Uncomment it and write the method itself: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkGestures</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ Finger point = fingers.get(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    position.x += point.Now.x - point.Before.x; //   position.y += point.Now.y - point.Before.y; }</span></span></code> </pre> <br><br>  You can run and drag your finger and if everything is done correctly, the canvas should be dragged behind it. <br><br><h4>  Change the distance to the canvas </h4><br><br>  To implement this gesture, you need to divide the entire contents of the method into multitouch <i>(when there is more than one finger)</i> and the usual touch.  If it is multitouch, then we will constantly check the current distance between two fingers and the past.  Change the contents of the checkGestures method: <br><br><pre> <code class="java hljs">Finger point = fingers.get(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(fingers.size() &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>){ <span class="hljs-comment"><span class="hljs-comment">// Multitouch //     (now)   (before) float now = checkDistance(point.Now, fingers.get(1).Now); float before = checkDistance(point.Before, fingers.get(1).Before); float oldSize = zoom; //     zoom = Math.max(now - before + zoom, density * 25); //     position.x -= (zoom - oldSize) / 2; //    position.y -= (zoom - oldSize) / 2; }else{ //   position.x += point.Now.x - point.Before.x; position.y += point.Now.y - point.Before.y; }</span></span></code> </pre> <br><br>  In this section of the code, the checkDistance method was used, which needs to be added to the ApplicationView.  Here is his code: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkDistance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Point p1, Point p2)</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       return FloatMath.sqrt((p1.x - p2.x)*(p1.x - p2.x)+(p1.y - p2.y)*(p1.y - p2.y)); }</span></span></code> </pre> <br><br>  Now when you touch two fingers and mixing / breeding them, the distance to the canvas will change.  If you have an emulator, it will not work. <br><br><h4>  Mode change </h4><br><br>  We need to create a variable that will be responsible for the mode.  I called it a boolean drawingMode.  To implement a long touch, we have to use a method that will be called in time.  There are several options for the development of events: <br><ol><li>  we write our code in the onDraw method; </li><li>  we write our code in onTouchEvent; </li><li>  we create a timer and write code into it; </li><li>  we create a Handler and call our Runnable using the postDelayed method; </li></ol><br>  In the onDraw method, in my opinion, only the display of graphics should be performed.  In onTouchEvent, you can only write with the fact that the finger will move, thereby constantly calling this method.  The timer works constantly and it is a little annoying, so we will use the fourth option.  In the ApplicationView class, we create a handler variable of type Handler, and also add an onTouchEvent line to the if block (if (action == MotionEvent.ACTION_DOWN || action == MotionEvent.ACTION_POINTER_DOWN)) block: <br><br><pre> <code class="java hljs">handler.postDelayed(longPress, <span class="hljs-number"><span class="hljs-number">1000</span></span>);</code> </pre><br><br>  Now you need to create a Runnable named longPress: <br><br><pre> <code class="java hljs">Runnable longPress = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } };</code> </pre><br><br>  Now, in the Finger class, we need to create a long type wasDown variable, which will contain the time of pressing <i>(useful for double-tapping)</i> .  In the constructor of this variable, you must set the value of System.currentTimeMillis ().  We also need to add a StartPoint variable of type Point, which will contain the starting position of the finger.  It must contain the value that was passed to the constructor, or the first time you call setNow.  We also need to create a boolean-type enabledLongTouch variable that represents the suitability of this touch for the event we are implementing.  We need to constantly check whether the finger has moved too far from the start.  This functionality can be implemented in setNow.  The result should be something like this: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.graphics.Point; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Finger</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ID; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Point Now; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Point Before; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> wasDown; <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> enabled = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> enabledLongTouch = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; Point startPoint; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Finger</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y)</span></span></span></span>{ wasDown = System.currentTimeMillis(); ID = id; Now = Before = startPoint = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point(x, y); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setNow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!enabled){ enabled = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; Now = Before = startPoint = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point(x, y); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ Before = Now; Now = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point(x, y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ApplicationView.checkDistance(Now, startPoint) &gt; ApplicationView.density * <span class="hljs-number"><span class="hljs-number">25</span></span>) enabledLongTouch = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } } }</code> </pre> <br><br>  Now in the run method of our Runnable, we can check whether this is a long touch: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(fingers.size() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; fingers.get(<span class="hljs-number"><span class="hljs-number">0</span></span>).enabledLongTouch){ fingers.get(<span class="hljs-number"><span class="hljs-number">0</span></span>).enabledLongTouch = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; drawingMode = !drawingMode; vibrator.vibrate(<span class="hljs-number"><span class="hljs-number">80</span></span>); }</code> </pre> <br><br><div class="spoiler">  <b class="spoiler_title">To make better</b> <div class="spoiler_text">  To make a long touch better, you need to turn on a light vibration when it is activated.  To do this, simply create a vibrator variable of type Vibrator and in the constructor set its value as follows: <br><pre> <code class="java hljs">vibrator = (Vibrator)context.getSystemService(Context.VIBRATOR_SERVICE);</code> </pre> <br>  <b>Important:</b> to work with vibration in manifest, the following line should be: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.VIBRATE"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> <br>  Then in the run method, our timer at the end of the test for a long touch can be entered: <br><pre> <code class="java hljs">vibrator.vibrate(<span class="hljs-number"><span class="hljs-number">80</span></span>);</code> </pre> </div></div><br><br><h4>  Drawing </h4><br><br>  Now we are implementing drawing on canvas and resizing the brush.  To do this, we will divide each part of the checkGestures method into two more parts: the drawing mode and the normal mode.  In the drawing mode when you touch, we will simply draw a line, and in the drawing mode with multitouch we will change the size of the brush.  This is what the checkGestures method will look like: <br><br><pre> <code class="java hljs">Finger finger = fingers.get(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(fingers.size() &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> now = checkDistance(finger.Now, fingers.get(<span class="hljs-number"><span class="hljs-number">1</span></span>).Now); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> before = checkDistance(finger.Before, fingers.get(<span class="hljs-number"><span class="hljs-number">1</span></span>).Before); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!drawingMode){ <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> oldSize = zoom; zoom = Math.max(now - before + zoom, density * <span class="hljs-number"><span class="hljs-number">25</span></span>); position.x -= (zoom - oldSize) / <span class="hljs-number"><span class="hljs-number">2</span></span>; position.y -= (zoom - oldSize) / <span class="hljs-number"><span class="hljs-number">2</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> paint.setStrokeWidth(paint.getStrokeWidth() + (now - before) / <span class="hljs-number"><span class="hljs-number">8</span></span>); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!drawingMode){ position.x += finger.Now.x - finger.Before.x; position.y += finger.Now.y - finger.Before.y; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x1 = (finger.Before.x-position.x)*<span class="hljs-number"><span class="hljs-number">500</span></span>/zoom; <span class="hljs-comment"><span class="hljs-comment">//   float x2 = (finger.Now.x-position.x)*500/zoom; //    float y1 = (finger.Before.y-position.y)*500/zoom; //   float y2 = (finger.Now.y-position.y)*500/zoom; canvas.drawLine(x1, y1, x2, y2, paint); //   canvas.drawCircle(x1, y1, paint.getStrokeWidth() / 2, paint); //   canvas.drawCircle(x2, y2, paint.getStrokeWidth() / 2, paint); cursor = finger.Now; } }</span></span></code> </pre> <br><br>  In the last line I set the value to nobody cursor.  It is a variable of type Point containing the coordinates of the cursor.  The cursor is only needed to navigate the size of the brush.  To display the cursor in the onDraw method, add: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(drawingMode){ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> old = paint.getColor(); <span class="hljs-comment"><span class="hljs-comment">//    paint.setColor(Color.GRAY); //     canvas.drawCircle((cursor.x-position.x)*500/zoom, (cursor.y-position.y)*500/zoom, paint.getStrokeWidth() / 2, paint); //      paint.setColor(old); //    }</span></span></code> </pre> <br><br>  Now we can move the canvas, zoom in, move it away, switch to drawing mode, draw, change the size of the brush.  It remains only to realize the choice of color. <br><br><h4>  Color selection </h4><br><br>  The choice of color occurs after double-tapping on the screen.  To do this, in ApplicationView you need to create a variable that saves the last touch on the screen and a variable that saves the coordinates of this touch.  The first one will be called lastTapTime of type long, and the second one - lastTapPosition of type Point.  Then change the onTouchEvent method: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id = event.getPointerId(event.getActionIndex()); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> action = event.getActionMasked(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(action == MotionEvent.ACTION_DOWN || action == MotionEvent.ACTION_POINTER_DOWN) fingers.add(event.getActionIndex(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Finger(id, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)event.getX(), (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)event.getY())); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(action == MotionEvent.ACTION_UP || action == MotionEvent.ACTION_POINTER_UP){ Finger finger = fingers.get(event.getActionIndex()); <span class="hljs-comment"><span class="hljs-comment">//    //     100,       200, //             25dp if(System.currentTimeMillis() - finger.wasDown &lt; 100 &amp;&amp; finger.wasDown - lastTapTime &lt; 200 &amp;&amp; finger.wasDown - lastTapTime &gt; 0 &amp;&amp; checkDistance(finger.Now, lastTapPosition) &lt; density * 25){ //     } lastTapTime = System.currentTimeMillis(); //     lastTapPosition = finger.Now; //     fingers.remove(fingers.get(event.getActionIndex())); }else if(action == MotionEvent.ACTION_MOVE){ for(int n = 0; n &lt; fingers.size(); n++){ fingers.get(n).setNow((int)event.getX(n), (int)event.getY(n)); } checkGestures(); } return true;</span></span></code> </pre> <br><br>  It remains for us to implement the color selection dialog.  Where a touch occurs <i>(marked with a comment)</i> , we write: <br><br><pre> <code class="java hljs">Builder builder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AlertDialog.Builder(getContext()); String[] items = {<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AlertDialog dialog = builder.setTitle(<span class="hljs-string"><span class="hljs-string">"  "</span></span>).setItems(items, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DialogInterface.OnClickListener() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DialogInterface dialog, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> which)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] colors = {Color.RED, Color.GREEN, Color.BLUE, <span class="hljs-number"><span class="hljs-number">0xFF99CCFF</span></span>, Color.BLACK, Color.WHITE, Color.YELLOW, <span class="hljs-number"><span class="hljs-number">0xFFFFCC99</span></span>}; paint.setColor(colors[which]); } }).create(); dialog.show();</code> </pre> <br><br>  If you run the application, you will see that by double-tapping the color selection window appears. <br><br><h4>  Conclusion </h4><br><br>  Recognizing user gestures was not so difficult.  We disassembled this on the example of the implementation of a graphical editor.  A similar implementation, of course, can have not only applications, but also games. <br><br>  Sources of the project <a href="https://github.com/suVrik/GesturesHabrahabr">here</a> . <br><br>  Used information from <a href="http://developer.android.com/intl/ru/index.html">developer.android.com</a> .  On the basis used <a href="http://habrahabr.ru/post/111405/">this</a> article. <br>  I would also like to thank the users of <a href="https://habrahabr.ru/users/andreymi/" class="user_link">AndreyMI</a> , <a href="https://habrahabr.ru/users/leoccoder/" class="user_link">LeoCcoder</a> , <a href="https://habrahabr.ru/users/silentnuke/" class="user_link">silentnuke</a> and <a href="https://habrahabr.ru/users/vovkab/" class="user_link">vovkab</a> </div><p>Source: <a href="https://habr.com/ru/post/154193/">https://habr.com/ru/post/154193/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../154181/index.html">Freelancer start working in pairs</a></li>
<li><a href="../154185/index.html">Turning the router into an XBee-to-Ethernet Gateway</a></li>
<li><a href="../154187/index.html">C / C ++ web application with FastCGI - it‚Äôs just</a></li>
<li><a href="../154189/index.html">Published free e-books on Windows Azure technology from the Patterns & Practices team</a></li>
<li><a href="../154191/index.html">DBSlayer proxy on BASH in 5 minutes or another way to send JSON from MySQL</a></li>
<li><a href="../154197/index.html">Call Manager & Skype connect via CUBE</a></li>
<li><a href="../154199/index.html">Mail.Ru Mail for WP7: development, close-up</a></li>
<li><a href="../154203/index.html">Office supplies that may disappear in the future</a></li>
<li><a href="../154205/index.html">NetApp: Compatibility Matrix</a></li>
<li><a href="../154207/index.html">Microsoft creates a prototype wearable manipulator in 3D space</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>