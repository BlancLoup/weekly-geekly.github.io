<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to make the next bot in Telegram</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It has become fashionable to use messengers as a platform for the so-called "conversational commerce": now, in addition to smoothies and co-working, a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to make the next bot in Telegram</h1><div class="post__text post__text-html js-mediator-article"><p>  It has become fashionable to use messengers as a platform for the so-called "conversational commerce": now, in addition to smoothies and co-working, a self-respecting startup must acquire a bot or, at least, a channel in a telegram.  To help them, we not only wrote a bot who was looking for the best coffee <s>smoothies and co-workers</s> and burgers in the city, but also an article about how we designed it. </p><br><br><p>  In our small tutorial, we will talk about how to create a bot, set up a graphical menu, edit messages and send text and photos in one message. </p><a name="habracut"></a><br><br><h2>  Why do we need a bot? </h2><br><p>  <a href="http://tagvisor.com/">Tagvisor</a> - service for finding real reviews about the institution.  We aggregate them by geolocation, hashtags, and from the official accounts of institutions in social networks.  Next, we rank in popularity (number and freshness of posts on social networks) and proximity to the user. </p>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>  Custdev showed that our target audience is often looking for places near the phone.  Does not like to see more than 20 options in the search results, wants to immediately see reviews, photos and mark places on the map. </p><br><br><p>  It would be logical to roll out a mobile application, but the development cost and entry threshold for a potential user is too high for a young startup.  We decided to go the fashionable way and released a bot as an mvp. </p><br><br><p>  <a href="http://telegram.me/tagvisorbot">@TagvisorBot</a> shows the institution closest to you in the selected category. <br>  As in the desktop version of the service, the main content of the issue are posts from social networks. </p><br><br><h2>  Development </h2><br><p>  For implementation, Node.js and fork were chosen for the <a href="https://github.com/tjhorner/node-telegram-bot-api">@ node-telegram-bot-api</a> module, adapted for Telegram 2.0. </p><br><br><p>  We mainly used the <a href="https://core.telegram.org/bots/api">API telegram</a> documentation and the node-telegram-bor-api module.  For people who love Russian documentation, there is a <a href="https://tlgrm.ru/docs/bots/api">translation</a> , but it is still in the process.  There is also a group of developers from all over Russia in <a href="https://telegram.me/joinchat/ABI4pz3M7FCxoDZcdcfVUA">Telegram</a> itself) and on <a href="https://www.facebook.com/groups/chatbotsdevelopers">facebook</a> .  In groups you can always write a question, usually answer within a couple of days. </p><br><br><h2>  Creature </h2><br><p>  To create a bot, first of all, knock on <a href="https://telegram.me/BotFather">@botfather</a> with the / newbot command.  He will ask you to write the name of the bot and its username (which should end with bot).  When creating the bot, @botfather will report the http-token for api.  Commands beginning with / set will help you to configure various parameters of the bot, such as name, description, avatar, text in profile and description.  Everything is quite simple. </p><br><br><p>  For the bot to work, you need to select the update mode: polling or WebHook. </p><br><br><ul><li>  in WebHook mode, the Telegram server will send data to your bot, each time a request is received.  This is a convenient and reliable option, and, most importantly, fast, but, unfortunately, this mode requires https-connection and certificate. </li><li>  in polling mode, the bot will go to the Telegram server itself and collect new data.  This mode is much simpler, but the reaction of the bot will not be instantaneous, but on average with a half second delay.  In addition, you need to consider that sometimes there are failures in the response from the server, so the bot should be made resistant to such errors. </li></ul><br><br><h2>  Run bot </h2><br><p>  To start the bot, you need to connect the package and transfer the necessary data to the bot: token and update mode. </p><br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TelegramBot = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./lib/telegram.js'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bot = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TelegramBot(<span class="hljs-string"><span class="hljs-string">'YOUR_TOKEN'</span></span>, {<span class="hljs-attr"><span class="hljs-attr">polling</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}); bot.getMe().then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">me</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Hi my name is %s!'</span></span>, me.username); });</code> </pre> <br><br><p>  The call to the getMe () function occurs when the bot token is successfully authorized and the program is issued.  In this case, the function getMe (). Then () takes the function function (me) as an argument.  Its first argument is an object with which you can get various information about your bot and, in this case, output it to the console. </p><br><br><p>  Next, to teach the bot to send messages, you need to use the bot.sendMessage method (chatId, 'Hello World !!!');  And for a bot to understand incoming requests, it is enough to use bot.on ('message', function (msg) {}).  The methods are described in more detail in the <a href="https://github.com/tjhorner/node-telegram-bot-api">node-telegram-bot-api</a> documentation. </p><br><br><h2>  Beautiful buttons </h2><br><p>  In order for the user to see the inline keyboard instead of the standard one, you need to send its parameters to the sendMessage method when sending messages: </p><br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> opt = { <span class="hljs-attr"><span class="hljs-attr">parse_mode</span></span>: <span class="hljs-string"><span class="hljs-string">'markdown'</span></span>, <span class="hljs-attr"><span class="hljs-attr">disable_web_page_preview</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">reply_markup</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify({ <span class="hljs-attr"><span class="hljs-attr">inline_keyboard</span></span>: [ [{<span class="hljs-attr"><span class="hljs-attr">text</span></span>: <span class="hljs-string"><span class="hljs-string">` </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${emoji.get(</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">'ru'</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-attr"><span class="hljs-attr">callback_data</span></span>:<span class="hljs-string"><span class="hljs-string">'rus'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">text</span></span>: <span class="hljs-string"><span class="hljs-string">`English </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${emoji.get(</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">'gb'</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-attr"><span class="hljs-attr">callback_data</span></span>:<span class="hljs-string"><span class="hljs-string">'eng'</span></span>}] ] }) } bot.sendMessage(chatId, <span class="hljs-string"><span class="hljs-string">'language?'</span></span>,opt);</code> </pre><br><br><p>  Where text is the text on the button, callback_data is the data that the bot will receive when the button is pressed. </p><br><br><img src="https://habrastorage.org/files/009/25b/aeb/00925baeb45045e2959208858bbb062f.png"><br><br><p>  Accordingly, in order to catch the events of pressing a certain button, you need to use the method. </p><br><br><pre> <code class="javascript hljs">bot.on(<span class="hljs-string"><span class="hljs-string">'callback_query'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">msg</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msg.data === <span class="hljs-string"><span class="hljs-string">'rus'</span></span>){ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(‚ÄúRussian‚Äù); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msg.data === <span class="hljs-string"><span class="hljs-string">'eng'</span></span>){ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(‚ÄúEnglish‚Äù); } });</code> </pre><br><br><h2>  Change message </h2><br><p>  Sometimes you want not to send the message again, and correct the already existing (for convenience of displaying data).  To do this, we decided to use the bot.editMessageText (text, opt) method;  where text is the modified message text, opt - Additional options for requesting a telegram, such as the presence of a keyboard, text formatting, and more. </p><br><img src="https://habrastorage.org/files/cb0/cf4/ca2/cb0cf4ca2bb6447888a4d9b0d094e18b.png"><img src="https://habrastorage.org/files/0d1/703/563/0d170356398a4bb18f2c1bba20763e0a.png"><br><br><h2>  Sending text and photos in one message </h2><br><p>  The standard sendPhoto method is not suitable, as it has limitations on the number of characters in the text and other formatting - the text is written under the photo.  Therefore, we used sendMessage and simply inserted a link to the desired image into the message text. </p><br><br><img src="https://habrastorage.org/files/c08/288/1a7/c082881a79da48b9a73fc7eeb1378bea.png"><br><br><p>  In order for the telegram to load the image into the message, you need to set the disable_web_page_preview parameter: false. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> opt = { <span class="hljs-attr"><span class="hljs-attr">chat_id</span></span>: chatId, <span class="hljs-attr"><span class="hljs-attr">parse_mode</span></span>: <span class="hljs-string"><span class="hljs-string">'markdown'</span></span>, <span class="hljs-attr"><span class="hljs-attr">disable_web_page_preview</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, reply_markup = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify({ <span class="hljs-attr"><span class="hljs-attr">inline_keyboard</span></span>: [..] }) }</code> </pre><br><br><p>  To format the text you need to set the parse_mode parameter.  It has two meanings: markdown and html.  If the value is markdown, formatting is used: </p><br><br><pre> <code class="javascript hljs">*bold text* _italic text_ [text](URL) <span class="hljs-string"><span class="hljs-string">`inline fixed-width code`</span></span> <span class="hljs-string"><span class="hljs-string">``</span></span><span class="hljs-string"><span class="hljs-string">`pre-formatted fixed-width code block`</span></span><span class="hljs-string"><span class="hljs-string">``</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> text = <span class="hljs-string"><span class="hljs-string">'[](url)'</span></span>; bot.sendMessage(chatId, text);</code> </pre><br><br><h2>  Bot store </h2><br><p>  To see all this beauty of the world, and not just your users, you can <s>write an article on Habr</s> upload your bot to the store store store bot. </p><br><br><p>  Registration and publication is simple - just log in on the <a href="https://storebot.me/">storebot.met</a> website and then click ‚ÄúAddBot‚Äù in the menu ‚ÄúAdd-Dele-Ready‚Äù.  This is not a moderation in the AppStore. </p><br><br><h2>  Bonus for the coolest </h2><br><img src="https://habrastorage.org/files/fef/9fe/9bc/fef9fe9bc0774fa9908bdda590345da8.jpg"><br><br><p>  So, with the help of our small tutorial, you could learn how to make a bot in a telegraph.  We hope it was useful for you.  And if you are a cool developer, and it was all obvious to you, then we invite you to participate in a small challenge: as we already wrote above, Tagvisor also has a desktop version, which we recently launched in test mode.  And to the one who finds the most bugs (in the layout, code, mobile version), we will organize the delivery of three large pizzas.  Found bugs send mail bugtracker@tagvisor.com. </p></div><p>Source: <a href="https://habr.com/ru/post/306036/">https://habr.com/ru/post/306036/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../306026/index.html">Connect the HP tape library via Fiber Channel to an ESXi 5.5 host</a></li>
<li><a href="../306028/index.html">CLion 2016.2 release: remote debugging, Doxygen format support, new code generation features and much more</a></li>
<li><a href="../306030/index.html">Software update and initial setup instructions for Nokia 7210 SAS-M</a></li>
<li><a href="../306032/index.html">Introduction to Veeam Agent for Linux</a></li>
<li><a href="../306034/index.html">Removing a key from a token with a non-recoverable key</a></li>
<li><a href="../306038/index.html">Webinar: Meet Asterisk</a></li>
<li><a href="../306040/index.html">Hiring technicians sank by 40% - and no one talks about it</a></li>
<li><a href="../306044/index.html">Why doesn't Wi-Fi based positioning take off</a></li>
<li><a href="../306046/index.html">Interview with mom, bank programmer on COBOL</a></li>
<li><a href="../306048/index.html">Text Editors vs IDE</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>