<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PostgreSQL 9.5: what's new? Part 1. INSERT ... ON CONFLICT DO NOTHING / UPDATE and ROW LEVEL SECURITY</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Part 2. TABLESAMPLE 
 Part 3. GROUPING SETS, CUBE, ROLLUP 
 In the 4th quarter of 2015, PostgreSQL 9.5 is expected to be released. As always, the new ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PostgreSQL 9.5: what's new? Part 1. INSERT ... ON CONFLICT DO NOTHING / UPDATE and ROW LEVEL SECURITY</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://habrahabr.ru/post/266759/">Part 2. TABLESAMPLE</a> <br>  <a href="http://habrahabr.ru/post/269849/">Part 3. GROUPING SETS, CUBE, ROLLUP</a> <br>  <a href="http://www.postgresql.org/developer/roadmap/">In the 4th quarter of 2015,</a> PostgreSQL 9.5 is expected to be released.  As always, the new version, <s>in addition to new bugs,</s> brings new features and "buns".  In this article, two of them will be considered, namely INSERT ... ON CONFLICT DO NOTHING / UPDATE and Row-level security.  The second alpha version has already been released, so the most impatient can install it and try new functionality. <br>  You can download it <a href="http://www.postgresql.org/download/snapshots/">here.</a> <br><a name="habracut"></a><br><ul><li>  <a href="https://habr.com/ru/post/264281/">INSERT ... ON CONFLICT DO NOTHING / UPDATE</a> </li><li>  <a href="https://habr.com/ru/post/264281/">Row-level security</a> </li></ul><br><a name="UPSERT"></a><h4>  INSERT ... ON CONFLICT DO NOTHING / UPDATE </h4><br><br>  He is colloquially UPSERT.  Allows in case of a conflict when inserting to update the fields or ignore the error. <br><br>  What was previously proposed to be implemented using the <a href="http://www.postgresql.org/docs/current/static/plpgsql-control-structures.html">stored function</a> will now be available out of the box.  You can use the <b>ON CONFLICT DO NOTHING / UPDATE</b> clause in an <b>INSERT</b> <b>statement</b> .  In this case, the expression indicates separately <b>conflict_target</b> (by which field / condition the conflict will be considered) and <b>conflict_action</b> (what to do when the conflict occurred: <b>DO NOTHING</b> or <b>DO UPDATE SET</b> ). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The complete syntax for an <b>INSERT statement</b> is: <br><pre><code class="sql hljs">[ <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> [ <span class="hljs-keyword"><span class="hljs-keyword">RECURSIVE</span></span> ] with_query [, ...] ] <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> table_name [ <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> ] [ ( column_name [, ...] ) ] { <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ( { expression | <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> } [, ...] ) [, ...] | <span class="hljs-keyword"><span class="hljs-keyword">query</span></span> } [ <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> CONFLICT [ conflict_target ] conflict_action ] [ <span class="hljs-keyword"><span class="hljs-keyword">RETURNING</span></span> * | output_expression [ [ <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ] output_name ] [, ...] ] <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> conflict_target can be one <span class="hljs-keyword"><span class="hljs-keyword">of</span></span>: ( { column_name_index | ( expression_index ) } [ <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">collation</span></span> ] [ opclass ] [, ...] ) [ <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> index_predicate ] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> constraint_name <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> conflict_action <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> one <span class="hljs-keyword"><span class="hljs-keyword">of</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOTHING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> { column_name = { expression | <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> } | ( column_name [, ...] ) = ( { expression | <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> } [, ...] ) | ( column_name [, ...] ) = ( sub-<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ) } [, ...] [ <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> condition ]</code> </pre> <br>  For us, the fun begins after ON CONFLICT. <br><br>  Let's look at examples.  Create a table in which the credentials of certain persons will lie: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> bigserial, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, surname <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, address <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> unique_person <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, surname, address) ); Query returned successfully <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> <span class="hljs-keyword"><span class="hljs-keyword">result</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">31</span></span> ms.</code> </pre><br>  Execute the insert request <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, surname, address) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">', '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> CONFLICT (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOTHING</span></span>; Query returned successfully: one row affected, 12 ms execution time. <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span>;</code> </pre><br><table border="1"><tbody><tr><th>  id </th><th>  name </th><th>  surname </th><th>  address </th></tr><tr><td>  one </td><td>  Vasya </td><td>  Pupkin </td><td>  Moscow Kremlin </td></tr></tbody></table><br>  Here, <b>conflict_target</b> is <b>(id)</b> and <b>conflict_action</b> is <b>DO NOTHING</b> . <br>  If you try to execute this query a second time, then the insertion will not occur, and it will not give you any error message: <br><pre> <code class="sql hljs">Query returned successfully: 0 rows affected, 12 ms execution time.</code> </pre> <br>  If we did not specify <b>ON CONFLICT (id) DO NOTHING</b> , we would get an error: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, surname, address) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">', '</span></span>); ********** Error ********** ERROR: duplicate key value violates unique constraint "account_pkey" SQL state: 23505 Detail: Key (id)=(1) already exists.</code> </pre><br>  The same behavior (as for <b>ON CONFLICT (id) DO NOTHING</b> ) will be for the query: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, surname, address) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">', '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> CONFLICT (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, surname, address) <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOTHING</span></span>; Query returned successfully: 0 rows affected, 12 ms execution time.</code> </pre><br>  In it, we already take the <b>id</b> value by default (from a sequence), but indicate another <b>conflict_target</b> ‚Äî in the three fields that are subject to a unique constraint. <br><br>  As mentioned above, you can also specify a <b>conflict_target</b> using the <b>ON CONSTRAINT construct</b> , specifying the constraint name itself: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, surname, address) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">', '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> CONFLICT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> unique_person <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOTHING</span></span>; Query returned successfully: 0 rows affected, 11 ms execution time.</code> </pre><br>  This is especially useful if you have an exclusion constraint, which you can refer to only by name, and not by a set of columns, as is the case with the restriction of uniqueness. <br><br>  If you have built a partial unique index, then this can also be specified in the condition.  Let only our people named Vasya will have unique combinations of the surname + address in our table: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> unique_person; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> unique_vasya <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> (surname, address) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>=<span class="hljs-string"><span class="hljs-string">''</span></span>;</code> </pre><br>  Then we can write this query: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, surname, address) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">', '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> CONFLICT (surname, address) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>=<span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOTHING</span></span>; Query returned successfully: 0 rows affected, 12 ms execution time.</code> </pre><br>  And finally, if you want <b>DO NOTHING to</b> be triggered by any uniqueness / exception conflict on insertion, this can be written as follows: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, surname, address) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">', '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> CONFLICT <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOTHING</span></span>; Query returned successfully: 0 rows affected, 12 ms execution time.</code> </pre><br>  It is worth noting that it is impossible to specify multiple <b>conflict_action</b> , so if one of them is specified and the other is triggered, then there will be an error when pasting: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, surname, address) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">', '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> CONFLICT (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOTHING</span></span>; ********** Error ********** ERROR: duplicate key value violates unique constraint "unique_person" SQL state: 23505 Detail: Key (name, surname, address)=(, , , ) already exists.</code> </pre><br>  Let us turn to the possibilities of <b>DO UPDATE SET</b> . <br><br>  For <b>DO UPDATE SET</b> , unlike <b>DO NOTHING,</b> an indication of <b>conflict_action is</b> required. <br><br>  The <b>DO UPDATE SET</b> construct updates the fields that are listed in it.  The values ‚Äã‚Äãof these fields can be set explicitly, set by default, obtained from a subquery, or taken from the special expression <b>EXCLUDED</b> , from which you can take data that was originally proposed for insertion. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, surname, address) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">', '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> CONFLICT (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>=<span class="hljs-string"><span class="hljs-string">''</span></span>, surname=<span class="hljs-string"><span class="hljs-string">''</span></span>; Query returned successfully: one row affected, 11 ms execution time. <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span>;</code> </pre><br><table border="1"><tbody><tr><th>  id </th><th>  name </th><th>  surname </th><th>  address </th></tr><tr><td>  one </td><td>  Petya </td><td>  Petrov </td><td>  Moscow Kremlin </td></tr></tbody></table><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> a (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, surname, address) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">', '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> CONFLICT (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>=EXCLUDED.name || <span class="hljs-string"><span class="hljs-string">' ( '</span></span> || a.name || <span class="hljs-string"><span class="hljs-string">')'</span></span>, surname=EXCLUDED.surname || <span class="hljs-string"><span class="hljs-string">' ( '</span></span> || a.surname || <span class="hljs-string"><span class="hljs-string">')'</span></span>; Query returned successfully: one row affected, 13 ms execution time. <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span>;</code> </pre><br><table border="1"><tbody><tr><th>  id </th><th>  name </th><th>  surname </th><th>  address </th></tr><tr><td>  one </td><td>  Petya (former Vasya) </td><td>  Petrov (former Pupkin) </td><td>  Moscow Kremlin </td></tr></tbody></table><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, surname, address) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">', '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> CONFLICT (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span>, surname=<span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span>; Query returned successfully: one row affected, 11 ms execution time. <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span>;</code> </pre><br><table border="1"><tbody><tr><th>  id </th><th>  name </th><th>  surname </th><th>  address </th></tr><tr><td>  one </td><td>  Null </td><td>  Null </td><td>  Moscow Kremlin </td></tr></tbody></table><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, surname, address) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">', '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> CONFLICT (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>=(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> some_field <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> other_table <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><br>  The <b>WHERE clause</b> can also be used.  For example, we want the <b>name</b> field not to be updated if the <b>address</b> field in the table row already contains the text ‚ÄúKremlin‚Äù, otherwise it would be added: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> a (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, surname, address) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">', '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> CONFLICT (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>=EXCLUDED.name <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> a.name <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%%'</span></span>; Query returned successfully: 0 rows affected, 12 ms execution time.</code> </pre><br>  And if we want the <b>name</b> field not to be updated, if the <b>address</b> field in the inserted data contains the text "Kremlin", otherwise, it was added: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> a (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, surname, address) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">',  '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> CONFLICT (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>=EXCLUDED.name <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> EXCLUDED.name <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%%'</span></span>; Query returned successfully: one row affected, 11 ms execution time. <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span></code> </pre><br><table border="1"><tbody><tr><th>  id </th><th>  name </th><th>  surname </th><th>  address </th></tr><tr><td>  one </td><td>  Vasya </td><td>  Null </td><td>  Moscow Kremlin </td></tr></tbody></table><br><br><a name="RLS"></a><h4>  ROW LEVEL SECURITY </h4><br>  Row-level security or row-level security is a mechanism for delimiting access to information to the database, which allows users to restrict access to individual rows in the tables. <br><br>  This functionality may be interesting to those who use databases with a large number of users. <br><br>  It works as follows: the rules for a specific table are described, according to which access to specific rows is limited when executing certain commands, using the <b>CREATE POLICY</b> expression.  Each rule contains a certain logical expression that must be true for the string to be visible in the query.  The rules are then activated using the <b>ALTER TABLE ... ENABLE ROW LEVEL SECURITY</b> statement.  Then when trying to access, for example, when a <b>SELECT</b> query is made, it is checked whether the user has the right to access a specific row and if not, they are not shown to him.  The superuser can see all lines by default, since his default flag is BYPASSRLS, which means that no checks will be performed for this role. <br><br>  The syntax for the <b>CREATE POLICY</b> statement <a href="http://www.postgresql.org/docs/9.5/static/sql-createpolicy.html">is</a> : <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">POLICY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> table_name [ <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> { ALL | <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> } ] [ <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> { role_name | <span class="hljs-keyword"><span class="hljs-keyword">PUBLIC</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_USER</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">SESSION_USER</span></span> } [, ...] ] [ <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> ( using_expression ) ] [ <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHECK</span></span> ( check_expression ) ]</code> </pre><br>  Rules are created for specific tables, so there can be several rules in the database with the same name for different tables. <br>  After the <b>FOR</b> statement, it is indicated for which requests the rule is applied, the default is <b>ALL</b> , that is, for all requests. <br><br>  After <b>TO</b> - for which roles, by default - <b>PUBLIC</b> , that is, for all roles. <br><br>  Further, in the <b>USING</b> expression, a Boolean expression is specified, which must be true in order for the specific string to be visible to the user in queries that use already existing data ( <b>SELECT</b> , <b>UPDATE</b> , <b>DELETE</b> ).  If the boolean expression returns null or false, then the string will not be visible. <br><br>  The <b>WITH CHECK</b> statement specifies a Boolean expression that must be true for the query to add or modify data ( <b>INSERT</b> or <b>UPDATE</b> ) to succeed.  If the boolean expression returns null or false, then there will be an error.  The <b>WITH CHECK clause</b> is executed after <b>BEFORE</b> triggers (if present) and before any other checks.  Therefore, if a <b>BEFORE</b> trigger modifies a string so that the condition does not return true, there will be an error.  For <b>UPDATE</b> to succeed, it is necessary that both conditions return true, including if a conflict occurs in the <b>INSERT ... ON CONFILCT DO UPDATE</b> request and the request attempts to modify the data.  If the <b>WITH CHECK</b> clause is omitted, the condition from the <b>USING clause</b> will be substituted instead. <br>  Under conditions, aggregate or window functions cannot be used. <br><br>  Usually, it is required to control access based on which database user requests the data, so we can use functions that return <a href="http://www.postgresql.org/docs/9.5/static/functions-info.html">System Information</a> ( <a href="http://www.postgresql.org/docs/9.5/static/functions-info.html">System Information Functions</a> ). <br><br>  Let us turn to examples: <br><br>  Add a <b>db_user</b> field to the <b>account</b> table, fill this field for an already existing record and add new records: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> db_user <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>; Query returned successfully <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> <span class="hljs-keyword"><span class="hljs-keyword">result</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> ms. <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> db_user=<span class="hljs-string"><span class="hljs-string">'pupkin'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> surname=<span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, surname, address, db_user) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">',  '</span></span>, <span class="hljs-string"><span class="hljs-string">'petrov'</span></span>), (<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'-,  '</span></span>, <span class="hljs-string"><span class="hljs-string">'sidorov'</span></span>); Query returned successfully: 2 rows affected, 31 ms execution time.</code> </pre><br>  Create roles: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROLE</span></span> pupkin <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> LOGIN <span class="hljs-keyword"><span class="hljs-keyword">PASSWORD</span></span> <span class="hljs-string"><span class="hljs-string">'pupkin'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROLE</span></span> petrov <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> LOGIN <span class="hljs-keyword"><span class="hljs-keyword">PASSWORD</span></span> <span class="hljs-string"><span class="hljs-string">'petrov'</span></span>; Query returned successfully <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> <span class="hljs-keyword"><span class="hljs-keyword">result</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">31</span></span> ms.</code> </pre><br>  Create a rule and enable RLS on the table: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">POLICY</span></span> select_self <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> (db_user=<span class="hljs-keyword"><span class="hljs-keyword">current_user</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ENABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEVEL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SECURITY</span></span>; Query returned successfully <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> <span class="hljs-keyword"><span class="hljs-keyword">result</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> ms.</code> </pre><br>  In this query, we created a rule according to which, the user in the <b>SELECT</b> query will see only those rows in which the value of the <b>db_user</b> field coincides with the name of the current database user. <br><br>  Run a request from the postgres user: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span></code> </pre> <br><table border="1"><tbody><tr><th>  id </th><th>  name </th><th>  surname </th><th>  address </th><th>  db_user </th></tr><tr><td>  one </td><td>  Vasya </td><td>  Pupkin </td><td>  Moscow Kremlin </td><td>  pupkin </td></tr><tr><td>  five </td><td>  Peter </td><td>  Petrov </td><td>  Moscow Red Square </td><td>  petrov </td></tr><tr><td>  6 </td><td>  Ivan </td><td>  Sidorov </td><td>  St. Petersburg, Winter Palace </td><td>  sidorov </td></tr></tbody></table><br>  Perform the same request from the pupkin user: <br><table border="1"><tbody><tr><th>  id </th><th>  name </th><th>  surname </th><th>  address </th><th>  db_user </th></tr><tr><td>  one </td><td>  Vasya </td><td>  Pupkin </td><td>  Moscow Kremlin </td><td>  pupkin </td></tr></tbody></table><br>  Let's create a rule according to which only the pupkin user can insert lines with the last name "Pupkin": <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">POLICY</span></span> insert_update_pupkin <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHECK</span></span> (surname&lt;&gt;<span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current_user</span></span>=<span class="hljs-string"><span class="hljs-string">'pupkin'</span></span>)</code> </pre> <br>  Let's try to fulfill the request from the pupkin user: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, surname, address) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">', '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Query</span></span> returned successfully: one <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> affected, <span class="hljs-number"><span class="hljs-number">13</span></span> ms execution time.</code> </pre> <br>  Check: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span>;</code> </pre> <br><table border="1"><tbody><tr><th>  id </th><th>  name </th><th>  surname </th><th>  address </th><th>  db_user </th></tr><tr><td>  one </td><td>  Vasya </td><td>  Pupkin </td><td>  Moscow Kremlin </td><td>  pupkin </td></tr></tbody></table><br>  Op-pa!  We forgot to specify the <b>db_user</b> field and the record that we inserted, we will not see.  Well, let's fix this logic with the help of a trigger in which we fill in the <b>db_user</b> field <b>with the</b> name of the current user: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> fill_db_user() <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> NEW.db_user = <span class="hljs-keyword"><span class="hljs-keyword">current_user</span></span>; RETURN NEW; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; $BODY$ LANGUAGE plpgsql VOLATILE; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> fill_db_user <span class="hljs-keyword"><span class="hljs-keyword">BEFORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> fill_db_user();</code> </pre> <br>  We try again: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, surname, address) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">', '</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span>;</code> </pre> <br><table border="1"><tbody><tr><th>  id </th><th>  name </th><th>  surname </th><th>  address </th><th>  db_user </th></tr><tr><td>  one </td><td>  Vasya </td><td>  Pupkin </td><td>  Moscow Kremlin </td><td>  pupkin </td></tr><tr><td>  21 </td><td>  Ivan </td><td>  Pupkin </td><td>  Kiev, Maidan </td><td>  pupkin </td></tr></tbody></table><br>  Let's try to change the data on Ivan Pupkin user petrov: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> db_user=<span class="hljs-string"><span class="hljs-string">'petrov'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Query</span></span> returned successfully: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> affected, <span class="hljs-number"><span class="hljs-number">13</span></span> ms execution time.</code> </pre> <br>  As you can see, the data has not changed, it happened because the <b>USING</b> condition from the <b>select_self</b> rule <b>was</b> not fulfilled. <br><br>  If several rules correspond to one request, they are combined via <b>OR</b> . <br><br>  It is worth noting that the rules apply only when explicit requests are made to the tables and do not apply when the system performs checks (constaints, foreign keys, etc.).  This means that the user, using queries, determine that any value exists in the database.  For example, if a user can insert into a table that refers to another table, from which he cannot make a <b>SELECT</b> .  In such a case, it may try to make an INSERT in the first table and by the result (it was inserted or an error occurred while checking referential integrity) to determine if a value exists in the second table. <br><br>  There are many ways to use row-level security: <br><ul><li>  the same database is used by several applications with different functionality </li><li>  multiple instances of the same application with different rights </li><li>  access by roles or user groups </li><li>  etc. </li></ul><br>  In the following parts, I plan to consider such new features of PostgreSQL 9.5 as: <br><ul><li>  <a href="http://habrahabr.ru/post/266759/">Part 2. TABLESAMPLE</a> </li><li>  SKIP LOCKED </li><li>  BRIN indices </li><li>  GROUPING SETS, CUBE, ROLLUP </li><li>  New features for JSONB </li><li>  IMPORT FOREIGN SCHEMA </li><li>  other </li></ul></div><p>Source: <a href="https://habr.com/ru/post/264281/">https://habr.com/ru/post/264281/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264271/index.html">Preparing ASP.NET5, issue number 2 - repeat the basics for the most beginners</a></li>
<li><a href="../264273/index.html">ESET & Intel Security on Black Hat USA 2015</a></li>
<li><a href="../264275/index.html">SIP registration, trunk, softphone and other scary words of cloud PBX</a></li>
<li><a href="../264277/index.html">HP is the leader of the Gartner Magic Quadrant for modular servers</a></li>
<li><a href="../264279/index.html">API interface for free PBX and telephony</a></li>
<li><a href="../264283/index.html">Welcome to Windows Camp - September 10, Moscow</a></li>
<li><a href="../264285/index.html">Data Science: the path to professionalism</a></li>
<li><a href="../264287/index.html">Two-factor authentication. New challenges</a></li>
<li><a href="../264289/index.html">Making the code cleaner: Refactoring the PCI driver for a NAND Denali controller</a></li>
<li><a href="../264291/index.html">Creating The Blacksmith: animation, camera effects, audio / video</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>