<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Embedded Systems: Windows Special Purpose</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 O mighty habramen and the most beautiful habramimen! The insignificant remarked that the surah about the brilliant Windows Embedded is not y...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Embedded Systems: Windows Special Purpose</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  O mighty habramen and the most beautiful habramimen!  The insignificant remarked that the surah about the brilliant Windows Embedded is not yet recorded in the book of the wisdom of Habr.  Let me, the unworthy one, be allowed to tell you one enlightening story about how a particularly bulletproof Windows <sup>¬Æ</sup> ‚Ñ¢ was built and implemented at the facilities of a Russian railway corporation. <br><a name="habracut"></a><br><h4>  How we came to such a life </h4><br>  So, one morning, a messenger from programmers arrived at our modest abode of System Software with terrible and sad news.  Truly, I tell you - programmers on a business trip could not update the software in the workplace, because  it wrapped around Shaitan and populated it with viruses, Trojans, pornos, and a contractrake (non-unique users had nothing to do with it). <br><br><blockquote>  The software is an electromechanical workstation of the signaling system, written in VC ++ 6 + MFC + WINAPI. <br></blockquote>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Our wisest caliph, having learned of such indecency, convened a sofa.  And so said the wise men of the court and astrologers: <br><br>  The anti-virus was not installed due to the absence of Internet stations at the stations (stations are scattered across the entire surface of Russia and traveling with an offline base for updating is somehow not an option).  At some stations there is an access to the intranet, where there is a corporate antivirus, but firstly: not at all, secondly: the antivirus there is chthonic Symantec, old and kind. <br><br>  After a certain amount of service, it was decided to replace the Windows desktop with something more durable and reliable, but at the same time win32-compatible.  Of the whole <i>mass of</i> suitable platforms, Windows XP Embedded was chosen, since  according to it, there were already some developments and, in general, such a system is really cool. <br><br><blockquote>  <b>Windows XP Embedded</b> is an embedded component operating system based on Windows XP Professional Edition and is designed for use in various embedded systems: industrial automation systems, ATMs, medical devices, cash registers, gaming machines, VoIP components, etc. Windows XP Embedded includes additional functions for embedding, including a write protection filter (EWF and FBWF), boot from flash memory, CD-ROM, a network, use of its own system shell, etc. <br><br>  Currently known as Windows Embedded Standard. <br></blockquote><br><br><h4>  Windows on steroids </h4><br>  We figured out what can be done with the built-in IDE tools in Windows Embedded: <br><ol><li>  disable disc writing </li><li>  restrict user credentials </li><li>  prevent the user from launching anything other than AWP </li><li>  close unused ports </li><li>  disable mounting external USB drives </li><li>  exclude from the system the application and system software that is not required for the direct operation of the AWP (Media Player, Outlook Express, Paint, Explorer, etc.) </li></ol><br><br>  But it's all boring and simple.  The bosses were inspired by the idea of ‚Äã‚Äãmodular software ‚Ñ¢, which consists in dividing the application, system software and configuration into ‚Äúmodules‚Äù - FS files that combine software according to functional features.  Advantages of this approach: <br><br><ol><li>  software structure becomes more streamlined </li><li>  more convenient software versioning system (I apologize for this wonderful term, the best was not invented) </li><li>  Increase the speed of deployment / software update - a large file is written faster than many smaller ones </li><li>  Increasing system flexibility, for example, system software (OS) can be mounted in read-only, without affecting application programs. </li></ol><br><br>  It seems that there are no obvious minuses, it would seem - implement and rejoice.  But the fact that for QNX (originally a modular system was developed for our industrial computers) was simple and naturally Windows became a hellish migraine and looked like an attempt to cross a sea urchin with a crane.  In the end, it turned out to be implemented, but first and foremost. <br><br><h5>  Truncation of windows </h5><br>  How to solve the problem of the points: <br><ul><li>  we use <a href="http://msdn.microsoft.com/en-us/library/ms838511(v%3Dwinembedded.5).aspx">EWF</a> with data mapping in RAM to block writing to disk </li></ul><br><blockquote>  Advanced write filter - a driver intercepting write access to a hard disk and buffering them depending on the settings: <br><ul><li>  on a specially hidden section </li><li>  in RAM </li></ul><br>  There is no real write to the protected partition; it is executed only at the user's request (so-called commit), for which the kindest Microsoft provides the API and the ready-made utility ewfmgr.  When using a special section for buffering, data will be saved between reboots, in the case of buffering in RAM - no. <br></blockquote><br><ul><li>  Create an account from the pre-installed Windows template - ‚Äúregular user‚Äù and put it into autologon </li><li>  create a component of the Shell type (system shell) that starts the AWP as the system shell;  exclude from the system explorer.exe.  A particularly ingenious user still has the ability to view the directory structure through the save file dialog in one of the AWP windows, but: <br><ul><li>  this is the problem of programmers (hehe) </li><li>  don't forget about filtering a record and limited account </li></ul><br></li><li>  because  I am not a big fan of WHS-th dialect of VB, then I used the batch file, <a href="http://technet.microsoft.com/en-us/library/bb490617.aspx">jerking netsh.exe firewall</a> </li><li>  with extra components, I just entered - I created a XP Embedded project that contains only vital components (i.e., components automatically added by hardware dependencies + required infrastructure for AWS operation) </li><li>  Disabling external USB-drives was performed by the <a href="http://msdn.microsoft.com/en-us/library/ms940862">barbaric method</a> , namely, the driver for USB-drives and the installation wizard of the new equipment were excluded from the system image, and the wizard of the new equipment was turned off when the unknown PnP device was connected via the registry key <br><br>  The problem of disabling PnP devices can be solved in <a href="http://www.realgeek.com/forums/how-to-enable-or-disable-usb-storage-device-151910.html">several</a> <a href="http://www.petri.co.il/disable_usb_disks_with_gpo.htm">ways</a> (and there is still <a href="http://support.microsoft.com/kb/311272">devcon</a> ), but this one attracted me with its global nature, i.e.  at the same time, any other unauthorized peripherals will be disconnected from the USB drives, but it will still be possible to replace the USB mouse / keyboard (since the driver is in the system and it contains a digital signature ‚Äî such drivers are installed automatically) </li></ul><br><br><h5>  Mounting images </h5><br>  Searches for software for mounting images in Windows were long and painful.  Came across only the implementation of the RAM-drive, which is certainly cool, but not that.  I remembered that the utility for mounting vhd files is included in the Windows Virtual Server kit, but how to add it to my WinXP and whether it is legal at all, I never opened.  The project of the century has almost covered itself with a copper basin, I wondered how to get off with less blood and avoid developing my own driver, when suddenly a link to a <a href="http://www.acc.umu.se/~bosse/">great filedisk appeared</a> in Google.  Fits all articles - it can mount images as logical disks (it is not able to emulate media, but it was not required), made in the form of a driver, which makes it easy to add to the XP Embedded project, it contains a console utility for managing disks out of the box necessary for use in start scripts.  In general - one hundred percent hit. <br><br>  The driver is installed, but where do you get the images themselves?  We take <a href="http://www.chrysocome.net/dd">dd for windows</a> and create images of the required size from its virtual / dev / null.  We connect them with the help of filedisk, we see logical disks without FS, we create NTFS on them, we fill them with contents. <br><br>  On one of the images I placed the startup scripts that run after the logon and make some settings (setting the IP address, screen resolution, etc. from the config file).  It is clear that by the time Logon, the images should already be mounted.  And then I tried a bunch of options - <a href="http://technet.microsoft.com/en-us/library/cc772785(v%3Dws.10).aspx">Schtasks</a> , which allows you to perform the task with Logon (but it did not always work somehow), drove the script to mount disks into services using sc - while the contents of the images were not available to user accounts on behalf of which they were running application software (as an option, it would be possible to transfer tasks from scripts to a service, but for some reason, script-writing is nicer to me than this soulless C ++).  As a result, Skolhozil - <a href="http://support.microsoft.com/kb/243486/ru">AutoExNt</a> performs the mount before the logon, and the system configuration tasks are performed using encrypted <a href="http://www.joeware.net/freetools/tools/cpau/">cpau</a> tasks on behalf of the administrator (because the autologon occurs under the account of a regular user).  It was the first of the stable working options, and by that moment debugging got me so hard that I spat on the ugliness of the method and left it as it is. <br><br>  Additionally, I developed a small simple autorun utility, because  Explorer Shell was excluded from the project and no one was processing the Avtoran keys in the registry, and someone had to start the programs at the start. <br><br>  On this, my torment with the Windows system software is basically over, it is time to think about how all this crap will be installed on the target machine. <br><br><br><h4>  Deployment </h4><br>  Windows XP Embedded does not contain tools for partitioning and formatting the disk, unlike the usual Windows XP.  Those.  XPe installation consists of copying the project directory structure to the root of a partition formatted with FAT32 / NTFS and marked as active (the boot flag is set).  The XPe package includes the WinPE disk, which contains the utilities necessary for partitioning, but the usage scenarios for this disk are rather vague (for example, it cannot be used as a recovery disk).  After praising such user care for myself, I decided not to bother with Microsoft products for deploying XPe (although there seems to be a free Windows AIK, but from previous experience of trying to understand the licensing restrictions of Microsoft products, it was decided to look for something on the side). <br><br>  I decided to try my luck with GNU / Linux, because  The ntfs-3g driver has been stable for quite a long time and has worked quite well (and, by the way, in quite strange places, Realtek is in the whim, in the SDK for their multimedia platforms it is used as the default file system for external drives).  I took the Ubuntu LTS Live-CD, cleared it from the logos and the mention of Ubuntu (because for a deep modification of the system, Canonical puts forward such requirements) and began to customize.  The choice of distribution was due to personal preferences. <br><br>  The first version of the deployment environment was a bash script that communicated with the user using zenity.  Simple and tasteful.  It was rejected as not divine enough in terms of UI. <br><br>  The second version was written in Mono (C # is the corporate standard) and contained almost all GTK graphic elements.  The high commission noted that the UI is still not divine enough, but still viable. <br><br>  The installation procedure itself consisted of calling external utilities - parted for markup, mkfs.ntfs from the ntfsprogs package (ntfstools) to create filesystems and rsync to copy data from the installation media. <br><br>  Next - reboot and go directly to the deployment of Windows Embedded. <br><br><h4>  Conclusion </h4><br>  Now Windows XP Embedded (Windows Embedded Standard 2009) is rapidly losing relevance (although support will continue until 2015) - it has been replaced by Windows Embedded 7, which is much, much, much more convenient than XPe, but my colleague, I work with it he described (as he could, hehe) his own experience.  I hope someone will find something useful in this collection of harmful tips. <br><br>  In conclusion, I will provide a list of useful resources for Windows Embedded: <br><br><ul><li>  First of all, this is of course the <a href="http://msdn.microsoft.com/en-US/library/ff795587(v%3Dwinembedded.0).aspx">thematic section on MSDN</a> </li><li>  <a href="http://forum.quarta.ru/index.php%3F/forum/8-windows-embedded-standard-windows-xp-embedded/">Russian-speaking forum of the</a> company "Quart" - the official supplier of Windows Embedded in Russia.  Probably the only major Russian-language resource for Windows Embedded. </li><li>  There was also a great repository of user scripts and xpefiles.com components, but something bad happened to it. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/138630/">https://habr.com/ru/post/138630/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../138623/index.html">NFC tags from metro maps</a></li>
<li><a href="../138625/index.html">Sort: key vs cmp</a></li>
<li><a href="../138627/index.html">Django Meetup - March 1 in Moscow</a></li>
<li><a href="../138628/index.html">Black holes and gold mines on the web development market</a></li>
<li><a href="../138629/index.html">Development of a WEB project on Node.JS: Part 2</a></li>
<li><a href="../138631/index.html">Be the center of attention!</a></li>
<li><a href="../138632/index.html">A unified look at communities and social networks</a></li>
<li><a href="../138633/index.html">Network access to libraries and runtime-formation of function calls</a></li>
<li><a href="../138634/index.html">What to expect from MWC 2012?</a></li>
<li><a href="../138635/index.html">Why I choose D</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>