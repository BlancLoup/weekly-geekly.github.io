<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How using PVS-Studio can improve Visual C ++ 2017 Libraries</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The title of the article hints to Visual Studio developers that they can benefit from using the PVS-Studio static code analyzer. The article presents ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How using PVS-Studio can improve Visual C ++ 2017 Libraries</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/df7/5eb/e8d/df75ebe8dd93a63351cd7b6e5a23c201.png" align="left">  The title of the article hints to Visual Studio developers that they can benefit from using the PVS-Studio static code analyzer.  The article presents the results of the analysis of the libraries that are part of the recently released version of Visual C ++ 2017, and gives recommendations for improving and eliminating errors.  I invite readers to find out how the developers of Visual C ++ Libraries shoot their feet: it will be interesting and informative. <br><a name="habracut"></a><br><h2>  A bit of background </h2><br>  This is not my first experiment in checking libraries included in Visual C ++.  You can read about previous checks here: <br><br><ul><li>  <a href="https://www.viva64.com/ru/b/0163/">Errors found in Visual C ++ 2012 libraries</a> </li><li>  <a href="https://www.viva64.com/ru/b/0288/">Tyap-blooper, checked the library Visual C ++ 2013 (update 3)</a> </li></ul><br>  After these publications there was a long break, and I did not write an article regarding VS2015.  There were <a href="https://www.viva64.com/ru/inspections/">many interesting projects</a> that were waiting for verification.  Although, to be honest, I just forgot to write an article on this topic.  Fortunately, a <a href="https://twitter.com/MalwareMinigun/status/847851006884929541">tweet</a> from one of the Visual C ++ developers ( <a href="https://twitter.com/MalwareMinigun">@MalwareMinigun</a> ) reminded me about VS2017: <br><br>  <i>You must be able to find out the standard library headers.</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p><img src="https://habrastorage.org/getpro/habr/post_images/208/32d/0e0/20832d0e0dae315d74a5ba397b63b4f0.png" alt="Picture 1"></p><br>  Indeed, I did not tell the world about the bugs in the libraries of Visual Studio 2017!  Well, the challenge is accepted! <br><br>  As you can see, a month has passed since the tweet (March 31).  I admit that I delayed the answer, but now I will correct it. <br><br><h2>  What and how was checked </h2><br>  For verification, I used the latest version of the <a href="https://www.viva64.com/ru/pvs-studio-download/">PVS-Studio</a> analyzer (6.15) available to me. <br><br>  I checked the C ++ libraries that are part of the recently released version of Visual Studio 2017. I checked the version of the libraries that I had on my computer 04/12/2017.  However, the version is not so important, since this text is not a bug report, but an article popularizing the static analysis methodology in general, and the PVS-Studio analyzer in particular. <br><br>  I admit, I did not bother to complete the library check, as it is difficult for me. <br><br>  First, I had to copy all the libraries to another folder, otherwise I would not be able to get warnings for them.  The analyzer does not display messages to the system libraries.  By copying files to another folder, I deceive PVS-Studio, and I get the warnings I need. <br><br>  By the way, here's the answer to the <a href="https://twitter.com/MalwareMinigun/status/847851006884929541">tweet</a> above.  For this reason, Visual C ++ users do not write about the PVS-Studio warnings regarding libraries.  It makes no sense to give them out, as they will only distract people.  At the same time, this speeds up the analysis a bit, since it is not necessary to fully parse and analyze the bodies of inline functions. <br><br>  Secondly, I did not try to honestly collect projects.  I just created a new solution and added files from libraries there.  As a result, some of the files I could not verify.  But, from the point of view of writing the article, this is not essential.  Material for a full text and so it turned out quite enough.  A more thorough and correct check should be done by Visual C ++ developers themselves, and I am ready to help them with this. <br><br><h2>  False alarms </h2><br>  This time, unfortunately, I cannot quote specific numbers and percentages. <br><br>  I can say that: <br><br><ul><li>  General Purpose (GA) Warnings High; I received 433 units. </li><li>  Warnings General Purpose (GA) with confidence Medium I received 743 pcs. </li></ul><br>  However, these numbers can not be interpreted in any way, and no conclusions can be made on their basis! <br><br>  Let me remind you that I checked only part of the files, but also in a strange way.  Plus there is an unusual moment with libraries.  The analyzer generates many absolutely correct messages that are absolutely false.  Now I will explain the reason for this paradox. <br><br>  It is harmful and dangerous to independently declare system data types.  An example of a bad idea: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> DWORD;</code> </pre> <br>  The PVS-Studio analyzer will display a warning: <a href="http://www.viva64.com/ru/w/V677/">V677</a> Custom declaration of a standard 'DWORD' type.  The system header file should be used: #include &lt;WinDef.h&gt;. <br><br>  The analyzer is absolutely right.  You should not declare the type "manually", but connect the corresponding header file. <br><br>  As you understand, such diagnostics are not applicable to Visual C ++ libraries.  After all there, just, such types also appear.  And the analyzer issued more than 250 such messages. <br><br>  Or here is another interesting example.  The PVS-Studio analyzer is absolutely right when it criticizes the code in which the <i>this</i> pointer is checked for <i>NULL</i> equality.  According to the current C ++ standard, the <i>this</i> pointer cannot be <i>NULL</i> . <br><br>  Visual C ++ has big problems with this.  Apparently, in this regard, it will never meet the standard, well, or it will happen very soon.  The fact is that libraries (for example, MFC) are architecturally constructed so that <i>this</i> equal to <i>NULL</i> is a typical situation. <br><br>  The library code contains a large number of functions that check the <i>this</i> pointer.  Here are a couple of such features: <br><br><pre> <code class="cpp hljs">_AFXWIN_INLINE CDC::<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">operator</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HDC</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ? <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> : m_hDC; } _AFXWIN_INLINE HDC CDC::GetSafeHdc() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ? <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> : m_hDC; }</code> </pre> <br>  The PVS-Studio analyzer, of course, will issue warnings for them: <br><br><ul><li>  V704 'this == 0' expression must be avoided - this expression is always false on newer compilers, because it can be never NULL.  afxwin1.inl 314 </li><li>  V704 'this == 0' expression must be avoided - this expression is always false on newer compilers, because it can be never NULL.  afxwin1.inl 316 </li></ul><br>  There are more than 40 such messages, while there is no sense, of course.  In the coming years, they can be considered false alarms. <br><br>  As we can see from the example of messages <a href="http://www.viva64.com/ru/w/V677/">V677</a> and <a href="http://www.viva64.com/ru/w/V704/">V704</a> , not all diagnostics are applicable to Visual C ++ libraries.  Of course there is no problem: these and other warnings can be simply turned off and, thus, immediately reduce the number of messages by 300 pieces. <br><br>  All this I am writing to once again demonstrate that it is very often pointless to discuss the percentage of false positives if you do not pre-configure the analyzer. <br><br>  In general, this time without interest, I apologize.  My subjective opinion is that there are few false positives. <br><br><h2>  What the analyzer found interesting </h2><br>  I decided to go from harmless to scary.  In the beginning I will consider recommendations for minor improvements.  Then I move on to horror mistakes, and finish the story with what, in my opinion, can be called ‚Äúhorror‚Äù.  In general, I will gradually increase the degree.  So, go ahead, save the world of programs from bugs! <br><br><p><img src="https://habrastorage.org/getpro/habr/post_images/a7e/ad3/d41/a7ead3d41f24bc0c5edf2432152d63c0.png" alt="Picture 5"></p><br><br><h3>  Micro-optimizations </h3><br>  The analyzer offers to perform a number of micro-optimizations.  That is, everything that will be considered in this chapter is not an error, but the code can be slightly improved. <br><br>  Let's start with the warning <a href="http://www.viva64.com/ru/w/V808/">V808</a> , which says that a certain object is created, but not used.  Consider this situation on the example of two functions. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CMFCToolBarComboBoxButton::AdjustRect() { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_pWndEdit != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { CRect rectEdit = m_rect; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> iBorderOffset = <span class="hljs-number"><span class="hljs-number">3</span></span>; m_pWndEdit-&gt;SetWindowPos( <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, m_rect.left + nHorzMargin + iBorderOffset, m_rect.top + iBorderOffset, m_rect.Width() - <span class="hljs-number"><span class="hljs-number">2</span></span> * nHorzMargin - m_rectButton.Width() - iBorderOffset - <span class="hljs-number"><span class="hljs-number">3</span></span>, m_rectCombo.Height() - <span class="hljs-number"><span class="hljs-number">2</span></span> * iBorderOffset, SWP_NOZORDER | SWP_NOACTIVATE); } .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/w/V808/">warning</a> : <a href="http://www.viva64.com/ru/w/V808/">V808</a> 'rectEdit' object of 'CRect' type created.  afxtoolbarcomboboxbutton.cpp 607 <br><br>  The <i>rectEdit</i> object is not used anywhere after creation and initialization.  It is just superfluous and it can be safely removed.  The code will be slightly shorter. <br><br>  Another case: <br><br><pre> <code class="cpp hljs">BOOL CALLBACK AFX_EXPORT CMFCToolBarFontComboBox::EnumFamPrinterCallBackEx(....) { .... CString strName = pelf-&gt;elfLogFont.lfFaceName; pCombo-&gt;AddFont((ENUMLOGFONT*)pelf, FontType, CString(pelf-&gt;elfScript)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br>  <a href="http://www.viva64.com/ru/w/V808/">V808</a> 'strName' object of 'CStringT' type created but not used.  afxtoolbarfontcombobox.cpp 138 <br><br>  An object of type <i>CString</i> is created and initialized, but not used anywhere.  I don‚Äôt know if the compiler will guess to throw out extra code to create and copy a string.  Perhaps, he will not guess, since <i>CStirng</i> is a complex class.  However, it does not matter, in any case, the <i>strName</i> object should be removed and, thus, make the code easier. <br><br>  And there are a lot of such superfluous objects.  In addition to those already reviewed, the analyzer issued another 50 messages.  In order not to clutter the text of the article, I wrote these messages in a separate file: <a href="http://cppfiles.com/vs2017_V808.txt">vs2017_V808.txt</a> . <br><br>  Now it's time for extra checks. <br><br><pre> <code class="cpp hljs">TaskStack::~TaskStack() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_pStack) <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> [] m_pStack; }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/w/V809/">warning</a> : <a href="http://www.viva64.com/ru/w/V809/">V809</a> Verifying that a pointer value is not NULL is not required.  The 'if (m_pStack)' check can be removed.  taskcollection.cpp 29 <br><br>  The <i>delete</i> operator is completely safe to give <i>nullptr</i> as input.  Thus, verification is superfluous and the code can be simplified: <br><br><pre> <code class="cpp hljs">TaskStack::~TaskStack() { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> [] m_pStack; }</code> </pre> <br>  There are too many such extra checks.  I wrote 68 messages to the file <a href="http://cppfiles.com/vs2017_V809.txt">vs2017_V809.txt</a> . <br><br>  The next trifle that can be changed is to replace the postfix increment of iterators with the prefix one.  Example: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">size_type </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">count</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key_type&amp; _Keyval)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ size_type _Count = <span class="hljs-number"><span class="hljs-number">0</span></span>; const_iterator _It = _Find(_Keyval); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;_It != end() &amp;&amp; !<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;_M_comparator(....); _It++) { _Count++; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _Count; }</code> </pre> <br>  PVS-Studio warning: <a href="http://www.viva64.com/ru/w/V803/">V803</a> Decreased performance.  In case of an '_It' is an iterator, it is more useful to use the prefix form of increment.  Replace iterator ++ with ++ iterator.  internal_concurrent_hash.h 509 <br><br>  It will be a little better if you write: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;_It != end() &amp;&amp; !<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;_M_comparator(....); ++_It)</code> </pre> <br>  The question of whether this refactoring is useful, I considered in the article: " <a href="https://www.viva64.com/ru/b/0093/">Is there a practical sense to use the prefix increment operator ++ it for iterators instead of postfix it ++</a> ".  The answer is, though not great. <br><br>  If the authors of the libraries decide that the fix is ‚Äã‚Äãworth making, then here are 26 more similar warnings: <a href="http://cppfiles.com/vs2017_V803.txt">vs2017_V803.txt</a> . <br><br>  Next micro optimization.  It is better to clear the string by calling the function <i>str.Empty ()</i> , rather than assigning it the value <i>_T ("")</i> .  The class does not know in advance how much memory should be allocated for the line.  Therefore, it begins to waste the length of the string.  In general, extra actions. <br><br><pre> <code class="cpp hljs">CString m_strRegSection; CFullScreenImpl::CFullScreenImpl(CFrameImpl* pFrameImpl) { m_pImpl = pFrameImpl; m_pwndFullScreenBar = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; m_bFullScreen = FALSE; m_bShowMenu = TRUE; m_bTabsArea = TRUE; m_uiFullScreenID = (UINT)<span class="hljs-number"><span class="hljs-number">-1</span></span>; m_strRegSection = _T(<span class="hljs-string"><span class="hljs-string">""</span></span>); }</code> </pre> <br>  PVS-Studio warning: <a href="http://www.viva64.com/ru/w/V815/">V815</a> Decreased performance.  Consider replacing the expression 'm_strRegSection = L ""' with 'm_strRegSection.Empty ()'.  afxfullscreenimpl.cpp 52 <br><br>  Here it is better to replace the line <br><br><pre> <code class="cpp hljs">m_strRegSection = _T(<span class="hljs-string"><span class="hljs-string">""</span></span>);</code> </pre> <br>  on <br><br><pre> <code class="cpp hljs">m_strRegSection.Empty();</code> </pre> <br>  A trifle, but a perfectionist would be happy for such an improvement in the code. <br><br>  Note.  In fact, this line can be removed altogether, since this code is in the constructor, and the string is empty. <br><br>  Here are 27 more warnings on this topic: <a href="http://cppfiles.com/vs2017_V815.txt">vs2017_V815.txt</a> . <br><br>  And finally, here is the code: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">HRESULT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPropertyInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(ul=<span class="hljs-number"><span class="hljs-number">0</span></span>; ul&lt;m_cPropSetDex; ul++) { .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(ULONG ulProp=<span class="hljs-number"><span class="hljs-number">0</span></span>; ....) { .... pDescBuffer += (wcslen(<span class="hljs-string"><span class="hljs-string">L"UNKNOWN"</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span>); .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/w/V814/">warning</a> : <a href="http://www.viva64.com/ru/w/V814/">V814</a> Decreased performance.  Wreck of the body of a loop.  atldb.h 2374 <br><br>  Note that the <i>wcslen</i> function will be called multiple times, as it is inside nested loops.  It would be more logical to calculate in advance and remember the length of the string <i>L "UNKNOWN"</i> . <br><br>  Another post: <a href="http://www.viva64.com/ru/w/V814/">V814</a> Decreased performance.  Wreck of the body of a loop.  atldb.h 2438 <br><br>  Everything finished with recommendations.  Let's move on to something more interesting. <br><br><h3>  Errors of small and medium caliber </h3><br>  Compiler warnings are suppressed incorrectly in header files.  Consider the wrong way to temporarily disable alerts: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> _MSC_VER #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">warning</span></span></span><span class="hljs-meta">(disable:4200) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> typedef struct adpcmwaveformat_tag { WAVEFORMATEX wfx; WORD wSamplesPerBlock; WORD wNumCoef; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> defined( _MSC_VER ) ADPCMCOEFSET aCoef[]; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> ADPCMCOEFSET aCoef[1]; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> } ADPCMWAVEFORMAT; typedef ADPCMWAVEFORMAT *PADPCMWAVEFORMAT; typedef ADPCMWAVEFORMAT NEAR *NPADPCMWAVEFORMAT; typedef ADPCMWAVEFORMAT FAR *LPADPCMWAVEFORMAT; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> _MSC_VER #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">warning</span></span></span><span class="hljs-meta">(default:4200) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/w/V665/">warning</a> : <a href="http://www.viva64.com/ru/w/V665/">V665</a> Possibly, the usage of #pragma warning (default: X) 'is incorrect in this context.  The '#pragma warning (push / pop)' should be used instead.  Check lines: 2610, 2628. mmreg.h 2628 <br><br>  I understand that it‚Äôs not easy to see what the error itself is, so I‚Äôll highlight the point. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">warning</span></span></span><span class="hljs-meta">(disable:4200) .... #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">warning</span></span></span><span class="hljs-meta">(default:4200)</span></span></code> </pre> <br>  First, the compiler warning is disabled.  Next, alert status 4200 is set to its default value.  So you can not do.  Suppose the user has disabled the 4200 diagnostics for one of his files altogether.  To his misfortune, he wrote in the file: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;mmreg.h&gt;</span></span></span></span></code> </pre> <br>  As a result, the warning will turn on again and will be issued for the user code. <br><br>  The correct solution is to save the state, and then return the previous one: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">warning</span></span></span><span class="hljs-meta">(push) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">warning</span></span></span><span class="hljs-meta">(disable:4200) .... #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">warning</span></span></span><span class="hljs-meta">(pop)</span></span></code> </pre> <br>  This is where pragma warning is used incorrectly in header files: <br><br><ul><li>  V665 Possibly, the usage of #pragma warning (default: X) 'is incorrect in this context.  The '#pragma warning (push / pop)' should be used instead.  Check lines: 586, 601. workstealingqueue.h 601 </li><li>  V665 Possibly, the usage of #pragma warning (default: X) 'is incorrect in this context.  The '#pragma warning (push / pop)' should be used instead.  Check lines: 1669, 1697. usbioctl.h 1697 </li><li>  V665 Possibly, the usage of #pragma warning (default: X) 'is incorrect in this context.  The '#pragma warning (push / pop)' should be used instead.  Check lines: 1631, 1646. usbioctl.h 1646 </li><li>  V665 Possibly, the usage of #pragma warning (default: X) 'is incorrect in this context.  The '#pragma warning (push / pop)' should be used instead.  Check lines: 1490, 1518. usbioctl.h 1518 </li><li>  V665 Possibly, the usage of #pragma warning (default: X) 'is incorrect in this context.  The '#pragma warning (push / pop)' should be used instead.  Check lines: 986, 1002. usbioctl.h 1002 </li><li>  V665 Possibly, the usage of #pragma warning (default: X) 'is incorrect in this context.  The '#pragma warning (push / pop)' should be used instead.  Check lines: 960, 978. usbioctl.h 978 </li><li>  V665 Possibly, the usage of #pragma warning (default: X) 'is incorrect in this context.  The '#pragma warning (push / pop)' should be used instead.  Check lines: 913, 925. usbioctl.h 925 </li><li>  V665 Possibly, the usage of #pragma warning (default: X) 'is incorrect in this context.  The '#pragma warning (push / pop)' should be used instead.  Check lines: 861, 876. usbioctl.h 876 </li><li>  V665 Possibly, the usage of #pragma warning (default: X) 'is incorrect in this context.  The '#pragma warning (push / pop)' should be used instead.  Check lines: 860, 875. usbioctl.h 875 </li></ul><br>  There are such errors in the * .cpp files, but I did not write them out, as they do not pose any danger to the code of Visual C ++ users.  Although, of course, they too will be useful to fix. <br><br>  Now let's talk about the operator <i>new</i> . <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> HRESULT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreatePhraseFromWordArray</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... SPPHRASEELEMENT *pPhraseElement = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SPPHRASEELEMENT[cWords]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(pPhraseElement == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { ::CoTaskMemFree(pStringPtrArray); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> E_OUTOFMEMORY; } <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(pPhraseElement, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(SPPHRASEELEMENT) * cWords); .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/w/V668/">warning</a> : <a href="http://www.viva64.com/ru/w/V668/">V668 pphraseElement</a>  The exception will be generated in the case of memory allocation error.  sphelper.h 2973 <br><br>  Formally, this code is incorrect.  In case of a memory allocation error, the operator <i>new</i> should throw an exception.  As a result, we will not get inside the body of the <i>if</i> operator and the <i>CoTaskMemFree</i> function will not be called.  And, in general, the program will not work as expected by the programmer. <br><br>  I'm not sure this is a real mistake.  There is a possibility that the project is linked with <i>nothrownew.obj</i> .  In this case, the <i>new</i> operator will not generate an exception.  This feature, for example, is used by driver developers.  Read more: <a href="http://stackoverflow.com/questions/550451/will-new-return-null-in-any-case">new and delete operators</a> .  So, if these are false positives, then you can simply turn off the <a href="http://www.viva64.com/ru/w/V668/">V668</a> warning. <br><br>  But another scenario is possible.  This code has remained since ancient times, when the <i>new</i> operator returned a <i>null</i> value in case of an error.  Then everything is bad, since the analyzer issued 112 such warnings: <a href="http://cppfiles.com/vs2017_V668.txt">vs2017_V668.txt</a> . <br><br>  We continue.  The analyzer generates many warnings <a href="http://www.viva64.com/ru/w/V730/">V730</a> , which says that not all members are initialized in the constructor.  Let me explain the essence of the warning on two examples. <br><br>  In the beginning, we consider the <i>CMFCScanliner</i> class.  It announces the following members: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CMFCScanliner</span></span></span><span class="hljs-class"> {</span></span> .... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: LPBYTE m_line; LPBYTE m_line_begin; LPBYTE m_line_end; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> m_pitch; DWORD m_start_row; DWORD m_start_col; DWORD m_rows; DWORD m_cols; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> m_offset; BYTE m_channels; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> m_height; };</code> </pre> <br>  Now look at the constructor: <br><br><pre> <code class="cpp hljs">CMFCScanliner() { empty(); }</code> </pre> <br>  Actually, there is nothing to look at in the constructor.  We should proceed to the study of the <i>empty</i> function: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">empty</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ m_line = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; m_pitch = <span class="hljs-number"><span class="hljs-number">0</span></span>; m_start_row = <span class="hljs-number"><span class="hljs-number">0</span></span>; m_start_col = <span class="hljs-number"><span class="hljs-number">0</span></span>; m_rows = <span class="hljs-number"><span class="hljs-number">0</span></span>; m_cols = <span class="hljs-number"><span class="hljs-number">0</span></span>; m_offset = <span class="hljs-number"><span class="hljs-number">0</span></span>; m_height = <span class="hljs-number"><span class="hljs-number">0</span></span>; m_line_begin = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; m_line_end = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; }</code> </pre> <br>  PVS-Studio Warning: <a href="http://www.viva64.com/ru/w/V730/">V730</a> It is possible that all of the <a href="http://www.viva64.com/ru/w/V730/">elements</a> are initialized inside the constructor.  Consider inspecting: m_channels.  afxtoolbarimages.cpp 510 <br><br>  Initialized all members except <i>m_channels</i> .  Agree, this is strange, since this member does not stand out among the rest.  This is very similar to an error, although I cannot be sure to the end, since I am not familiar with the principles of the class in question. <br><br>  Now consider the <i>AFX_EVENT</i> structure. <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AFX_EVENT</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> { event, propRequest, propChanged, propDSCNotify }; AFX_EVENT(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> eventKind); AFX_EVENT(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> eventKind, DISPID dispid, ....); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> m_eventKind; DISPID m_dispid; DISPPARAMS* m_pDispParams; EXCEPINFO* m_pExcepInfo; UINT* m_puArgError; BOOL m_bPropChanged; HRESULT m_hResult; DSCSTATE m_nDSCState; DSCREASON m_nDSCReason; }; AFX_INLINE AFX_EVENT::AFX_EVENT(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> eventKind) { m_eventKind = eventKind; m_dispid = DISPID_UNKNOWN; m_pDispParams = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; m_pExcepInfo = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; m_puArgError = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; m_hResult = NOERROR; m_nDSCState = dscNoState; m_nDSCReason = dscNoReason; }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/w/V730/">warning</a> : <a href="http://www.viva64.com/ru/w/V730/">V730</a> class are initialized inside the constructor.  Consider inspecting: m_bPropChanged.  afxpriv2.h 104 <br><br>  This time, the <i>m_bPropChanged</i> variable remained uninitialized. <br><br>  In both cases, I do not presume to judge whether it is necessary to initialize these variables.  Therefore, I suggest the developers to study these and other suspicious cases that the PVS-Studio analyzer pays attention to.  I wrote another 183 analyzer warnings to the <a href="http://cppfiles.com/vs2017_V730.txt">vs2017_V730.txt</a> file.  Surely among these messages there are several that indicate these serious errors.  If I were sure that the members should be precisely initialized, I would refer all these warnings to the next chapter of this article.  Uninitialized variables are extremely insidious, since errors can occur rarely and irregularly. <br><br>  The following analyzer warnings concern meaningless checks.  Such checks should either be removed or replaced by some others. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">HRESULT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetDpiCompensatedEffectInput</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... hr = deviceContext-&gt;CreateEffect(CLSID_D2D1DpiCompensation, &amp;dpiCompensationEffect); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SUCCEEDED(hr)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SUCCEEDED(hr)) { .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/w/V571/">warning</a> : <a href="http://www.viva64.com/ru/w/V571/">V571</a> Recurring check.  The 'if (((HRESULT) (hr))&gt; = 0)' condition was already verified in line 881. d2d1_1helper.h 883 <br><br>  The value of the variable <i>hr is</i> checked twice in a row.  We deal either with a superfluous code, or this is some kind of typo and we need to change the second condition. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Append</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_In_reads_(nLength) PCXSTR pszSrc, _In_ </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nLength)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// See comment in SetString() about why we do this UINT_PTR nOffset = pszSrc-GetString(); UINT nOldLength = GetLength(); if (nOldLength &lt; 0) { // protects from underflow nOldLength = 0; } .... }</span></span></code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/w/V547/">warning</a> : <a href="http://www.viva64.com/ru/w/V547/">V547</a> Expression 'nOldLength &lt;0' is always false.  Unsigned type value is never &lt;0. atlsimpstr.h 392 <br><br>  The variable <i>nOldLength</i> is of unsigned type <i>UINT</i> , which means it cannot be less than zero. <br><br>  Now let's talk about the <i>FreeLibrary</i> function. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> <span class="hljs-function"><span class="hljs-function">BOOL WINAPI </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DllMain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HINSTANCE hInstance, DWORD dwReason, LPVOID)</span></span></span><span class="hljs-function"> </span></span>{ .... ::FreeLibrary(pState-&gt;m_appLangDLL); .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/w/V718/">warning</a> : <a href="http://www.viva64.com/ru/w/V718/">V718</a> The 'FreeLibrary' function should not be called from the 'DllMain' function.  dllinit.cpp 639 <br><br>  Here is what <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms683152(v%3Dvs.85).aspx">MSDN says</a> about the <i>FreeLibrary</i> function: It is not safe to call <i>FreeLibrary</i> from <i>DllMain</i> .  For more information, see the Remarks section in <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682583(v%3Dvs.85).aspx">DllMain</a> . <br><br>  Thanks to luck, the code can work.  However, the code is still bad and you should pay attention to it. <br><br>  In conclusion of this chapter I want to draw attention to this template function here: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FwdIt</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string_type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">transform_primary</span></span></span><span class="hljs-class">(_</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FwdIt</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">First</span></span></span><span class="hljs-class">, _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FwdIt</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Last</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">// apply locale-specific case-insensitive transformation string_type _Res; if (_First != _Last) { // non-empty string, transform it vector&lt;_Elem&gt; _Temp(_First, _Last); _Getctype()-&gt;tolower(&amp;*_Temp.begin(), &amp;*_Temp.begin() + _Temp.size()); _Res = _Getcoll()-&gt;transform(&amp;*_Temp.begin(), &amp;*_Temp.begin() + _Temp.size()); } return (_Res); }</span></span></code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/w/V530/">warning</a> : <a href="http://www.viva64.com/ru/w/V530/">V530</a> The return value of the function 'tolower' is required to be utilized.  regex 319 <br><br>  I see this code for the first time and it's hard for me to navigate  Therefore, I don‚Äôt know if the analyzer is right, indicating a call to the <i>tolower</i> function.  Usually, the result of the <i>tolower</i> function must be used, but I do not know which particular <i>tolower</i> function is called here.  Therefore, I simply pay attention of the library developers to this code and ask to check it. <br><br><h3>  Hardcore </h3><br>  Here begins, in my opinion, the most interesting. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4dc/719/45d/4dc71945d11c16b6fa1ad2308d510493.png" alt="Picture 7"><br><pre> <code class="cpp hljs">_AFXCMN_INLINE <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CToolBarCtrl::GetString( _In_ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nString, _Out_writes_to_(cchMaxLen, <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>) LPTSTR lpstrString, _In_ <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> cchMaxLen) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { ASSERT(::IsWindow(m_hWnd)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) ::SendMessage(m_hWnd, ...., (LPARAM)lpstrString); lpstrString[cchMaxLen]=_T(<span class="hljs-string"><span class="hljs-string">'\0'</span></span>); }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/w/V779/">warning</a> : <a href="http://www.viva64.com/ru/w/V779/">V779</a> Unreachable code detected.  It is possible that an error is present.  afxcmn2.inl 111 <br><br>  Clear error: the last line of the function is never executed. <br><br>  The following code snippet contains a highly suspicious call to the <i>return statement</i> inside the loop body: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">HRESULT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetIndexOfPropertyInSet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( _In_ </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> GUID* pPropSet, _In_ DBPROPID dwPropertyId, _Out_ ULONG* piCurPropId, _Out_ ULONG* piCurSet)</span></span></span><span class="hljs-function"> </span></span>{ HRESULT hr = GetIndexofPropSet(pPropSet, piCurSet); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hr == S_FALSE) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hr; UPROPINFO* pUPropInfo = m_pUPropSet[*piCurSet].pUPropInfo; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(ULONG ul=<span class="hljs-number"><span class="hljs-number">0</span></span>; ul&lt;m_pUPropSet[*piCurSet].cUPropInfo; ul++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( dwPropertyId == pUPropInfo[ul].dwPropId ) *piCurPropId = ul; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> S_OK; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> S_FALSE; }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/w/V612/">warning</a> : <a href="http://www.viva64.com/ru/w/V612/">V612</a> An unconditional 'return' within a loop.  atldb.h 4837 <br><br>  It is not clear why there was a cycle to be done, if, all the same, this cycle will not be able to perform more than one iteration.  The code can be simplified.  However, it seems to me that here it is necessary not to simplify the code, but to correct the error.  I have a suspicion that the curly brackets are forgotten and, in fact, the function should look like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">HRESULT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetIndexOfPropertyInSet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( _In_ </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> GUID* pPropSet, _In_ DBPROPID dwPropertyId, _Out_ ULONG* piCurPropId, _Out_ ULONG* piCurSet)</span></span></span><span class="hljs-function"> </span></span>{ HRESULT hr = GetIndexofPropSet(pPropSet, piCurSet); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hr == S_FALSE) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hr; UPROPINFO* pUPropInfo = m_pUPropSet[*piCurSet].pUPropInfo; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(ULONG ul=<span class="hljs-number"><span class="hljs-number">0</span></span>; ul&lt;m_pUPropSet[*piCurSet].cUPropInfo; ul++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( dwPropertyId == pUPropInfo[ul].dwPropId ) { *piCurPropId = ul; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> S_OK; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> S_FALSE; }</code> </pre> <br>  In addition to the considered cycle, you should pay attention to a couple of <i>break</i> statements <i>,</i> which always interrupt the cycles: <br><br><ul><li>  V612 An unconditional 'break' within a loop.  viewprev.cpp 476 </li><li>  V612 An unconditional 'break' within a loop.  iomanip 489 </li></ul><br>  Now let's talk about Copy-Paste.  You can not write a big project and not make mistakes associated with copying and editing blocks of text. <br><br>  By the way, I suggest at the beginning to try to find the error yourself, without reading the article further. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CPaneContainerManager::RemoveAllPanesAndPaneDividers() { ASSERT_VALID(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); POSITION pos = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (pos = m_lstControlBars.GetHeadPosition(); pos != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>;) { POSITION posSave = pos; CBasePane* pWnd = DYNAMIC_DOWNCAST( CBasePane, m_lstControlBars.GetNext(pos)); ASSERT_VALID(pWnd); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pWnd-&gt;IsPaneVisible()) { m_lstControlBars.RemoveAt(posSave); } } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (pos = m_lstSliders.GetHeadPosition(); pos != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>;) { POSITION posSave = pos; CBasePane* pWnd = DYNAMIC_DOWNCAST( CBasePane, m_lstControlBars.GetNext(pos)); ASSERT_VALID(pWnd); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pWnd-&gt;IsPaneVisible()) { m_lstSliders.RemoveAt(posSave); } } }</code> </pre><br><p><img src="https://habrastorage.org/getpro/habr/post_images/2dc/ec8/362/2dcec83623dcef91f274a27f1493a157.png" alt="Picture 3"></p><br>  See what's wrong? <br><br>  I bet that many have surrendered and decided to read the article further.  This is a good example of why static analyzers are important and necessary: ‚Äã‚Äãthey are not lazy and not tired. <br><br>  PVS-Studio <a href="http://www.viva64.com/ru/w/V778/">warning</a> : <a href="http://www.viva64.com/ru/w/V778/">V778</a> Two code fragments were found.  Perhaps this is a typo and 'm_lstSliders' variable should not be used instead of 'm_lstControlBars'.  afxpanecontainermanager.cpp 1645 <br><br>  However, even after reading the analyzer warning, it‚Äôs not easy to find an error in the code.  Therefore, I will cut it, leaving important for us: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (... m_lstControlBars ...) { CBasePane* pWnd = ... m_lstControlBars ... m_lstControlBars.RemoveAt(); } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (... m_lstSliders ...) { CBasePane* pWnd = ... m_lstControlBars ... m_lstSliders.RemoveAt(); }</code> </pre> <br>  In the first cycle, the <i>m_lstControlBars</i> container is <i>processed</i> , and in the second, the <i>m_lstSliders</i> container. <br><br>  With a probability of 99%, the second cycle was written using Copy-Paste technology: the first cycle was taken, copied, and then it replaced the name <i>m_lstControlBars</i> with <i>m_lstSliders</i> .  But in one place you forgot to replace the name! <br><br>  Error here: CBasePane * pWnd = ... <b>m_lstControlBars</b> ... <br><br>  It was a good mistake, but the next one is not inferior to her in beauty.  Consider how the increment / decrement operators are implemented in the <i>CMFCScanliner</i> class: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CMFCScanliner</span></span></span><span class="hljs-class"> {</span></span> .... <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMFCScanliner&amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> ++ () { m_line += m_offset; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMFCScanliner&amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> ++ (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) { m_line += m_offset; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMFCScanliner&amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> -- () { m_line -= m_offset; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMFCScanliner&amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> -- (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) { m_line += m_offset; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } .... };</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/w/V524/">warning</a> : <a href="http://www.viva64.com/ru/w/V524/">V524</a> It is odd that the body of the '-' function is fully equivalent to the body of the '++' function.  afxtoolbarimages.cpp 656 <br><br>  Pay attention to the implementation of the latest operator.  Forgot to change <i>+ =</i> to <i>- =</i> .  This is a classic!  This is the ‚Äú <a href="https://www.viva64.com/ru/b/0260/">last line effect</a> ‚Äù in action! <br><br>  There are three places where leaks can occur.  Here is one of them: <br><br><pre> <code class="cpp hljs">CSpinButtonCtrl* CMFCPropertyGridProperty::CreateSpinControl( CRect rectSpin) { ASSERT_VALID(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); ASSERT_VALID(m_pWndList); CSpinButtonCtrl* pWndSpin = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CMFCSpinButtonCtrl; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!pWndSpin-&gt;Create(WS_CHILD | WS_VISIBLE | UDS_ARROWKEYS | UDS_SETBUDDYINT | UDS_NOTHOUSANDS, rectSpin, m_pWndList, AFX_PROPLIST_ID_INPLACE)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/w/V773/">warning</a> : <a href="http://www.viva64.com/ru/w/V773/">V773</a> The pWndSpin pointer.  A memory leak is possible.  afxpropertygridctrl.cpp 1490 <br><br>  If the <i>Create</i> function is executed with an error, the object to which the pointer is stored in the <i>pWndSpin</i> variable will not be deleted. <br><br>  Similarly: <br><br><ul><li>  V773 The function of the pList pointer.  A memory leak is possible.  afxribboncombobox.cpp 461 </li><li>  V773 The function of the pButton pointer.  A memory leak is possible.  afxvslistbox.cpp 222 </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">According to the C ++ standard, calling the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">delete</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operator </font><font style="vertical-align: inherit;">on a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void *</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pointer </font><font style="vertical-align: inherit;">results in undefined behavior. </font><font style="vertical-align: inherit;">And, as the reader has already guessed, this happens in the Visual C ++ libraries:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *PVOID; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> PVOID PSECURITY_DESCRIPTOR; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CSecurityDescriptor</span></span></span><span class="hljs-class"> {</span></span> .... PSECURITY_DESCRIPTOR m_pSD; .... }; <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> CSecurityDescriptor::~CSecurityDescriptor() { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> m_pSD; <span class="hljs-comment"><span class="hljs-comment">// &lt;=  m_pSD   void * free(m_pOwner); free(m_pGroup); free(m_pDACL); free(m_pSACL); }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font><a href="http://www.viva64.com/ru/w/V772/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">warning</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><a href="http://www.viva64.com/ru/w/V772/"><font style="vertical-align: inherit;">V772</font></a><font style="vertical-align: inherit;"> Calling a 'delete' operator for a void pointer will cause undefined behavior. </font><font style="vertical-align: inherit;">atlcom.h 1039 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Similar problems can be found here:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V772 Calling a 'delete' operator for a void pointer will cause undefined behavior. </font><font style="vertical-align: inherit;">atlcom.h 1048</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V772 Calling a 'delete' operator for a void pointer will cause undefined behavior. </font><font style="vertical-align: inherit;">atlcom.h 1070</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V772 Calling a 'delete' operator for a void pointer will cause undefined behavior. </font><font style="vertical-align: inherit;">atlcom.h 1667</font></font></li><li> V772 Calling a 'delete' operator for a void pointer will cause undefined behavior. afxstate.cpp 265 </li><li> V772 Calling a 'delete' operator for a void pointer will cause undefined behavior. dbcore.cpp 1240 </li><li> V772 Calling a 'delete' operator for a void pointer will cause undefined behavior. dbcore.cpp 1250 </li><li> V772 Calling a 'delete' operator for a void pointer will cause undefined behavior. doccore.cpp 1654 </li><li> V772 Calling a 'delete' operator for a void pointer will cause undefined behavior. dockstat.cpp 343 </li><li> V772 Calling a 'delete' operator for a void pointer will cause undefined behavior. filefind.cpp 43 </li><li> V772 Calling a 'delete' operator for a void pointer will cause undefined behavior. filefind.cpp 49 </li><li> V772 Calling a 'delete' operator for a void pointer will cause undefined behavior. sockcore.cpp 541 </li><li> V772 Calling a 'delete' operator for a void pointer will cause undefined behavior. winfrm.cpp 145 </li><li> V772 Calling a 'delete' operator for a void pointer will cause undefined behavior. winfrm.cpp 465 </li><li> V772 Calling a 'delete' operator for a void pointer will cause undefined behavior. mapiunicodehelp.h 168 </li></ul><br>  <i>CMFCReBar::CalcFixedLayout</i>   <i>bStretch</i> ,    . ,   ,  <i>bStretch</i>   1.  ,        ,    . <br><br><pre> <code class="cpp hljs">CSize CMFCReBar::CalcFixedLayout(BOOL bStretch, BOOL bHorz) { ASSERT_VALID(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); ENSURE(::IsWindow(m_hWnd)); <span class="hljs-comment"><span class="hljs-comment">// the union of the band rectangles is the total bounding rect int nCount = (int) DefWindowProc(RB_GETBANDCOUNT, 0, 0); REBARBANDINFO rbBand; rbBand.cbSize = m_nReBarBandInfoSize; int nTemp; // sync up hidden state of the bands for (nTemp = nCount; nTemp--; ) { rbBand.fMask = RBBIM_CHILD|RBBIM_STYLE; VERIFY(DefWindowProc(RB_GETBANDINFO, nTemp, (LPARAM)&amp;rbBand)); CPane* pBar = DYNAMIC_DOWNCAST( CPane, CWnd::FromHandlePermanent(rbBand.hwndChild)); BOOL bWindowVisible; if (pBar != NULL) bWindowVisible = pBar-&gt;IsVisible(); else bWindowVisible = (::GetWindowLong( rbBand.hwndChild, GWL_STYLE) &amp; WS_VISIBLE) != 0; BOOL bBandVisible = (rbBand.fStyle &amp; RBBS_HIDDEN) == 0; if (bWindowVisible != bBandVisible) VERIFY(DefWindowProc(RB_SHOWBAND, nTemp, bWindowVisible)); } // determine bounding rect of all visible bands CRect rectBound; rectBound.SetRectEmpty(); for (nTemp = nCount; nTemp--; ) { rbBand.fMask = RBBIM_STYLE; VERIFY(DefWindowProc(RB_GETBANDINFO, nTemp, (LPARAM)&amp;rbBand)); if ((rbBand.fStyle &amp; RBBS_HIDDEN) == 0) { CRect rect; VERIFY(DefWindowProc(RB_GETRECT, nTemp, (LPARAM)&amp;rect)); rectBound |= rect; } } // add borders as part of bounding rect if (!rectBound.IsRectEmpty()) { CRect rect; rect.SetRectEmpty(); CalcInsideRect(rect, bHorz); rectBound.right -= rect.Width(); rectBound.bottom -= rect.Height(); } bStretch = 1; return CSize((bHorz &amp;&amp; bStretch) ? 32767 : rectBound.Width(), (!bHorz &amp;&amp; bStretch) ? 32767 : rectBound.Height()); }</span></span></code> </pre> <br>  PVS-Studio: <a href="http://www.viva64.com/ru/w/V763/">V763</a> Parameter 'bStretch' is always rewritten in function body before being used. afxrebar.cpp 209 <br><br>  ¬´bStretch = 1;¬ª  ,    -   ,    . ,    .         . <br><br> ,    <i>AdjustDockingLayout</i>   <i>CBasePane</i>  <i>CDockSite</i> . <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CBasePane</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CWnd { .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AdjustDockingLayout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HDWP hdwp = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">NULL</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; .... }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CDockSite</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CBasePane { .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AdjustDockingLayout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; .... };</code> </pre> <br>  PVS-Studio: <a href="http://www.viva64.com/ru/w/V762/">V762</a> It is possible a virtual function was overridden incorrectly. See first argument of function 'AdjustDockingLayout' in derived class 'CDockSite' and base class 'CBasePane'. afxdocksite.h 94 <br><br>  ,   -          <i>hdwp</i> ,   - .  ,     . <br><br>  : <br><br><ul><li> V762 It is possible a virtual function was overridden incorrectly. See first argument of function 'CopyState' in derived class 'CPane' and base class 'CBasePane'. afxpane.h 96 </li><li> V762 It is possible a virtual function was overridden incorrectly. See first argument of function 'CopyState' in derived class 'CDockablePane' and base class 'CPane'. afxdockablepane.h 184 </li><li> V762 It is possible a virtual function was overridden incorrectly. See second argument of function 'SizeToContent' in derived class 'CMFCLinkCtrl' and base class 'CMFCButton'. afxlinkctrl.h 50 </li><li> V762 It is possible a virtual function was overridden incorrectly. See first argument of function 'RecalcLayout' in derived class 'CMFCTasksPane' and base class 'CPane'. afxtaskspane.h 287 </li></ul><br>        ,     , ,   .      <i>CAccessToken</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CAccessToken</span></span></span><span class="hljs-class"> {</span></span> .... <span class="hljs-keyword"><span class="hljs-keyword">mutable</span></span> CRevert *m_pRevert; }; <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CAccessToken::ImpersonateLoggedOnUser() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">throw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> m_pRevert; m_pRevert = _ATL_NEW CRevertToSelf; .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The analyzer issues a warning: </font></font><a href="http://www.viva64.com/ru/w/V599/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V599</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The virtual destructor is not present, although the 'CRevert' class contains virtual functions. </font><font style="vertical-align: inherit;">atlsecurity.h 5252 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's see why he does it. </font><font style="vertical-align: inherit;">We are interested in the member </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m_pRevert</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which is a pointer to an object of type </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CRevert</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The class is used polymorphically. </font><font style="vertical-align: inherit;">This conclusion can be reached by looking at this line of code:</font></font><br><br><pre> <code class="cpp hljs">m_pRevert = _ATL_NEW CRevertToSelf;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The class </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CRevertToSelf is</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> inherited from the class </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CRevert</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Let's now get acquainted with these classes:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CRevert</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Revert</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">throw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CRevertToSelf</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CRevert { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Revert</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">throw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> != ::RevertToSelf(); } };</code> </pre> <br>       <i>CRevert</i> ?      . <br><br>       PVS-Studio  ,     . ,   V611     ,          .   ,     . <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TAccessor</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CBulkRowset</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CRowset&lt;TAccessor&gt; { .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetRows</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_In_ DBROWCOUNT nRows)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">throw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nRows == <span class="hljs-number"><span class="hljs-number">0</span></span>) nRows = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nRows != m_nRows) { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> m_phRow; m_phRow = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; m_nRows = nRows; } } <span class="hljs-function"><span class="hljs-function">HRESULT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BindFinished</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">throw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ m_nCurrentRows = <span class="hljs-number"><span class="hljs-number">0</span></span>; m_nCurrentRow = <span class="hljs-number"><span class="hljs-number">0</span></span>; m_hr = S_OK; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_phRow == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { m_phRow = _ATL_NEW HROW[m_nRows]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_phRow == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> E_OUTOFMEMORY; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> S_OK; } .... HROW* m_phRow; .... }</code> </pre> <br>  PVS-Studio: <a href="http://www.viva64.com/ru/w/V611/">V611</a> The memory was allocated using 'new T[]' operator but was released using the 'delete' operator. Consider inspecting this code. It's probably better to use 'delete [] m_phRow;'. atldbcli.h 5689 <br><br>     <i>BindFinished</i>    <i>new []</i> : <br><br><pre> <code class="cpp hljs">m_phRow = _ATL_NEW HROW[m_nRows];</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memory is freed in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SetRows</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">using the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">delete</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operator </font><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> m_phRow;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Result: undefined behavior. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now let's talk about one very suspicious function call </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memset</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">However, before looking at the incorrect code, take a look at the code where everything is fine.</font></font><br><br>  The correct code is: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CToolTipCtrl::FillInToolInfo(TOOLINFO&amp; ti, ....) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(&amp;ti, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(AFX_OLDTOOLINFO)); ti.cbSize = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(AFX_OLDTOOLINFO); .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Before us is a typical situation. All members of the structure are cleared (filled with zeros) by calling the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memset</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">. Then the structure is written its size. This is standard practice for WinAPI. So many functions will find out with which version (format) of the structure they are working. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the above code, everything is logical. The size of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AFX_OLDTOOLINFO</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> structure is </font><i><font style="vertical-align: inherit;">calculated</font></i><font style="vertical-align: inherit;"> . Further this structure size is used to call the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memset</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">and the same size is written inside the structure. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now consider the anomalous code:</font></font><br><br><pre> <code class="cpp hljs">BOOL CControlBar::PreTranslateMessage(MSG* pMsg) { .... TOOLINFO ti; <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(&amp;ti, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(AFX_OLDTOOLINFO)); ti.cbSize = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(TOOLINFO); .... }</code> </pre> <br>  PVS-Studio: <a href="http://www.viva64.com/ru/w/V512/">V512</a> A call of the 'memset' function will lead to underflow of the buffer '&amp; ti'. barcore.cpp 384 <br><br>    <i>TOOLINFO</i> .    <i>TOOLINFO</i>     : <i>ti.cbSize = sizeof(TOOLINFO);</i>  . <br><br> ,    ,   ,          <i>sizeof(AFX_OLDTOOLINFO)</i> . <br><br>  ,     . <br><br>    ,  <i>memset</i>    . <br><br><pre> <code class="cpp hljs">GUID m_Id; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">zInternalStart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-comment"><span class="hljs-comment">// Zero the activity id in case we end up logging the stop. ZeroMemory(&amp;m_Id, sizeof(&amp;m_Id)); .... }</span></span></code> </pre> <br>  PVS-Studio: <a href="http://www.viva64.com/ru/w/V512/">V512</a> A call of the 'memset' function will lead to underflow of the buffer '&amp; m_Id'. traceloggingactivity.h 656 <br><br>  ,       .  ,    4  8 ,    ,  32-  64- .  GUID   16  (128 ). <br><br>  : <br><br><pre> <code class="cpp hljs">ZeroMemory(&amp;m_Id, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(m_Id));</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Not without warnings </font></font><a href="http://www.viva64.com/ru/w/V595/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This is not surprising, since this diagnostics reveals </font></font><a href="https://www.viva64.com/ru/examples/V595/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">one of the most common errors</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in C and C ++ programs. </font><font style="vertical-align: inherit;">However, in C #, </font></font><a href="https://www.viva64.com/ru/examples/V3095/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">everything is also not perfect</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The essence of the error lies in the fact that the pointer dereference occurs before it is checked. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consider the code snippet identified using this diagnostic.</font></font><br><br><pre> <code class="cpp hljs">HRESULT CBasePane::get_accHelp(VARIANT varChild, BSTR *pszHelp) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((varChild.vt == VT_I4) &amp;&amp; (varChild.lVal == CHILDID_SELF)) { *pszHelp = SysAllocString(<span class="hljs-string"><span class="hljs-string">L"ControlPane"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> S_OK; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (((varChild.vt != VT_I4) &amp;&amp; (varChild.lVal != CHILDID_SELF)) || (<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> == pszHelp)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> E_INVALIDARG; } .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font><a href="http://www.viva64.com/ru/w/V595/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">warning</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><a href="http://www.viva64.com/ru/w/V595/"><font style="vertical-align: inherit;">V595</font></a><font style="vertical-align: inherit;"> The 'pszHelp' pointer was used against nullptr. </font><font style="vertical-align: inherit;">Check lines: 1324, 1328. afxbasepane.cpp 1324 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the function is called like this:</font></font><br><br><pre> <code class="cpp hljs">VARIANT foo; foo.vt = VT_I4; foo.lVal = CHILDID_SELF; get_accHelp(foo, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>);</code> </pre> <br>        <i>E_INVALIDARG</i> ,       . <br><br>    .  . ,        <i>NULL</i> .    ,      .    ,  . ,  ! <br><br>    ,    .  Visual C++   .   17 ,   : <a href="http://cppfiles.com/vs2017_V595.txt">vs2017_V595.txt</a> . <br><br>    ,      FALSE  S_FALSE. <br><br><pre> <code class="cpp hljs">BOOL CMFCRibbonPanel::OnSetAccData (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lVal) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nIndex &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || nIndex &gt;= arElements.GetSize()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FALSE; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GetParentWnd()-&gt;GetSafeHwnd() == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> S_FALSE; } ASSERT_VALID(arElements[nIndex]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> arElements[nIndex]-&gt;SetACCData(GetParentWnd(), m_AccData); }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font><a href="http://www.viva64.com/ru/w/V716/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">warning</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><a href="http://www.viva64.com/ru/w/V716/"><font style="vertical-align: inherit;">V716</font></a><font style="vertical-align: inherit;"> Suspicious type conversion in </font><a href="http://www.viva64.com/ru/w/V716/"><font style="vertical-align: inherit;">HR</font></a><font style="vertical-align: inherit;"> statement, but the function actually returns BOOL. </font><font style="vertical-align: inherit;">afxribbonpanel.cpp 4107. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The function returns the type </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BOOL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">If it was not possible to get the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HWND</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from the parent window, the programmer wanted to return </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FALSE</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> values ‚Äã‚Äãfrom the function </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">But it was sealed and wrote </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S_FALSE</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that radically changes everything. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here is how the constant S_FALSE is declared:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> S_FALSE ((HRESULT)1L)</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I think you already understand what is happening, but I will explain just in case. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Write ‚Äúreturn S_FALSE;‚Äù is the same as writing ‚Äúreturn TRUE;‚Äù. </font><font style="vertical-align: inherit;">Epic fail. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Error is not alone, she has friends:</font></font><br><br><ul><li> V716 Suspicious type conversion in return statement: returned HRESULT, but function actually returns BOOL. afxribbonbar.cpp 5623 </li><li> V716 Suspicious type conversion in return statement: returned HRESULT, but function actually returns BOOL. afxribbonbar.cpp 5627 </li><li> V716 Suspicious type conversion in return statement: returned HRESULT, but function actually returns BOOL. ctlnownd.cpp 349 </li><li> V716 Suspicious type conversion in return statement: returned HRESULT, but function actually returns BOOL. olecli2.cpp 548 </li></ul><br><h3>  Note </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As mentioned at the beginning of the article, I have not checked all the files. In addition, I could miss something among the warnings issued by the analyzer. Therefore, please do not consider the developers of this document as a guide to correct some errors. It is much better if the developers themselves fully check the libraries and carefully examine the warnings of the analyzer.</font></font><br><br><h2>  Conclusion </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/2e4/862/9e8/2e48629e8817e804901983cdfe9f0359.png" alt="Picture 4"></p><br><br>       ,        . <br><br>     .     ,          .  -    ,   ,    ,        .       .    ,      ,       ,   . <br><br>       PVS-Studio     . <br><br>   PVS-Studio: <a href="https://www.viva64.com/ru/pvs-studio/">https://www.viva64.com/ru/pvs-studio/</a> <br><br>  Supported languages ‚Äã‚Äãand compilers: <br><br><ul><li> Windows.  Visual Studio 2017 C, C ++, C ++ / CLI, C ++ / CX (WinRT), C # </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows </font><font style="vertical-align: inherit;">Visual Studio 2015 C, C ++, C ++ / CLI, C ++ / CX (WinRT), C #</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows </font><font style="vertical-align: inherit;">Visual Studio 2013 C, C ++, C ++ / CLI, C ++ / CX (WinRT), C #</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows </font><font style="vertical-align: inherit;">Visual Studio 2012 C, C ++, C ++ / CLI, C ++ / CX (WinRT), C #</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Windows </font></font> Visual Studio 2010 C, C ++, C ++ / CLI, C # </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows </font><font style="vertical-align: inherit;">MinGW C, C ++</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows / Linux. </font><font style="vertical-align: inherit;">Clang C, C ++</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux </font><font style="vertical-align: inherit;">GCC C, C ++</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thank you for your attention and </font></font><a href="https://twitter.com/Code_Analysis"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">follow @Code_Analysis</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on twitter </font><font style="vertical-align: inherit;">.</font></font><br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0502/"><img src="https://habrastorage.org/files/8d2/41b/5bf/8d241b5bf34747169141ed7c1997143b.png"></a> </div><br><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Andrey Karpov. <a href="http://www.viva64.com/en/b/0502/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to Improve Visual C ++ 2017 Libraries Using PVS-Studio</font></font></a> <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. </div></div></div><p>Source: <a href="https://habr.com/ru/post/327784/">https://habr.com/ru/post/327784/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327762/index.html">Biometric authentication technology - a European perspective</a></li>
<li><a href="../327766/index.html">Cultural Embedded at IT Global Meetup In St. Petersburg</a></li>
<li><a href="../327768/index.html">From two tuning forks from Lissajous experiments to a single elliptical level gauge tube with a step of centuries and everything in Python</a></li>
<li><a href="../327780/index.html">Handbook "beekeeper" or answer questions on the EFM8 Bee microcontrollers</a></li>
<li><a href="../327782/index.html">How to create a simple Scala SBT application for Android</a></li>
<li><a href="../327786/index.html">GameDev from scratch: How to communicate with the player without words</a></li>
<li><a href="../327788/index.html">Ready native modules for node.js</a></li>
<li><a href="../327792/index.html">Development of a simulator of the evolution of single-celled organisms "The strongest survives"</a></li>
<li><a href="../327796/index.html">Conference Outsource-People 2017, Krakow (day one)</a></li>
<li><a href="../327804/index.html">The first decade of augmented reality</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>