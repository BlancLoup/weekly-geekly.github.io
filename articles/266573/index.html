<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I stopped worrying and started committing to GIT on a big 1C-Bitrix project</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I had the opportunity to work for a long time as an admin manager (a kind of playing trainer) on a large 1C-Bitrix web project: over 40 sites for vari...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I stopped worrying and started committing to GIT on a big 1C-Bitrix project</h1><div class="post__text post__text-html js-mediator-article"><img src="http://./upload/medialibrary/ebc/ebcb79ca5d48d0e3491b6eed709c80cd.jpg" alt="KdPV is a text writer at the Summer Partnership Conference 1C-Bitrix 2012"><br><br>  I had the opportunity to work for a long time as an admin manager (a kind of playing trainer) on a large 1C-Bitrix web project: over 40 sites for various holding organizations from different countries, Oracle DB, Web Cluster editorial, more than 100 GB of files, several years of history , more than 20 edits of the kernel that survived many updates of the Kernel, paranoid security mode and ... direct changes in the functionality of the "hands" on the battle server without any hints of version control ... <br>  Very sad picture, causing many "accidents at work", which after the next incident was ordered to be corrected. <br><br>  This article describes my experience, but it will be useful primarily for owners of small Internet projects who have never used a version control system and do not know where to start. <br><a name="habracut"></a><br>  Actually all our troubles were due to 2 main reasons: <br><ol><li>  The big project was running at full speed along its narrow gauge railway into a bright future, and it was a bit difficult to change the rails under it at that moment. </li><li>  Despite the huge amount of literature devoted to version control systems and GIT in particular, almost all of it suffers from a lack of scripts and clear guidelines.  For example, the magnificent <a href="https://git-scm.com/book/ru/">Pro Git</a> perfectly describes each individual function and operation, but almost does not give an idea of ‚Äã‚Äãwhich end to start using this wealth. </li></ol><br><div class="spoiler">  <b class="spoiler_title">Captain obvious</b> <div class="spoiler_text">  <b>My most important advice to anyone who wants to start using GIT is to start.</b> <br>  Just take and start at least with something. <br>  And then complicate. <br>  Personally, I was very helped to put scripts and instructions on the shelves. <br></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The narration will be divided into parts: <br><ul><li>  Description of the situation </li><li>  Instruments </li><li>  Instructions <br><ul><li>  3.1 Initializing the Repository </li><li>  3.2 Nakat task update </li><li>  3.3 Committing daily changes (at the end of the day) </li><li>  3.4 Roll back changes </li></ul></li><li>  Conclusion </li><li>  FAQ </li></ul><br><br><br><h2>  Part 1 - Description of the situation </h2><br>  I am directly on the territory of the Customer and serve as a kind of bridge between him and the Developer. <br><br>  Good security guards of the Customer limit access to everything that can be at least something replaced. <br>  Probably, this article would never have appeared (and the problems hiding behind it would be much less) if both I and the Developer had SSH / FTP access. <br>  However, there was no such access, no, and probably it will not, since a purely formal introduction of changes is possible in 2 ways: <br><ul><li>  Remotely through the admin panel 1C-Bitrix </li><li>  Directly on the territory of the Customer (under the strict supervision) </li></ul><br>  Therefore, when rolling out some tasks, I occasionally received a call from the Developer Manager: <br><blockquote>  Alexey, we want to roll out task XXX here.  Zabekapte please init.php, but it is not enough ... </blockquote><br>  Naturally, ‚Äúyou never know,‚Äù it sometimes came, and the request to restore the specified file went all along the chain, and the site was unavailable at that time <br><br>  Similarly, access to the Central Repository (GitLab), when it was created, was limited entirely to the territory of the Customer.  This leads to important restrictions on the implementation of GIT: <br><ul><li>  The developer cannot get a repo from the Customer‚Äôs servers (only if he copies the .git folder by hand) </li><li>  The developer can not roll the update using GIT.  Roll forward manually. </li></ul><br>  The version control systems of the Customer and the Developer are actually isolated from each other (the message occurs exclusively in manual mode through the 1C-Bitrix admin panel). <br><br>  And also administrative access (1 group 1C-Bitrix) is limited in time.  There is a special script that, at the DB level (Oracle), distributes the rights to me and the Developer at 9.00 and selects at 17.50 in Moscow. <br><br>  <i>I know this is a nightmare.</i>  <i>Do not remind me of this in the comments.</i>  <i>=)</i> <br><br><br><h2>  Part 2 - Tools </h2><br><h3>  2.1 Servers </h3><br><br>  <b>Prod</b> - the main battle server. <br><br>  At the direction of the authorities were created in addition to the Battle Server 2 copies: <br><ul><li>  <b>Test</b> - can be recreated upon request (the process is long, since it requires the involvement of people from other departments, the estimated implementation period is 24 hours).  The server is accessible only from the Customer‚Äôs and Developer‚Äôs networks. </li><li>  <b>Prelive</b> - automatically re-created 1 time per day (at night), erasing all the changes made, takes the version of the Battle Server that is current at the time of creation.  The server is accessible only from the Customer‚Äôs and Developer‚Äôs networks. </li></ul><br>  <u>Access to all 3 servers, both for me and for the Developer, is only via https</u> (an automatic authorization in 1C-Bitrix takes place according to the certificate). <br>  <u>SSH / FTP access only from my immediate superior</u> .  = ( <br>  <b>GitLab</b> is a separate server for deploying GitLab, used as the Central Repository.  The server is accessible only from the Customer‚Äôs network by direct IP (suppose that 172. ***. ***. 61 is for the specifics of this article, but in fact it can be any IP or domain, in your case, for example, github.com) . <br>  <u>All 3 web servers (Prod / Test / Prelive) have ssh access to GitLab.</u> <br>  <u>I only have access to GitLab via http (in fact, I can only create / delete repositories and watch a beautiful picture with branches).</u> <br>  <b>DEV</b> - The symbol for the segment of servers and workstations of the Developer.  This article is not considered.  All changes from the segment are transferred to the Customer‚Äôs server by hand through the 1C-Bitrix admin panel by me or by the Developer. <br><br>  The initial task reloading scheme assumed the passage of the entire chain: <br>  <b>DEV ‚Üí TEST ‚Üí PRELIVE ‚Üí PROD</b> <br>  The final test was supposed to be on the ‚Äúmost relevant‚Äù Prelaive before rolling the task into battle.  The scheme naturally turned out to be very dreary and of little use. <br>  At the moment, I abandoned it in favor of using 2 servers for checking Tasks (on Test, requiring long checks, on Prelive, they are quickly checked): <br>  <b>DEV ‚Üí TEST / PRELIVE ‚Üí PROD</b> <br>  The transfer of code from one server to another in the Customer segment occurs ONLY through the Central Repository (GitLab), so that the run-up scheme can be represented as follows: <br><img src="https://habrastorage.org/files/4e2/8ef/a97/4e28efa97bdd4c3ab1508a03fe3524de.jpg"><br><br><h4>  2.1.1 GIT on the server </h4><br>  Installed by the system administrator.  Unfortunately, I can‚Äôt tell anything really useful on this topic (the question goes beyond my competence). <br>  No special manipulations other than generating SSH keys (for communication between servers and Central Repository (GitLab)). <br>  The instruction is easily googled, or is in the help section of GitLab. <br><br><h4>  2.1.2 Web console on the server (git_console.php) </h4><br>  As mentioned above, neither I nor the Developer have SSH access to the servers, so to transfer the GIT commands I had to install a separate script that implements the console in the browser. <br>  Thanks for it <a href="https://habrahabr.ru/users/elfet/" class="user_link">Elfet</a> ( <a href="http://habrahabr.ru/post/147919/">article about the console on Habr√©</a> ) <br>  We made very minor changes: <br><ul><li>  They put the console itself in a directory inaccessible to the Developer in the server's depths (so that neither the Developer, nor I <s>, nor ‚Äúthe potential Malicious user</s> could make changes to the console code).  At the same time, in the kernel we put the git_console.php file available to administrators, which simply connects the script from the depths; </li><li>  In the settings of the script put a restriction on the execution of commands (only git, pwd and cd); </li><li> Changed the console background color (Test - green, Prelive - gray, Prod - black).  <i>This was done after I was glad to start the task ‚Äúnot there‚Äù</i> =) </li><li>  Added access restriction by certificate (i.e. not every Admin has access to the console. During the test period, only I had access, after transferring to commercial operation, access was given to 1 Developer programmer). </li></ul><br><br>  <b>An important advantage of this solution</b> is console autonomy!  Those.  even if the Developer puts an unsuccessful <s>pen stroke with a</s> change in init.php, the console will still work (because it does not use 1C-Bitrix) and the Developer will be able to roll back himself. <br><br><h4>  2.1.3 Repository Structure </h4><br>  Unfortunately, not all sites in the system are under the version control system, but only the ‚Äúheads‚Äù of the holding.  This causes certain inconveniences and problems (for example, when the Developer makes an amendment to the Kernel for some of the Daughters), but this is mainly a problem for the owners of these sites ‚Äúon the ground‚Äù.  Perhaps in the future, despite the overheads and they will be added to the GIT. <br>  Scheme of the real repository structure (names and addresses partially erased): <br><img alt="Scheme of the real repository structure (names and addresses partially erased)" src="https://habrastorage.org/getpro/habr/post_images/8c1/ed7/d2b/8c1ed7d2b683708b03b8b6045ddbbbaf.png"><br>  As we see in our structure: <br><ul><li>  The kernel is in a separate directory. </li><li>  Folders of some sites are grouped in separate directories "by meaning" </li><li>  Some sites have their own personal directory / local / </li><li>  Some sites have a group directory / local / </li><li>  Some repositories have submodules (repositories within the repository) - these are usually special projects that are rarely updated after completion, but have serious differences in both logic and content (they are often subject to seriously different rules for .gitignore).  Therefore, they are taken out separately, so as not to create a mess. </li></ul><br>  Not a single repository (even in its worst times) exceeded 300MB. <br>  This is achieved by a political decision not to include certain types of content (binary files like PDF, avi, jpg, etc.) into such repositories unnecessarily and with the corresponding ban in .gitignore. <br><h4>  2.1.4 Documentation </h4><br>  All pictures (except for KdPV of course) for this article are taken from the Documentation, which is located on a special resource available to the Customer, me and the Developer. <br>  Initially (for the period of test operation) drafts of the documentation were stored on my machine, but now all the documentation has been published for the entire team to access. <br><br><br><h2>  Part 3 - Instructions </h2><br>  So we got to the most interesting. <br>  If everything that is written in Part 1 is purely for creating context (in order to gain condescension from experienced users), and in Part 2 it‚Äôs more to go into the question (just for those who have a big project that is rapidly approaching Horizon). Events), then <b>part 3 - these are just those basic examples of instructions that I personally did not have enough for a start.</b> <br>  I hope that those who have not used GIT, but want to start (even if they have a small online store on a shared hosting) will be able to ask for GIT technical support, and use GitHub or BitBucket as the Central repository and using the scripts described below will start work.  And in the process they will already be able to start studying the <a href="https://git-scm.com/book/ru/">Pro Git</a> documentation and adapt their working methods, make them more flexible and perfect. <br>  All of the above was not born on the same day.  But even when it finally appeared, the question remained how to use all this wealth. <br>  All the instructions below were written in <s>blood and then</s> ‚Äúfor myself‚Äù by me. <br><br><br><h3>  3.1 Initializing the Repository </h3><br><h3>  3.1.1 Initializing the Repository to the Prod (and Re-creating the Prod / Prelive) </h3><br>  The most simple and correct method. <br>  It means that you create a repository in the Battle, and then copy the entire site (including the repository) from Battle to Test and Prelay. <br>  On example of directory / local / (common for several sites) <br><blockquote> Web console (on PROD) - https: //********.ru: 1119 / bitrix / admin / git_console.php <br>  <code>cd /u-app/bitrix/Apache/htdocs/site/******/local/</code> (go to the directory / local / common for sites Press Services from any other place) <br>  <code>pwd</code> - we define the current directory (we check the location) <br>  <code>git status</code> - check GIT status (should show no repository) <br>  Put .gitignore (see sample in appendix) <br> <code>git init</code> <br> <code>git config user.name "Zadoiny Alexey"</code> <br> <code>git config user.email "aleksey.zadoiny@******.ru"</code> <br> <code>git add -A .</code> <br> <code>git commit -m 'initital'</code> <br>  Create if repo was not created in GitLab (with the name local - ******) <br> <code>git remote add origin git@172.***.***.61:Alexey.Zadoiny/local-******.git</code> <br> <code>git push -u origin master</code> <br> </blockquote><br><div class="spoiler">  <b class="spoiler_title">Example .gitignore for repository in / local /</b> <div class="spoiler_text">  /.htaccess <br>  * .log <br>  * .tar <br>  * .gz <br>  * .sql <br>  # *. flv <br>  # *. mp4 <br>  # *. pdf <br>  avi <br>  # *. png <br>  jpg <br>  gif <br>  bmp <br>  * .rar <br>  * .zip <br>  * .7z <br>  * .webm <br>  # *. mp3 <br>  wav <br>  # *. swf <br>  /log.txt <br>  * ._ log <br>  / mail_log / <br>  /_log.txt <br>  * sitemap _ *. xml <br><br>  .htaccess <br>  urlrewrite.php <br></div></div><br><br>  After creating the repository in the folder. Git, you must put the file. Htaccess with <br>  following content: <br><blockquote>  deny from all </blockquote><br><br><h3>  3.1.2 Initialization of the Repository to the Prod (and transfer to an empty TEST / PRELIVE) </h3><br>  <b>Why do you need it?</b>  For example, test and combat servers have already been created and configured, and synchronization between them is not possible in the near future. <br>  It is important that there are only a small number of files that are not subject to synchronization, but are necessary (that is, the method is suitable for the kernel, because only the database connection files are not synchronized there, but not suitable for the public part if there is a lot of content in as binary files that are excluded from the repository, otherwise see clause 3.1.3) <br><br><div class="spoiler">  <b class="spoiler_title">On the example of the kernel / bitrix / common for all sites</b> <div class="spoiler_text">  On the Battle: <br><blockquote>  Web console (on PROD) - https: //*******.ru: 1119 / bitrix / admin / git_console.php <br>  <code>cd /u-app/bitrix/Apache/htdocs/bitrix/</code> (go to the directory / bitrix / common for all sites from any other place) <br>  <code>pwd</code> - we define the current directory (we check the location) <br>  <code>git status</code> - check GIT status (should show no repository) <br>  Put .gitignore (see sample in appendix) <br> <code>git init</code> <br> <code>git config user.name "Zadoiny Alexey"</code> <br> <code>git config user.email "aleksey.zadoiny@********.com"</code> <br> <code>git add -A .</code> <br> <code>git commit -m 'initital'</code> <br>  Create if repo was not created in GitLab (named bitrix) <br> <code>git remote add origin git@172.***.***.61:Alexey.Zadoiny/bitrix.git</code> <br> <code>git push -u origin master</code> <br> </blockquote><br><br>  Example .gitignore: <br><blockquote>  * .log <br>  * .tar <br>  * .gz <br>  * .sql <br>  * .flv <br>  * .mp4 <br>  * .pdf <br>  * .avi <br>  * .rar <br>  * .zip <br>  * .7z <br>  * .webm <br>  * .mp3 <br>  * .wav <br>  * .swf <br><br>  cache <br>  stack_cache <br>  managed_cache <br>  tmp <br><br>  php_interface / dbconn.php <br>  .settings.php <br></blockquote><br><br>  on Test / Prelayv: <br><blockquote>  Backing up the files /bitrix/.settings.php and /bitrix/php_interface/dbconn.php (any other vital files that will not be synchronized by GIT) <br>  Delete the contents of the folder / bitrix / <br>  <b>Web console does not work.</b>  <b>Go to the usual console!</b> <br>  <code>cd /u-app/bitrix/Apache/htdocs/bitrix/</code> (go to the directory / bitrix / from any other place) <br>  <code>pwd</code> - we define the current directory (we check the location) <br> <code>git init</code> <br> <code>git remote add origin git@172.***.***.61:Alexey.Zadoiny/bitrix.git</code> <br> <code>git pull origin master</code> <br>  Restoring a backup of the files /bitrix/.settings.php and /bitrix/php_interface/dbconn.php <br></blockquote><br><br>  After creating the repository in the folder. Git, you must put the file. Htaccess with <br>  following content: <br><blockquote>  deny from all </blockquote><br></div></div><br><br><h3>  3.1.3 Initialization of the Repository to the Prod (and transfer to a non-empty TEST / PRELIVE) </h3><br>  <b>Why do you need it?</b>  For example, test and combat servers have already been created and configured, and synchronization between them is not possible in the near future, and the directory contains a large amount of content that is not synchronized using a version control system (for example, binary content files: pdf, jpg, swf, avi and etc.) <br><br><div class="spoiler">  <b class="spoiler_title">On the example of the mobile version of one of the sites</b> <div class="spoiler_text">  On the Battle: <br><blockquote>  Web console (on PROD) - https: //*******.ru: 1119 / bitrix / admin / git_console.php <br>  <code>cd /u-app/bitrix/Apache/htdocs/site/******/m-ru/</code> (go to the directory Mobile RU from any other place) <br>  <code>pwd</code> - we define the current directory (we check the location) <br>  <code>git status</code> - check GIT status (should show no repository) <br>  Put .gitignore (see sample in appendix) <br> <code>git init</code> <br> <code>git config user.name "Zadoiny Alexey"</code> <br> <code>git config user.email "aleksey.zadoiny@******.ru"</code> <br> <code>git add -A .</code> <br> <code>git commit -m 'MOBILE RU 2014 initital'</code> <br>  Create if repo was not created in GitLab (with the name m-ru2014) <br> <code>git remote add origin git@172.***.***.61:Alexey.Zadoiny/m-ru2014.git</code> <br> <code>git push -u origin master</code> <br> <code>git log</code> <br> </blockquote><br>  The last command ( <code>git log</code> ) is executed to find out the commit hash: <br><img src="https://habrastorage.org/files/50a/c0a/a77/50ac0aa7779a4bd2b57ec9ea31253c71.png"><br>  We will need it if there are any GIT-controlled files on the Test / Prelaive (then we roll back to this commit, considering that we have the most current server status in battle and actually synchronize) <br><br>  Example .gitignore: <br><blockquote>  bitrix <br>  local <br>  upload <br>  docs <br><br>  /.htaccess <br>  * .log <br>  * .tar <br>  * .gz <br>  * .sql <br>  * .flv <br>  * .mp4 <br>  * .pdf <br>  * .avi <br>  * .png <br>  * .jpg <br>  * .gif <br>  * .bmp <br>  * .rar <br>  * .zip <br>  * .7z <br>  * .webm <br>  * .mp3 <br>  * .wav <br>  * .swf <br>  /log.txt <br>  * ._ log <br>  / mail_log / <br>  /_log.txt <br>  * sitemap _ *. xml <br><br>  .htaccess <br>  urlrewrite.php <br></blockquote><br><br>  Now let's copy the entire .git folder from the battlefield, which appeared in the bark of the mobile version directory (it is better to archive it first, because there are many small files inside) and transfer it to Test / Prelay. <br>  There we will unpack and check the status of the repository: <br><blockquote>  Web console (on TEST / PRELIVE) - https: //*******.ru: 1119 / bitrix / admin / git_console.php <br>  <code>cd /u-app/bitrix/Apache/htdocs/site/******/m-ru/</code> (go to the directory Mobile RU from any other place) <br>  <code>pwd</code> - we define the current directory (we check the location) <br>  <code>git status</code> - check GIT status (must show no changes) <br>  If there are any changes: <br>  <code>git reset --hard #HASH#</code> where # HASH # is the first 4-5 characters from the commit hash that we received in battle (more is possible, but usually quite a small number) <br></blockquote><br><br>  After creating the repository in the folder. Git, you must put the file. Htaccess with <br>  following content: <br><blockquote>  deny from all </blockquote><br></div></div><br><br><h3>  3.1.4 Initialization of the Submodule Repository on the Prod (and porting to a Non-Empty TEST / PRELIVE) </h3><br>  The difficulty with the submodule lies in the fact that you need to edit the already existing ecosystem (Ie, the repository already exists, and suddenly you want to tell him ‚Äú <i>uh, not, dear, here there will be a fence, and Vasya will live behind the fence!</i> ‚Äú) <br>  In particular, if you first deploy some functionality, commit it, then in order to create a submodule at this point, you will have to delete all created files / directories ( <a href="https://toster.ru/q/110569">TOSTER question on this topic</a> ). <br><br><div class="spoiler">  <b class="spoiler_title">Creating a submodule d **** within the existing repository</b> <div class="spoiler_text">  Create in the Central Repository (GitLab) a new empty repository (with the name **** - project-d ****) <br><br>  We check on Boy and if there is - delete the folder / u-app / bitrix / Apache / htdocs / site / ********** / en / ***** / ****** / d * *** / <br>  Go to the web console - https: //********.ru: 1119 / bitrix / admin / git_console.php <br><blockquote>  <code>cd /u-app/bitrix/Apache/htdocs/site/*********/ru/</code> (go to the Repository directory from any other location) <br>  <code>pwd</code> - we define the current directory (we check the location) <br>  <code>git status</code> - check the status of GIT (should show the presence of the root repository) <br> <code>git submodule add git@172.***.251.61:Alexey.Zadoiny/****-project-d****.git *****/****/d****/</code> <br> </blockquote><br>  If we now do git status, we will see: <br><img src="https://habrastorage.org/files/5c0/8f9/a28/5c08f9a280cf40ef82638ba6f1a399c6.png"><br><blockquote> <code>git add -A .</code> <br> <code>git commit -m 'INIT SUBmodule D****</code> <br> </blockquote><br><br><ul><li>  Now we can work with the submodule as an independent repository (commit its state, change it via GitLab with the Prod / Test / Prelive server, etc.) </li><li>  When updating the state of the main repository on Test / Prelive, a new submodule will be automatically installed there! </li></ul><br></div></div><br><br><br><h3>  3.2 Nakat task update </h3><br>  Let me remind you that initially this process was supposed to follow the scheme: <br>  DEV ‚Üí TEST ‚Üí PRELIVE ‚Üí PROD <br>  Therefore, the update scheme contained 11 main and 4 additional steps and had several branches: <br><div class="spoiler">  <b class="spoiler_title">Spawn of hell</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/601/6be/a2d/6016bea2d4234ba0822c9147545b3749.jpg"><br>  The horizontal version of this nightmare still hangs in my workplace ( <i>I should probably remove it, but it is really funny to look at the thoughtful shaking of the head of people who first worked with me, for example, representatives of the new Contractor who came to roll a special project</i> ) <br><img src="https://habrastorage.org/files/2b7/61e/808/2b761e808b8642c19804e862f3955459.jpg"><br></div></div><br>  Now the scheme is simplified to <br>  DEV ‚Üí TEST / PRELIVE ‚Üí PROD <br><img src="https://habrastorage.org/files/c6a/0b5/498/c6a0b5498b4641fcaefe014a3f3eccc6.jpg"><br><br>  Note.  In fact, in all instructions I have not 1 address (cd ), but a sign with a list of all addresses.  Those.  When executing the action, you can select 1 any and copy it entirely (and not recall, let to the directory of this or that repo) <br><div class="spoiler">  <b class="spoiler_title">an example of how it looks</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/7ad/fb8/4c4/7adfb84c438f4951a754988dd0b211c6.png"><br></div></div><br>  For the sake of this article, for brevity, I will use 1 address everywhere (since I suppose that most novice GIT users will not have to immediately work with many repositories at once. <br><br>  <b>Each step is considered as independent and autonomous</b> , therefore it begins with the transition to the repository directory.  If the process is not interrupted, then this item instructions can simply be ignored. <br><br><h4>  3.2.0 Run Upgrade Task - Step 0 </h4><br><img src="https://habrastorage.org/files/87d/120/71b/87d12071be3a4b05b4054eb5328d8833.jpg"><br>  <code>cd /u-app/bitrix/Apache/htdocs/bitrix/</code> - go to the project folder.  We check ourselves with the <code>pwd</code> <br>  <code>git status</code> - there should not be any uncommitted changes. <br>  <code>git log</code> - the last commit should correspond to the last commit of the Master branch of the central GitLab repository <br>  <b>If</b> <code>git log</code> did not show the last commit, go to steps 3.4 and after rolling up the current state from the battlefield to the test / prelaw we start the procedure from the beginning. <br>  <b>Nakat</b> - we transfer to the test / preraiv functional of the task by any means (FTP, admin). <br><br><h4>  3.2.1 Nakat task update - Step 1 </h4><br><img src="https://habrastorage.org/files/1e5/74b/7ca/1e574b7caa794645a2b8d14279408ffb.jpg"><br> <code>cd /u-app/bitrix/Apache/htdocs/bitrix/</code> <br> <code>git add -A .</code> <br> <code>git commit -m 'TIKET ######'</code> <br> <code>git push origin master:TIKET_######</code> <br>  <i>We commit the changes, send them from the development branch (master on the test / pre-server) to the branch in the central repository.</i> <br><div class="spoiler">  <b class="spoiler_title">Alternative option</b> <div class="spoiler_text">  In case git status shows changes <u>not only</u> in the task files to be entered into the GIT, it is recommended to use: <br> <code>git add -A /puth/</code> <br>  or <br> <code>git add -A /puth/file.php</code> <br>  For all directories and files that need to be added to the version control system.  Point instead of the path indexes All changed (as well as created and deleted) files. <br></div></div><br><br><h4>  3.2.2 Nakat task update - Step 2 </h4><br><img src="https://habrastorage.org/files/059/28e/088/05928e08820440a78eecd87e87f4f303.jpg"><br> <code>cd /u-app/bitrix/Apache/htdocs/bitrix/</code> <br> <code>git status</code> <br> <code>git add -A .</code> <br> <code>git commit -m 'Prod changes ##'</code> <br> <code>git push origin master</code> <br>  <i>Check the status of the battle.</i> <i><br></i>  <i>If the state of the battle has changed (and the test / head is in a more irrelevant state), then commit the change and send it to the central repository for synchronization.</i> <br>  <b>If there are no changes ‚Üí go to Step 4.</b> <br><br><h4>  3.2.3 Nakat task update - Step 3 </h4><br><img src="https://habrastorage.org/files/e0c/a69/9ef/e0ca699ef7a54f669d4c8eac656d770e.jpg"><br> <code>cd /u-app/bitrix/Apache/htdocs/bitrix/</code> <br> <code>git pull origin master</code> <br>  <i>If, during the roll forward of the task to Test / Prelay, the Fight has changed (see Step 2), you should roll changes from the battlefield (through the central repository) to Test / Prelay and change the changes.</i> <i><br></i>  <i>If GIT fails to merge branches independently (conflicts arise, for example, due to changes in the same files), you should manually resolve the conflicts.</i> <br>  <b>At the end of step ‚Üí return to Step 1.</b> <br><br><h4>  3.2.4 Nakat task update - Step 4 </h4><br><img src="https://habrastorage.org/files/0c1/014/c5b/0c1014c5b01943d0ab349d20954612db.jpg"><br> <code>cd /u-app/bitrix/Apache/htdocs/bitrix/</code> <br> <code>git pull origin TIKET_######</code> <br>  <i>We roll the update task to Fight from the central repository</i> <br><br><br><h3>  3.3 Committing daily changes (at the end of the day) </h3><br>  Unfortunately, despite the process described above, we are constantly having changes right in the fight due to 2 main reasons: <br><ul><li>  There are many content editors who have access to change files in the public part of the combat server (of course, with limited rights, without access to editing php code, but with the ability to change the html markup) </li><li>  There are tasks for the Daughters, which often affect the kernel / bitrix / (as a rule, templates and components appear or change) </li></ul><br>  Therefore, every day at the end of the working day (and as you remember from the beginning of the article after 17.50 Moscow, the Developer and I lose the opportunity to edit php on Boy), I summarize and commit all the edits made outside of my tasks. <br><div class="spoiler">  <b class="spoiler_title">Why not in the morning?</b> <div class="spoiler_text">  If for some reason I am forced to leave work early, then usually I just do it the next day before the work process begins (while the Developers are sleeping in their warm beds). <br>  However, this adds complexity, since Prelive and Prod are synchronized at night!  Those.  The unfixed changes in the morning will be not only in battle, but also on prewater! <br>  This means that you either have to abandon the deployment of tasks for pre-development during the day, or synchronize files using GIT: <br><ul><li>  Roll back the state of Prelaive to the last commit (see 3.4.1) </li><li>  Roll up the current status on Prelaive from GitLab (git pull, see 3.1.3) </li></ul><br></div></div><br>  The process is completely identical to the fixation of changes in combat (see 3.1.2): <br> <code>cd /u-app/bitrix/Apache/htdocs/bitrix/</code> <br> <code>git status</code> <br> <code>git add -A .</code> <br> <code>git commit -m 'Prod changes ##'</code> <br> <code>git push origin master</code> <br> <br><br><h3>  3.4 Roll back changes </h3><br><ol><li>  There are 3 types of situations when it is necessary to roll back changes (as the situation worsens): </li><li>  Rollback on Test / Prelive (it doesn‚Äôt matter if a mistake was made or the task was successfully checked - you need to ‚Äúfree up the site‚Äù, no edits on the Test / Prelaive are foreseen) </li><li>  Rollback to the Battle of a <b>minor</b> error that came through GIT (the keyword is insignificant. Version history is valuable for example for analysis in GitLab, but you need to return to the battle a stable version. It is practiced only for FRESH edits) </li><li>  Rollback of <b>critical</b> error to the Battle (situation from the series ‚Äú <i>Chief, everything is lost !!!! 1111one</i> ‚Äù, when the performance of the project is more critical than a beautiful story in GitLab) </li></ol><br><br><h4>  3.4.1 Test - Rollback to the last stable state </h4><br>  There is no work done on test servers with tasks to ‚Äúbring to mind‚Äù.  For this, developers have a Dev environment, we only come here to test before handing over to the Customer, which is why sterile conditions are more critical than history (this is why the hard flag, and exactly reset, not checkout or something else). <br> <code>git reset --hard HEAD</code> <br> <br>  <i>If you need to rollback not to 1 commit, then take the hash of a specific commit from GitLab and roll back to it:</i> <br> <code>git reset --hard #HASH# <br></code> <br><br><h4>  3.4.2 Fight - The inflated task introduces an error (came through GIT) </h4><br>  If the edit did not put the server and 100% came with the last commit, and was not made 2 months ago and was already assimilated, creating a dependency with some other task, then you can make a counter commit canceling the edit. <br>  The advantage is that you save the history of this edit in GitLab and the Developer (if you have access) can once again examine the commit and brainstorm.  And if the commit has already hit the master branch of GitLab there are no problems. <br>  If the edit was made right away in a battle (who's going to tear off their hands?), Then for this strategy you will have to first make a commit, which is clearly not rational. <br><br> <code>git revert HEAD <br></code> <br>  <i>Creates a counter commit that cancels changes from the last one.</i> <br><br><h4>  3.4.3 Fight - Edit broke the fight (completely) </h4><br>  If everything is very bad (the server is down, or it suddenly turned out that ‚Äúvery important functionality‚Äù was broken a long time ago, then there is nowhere to go: <br> <code>git reset --hard HEAD</code> <br> <br>  <i>If you need to rollback not to 1 commit, then take the hash of a specific commit from GitLab and roll back to it:</i> <br> <code>git reset --hard #HASH#</code> <br> <br>  If as a result of such a rollback it turns out that the destroyed commit has already got into the master branch on GitLab, then to restore order it is often easier to delete the entire repo on GitLab and re-create it.  =) <br><br><br><h2>  Conclusion </h2><br>  The scripts I have described are very simple.  This is their advantage and disadvantage at the same time. <br><ul><li>  <b>Advantage</b> - they allow even a novice GIT user to work with the version control system (tested on my boss for 2 weeks of my vacation) </li><li>  <b>The disadvantage</b> is that an experienced user sees some more flexible and interesting scenarios that are difficult to formalize as a set of simple rules of application.  That is why I recommend reading their <a href="https://git-scm.com/book/ru/">Pro Git</a> book after successfully mastering and implementing them. </li></ul><br>  However, even such a limited toolkit allows you to observe such wonderful pictures in GitLab: <br><br><img src="https://habrastorage.org/files/77b/e1b/e51/77be1be511624c049bd105035a50f87d.png"><br>  <i>Several commits are not named according to my rules - this is the result of the developer quickly setting up the functionality on the Test / Prelive server when the task is rolled up.</i>  <i>In such cases, I wrote TIKET _ ###### Patch _ ## (Ticket number and patch sequence number) in order to more easily identify to which task in the tracker this or that edit belongs.</i> <br><br><img src="https://habrastorage.org/files/b4e/f24/0fc/b4ef240fcc7e40bfbaa9ef707a3dd3be.png"><br>  <i>Some tasks are implemented directly by me, not by the Developer.</i>  <i>In this case, I call from Task and not Tiket and indicate the ID of the related task in another account system.</i> <br><br>  In fact, such branching and intersection is not at all good.  It looks cool, but in reality, each task postponed for a week or a month for testing creates hemorrhoids to the one who then all this will be merdzhit. <br>  It‚Äôs not that something broke (although there were conflicts a couple of times that the GIT couldn‚Äôt be corrected and I had to resolve them).  But makes you nervous. <br><br><br><div class="spoiler">  <b class="spoiler_title">FAQ</b> <div class="spoiler_text">  <b>Q:</b> Not too many branches work? <br>  <b>A:</b> As a rule, each server has only 1 branch - master.  Many branches exist only in the Central Repository (GitLab).  It is rarely necessary to download a separate branch from there (this scenario is not described, since it is not a model one due to its rarity).  Naturally unnecessary branches (whose commits have joined the master) have to be periodically cleaned.  I understand that it is very similar to SVN, but it works for us and helps a lot. <br><br>  <b>Q:</b> Not described merge.  How to do it? <br>  <b>A:</b> As a rule, merge is automatically executed by GIT.  In rare cases, conflict resolution is required.  In this case, you receive a notification that the automatic merge has failed. <br>  If at this moment to make git status, the list of files with conflicts will be received.  On them it is necessary to go through and resolve all conflicts (a special marker has allocated pieces of code from different commits). <br>  However, it is easier for us to avoid merge conflicts by organizational methods than to resolve them.  In any case, often this can only be done by an experienced programmer. <br>  Well, the <a href="https://git-scm.com/book/ru/v1/%25D0%2592%25D0%25B5%25D1%2582%25D0%25B2%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5-%25D0%25B2-Git-%25D0%259E%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B2%25D1%258B-%25D0%25B2%25D0%25B5%25D1%2582%25D0%25B2%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F-%25D0%25B8-%25D1%2581%25D0%25BB%25D0%25B8%25D1%258F%25D0%25BD%25D0%25B8%25D1%258F">chapter on merge in Pro Git is</a> very useful, if that. <br><br>  <b>Q:</b> Is it possible to remove the asterisks from the code samples and the filled places in the pictures? <br>  <b>A:</b> I apologize to the reader for this monstrous product of conspiracy. <br>  This is a minimal distortion of our actual instructions to which, for security reasons, the representative of the Customer agreed, coordinating the draft article. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/266573/">https://habr.com/ru/post/266573/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266563/index.html">Profit about the printer</a></li>
<li><a href="../266565/index.html">GPS service ViaLatM - scripting language (part 2)</a></li>
<li><a href="../266567/index.html">Expand the Ghost blog in InfoboxCloud</a></li>
<li><a href="../266569/index.html">Configuring a ZTE AD3700 CDMA Modem for Intertelecom on Linux</a></li>
<li><a href="../266571/index.html">Generating PDF files in a web project: wkhtmltopdf program</a></li>
<li><a href="../266575/index.html">How to create interactive maps</a></li>
<li><a href="../266577/index.html">Underground carders market. Translation of the book "KingPIN". Chapter 2. Deadly Weapons</a></li>
<li><a href="../266581/index.html">Published exploit code for critical Android vulnerabilities Stagefright</a></li>
<li><a href="../266583/index.html">It is finished! io.js + NodeJS = NodeJS 4.0.0</a></li>
<li><a href="../266585/index.html">Open Source Calendar for JIRA</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>