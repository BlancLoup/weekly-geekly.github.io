<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We expand automation in a couple of hours: PHPUnit, Selenium, Composer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! My name is Vitaliy Kotov, I work in Badoo, in the QA department. Most of the time I do test automation. Recently, I was faced with the task ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We expand automation in a couple of hours: PHPUnit, Selenium, Composer</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr!  My name is Vitaliy Kotov, I work in Badoo, in the QA department.  Most of the time I do test automation.  Recently, I was faced with the task of deploying Selenium tests as quickly as possible for one of our projects.  The condition was simple: the code should lie in a separate repository and not use the best practices of previous autotests.  Oh yes, and it was necessary to do without CI.  In this case, the tests should be run immediately after changing the project code.  The report was supposed to come in the mail. <br><br>  Actually, I decided to share the experience of such deployment.  It turned out a kind of guide "How to run tests in a couple of hours." <br><br>  Go! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/dx/yh/gv/dxyhgvadu2qcde-jywg9lm1eowi.jpeg"><br><a name="habracut"></a><br><h2>  Conditions of the problem </h2><br>  First of all, the task should be decomposed into several subtasks.  It turns out that our mission, if we take up its execution, is as follows: <br><br><ul><li>  need a separate repository; </li><li>  there must be tests; </li><li>  there must be a mechanism in it that will run tests to change the project code; </li><li>  The report should be readable, convenient and come to the mail to the specified people. </li></ul><br>  It seems everything is clear. <br><br><h2>  Stack </h2><br>  In Badoo, the first Selenium tests were written in PHP based on the <a href="https://github.com/sebastianbergmann/phpunit">PHPUnit</a> framework.  The Badoo server was mostly written in PHP, and by the time the automation appeared, it was decided not to produce technologies. <br><br>  At that time, a <a href="https://github.com/facebook/php-webdriver">framework from Facebook</a> was chosen to work with Selenium, but at some point we were so enthusiastic about adding our functionality there, so that our version is no longer compatible with them. <br><br>  Since the task was urgent, I decided not to experiment with technology.  Unless the Facebook version of the latest version was chosen - it was interesting that there was something new there. <br><br>  I downloaded the <a href="https://getcomposer.org/download/">composer</a> , with which it was more convenient for me to build such a project: <br><br><pre><code class="bash hljs">wget https://phar.phpunit.de/phpunit.phar</code> </pre> <br>  The composer.json file looked like this then: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"require-dev"</span></span>: { <span class="hljs-string"><span class="hljs-string">"phpunit/phpunit"</span></span>: <span class="hljs-string"><span class="hljs-string">"5.3.*"</span></span>, <span class="hljs-string"><span class="hljs-string">"facebook/webdriver"</span></span>: <span class="hljs-string"><span class="hljs-string">"dev-master"</span></span> } }</code> </pre><br><h2>  Class MyTestCase </h2><br>  The first thing to do is to write your TestCase class: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/../../vendor/autoload.php'</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyTestCase</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PHPUnit_Framework_TestCase</span></span></span></span></code> </pre><br>  It introduced the setUp and tearDown functions, which created and killed the Selenium session, and the onNotSuccessfulTest function, which processed the data of the fallen test: <br><br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> RemoteWebDriver $driver */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $driver; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tearDown</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onNotSuccessfulTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($e)</span></span></span><span class="hljs-function"> </span></span>{}</code> </pre><br>  Everything in setUp is quite simple: we create a session by specifying the URL of the Selenium farm and the desired capabilities.  At this stage, I was only interested in the browser on which we were going to drive the tests. <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;driver = RemoteWebDriver::create( <span class="hljs-string"><span class="hljs-string">'http://selenium-farm:5555/wd/hub'</span></span>, [WebDriverCapabilityType::BROWSER_NAME =&gt; WebDriverBrowserType::FIREFOX] ); }</code> </pre><br>  C tearDown is a bit trickier. <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tearDown</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;driver) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_prepareDataOnFailure(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;driver-&gt;quit(); } }</code> </pre><br>  The bottom line is this.  For a dropped test, tearDown is performed before onNotSuccessfulTest is executed.  Therefore, if we want to close the session in tearDown, all the necessary data from it should be obtained in advance: the current location, screenshot, and HTML snapshot, cookie values, and so on.  All these data will be required by us for the formation of a beautiful and understandable report. <br><br>  Collect data, respectively, should only be for dropped tests, remembering that tearDown will be called for all tests, including successfully passed, skipped and incomplete. <br><br>  You can do it something like this: <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_prepareDataOnFailure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $error_and_failure_statuses = [ PHPUnit_Runner_BaseTestRunner::STATUS_ERROR, PHPUnit_Runner_BaseTestRunner::STATUS_FAILURE ]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (in_array(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getStatus(), $error_and_failure_statuses)) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data[<span class="hljs-string"><span class="hljs-string">'url'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;driver-&gt;getCurrentURL(); $ArtifactsHelper = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArtifactsHelper(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;driver); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data[<span class="hljs-string"><span class="hljs-string">'screenshot'</span></span>] = $ArtifactsHelper-&gt;takeLocalScreenshot(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;current_test_name); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data[<span class="hljs-string"><span class="hljs-string">'source'</span></span>] = $ArtifactsHelper-&gt;takeLocalSource(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;current_test_name); } }</code> </pre><br>  The class ArtifactsHelper, as you might guess from the name, helps to collect artifacts.  But about him a little later.  :) <br><br>  In the meantime, back to tearDown.  In it, we have already collected all the necessary data for the fallen test, so that you can safely close the session. <br><br>  This is followed by onNotSuccessfulTest, where we will need <a href="http://php.net/manual/ru/class.reflectionclass.php">ReflectionClass</a> .  It looks like this: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onNotSuccessfulTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($e)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//prepare message $message = $this-&gt;_prepareCuteErrorMessage($e-&gt;getMessage()); //set message $class = new \ReflectionClass(get_class($e)); $property = $class-&gt;getProperty('message'); $property-&gt;setAccessible(true); $property-&gt;setValue($e, PHP_EOL . $message); parent::onNotSuccessfulTest($e); }</span></span></code> </pre><br>  In the exception message, we add all the information that we collected before closing the session.  So it will be much more convenient for us to understand the reason for the drop in tests. <br><br><h2>  Class ArtifactsHelper </h2><br>  The class is pretty simple, so I‚Äôll talk about it very briefly.  It creates files that are called as a dropped test plus a timestamp, and puts them in the appropriate daddy.  After running all the tests, the files are added to the final email with a report and deleted.  This case looks like this: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArtifactsHelper</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ARTIFACTS_FOLDER_PATH = <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/../artifacts/'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> RemoteWebDriver */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $driver; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RemoteWebDriver $driver)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_dir(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ARTIFACTS_FOLDER_PATH)) { mkdir(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ARTIFACTS_FOLDER_PATH); } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;driver = $driver; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">takeLocalScreenshot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;driver) { $name = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::_escapeFileName($name) . time() . <span class="hljs-string"><span class="hljs-string">'.png'</span></span>; $path = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ARTIFACTS_FOLDER_PATH . $name; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;driver-&gt;takeScreenshot($path); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $path; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">takeLocalSource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;driver) { $name = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::_escapeFileName($name) . time() . <span class="hljs-string"><span class="hljs-string">'.html'</span></span>; $path = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ARTIFACTS_FOLDER_PATH . $name; $html = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;driver-&gt;getPageSource(); file_put_contents($path, $html); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $path; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_escapeFileName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($file_name)</span></span></span><span class="hljs-function"> </span></span>{ $file_name = str_replace( [<span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'#'</span></span>, <span class="hljs-string"><span class="hljs-string">'/'</span></span>, <span class="hljs-string"><span class="hljs-string">'\\'</span></span>, <span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">':'</span></span>, <span class="hljs-string"><span class="hljs-string">'?'</span></span>, <span class="hljs-string"><span class="hljs-string">'='</span></span>, <span class="hljs-string"><span class="hljs-string">'"'</span></span>, <span class="hljs-string"><span class="hljs-string">"'"</span></span>, <span class="hljs-string"><span class="hljs-string">":"</span></span>], [<span class="hljs-string"><span class="hljs-string">'_'</span></span>, <span class="hljs-string"><span class="hljs-string">'No'</span></span>, <span class="hljs-string"><span class="hljs-string">'_'</span></span>, <span class="hljs-string"><span class="hljs-string">'_'</span></span>, <span class="hljs-string"><span class="hljs-string">'_'</span></span>, <span class="hljs-string"><span class="hljs-string">'_'</span></span>, <span class="hljs-string"><span class="hljs-string">'_'</span></span>, <span class="hljs-string"><span class="hljs-string">'_'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'_'</span></span>], $file_name ); $file_name = mb_strtolower($file_name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $file_name; } }</code> </pre><br>  In the constructor, we create the desired directory, if not, and bind the driver to the local field, so that it is more convenient to use it. <br><br>  The takeLocalScreenshot and takeLocalSource methods create files with a screenshot (.png) and an HTML snapshot (.html).  They will be called the test name, but we will replace some of the characters with others, so that the file name does not confuse the file system. <br><br><h2>  Tests </h2><br>  Tests will be inherited from MyTestCase.  I will not give examples - everything is standard.  Through $ this-&gt; driver we work with Selenium, and all assertions and so on are executed through $ this. <br><br>  It is worth saying a few words about passing parameters for running tests.  PHPUnit will not add an unknown parameter to it when the test is run from the console.  And it would be very convenient, for example, to be able to set the desired browser for tests. <br><br>  I solved this problem in the following way: I created a bin / daddy in the project root, where I put an executable file called phpunit with the following content: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#!/local/php/bin/php &lt;?php require_once __DIR__ . '/../vendor/autoload.php'; require_once __DIR__ . '/../lib/MyCommand.php'; MyCommand::main();</span></span></code> </pre><br>  And in the MyCommand class, respectively, I registered the desired parameters: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyCommand</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PHPUnit_TextUI_Command</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleArguments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $argv)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;longOptions[<span class="hljs-string"><span class="hljs-string">'platform='</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;longOptions[<span class="hljs-string"><span class="hljs-string">'browser='</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;longOptions[<span class="hljs-string"><span class="hljs-string">'local'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;longOptions[<span class="hljs-string"><span class="hljs-string">'proxy='</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;longOptions[<span class="hljs-string"><span class="hljs-string">'send-report'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::handleArguments($argv); } }</code> </pre><br>  Now, if we run tests from our phpunit file, we can set parameters that will be passed to tests in the $ GLOBALS ['argv'] array.  Then you can parse it and somehow handle it. <br><br><h2>  Run to change the project code </h2><br>  So, now we have everything to start running tests on the trigger.  Unfortunately, we do not have a repository with the project code, so it is not possible to find out when the changes were made in it.  Without the help of developers here is not enough. <br><br>  We agreed that in the test environment the application will have a special address where you can see the last commit hash (in fact, the version of the site). <br><br>  Then everything is simple: by cron, we launch a special script script every couple of minutes.  When you first start it goes with <a href="http://php.net/manual/ru/book.curl.php">Curl</a> to this address and gets the current version of the site.  Then he creates in the special directory the file version.file, where he writes this version.  The next time he gets the version from the site and from the file;  if they are different, write the new version to the file and run the tests. If not, it does nothing. <br><br>  In the end, it looks like this: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isVersionChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($domain)</span></span></span><span class="hljs-function"> </span></span>{ $url = $domain . <span class="hljs-string"><span class="hljs-string">'version'</span></span>; $ch = curl_init(); curl_setopt($ch, CURLOPT_URL, $url); curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($proxy = SeleniumConfig::getInstance()-&gt;getProxy()) { curl_setopt($ch, CURLOPT_PROXY, $proxy); } $response = curl_exec($ch); curl_close($ch); $version_from_site = trim($response); $version_from_file = file_get_contents(VERSION_FILE); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ($version_from_site != $version_from_file); }</code> </pre><br><h2>  Sending a letter with a report </h2><br>  Unfortunately, in PHPUnit from the TestCase class it is impossible to determine whether the last test was in the suite or not.  Of course, there is a method tearDownAfterClass, but it is executed after the completion of tests in one class.  If, for example, two classes with tests are specified in the suite, tearDownAfterClass will be executed twice. <br><br>  I also needed to register the logic somewhere, which will send a letter guaranteed after passing all the tests.  And, of course, do it only once.  As you may have guessed, I wrote another helper.  :) <br><br><h2>  Class mailer </h2><br>  This class stores information about past tests: error texts, paths to a file with a screenshot and an HTML snapshot.  It is made on the principle of Singleton, instantiated once at the first call.  And not forcibly destroyed.  Do you understand what I am doing?  :) <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__destruct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;send_email) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sendReport(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;tests_failed, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;tests_count); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendReport</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $report, $tests_count)</span></span></span><span class="hljs-function"> </span></span>{ $count = count($report); $is_success_run = $count == <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// start message if ($is_success_run) { $message = "All tests run successfully! Total amount: {$tests_count}."; $subject = self::REPORT_SUBJECT_SUCCESS; } else { $message = "Autotests failed for project. Failed amount: {$count}, total amount: {$tests_count}."; $subject = self::REPORT_SUBJECT_FAILURE; } $message .= PHP_EOL; $start_version = VersionStorage::getInstance()-&gt;getStartVersion(); $finish_version = VersionStorage::getInstance()-&gt;getFinishVersion(); if ($start_version == $finish_version) { $message .= 'Application version: ' . $start_version . PHP_EOL; foreach ($report as $testname =&gt; $text) { $message .= PHP_EOL . $testname . PHP_EOL . trim($text) . PHP_EOL; } } else { $message .= PHP_EOL; $message .= "***APPLICATION VERSION HAS BEEN CHANGED***" . PHP_EOL; $message .= "Version on start: {$start_version}" . PHP_EOL; $message .= "Current version: {$finish_version}" . PHP_EOL; $message .= "TESTS WILL BE RE-LAUNCHED IN FEW MINUTES."; $subject = self::REPORT_SUBJECT_FAILURE; } // end message foreach (self::$report_recipients as $email_to) { $this-&gt;_sendMail($email_to, self::EMAIL_FROM, $subject, $message); }</span></span></code> </pre><br>  That's right, the logic of sending a letter I added to the destructor.  When the test run process completes, the garbage collector arrives and destroys my class.  Therefore, the destructor is triggered at the very last moment. <br><br>  Depending on whether the tests passed successfully or not, the title of the letter changes.  If the site version has changed during the run, the tests are run again. <br><br><h2>  Autopool Test </h2><br>  And finally, a bit of convenience.  Since the whole system will live somewhere on a remote server, it would be convenient if she could do git pull herself, so as not to forget to freeze important changes in the tests. <br><br>  To do this, create an executable file with the following content: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /usr/bin/env bash cd `dirname "$0"` output=$(git -c gc.auto=0 pull -q origin master 2&gt;&amp;1) if [ ! $? -eq 0 ]; then echo "${output}" | mail -s "Failed to update selenium repo on selenium-server" username@corp.badoo.com fi</span></span></code> </pre><br>  The script will execute the git pull command, and if something goes wrong and it fails, it will write a letter to the responsible employee. <br><br>  Then we add the script to cron, running every couple of minutes, and the trick is in the hat. <br><br><h2>  Results </h2><br>  The results are usually summed up with an eye on the original task.  Here is what we get: <br><br><ul><li>  a separate repository has appeared; </li><li>  there with the help of composer we compiled a project: downloaded PHPUnit and the Facebook framework; </li><li>  wrote their TestCase-class, which is able to generate convenient reports; </li><li>  wrote tests that can be run in different browsers and with different parameters; </li><li>  created a mechanism that will run these tests when changing the version of the test project; </li><li>  took care of sending a letter with a report and screenshots; </li><li>  added a script that automatically updates this whole thing to the required version. </li></ul><br>  It seems nothing is missed. <br><br>  Such is the story.  Thanks for attention!  I will be glad to hear your stories, write in the comments.  :) </div><p>Source: <a href="https://habr.com/ru/post/349098/">https://habr.com/ru/post/349098/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../349088/index.html">Avito Quiz: Golang</a></li>
<li><a href="../349090/index.html">About the lost stages of cybersecurity</a></li>
<li><a href="../349092/index.html">WIP: Product Design</a></li>
<li><a href="../349094/index.html">Multitasking or marijuana?</a></li>
<li><a href="../349096/index.html">SignalR Core. "Hello Habr!"</a></li>
<li><a href="../349100/index.html">Digest news from the world of PostgreSQL. Issue number 3</a></li>
<li><a href="../349102/index.html">Immersion in Android services</a></li>
<li><a href="../349104/index.html">Who killed the junior?</a></li>
<li><a href="../349106/index.html">What is a programmer?</a></li>
<li><a href="../349110/index.html">From MS SharePoint to Bitrix24: One Way Ticket</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>