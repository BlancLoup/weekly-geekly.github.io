<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bot playing in Castlevania</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What is it 
 CastlevaniaBot is a plugin for the NES Nintaco emulator that plays Castlevania. If you run it on the splash screen, the plugin will go th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bot playing in Castlevania</h1><div class="post__text post__text-html js-mediator-article"><h1>  What is it </h1><br>  CastlevaniaBot is a plugin for <a href="https://nintaco.com/">the NES Nintaco emulator</a> that plays Castlevania.  If you run it on the splash screen, the plugin will go through the whole game from start to finish.  Or you can run it anywhere in the game so that it passes its part. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/UrtgTGmv1GQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  In this article, I will tell you how I created a bot capable of passing Castlevania, and how you can create something similar for any game on the NES. <br><a name="habracut"></a><br><hr><br><h1>  Knowledge based structure </h1><br>  This project did not use machine learning.  Rather, the development can be called "learning the machine."  I know how to go Castlevania.  The difficulty was to write my knowledge into a computer program.  The result was a system that simulates the same decision-making process that I carry out with the controller in my hands.  To create it, it was necessary to clearly state the detailed details of the physics that control the bit world of Simon Belmont, and all the tactics needed by an experienced vampire hunter. <br><br>  CastlevaniaBot has access to a set of strategies to cope with a wide range of situations.  Most of them are designed to work with a specific type of game objects.  For example, there is a strategy to fight the skeletons, another one for fish people, for breaking candles, for gathering hearts, and so on. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      CastlevaniaBot constantly monitors the state of the game and, if necessary, switches between different strategies.  The decision-making process uses the fitness function, which ranks all the game objects on the screen.  At the top of the list is the main goal, and when it changes, the bot changes its strategy.  For example, CastlevaniaBot may be preparing to hit candles when a bat flies into the frame.  Depending on the distance to the bat, CastlevaniaBot can react by switching from the candle strategy to the bat strategy.  Having destroyed the bat, he will continue to work with the candles. <br><br>  Before making a decision on switching, CastlevaniaBot considers the current goal and strategy.  If he does not succeed, he can get stuck in an infinite loop, switching back and forth between two targets with equal or nearly equal priority.  To avoid this, when a new primary goal appears, which is only slightly higher in priority to the current goal, CastlevaniaBot may decide to continue the current strategy. <br><br>  Some strategies automatically run when they hit a specific area.  Usually they are intended for simultaneous processing of several game objects.  For example, in the corridor with a bunch of flying jellyfish heads, it's best to just go ahead and not aim at each head individually. <br><br>  Some strategies may vary depending on the current secondary weapons and the number of hearts collected, in particular, in battles with bosses.  CastlevaniaBot is trying to make the best decision based on the tools it has and the current situation. <br><br><hr><br><h1>  Making a plan for an 8-bit world </h1><br>  When working on such projects, I primarily strive to simplify the task.  I imagined what Castlevania would look like if there were no enemies, candles and collected items on the levels.  All that would be needed in that case is simply to go from the beginning to the end of the level.  I wondered if I could teach a bot to do it, how difficult would it be to destroy several enemies along the way? <br><br>  To teach the bot to move, I needed tile maps of backgrounds and an understanding of how levels are organized.  The game consists of six levels, each of which ends with a boss. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/09b/644/665/09b644665551ebb424b3813af0205173.png"></div><br>  Each level is divided into 3 or 4 stages.  The stages are usually separated by wooden doors, which creak open and slam behind the player‚Äôs back. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/207/5fb/a46/2075fba46c9ef8ccd9a496df6aadcf07.png"></div><br>  Doors are control points (checkpoints).  If a player is killed, he returns to the beginning of the stage, but only if he has not ended his life.  If you continue the game after Game Over, the player is sent to the very beginning of the level. <br><br>  The stage number indicates the total number of checkpoints completed since the beginning of the game.  The last stage is number 18. But if you kill Dracula, the game starts from the very beginning in Difficult Mode, and the numbers of the stages continue to increase to 19 and further.  If you go through the Difficult Mode, the third cycle of the game does not become more difficult, but the numbers of the stages still continue to increase. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/447/6a5/3c5/4476a53c571dc062a4bc2287f5e02587.png"></div><br>  Each stage consists of one or more background bands with horizontal scrolling, which I call ‚Äúsub-steps.‚Äù  If you go beyond the screen on the stairs leading up or down, the game moves from one sub-step to another, rather than scrolling vertically. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/760/751/5d8/7607515d8da99df95877d7eef8214f3f.png"></div><br>  The game uses 3 bytes to track the game cycle number, stage number and substage number.  The game loop in normal mode (Normal Mode) is set to 0;  values ‚Äã‚Äãof 1 and above indicate Difficult Mode.  Regardless of the game cycle, the stages always have a numbering from 0 to 18. And the sub-stages always have the value 0 or 1, because the stages never contain more than 2 horizontal stripes.  CastlevaniaBot tracks these bytes to know where it is. <br><br>  For my convenience, I recorded the background strip of each sub-step in a separate graphic file.  If I needed to find out the exact coordinates of some object, then I could quickly find them out using a graphical editor.  I recorded the files using the Nintaco‚Äôs built-in Map Maker tool.  I turned it on, and then went through the whole game.  Some of the resulting images contained several sub-steps joined together that were easy to break apart. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a53/3de/57e/a533de57e49c26f55eea024465dd3cf6.png" alt="Nintaco's Map Maker"></div><br>  Having studied the images of the backgrounds, I realized that the only important tiles are platforms and stairs.  Everything else can be considered empty space.  Ladders are of two types: leading forward or backward (they can be represented as the left and right edge of an isosceles triangle).  Sometimes the stairs end with a platform on which a player can walk. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c6e/6fa/76b/c6e6fa76bcd6d6c3457060763eb6f993.png"></div><br>  There are only 5 important types of tiles, and at each level they have a different appearance.  I copied and pasted them into separate graphic files of size 16 √ó 16.  Then I wrote a program that compares each tile in each sub-step with a corresponding set of images.  So I got a matrix of types of tiles for all sub-steps. <br><br>  The matrices could be extracted directly from the ROM, but I could not find the documentation on how and where the data is stored.  Since the ROM space is limited, these levels are usually compressed, resembling a vector graphics format.  Each game uses its own format, so I did not consider it necessary to conduct research, because I had Map Maker.  In addition, I still needed graphic images of sub-steps.  If I had not captured the background bands, then I would have to write a program that generates images from the matrices. <br><br><hr><br><h1>  Search for ways </h1><br>  Having created the matrices, I wanted to apply a pathfinding algorithm, namely <a href="https://en.wikipedia.org/wiki/Floyd%25E2%2580%2593Warshall_algorithm">the Floyd-Warshell algorithm</a> , which yields a table containing the shortest paths between each of the vertex pairs of the oriented graph with weighted edges.  The idea was to pre-compute the tables and write them into files, and then load them during the execution of the game.  With tables in memory, a bot can search and instantly recognize the shortest path between any two platform tiles. <br><br>  The graph consists of edges and vertices.  If platform tiles are vertices, then edges are only those operations that Simon can perform to move from one platform to another.  Operations performed within one tile are prohibited.  For example, on a plane from tiles, Simon can move only one tile to the left or one tile to the right. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fe2/fa3/03d/fe2fa303d199d5c1cb826da8003acd3a.png"></div><br>  Similarly, if Simon is on the stairs, he can move one tile in one of two possible directions. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a68/f17/502/a68f175026f789811cf3c7b032f76898.png"></div><br>  These are valid operations.  But such actions as moving from the middle point of a tile to the edge of a tile are too fractional, because they do not correspond to the transition from one vertex of the graph to another. <br><br>  In addition to walking left-right, descending-raising the stairs, Simon can jump to another tile.  And he can jump left or right, starting from any of the 16 pixels of the tile surface.  To reduce the number of edges in the graph (and the size of the lookup table), I considered only five possible points of repulsion: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/012/37d/aab/01237daabc08e79e6ccd6de83b6a1c0e.png"></div><br>  Adding the ‚Äúdo nothing‚Äù operation, I received 15 operations.  All of them are simple enough so that the bot can easily determine the sequence of keystrokes needed to execute them during the execution of the game. <br><br>  To build a complete graph, I created a very simple simulation of Simon‚Äôs physics of the world.  In this simulation, all 15 operations are performed starting with each platform tile.  The graph is built by simply observing where Simon will be.  More specifically, when specifying the initial coordinates and operations, the simulation gives the final coordinates at the output.  If there are no end coordinates, for example, when Simon tries to go into a wall or into a pit, then the program returns that the operation is invalid and this edge is not part of the graph. <br><br>  To create this simulation it took careful study of Simon Belmont.  Unlike other classic platformers, where the player can accelerate from walking to running, Simon, when moving horizontally, always moves exactly 1 pixel per frame.  This is true for walking, jumping, climbing stairs and even when throwing back when attacking enemies. <br><br>  Limiting the horizontal speed greatly simplifies the recognition of barriers.  The game checks if there is a wall in one pixel in front of the character, and if necessary, stops the movement.  The check is performed below head level, which allows the head to pass under low ceilings without interfering with horizontal movement. <br><br>  With vertical movement, things are a little more complicated.  If Simon comes off the edge of the platform, instead of gradually accelerating, he instantly falls down at a speed of 8 pixels per frame.  Since each tile has a height of 16 pixels (which is a multiple of 8), ground recognition is simplified.  At the same time, the player maintains a horizontal speed of 1 pixel per frame in the direction immediately before the fall. <br><br>  Simon's sprite width is 16 pixels, and nevertheless, it can hang over a block a maximum of ¬± 4 pixels from its midpoint.  If you move a little more, it will fall below. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fd8/b2a/0a4/fd8b2a0a48035271fc78e7209d980dd5.png"></div><br>  Interestingly, if it goes off the platform and drops exactly 1 tile at a speed of 1 horizontal and 8 vertical pixels per frame, it will not exactly stand on the block when landing.  One of his legs will remain inside the wall at a depth of 2 pixels. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/da0/a27/458/da0a274588a45b4e448fbe46ef9e48ca.png"></div><br>  After that, he will be able to get out of the wall, but not go into it. <br><br>  During the jump, Simon cannot change his direction.  After pressing the button A, he makes a fixed path along a parabola. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/041/db3/a4a/041db3a4afa0f0f93e0533f0ee1dbd48.png"></div><br>  At the top point, Simon rises 36 pixels, which allows him to jump onto platforms with a height of 2 tiles.  And the top of the ‚Äúparabola‚Äù is surprisingly flat.  It seems that it hangs in space for 9 full frames, perhaps in order to simplify blows with a whip in the air.  If Simon has nothing to land on, then the parabola continues until he returns to the original height.  After that, it begins to fall at a speed of 8 pixels per frame, that is, with the same constant speed of falling from the platform. <br><br>  When there is a platform directly above the character‚Äôs head, no jumps are allowed. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e06/358/0ba/e063580bac81a0ec963336e2886c0e2a.png"></div><br>  Otherwise, it partially ‚Äújumps‚Äù into platform tiles. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/651/56a/f41/65156af41893e3c9008a4836d67efca1.png"></div><br>  As mentioned earlier, if Simon touches more than the top of the head, he stops moving horizontally.  This is quite annoying at the end of the first stage of level 4, when the player tries to get out of the cave. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1c6/d41/331/1c6d413312f17f67d6247f9a33000499.png"></div><br>  Ladders allow you to freely move vertically between platforms. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/05c/5e1/2fc/05c5e12fc0bd66681054052354e13a14.png"></div><br>  In one case, Simon climbs the stairs, passing through the platform tile.  Being on the stairs, he can freely pass through the wall. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/522/872/438/5228724383d3d908b5298c62dc73e015.png"></div><br>  On level 4 mobile platforms, a player usually ducks under low-hanging stalactites.  However, you can climb and rest on them.  In such a situation, the game restricts horizontal movement, quickly dragging Simon into a water trap. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/feb/dcd/85f/febdcd85f8f47c08806d00343a74fc02.png"></div><br>  A physics simulator that generates directed graphs considers Simon to be a rectangle.  The movement of this rectangle is limited by the movement rules described above.  So that the bot did not jump from place to place like a rabbit, the ribs of the count's jumps were assigned a higher cost than the edges of walking and walking along stairs. <br><br>  The table generated by the pathfinding algorithm contains the shortest distance for each initial and final tile (total cost of the path) and a description of the first step of the path.  This description includes the first operation that must be performed on this path, and the tile on which the character will be after its execution.  The entire path can be recreated by re-searching the table, each of which gives a subsequent step in the direction of the final tile. <br><br>  In some sub-steps, the graphs are not fully connected.  For example, at level 4, the only way to cross the chasms are platforms.  In such sub-steps, the table contains ways to move around each of the islands, but not between them. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e0f/098/f72/e0f098f72ffb3a91bb86d2cf5fa1921b.png"></div><br>  Some destructible blocks contain hidden objects.  And the destruction of blocks changes this graph.  To circumvent this problem, an algorithm for finding paths with and without breakable blocks was applied to the substeps.  At runtime, CastlevaniaBot monitors the states of the blocks being split and uses the appropriate lookup table. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/aca/ac4/8a1/acaac48a1c7f4acd0849f06dab3a9d0a.png"></div><br><hr><br><h1>  Game state </h1><br>  CastlevaniaBot integrates into Nintaco through <a href="https://nintaco.com/api.html">its API</a> .  It registers an implementation of the <a href="https://nintaco.com/javadoc/index.html"><code>FrameListener</code></a> to receive a return on each frame.  Since the emulator runs at about 60 frames per second, this listener must be returned on time;  lengthy calculations or downtime will slow down or block the emulator.  In a short period of time, CastlevaniaBot reads the state of the game, determines its main goal, switches strategies if the goal has changed and executes the current strategy. <br><br>  CastlevaniaBot reads the current state of Simon Belmont directly from the processor's RAM.  But I can not determine how other game objects are represented in memory.  Therefore, CastlevaniaBot reads directly from the memory object attributes (Object Attribute Memory, OAM) - the area that stores the list of displayed sprites. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/296/b58/46a/296b5846a26530aa657294d619e5ad63.png"></div><br>  This technique works and is generally applicable to other games, but has many drawbacks.  The order of sprites in OAM is constantly changing.  If there are several instances of the same type of enemy on the screen at the same time, then the only way to track them is to determine their proximity, to compare the last coordinates of the sprite with the coordinates from the previous frame. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/46d/236/258/46d23625808baf3abb91916e4f80baed.png"></div><br>  Some game objects consist of repetitive sprites, such as bone towers. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1b7/49a/dcb/1b749adcb05680e5a22247c783d8bac2.png"></div><br>  Mobile platforms consist of one sprite repeated 4 times. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7e0/f85/ea8/7e0f85ea889b5e824a010d04e26f03d2.png"></div><br>  To sort both of these cases, additional logic is required, which is easy to implement.  Secondary weapon upgrades and some types of secondary weapons use the same sprites.  Worse, at level 5, the knights borrow the sprites of Simon's secondary weapon. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/44c/cd1/08e/44ccd108ea9b25c442a5653d79f0c49e.png"></div><br>  Fortunately, with the exception of holy water, CastlevaniaBot uses secondary weapons only where upgrades are usually not available, for example, in boss fights.  And the sprite upgrade of holy water is different from the sprite used when throwing it. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/014/1d2/faf/0141d2faf5e0168ae8d4046cdbfbe278.png"></div><br>  Some game objects blink when they are created, such as crystal balls at the end of boss fights, Death Scythe and Dracula‚Äôs body.  Flashing sprites appear and disappear from OAM, so additional logic is required to track these objects. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b80/5f1/f8b/b805f1f8bf89efb9c021b716a0d39e25.png"></div><br>  It is also worth noting that due to hardware limitations, NES can only display 8 sprites per raster line.  Since the priority of sprites depends in part on their indexes in OAM, the order in each frame is randomly shuffled to avoid a shift that makes one sprite invisible all the time.  Several sprites blink in turn, gradually changing their priority.  This blinking does not affect the reading of OAM sprites.  The data still remains there, but the emulated hardware does not display it.  This is different from the situation described above with sprites flashing when created.  In addition, Nintaco has an option that significantly reduces hardware blinking. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6b9/527/fe6/6b9527fe61e614012f1fd50d1ad0625e.png"></div><br>  Finally, a small portion of the game state is read from the PPU name tables ‚Äî a memory area containing all the background data.  This includes checking destructible blocks and tracking the positions of the ‚Äúcrush‚Äù level 2. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d35/f3c/378/d35f3c378b284474c8d2b5386a78fb57.png"></div><br><hr><br><h1>  Heuristic state machines </h1><br>  Strategies are state machines.  CastlevaniaBot defines them as an abstract class with the <code>init</code> and <code>step</code> methods.  The <code>init</code> method is called when CastlevaniaBot switches to the appropriate strategy, allowing the state machine to reset to its original state.  And the <code>step</code> method executes the strategy.  For example, the <code>step</code> strategy method for people-fishes checks whether a person-fish is within the range of a whip strike, and if so, the bot hits the whip.  Otherwise, it checks whether it is possible to reach the strike distance with a jump, and if so, the bot jumps.  And finally, if the bot is too close to the enemy, it moves away from him.  With these simple rules, CastlevaniaBot defeats people-fishes. <br><br>  To make writing strategies as simple as possible, I created a library of possible actions to be performed.  For example, instead of pressing and releasing the A button for a jump, the bot simply calls the jump method from the library.  And before that, he asks the library whether Simon is on the platform and can jump. <br><br>  Approximation and removal from the target are standard actions performed using operations from the table created by the pathfinding algorithm.  For example, the candlestick strategy uses the library's <code>routeAndFace</code> method, which not only sends Simon to some specified coordinates, but also turns him to the left or right after hitting them.  In addition, depending on the height of the candles, the strategy performs a jump or a squat before a blow with a whip.  The object falling out of the candles will be created in the air and will fall or slowly fall to the ground.  The elevation strategy directs Simon to the nearest tile directly below him, before the object touches the ground. <br><br>  To move away from enemies, the library needs to know how to move left or right without falling into the pits.  In general, this is done by searching for paths to the left or right edges of the sub-step.  But in some areas the shortest path to the left edge initially requires moving to the right, and vice versa.  When similar problems arose, I added logic specifically for the substeps, directing Simon to the left and right edges of the current platform. <br><br><hr><br><h1>  Passage </h1><br>  In this section, I will describe in detail the strategies used by CastlevaniaBot, commenting on the entire walkthrough. <br><br>  The game begins in the courtyard in front of the castle.  The objects in the frame are ranked to select the main target, which in this case is a column with a flame.  The strategy for working with columns orders the bot to approach the column and use the whip when it is within reach. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/14c/647/750/14c6477507cee1d822e6cadbcafbda5a.png"></div><br>  After hitting the whip and destroying the column, an item is created.  The priority of all items is higher than that of columns with a flame.  Therefore, CastlevaniaBot responds to this using the collection strategy of the item that has appeared, before moving on to the subsequent columns. <br><br>  When ranking objects, CastlevaniaBot always takes into account a long-term goal - passing a level before time runs out.  When creating a list of potential targets, the door to the next level is always added to it.  Doors are assigned a low priority, but after the destruction of all columns and the collection of all items, it becomes a priority.  With only one exception: CastlevaniaBot knows how to uncover all the hidden treasures, and jumps over the entrance to the castle to create a flashing bag of money. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/200/7f5/eaa/2007f5eaa4405bd611bd8711017fbe24.png"></div><br>  After entering the castle CastlevaniaBot sees ghosts and candles.  Candles and created items have a higher priority until the ghosts get closer. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8a7/9ab/843/8a79ab84345e6a16a9231c5a7f45ceae.png"></div><br>  It often seems that a whip destroys enemies without touching them.  I found in the ROM of the game a table of collision rectangles, so CastlevaniaBot knows for sure when something is within the range of the whip.  And since collision rectangles are often slightly protruded beyond sprite boundaries, the whip can strike an ‚Äúinvisible part.‚Äù <br><br>  In most cases, when destroying candles, CastlevaniaBot jumps vertically, not forward.  This is a risk avoidance tactic.  Since it is impossible to change the direction of movement while in the air, a crowd of approaching enemies may make it difficult to land safely or make it impossible.  In addition, with a vertical jump, CastlevaniaBot remains on the same block;  he does not need to check whether the jump will lead to a fall on the lower platform or the bottom of the pit. <br><br>  When there are no candles being destroyed or objects collected, CastlevaniaBot begins to haunt the ghosts.  But the "strategy of the panther" orders him to stand still, waiting for the enemy to fall within the limits of the blow of the whip. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/434/9a0/bd5/4349a0bd58a7078c6b0d1951845bfea2.png"></div><br>  Besides the fact that candles serve as sources of hearts and other objects, they guide the player along the way through the stage.  For example, in the image below, the candle in the upper right corner ‚Äúinvites‚Äù the player to climb the stairs.  However, in order to climb up the stairs, the player initially needs to pass to the left, because of which the candles disappear from the screen.  Since CastlevaniaBot solutions are based on prioritizing the items visible on the screen, this situation can lead to an infinite loop where the bot alternately chooses the shortest path to the candles (left) or the shortest path to the exit door (to the right). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/309/d1a/8e7/309d1a8e7f1f5a39a8b34411108b94b8.png"></div><br>  Similar problems can be solved in several ways.  For example, CastlevaniaBot can be equipped with memorization of objects, understanding that objects continue to exist, even if they are not visible.  But for this, they still need to be initially seen.  If the candles were even more to the right, then after their discovery one would have to go back even further. <br><br>  With this in mind, I added incentives pushing CastlevaniaBot to research areas of the stage that he would normally ignore.  These incentives work similarly to exit doors, attracting CastlevaniaBot to where it needs to go.  In addition, I added rules that cause him to ignore candles and objects that are too far away (by distance, and not in a straight line). <br><br>  After raising the stairs and destroying the candles, holy water is created - the most valuable of all secondary weapons.  CastlevaniaBot chooses him by exchanging a dagger for him. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4c5/575/00a/4c557500adad3a899c43ea80b983d6fb.png"></div><br>  As in the case of a money bag at the beginning of the game, CastlevaniaBot knows about all destructible blocks with hidden objects, and he uses a strategy similar to that for candles to destroy blocks with a whip. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1eb/007/d43/1eb007d4384996127451979738a3c6ea.png"></div><br>  Upon further movement of CastlevaniaBot, you will notice that it begins to use holy water to destroy ghosts and candles.  This may seem redundant, but serves an important purpose.  Castlevania rewards players for using double and triple secondary weapons.  In other words, CastlevaniaBot <a href="https://en.wikipedia.org/wiki/Grinding_(gaming)">grindite</a> upgrades of secondary weapons. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6a7/186/be0/6a7186be0588f46012a241cc9745d586.png"></div><br>  After pressing button B, there is a delay of 16 frames before hitting the whip.  The whip remains long for an additional 10 frames, but is valid only in the first of these ten.  CastlevaniaBot uses this fact to improve aiming.  In particular, it tracks the speed of all objects in the frame, assuming that the main goal will continue to move along a linear path.  He then presses button B for 16 frames before the target is to meet the blow of the whip.  The enemy can always change direction during these 16 frames, but usually this simple heuristics works. <br><br>  However, after passing through the door, CastlevaniaBot meets red bats.  Like the jellyfish heads, red bats fly across the screen, flying through a sine wave through platforms and stairs.  To predict where the red bat will be after 16 frames, I recorded the movement of one of them in the table.  During the execution of the game CastlevaniaBot tracks bats and waits for peaks or minima of the trajectory, where the vertical speed changes its sign.  Then he is able to compare the coordinates with the values ‚Äã‚Äãin the previously created table.  This allows the appropriate strategy to hit the red bat with the whip, to lean or jump over it. <br><br>  During the high-speed passing (speedranes) of Castlevania, players perform maneuvers that make the game as deterministic as possible.  For example, they found that if, at the end of level 1, to destroy a block and pick up a weapon upgrade in a certain time sequence, then the boss will behave in accordance with the desired pattern, allowing it to be defeated quickly. <br><br>  No matter how experienced people may be, they cannot fully tame the random number generator.  However, since CastlevaniaBot can control button presses with frame accuracy, it can bring the concept of high-speed transmission to its limit, each time passing the game in exactly the same way.  If he did, it would be no better than passing <a href="https://ru.wikipedia.org/wiki/Tool-assisted_speedrun">TAS</a> .  Therefore, CastlevaniaBot arbitrarily adds errors and delays to its actions using an external random number generator, in order to avoid deterministic gameplay.  For example, when he strikes a high candle with a whip, he deliberately adds a delay to the jump and strike for a random number of frames.  Such tiny changes significantly affect the passing game. <br><br>  Although CastlevaniaBot seeks to avoid determinism, it still borrowed one concept from speedrunning: <a href="http://www.speedrunslive.com/faq/glossary/">damage boosts</a> .  In 50% of cases, CastlevaniaBot completely avoids passing the dungeon of human fish by jumping back onto the red bat, which throws it onto a platform that is otherwise unattainable. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/375/733/1ed/3757331edfa439d3ed9eb1ef3be8443e.png"></div><br>  In the other half of the cases, CastlevaniaBot chooses to fight with fish people.  Their fireballs have high priority and CastlevaniaBot hits them with a whip, dodges or bounces depending on the situation. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6e4/f51/077/6e4f51077f42c471bc0484e64aaa14b6.png"></div><br>  Due to the unpredictability of the creation of enemies and their fireballs, most players usually run a part with fish people.  But CastlevaniaBot spends time on them, gathers all the hearts and even the hidden treasure in the rightmost edge.  The bot knows exactly what items are in each candle, and since he prefers to use holy water, he skips the candles, which are hidden chronometers.  However, if you stay in this part and fight with people-fishes, then sometimes you can inevitably choose a chronometer. <br><br>  Stages are often completed with crosses, destroying all enemies on the screen.  In case you are curious, I will say - crosses cannot kill bosses at the end of a level.  In fact, crosses are sometimes created even during boss fights.  For example, in a battle with Medusa, crosses sometimes appear when killing snakes.  But these crosses can only kill other snakes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c3e/328/e31/c3e328e311c90509ffc2450e4b991436.png"></div><br>  After passing through the door CastlevaniaBot again meets with ghosts.  In the screenshot below, he wants to jump onto the lower platform, but ghosts prevent him from moving.  When the table created by the pathfinding algorithm orders CastlevaniaBot to jump, it studies the space around the target platform.  If it turns out that he will land on enemies, then the jump is not performed.  In this case, this mechanism causes CastlevaniaBot to wait until the ghosts make room for him. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c3b/2ef/817/c3b2ef81726485f94f1f391efa1ab2e6.png"></div><br>  This rule ‚Äúcheck the presence of enemies before a jump‚Äù illustrates one of the principles of the structure of CastlevaniaBot: it should be governed by simple, as generalized rules as possible.  In some parts of the game you need to use one-time strategies that solve very specific problems.  But in most of the game, the bot's actions are controlled by reusable heuristics.  I did not write a command that made him stop at that particular point and wait for the ghosts to go astray.  This behavior originated as a result of heuristics. <br><br>  CastlevaniaBot completes the level by killing Phantom Bat with triple holy water.  But his attack strategy is determined by his secondary weapon.  In fact, if he had no secondary weapons, he was ready to kill the boss with one whip.  A particularly interesting case is the killing of Phantom Bat with an ax.  Similar to the case of the red bat, I recorded in the table the movement of the ax along a parabola.  During the execution of the game, CastlevaniaBot performs a table offset, matching it with each of the floor tiles.  This allows you to calculate the optimal point for killing the boss with an ax. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d0c/480/2de/d0c4802de26d9629ca4376a67513106f.png"></div><br>  Immediately before picking up a crystal ball, CastlevaniaBot throws the secondary weapon in different directions, knowing that it will freeze in the air after it touches the ball.  Then he randomly jumps repeatedly and hits his whip, hoping to stand in a strange pose. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f90/83b/d56/f9083bd561d92261d581128157bdf205.png"></div><br>  At the beginning of level 2, CastlevaniaBot avoids the first candles in which the boomerang is hidden.  The strategy of working with a knight spear campaign on the strategies of ghosts or fish people, but this is the first enemy, for the murder of which two blows are needed.  A black bat slumbers until you approach it, after which it takes off and moves linearly enough to be killed with a whip using the simple heuristics mentioned above. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a3e/d23/01e/a3ed2301ee4a6689ef64648439eb1939.png"></div><br>  Having destroyed the bricks of the wall, in 50% of cases CastlevaniaBot seems to leave the room without lifting the crown.  But is it?  In fact, in such cases, he picks up the crown, taking advantage of the game's bug.  Since the end of the upper ladder coincides horizontally with the location of the crown, the player, when passing upwards and beyond the screen, is momentarily below.  If you listen to the sound or look at the glasses, you can see that the bot actually takes the crown. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/348/459/ef8/348459ef8dc72330b2d1bf99c63eb07d.png"></div><br>  At level 2, enemies do not attack a player when he is on a mobile platform.  CastlevaniaBot just has to wait until the platform comes, go to the platform, wait until it reaches the other side, and then leave it.  There is a slight variation for platforms that do not touch tiles on the other hand.  In such cases, CastlevaniaBot does not step down, but jumps off the platform. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/161/7e3/f4c/1617e3f4c2b0f50832dba59992438aa7.png"></div><br>  The door leads to a corridor filled with flying heads, and CastlevaniaBot reacts to this by moving forward.  As in the case of mobile platforms, CastlevaniaBot knows that this strategy should be applied based on its position, and not on the prioritization of game objects on the screen.  However, as soon as all the heads of the jellyfish fly, he again switches to this technique in order to choose the strategy that will be used later. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c33/0ce/dd8/c330cedd8cdb3748b08988787e1b58df.png"></div><br>  Another strategy, depending on the position, is triggered after raising along the next ladder leading to the area filled with heads of jellyfish.  In 50% of cases, CastlevaniaBot intentionally jumps on the jellyfish head to get a damage boost, pushing it onto the upper platform next to the door leading to the next stage.  These are the only two damage boost that CastlevaniaBot knows about.  Unlike speedrunners, it does not do it to save time; this is just another contribution to the non-determinism of the passage. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0ea/e45/c5c/0eae45c5c564301aa03fa376b85f43f2.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Passing through the "crush" is an interesting position-based strategy, repeated three times. </font><font style="vertical-align: inherit;">CastlevaniaBot waits until the closest ‚Äúcrush‚Äù to its left reaches the desired position, then runs through it. </font><font style="vertical-align: inherit;">After its passage, it stops, turns, hits the candles with a whip, picks up the created object and repeats the operation with subsequent ‚Äúcrush‚Äù. </font><font style="vertical-align: inherit;">One of the items could potentially be holy water, so it always destroys these candles.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7d2/2b4/303/7d22b4303c14e5f460b4b090918ef1fb.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After the "crush" for the first time there are ghosts and bone towers. </font><font style="vertical-align: inherit;">The ghosts are very easy to aim, but to kill them you need a few hits. </font><font style="vertical-align: inherit;">It is even easier to aim at the bone towers, because they do not move. </font><font style="vertical-align: inherit;">For their fireballs, the same strategy is used as for the people-fish balls.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7b1/0ad/931/7b10ad9316ab8e0ef3f53007740ffd4a.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Level 2 usually ends with CastlevaniaBot instantly killing Medusa with an endless stream of holy water. </font><font style="vertical-align: inherit;">However, he is ready to work with any other type of secondary weapon.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/46a/02c/a28/46a02ca28233821148bd64afcf43ef65.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At level 3 jumpers appear. </font><font style="vertical-align: inherit;">CastlevaniaBot reacts to them by waiting for them to jump into the limits of the whip. </font><font style="vertical-align: inherit;">If the jumpers jump the player, then CastlevaniaBot moves in the opposite direction and hits them with the whip before they touch the ground.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/863/ec4/58e/863ec458ebc43b8c3959750018c9952e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Further white skeletons appear. </font><font style="vertical-align: inherit;">They have a very random pattern. </font><font style="vertical-align: inherit;">In addition, they throw bones. </font><font style="vertical-align: inherit;">At level 3, CastlevaniaBot tries to avoid them. </font><font style="vertical-align: inherit;">But I found that at subsequent levels the bones only distract, and it will be more effective to simply ignore them. </font><font style="vertical-align: inherit;">The strategy of CastlevaniaBot for white skeletons - just beat them.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c4d/eaf/9e4/c4deaf9e44458c08487d89d22b5a9618.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CastlevaniaBot waits for the crows to fly. </font><font style="vertical-align: inherit;">Then, based on the height of the crow relative to the player, he accurately calculates when to hit the whip after the jump.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d0b/7ce/78c/d0b7ce78cf8ea65a6001ca63a0a1d087.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After moving to the next stage, CastlevaniaBot independently strikes candles, from which a chronometer appears, and then waits until it disappears. </font><font style="vertical-align: inherit;">A little ahead and behind the screen is a raven. </font><font style="vertical-align: inherit;">The bot destroys the candles before raven battle, to reduce the risk of accidentally striking them and receiving unwanted secondary weapons.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fb3/a6a/c85/fb3a6ac852c7633a530ea2666f3cf3c0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Right before the place where the mummies appear, CastlevaniaBot goes to the left on the platform to bring about a hidden money bag. </font><font style="vertical-align: inherit;">He does it just for the sake of interest, because he cannot raise it in any way.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2f4/62d/ebe/2f462debef355d502ee9969489c0fa9b.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Further, CastlevaniaBot deliberately strikes candles, from which a dagger falls out. </font><font style="vertical-align: inherit;">As is the case with the chronometer, he does this so as not to pick it up randomly during subsequent actions.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/094/9c7/0fa/0949c70faa3fcc414107b04ae8e1be68.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Finally, the mummies are cast down by rain from the holy water. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ee4/0a6/75a/ee40a675a2432df6a4a3c24d2681c682.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To fight all the bosses CastlevaniaBot is ready to use any secondary weapon. </font><font style="vertical-align: inherit;">In fact, the strategies for using secondary weapons completely change if, for some reason, a block containing a piece of pork is destroyed. </font><font style="vertical-align: inherit;">Without this block it is impossible to climb the upper platform, because of which you have to fight on the lower level.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At level 4, moving platforms are returned. </font><font style="vertical-align: inherit;">And this time there is a chance that red bats will appear on the way. </font><font style="vertical-align: inherit;">To reduce the likelihood of their attack, he waits for the arrival of the platform to coincide with the destruction of the red bat. </font><font style="vertical-align: inherit;">Since red mice appear at fixed intervals, this gives CastlevaniaBot enough time to cross the waterhole without bats. </font><font style="vertical-align: inherit;">He is ready to deal with bats and randomly appearing human fishes while he is on the platform, but this makes jumping to and from the platform very dangerous. </font><font style="vertical-align: inherit;">The strategy used by CastlevaniaBot increases the likelihood of its success.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f4a/cb3/35b/f4acb335ba2cf17e29d42dfffe51d689.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The same strategy is repeated in the middle of the stage. </font><font style="vertical-align: inherit;">This time the jump to the mobile platform is much longer, so it is crucial to destroy the red bat before the jump.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6b0/42c/e0d/6b042ce0d1ee7845c83d5ff1ea5c65cf.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As shown in the screenshot above, the candles are always located at a distance of 64 pixels from each other. Perhaps this is an artifact of the fact that the level data is presented in ROM in a vector-like format that saves space. But for some reason, the designers decided to align the candles not with the centers, but with the edges of the tiles. In this case, the candles are aligned with both ends of the platform. Therefore, after hitting them, an object that appears may fall directly into the abyss below them.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I think that at some stage the designers realized this problem. But by that time, the displacement of the entire series of candles on all the finished levels, in order to align them with the centers of the tiles, could have caused other problems. Instead, they decided to randomly shift the candles one pixel to the right or left of the place of their creation. Therefore, after hitting the candles on the right side of the screenshot, there is a 50% chance that the holy water contained in them will fall on the platform. In the rest of the cases, it falls into the water. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CastlevaniaBot usually completely avoids these candles, because it rather successfully saves holy water. But if he needs it, he rises very close to these candles in order to guarantee the holy water that has fallen from them.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next CastlevaniaBot meets a bunch of jumpers. </font><font style="vertical-align: inherit;">Axes often appear in this area after killing jumpers. </font><font style="vertical-align: inherit;">CastlevaniaBot avoids them, because holy water turns out to be especially useful in fighting the boss.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/50e/182/f5f/50e182f5fe39bc3e3145bb68aae819d7.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> When going to the last stage, the level of CastlevaniaBot completely ignores the bone dragon. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/093/45e/a6c/09345ea6ca0024888d7be0f8d25785f6.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> But he gets rid of the next two with quick blows of the whip. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d5f/0e5/d57/d5f0e5d5706307c36d5d9dd9c19052e7.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The monster of Frankenstein and Igor are destroyed by a constant stream of blows with a whip and holy water. </font><font style="vertical-align: inherit;">As is the case with other bosses, CastlevaniaBot can handle other secondary weapons, or even without them. </font><font style="vertical-align: inherit;">However, the chances of survival without holy water are reduced.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/23f/606/220/23f6062203ce695c2a38c9d2d170926e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At level 5, CastlevaniaBot again deals with white skeletons. </font><font style="vertical-align: inherit;">But this time, he uses variations of strategies that are rarely seen at level 3. Depending on where they appear, CastlevaniaBot throws holy water and then moves back to attract skeletons to the flame. </font><font style="vertical-align: inherit;">Next to the stairs, he passes under the skeletons to direct them to where they should be.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/64e/c6c/610/64ec6c6100a72265aab1f024c6561718.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At level 5, resurgent red skeletons appear for the first time. </font><font style="vertical-align: inherit;">CastlevaniaBot keeps track of the time of the last blow to them, to know when you can safely walk on the red bones.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8b6/628/54c/8b662854cf5582b93cf299b0852964c9.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first room of stage 14 is fully processed by one huge strategy. CastlevaniaBot kills the jumper first. Then he waits for the lower knight to throw an ax, hits the ax with a whip and slowly rises along the lower stairs. This pushes the lower knight off the screen, which causes it to disappear. Then he waits until the upper region is free from the axes, hits the candles and collects the objects that appear. Then he approaches the base of the ladder leading to the upper knight. When the top knight throws the ax high, CastlevaniaBot runs after him. This pushes the upper knight to the left and almost completely off the screen, but does not destroy him. CastlevaniaBot bends under the returning ax, and possibly under the second abandoned ax, and then finally approaches the stairs to the next sub-step.</font></font> Hooray! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/93a/727/488/93a727488c3cd37cd381668415c1261b.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After passing a few stairs, CastlevaniaBot again meets a knight with an ax. </font><font style="vertical-align: inherit;">He uses holy water to stun him, and then finishes him off with a whip. </font><font style="vertical-align: inherit;">If there is no holy water, he continues to beat the whip, chasing the knight until he dies.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/81c/992/8d6/81c9928d6a77554910fb989df1fd4932.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Moving along level 5 stairs, CastlevaniaBot often has to wait until the red skeleton moves away from either the top or bottom of the stairs. </font><font style="vertical-align: inherit;">Towards the end of the level, the bone tower makes this task even more difficult. </font><font style="vertical-align: inherit;">Depending on how the skeletons decide to move, CastlevaniaBot goes up and down the stairs until it can pass.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/65a/cd8/ed8/65acd8ed8ae89e882702cb9387b8c432.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To process groups of red skeletons, additional logic is required so that the bot does not fall into an infinite loop. If CastlevaniaBot hits them with a whip separately, at such intervals that the first hit has time to be reborn, he will fall into a cycle, where he will continue to destroy the endlessly resurgent skeletons. To avoid this, CastlevaniaBot will not hit the whip of the red skeleton standing next to the pile of red bones. This rule allows the red bones to be reborn next to the still-living red skeleton, giving the opportunity to hit the two of them simultaneously. Without the interval between their destruction, the cycle will not be created.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/446/82b/18d/44682b18de7a81b58d01dd734e4f57f3.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To avoid the jellyfish heads in the long corridor leading to Death, the bot never stops, stunning the knights that usually appear in the path. </font><font style="vertical-align: inherit;">He takes advantage of the fact that a player can pass through enemies stunned by holy water without taking damage.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cab/d68/587/cabd685876fb241b8362a9f2f83482d5.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If there is no holy water, then right in front of the corridor CastlevaniaBot can take a boomerang. </font><font style="vertical-align: inherit;">With the best of luck, he uses it to destroy the knights, as well as to obtain weapon upgrades.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/444/738/a60/444738a60282b741af01e775ebfe70b2.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CastlevaniaBot stuns Death with holy water before she starts throwing spit, quickly killing her. </font><font style="vertical-align: inherit;">He can also defeat Death with a triple boomerang, but this usually requires several attempts.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/72a/fdb/57a/72afdb57a40c4f9613a71c6edd5beb17.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The principal strategy of CastlevaniaBot for passing the bridge at the beginning of level 6 is to keep moving. </font><font style="vertical-align: inherit;">He strikes a whip of huge bats from above to stun them, and then jumps over the huge bats that appear from below. </font><font style="vertical-align: inherit;">In addition, from time to time he needs to evade fireballs thrown by bats, or beat them with a whip.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/507/fa3/c82/507fa3c822d5a767e6b6a4916d1d2857.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Passage over the bridge is not guaranteed. </font><font style="vertical-align: inherit;">It all depends on how friendly the huge bats will be. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the next sub-step, CastlevaniaBot uses the chronograph received on the bridge two or more times in order to pass through eagles and jumpers. </font><font style="vertical-align: inherit;">Without a chronograph, he tries to make his way with a whip.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d06/4fd/3f3/d064fd3f3b249a76112632c100b34ccd.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> When CastlevaniaBot reaches Dracula's tower, he can climb and descend the stairs several times to create candles again, which allows him to collect at least 20 hearts. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/338/cf3/525/338cf3525c8b5c0361cb98c23681f8b3.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The rightmost candles in the chambers of Dracula give holy water, which is necessary to fight the second form of Dracula. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To defeat the first form of Dracula requires 16 blows to the head. </font><font style="vertical-align: inherit;">CastlevaniaBot comes up to Dracula several times, waits for him to fire balls of fire, and then jumps over the balls and hits Dracula on the head with a whip.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8ad/47e/af9/8ad47eaf9a2a962288480bbf49b844fc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The second form of Dracula, called Cookie Monster, is stunned by the bot with holy water and several times strikes the head with a whip. </font><font style="vertical-align: inherit;">From time to time, Cookie Monster jumps to the player, while CastlevaniaBot dodges. </font><font style="vertical-align: inherit;">Also, the Cookie Monster throws fireballs, which can usually be destroyed with holy water and a whip. </font><font style="vertical-align: inherit;">Sometimes you can get a weapon upgrade. </font><font style="vertical-align: inherit;">And double holy water catches Cookie Monster in a constant stunning cycle leading to a quick victory.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bdf/05b/266/bdf05b2661aff44a2b0804865013b95b.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CastlevaniaBot does not know how to go through the Difficult Mode, which begins after the final credits. </font><font style="vertical-align: inherit;">However, after restarting the game in the courtyard of the castle, he drops the byte of the game cycle to zero, switching it to Normal Mode. </font><font style="vertical-align: inherit;">This allows CastlevaniaBot to play forever.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4c6/3a6/c4a/4c63a6c4ad709d26e0256a6ecdf07a61.png"></div><br><hr><br><h1>  Files </h1><br> <a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CastlevaniaBot_2018-12-09.zip</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The file </font></font><code>.zip</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contains:</font></font><br><br><ul><li> <code>src</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - source tree. </font></font></li><li> <code>CastlevaniaBot.jar</code> ‚Äî   . </li><li> <code>lgpl-2.1.txt</code> ‚Äî    . </li></ul><br><hr><br><h1>  Launch </h1><br><h2>   </h2><br><ul><li> <a href="https://nintaco.com/">Nintaco</a> ‚Äî  NES. </li><li> <code>Castlevania (U) (PRG1) [!].nes</code> ‚Äî ROM . </li></ul><br><h2>   </h2><br><ol><li>  Nintaco   <code>Castlevania (U) (PRG1) [!].nes</code> . </li><li>  <code>CastlevaniaBot.jar</code>   <code>.zip</code> . </li><li>   Run Program,  Tools | Run Program... </li><li>       JAR   ,    Find JAR.... </li><li>  Load JAR,   . </li><li>  Run. </li></ol><hr><table><tbody><tr><td> Copyright ¬© 2018 meatfighter.com <br><br>      .     /      LGPLv2.1. </td></tr></tbody></table></div><p>Source: <a href="https://habr.com/ru/post/432784/">https://habr.com/ru/post/432784/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../432774/index.html">Frontend DevDay. Record of reports</a></li>
<li><a href="../432776/index.html">The book "React in action"</a></li>
<li><a href="../432778/index.html">Development of buck-converter on STM32F334: principle of operation, calculations, prototyping</a></li>
<li><a href="../432780/index.html">Why do we need empathy in the world of technology</a></li>
<li><a href="../432782/index.html">Multi-server installation Zimbra Collaboration Suite</a></li>
<li><a href="../432786/index.html">.NET - localization without pain. (N) gettext + poedit</a></li>
<li><a href="../432788/index.html">Prototypes: how to create a successful product and save</a></li>
<li><a href="../432790/index.html">Superconductor + ferromagnet: the study of triplet Cooper pairs</a></li>
<li><a href="../432792/index.html">Roskomnadzor fined Google 500 thousand rubles</a></li>
<li><a href="../432794/index.html">Bret Victor: A few words about Douglas Engelbart</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>