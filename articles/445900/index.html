<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to withstand the increased load on the system: talk about large-scale preparations for Black Friday</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 

 In 2017, during Black Friday, the load increased by almost one and a half times, and our servers were at the limit. Over the year, the nu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to withstand the increased load on the system: talk about large-scale preparations for Black Friday</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr! <br><br>  In 2017, during Black Friday, the load increased by almost one and a half times, and our servers were at the limit.  Over the year, the number of customers has grown significantly, and it became clear that without thorough preliminary preparation, the platform may simply not withstand the loads of 2018. <br><br>  We set the goal to be the most ambitious possible: we wanted to be fully prepared for any, even the most powerful, spikes in activity and began to withdraw new capacities in advance throughout the year. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Our CTO Andrei Chizh ( <a href="https://habr.com/ru/users/chizh_andrey/" class="user_link">chizh_andrey</a> ) tells how we were preparing for Black Friday 2018, what measures we took to avoid falls, and, of course, about the results of such thorough preparation. <br><br><img src="https://habrastorage.org/webt/nv/pg/sq/nvpgsqdi4auhsvdmclno1upgvju.jpeg"><br><a name="habracut"></a><br>  Today I want to talk about preparations for Black Friday 2018. Why now, when most of the large sales are over?  We began to prepare about a year before large-scale actions, and by trial and error we found the optimal solution.  We recommend that you take care of the hot seasons in advance and prevent fakapy that can emerge at the most inopportune moment. <br>  The material will be useful to anyone who wants to squeeze the maximum profit from such actions, because  The technical side of the question is not inferior here marketing. <br><br><h2>  Features of traffic at big sales </h2><br>  Contrary to popular belief, black Friday is not one day in a year, but almost a whole week: the first discount offers are received 7-8 days before the sale.  Website traffic begins to grow smoothly throughout the week, reaches its peak on Friday and falls quite sharply on Saturday to regular store numbers. <br><br><img src="https://habrastorage.org/webt/fp/gg/zh/fpggzhkt6td7vbzkbmw7k5ljo6u.jpeg"><br><br>  This is important to consider: online stores are especially sensitive to any ‚Äúslowdowns‚Äù in the system.  In addition, our email newsletter direction also felt a significant increase in the number of shipments. <br><br>  It is strategically important for us to go through Black Friday without a fall, because  The most important functionality of the work of sites and mailing lists of stores depends on the work of the platform, namely: <br><br><ul><li>  Tracking and issuing product recommendations, </li><li>  Issuance of related materials (for example, design images of blocks of recommendations, such as arrows, logos, icons and other visual elements), </li><li>  Delivery of product images of the right size (for this purpose, we have ‚ÄúImageResizer‚Äù - a subsystem that downloads the image from the store server, compresses it to the right size and, through the caching servers, produces images of the right size for each product in each recommendation block). </li></ul><br>  In fact, during the Black Friday 2019 period, the service load increased by 40%, i.e.  The number of events that the Retail Rocket system tracks and processes on online shopping sites has increased from 5 to 8 thousand requests per second.  Due to the fact that we were preparing for more serious loads, we experienced this surge easily. <br><br><img src="https://habrastorage.org/webt/hj/rf/yi/hjrfyizrdasmrzna_e2yv26s7x4.png"><br><br><h2>  General training </h2><br><br>  Black Friday is a hot season for all retail and for ecommerce in particular.  The number of users and their activity at this time is growing at times, so we, as always, thoroughly prepared for this tense pore.  Add here the fact that many online stores are connected to us, not only in Russia, but also in Europe, where the hype is much higher, and we get the level of passions worse than the Brazilian series.  What needs to be done to be fully prepared for increased loads? <br><br><h3>  Work with servers </h3><br>  To begin with, it was necessary to find out exactly what we lack to increase the capacity of servers.  Already in August, we started ordering new servers specifically for Black Friday - we added 10 additional machines.  By November, they were already completely in battle. <br><br>  At the same time, part of the build of machines was reinstalled for use as Application servers.  We immediately prepared them for using different functions: for issuing recommendations, and for ImageResizer, so that, depending on the type of load, each of them could be used for one of these roles.  In the normal mode, the Application and ImageResizer servers have clearly marked functions: the first are engaged in issuing recommendations, the second - delivering images for letters and recommendation blocks on the website of online stores.  In preparation for Black Friday, it was decided to make all the dual-purpose servers in order to balance the traffic between them depending on the type of download. <br><br>  Then we added two large servers for Kafka (Apache Kafka) and got a cluster of 5 powerful machines.  Unfortunately, everything did not go as smoothly as we would like: in the process of data synchronization, two new machines occupied the entire width of the network channel, and it was necessary to urgently figure out how to carry out the adding process quickly and safely for the entire infrastructure.  To solve this issue, our administrators had to valiantly donate the weekend. <br><br><h3>  Work with data </h3><br>  In addition to servers, we decided to optimize files to ease the load and a big step for us was the translation of static files.  All static files that were previously hosted on servers were increased to S3 + Cloudfront.  We have long wanted to do this, because the server load was close to the limit values, and now there was an excellent reason. <br><br>  A week before Black Friday, they increased the caching time for images up to 3 days, so that if ImageResizer falls, previously cached images were obtained from cdn.  It also reduced the load on our servers, because the longer the image is stored, the less often we need to spend resources on resizing. <br><br>  Last but not least, 5 days before Black Friday a moratorium on deploying any new functionality was announced, as well as on any work with the infrastructure - all attention is focused on coping with the increased loads. <br><br><h2>  Difficult Situation Response Plans </h2><br>  No matter how good the preparation is, fakaps are always possible.  And we have developed 3 plans for responding to possible critical situations: <br><br><ul><li>  load reduction </li><li>  disable some services </li><li>  full service shutdown. </li></ul><br>  <b>Plan A: reduced load.</b>  It should have been enabled if, due to a surge in load, our servers will go beyond the allowed response timings.  In this case, we prepared mechanisms for gradually reducing the load by switching part of the traffic to Amazon servers, which simply would give ‚Äú200 OK‚Äù to all requests and give an empty response.  We understood that this is a degradation of the quality of service, but the choice between the fact that the service does not work at all or does not show recommendations for approximately 10% of the traffic is obvious. <br><br>  <b>Plan B: Disable services.</b>  Implied partial degradation of the service.  For example, reducing the speed of calculating personal recommendations for the sake of unloading some databases and communication channels.  In regular mode, recommendations are calculated in real-time mode, creating for each visitor their own version of an online store, but under conditions of increased loads, the reduction in speed allows other core services to continue working. <br><br>  <b>Plan C: in case of Armageddon.</b>  If a complete system failure occurs, we have prepared a plan that will allow us to safely disconnect us from customers.  Buyers of stores simply stop seeing recommendations, the performance of an online store will not suffer in any way.  For this, we would have to reset our integration file in order for new users to stop interacting with the service.  That is, we would disable our main tracking code, the service would stop collecting data and calculate recommendations, and the user would simply see the page without blocks of recommendations.  For all those who have already received the integration file, we have provided the option of switching the DNS record to Amazon and the 200 OK plug. <br><br><h2>  Results </h2><br>  We coped with the entire load, even without the need to use additional build machines.  And thanks to advance preparation, we did not need any of the developed response plans.  But all the work done is an invaluable experience that will help us cope with the most unexpected and huge influxes of traffic. <br>  As in 2017, the load on the service increased by 40%, and the number of users in online stores on Black Friday increased by 60%.  All the difficulties and mistakes occurred during the preparatory period, which saved us and our clients from unforeseen situations. <br><br>  How do you experience Black Friday?  How do you prepare for critical loads? </div><p>Source: <a href="https://habr.com/ru/post/445900/">https://habr.com/ru/post/445900/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../445890/index.html">PyTest Neo</a></li>
<li><a href="../445892/index.html">Theory of large and small explosions</a></li>
<li><a href="../445894/index.html">[Izhevsk and Perm, Announcement] Warm and transistor online broadcast CodeFest X</a></li>
<li><a href="../445896/index.html">Why low-cost 3D scanners are not suitable for professional tasks</a></li>
<li><a href="../445898/index.html">About new ideas, narrow views and a word of mouth</a></li>
<li><a href="../445904/index.html">Types of infinity and brain removal</a></li>
<li><a href="../445906/index.html">Do not eat aspirin</a></li>
<li><a href="../445908/index.html">Golang and the evolution of database interaction</a></li>
<li><a href="../445910/index.html">How do we make EF 6 with MSSQL and PostgresSQL</a></li>
<li><a href="../445912/index.html">Hi, Habr, we are Advantech</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>