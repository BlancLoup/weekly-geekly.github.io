<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As I wrote a cross-platform 3d game engine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings Habr! Many of us probably wondered "if I didn't write the game myself." Now I am running the project ‚ÄúOpen tomb‚Äù - an attempt to create a po...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As I wrote a cross-platform 3d game engine</h1><div class="post__text post__text-html js-mediator-article">  Greetings Habr!  Many of us probably wondered "if I didn't write the game myself."  Now I am running the project <a href="http://sourceforge.net/projects/opentomb/">‚ÄúOpen tomb‚Äù</a> - an attempt to create a portable game engine for the first 5 parts of the ‚ÄúTomb raider‚Äù, which is posted on sourceforge.com, however, judging by my experience, many will be interested in the story with some details about how the engine was written from scratch and with virtually no knowledge in this area.  Even now, a lot of knowledge is not enough, and sometimes there is simply not enough motivation to do something better, or more correctly, but it is better to move on to how the project has come to life, step by step. <br><a name="habracut"></a><br><h5>  What motivated me to write the engine </h5><br>  The story began a long time ago and from the fact that I wanted to play a wonderful logical puzzle game ‚ÄúPusher‚Äù on Vista 64. However, the original game was 16 bit and completely refused to start.  Nothing better than writing a clone on C, I did not come up with (sometimes the best solution initially leads to more useful results).  After a short time, I implemented the game on the <a href="http://www.libsdl.org/">SDL</a> v1.2 + <a href="https://www.opengl.org/">OpenGL</a> platform. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0c4/032/d76/0c4032d76ceda66f6dc2d5413c8b04af.jpg" alt="image"><br><br>  For the convenience of transferring maps added level editor and manually cloned all 64 maps.  After some time, the interest in ‚ÄúPusher‚Äù weakened, and I already wanted to drive in <a href="https://ru.wikipedia.org/wiki/Tomb_Raider_%2528%25D1%2581%25D0%25B5%25D1%2580%25D0%25B8%25D1%258F_%25D0%25B8%25D0%25B3%25D1%2580%2529">Tomb raider</a> 1 with 3dfx graphics.  And as many have already guessed, the existing solutions didn‚Äôt make me particularly pleased (more likely even subjectively) and I started looking for ports.  In addition to the well-known project <a href="http://sourceforge.net/projects/openraider">Open raider,</a> I found nothing  I still remember how I suffered with its build under windows using the <a href="https://ru.wikipedia.org/wiki/MinGW">mingw</a> compiler (I don‚Äôt remember the development environment, either <a href="http://www.codeblocks.org/">code :: blocks</a> , or <a href="https://netbeans.org/">netbeans</a> ).  I was not at all pleased with the result of the assembly: loading the level for about a minute and a black screen as a result.  I didn‚Äôt have the skills to pick someone else‚Äôs code, to understand its structure and the meaning of the functions.  Attempts to collect "better" stopped.  However, I set about trying to assemble at least one of the open engines manually, not with the auto-config <a href="http://habrahabr.ru/post/188354/">Die GNU Autotools</a> , but from a self-assembled designer in the development environment. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Thus, after a heap of time behind the monitor, a certain amount of mate, etc., I gathered <a href="http://tenebrae.sourceforge.net/">Quake Tenebrae</a> without sound.  But he worked!  It was a small victory that bore fruit: I began to better understand someone else's code and finally began to at least understand something about the organization of the compiler's work - without which nothing is possible at all.  After a few minor improvements were made, some bugs were fixed and the sound was started, but the project was never uploaded to the Internet (even then it was morally obsolete, especially considering the presence of <a href="http://icculus.org/twilight/darkplaces">Dark places engine</a> ).  However, I found out from the code of the <a href="http://tenebrae.sourceforge.net/">Quake Tenebrae</a> engine how the game as a whole is organized, its individual components and the memory manager (I added the <i>realloc</i> function to it, albeit a fairly simple one, but everything worked without crashes). <br><br><h5>  We write the engine </h5><br>  When I got a little comfortable, I decided to start writing my own engine from scratch.  Just for the sake of interest and self-development.  The basis for creating the engine was the following: <a href="http://sourceforge.net/projects/tdm-gcc">GCC-TDM compiler v4..</a> + <a href="http://sourceforge.net/projects/mingwbundle">msys</a> and <a href="https://netbeans.org/">Netbeans</a> development environment;  libraries: <a href="http://www.libsdl.org/">SDL</a> v1.2 + <a href="https://www.opengl.org/">OpenGL</a> .  The first implemented function was to create a screenshot and save it to a * .bmp file using a handwritten bibliteck for working with this format.  Which engine can do without the console to enter command <s>cheats</s> and text output ‚Äî probably none, so the next thing I learned was how to display text in the OpenGL window and chose a bunch of <a href="http://freetype.sourceforge.net/">freetype</a> 1 + <a href="http://gltt.sourceforge.net/">gltt</a> .  The first recognizable team was the <i>exit command,</i> and after that - commands for playing with the sizes of fonts, strings, etc ....  For reference: I liked the code used in <a href="https://github.com/id-Software/Quake">Quake I</a> for parsing lines and sequentially breaking it into tokens, which is still present in the engine: <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_token</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *token)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> len; len = <span class="hljs-number"><span class="hljs-number">0</span></span>; token[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!data) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// skip whitespace skipwhite: while((c = *data) &lt;= ' ') { if(c == 0) return NULL; // end of file; data++; } // skip // comments if (c=='/' &amp;&amp; data[1] == '/') { while (*data &amp;&amp; *data != '\n') data++; goto skipwhite; } // handle quoted strings specially if (c == '\"') { data++; while (1) { c = *data++; if (c=='\"' || !c) { token[len] = 0; return data; } token[len] = c; len++; } } // parse single characters if (c=='{' || c=='}'|| c==')'|| c=='(' || c=='\'' || c==':') { token[len] = c; len++; token[len] = 0; return data+1; } // parse a regular word do { token[len] = c; data++; len++; c = *data; if (c=='{' || c=='}'|| c==')'|| c=='(' || c=='\'' || c==':') { break; } } while (c&gt;32); token[len] = 0; return data; }</span></span></code> </pre> <br><br>  Looking ahead: when I needed script support, I decided to use the approach to developing the engine as in ‚ÄúID software‚Äù using the example of ‚ÄúDOOM 3 engine‚Äù, which was very well described <a href="http://habrahabr.ru/post/166113/">here</a> on Habr√© =) (I want to say again many thanks to the authors for the article translation and write interesting comments to her people).  Impressed by the article, I decided to implement <a href="http://www.lua.org/">LUA</a> in my engine not only for in-game script needs, but also for parsing configuration files and console commands (i.e., a uniform system is used everywhere).  The approach justified itself absolutely. <br><br><h5>  Let's go to 3d </h5><br>  I was lucky that at the institute I liked linear algebra, matrix transformations, vectors and numerical methods.  Without these fundamentals, it is very imprudent to start programming the engine from scratch (except to study these sections with examples, but without a certain theoretical knowledge base this will not be very realistic).  The book by <a href="http://steps3d.narod.ru/">A. Boreskov</a> ‚ÄúGraphics of a three-dimensional computer game based on OPENGL‚Äù helped me greatly in mastering graphics.  I reread it more than once (to get acquainted with the mathematical apparatus, types of renderers and the structure of engines).  Without understanding the principle of constructing the scene and the purpose of the species matrix and the projection matrix, it is impossible to move anywhere.  After studying some material on the Internet and just literature, I decided to do a portal renderer.  The first thing that was implemented in the engine is a free-flying camera and several portals that could only be seen through each other. <br><br>  After the hardcode, a wireframe scene of 3 rooms was added (two more and a corridor).  But is it really interesting to fly in such a primitive world ... And then I decided to use the resource loader from the <a href="http://sourceforge.net/projects/openraider">Open raider</a> and render the levels.  I was pleased with the result and here it was finally decided to implement the idea of ‚Äã‚Äãcreating a <a href="http://sourceforge.net/projects/opentomb/">port</a> for playing the <a href="https://ru.wikipedia.org/wiki/Tomb_Raider_%2528%25D1%2581%25D0%25B5%25D1%2580%25D0%25B8%25D1%258F_%25D0%25B8%25D0%25B3%25D1%2580%2529">Tomb raider</a> , at least in its first part.  For positioning objects in space, I used the <a href="http://www.songho.ca/opengl/gl_transform.html">matrix in the OpenGL format</a> because it allows you to access the base vectors of the local coordinate system of the object, set the position of the object with one command <i>glMultMatrixf</i> (transform) and set the orientation of the object in the physical <a href="http://bulletphysics.org/wordpress/">bullet</a> engine with one command <i>setFromOpenGLMatrix</i> (transform), about which a little bit later.  Below is an image with the OpenGL matrix structure from the above link: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ca3/92a/034/ca392a034a4e67d8b2921b7b6bc08522.png" alt="image"><br><br>  For keeping a history of changes in the engine and the possibility of backup and just for self-development, it was decided to use the version control system <a href="http://mercurial.selenic.com/">mercurial</a> .  Its use has allowed not only to track the progress in writing code, but also made it possible to upload the results to <a href="http://sourceforge.com/">sourceforge.com</a> .  It should be noted that when the information about portals from real maps began to load into the engine, a huge amount of flaws in my implementation of the portal system immediately surfaced.  It took a lot of time to fight the disappearing objects and departures, and even now I think that the portal module needs serious improvement.  Now the engine renderer, depending on the position of the camera and its orientation, starts passing through the room portals and adds only visible rooms to the list.  Then the renderer draws the rooms and their contents from the list.  It is clear that for large open spaces such an approach is not the most successful, but for the purposes of the project it is quite enough.  Here is an example of the recursive walk around room: <br><br><pre> <code class="cpp hljs">** * The reccursion algorithm: go through the rooms with portal - frustum occlusion test * @portal - we entered to the room through that portal * @frus - frustum that intersects the portal * @<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> number of added rooms */ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Render_ProcessRoom(struct portal_s *portal, struct frustum_s *frus) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ret = <span class="hljs-number"><span class="hljs-number">0</span></span>, i; room_p room = portal-&gt;dest_room; <span class="hljs-comment"><span class="hljs-comment">//    room_p src_room = portal-&gt;current_room; //    portal_p p; //      - frustum_p gen_frus; //    if((src_room == NULL) || !src_room-&gt;active || (room == NULL) || !room-&gt;active) { return 0; } p = room-&gt;portals; for(i=0; i&lt;room-&gt;portal_count; i++,p++) //      { if((p-&gt;dest_room-&gt;active) &amp;&amp; (p-&gt;dest_room != src_room)) //      { gen_frus = Portal_FrustumIntersect(p, frus, &amp;renderer); //  -  .    if(NULL != gen_frus) //        { ret++; Render_AddRoom(p-&gt;dest_room); Render_ProcessRoom(p, gen_frus); } } } return ret; }</span></span></code> </pre> <br><br><h5>  Skeleton Animated Models </h5><br>  And so began one of the most laborious works in the project.  Rendering static rooms with static objects turned out to be relatively easy, but when it came to animated skeleton models ... The first thing I realized was that the <a href="http://sourceforge.net/projects/openraider">Open raider</a> resource loader does not load all the necessary information about the skeleton model.  The number of frames in the animation is determined incorrectly, because of which one animation contains frames from several at once. <br>  During attempts to solve these problems, I found various documentation on the format of the <a href="https://ru.wikipedia.org/wiki/Tomb_Raider_%2528%25D1%2581%25D0%25B5%25D1%2580%25D0%25B8%25D1%258F_%25D0%25B8%25D0%25B3%25D1%2580%2529">Tomb raider</a> levels and at the same time the <a href="http://icculus.org/vt/vt/doc/Tomb%2520Raider%2520II%2520Data%2520Formats.htm">vt</a> project, which had its own resource loader.  Suppose that in this project there was no loading of frames of animation models, but there was more structured code in it, convenient for reading and bringing to mind.  So I replaced the bootloader in the project with <a href="http://icculus.org/vt/vt/doc/Tomb%2520Raider%2520II%2520Data%2520Formats.htm">vt</a> .  For example: in the <a href="http://sourceforge.net/projects/openraider">Open raider</a> all 5 parts of the <a href="https://ru.wikipedia.org/wiki/Tomb_Raider_%2528%25D1%2581%25D0%25B5%25D1%2580%25D0%25B8%25D1%258F_%25D0%25B8%25D0%25B3%25D1%2580%2529">Tomb raider</a> are loaded with one long function with a bunch of <i>if</i> and <i>switch</i> by the version number of the game, which noticeably complicated reading the code and finding errors.  There were 5 modules in <a href="http://icculus.org/vt/vt/doc/Tomb%2520Raider%2520II%2520Data%2520Formats.htm">vt</a> , each of which was responsible for its own version of the level, thanks to which the code was read fairly easily and making changes was not difficult. <br><br>  The main problem with animations was the extraction of the angles of the bones in the skeletal model.  The fact is that to save space, the corners were stored in bytecode in 2-4 byte increments.  The first 2 bytes include a flag about whether there is one turn and around which axis, or just three and the corners themselves.  In the case of 3 turns, flags and corners are stored in 4 bytes, in the case of one, only 2 bytes are used.  In this case, the angles for all models, animations and frames are stored in a single array and the offset must be calculated.  In addition, this bytecode still stores the headers of the individual frames of the model and confusion with offsets is critical, and now we add that the number of frames is loaded incorrectly (later it turned out that the number of frames is given for ‚Äúinterpolated‚Äù animations with a frequency of 30 fps, but in reality frames can be stored in a ‚Äúnarrowed‚Äù form with fps with multipliers 1, 1/2, 1/3 and 1/4).  After finishing the frame loader animations, the skeleton models no longer turn inside out and turn into a mess of distorted polygons!  Now we need to "revive" Lara.  Below is the code of the function that generates the skeleton model, saved spelling and commented out sections of the code for debugging: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GenSkeletalModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct world_s *world, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> model_num, struct skeletal_model_s *model, class VT_Level *tr)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i, j, k, l, l_start; <span class="hljs-keyword"><span class="hljs-keyword">tr_moveable_t</span></span> *tr_moveable; <span class="hljs-keyword"><span class="hljs-keyword">tr_animation_t</span></span> *tr_animation; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> frame_offset, frame_step; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> *frame, temp1, temp2; <span class="hljs-comment"><span class="hljs-comment">///@</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">FIXME:</span></span></span><span class="hljs-comment"> "frame" set, but not used float ang; btScalar rot[3]; bone_tag_p bone_tag; bone_frame_p bone_frame; mesh_tree_tag_p tree_tag; animation_frame_p anim; tr_moveable = &amp;tr-&gt;moveables[model_num]; // original tr structure model-&gt;collision_map = (uint16_t*)malloc(model-&gt;mesh_count * sizeof(uint16_t)); model-&gt;collision_map_size = model-&gt;mesh_count; for(i=0;i&lt;model-&gt;mesh_count;i++) { model-&gt;collision_map[i] = i; } model-&gt;mesh_tree = (mesh_tree_tag_p)malloc(model-&gt;mesh_count * sizeof(mesh_tree_tag_t)); tree_tag = model-&gt;mesh_tree; tree_tag-&gt;mesh2 = NULL; for(k=0;k&lt;model-&gt;mesh_count;k++,tree_tag++) { tree_tag-&gt;mesh = model-&gt;mesh_offset + k; tree_tag-&gt;mesh2 = NULL; tree_tag-&gt;flag = 0x00; vec3_set_zero(tree_tag-&gt;offset); if(k == 0) { tree_tag-&gt;flag = 0x02; vec3_set_zero(tree_tag-&gt;offset); } else { uint32_t *tr_mesh_tree = tr-&gt;mesh_tree_data + tr_moveable-&gt;mesh_tree_index + (k-1)*4; tree_tag-&gt;flag = tr_mesh_tree[0]; tree_tag-&gt;offset[0] = (float)((int32_t)tr_mesh_tree[1]); tree_tag-&gt;offset[1] = (float)((int32_t)tr_mesh_tree[3]); tree_tag-&gt;offset[2] =-(float)((int32_t)tr_mesh_tree[2]); } } /* * ================= now, animation loading ======================== */ if(tr_moveable-&gt;animation_index &lt; 0 || tr_moveable-&gt;animation_index &gt;= tr-&gt;animations_count) { /* * model has no start offset and any animation */ model-&gt;animation_count = 1; model-&gt;animations = (animation_frame_p)malloc(sizeof(animation_frame_t)); model-&gt;animations-&gt;frames_count = 1; model-&gt;animations-&gt;frames = (bone_frame_p)malloc(model-&gt;animations-&gt;frames_count * sizeof(bone_frame_t)); bone_frame = model-&gt;animations-&gt;frames; model-&gt;animations-&gt;id = 0; model-&gt;animations-&gt;next_anim = NULL; model-&gt;animations-&gt;next_frame = 0; model-&gt;animations-&gt;state_change = NULL; model-&gt;animations-&gt;state_change_count = 0; model-&gt;animations-&gt;original_frame_rate = 1; bone_frame-&gt;bone_tag_count = model-&gt;mesh_count; bone_frame-&gt;bone_tags = (bone_tag_p)malloc(bone_frame-&gt;bone_tag_count * sizeof(bone_tag_t)); vec3_set_zero(bone_frame-&gt;pos); vec3_set_zero(bone_frame-&gt;move); bone_frame-&gt;v_Horizontal = 0.0; bone_frame-&gt;v_Vertical = 0.0; bone_frame-&gt;command = 0x00; for(k=0;k&lt;bone_frame-&gt;bone_tag_count;k++) { tree_tag = model-&gt;mesh_tree + k; bone_tag = bone_frame-&gt;bone_tags + k; rot[0] = 0.0; rot[1] = 0.0; rot[2] = 0.0; vec4_SetTRRotations(bone_tag-&gt;qrotate, rot); vec3_copy(bone_tag-&gt;offset, tree_tag-&gt;offset); } return; } //Sys_DebugLog(LOG_FILENAME, "model = %d, anims = %d", tr_moveable-&gt;object_id, GetNumAnimationsForMoveable(tr, model_num)); model-&gt;animation_count = GetNumAnimationsForMoveable(tr, model_num); if(model-&gt;animation_count &lt;= 0) { /* * the animation count must be &gt;= 1 */ model-&gt;animation_count = 1; } /* * Ok, let us calculate animations; * there is no difficult: * - first 9 words are bounding box and frame offset coordinates. * - 10's word is a rotations count, must be equal to number of meshes in model. * BUT! only in TR1. In TR2 - TR5 after first 9 words begins next section. * - in the next follows rotation's data. one word - one rotation, if rotation is one-axis (one angle). * two words in 3-axis rotations (3 angles). angles are calculated with bit mask. */ model-&gt;animations = (animation_frame_p)malloc(model-&gt;animation_count * sizeof(animation_frame_t)); anim = model-&gt;animations; for(i=0;i&lt;model-&gt;animation_count;i++,anim++) { tr_animation = &amp;tr-&gt;animations[tr_moveable-&gt;animation_index+i]; frame_offset = tr_animation-&gt;frame_offset / 2; l_start = 0x09; if(tr-&gt;game_version == TR_I || tr-&gt;game_version == TR_I_DEMO || tr-&gt;game_version == TR_I_UB) { l_start = 0x0A; } frame_step = tr_animation-&gt;frame_size; //Sys_DebugLog(LOG_FILENAME, "frame_step = %d", frame_step); anim-&gt;id = i; anim-&gt;next_anim = NULL; anim-&gt;next_frame = 0; anim-&gt;original_frame_rate = tr_animation-&gt;frame_rate; anim-&gt;accel_hi = tr_animation-&gt;accel_hi; anim-&gt;accel_hi2 = tr_animation-&gt;accel_hi2; anim-&gt;accel_lo = tr_animation-&gt;accel_lo; anim-&gt;accel_lo2 = tr_animation-&gt;accel_lo2; anim-&gt;speed = tr_animation-&gt;speed; anim-&gt;speed2 = tr_animation-&gt;speed2; anim-&gt;anim_command = tr_animation-&gt;anim_command; anim-&gt;num_anim_commands = tr_animation-&gt;num_anim_commands; anim-&gt;state_id = tr_animation-&gt;state_id; anim-&gt;unknown = tr_animation-&gt;unknown; anim-&gt;unknown2 = tr_animation-&gt;unknown2; anim-&gt;frames_count = GetNumFramesForAnimation(tr, tr_moveable-&gt;animation_index+i); //Sys_DebugLog(LOG_FILENAME, "Anim[%d], %d", tr_moveable-&gt;animation_index, GetNumFramesForAnimation(tr, tr_moveable-&gt;animation_index)); // Parse AnimCommands // Max. amount of AnimCommands is 255, larger numbers are considered as 0. // See http://evpopov.com/dl/TR4format.html#Animations for details. if( (anim-&gt;num_anim_commands &gt; 0) &amp;&amp; (anim-&gt;num_anim_commands &lt;= 255) ) { // Calculate current animation anim command block offset. int16_t *pointer = world-&gt;anim_commands + anim-&gt;anim_command; for(uint32_t count = 0; count &lt; anim-&gt;num_anim_commands; count++, pointer++) { switch(*pointer) { case TR_ANIMCOMMAND_PLAYEFFECT: case TR_ANIMCOMMAND_PLAYSOUND: // Recalculate absolute frame number to relative. ///@FIXED: was unpredictable behavior. *(pointer + 1) -= tr_animation-&gt;frame_start; pointer += 2; break; case TR_ANIMCOMMAND_SETPOSITION: // Parse through 3 operands. pointer += 3; break; case TR_ANIMCOMMAND_JUMPDISTANCE: // Parse through 2 operands. pointer += 2; break; default: // All other commands have no operands. break; } } } if(anim-&gt;frames_count &lt;= 0) { /* * number of animations must be &gt;= 1, because frame contains base model offset */ anim-&gt;frames_count = 1; } anim-&gt;frames = (bone_frame_p)malloc(anim-&gt;frames_count * sizeof(bone_frame_t)); /* * let us begin to load animations */ bone_frame = anim-&gt;frames; frame = tr-&gt;frame_data + frame_offset; for(j=0;j&lt;anim-&gt;frames_count;j++,bone_frame++,frame_offset+=frame_step) { frame = tr-&gt;frame_data + frame_offset; bone_frame-&gt;bone_tag_count = model-&gt;mesh_count; bone_frame-&gt;bone_tags = (bone_tag_p)malloc(model-&gt;mesh_count * sizeof(bone_tag_t)); vec3_set_zero(bone_frame-&gt;pos); vec3_set_zero(bone_frame-&gt;move); bone_frame-&gt;v_Horizontal = 0.0; bone_frame-&gt;v_Vertical = 0.0; bone_frame-&gt;command = 0x00; GetBFrameBB_Pos(tr, frame_offset, bone_frame); if(frame_offset &lt; 0 || frame_offset &gt;= tr-&gt;frame_data_size) { //Con_Printf("Bad frame offset"); for(k=0;k&lt;bone_frame-&gt;bone_tag_count;k++) { tree_tag = model-&gt;mesh_tree + k; bone_tag = bone_frame-&gt;bone_tags + k; rot[0] = 0.0; rot[1] = 0.0; rot[2] = 0.0; vec4_SetTRRotations(bone_tag-&gt;qrotate, rot); vec3_copy(bone_tag-&gt;offset, tree_tag-&gt;offset); } } else { l = l_start; for(k=0;k&lt;bone_frame-&gt;bone_tag_count;k++) { tree_tag = model-&gt;mesh_tree + k; bone_tag = bone_frame-&gt;bone_tags + k; rot[0] = 0.0; rot[1] = 0.0; rot[2] = 0.0; vec4_SetTRRotations(bone_tag-&gt;qrotate, rot); vec3_copy(bone_tag-&gt;offset, tree_tag-&gt;offset); switch(tr-&gt;game_version) { case TR_I: /* TR_I */ case TR_I_UB: case TR_I_DEMO: temp2 = tr-&gt;frame_data[frame_offset + l]; l ++; temp1 = tr-&gt;frame_data[frame_offset + l]; l ++; rot[0] = (float)((temp1 &amp; 0x3ff0) &gt;&gt; 4); rot[2] =-(float)(((temp1 &amp; 0x000f) &lt;&lt; 6) | ((temp2 &amp; 0xfc00) &gt;&gt; 10)); rot[1] = (float)(temp2 &amp; 0x03ff); rot[0] *= 360.0 / 1024.0; rot[1] *= 360.0 / 1024.0; rot[2] *= 360.0 / 1024.0; vec4_SetTRRotations(bone_tag-&gt;qrotate, rot); break; default: /* TR_II + */ temp1 = tr-&gt;frame_data[frame_offset + l]; l ++; if(tr-&gt;game_version &gt;= TR_IV) { ang = (float)(temp1 &amp; 0x0fff); ang *= 360.0 / 4096.0; } else { ang = (float)(temp1 &amp; 0x03ff); ang *= 360.0 / 1024.0; } switch (temp1 &amp; 0xc000) { case 0x4000: // x only rot[0] = ang; rot[1] = 0; rot[2] = 0; vec4_SetTRRotations(bone_tag-&gt;qrotate, rot); break; case 0x8000: // y only rot[0] = 0; rot[1] = 0; rot[2] =-ang; vec4_SetTRRotations(bone_tag-&gt;qrotate, rot); break; case 0xc000: // z only rot[0] = 0; rot[1] = ang; rot[2] = 0; vec4_SetTRRotations(bone_tag-&gt;qrotate, rot); break; default: // all three temp2 = tr-&gt;frame_data[frame_offset + l]; rot[0] = (float)((temp1 &amp; 0x3ff0) &gt;&gt; 4); rot[2] =-(float)(((temp1 &amp; 0x000f) &lt;&lt; 6) | ((temp2 &amp; 0xfc00) &gt;&gt; 10)); rot[1] = (float)(temp2 &amp; 0x03ff); rot[0] *= 360.0 / 1024.0; rot[1] *= 360.0 / 1024.0; rot[2] *= 360.0 / 1024.0; vec4_SetTRRotations(bone_tag-&gt;qrotate, rot); l ++; break; }; break; }; } } } } /* * Animations interpolation to 1/30 sec like in original. Needed for correct state change works. */ SkeletalModel_InterpolateFrames(model); GenerateAnimCommandsTransform(model); /* * state change's loading */ #if LOG_ANIM_DISPATCHES if(model-&gt;animation_count &gt; 1) { Sys_DebugLog(LOG_FILENAME, "MODEL[%d], anims = %d", model_num, model-&gt;animation_count); } #endif anim = model-&gt;animations; for(i=0;i&lt;model-&gt;animation_count;i++,anim++) { anim-&gt;state_change_count = 0; anim-&gt;state_change = NULL; tr_animation = &amp;tr-&gt;animations[tr_moveable-&gt;animation_index+i]; j = (int)tr_animation-&gt;next_animation - (int)tr_moveable-&gt;animation_index; j &amp;= 0x7fff; if(j &gt;= 0 &amp;&amp; j &lt; model-&gt;animation_count) { anim-&gt;next_anim = model-&gt;animations + j; anim-&gt;next_frame = tr_animation-&gt;next_frame - tr-&gt;animations[tr_animation-&gt;next_animation].frame_start; anim-&gt;next_frame %= anim-&gt;next_anim-&gt;frames_count; if(anim-&gt;next_frame &lt; 0) { anim-&gt;next_frame = 0; } #if LOG_ANIM_DISPATCHES Sys_DebugLog(LOG_FILENAME, "ANIM[%d], next_anim = %d, next_frame = %d", i, anim-&gt;next_anim-&gt;id, anim-&gt;next_frame); #endif } else { anim-&gt;next_anim = NULL; anim-&gt;next_frame = 0; } anim-&gt;state_change_count = 0; anim-&gt;state_change = NULL; if((tr_animation-&gt;num_state_changes &gt; 0) &amp;&amp; (model-&gt;animation_count &gt; 1)) { state_change_p sch_p; #if LOG_ANIM_DISPATCHES Sys_DebugLog(LOG_FILENAME, "ANIM[%d], next_anim = %d, next_frame = %d", i, (anim-&gt;next_anim)?(anim-&gt;next_anim-&gt;id):(-1), anim-&gt;next_frame); #endif anim-&gt;state_change_count = tr_animation-&gt;num_state_changes; sch_p = anim-&gt;state_change = (state_change_p)malloc(tr_animation-&gt;num_state_changes * sizeof(state_change_t)); for(j=0;j&lt;tr_animation-&gt;num_state_changes;j++,sch_p++) { tr_state_change_t *tr_sch; tr_sch = &amp;tr-&gt;state_changes[j+tr_animation-&gt;state_change_offset]; sch_p-&gt;id = tr_sch-&gt;state_id; sch_p-&gt;anim_dispath = NULL; sch_p-&gt;anim_dispath_count = 0; for(l=0;l&lt;tr_sch-&gt;num_anim_dispatches;l++) { tr_anim_dispatch_t *tr_adisp = &amp;tr-&gt;anim_dispatches[tr_sch-&gt;anim_dispatch+l]; int next_anim = tr_adisp-&gt;next_animation &amp; 0x7fff; int next_anim_ind = next_anim - (tr_moveable-&gt;animation_index &amp; 0x7fff); if((next_anim_ind &gt;= 0) &amp;&amp;(next_anim_ind &lt; model-&gt;animation_count)) { sch_p-&gt;anim_dispath_count++; sch_p-&gt;anim_dispath = (anim_dispath_p)realloc(sch_p-&gt;anim_dispath, sch_p-&gt;anim_dispath_count * sizeof(anim_dispath_t)); anim_dispath_p adsp = sch_p-&gt;anim_dispath + sch_p-&gt;anim_dispath_count - 1; int next_frames_count = model-&gt;animations[next_anim - tr_moveable-&gt;animation_index].frames_count; int next_frame = tr_adisp-&gt;next_frame - tr-&gt;animations[next_anim].frame_start; int low = tr_adisp-&gt;low - tr_animation-&gt;frame_start; int high = tr_adisp-&gt;high - tr_animation-&gt;frame_start; adsp-&gt;frame_low = low % anim-&gt;frames_count; adsp-&gt;frame_high = (high - 1) % anim-&gt;frames_count; adsp-&gt;next_anim = next_anim - tr_moveable-&gt;animation_index; adsp-&gt;next_frame = next_frame % next_frames_count; #if LOG_ANIM_DISPATCHES Sys_DebugLog(LOG_FILENAME, "anim_disp[%d], frames_count = %d: interval[%d.. %d], next_anim = %d, next_frame = %d", l, anim-&gt;frames_count, adsp-&gt;frame_low, adsp-&gt;frame_high, adsp-&gt;next_anim, adsp-&gt;next_frame); #endif } } } } } }</span></span></code> </pre> <br><br><h5>  The publication </h5><br>  When the skeletal models started working, it was already possible to move on to their leveling and ‚Äúliven up‚Äù Lara, which required the presence of physics.  To begin with, it was decided to write my physics engine in order to become better acquainted with the topic and then more thoroughly approach the choice of ready-made products.  The first thing that is required to create a character controller is to define heights.  The function for determining the intersection of a triangle and a ray was originally written (based on a <a href="http://ray-tracing.ru/articles213.html">barycentric algorithm</a> ).  After that, such basic methods were added as the definition of the intersection of moving segments, a triangle and a sphere, a triangle and a triangle.  It should be noted that this approach eliminates the possibility of the appearance of the so-called ‚Äútunnel effect‚Äù (when due to high speed objects with high speeds can fly through each other without a collision), inherent to physical engines based on impulse. <br><br>  And Lara runs through the levels, even if bypassing all the steps of any size, but does not fall out of the map!  When the project was in such a state, I wrote to Anatoly Lwmte that it was cool that at least someone was interested in the first parts of the <a href="https://ru.wikipedia.org/wiki/Tomb_Raider_%2528%25D1%2581%25D0%25B5%25D1%2580%25D0%25B8%25D1%258F_%25D0%25B8%25D0%25B3%25D1%2580%2529">Tomb raider</a> .  Thus began the correspondence, thanks to which interest in the project began to reappear.  After I signed up for <a href="http://www.tombraiderforums.com/">tombraiderforums.com</a> (Anatoly was already there long enough, with his project to improve the fourth part of the <a href="https://ru.wikipedia.org/wiki/Tomb_Raider_%2528%25D1%2581%25D0%25B5%25D1%2580%25D0%25B8%25D1%258F_%25D0%25B8%25D0%25B3%25D1%2580%2529">Tomb raider</a> engine).  Thanks to him, a topic with <a href="http://www.tombraiderforums.com/showthread.php%3Ft%3D197508">my engine</a> and many improvements in the code appeared on this forum: sound manager, alteration of the state control system (before that I had a <i>switch</i> on animation numbers, now it is on state numbers), etc.  The presence of people interested in the project is well motivated to develop the project. <br><br><h5>  Physics + Renderer Optimization </h5><br>  Since I used my physics, and even with poor optimization, fps began to sink in some places.  By long picking various open source physics engines, the <a href="http://bulletphysics.org/wordpress/">bullet</a> was chosen.  First, I added a collision filter in the case of intersecting rooms.  The fact is that the design of the original levels allows the intersection of 2 or more completely different rooms in one place, while the objects of one room should not affect the objects of another;  similarly with rendering.  Currently, I try to bring the character controller to mind: eliminate the possibility of passage through walls (occurs in a series of animations against the wall) and finish the character's reaction and behavior in the case of climbing on walls and ceiling. <br><br>  Let's go back to OpenGL.  Initially, in the engine, polygons were <i>drawn</i> using <i>glVertex3fv</i> (...), etc .;  About the performance of this approach and the speed of the engine, we can say one thing: they are not.  Therefore, after studying the part concerning the <a href="http://steps3d.narod.ru/tutorials/tutorial-VBO.html">VBO</a> (Vertex Buffer Object), I did the optimization and began, if possible, to store the vertex data of the polygons in the video memory and draw the mesh in one go.  The speed has increased markedly.  However, because for one mesh, textures could lie in different pixel arrays, switching OpenGL textures was more often than necessary, and the fact that the textures of many different objects could be stored in one pixel array created ‚Äúartifacts‚Äù with anti-aliasing turned on.  Cochrane with <a href="http://www.tombraiderforums.com/">tombraiderforums.com</a> took up the renderer optimization and wrote a texture atlas with the boundaries between textures.  Thanks to this innovation, all level textures are stored in 1 - 2 OpenGL textures and anti-aliasing does not lead to the appearance of ‚Äúartifacts‚Äù.  In addition, he made the project port on MacOS. <br><br>  When there were no ideas at all for what and how to tackle the engine, I simply looked for errors in the code, corrected its structure or changed the plug-in libraries.  Thus, a ‚Äúrelocation‚Äù was carried out from <a href="http://www.libsdl.org/">SDL1 to SDL2</a> , from <a href="http://freetype.sourceforge.net/freetype1/index.html">freetype1</a> + <a href="http://gltt.sourceforge.net/">gltt</a> to <a href="http://freetype.sourceforge.net/freetype2/index.html">freetype2</a> + <a href="http://sourceforge.net/projects/ftgl/">ftgl</a> .  Similarly, I got the idea to add anti-aliasing to animations using spherical interpolation <a href="http://en.wikipedia.org/wiki/Slerp">slerp</a> .  Here I want to add: be attentive to mathematical algorithms, especially when it comes to "arches" (asin, acos, atan ...) - the loss of a sign is fraught with killer frames with a skewed and twisted skeleton.  I advise you to look at the implementation of the slerp source code bullet.  After adding anti-aliasing, I could no longer look at unsmoothed animations.  Then there was the need to load and play the sound, and then run through the levels in deathly silence is not very, though <a href="https://ru.wikipedia.org/wiki/Tomb_Raider_%2528%25D1%2581%25D0%25B5%25D1%2580%25D0%25B8%25D1%258F_%25D0%25B8%25D0%25B3%25D1%2580%2529">Tomb raider</a> . <br><br><h5>  Add sound </h5><br>  To use sound, using <a href="http://www.libsdl.org/">SDLAudio</a> + <a href="http://www.libsdl.org/projects/SDL_mixer/">SDLMixer is</a> completely inadequate, and to go into the audio stream conversion algorithms and make bicycles to create effects is a completely bad idea.  After consulting with Anatoly, it was decided to use <a href="http://sourceforge.net/projects/openal-soft/">OpenAL</a> .  Since I was guided by the fact that as much as possible of the platform-dependent code shifted to the <a href="http://www.libsdl.org/">SDL</a> , I did not invent anything better than writing the SDL_backend for <a href="http://sourceforge.net/projects/openal-soft/">OpenAL</a> .<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">However, it worked, I added a tool to the engine, and Anatoly made everything play when necessary, where necessary, and with the necessary effects. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And now it's time to revive all kinds of levers, traps and other triggers of the game world. In fact, the development here was based on logic: I need to implement something, what tools are needed for this, how to implement them. The main function used for script operation is to get a pointer to an object by a numeric id, then any </font></font><a href="http://www.lua.org/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LUA</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function can process all the necessary objects. To dynamically add and remove objects and the ability to quickly access them by id, I applied </font></font><a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D1%2580%25D0%25B0%25D1%2581%25D0%25BD%25D0%25BE-%25D1%2587%25D1%2591%25D1%2580%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25B4%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B2%25D0%25BE"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">red-black trees</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In theory, it was possible to apply a </font></font><a href="https://ru.wikipedia.org/wiki/%25D0%25A5%25D0%25B5%25D1%2588-%25D1%2582%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25B8%25D1%2586%25D0%25B0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hash table</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but then personal preferences were more likely to work.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a result, now the scripting system allows you to carry out practically any manipulations with objects and animations, create tasks (and timers based on them), pick up objects, press a growl and buttons, opening and closing doors thereby and not only. Thanks to the efforts of people from the </font></font><a href="http://www.tombraiderforums.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tombraiderforums.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> community, </font><a href="http://www.tombraiderforums.com/"><font style="vertical-align: inherit;">gameflow_manager</font></a><font style="vertical-align: inherit;"> was added, responsible for switching from one level to another, loading necessary scripts and screen savers, loading information about light sources and implementing a simple lightmap based on correcting vertex colors and a cmake script for building under OS Lunux .</font></font><br><br><h5>  Afterword </h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the end, I would like to draw attention to the fact that when you use third-party resources, it‚Äôs easier with tests and you don‚Äôt have to be loaded with content creation, but this places limitations on the architecture of the engine or makes it necessary to convert formats when loading in order to avoid cracking crutches inside game engine. And there </font><font style="vertical-align: inherit;">are a lot of </font><font style="vertical-align: inherit;">crutches in the original </font></font><a href="https://ru.wikipedia.org/wiki/Tomb_Raider_%2528%25D1%2581%25D0%25B5%25D1%2580%25D0%25B8%25D1%258F_%25D0%25B8%25D0%25B3%25D1%2580%2529"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tomb raider</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Further plans in the </font></font><a href="http://sourceforge.net/projects/opentomb/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">project</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are simple: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1) fix existing bugs, especially with physics, and expand the capabilities of the character controller; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2) ‚Äúrevive‚Äù the enemies on the maps, add AI and weapons; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3) expand the system for managing skeletal model animations to switch meshes;</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4) expand the capabilities of the scripting system and write key level scripts so that you can go through the normal game; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5) to improve the graphics in the game, add effects, but here I am counting on the help of more qualified OpenGL programmers; </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally, some videos with an example of the engine:</font></font><br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/Td7DEDrwxJ4%3Ffeature%3Doembed&amp;xid=25657,15700023,15700186,15700191,15700253&amp;usg=ALkJrhjGz1bgmIfgvhG_xg2_TZbTXG5N6g" frameborder="0" allowfullscreen=""></iframe><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/9m102yLd83c%3Ffeature%3Doembed&amp;xid=25657,15700023,15700186,15700191,15700253&amp;usg=ALkJrhiBwLOssoPVTeqpmxR8yAJsQO7yHg" frameborder="0" allowfullscreen=""></iframe><br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/239751/">https://habr.com/ru/post/239751/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../239739/index.html">Cray Inc launches new generation of supercomputers Cray X–°40</a></li>
<li><a href="../239741/index.html">How we opened and then closed the online store</a></li>
<li><a href="../239743/index.html">FuelWear: smart heated clothes won't keep you cold</a></li>
<li><a href="../239747/index.html">The life story of one software package in photos</a></li>
<li><a href="../239749/index.html">System-NS as it is</a></li>
<li><a href="../239753/index.html">FAQ about the work of the cellular network for the smallest</a></li>
<li><a href="../239755/index.html">Rosetta approaches the comet Churyumov Gerasimenko at a distance of 10 kilometers</a></li>
<li><a href="../239757/index.html">Creating PureView: how Zeiss helps us make cameras</a></li>
<li><a href="../239759/index.html">Next Thursday, nine in the evening: new iPads, Mac mini, Yosemite?</a></li>
<li><a href="../239761/index.html">"Photoshop" goes to the clouds: the main announcement from today's presentation of Adobe</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>