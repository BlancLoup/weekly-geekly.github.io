<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>HAProxy as LoadBalan—Åer for RDP truss. Reliable solution for $ 0</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quite by chance, in a passive search for an alternative to the outdated 2X-LoadBalancer and the heavy, incomprehensible Remote Connection Broker from ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>HAProxy as LoadBalan—Åer for RDP truss. Reliable solution for $ 0</h1><div class="post__text post__text-html js-mediator-article">  Quite by chance, in a passive search for an alternative to the outdated 2X-LoadBalancer and the heavy, incomprehensible Remote Connection Broker from MS, I came across HAProxy and his ability to proxy RDP traffic.  <s>In search results, haproxy is practically not issued as a proxy for RDP</s> .  Now suddenly he began to give out in batches.  However, commercial products with the same functionality, such as mentioned above, are worth decent money. <br><br>  In general, it seemed to me that this might be interesting to someone.  Therefore, I decided to highlight this decision.  Plus, at the end I will demonstrate the flexibility of using HAProxy, which is not the case for famous competitors. <br><a name="habracut"></a><br><h3>  How does it work in short </h3><br>  HAProxy can identify RDP, proxy it and parse rdp_cookie to get the necessary information from them and then use it in the routing mechanism. <br><br>  The client connects to the proxy, he pulls out the login from rdp_cookie, selects a server for it, writes the login - server values ‚Äã‚Äãto the stick-table and connects the user to the server. <br>  Accordingly, the next time the same client connects (with this login), the proxy finds an entry in the table and connects it to the server on which the user has an open session.  Brilliant and easy! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A stick-table is a table stored in the process memory, where for each record you can determine the lifetime.  Set 8 hours, and all day the client will fall on the same server. <br><br>  Below is the standard config: <br><br><pre><code class="hljs pgsql">#/usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/etc/haproxy.conf <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> daemon stats socket /var/run/haproxy.sock mode <span class="hljs-number"><span class="hljs-number">600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">level</span></span> <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span> stats timeout <span class="hljs-number"><span class="hljs-number">2</span></span>m defaults <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> mode tcp <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> tcplog <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> dontlognull frontend fr_rdp mode tcp bind *:<span class="hljs-number"><span class="hljs-number">3389</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span> rdp <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> tcplog tcp-request inspect-delay <span class="hljs-number"><span class="hljs-number">2</span></span>s tcp-request content accept <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> RDP_COOKIE default_backend BK_RDP backend BK_RDP mode tcp balance leastconn timeout <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>s timeout <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>s <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> tcplog stick-<span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> string len <span class="hljs-number"><span class="hljs-number">32</span></span> size <span class="hljs-number"><span class="hljs-number">10</span></span>k expire <span class="hljs-number"><span class="hljs-number">8</span></span>h stick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> rdp_cookie(mstshash),bytes(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>) stick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> rdp_cookie(mstshash) <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> tcp-<span class="hljs-keyword"><span class="hljs-keyword">check</span></span> tcp-<span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> port <span class="hljs-number"><span class="hljs-number">3389</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> inter <span class="hljs-number"><span class="hljs-number">3</span></span>s rise <span class="hljs-number"><span class="hljs-number">2</span></span> fall <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> TS01 <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span>:<span class="hljs-number"><span class="hljs-number">3389</span></span> weight <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> TS02 <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span>:<span class="hljs-number"><span class="hljs-number">3389</span></span> weight <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> TS03 <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span><span class="hljs-number"><span class="hljs-number">.13</span></span>:<span class="hljs-number"><span class="hljs-number">3389</span></span> weight <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> TS04 <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span><span class="hljs-number"><span class="hljs-number">.14</span></span>:<span class="hljs-number"><span class="hljs-number">3389</span></span> weight <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> TS05 <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span><span class="hljs-number"><span class="hljs-number">.15</span></span>:<span class="hljs-number"><span class="hljs-number">3389</span></span> weight <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> TS06 <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span><span class="hljs-number"><span class="hljs-number">.16</span></span>:<span class="hljs-number"><span class="hljs-number">3389</span></span> weight <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> TS07 <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span><span class="hljs-number"><span class="hljs-number">.17</span></span>:<span class="hljs-number"><span class="hljs-number">3389</span></span> weight <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> TS08 <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span><span class="hljs-number"><span class="hljs-number">.18</span></span>:<span class="hljs-number"><span class="hljs-number">3389</span></span> weight <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> stats bind *:<span class="hljs-number"><span class="hljs-number">9000</span></span> mode http stats <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> #stats hide-<span class="hljs-keyword"><span class="hljs-keyword">version</span></span> stats <span class="hljs-keyword"><span class="hljs-keyword">show</span></span>-node stats realm Haproxy\ <span class="hljs-keyword"><span class="hljs-keyword">Statistics</span></span> stats uri /</code> </pre> <br><h2>  Difficulties </h2><br>  Since the stick-table is located in memory, when the process is restarted, all information about client-server pairs is lost, and this is critical information in our case.  To get out of the situation, I wrote a scripter that I use to restart the process.  Before stopping the process, the script drops the stick-table to a file, then, after starting the process, writes data back (current sessions do not terminate): <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python import sys import socket import re import subprocess haproxyConf = '/usr/local/etc/haproxy.conf' def restart(): backends = [] with open(haproxyConf) as f: for line in f: lines = line.split(' ') if lines[0] == 'backend': backends.append(lines[1].strip('\n')) for backend in backends: getDataTables(backend) rebootHa() for backend in backends: insertDataTables(backend) # Writes data from stik-tables to external files def getDataTables(table): print table tmp_f = open('/tmp/tmp.' + table,'w') tableVal = {} c = socket.socket( socket.AF_UNIX ) c.connect("/var/run/haproxy.sock") c.send("prompt\r\n") c.send("show table " + table + "\r\n") d = c.recv(10240) for line in d.split('\n'): if re.search('^[a-zA-Z_0-9]',line): line = line.split(' ') del line[0] for item in line: key = item.split('=')[0] val = item.split('=')[1] tableVal[key] = val print tableVal['key'] print tableVal['server_id'] tmp_f.write(tableVal['key'] + ',' + tableVal['server_id'] + '\n') tmp_f.close() def rebootHa(): subprocess.call("/usr/local/etc/rc.d/haproxy reload", shell=True) # Writes data from files to stik-tables def insertDataTables(table): tmp_f = open('/tmp/tmp.' + table,'r') c = socket.socket( socket.AF_UNIX ) c.connect("/var/run/haproxy.sock") c.send("prompt\r\n") for line in tmp_f: line = line.split(',') print "set table " + table + " key " + line[0] + " data.server_id " + line[1] c.send("set table " + table + " key " + line[0] + " data.server_id " + line[1] +"\r\n") c.recv(10240) c.close() restart()</span></span></code> </pre><br><h3>  What else? </h3><br>  You can also flexibly control which servers to proxy for certain clients.  This can be done on the basis of the login, ip address, network, time of day, etc. <br>  I will give an example of how, based on groups from AD, you can split farm servers by departments, for example: <br><br>  two servers for Accounting <br>  two servers for marketing <br>  two servers for Sales Representatives <br>  two for everyone else. <br><br>  It is clear that in each group of servers there can be different capacities: installed software and some specific settings, so we will separate them. <br><br>  HAProxy allows, based on certain policies, to flexibly determine which server to connect a user to, having one entry point for all RDP connections (which is undoubtedly convenient). <br><br>  To do this, you need to slightly modify the HAProxy config and reload script: <br><br><pre> <code class="hljs pgsql">#/usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/etc/haproxy.conf <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> daemon stats socket /var/run/haproxy.sock mode <span class="hljs-number"><span class="hljs-number">600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">level</span></span> <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span> stats timeout <span class="hljs-number"><span class="hljs-number">2</span></span>m defaults <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> mode tcp <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> tcplog <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> dontlognull frontend fr_rdp mode tcp bind *:<span class="hljs-number"><span class="hljs-number">3389</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span> rdp #timeout client <span class="hljs-number"><span class="hljs-number">1</span></span>h <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> tcplog tcp-request inspect-delay <span class="hljs-number"><span class="hljs-number">2</span></span>s tcp-request content accept <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> RDP_COOKIE acl Accounting_ACL rdp_cookie(mstshash),bytes(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>) -m str -i -f /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/etc/haproxy/Accounting acl Marketing_ACL rdp_cookie(mstshash),bytes(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>) -m str -i -f /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/etc/haproxy/Marketing acl Sales_ACL rdp_cookie(mstshash),bytes(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>) -m str -i -f /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/etc/haproxy/Sales use_backend Accounting_BK <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Accounting_ACL use_backend Marketing_BK <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Marketing_ACL use_backend Sales_BK <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Sales_ACL default_backend DF_RDP backend DF_RDP mode tcp balance leastconn <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> tcplog stick-<span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> string len <span class="hljs-number"><span class="hljs-number">32</span></span> size <span class="hljs-number"><span class="hljs-number">10</span></span>k expire <span class="hljs-number"><span class="hljs-number">8</span></span>h stick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> rdp_cookie(mstshash),bytes(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> tcp-<span class="hljs-keyword"><span class="hljs-keyword">check</span></span> tcp-<span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> port <span class="hljs-number"><span class="hljs-number">3389</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> inter <span class="hljs-number"><span class="hljs-number">3</span></span>s rise <span class="hljs-number"><span class="hljs-number">2</span></span> fall <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> TS01 <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span>:<span class="hljs-number"><span class="hljs-number">3389</span></span> weight <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> TS02 <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span>:<span class="hljs-number"><span class="hljs-number">3389</span></span> weight <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> backend Accounting_BK mode tcp balance leastconn <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> stick-<span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> string len <span class="hljs-number"><span class="hljs-number">32</span></span> size <span class="hljs-number"><span class="hljs-number">10</span></span>k expire <span class="hljs-number"><span class="hljs-number">8</span></span>h stick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> rdp_cookie(mstshash),bytes(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> tcplog tcp-<span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> port <span class="hljs-number"><span class="hljs-number">3389</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> inter <span class="hljs-number"><span class="hljs-number">3</span></span>s rise <span class="hljs-number"><span class="hljs-number">2</span></span> fall <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> TS03 <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span><span class="hljs-number"><span class="hljs-number">.13</span></span>:<span class="hljs-number"><span class="hljs-number">3389</span></span> weight <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> TS04 <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span><span class="hljs-number"><span class="hljs-number">.14</span></span>:<span class="hljs-number"><span class="hljs-number">3389</span></span> weight <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> backend Marketing_BK mode tcp balance leastconn <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> stick-<span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> string len <span class="hljs-number"><span class="hljs-number">32</span></span> size <span class="hljs-number"><span class="hljs-number">10</span></span>k expire <span class="hljs-number"><span class="hljs-number">8</span></span>h stick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> rdp_cookie(mstshash),bytes(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> tcplog tcp-<span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> port <span class="hljs-number"><span class="hljs-number">3389</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> inter <span class="hljs-number"><span class="hljs-number">3</span></span>s rise <span class="hljs-number"><span class="hljs-number">2</span></span> fall <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> TS05 <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span><span class="hljs-number"><span class="hljs-number">.15</span></span>:<span class="hljs-number"><span class="hljs-number">3389</span></span> weight <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> TS06 <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span><span class="hljs-number"><span class="hljs-number">.16</span></span>:<span class="hljs-number"><span class="hljs-number">3389</span></span> weight <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> backend Sales_BK mode tcp balance leastconn <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> stick-<span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> string len <span class="hljs-number"><span class="hljs-number">32</span></span> size <span class="hljs-number"><span class="hljs-number">10</span></span>k expire <span class="hljs-number"><span class="hljs-number">8</span></span>h stick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> rdp_cookie(mstshash),bytes(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> tcplog tcp-<span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> port <span class="hljs-number"><span class="hljs-number">3389</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> inter <span class="hljs-number"><span class="hljs-number">3</span></span>s rise <span class="hljs-number"><span class="hljs-number">2</span></span> fall <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> TS07 <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span><span class="hljs-number"><span class="hljs-number">.17</span></span>:<span class="hljs-number"><span class="hljs-number">3389</span></span> weight <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> TS08 <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span><span class="hljs-number"><span class="hljs-number">.18</span></span>:<span class="hljs-number"><span class="hljs-number">3389</span></span> weight <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> stats bind *:<span class="hljs-number"><span class="hljs-number">9000</span></span> mode http stats <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> #stats hide-<span class="hljs-keyword"><span class="hljs-keyword">version</span></span> stats <span class="hljs-keyword"><span class="hljs-keyword">show</span></span>-node stats realm Haproxy\ <span class="hljs-keyword"><span class="hljs-keyword">Statistics</span></span> stats uri /</code> </pre><br>  modified reload script: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python import sys import ldap import socket import re import subprocess ldapDomain = '' ldapUser = '' ldapPass = '' ldapDN = '' # OU=GROUPS,DC=domain,DC=tld' haproxyConf = '/usr/local/etc/haproxy.conf' action = sys.argv[1] # Get users from Active Directory Groups and store it to files def getADGroups(): l = ldap.open(ldapDomain) l.simple_bind_s(ldapUser,ldapPass) f = open('/usr/local/etc/haproxy/' + groupName,'w') results = l.search_s("cn=%s, %s" % (groupName, ldapDN), ldap.SCOPE_BASE) for result in results: result_dn = result[0] result_attrs = result[1] if "member" in result_attrs: for member in result_attrs["member"]: f.write(member.split(',')[0].split('=')[1] + '\n') f.close() restart() # Searching stik-tables to save it and to restore after reload def restart(): backends = [] with open(haproxyConf) as f: for line in f: lines = line.split(' ') if lines[0] == 'backend': backends.append(lines[1].strip('\n')) for backend in backends: getDataTables(backend) rebootHa() for backend in backends: insertDataTables(backend) # Writes data from stik-tables to external files def getDataTables(table): print table tmp_f = open('/tmp/tmp.' + table,'w') tableVal = {} c = socket.socket( socket.AF_UNIX ) c.connect("/var/run/haproxy.sock") c.send("prompt\r\n") c.send("show table " + table + "\r\n") d = c.recv(10240) for line in d.split('\n'): if re.search('^[a-zA-Z_0-9]',line): line = line.split(' ') del line[0] for item in line: key = item.split('=')[0] val = item.split('=')[1] tableVal[key] = val print tableVal['key'] print tableVal['server_id'] tmp_f.write(tableVal['key'] + ',' + tableVal['server_id'] + '\n') tmp_f.close() def rebootHa(): #pass subprocess.call("/usr/local/etc/rc.d/haproxy reload", shell=True) # Writes data from files to stik-tables def insertDataTables(table): #pass tmp_f = open('/tmp/tmp.' + table,'r') #tableVal = {} c = socket.socket( socket.AF_UNIX ) c.connect("/var/run/haproxy.sock") c.send("prompt\r\n") for line in tmp_f: line = line.split(',') print "set table " + table + " key " + line[0] + " data.server_id " + line[1] c.send("set table " + table + " key " + line[0] + " data.server_id " + line[1] +"\r\n") c.recv(10240) c.close() if action == 'restart': restart() if action == 'group': groupName = sys.argv[2] getADGroups()</span></span></code> </pre><br>  How it works: <br>  Groups are created in AD (and surely such groups already exist) Accounts, Marketing and Sales, employees are placed in these groups.  The script connects to AD and gets a list of employees for the selected groups.  The list of employees is saved to a file with the name of the group. <br><br>  In the HAProxy config, the ACL source is configured by these group files.  If a new employee is added to a group, you must run a script to update the group file. <br><br>  The proxy checks if there is a login in the specified file.  If there is, sends to the backend defined for this group.  Everything is very simple! <br><br>  Script launch options: <br>  haproxy.py group group_name - group reloads, current sessions do not terminate. <br>  haproxy.py restart - restart the process (re-read the config), while the current sessions do not terminate. <br><br><h3>  fault tolerance </h3><br>  She is not! <br><br>  In this example, the solution does not have any fault tolerance. <br><br>  Firstly, haproxy is not reserved. <br><br>  Secondly, the solution with recording client-server values ‚Äã‚Äãin the stick-table does not allow haproxy to connect users to live servers whose records are already in the table and the server to which they were connected is currently unavailable.  He will stupidly try to send them to the server from the table, despite the fact that he is not online. <br><br>  First, haproxy reservations can be done in various ways. <br><br>  <s>One of them is a modified reload script.</s>  <s>You can add to it the copying and loading of the saved tables on another haproxy, with the launch of this script periodically according to the crown.</s> <br>  Thanks <a href="https://habrahabr.ru/users/vasilevkirill/" class="user_link">vasilevkirill</a> , there is a built-in solution, which he shared in the comments <br>  <a href="https://habrahabr.ru/post/335872/">habrahabr.ru/post/335872/#comment_10369854</a> <br><br>  The second is harder.  We need a mechanism that would determine exactly what is with the server.  The server may for some legal and not very reasons not be available on the network for some time, say 1 minute, for example.  But at the same time have open all RDP sessions.  And if we decide that the server is no longer available, and we need to switch all users to other servers, we can get unsaved data, customers may lose a large amount of work, and so on. <br><br>  Technically, it is not difficult to implement stick-table cleaning.  To monitor the status of servers, you can use various monitoring systems.  In the same Zabbix, local scripts can be called on events. In our case, you can call the stick-table cleanup script. <br><br>  In conclusion, given the shortcomings that I have indicated above, HAProxy works very stably and reliably. </div><p>Source: <a href="https://habr.com/ru/post/335872/">https://habr.com/ru/post/335872/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335856/index.html">EntityFramework: (anti) Repository pattern</a></li>
<li><a href="../335858/index.html">Why not rely on user error reports</a></li>
<li><a href="../335866/index.html">Memoization and Currying (Python)</a></li>
<li><a href="../335868/index.html">Redux store: horizontal expansion</a></li>
<li><a href="../335870/index.html">What is DNSBL and how can you not get there</a></li>
<li><a href="../335874/index.html">How we migrated from InboxSDK to Gmail.js</a></li>
<li><a href="../335876/index.html">Traveling over the hill and back: how not to get a job abroad</a></li>
<li><a href="../335878/index.html">Pragmatic functional programming</a></li>
<li><a href="../335880/index.html">Nodebackup - saving data from containers (docker) and the rest</a></li>
<li><a href="../335882/index.html">Counting the number of links to an entry in the table via Foreign Keys</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>