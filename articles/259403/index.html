<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Increase performance with SO_REUSEPORT in NGINX 1.9.1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="NGINX version 1.9.1 introduces a new feature that allows you to use the SO_REUSEPORT socket option, which is available in modern versions of operating...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Increase performance with SO_REUSEPORT in NGINX 1.9.1</h1><div class="post__text post__text-html js-mediator-article"> NGINX version 1.9.1 introduces a new feature that allows you to use the <code>SO_REUSEPORT</code> socket option, which is available in modern versions of operating systems such as DragonFly BSD and Linux (kernels 3.9 and newer).  This option allows you to open several listening sockets at the same address and port at once.  At the same time, the kernel will distribute incoming connections between them. <br><a name="habracut"></a><br>  (In NGINX Plus, this functionality will appear in release 7, which will be released later this year.) <br><br>  The <code>SO_REUSEPORT</code> has many potential applications for solving various problems.  So, some applications can use it to update executable code on the fly (NGINX has always had <a href="http://nginx.org/ru/docs/control.html">this capability</a> from time immemorial using a different mechanism).  In NGINX, enabling this option increases performance in some cases by reducing locks on the locks. <br><br>  As shown in the figure, without <code>SO_REUSEPORT</code> one listening socket is divided between multiple workflows, and each of them tries to accept new connections from it: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/files/cce/f22/52e/ccef2252e21e4f01b4825b301c6471a8.png"></div><br><br>  With the <code>SO_REUSEPORT</code> option, we have a lot of listening sockets, one for each workflow.  The kernel of the operating system distributes to which of them a new connection falls (and thus which of the working processes will eventually receive it): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e59/bd5/7f2/e59bd57f2c4c457d93d1c655988bccba.png"></div><br><br>  This allows for multi-core systems to reduce blocking when multiple workflows simultaneously accept connections.  However, this also means that when one of the workflows is blocked by a long operation, this will affect not only the connections that it already processes, but also those that are still waiting in the queue. <br><br><h2>  Configuration </h2><br>  To enable <code>SO_REUSEPORT</code> in <code>http</code> or <code>stream</code> modules, it is enough to specify the <code>reuseport</code> directive parameter in the example, as shown in the example: <br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">http</span></span> { <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> reuseport; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> example.org; ... } } <span class="hljs-section"><span class="hljs-section">stream</span></span> { <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">12345</span></span> reuseport; ... } }</code> </pre><br>  Specifying <code>reuseport</code> will automatically disable <code>accept_mutex</code> for this socket, since no mutex is needed in this mode. <br><br><h2>  Testing performance with <code>reuseport</code> </h2><br>  Measurements were made using <a href="https://github.com/wg/wrk">wrk</a> using 4 NGINX workflows on the 36th nuclear AWS instance.  To minimize network costs, the client and server worked through a loopback interface, and NGINX was configured to return the <code>OK</code> string.  Three configurations were compared: with <code>accept_mutex on</code> (default), with <code>accept_mutex off</code> and with <code>reuseport</code> .  As can be seen in the diagram, the inclusion of <code>reuseport</code> increases the number of requests per second by 2-3 times and reduces delays, as well as their fluctuations. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d9f/f9c/a12/d9ff9ca1299db0f05135971680e17f95.png"></div><br><br>  Measurements were also taken when the client and server were running on different machines and an html file was requested.  As can be seen from the table, with <code>reuseport</code> there is a decrease in delays, similar to the previous measurement, and their spread decreases even more (almost by an order of magnitude).  Other tests also show good results from using the option.  Using <code>reuseport</code> load was distributed evenly across workflows.  With the <code>accept_mutex</code> directive <code>accept_mutex</code> there was an imbalance at the beginning of the test, and in the event of a shutdown, all workflows took up more CPU time. <br><br><table><tbody><tr><th></th><th>  Latency (ms) </th><th>  Latency stdev (ms) </th><th>  CPU Load </th></tr><tr><th>  Default </th><td>  15.65 </td><td>  26.59 </td><td>  0.3 </td></tr><tr><th>  accept_mutex off </th><td>  15.59 </td><td>  26.48 </td><td>  ten </td></tr><tr><th>  reuseport </th><td>  12.35 </td><td>  3.15 </td><td>  0.3 </td></tr></tbody></table><br>  In these tests, the frequency of requests was extremely high, and they did not require any complex processing.  Various observations confirm that the greatest effect of using the <code>reuseport</code> option <code>reuseport</code> achieved when the load responds to this pattern.  Thus, the <code>reuseport</code> option <code>reuseport</code> not available for the <code>mail</code> module, since mail traffic definitely does not meet these conditions.  We recommend that everyone make their own measurements to ensure that the effect of the <code>reuseport</code> , and not blindly turn on the option wherever possible.  Some tips on testing the performance of NGINX can be found in the <a href="http://www.youtube.com/watch%3Fv%3DeLW_NSuwYU0">speech of</a> Konstantin Pavlov at the nginx.conf 2014 conference. <br><br><h2>  Thanks </h2><br>  Thanks to Sepherosa Ziehau and Yingqi Lu, each of whom proposed their own solution for running <code>SO_REUSEPORT</code> in NGINX.  The NGINX team used their ideas for implementation, which we consider to be ideal. </div><p>Source: <a href="https://habr.com/ru/post/259403/">https://habr.com/ru/post/259403/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259391/index.html">How to organize interaction of processes in Oracle BPM</a></li>
<li><a href="../259393/index.html">Skype Skype for Windows and Mac OS DoS Exploit</a></li>
<li><a href="../259397/index.html">AI, BigData & HPC Digest # 1 (May 7 - June 3)</a></li>
<li><a href="../259399/index.html">FastNetMon 1.1.2 release for open DoS / DDoS attack monitoring solution</a></li>
<li><a href="../259401/index.html">Forwarding several identical USB devices to virtual machine libvirt + QEMU</a></li>
<li><a href="../259405/index.html">Reverse engineering flashing LED (+ RGB)</a></li>
<li><a href="../259409/index.html">CLRium # 2 Workshop Videos</a></li>
<li><a href="../259411/index.html">Uptime Institute introduced a new data center certification system</a></li>
<li><a href="../259413/index.html">Wargaming: rear - front! Find out what your tank has under the hood. Python Video with DevConf 2014</a></li>
<li><a href="../259415/index.html">‚ÄúWe can test Java better than Oracle‚Äù - an interview with Andrey Pangin from Odnoklassniki</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>