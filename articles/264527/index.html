<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>EXTREME'AL LACP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The devil is in the details - I always remember this when I deal with something new. A new software or a new piece of hardware can be all cool, both t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>EXTREME'AL LACP</h1><div class="post__text post__text-html js-mediator-article">  The devil is in the details - I always remember this when I deal with something new.  A new software or a new piece of hardware can be all cool, both technically and economically, but there is sure to be such a trifle that seems to be unprincipled, but it drinks a lot of blood.  That's about some of these insatiable little things in the network equipment Extreme Networks and I want to tell under the cut. <br><br> <a href="http://habrahabr.ru/company/ivi/blog/264527/"><img src="https://habrastorage.org/files/bee/8cb/569/bee8cb5696ff40188d1e6b4cbd512497.jpg"></a> <br><a name="habracut"></a><br><h2>  <font color="#fd004c">Snack</font> </h2><br>  <a href="http://www.extremenetworks.com/product/summit-x670-series">Extreme Summit X670V-48x</a> switches are used as aggregation switches in our Moscow network.  For reliability, they are enclosed through VIM4-40G4X modules (these are 4 ports on 40G-ethernet).  Now there are 2 chassis in each stack, but there are already tickets to add a third one. <br><br><img src="https://habrastorage.org/files/df7/415/dd7/df7415dd733b4495a20c8ce06a97f20d.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Accordingly, all links are evenly distributed (i.e., halved) between the two chassis and aggregated using LACP.  If something happens to one chassis, we will get degradation along the strip, but the service will continue. <br><br><h2>  <font color="#fd004c">The first</font> </h2><br>  The first thing we dug into, transferring the load to Extreme, was such a thing.  We switch the provider - the physics has risen, but the LACP is not going to.  That's all right, but confused - no.  Exactly the same settings in the direction of another provider - everything works there.  And then - even kicked with your feet ... It would be possible to lose a lot of time for disassembling with support, but colleagues from AS8359 helped out: Andrei and Pavel.  Quickly recommended line: <br><br><pre><code class="hljs pgsql">configure sharing <span class="hljs-number"><span class="hljs-number">1</span></span> lacp <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>-priority <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  It helped.  The strangest thing in this business is that the problem does not occur with all partners.  With our tsiski - no problem, but if on the other side of the ASR9000 - most likely there will be a problem.  But not always.  In general, to understand laziness.  Memorized and repeated as a mantra. <br><br><h2>  <font color="#fd004c">The second</font> </h2><br>  The switches are 10-gigabit, and the traffic is much more.  Therefore, we have many aggregated links (LAG).  Well, inside LAG you need to balance, and to do it in such a way that all legs would be used as evenly as possible, because it is very unpleasant to rest with one foot.  So while there were 8 legs in one LAG, everything was fine, but suddenly one lambda jumped up and fell.  We always have a reserve for the cumulative lane, losing one dozen is not a problem.  But in a strange way, evenly filled legs exfoliated.  Some have risen higher (this is expected), others have declined.  Oops! <br><br>  The first time did not have time to understand - they repaired the victim, everything returned to normal.  But the sediment remained.  The next time we returned to this question, when we added two more lambdas.  Look - again a bundle.  Turning off the "extra" two pieces - everything is smooth.  Turn on - guard!  It was experimentally verified that delamination occurs if the number of active legs in a LAG is not a power of 2. <br><br>  Thoughtful, talked with support.  And they say: use custom.  Frankly, I did not believe it, because if you believe the documentation, the custom with the default settings is completely equal to L3_L4.  I was convinced by colleagues from MSK-IX, who had already fought this problem out. <br><br>  We reconfigured our LAGs to use the custom method, and now we have the balancing uniformity independent of the number of active legs in the LAG.  To do this, however, I had to delete the old settings and create the LAG again, because the balancing algorithm is set only at the moment of creating the LAG.  But when did it scare us? <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">enable</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sharing</span></span> 1<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">grouping</span></span> 1<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1-5</span></span>, 2<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1-5</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">algorithm</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">address-based</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">custom</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lacp</span></span></code> </pre><br><h2>  <font color="#fd004c">Dessert</font> </h2><br>  For dessert, left my favorite :) Port-channel.  How is port aggregation done on all tsiska?  A special port is created - the Port-channel, it is configured, enabled.  Then physical ports are added to it (configuration is not quite true, but now it does not matter).  It was necessary to add - add!  There were extra - delete.  Any.  Conveniently, damn it! <br><br>  In XOS, the story is different: the LAG configuration is tied to one of the physical ports (it becomes the config master).  Such a port must be a member of LAG.  I can add and remove ports as many as I need, unless the config master is moved.  But if you need to move the last (master) port, that's all.  The only option is to delete one sharing and create a new one.  Upsik ... <br><br>  As in any decent office, we love to redo it for ourselves.  For various reasons, but we have enough housekeeping.  Accordingly, we have several times perfectly applied to this rake.  I will not speak for other members of our team, but I personally did not like it. <br><br>  Judge for yourself: the port must be configured with VLANs (by the way, in the EXTREME'al ideology, not vlan are hung on the port, but ports are on the vlan. Accordingly, you cannot hang the entire list of vlan on the port on one line), STP (officers, keep silence! ) and other disgraces.  The stump is clear that with such a volume of settings it is a mistake - how to send a couple of bytes.  In general, where are you, my favorite cisco-style portchannels?  However, not everything is so bad.  If the config master port goes to down, then the LAG itself remains alive (otherwise it would be quite x ... bad).  Even when we disconnected the chassis that the config master is on, everything continued to work.  Well, at least so ... <br><br>  From hopelessness, I discovered feature-request FR4-4584728621 last year.  As you know, not implemented.  And there is no certainty that the manufacturer thought about it at all. <br><br>  Salvation of drowning people is the work of drowning people themselves.  I once looked at one portchennel on a tsiska: <br><br><pre> <code class="hljs vhdl">#sh int po1 eth <span class="hljs-keyword"><span class="hljs-keyword">Port</span></span>-channel1 (Primary aggregator) Age <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">Port</span></span>-channel = <span class="hljs-number"><span class="hljs-number">174</span></span>d:<span class="hljs-number"><span class="hljs-number">06</span></span>h:<span class="hljs-number"><span class="hljs-number">35</span></span>m:<span class="hljs-number"><span class="hljs-number">37</span></span>s Logical slot/<span class="hljs-keyword"><span class="hljs-keyword">port</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> ports = <span class="hljs-number"><span class="hljs-number">4</span></span> HotStandBy <span class="hljs-keyword"><span class="hljs-keyword">port</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Port</span></span> state = <span class="hljs-keyword"><span class="hljs-keyword">Port</span></span>-channel Ag-Inuse Protocol = LACP <span class="hljs-keyword"><span class="hljs-keyword">Port</span></span> security = Disabled</code> </pre><br>  And noticed a beautiful line of Logical Slot / Port.  "Oh," I said.  From where on this not stacked non-expandable tsiska the second slot ?!  When I realized that this is a logical slot, I was born PLAN! <br><br>  And what if you use such a port as a config master port that will never be used?  No, we are sorry for the ports purchased, so they will all be used.  What about a non-existent port?  This, which is on the slot (in the stack), which is not.  Then we do not care which ports are included in a specific LAG.  All the settings we will do on this virtual slot.  Add and remove ports from it as needed.  Yes, we will reduce the number of chassis in one stack, but have you seen so many stacks of 8 chassis?  I did not see 3 thicker. <br><br>  Then everything turns out just.  We declare a virtual slot, take as many ports as possible (we will announce all LAG on its ports) and go ahead! <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">configure</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">slot</span></span> 8 <span class="hljs-selector-tag"><span class="hljs-selector-tag">module</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">X670V-48x</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">enable</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sharing</span></span> 8<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">grouping</span></span> 8<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span>, 1<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1-5</span></span>, 2<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1-5</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">algorithm</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">address-based</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">custom</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lacp</span></span></code> </pre><br>  To add new ports: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">configure</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sharing</span></span> 8<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ports</span></span> 1<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:48</span></span>, 2<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:48</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">enable</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ports</span></span> 1<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:48</span></span>, 2<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:48</span></span></code> </pre><br>  Now you can safely switch to new ports.  LACP will be active all the time.  And then we clean the old ports so that they can be used for what is a thread: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">disable</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ports</span></span> 1<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span>, 2<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">configure</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sharing</span></span> 8<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">delete</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ports</span></span> 1<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span>, 2<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span></code> </pre><br>  Fluent testing in the lab showed the vitality of the idea.  But I warn you at once: while in battle, we did not exploit it, although there is already an introduction ticket. <br><br>  I tried to reach the developers and made a <a href="https://community.extremenetworks.com/extreme/topics/virtual-slot-as-a-config-master-for-lacp-sharing">topic</a> on the <a href="https://community.extremenetworks.com/extreme/topics/virtual-slot-as-a-config-master-for-lacp-sharing">Extreme forum</a> .  You can read the answers yourself. <br><br>  It seems to me that making a command line interface that would allow conveniently working with LAG should be relatively simple, given that there are built-in mechanisms.  I think, just all networkers suffer over this problem in splendid isolation, so I propose to raise the degree of this problem.  If you are an Extreme user, contact support.  Refer to the specified FR and require topping up the foam after the beer has settled.  Write in the given forum thread everything you think about the manufacturer.  Let it be such a network flash mob. <br><br><img src="https://habrastorage.org/files/8bd/1e4/d90/8bd1e4d901ef4fb49652169a74f5cadb.jpg"><br><br>  Our previous publications: <br>  <font color="#fd004c">¬ª</font> <a href="http://habrahabr.ru/company/ivi/blog/256365/">Implementing a secure VPN protocol</a> <br>  <font color="#fd004c">¬ª</font> <a href="http://habrahabr.ru/company/ivi/blog/257431/">Implement an even more secure VPN protocol</a> <br>  <font color="#fd004c">"</font> <a href="http://habrahabr.ru/company/ivi/blog/240237/">Unnecessary items or how we balance between servers</a> <br>  <font color="#fd004c">¬ª</font> <a href="http://habrahabr.ru/company/ivi/blog/249359/">Blowfish on guard ivi</a> <br>  <font color="#fd004c">¬ª</font> <a href="http://habrahabr.ru/post/247813/">Non-personalized recommendations: the association method</a> <br>  <font color="#fd004c">"</font> <a href="http://habrahabr.ru/post/237349/">By cities and villages or as we balance between CDN nodes</a> <br>  <font color="#fd004c">"</font> <a href="http://habrahabr.ru/post/236253/" title="b706a658aa01">I am Groot.</a>  <a href="http://habrahabr.ru/post/236253/" title="b706a658aa01">We do our analytics on events</a> <br>  <font color="#fd004c">¬ª</font> <a href="http://habrahabr.ru/post/236065/">All on one or as we built CDN</a> </div><p>Source: <a href="https://habr.com/ru/post/264527/">https://habr.com/ru/post/264527/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264517/index.html">The notorious programmer: life hacking firsthand</a></li>
<li><a href="../264519/index.html">Tutorial: Interactive SVG Cartogram Component for InstantCMS 2</a></li>
<li><a href="../264521/index.html">Treacherous router or why ports need to open</a></li>
<li><a href="../264523/index.html">How Easter eggs in email helped the company draw attention to its conference</a></li>
<li><a href="../264525/index.html">Free IBM Bluemix Developer Resources</a></li>
<li><a href="../264531/index.html">ASR and TTS technologies for an application programmer: theoretical minimum</a></li>
<li><a href="../264535/index.html">Android Devs Meetup 2: videos and presentations from the last meeting</a></li>
<li><a href="../264539/index.html">Check or not check - that is the question</a></li>
<li><a href="../264541/index.html">Kali Linux 2.0</a></li>
<li><a href="../264543/index.html">Work with Queues and other Call Center features</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>