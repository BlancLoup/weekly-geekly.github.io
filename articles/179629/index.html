<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Battle of balancers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚ÄúBattle of balancers‚Äù is a load test of balancers / proxies that support WebSockets. These technologies are indispensable when scaling infrastructure....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Battle of balancers</h1><div class="post__text post__text-html js-mediator-article">  ‚ÄúBattle of balancers‚Äù is a load test of balancers / proxies that support WebSockets.  These technologies are indispensable when scaling infrastructure. <br><br>  The following technologies were tested: <br><br>  - <a href="http-proxy/">http-proxy</a> , version: 0.10.0 <br>  - <a href="http://haproxy.1wt.eu/">HAProxy</a> , version: 1.5-dev18 (development release) <br>  - elementary ‚Äúecho server‚Äù, for the control test. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There were doubts about the <a href="https://github.com/dotcloud/hipache">hipache</a> .  The reason why it was excluded is simple - it is built on the basis of <a href="">http-proxy</a> .  At the moment they are using a fork project, in which there are simply no patches related to performance. <br><a name="habracut"></a><br>  For testing, 3 different unrelated servers were used, all hosted on a <a href="http://joyent.com/">joyent</a> . <br><br>  1. Proxy, 512Mb, Ubuntu server.  All proxy servers were installed on this server.  image: sdc: jpc: ubuntu-12.04: 2.4.0 <br>  2. WebSocket-server, 512MB ‚Äúsmart machine‚Äù with Node.js, on which our WebSocket echo server was spinning.  The server is written on Node.js and started on several cores using the cluster module.  image: sdc: sdc: nodejs: 1.4.0 <br>  3. Thor, 512Mb, another ‚Äúsmart machine‚Äù on Node.js with specifications similar to the previous one.  From this server we generated the necessary load.  Thor is a load generation tool developed by us.  This application is open source and is available at <a href="http://github.com/observing/thor">http://github.com/observing/thor</a> . <br><br><h4>  Proxy configuration </h4><br>  Our proxy server was a ‚Äúclean‚Äù server with Ubuntu 12.04.  To configure and install all dependencies, the following steps have been done.  To make sure that we are working with the latest versions, run: <br><br><pre><code class="bash hljs">apt-get upgrade</code> </pre> <br>  The system has the following dependencies: <br>  - git to access github repositories <br>  - build-essential for compiling proxies from source, most proxies only recently got support for WebSockets or HTTPS <br>  - libssl-dev is needed to support HTTPS <br>  - libev-dev is required for stud, which is just incredible <br><br><pre> <code class="bash hljs">apt-get install git build-essential libssl-dev libev-dev</code> </pre><br><h5>  Node.js </h5>  Node.js is needed for http-proxy.  While http-proxy uses the latest version of Node.js, these tests were run on version 0.8.19 so that all dependencies are compatible.  Node.js was cloned from github. <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git://github.com/joyent/node.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> node git checkout v0.8.19 ./configure make make install</code> </pre><br>  This installs the binary npm, so that we can install the dependencies of this project.  Run npm install in the root of this repository and http-proxy and all dependencies will be installed automatically. <br><br><h5>  Nginx </h5>  Nginx is already a widespread server.  It supports proxying to various backend servers, but did not support WebSockets.  Not so long ago, this was added to the development branch of Nginx.  Thus, we installed the latest development version and compiled from source: <br>  <b>Please note that since testing and writing this article, nginx 1.4.0 has been released, which has support for WebSockets.</b>  <b>So if you are reading this article and are planning to deploy it in production, my advice is to use version 1.4.0.</b>  <b>instead of developer versions.</b> <br><br><pre> <code class="bash hljs">wget http://nginx.org/download/nginx-1.3.15.tar.gz tar xzvf nginx-1.3.15.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> nginx-1.3.15 ./configure --with-http_spdy_module --with-http_ssl_module \ --pid-path=/var/run/nginx.pid --conf-path=/etc/nginx/nginx.conf \ --sbin-path=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin --http-log-path=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/access.log \ --error-log-path=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/error.log --without-http_rewrite_module</code> </pre><br>  As you can see from these options, we enabled SSL, SPDY and used some other settings.  In the end, this general configuration came out: <br><br><pre> <code class="bash hljs">Configuration summary + PCRE library is not used + using system OpenSSL library + md5: using OpenSSL library + sha1: using OpenSSL library + using system zlib library nginx path prefix: <span class="hljs-string"><span class="hljs-string">"/usr/local/nginx"</span></span> nginx binary file: <span class="hljs-string"><span class="hljs-string">"/usr/local/sbin"</span></span> nginx configuration prefix: <span class="hljs-string"><span class="hljs-string">"/etc/nginx"</span></span> nginx configuration file: <span class="hljs-string"><span class="hljs-string">"/etc/nginx/nginx.conf"</span></span> nginx pid file: <span class="hljs-string"><span class="hljs-string">"/var/run/nginx.pid"</span></span> nginx error <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> file: <span class="hljs-string"><span class="hljs-string">"/var/log/nginx/error.log"</span></span> nginx http access <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> file: <span class="hljs-string"><span class="hljs-string">"/var/log/nginx/access.log"</span></span> nginx http client request body temporary files: <span class="hljs-string"><span class="hljs-string">"client_body_temp"</span></span> nginx http proxy temporary files: <span class="hljs-string"><span class="hljs-string">"proxy_temp"</span></span> nginx http fastcgi temporary files: <span class="hljs-string"><span class="hljs-string">"fastcgi_temp"</span></span> nginx http uwsgi temporary files: <span class="hljs-string"><span class="hljs-string">"uwsgi_temp"</span></span> nginx http scgi temporary files: <span class="hljs-string"><span class="hljs-string">"scgi_temp"</span></span></code> </pre><br>  Thereafter: <br><br><pre> <code class="bash hljs">make make install</code> </pre><br><h5>  Haproxy </h5>  HAProxy and previously knew how to proxy WebSockets in tcp mode, and now in http mode.  HAProxy also received support for HTTPS termination.  So again, we need to establish a development brunch. <br><br><pre> <code class="bash hljs">wget http://haproxy.1wt.eu/download/1.5/src/devel/haproxy-1.5-dev18.tar.gz tar xzvf haproxy-1.5-dev18.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> haproxy-1.5-dev18 make TARGET=linux26 USE_OPENSSL=1 make install</code> </pre><br><h5>  Stud </h5>  Although HAProxy has the option of SSL termination, stud is usually used for SSL termination before HAProxy.  And this we also want to check. <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git://github.com/bumptech/stud.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> stud make make install</code> </pre><br>  Now that everything is installed, you need to configure the configuration files.  For Nginx, you can copy nginx.conf from the root of this repository to /etc/nginx/nginx.conf.  Other proxies can be configured on the fly. <br><br><h4>  Kernel configuration </h4><br>  After installing all the proxies, some tuning of the sockets is required.  This information I pulled from the Internet: <br><br><pre> <code class="bash hljs">vim /etc/sysctl.conf</code> </pre><br>  And the following values ‚Äã‚Äãare set: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># General gigabit tuning: net.core.somaxconn = 16384 net.core.rmem_max = 16777216 net.core.wmem_max = 16777216 net.ipv4.tcp_rmem = 4096 87380 16777216 net.ipv4.tcp_wmem = 4096 65536 16777216 net.ipv4.tcp_syncookies = 1 # this gives the kernel more memory for tcp # which you need with many (100k+) open socket connections net.ipv4.tcp_mem = 50576 64768 98152 net.core.netdev_max_backlog = 2500</span></span></code> </pre><br><br><h4>  Benchmarking </h4><br>  2 different tests are carried out: <br>  1. Load test proxy servers without SSL.  In this case, we only test the performance of WebSockets proxying. <br>  2. Load test proxy servers with SSL.  Do not use unprotected WebSockets, since  they have a very bad connection in browsers.  But here an extra load is added in the SSL termination process to the proxy server. <br>  In addition to our two tests, we try a different number of compounds: <br>  - 2k <br>  - 5k <br>  - 10k <br>  And for the same results also: <br>  - 20k <br>  - 30k <br>  Before each test, all WebSocket servers are reset, and proxies are reinitialized.  Thor loads all proxy servers with X number of connections with 100 simultaneous connections.  For each established connection, one UTF-8 message is sent and received.  After the message is received, the connection is closed. <br><br><h4>  Launch </h4><br><h5>  Stud </h5><br><pre> <code class="bash hljs">stud --config stud.conf</code> </pre><br><h5>  Haproxy </h5><br><pre> <code class="bash hljs">haproxy -f ./haproxy.cfg</code> </pre><br><h5>  Nginx </h5><br><pre> <code class="bash hljs">nginx</code> </pre><br><h5>  http proxy </h5><br><pre> <code class="bash hljs">FLAVOR=http node http-proxy.js</code> </pre><br><h5>  WebSocketServer </h5><br><pre> <code class="bash hljs">FLAVOR=http node index.js</code> </pre><br><h4>  results </h4><br>  http-proxy justified its name, it proxies requests and does it quickly enough.  But since  It is based on Node.js, it eats up a lot of memory.  Even the simplest node process requires 12+ MB of memory.  For 10k requests it took about 70 MB of memory.  When compared to the control test, the HTTP proxy took 5 seconds more.  HTTPS, as expected, showed the slowest result, because Node.js with a bang loses over SSL.  And this is not to mention the fact that, being under a serious load, it completely stops your main loop (event loop). <br>  There is a <a href="http-proxy/pull/370">pull request</a> for http-proxy, which significantly reduces memory usage.  I manually applied the patch, and as a result, the memory eaten down was halved.  But still, even after the patch, it uses more memory than Nginx, which is easily explained by writing the latter in pure C. <br>  I had high hopes for Nginx, and he did not disappoint me.  He used no more than 10 MB of memory, and really worked very quickly.  The first time I tested Nginx, it showed awesome performance.  Node showed even faster results with SSL than Nginx, and I felt that there must be some kind of error, I must have made a mistake in setting up Nginx.  After a couple of hints from friends, I really changed one line in the config - there were incorrect encryption settings.  Small setup and confirmation using openssl s_client -connect server: ip fixed everything (now, by default, really fast RC4 encryption is used). <br>  The next was NARroxy, which showed the same performance as NGINX, but required less (7 MB) of memory.  <s>The biggest difference was when testing for HTTPS: it was very slow, not even close compared with Nginx.</s>  <s>We hope that this will be corrected, because</s>  <s>we have only tested the developer brunch.</s>  Then I made the same mistake as with Nginx, incorrectly configured encryption, which I was correctly noted on <a href="https://news.ycombinator.com/item%3Fid%3D5517258">HackerNews</a> .  In addition to HTTPS testing, we installed stud in front of it to verify the performance shown. <br><br><h4>  findings </h4><br>  http-proxy is a great flexible proxy, easily extensible and writeable.  When used in production, I would advise running studs for SSL termination before it. <br>  nginx and haproxy showed very close results, it is difficult to say that one of them would be faster or better.  But if you look at them from the point of view of administration, it is easier to deploy and work with one nginx than with stud and haproxy. <br><br><h5>  HTTP </h5><table border="1" cellpadding="5"><tbody><tr><th>  Proxy </th><th>  Connections </th><th>  Handshaken (medium) </th><th>  Latency (medium) </th><th>  Total </th></tr><tr><td>  http proxy </td><td>  10k </td><td>  293 ms </td><td>  44 ms </td><td>  30168 ms </td></tr><tr><td>  nginx </td><td>  10k </td><td>  252 ms </td><td>  16 ms </td><td>  28433 ms </td></tr><tr><td>  haproxy </td><td>  10k </td><td>  209 ms </td><td>  18 ms </td><td>  26974 ms </td></tr><tr><td>  control </td><td>  10k </td><td>  189 ms </td><td>  16 ms </td><td>  25310 ms </td></tr></tbody></table>  <b>Winner</b> : Nginx and HAProxy are really fast and their results are close. <br><br><h5>  Https </h5><table border="1" cellpadding="5"><tbody><tr><th>  Proxy </th><th>  Connections </th><th>  Handshaken (medium) </th><th>  Latency (medium) </th><th>  Total </th></tr><tr><td>  http proxy </td><td>  10k </td><td>  679 ms </td><td>  62 ms </td><td>  68670 ms </td></tr><tr><td>  nginx </td><td>  10k </td><td>  470 ms </td><td>  30 ms </td><td>  50180 ms </td></tr><tr><td>  haproxy </td><td>  10k </td><td>  464 ms </td><td>  25 ms </td><td>  50058 ms </td></tr><tr><td>  haproxy + stud </td><td>  10k </td><td>  492 ms </td><td>  42 ms </td><td>  52403 ms </td></tr><tr><td>  control </td><td>  10k </td><td>  703 ms </td><td>  65 ms </td><td>  71500 ms </td></tr></tbody></table>  <b>Winner</b> : Nginx and HAProxy are really fast and their results are close. <br><br>  All test results are available at: <a href="https://github.com/observing/balancerbattle/tree/master/results">https://github.com/observing/balancerbattle/tree/master/results</a> <br><br><h4>  Contributions </h4><br>  All configurations are in the repository, I would be very happy to check if we can get better performance of our servers. </div><p>Source: <a href="https://habr.com/ru/post/179629/">https://habr.com/ru/post/179629/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../179619/index.html">How much bring Top Free applications on the App Store</a></li>
<li><a href="../179621/index.html">DUMP-2013: the largest conference of the Ural developers will be held May 24-25, 2013</a></li>
<li><a href="../179623/index.html">Internet Life 2013 Conference. Moscow, May 27-28</a></li>
<li><a href="../179625/index.html">Google I / O extended: Telegraph</a></li>
<li><a href="../179627/index.html">Superprotected flash drives and hard drives</a></li>
<li><a href="../179631/index.html">The history of the admin tracker, planted for laying out a movie</a></li>
<li><a href="../179633/index.html">Kiev ITSM meetings</a></li>
<li><a href="../179635/index.html">Tracking the effectiveness of advertising campaigns in the online store</a></li>
<li><a href="../179637/index.html">Google+: content recommendations for your mobile site</a></li>
<li><a href="../179639/index.html">Vain attempts to win the lottery</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>