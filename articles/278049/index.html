<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to create your own Dependency Injection Container</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello to all! 
 This is a free translation of the article How to Build Your Own Dependency Injection Container . 
 Since This is my first translation ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to create your own Dependency Injection Container</h1><div class="post__text post__text-html js-mediator-article">  Hello to all! <br>  This is a free translation of the article <a href="http://www.sitepoint.com/how-to-build-your-own-dependency-injection-container/">How to Build Your Own Dependency Injection Container</a> . <br>  Since  This is my first translation for Habr, please indicate errors, inaccuracies. <br><br><h2>  How to create your own Dependency Injection Container. </h2><br>  The search for ‚Äúdependency injection container‚Äù on <a href="https://packagist.org/">packagist</a> currently yields over 95 result pages.  It is safe to say that this particular ‚Äúwheel‚Äù has already been invented. <br><br>  However, not a single chef learned to cook using only prepared food.  Also, no developer has ever learned how to program using only ready-made code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article, we are going to learn how to make a simple <em>dependency injection container</em> package.  All the code in the article plus PHPDoc annotations and unit tests with 100% coverage are available on <a href="https://github.com/sitepoint/Container">GitHub</a> .  All this is also added to <a href="https://packagist.org/packages/sitepoint/container">Packagist</a> . <br><a name="habracut"></a><br><h2>  Planning our Dependency Injection Container </h2><br>  Let us begin by planning what we want our container to do. <br>  A good start is to divide the <em>‚ÄúDependency Injection Container‚Äù</em> into two roles - <em>‚ÄúDependency Injection‚Äù</em> and <em>‚ÄúContainer‚Äù</em> . <br><br>  The two most common methods for performing dependency <em>injection</em> through <em>constructor injection</em> or <em>setter injection</em> .  This is the transmission of the dependency class through the constructor as an argument or method call.  If our container will be able to create an instance and contain services, it will be able to implement both of these methods. <br><br>  To be a container, it must be able to store and retrieve instances of services.  This is a rather trivial task compared to creating a service, but it still requires some consideration.  The <a href="https://github.com/container-interop/container-interop">container-interop</a> package provides a set of interfaces that a container can implement.  The main interface is <em>ContainerInterface</em> , which defines two methods ‚Äî one to get the service, the other to check if the service is defined. <br><br><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContainerInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">has</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span></span>; }</code> </pre> <br><h2>  Experience Other Dependency Injection Containers </h2><br>  <a href="http://symfony.com/doc/current/components/dependency_injection/introduction.html">Symfony Dependency Injection Container</a> allows us to define services in various ways.  In <em>YAML</em> , the configuration for a container might look like this: <br><br><pre> <code class="hljs scala">parameters: # ... mailer.transport: sendmail services: mailer: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Mailer</span></span> arguments: [<span class="hljs-string"><span class="hljs-string">"%mailer.transport%"</span></span>] newsletter_manager: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">NewsletterManager</span></span> calls: - [setMailer, [<span class="hljs-string"><span class="hljs-string">"@mailer"</span></span>]]</code> </pre> <br>  <em>Symfony's</em> way of breaking a container's configuration into a configuration of parameters and services is very useful.  This allows secret application data, such as API keys, encryption keys, and authorization tokens, to be stored parameters in files that are excluded from the source code of the repository. <br><br>  In PHP, the same configuration of the <em>Symfony Dependency Injection</em> component would look like this: <br><br><pre> <code class="hljs vhdl"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Symfony\<span class="hljs-keyword"><span class="hljs-keyword">Component</span></span>\DependencyInjection\Reference; // ... $container-&gt;setParameter(<span class="hljs-symbol"><span class="hljs-symbol">'mailer</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">transport</span></span>', <span class="hljs-symbol"><span class="hljs-symbol">'sendmail</span></span>'); $container -&gt;<span class="hljs-keyword"><span class="hljs-keyword">register</span></span>(<span class="hljs-symbol"><span class="hljs-symbol">'mailer</span></span>', <span class="hljs-symbol"><span class="hljs-symbol">'Mailer</span></span>') -&gt;addArgument('%mailer.<span class="hljs-keyword"><span class="hljs-keyword">transport</span></span>%'); $container -&gt;<span class="hljs-keyword"><span class="hljs-keyword">register</span></span>(<span class="hljs-symbol"><span class="hljs-symbol">'newsletter_manager</span></span>', <span class="hljs-symbol"><span class="hljs-symbol">'NewsletterManager</span></span>') -&gt;addMethodCall(<span class="hljs-symbol"><span class="hljs-symbol">'setMailer</span></span>', <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Reference(<span class="hljs-symbol"><span class="hljs-symbol">'mailer</span></span>')));</code> </pre> <br>  Using the <em>Reference</em> object in a call to the <em>setMailer</em> method, the dependency injection logic can detect that this value should not be passed directly, and replace it with a service referenced in the container.  This allows for both PHP values ‚Äã‚Äãand other services to be easily embedded in the service without confusion. <br><br><h3>  Beginning of work </h3><br>  The first thing we need to do is create a directory and <em>composer.json</em> file that <em>Composer</em> will use for our class autoloader to work.  This entire file is currently a <em>SitePoint \ Container</em> namespace map to the <em>src</em> directory. <br><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"autoload"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"psr-4"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"SitePoint\\Container\\"</span></span>: <span class="hljs-string"><span class="hljs-string">"src/"</span></span> } }, }</code> </pre> <br>  Further, as we are going to do, our container will implement the <em>container-interop</em> interface, we need the composer to load them and add them to our <em>composer.json</em> file: <br><br><pre> <code class="hljs axapta">composer require <span class="hljs-keyword"><span class="hljs-keyword">container</span></span>-interop/<span class="hljs-keyword"><span class="hljs-keyword">container</span></span>-interop</code> </pre> <br>  Along with the main interface <em>ContainerInterface</em> , the <em>container-interop</em> package also defines two interfaces for exceptions.  The first is for general exceptions when creating a service and the other for exceptions when the requested service was not found.  We will also add another exception to this list, for those situations when the requested parameter was not found. <br><br>  Since we do not need to add any functionality beyond the scope of the proposed PHP <em>Exception</em> core class, these classes are pretty simple.  While they may seem meaningless, such a partition makes it easier for us to catch and process them separately. <br><br>  Create a folder <em>src</em> and in it the following files <em>src / Exception / ContainerException.php</em> , <em>src / Exception / ServiceNotFoundException.php</em> and <em>src / Exception / ParameterNotFoundException.php</em> respectively: <br><br><pre> <code class="hljs scala">&lt;?php namespace <span class="hljs-type"><span class="hljs-type">SitePoint</span></span>\<span class="hljs-type"><span class="hljs-type">Container</span></span>\<span class="hljs-type"><span class="hljs-type">Exception</span></span>; use <span class="hljs-type"><span class="hljs-type">Interop</span></span>\<span class="hljs-type"><span class="hljs-type">Container</span></span>\<span class="hljs-type"><span class="hljs-type">Exception</span></span>\<span class="hljs-type"><span class="hljs-type">ContainerException</span></span> as <span class="hljs-type"><span class="hljs-type">InteropContainerException</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContainerException</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">\Exception</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InteropContainerException</span></span></span><span class="hljs-class"> </span></span>{}</code> </pre> <br><pre> <code class="hljs scala">&lt;?php namespace <span class="hljs-type"><span class="hljs-type">SitePoint</span></span>\<span class="hljs-type"><span class="hljs-type">Container</span></span>\<span class="hljs-type"><span class="hljs-type">Exception</span></span>; use <span class="hljs-type"><span class="hljs-type">Interop</span></span>\<span class="hljs-type"><span class="hljs-type">Container</span></span>\<span class="hljs-type"><span class="hljs-type">Exception</span></span>\<span class="hljs-type"><span class="hljs-type">NotFoundException</span></span> as <span class="hljs-type"><span class="hljs-type">InteropNotFoundException</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceNotFoundException</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">\Exception</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InteropNotFoundException</span></span></span><span class="hljs-class"> </span></span>{}</code> </pre> <br><pre> <code class="hljs scala">&lt;?php namespace <span class="hljs-type"><span class="hljs-type">SitePoint</span></span>\<span class="hljs-type"><span class="hljs-type">Container</span></span>\<span class="hljs-type"><span class="hljs-type">Exception</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ParameterNotFoundException</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">\Exception</span></span></span><span class="hljs-class"> </span></span>{}</code> </pre> <br><h2>  Container links </h2><br>  The symfony <em>Reference</em> class, discussed earlier, allowed the library to distinguish PHP values ‚Äã‚Äãfor immediate use and arguments that need to be replaced by other services in the container. <br><br>  Let's borrow this idea and create two classes for references to parameters and services.  Since both of these classes will store the values ‚Äã‚Äãof objects simply by the name of the resource to which they refer, it makes sense to use the base abstract class.  Thus, we should not write the same code twice. <br><br>  Create the following files <em>src / Reference / AbstractReference.php</em> , <em>src / Reference / ServiceReference.php</em> and <em>src / Reference / ParameterReference.php</em> respectively: <br><br><pre> <code class="hljs xml"><span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span><span class="php"> </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">namespace</span></span></span><span class="php"> </span><span class="hljs-title"><span class="php"><span class="hljs-title">SitePoint</span></span></span><span class="php">\</span><span class="hljs-title"><span class="php"><span class="hljs-title">Container</span></span></span><span class="php">\</span><span class="hljs-title"><span class="php"><span class="hljs-title">Reference</span></span></span><span class="php">; </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">abstract</span></span></span><span class="php"> </span><span class="hljs-class"><span class="hljs-keyword"><span class="php"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span><span class="php"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="php"><span class="hljs-class"><span class="hljs-title">AbstractReference</span></span></span></span><span class="php"><span class="hljs-class"> </span></span></span><span class="php">{ </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">private</span></span></span><span class="php"> $name; </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">public</span></span></span><span class="php"> </span><span class="hljs-function"><span class="hljs-keyword"><span class="php"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="php"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="php"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span></span><span class="hljs-params"><span class="php"><span class="hljs-function"><span class="hljs-params">($name)</span></span></span></span><span class="php"><span class="hljs-function"> </span></span></span><span class="php">{ </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">$this</span></span></span><span class="php">-&gt;name = $name; } </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">public</span></span></span><span class="php"> </span><span class="hljs-function"><span class="hljs-keyword"><span class="php"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="php"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="php"><span class="hljs-function"><span class="hljs-title">getName</span></span></span></span><span class="hljs-params"><span class="php"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span><span class="php"><span class="hljs-function"> </span></span></span><span class="php">{ </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">return</span></span></span><span class="php"> </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">$this</span></span></span><span class="php">-&gt;name; } }</span></span></code> </pre> <br><pre> <code class="hljs scala">&lt;?php namespace <span class="hljs-type"><span class="hljs-type">SitePoint</span></span>\<span class="hljs-type"><span class="hljs-type">Container</span></span>\<span class="hljs-type"><span class="hljs-type">Reference</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceReference</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractReference</span></span></span><span class="hljs-class"> </span></span>{}</code> </pre> <br><pre> <code class="hljs scala">&lt;?php namespace <span class="hljs-type"><span class="hljs-type">SitePoint</span></span>\<span class="hljs-type"><span class="hljs-type">Container</span></span>\<span class="hljs-type"><span class="hljs-type">Reference</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ParameterReference</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractReference</span></span></span><span class="hljs-class"> </span></span>{}</code> </pre> <br><h2>  Container class </h2><br>  It's time to create our container.  We are going to start with the basic schema of our container class, and we will add methods to it as we go. <br><br>  The main idea is to take two arrays in the constructor of our container.  The first array should contain the service definition, and the second parameter definition. <br><br>  In <em>src / Container.php</em> put the following code: <br><br><pre> <code class="hljs xml"><span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span><span class="php"> </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">namespace</span></span></span><span class="php"> </span><span class="hljs-title"><span class="php"><span class="hljs-title">SitePoint</span></span></span><span class="php">\</span><span class="hljs-title"><span class="php"><span class="hljs-title">Container</span></span></span><span class="php">; </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">use</span></span></span><span class="php"> </span><span class="hljs-title"><span class="php"><span class="hljs-title">Interop</span></span></span><span class="php">\</span><span class="hljs-title"><span class="php"><span class="hljs-title">Container</span></span></span><span class="php">\</span><span class="hljs-title"><span class="php"><span class="hljs-title">ContainerInterface</span></span></span><span class="php"> </span><span class="hljs-title"><span class="php"><span class="hljs-title">as</span></span></span><span class="php"> </span><span class="hljs-title"><span class="php"><span class="hljs-title">InteropContainerInterface</span></span></span><span class="php">; </span><span class="hljs-class"><span class="hljs-keyword"><span class="php"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span><span class="php"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="php"><span class="hljs-class"><span class="hljs-title">Container</span></span></span></span><span class="php"><span class="hljs-class"> </span></span><span class="hljs-keyword"><span class="php"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span></span><span class="php"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="php"><span class="hljs-class"><span class="hljs-title">InteropContainerInterface</span></span></span></span><span class="php"><span class="hljs-class"> </span></span></span><span class="php">{ </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">private</span></span></span><span class="php"> $services; </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">private</span></span></span><span class="php"> $parameters; </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">private</span></span></span><span class="php"> $serviceStore; </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">public</span></span></span><span class="php"> </span><span class="hljs-function"><span class="hljs-keyword"><span class="php"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="php"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="php"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span></span><span class="hljs-params"><span class="php"><span class="hljs-function"><span class="hljs-params">(array $services = [], array $parameters = [])</span></span></span></span><span class="php"><span class="hljs-function"> </span></span></span><span class="php">{ </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">$this</span></span></span><span class="php">-&gt;services = $services; </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">$this</span></span></span><span class="php">-&gt;parameters = $parameters; </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">$this</span></span></span><span class="php">-&gt;serviceStore = []; } }</span></span></code> </pre> <br>  All we have done here is to implement the <em>ContainerInterface</em> interface from <em>container-interop</em> and load the definitions into properties that can be accessed later.  We also created the <em>serviceStore</em> property and initialized it with an empty array.  When the container is asked to create services, we will store them in this array so that they can be restored later without the need to re-create them. <br><br>  Now let us start writing the methods declared in <em>container-interop</em> .  Let's start with <em>get ($ name)</em> , add the following method to the class: <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> SitePoint\Container\Exception\ServiceNotFoundException; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ... public function get($name) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$this-&gt;has($name)) { throw new ServiceNotFoundException(<span class="hljs-string"><span class="hljs-string">'Service not found: '</span></span>.$name); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isset($this-&gt;serviceStore[$name])) { $this-&gt;serviceStore[$name] = $this-&gt;createService($name); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $this-&gt;serviceStore[$name]; } // ...</code> </pre><br>  Be sure to add <em>use</em> at the beginning of the file.  Our <em>get ($ name)</em> method is a simple check for the presence of a service in the container.  If it is not, the <em>ServiceNotFoundException</em> that we created earlier will be thrown.  If it is, returns it.  Creates it and saves it to the repository if it has not already been created. <br><br>  While we are in it, we should create a method to retrieve the parameters from the container.  Accepting the parameters committed to the constructor from an n-dimensional associative array, we need a way to cleanly access any element within the array using a single line.  A simple way to do this is to use the dot as a separator, so that the string <em>foo.bar</em> refers to the key <em>bar</em> in the key <em>foo</em> from the root of the parameter array. <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> SitePoint\Container\Exception\ParameterNotFoundException; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ... public function getParameter($name) { $tokens = explode(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, $name); $context = $this-&gt;parameters; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (null !== ($token = array_shift($tokens))) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isset($context[$token])) { throw new ParameterNotFoundException(<span class="hljs-string"><span class="hljs-string">'Parameter not found: '</span></span>.$name); } $context = $context[$token]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $context; } // ...</code> </pre> <br>  Now we used a couple of methods that we haven‚Äôt written yet.  The first of them is <em>has ($ name)</em> , which is declared in <em>container-interop</em> .  This is a fairly simple method and it just needs to check if the definition array provided to the constructor contains the <em>$ name</em> service. <br><br><pre> <code class="hljs bash">// ... public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> has(<span class="hljs-variable"><span class="hljs-variable">$name</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> isset(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;services[<span class="hljs-variable"><span class="hljs-variable">$name</span></span>]); } // ...</code> </pre> <br>  Another method we need to write is <em>createService ($ name)</em> .  This method will use the definitions provided to create the service.  Since we do not want this method to be called outside the container, we will make it private. <br><br>  The first thing to do in this method is some reasonable checks. <br>  For each declared service, we require an array containing the <em>class</em> key and the optional <em>arguments</em> and <em>calls</em> keys.  They will be used to implement the designer and setter, respectively.  We can also add anti-looping protection by checking if we have already tried to create a service. <br><br>  If the <em>arguments</em> key exists, we want to convert the array of argument definitions into a PHP array of values ‚Äã‚Äãthat can be passed to the constructor.  In order to do this, we need to convert the directory of objects that we previously declared into the values ‚Äã‚Äãreferenced in the container.  At the moment we will use this logic in the method <em>resolveArguments ($ name, array $ argumentDefinitons)</em> . <br>  We use the <em>ReflectionClass :: newInstanceArgs ()</em> method to create a service using the arguments array.  This is the introduction of the designer. <br><br>  If the key <em>calls</em> exists, we want to use an array of <em>call definitions</em> and apply it to the service we just created.  Again, we will use the logic in a separate method, defined as <em>initializeService ($ service, $ name, array $ callDefinitions)</em> .  This is the introduction of the setter. <br><br><pre> <code class="hljs bash">use SitePoint\Container\Exception\ContainerException; // ... private <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> createService(<span class="hljs-variable"><span class="hljs-variable">$name</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$entry</span></span> = &amp;<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;services[<span class="hljs-variable"><span class="hljs-variable">$name</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_array(<span class="hljs-variable"><span class="hljs-variable">$entry</span></span>) || !isset(<span class="hljs-variable"><span class="hljs-variable">$entry</span></span>[<span class="hljs-string"><span class="hljs-string">'class'</span></span>])) { throw new ContainerException(<span class="hljs-variable"><span class="hljs-variable">$name</span></span>.<span class="hljs-string"><span class="hljs-string">' service entry must be an array containing a \'</span></span>class\<span class="hljs-string"><span class="hljs-string">' key'</span></span>); } elseif (!class_exists(<span class="hljs-variable"><span class="hljs-variable">$entry</span></span>[<span class="hljs-string"><span class="hljs-string">'class'</span></span>])) { throw new ContainerException(<span class="hljs-variable"><span class="hljs-variable">$name</span></span>.<span class="hljs-string"><span class="hljs-string">' service class does not exist: '</span></span>.<span class="hljs-variable"><span class="hljs-variable">$entry</span></span>[<span class="hljs-string"><span class="hljs-string">'class'</span></span>]); } elseif (isset(<span class="hljs-variable"><span class="hljs-variable">$entry</span></span>[<span class="hljs-string"><span class="hljs-string">'lock'</span></span>])) { throw new ContainerException(<span class="hljs-variable"><span class="hljs-variable">$name</span></span>.<span class="hljs-string"><span class="hljs-string">' service contains a circular reference'</span></span>); } <span class="hljs-variable"><span class="hljs-variable">$entry</span></span>[<span class="hljs-string"><span class="hljs-string">'lock'</span></span>] = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-variable"><span class="hljs-variable">$arguments</span></span> = isset(<span class="hljs-variable"><span class="hljs-variable">$entry</span></span>[<span class="hljs-string"><span class="hljs-string">'arguments'</span></span>]) ? <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;resolveArguments(<span class="hljs-variable"><span class="hljs-variable">$name</span></span>, <span class="hljs-variable"><span class="hljs-variable">$entry</span></span>[<span class="hljs-string"><span class="hljs-string">'arguments'</span></span>]) : []; <span class="hljs-variable"><span class="hljs-variable">$reflector</span></span> = new \ReflectionClass(<span class="hljs-variable"><span class="hljs-variable">$entry</span></span>[<span class="hljs-string"><span class="hljs-string">'class'</span></span>]); <span class="hljs-variable"><span class="hljs-variable">$service</span></span> = <span class="hljs-variable"><span class="hljs-variable">$reflector</span></span>-&gt;newInstanceArgs(<span class="hljs-variable"><span class="hljs-variable">$arguments</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isset(<span class="hljs-variable"><span class="hljs-variable">$entry</span></span>[<span class="hljs-string"><span class="hljs-string">'calls'</span></span>])) { <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;initializeService(<span class="hljs-variable"><span class="hljs-variable">$service</span></span>, <span class="hljs-variable"><span class="hljs-variable">$name</span></span>, <span class="hljs-variable"><span class="hljs-variable">$entry</span></span>[<span class="hljs-string"><span class="hljs-string">'calls'</span></span>]); } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$service</span></span>; } // ...</code> </pre> <br>  It remains for us to create two final methods.  The first is to convert the declaration arguments array to a PHP array of values.  To do this, you need to replace the <em>ParameterReference</em> and <em>ServiceReference</em> objects <em>with the</em> corresponding parameters and services from the container. <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> SitePoint\Container\Reference\ParameterReference; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> SitePoint\Container\Reference\ServiceReference; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ... private function resolveArguments($name, array $argumentDefinitions) { $arguments = []; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($argumentDefinitions as $argumentDefinition) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($argumentDefinition instanceof ServiceReference) { $argumentServiceName = $argumentDefinition-&gt;getName(); $arguments[] = $this-&gt;get($argumentServiceName); } elseif ($argumentDefinition instanceof ParameterReference) { $argumentParameterName = $argumentDefinition-&gt;getName(); $arguments[] = $this-&gt;getParameter($argumentParameterName); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $arguments[] = $argumentDefinition; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $arguments; }</code> </pre> <br>  The latter method injects the setter into an instance of the service object.  To do this, you must iterate through the array of definitions when calling the method.  The <em>method</em> key is used to specify a method, and the optional <em>arguments</em> key can be used to provide arguments to this method.  We can use the method we just wrote to translate its arguments to PHP values. <br><br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initializeService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($service, $name, array $callDefinitions)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($callDefinitions <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $callDefinition) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_array($callDefinition) || !<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($callDefinition[<span class="hljs-string"><span class="hljs-string">'method'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ContainerException($name.<span class="hljs-string"><span class="hljs-string">' service calls must be arrays containing a \'method\' key'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> (!is_callable([$service, $callDefinition[<span class="hljs-string"><span class="hljs-string">'method'</span></span>]])) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ContainerException($name.<span class="hljs-string"><span class="hljs-string">' service asks for call to uncallable method: '</span></span>.$callDefinition[<span class="hljs-string"><span class="hljs-string">'method'</span></span>]); } $arguments = <span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($callDefinition[<span class="hljs-string"><span class="hljs-string">'arguments'</span></span>]) ? <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;resolveArguments($name, $callDefinition[<span class="hljs-string"><span class="hljs-string">'arguments'</span></span>]) : []; call_user_func_array([$service, $callDefinition[<span class="hljs-string"><span class="hljs-string">'method'</span></span>]], $arguments); } } }</code> </pre> <br>  And now we have a ready <em>dependency injection container</em> !  To see usage examples, check out the <a href="https://github.com/sitepoint/Container">repository on GitHub</a> . <br><br><h2>  Conclusion </h2><br>  We've learned how to create a simple dependency <em>injection container</em> , but there are a lot of containers with great features that we don‚Äôt have yet. <br><br>  Some dependency injection containers, such as <a href="http://php-di.org/doc/autowiring.html">PHP-DI</a> and <a href="">Aura.DI,</a> provide a feature called automatic connection.  This is where the container guesses which services from the container should be injected into others.  To do this, they use the reflection API to search for information about the parameters of the designer. <br></div><p>Source: <a href="https://habr.com/ru/post/278049/">https://habr.com/ru/post/278049/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278039/index.html">Again about STL</a></li>
<li><a href="../278041/index.html">Personalize IMGUI and Unity Editor. Part one</a></li>
<li><a href="../278043/index.html">The story of the endless city. On Three.js</a></li>
<li><a href="../278045/index.html">Configuring fault tolerance in 3CX Version 14</a></li>
<li><a href="../278047/index.html">jsPDF + canvas: export to PDF of a multipage table in Russian</a></li>
<li><a href="../278051/index.html">Patch gnupg or a pair of RSA-32768 in 106 minutes</a></li>
<li><a href="../278053/index.html">Apple hired the author Signal</a></li>
<li><a href="../278055/index.html">A little about data storage and experience 1cloud</a></li>
<li><a href="../278069/index.html">Machine Learning: Questions and Answers</a></li>
<li><a href="../278071/index.html">Citrix Tech Exchange Moscow 2016: how it changed my attitude to Xen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>