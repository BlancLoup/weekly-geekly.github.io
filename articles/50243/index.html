<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The data structures in memcached / memcacheDB. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quite often we have to store data in memcached or memcacheDB . It can be relatively simple data, for example, cached samples from the database, and so...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The data structures in memcached / memcacheDB. Part 1</h1><div class="post__text post__text-html js-mediator-article"> Quite often we have to store data in <a href="http://danga.com/memcached/">memcached</a> or <a href="http://memcachedb.org/">memcacheDB</a> .  It can be relatively simple data, for example, cached samples from the database, and sometimes it is necessary to store and process more complex data structures that are updated from several processes simultaneously, provide fast data reading, etc.  The implementation of such data structures no longer fits into a combination of memcached <code>get</code> / <code>set</code> commands.  This article will describe how to store some data structures in memcached with code examples and a description of the main ideas. <br><br>  Memcached and MemcacheDB in this article are considered together, because they have a common access interface and the logic of most data structures will be the same, in the following we will simply call them ‚Äúmemcached‚Äù.  Why do we need to store data structures in memcached?  Most often for distributed access to data from different processes, from different servers, etc.  And sometimes for solving the problem of data storage, the interface provided by MemcacheDB is sufficient, and the need to use a DBMS is no longer necessary. <br><br>  Sometimes a project is developed initially for an unallocated case (working within a single server), however, assuming the future need for scaling, it is better to use such algorithms and data structures at once that can provide easy scaling.  For example, even if the data will be stored simply in the memory of the process, but the interface to access them repeats the semantics of memcached, then when moving to a distributed and scalable architecture it will be enough to replace the calls to the internal storage to the calls to the server (or server cluster) memcached. <br><a name="habracut"></a><br>  A total of 6 data structures will be considered: <br><ol><li>  lock; </li><li>  counter; </li><li>  visitor counter; </li><li>  event log; </li><li>  array; </li><li>  table. </li></ol>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      From the first to the third in this part, and from the fourth to the sixth - in the next. <br><br>  Code samples will be written in Python, they will use the following <br>  memcached access interface: <br><br><pre> <code class="hljs python"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Memcache</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, key)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   . @param key:  @type key: C{str} @return:   @raises KeyError:   """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, key, value, expire=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   ,     . @param key:  @type key: C{str} @param value:   @param expire: " "    (0 ‚Äî ) @type expire: C{int} @raises KeyError:    """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">incr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, key, value=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""     . @param key:  @type key: C{str} @param value:  @type value: C{int} @return:    ( ) @rtype: C{int} @raises KeyError:    """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">append</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, key, value)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""      . @param key:  @type key: C{str} @param value:  @raises KeyError:    """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, key)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  . @param key:  @type key: C{str} """</span></span></code> </pre><br>  All our data structures will be derived from the following base class: <br><br><pre> <code class="hljs python"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MemcacheObject</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, mc)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" . @param mc:  memcached @type mc: L{Memcache} """</span></span> self.mc = mc</code> </pre><br><br><h2>  Lock </h2><br><h3>  Task </h3><br>  A lock (mutex, or rather a spinlock in this situation) is not exactly a data structure, but it can be used as a ‚Äúbrick‚Äù when building complex data structures in memcached.  A lock is used to exclude simultaneous access to certain keys; the lock feature is not available in the memcached API, so it is emulated using other operations. <br><br>  So, the lock is determined by its name, it works distributedly (that is, from any process that has access to memcached), it has an automatic ‚Äúdie‚Äù (in case the process that put the lock cannot remove it, for example, due to a crash). <br><br>  Lock operations: <br><br><ul><li>  try to lock (try-lock); </li><li>  unlock (unlock). </li></ul><br><br><h3>  Decision </h3><br><pre> <code class="hljs python"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MCCounter</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(MemcacheObject)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, mc, name)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" . @param name:   @type name: C{str} """</span></span> super(MCCounter, self).__init__(mc) self.key = <span class="hljs-string"><span class="hljs-string">'counter'</span></span> + name <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">increment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, value=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""      . @param value:  @type value: C{int} """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: self.mc.incr(self.key, value) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> KeyError: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: self.mc.add(self.key, value, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> KeyError: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   . @return:    @rtype: C{int} """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.mc.get(self.key) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> KeyError: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br><br><h3>  Discussion </h3><br>  The correctness of the lock operation is based on the `add` operation, which guarantees that exactly one process will be able to‚Äú first ‚Äùset the key value, all other processes will get an error.  The above class can be wrapped more conveniently, for example, for <a href="http://docs.python.org/reference/datamodel.html">Python with-handler</a> .  The issue of locks was discussed in more detail in a post about <a href="http://www.smira.ru/2008/10/28/web-caching-memcached-4/">simultaneous rebuilding of caches</a> . <br><br><h2>  Atomic counter </h2><br><h3>  Task </h3><br>  It is necessary to calculate the number of events that occur distributed on different servers, also get the current value of the counter.  At the same time, the counter should not ‚Äúlose‚Äù events and charge ‚Äúextra‚Äù values. <br><br>  Data type: integer. <br><br>  Initial value: zero. <br><br>  Operations: <br><br><ul><li>  increase the counter value by the specified value; </li><li>  get the current value of the counter. </li></ul><br><br><h3>  Decision </h3><br><pre> <code class="hljs python"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">time</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""         (, UNIX Epoch). @return:     @rtype: C{int} """</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MCVisitorCounter</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(MemcacheObject)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, mc, name, T)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" . @param name:   @type name: C{str} @param T:  ,  @type T: C{int} """</span></span> super(MCVisitorCounter, self).__init__(mc) self.keys = (<span class="hljs-string"><span class="hljs-string">'counter'</span></span> + name + <span class="hljs-string"><span class="hljs-string">'_0'</span></span>, <span class="hljs-string"><span class="hljs-string">'counter'</span></span> + name + <span class="hljs-string"><span class="hljs-string">'_1'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_active</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""    . @return: 0  1 """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (time() % (<span class="hljs-number"><span class="hljs-number">2</span></span>*T)) &lt; T <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">increment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   . """</span></span> active = self._active() <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: self.mc.incr(self.keys[<span class="hljs-number"><span class="hljs-number">1</span></span>-active], <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> KeyError: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: self.mc.add(self.keys[<span class="hljs-number"><span class="hljs-number">1</span></span>-active], <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>*T) <span class="hljs-comment"><span class="hljs-comment">#  43 return except KeyError: pass def value(self): """   . @return:    @rtype: C{int} """ try: return self.mc.get(self.keys[self._active()]) except KeyError: return 0</span></span></code> </pre><br><br><h3>  Discussion </h3><br>  The implementation of the counter is quite obvious, the most difficult moment is the ‚Äúeternal‚Äù cycle in the <code>increment</code> method.  It is necessary for the correct initialization of the counter value in a competitive access to it.  If the <code>incr</code> operation failed with the lack of a key, we need to create a counter key, but this code can simultaneously perform several processes, then one of them will be able to <code>add</code> , and the second will receive an error and increment the already created counter using <code>incr</code> .  Looping is impossible, because  One of the <code>incr</code> or <code>add</code> operations must be successful: after creating a key in memcached, the <code>incr</code> operation will be successful for the entire <code>incr</code> key. <br><br>  How to deal with the situation when the key with the counter from memcached disappears?  Two situations are possible when the key disappears: <br><ol><li>  memcached not enough memory to host other keys; </li><li>  memcached process terminated abnormally (server ‚Äúcrashed‚Äù). </li></ol><br><br>  (In the case of MemcacheDB, configured replication, etc. server crash should not lead to loss of keys.) In the first case, you only need to properly maintain memcached - there should be enough memory for the counters, otherwise we start to lose value, and this is unacceptable in this situation ( but perfectly normal, for example, for storing caches in memcached).  The second case is always possible, if this situation often arises, you can duplicate the counters in several memcached-servers. <br><br><h2>  Visitor count </h2><br><h3>  Task </h3><br>  It is necessary to calculate the number of unique hits to the site during a certain period T. For example, T may be equal to 5 minutes.  Suppose we can say when the site‚Äôs last appeal to the site was more than T minutes ago or less (that is, is it unique during period T). <br><br>  Operations on the counter: <br><br><ul><li>  increase the counter value by one (circulation unique during the period T visitor); </li><li>  get the current number of visitors. </li></ul><br><br><h3>  Decision </h3><br><pre> <code class="hljs python"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">time</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""         (, UNIX Epoch). @return:     @rtype: C{int} """</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MCVisitorCounter</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(MemcacheObject)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, mc, name, T)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" . @param name:   @type name: C{str} @param T:  ,  @type T: C{int} """</span></span> super(MCVisitorCounter, self).__init__(mc) self.keys = (<span class="hljs-string"><span class="hljs-string">'counter'</span></span> + name + <span class="hljs-string"><span class="hljs-string">'_0'</span></span>, <span class="hljs-string"><span class="hljs-string">'counter'</span></span> + name + <span class="hljs-string"><span class="hljs-string">'_1'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_active</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""    . @return: 0  1 """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (time() % (<span class="hljs-number"><span class="hljs-number">2</span></span>*T)) &lt; T <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">increment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   . """</span></span> active = self._active() <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: self.mc.incr(self.keys[<span class="hljs-number"><span class="hljs-number">1</span></span>-active], <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> KeyError: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: self.mc.add(self.keys[<span class="hljs-number"><span class="hljs-number">1</span></span>-active], <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>*T) <span class="hljs-comment"><span class="hljs-comment">#  43 return except KeyError: pass def value(self): """   . @return:    @rtype: C{int} """ try: return self.mc.get(self.keys[self._active()]) except KeyError: return 0</span></span></code> </pre><br><br><h3>  Discussion </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/96e/e82/c9a/96ee82c9a28cd409082bb76ff13eca50.png" alt="  " title="Visitor counter operation" width="639" height="273"><br><br>  The basic structure of working with a counter in memcached in this task repeats the solution of the problem of an atomic counter.  The basic idea is to use the shadow and current counter: the shadow counter receives updates (increases), and the current one is used to get the number of visitors (its value was accumulated when it was shadow).  Each period T current and shadow counter swapped.  The key of the shadow counter is created with a shelf life of 2 * T seconds, that is, its lifetime is T seconds while it was shadow (and increased), and T seconds while its value was used for reading.  By the time this key becomes a shadow counter again, it should be destroyed by memcached, since  its expiration date has expired.  The idea of ‚Äã‚Äãa shadow and current counter resembles, for example, double buffering when displayed on a screen in games. <br><br>  It is necessary to pay attention to the <code>_active()</code> function: it is implemented by calculating the remainder of dividing the current time in seconds, and not, for example, through a periodic (once every T seconds) change of the <code>active</code> value, since  if the time on all servers is synchronized with reasonable accuracy, then the result of the <code>_active()</code> function will be the same on all servers, which is important for the correct distributed operation of this data structure. <br><br>  The described approach will work correctly only with a sufficiently large number of visitors, when the time interval between the next change of the <code>_active()</code> function <code>_active()</code> and the <code>increment()</code> function call will be as short as possible.  That is, when the <code>increment()</code> is called frequently, that is, when there are a lot of visitors, for example, 1000 people with a period T = 3 minutes.  Otherwise, the creation and destruction of keys will not be synchronized with the moment the <code>_active()</code> value is <code>_active()</code> and visitors accumulated in the shadow counter, which will be destroyed during the accumulation of values ‚Äã‚Äãand created anew, will disappear.  In this situation, its lifetime 2 * T will be ‚Äúshifted‚Äù relative to the moments 0, T of the time ()% (2 * T) function.  Due to the fact that memcached considers the shelf life of keys discretely relative to seconds (with an accuracy of no more than one second), any shift in the key lifetime can be 1.2, ..., T-1 second (no shift - 0 seconds).  The expiration date resolution means that if a key was created in 25 seconds 31 milliseconds with a shelf life of 10 seconds, then it will be destroyed in the 35th (or 36th) second 0 milliseconds (and not the 31st millisecond).  To compensate for the shift in an integer number of seconds, you need to correct the line 43 of the example as follows: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">self</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.mc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.add</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">self</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.keys</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1-active]</span></span>, 1, 2*<span class="hljs-selector-tag"><span class="hljs-selector-tag">T</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">time</span></span>() % <span class="hljs-selector-tag"><span class="hljs-selector-tag">T</span></span>)</code> </pre> <br><br>  The value of the visitor counter does not change over a period of time T; for a more pleasant display, you can add a normally distributed value with a small variance and expected value of about 5% of the counter value to the counter value during output. <br><br>  A slightly more complicated version of such a counter (with interpolation in time), but with exactly the same idea was described in a post about the <a href="http://www.smira.ru/2008/10/24/web-caching-memcached-3">atomicity of the operation and the counters in memcached</a> . <br><br>  <b>UPD</b> : <a href="http://habrahabr.ru/blogs/webdev/50247/">The second part of the</a> article. </div><p>Source: <a href="https://habr.com/ru/post/50243/">https://habr.com/ru/post/50243/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../50234/index.html">OLPC XO-1 near</a></li>
<li><a href="../50235/index.html">Bash and twitter</a></li>
<li><a href="../50238/index.html">Nice little thing in gmail</a></li>
<li><a href="../50240/index.html">Introducing FreeSWITCH Part Two</a></li>
<li><a href="../50241/index.html">CUDA: right off the bat</a></li>
<li><a href="../50247/index.html">The data structures in memcached / memcacheDB. Part 2</a></li>
<li><a href="../50249/index.html">Attacks on wireless networks. Part 2</a></li>
<li><a href="../50253/index.html">Yandex competitor has a competitor (Kiev)</a></li>
<li><a href="../50254/index.html">Search for the approach to the presentation of ideas</a></li>
<li><a href="../50255/index.html">"Space tourists" will not be able to fly to the ISS after 2009</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>