<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ORM or simple filling of the class with data from the stored procedure</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello to all habrayusers, I decided to write my first article, which continues a series of essays about interaction with the database. It so happened ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ORM or simple filling of the class with data from the stored procedure</h1><div class="post__text post__text-html js-mediator-article">  Hello to all habrayusers, I decided to write my first article, which continues a series of <a href="http://habrahabr.ru/blogs/net/48820">essays</a> about interaction with the database.  It so happened that I turned up a small web project for implementation.  ASP.NET MVC + ExtJS was chosen as the platform, but there was no solution for ORM at once.  The problem was that it would not be desirable to involve a large industrial ORM solution like NHibernate or the Entity Framework, since the project will have two to three dozen stored procedures.  At the same time, using the Microsoft DAAB wrapper does not work either. <a name="habracut"></a>  because  in the MVC framework, the models are essentially copies of the database tables (well, just to simplify, we assume that) as a result, Readers, DataSets, and DataTables can do little to help us.  Perhaps a good solution would be to use LinqToSql, but I really dislike it when requests are written not in SQL but in C #, I firmly believe that communication between the application and the database should occur only through stored procedures and functions.  In other words, we need a class mapping on the result set of the stored procedure and the simplicity of its use in order to simply call the helper method and, using reflection, it returned a collection of instances filled with data from the procedure.  I think the essence of the problem I have set out quite clearly, so we proceed to the implementation. <br><br>  To begin with, let's declare our class to fill with data, of course, that it will completely copy the fields that the stored procedure returns: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> Book <br> { <br> <font color="#0000ff">public</font> <font color="#0000ff">int</font> ID { <font color="#0000ff">get</font> ; <font color="#0000ff">set</font> ; } <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> Title { <font color="#0000ff">get</font> ; <font color="#0000ff">set</font> ; } <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> Author { <font color="#0000ff">get</font> ; <font color="#0000ff">set</font> ; } <br> <font color="#0000ff">public</font> <font color="#2B91AF">DateTime</font> PublicationDate { <font color="#0000ff">get</font> ; <font color="#0000ff">set</font> ; } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  And here is the helper method for mapping: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#2B91AF">List</font> &lt;T&gt; GetSpResultset&lt;T&gt;( <font color="#0000ff">string</font> spName) <br> { <br> <font color="#2B91AF">List</font> &lt;T&gt; list = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt;T&gt;(); <br> SqlConnection connection = <font color="#0000ff">new</font> SqlConnection( <font color="#A31515">" "</font> ); <br> <br> connection.Open(); <br> <br> <font color="#0000ff">using</font> ( <font color="#2B91AF">SqlCommand</font> command = <font color="#0000ff">new</font> <font color="#2B91AF">SqlCommand</font> (spName, connection)) <br> { <br> command.CommandType = CommandType.StoredProcedure; <br> <font color="#0000ff">using</font> (IDataReader reader = command.ExecuteReader(CommandBehavior.CloseConnection)) <br> { <br> PropertyInfo[] fields = <font color="#0000ff">typeof</font> (T).GetProperties(); <br> <font color="#0000ff">while</font> (reader.Read()) <br> { <br> T record = Activator.CreateInstance&lt;T&gt;(); <br> <font color="#0000ff">foreach</font> (PropertyInfo pi <font color="#0000ff">in</font> fields) <br> { <br> <font color="#0000ff">if</font> (pi.PropertyType.Name == <font color="#0000ff">typeof</font> ( <font color="#2B91AF">Int32</font> ).Name) <br> { <br> <font color="#0000ff">if</font> (pi.CanWrite) <br> { <br> <font color="#0000ff">int</font> <font color="#0000ff">value</font> = reader.GetInt32(reader.GetOrdinal(pi.Name)); <br> pi.SetValue(record, <font color="#0000ff">value</font> , <font color="#0000ff">null</font> ); <br> } <br> } <br> <font color="#0000ff">else</font> <font color="#0000ff">if</font> (pi.PropertyType.Name == <font color="#0000ff">typeof</font> (Int16).Name) <br> { <br> <font color="#0000ff">if</font> (pi.CanWrite) <br> { <br> <font color="#0000ff">short</font> <font color="#0000ff">value</font> = <font color="#2B91AF">Convert</font> .ToInt16(reader.GetValue(reader.GetOrdinal(pi.Name))); <br> pi.SetValue(record, <font color="#0000ff">value</font> , <font color="#0000ff">null</font> ); <br> } <br> } <br> <font color="#0000ff">else</font> <font color="#0000ff">if</font> (pi.PropertyType.Name == <font color="#0000ff">typeof</font> ( <font color="#2B91AF">String</font> ).Name) <br> { <br> <font color="#0000ff">if</font> (pi.CanWrite) <br> { <br> <font color="#0000ff">string</font> <font color="#0000ff">value</font> = reader.GetString(reader.GetOrdinal(pi.Name)); <br> pi.SetValue(record, <font color="#0000ff">value</font> , <font color="#0000ff">null</font> ); <br> } <br> } <br> <font color="#0000ff">else</font> <font color="#0000ff">if</font> (pi.PropertyType.Name == <font color="#0000ff">typeof</font> ( <font color="#2B91AF">DateTime</font> ).Name) <br> { <br> <font color="#0000ff">if</font> (pi.CanWrite) <br> { <br> <font color="#2B91AF">DateTime</font> <font color="#0000ff">value</font> = reader.GetDateTime(reader.GetOrdinal(pi.Name)); <br> pi.SetValue(record, <font color="#0000ff">value</font> , <font color="#0000ff">null</font> ); <br> } <br> } <br> } <br> list.Add(record); <br> } <br> } <br> } <br> <font color="#0000ff">return</font> list; <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  The method is implemented as a <a href="http://msdn.microsoft.com/en-us/library/twcad0zb(VS.80).aspx">generic method</a> that returns the System.Collections.Generic.List collection filled with instances of our class, for ease of implementation, it omits passing parameters to the procedure and works with only 4 data types Int32, Int16, String and DateTime, but you be able to expand and supplement it functionally. <br><br>  And of course, an example of use: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#2B91AF">List</font> &lt;Book&gt; books = GetSpResultset&lt;Book&gt;( <font color="#A31515">"sp_GetBooks"</font> );</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Well, that's all I wanted to tell in my article, I look forward to comments and constructive criticism. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/51404/">https://habr.com/ru/post/51404/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../51398/index.html">C ++ MythBusters. The myth of the virtual functions (addition)</a></li>
<li><a href="../51399/index.html">Number or label?</a></li>
<li><a href="../51400/index.html">In social networks more women.</a></li>
<li><a href="../51401/index.html">Happy birthday to Mendeleev</a></li>
<li><a href="../51403/index.html">Resource manager</a></li>
<li><a href="../51406/index.html">"Favorite Internet"</a></li>
<li><a href="../51410/index.html">ReactOS - Open Source Windows?</a></li>
<li><a href="../51412/index.html">Functional programming :: recursive functions</a></li>
<li><a href="../51417/index.html">Music widgets 9 months later</a></li>
<li><a href="../51418/index.html">Carakan wallpaper</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>