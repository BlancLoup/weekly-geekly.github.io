<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Authorization on sites through Z-Payment (OAuth 2.0)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, community! This article describes the Z-Payment API protocol based on OAuth 2.0, for authorizing users on third-party sites. We admit that it i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Authorization on sites through Z-Payment (OAuth 2.0)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/b31/766/1a3/b317661a3b276425dad9c0f0e9fa1f10.png" align="left" alt="image">  Hello, community!  This article describes the Z-Payment API protocol based on OAuth 2.0, for authorizing users on third-party sites.  We admit that it is always laziness to register, not to mention the fact that you have to share personal information (at least by mail), and when it needs to be done only once, then laziness is twofold.  That is why Internet services with a large number of users offer the possibility of authorization on third-party resources through themselves and Z-Payment in this case is no longer an exception. <br><a name="habracut"></a><br><h4>  Introduction </h4><br>  Recently, the <a href="http://z-payment.ru/">Z-Payment</a> team implemented a server-based authorization mechanism based on the OAuth 2.0 protocol, which offers developers the ability to create authorization on third-party sites through the Z-Payment service and request the personal data of authorized users with their consent.  This method allows you to implement secure user authentication on a third-party site. <br><br>  In order to take advantage of access to this interface, you must fulfill 3 mandatory conditions: <br><ol><li>  Have a registration on Z-Payment </li><li>  Register site </li><li>  The site should receive public status, i.e.  published in the Z-Catalog </li></ol><br>  The main task of Z-Payment when implementing this authorization method is to provide developers with another means to create independent projects that use Z-Payment resources.  A successful example is the project <a href="http://z-change.ru/">Exchange Exchange Z-Change</a> <br>  <b>The authorization process consists of 4 steps:</b> <br><ol><li>  User transfer for authorization to Z-Payment </li><li>  Allowing user access to personal data.  The user must consent to the provision of the requested 3rd party (you) data.  If the user is not authorized to Z-Payment, then he will be asked to authorize in his personal account.  After successful authorization, the user will be asked to allow access to personal data. </li><li>  Passing the code to the site to get the access key </li><li>  Getting the access_token access key by the project server to access the Z-Payment API </li></ol><br><h4>  Now in order and in more detail </h4><br>  <b>Given:</b> site.  <b>The task is to</b> authorize / register your users through Z-Payment. <br><br><h5>  Step 1 </h5><br>  You need to redirect the user to authorize on Z-Payment, you can do this GET or POST request to <code><a href="https://z-payment.ru/enter.php"></a> z-payment.ru/enter.php</code>  <code><a href="https://z-payment.ru/enter.php"></a> z-payment.ru/enter.php</code> with parameters: <br>  <b>client_id</b> - a required parameter, four-digit, unique identifier of the store in Z-Payment, issued when the site is registered in the system. <br>  <b>redirect</b> - a required parameter, the address to which the user will be redirected after passing authorization (the domain of the specified address must correspond to the main domain in the store settings) <br>  <b>display</b> is a required parameter that indicates the type of display of the authorization page.  Currently supports only page, which means - authorization in a separate window <br>  <b>scope</b> is an optional parameter; this parameter is responsible for the list of requested personal data about the user.  The requested data must be separated by a comma or a space. <br>  Here is a list of possible requested data: <br><table><tbody><tr><td>  0 </td><td>  f_name </td><td>  Name </td></tr><tr><td>  one </td><td>  s_name </td><td>  Surname </td></tr><tr><td>  2 </td><td>  m_name </td><td>  middle name </td></tr><tr><td>  3 </td><td>  birth_day </td><td>  Date of Birth </td></tr><tr><td>  four </td><td>  group </td><td>  Type of certificate </td></tr><tr><td>  five </td><td>  sex </td><td>  Floor </td></tr><tr><td>  6 </td><td>  e_mail </td><td>  post office </td></tr><tr><td>  7 </td><td>  phone </td><td>  Telephone number </td></tr><tr><td>  eight </td><td>  country </td><td>  A country </td></tr><tr><td>  9 </td><td>  city </td><td>  City </td></tr><tr><td>  ten </td><td>  balance </td><td>  Wallet balance </td></tr></tbody></table><br>  <b>response_type</b> is not a required parameter; it is responsible for the type of response that we want to receive; it can take values: code ‚Äî if we want to make requests from a third-party server (by default) or token ‚Äî if we want to make requests from a client. <br>  According to the above, the GET request should look like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code><a href="http"></a> GET: z-payment.ru/enter.php?client_id=ID__&amp;redirect=http://.ru/login&amp;dispaly=page&amp;scope=f_name,s_name,m_name,phone,city,e_mail&amp;response_type=code <br></code> <br><br><h5>  Step 2 </h5><br>  Clicking on such a link, the user will be on the page where he will be asked to give consent to provide the 3rd person (your site) with the data you request in the scope parameter, or log in first if he hasn‚Äôt already done so, and then give consent.  Further, with the user's consent, in automatic mode it will be transferred to the page specified in the redirect parameter. <br><br><h5>  Step 3 </h5><br>  Returning back, the GET method will pass the code parameter, which contains the temporary code.  With it, it is possible to request data for which the user has agreed.  The parameter lifetime is 15 minutes. During this period, you need to get the access key to the access_token API from the requested site.  It will look like this: <br><br> <code><a href="http://redirect_uri/%3Fcode%3Da2a56603b8f57a6fa4dff77380df05206c883f011c40b72630bb5ed6f6479e52a8e"></a> <a href="http://redirect_uri/%3Ferror%3Dinvalid_request%26error_description%3DInvalid%2Bdisplay%2Bparameter"></a> GET: REDIRECT_URI?code=a2a56603b8f57a6fa4dff77380df05206c883f011c40b72630bb5ed6f6479e52a8e <br>         : <br> GET: REDIRECT_URI?error=invalid_request&amp;error_description=Invalid+display+parameter <br></code> <br><br><h5>  Step 4 </h5><br>  At the final step, we get access by sending a request to <a href="https://z-payment.ru/api/get_access_token.php">z-payment.ru/api/get_access_token.php</a> , the request as well as in step 1, can be transmitted via GET or POST method and must contain the following parameters: <br>  <b>client_id</b> - a required parameter, a four-digit, unique identifier of the store in the z-payment system, issued when the store is registered in the Z-Payment merchant (see above) <br><br>  <b>code</b> - a required parameter, a temporary code received after passing authorization in step 3 (see above) <br><br>  <b>format_answer</b> is optional, response format, json is used by default.  May take values: json, get. <br>  <b>client_secret</b> is a required parameter and is an electronic signature.  It is generated as a hash md5 from the merged string of request parameters and password of the Merchant Key store. <br>  Data involved in the signature: client_id + code + MerchantKey - from this and take MD5 <br><br>  The result of the request must be a response consisting of parameters: <br>  access_token, expires_in key lifetime (in seconds), user_id ZP number of the user_verification wallet - information about the user's certification (takes the value yes in case the user has a certificate), as well as a set of requested fields from the first request. <br><br>  This completes the theoretical description of the authorization process, now <br>  based on the above, you can make a software implementation of the protocol, I will do it on php 5.3 and it is assumed that the implemented class should be used in some MVC architecture. <br>  So, the task is to make a simple class for automating authorization through Z-Payment.  I want to immediately make a reservation on the code: <br><ol><li>  define constants need to be placed in the configuration file, I use them in the example for clarity, <br></li><li>  I do not give an example of a class that implements the IUserStorage interface, data can be stored wherever it wants - a session (SessionUserStorage), a database (DbUserStorage) or a file (FileUserStorage), and therefore it is enough to know only the interface.  The code is documented, so I consider additional commenting tediousness. <br></li></ol><br><div class="spoiler">  <b class="spoiler_title">PHP code itself</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment"> ID      */</span></span> define(<span class="hljs-string"><span class="hljs-string">"SHOP_ID"</span></span>, <span class="hljs-string"><span class="hljs-string">"0001"</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment"> MERCHANT KEY      */</span></span> define(<span class="hljs-string"><span class="hljs-string">"MERCHANT_KEY"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Example</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">           */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IUserStorage</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $data)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">erase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">     */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserManager</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TOKEN_URL = <span class="hljs-string"><span class="hljs-string">"https://z-payment.ru/api/get_access_token.php"</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> \Example\IUserStorage * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $storage; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> $userInfo array * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $userInfo; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> \Example\Controller\Base * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">     mvc ,      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $controller; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> IUserStorage $storage * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">   $storage    \Example\IUserStorage */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\Example\IUserStorage $storage)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;storage = $storage; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userInfo = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;storage-&gt;load(); } <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">   ,     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($field = null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> === $field) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userInfo; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userInfo[$field])) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userInfo[$field]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isLogin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userInfo != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">  ZP  * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string | null */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAccount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isLogin()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userInfo[<span class="hljs-string"><span class="hljs-string">'user_id'</span></span>]; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isCertified</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getUserInfo(<span class="hljs-string"><span class="hljs-string">'user_verification'</span></span>) == <span class="hljs-string"><span class="hljs-string">'yes'</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">    code,  mvc   ,      $code = $_REQUEST['code']; */</span></span> $code = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;controller-&gt;getRequest()-&gt;get(<span class="hljs-string"><span class="hljs-string">"code"</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">  ,    md5     * 1+2+Merchant Key,  Merchant Key    */</span></span> $client_secret = md5(SHOP_ID . $code . MERCHANT_KEY); <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">     */</span></span> $params = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-comment"><span class="hljs-comment">/** id  */</span></span> <span class="hljs-string"><span class="hljs-string">'client_id='</span></span> . urlencode(SHOP_ID), <span class="hljs-comment"><span class="hljs-comment">/**      */</span></span> <span class="hljs-string"><span class="hljs-string">'code='</span></span> . urlencode($code), <span class="hljs-comment"><span class="hljs-comment">/**    */</span></span> <span class="hljs-string"><span class="hljs-string">'format_answer='</span></span> . <span class="hljs-string"><span class="hljs-string">'json'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/**   */</span></span> <span class="hljs-string"><span class="hljs-string">'client_secret='</span></span> . urlencode($client_secret) ); $curl = curl_init(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::TOKEN_URL); curl_setopt($curl, CURLOPT_HEADER, <span class="hljs-number"><span class="hljs-number">1</span></span>); curl_setopt($curl, CURLOPT_POST, <span class="hljs-number"><span class="hljs-number">1</span></span>); curl_setopt($curl, CURLOPT_RETURNTRANSFER, <span class="hljs-number"><span class="hljs-number">1</span></span>); curl_setopt($curl, CURLOPT_POSTFIELDS, implode(<span class="hljs-string"><span class="hljs-string">"&amp;"</span></span>, $params)); <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">    */</span></span> $result = curl_exec($curl); curl_close($curl); <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">    */</span></span> $result = json_decode($result); <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($result-&gt;error != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;storage-&gt;save((<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>)$result); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">   * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LogOut</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;storage-&gt;erase(); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> \Example\Controller\Base $controller * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">   . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\Example\Controller\Base $controller)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;controller = $controller; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> isLogin bool * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">     */</span></span> $controller-&gt;getView()-&gt;isLogin = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isLogin(); <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> $client_id int */</span></span> $client_id = SHOP_ID; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> $redirect_uri string * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment"> URL  */</span></span> $redirect_uri = <span class="hljs-string"><span class="hljs-string">"http://example_site_domain.org/login"</span></span>; $display = <span class="hljs-string"><span class="hljs-string">"page"</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> $scope strung * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">   */</span></span> $scope = <span class="hljs-string"><span class="hljs-string">"f_name,s_name,m_name,sex,birth_day,group,e_mail,phone,country,city,balance"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isLogin()) { <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">   ,      */</span></span> $controller-&gt;getView()-&gt;userName = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userInfo[<span class="hljs-string"><span class="hljs-string">'f_name'</span></span>] . <span class="hljs-string"><span class="hljs-string">" "</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userInfo[<span class="hljs-string"><span class="hljs-string">'s_name'</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@desc</span></span></span><span class="hljs-comment">    ,       */</span></span> $controller-&gt;getView()-&gt;linkZpAuth = sprintf(<span class="hljs-string"><span class="hljs-string">"https://z-payment.ru/enter.php?client_id=%s&amp;redirect_uri=%s&amp;display=%s&amp;scope=%s"</span></span>, $client_id, $redirect_uri, $display, $scope); } } }</code> </pre><br></div></div><br>  As you can see, the authorization process is almost identical to other Internet services offering this feature, especially if you look at the VKontakte API.  :) <br><br>  Thank you for your patience in the process of reading my humble work and I want to answer the question that you started to torment after reading the first paragraph - ‚ÄúWhy should I screw up authorization through ZP, if they have significantly less users than VK, Gmail, Facebook, etc.?‚Äù , I answer: In contrast to the numerous implementations of the OAuth protocol on other sites, authorization through the Z-Payment API implies obtaining verified information about the user, and this is very important for all projects related to e-commerce. <br><br>  Read more about the Z-Payment API in the <a href="">InterfaceHTTPS.zip</a> doc file. </div><p>Source: <a href="https://habr.com/ru/post/149243/">https://habr.com/ru/post/149243/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../149237/index.html">Javascript and jQuery bikes</a></li>
<li><a href="../149238/index.html">PostgreSQL vs Oracle</a></li>
<li><a href="../149239/index.html">Automatic code check for PHP</a></li>
<li><a href="../149241/index.html">1C server 8.2 + MsSql 2008 + BackUp</a></li>
<li><a href="../149242/index.html">Google Play tightens requirements</a></li>
<li><a href="../149244/index.html">Client-server communication in Unity3d</a></li>
<li><a href="../149247/index.html">Developer, do not be afraid of the new iPhone</a></li>
<li><a href="../149248/index.html">InterSystems Database Mirroring. Creating and testing mirrors. Part 2</a></li>
<li><a href="../149249/index.html">How and why sites are blocked</a></li>
<li><a href="../149251/index.html">SilkRoad's monthly turnover reaches $ 2 million</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>