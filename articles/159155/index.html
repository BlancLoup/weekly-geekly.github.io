<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Write CLI module for Zend Framework 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings 

 Recently I started working with Zend Framework 2, and I needed to write a cli module that works with database migrations. 

 In this arti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Write CLI module for Zend Framework 2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/ded/876/fb1/ded876fb1fd9ec5b7d42a73ed7a7519f.png" alt="image" align="left"><br>  Greetings <br><br>  Recently I started working with Zend Framework 2, and I needed to write a cli module that works with database migrations. <br><br>  In this article I will describe how to create a module for Zend 2 to work with it from the command line using the example of the migration module, how to write tests, how to publish a module in packagist.org 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i>What are migrations: Database migrations are a class system that describes actions on a database and allows you to perform these actions.</i> <br><br><h4>  <b>Installing the framework</b> </h4><br>  Let's start with the installation of the framework, take ZendSkeletonApplication as the framework <br><a name="habracut"></a><br>  We clone ZendSkeletonApplication, it is an application skeleton. <br>  cd projects_dir / <br>  git clone git: //github.com/zendframework/ZendSkeletonApplication.git <br>  // rename to SampleZendModule <br>  mv ZendSkeletonApplication SampleZendModule <br>  // install zendframework itself through the composer <br>  php composer.phar self-update <br>  php composer.phar install <br><br>  Read more about the basic installation and quick start here. <br>  <a href="http://framework.zend.com/manual/2.0/en/index.html">framework.zend.com/manual/2.0/en/index.html</a> in the User Guide <br><br><h4>  <b>general description</b> </h4><br>  Console tasks with Zend 2 are written using MVC technology similarly to web MVC, using a similar routing system, which is only slightly different due to the specifics of console parameters. <br><br>  The router determines which command to call and calls the required controller, passing all the data to it. <br><br>  Which is typical, for the web and the console one and the same controllers are used, the differences are probably only in the use of Zend \ Console \ Request instead of Zend \ Http \ Request and Zend \ Console \ Response instead of Zend \ Http \ Response, the request and response object, respectively. <br><br>  The point of interaction with console commands is a single entry point, the same as responsible for web interaction, i.e.  usually it is /project/public/index.php <br><br><h4>  <b>Creating a module framework</b> </h4><br>  Since Zend 2 still doesn‚Äôt have console utilities for generating code, you‚Äôll have to create a module by hand. <br><br>  Create the following directory structure from the project root <br>  / project / <br>  - / module / - shared folder with modules, by default there is an Application which must be required <br>  ---- / knyzev / - the name of the group of modules or the developer, in general, you can not specify, but if you publish on packagist.org, then he wants a composite name of the type group / package <br>  ------ / zend-db-migrations / - this is the module directory itself <br>  -------- / config / - folder for configs <br>  -------- / src / - main folder with classes <br>  ---------- / ZendDbMigrations / - directory corresponding to the namespace <br>  ------------ / Controller / - controllers <br>  ------------ / Library / - library for work migrations <br>  ------------ Module.php - class that provides general information about the module <br>  ------------README.md - module description <br>  ------------ composer.json - description of the module and dependencies so that it can be published on packagist.org <br><br>  In Zend 2, an application is built as modules, each of which can define controllers, services, etc. <br><br><h5>  <b>Configuration</b> </h5><br>  Let's start with the config folder, here you need to create a file module.config.php containing the config, I got this file contents. <br><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'migrations'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'dir'</span></span> =&gt; dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>) . <span class="hljs-string"><span class="hljs-string">'/../../../../migrations'</span></span>, <span class="hljs-string"><span class="hljs-string">'namespace'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'ZendDbMigrations\Migrations'</span></span>, <span class="hljs-string"><span class="hljs-string">'show_log'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> ), <span class="hljs-string"><span class="hljs-string">'console'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'router'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'routes'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'db_migrations_version'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'simple'</span></span>, <span class="hljs-string"><span class="hljs-string">'options'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'route'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'db_migrations_version [--env=]'</span></span>, <span class="hljs-string"><span class="hljs-string">'defaults'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'controller'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'ZendDbMigrations\Controller\Migrate'</span></span>, <span class="hljs-string"><span class="hljs-string">'action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'version'</span></span> ) ) ), <span class="hljs-string"><span class="hljs-string">'db_migrations_migrate'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'simple'</span></span>, <span class="hljs-string"><span class="hljs-string">'options'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'route'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'db_migrations_migrate [&lt;version&gt;] [--env=]'</span></span>, <span class="hljs-string"><span class="hljs-string">'defaults'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'controller'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'ZendDbMigrations\Controller\Migrate'</span></span>, <span class="hljs-string"><span class="hljs-string">'action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'migrate'</span></span> ) ) ), <span class="hljs-string"><span class="hljs-string">'db_migrations_generate'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'simple'</span></span>, <span class="hljs-string"><span class="hljs-string">'options'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'route'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'db_migrations_generate [--env=]'</span></span>, <span class="hljs-string"><span class="hljs-string">'defaults'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'controller'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'ZendDbMigrations\Controller\Migrate'</span></span>, <span class="hljs-string"><span class="hljs-string">'action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'generateMigrationClass'</span></span> ) ) ) ) ) ), <span class="hljs-string"><span class="hljs-string">'controllers'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'invokables'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'ZendDbMigrations\Controller\Migrate'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'ZendDbMigrations\Controller\MigrateController'</span></span> ), ), <span class="hljs-string"><span class="hljs-string">'view_manager'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'template_path_stack'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/../view'</span></span>, ), ), );</code> </pre> <br><br>  In this configuration, controllers and view_manager describe where the templates are stored and which controllers will be called, as I understood this abbreviation, apparently you can turn directly, these parameters are standard for all modules. <br><br>  Migrations are the settings of my module that set the migration storage directory, in my case it is the project root directory, the namespace specified in the migration classes and show_log determining the output of logs to the console. <br><br>  Console is the configuration of console routing, in Zend 2, the definition of console parameters occurs through a routing system similar to that used in the web part <br><br>  More information about the work of console routing can be found here. <br>  <a href="http://framework.zend.com/manual/2.0/en/modules/zend.console.routes.html">framework.zend.com/manual/2.0/en/modules/zend.console.routes.html</a> <br><br>  About the usual http routing here <br>  <a href="http://framework.zend.com/manual/2.0/en/modules/zend.mvc.routing.html">framework.zend.com/manual/2.0/en/modules/zend.mvc.routing.html</a> <br><br>  So, we create routes.  In this case, we need three routes. <br>  1. db_migrations_version - displays info about the current database version <br>  2. db_migrations_migrate [] [--env =] - performs or rolls back the database migration <br>  3. db_migrations_generate - generates a stub for the database <br><br>  Description of the parameters of the route: <br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">'db_migrations_migrate'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'simple'</span></span>, <span class="hljs-string"><span class="hljs-string">'options'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'route'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'db_migrations_migrate [&lt;version&gt;] [--env=]'</span></span>, <span class="hljs-string"><span class="hljs-string">'defaults'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'controller'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'ZendDbMigrations\Controller\Migrate'</span></span>, <span class="hljs-string"><span class="hljs-string">'action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'migrate'</span></span> ) ) ),</code> </pre><br><br>  type - type of route <br>  options / route - the name of the console command with parameters and options, if the parameter is optional, it is enclosed in square brackets, a detailed description of the link above. <br>  options / defaults / controller - controller processing route <br>  options / defaults / action - action in the controller <br><br><h5>  <b>Controller</b> </h5><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * Zend Framework (http://framework.zend.com/) * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> http://github.com/zendframework/ZendSkeletonApplication for the canonical source repository * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@copyright</span></span></span><span class="hljs-comment"> Copyright (c) 2005-2012 Zend Technologies USA Inc. (http://www.zend.com) * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@license</span></span></span><span class="hljs-comment"> http://framework.zend.com/license/new-bsd New BSD License */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ZendDbMigrations</span></span>\<span class="hljs-title"><span class="hljs-title">Controller</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Zend</span></span>\<span class="hljs-title"><span class="hljs-title">Mvc</span></span>\<span class="hljs-title"><span class="hljs-title">Controller</span></span>\<span class="hljs-title"><span class="hljs-title">AbstractActionController</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Zend</span></span>\<span class="hljs-title"><span class="hljs-title">View</span></span>\<span class="hljs-title"><span class="hljs-title">Model</span></span>\<span class="hljs-title"><span class="hljs-title">ViewModel</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Zend</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Request</span></span> <span class="hljs-title"><span class="hljs-title">as</span></span> <span class="hljs-title"><span class="hljs-title">ConsoleRequest</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">ZendDbMigrations</span></span>\<span class="hljs-title"><span class="hljs-title">Library</span></span>\<span class="hljs-title"><span class="hljs-title">Migration</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">ZendDbMigrations</span></span>\<span class="hljs-title"><span class="hljs-title">Library</span></span>\<span class="hljs-title"><span class="hljs-title">MigrationException</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">ZendDbMigrations</span></span>\<span class="hljs-title"><span class="hljs-title">Library</span></span>\<span class="hljs-title"><span class="hljs-title">GeneratorMigrationClass</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">ZendDbMigrations</span></span>\<span class="hljs-title"><span class="hljs-title">Library</span></span>\<span class="hljs-title"><span class="hljs-title">OutputWriter</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *      */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MigrateController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractActionController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** *     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> \Migrations\Library\Migration */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMigration</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ $adapter = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getServiceLocator()-&gt;get(<span class="hljs-string"><span class="hljs-string">'Zend\Db\Adapter\Adapter'</span></span>); $config = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getServiceLocator()-&gt;get(<span class="hljs-string"><span class="hljs-string">'Configuration'</span></span>); $console = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getServiceLocator()-&gt;get(<span class="hljs-string"><span class="hljs-string">'console'</span></span>); $output = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($config[<span class="hljs-string"><span class="hljs-string">'migrations'</span></span>][<span class="hljs-string"><span class="hljs-string">'show_log'</span></span>]) { $output = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OutputWriter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($message)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($console)</span></span></span><span class="hljs-function"> </span></span>{ $console-&gt;write($message . <span class="hljs-string"><span class="hljs-string">"\n"</span></span>); }); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Migration($adapter, $config[<span class="hljs-string"><span class="hljs-string">'migrations'</span></span>][<span class="hljs-string"><span class="hljs-string">'dir'</span></span>], $config[<span class="hljs-string"><span class="hljs-string">'migrations'</span></span>][<span class="hljs-string"><span class="hljs-string">'namespace'</span></span>], $output); } <span class="hljs-comment"><span class="hljs-comment">/** *     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> integer */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">versionAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ $migration = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getMigration(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sprintf(<span class="hljs-string"><span class="hljs-string">"Current version %s\n"</span></span>, $migration-&gt;getCurrentVersion()); } <span class="hljs-comment"><span class="hljs-comment">/** *  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">migrateAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ $migration = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getMigration(); $version = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getRequest()-&gt;getParam(<span class="hljs-string"><span class="hljs-string">'version'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(is_null($version) &amp;&amp; $migration-&gt;getCurrentVersion() &gt;= $migration-&gt;getMaxMigrationNumber($migration-&gt;getMigrationClasses())) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"No migrations to execute.\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{ $migration-&gt;migrate($version); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Migrations executed!\n"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (MigrationException $e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"ZendDbMigrations\Library\MigrationException\n"</span></span> . $e-&gt;getMessage() . <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; } } <span class="hljs-comment"><span class="hljs-comment">/** *       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generateMigrationClassAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ $adapter = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getServiceLocator()-&gt;get(<span class="hljs-string"><span class="hljs-string">'Zend\Db\Adapter\Adapter'</span></span>); $config = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getServiceLocator()-&gt;get(<span class="hljs-string"><span class="hljs-string">'Configuration'</span></span>); $generator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GeneratorMigrationClass($config[<span class="hljs-string"><span class="hljs-string">'migrations'</span></span>][<span class="hljs-string"><span class="hljs-string">'dir'</span></span>], $config[<span class="hljs-string"><span class="hljs-string">'migrations'</span></span>][<span class="hljs-string"><span class="hljs-string">'namespace'</span></span>]); $className = $generator-&gt;generate(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sprintf(<span class="hljs-string"><span class="hljs-string">"Generated class %s\n"</span></span>, $className); } }</code> </pre><br><br>  Here is an example of a typical controller, the Action (Action) to which the routing route is attached has a name of the form [name] Action, Action is an obligatory part, and name is a command name. <br><br>  The request parameters are retrieved through the Zend / Console / Request classes, through the inherited base controller class <br>  $ this-&gt; getRequest () -&gt; getParam ('version') - so we got the version parameter from the route db_migrations_migrate [] <br><br>  Anything returned from plain text methods like in this example will be wrapped in the ViewModel and output directly to the console. <br><br>  For asynchronous output to the console as the application runs, you need to use Zend / Console / Response which is available through the service locator $ this-&gt; getServiceLocator () -&gt; get ('console'). Supports the write, writeAt, writeLine methods.  Detailed description and parameters can be found in the documentation. <br><br><h5>  <b>Module.php</b> </h5><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ZendDbMigrations</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Zend</span></span>\<span class="hljs-title"><span class="hljs-title">Mvc</span></span>\<span class="hljs-title"><span class="hljs-title">ModuleRouteListener</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Zend</span></span>\<span class="hljs-title"><span class="hljs-title">ModuleManager</span></span>\<span class="hljs-title"><span class="hljs-title">Feature</span></span>\<span class="hljs-title"><span class="hljs-title">AutoloaderProviderInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Zend</span></span>\<span class="hljs-title"><span class="hljs-title">ModuleManager</span></span>\<span class="hljs-title"><span class="hljs-title">Feature</span></span>\<span class="hljs-title"><span class="hljs-title">ConfigProviderInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Zend</span></span>\<span class="hljs-title"><span class="hljs-title">ModuleManager</span></span>\<span class="hljs-title"><span class="hljs-title">Feature</span></span>\<span class="hljs-title"><span class="hljs-title">ConsoleUsageProviderInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Zend</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Adapter</span></span>\<span class="hljs-title"><span class="hljs-title">AdapterInterface</span></span> <span class="hljs-title"><span class="hljs-title">as</span></span> <span class="hljs-title"><span class="hljs-title">Console</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Zend</span></span>\<span class="hljs-title"><span class="hljs-title">ModuleManager</span></span>\<span class="hljs-title"><span class="hljs-title">Feature</span></span>\<span class="hljs-title"><span class="hljs-title">ConsoleBannerProviderInterface</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Module</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AutoloaderProviderInterface</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigProviderInterface</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConsoleUsageProviderInterface</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConsoleBannerProviderInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBootstrap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($e)</span></span></span><span class="hljs-function"> </span></span>{ $e-&gt;getApplication()-&gt;getServiceManager()-&gt;get(<span class="hljs-string"><span class="hljs-string">'translator'</span></span>); $eventManager = $e-&gt;getApplication()-&gt;getEventManager(); $moduleRouteListener = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModuleRouteListener(); $moduleRouteListener-&gt;attach($eventManager); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getConfig</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/config/module.config.php'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAutoloaderConfig</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'Zend\Loader\StandardAutoloader'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'namespaces'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">__NAMESPACE__</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/src/'</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">__NAMESPACE__</span></span>, ), ), ); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getConsoleBanner</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Console $console)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'DB Migrations Module'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getConsoleUsage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Console $console)</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">//description command return array( 'db_migrations_version' =&gt; 'Get current migration version', 'db_migrations_migrate [&lt;version&gt;]' =&gt; 'Execute migrate', 'db_migrations_generate' =&gt; 'Generate new migration class' ); } }</span></span></code> </pre><br><br>  The Module.php file provides some information about the module; all Module.php files are automatically loaded each time it is launched to load configuration files and other data. <br><br>  In this case, the Module class will look like this. <br><br>  It is worth noting that in order to call a console script without parameters, it lists all existing commands, you need to add support for the ConsoleUsageProviderInterface interface and its implementation, which is the output of an array of commands with the description as in the example above. <br><br>  So for example when running a command <br>  php public / index.php <br>  all the commands returned by the getConsoleUsage method of our module will be displayed. <br><br><h5>  <b>Creating PHPUnit tests</b> </h5><br>  Tests in MVC Zend 2 are usually placed in the tests folder in the project root and fully correspond to the module structure. <br><br>  for example <br>  / project / <br>  - / module / <br>  - / knyzev / <br>  --- / zend-db-migrations / <br>  ---- / src / <br>  ----- / ZendDbMigrations / <br>  ------ / Controller / <br>  ------- / MigrateController.php <br>  - / tests / <br>  - / knyzev / <br>  --- / zend-db-migrations / <br>  ---- / src / <br>  ----- / ZendDbMigrations / <br>  ------ / Controller / <br>  ------- / MigrateControllerTest.php <br><br>  And I will give an example of tests for the class MigrateController <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Tests</span></span>\<span class="hljs-title"><span class="hljs-title">ZendDbMigrations</span></span>\<span class="hljs-title"><span class="hljs-title">Controller</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">ZendDbMigrations</span></span>\<span class="hljs-title"><span class="hljs-title">Controller</span></span>\<span class="hljs-title"><span class="hljs-title">MigrateController</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Zend</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Request</span></span> <span class="hljs-title"><span class="hljs-title">as</span></span> <span class="hljs-title"><span class="hljs-title">ConsoleRequest</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Zend</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Response</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Zend</span></span>\<span class="hljs-title"><span class="hljs-title">Mvc</span></span>\<span class="hljs-title"><span class="hljs-title">MvcEvent</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Zend</span></span>\<span class="hljs-title"><span class="hljs-title">Mvc</span></span>\<span class="hljs-title"><span class="hljs-title">Router</span></span>\<span class="hljs-title"><span class="hljs-title">RouteMatch</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">PHPUnit_Framework_TestCase</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> \<span class="hljs-title"><span class="hljs-title">Bootstrap</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Zend</span></span>\<span class="hljs-title"><span class="hljs-title">Db</span></span>\<span class="hljs-title"><span class="hljs-title">Adapter</span></span>\<span class="hljs-title"><span class="hljs-title">Adapter</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Zend</span></span>\<span class="hljs-title"><span class="hljs-title">Db</span></span>\<span class="hljs-title"><span class="hljs-title">Metadata</span></span>\<span class="hljs-title"><span class="hljs-title">Metadata</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *   MigrateController */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MigrateControllerTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PHPUnit_Framework_TestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $controller; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $request; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $response; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $routeMatch; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $event; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $eventManager; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $serviceManager; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $dbAdapter; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $connection; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $metadata; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $folderMigrationFixtures; <span class="hljs-comment"><span class="hljs-comment">/** *  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $bootstrap = \Zend\Mvc\Application::init(Bootstrap::getAplicationConfiguration()); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConsoleRequest(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;routeMatch = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RouteMatch(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'controller'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'migrate'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;event = $bootstrap-&gt;getMvcEvent(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;event-&gt;setRouteMatch(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;routeMatch); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;eventManager = $bootstrap-&gt;getEventManager(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;serviceManager = $bootstrap-&gt;getServiceManager(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;dbAdapter = $bootstrap-&gt;getServiceManager()-&gt;get(<span class="hljs-string"><span class="hljs-string">'Zend\Db\Adapter\Adapter'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;dbAdapter-&gt;getDriver()-&gt;getConnection(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;metadata = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Metadata(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;dbAdapter); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;folderMigrationFixtures = dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>) . <span class="hljs-string"><span class="hljs-string">'/../MigrationsFixtures'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;initController(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;tearDown(); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tearDown</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;dbAdapter-&gt;query(<span class="hljs-string"><span class="hljs-string">'DROP TABLE IF EXISTS migration_version CASCADE;'</span></span>, Adapter::QUERY_MODE_EXECUTE); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;dbAdapter-&gt;query(<span class="hljs-string"><span class="hljs-string">'DROP TABLE IF EXISTS test_migrations CASCADE;'</span></span>, Adapter::QUERY_MODE_EXECUTE); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;dbAdapter-&gt;query(<span class="hljs-string"><span class="hljs-string">'DROP TABLE IF EXISTS test_migrations2 CASCADE;'</span></span>, Adapter::QUERY_MODE_EXECUTE); $iterator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \GlobIterator(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;folderMigrationFixtures . <span class="hljs-string"><span class="hljs-string">'/tmp/*'</span></span>, \FilesystemIterator::KEY_AS_FILENAME); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($iterator <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $item) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($item-&gt;isFile()) { unlink($item-&gt;getPath() . <span class="hljs-string"><span class="hljs-string">'/'</span></span> . $item-&gt;getFilename()); } } chmod(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;folderMigrationFixtures . <span class="hljs-string"><span class="hljs-string">'/tmp'</span></span>, <span class="hljs-number"><span class="hljs-number">0775</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;controller = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MigrateController(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;controller-&gt;setEvent(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;event); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;controller-&gt;setEventManager(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;eventManager); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;controller-&gt;setServiceLocator(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;serviceManager); } <span class="hljs-comment"><span class="hljs-comment">/** *      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testVersion</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;routeMatch-&gt;setParam(<span class="hljs-string"><span class="hljs-string">'action'</span></span>, <span class="hljs-string"><span class="hljs-string">'version'</span></span>); $result = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;controller-&gt;dispatch(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;request); $response = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;controller-&gt;getResponse(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals(<span class="hljs-number"><span class="hljs-number">200</span></span>, $response-&gt;getStatusCode(), <span class="hljs-string"><span class="hljs-string">'Status code is 200 OK!'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertInstanceOf(<span class="hljs-string"><span class="hljs-string">'Zend\View\Model\ViewModel'</span></span>, $result, <span class="hljs-string"><span class="hljs-string">'Method return object Zend\View\Model\ViewModel!'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals(<span class="hljs-string"><span class="hljs-string">"Current version 0\n"</span></span>, $result-&gt;getVariable(<span class="hljs-string"><span class="hljs-string">'result'</span></span>), <span class="hljs-string"><span class="hljs-string">'Returt value is correctly!'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    $this-&gt;connection-&gt;execute('INSERT INTO migration_version (version) VALUES (12345678910)'); // $result = $this-&gt;controller-&gt;dispatch($this-&gt;request); $response = $this-&gt;controller-&gt;getResponse(); $this-&gt;assertEquals("Current version 12345678910\n", $result-&gt;getVariable('result'), 'Returt value is correctly!'); } /** *        */ public function testMigrateIfNotMigrations() { $this-&gt;routeMatch-&gt;setParam('action', 'migrate'); $result = $this-&gt;controller-&gt;dispatch($this-&gt;request); $response = $this-&gt;controller-&gt;getResponse(); $this-&gt;assertEquals(200, $response-&gt;getStatusCode(), 'Status code is 200 OK!'); $this-&gt;assertInstanceOf('Zend\View\Model\ViewModel', $result, 'Method return object Zend\View\Model\ViewModel!'); $this-&gt;assertEquals("No migrations to execute.\n", $result-&gt;getVariable('result'), 'Return correct info if no exists not executable migations!'); } /** *       */ public function testMigrationIfExistsMigrations(){ //       copy($this-&gt;folderMigrationFixtures . '/MigrationsGroup1/Version20121110210200.php', $this-&gt;folderMigrationFixtures . '/tmp/Version20121110210200.php'); $this-&gt;routeMatch-&gt;setParam('action', 'migrate'); $result = $this-&gt;controller-&gt;dispatch($this-&gt;request); $response = $this-&gt;controller-&gt;getResponse(); $this-&gt;assertEquals(200, $response-&gt;getStatusCode(), 'Status code is 200 OK!'); $this-&gt;assertEquals("Migrations executed!\n", $result-&gt;getVariable('result'), 'Return correct info if executed migrations!'); //     $this-&gt;assertTrue(in_array('test_migrations', $this-&gt;metadata-&gt;getTableNames()), 'Migration real executed!'); //         $this-&gt;initController(); $this-&gt;routeMatch-&gt;setParam('action', 'migrate'); $this-&gt;routeMatch-&gt;setParam('version', 20121110210200); $result = $this-&gt;controller-&gt;dispatch($this-&gt;request); $response = $this-&gt;controller-&gt;getResponse(); $this-&gt;assertEquals(200, $response-&gt;getStatusCode(), 'Status code is 200 OK!'); $this-&gt;assertContains("Migration version 20121110210200 is current version!\n", $result-&gt;getVariable('result'), 'Starting the migration with a current version works correctly!'); } /** *       */ public function testMigrateWithVersion() { copy($this-&gt;folderMigrationFixtures . '/MigrationsGroup2/Version20121111150900.php', $this-&gt;folderMigrationFixtures . '/tmp/Version20121111150900.php'); copy($this-&gt;folderMigrationFixtures . '/MigrationsGroup2/Version20121111153700.php', $this-&gt;folderMigrationFixtures . '/tmp/Version20121111153700.php'); $this-&gt;routeMatch-&gt;setParam('action', 'migrate'); $this-&gt;routeMatch-&gt;setParam('version', 20121111150900); $result = $this-&gt;controller-&gt;dispatch($this-&gt;request); $response = $this-&gt;controller-&gt;getResponse(); $this-&gt;assertEquals(200, $response-&gt;getStatusCode(), 'Status code is 200 OK!'); $this-&gt;assertTrue(in_array('test_migrations', $this-&gt;metadata-&gt;getTableNames()), 'Migration 20121111150900 execucte ok!'); $this-&gt;assertFalse(in_array('test_migrations2', $this-&gt;metadata-&gt;getTableNames()), 'Migration 20121111153700 not execucte ok!'); } /** *      */ public function testGenerateMigrationClass() { $this-&gt;routeMatch-&gt;setParam('action', 'generateMigrationClass'); $result = $this-&gt;controller-&gt;dispatch($this-&gt;request); $response = $this-&gt;controller-&gt;getResponse(); $this-&gt;assertEquals(200, $response-&gt;getStatusCode(), 'Status code is 200 OK!'); $this-&gt;assertInstanceOf('Zend\View\Model\ViewModel', $result, 'Method return object Zend\View\Model\ViewModel!'); $this-&gt;assertContains("Generated class ", $result-&gt;getVariable('result'), 'Return result info ok!'); $fileName = sprintf('Version%s.php', date('YmdHis', time())); $this-&gt;assertFileExists($this-&gt;folderMigrationFixtures . '/tmp/' . $fileName, 'Generate command real generated class!'); } }</span></span></code> </pre><br><br>  Read more about the structure of the tests can be read here. <br>  <a href="http://framework.zend.com/manual/2.0/en/user-guide/unit-testing.html">framework.zend.com/manual/2.0/en/user-guide/unit-testing.html</a> <br><br>  There is a nuance here, in Zend 2, work with environments is not supported, so you need to invent your bike to work with the test base. <br><br><h4>  <b>Composer.json and adding a module to packagist.org</b> </h4><br>  Now we have to describe the module in the json composer and publish it. <br>  Create the file composer.json in the module root with the following information <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"knyzev/zend-db-migrations"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"Module for managment database migrations."</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"library"</span></span>, <span class="hljs-string"><span class="hljs-string">"license"</span></span>: <span class="hljs-string"><span class="hljs-string">"BSD-3-Clause"</span></span>, <span class="hljs-string"><span class="hljs-string">"keywords"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"database"</span></span>, <span class="hljs-string"><span class="hljs-string">"db"</span></span>, <span class="hljs-string"><span class="hljs-string">"migrations"</span></span>, <span class="hljs-string"><span class="hljs-string">"zf2"</span></span> ], <span class="hljs-string"><span class="hljs-string">"homepage"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://github.com/vadim-knyzev/ZendDbMigrations"</span></span>, <span class="hljs-string"><span class="hljs-string">"authors"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Vadim Knyzev"</span></span>, <span class="hljs-string"><span class="hljs-string">"email"</span></span>: <span class="hljs-string"><span class="hljs-string">"vadim.knyzev@gmail.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"homepage"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://vadim-knyzev.blogspot.com/"</span></span> } ], <span class="hljs-string"><span class="hljs-string">"require"</span></span>: { <span class="hljs-string"><span class="hljs-string">"php"</span></span>: <span class="hljs-string"><span class="hljs-string">"&gt;=5.3.3"</span></span>, <span class="hljs-string"><span class="hljs-string">"zendframework/zendframework"</span></span>: <span class="hljs-string"><span class="hljs-string">"2.*"</span></span> }, <span class="hljs-string"><span class="hljs-string">"autoload"</span></span>: { <span class="hljs-string"><span class="hljs-string">"psr-0"</span></span>: { <span class="hljs-string"><span class="hljs-string">"ZendDbMigrations"</span></span>: <span class="hljs-string"><span class="hljs-string">"src/"</span></span> }, <span class="hljs-string"><span class="hljs-string">"classmap"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"./Module.php"</span></span> ] } }</code> </pre><br><br>  name - the name of the module, it will also match the name of the module folder. <br>  require - dependencies <br>  The rest can be copied and described in a similar way. <br><br>  Next, register an account on <a href="https://github.com/">github.com</a> , choose a public repository, enter the name of the form MyZendModule <br>  On the local computer, initiate the git repository, and send everything to the github <br>  git init <br>  git remote add origin <a href="https://github.com/knyzev/zend-db-migrations">github.com/knyzev/zend-db-migrations</a> <br>  git add -A <br>  git commit -m "init commit" <br>  git push <br><br>  On the website <a href="http://packagist.org/">packagist.org we</a> register, select the submit package and add a link to github, it will automatically check the correctness of composer.json and report problems if any. <br><br>  Everything, now in a new project or someone else can in the main file composer.json <br>  just add a dependency, for example knyzev / zend-db-migrations <br>  execute commands <br>  php composer.phar self-update <br>  php composer.phar update <br>  And the module will be automatically installed, it remains only to register it in config / application.config.php <br><br><h4>  <b>Comparing Symfony 2 + Doctrine 2 and Zend 2</b> </h4><br>  I really like Symfony 2 and Doctrine 2 nd version and after working with annotations, full console support (console commands for all cases) and quite convenient announcement of services, Doctrine ORM system, zend looks rather gloomy and not comfortable, well, this is a personal subjective opinion , although it is possible and works in places faster and consumes less memory.  This impression is formed mainly due to the unfinishedness towards a quick start, i.e.  all you need to configure and finish yourself. <br>  After working with Symfony for a bit, I started thinking about the possibility of switching to Java Spring + Hibernate. <br><br>  The migration module itself described in this article can be found here. <br>  <a href="https://github.com/vadim-knyzev/ZendDbMigrations">github.com/vadim-knyzev/ZendDbMigrations</a> <br>  Tests are not included in the module, since  According to the standards of the typical structure of the module zend 2, tests are placed in a separate folder. <br><br>  PS: Does anyone know how to add a module to the module information page on the <a href="http://modules.zendframework.com/">modules.zendframework.com</a> site? <br><br>  <a href="http://framework.zend.com/manual/2.0/en/index.html">framework.zend.com/manual/2.0/en/index.html</a> <br>  <a href="https://github.com/vadim-knyzev/ZendDbMigrations">github.com/vadim-knyzev/ZendDbMigrations</a> <br>  <a href="http://vadim-knyzev.blogspot.com/">vadim-knyzev.blogspot.com</a> </div><p>Source: <a href="https://habr.com/ru/post/159155/">https://habr.com/ru/post/159155/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../159143/index.html">Lytro photos can now change perspective and color.</a></li>
<li><a href="../159145/index.html">Chrome extension - with chess and librarians</a></li>
<li><a href="../159147/index.html">Go to Fusion Drive</a></li>
<li><a href="../159151/index.html">New amendments to the law "On Information" are being prepared: pages of sites offer to block pointwise</a></li>
<li><a href="../159153/index.html">Trac and his friends Gitolite, Nginx and UWSGI</a></li>
<li><a href="../159161/index.html">Animals on CSS3 transitions & transforms</a></li>
<li><a href="../159165/index.html">Guitar Tabs 2.0</a></li>
<li><a href="../159171/index.html">Autopsy Meizu MX</a></li>
<li><a href="../159173/index.html">ImapFilter - a powerful tool for sorting mail</a></li>
<li><a href="../159177/index.html">Wheel speed counter squirrel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>