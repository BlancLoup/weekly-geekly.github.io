<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cleaning infected site files from malicious code. Continuation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, dear Habrayuzer! 

 This article is a logical continuation of this article . In one of the comments to it, left by the user Agel_Nash ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cleaning infected site files from malicious code. Continuation</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, dear Habrayuzer! <br><br>  This article is a logical continuation of <a href="http://habrahabr.ru/post/141710/">this article</a> .  In one of the <a href="http://habrahabr.ru/post/141710/">comments</a> to it, left by the user <a href="http://habrahabr.ru/users/agel_nash/" class="user_link">Agel_Nash</a> was indicated a new virus signature.  Files subject to attack - * .js. <br><br>  Several sites of our clients, which did not follow our recommendations to change FTP accesses, clean their cars from malware and change FTP, were infected with this virus.  The following code is <a href="http://pastebin.com/2PWJycAd">written to the</a> * .js file: <a href="http://pastebin.com/2PWJycAd">pastebin.com/2PWJycAd</a> .  It is placed in one line and strictly at the end of the file. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      With the help of simple manipulations, the code was deobfuscated.  For those who are interested, I post a readable view: of the <a href="http://pastebin.com/qaX1HLC9">given code</a> (the <a href="http://pastebin.com/M6U1xC6L">same code was</a> already indicated by <a href="http://habrahabr.ru/users/mrmystic/" class="user_link">MrMYSTIC</a> ). <a name="habracut"></a><br>  Deobfuscation was carried out in the simplest way.  I went to jsfiddle and, instead of eval, brought the generated code to the page.  It does simple manipulations, namely the following: Generates the path to the * .js file using url = 305yoy.bdcfwpndqm.is-a-therapist.com/g/, then collects the script element with the resulting path and adds it to the head of the page, to which worked. <br><br>  To clean the sites I used the scanner, about which I wrote in the last article.  However, I decided to ‚Äúbrush‚Äù it a little, taking into account the comments in the comments.  Special thanks for the constructive criticism of <a href="http://habrahabr.ru/users/charon/" class="user_link">charon</a> and <a href="http://habrahabr.ru/users/pro100tak/" class="user_link">pro100tak</a> (would put + if you could vote). <br><br>  The algorithm is old, it works line by line in files.  Therefore, it was necessary to identify for what to catch the scanner. <br><br>  Based on the specified <a href="http://habrahabr.ru/users/agel_nash/" class="user_link">Agel_Nash</a> , however, the scanner showed an unexpectedly small number of infected files.  Strange, because even if not thousands, but there are hundreds of * .js files in the project.  Began to dig and true, trust but verify.  The selected signature was not met everywhere because it is not finite.  Selectively checking several files in different distances from each other to directories, a couple of options were identified: <br><pre><code class="javascript hljs">)<span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>().prototype.q}<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(egewgsd){f=[</code> </pre> <br>  and <br><pre> <code class="javascript hljs">)<span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>().prototype.q}<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(egewgsd){f=[</code> </pre><br>  The difference is small and consists of two words: <br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>()  <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>()</code> </pre><br>  Supposedly, all types of data can be moved in this way: dates, numbers, strings, and so on.  Well, then take the rest of the line, namely: <br><pre> <code class="javascript hljs">().prototype.q}<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(egewgsd){f=[</code> </pre><br>  This time the scanner showed all the files that were infected with this virus.  Exactly what is needed!  It remains to check the Jquery, fancybox and a few other libraries used.  Pure ... No occurrences found in their source code.  Great, you can use. <br><br>  Slightly reworked the scanner and launched.  He again worked as planned, did not disappoint. <br><br>  <b>Changes:</b> <br>  - began to collect a list of signatures (at the moment there are two of them, you can run the scanner without the required string parameter); <br>  - indicates which of the signatures found in the file; <br>  - added function to delete backups (delete_backups ()); <br>  - the function call can be performed without parameters (in this case, the default values ‚Äã‚Äãare used): <br><pre> <code class="php hljs"> $dron-&gt;find(); $dron-&gt;scan(); $dron-&gt;restore_backups(); $dron-&gt;delete_backups();</code> </pre><br>  - added functionality to change the owner of the directory while working with her scanner, but I commented out this section.  It was not possible to test: <br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">/* //     $unformated_path_stat = stat($path); $path_stat = posix_getpwuid($unformated_path_stat['uid']); $path_user_name = $path_stat['name']; //     chown($path, 'www'); */</span></span> ... <span class="hljs-comment"><span class="hljs-comment">//     // chown($path, $path_user_name);</span></span></code> </pre><br>  - the function dir_content () is added which collects all files into an array, which is subsequently used by all other functions; <br>  - when scanning ignores itself. <br><br>  I give the code of the updated scanner, with detailed comments: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span> <span class="hljs-comment"><span class="hljs-comment">/* ---------------------------------------------------------------------------------- dScaner Class - START ---------------------------------------------------------------------------------- */</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> : dScaner * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> :          *    * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> :   * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment">  : 0.0.5 (13-04-2012) * */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">Class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dScaner</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   private $arr_files = array(); //     public $signatures = array( '=Array.prototype.slice.call(arguments).join(""),', '().prototype.q}catch(egewgsd){f=[' ); /** *      * * @param string $get_str   * @param string $separator     * @return array -    FALSE */ function request($get_str, $separator) { if (!empty($get_str)) { //        $obj = explode($separator, $get_str); return $obj; } else { return false; } } /** *       * * @param string $path -   ,      * @param string $files_allowed -  ,    */ function dir_content($path = './', $files_allowed = '.') { //      ,    $dir_disallow = array('.', '..', '.htaccess', '.git', 'zlordwaters'); if(is_dir($path)) { $temp = opendir($path); while (false !== ($dir = readdir($temp))) { if ((is_dir($path . $dir)) &amp;&amp; (!in_array($dir, $dir_disallow)) ) { //   -   $sub_dir = $path . $dir . '/'; $this-&gt;dir_content($sub_dir, $files_allowed); } elseif ((is_file($path . $dir)) &amp;&amp; (!in_array($dir, $dir_disallow)) &amp;&amp; (strpos($dir, $files_allowed) == true) &amp;&amp; (strpos($dir, '_BACKUP') == false) &amp;&amp; (strpos($dir, trim($_SERVER['SCRIPT_NAME'], '/')) === false) ) { //  ,     $this-&gt;arr_files[] = $path . $dir; } } closedir($temp); } } /** *       : * * @param string $path -   ,      * @param string $files_allowed -  ,    * @param string $requested_string -   */ function find($path = './', $files_allowed = '.', $requested_string = '().prototype.q}catch(egewgsd){f=[') { //      $this-&gt;dir_content($path, $files_allowed); foreach($this-&gt;arr_files AS $in_dir_file) { //     $temporary_file = file_get_contents($in_dir_file); //      $file_founded = false; //     $tf_strings = explode("\n", $temporary_file); //    foreach ($tf_strings AS $item) { //     $item = strval($item); if (strpos($item, $requested_string) !== false) { $file_founded = true; $founded_str = $requested_string; } //     foreach ($this-&gt;signatures AS $signa) { $signa = strval($signa); if (strpos($item, $signa) !== false) { $file_founded = true; $founded_str = $signa; } } } //      if ($file_founded) { //         print "&lt;span style='display:block; padding:5px; border:1px solid #1f4f18; background-color:#d5f5ce; font-size:12px; line-height:16px; font-family:tahoma, sans-serif; margin-bottom:-15px;'&gt;&lt;h3&gt;" . $in_dir_file . "&lt;/h3&gt;     . &lt;br&gt; C: &lt;b&gt;" . $founded_str . "&lt;/b&gt; &lt;/span&gt;&lt;br&gt;"; } } } /** *    : * * @param string $path -   ,      * @param string $files_allowed -  ,    * @param string $requested_string - ,       */ function scan($path = './', $files_allowed = '.', $requested_string = '().prototype.q}catch(egewgsd){f=[') { //      $this-&gt;dir_content($path, $files_allowed); foreach($this-&gt;arr_files AS $in_dir_file) { //     $temporary_file = file_get_contents($in_dir_file); //    $create_backup = false; //         $tf_strings = explode("\n", $temporary_file); //    $str_index = 0; //     foreach ($tf_strings AS $item) { //     $item = strval($item); if (strpos($item, $requested_string) !== false) { //        //   ,      $create_backup = true; //       unset($tf_strings[$str_index]); $founded_str = $requested_string; } //     foreach ($this-&gt;signatures AS $signa) { $signa = strval($signa); if (strpos($item, $signa) !== false) { //        //   ,      $create_backup = true; //       unset($tf_strings[$str_index]); $founded_str = $signa; } } //     $str_index++; } //   if ($create_backup) { /* //     $unformated_path_stat = stat($path); $path_stat = posix_getpwuid($unformated_path_stat['uid']); $path_user_name = $path_stat['name']; //     chown($path, 'www'); */ //              chmod($path, 0777); //     $temp_file_backup = $in_dir_file.'_BACKUP'; //       file_put_contents($temp_file_backup, $temporary_file); //      $scanned_file = implode("\n", $tf_strings); //    if (file_put_contents($in_dir_file, $scanned_file)) { //   print "&lt;span style='display:block; padding:5px; border:1px solid #1f4f18; background-color:#d5f5ce; font-size:12px; line-height:16px; font-family:tahoma, sans-serif; margin-bottom:-15px;'&gt;&lt;h3&gt;" . $in_dir_file . "&lt;/h3&gt;  . (+ BACKUP) &lt;br&gt; C: &lt;b&gt;" . $founded_str . "&lt;/b&gt; &lt;/span&gt;&lt;br&gt;"; } else { //    print "&lt;span style='display:block; padding:5px; border:1px solid #822121; background-color:#ea7575; font-size:12px; line-height:16px; font-family:tahoma, sans-serif; margin-bottom:-15px;'&gt;&lt;h3&gt;" . $in_dir_file . "&lt;/h3&gt;   . C: &lt;b&gt;" . $founded_str . "&lt;/b&gt; &lt;/span&gt;&lt;br&gt;"; } //          755 chmod($path, 0755); //     // chown($path, $path_user_name); } } } /** *     * * @param string $path -   ,      * @param string $files_allowed -  ,    */ function restore_backups($path = './', $files_allowed = '.') { //      $this-&gt;dir_content($path, $files_allowed); foreach($this-&gt;arr_files AS $in_dir_file) { if (is_file($in_dir_file.'_BACKUP')) { //  ,    $temporary_file_from_backup = file_get_contents($in_dir_file.'_BACKUP'); //    if (file_put_contents($in_dir_file, $temporary_file_from_backup)) { //   unlink($_SERVER['DOCUMENT_ROOT'].'/'.$in_dir_file.'_BACKUP'); //   print "&lt;span style='display:block; padding:5px; border:1px solid #1f4f18; background-color:#d5f5ce; font-size:12px; line-height:16px; font-family:tahoma, sans-serif; margin-bottom:-15px;'&gt;&lt;h3&gt;".$in_dir_file ."&lt;/h3&gt; . &lt;/span&gt;&lt;br&gt;"; } else { //    print "&lt;span style='display:block; padding:5px; border:1px solid #822121; background-color:#ea7575; font-size:12px; line-height:16px; font-family:tahoma, sans-serif; margin-bottom:-15px;'&gt;&lt;h3&gt;".$in_dir_file ."&lt;/h3&gt;  . &lt;/span&gt;&lt;br&gt;"; } } } } /** *     * * @param string $path -   ,       * @param string $files_allowed -  ,    */ function delete_backups($path = './', $files_allowed = '.') { //      $this-&gt;dir_content($path, $files_allowed); foreach($this-&gt;arr_files AS $in_dir_file) { if (is_file($in_dir_file.'_BACKUP')) { //  ,   if (unlink($_SERVER['DOCUMENT_ROOT'].'/'.$in_dir_file.'_BACKUP')) { print " &lt;span style='display:block; padding:5px; border:1px solid #1f4f18; background-color:#d5f5ce; font-size:12px; line-height:16px; font-family:tahoma, sans-serif; margin-bottom:-15px;'&gt;&lt;h3&gt;".$in_dir_file ."_BACKUP&lt;/h3&gt; . &lt;/span&gt;&lt;br&gt;"; } else { //    print "&lt;span style='display:block; padding:5px; border:1px solid #822121; background-color:#ea7575; font-size:12px; line-height:16px; font-family:tahoma, sans-serif; margin-bottom:-15px;'&gt;&lt;h3&gt;".$in_dir_file ."_BACKUP&lt;/h3&gt;  . &lt;/span&gt;&lt;br&gt;"; } } } } } /* ---------------------------------------------------------------------------------- dScaner Class - END ---------------------------------------------------------------------------------- */ </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br>  Well, an example of use with basic search options. <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span> <span class="hljs-comment"><span class="hljs-comment">//    -  $dron = new dScaner; //       $dron-&gt;find('./', '.'); //   // $dron-&gt;scan('./', '.'); //    // $dron-&gt;restore_backups('./', '.'); //    // $dron-&gt;delete_backups('./', '.'); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br><br>  That's all I wanted to share with you. <br>  Clean servers to you and their stable operation. <br>  Best Regards! </div><p>Source: <a href="https://habr.com/ru/post/141938/">https://habr.com/ru/post/141938/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../141932/index.html">Robot Petman learned to climb the stairs</a></li>
<li><a href="../141933/index.html">Semi-automatic lazy code conversion</a></li>
<li><a href="../141935/index.html">A free webinar about innovations in Team Foundation Server 11 for team development and the application development cycle</a></li>
<li><a href="../141936/index.html">How to quickly develop a mobile application? Feedback and experience of startups</a></li>
<li><a href="../141937/index.html">Backing up to Yandex.Disk using D√©j√† Dup in Ubuntu and not only in it</a></li>
<li><a href="../141940/index.html">YOTA begins testing a new LTE network in Moscow</a></li>
<li><a href="../141941/index.html">Withdrawing Yandex.Money to Visa cards in new countries</a></li>
<li><a href="../141943/index.html">We write "Snake" for Windows Phone 7</a></li>
<li><a href="../141944/index.html">CouchDB: the story of one accident</a></li>
<li><a href="../141945/index.html">The evolution of architecture: from "samopisnyh" services to HandlerSocket</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>