<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Maraquia - ORM for MongoDB</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After reading the title, many probably have a question - why another bike if there are already run-in Mongoose, Mongorito, TypeORM, etc.? To answer, y...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Maraquia - ORM for MongoDB</h1><div class="post__text post__text-html js-mediator-article"><p>  After reading the title, many probably have a question - why another bike if there are already run-in Mongoose, Mongorito, TypeORM, etc.?  To answer, you need to understand what is the difference between ORM and ODM.  Enjoying Wikipedia: </p><br><blockquote>  ORM (English Object-Relational Mapping, Russian object-relational mapping, or transformation) is a programming technology that links databases with the concepts of object-oriented programming languages, creating a "virtual object database." </blockquote><p>  That is, ORM is about relational data representation.  Let me remind you that in relational databases there is no possibility to simply take and embed a document in the field of another document (in this article, the records of the tables are also called documents, even though it is incorrect), you can of course be stored in the JSON field as a string, but the index does not make an will come out.  Instead, ‚Äúlinks‚Äù are used - in the field where the attached document should be, its identifier is written instead, and the document with this identifier is stored in the next table.  ORM can work with such links - records for them are automatically immediately or lazily taken from the database, and when saving, you do not need to first save the child document, take the identifier assigned to it, write it in the field of the parent document and only then save the parent document.  You just need to ask ORM to save the parent document and everything connected with it, and he (the object-relational mapper) will figure out how to do it correctly.  ODM, on the contrary, does not know how to work with such links, but it knows about embedded documents. </p><a name="habracut"></a><br><p>  I think the differences are roughly clear, so all of the above is exactly ODM.  Even TypeORM when working with MongoDB has some limitations ( <a href="https://github.com/typeorm/typeorm/issues/655">https://github.com/typeorm/typeorm/issues/655</a> ) which make it again an ordinary ODM. </p><br><p>  And then you ask - why?  Why working with document-oriented database did I need any links?  There is at least one simple, but often occurring situation when they are still necessary: ‚Äã‚Äãseveral parents point to a child document, here each parent can write a copy of the child and then suffer ensuring the consistency of the data in these copies, or you can simply save the child document in a separate collection, and give all parents a link to it (you can still embed the parent in the child, but this is not always possible, first, the relationship may be many-to-many, secondly, the child type may be too minor  n in the system, and tomorrow may disappear altogether from the database embedded in it something key does not want to). </p><br><p>  For a long time I have worked with RethinkDB for which there are some quite good ORMs ( <a href="https://github.com/neumino/thinky">thinky</a> , <a href="https://github.com/buckless/requelize">requelize</a> , ...), but recently the development activity of this database has been quite disheartening.  I decided to look in the direction of MongoDB and the first thing I <strong>didn‚Äôt</strong> find was these packages.  Why not write it yourself, it will be quite an interesting experience, I thought, and meet - Maraquia. </p><br><h2 id="ustanovka">  Installation </h2><br><pre><code class="hljs matlab">npm <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> -S maraquia</code> </pre> <br><p>  When used with typescript, you must also add <code>"experimentalDecorators": true</code> to <code>tsconfig.json</code> . </p><br><h2 id="nastroyka-soedineniya">  Connection setup </h2><br><p>  There are two ways, here we consider a simpler one: in the project folder we create the file <code>config/maraquia.json</code> to which we add the following: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"databaseUrl"</span></span>: <span class="hljs-string"><span class="hljs-string">"mongodb://localhost:27017/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"databaseName"</span></span>: <span class="hljs-string"><span class="hljs-string">"Test"</span></span> }</code> </pre> <br><h2 id="ispolzovanie">  Using </h2><br><h3 id="sohranenie-v-bd">  Saving to DB </h3><br><p>  A simple example of a one-to-many relationship with a link in one direction only (examples will be on typescript, at the end a javascript example): </p><br><pre> <code class="hljs scala"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { <span class="hljs-type"><span class="hljs-type">BaseModel</span></span>, <span class="hljs-type"><span class="hljs-type">Field</span></span>, <span class="hljs-type"><span class="hljs-type">Model</span></span> } from <span class="hljs-symbol"><span class="hljs-symbol">'maraqui</span></span>a'; <span class="hljs-meta"><span class="hljs-meta">@Model</span></span>({ collectionName: <span class="hljs-symbol"><span class="hljs-symbol">'Pe</span></span>t' }) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Pet</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>() name: string | <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Model</span></span>({ collectionName: <span class="hljs-symbol"><span class="hljs-symbol">'Owne</span></span>r' }) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Owner</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>() name: string | <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>(() =&gt; <span class="hljs-type"><span class="hljs-type">Pet</span></span>) pets: <span class="hljs-type"><span class="hljs-type">Promise</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Array</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Pet</span></span>&gt; | <span class="hljs-literal"><span class="hljs-literal">null</span></span>&gt;; } (async () =&gt; { <span class="hljs-comment"><span class="hljs-comment">//         let pet = new Pet({ name: 'Tatoshka' }); let owner = new Owner({ name: 'Dmitry', pets: [pet] }); await owner.save(); })();</span></span></code> </pre> <br><p>  Two collections <code>Pet</code> and <code>Owner</code> will appear in the database with entries: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"5a...1f44"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Tatoshka"</span></span> }</code> </pre> <br><p>  and </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"5a...1f43"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Dmitry"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pets"</span></span>: [<span class="hljs-string"><span class="hljs-string">"5a...1f44"</span></span>] }</code> </pre> <br><p>  The <code>save</code> method was called only on the <code>owner</code> model, Maraquia as it should be, she herself took care of saving the second document. </p><br><p>  Let's complicate the example, now the relation of many-to-many and references in both directions: </p><br><pre> <code class="hljs scala"><span class="hljs-meta"><span class="hljs-meta">@Model</span></span>({ collectionName: <span class="hljs-symbol"><span class="hljs-symbol">'Use</span></span>r' }) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>() name: string | <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>(() =&gt; <span class="hljs-type"><span class="hljs-type">Group</span></span>) groups: <span class="hljs-type"><span class="hljs-type">Promise</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Array</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Group</span></span>&gt; | <span class="hljs-literal"><span class="hljs-literal">null</span></span>&gt;; } <span class="hljs-meta"><span class="hljs-meta">@Model</span></span>({ collectionName: <span class="hljs-symbol"><span class="hljs-symbol">'Grou</span></span>p' }) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Group</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>() name: string | <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>(() =&gt; <span class="hljs-type"><span class="hljs-type">User</span></span>) users: <span class="hljs-type"><span class="hljs-type">Promise</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Array</span></span>&lt;<span class="hljs-type"><span class="hljs-type">User</span></span>&gt; | <span class="hljs-literal"><span class="hljs-literal">null</span></span>&gt;; } let user1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">User</span></span>({ name: <span class="hljs-symbol"><span class="hljs-symbol">'Dmitr</span></span>y' }); let user2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">User</span></span>({ name: <span class="hljs-symbol"><span class="hljs-symbol">'Tatoshk</span></span>a' }); let group1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Group</span></span>({ name: <span class="hljs-symbol"><span class="hljs-symbol">'Admin</span></span>s', users: [user1] }); let group2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Group</span></span>({ name: <span class="hljs-symbol"><span class="hljs-symbol">'Moderator</span></span>s', users: [user1, user2] }); user1.groups = [group1, group2] as any; user2.groups = [group2] as any; await group1.save();</code> </pre> <br><p>  The <code>User</code> collection will appear in the database with the entries: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"5a...c56f"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Dmitry"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"groups"</span></span>: [<span class="hljs-string"><span class="hljs-string">"5a...c56e"</span></span>, <span class="hljs-string"><span class="hljs-string">"5a...c570"</span></span>] } { <span class="hljs-attr"><span class="hljs-attr">"_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"5a...c571"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Tatoshka"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"groups"</span></span>: [<span class="hljs-string"><span class="hljs-string">"5a...c570"</span></span>] }</code> </pre> <br><p>  and the <code>Group</code> collection with entries: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"5a...c56e"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Admins"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"users"</span></span>: [<span class="hljs-string"><span class="hljs-string">"5a...c56f"</span></span>] } { <span class="hljs-attr"><span class="hljs-attr">"_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"5a...c570"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Moderators"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"users"</span></span>: [<span class="hljs-string"><span class="hljs-string">"5a...c56f"</span></span>, <span class="hljs-string"><span class="hljs-string">"5a...c571"</span></span>] }</code> </pre> <br><p>  You, probably, have already noticed the absence of decorators with names like <code>hasOne</code> , <code>hasMany</code> , <code>belongsTo</code> as it is usually accepted for ORM.  Maraquia copes without this additional information, hasOne or hasMany is determined by the value, the array means hasMany.  A built-in document or external (stored in a separate collection) is determined by the presence in its scheme of a filled <code>collectionName</code> .  For example, if in the first example you comment out the line <code>collectionName: 'Pet'</code> and restart it, then the entry will appear only in the <code>Owner</code> collection and will look like this: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"5b...ec43"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Dmitry"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pets"</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"Tatoshka"</span></span> }] }</code> </pre> <br><p>  In addition, the type of <code>pets</code> field is no longer promis. <br>  That is, with the help of Maraquia, you can also conveniently work with embedded documents. </p><br><h3 id="chtenie-iz-bd">  Reading from DB </h3><br><p>  Let's try to read from the database something from the previously saved: </p><br><pre> <code class="hljs coffeescript">let user = User.find&lt;User&gt;({ name: <span class="hljs-string"><span class="hljs-string">'Dmitry'</span></span> }); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(user <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> User); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(user.name); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-string"><span class="hljs-string">'Dmitry'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> user.groups); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> [Group { name: <span class="hljs-string"><span class="hljs-string">'Admins'</span></span>, ... }, Group { name: <span class="hljs-string"><span class="hljs-string">'Moderators'</span></span>, ... }]</code> </pre> <br><p>  When reading the <code>groups</code> field, the <code>await</code> keyword was used - external documents are retrieved from the database lazily when they first read the corresponding field. </p><br><p>  But what if you need to have access to the identifiers stored in the field without pulling out the corresponding documents from the database, but optionally you may need to pull them out?  The name of the field in the model corresponds to the name of the field in the document, but using the <code>dbFieldName</code> option <code>dbFieldName</code> can change this correspondence.  That is, by defining two fields in the model that refer to one field in the document and without specifying the type for one of them, you can solve this problem: </p><br><pre> <code class="hljs scala"><span class="hljs-meta"><span class="hljs-meta">@Model</span></span>({ collectionName: <span class="hljs-symbol"><span class="hljs-symbol">'Grou</span></span>p' }) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Group</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>({ dbFieldName: <span class="hljs-symbol"><span class="hljs-symbol">'user</span></span>s' }) readonly userIds: <span class="hljs-type"><span class="hljs-type">Array</span></span>&lt;<span class="hljs-type"><span class="hljs-type">ObjectId</span></span>&gt; | <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    @Field(() =&gt; User) users: Promise&lt;Array&lt;User&gt; | null&gt;; //       }</span></span></code> </pre> <br><h3 id="udalenie-dokumenta">  Deleting a document </h3><br><p>  The <code>remove</code> method removes the corresponding document from the database.  Maraquia does not know where there are links to it and here the programmer needs to work on his own: </p><br><pre> <code class="hljs scala"><span class="hljs-meta"><span class="hljs-meta">@Model</span></span>({ collectionName: <span class="hljs-symbol"><span class="hljs-symbol">'Use</span></span>r' }) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>() name: string | <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>({ dbFieldName: <span class="hljs-symbol"><span class="hljs-symbol">'group</span></span>s' }) groupIds: <span class="hljs-type"><span class="hljs-type">Array</span></span>&lt;<span class="hljs-type"><span class="hljs-type">ObjectId</span></span>&gt; | <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>(() =&gt; <span class="hljs-type"><span class="hljs-type">Group</span></span>) groups: <span class="hljs-type"><span class="hljs-type">Promise</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Array</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Group</span></span>&gt; | <span class="hljs-literal"><span class="hljs-literal">null</span></span>&gt;; } <span class="hljs-meta"><span class="hljs-meta">@Model</span></span>({ collectionName: <span class="hljs-symbol"><span class="hljs-symbol">'Grou</span></span>p' }) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Group</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>() name: string | <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>({ dbFieldName: <span class="hljs-symbol"><span class="hljs-symbol">'user</span></span>s' }) userIds: <span class="hljs-type"><span class="hljs-type">Array</span></span>&lt;<span class="hljs-type"><span class="hljs-type">ObjectId</span></span>&gt; | <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>(() =&gt; <span class="hljs-type"><span class="hljs-type">User</span></span>) users: <span class="hljs-type"><span class="hljs-type">Promise</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Array</span></span>&lt;<span class="hljs-type"><span class="hljs-type">User</span></span>&gt; | <span class="hljs-literal"><span class="hljs-literal">null</span></span>&gt;; } let user = (await <span class="hljs-type"><span class="hljs-type">User</span></span>.find&lt;<span class="hljs-type"><span class="hljs-type">User</span></span>&gt;({ name: <span class="hljs-symbol"><span class="hljs-symbol">'Tatoshk</span></span>a' }))!; <span class="hljs-comment"><span class="hljs-comment">//     for (let group of await Group.findAll&lt;Group&gt;({ _id: { $in: user.groupIds } })) { group.userIds = group.userIds!.filter( userId =&gt; userId.toHexString() != user._id!.toHexString() ); await group.save(); } //    await user.remove();</span></span></code> </pre> <br><p>  In this example, the <code>userIds</code> array <code>userIds</code> been replaced with a new one created by the <code>Array#filter</code> method, but the existing array can be changed, Maraquia finds such changes.  That is, it was possible so: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">group</span></span>.userIds!.splice( <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>.userIds!.findIndex(userId =&gt; userId.toHexString() == <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>._id!.toHexString()), <span class="hljs-number"><span class="hljs-number">1</span></span> );</code> </pre> <br><h3 id="validaciya">  Validation </h3><br><p>  To validate a field, you must add the <code>validate</code> property to its options: </p><br><pre> <code class="hljs pgsql">@Model({ collectionName: <span class="hljs-string"><span class="hljs-string">'User'</span></span> }) <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">User</span></span> extends BaseModel { @Field({ <span class="hljs-keyword"><span class="hljs-keyword">validate</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> =&gt; typeof <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> == <span class="hljs-string"><span class="hljs-string">'string'</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.trim().length &gt;= <span class="hljs-number"><span class="hljs-number">2</span></span> }) <span class="hljs-type"><span class="hljs-type">name</span></span>: string | <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; @Field({ <span class="hljs-keyword"><span class="hljs-keyword">validate</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> =&gt; { //  <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>     : <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> typeof <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> == <span class="hljs-string"><span class="hljs-string">'number'</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; //     : <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (typeof <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> != <span class="hljs-string"><span class="hljs-string">'number'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'-   '</span></span>; //  : <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> TypeError(<span class="hljs-string"><span class="hljs-string">'-   '</span></span>); //  : throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> TypeError(<span class="hljs-string"><span class="hljs-string">'-   '</span></span>); } } }) age: number | <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; @Field(() =&gt; Account, { <span class="hljs-keyword"><span class="hljs-keyword">validate</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> =&gt; !!<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> }) <span class="hljs-comment"><span class="hljs-comment">/*    : @Field({ type: () =&gt; Account, validate: value =&gt; !!value }) */</span></span> account: Promise&lt;Account | <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>&gt;; }</code> </pre> <br><p>  You can also transfer objects created by the <a href="https://www.npmjs.com/package/joi">joi</a> library: </p><br><pre> <code class="hljs scala"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * as joi from <span class="hljs-symbol"><span class="hljs-symbol">'jo</span></span>i'; <span class="hljs-meta"><span class="hljs-meta">@Model</span></span>({ collectionName: <span class="hljs-symbol"><span class="hljs-symbol">'Use</span></span>r' }) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>({ validate: joi.string().min(<span class="hljs-number"><span class="hljs-number">2</span></span>) }) name: string | <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Field</span></span>({ validate: joi.number().min(<span class="hljs-number"><span class="hljs-number">0</span></span>) }) age: number | <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre> <br><h3 id="huki">  Hooks </h3><br><p>  The following methods work according to their name: <code>beforeSave</code> , <code>afterSave</code> , <code>beforeRemove</code> , <code>afterRemove</code> . </p><br><h3 id="ispolzovanie-s-javascript">  Use with javascript </h3><br><p>  Typescript is great, but sometimes you need it without it.  To do this, instead of the object passed to the <code>Model</code> decorator, you need to define a <code>$schema</code> static field, which also has a <code>fields</code> field: </p><br><pre> <code class="hljs scala">const { <span class="hljs-type"><span class="hljs-type">BaseModel</span></span> } = require(<span class="hljs-symbol"><span class="hljs-symbol">'maraqui</span></span>a'); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Pet</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseModel</span></span></span><span class="hljs-class"> </span></span>{ } <span class="hljs-type"><span class="hljs-type">Pet</span></span>.$schema = { collectionName: <span class="hljs-symbol"><span class="hljs-symbol">'Pe</span></span>t', fields: { name: {} } }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Owner</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseModel</span></span></span><span class="hljs-class"> </span></span>{ } <span class="hljs-type"><span class="hljs-type">Owner</span></span>.$schema = { collectionName: <span class="hljs-symbol"><span class="hljs-symbol">'Owne</span></span>r', fields: { name: {}, pets: { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: () =&gt; <span class="hljs-type"><span class="hljs-type">Pet</span></span> } } }; let pet = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Pet</span></span>({ name: <span class="hljs-symbol"><span class="hljs-symbol">'Tatoshk</span></span>a' }); let owner = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Owner</span></span>({ name: <span class="hljs-symbol"><span class="hljs-symbol">'Dmitr</span></span>y', pets: [pet] }); await owner.save();</code> </pre> <br><p>  Writing to fields is done via the <code>setField</code> method: </p><br><pre> <code class="hljs cs">pet.setField(<span class="hljs-string"><span class="hljs-string">'name'</span></span>, <span class="hljs-string"><span class="hljs-string">'Tosha'</span></span>);</code> </pre> <br><p>  And reading fields with external documents through the <code>fetchField</code> method: </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">await</span></span> owner.fetchField(<span class="hljs-string"><span class="hljs-string">'pets'</span></span>);</code> </pre> <br><p>  The remaining fields are read as usual. </p><br><h2 id="proizvoditelnost">  Performance </h2><br><p>  I wrote a couple of simple benchmarks to compare performance with Mongoose and Mongorito.  In the first, instances of the model are simply created.  For all three, it looks the same: </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> cat = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Cat({ name: <span class="hljs-string"><span class="hljs-string">'Tatoshka'</span></span>, age: <span class="hljs-number"><span class="hljs-number">1</span></span>, gender: <span class="hljs-string"><span class="hljs-string">'1'</span></span>, email: <span class="hljs-string"><span class="hljs-string">'tatoshka@email.ru'</span></span>, phone: <span class="hljs-string"><span class="hljs-string">'+79991234567'</span></span> });</code> </pre> <br><p>  Result (more is better): </p><br><pre> <code class="hljs matlab">Mongoose x <span class="hljs-number"><span class="hljs-number">41</span></span>,<span class="hljs-number"><span class="hljs-number">382</span></span> ops/<span class="hljs-built_in"><span class="hljs-built_in">sec</span></span> ¬±<span class="hljs-number"><span class="hljs-number">7.38</span></span><span class="hljs-comment"><span class="hljs-comment">% (78 runs sampled) Mongorito x 28,649 ops/sec ¬±3.20% (85 runs sampled) Maraquia x 1,312,816 ops/sec ¬±1.70% (87 runs sampled)</span></span></code> </pre> <br><p>  In the second the same, but with preservation in the database.  Result: </p><br><pre> <code class="hljs matlab">Mongoose x <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">125</span></span> ops/<span class="hljs-built_in"><span class="hljs-built_in">sec</span></span> ¬±<span class="hljs-number"><span class="hljs-number">4.59</span></span><span class="hljs-comment"><span class="hljs-comment">% (69 runs sampled) Mongorito x 1,596 ops/sec ¬±4.08% (69 runs sampled) Maraquia x 1,143 ops/sec ¬±3.39% (73 runs sampled)</span></span></code> </pre> <br><p>  Sources in the <a href="https://github.com/Riim/Maraquia/tree/master/perf">perf</a> folder. </p><br><h2 id="futer">  Footer </h2><br><p>  I hope someone will find the library useful, it has not yet been used on real projects, so use it at your own peril and risk.  If something doesn't work as expected, <a href="https://github.com/Riim/Maraquia/issues/new">create an issue on github</a> . </p><br><p>  Basically, I am engaged in front-end development and I am hardly well versed in databases, so if I have written nonsense somewhere, then please understand and forgive :). </p><br><p>  Thank you for attention. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/358972/">https://habr.com/ru/post/358972/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358960/index.html">The digest of interesting materials for the mobile developer # 253 (May 14 - May 20)</a></li>
<li><a href="../358964/index.html">How I migrated the project from Angular 1 to React</a></li>
<li><a href="../358966/index.html">Universal API for Check Information</a></li>
<li><a href="../358968/index.html">What are smart contracts: a brief guide</a></li>
<li><a href="../358970/index.html">Cross-platform SNMP traffic monitoring utility without dependencies and GUI availability</a></li>
<li><a href="../358974/index.html">How update Rust 1.26 sped up my code more than three times</a></li>
<li><a href="../358976/index.html">Cofree Will Tear Us Apart</a></li>
<li><a href="../358978/index.html">The digest of fresh materials from the world of the frontend for the last week No. 315 (May 14 - 20, 2018)</a></li>
<li><a href="../358982/index.html">How do I want to invest in cryptocurrency or venture projects?</a></li>
<li><a href="../358984/index.html">How databases are arranged</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>