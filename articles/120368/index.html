<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bundle rvm + Rails + Nginx + Unicorn or deploy rails correctly</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The purpose of this article is to describe in detail the organization of the server for Rails applications in the currently most popular bundle: rvm +...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bundle rvm + Rails + Nginx + Unicorn or deploy rails correctly</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/storage/263722fa/68d4808e/bad30747/f721e883.png">  The purpose of this article is to describe in detail the organization of the server for Rails applications in the currently most popular bundle: rvm + Rails + Nginx + Unicorn.  The writing of the article was prompted by the absence of complete step-by-step documentation on this bundle, which is understandable not only to the vigorous professionals in this field.  Next, I will try in detail, step by step, to describe the ideologically correct process of organizing a server for servicing several Rails applications (using one example) - if you have <b>absolute</b> confidence that more than one application will <b>never</b> work on a test machine - the setting may Much shorter and simpler.  I want to warn you that the subtleties concerning the work of the application under high load are not described in the article, since  the goal was different - to make the application work in a bundle and reduce the number of conflicts with other applications to a minimum. <br><a name="habracut"></a><br><h5>  Ssh key </h5><br>  Before using the tools listed in the header, you need to prepare the server on which we are going to organize everything.  Suppose you just installed a fresh Ubuntu 10.04 LTS on the server (+ started up in the process of the first user), and raised OpenSSH daemon there.  Everything!  From now on, the server should not be touched for arms, legs and other limbs - we will only work with it remotely, and for this you should run on your working machine: <br><pre><code class="bash hljs">ssh-copy-id vasya@rails-production.example.com</code> </pre>  where vasya is the name of the user on the server, on behalf of which the rights will be implemented by the deploy, and rails-production.example.com is the address or name of the server you just raised.  After entering, it will be necessary to agree to add a host to the list of known hosts on your machine - that's okay - this is normal.  And enter Vasin password.  This will be the last time you will enter Vasily's password.  Now access to the server is possible using the ssh key and nothing needs to be entered. <br><br>  It would seem that these are the basics of which it is not worth mentioning - but there is always a certain percentage of people who have an alternative point of view on access to the machine via ssh keys.  For them, I can advise ointment from arthritis of the joints of the hand, the rest I suggest just to believe that ssh keys are good. <br><br><h5>  Database </h5><br>  Here I‚Äôll just give you tips on installing the right packages for the two most popular DBMSs: <br><pre> <code class="bash hljs">sudo apt-get install mysql-server mysql-client libmysqld-dev <span class="hljs-comment"><span class="hljs-comment"># MySQL sudo apt-get install postgresql postgresql-client postgresql-server-dev #Postgresql</span></span></code> </pre>  Setting up a database on a server is the topic of a separate article, so suppose that you can handle it yourself.  Therefore - tadaaam!  DBMS is up and running. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Rvm </h5><br>  <a href="https://rvm.io/">Rvm</a> is a Ruby version control tool in the system that allows you to create separate ‚Äúenvironments‚Äù from gems, which is not important in our case.  If we consider the concepts of <a href="http://gembundler.com/">bundler</a> and gemsets Rvm, then there may be a feeling that they are designed for the same purpose - to isolate the environment for the work of a particular application.  Bundler is a great tool for resolving gem dependencies, and Rails 3 works with it by default.  And in general, since we are talking about this - I recommend using the bundler for Rails 2.3.x, as described <a href="http://gembundler.com/rails23.html">here</a> . <br><br>  We need Rvm only to easily switch between different versions of Ruby, and such a need will most likely arise on the server, where applications written on different versions of Ruby on Rails will run simultaneously.  Rvm has its opponents.  No, and in fact - if you are <strong>absolutely</strong> sure that more than one version of ruby ‚Äã‚Äãwill <strong>never</strong> work on this piece of hardware, then it will be more correct to install some ree as a system interpreter of ruby ‚Äã‚Äãand <strike>burn in hell</strike> little by little to enjoy life.  But the reality is harsh, so I just recommend using rvm - this will keep everything in order. <br><br>  If you have already read the documentation, you probably noticed that there are two ways to install Rvm - from root (the so-called system wide install) and normal - for a simple user.  So again, I want to test your faith - do not install as root.  No wonder we created a user responsible for deploy.  Therefore, going to the server under our Vasily executes the following sequence of commands: <br><br><pre> <code class="bash hljs">sudo apt-get install git-core curl <span class="hljs-comment"><span class="hljs-comment">#  ,    Rvm. curl -L https://get.rvm.io | bash -s stable --ruby type rvm | head -1</span></span></code> </pre>  The last command should issue "rvm is a function" or equivalent in Russian.  If this does not happen, it is worthwhile to start studying <a href="https://rvm.io/rvm/install/">from here</a> until the moment - ‚Äúuntil it works‚Äù. <br><br><h5>  Ruby </h5><br>  Choosing the version of Ruby depends on which version of the rail is used in the application: so for 2.3.x it is preferable to use <a href="http://www.rubyenterpriseedition.com/">Ruby Enterprise Edition</a> , for 3.x it is recommended to use 1.9.3.  In my case, this is an application on 2.3.x and ree respectively.  And if to install ruby ‚Äã‚Äã1.9.3 nothing extraordinary from the system is required, then to install ree you need several system packages: <br><pre> <code class="bash hljs">sudo apt-get install build-essential bison openssl libreadline6 libreadline6-dev curl git-core zlib1g zlib1g-dev libssl-dev libyaml-dev libsqlite3-0 libsqlite3-dev sqlite3 libxml2-dev libxslt-dev autoconf libc6-dev ncurses-dev rvm install ree-1.8.7-2011.03 <span class="hljs-comment"><span class="hljs-comment">#  ree rvm ree # ,   Ruby .      -     : rvm ree@myapp --create.   Bundler    . gem install bundler #  gem,    . sudo mkdir -p /srv/myapp #  ,      . sudo chown -R vasya:vasya /srv/myapp #      (   ,  -R  ).</span></span></code> </pre> <br><br><h5>  Nginx </h5><br>  Since we will use Unicorn, we cannot do without Nginx - there is such a feature of Unicorn - it cannot work with slow clients.  There is, however, its counterpart, which can - Rainbows, but Nginx in itself is extremely useful, good and easy to use.  Installation instructions can be found on the <a href="http://sysoev.ru/nginx/">website of the</a> author of this wonderful server - Igor Sysoev.  I just give here a simple init script to run nginx and nginx.conf: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /bin/sh EXEC_PATH="/usr/local/nginx/sbin/nginx" case "$1" in start) echo "Starting NginX" start-stop-daemon --start --exec $EXEC_PATH ;; stop) echo "Stopping NginX" start-stop-daemon --stop --exec $EXEC_PATH ;; restart) echo "Stopping NginX" start-stop-daemon --stop --exec $EXEC_PATH sleep 1 echo "Starting NginX" start-stop-daemon --start --exec $EXEC_PATH ;; *) echo "Usage: {start|stop|restart}" exit 1 ;; esac exit 0</span></span></code> </pre> <br><pre> <code class="bash hljs">worker_processes 1; <span class="hljs-comment"><span class="hljs-comment">#       . user vasya vasya; #      worker -   ,    . pid /tmp/nginx.pid; #       - Nginx. error_log /tmp/nginx.error.log; events { worker_connections 1024; #        . accept_mutex off; #         - . } http { #     -       - -  : include mime.types; default_type application/octet-stream; access_log /tmp/nginx.access.log combined; sendfile on; tcp_nopush on; tcp_nodelay off; gzip on; #    .    upstream .        ,     . upstream myapp_server { server unix:/srv/myapp/shared/unicorn.sock fail_timeout=0; #        config/unicorn.rb    . } server { listen 80 default deferred; #  ,       ip   ,      -  myapp.mydomain.ru:80 client_max_body_size 1G; #     (   -       ). server_name myapp.mydomain.ru; #   keepalive_timeout 5; root /srv/myapp/current/public; #        public Rails .  current       Capistrano try_files $uri/index.html $uri.html $uri @myapp; #     - ,    location    location @myapp { proxy_pass http://myapp_server; #   http://       upstream . proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header Host $http_host; proxy_redirect off; } error_page 500 502 503 504 /500.html; location = /500.html { root /srv/myapp/current/public; } } }</span></span></code> </pre> <br>  It should immediately be warned that when Nginx simultaneously serves several applications, <code>server { ... }</code> blocks should be placed in separate files in the <code>/usr/local/nginx/conf/vhosts</code> and in nginx.conf write <code>include /usr/local/nginx/conf/vhosts/*</code> - in the example of this is not done for clarity. <br><br><h5>  Unicorn </h5><br>  Unicorn can be installed for the entire system, but this should not be done - it is much more correct to include the appropriate gem in the Gemfile: <pre> <code class="ruby hljs">gem <span class="hljs-string"><span class="hljs-string">'unicorn'</span></span></code> </pre>  and run Unicorn with the <code>bundle exec</code> command.  By the way, the recommendation applies not only to Unicorn, but also to any executable files that come with gems.  Installing Unicorn within a specific application will allow you to have as many applications as you need on one machine. <br>  Next, I will give an example of server configuration, which provides the so-called zero downtime deploy.  So, config / unicorn.rb: <br><pre> <code class="ruby hljs">deploy_to = <span class="hljs-string"><span class="hljs-string">"/srv/myapp"</span></span> rails_root = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/current"</span></span> pid_file = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/shared/pids/unicorn.pid"</span></span> socket_file= <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{deploy_to}</span></span></span><span class="hljs-string">/shared/unicorn.sock"</span></span> log_file = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{rails_root}</span></span></span><span class="hljs-string">/log/unicorn.log"</span></span> err_log = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{rails_root}</span></span></span><span class="hljs-string">/log/unicorn_error.log"</span></span> old_pid = pid_file + <span class="hljs-string"><span class="hljs-string">'.oldbin'</span></span> timeout <span class="hljs-number"><span class="hljs-number">30</span></span> worker_processes <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-comment"><span class="hljs-comment">#      ,       listen socket_file, :backlog =&gt; 1024 pid pid_file stderr_path err_log stdout_path log_file preload_app true #    ,  ,    . GC.copy_on_write_friendly = true if GC.respond_to?(:copy_on_write_friendly=) #   ,    ,     . before_exec do |server| ENV["BUNDLE_GEMFILE"] = "#{rails_root}/Gemfile" end before_fork do |server, worker| #  ,     ,    . defined?(ActiveRecord::Base) and ActiveRecord::Base.connection.disconnect! #   ,   0 downtime deploy. if File.exists?(old_pid) &amp;&amp; server.pid != old_pid begin Process.kill("QUIT", File.read(old_pid).to_i) rescue Errno::ENOENT, Errno::ESRCH # someone else did our job for us end end end after_fork do |server, worker| #      ,     . defined?(ActiveRecord::Base) and ActiveRecord::Base.establish_connection end</span></span></code> </pre> <br><br><h5>  Capistrano </h5><br>  Well, we have already set up everything <strike>that is possible</strike> basic things, so you should deal with Capistrano.  First of all, you should place the capistrano gem into the group: development of our Gemfile, and also put the rvm-capistrano for integration with rvm (for rvm versions&gt; = 1.1.0): <br><pre> <code class="ruby hljs">group <span class="hljs-symbol"><span class="hljs-symbol">:development</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> gem <span class="hljs-string"><span class="hljs-string">"capistrano"</span></span> gem <span class="hljs-string"><span class="hljs-string">"rvm-capistrano"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre>  After installing the gem, execute the command: <pre> <code class="bash hljs">bundle <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> capify .</code> </pre>  and we get an almost empty config / deploy.rb file.  I will give an example of a file for our needs: <pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'rvm/capistrano'</span></span> <span class="hljs-comment"><span class="hljs-comment">#   rvm require 'bundler/capistrano' #   bundler.    bundler      ,       . set :application, "myapp" set :rails_env, "production" set :domain, "vasya</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@rails</span></span></span><span class="hljs-comment">-production.example.com" #      ssh.             ,    . set :deploy_to, "/srv/#{application}" set :use_sudo, false set :unicorn_conf, "#{deploy_to}/current/config/unicorn.rb" set :unicorn_pid, "#{deploy_to}/shared/pids/unicorn.pid" set :rvm_ruby_string, 'ree' #    ,  Ruby    . set :scm, :git #  git. , ,  -  - svn, ,         git -  git. set :repository, "git</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@github</span></span></span><span class="hljs-comment">.com:myprojects/myapp.git" #    . ,         ,   ,     rsa        deployment keys   . set :branch, "master" #        . set :deploy_via, :remote_cache #   ,              .       . role :web, domain role :app, domain role :db, domain, :primary =&gt; true before 'deploy:setup', 'rvm:install_rvm', 'rvm:install_ruby' #  rvm  capistrano  ,    cap deploy:setup      rvm_ruby_string . after 'deploy:update_code', :roles =&gt; :app do #           - database.yml.       /srv/myapp/shared/config    .           . run "rm -f #{current_release}/config/database.yml" run "ln -s #{deploy_to}/shared/config/database.yml #{current_release}/config/database.yml" end #      unicorn.       -  . #    Rails 3    bundle exec unicorn_rails  bundle exec unicorn namespace :deploy do task :restart do run "if [ -f #{unicorn_pid} ] &amp;&amp; [ -e /proc/$(cat #{unicorn_pid}) ]; then kill -USR2 `cat #{unicorn_pid}`; else cd #{deploy_to}/current &amp;&amp; bundle exec unicorn_rails -c #{unicorn_conf} -E #{rails_env} -D; fi" end task :start do run "bundle exec unicorn_rails -c #{unicorn_conf} -E #{rails_env} -D" end task :stop do run "if [ -f #{unicorn_pid} ] &amp;&amp; [ -e /proc/$(cat #{unicorn_pid}) ]; then kill -QUIT `cat #{unicorn_pid}`; fi" end end</span></span></code> </pre> <br><br>  PS If anyone has any suggestions for improving the material presented, or constructive comments I will be glad to read and correct. </div><p>Source: <a href="https://habr.com/ru/post/120368/">https://habr.com/ru/post/120368/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../120362/index.html">VTB 24 introduces ATM technology, similar to Adsens.</a></li>
<li><a href="../120364/index.html">Operator with and why it should not be used</a></li>
<li><a href="../120365/index.html">Kaspersky Mobile Security, or why the phone is easier to find in the snow</a></li>
<li><a href="../120366/index.html">Interview with Eric Schmidt: choose Mac and Chrome for safety</a></li>
<li><a href="../120367/index.html">Student projects of the St. Petersburg State University's fur</a></li>
<li><a href="../120369/index.html">Can Tor trigger a world war?</a></li>
<li><a href="../120370/index.html">The input element in html 5, multi-flood</a></li>
<li><a href="../120371/index.html">Ebay sniper on a specific example</a></li>
<li><a href="../120373/index.html">NSPK: injured and winners</a></li>
<li><a href="../120374/index.html">Practical use of Asterisk at home</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>