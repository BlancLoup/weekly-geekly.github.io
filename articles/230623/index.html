<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>7 myths about Linq to Database</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Linq appeared in 2007, the first IQueryable provider also appeared - Linq2SQL, it worked only with MS SQL Server, it was rather slow and didn‚Äôt cover ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>7 myths about Linq to Database</h1><div class="post__text post__text-html js-mediator-article">  Linq appeared in 2007, the first IQueryable provider also appeared - Linq2SQL, it worked only with MS SQL Server, it was rather slow and didn‚Äôt cover all the scenarios.  Almost 7 years have passed, several Linq-providers have appeared that work with different DBMS, almost all the ‚Äúchildhood diseases‚Äù of technology have won and, for a couple of years, Linq to Database (a generic name for popular providers) is ready for industrial use. <br><br>  Nevertheless, not everyone uses Linq to Database and explains this not only because the project is old and rather difficult to rewrite to linq, but also cites various myths as arguments.  These myths wander from one company to another and often spread via the Internet. <br><br>  In this post I collected the most popular myths and denials to them. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Myth number 1 </h4><br><h6>  The database is handled by a specially trained DBA, which makes all queries, and programmers write code, so Linq to Database is not needed. </h6><br>  Despite the attractiveness of the myth, this approach usually does not work.  To make effective DBA queries, you need to understand very well what is happening in the program, what data is needed in each scenario. <br><br>  If the DBA does not have this knowledge, then it usually comes down to the fact that the DBA makes a small set of CRUD stored on each entity + several stored for the most ‚Äúthick‚Äù queries.  And the rest is already done by programmers in the code.  This most often works inefficiently, because on average, much more data is pulled than is needed for a particular scenario.  And to optimize this is difficult. <br><br>  If the DBA knows each script, then it has two options: <br>  a) Make a lot of things (almost the same), each for a specific scenario, and then painfully maintain them. <br>  b) Make a few universal storage with a bunch of parameters, inside which to glue the lines to form optimal queries.  Moreover, adding an additional parameter to the request becomes an extremely complex process. <br><br>  Both options for DBA are very complex, so the hybrid option with several very complex storage is often the result, and the rest is a banal CRUD.  Linq allows you to do the same splice of lines much more efficiently, so you can generate optimal queries in your program code or close to optimal ones. <br><br>  A DBA can create views and functions that will be used in queries from application code, as well as stored procedures for batch processing.  But designing requests is better to leave on the side of the application. <br><br><h4>  Myth number 2 </h4><br><h6>  Linq generates inefficient SQL queries. </h6><br>  Very often repeated myth.  But most of the inefficiencies of Linq queries are created by people. <br><br>  The reasons for this are simple: <br>  1) People do not understand how Linq differs from SQL.  Linq works with ordered sequences, and SQL with unordered sets.  Therefore, some Linq operations add extremely inefficient sort operators to SQL. <br>  2) People do not understand the mechanisms of IQuryable-providers and how queries are executed in the database.  Read more in a previous post - <a href="http://habrahabr.ru/post/230479">habrahabr.ru/post/230479</a> <br><br>  But there are also bugs in providers that lead to the generation of requests that are far from optimal. <br><br>  For example, in the Entity Framework there is a bug when using navigation properties: <br><pre><code class="cs hljs">context.Orders .Where(o =&gt; o.Id == id) .SelectMany(o =&gt; o.OrderLines) .Select(l =&gt; l.Product) .ToList();</code> </pre> <br>  Such a query generates the following SQL: <br><div class="spoiler">  <b class="spoiler_title">Lot of code</b> <div class="spoiler_text"><pre> <code class="sql hljs"> [Project1].[Id] AS [Id], [Project1].[OrderDate] AS [OrderDate], [Project1].[UserId] AS [UserId], [Project1].[C1] AS [C1], [Project1].[OrderId] AS [OrderId], [Project1].[ProductId] AS [ProductId], [Project1].[Id1] AS [Id1], [Project1].[Title] AS [Title] FROM ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [Extent1].[OrderDate] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [OrderDate], [Extent1].[UserId] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [UserId], [Join1].[OrderId] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [OrderId], [Join1].[ProductId] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [ProductId], [Join1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Id1], [Join1].[Title] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Title], <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> ([Join1].[OrderId] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C1] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Orders] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent2].[OrderId] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [OrderId], [Extent2].[ProductId] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [ProductId], [Extent3].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [Extent3].[Title] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Title] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[OrderLines] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent2] <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [dbo].[Products] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent3] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [Extent2].[ProductId] = [Extent3].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Join1] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [Join1].[OrderId] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = @p__linq__0 ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Project1] <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> [Project1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [Project1].[C1] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span></code> </pre><br></div></div><br>  In this query, the calculated field and sorting by it cannot be optimized by SQL Server and you have to perform a real sort. <br><br>  But if you slightly rewrite Linq's request to use the join operator, then there will be no problem: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> orders1 = <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> o <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> context.Orders <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> o.Id == id <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> ol <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> context.OrderLines <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> o.Id <span class="hljs-keyword"><span class="hljs-keyword">equals</span></span> ol.OrderId <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> j <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> j.DefaultIfEmpty() <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> p.Product; orders1.ToArray();</code> </pre><br>  SQL obtained: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent3].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [Extent3].[Title] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Title] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Orders] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [dbo].[OrderLines] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent2] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [Extent2].[OrderId] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [dbo].[Products] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent3] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [Extent2].[ProductId] = [Extent3].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = @p__linq__0</code> </pre><br>  It is well covered with indexes and optimized by SQL Server. <br><br>  I also heard about ineffective requests from NHibernate, but did not work with it so actively to find such bugs. <br><br><h4>  Myth number 3 </h4><br><h6>  Slowly running mapping. </h6><br>  The conversion of the DataReader into a set of objects is performed in a fraction of a <b>microsecond</b> per object.  And the linq2db provider manages to do it faster than the advertised Dapper. <br><br>  But what can work slowly is attaching the received objects to the Change Tracking context.  But this must be done only in the case when the objects will be modified and recorded in the database.  In other cases, you can explicitly specify that the objects do not join the context or use projections. <br><br><h4>  Myth number 4 </h4><br><h6>  Slowly generated queries. </h6><br>  Indeed, to generate a SQL query from Linq requires a traversal of the tree, a lot of work with reflection and analysis of metadata.  But in all providers, such analysis is performed once, and then the data is cached. <br><br>  As a result, for simple requests, the generation of a request is performed on average over 0.4 ms.  For complex ones, this can be up to several milliseconds. <br>  This time is usually less than the statistical error of the total query execution time. <br><br><h4>  Myth number 5 </h4><br><h6>  Cannot use hints. </h6><br>  In SQL Server, there is a Plan Guide mechanism that allows you to add hints to any query.  Similar mechanisms exist in other DBMSs. <br><br>  Even so, hints are not much needed when using Linq.  Linq generates fairly simple queries that the DBMS itself optimizes in the presence of statistics, indexes and constraints.  Hints of locks should be replaced by setting the correct isolation levels and limiting the number of rows requested. <br><br><h4>  Myth number 6 </h4><br><h6>  Linq cannot use all SQL features. </h6><br>  This is partly true.  But many SQL features can be wrapped in functions or views, and they can already be used in Linq queries. <br><br>  Moreover, the Entity Framework allows you to perform any SQL queries, and results on objects, including those with Change Tracking. <br><br><h4>  Myth number 7 </h4><br><h6>  Stored procedures run faster than ad-hoc queries generated by Linq. </h6><br>  This was true in the mid-90s.  Today, all DBMSs ‚Äúcompile‚Äù requests and cache plans, regardless of whether this is a procedure or an ad-hoc request. <br><br>  Here is a brief set of myths that can be found.  If you have more - add. </div><p>Source: <a href="https://habr.com/ru/post/230623/">https://habr.com/ru/post/230623/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../230607/index.html">Modern Tornado: distributed image hosting in 30 lines of code</a></li>
<li><a href="../230613/index.html">What must a startup do to survive?</a></li>
<li><a href="../230615/index.html">RNAInSpace and folding of tRNA - season closing, new season - Structural alignment</a></li>
<li><a href="../230617/index.html">Interview with the demostsener - kb ^ Farbrausch</a></li>
<li><a href="../230619/index.html">Meta-Object Protocol Common Lisp on the example of the implementation of the prototype object system</a></li>
<li><a href="../230625/index.html">View DOM events in Firefox Developer Tools</a></li>
<li><a href="../230627/index.html">Google uses machine learning to improve data center efficiency</a></li>
<li><a href="../230631/index.html">Soap: all-in-one router for smart home</a></li>
<li><a href="../230633/index.html">Phalcon amazing framework</a></li>
<li><a href="../230635/index.html">WebCamp 2014 Live Webcast</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>