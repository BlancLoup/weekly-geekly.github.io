<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Auto-find IPs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Why look for an IP at all? 
 The other day I was faced with the task of sending database updates to certain terminals. But before sending, I had to fi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Auto-find IPs</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/7fb/0ce/538/7fb0ce538a3947c897150d3fbe238c16.jpg" alt="Preview"><br><br><h2>  Why look for an IP at all? </h2><br>  The other day I was faced with the task of sending database updates to certain terminals.  But before sending, I had to find out where to send, or where to take it from.  At first glance, it is more logical to tell the terminal the IP address of the server and collect data, but the following nuances prevented such an implementation: <br><br><ul><li>  These terminals will be publicly available and operate in <a href="https://support.google.com/chrome/a/answer/6137028%3Fhl..">kiosk mode</a> .  Therefore, the idea to add some kind of administration panel to them immediately fell away, because a random user will be able to ‚Äúnaklats‚Äù in the settings of the IP address that he likes. </li><li>  It would be possible to stitch the update server IP address into the terminals, but since the server, in my case, is just a desktop application that the user can run on any computer on the subnet, this solution did not work either. </li><li>  Taking into account the previous two points, it would be possible to implement the administration panel, with password entry, but, nevertheless, constantly driving in a new IP address of the update server is an extra headache for the maintenance staff. </li></ul><br>  Therefore, from the idea of ‚Äã‚Äã‚Äúpick up,‚Äù I proceeded to the idea of ‚Äã‚Äã‚Äúsend‚Äù and began to tinkering with the implementation of automatic search for IP addresses in Python 3. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The first idea that came to mind is the periodic distribution of the base and its hash sum via <a href="https://en.wikipedia.org/wiki/Broadcast_address">udp broadcast</a> , but, unfortunately, the UDP protocol <a href="https://www.ietf.org/rfc/rfc768.txt">does not guarantee the</a> integrity of the delivered information.  However, the idea of ‚Äã‚Äãusing broadcast addresses lay in the final implementation method. <br><br>  So, in the end, I decided to send a UDP mailing to the broadcast address 255.255.255.255 from the server, and install UDP servers on the terminals that, after receiving the command on this mailing, will open a TCP connection to the central server. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/623/df8/1ba/623df81ba92945ddb3ff8cf2ba722937.png" alt="approximate network topology"></div><br><h2>  First step: write a UDP client </h2><br>  The official Python website has several <a href="https://docs.python.org/3/library/socket.html">examples</a> of socket implementations, but I immediately ran into a problem.  When sent to a broadcast address, the interpreter issued: <b>PermissionError: [Errno 13] Permission denied</b> .  On "stackoverflow" I found a <a href="http://stackoverflow.com/questions/11457676/python-socket-error-errno-13-permission-denied">solution to the problem</a> - for such a mailing the socket needs to set the special flag <b>SO_BROADCAST</b> .  Given this fact, the function of creating a UDP client has taken the following form: <br><br><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_broadcast_socket</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> udp_sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM) udp_sock.setsockopt(socket.SOL_SOCKET, socket.SO_BROADCAST, <span class="hljs-number"><span class="hljs-number">1</span></span>) udp_sock.settimeout(<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> udp_sock</code> </pre> <br>  And the following functions send various messages through this socket. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ask_addresses</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> create_broadcast_socket() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sock: sock.sendto(<span class="hljs-string"><span class="hljs-string">'show yourself'</span></span>.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>), (<span class="hljs-string"><span class="hljs-string">'255.255.255.255'</span></span>, PORT)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update_many</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> create_broadcast_socket() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sock: sock.sendto(<span class="hljs-string"><span class="hljs-string">'get updates'</span></span>.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>), (<span class="hljs-string"><span class="hljs-string">'255.255.255.255'</span></span>, PORT)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update_one</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ip)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> create_broadcast_socket() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sock: sock.sendto(<span class="hljs-string"><span class="hljs-string">'get updates'</span></span>.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>), (ip, PORT))</code> </pre> <br>  I think the names show what they are doing, and there is no need for specific explanations here. <br><br><h2>  Second step: write a UDP server and TCP client in it </h2><br>  Fortunately, the <a href="https://docs.python.org/3/library/socketserver.html">socketserver</a> module already exists in the standard language library.  To create a full-fledged UDP server, it is enough to inherit from the <a href="https://docs.python.org/3.4/library/socketserver.html">DatagramRequestHandler</a> class and implement the logic in the <b>handle ()</b> method. <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoServer</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(socketserver.DatagramRequestHandler)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> data = self.request[<span class="hljs-number"><span class="hljs-number">0</span></span>].strip().decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) client_ip = self.client_address[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> data.startswith(<span class="hljs-string"><span class="hljs-string">'show yourself'</span></span>): print(<span class="hljs-string"><span class="hljs-string">'show myself'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> socket.socket(socket.AF_INET, socket.SOCK_STREAM) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tcp_sock: tcp_sock.connect((client_ip, PORT)) tcp_sock.send(<span class="hljs-string"><span class="hljs-string">'show\n'</span></span>.encode(<span class="hljs-string"><span class="hljs-string">'UTF-8'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> data.startswith(<span class="hljs-string"><span class="hljs-string">'get updates'</span></span>): print(<span class="hljs-string"><span class="hljs-string">'get updates FROM '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> socket.socket(socket.AF_INET, socket.SOCK_STREAM) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tcp_sock: tcp_sock.connect((client_ip, PORT)) tcp_sock.send(<span class="hljs-string"><span class="hljs-string">'get\n'</span></span>.encode(<span class="hljs-string"><span class="hljs-string">'UTF-8'</span></span>)) part = tcp_sock.recv(<span class="hljs-number"><span class="hljs-number">1024</span></span>) file = open(<span class="hljs-string"><span class="hljs-string">'internal.db'</span></span>, <span class="hljs-string"><span class="hljs-string">'wb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> part: file.write(part) print(part) part = tcp_sock.recv(<span class="hljs-number"><span class="hljs-number">1024</span></span>) file.close() print(self.request)</code> </pre> <br>  This server listens to UDP connections on a specific port (the port number is stored in the global variable PORT).  After receiving the packet, he checks its contents, if the packet <i>shows a ‚Äúshow yourself‚Äù</i> message, it opens a TCP connection and sends the message <i>‚Äúshow \ n‚Äù</i> , after which the TCP server of the update server adds this IP address to its set of addresses.  If the package received the message <i>‚Äúget updates‚Äù</i> , the terminal will open a TCP connection, in which it will send the message <i>‚Äúget \ n‚Äù</i> , after which the download of the SQLite database file will begin.  The symbol '\ n' at the end of the messages I used for convenience, so that on the TCP server you could call the <b>readline ()</b> method on the socket <br><br>  All this stuff starts like this: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run_echo_server</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> server = socketserver.UDPServer((<span class="hljs-string"><span class="hljs-string">''</span></span>, PORT), EchoServer) server.serve_forever()</code> </pre> <br>  An empty string, instead of an address, tells the server to listen for connections on all available network interfaces. <br><br><h2>  The third step: we write TCP client </h2><br>  The last link in this chain of communications will be a TCP server on the update server.  It is implemented on the basis of the <a href="https://docs.python.org/3/library/socketserver.html">StreamRequestHandler</a> class from the same <a href="https://docs.python.org/3/library/socketserver.html">socketserver</a> module.  As in the first case, it also remained only to implement the <b>handle ()</b> method: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NetworkController</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(socketserver.StreamRequestHandler)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> request_type = self.rfile.readline() print(<span class="hljs-string"><span class="hljs-string">"{} wrote: {}"</span></span>.format(self.client_address[<span class="hljs-number"><span class="hljs-number">0</span></span>], request_type)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> request_type.decode(<span class="hljs-string"><span class="hljs-string">'UTF-8'</span></span>) == <span class="hljs-string"><span class="hljs-string">'show\n'</span></span>: scales_catalogue.add(self.client_address[<span class="hljs-number"><span class="hljs-number">0</span></span>]) <span class="hljs-comment"><span class="hljs-comment"># print(scales_catalogue) elif request_type.decode('UTF-8') == 'get\n': file = open('internal.db', 'rb') part = file.read(1024) while part: self.wfile.write(part) part = file.read(1024) file.close()</span></span></code> </pre> <br>  As mentioned above, when receiving the <i>‚Äúshow \ n‚Äù</i> message, the server will add the IP address from which the message was sent to its internal array, or rather the set, in order to avoid duplicate addresses.  If the server receives the <i>‚Äúget \ n‚Äù</i> message, it will begin sending the database file in 1024 byte portions. <br><br>  This server is started with the following functions: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_server</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> socketserver.TCPServer((<span class="hljs-string"><span class="hljs-string">''</span></span>, PORT), NetworkController) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run_pong_server</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> server = create_server() server.serve_forever()</code> </pre> <br>  As with the UDP server, a blank line forces the server to listen on connections on all available network interfaces. <br><br><h2>  Total </h2><br>  In this way, a system turned out that through the UDP mailing list can find out the addresses of the terminals, and then either selectively force the terminals from the list of IP addresses to pick up the updated database file, or again, via the UDP mailing, force all terminals on the network to pick up the updates. <br><br>  If some nuances are not clear, the full source code is publicly available on my GitHub repository. </div><p>Source: <a href="https://habr.com/ru/post/319706/">https://habr.com/ru/post/319706/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319696/index.html">How to iterate over all permutations and about factorial decomposition of natural numbers</a></li>
<li><a href="../319698/index.html">Windows has an internal list of undelete root certificates.</a></li>
<li><a href="../319700/index.html">Introduction to the 8pt mesh system</a></li>
<li><a href="../319702/index.html">Duplo Railroad Tycoon: Synthesis of the rail network with maximum coverage</a></li>
<li><a href="../319704/index.html">The system of recommendations online store based on methods of machine learning in the Compute Engine (Google Cloud Platform)</a></li>
<li><a href="../319708/index.html">Battle of ideas</a></li>
<li><a href="../319710/index.html">8 network resources to remove malicious code and eliminate the consequences of hacking the site</a></li>
<li><a href="../319712/index.html">Crysis at the maximum speed, or why the server needs a video card</a></li>
<li><a href="../319714/index.html">Flash to the head: IBM announced a line of storage arrays for the cloud</a></li>
<li><a href="../319716/index.html">Server abroad</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>