<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tuning typical roles of Windows. Part One: Files and Printing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We are starting a small series of articles devoted to tuning the performance of a Windows server and its typical roles. The material will be useful bo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tuning typical roles of Windows. Part One: Files and Printing</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/a6d/c01/4ee/a6dc014ee07c4fcdadd77613121dfd47.jpg"></p><br><p>  We are starting a small series of articles devoted to tuning the performance of a Windows server and its typical roles.  The material will be useful both when trying to squeeze the maximum out of the old server (besides painting red), and when planning new high-load systems without buying top-end servers (as integrators advise). <a name="habracut"></a></p><br><h1 id="obschie-rekomendacii-po-zhelezu">  General recommendations for iron </h1><br><p>  The processor is like the heart of the server, so much depends on it in terms of performance.  Thanks to marketers, we know - the more cores and megahertz, the steeper.  In fact, everything is not quite so: </p><br><ol><li><p>  Choose a 64-bit processor.  Modern server Windows do not support 32-bit processors, and it can address the memory much more. </p><br></li><li><p>  The number of cores is not a big deal.  Not all applications and services can use multiple cores, and in the general case one core with a higher frequency will be more efficient than two with a smaller one. </p><br></li><li><p>  Hyperthreading - Hyperthreading - when one physical core of a processor is defined as two logical ones.  The processor function allows you to process two different threads on the same core, which generally improves performance.  But it happens that the performance on the contrary <a href="https://habrahabr.ru/post/248359/">is reduced</a> due to the fact that the cache of the processor core is one. </p><br></li><li><p>  CPU cache.  Everything is simple: the more it is, the better, and often a larger cache gives more performance than the frequency of the processor. </p><br></li><li><p>  No need to compare processors of different generations and manufacturers in terms of frequency: data processing speed depends on many other factors, such as cache and bus frequency. </p><br></li><li>  For Hyper-V, it is important that the processor supports SLAT (Second Level Address Translation).  In Intel terminology, the capability is called Extended Page Tables (EPT), for AMD - Nested Page Tables (NPT).  You can check the availability of this processor function using the systeminfo.exe utility. </li></ol><br><p><img src="https://habrastorage.org/web/747/97f/3cf/74797f3cf3e8425f95b99bd056aa563f.jpg"></p><br><p>  <em>Check processor under Hyper-V requirements.</em> </p><br><p>  With RAM, everything is quite simple: the bigger and faster it is, the better.  It becomes a little more interesting if the RAM is not enough and the system needs to use the paging file.  Here you can limit the following recommendations: </p><br><ul><li><p>  The paging file should be put on a separate physical disk.  The faster he is, the better.  If this is not possible, then it is better to place it on a disk that has fewer file reads; </p><br></li><li>  it is better not to store the paging file on a fault-tolerant array like RAID1‚Äï; it loses in speed with one disk.  It‚Äôs a good idea to put a paging file on a RAID0 or several paging files on different physical disks. </li></ul><br><p><img src="https://habrastorage.org/web/9ea/52d/6f2/9ea52d6f277f46589694582fdaff80f5.jpg"></p><br><p>  <em>Placing a paging file on the system disk is not the best option.</em> </p><br><p>  Now about network adapters.  Of the interesting features can be noted: </p><br><ol><li><p>  Only adapters that support 64-bit systems have DMA (Direct Memory Access), a technology of direct memory access over the network.  If you need a really fast network between the nodes of the cluster, you should pay attention to it. </p><br></li><li>  Multiport adapters are convenient for load balancing and fault tolerance.  But 2 adapters with one port will be faster than one adapter with 2 ports.  You also need to keep in mind that installing more network adapters than cores in the server is fraught with a drop in performance. </li></ol><br><p><img src="https://habrastorage.org/web/c71/643/b01/c71643b01f0647a1a18ae0ad8c3b4347.jpg"></p><br><p>  <em><a href="https://servermall.ru/promo/">HPE ProLiant DL360 Gen7</a> initially has four network ports.</em> </p><br><p>  This concludes a small introductory and will go directly to the optimization of server roles.  Let's start with the simplest - with a file server. </p><br><h1 id="faylovyy-server">  File server </h1><br><p>  Usually, when installing and running a file server, the performance issue is not.  But only as long as databases, monstrous Excel files and the like "interesting" things start up on a regular file storage facility.  I'll tell you about the parameters that can improve or degrade the performance of SMB. </p><br><p>  Separately, I note the issue of server speed, which processes not only clients inside the local network, but also remote ones - for example, via VPN.  Personally, I came across a situation when computers started to appear on the network on Windows XP \ 2003 on Windows 7 \ 2008.  Then we are faced with the fact that the speed of the network of new computers leaves much to be desired when communicating with old operating systems.  Having read the Internet, we performed the following script on new machines: </p><br><pre><code class="bash hljs">netsh int tcp <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> global autotuning=disabled netsh int tcp <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> global autotuninglevel=disabled netsh int tcp <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> global rss=disabled chimney=disabled</code> </pre> <br><p>  The network has earned, the script has been added to the deployed image systems. </p><br><p>  And everything was fine until a remote segment appeared on the network with an increased demand for network speed.  Files transferred via VPN are not faster than 2 Mb / s.  The problem was localized: it turned out that the <em>autotuning</em> function was added specifically for work on LAN \ WAN networks in new operating systems.  Using it, the systems determine the connection speed and agree on the TCP frame sizes for optimal performance.  In order for VPN to work quickly, and the servers did not slow down when accessing Windows 2003, it was enough not to turn off <em>autotuning</em> , but limit it to the command: </p><br><pre> <code class="bash hljs">netsh int tcp <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> global autotuninglevel=highlyrestricted</code> </pre><br><p>  But let's move on to more specialized parameters. </p><br><p>  <strong>Remember that changes to registry settings and service settings can lead to anything.</strong>  <strong>Therefore, we do everything carefully.</strong> </p><br><p>  Let's start with tuning file server clients.  <em>LanmanWorkstation</em> is responsible for connecting to the SMB server.  Most of the settings are in the following registry branch: </p><br><pre> <code class="xml hljs">HKLM\System\CurrentControlSet\Services\LanmanWorkstation\Parameters</code> </pre><br><p>  Most of the parameters are of type REG_DWORD.  In modern Windows, management of some of the settings is possible via the <strong>Set-SmbClientConfiguration cmdlet</strong> .  View current values ‚Äã‚Äã‚Äî respectively, <strong>Get-SmbClientConfiguration</strong> . </p><br><p><img src="https://habrastorage.org/web/28b/7a9/41f/28b7a941fa02441980325a33a113f6e0.jpg"></p><br><p>  <em>SMB client parameter values.</em> </p><br><p>  Parameters that should be paid attention first of all in terms of speed: </p><br><table><tbody><tr><td width="150">  Parameter name </td><td width="100">  Default value </td><td width="100">  Value options </td><td width="150">  What is responsible </td><td>  Comment </td></tr><tr><td>  DisableBandwidthThrottling </td><td>  0 </td><td>  0‚Äï1 </td><td>  Enable - Disable Throttling for high latency networks </td><td>  Enabling this option can increase network bandwidth with high latency (WAN) </td></tr><tr><td>  FileInfoCacheEntriesMax </td><td>  64 </td><td>  1‚Äï65536 </td><td>  Maximum number of values ‚Äã‚Äãin the file metadata cache </td><td>  Increasing this setting reduces traffic and increases network bandwidth when accessing a large number of files. </td></tr><tr><td>  DirectoryCacheEntrySizeMax </td><td>  64 </td><td>  1‚Äï65536 </td><td>  Maximum cache size for directories </td><td>  Measured in kilobytes </td></tr><tr><td>  FileNotFoundCacheEntriesMax </td><td>  128 </td><td>  1‚Äï65536 </td><td>  Maximum number of values ‚Äã‚Äãin the file information cache </td><td>  Increasing this setting reduces traffic and increases network bandwidth when accessing a large number of files. </td></tr><tr><td>  MaxCmds </td><td>  50 </td><td>  1‚Äï65536 </td><td>  Maximum number of commands per session </td><td>  Increasing the parameter will increase the memory consumption, but will increase the speed.  Only for SMB v1 </td></tr><tr><td>  DormantFileLimit </td><td>  1023 </td><td>  1‚Äï65536 </td><td>  Maximum number of files that can be opened after being "released" by the application </td><td></td></tr><tr><td>  ScavengerTimeLimit </td><td>  ten </td><td>  0‚Äï127 </td><td>  How often does the garbageman run, clearing the file descriptor cache </td><td>  Measured in seconds, relevant for Windows XP \ 2003 </td></tr></tbody></table><br><p>  As an example of tuning, we can cite the following values: </p><br><ul><li><p>  DisableBandwidthThrottling = 1; </p><br></li><li><p>  FileInfoCacheEntriesMax = 32768; </p><br></li><li><p>  DirectoryCacheEntriesMax = 4096; </p><br></li><li><p>  FileNotFoundCacheEntriesMax = 32768; </p><br></li><li><p>  MaxCmds = 32768; </p><br></li><li><p>  DormantFileLimit = 32768; </p><br></li><li>  ScavengerTimeLimit = 60. </li></ul><br><p>  Of course, specifically these values ‚Äã‚Äã- not a panacea.  Parameters must be selected individually. </p><br><div class="spoiler">  <b class="spoiler_title">With other parameters that have less impact on performance, I suggest to get acquainted under the spoiler.</b> <div class="spoiler_text"><p>  Parameters configured via powershell and registry: </p><br><table><tbody><tr><td width="150">  Parameter name </td><td width="100">  Default value </td><td width="100">  Value options </td><td width="150">  What is responsible </td><td>  Comment </td></tr><tr><td>  ConnectionCountPerNetworkInterface </td><td>  one </td><td>  1‚Äï16 </td><td>  Maximum number of connections to the server with non-RSS interface </td><td>  MS does not recommend changing the default value. <br></td></tr><tr><td>  ConnectionCountPerRssNetworkInterface </td><td>  four </td><td>  1‚Äï16 </td><td>  Maximum number of connections to the server with RSS interface </td><td></td></tr><tr><td>  ConnectionCountPerRdmaNetworkInterface </td><td>  2 </td><td>  1‚Äï16 </td><td>  Maximum number of connections to the server with an interface with RDMA support </td><td></td></tr><tr><td>  MaximumConnectionCountPerServer </td><td>  32 </td><td>  1‚Äï64 </td><td>  Maximum number of connections to one server </td><td></td></tr><tr><td>  DormantDirectoryTimeout </td><td>  600 </td><td></td><td>  Maximum amount of directory processing time </td><td>  Measured in seconds <br></td></tr><tr><td>  FileInfoCacheLifetime </td><td>  ten </td><td></td><td>  Cache information storage time </td><td></td></tr><tr><td>  DirectoryCacheLifetime </td><td>  ten </td><td></td><td>  Time to store directory metadata in cache </td><td></td></tr><tr><td>  FileNotFoundCacheLifetime </td><td>  five </td><td></td><td>  Cache retention time for files not found </td><td></td></tr><tr><td>  Cachefiletime </td><td>  ten </td><td></td><td>  Cache storage time for a file after the file is ‚Äúreleased‚Äù by the application </td><td></td></tr><tr><td>  DisableLargeMtu </td><td>  0 (win8) </td><td>  0‚Äï1 </td><td>  Enable ‚Äï disable large MTU </td><td>  With the enabled option, the request size is limited to 64 KB, with the enabled option - 1 MB. </td></tr><tr><td>  RequireSecuritySignature </td><td>  0 </td><td>  0‚Äï1 </td><td>  Enable ‚Äï Disable SMB Signature Mandatory </td><td>  Enabling this option slows down the speed of operation, but increases protection against the MITM attack. </td></tr><tr><td>  DirectoryCacheEntriesMax </td><td>  sixteen </td><td>  1‚Äï4096 </td><td>  Maximum number of values ‚Äã‚Äãin the directory information cache </td><td>  Increasing this setting reduces traffic and increases network bandwidth when accessing large directories. </td></tr><tr><td>  Maxcredits </td><td>  128 </td><td></td><td>  Maximum number of commands per session </td><td>  Same as MaxCmds, but for SMB v2 </td></tr></tbody></table><br><p>  Parameters configured via powershell: </p><br><table><tbody><tr><td width="150">  EnableMultiChannel </td><td width="100">  one </td><td width="100">  0‚Äï1 </td><td>  Enable ‚Äï disable the use of multiple physical adapters </td><td></td></tr><tr><td>  EnableByteRangeLockingOnReadOnlyFiles </td><td>  True </td><td>  True \ False </td><td>  Enable ‚Äï Disable Read-Only File Locking </td><td></td></tr><tr><td>  EnableInsecureGuestLogons </td><td>  True </td><td>  True \ False </td><td>  Enable ‚Äï disable guest login to resource </td><td>  Disconnection will not allow accessing folders on a non-home server (NAS) without authorization to the shared folders for all. </td></tr><tr><td>  EnableLoadBalanceScaleOut </td><td>  True </td><td>  True \ False </td><td>  Enable ‚Äî Disable support for load sharing when connecting to a cluster. </td><td></td></tr><tr><td>  EnableSecuritySignature </td><td>  True </td><td>  True \ False </td><td>  Enable ‚Äï Disable SMB Signature Capability </td><td></td></tr><tr><td>  ExtendedSessionTimeout </td><td>  1000 </td><td></td><td>  Server timeout </td><td>  Measured in seconds </td></tr><tr><td>  Keepconn </td><td>  600 </td><td></td><td>  Time to close inactive session </td><td>  Measured in seconds, applicable only to SMB v1 </td></tr><tr><td>  OplocksDisabled </td><td>  False </td><td>  True \ False <br></td><td></td><td>  Switched automatically depending on the value of the parameter UseOpportunisticLocking </td></tr><tr><td>  Sessiontimeout </td><td>  60 </td><td></td><td>  Time to close inactive session </td><td>  Measured in seconds </td></tr><tr><td>  UseOpportunisticLocking </td><td>  True </td><td>  True \ False </td><td>  Enable ‚Äï disable flexible locking (oplock) of files with their buffering </td><td>  The included mechanism greatly increases the speed, but on unreliable networks can damage files </td></tr><tr><td>  Windowseize threshold </td><td>  1 for server systems, 8 for client systems </td><td></td><td>  Minimum window size before Multichannel mode </td><td></td></tr></tbody></table></div></div><br><p>  If we speak directly about the file server, here are some general recommendations: </p><br><ol><li><p>  For better performance, do not use unnecessary functions like file system mini-filters, IPSec, NTFS encryption and compression, SMB encryption, and others.  The inclusion of an antivirus can significantly spoil the speed, and if the network perimeter is protected, it is better not to install it. </p><br></li><li><p>  You should regularly check the relevance of drivers, especially on network cards.  There were situations when, due to driver curves, the network card worked stably only when forcing one hundred megabits.  And only with the release of fresh drivers managed to squeeze a full gigabit. </p><br></li><li>  Copying files is a fairly regular operation for a file server.  When copying over the network, it is preferable to use the utility robocopy.exe with the / mt key, which includes multithreading for a large number of small files.  A bit of speed will be added by the lack of output to the console - the / log key for robocopy and / q for xcopy. </li></ol><br><p>  To assess the performance of the SMB protocol, you can use performance counters that exist for both the server and the client. </p><br><div class="spoiler">  <b class="spoiler_title">Let me remind you how to see them.</b> <div class="spoiler_text"><p>  The perfmon.exe utility will help here.  After launch, it is convenient to switch the display to the ‚Äúreport‚Äù mode: </p><br><p><img src="https://habrastorage.org/web/98c/295/01b/98c29501b32d457fa9e28b53bdc5a4de.jpg"></p><br><p>  Then you need to add the necessary performance counters.  For example, add the ‚ÄúSMB Server Shares‚Äù counter by clicking on the green plus, choosing the counter and share we need: </p><br><p><img src="https://habrastorage.org/web/4e4/021/9dc/4e40219dc9734f91bf73e1483e92b59d.jpg"></p><br><p>  And enjoy the result: </p><br><p><img src="https://habrastorage.org/web/7a1/5a3/cff/7a15a3cffcbd45caae2b376a5b398eb6.jpg"></p><br><p>  I recommend reading the <a href="https://habrahabr.ru/company/microsoft/blog/282740/">Microsoft</a> blog more fully with the procedure for using performance counters, collecting and analyzing results. </p></div></div><br><p>  We turn to tuning.  The Lanmanserver service is responsible for the operation of the SMB server, so part of the parameters can be changed in the corresponding registry branch: </p><br><pre> <code class="xml hljs">HKLM\System\CurrentControlSet\Services\LanmanServer\Parameters.</code> </pre><br><p>  It is more convenient, of course, to use the <strong>Set-SmbServerConfiguration cmdlet</strong> . </p><br><p><img src="https://habrastorage.org/web/a75/2eb/940/a752eb940e62461b9ba7a72216296304.jpg"></p><br><p>  <em>Displaying parameter values ‚Äã‚Äãusing the Get-SmbServerConfiguration cmdlet.</em> </p><br><p>  Parameters that should be paid attention first of all: </p><br><table><tbody><tr><td width="150">  Parameter name </td><td width="100">  Default value </td><td width="100">  Parameter type </td><td width="150">  What is responsible </td><td>  Comment </td></tr><tr><td>  Smb2CreditsMax </td><td>  8192 </td><td>  uint32 </td><td>  Maximum number of SMB v2 commands </td><td>  These two parameters allow you to dynamically distribute the load.  Sometimes when using high-speed channels with high latency (WAN), changing these parameters will increase the speed.  To see if there are any problems, help the performance counter ‚ÄúSMB Client Total Resources - Credit Delays / c‚Äù </td></tr><tr><td>  Smb2CreditsMin </td><td>  512 </td><td>  uint32 </td><td>  Minimum number of SMB v2 commands </td><td></td></tr><tr><td>  MaxThreadsPerQueue </td><td>  20 </td><td>  unit32 </td><td>  Maximum number of server threads when processing simultaneous requests </td><td>  Increasing the parameter affects the hardware boot, but increases performance.  The indicator to change a parameter can be the value of the performance counter ‚ÄúServer Work Queues - Queue Length - SMB2 NonBlocking‚Äù becomes more than 100. </td></tr><tr><td>  Asynchronouscredits </td><td>  512 </td><td>  uint32 </td><td>  Maximum number of simultaneous asynchronous commands in one session </td><td>  In some cases, for example, when using a loaded web server, increasing the value of the parameter increases performance </td></tr><tr><td>  MaxMpxCt </td><td>  50 </td><td>  uint32 </td><td>  Maximum number of outstanding client requests for each client </td><td>  Affects only SMB v1 clients </td></tr></tbody></table><br><p>  There is another registry entry that is not controlled by the powershell cmdlet: </p><br><ul><li><p>  path: HKLM \ System \ CurrentControlSet \ Control \ Session Manager \ Executive; </p><br></li><li><p>  parameter: REG_DWORD with the name AdditionalCriticalWorkerThreads; </p><br></li><li>  default value is 0. </li></ul><br><p>  This parameter is responsible for additional workflows responsible for writing and reading in the system cache of the file system.  By default, there are no additional processes, and changing this parameter can significantly speed up the operation of the file server.  Especially in the presence of multi-core processors and productive disk system.  You can think about increasing this parameter while the ‚ÄúCache -‚Äú Dirty ‚Äùpage performance counter grows. </p><br><p>  An example of tuning is the following parameter values: </p><br><ul><li><p>  AdditionalCriticalWorkerThreads = 64; </p><br></li><li><p>  MaxThreadsPerQueue = 64; </p><br></li><li>  MaxMpxCt = 32768. </li></ul><br><p>  Values ‚Äã‚Äãmust also be selected individually. </p><br><div class="spoiler">  <b class="spoiler_title">I propose to read about other parameters under the spoiler.</b> <div class="spoiler_text"><table><tbody><tr><td width="150">  Parameter name </td><td width="100">  Default value </td><td width="100">  Parameter type </td><td width="150">  What is responsible </td><td>  Comment </td></tr><tr><td>  AnnounceComment </td><td>  null </td><td>  string </td><td>  Server view </td><td></td></tr><tr><td>  AnnounceServer </td><td>  False </td><td>  boolean </td><td>  Enable - Disable Server View </td><td></td></tr><tr><td>  AuditSmb1Access </td><td>  False </td><td>  boolean </td><td>  Enable - Disable SMB Access Audit v1 </td><td>  The parameter appeared only in Windows 10 \ 2016 </td></tr><tr><td>  AutoDisconnectTimeout </td><td>  15 </td><td>  uint32 </td><td>  The time after which the inactive session is disconnected </td><td></td></tr><tr><td>  Autoshareserver </td><td>  True </td><td>  boolean </td><td>  Enable - disable default server network resources </td><td></td></tr><tr><td>  AutoShareWorkstation </td><td>  True </td><td>  boolean </td><td>  Enable ‚Äî Disables the network resources of the default workstation. </td><td></td></tr><tr><td>  CachedOpenLimit </td><td>  ten </td><td>  uint3 </td><td>  Maximum number of open files in cache </td><td></td></tr><tr><td>  DurableHandleV2TimeoutInSeconds </td><td>  180 </td><td>  uint32 </td><td>  Disable inactive handle timeout </td><td></td></tr><tr><td>  EnableAuthenticateUserSharing </td><td>  False </td><td>  boolean </td><td>  Enable ‚Äî Disable Connection Sharing </td><td></td></tr><tr><td>  EnableDownlevelTimewarp </td><td>  False </td><td>  boolean </td><td>  Enable - Disable Low Level Time Distortion </td><td></td></tr><tr><td>  EnableForcedLogoff </td><td>  True </td><td>  boolean </td><td>  Enable - Disable forced exit </td><td></td></tr><tr><td>  EnableLeasing </td><td>  True </td><td>  boolean </td><td>  Enable - Disable Rent </td><td></td></tr><tr><td>  EnableMultiChannel </td><td>  True </td><td>  boolean </td><td>  Enable ‚Äî Disable the use of multiple physical adapters. </td><td></td></tr><tr><td>  EnableOplocks </td><td>  True </td><td>  boolean </td><td>  Enable - Disable flexible locks (oplock) </td><td></td></tr><tr><td>  EnableSecuritySignature </td><td>  False </td><td>  boolean </td><td>  Enable - Disable SMB Signature Capability </td><td></td></tr><tr><td>  EnableSMB1Protocol </td><td>  True </td><td>  boolean </td><td>  Enable - Disable SMB v1 protocol </td><td></td></tr><tr><td>  EnableSMB2Protocol </td><td>  True </td><td>  boolean </td><td>  Enable - Disable SMB v2 + Protocol </td><td></td></tr><tr><td>  EnableStrictNameChecking </td><td>  True </td><td>  boolean </td><td>  Enable - Disable incoming connection check </td><td></td></tr><tr><td>  EncryptData </td><td>  False </td><td>  boolean </td><td>  Enable ‚Äî Disable data encryption support. </td><td></td></tr><tr><td>  IrpStackSize </td><td>  15 </td><td>  unit32 </td><td>  The size of the stack IRP (I / O requests) </td><td></td></tr><tr><td>  KeepAliveTime </td><td>  2 </td><td>  unit32 </td><td>  TCP keepalive request rate for SMB connection </td><td></td></tr><tr><td>  MaxChannelPerSession </td><td>  32 </td><td>  unit32 </td><td>  The number of channels in one session </td><td></td></tr><tr><td>  MaxMpxCount </td><td>  50 </td><td>  unit32 </td><td>  Maximum number of commands per session </td><td>  The parameter must be configured the same way as the MaxCmds client parameter </td></tr><tr><td>  MaxSessionPerConnection </td><td>  16384 </td><td>  unit32 </td><td>  Maximum number of sessions in one connection </td><td></td></tr><tr><td>  MaxWorkItems </td><td>  one </td><td>  uint32 </td><td>  Maximum number of work items </td><td>  This parameter affects SMB v1 only. </td></tr><tr><td>  NullSessionPipes </td><td>  null </td><td>  string </td><td>  Channels available in zero session </td><td></td></tr><tr><td>  NullSessionShares </td><td>  null </td><td>  string </td><td>  Network resources available in zero session </td><td></td></tr><tr><td>  OplockBreakWait </td><td>  35 </td><td>  uint32 </td><td>  Timeout before interruption of the lock </td><td></td></tr><tr><td>  PendingClientTimeoutInSeconds </td><td>  120 </td><td>  uint32 </td><td>  Client waiting time </td><td></td></tr><tr><td>  RejectUnencryptedAccess </td><td>  True </td><td>  boolean </td><td>  Enable ‚Äî Disable unencrypted access requests. </td><td></td></tr><tr><td>  RequireSecuritySignature </td><td>  False </td><td>  boolean </td><td>  Enable ‚Äî Disable SMB Signature Mandatory </td><td>  Enabling this option slows down the speed of operation, but increases protection against the MITM attack. </td></tr><tr><td>  ServerHidden </td><td>  True </td><td>  boolean </td><td>  Enable - Disable Server View </td><td>  By default, the server does not present itself. </td></tr><tr><td>  SmbServerNameHardeningLevel </td><td>  0 </td><td>  uint32 </td><td>  Server Name Simplification Level </td><td></td></tr><tr><td>  TreatHostAsStableStorage </td><td>  False </td><td>  boolean </td><td>  Enable ‚Äî Disable Trusted Disk Storage </td><td>  Enabling this option tells the server about the reliability of disk storage, it is worth including it when working with a disk with a non-volatile write cache.  Then the server will not wait for confirmation to write to the disk, which will speed up performance. </td></tr><tr><td>  ValidateAliasNotCircular </td><td>  True </td><td>  boolean </td><td>  Enabling - disabling the use of aliases </td><td></td></tr><tr><td>  ValidateShareScope </td><td>  True </td><td>  boolean </td><td>  Enable ‚Äî Disable resource name checking when creating a new resource. </td><td></td></tr><tr><td>  ValidateShareScopeNotAliased </td><td>  True </td><td>  boolean </td><td>  Enabling - disabling the checking of resource aliases when creating a new resource </td><td></td></tr><tr><td>  ValidateTargetName </td><td>  True </td><td>  boolean </td><td>  Enable - disable checking the name of the target resource when creating an alias </td><td></td></tr></tbody></table></div></div><br><p>  I repeat: changing the parameters can lead to server malfunction.  Therefore, it is better to first "practice on cats."  Or at least make backups. </p><br><p>  I turn to the next, seemingly simple role - the print server. </p><br><h1 id="server-pechati">  Print server </h1><br><p>  In addition to the recommendations of the "faster, higher, stronger" in terms of hardware, you need to note several other interesting points. </p><br><p>  <strong>Transferring a print queue</strong> to a non-system disk will greatly increase server performance.  This is done in the properties of the print server, in the "advanced settings" tab. </p><br><p><img src="https://habrastorage.org/web/c80/bd4/b26/c80bd4b263444fbfaa6c0a3c67a10dbb.jpg"><br>  <em>Setting the location of the print queue.</em> </p><br><p>  Whenever possible it is better to <strong>draw tasks on the client</strong> .  In this case, the client will translate the document into a special format for printing (PDL).  The server will not waste resources on this conversion. </p><br><p>  By default, this feature is already enabled; you can turn it on ‚Äï by using Group Policy for all printers.  Printers can be individually configured using the command </p><br><pre> <code class="bash hljs">printui /Xs /n <span class="hljs-string"><span class="hljs-string">"printer"</span></span> ClientSideRender disabled</code> </pre><br><p>  It makes sense to turn off rendering on the client with a sufficient margin of print server performance to offload clients. </p><br><p>  Printers with <strong>XPS</strong> (OpenXPS) support put less pressure on the server than printers without it.  Printers with PCL 6 and Postscript support are a bit less efficient because of the vector format.  Therefore, when choosing a printer is better to choose with support for XPS, and install the appropriate driver. </p><br><p>  With the release of Windows 8 \ 2012, there is support for <strong>print drivers v4</strong> .  The 4th version drivers are more productive, but Windows 7 will print on the fourth type driver, drawing tasks on the client.  Therefore, if there are still old Windows on the network, it is worthwhile to install third type drivers.  You can look at the driver type in the print server properties on the Drivers tab: </p><br><p><img src="https://habrastorage.org/web/242/f8f/bdc/242f8fbdc8a64dc3a3b3f759847bb4c7.jpg"><br>  <em>Installation window for additional drivers.</em> </p><br><p>  If we talk about the capabilities of drivers of the fourth type, then these include: </p><br><ul><li><p>  use of graphics card for drawing print tasks.  Yes, now, to improve performance when drawing tasks on the server, you can install a <a href="https://habrahabr.ru/company/pc-administrator/blog/319712/">video card</a> in the print server; </p><br></li><li>  simplified system for connecting a ‚Äúshared‚Äù printer: now you don‚Äôt need to install drivers for different processor architectures. </li></ul><br><p>  <strong>Branch Office</strong> technology also deserves attention <strong>.</strong>  With its help, the client works with the printer directly, bypassing any processing on the print server.  True, you will need printers with support for TCP \ IP or WSD.  You can learn more about the technology on the <a href="https://technet.microsoft.com/en-us/library/jj134152.aspx">Microsoft</a> website, and you can enable or disable it for a specific printer using the powershell cmdlet: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>‚ÄïPrinter ‚Äï<span class="hljs-type"><span class="hljs-type">name</span></span> &lt;printername&gt; ‚ÄïComputerName &lt;computername&gt; ‚ÄïRenderingMode BranchOffice</code> </pre><br><p>  The technology does not work if print processing is used on the server. </p><br><p>  To diagnose bottlenecks when printing, pay attention to three processes: </p><br><ul><li><p>  Spoolsv.exe; </p><br></li><li><p>  Printfilterpipelinesvc.exe; </p><br></li><li>  Printisolationhost.exe; </li></ul><br><p>  And also look at the expense of these processes of memory, processor and hard disk load.  For a more subtle search for bottlenecks, special performance counters will help. </p><br><p><img src="https://habrastorage.org/web/ade/da1/e6d/adeda1e6dd7343ee873edb3345e5cda0.jpg"><br>  <em>A set of typical print subsystem performance counters.</em> </p><br><div class="spoiler">  <b class="spoiler_title">List of counters with explanations - under the spoiler.</b> <div class="spoiler_text"><table><tbody><tr><td>  Title </td><td>  Description </td></tr><tr><td>  Total jobs printed </td><td>  Number of jobs printed </td></tr><tr><td>  Total pages printed </td><td>  Number of pages printed </td></tr><tr><td>  Call Add Network Printer </td><td>  Number of connections to the shared printer since the last restart of the service </td></tr><tr><td>  Tasks </td><td>  Number of jobs printed since the last service restart </td></tr><tr><td>  Jobs Handled by the Print Manager </td><td>  The current number of jobs in the print service </td></tr><tr><td>  Maximum jobs processed by the dispatcher </td><td>  Maximum number of jobs in print service </td></tr><tr><td>  Maximum links </td><td>  The maximum number of accesses to the print queue </td></tr><tr><td>  Task errors </td><td>  Number of job errors </td></tr><tr><td>  Errors "Missing Paper" </td><td>  The number of errors caused by the lack of paper </td></tr><tr><td>  Errors "The printer is not ready" </td><td>  Number of printer errors </td></tr><tr><td>  Printable bytes / c </td><td>  The speed of the current printing in bytes, allows you to approximately estimate the time the printer is busy </td></tr><tr><td>  Links </td><td>  The current number of accesses to the print queue </td></tr></tbody></table></div></div><br><p>  In general, selecting parameters for a specific situation can improve the performance of these simple roles up to 50%.  A <a href="https://servermall.ru/">refurbished</a> server will still give light to modern monsters with the default settings. </p><br><p>  Tell us in the comments about the performance improvement of any Windows roles you would be interested to read.  <strong>Have you ever been involved in tuning roles and services?</strong>  <strong>What results have been achieved?</strong> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/332600/">https://habr.com/ru/post/332600/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../332586/index.html">Fix bugs in 1988 style</a></li>
<li><a href="../332588/index.html">How to create your own metro</a></li>
<li><a href="../332594/index.html">Let's Encrypt will start issuing wildcard certificates in January 2018</a></li>
<li><a href="../332596/index.html">We remove and deposit cash at an ATM using a smartphone. World's first</a></li>
<li><a href="../332598/index.html">What I learned by converting a project to Kotlin using Android Studio</a></li>
<li><a href="../332602/index.html">Why mobile apps take up more space</a></li>
<li><a href="../332604/index.html">How to build a database for mailings and do not turn into a spammer?</a></li>
<li><a href="../332608/index.html">How to create a vegetation billboard texture in Unreal Engine 4</a></li>
<li><a href="../332612/index.html">Seminar "Clouds and reality: cases, rakes, good news", July 13, St. Petersburg</a></li>
<li><a href="../332614/index.html">Backup LVM2 volumes with IO overload protection using SIGSTOP, SIGCONT signals</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>