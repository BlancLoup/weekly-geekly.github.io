<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Meet the PayPal API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the moment, PayPal is the most popular electronic payment platform. Exactly how easy it is to open an account and start receiving funds for it, com...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Meet the PayPal API</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/storage1/c74a005b/cb487e73/ca1e5085/f9d5b0e6.png">  At the moment, PayPal is the most popular electronic payment platform.  Exactly how easy it is to open an account and start receiving funds for it, compared to traditional methods of receiving payments, is the reason # 1 for its extreme popularity.  The second reason many would agree with me is the powerful API provided by PayPal.  In this topic, I will decompose in order all the methods and tricks associated with the work of PayPal API, so that you avoid problems with its integration. <br><a name="habracut"></a><br><br>  <b>Warning:</b> PayPal API is one of the most disgusting that I have ever seen.  Inaccurate, in some places incomplete or inconsistent documentation, unpredictable failures and a significant difference between the work of the API in real conditions and in the sandbox, all this is essentially a pain in the ass that you have to deal with. <br><br><h4><img src="https://habrastorage.org/storage1/36789f36/e659a957/cc3573a5/7d7e3251.png" alt="Part 1: PayPal Payment Types" title="Part 1: PayPal Payment Types"></h4><br>  PayPal offers a whole range of payment methods, which is bound to confuse a person unfamiliar with PP: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Express payment</b> <br>  The main service from a variety of similar ones offered by PayPal.  An express payment will allow you to receive funds without having a merchant account, and in general, no special requirements whatsoever, except for a banal account confirmation (either through a bank account or through a credit / debit card), no.  Previously, users could only accept express payments from other PayPal users, but since the system introduced the ability to pay directly from a bank card for those who do not have an account, it is possible to receive payments from almost everyone who has a card.  Please note that express payments are entirely made on PayPal, so this method cannot be fully integrated into your website. <br><br>  <b>Direct payment</b> <br>  This method will allow you to receive payments from bank cards through a simple API call.  This will allow you to fully integrate the entire translation process into your website, which, in some cases, will make shopping for your users more convenient.  There is another variation of the direct payment, which will allow you to authorize the transfer and execute it only after a certain period of time.  The postpone method is available only to users from the United States, Canada and the United Kingdom. <br><br>  <b>Recurring payment</b> <br>  This method will allow you to re-withdraw funds from the user's account (for example, it is used in the monthly payment for any subscription). <br><br>  <b>Bulk payment</b> <br>  Mass payment will allow you to divide the funds received between multiple accounts. <br><br>  <b>Adaptive Payments</b> <br>  This option basically performs the same function as the previous one, but with some differences (I‚Äôve already mentioned that PayPal API is confusing and full of excesses). <br><br>  This list can not be called complete, but it lists the most popular ways to receive funds (Want more - welcome to the <a href="https://cms.paypal.com/us/cgi-bin/%3Fcmd%3D_render-content%26content_ID%3Ddeveloper/howto_api_reference">documentation</a> ). <br><br><img src="https://habrastorage.org/storage1/6ab050f5/c3c7f658/28f0e26e/fd58a3f7.png" alt="Part 2: Creating an API Request" title="Part 2: Creating an API Request"><br>  PayPal supports two formats of data transfer via the HTTP protocol: NVP and SOAP.  NVP is an abbreviation for the Name-Value Pair, meanwhile SOAP stands for Simple Object Access Protocol.  I‚Äôll only talk about NVP, since it‚Äôs much more flexible than SOAP. <br><br>  All methods listed in part 1 have their own parameters, but they all have several identical basic parameters that are passed to identify the API account and authorize the payment: <br><ul><li><code>USER</code> <br>  The name of your PayPal API account; <br></li><li> <code>PWD</code> <br>  Password for your PayPal API account; <br></li><li> <code>VERSION</code> <br>  The version number of the NVP API, for example, <a href="https://cms.paypal.com/us/cgi-bin/%3Fcmd%3D_render-content%26content_ID%3Ddeveloper/e_howto_api_nvp_PayPalAPIWhatsNewNVP">74.0</a> (the latest version at the time of this writing); <br></li><li> <code>SIGNATURE</code> <br>  Electronic Signature PayPal API.  The parameter should be used only if you use a certificate for authorization; <br></li></ul>  The last of the required parameters is <code>METHOD</code> , which announces what method of transfer of funds we will use. <br><br>  Requests are transmitted using the HTTPS protocol.  For example, we will use cURL to form our simple request, and then we will put the whole process into a separate class: <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Paypal</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** *     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> array */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $_errors = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-comment"><span class="hljs-comment">/** *  API *    ,        * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> array */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $_credentials = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'USER'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'seller_1297608781_biz_api1.lionite.com'</span></span>, <span class="hljs-string"><span class="hljs-string">'PWD'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'1297608792'</span></span>, <span class="hljs-string"><span class="hljs-string">'SIGNATURE'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'A3g66.FS3NAf4mkHn3BDQdpo6JD.ACcPc4wMrInvUEqO3Uapovity47p'</span></span>, ); <span class="hljs-comment"><span class="hljs-comment">/** * ,     *   - https://api-3t.paypal.com/nvp *  - https://api-3t.sandbox.paypal.com/nvp * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $_endPoint = <span class="hljs-string"><span class="hljs-string">'https://api-3t.sandbox.paypal.com/nvp'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *  API * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $_version = <span class="hljs-string"><span class="hljs-string">'74.0'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *   * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $method      * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> array $params   * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> array / boolean Response array / boolean false on failure */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($method,$params = array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span> -&gt; _errors = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($method) ) { <span class="hljs-comment"><span class="hljs-comment">// ,     $this -&gt; _errors = array('    '); return false; } //    $requestParams = array( 'METHOD' =&gt; $method, 'VERSION' =&gt; $this -&gt; _version ) + $this -&gt; _credentials; //    NVP $request = http_build_query($requestParams + $params); //  cURL $curlOptions = array ( CURLOPT_URL =&gt; $this -&gt; _endPoint, CURLOPT_VERBOSE =&gt; 1, CURLOPT_SSL_VERIFYPEER =&gt; true, CURLOPT_SSL_VERIFYHOST =&gt; 2, CURLOPT_CAINFO =&gt; dirname(__FILE__) . '/cacert.pem', //   CURLOPT_RETURNTRANSFER =&gt; 1, CURLOPT_POST =&gt; 1, CURLOPT_POSTFIELDS =&gt; $request ); $ch = curl_init(); curl_setopt_array($ch,$curlOptions); //   , $response     API $response = curl_exec($ch); // ,      cURL if (curl_errno($ch)) { $this -&gt; _errors = curl_error($ch); curl_close($ch); return false; } else { curl_close($ch); $responseArray = array(); parse_str($response,$responseArray); //  ,   NVP   return $responseArray; } } }</span></span></code> </pre><br>  Please note that I used a CA certificate for SSL validation.  The certificate file can be found on <a href="http://curl.haxx.se/docs/caextract.html">the cURL website</a> .  Do not forget to change the path to the certificate in accordance with the location where you downloaded it. <br><br>  The response to the request will be in NVP format, and I have broken it into an array.  The <code>ACK</code> parameter indicates the result of processing the request: <code>Success</code> or <code>SuccessWithWarning</code> in case the request was successful, <code>Error</code> or <code>Warning</code> in case the request failed. <br><br>  The request can be rejected for a variety of reasons, and for each method of payment has its own reasons, which are discussed in detail in the <a href="https://cms.paypal.com/us/cgi-bin/%3Fcmd%3D_render-content%26content_ID%3Ddeveloper/e_howto_api_nvp_errorcodes">documentation</a> .  A little later we will look at some of them and learn how to fix them.  By the way, pay attention to the fact that all the parameters in the request are case-sensitive, which is often the reason for the failure. <br><br><img src="https://habrastorage.org/storage1/fa3725cc/16433c9b/b62d8a90/a9e65cd5.png" alt="Part 3: We work with express payment" title="Part 3: We work with express payment"><br>  One of the most popular ways to transfer funds is an express payment, which allows you to receive funds without opening a special account (Website Payments Pro), which is available only to US citizens, and the payment is made on the PayPal side, which does not require any protection. <br><br>  The entire payment passes according to the following algorithm: <br><ol><li>  We request access tokens from PayPal by sending transfer details; </li><li>  If the token is received, we redirect the user to the PayPal site using the received token; </li><li>  The user makes or cancels a payment on the PayPal platform, and then redirects back to our site; </li><li>  We complete the payment, either when the user is redirected back, or via <a href="https://cms.paypal.com/us/cgi-bin/%3Fcmd%3D_render-content%26content_ID%3Ddeveloper/e_howto_admin_IPNIntro">Instant Payment Notification (IPN)</a> . </li></ol><br><div style="text-align:center;"><img src="https://habrastorage.org/storage1/4767db4e/dc8d42f0/2e11ce5e/c0b0b819.png"></div><br><br><img src="https://habrastorage.org/storage1/f2820902/87c9ebba/d3b75d7d/48a74d97.png" alt="1. Get the token: SetExpressCheckout" title="1. Get the token: SetExpressCheckout"><br>  The express payment process starts by sending payment data to the PayPal API, after which we get a token that identifies our transaction.  This token will come in handy in the next step when we send the user to the PayPal platform. <br><br>  The following parameters must be specified in the request: <br><ul><li> <code>METHOD</code> <br>  Here you need to specify which payment method we choose (for example, <code>SetExpressCheckout</code> ); <br></li><li> <code>RETURNURL</code> <br>  The address to which the user will be redirected after a successful payment; <br></li><li> <code>CANCELURL</code> <br>  The address to which the user will be redirected if an error occurred during the payment; <br></li><li> <code>PAYMENTREQUEST_0_AMT</code> <br>  Total amount to transfer.  You need to specify two decimal numbers separated by a dot ( <code>.</code> ).  Optionally, you can use a comma ( <code>,</code> ) to separate thousands; <br></li><li> <code>PAYMENTREQUEST_0_ITEMAMT</code> <br>  The total cost, which does not include the commission, taxes, shipping costs and other additional.  costs.  If there is no such parameter, the value of this parameter must correspond to the value of <code>PAYMENTREQUEST_0_AMT</code> . <br></li></ul>  We can also pass additional parameters that will allow us to expand the set of information about the payment, some of the parameters have default values: <br><ul><li> <code>PAYMENTREQUEST_0_CURRENCYCODE</code> <br>  This parameter defines the currency in which all transactions will be conducted.  You need to specify a <a href="http://ru.wikipedia.org/wiki/ISO_4217">three-digit code</a> .  The default value is <code>USD</code> ; <br></li><li> <code>PAYMENTREQUEST_0_SHIPPINGAMT</code> <br>  Shipping cost of the order; <br></li><li> <code>PAYMENTREQUEST_0_TAXAMT</code> <br>  The total amount of all commissions (only necessary if there are several positions in the order and each commission has its own commission); <br></li><li> <code>PAYMENTREQUEST_0_DESC</code> <br>  Description of the translation. <br></li></ul>  If the user pays for several products at once, then it is possible to make a list of products for convenience: <br><ul><li> <code>L_PAYMENTREQUEST_0_NAMEm</code> <br>  Product Name; <br></li><li> <code>L_PAYMENTREQUEST_0_DESCm</code> <br>  Product description; <br></li><li> <code>L_PAYMENTREQUEST_0_AMTm</code> <br>  Unit cost; <br></li><li> <code>L_PAYMENTREQUEST_0_QTYm</code> <br>  Quantity of goods. <br></li></ul><br><br>  The variable <code>m</code> identifies a specific product (use the same variable index for the parameters applicable to the same product). <br><br>  There is a whole host of optional parameters that you can easily find in the <a href="https://cms.paypal.com/us/cgi-bin/%3Fcmd%3D_render-content%26content_ID%3Ddeveloper/e_howto_api_nvp_r_SetExpressCheckout">documentation</a> . <br><br>  We use the function we wrote earlier in part 2 to form a <code>SetExpressCheckout</code> request: <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//    $requestParams = array( 'RETURNURL' =&gt; 'http://www.yourdomain.com/payment/success', 'CANCELURL' =&gt; 'http://www.yourdomain.com/payment/cancelled' ); $orderParams = array( 'PAYMENTREQUEST_0_AMT' =&gt; '500', 'PAYMENTREQUEST_0_SHIPPINGAMT' =&gt; '4', 'PAYMENTREQUEST_0_CURRENCYCODE' =&gt; 'GBP', 'PAYMENTREQUEST_0_ITEMAMT' =&gt; '496' ); $item = array( 'L_PAYMENTREQUEST_0_NAME0' =&gt; 'iPhone', 'L_PAYMENTREQUEST_0_DESC0' =&gt; 'White iPhone, 16GB', 'L_PAYMENTREQUEST_0_AMT0' =&gt; '496', 'L_PAYMENTREQUEST_0_QTY0' =&gt; '1' ); $paypal = new Paypal(); $response = $paypal -&gt; request('SetExpressCheckout',$requestParams + $orderParams + $item);</span></span></code> </pre> <br><br><img src="https://habrastorage.org/storage1/715c3631/b3480b67/f44dd6b1/7cfd1233.png" alt="2. Use the resulting token to redirect to PayPal" title="2. Use the resulting token to redirect to PayPal"><br>  If the request was successful, we will receive a token in the <code>TOKEN</code> parameter in the response from PayPal. <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(is_array($response) &amp;&amp; $response[<span class="hljs-string"><span class="hljs-string">'ACK'</span></span>] == <span class="hljs-string"><span class="hljs-string">'Success'</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//     $token = $response['TOKEN']; header( 'Location: https://www.paypal.com/webscr?cmd=_express-checkout&amp;token=' . urlencode($token) ); }</span></span></code> </pre>  Now the user is sent to the PayPal platform, where the entire transfer process will be processed.  When the user successfully completes or cancels the payment, he will be sent to one of the relevant pages, which we indicated in the request. <br><br><img src="https://habrastorage.org/storage1/adb73e9a/2599063c/cd1db1b9/1dddae4a.png" alt="3. Complete the translation" title="3. Complete the translation"><br>  Suppose a user has confirmed a transfer, after which he will be sent back to our website.  At this very moment, we need to use two appropriate API functions: <code>DoExpressCheckoutPayment</code> will complete the transfer, but before that we need to get more information about the customer using <code>GetExpressCheckoutDetails</code> . <br><br>  PayPal will redirect the user back to our website along with the token we will use to call these functions.  The token will be listed in the URL in the <code>token</code> parameter.  We will check its presence in the address to which the user is transferred and send the necessary requests to the API in case he is present. <br><br>  The <code>GetExpressCheckoutDetails</code> function requires the transfer of a single token, and the <code>DoExpressCheckoutPayment</code> requires the specification of several additional parameters: <br><ul><li> <code>PAYMENTREQUEST_0_PAYMENTACTION</code> <br>  This parameter defines the action we need.  <code>Sale</code> must be specified in the value if we have not specified another action in the <code>SetExpressCheckout</code> function ( <code>Authorization</code> and <code>Capture</code> among the possible values); <br></li><li> <code>PAYERID</code> <br>  This parameter specifies the unique identifier for your PayPal account.  It, like the token, will be returned in the URL when the user is redirected (in the <code>PayerID</code> parameter). <br></li></ul><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_GET[<span class="hljs-string"><span class="hljs-string">'token'</span></span>]) &amp;&amp; !<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($_GET[<span class="hljs-string"><span class="hljs-string">'token'</span></span>]) ) { <span class="hljs-comment"><span class="hljs-comment">//   //   ,    . //        ,  ,    $paypal = new Paypal(); $checkoutDetails = $paypal -&gt; request('GetExpressCheckoutDetails', array('TOKEN' =&gt; $_GET['token'])); //   $requestParams = array( 'PAYMENTREQUEST_0_PAYMENTACTION' =&gt; 'Sale', 'PAYERID' =&gt; $_GET['PayerID'] ); $response = $paypal -&gt; request('DoExpressCheckoutPayment',$requestParams); if( is_array($response) &amp;&amp; $response['ACK'] == 'Success') { //    //    ID ,      $transactionId = $response['PAYMENTINFO_0_TRANSACTIONID']; } }</span></span></code> </pre> <br><br><img src="https://habrastorage.org/storage1/76722ffe/93f212a9/4913acfb/c26a108a.png" alt="Part 4: We work with direct payment" title="Part 4: We work with direct payment"><br>  Direct payment allows you to fully control the entire process of transferring funds right on your website.  For some unknown reason, in this case, buyers without a PayPal account will not be able to pay for services and products on your site, but it will be possible to make the whole process as simple as possible, which will have a positive impact on users' opinions.  Full control over the process actually allows us to optimize and increase sales. <br><div style="text-align:center;"><img src="https://habrastorage.org/storage1/1b4cb6cc/da3a59a7/55672b6f/ceb98703.png"></div><br>  This method is a bit simpler than an express payment, because all user interaction occurs on your website, and we will need to make only one request to the API: <code>DoDirectPayment</code> . <br><br>  But you should pay attention to the fact that you will have to make a few more requests if you are going to debit money from the user's account after a certain period of time (for example, when you are waiting for the goods to be transferred to the delivery service).  For this, we will use the methods of <code>Authorization</code> and <code>Capture</code> , about which I will not tell you, but you still need to know about their existence. <br><br><img src="https://habrastorage.org/storage1/67b46b63/002c31f7/11958592/2fb45d88.png" alt="1. Required parameters" title="1. Required parameters"><br>  Direct payment, as was said earlier, requires the indication of completely different parameters.  Despite the fact that the parameters indicating the details of the transfer are similar to the express payment (the same appointments, other names are more fun), this method requires information about the bank card and address. <br><br>  <b>The main parameters of direct payment:</b> <ul><li> <code>METHOD</code> <br>  Obviously, in this parameter, you must specify DoDirectPayment; <br></li><li> <code>IPADDRESS</code> <br>  In this parameter, you must specify the IP address of the buyer.  Using PHP, we can easily get it using <code>$_SERVER['REMOTE_ADDR']</code> , however, we have to do a <a href="http://stackoverflow.com/questions/55768/how-do-i-find-a-users-ip-address-with-php/55790">little more work</a> if on your server PHP communicates with the outside world through an intermediary (for example, if you use nginx); <br></li><li> <code>PAYMENTACTION</code> <br>  This parameter defines the desired action.  As it was said several times before, we need to specify <code>Sale</code> in it. <br></li></ul><br><br>  <b>Bank card details:</b> <ul><li> <code>CREDITCARDTYPE</code> <br>  The type of bank card (for example, Visa, MasterCard and others); <br></li><li> <code>ACCT</code> <br>  Bank card number (do you also like these wonderful abbreviations?); <br></li><li> <code>EXPDATE</code> <br>  The expiration date of the card in the format MMYYYY (two digits per month, four digits a year); <br></li><li> <code>CVV2</code> <br>  A three-four-digit code, also known as a security code.  Indicated on the back of the card. <br></li></ul><br><br>  <b>Information about the buyer:</b> <ul><li> <code>FIRSTNAME, LASTNAME</code> <br>  First and last name of the buyer, in separate fields.  Optionally, you can also send the user's e-mail in the EMAIL parameter; <br></li><li> <code>CITY, STATE, COUNTRYCODE, ZIP</code> <br>  City, state, <a href="http://ru.wikipedia.org/wiki/ISO_3166-1">two-digit country code</a> , zip code, all these fields are required; <br></li><li> <code>STREET, STREET2</code> <br>  Two lines for the address.  Only the first is obligatory. <br></li></ul>  The address will be processed <a href="https://cms.paypal.com/us/cgi-bin/%3Fcmd%3D_render-content%26content_ID%3Ddeveloper/e_howto_api_nvp_AVSResponseCodes">by the address verification system (AVS)</a> .  You will be returned a specific error if the transaction was rejected due to an incorrect address. <br><br>  The parameters for specifying payment details are similar to those for express payments, but with some differences in names ( <code>AMT</code> , <code>ITEMAMT</code> , <code>CURRENCYCODE</code> , <code>SHIPPINGAMT</code> , <code>TAXAMT</code> and <code>DESC</code> should be used).  See the documentation for details. <br><br>  In the same way, to enter information about products, you must use the following parameters: <code>L_NAMEm</code> , <code>L_DESCm</code> , <code>L_AMTm</code> and <code>L_QTYm</code> .  The variable m is used to delimit the parameters for each individual product (replace with 0, 1 and further for the numbered positions in the order).  Consult the documentation for a <a href="https://cms.paypal.com/us/cgi-bin/%3Fcmd%3D_render-content%26content_ID%3Ddeveloper/e_howto_api_nvp_r_DoDirectPayment">more complete list</a> . <br><br><img src="https://habrastorage.org/storage1/63eeea7e/f0cb4e71/1d2cc848/ea213883.png" alt="2. Conducting a transaction" title="2. Conducting a transaction"><br>  Sending a request using the function we wrote earlier is very similar to the case of express payment.  We pass all parameters in exactly the same way, but specify <code>DoDirectPayment</code> as the method. <pre> <code class="php hljs">$requestParams = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'IPADDRESS'</span></span> =&gt; $_SERVER[<span class="hljs-string"><span class="hljs-string">'REMOTE_ADDR'</span></span>], <span class="hljs-string"><span class="hljs-string">'PAYMENTACTION'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Sale'</span></span> ); $creditCardDetails = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'CREDITCARDTYPE'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Visa'</span></span>, <span class="hljs-string"><span class="hljs-string">'ACCT'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'4929802607281663'</span></span>, <span class="hljs-string"><span class="hljs-string">'EXPDATE'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'062012'</span></span>, <span class="hljs-string"><span class="hljs-string">'CVV2'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'984'</span></span> ); $payerDetails = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'FIRSTNAME'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'John'</span></span>, <span class="hljs-string"><span class="hljs-string">'LASTNAME'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Doe'</span></span>, <span class="hljs-string"><span class="hljs-string">'COUNTRYCODE'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'US'</span></span>, <span class="hljs-string"><span class="hljs-string">'STATE'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NY'</span></span>, <span class="hljs-string"><span class="hljs-string">'CITY'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'New York'</span></span>, <span class="hljs-string"><span class="hljs-string">'STREET'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'14 Argyle Rd.'</span></span>, <span class="hljs-string"><span class="hljs-string">'ZIP'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'10010'</span></span> ); $orderParams = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'AMT'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'500'</span></span>, <span class="hljs-string"><span class="hljs-string">'ITEMAMT'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'496'</span></span>, <span class="hljs-string"><span class="hljs-string">'SHIPPINGAMT'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'4'</span></span>, <span class="hljs-string"><span class="hljs-string">'CURRENCYCODE'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'GBP'</span></span> ); $item = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'L_NAME0'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'iPhone'</span></span>, <span class="hljs-string"><span class="hljs-string">'L_DESC0'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'White iPhone, 16GB'</span></span>, <span class="hljs-string"><span class="hljs-string">'L_AMT0'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'496'</span></span>, <span class="hljs-string"><span class="hljs-string">'L_QTY0'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'1'</span></span> ); $paypal = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Paypal(); $response = $paypal -&gt; request(<span class="hljs-string"><span class="hljs-string">'DoDirectPayment'</span></span>, $requestParams + $creditCardDetails + $payerDetails + $orderParams + $item ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( is_array($response) &amp;&amp; $response[<span class="hljs-string"><span class="hljs-string">'ACK'</span></span>] == <span class="hljs-string"><span class="hljs-string">'Success'</span></span>) { $transactionId = $response[<span class="hljs-string"><span class="hljs-string">'TRANSACTIONID'</span></span>]; }</code> </pre> <br><br><img src="https://habrastorage.org/storage1/bdc45ea4/622274fd/5ec64a8d/029427f3.png" alt=" 5:  " title="Part 5: Error Handling"><br>  If we lived in an ideal world, this part would not exist.  In reality, you will have to refer to this part or similar sections in other articles quite often.  PayPal may refuse to make a payment for one of a whole bunch of errors, and the correction of some of them is not under our control. <br><br>  The <code>$response</code> variable, which contains the response from the <code>paypalApiRequest()</code> function, may contain in the <code>ACK</code> parameter a value that does not correspond to <code>Success</code> , namely: <ul><li> <code>Success</code> <br>  The operation was successful; <br></li><li> <code>SuccessWithWarning</code> <br>  The operation was successful, but not perfect.  The API returned a message explaining what needs to be corrected; <br></li><li> <code>Failure</code> <br>  The operation was not successful; there are error codes in the response explaining the failure; <br></li><li> <code>FailureWithWarning</code> <br>  The operation was not successful, there are error codes and messages in response to which you should look. <br></li></ul><br>  It turns out that there are two successful statuses and two failures.  All the code specified above works only with the status of success, but we can easily replace it with <code>SuccessWithWarning</code> , but do not forget to check what the matter is and what the warning is about.  The most common error scenario for a direct payment is that the request was successfully accepted and verified, but the bank rejected the request to withdraw funds from the card. <br><br>  The errors returned by PayPal are enclosed in four parameters in the response: <ul><li> <code>L_ERRORCODE0</code> <br>  The digital error code that can be decrypted using <a href="https://cms.paypal.com/us/cgi-bin/%3Fcmd%3D_render-content%26content_ID%3Ddeveloper/e_howto_api_nvp_errorcodes">the PayPal error code list</a> ; <br></li><li> <code>L_SHORTMESSAGE0</code> <br>  A short message explaining the problem; <br></li><li> <code>L_LONGMESSAGE0</code> <br>  A detailed message explaining the problem; <br></li><li> <code>L_SEVERITYCODE0</code> <br>  Difficulty code.  I have no idea why he is needed, the documentation about him is silent, well, okay, let's forget about him. <br></li></ul>  The variable <code>0</code> at the end of the parameters is the sequence number of the error that occurred (if there are several errors, then the variable will have 1, 2, and so on). <br><br>  Here is a small list of the most common errors: <ul><li> <code>10002</code> <br>  API authorization data failed validation; <br></li><li> <code>81***</code> <br>  One of the required parameters is missing; <br></li><li> <code>104**</code> <br>  An incorrect value was passed in one of the parameters. <br></li></ul><br><img src="https://habrastorage.org/storage1/266f19c3/6951001c/f3758129/209c7c53.png" alt="      ?" title="How to solve all these problems in practice?"><br>  Some PayPal errors may contain private information in your description, which you hardly want to show to users.  For this reason, users are advised to turn off error display, even if it may be useful. <br><br>  In most cases, I would advise to do the following: <ol><li>  Create a white list of errors that can be shown to users (for example, incorrect data on a bank card); </li><li>  Make it so that when returning errors, they are checked against the white list; </li><li>  If there is no error in this list, the user needs to display some general error, for example, ‚ÄúAn error has occurred during the processing of your payment.  Wait a few minutes or contact us to solve this problem. " </li></ol><br><img src="https://habrastorage.org/storage1/6a994600/769783f7/5a7ffe05/2b6f649e.png"><br>  In this topic, I talked about the two most popular APIs and about working with errors.  This should be enough so that you can start working with the most popular payment system on the network. <br><br>  In the PayPal API, you can find a lot more methods and methods, more than one topic.  Once you learn how to work with the two most popular ways, learning the rest will be much easier.  I hope that this guide will give you a good start in using the API. <br><img src="https://habrastorage.org/storage1/6a994600/769783f7/5a7ffe05/2b6f649e.png"><br>  Original article: <a href="http://coding.smashingmagazine.com/2011/09/05/getting-started-with-the-paypal-api/">Getting Started With The PayPal API</a> , Eran Galperin, September 5, 2011. <br><br>  I really hope that this translation will be really useful for the habrasoobshchestvo.  In other words, I still do not lose hope for the holiday on September 24th.  Wait and see. <br><img src="https://habrastorage.org/storage1/6a994600/769783f7/5a7ffe05/2b6f649e.png"><br><img src="http://bade.psr.edu/files/by-nc-sa.jpg" alt="image"><br>  This text is distributed under a <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons Attribution-NonCommercial-ShareAlike 3.0 license</a> . <br>  You can copy, edit and use this text for non-commercial purposes with the obligatory indication of authorship and preservation of the original license. </div><p>Source: <a href="https://habr.com/ru/post/128198/">https://habr.com/ru/post/128198/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../128191/index.html">How to write quine</a></li>
<li><a href="../128192/index.html">Free book "Best of Smashing Magazine"</a></li>
<li><a href="../128193/index.html">Find greater value without comparison and conditions</a></li>
<li><a href="../128194/index.html">Smozzy application for Android: go to the Internet without the Internet</a></li>
<li><a href="../128197/index.html">Looking for mail.ru on Google?</a></li>
<li><a href="../128199/index.html">Correction of new accounting rules for App Engine applications. Good news</a></li>
<li><a href="../128201/index.html">The titans. Steve Jobs (translation)</a></li>
<li><a href="../128202/index.html">Details about the new programming language Google Dart (Dash)</a></li>
<li><a href="../128204/index.html">Digital Communications Kazakhstan 2011</a></li>
<li><a href="../128207/index.html">Hi-Tech@Mail.Ru: Samsung Wave 3 + Bada 2.0 Review</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>