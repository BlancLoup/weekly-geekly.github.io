<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Support clean balls to share files using Powershell</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Each organization has a network resource for exchanging data between users, to which all have access. What to do when users themselves do not delete t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Support clean balls to share files using Powershell</h1><div class="post__text post__text-html js-mediator-article">  Each organization has a network resource for exchanging data between users, to which all have access.  What to do when users themselves do not delete temporary files from their folders in the ‚Äúexchange‚Äù and the resource starts to take up too much space? <br><br>  Task: <br>  1) Automatic cleaning of user folders on a shared network share with preservation of the directory structure up to level 1.  In the root of the resource folders are located by the names of users. <br>  2) Saving data for the past day in the "Yesterday" folder (read-only user rights).  This is necessary in case the user forgot to pick up an important document yesterday. <br>  3) Logging file copying errors.  For analysis. <br>  4) Ability to quickly reconfigure the script for use on another server \ folder. <br>  Initial data: <br>  1) Network folder ‚ÄúExchange‚Äù on // server / obmen, which looks at D: \ obmen <br>  Decision: <br><a name="habracut"></a><br><br>  PowerShell allows you to work with the xml format using standard tools, so we will use this format to store the settings. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Listing of settings.xml file <br><pre><code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">settings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MainDir</span></span></span><span class="hljs-tag">&gt;</span></span>D:\obmen<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MainDir</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">OldDir</span></span></span><span class="hljs-tag">&gt;</span></span> D:\obmen \<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">OldDir</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NameOldDir</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NameOldDir</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ShareName</span></span></span><span class="hljs-tag">&gt;</span></span>Obmen<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ShareName</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AclDir</span></span></span><span class="hljs-tag">&gt;</span></span>D:\acl<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AclDir</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span>test_service_1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span>test_service_2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">settings</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  In the clearshare.ps1 script file, first of all we read the settings: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">xml</span></span>]$settings = Get-Content D:\ps_project\\settings.xml $mainfolder = $settings.settings.MainDir <span class="hljs-meta"><span class="hljs-meta">#    $oldfolder = $settings.settings.OldDir #   $services = $settings.settings.service #,    $ShareName = $settings.settings.sharename #  $NameOldDir = $settings.settings.NameOldDir #   $acldir = $settings.settings.AclDir #   acl</span></span></code> </pre><br><br>  To ensure the availability of files, we close all user sessions by disabling the share: <br><pre> <code class="cs hljs">$share = Get-WmiObject Win32_Share | <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> {$_.name -eq $ShareName} $share.delete()</code> </pre><br><br>  You may also need to disable services.  The list of services described in the settings file may increase .: <br><pre> <code class="cs hljs">stop-service -DisplayName $services</code> </pre><br><br>  Clear the Yesterday folder, write errors to the file: <br><pre> <code class="cs hljs">Remove-Item <span class="hljs-string"><span class="hljs-string">"$oldfolder\*"</span></span> -Recurse -Force <span class="hljs-number"><span class="hljs-number">2</span></span>&gt; <span class="hljs-string"><span class="hljs-string">"$mainfolder\remove_error_log.txt"</span></span></code> </pre><br><br>  We move today to yesterday, while excluding the ‚ÄúYesterday‚Äù folder itself: <br><pre> <code class="cs hljs">Get-ChildItem $mainfolder -Exclude $NameOldDir | Move-Item -destination $oldfolder <span class="hljs-number"><span class="hljs-number">2</span></span>&gt; <span class="hljs-string"><span class="hljs-string">"$mainfolder\move_error_log.txt"</span></span></code> </pre><br><br>  Create a user folder structure: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($foldname <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Get-ChildItem $oldfolder | <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> {$_.Attributes -eq <span class="hljs-string"><span class="hljs-string">'Directory'</span></span>}) { $a = $mainfolder + <span class="hljs-string"><span class="hljs-string">"\" + $foldname.name; New-Item -type directory -path $a }</span></span></code> </pre><br><br>  We include services by team <br><pre> <code class="cs hljs">start-service -DisplayName $services</code> </pre><br><br>  Turn on the ball <br><pre> <code class="cs hljs">$share = [wmiClass] <span class="hljs-string"><span class="hljs-string">'Win32_share'</span></span> $share.Create($mainfolder, $ShareName, <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-string"><span class="hljs-string">"1000"</span></span>)</code> </pre><br><br>  We assign READ rights for users and FullControl for admins to the ‚ÄúYesterday‚Äù folder through copies from the reference folder: <br><pre> <code class="cs hljs">$acl = Get-Acl -path $acldir Set-Acl -Path $oldfolder -AclObject $acl</code> </pre><br><br>  So, we got a script that will clear the temporary data of users every night, leaving the opportunity to collect data for forgetful people.  It also logs copy errors and has a configuration file to adapt to any shared folder. <br><br>  Naturally, the script must be added to the task scheduler at a time convenient to you.  (Thanks <a href="http://habrahabr.ru/users/ame/" class="user_link">ame</a> ) <br><br>  <b>UPD:</b> Improved the process of recreating the folder structure. </div><p>Source: <a href="https://habr.com/ru/post/186358/">https://habr.com/ru/post/186358/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../186346/index.html">The theoretical minimum for the mail administrator. Configuring mail on the Communigate Pro server</a></li>
<li><a href="../186348/index.html">Dota 2 with test mark has become available in Ubuntu</a></li>
<li><a href="../186350/index.html">GWT - we pry into the transmitted data</a></li>
<li><a href="../186352/index.html">Node.js as a proxy data server via websockets</a></li>
<li><a href="../186354/index.html">Economic efficiency and feasibility of the introduction of VDI</a></li>
<li><a href="../186360/index.html">IT systems support in the production area</a></li>
<li><a href="../186362/index.html">Bleeding debian / ubuntu servers for small</a></li>
<li><a href="../186366/index.html">Moto X: full customization - the key to hegemony?</a></li>
<li><a href="../186368/index.html">Pre-learning limited to Boltzmann machines for recognition of real images</a></li>
<li><a href="../186374/index.html">MT6589T and MT6589M devices appear on the Chinese market</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>