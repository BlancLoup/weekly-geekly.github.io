<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unit testing in Codeception</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A week ago I already wrote about Codeception and its use for testing PHP applications. After the last post several bugs have been fixed. Thanks for th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unit testing in Codeception</h1><div class="post__text post__text-html js-mediator-article">  A week ago <a href="http://habrahabr.ru/blogs/php/136477/">I already wrote about Codeception</a> and its use for testing PHP applications.  After the last post several bugs have been fixed.  Thanks for the bug reports.  If you have not tried Codeception, I advise you to look at the previous article and try it out for acceptance tests. <br><br>  Today I want to tell you how BDD-style unit testing is implemented in Codeception. <br><br>  I note that the module for testing units is still experimental.  Not in the sense of "unstable", but in the sense of "may and will be expanded to meet all the necessary needs." <br><a name="habracut"></a><br>  Before starting to talk about the BDD testing of units, I will answer the quite logical question that you naturally have: nafiga goat bayan?  That is, why do we need any pribludy to unit tests, if they already work fine in the same PHPUnit.  Why rewrite them in the scenario paradigm? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      All tests should be readable.  In particular, unit tests, where the test essentially describes the functionality of the method.  But he is overloaded with the preparation of the environment, the creation of stubs and mocks.  Many different calls are mixed in it and sometimes there are no comments at all.  And for a new person who breaks a test, it is difficult to understand what is being tested and how. <br><br>  Codeception offers an approach where each step describes the action to be performed. <br><br>  For example, like this: <br><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserCest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setNameAndSave</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CodeGuy $I)</span></span></span><span class="hljs-function"> </span></span>{ $I-&gt;wantToTest(<span class="hljs-string"><span class="hljs-string">'getter and setter of User model'</span></span>); $I-&gt;execute(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Model\User; $user-&gt;setName(<span class="hljs-string"><span class="hljs-string">'davert'</span></span>); $user-&gt;save(); }); $I-&gt;seeInDatabase(<span class="hljs-string"><span class="hljs-string">'users'</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'davert'</span></span>); } } <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre> <br><br>  And why is it necessary?  This is how the executable code is separated from the checks.  However, no one forbids the use of asserts inside the code block: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $I-&gt;wantToTest(<span class="hljs-string"><span class="hljs-string">'getter and setter of User model'</span></span>); $I-&gt;execute(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Model\User; $user-&gt;setName(<span class="hljs-string"><span class="hljs-string">'davert'</span></span>); assertEquals(<span class="hljs-string"><span class="hljs-string">'davert'</span></span>, $user-&gt;getName()); $user-&gt;save(); }); $I-&gt;seeInDatabase(<span class="hljs-string"><span class="hljs-string">'users'</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'davert'</span></span>);</code> </pre><br><br>  The more difficult the test becomes, the more it is required to maintain its readability. <br>  Codeception becomes interesting when you need to test business logic classes.  They usually do not exist in isolation, but depending on other classes, and the result of their implementation is sometimes not so easy to check as for the getter. <br><br>  Take this simple controller from an imaginary MVC framework. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbtractController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">show</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function"> </span></span>{ $user = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;db-&gt;find(<span class="hljs-string"><span class="hljs-string">'users'</span></span>,$id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$user) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;render404(<span class="hljs-string"><span class="hljs-string">'User not found'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;render(<span class="hljs-string"><span class="hljs-string">'show.html.php'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'user'</span></span> =&gt; $user)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br><br>  What he does, in principle, is understandable.  Shows the user profile page.  But testing it is difficult, because before testing, you need to isolate the controller from View and Model.  Here is how we do it in Codeception. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserControllerCest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $class = <span class="hljs-string"><span class="hljs-string">'UserController'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">show</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CodeGuy $I)</span></span></span><span class="hljs-function"> </span></span>{ $I-&gt;haveStub($controller = Stub::makeEmptyExcept(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;class, <span class="hljs-string"><span class="hljs-string">'show'</span></span>)) -&gt;haveStub($db = Stub::make(<span class="hljs-string"><span class="hljs-string">'DbConnector'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'find'</span></span> =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $id ? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User() : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ))) -&gt;setProperty($controller, <span class="hljs-string"><span class="hljs-string">'db'</span></span>, $db); $I-&gt;wantTo(<span class="hljs-string"><span class="hljs-string">'render profile page for valid user'</span></span>) -&gt;executeTestedMethodOn($controller, <span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt;seeResultEquals(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) -&gt;seeMethodInvoked($controller, <span class="hljs-string"><span class="hljs-string">'render'</span></span>); $I-&gt;expect(<span class="hljs-string"><span class="hljs-string">'it will render page 404 for unexistent user'</span></span>) -&gt;executeTestedMethodOn($controller, <span class="hljs-number"><span class="hljs-number">0</span></span>) -&gt;seeResultNotEquals(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) -&gt;seeMethodInvoked($controller, <span class="hljs-string"><span class="hljs-string">'render404'</span></span>,<span class="hljs-string"><span class="hljs-string">'User not found'</span></span>) -&gt;seeMethodNotInvoked($controller, <span class="hljs-string"><span class="hljs-string">'render'</span></span>); } }</code> </pre><br><br>  As the same test I wrote in PHPUnit can be viewed <a href="https://gist.github.com/1498755">here</a> .  It turned out to be 1.5 times longer, and the code, of course, is understandable, but if you are a PHPUnit guru. <br><br>  What is good in our code: it has a clear structure.  First we create the environment, then we perform the actions and check the results.  Please note, we check if the 'render' method was executed from the controller <strong>after</strong> we performed our 'show' method with parameter 1. Thus, we do not mix the definition of stubs with asserts.  All checks go after the execution of the tested code. <br><br>  About readability.  Let's try to creatively translate this code into the text: <br><br>  With this method I can render profile page for valid user <br><br>  If I execute this method <br>  I will see result equals: true <br>  I will see method invoked: $ controller, 'render' <br><br>  I expect it will render page 404 for unexistent user <br>  If I execute this method <br>  I will see result not equals: true <br>  I will see method invoked: $ controller, 'render404' <br>  I will see method not invoked: $ controller, 'render' <br><br>  Though take and write to the documentation.  Maybe soon the documentation generation will be added, but for now I just want to demonstrate how clearly and clearly the test code itself describes the code under test. <br><br>  Notice how stubs are created.  Any stub is done by one team.  For example: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//       save $user = Stub::make('User', array('save' =&gt; function () {})); //       $user = Stub::makeEmpty('User', array('name' =&gt; 'davert')); //       $user = Stub::constructEmpty('Template', array('show.html', 'html')); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br><br>  This is simpler than what PHPUnit offers.  Think of at least how many parameters mockBuilder requires and what they all mean.  But what is most interesting, the Stub class is just a wrapper over mockBuilder.  Notice, we create only stubs, i.e.  Wednesday  And of them, dynamically, with the same seeMethodInvoked command, we convert the stub into mock. <br><br>  More information in the <a href="http://codeception.com/docs/07-UnitTestsPractice">documentation</a> and in the <a href="http://codeception.com/docs/modules/Unit">Unit</a> module <br><br>  As I said at the beginning, this thing is experimental, which means it can be discussed.  But it was written not for ‚Äúspherical code in a vacuum‚Äù, but on the basis of its own real needs.  However, I advise you to try for your project.  If some moments are poorly covered in the documentation - ask. <br><br>  PS An <a href="http://codeception.com/01-27-2012/bdd-with-zend-framework.html">article</a> about Codeception and Zend Framework integration has appeared on the site <a href="http://codeception.com/01-27-2012/bdd-with-zend-framework.html">.</a> </div><p>Source: <a href="https://habr.com/ru/post/137097/">https://habr.com/ru/post/137097/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../137088/index.html">Beta-test Bitcasa do it yourself</a></li>
<li><a href="../137089/index.html">Ordinary (or unusual) Python transliteration</a></li>
<li><a href="../137092/index.html">1/998001</a></li>
<li><a href="../137093/index.html">Bitcasa - unlimited file storage for $ 10 ... for now free</a></li>
<li><a href="../137095/index.html">The jump in attendance of file hosting sites</a></li>
<li><a href="../137098/index.html">Songsterr - now on Android</a></li>
<li><a href="../137099/index.html">First look at the Sony Xperia S: the smartphone of our time</a></li>
<li><a href="../137100/index.html">IdeaPad Z570 - the perfect price-performance ratio</a></li>
<li><a href="../137101/index.html">Jsfl selection</a></li>
<li><a href="../137105/index.html">Twitter introduces censorship for certain countries</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>