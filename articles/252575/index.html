<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>WebGL and asyncio multiplayer online shooter, part two</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I tried to describe the creation of a browser-based 3D shooter, starting from importing cute tank models to the scene and ending with ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>WebGL and asyncio multiplayer online shooter, part two</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/7f7/b31/ed7/7f7b31ed7b3e41099718749ed5b7ccd5.jpg"><br>  In this article I tried to describe the creation of a browser-based <code>3D</code> shooter, starting from importing cute tank models to the scene and ending with synchronizing players and bots with each other using <code>websocket</code> and <code>asyncio</code> and balancing them in rooms. <br><br>  <a href="https://habr.com/ru/post/252575/">Introduction</a> <br>  <a href="https://habr.com/ru/post/252575/">1. Structure of the game</a> <br>  <a href="https://habr.com/ru/post/252575/">2. Import models and blender</a> <br>  <a href="https://habr.com/ru/post/252575/">3. Uploading models in the game with babylon.js and the models themselves</a> <br>  <a href="https://habr.com/ru/post/252575/">4. Movements, minimap and game sounds in babylon.js</a> <br>  <a href="https://habr.com/ru/post/252575/">5. Web Sockets and Game Sync</a> <br>  <a href="https://habr.com/ru/post/252575/">6. Players and their coordination</a> <br>  <a href="https://habr.com/ru/post/252575/">7. Balancing players by room and object python</a> <br>  <a href="https://habr.com/ru/post/252575/">8. Asyncio and bot behavior generation</a> <br>  <a href="https://habr.com/ru/post/252575/">9. Nginx and socket proxying</a> <br>  <a href="https://habr.com/ru/post/252575/">10. Asynchronous caching through memcache</a> <br>  <a href="https://habr.com/ru/post/252575/">11. Epilogue and Roadmap</a> <br><br>  <code>Python3</code> who is interested in the topic of asynchronous applications in <code>Python3</code> , <code>WebGL</code> and just games, please under the cat. <br><a name="habracut"></a><br><h3><a name="0"></a>  <font color="orange">Introduction</font> </h3><br>  The article itself was conceived as a continuation of the topic of writing asynchronous applications using <a href="http">aiohttp</a> and <code>asyncio</code> , and if the <a href="http://habrahabr.ru/post/242541/">first part</a> was devoted to how best to make a modular structure like <code>django</code> , on top of <code>aiohttp( asyncio )</code> , then the second one already wanted to do something more creative. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Naturally, it seemed to me interesting to make a <code>3D</code> toy, and where else if not in games, you might need asynchronous programming. <br><br>  We will have a toy without registration, with the ability to fall on each other, bots, rooms, a simple chat, and a simple landscape.  As a game model, we take a couple of tanks, as the most simple and familiar, and, at the same time, demonstrative game models.  Well, in the framework of the framework, recall the caching through <code>memcached</code> . <br><br>  For clarity, some processes will be represented by pictures that remotely resemble infographics, because network programming does not always look straightforward and more convenient all the same when the arrows show what is transmitted to whom and what is caused. <br>  Code samples, both in infographics and in the usual format, will often be greatly simplified, for a better understanding of the general scheme of work.  Moreover, the full code with the latest fixes can be viewed on <a href="https://github.com/alikzao/tao1">github</a> . <br><br>  But it should be understood that this is not a full-fledged game - in the sense that he wrote <code>git clone</code> and went to an ATM.  Rather, it is an attempt to make a gaming framework, a demo of <code>asyncio</code> and <code>webgl</code> in one bottle.  There is no shop window, ratings, thoroughly tested security, etc., but, on the other hand, it seems to me that for an <code>open sourse</code> project, developed occasionally, in my spare time, it turned out to be quite normal. <br><br><h3><a name="2"></a>  <font color="orange">2 Importing models and blender</font> </h3><br>  Naturally, we need <code>3D</code> models of characters for a toy, we need models to simulate a landscape, buildings, etc. <br>  Characters can be people, tanks, airplanes.  There are two options - to draw a model, and import already finished.  The easiest way is to find ready-made models on one of the specialized sites, for example, <a href="http://tf3dm.com/">here</a> or <a href="http://www.blendswap.com/blends">here</a> .  Who is interested in the process of drawing tanks and other models, on YouTube there is a lot of video, on Habr√© there are materials on this <a href="http://habrahabr.ru/post/273543/">subject</a> . <br><br>  Let us dwell on the import process itself.  Of the formats imported into <code>blender</code> , the most common are <code>.die .obj .3ds</code> . <br><br>  Import / export has a number of nuances.  For example, if we import <code>.3ds</code> , then, as a rule, the model is imported without textures, but with materials already created.  In this case, we just need to load each material from the texture disk.  For <code>.obj</code> , as a rule, besides textures, there must be a <code>.mtl</code> file, if it is present, then the probability of problems is usually less. <br><br>  Sometimes after exporting the model to the scene, it may turn out that the <code>chrome</code> crashes, warning that he has problems with displaying the <code>webgl</code> .  In this case, you should try to remove all unnecessary things in the blender, for example, if there are collisions, animations, etc. <br><br>  Then one of the most important moments.  For the models that we are going to move around the map, <br>  we need to glue all the objects of which the model consists.  Otherwise, we will not be able to move them, visually it will look like that instead of a tank, only his machine gun will go, and if you try to set the required coordinates to a tree, the location on the map will change only the stump of the tree, and everything else will remain in the center of the map. <br><br>  To solve this problem, there are two ways: <br>  1) Combine all the details of the model and make it a single object.  This method is a little faster, but it only works if we have one texture in the form of a <code>UV</code> sweep.  To do this, you can select all objects through the outliner with cipher, they will be highlighted with a characteristic orange color and in the <code>object</code> menu select the <code>join</code> item. <br><br><img src="https://habrastorage.org/files/f64/0b6/366/f640b63667a146019cd9dc76b21fac64.jpg"><br>  2) The next option is to link all the details on the principle of Parent-Child.  In this case, there will be no problems with textures, even if we have our own texture for every detail.  To do this, right-click to select the parent object and the child one by one, press <code>ctrl+P</code> to select <code>object</code> in the menu.  As a result, we should see in the autliner that all the objects that make up our model belong to the same parent. <br><br><img src="https://habrastorage.org/files/b7b/b83/01d/b7bb8301db2c407f96a020b42d9bc408.jpg"><br>  And yet, I would like to insert such a remark that quite often some kind of model may, for some unknown reason, not be imported into a blender or imported as some sort of junk.  And very often it happens that some textures that come with the model do not want to be applied.  In such a case, nothing can be done and we must go to other options. <br><br><h3><a name="3"></a>  <font color="orange">3. Uploading models in the game with babylon.js and the models themselves</font> </h3><br>  The loading of models itself looks quite simple, we indicate the location of the mesh on the disk: <br><br><pre> <code class="javascript hljs">loader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BABYLON.AssetsManager(scene); mesh = loader.addMeshTask(<span class="hljs-string"><span class="hljs-string">'enemy1'</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"/static/game/t3/"</span></span>, <span class="hljs-string"><span class="hljs-string">"t.babylon"</span></span>);</code> </pre> <br>  After this, we can check in any place that our model is already loaded and further set its position and convert, if necessary. <br><br><pre> <code class="javascript hljs">mesh.onSuccess = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">task</span></span></span><span class="hljs-function">) </span></span>{ task.loadedMeshes[<span class="hljs-number"><span class="hljs-number">0</span></span>].position = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BABYLON.Vector3(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>); };</code> </pre> <br>  One of the most common operations in our case is the cloning of objects, for example, there are trees, so as not to load each tree separately, you can simply load it once and clone around the scene with different coordinates: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> palm = loader.addMeshTask(<span class="hljs-string"><span class="hljs-string">'palm'</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"/static/game/g6/"</span></span>, <span class="hljs-string"><span class="hljs-string">"untitled.babylon"</span></span>); palm.onSuccess = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">task</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> p = task.loadedMeshes[<span class="hljs-number"><span class="hljs-number">0</span></span>]; p.position = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BABYLON.Vector3(<span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">-2</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> p1 = p.clone(<span class="hljs-string"><span class="hljs-string">'p1'</span></span>); p1.position = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BABYLON.Vector3(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">-2</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> p2 = p.clone(<span class="hljs-string"><span class="hljs-string">'p2'</span></span>); p2.position = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BABYLON.Vector3(<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">-2</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>); };</code> </pre> <br>  Cloning also plays an important role in the <code>AssetsManager</code> case.  He draws a simple screensaver until the main part of the scene is loaded, and makes sure that everything we <code>loader.onFinish</code> into <code>loader.onFinish</code> . <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> createScene = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ . . . } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scene = createScene(); loader.onFinish = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tasks</span></span></span><span class="hljs-function">) </span></span>{ engine.runRenderLoop(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ scene.render(); }); };</code> </pre> <br><img src="https://habrastorage.org/files/b9e/c3a/e8d/b9ec3ae8daa54b29a27cf55334c8c551.jpg"><br>  We must avoid further loading of anything during the game, for various reasons.  Therefore, all characters are loaded at initialization, and in the processing of sockets and in the class responsible for the appearance and behavior of players, we clone the equipment we need, etc.  The scheme looks something like this: <br><br><img src="https://habrastorage.org/files/253/14d/39a/25314d39a8d74d9da9948310eacf1c71.jpg"><br>  Further, I would like to write a little about the models themselves, and even though this version of the map is more an experiment than a ready-made solution, it doesn‚Äôt hurt to understand the overall picture. <br><br>  Characters, in this case, we have two types of tanks, T-90 and Abrams.  Since we don‚Äôt have the game logic of victories and defeats now, and in the case of the framework, it is implied that we need to invent all this in each individual case.  Therefore, now there is no choice and the first person always plays Abrams, and the bot and all other players are visible as T-90. <br><br>  On the map itself, we see some relief, it is created very simply using the <code>babylon.js</code> called <a href="http://doc.babylonjs.com/tutorials/14._Height_Map">heightMap</a> . To do this, you need to apply a black-and-white picture on the soil texture depending on where the light surface is and where the dark and mountains form. hills, some of the characteristics can be specified in the parameters, the more blurred the transition between dark and white, the gentler the slope. <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ground = BABYLON.Mesh.CreateGroundFromHeightMap(<span class="hljs-string"><span class="hljs-string">"ground"</span></span>, <span class="hljs-string"><span class="hljs-string">"/static/HMap.png"</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-number"><span class="hljs-number">70</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, scene, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> groundMaterial = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BABYLON.StandardMaterial(<span class="hljs-string"><span class="hljs-string">"ground"</span></span>, scene); groundMaterial.diffuseTexture = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BABYLON.Texture(<span class="hljs-string"><span class="hljs-string">"/static/ground.jpg"</span></span>, scene); ground.material = groundMaterial;</code> </pre> <br><img src="https://habrastorage.org/files/969/445/4b1/9694454b1a594f378cd1b2672a06221a.jpg"><br>  Next we have a small entourage in the form of a house, a water tower near it, several trees and a little grass. <br>  The grass came out with us as low poly as possible, just a plane with a texture on it.  And this plane is tilted in different places.  In general, the lower the polygonal models, the better in terms of performance, but for obvious reasons, entertainment will suffer. <br>  Of course, you can make the choice in the settings "graphics quality", but not in our case. <br>  Unlike grass, banana palm has quite a few peaks, so it was decided to leave only a couple of pieces on the map. <br>  The more vertices on the map, the lower can be <code>FPS</code> and so on. <br><br><img src="https://habrastorage.org/files/110/d5c/919/110d5c91960940c4b7244c89553cb439.jpg"><br>  The house stands a little apart, and it was decided to cover it all the same with a transparent cube with collisions. <br><br>  And the last thing we have left is three multi-colored cubes, they are not synchronized for everyone and represent simple targets.  When hit in each, it lights up and disappears. <br><br><img src="https://habrastorage.org/files/c2a/a72/6ed/c2aa726ed49c447cafc9694065382a6c.jpg"><br><h3><a name="4"></a>  <font color="orange">4. Movements, minimap and game sounds in babylon.js</font> </h3><br>  Speaking of movements, it‚Äôs mostly about the first person, since the movements of other players and bots are always just a change of position, which is most often transmitted using sockets from the server, which will be described below. <br><br>  Motion in itself is simply control of the camera and the visible part of the player.  For example, the player turns to the right, which means we must turn the camera to the right as to where we are looking, or turn the stage to the desired degree.  Also, a model depicting, for example, some means of defeating opponents, should also turn. <br>  Basically, in games made by <code>babylon.js</code> for the movement from the first person, there are two cameras: <br><br><ul><li>  <code>FreeCamera</code> - as a rule, is the parent of the character and the character just follows it, it is very convenient to use for the turn of technology, for people and for all flying, <code>FreeCamera</code> has the ability to adjust the inertia and speed of movement, which is also very important. </li><li>  <code>FollowCamera</code> - on the contrary, it is a camera that follows some object; it is more convenient to use it for cases when the control from the mouse and keyboard is different.  That is, the review does not depend on the direction of movement. </li></ul><br>  Examples: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//FollowCamera var camera = new BABYLON.FollowCamera("camera1", new BABYLON.Vector3(0, 2, 0), scene); camera.target = mesh; ``````javascript //FreeCamera var camera = new BABYLON.FreeCamera("camera1", new BABYLON.Vector3( 0, 2, 0), scene); mesh.parent = camera;</span></span></code> </pre> <br>  During the movement there should be some sounds, during the hit, during the shot, during the movement, etc.  <code>babylon.js</code> has a good sound management <a href="http://doc.babylonjs.com/tutorials/16._Playing_sounds_and_music">API</a> .  The topic of sound management is quite extensive, so we‚Äôll look at just a few small examples. <br>  Initialization example: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> music = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BABYLON.Sound(<span class="hljs-string"><span class="hljs-string">"Music"</span></span>, <span class="hljs-string"><span class="hljs-string">"music.wav"</span></span>, scene, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, { <span class="hljs-attr"><span class="hljs-attr">playbackRate</span></span>:<span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-comment"><span class="hljs-comment">//  . volume: 0.1, //  . loop: true, //      . autoplay: true //      . });</span></span></code> </pre> <br>  An example of the sound of a shot - when clicking, we check that the interlock is removed and reproduce the sound of a single shot. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> gunS = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BABYLON.Sound(<span class="hljs-string"><span class="hljs-string">"gunshot"</span></span>, <span class="hljs-string"><span class="hljs-string">"static/gun.wav"</span></span>, scene); <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">"mousedown"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!lock &amp;&amp; e.button === <span class="hljs-number"><span class="hljs-number">0</span></span>) gunS.play(); });</code> </pre> <br>  The sound of the movement of technology hang on the event of pressing the arrows forward and backward and, accordingly, the start of playback.  On the key release event, we stop the playback. <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ms = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BABYLON.Sound(<span class="hljs-string"><span class="hljs-string">"mss"</span></span>, <span class="hljs-string"><span class="hljs-string">"static/move.mp3"</span></span>, scene, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, { <span class="hljs-attr"><span class="hljs-attr">loop</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">autoplay</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }); <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (e.keyCode) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">83</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">87</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ms.isPlaying) ms.play(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }); <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (e.keyCode) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">83</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">87</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ms.isPlaying) ms.pause(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } });</code> </pre> <br><h4>  Minimap </h4><br>  Any shooter should have a minimap on which you can see either only your players or all at once, you can see the buildings and the general landscape, in our case, if you look closely, you can see the shells.  There are several ways to do this in <code>babylon.js</code> .  Probably the easiest is to create another camera, place it on top of the map and place the view from this camera in the corner we need. <br><br><img src="https://habrastorage.org/files/311/443/419/3114434197ec483b9d3814dc86003702.jpg"><br>  In our case, we take <code>freeCamera</code> and tell her that it should be placed on top: <br><br><pre> <code class="javascript hljs">camera2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BABYLON.FreeCamera(<span class="hljs-string"><span class="hljs-string">"minimap"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BABYLON.Vector3(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">170</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>), scene);</code> </pre> <br>  The higher the <code>Y</code> coordinate, the fuller the overview, but the finer the details on the map. <br>  Further we speak to the camera how we will place the image from it on the screen. <br><br><pre> <code class="javascript hljs">camera2.viewport = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BABYLON.Viewport(x, y, width, height);</code> </pre> <br>  And the last thing - you need to add both cameras to the scene (when the camera alone does not have to do this): <br><br><pre> <code class="javascript hljs">scene.activeCameras.push(camera); scene.activeCameras.push(camera2);</code> </pre> <br><h3><a name="5"></a>  <font color="orange">5. Web Sockets and Game Sync</font> </h3><br>  The entire basic structure of the game is built on the <code>websoket</code> , the player performs an action, mouse rotation or keystroke, an event is hung up on this movement, in which the coordinates of the player‚Äôs location are transmitted to the server, and the server transmits them to all game participants who are in this game. the room. <br><br>  Initially, since we use <code>FreeCamera</code> , it is a parent object, therefore, we use its coordinates.  For example: <br><br><ul><li>  <code>camera.cameraRotation</code> - contains the <code>X</code> and <code>Y</code> coordinates of the rotation along the axes. </li><li>  <code>camera.position</code> - contains <code>X</code> , <code>Y</code> and <code>Z</code> coordinates of the mesh location on the map. </li></ul><br>  In the picture below, we see an approximate process from the beginning of opening a connection to the server and creating a new player, before exchanging messages when reacting to some user actions. <br><br><br><img src="https://habrastorage.org/files/bf2/b47/32f/bf2b4732fdc546f99af9e996521873c9.jpg"><br><h3><a name="6"></a>  <font color="orange">6. Server side device</font> </h3><br>  Above, we saw a brief scheme, as it were, very briefly, but now let us dwell in more detail on how the server part works.  In the function of the socket handler, after receiving the next message, we watch its <code>action</code> , then what action did the player perform and in accordance with this call the desired function, event handler: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">game_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span> . . . <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> msg <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ws: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> msg.tp == MsgType.text: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> msg.data == <span class="hljs-string"><span class="hljs-string">'close'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> ws.close() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: e = json.loads( msg.data ) action = e[<span class="hljs-string"><span class="hljs-string">'e'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> action <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> handlers: handler = handlers[action] handler(ws, e) . . .</code> </pre> <br>  For example, if <code>move</code> came to us, it means that the player has moved to some coordinates.  In the handler function of this action, we simply assign these coordinates to the <code>Player</code> class, it processes them and returns them, and we transmit them to all the other players in the room at the moment. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">h_move</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(me, e)</span></span></span><span class="hljs-function">:</span></span> me.player.set_pos(e[<span class="hljs-string"><span class="hljs-string">'x'</span></span>], e[<span class="hljs-string"><span class="hljs-string">'y'</span></span>], e[<span class="hljs-string"><span class="hljs-string">'z'</span></span>]) mess = dict(e=<span class="hljs-string"><span class="hljs-string">"move"</span></span>, id=me.player.id, **me.player.pos_as_dict) me.player.room.send_all(mess, except_=(me.player,))</code> </pre> <br>  Of course, all that the <code>Player</code> class with coordinates is doing now is simply passing them to the bot so that it will be guided by them.  But ideally, he should check the entire map with the coordinates, and if the player hit the obstacle, he, for example, to avoid cheating, should not let him seep through the wall, if the script is changed on the client. <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Player</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(list)</span></span></span><span class="hljs-class">:</span></span> . . . <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, client, room, x=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, y=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, z=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, a=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, b=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> list.__init__(self, (x, y, z, a, b)) self._client = client self._room = room Player.last_id += <span class="hljs-number"><span class="hljs-number">1</span></span> self._id = Player.last_id room.add_player(self) . . . <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_rot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, a, b)</span></span></span><span class="hljs-function">:</span></span> self[<span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">5</span></span>] = a, b <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self[<span class="hljs-number"><span class="hljs-number">0</span></span>] . . . <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, newX)</span></span></span><span class="hljs-function">:</span></span> self[<span class="hljs-number"><span class="hljs-number">0</span></span>] = newX . . . x = property(getX, setX) . . . @property <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pos_as_dict</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dict(zip((<span class="hljs-string"><span class="hljs-string">'x'</span></span>, <span class="hljs-string"><span class="hljs-string">'y'</span></span>, <span class="hljs-string"><span class="hljs-string">'z'</span></span>), self.pos))</code> </pre><br>  In the <code>Player</code> class we use <code>property</code> , for more convenient work with coordinates.  Who cares, Habr√© was the best <a href="http://habrahabr.ru/post/137415/">material</a> on this topic. <br><br><h3><a name="7"></a>  <font color="orange">7. Balancing players by room</font> </h3><br>  An important part of any game is to separate players into different clans, rooms, planets, countries, etc.  Just because otherwise they will not fit on one card.  In our case, the system is still quite simple - if there are more players in one room than is set in the settings (4 by default with the bot), then we create a new room and send the rest of the players there, and so on. <br><br>  At the moment, all the information about which player in which room, etc., is stored in memory, since, since we do not yet have showcases and ratings, there is no point in using some kind of base. <br><br>  The number of the room is assigned to the player when he enters the game from the starting page, which is located on the route <code>/pregame</code> .  When you press a button, <code>ajax</code> triggered, which, if successful, redirects the player to the desired room. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data.result == <span class="hljs-string"><span class="hljs-string">'ok'</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.location = <span class="hljs-string"><span class="hljs-string">'/game#'</span></span>+data.room;</code> </pre> <br>  On the server side, we simply go through the <code>rooms</code> dictionary, which contains a list of all the rooms and players located in them, and if the number of players does not exceed the specified value, then we return the room <code>id</code> client.  And if the number of players is more, then we create a new room. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check_room</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span> found = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _id, room <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> rooms.items(): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(room.players) &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>: found = _id <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> found: _id = uuid4().hex[:<span class="hljs-number"><span class="hljs-number">3</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> _id <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> rooms: found = _id</code> </pre> <br>  <code>Room</code> class is responsible for working with rooms.  His general scheme of work looks like this: <br><br><img src="https://habrastorage.org/files/1e3/0db/e11/1e30dbe1100e4218993dff627285a975.jpg"><br>  Here we see that it interacts with the <code>Player</code> class, perhaps the whole scheme does not look quite linear, but in the end it will make it quite convenient to write such chains: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#        me.player.room.send_all( {"e" : "move", . . . }) #     me.player.room.players #     me.player.room.add_player(self) #     me.player.room.remove_player( me.player )</span></span></code> </pre> <br>  I would like to talk a little about <code>me.player</code> , because for some of my colleagues this caused questions, <code>me</code> is a socket that is passed as a parameter in functions that serve events: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">h_new</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(me, e)</span></span></span><span class="hljs-function">:</span></span> me.player = Player(me, Room.get( room_id ), x, z)</code> </pre> <br>  Here, in fact, as the translator would say, is a play on words.  Since we know that everything in python is an object. <br>  This is what will happen more clearly: <br><br><pre> <code class="python hljs">player = Player( Room.get(room_id), x, z) player.me = me me.player = player</code> </pre> <br>  And we get two links, the <code>player</code> module and the <code>.player</code> object of <code>me</code> , both are equal and refer to the same object in memory that will exist as long as there is at least one link. <br><br>  This can be seen in an even simpler example: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>a = {<span class="hljs-number"><span class="hljs-number">1</span></span>} &gt;&gt;&gt; b = a &gt;&gt;&gt; b.add(<span class="hljs-number"><span class="hljs-number">2</span></span>) &gt;&gt;&gt; b {<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>} &gt;&gt;&gt; a {<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>}</code> </pre> <br>  In this example, <code>b</code> and <code>a</code> are simply references to one common value. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>a.add(<span class="hljs-number"><span class="hljs-number">3</span></span>) &gt;&gt;&gt; a {<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>} &gt;&gt;&gt; b {<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>}</code> </pre> <br>  We look further: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> ... &gt;&gt;&gt; a = A() &gt;&gt;&gt; a.player = b &gt;&gt;&gt; a.player {<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>} &gt;&gt;&gt; b {<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>} &gt;&gt;&gt; a.__dict__ {<span class="hljs-string"><span class="hljs-string">'player'</span></span>: {<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>}}</code> </pre> <br>  The properties of objects are simply syntactic sugar.  In this case, they are simply saved to the <code>__dict__</code> dictionary <code>__dict__</code> <br><br>  As a result, we have now killed one of our links <code>a</code> , but instead we created another that belongs to the newly created object, and in fact lies in the <code>__dict__</code> dictionary of this object. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>a &lt;__main__.A object at <span class="hljs-number"><span class="hljs-number">0x7f3040db91d0</span></span>&gt;</code> </pre> <br><h3><a name="8"></a>  <font color="orange">8. Asyncio and bot behavior generation</font> </h3><br>  In any normal game there must be at least one bot, and our game is no exception.  Of course, so far all that our bot can do is to move in concentric circles, gradually approaching the coordinates where the player is located.  If a new player has entered, the bot switches its attention to it. <br>  Lines that send a message to all players in the room about the coordinates along which the bot moves. <br><br><pre> <code class="python hljs">mess = dict(e=<span class="hljs-string"><span class="hljs-string">"move"</span></span>, bot=<span class="hljs-number"><span class="hljs-number">1</span></span>, id=self.id, **self.pos_as_dict) self.room.send_all(mess, except_=(self,))</code> </pre> <br>             : <br><br><img src="https://habrastorage.org/files/16a/5df/453/16a5df453e184070945833cd7176c2b9.jpg"><br>   <code>Room</code>   <code>__init__</code>    <code>Bot</code> .    <code>def __init__</code>    <code>Bot</code>   <code>asyncio.async(self.update())</code>  ,      . <br>  ,  <code>await</code>    ,   -.      ,   <code>class</code>    ,   ,   .  ,  <code>await</code>  ,       <code>.__next__()</code> .    ‚Äî <code>next</code>    <code>async</code> ‚Äî   . <br>  ,  100          ,        . <br><br>        : <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( name )</span></span></span><span class="hljs-function">:</span></span> ctr = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">2</span></span>) ctr += <span class="hljs-number"><span class="hljs-number">1</span></span> print(<span class="hljs-string"><span class="hljs-string">"Task {}: test({})"</span></span>.format( ctr, name )) asyncio.ensure_future( test(<span class="hljs-string"><span class="hljs-string">"A"</span></span>) ) asyncio.ensure_future( test(<span class="hljs-string"><span class="hljs-string">"B"</span></span>) ) asyncio.ensure_future( test(<span class="hljs-string"><span class="hljs-string">"C"</span></span>) ) loop = asyncio.get_event_loop() loop.run_forever( )</code> </pre> <br>  ,     <code>asyncio.ensure_future</code> ,      ,   <code>asyncio.sleep(2)</code>   ).      ,           ,  , ,  ,    , ,  .         ,   ,   . <br><br><h3><a name="9"></a> <font color="orange">9. Nginx   </font> </h3><br>          ‚Äî    <code>Nginx</code>      ,        <code>websocket</code>   <code>http</code> . ,    ,    : <br><br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> aio.dev; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://127.0.0.1:8080; } }</code> </pre> <br>      ,        ‚Äî            ,          <code>5.5.5.10</code>    <code>loalhost</code> . <br>     : <br><br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> aio.dev; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://5.5.0.10:8080; } }</code> </pre> <br>    ,       <code>nginx</code>  ,     <code>proxy_pass</code>   <code>http://127.0.0.1:8080</code> <br>    <code>Nginx</code> -a,    ,  : <br><br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> aio.dev; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://127.0.0.1:8080; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /ws { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://127.0.0.1:8080; <span class="hljs-attribute"><span class="hljs-attribute">proxy_http_version</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Upgrade <span class="hljs-variable"><span class="hljs-variable">$http_upgrade</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Connection <span class="hljs-string"><span class="hljs-string">"upgrade"</span></span>; } }</code> </pre> <br>         80 <code>var uri = "ws://aio.dev:80/ws"</code> ,   <code>Nginx</code>      80 ,      <code>listen</code> . <br>         <code>Nginx</code> -,      <code>websoket</code> -,  <code>http</code> . <br><br><h3><a name="10"></a> <font color="orange">10.  .</font> </h3><br> ,         ,         . <br><br>          <code>memcached</code>    <code>async def</code> .   -         ,  ‚Äî ,  ,  ..,        ,    .  <a href="https://github.com/aio-libs/aiomcache"> </a>  memcached    <a href="https://habrahabr.ru/users/svetlov/" class="user_link">svetlov</a> ,        . <br><br>                , ,   <a href="https://beaker.readthedocs.org/en/latest/caching.html">beaker</a> .          ,  ,      memcached. <br><br>       <code>memcached</code>    <code>pickle</code> .     ‚Äî     <code>aiohttp</code> ,      <code>CIMultiDict</code> ,        ,       <code>Cython</code>  <code>aiohttp</code> . <br><br><pre> <code class="python hljs"> dct = CIMultiDict() print( dct ) &lt;CIMultiDict {}&gt; dct = MultiDict({<span class="hljs-string"><span class="hljs-string">'1'</span></span>:[<span class="hljs-string"><span class="hljs-string">'www'</span></span>, <span class="hljs-number"><span class="hljs-number">333</span></span>]}) print( dct ) &lt;MultiDict {<span class="hljs-string"><span class="hljs-string">'1'</span></span>: [<span class="hljs-string"><span class="hljs-string">'www'</span></span>, <span class="hljs-number"><span class="hljs-number">333</span></span>]}&gt; dct = MultiDict([(<span class="hljs-string"><span class="hljs-string">'a'</span></span>, <span class="hljs-string"><span class="hljs-string">'b'</span></span>), (<span class="hljs-string"><span class="hljs-string">'a'</span></span>, <span class="hljs-string"><span class="hljs-string">'c'</span></span>)]) print( dct ) &lt;MultiDict {<span class="hljs-string"><span class="hljs-string">'a'</span></span>: <span class="hljs-string"><span class="hljs-string">'b'</span></span>, <span class="hljs-string"><span class="hljs-string">'a'</span></span>: <span class="hljs-string"><span class="hljs-string">'c'</span></span>}&gt; dct = dict([(<span class="hljs-string"><span class="hljs-string">'a'</span></span>, <span class="hljs-string"><span class="hljs-string">'b'</span></span>), (<span class="hljs-string"><span class="hljs-string">'a'</span></span>, <span class="hljs-string"><span class="hljs-string">'c'</span></span>)]) print( dct ) {<span class="hljs-string"><span class="hljs-string">'a'</span></span>: <span class="hljs-string"><span class="hljs-string">'c'</span></span>}</code> </pre> <br>   ,    ,     <code>pickle</code> .       ,  ,    <code>CIMultiDict</code>    <code>pickle</code> . <br><br><pre> <code class="python hljs">d = MultiDict([(<span class="hljs-string"><span class="hljs-string">'a'</span></span>, <span class="hljs-string"><span class="hljs-string">'b'</span></span>), (<span class="hljs-string"><span class="hljs-string">'a'</span></span>, <span class="hljs-string"><span class="hljs-string">'c'</span></span>)]) prepared = [(k, v) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k, v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> d.items()] saved = pickle.dumps(prepared) restored = pickle.loads(saved) refined = MultiDict( restored )</code> </pre> <br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name, expire=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decorator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(func)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wrapper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request=None, **kwargs)</span></span></span><span class="hljs-function">:</span></span> args = [r <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [request] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(r, aiohttp.web_reqrep.Request)] key = cache_key(name, kwargs) mc = request.app.mc value = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> mc.get(key) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> value <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: value = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> func(*args, **kwargs) v_h = {} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(value, web.Response): v_h = value._headers value._headers = [(k, v) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k, v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> value._headers.items()] <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> mc.set(key, pickle.dumps(value, protocol=pickle.HIGHEST_PROTOCOL), exptime=expire) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(value, web.Response): value._headers = v_h <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: value = pickle.loads(value) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(value, web.Response): value._headers = CIMultiDict(value._headers) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> wrapper <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> decorator</code> </pre> <br></div></div><br>    ,           . <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> core.union <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cache @cache(<span class="hljs-string"><span class="hljs-string">'list_cached'</span></span>, expire=<span class="hljs-number"><span class="hljs-number">10</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">list_tags</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> templ(<span class="hljs-string"><span class="hljs-string">'list_tags'</span></span>, request, {})</code> </pre> <br><h3><a name="11"></a>  <font color="orange">Afterword</font> </h3><br>          , ,   <code>WebGL</code>  <code>asyncio</code>   .   ,            .        ,             ,        . <br><br>       <font color="orange">Star Wars</font> ,        ,   . <br>         ,   , ,    ,      . <br><br>   ,  , ,             ,  ,    . <br><br><h5> <font color="green">Ping</font> </h5><br>            ,   ..   .    ,     ,      .         . <br><br><h5> <font color="green"></font> </h5><br> ,                    ,   ,        ,         . ,    ,     . <br><br><h4> Roadmap ‚Äî  </h4><br> Client: <br><br><br><ul><li>   ,   . </li><li>   ‚Äî    ,    </li><li>     </li><li>        / </li><li>          like Urban Terror </li></ul><br> Server: <br><br><br><ul><li>    </li><li>    </li><li>    ( ,   ,     ..) </li><li>     </li></ul><br><h4> Roadmap ‚Äî    </h4><br><ul><li>  CMS </li><li>     ( ERP) </li><li>  Report Designer </li><li> Web   MongoDB </li><li>   - </li></ul><br> <i> -  ,      .          .</i> <br><br>  <a href="http://habrahabr.ru/post/242541/">First part</a> <br> <a href="http://habrahabr.ru/post/246259/">   babylon.js     three.js</a> <br>   <a href="https://github.com/alikzao/tao1">github</a> <br> <a href="http://tao1.readthedocs.org/">  readthedocs</a> <br> <a href="http://tf3dm.com/">          3D </a> <br> <a href="http://www.blendswap.com/blends">   3D   Blender</a> <br> <a href="http://www.babylonjs-playground.com/"></a> <br> <a href="http://doc.babylonjs.com/tutorials/16._Playing_sounds_and_music">    babylon.js</a> <br> <a href="http://www.babylonjs-playground.com/">  </a> <br> <a href="https://docs.python.org/3/library/asyncio-task.html">ello world  asynio</a> <br> <a href="https://docs.python.org/3/library/asyncio-task.html">Sleep</a> <br> <a href="https://docs.python.org/3/library/asyncio-task.html">  </a> <br> <a href="https://docs.python.org/3/library/asyncio-eventloop.html"> </a> <br> <a href="https://www.python.org/dev/peps/pep-0492/">pep-0492</a> <br> <a href="http://asvetlov.blogspot.com/"></a> <a href="https://habrahabr.ru/users/svetlov/" class="user_link">svetlov</a>  aiohttp <br> <a href="https://github.com/aio-libs/aiomcache">  memcached</a> <br> <a href="http://doc.babylonjs.com/tutorials">   babylon.js</a> <br> <a href="http/tree/master/docs">  aiohttp  github</a> <br> <a href="http.readthedocs.org/">  aiohttp  readthedocs</a> <br> <a href="https://docs.python.org/3/whatsnew/3.3.html">  yield from</a> <br> <a href="https://github.com/aio-libs">aio-libs ‚Äî  </a> <br> <a href="http://asyncio.org/">    </a> <br><br>    : <br> <a href="http://www.dabeaz.com/generators/Generators.pdf">http://www.dabeaz.com/generators/Generators.pdf</a> <br> <a href="http://www.dabeaz.com/coroutines/Coroutines.pdf">http://www.dabeaz.com/coroutines/Coroutines.pdf</a> <br> <a href="http://www.dabeaz.com/finalgenerator/FinalGenerator.pdf">http://www.dabeaz.com/finalgenerator/FinalGenerator.pdf</a> <br></div><p>Source: <a href="https://habr.com/ru/post/252575/">https://habr.com/ru/post/252575/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252565/index.html">Let's Lab. IS-IS routing protocol. Part 2</a></li>
<li><a href="../252567/index.html">OpenSMTPD + UW IMAP as an alternative to heavy mail systems</a></li>
<li><a href="../252569/index.html">Reverse engineering as a method of teaching electronics</a></li>
<li><a href="../252571/index.html">Machine learning - 2. Nonlinear regression and numerical optimization</a></li>
<li><a href="../252573/index.html">Conference. NEXT returns to Peter</a></li>
<li><a href="../252577/index.html">Casper - new cyber espionage malware</a></li>
<li><a href="../252581/index.html">Report from Integrated Systems Europe - what did you miss in technology if you did not get to ISE-2015</a></li>
<li><a href="../252583/index.html">$ 2,500 for a domain in the .SUCKS zone</a></li>
<li><a href="../252585/index.html">QIWI terminals. Dark side of the Moon</a></li>
<li><a href="../252587/index.html">Broadcast video with Raspberry Pi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>