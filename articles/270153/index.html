<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>XVB - Virtual PBX: Customization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On Habr√© straight month of virtual PBX. 

 Recall another one - XVB VirtualPBX , a boxed multi-tenant solution, with an asterisk inside. 

 The owner ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>XVB - Virtual PBX: Customization</h1><div class="post__text post__text-html js-mediator-article">  On Habr√© straight month of virtual PBX. <br><br>  Recall another one - <a href="http://virtual-pbx.ru/ru-main.html">XVB VirtualPBX</a> , a boxed multi-tenant solution, with an asterisk inside. <br><br>  The owner receives a system integrated into his network (self-contained box - downloaded / bought and used) providing the service of a virtual PBX.  No subscriptions, running subscriber traffic across half the country, Windows servers - for someone this is still a big plus. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="https://github.com/g613/virtual-pbx/blob/master/XVB.pdf">Documentation</a> / Screenshots on the site / <a href="http://virtual-pbx.ru/ru-video.html">Video</a> basically show standard features. <br><br>  The story below will be about the possible customization that can be done by yourself. <br><a name="habracut"></a><br><h4>  <b>I‚Äôll remind you a bit about XVB VirtualPBX</b> </h4><br>  A few years ago there was already an <a href="http://habrahabr.ru/post/135845/">article</a> , but since then everything has changed a lot. <br><br><div class="spoiler">  <b class="spoiler_title">for comparison, the old (by the link above) and the new interface</b> <div class="spoiler_text">  Reports: <br><br><img src="https://habrastorage.org/files/72b/4ac/ff1/72b4acff1c964925962ae45f06bd9e43.png"><br><br>  Online fax: <br><br><img src="https://habrastorage.org/files/8c2/a4d/7f4/8c2a4d7f4c294601bebc2c8ff9d06ae7.png"><br><br>  Admin reports: <br><br><img src="https://habrastorage.org/files/3a1/1f7/e2b/3a11f7e2b9f9454a87b266ae29cd7ff2.png"><br><br>  Tenant setup: <br><br><img src="https://habrastorage.org/files/e79/886/b49/e79886b4904743968f92af05145a63c0.png"><br><br>  <a href="http://virtual-pbx.ru/changelog.html">and many other changes</a> <a href="http://virtual-pbx.ru/updates/vpbx/%3FC%3DM%3BO%3DD">that are consistently coming out ...</a> <br><br></div></div><br><br>  The idea has not changed: <br><ul><li>  admin web to manage tenant / group settings. </li><li>  tuning the system with standard asterisk / kamailio configs, additional modules. </li><li>  The tenant sets everything up via the web. </li></ul><br><br>  A set of functions for most standard PBXs: <br><br><ul><li>  IVR </li><li>  talk recording </li><li>  smart call routing </li><li>  ability to integrate with external CRM systems </li><li>  missed notifications / voice mail </li><li>  call statistics </li><li>  schedule </li><li>  queues with different dialer strategies </li><li>  black / white lists </li><li>  short numbering </li><li>  phone book </li><li>  API </li></ul><br><br>  and not quite standard: <br><br><ul><li>  full call history (where was the user at each moment of the call) </li><li>  call tracking via google analytics / cdr / realtime panel / asterisk / http events </li><li>  transfer of a call to one touch without breaking the conversation (from cellular to fixed and back) </li><li>  ability to save / quickly restore configuration </li><li>  click2call out of the box </li><li>  autoinformer out of the box </li><li>  predictive dialing out of the box </li><li>  TTS out of the box </li></ul><br><br>  More complete list of features <a href="http://virtual-pbx.ru/ru-features.html">here</a> . <br><br>  The system is paid, but for those who are not yet completely an operator, you can <a href="http://virtual-pbx.ru/ru-downloads.html">pick up a</a> free version for 10 simultaneous calls (without a limit on the number of tenants), 10 simultaneous enough for 100 phones. <br><br>  After <a href="http://virtual-pbx.ru/ru-downloads.html">downloading</a> and launching in the vmware player, you can basically start using it - tenants are created / phones are ringing / conversations are being written / statistics are being collected / reports are being sent.  But the maneuvers for 'creativity' still remain, and the story itself will go on about them. <br><br><br><br><h4>  <b>Simplification of creation of automatic telephone exchange, we apply configuration templates</b> </h4><br>  Typically, customers roughly represent in advance what they want, so as not to force them to do the extra work, you can make your own template for the tenant. <br><br>  The algorithm is as follows: <br><br>  we create a new tenant; we set it up (schedule / simple IVR / example routes, etc.) and then in the menu select a user profile - save. <br><br><img src="https://habrastorage.org/files/435/bbb/eae/435bbbeae5c241ed89ae81378375c02e.png"><br><br>  Copy the resulting XML file to /opt/VirtualPBX/contrib/ourtmpl.xml <br><br>  and edit the variable in the configuration file /opt/VirtualPBX/etc/xvb.cfg: <br><br><pre><code class="bash hljs">ADMIN_TENANTS_TEMPLATES = -----:-----;/opt/VirtualPBX/contrib/utils/rpm/sys_update-data/ru-office.xml:RU-office;/opt/VirtualPBX/contrib/ourtmpl.xml: </code> </pre> <br><br>  as a result, when adding a tenant, you can use the created template "Our template": <br><br><img src="https://habrastorage.org/files/fdf/3d0/bff/fdf3d0bff7964f7698e5d6b6d36ac419.png"><br><br>  By creating a number of pre-configured PBX templates, you can greatly simplify your life and yourself.  After applying the template, the time from creating a new tenant's PBX to use can be reduced to the time to configure usernames and passwords in sip phones. <br><br><br><br><h4>  <b>Rules of the tenant's web interface templates</b> </h4><br>  The installed interface templates are in the / opt / VirtualPBX / templates directory, <br>  these are template files, almost honest html.  Those that are set are reaped and <br>  cleaned of spaces, so edit them is not very convenient.  Go <a href="https://github.com/g613/virtual-pbx/tree/master/templates">here</a> and pick up the latest actual files.  We correct the necessary files and put them in the right directory: <br><br><pre> <code class="bash hljs">mkdir -p /opt/VirtualPBX/templates/custom1 <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt/VirtualPBX/templates/custom1 ln -s . xvb.RU-Female ln -s . xvb.RU-Male cp /new/templates/*.tt /opt/VirtualPBX/templates/custom1/ xvb-ctl reload-tt</code> </pre><br><br><ul><li>  symlinks need to be done as the templates are tied to the tenant language settings. </li><li>  xvb-ctl is a utility for some management.  reload-tt - clean the template cache. </li></ul><br><br>  change in the group settings template to custom1. <br><br><img src="https://habrastorage.org/files/2fd/40a/03c/2fd40a03cc6644829c69ab43a456c58b.png"><br><br>  After that, the users in this group will take the interface from another directory. <br><br>  As a result, it may turn out from the standard for example: <br><br><img src="https://habrastorage.org/files/601/22e/94d/60122e94d9d345908fae65fcfea34939.png"><br><br><br><br>  those who lack editing regular templates and there are developers can completely write down their interface through the API. <br><br><br><br><h4>  <b>Hooks</b> </h4><br>  Hooks are a common barley module that is called when the call starts or after it ends.  By default there are several examples in: <br><br><blockquote>  / opt / VirtualPBX / lib / XVBHooks <br></blockquote><br><br>  With the help of hooks, you can do anything you like before and after the call ends: <br>  non-standard logging, various checks, setting internal variables, sms notifications, etc. <br><br>  As an example, there is a module for filling data in MongoDB: <br><br><pre> <code class="perl hljs">%hooks = ( <span class="hljs-string"><span class="hljs-string">start =&gt;</span></span> \&amp;call_start, <span class="hljs-string"><span class="hljs-string">stop =&gt;</span></span> \&amp;call_stop ); <span class="hljs-comment"><span class="hljs-comment"># # call start hook # sub call_start { my $obj = shift; my $ast_callid = $obj-&gt;{'_AGI'}-&gt;get_variable('CHANNEL'); my $xvb_callid = $obj-&gt;{'_CDR'}-&gt;{'CALL_ID'}; $obj-&gt;{'_MONGO_DB'} = MongoDB::Connection-&gt;new(host =&gt; '127.0.0.1', port =&gt; 27017); if ( $obj-&gt;{'_MONGO_DB'} ) { my $cdrs = $obj-&gt;{'_MONGO_DB'}-&gt;xvb-&gt;cdrs; my $rc = $cdrs-&gt;insert( { ast_id =&gt; $ast_callid, timestamp =&gt; time, xvb_id =&gt; $xvb_callid, user_id =&gt; $obj-&gt;{'_USER_CREDS'}-&gt;{'ACCESS_CODE'}, callerid =&gt; $obj-&gt;{'_CDR'}-&gt;{'CALLER_ID'}, calledid =&gt; $obj-&gt;{'_CDR'}-&gt;{'CALLED_ID'}, call_type =&gt; $obj-&gt;{'_CDR'}-&gt;{'CALL_TYPE'}, node =&gt; $obj-&gt;{'_CONF'}-&gt;{'common_server_id'} } ); } } # # call stop hook # sub call_stop { my $obj = shift; my $ast_callid = $obj-&gt;{'_AGI'}-&gt;get_variable('CHANNEL'); if ( $obj-&gt;{'_MONGO_DB'} ) { my $cdrs = $obj-&gt;{'_MONGO_DB'}-&gt;xvb-&gt;cdrs; my $rc = $cdrs-&gt;remove( { ast_id =&gt; $ast_callid } ); } } 1;</span></span></code> </pre><br><br>  After writing the hook, you need to add it in the group settings in the / ai interface: <br><br><img src="https://habrastorage.org/files/61f/7b0/060/61f7b0060c764c069f87451d0b08c738.png"><br><br>  and allow in the configuration file /opt/VirtualPBX/etc/xvb.cfg: <br><br><blockquote>  HOOK = MYHOOK, MYHOOK2 <br></blockquote><br><br><br><br><h4>  <b>Pre-handling of outgoing calls from phones</b> </h4><br>  If you need to bring all the dialed numbers to a certain type or add custom processing of some numbers, you can do this in the /etc/asterisk/xvb/xvb-phone-filters.conf file.  The example below lists the numbers to the e164 format: <br><br><pre> <code class="hljs php">exten =&gt; _00XXXXXXX.,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">Goto</span></span>(xvb-phones,${EXTEN:<span class="hljs-number"><span class="hljs-number">2</span></span>},<span class="hljs-number"><span class="hljs-number">1</span></span>) exten =&gt; _8XXXXXXXXXX,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">Goto</span></span>(xvb-phones,<span class="hljs-number"><span class="hljs-number">7</span></span>${EXTEN:<span class="hljs-number"><span class="hljs-number">1</span></span>},<span class="hljs-number"><span class="hljs-number">1</span></span>) exten =&gt; _+X.,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">Goto</span></span>(xvb-phones,${EXTEN:<span class="hljs-number"><span class="hljs-number">1</span></span>},<span class="hljs-number"><span class="hljs-number">1</span></span>) exten =&gt; _810XXXXXXXX.,<span class="hljs-number"><span class="hljs-number">1</span></span>,Set(CALLED_NUMBER=${EXTEN:<span class="hljs-number"><span class="hljs-number">3</span></span>}) exten =&gt; _810XXXXXXXX.,n,<span class="hljs-keyword"><span class="hljs-keyword">Goto</span></span>(xvb-phones,${EXTEN:<span class="hljs-number"><span class="hljs-number">3</span></span>},digits)</code> </pre><br><br>  Here you can also prohibit the dialing of certain numbers (global blacklist for outgoing, for all tenants) <br><br>  In the /etc/asterisk/xvb/xvb-phone-service.conf file, you can enter your service codes, for example, cost verification <br>  call XXX: <br><br><pre> <code class="hljs javascript">; <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">exten</span></span></span><span class="hljs-function"> =&gt;</span></span> _**<span class="hljs-number"><span class="hljs-number">44.</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-built_in"><span class="hljs-built_in">Set</span></span>(RATE=${CURL(http:<span class="hljs-comment"><span class="hljs-comment">//localhost/get_rate?phone=${EXTEN:4})}) exten =&gt; _**44.,n,Playback(current-rate) exten =&gt; _**44.,n,agi(d2ms.agi|${RATE}|rur)</span></span></code> </pre><br><br>  here the URL get_rate gives the cost of the call and below we voice it to the user. <br><br>  Through the same asterisk configs, you can integrate with FMC and other useful buns over incoming calls. <br><br><br><br><h4>  <b>SIP user registration at kamailio</b> </h4><br>  By default, the system goes to asterisk but no, that does not prevent the use of kamailio as a sip-registrar. <br><br>  We put the fourth kamailio, pick up the kamailio config for XVB pbx. <br><br>  in the config rule address: <br><br><blockquote>  xvb.gw_ip = "172.16.165.129" desc "XVB GW Address" - IP asterisk <br><br>  listen = MY_IP_ADDR - IP Kamalio <br><br></blockquote><br><br>  Rule configs asterisk.  For the case if everything remains on one machine - we change the port from 5060 to 5080 and make a feast for kamilio with the friend type, send calls from it to the xvb-phones context, in /etc/asterisk/sip.conf: <br><br><blockquote>  [sipregistrar] <br>  host = 172.16.165.129 <br>  port = 5060 <br>  insecure = port, invite <br>  type = friend <br>  context = xvb-phones <br></blockquote><br><br>  in /opt/VirtualPBX/etc/xvb.cfg add: <br><br><blockquote>  [Sip] <br>  REGISTRAR_TYPE = SER <br>  REGISTRAR_IP = 172.16.165.129 <br>  REGISTRAR_NAME = sipregistrar <br></blockquote><br><br>  in /etc/asterisk/extconfig.conf, run VPBX_SIPPEERS on VPBX_SIPPEERS_PEERS: <br><br><blockquote>  sippeers =&gt; odbc, xvb, VPBX_SIPPEERS_PEERS <br></blockquote><br><br>  we restart everything that is needed (or the whole system at once so that we can probably :)) and use the registration of local IPV phones via kamailio on port 5060 and asterisk for external trunks on 5080. Those who want and can go further and change the static address asterisk to use dispatcher and get clustering <br><br><h4>  <b>As a conclusion</b> </h4><br>  These examples show which way you can move in order to customize and expand <a href="http://virtual-pbx.ru/ru-main.html">XVB VirtualPBX</a> without recourse to the help of developers if what you want in addition to what is `box 'you want to add something. </div><p>Source: <a href="https://habr.com/ru/post/270153/">https://habr.com/ru/post/270153/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../270143/index.html">Pirate metrics: how to create an email campaign based on the AARRR principle. Part 3</a></li>
<li><a href="../270145/index.html">Street magic in scripts or what connects Groovy, Ivy and Maven?</a></li>
<li><a href="../270147/index.html">PHP html generation</a></li>
<li><a href="../270149/index.html">Microsoft raises prices for its software in the Russian Federation</a></li>
<li><a href="../270151/index.html">Top 10 articles on user eXperience for beginners to understand in an hour what it is</a></li>
<li><a href="../270155/index.html">We write the simplest plugin for ReSharper</a></li>
<li><a href="../270159/index.html">Significance of SPF</a></li>
<li><a href="../270161/index.html">Plugin for gulp - collect files in pieces</a></li>
<li><a href="../270163/index.html">As we for the first time in Ukraine held a security event on a grand scale</a></li>
<li><a href="../270165/index.html">Isolate the demons with systemd or ‚Äúyou don't need a docker for this!‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>