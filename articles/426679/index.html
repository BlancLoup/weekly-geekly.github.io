<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>When is the program code admirable?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The theme of ideal code often causes controversy among experienced programmers. The more interesting it was to get the opinion of Igor Marnat, directo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>When is the program code admirable?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/ra/0s/yx/ra0syx2ovvhaqig6cdsntx297cw.png"><br><br>  The theme of ideal code often causes controversy among experienced programmers.  The more interesting it was to get the opinion of Igor Marnat, director of development at Parallels RAS.  Under the cut his author's view on the stated topic.  Enjoy! <a name="habracut"></a><br><br><img src="https://habrastorage.org/webt/iy/ky/zg/iykyzgb9kkv_lvpvfplcfbbfqmm.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As an introduction, I would like to dwell on the question of why I decided to write this short article.  Before writing it, I asked the question from the title of several developers.  With most of the guys had to work for more than five years, with some a little less, but I trust their professionalism and experience unconditionally.  All industrial development experience for more than ten years, all work in Russian and international companies, software manufacturers. <br><br>  Some colleagues found it difficult to answer (some people still think), others gave one or two examples at once.  To those who gave examples, I asked a clarifying question - ‚ÄúWhat, in fact, caused this admiration?‚Äù.  The answers corresponded to the results of the next stage of my small research.  I searched the web for answers to this question in various formulations close to the title of the article.  All articles answered in much the same way as my comrades answered. <br><br>  The developers' answers, as well as the wording of the found articles, related to the readability and structure of the code, the elegance of logical structures, the use of all the features of modern programming languages ‚Äã‚Äãand the following of a certain style of design. <br><br>  When I asked myself about the ‚Äúdivine code‚Äù, the answer came up immediately, from the subconscious.  I immediately thought of two code examples I worked with for a long time (more than ten years ago), but I still feel a sense of admiration and some awe.  Having considered the reasons for admiring each of them, I formulated several criteria, which will be discussed below.  I will dwell on the first example in passing, but I would like to take a closer look at the second one.  By the way, to varying degrees, all these criteria are discussed in the reference book of each developer ‚Äú <a href="https://www.ozon.ru/context/detail/id/142768363/">Perfect Code</a> ‚Äù by Steve McConnell, but this article is noticeably shorter. <br><br><h3>  <font color="#cc0000">90's example</font> </h3><br>  The first example I will mention is related to the implementation of the v42bis modem protocol.  This protocol was developed in the late 80s - early 90s.  An interesting idea embodied by the developers of the protocol is the implementation of stream compression of information during transmission over an unstable (telephone) communication line.  The difference between stream compression and file compression is fundamental.  When compressing files, the archiver has the ability to analyze the entire data set, determine the optimal approach to compressing and encoding the data, and write the data to the file as a whole, without worrying about possible data and metadata losses.  When unzipping, in turn, the data set is again fully accessible, integrity is provided with a checksum.  With on-line compression, only a small data window is available to the archiver, there is no guarantee that there is no data loss, the need to reset the connection and initialize the compression process is common. <br><br>  The authors of the algorithm have found an elegant solution, a description that takes <a href="http://www.modem.od.ua/download/lib/v42b-com.pdf">literally several pages</a> .  Many years have passed, but I am still impressed by the beauty and elegance of the approach proposed by the developers of the algorithm. <br><br>  This example does not relate to the code per se, but rather to the algorithm, so we will not dwell on it in more detail. <br><br><h3>  <font color="#cc0000">Linux is the head of everything!</font> </h3><br>  I would like to analyze the second example of a perfect code in more detail.  This is the Linux kernel code.  The code that at the time of this writing controls the operation of 500 supercomputers from the <a href="https://www.top500.org/statistics/sublist/">top 500</a> , the code that runs on every second phone in the world and that controls most of the servers on the Internet. <br><br>  Consider for example the memory.c file from <a href="">the Linux kernel</a> , which belongs to the memory management subsystem. <br><br>  <b>1. Sources are easy to read.</b>  They are written using a very simple style that is easy to follow and difficult to get confused.  Capital letters are used only for preprocessor directives and macros, everything else is written in small letters, words in names are separated by underscores.  This is probably the easiest coding style possible, except for the lack of style at all.  At the same time, the code is perfectly readable.  Indents and approach to commenting are visible from any piece of any kernel file, for example: <br><br><pre><code class="hljs pgsql">static <span class="hljs-type"><span class="hljs-type">void</span></span> tlb_remove_table_one(<span class="hljs-type"><span class="hljs-type">void</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">table</span></span>) {     <span class="hljs-comment"><span class="hljs-comment">/*      * This isn't an RCU grace period and hence the page-tables cannot be      * assumed to be actually RCU-freed.      *      * It is however sufficient for software page-table walkers that rely on      * IRQ disabling. See the comment near struct mmu_table_batch.      */</span></span>     smp_call_function(tlb_remove_table_smp_sync, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>);     __tlb_remove_table(<span class="hljs-keyword"><span class="hljs-keyword">table</span></span>); }</code> </pre> <br><br>  <b>2. There are not too many comments in the code, but those that exist are usually useful.</b>  They, as a rule, do not describe the action, which is already obvious from the code (a classic example of a useless comment - ‚Äúcnt ++; // increment counter‚Äù), but the context of this action - why what is done here, why it is done so, why here, with what assumptions it is used, with what other places in the code it is connected.  For example: <br><br><pre> <code class="hljs java"><span class="hljs-comment"><span class="hljs-comment">/** * tlb_gather_mmu - initialize an mmu_gather structure for page-table tear-down * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@tlb</span></span></span><span class="hljs-comment">: the mmu_gather structure to initialize * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@mm</span></span></span><span class="hljs-comment">: the mm_struct of the target address space * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@start</span></span></span><span class="hljs-comment">: start of the region that will be removed from the page-table * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@end</span></span></span><span class="hljs-comment">: end of the region that will be removed from the page-table * * Called to initialize an (on-stack) mmu_gather structure for page-table * tear-down from </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@mm</span></span></span><span class="hljs-comment">. The </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@start</span></span></span><span class="hljs-comment"> and </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@end</span></span></span><span class="hljs-comment"> are set to 0 and -1 * respectively when </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@mm</span></span></span><span class="hljs-comment"> is without users and we're going to destroy * the full address space (exit/execve). */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tlb_gather_mmu</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct mmu_gather *tlb, struct mm_struct *mm,            unsigned </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> start, unsigned </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> end)</span></span></span></span></code> </pre><br><br>  Another use of comments in the kernel is to describe the change history, usually at the beginning of the file.  The history of the nucleus has been around for almost thirty years, and some places to read are just interesting, you feel like a part of the story: <br><br><pre> <code class="hljs objectivec"><span class="hljs-comment"><span class="hljs-comment">/* * demand-loading started 01.12.91 - seems it is high on the list of * things wanted, and it should be easy to implement. - Linus */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* * Ok, demand-loading was easy, shared pages a little bit tricker. Shared * pages started 02.12.91, seems to work. - Linus. * * Tested sharing by executing about 30 /bin/sh: under the old kernel it * would have taken more than the 6M I have free, but it worked well as * far as I could see. * * Also corrected some "invalidate()"s - I wasn't doing enough of them. */</span></span></code> </pre><br><br>  <b>3. The kernel code uses special macros to validate data.</b>  They are also used to check the context in which the code works.  The functionality of these macros is similar to the standard assert, with the difference that the developer can override the action that is performed when the condition is true.  General approach to data processing in the kernel - everything that comes from the user space is checked, in case of erroneous data the corresponding value is returned.  In this case, WARN_ON can be used to issue a record in the kernel log.  BUG_ON is usually quite useful when debugging new code and launching the kernel on new architectures. <br><br>  The BUG_ON macro usually causes the contents of the registers and the stack to be printed and either stops the entire system or the process in the context of which the corresponding call occurred.  The WARN_ON macro simply displays a message to the kernel log in the event that the condition is true.  There are also macros WARN_ON_ONCE and a number of others, the functionality of which is clear from the name. <br><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> unmap_page_range(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> mmu_gather *tlb, ‚Ä¶.     <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> next;    BUG_ON(addr &gt;= end);    tlb_start_vma(tlb, vma); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> apply_to_page_range(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> mm_struct *mm, <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> addr, ‚Ä¶    <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> end = addr + size;    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> err;    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (WARN_ON(addr &gt;= end))        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -EINVAL;</code> </pre><br><br>  The approach, in which data obtained from unreliable sources are checked before use, and the system‚Äôs response to ‚Äúimpossible‚Äù situations is foreseen and defined, makes it much easier to debug the system and its operation.  You can consider this approach as the implementation of the fail early and loudly principle. <br><br>  <b>4. All core components of the kernel provide users with information about their state through a simple interface, the virtual file system / proc /.</b> <br><br>  For example, information about the state of memory is available in the file / proc / meminfo <br><br><pre> <code class="hljs mel">user@parallels-vm:/home/user$ cat /<span class="hljs-keyword"><span class="hljs-keyword">proc</span></span>/meminfo MemTotal:    <span class="hljs-number"><span class="hljs-number">2041480</span></span> kB MemFree:      <span class="hljs-number"><span class="hljs-number">65508</span></span> kB MemAvailable:   <span class="hljs-number"><span class="hljs-number">187600</span></span> kB Buffers:      <span class="hljs-number"><span class="hljs-number">14040</span></span> kB Cached:      <span class="hljs-number"><span class="hljs-number">246260</span></span> kB SwapCached:    <span class="hljs-number"><span class="hljs-number">19688</span></span> kB Active:     <span class="hljs-number"><span class="hljs-number">1348656</span></span> kB Inactive:     <span class="hljs-number"><span class="hljs-number">477244</span></span> kB Active(anon):  <span class="hljs-number"><span class="hljs-number">1201124</span></span> kB Inactive(anon):  <span class="hljs-number"><span class="hljs-number">387600</span></span> kB Active(<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>):   <span class="hljs-number"><span class="hljs-number">147532</span></span> kB Inactive(<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>):  <span class="hljs-number"><span class="hljs-number">89644</span></span> kB ‚Ä¶.</code> </pre><br><br>  The information above is collected and processed in several source files of the memory management subsystem.  So, the first MemTotal field is the value of the totalram field of the sysinfo structure, which is populated with the <a href="">si_meminfo</a> function of the <a href="">page_alloc.c file</a> . <br><br>  Obviously, the organization of collecting, storing and providing the user with access to such information requires efforts from the developer and some overhead from the system.  At the same time, the benefits of having convenient and simple access to such data are invaluable, both in the process of development and in the operation of the code. <br><br>  The development of almost any system should start with a system for collecting and providing information about the internal state of your code and data.  This will greatly help in the process of development and testing, and, further, in operation. <br><br>  As <a href="https://en.wikiquote.org/wiki/Linus_Torvalds">Linus said</a> , ‚ÄúBad programmers worry about the code.  Good programmers worry about data structures and their relationships. ‚Äù <br><br>  <b>5. All code is read and discussed by several developers before committing.</b>  The source code change history is recorded and available.  Changes to any line can be traced back to its occurrence - what has changed, by whom, when, why, what issues were discussed by the developers.  For example, a change in https://github.com/torvalds/linux/commit/1b2de5d039c883c9d44ae5b2b6eca4ff9bd82dac#diff-983ac52fa16631c1e1dfa28fc593d2ef in the code memory.c, inspired by the https://bjcpage filed, which is supported by the current accountant, and you will be supported by https, in a modem, and you will be supported by the current accountant, and you will be supported by the httpspage filed by 78h.h. a small code optimization was made (the call to enable memory protection from writing does not occur if the memory is already write-protected). <br><br>  It is always important for the developer working with the code to understand the context around this code, with what assumptions the code was created, what and when it changed, in order to understand which scenarios could be affected by the changes that he himself is going to make. <br><br>  <b>6. All important elements of the life cycle of the kernel code are documented and available</b> , starting <a href="https://www.kernel.org/doc/html/v4.12/process/coding-style.html">with the coding style</a> and ending with the <a href="https://www.kernel.org/doc/html/v4.12/process/stable-kernel-rules.html">content and schedule for the release of stable kernel versions</a> .  Each developer and user who wants to work with the kernel code in one capacity or another has all the necessary information for this. <br><br>  These moments seemed important to me, basically, they determined my enthusiastic attitude to the kernel code.  Obviously, the list is very short and can be expanded.  But the above points, in my opinion, relate to key aspects of the life cycle of any source code from the point of view of the developer working with this code. <br><br>  What I would like to say in conclusion.  Kernel developers are smart and experienced, they have been successful.  Proved by billions of devices running Linux <br><br>  Be like kernel developers, use best practices and read Code Complete! <br><br>  <b>ZY</b>  By the way, what are the criteria for the ideal code for you personally?  Share your thoughts in the comments. </div><p>Source: <a href="https://habr.com/ru/post/426679/">https://habr.com/ru/post/426679/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../426667/index.html">Seymour Papert: ‚ÄúComputer as a condom‚Äù</a></li>
<li><a href="../426671/index.html">The head of Google commented on the launch of a search engine censored in China</a></li>
<li><a href="../426673/index.html">Roskomnadzor did not find references to RuTracker and Librusek in the issuance of Yandex</a></li>
<li><a href="../426675/index.html">OpenCV based line following</a></li>
<li><a href="../426677/index.html">There was a nearly two-hour crash in the services of YouTube, now the service has become operational</a></li>
<li><a href="../426681/index.html">GitHub announced its own CI / CD and began distributing invites.</a></li>
<li><a href="../426685/index.html">We manage hundreds of different smart home devices with voice and text from a smartphone. Alexa Echo in messenger</a></li>
<li><a href="../426687/index.html">Production of the case for the robot with a limited budget. Vacuum forming</a></li>
<li><a href="../426689/index.html">Responsible for someone else's bazaar: what social networks say about CRM</a></li>
<li><a href="../426691/index.html">Programmer at the hospital</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>