<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pure C ++: How to destroy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, Serega again got to the keyboard and talks about C ++. Today we will talk about what else classes need in C ++, how destructors work a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pure C ++: How to destroy</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/dff/823/718/dff823718d0816ff96eff0f48c819116.jpg"><br>  Good afternoon, <a href="http://habrahabr.ru/company/intel/blog/156863/">Serega</a> again got to the keyboard and talks about C ++.  Today we will talk about what else classes need in C ++, how destructors work and what other rake can be stepped on if you mix two languages.  Under the cut there is nothing new and outstanding for those who know C ++ since the days of DOS.  If you are just learning this language - welcome. <br><a name="habracut"></a><br>  As you probably noticed last time, a class has a very important thing - a destructor!  This function will be called ALWAYS when the class is destroyed.  No matter what happened, exit from a function in the middle or even a thrown exception, the class destructor will be called anyway while the program is running.  (For reference, the program no longer works if no one catches an exception, so you need to put try ... catch on all types of exceptions in main.).  On C, the destructor is called manually, which forces you to write a lot of unnecessary details. <br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!Create1(...)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!Create2(...)) { Destroy1(...); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!CreateN(...)) { Destroy1(...); Destroy2(...); ... DestroyN<span class="hljs-number"><span class="hljs-number">-1</span></span>(...); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; }</code> </pre> <br>  And additional branches and loops only add confusion and bulkiness in the code. <br>  The destructor is not replaced by the finalize section available in other languages!  The fact is that it is called only for already created objects, and it is not always possible to figure out who has already been created and who is not in finalize.  It is necessary to fence nested blocks and multiple sections of finalization, which also makes the code unnecessarily confusing.  Here is a good example of such a situation: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;iostream&gt; #include &lt;stdexcept&gt; class Foo { private: static int sm_count; int instance; public: Foo() { instance = ++sm_count; if(instance &gt; 5) throw std::runtime_error("   5 ."); std::cout &lt;&lt; " ‚Ññ " &lt;&lt; instance &lt;&lt; "  Foo .\n"; } ~Foo() { std::cout &lt;&lt; " ‚Ññ " &lt;&lt; instance &lt;&lt; "  Foo .\n"; } }; int Foo::sm_count = 0; int main() { try { Foo* pFoo = new Foo[10]; } catch(const std::exception&amp; e) { std::cout &lt;&lt; e.what() &lt;&lt; "\n"; } return 0; }</span></span></span></span></code> </pre><br>  Competent and ubiquitous use of destructors brings C ++ closer in style to programming languages ‚Äã‚Äãwith the garbage collector.  With this approach, the programmer is busy building a model, rather than tracking down symmetric selections and freeing up resources.  However, such a rapprochement is highly deceptive and often ends with an appeal to an object removed from the heap and an emergency exit from the program.  And if you still actively use the constructions of the C language (referred to last time as ‚ÄúC with classes‚Äù), then once guaranteed to access the data of an object of one type through a pointer to another type.  Here is a very good example (it is not necessary to divide into header files, but it is useful to make it easy to change the order of their inclusion): <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// HeaderFile1 class Interface1 { public: virtual void SomeFunc(int a) = 0; }; class Interface2 { public: virtual void AnotherFunc(double b) = 0; }; // HeaderFile2 class Implementation; class Storage { private: Implementation* m_pImpl; public: Storage(Implementation* in_pImpl) : m_pImpl(in_pImpl) {} Interface1* GetInterface1() { return (Interface1*)m_pImpl; } Interface2* GetInterface2() { return (Interface2*)m_pImpl; } }; // HeaderFile3 #include &lt;iostream&gt; class ImplementationBase { protected: virtual void BaseFunc() { std::cout &lt;&lt; "BaseFunc  .\n"; } }; class Implementation : private ImplementationBase , public Interface1 , public Interface2 { public: virtual void SomeFunc(int a) { std::cout &lt;&lt; "SomeFunc     a = " &lt;&lt; a &lt;&lt; ".\n"; } virtual void AnotherFunc(double b) { std::cout &lt;&lt; "AnotherFunc     b = " &lt;&lt; b &lt;&lt; ".\n"; } }; // C++ source file // #include &lt;HeaderFile1&gt; // #include &lt;HeaderFile2&gt; // #include &lt;HeaderFile3&gt; int main() { Implementation impl; Storage storage(&amp;impl); storage.GetInterface1()-&gt;SomeFunc(42); storage.GetInterface2()-&gt;AnotherFunc(37.7); return 0; }</span></span></code> </pre><br>  In this example, try changing the order in which the second and third header files are included.  It is very good when such errors are easy to detect, as in this isolated example.  When code is scattered across many files, hidden by several levels of inheritance hierarchy and virtual operator overload, it‚Äôs easier to go crazy than to understand what actually happens.  If pure C ++ is used in this example, the compiler will generate an error at compile time. <br><br>  Let's return to destructors.  When writing them, the main thing is not to accidentally throw an exception.  The fact is that a destructor can be called exactly in the course of exception handling.  In this case, the process of unwinding the stack of the procedure of unwinding the stack ends in the most simple and expected way: immediate exit from the program.  So watch them carefully.  In no case do not allocate them memory, resources, and especially do not throw exceptions explicitly.  This requirement dictates a certain attitude towards all ‚Äúclosing‚Äù functions.  For example, some <code>Socket::Close()</code> can no longer make <code>throw std::runtime_error("Close socket error: socket was not opened")</code> .  The fact is that the most logical thing to do with the ‚Äúclosing‚Äù function is to call it in the destructor.  But it‚Äôs not even logical to call this call with various condition checks.  And if you work in a team, then someone will definitely try to close the already closed.  So, write down a simple rule for yourself: in any ‚Äúclosing‚Äù function, you need to quietly and without unnecessary movements to do exactly what is required of it - to ‚Äúclose‚Äù what is asked, even if it is physically impossible. <br>  Once again I draw attention to the fact that it is impossible to allocate or seize anything in such functions and destructors.  Very common mistake: <br><pre> <code class="cpp hljs">~object::object() { g_logger.put_message(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>(<span class="hljs-string"><span class="hljs-string">"Object "</span></span>) + m_name + <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>(<span class="hljs-string"><span class="hljs-string">" was deleted."</span></span>)); }</code> </pre><br>  If this destructor is called in the process of processing the exception "out of memory", then you will be looking for the cause of the program departure for a long time.  However, even the logger mentioned here will not help, since  will not be able to form and save the message so desired.  How to be in this situation?  The easiest way, but not the most ‚Äúbeautiful‚Äù, is to generate a message in advance, when everything was fine, and keep it in a private part for the time being.  More "advanced" option: <br><pre> <code class="cpp hljs">~object::object() { g_logger &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Object "</span></span> &lt;&lt; m_name &lt;&lt; <span class="hljs-string"><span class="hljs-string">" was deleted."</span></span>; }</code> </pre><br>  I hope it is clear that g_logger here has no right to deal with allocations of memory and file openings, but is it obliged to have a fixed-size buffer ready and merge it into a previously opened file for filling? <br><br>  Smoothly proceed to the allocation of resources.  The correct approach is to first select and then use.  Here is a wrong example: <br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; items; ... items.push_back(item1); items.push_back(item2);   : <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; items; ... items.reserve(items.size() + <span class="hljs-number"><span class="hljs-number">2</span></span>); items.push_back(item1); items.push_back(item2);</code> </pre><br>  We must constantly remember that the memory may end at the most inopportune moment, and the state of the program at such a moment must remain certain.  If there must be two elements in the array, it means either two integers or none.  There should be no "under-created" data structures, since  This is a direct way to crash when working destructors.  A good program is one that even when there is a shortage of memory, saves its data correctly and goes out quietly.  Well, maybe not quiet, but politely saying goodbye.  Unfortunately, this is not always so easily achievable.  For example, <code>std::list</code> does not have a reserve method.  For such cases, you have to set up the "empty" state of the data element, such as null_ptr for pointers or -1 for indexes, and put it first in the data structure.  And in the destructor carefully bypass such elements.  It is appropriate to recall the fascination with all sorts of operators that create temporary objects on the stack.  These objects, in turn, allocate resources that are not allocated, but throw an exception right in the middle of a complex expression, leaving parts of this expression in a semi-exhausted state.  For example, an iterator shifted by the ++ operator in the middle of an expression will be absolutely useless in the catch section. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In order for the integrity of data structures to be obtained by itself, without unnecessary gestures on the part of the programmer, it is necessary to strive to ensure that all such structures are created in constructors and represent an object, but destroyed by destructors, correctly excluding themselves from the overall data structure of the program.  The above example with integers should be written like this: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::pair&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; DataItem; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;DataItem&gt; items; ... items.push_back(DataItem(item1, item2));</code> </pre><br>  However, this is no longer such a simple topic of modeling the subject area of ‚Äã‚Äãthe task. </div><p>Source: <a href="https://habr.com/ru/post/163907/">https://habr.com/ru/post/163907/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../163895/index.html">Automatic analysis of code coverage using OpenCover + buns</a></li>
<li><a href="../163897/index.html">Offline informer for online business</a></li>
<li><a href="../163899/index.html">PyCon in Russia: let it be</a></li>
<li><a href="../163901/index.html">China tightens Internet access rules</a></li>
<li><a href="../163903/index.html">Latency when loading web pages</a></li>
<li><a href="../163909/index.html">And some more thoughts on project management methodologies</a></li>
<li><a href="../163913/index.html">Work with COM port in Android applications</a></li>
<li><a href="../163917/index.html">Serialization of GWT RPC to the requested page for indexing the application by search engines and speeding up downloads</a></li>
<li><a href="../163919/index.html">The nuances of installing Oracle 10g RAC on SUSE 11</a></li>
<li><a href="../163923/index.html">How to sell a company twice or CleverPumpkin History</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>