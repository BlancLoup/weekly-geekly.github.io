<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Client-side Linq to NHibernate</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Practically any .NET developer somehow uses Linq technology in his practice. Linq allows you to write beautiful and concise code for receiving objects...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Client-side Linq to NHibernate</h1><div class="post__text post__text-html js-mediator-article">  Practically any .NET developer somehow uses Linq technology in his practice.  Linq allows you to write beautiful and concise code for receiving objects from a data source with the ability to define criteria for obtaining and / or transforming the requested objects on the fly.  Linq support is present in almost all popular ORM frameworks, including NHibernate.  NHibernate provides a Linq provider with which we can write a request at design time (Design-Time), but in order to make a request at runtime, you will have to tinker with Reflection.  However, if there is a need to form a request in an external process, for example, in the client part of the service, then Reflection will not save, the client part, as a rule, does not know (and should not know anything) about the server ORM. <br>  Below we will discuss how to create an API for writing Linq queries to NHibernate in a situation where the query is written in one process and executed in another.  Also, we implement our own IQueryProvider, which will translate requests from the source application to the executing application. <br><a name="habracut"></a><br><h2>  Content </h2><br>  <a href="https://habr.com/ru/post/302594/">1. IEnumerable vs IQueryable</a> <br>  <a href="https://habr.com/ru/post/302594/">2. Linq in NHibernate</a> <br>  <a href="https://habr.com/ru/post/302594/">3. Linq requests without an ISession object</a> <br>  <a href="https://habr.com/ru/post/302594/">4. Linq database query through NHibernate from external process</a> <br>  <a href="https://habr.com/ru/post/302594/">5. We write test application</a> <br>  <a href="https://habr.com/ru/post/302594/">Conclusion</a> <br>  <a href="https://habr.com/ru/post/302594/">Links</a> <br><a name="IEnumerableVsIQueryable"></a><br><h2>  1. IEnumerable vs IQueryable </h2><br>  For starters, you should briefly recall the IEnumerable and IQueryable interfaces.  They wrote about them <a href="https://habrahabr.ru/post/108407/">here</a> and <a href="https://habrahabr.ru/post/256821/">here</a> .  It is also helpful to read about <a href="https://msdn.microsoft.com/en-us/library/mt654263.aspx">expression trees</a> and how they <a href="https://habrahabr.ru/post/83169/">work</a> . <br><div class="spoiler">  <b class="spoiler_title">IEnumerable</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/b2c/718/273/b2c7182736fa4fea932d36b52768f7cd.png"><br></div></div><br>  How the IEnumerable query is executed: <br>  1. The data source is represented as IEnumerable (enumerable); in the case of collections, this is an optional action. <br>  2. The enumerated data source is wrapped (decorated) by an WhereListIterator iterator <br>  3. The first WhereListIterator iterator is decorated by the next WhereListIterator iterator. <br>  4. In the List constructor, the WhereListIterator is ‚Äútop-level‚Äù.  In a rough approximation, we can say that the filling of the internal List container takes place through a <a href="https://msdn.microsoft.com/ru-ru/library/aa288257(v%3Dvs.71).aspx">foreach loop</a> traversing the resulting WhereListIterator.  When requesting the next element, the ‚Äútop-level‚Äù decorator calls the whole chain of decorators, each element of which determines which element can be pushed up and which should be skipped. <br><div class="spoiler">  <b class="spoiler_title">Pseudocode</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// List ctor public List&lt;T&gt;(IEnumerable&lt;T&gt; source) { //  IEnumerator  WhereListIterator. var enumerator = source.GetEnumerator(); //        WhereListIterator'        while(enumerator.MoveNext()) { items.Add(enumerator.Current) } }</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Iqueryable</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/7a0/f90/743/7a0f9074364846f99e88c2b253aa646f.png"><br></div></div><br>  How is the execution of IQueryable query for example collections: <br>  1. The data source is wrapped by an EnumerableQueryable object (let's call it ‚ÄúA‚Äù), inside of which a ConstantExpression expression is created with the reference to the source object closed (IQueryProvider is also created, which in the case of IEnumerable will look at the original collection). <br>  2. Object ‚ÄúA‚Äù is decorated with a new object EnumerableQueryable (let's call it ‚ÄúB‚Äù), from object A, the Expression property is taken, which is decorated with an expression MethodCallExpression, where Queryable.Where is specified as the called method;  the request provider in the new object sets the request provider from object A. Object A is no longer needed. <br>  3. The object B obtained in the previous step with the expression MemberExpression is decorated with the new object EnumerableQueryable (let's call it ‚ÄúC‚Äù), from object B the property with the type Expression is taken, which is decorated with the expression MethodCallExpression, where Queryable.Where is specified as the called method;  the request provider in the new object sets the request provider from object B. Object B is no longer needed. <br>  4. The main action takes place at the stage of accessing the results of the query: <br>  The IQueryable interface is an IEnumerable inheritor, therefore, an object of type IQueryable can also be passed to the List constructor, before executing the foreach loop (again a rough approximation), the GetEnumerator method will be called on the transferred IQueryable object.  During a call to GetEnumerator (), the query provider will compile the resulting MethodCallExpression and return, as in the case of IEnumerable, a chain of decorator methods that will return the next element on request. <br><div class="spoiler">  <b class="spoiler_title">Pseudocode</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;T&gt;(IQueryable&lt;T&gt; source) { <span class="hljs-comment"><span class="hljs-comment">//  IEnumerator  WhereListIterator. var enumerator = source.GetEnumerator(); //        WhereListIterator'        while(enumerator.MoveNext()) { items.Add(enumerator.Current) } } public class EnumerableQueryable&lt;T&gt; : IQueryable&lt;T&gt; { private Expression expression; private IEnumerable enumerableResult; public IEnumerator GetEnumerator() { if (enumerableResult == null) enumerableResult = expression.Compile().Invoke(); return enumerableResult.GetEnumerator(); } }</span></span></code> </pre><br></div></div><br>  Here we come to the difference between IEnumerable and IQueryable. <br><ul><li>  When working with IEnumerable, the data source is decorated with <b>iterator objects</b> . </li><li>  When working with IQueryable, the data source is decorated using <b>expression trees</b> . </li></ul><br>  The advantage of expression trees is that it is inherently a high-level API for generating IL code, which we can build / edit at runtime, compile into a delegate, and call. <br><a name="Linq2NHibernate"></a><br><h2>  2. Linq in NHibernate </h2><br>  A typical scenario for working with Linq in NHibernate looks like this: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> activeMasterEntities = session <span class="hljs-comment"><span class="hljs-comment">//  NhQueryable&lt;T&gt;,  ConstantExpression ,        . .Query&lt;Entity&gt;() //  IQueryable,  MethodCallExpression ,   ConstantExpression. .Where(e =&gt; e.IsMaster == true) //  IQueryable,  MethodCallExpression ,    MethodCallExpression. .Where(e =&gt; e.IsActive == true) //    .ToList()</span></span></code> </pre><br>  Calling session.Query () will return an object of type NhQueryable.  Further refinement of the Where conditions will decorate the expression from the NhQueryable source object.  Wrapping the original query is exactly the same as in the case of a query to the collection.  Differences begin from the moment you call ToList (). <br>  At the time of the GetEnumerator () method call, the constructed expression tree will not be compiled, but translated into an sql query.  The Remotion.Linq library is responsible for the Linq query translation mechanism in SQL, it parses the expression tree received from NHibernate.  At the parsing stage, calculations of closures in the tree nodes occur, for example: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> stateCoefficient = <span class="hljs-number"><span class="hljs-number">0.9</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ageLimitInCurrentState = <span class="hljs-number"><span class="hljs-number">18</span></span> * stateCoefficient; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> availableMovies = session .Query&lt;Movie&gt;() .Where(m =&gt; m.AgeLimit &gt;= ageLimitInCurrentState) .ToList()</code> </pre><br>  The lambda expression m =&gt; m.AgeLimit&gt; = ageLimit will create a <a href="http://sergeyteplyakov.blogspot.ru/2010/04/c.html">closure</a> on the local variable ageLimit.  When parsing this lambda expression, the expression tree of the form m.AgeLimit&gt; = ageLimitInCurrentState will be evaluated in the expression m.AgeLimit&gt; = 16 and already in this form the expression will be given to the Linq2Sql translator. <br><div class="spoiler">  <b class="spoiler_title">Convert Linq to Sql</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/ad5/15f/a63/ad515fa632c8439aadcdbef0f0874be7.png"><br></div></div><br><h4>  <u>IQueryable and IQueryProvider</u> </h4><br>  Let's take a <a href="https://msdn.microsoft.com/ru-ru/library/system.linq.iqueryable(v%3Dvs.110).aspx">closer</a> look at the <a href="https://msdn.microsoft.com/ru-ru/library/system.linq.iqueryable(v%3Dvs.110).aspx">IQueryable</a> and <a href="https://msdn.microsoft.com/ru-ru/library/system.linq.iqueryprovider(v%3Dvs.110).aspx">IQueryProvider interfaces</a> . <br>  In the IQueryable interface, there is an Expression property, which provides the current expression-decorator (data source decorator, or another expression decorator), as well as the Provider property with the IQueryProvider type, through which you can get the current query provider. <br>  The IQueryProvider interface provides CreateQuery (Expression expression) methods for decorating the lower level expression and Execute (Expression expression) for querying the data source. <br>  All Linq methods can be divided into two groups: <br><ul><li>  Decorator methods that wrap the expression of the previous IQueryable object (Where (), Select (), OrderBy (), etc.).  The decorator methods use the CreateQuery () method of the IQueryProvider object and return IQueryable. <br></li><li>  Processor methods that execute the query (Count (), First (), Last (), Sum (), etc.). <br>  Processor methods use the IQueryProvider object's Execute () method and return the result. </li></ul><br>  Calling the session.Query () method returns an object of type NhQueryable, whose Provider property is denoted by an object of type INhQueryProvider. <br>  A strongly simplified implementation of NhQueryable looks like this. <br><div class="spoiler">  <b class="spoiler_title">NhQueryable</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">NhQueryable</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">QueryableBase</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NhQueryable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ISessionImplementor session</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//     INhQueryProvider Provider = QueryProviderFactory.CreateQueryProvider(session); //     . Expression = Expression.Constant(this); } }</span></span></code> </pre><br></div></div><br>  Further wrapping the NhQueryable object with methods from the System.Linq.Queryable class (such as Where, Select, Skip, Take, etc.) will use the same data provider that was created in the NhQueryable object. <br><img src="https://habrastorage.org/files/ddb/5cf/449/ddb5cf449b254d52ac1dea416a98ae07.png"><br><a name="LinqWithoutSession"></a><br><h2>  3. Linq requests without an ISession object </h2><br>  Unlinking a request from a session involves getting rid of the call to Session.Query () and NhQueryable in the root of the expression tree, respectively.  In order to be able to use linq, a stub source is needed that returns an IQueryable object. <br>  Define it: <br><div class="spoiler">  <b class="spoiler_title">RemoteQueryable</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RemoteQueryable</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">IQueryable</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Expression Expression { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Type ElementType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IQueryProvider Provider { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoteQueryable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Expression = Expression.Constant(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } }</code> </pre><br></div></div><br>  Now we can write something like: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RemoteQueryable&lt;Entity&gt;().Where(e =&gt; e.IsMaster);</code> </pre><br>  For ease of use, let's wrap the creation of a query into a repository class: <br><div class="spoiler">  <b class="spoiler_title">Remoterepository</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RemoteRepository</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IQueryable&lt;TResult&gt; CreateQuery&lt;TResult&gt;(IChannelProvider provider) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RemoteQueryable&lt;TResult&gt;(provider); } }</code> </pre><br></div></div><br>  Now write about this code <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = RemoteRepository.CreateQuery&lt;Entity&gt;() .Where(e =&gt; e.IsMaster) .Where(e =&gt; e.IsActive);</code> </pre><br>  and referring to the Expression property of the query object, we get the following expression tree: <br><img src="https://habrastorage.org/files/c85/ee5/a68/c85ee5a684fd4ec39703e3d791960765.png"><br>  Above, I wrote that the expression tree can be edited at runtime, so we can bypass the resulting tree and replace the MockDataSource with NhQueryable.  NhQueryable can be obtained by calling session.Query (). <br>  To perform a tree traversal, use the Visitor pattern.  In order not to write the expression tree visitor "from scratch", we use <a href="https://msdn.microsoft.com/en-us/library/bb882521(v%3Dvs.90).aspx">this basic implementation</a> .  In the successor, override the VisitConstant and VisitMethodCall methods, and also override the Visit method, which will be the access point for editing the expression: <br><div class="spoiler">  <b class="spoiler_title">NhibernateExpressionVisitor</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">NhibernateExpressionVisitor</span></span> : <span class="hljs-title"><span class="hljs-title">ExpressionVisitor</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> IQueryable queryableRoot; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> new Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Visit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Expression sourceExpression, IQueryable queryableRoot</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.queryableRoot= queryableRoot; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Visit(sourceExpression); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VisitMethodCall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MethodCallExpression m</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = m; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> constantArgument = query.Arguments.FirstOrDefault(e =&gt; e <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> ConstantExpression &amp;&amp; e.Type.IsGenericType &amp;&amp; e.Type.GetGenericTypeDefinition() == <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(EnumerableQuery&lt;&gt;)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (constantArgument != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> constantArgumentPosition = query.Arguments.IndexOf(constantArgument); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newArguments = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Expression[query.Arguments.Count]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index = <span class="hljs-number"><span class="hljs-number">0</span></span>; index &lt; newArguments.Length; index++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (index != constantArgumentPosition) newArguments[index] = query.Arguments[index]; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> newArguments[index] = queryableRoot.Expression; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Expression.Call(query.Object, query.Method, newArguments); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.VisitMethodCall(query); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VisitConstant</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ConstantExpression c</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c.Type.IsGenericType &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(RemoteQueryable&lt;&gt;).IsAssignableFrom(c.Type.GetGenericTypeDefinition())) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> queryableRoot.Expression; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c; } }</code> </pre><br></div></div><br>  How to use it: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = RemoteRepository.CreateQuery&lt;Entity&gt;() .Where(e =&gt; e.IsMaster) .Where(e =&gt; e.IsActive); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> session = CreateSession()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nhQueryable = session.Query&lt;Entity&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nhQueryableWithExternalQuery = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NhibernateExpressionVisitor().Visit(query.Expression, nhQueryable); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = nhQueryable.Provider.Execute(nhQueryableWithExternalQuery); }</code> </pre><br>  On the line new NhibernateExpressionVisitor (). Visit (query.Expression, nhQueryable), the RemoteQueryable stub was replaced with NhQueryable. <br><img src="https://habrastorage.org/files/d68/c1a/566/d68c1a5668924332a26fab6cf4446879.png"><br>  By themselves, such gestures are not reasonable, if the code that collects such an expression is dynamically in the same process with NHibernate, then we will look at how to render the code generating the linq request from the fake source to an external process. <br><br><a name="LinqFromExternalProcess"></a><br><h2>  4. Linq database query through NHibernate from external process </h2><br>  The process from which requests come, let's call it ‚Äúclient‚Äù, and the process that executes requests is ‚Äúserver‚Äù <br><br><h4>  Client part </h4><br>  For the full implementation of linq, it is necessary to define a client request provider that will provide a fake stub.  But before we define the interface through which you can access the server process: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IChannelProvider</span></span> { T SendRequest&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> request); }</code> </pre><br>  The responsibility for the process of serialization of the query results (objects or collections of objects) will be assigned to the transport layer, or rather to the implementation of IChannelProvider.  Next, you need to modify the RemoteQueryable constructor and the RemoteRepository class so that you can pass the server process data provider (IChannelProvider) to these classes <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoteQueryable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IChannelProvider channelProvider</span></span></span><span class="hljs-function">)</span></span> { Expression = Expression.Constant(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); Provider = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RemoteQueryableProvider&lt;T&gt;(channelProvider); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IQueryable&lt;TResult&gt; CreateQuery&lt;TResult&gt;(IChannelProvider provider) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RemoteQueryable&lt;TResult&gt;(provider); }</code> </pre><br>  To simplify the process of sending the request, we will give it to the transport level as a string.  Next, we define the client query provider (RemoteQueryableProvider) with the IQueryProvider interface, as well as the DTO class (QueryDto) to send the request to the server: <br><div class="spoiler">  <b class="spoiler_title">RemoteQueryProvider</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RemoteQueryProvider</span></span> : <span class="hljs-title"><span class="hljs-title">IQueryProvider</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IQueryable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateQuery</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Expression expression</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> enumerableQuery = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EnumerableQuery&lt;T&gt;(expression); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resultQueryable = ((IQueryProvider)enumerableQuery).CreateQuery(expression); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RemoteQueryable&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, resultQueryable.Expression); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IQueryable&lt;TElement&gt; CreateQuery&lt;TElement&gt;(Expression expression) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> enumerableQuery = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EnumerableQuery&lt;TElement&gt;(expression); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resultQueryable = ((IQueryProvider)enumerableQuery).CreateQuery&lt;TElement&gt;(expression); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RemoteQueryable&lt;TElement&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, resultQueryable.Expression); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Expression expression</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serializedQuery = SerializeQuery(expression); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> channelProvider.SendRequest&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(serializedQuery); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TResult Execute&lt;TResult&gt;(Expression expression) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serializedQuery = SerializeQuery(expression); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.channelProvider.SendRequest&lt;TResult&gt;(serializedQuery); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoteQueryableProvider</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IChannelProvider channelProvider</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.channelProvider = channelProvider; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SerializeQuery</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Expression expression</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newQueryDto = QueryDto.CreateMessage(expression, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serializedQuery = JsonConvert.SerializeObject(newQueryDto, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonSerializerSettings { ReferenceLoopHandling = ReferenceLoopHandling.Ignore, TypeNameHandling = TypeNameHandling.All }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> serializedQuery; } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Queryery to</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">QueryDto</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ExpressionNode SerializedExpression { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> RequestedTypeName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> RequestedTypeAssemblyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">QueryDtoCreateMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Expression expression, Type type</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serializedExpression = expression.ToExpressionNode(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QueryDto(serializedExpression, type.FullName, type.Assembly.FullName); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">QueryDto</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ExpressionNode serializedExpression, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> requestedTypeName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> requestedTypeAssemblyName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SerializedExpression = serializedExpression; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.RequestedTypeName = requestedTypeName; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.RequestedTypeAssemblyName = requestedTypeAssemblyName; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">QueryDto</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } }</code> </pre><br></div></div><br>  The factory method QueryDto.CreateMessage () serializes the resulting expression using the <a href="">Serialize.Linq</a> library.  The QueryDto class also contains the RequestedTypeName and RequestedTypeAssemblyName properties to identify the type of entity being requested and to properly restore the expression on the server.  The very object of the QueryDto class is serialized into a string using the <a href="http://www.newtonsoft.com/json">Json.NET</a> library.  The serialized request is transmitted to the server via the IChannelProvider proxy object. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  The devil is in the details </h4><br>  <u>1. Handling closures in an expression.</u> <br>  In the <a href="https://habr.com/ru/post/302594/">Linq</a> section <a href="https://habr.com/ru/post/302594/">in Nhibernate,</a> it was not by chance <a href="https://habr.com/ru/post/302594/">that</a> I mentioned the process of calculating closures in expressions.  Since the formation of the request is now in an external process, before sending the request, it is necessary to calculate the values ‚Äã‚Äãof the closures in the constructed expression.  We are interested in (so far) only closures in predicates for example. <br><div class="spoiler">  <b class="spoiler_title">Pseudocode</b> <div class="spoiler_text"><pre> <code class="cs hljs">RemoteRepository.Query&lt;WorkItem&gt;() .Where(w =&gt; w.Priority == EnvironmentSettings.MaxPriority)) <span class="hljs-comment"><span class="hljs-comment">//   EnvironmentSettings</span></span></code> </pre><br></div></div><br>  To calculate the value of the links and convert the values ‚Äã‚Äãto ConstantExpression, we will write a client-side ExpressionVisitor, which will modify the expression <br><div class="spoiler">  <b class="spoiler_title">ClientExpressionVisitor</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ClientExpressionVisitor</span></span> : <span class="hljs-title"><span class="hljs-title">ExpressionVisitor</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Evaluate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Expression expression</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.Visit(expression); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EvaluateIfNeed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Expression expression</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> memberExpression = expression <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> MemberExpression; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (memberExpression != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (memberExpression.Expression <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> ParameterExpression) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> expression; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rightValue = GetValue(memberExpression); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Expression.Constant(rightValue); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> methodCallExpression = expression <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> MethodCallExpression; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodCallExpression != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> obj = ((ConstantExpression)methodCallExpression.Object).Value; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = methodCallExpression.Method.Invoke(obj, methodCallExpression.Arguments.Select(ResolveArgument).ToArray()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Expression.Constant(result); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> expression; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VisitBinary</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">BinaryExpression b</span></span></span><span class="hljs-function">)</span></span> { Expression left = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.EvaluateIfNeed(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Visit(b.Left)); Expression right = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.EvaluateIfNeed(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Visit(b.Right)); Expression conversion = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Visit(b.Conversion); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (left != b.Left || right != b.Right || conversion != b.Conversion) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (b.NodeType == ExpressionType.Coalesce &amp;&amp; b.Conversion != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Expression.Coalesce(left, right, conversion <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> LambdaExpression); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Expression.MakeBinary(b.NodeType, left, right, b.IsLiftedToNull, b.Method); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> b; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ResolveArgument</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Expression exp</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> constantExp = exp <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ConstantExpression; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (constantExp != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> constantExp.Value; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> memberExp = exp <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> MemberExpression; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (memberExp != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetValue(memberExp); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MemberExpression exp</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> constantExpression = exp.Expression <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ConstantExpression; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (constantExpression != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> member = constantExpression.Value .GetType() .GetMember(exp.Member.Name) .First(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fieldInfo = member <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> FieldInfo; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldInfo != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldInfo.GetValue(constantExpression.Value); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> propertyInfo = member <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> PropertyInfo; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (propertyInfo != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> propertyInfo.GetValue(constantExpression.Value); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> expression = exp.Expression <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> MemberExpression; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (expression != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetValue(expression); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> </pre><br></div></div><br>  and modify the Execute methods of the RemoteQueryableProvider class, taking into account the functionality of the ClientExpressionVisitor <br><div class="spoiler">  <b class="spoiler_title">RemoteQueryableProvider methods</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Expression expression</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> partialEvaluatedExpression = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.expressionEvaluator.Evaluate(expression); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serializedQuery = SerializeQuery(partialEvaluatedExpression); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> channelProvider.SendRequest&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(serializedQuery); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TResult Execute&lt;TResult&gt;(Expression expression) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> partialEvaluatedExpression = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.expressionEvaluator.Evaluate(expression); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serializedQuery = SerializeQuery(partialEvaluatedExpression); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.channelProvider.SendRequest&lt;TResult&gt;(serializedQuery); }</code> </pre><br></div></div><br><br>  <u>2. The use of entity properties in queries that are not specified in the mapping.</u> <br>  If in NHibernate we write a condition of the form Where (x =&gt; x.UnmappedProperty == 4)), then the validator of the NHibernate query will not miss such an expression.  To solve this problem, we introduce API post requests, i.e.  queries to the data that have already been received as a result of sql-selection. <br><div class="spoiler">  <b class="spoiler_title">Postqueryable</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PostQueryable</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">BaseQueryable</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PostQueryable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IChannelProvider channelProvider</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">channelProvider</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PostQueryable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">AbstractQueryProvider provider, Expression expression</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">provider, expression</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PostQueryable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Expression = Expression.Constant(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } }</code> </pre><br></div></div><br>  and extension for easy query wrapping <br><div class="spoiler">  <b class="spoiler_title">Ex</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Ex</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IQueryable&lt;T&gt; PostQuery&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> IQueryable&lt;T&gt; sourceQuery) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = Expression .Call(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> (PostQueryable&lt;T&gt;).GetMethod(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(PostQueryable&lt;T&gt;.WrapQuery)), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> [] {sourceQuery.Expression}); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sourceQuery.Provider.CreateQuery&lt;T&gt;(query); } }</code> </pre><br></div></div><br>  Now you can write a query like: <br><div class="spoiler">  <b class="spoiler_title">Pseudocode</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> stateCoefficient = <span class="hljs-number"><span class="hljs-number">0.9</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ageLimitInCurrentState = <span class="hljs-number"><span class="hljs-number">18</span></span> * stateCoefficient; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> availableMovies = session .Query&lt;Movie&gt;() .Where(m =&gt; m.AgeLimit &gt;= ageLimitInCurrentState) .PostQuery() .Where(m =&gt; m.RatingInCurrentState &gt; <span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-comment"><span class="hljs-comment">// unmapped- RatingInCurrentState .ToList()</span></span></code> </pre><br></div></div><br>  and send it to the server. <br><br><h4>  Server part </h4><br>  Both server and client code must be in the same assembly, but the code contains references to types from the NHibernate assembly.  It is necessary to untie the extra dependency for the client.  We write a helper for working with Nhibernate types to remove the hard link to the Nhibernate.dll assembly.  The very same assembly NHibernate.dll on the server side will be loaded via Reflection. <br><div class="spoiler">  <b class="spoiler_title">NHibernateTypesHelper</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">NHibernateTypesHelper</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Assembly nhibernateAssembly; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Type SessionType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Type LinqExtensionType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsSessionObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> inspectedObject</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SessionType.IsInstanceOfType(inspectedObject); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NHibernateTypesHelper</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { nhibernateAssembly = AppDomain.CurrentDomain.GetAssemblies() .FirstOrDefault(asm =&gt; asm.FullName.Contains(<span class="hljs-string"><span class="hljs-string">"NHibernate"</span></span>)) ?? Assembly.Load(<span class="hljs-string"><span class="hljs-string">"NHibernate"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nhibernateAssembly == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-string"><span class="hljs-string">"Caller invoking server-side types, but the NHibernate.dll not found in current application domain"</span></span>); SessionType = nhibernateAssembly.GetTypes() .Single(p =&gt; p.FullName.Equals(<span class="hljs-string"><span class="hljs-string">"NHibernate.ISession"</span></span>, StringComparison.OrdinalIgnoreCase)); LinqExtensionType = nhibernateAssembly.GetTypes() Single(p =&gt; p.FullName.Equals(<span class="hljs-string"><span class="hljs-string">"NHibernate.Linq.LinqExtensionMethods"</span></span>, StringComparison.OrdinalIgnoreCase)); } }</code> </pre><br></div></div><br>  On the server side, we define the RemoteQueryExecutor class, which will accept the serialized QueryDto, restore it, and execute it: <br><div class="spoiler">  <b class="spoiler_title">RemoteQueryExecutor</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RemoteQueryExecutor</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Do</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> serializedQueryDto, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sessionObject</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> internalRemoteQuery = DeserializeQueryDto(serializedQueryDto); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> deserializedQuery = DeserializedQueryExpressionAndValidate(internalRemoteQuery); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> targetType = ResolveType(internalRemoteQuery); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Execute(deserializedQuery, targetType, sessionObject); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> TypeInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ResolveType</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">QueryDto internalRemoteQuery</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> targetAssemblyName = internalRemoteQuery.RequestedTypeAssemblyName; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> targetAssembly = GetAssemblyOrThrownEx(internalRemoteQuery, targetAssemblyName); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> targetType = GetTypeFromAssemblyOrThrownEx(targetAssembly, internalRemoteQuery.RequestedTypeName, targetAssemblyName); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> targetType; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeserializedQueryExpression</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">QueryDto internalRemoteQuery</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> deserializedQuery = internalRemoteQuery.SerializedExpression.ToExpression(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> deserializedQuery; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> TypeInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetTypeFromAssemblyOrThrownEx</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Assembly targetAssembly, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> requestedTypeName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> targetAssemblyName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> targetType = targetAssembly.DefinedTypes .FirstOrDefault(type =&gt; type.FullName.Equals(requestedTypeName, StringComparison.OrdinalIgnoreCase)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (targetType == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"Type with name '{0}' not found in assembly '{1}'"</span></span>, requestedTypeName, targetAssemblyName)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> targetType; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Assembly </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAssemblyOrThrownEx</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">QueryDto internalRemoteQuery, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> targetAssemblyName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> targetAssembly = AppDomain.CurrentDomain.GetAssemblies() .FirstOrDefault(asm =&gt; asm.FullName.Equals(internalRemoteQuery.RequestedTypeAssemblyName, StringComparison.OrdinalIgnoreCase)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (targetAssembly == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"Assembly with name '{0}' not found in server app domain"</span></span>, targetAssemblyName)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> targetAssembly; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> QueryDto </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeserializeQueryDto</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> serializedQueryDto</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> internalRemoteQuery = JsonConvert .DeserializeObject&lt;QueryDto&gt;(serializedQueryDto, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonSerializerSettings { ReferenceLoopHandling = ReferenceLoopHandling.Ignore, TypeNameHandling = TypeNameHandling.All }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> internalRemoteQuery; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Expression expression, Type targetType, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sessionObject</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> queryable = GetNhQueryableFromSession(targetType, sessionObject); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nhibernatePartialExpression = ExpressionModifier.GetNhibernatePartialExpression(expression, queryable); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resultFromStorage = queryable.Provider.Execute(nhibernatePartialExpression); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> requestedCollection = resultFromStorage <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IEnumerable&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (requestedCollection == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resultFromStorage; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resultCollectionType = requestedCollection.GetType(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (resultCollectionType.IsGenericType) targetType = resultCollectionType.GetGenericArguments().Single(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> enumerableQueryable = (IQueryable)Activator .CreateInstance(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(EnumerableQuery&lt;&gt;).MakeGenericType(targetType), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { requestedCollection }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> postQueryPartialExpression = ExpressionModifier .GetPostQueryPartialExpression(expression, enumerableQueryable); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (postQueryPartialExpression == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resultFromStorage; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> enumerableQueryable.Provider.Execute(postQueryPartialExpression); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IQueryable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNhQueryableFromSession</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type targetType, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sessionObject</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> finalQueryMethod = ResolveQueryMethod(targetType); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> queryable = (IQueryable) finalQueryMethod.Invoke(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] {sessionObject}); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> queryable; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> MethodInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ResolveQueryMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type targetType</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> queryMethod = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(LinqExtensionMethods).GetMethods(BindingFlags.Public | BindingFlags.Static) .Where(m =&gt; m.IsGenericMethod) .Where(m =&gt; m.Name.Equals(<span class="hljs-string"><span class="hljs-string">"Query"</span></span>)) .Single(m =&gt; m.GetParameters().Length == <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; NHibernateTypesHelper.SessionType.IsAssignableFrom(m.GetParameters().First().ParameterType)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> finalQueryMethod = queryMethod.MakeGenericMethod(targetType); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> finalQueryMethod; } }</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After receiving the request, on the server we restore QueryDto with the Json.NET deserializer. </font><font style="vertical-align: inherit;">The serialized expression inside the DTO object is restored using the </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serialize.Linq</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> library </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Then we modify the expression with the help of the NhibernateExpressionVisitor visitor - we replace the fake root with NhQueryable, as explained above. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The resulting expression is divided into two queries:</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Directly query to the database </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Query the results of the sample from the database </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The query to the database will work according to the already known scheme, without compilation. </font><font style="vertical-align: inherit;">The query to the results of the sample is compiled and processes the objects by the methods specified in the expressions. </font><font style="vertical-align: inherit;">The query for the results of the previous query is compiled and executed as a regular EnumerableQuery.</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Request drawings</font></font></b> <div class="spoiler_text"><img src="https://habrastorage.org/files/091/c96/2de/091c962de1fa4215a2123d041c1cc69c.png"><br></div></div><br><a name="HowItUse"></a><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 5. We write test application </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We implement a test client-server application. </font><font style="vertical-align: inherit;">For the client side, we use the WPF technology, on the server side, we will use SQLite as the database, for communication between the processes, we will use WCF with HTTP bindings. </font><font style="vertical-align: inherit;">As an object model, use the WorkItem class.</font></font><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">DataContract</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WorkItem</span></span> : <span class="hljs-title"><span class="hljs-title">BaseEntity</span></span> { [DataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [DataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Priority { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Behind the scenes, leave the NHibernate mapping setting and the nhibernate.cfg.xml configuration, as well as the WCF setting for data transfer and set the goal - to display 200 WorkItem objects in the ListView, loading data from the database as necessary. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WPF for lists provides a mechanism for data virtualization at the UI layer, which can be further developed for virtualization at the level of the ViewModel data collection. </font><font style="vertical-align: inherit;">We take the example from </font></font><a href="https://habrahabr.ru/post/208792/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this article as a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> basis </font><font style="vertical-align: inherit;">and modify the example for paging downloading data from the database to the client.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We implement our IItemsProvider and replace the implementation from the example with our class DemoWorkItemProvider. </font><font style="vertical-align: inherit;">In the FetchCount () and FetchRange () methods, we will use Linq queries using the RemoteQueryable API. </font><font style="vertical-align: inherit;">In the FetchRange method, we specify a query only for the range of data that is required for display.</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DemoWorkItemProvider</font></font></b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DemoWorkItemProvider</span></span> : <span class="hljs-title"><span class="hljs-title">IItemsProvider</span></span>&lt;<span class="hljs-title"><span class="hljs-title">WorkItem</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FetchCount</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RemoteRepository.CreateQuery&lt;WorkItem&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DemoChannelProvider()) .Count(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IList&lt;WorkItem&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FetchRange</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> startIndex, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RemoteRepository.CreateQuery&lt;WorkItem&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DemoChannelProvider()) .Skip(startIndex) .Take(count) .ToList(); } }</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Few rule UI and ListView style for displaying WorkItem. </font><font style="vertical-align: inherit;">We start the server and the client, when clicking on the Refresh button, the client sends a Linq request for the number of items and two subsequent requests for receiving the first and second pages of the list to the server. </font><font style="vertical-align: inherit;">When scrolling down the list, the next page is loaded from the database via the </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RemoteQueryablyProvider -&gt; WCF -&gt; HTTP -&gt; WCF -&gt; RemoteQueryExecutor -&gt; NHibernate -&gt; SQLite </font><font style="vertical-align: inherit;">chain</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Demonstration of work</font></font></b> <div class="spoiler_text"><img src="https://habrastorage.org/files/658/f7b/c00/658f7bc007d646c992daf2ebb9096d96.gif"><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pros of the RemoteQueryable API: </font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1. Clean and clear code in the FetchRange and FetchCount methods </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2. The ability to build dynamic queries on the client using Dynamic.Linq (for example, to filter data in tables) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 3. The one and only WCF service method for processing a request. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 4. Optimization of data retrieval - from the database only those records that were actually requested by the client will be selected. </font></font></li></ul><br><a name="Resume"></a><br><h2>  Conclusion </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On this, perhaps, you can stop. </font><font style="vertical-align: inherit;">The next step may be to modify the request on the server side, taking into account user authorization or optimization of the code that works with Reflection, or the connection Dynamic.Linq, but this is the topic of a separate article.</font></font><br><a name="Links"></a><br><h2>  Links </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. </font></font><a href="https://github.com/MaximVanyushkin/Sharp.RemoteQueryable"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repositories with code and examples from the article on GitHub</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2. </font></font><a href="https://habrahabr.ru/post/108407/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IEnumerable and IQueryable, what is the difference? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. </font></font></a> <a href="https://habrahabr.ru/post/256821"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Principles of operation of IQueryable and LINQ data providers</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 4. </font></font><a href="http://sergeyteplyakov.blogspot.ru/2010/04/c.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Closures in the C # programming language</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 5. </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serialize.Linq </font></font></a> <font style="vertical-align: inherit;"><a href="https://relinq.codeplex.com/"><font style="vertical-align: inherit;">source codes</font></a></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 6. </font></font><a href="https://github.com/nhibernate/nhibernate-core"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NHibernate sources</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 7. </font></font><a href="https://relinq.codeplex.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remotion.Linq on codeplex</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 8. </font></font><a href="https://msdn.microsoft.com/ru-ru/library/system.linq.iqueryprovider(v%3Dvs.110).aspx"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IQueryProvider on MSDN</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 9. </font></font><a href="https://msdn.microsoft.com/en-us/library/bb882521(v%3Dvs.90).aspx"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to: Implement an Expression Tree Visitor</font></font></a> </div><p>Source: <a href="https://habr.com/ru/post/302594/">https://habr.com/ru/post/302594/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302568/index.html">Already 2016, and the future does not come. Who is to blame and what to do?</a></li>
<li><a href="../302570/index.html">Write the code as if it would be accompanied by a violent psychopath who knows where you live.</a></li>
<li><a href="../302576/index.html">Tony Robbins seminar review ‚ÄúFree your inner strength‚Äù. Day 2: Turning dreams into reality (part 2)</a></li>
<li><a href="../302580/index.html">How I caught a Wi-Fi printer via OSPF, corporate network on MikroTik part 2</a></li>
<li><a href="../302590/index.html">Launch queues and the Laravel scheduler in the Elastic Beanstalk environment</a></li>
<li><a href="../302598/index.html">SMS as a secret weapon</a></li>
<li><a href="../302600/index.html">BGP Inter-AS</a></li>
<li><a href="../302602/index.html">Creating a blog on symfony 2.8 lts [Part 4]</a></li>
<li><a href="../302606/index.html">About the three-dimensional Z-order put in a word</a></li>
<li><a href="../302608/index.html">Create a secure IP messenger with Virgil and Twilio in 30 minutes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>