<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A couple of ways to send notifications to your smartphone from your server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this tutorial, I will consider step by step how to send notifications from my server to my (or not) smartphone, what means will be needed for this....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A couple of ways to send notifications to your smartphone from your server</h1><div class="post__text post__text-html js-mediator-article">  In this tutorial, I will consider step by step how to send notifications from my server to my (or not) smartphone, what means will be needed for this.  These methods are universal and suitable for any programming language, since  directly use the Google API, without the use of libraries.  You can send to smartphones with Android, iOS and browsers with support for Push API (today it is Chrome, Firefox and their derivatives). <br><br>  In general, all those who have long wanted to send notifications from their home server to their smartphone, but did not know where to start, is dedicated. <br><a name="habracut"></a><br>  A bit of history.  At the beginning (from Android version 2.2), Google used the C2DM system (Android Cloud to Device Messaging) for delivery, since June 2012 they began to suggest using <a href="https://en.wikipedia.org/wiki/Google_Cloud_Messaging">GCM</a> (Google cloud messaging) for this. <br><br>  At present, the universal <a href="https://en.wikipedia.org/wiki/Firebase_Cloud_Messaging">Firebase</a> platform is used, which, in addition to the delivery of notifications, has many other possibilities.  Firebase also managed to evolve and the first generation protocol is already considered obsolete and it is recommended to use the second generation protocol for message delivery. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Technically, notifications are sent from the server not directly to the smartphone, but to a certain intermediate server, where they are stored for up to 4 weeks if necessary (configurable), and, if possible, are sent to the recipient.  Those.  if the smartphone is offline, the server is waiting.  As soon as the opportunity arises, it sends. <br><br><h3>  1. Registering in Firebase </h3><br>  To register with <a href="https://firebase.google.com/">Firebase, you</a> need a Google account. <br><br><img src="https://habrastorage.org/webt/6f/pe/yc/6fpeycrg-ifovp9edicahxt8l9a.png"><br><br>  Click "Go to console". <br><br><img src="https://habrastorage.org/webt/51/8p/kv/518pkvycwiazsvmnvyyz8j1bts8.png"><br><br>  Then "Add project". <br><br><img src="https://habrastorage.org/webt/im/ge/j1/imgej1_kyvqfsefsqetyxbcpcoi.png"><br><br>  Enter the name of the project.  I recommend in the range of 8-16 characters. <br>  Choose a country.  Click "Create a project." <br><br><h3>  2. Configure Firebase </h3><br><img src="https://habrastorage.org/webt/0f/sw/pi/0fswpisfpmdbto5i2c_r-rk2y38.png"><br><br>  Scroll to the block "Notifications", click "Start." <br><br>  You will be prompted to select the application for which your notifications will be sent. <br><br><img src="https://habrastorage.org/webt/g8/zc/oo/g8zcoopkeqw-kthksdb5zfujah0.png"><br><br>  Steps for the Andriod application: <br><br><img src="https://habrastorage.org/webt/as/rx/ww/asrxwwfw19ytfvhwhu80vdjqrba.png"><br><br>  Step 1 - Enter the name of the project on Andriod. <br>  Click "Register an application." <br><br><img src="https://habrastorage.org/webt/ah/yr/ii/ahyriiuo1gecrwd4rji7vogxj7m.png"><br><br>  Step 2 - Click "Download google-services.com". <br>  Add the downloaded configuration file to the project, next to the build.gradle file (the one that is personal for the application). <br>  Click "Continue." <br><br><img src="https://habrastorage.org/webt/fk/f9/n8/fkf9n87navfkq6uke4x4_9ivmni.png"><br><br>  Step 3 - Add dependencies to the project. <br>  in the /build.gradle line <br>  <b>classpath 'com.google.gms: google-services: 3.1.0'</b> <br>  in the file /&lt;app-module&gt;/build.gradle line <br>  <b>apply plugin: 'com.google.gms.google-services'</b> <br>  That's all, click "Finish." <br><br>  <s>After setting up the application, you can immediately test whether the connection works by sending a test message (no, it‚Äôs not, we don‚Äôt have a client ID where to send it).</s> <br><br><h3>  3. Setting up the Android application to receive notifications. </h3><br>  <i>Important note: some shells, such as MIUI, may block notifications if the application is not running or not hanging in the background.</i>  <i>This is done ostensibly to save battery power.</i> <br><br>  Roughly speaking, you can send two types of notifications: <br>  - notification on request, <br>  - notification with payload. <br>  They have different ways to interact with the application. <br><br>  Notification on request will display a notification in the notification area, but only if the application is minimized.  When the user clicks it, it will open the application pre-selected (when sending), and transfer the extra parameters to the bundle. <br><br>  A notification with a payload requires that the application has a pair of services to which control is transferred, but for a duration not longer than 10 seconds. <br><br>  Below is an example of a service that is responsible for generating a client ID. <br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> ru.pyur.loga; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.util.Log; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.firebase.iid.FirebaseInstanceId; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.firebase.iid.FirebaseInstanceIdService; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestFirebaseInstanceIdService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FirebaseInstanceIdService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String TAG = <span class="hljs-string"><span class="hljs-string">"TestFbseInstIdSvc"</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onTokenRefresh</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ String refreshedToken = FirebaseInstanceId.getInstance().getToken(); Log.d(TAG, <span class="hljs-string"><span class="hljs-string">"Refreshed token: "</span></span> + refreshedToken); <span class="hljs-comment"><span class="hljs-comment">//~sendRegistrationToServer(refreshedToken); } }</span></span></code> </pre> <br><br>  And an example of the service code that receives messages.  The application must be running, or hang in the background, otherwise the reception of messages is not guaranteed.  Some shells, such as MIUI, in order to save, cut everything, including the privileges of background services. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> ru.pyur.loga; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.app.Notification; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.app.NotificationManager; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.content.Context; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.support.v4.app.NotificationCompat; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.util.Log; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.firebase.messaging.FirebaseMessagingService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.firebase.messaging.RemoteMessage; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> ru.pyur.loga.AcMain.context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestFirebaseMessagingService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FirebaseMessagingService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String TAG = <span class="hljs-string"><span class="hljs-string">"TestFbseMsgngSvc"</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMessageReceived</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RemoteMessage remoteMessage)</span></span></span><span class="hljs-function"> </span></span>{ Log.d(TAG, <span class="hljs-string"><span class="hljs-string">"From: "</span></span> + remoteMessage.getFrom()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (remoteMessage.getData().size() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { Log.d(TAG, <span class="hljs-string"><span class="hljs-string">"Message data payload: "</span></span> + remoteMessage.getData()); String val1 = remoteMessage.getData().get(<span class="hljs-string"><span class="hljs-string">"val1"</span></span>); String val2 = remoteMessage.getData().get(<span class="hljs-string"><span class="hljs-string">"val2"</span></span>); String val3 = remoteMessage.getData().get(<span class="hljs-string"><span class="hljs-string">"val3"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> color = (<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;<span class="hljs-number"><span class="hljs-number">16</span></span>)|(<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;<span class="hljs-number"><span class="hljs-number">8</span></span>)|(<span class="hljs-number"><span class="hljs-number">0</span></span>); ShowNotification(val1, val2, color); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (remoteMessage.getNotification() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Log.d(TAG, <span class="hljs-string"><span class="hljs-string">"Message Notification Body: "</span></span> + remoteMessage.getNotification().getBody()); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDeletedMessages</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// In some situations, FCM may not deliver a message. This occurs when there are too many messages (&gt;100) pending for your app on a particular device // at the time it connects or if the device hasn't connected to FCM in more than one month. In these cases, you may receive a callback // to FirebaseMessagingService.onDeletedMessages() When the app instance receives this callback, it should perform a full sync with your app server. // If you haven't sent a message to the app on that device within the last 4 weeks, FCM won't call onDeletedMessages(). } void ShowNotification(String title, String text, int color) { NotificationCompat.Builder mNotify = new NotificationCompat.Builder(context, ""); mNotify.setLights(color, 100, 200); mNotify.setSmallIcon(R.drawable.service_icon); mNotify.setContentTitle(title); mNotify.setContentText(text); mNotify.setDefaults(Notification.DEFAULT_SOUND); NotificationManager mNotificationManager = (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE); int mId = 1001; try { mNotificationManager.notify(mId, mNotify.build()); } catch (Exception e) { e.printStackTrace(); } } }</span></span></code> </pre><br><br>  do not forget to register the service in the manifest. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".TestFirebaseMessagingService"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.google.firebase.MESSAGING_EVENT"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".TestFirebaseInstanceIdService"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.google.firebase.INSTANCE_ID_EVENT"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Client ID is generated on the device, but you choose the method of delivering this ID to your server. <br><br>  <i>Now you can test by sending a test message from the console.</i> <br><br><img src="https://habrastorage.org/webt/el/-n/8_/el-n8_6axrzo61neipdeg2qyim8.png"><br><br><img src="https://habrastorage.org/webt/ox/8e/-x/ox8e-xzlwoasr0lp97z24qn87gy.png"><br><br><h3>  4. Send notification from your server </h3><br>  There are several ways to communicate with the Firebase server.  We will look at two ways to exchange over HTTP. <br><br><h4>  First Generation Protocol - Legacy HTTP </h4><br><img src="https://habrastorage.org/webt/o7/fu/gv/o7fugv3z-jdzjlogrrfrtlhghsi.png"><br><br>  You need the key.  We press on the nut, select the "Project Settings". <br><br><img src="https://habrastorage.org/webt/uk/ru/a-/ukrua-jjfwuwrmglv0wc63sp2hk.png"><br><br>  Cloud Messaging tab. <br>  Copy the "Outdated Server Key". <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// ------------------------ test fcm send. legacy ------------------------ // $socket = @fsockopen('ssl://fcm.googleapis.com', 443, $errno, $errstr, 10); if (!$socket) die('error: remote host is unreachable.'); // ----    ---- // $payload = '{ "to" : "cGAFgPJGf-s:APA91bF**...**aEVM17c9peqZ", "notification" : { "title" : "  ", "body" : "(Legacy API) !", "sound": "default" } }'; //  // ----    ---- // $payload = '{ "to" : "cGAFgPJGf-s:APA91bF**...**aEVM17c9peqZ", "data":{ "val1" : "  ", "val2" : "(Legacy API) !", "val3" : "-  " } }'; $send = ''; $send .= 'POST /fcm/send HTTP/1.1'."\r\n"; $send .= 'Host: fcm.googleapis.com'."\r\n"; $send .= 'Connection: close'."\r\n"; $send .= 'Content-Type: application/json'."\r\n"; $send .= 'Authorization: key=AIzaSy***************************IPSnjk'."\r\n"; $send .= 'Content-Length: '.strlen($payload)."\r\n"; $send .= "\r\n"; $send .=$payload; $result = fwrite($socket, $send); $receive = ''; while (!feof($socket)) $receive .= fread($socket, 8192); fclose($socket); echo '&lt;pre&gt;'.$receive.'&lt;/pre&gt;'; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br>  Here in the ‚Äúto‚Äù field you need to substitute the client ID.  In the http header, ‚ÄúAuthorization: key =‚Äù, substitute ‚ÄúOutdated Server Key‚Äù. <br><br><h4>  The second generation protocol is (Modern) HTTP v1. </h4><br>  (source: <a href="https://developers.google.com/identity/protocols/OAuth2ServiceAccount">developers.google.com/identity/protocols/OAuth2ServiceAccount</a> ) <br>  Do not ask why the second version of the protocol is called V1, apparently the first was considered a beta and wore a zero number. <br>  I did not go into details, but I understand this protocol is more universal and has more features than just sending notifications. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// ------------------------ test fcm send. modern ------------------------ // // --  1.  JWT -- // $JWT_header = base64_encode('{"alg":"RS256","typ":"JWT"}'); $issue_time = time(); $JWT_claim_set = base64_encode( '{"iss":"firebase-adminsdk-mvxyi@&lt;your-project&gt;.iam.gserviceaccount.com",'. '"scope":"https://www.googleapis.com/auth/firebase.messaging",'. '"aud":"https://www.googleapis.com/oauth2/v4/token",'. '"exp":'.($issue_time + 3600).','. '"iat":'.$issue_time.'}'); // .  $private_key = ' -----BEGIN PRIVATE KEY----- MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCwR1biSUCv4J4W **************************************************************** **************************************************************** ... **************************************************************** teTJImCT6sg7go7toh2ODfaPmeI0nA/LwSjzWs0b8gdIYPT5fAsvfQiND0vu/M3V 7C/z/SmIKeIcfOYrcbWQwTs= -----END PRIVATE KEY----- '; $data = $JWT_header.'.'.$JWT_claim_set; $binary_signature = ''; openssl_sign($data, $binary_signature, $private_key, 'SHA256'); $JWT_signature = base64_encode($binary_signature); $JWT = $JWT_header.'.'.$JWT_claim_set.'.'.$JWT_signature; // --  2.     -- // $socket = @fsockopen('ssl://www.googleapis.com', 443, $errno, $errstr, 10); if (!$socket) die('error: remote host is unreachable.'); $payload = 'grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Ajwt-bearer&amp;assertion='.rawurlencode($JWT); $send = ''; $send .= 'POST /oauth2/v4/token HTTP/1.1'."\r\n"; $send .= 'Host: www.googleapis.com'."\r\n"; $send .= 'Connection: close'."\r\n"; $send .= 'Content-Type: application/x-www-form-urlencoded'."\r\n"; $send .= 'Content-Length: '.strlen($payload)."\r\n"; $send .= "\r\n"; $send .= $payload; $result = fwrite($socket, $send); $receive = ''; while (!feof($socket)) $receive .= fread($socket, 8192); fclose($socket); echo '&lt;pre&gt;'.$receive.'&lt;/pre&gt;'; // -- parse answer JSON (lame) -- // $line = explode("\r\n", $receive); if ($line[0] != 'HTTP/1.1 200 OK') die($line[0]); $pos = FALSE; if (($pos = strpos($receive, "\r\n\r\n", 0)) !== FALSE ) { if (($pos = strpos($receive, "{", $pos+4)) !== FALSE ) { if (($pose = strpos($receive, "}", $pos+1)) !== FALSE ) { $post = substr($receive, $pos, ($pose - $pos+1) ); $aw = json_decode($post, TRUE); $access_token = $aw['access_token']; } else die('} not found.'); } else die('{ not found.'); } else die('\r\n\r\n not found.'); // --  3.    Firebase  -- // $socket = @fsockopen('ssl://fcm.googleapis.com', 443, $errno, $errstr, 10); if (!$socket) die('error: remote host is unreachable.'); $payload = '{ "message":{ "token" : "cGAFgPJGf-s:APA91bF**...**aEVM17c9peqZ", "notification" : { "title" : " ", "body" : "(Modern API)     Firebase!" } } }'; //  $payload = '{ "message": { "token" : "cGAFgPJGf-s:APA91bF**...**aEVM17c9peqZ", "data":{ "val1" : " ", "val2" : "(Modern API)     Firebase!", "val3" : " " } } }'; $send = ''; $send .= 'POST /v1/projects/pyur-test-id/messages:send HTTP/1.1'."\r\n"; $send .= 'Host: fcm.googleapis.com'."\r\n"; $send .= 'Connection: close'."\r\n"; $send .= 'Content-Type: application/json'."\r\n"; $send .= 'Authorization: Bearer '.$access_token."\r\n"; $send .= 'Content-Length: '.strlen($payload)."\r\n"; $send .= "\r\n"; $send .=$payload; $result = fwrite($socket, $send); $receive = ''; while (!feof($socket)) $receive .= fread($socket, 8192); fclose($socket); echo '&lt;pre&gt;'.$receive.'&lt;/pre&gt;'; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br><br><img src="https://habrastorage.org/webt/xn/ae/ga/xnaegaihh7l5xxwsjakmatwdkio.png"><br><br>  at <a href="https://console.firebase.google.com/project/poject-id/settings/serviceaccounts/adminsdk">console.firebase.google.com/project/poject-id/settings/serviceaccounts/adminsdk,</a> copy the ‚ÄúFirebase Service Account‚Äù and substitute it into the ‚Äú$ JWT_claim_set‚Äù variable in the ‚Äúiss‚Äù field. <br><br>  Click "Create a private key" <br><br><img src="https://habrastorage.org/webt/_b/rp/xp/_brpxpidslvvkhxgc7dafpjrvgm.png"><br><br>  Create a key, save, do not show it to anyone.  The downloaded file will contain the "Private key", it is substituted into the variable "$ private_key". <br><br>  Hint: the token obtained in steps 1 and 2 can and should be cached in a local temporary storage, such as a file, or a database.  And only after the time has expired (the default is one hour), request the next token from the authorization server. <br><br><img src="https://habrastorage.org/webt/la/1d/gy/la1dgypfdbovku0throlg1yj1ze.png"><br><br>  <b>Important!</b>  Before using the Modern Http API, you must explicitly allow its use here: <a href="https://console.developers.google.com/apis/library/fcm.googleapis.com/%3Fproject%3Dyour-project">console.developers.google.com/apis/library/fcm.googleapis.com/?project=your-project</a> <br><br><h4>  Bonus, additional parameters for notifications: </h4><br>  <b>sound</b> - either "default" or the name of the resource in the application.  Must be located in "/ res / raw /".  MP3 format, AAC or something else suitable. <br>  <b>icon</b> - changes the notification icon.  Must be stored in "drawable" applications.  If absent, FCM will use the application icon (specified as ‚Äúlauncher icon‚Äù in the application manifest). <br>  <b>tag</b> - Should be used to group similar notifications.  New notifications will be displayed on top of existing ones with the same tag. <br>  <b>color</b> - the color of the icon, is set as "#rrggbb" (it did not work for me in MIUI) <br>  <b>click_action</b> - activated activation, when the user <b>clicks</b> on the notification. <br><br><h3>  Conclusion </h3><br>  In the future, the API will probably change, be declared depricated, etc.  Therefore, today I think it‚Äôs worth doing right away on the HTTP v1 protocol <br><br>  It will be interesting for me to read in the comments the original ways of using notifications, in addition to new messages from the contact.  For example, I have configured monitoring of Arduina fans, and if they stop, a notification is sent. <br><br>  Yes, I know that there is Zabbix, etc., but the topic of the article is home servers, and other smart houses.  I consider corporate-class systems brute-force in amateur handicrafts. </div><p>Source: <a href="https://habr.com/ru/post/345942/">https://habr.com/ru/post/345942/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345930/index.html">PushFeed - monitoring RSS and VK feeds</a></li>
<li><a href="../345932/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ295 (December 25 - 31, 2017)</a></li>
<li><a href="../345936/index.html">How to start creating an open source project in the new year</a></li>
<li><a href="../345938/index.html">ScadaPy - creating mnemonic schemes</a></li>
<li><a href="../345940/index.html">The problem of a chess horse and probability</a></li>
<li><a href="../345944/index.html">Simula - 50 years of OOP</a></li>
<li><a href="../345946/index.html">Objective-C compliant "Swift" code</a></li>
<li><a href="../345948/index.html">Enterprise Architecture vs alchemy enterprises. Part 2. Nowhere is easier: simple framework and simple enterprise.</a></li>
<li><a href="../345950/index.html">Welcome to the era of deep neuroevolution</a></li>
<li><a href="../345954/index.html">Simplify the work with RecyclerView</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>