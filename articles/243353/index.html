<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Autoregistered Unity .net repositories for EF Code first</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hey. Let's get started 
 Motivation 

1. There is a project with the Entity framework (> = 5.0.0.0) code first. 
2. You love IoC, but you don‚Äôt like e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Autoregistered Unity .net repositories for EF Code first</h1><div class="post__text post__text-html js-mediator-article">  Hey.  Let's get started <br><h4>  Motivation </h4><ol><li>  There is a project with the Entity framework (&gt; = 5.0.0.0) code first. </li><li>  You love IoC, but you don‚Äôt like endless registrations of new entities. </li><li>  Unity is used as a container (or it is possible to spend 10 minutes on finishing the sources under your container). </li><li>  The prospect of writing the same type of code for some reason scares you. </li></ol><br>  So what this article offers.  You connect 2 nuget-packages, implement a simple IRetrievableEntity &lt;TEntity, TId&gt; interface for your Entity (you can simplify the task, inheriting from the ready-made Entity &lt;TId&gt; class), add 2 registration lines to the code and get complete DBContext independence and the possibility resolving repositories for each IRetrievableEntity entity with the ability to build object-oriented (typed) requests to these repositories.  Just look: <pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> employeeRepository = container.Resolve&lt;IRepository&lt;Emloyee, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> employees = employeeRepository.Get(q =&gt; { q = q.Filter(e =&gt; e.EmploymentDate &gt;= <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2014</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(excludeFired) q = q.Filter(e =&gt; !e.Fired); q = q.Include(e =&gt; e.Department, p =&gt; p.Department.Chief) .OrderBy(p =&gt; p.FirstName); });</code> </pre> <br><h4>  How to quickly start using </h4><a name="habracut"></a>  You can use repositories without IoC, getting bonuses for building queries and isolation from the context, but the following example and source codes will provide comprehensive information about the most productive and simple application. <br>  1. Install the <a href="https://www.nuget.org/packages/Rikrop.Core.Data/">Rikrop.Core.Data</a> and <a href="https://www.nuget.org/packages/Rikrop.Core.Data.Unity/">Rikrop.Core.Data.Unity packages</a> .  The first is in the project with Entity-entities, the second is in the project with the database context.  I used one project for example, it turned out the following: <pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">packages</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">package</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"EntityFramework"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5.0.0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">targetFramework</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"net45"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">package</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Rikrop.Core.Data"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1.0.1.0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">targetFramework</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"net45"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">package</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Rikrop.Core.Data.Unity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1.0.1.0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">targetFramework</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"net45"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">package</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Unity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"3.5.1404.0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">targetFramework</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"net45"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">packages</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  2. Add to registrations in IoC about the following: <br><pre> <code class="cs hljs">container.RegisterRepositoryContext&lt;MyDbContext&gt;(); <span class="hljs-comment"><span class="hljs-comment">//container.RegisterRepositoryContext(s =&gt; new MyDbContext(s), "myConStr"); container.RegisterRepositories(typeof(Department).Assembly);</span></span></code> </pre><br>  <a href="">RepositoryContext</a> is a wrapper over the DBContext class, respectively, registration takes a generic inheritor parameter from the DBContext.  You can register a context with the name of the connection string. <br>  The RegisterRepositories extension method takes as input the Assembly in which the POCO objects are located that implement <a href="">IRetrievableEntity &lt;TId&gt;</a> . <br><br>  3. Implement for your POCO IRetrievableEntity.  For example: <pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Department</span></span> : <span class="hljs-title"><span class="hljs-title">Entity</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Int32</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">IRetrievableEntity</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Department</span></span>, <span class="hljs-title"><span class="hljs-title">Int32</span></span>&gt; {...} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Employee</span></span> : <span class="hljs-title"><span class="hljs-title">DeactivatableEntity</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Int32</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">IRetrievableEntity</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Employee</span></span>, <span class="hljs-title"><span class="hljs-title">Int32</span></span>&gt; {...}</code> </pre><br>  4. Done.  You can use: <pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> departmentRepository = container.Resolve&lt;IRepository&lt;Department, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;&gt;(); departmentRepository.Save(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Department { Name = <span class="hljs-string"><span class="hljs-string">"TestDepartment"</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> testDeps = departmentRepository.Get(q =&gt; q.Filter(dep =&gt; dep.Name.Contains(<span class="hljs-string"><span class="hljs-string">"Test"</span></span>)));</code> </pre><br>  It is impossible to make a mistake, since generic parameters ensure that correct repositories are resolved: <pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//  IDeactivatableRepository    ( ), // ..      DeactivatableEntity. //var departmentRepository2 = container.Resolve&lt;IDeactivatableRepository&lt;Department, int&gt;&gt;();</span></span></code> </pre><br>  5. If the standard functionality offered by the <a href="">IRepository &lt;TEntity, in TId&gt;</a> and <a href="">IDeactivatableRepository &lt;TEntity, in TId&gt; interfaces</a> is not enough for any entity, you can always extend the existing implementation in a couple of simple steps.  Set the interface: <pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IPersonRepository</span></span> : <span class="hljs-title"><span class="hljs-title">IDeactivatableRepository</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Person</span></span>, <span class="hljs-title"><span class="hljs-title">int</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExtensionMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre><br>  Add the implementation and be sure to mark the attribute: <pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Repository(typeof(IPersonRepository))</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PersonRepository</span></span> : <span class="hljs-title"><span class="hljs-title">DeactivatableRepository</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Person</span></span>, <span class="hljs-title"><span class="hljs-title">int</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">IPersonRepository</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PersonRepository</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IRepositoryContext repositoryContext</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">repositoryContext</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExtensionMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//       DBContext Console.WriteLine("PersonRepository ExtensionMethod called"); } }</span></span></code> </pre><br>  We ask Unity to find and register all extended repositories in the given assembly: <pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//   ""     . container.RegisterCustomRepositories(typeof(Department).Assembly);</span></span></code> </pre><br>  We use: <pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//  ""   . var personRepository = container.Resolve&lt;IPersonRepository&gt;(); personRepository.ExtensionMethod();</span></span></code> </pre><br>  In this case, without the need for advanced methods, you can always use the standard implementation: <pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//   Person     ,     DeactivatableEntity. var personRepository2 = container.Resolve&lt;IRepository&lt;Person, int&gt;&gt;(); var personRepository3 = container.Resolve&lt;IDeactivatableRepository&lt;Person, int&gt;&gt;();</span></span></code> </pre><br><br><h4>  How it works </h4>  There is a <a href="">basic</a> repository <a href="">implementation</a> that works with the context through the abstraction IRepositoryContext.  Accessing the data set from the repository works thanks to generic DBContext methods: <pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> DbSet&lt;TEntity&gt; Data { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Context.Set&lt;TEntity&gt;(); } }</code> </pre><br>  The key class for working with building queries to the repository is the <a href="">RepositoryQuery</a> class.  The class implements the fluent interface and allows you to include by Expression or text path (the latter may be relevant when loading the properties of the child collections when the path cannot be specified via expression), filter, sort, Skip and Take. <br>  Registration Magic is based on Reflection.  When registering repositories in an assembly, all classes inherited from IRetrievableEntity &lt;,&gt; are found, generic arguments are derived from them, new IRepository &lt;,&gt; and Repository &lt;,&gt; types are built with the necessary generic arguments, then everything is recorded by the types newly created through reflection .  For extended repositories, the search is performed by attribute: <pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> repositoryType <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> assembly.GetTypes().Where(type =&gt; type.IsClass)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> repositoryAttribute = repositoryType.GetCustomAttribute&lt;RepositoryAttribute&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (repositoryAttribute != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { container.RegisterType(repositoryAttribute.RepositoryInterfaceType, repositoryType, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TransientLifetimeManager()); } }</code> </pre><br><h4>  Problems </h4><ol><li>  Only Entity framework and Unity only.  The tool was created for our personal purposes and therefore it is rather difficult to find the motivation to implement, for example, registrations for other containers. </li><li>  The script is suitable for use with a single DBContext - different will not be able to kill a repository.  This restriction does not apply to the use of Rikrop.Core.Data without Rikrop.Core.Data.Unity. </li><li>  Fixed version of Unity.  If the Nuget-package for 4.0 does not explicitly indicate the version, then nuget will try to resolve the latest version, despite the fact that it is incompatible with .net 4. If anyone knows a way to get rid of this problem, please inform the PM. </li><li>  Only .net 4.0 and 4.5. </li></ol><br><h4>  Links </h4><ul><li>  GitHub <a href="https://github.com/rikrop/Rikrop.Core.Data/">Rikrop.Core.Data</a> </li><li>  GitHub <a href="https://github.com/rikrop/Rikrop.Core.Data.Unity/">Rikrop.Core.Data.Unity</a> </li><li>  Special thanks to <a href="https://habrahabr.ru/users/lexwings/" class="user_link">lexwings</a> for co-authoring and advising on Unity. </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/243353/">https://habr.com/ru/post/243353/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../243339/index.html">Review of the most interesting materials on data analysis and machine learning ‚Ññ22 (10 - 16 November 2014)</a></li>
<li><a href="../243343/index.html">Some interesting and useful things for web developer # 33</a></li>
<li><a href="../243345/index.html">Test iOS8 apps with Xcode 6.1 without Apple Developer Program Membership (Jailbreak) (Updated for Xcode 6.4)</a></li>
<li><a href="../243347/index.html">Repair through the ass or why you need debug-thinking</a></li>
<li><a href="../243351/index.html">Code that does not exist</a></li>
<li><a href="../243355/index.html">QML: animated sandwich icon in Material Design style in 20 minutes</a></li>
<li><a href="../243357/index.html">Inertial measurement of air temperature by ultrasound</a></li>
<li><a href="../243359/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ134 (November 10 - 16, 2014)</a></li>
<li><a href="../243361/index.html">Yii2 test on HHVM</a></li>
<li><a href="../243363/index.html">Animations using the Transitions API</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>