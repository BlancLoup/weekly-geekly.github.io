<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Degrees - the key to fast hierarchy (Django example)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are many ways to organize hierarchical data storage. Recently, I was interested in the question on the structure of the catalog, for example, an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Degrees - the key to fast hierarchy (Django example)</h1><div class="post__text post__text-html js-mediator-article">  There are many ways to organize hierarchical data storage.  Recently, I was interested in the question on the structure of the catalog, for example, an online store.  Namely, when Groups and Products are stored in different tables. <br>  When navigating a visitor in Groups, the Products should be displayed from all Subgroups. <br><br>  It would be desirable, having the Group code, to receive a quick query to the Product table, which would result in Products from the current Group and all its Subgroups. <br><a name="habracut"></a><br>  Traditionally, the hierarchical group table looks like this: <br>  1. ID - code <br>  2. PARENT - parent code <br>  3. NAME <br>  ... <br><br>  Then, in order to receive the Goods from all Subgroups, you will need to bypass the subtree, collect all the codes of the Children and insert them into the query to the Product table.  The method is the slowest to read. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      You can also add a string field to the Group table: <br>  4. ID_STR <br><br>  It encodes the group hierarchy.  It turns out like this: <br><br>  1. A; <br>  1.1.  AA;  1.2.  AB; <br>  2. In; <br>  2.1.  VA;  2.2.  BB; <br>  ... <br><br>  This field is the key of the Group in the Product table. <br>  Reading with such an organization is faster, but changing the hierarchy requires additional costs.  Since the revisions are a priori less than readings, you can put up with it. <br><br>  Thus, we can not make a traversal of the Group tree for the withdrawal of Products from all Subgroups, and do everything in one query. <br><br>  Minuses: <br>  - It is necessary to manually calculate the new string code. <br>  - When transferring / deleting a group, rearrange the table of goods (change the string key). <br>  - The limited options for the string key (in many respects, of course, depends on the coding system chosen, and in most cases this disadvantage can be neglected). <br>  - Also, the disadvantages of this approach include the need to work with string data, which entails an additional load on the server. <br><br>  You can get rid of the last flaw by making this field numeric. <br>  After a little thought, I sketched test plates (Children - below and to the right of the Parent): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/80d/496/510/80d4965101295a1e15b0b9614455ea55.png" alt="image"><br>  Pic1 <br><br>  The group table will look like this: <br>  1. ID - integer code <br>  2. PARENT - parent code <br>  ... <br><br>  Product Table: <br>  1. ID - code <br>  2. GROUP - Group Code <br>  ... <br><br>  Then all products from the Group and all Subgroups can be received in one request specifying a range of codes. <br><br>  For example, for Products from Group 16 and all of its Subgroups (Figure 1, Table 2), you will need to select a range (GROUP&gt; = 16) AND (GROUP &lt;32) <br><br>  The next drawback of this approach is the limited options.  But is he principled? <br><br>  The maximum 32-bit unsigned integer = 4,294,967,296. <br><br>  If you use a key of this type, then, for example, with 6 Levels you can get 39 Children for each Parent, with 7 levels - 23, with 5 - 83, etc ... <br><br>  The maximum required key value can be found by the formula: <br>  (Number of Children + 1) ^ Number of Levels <br><br>  If the database does not have the ability to store an unsigned integer, we can use a negative range, simply set the ‚Äúupper‚Äù element (root of the tree) to be a negative number.  To maximize the use of a 32-bit integer, with 6 levels and 39 children, this will be 2,048,000,000. <br><br><img src="http://storage5.static.itmages.com/i/13/0113/h_1358083455_1068008_bb05540109.png" alt="image"><br>  Fig.  2 <br><br>  For the example from the illustration above (Fig.2), the maximum unsigned integer is 64, if you use the negative range, then you will need to put root = -32 <br><br>  For most tasks, 4,294,967,296 is more than enough (at least for me).  Need more levels - reduce the number of children, and vice versa.  If such ‚Äúframeworks‚Äù are still cramped for someone, you can take a 64-bit integer.  The speed of working with such values ‚Äã‚Äãwill be almost the same. <br><br>  To check all this in work, I made the simplest Django application.  In the model entered 2 additional fields - Level and Number of Unemployed Children.  Also implemented the addition of a new element of the Group and its removal.  The settings for the tree now stand there like this: Number of Children = 39, Number of Levels = 6. The key is a 32-bit integer.  Of course, they can be changed (when changing the settings in the table there should be only one entry - root). <br>  You also need to manually add the root element to the table. <br><br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#coding: utf-8 #       !!! # #  ,   ,   : # (+1)^ # #    (    ),      2 # # 32-      -2,147,483,647  2,147,483,648 # #  ,  6   39     #    id=-((39+1)^6)/2,         : # id = -2,048,000,000 # parent = -2,048,000,000 # level = 0 # count_childs= 0 # name = 'root' #      # #    int32  /: # 3/1624 # 4/255 # 5/83 # 6/39 # 7/23 # 8/15 #    ,     int64, .. BigIntegerField() LV = 6 #   ... CH = 39 # ...  from django.db import models from django.db.models.signals import post_delete #   ... from django.dispatch import receiver # ...       class Group(models.Model): id = models.IntegerField(primary_key=True) parent = models.ForeignKey('self') level = models.SmallIntegerField(blank=False, null=False) count_childs= models.SmallIntegerField(blank=False, null=False) name = models.CharField(max_length=150, blank=False, null=False) # ... def save(self, *args, **kwargs): #     ... if self.id==None: #     parent_obj=self.parent #        if (parent_obj.count_childs &lt; CH) and (parent_obj.level &lt; LV): #     self.id = ((CH+1)**(LV-parent_obj.level-1)) \ * (parent_obj.count_childs+1) + parent_obj.id #     1     self.level = parent_obj.level+1 #      self.count_childs = 0 #      parent_obj.count_childs+=1 parent_obj.save() else: # ... ,    ,  raise ValueError("     ") #   super(Group, self).save(*args, **kwargs) def __unicode__(self): return u'%s (lv=%s ch=%s id=%s)' % (self.name, self.level, self.count_childs, self.id) # END class Group #         @receiver(post_delete, sender=Group) def my_post_delete(sender, **kwargs): parent = (kwargs.get("instance")).parent if parent.count_childs &gt; 0: parent.count_childs-=1 parent.save()</span></span></code> </pre> <br><br>  To quickly check the work, you can make a test to get the tree as in Fig. 1. Table 2. To do this, you need to enter the root element with values ‚Äã‚Äãin the table: <br>  id = 0 <br>  parent = 0 <br>  level = 0 <br>  count_childs = 0 <br>  name = 'root' <br>  ... and change the constants in the code above to LV = 3 CH = 3 <br><br>  Of course, in order for everything to work fully, you will need to add to the code: <br>  - When transferring the Group, it is necessary to recalculate the codes of all Children.  It is done in one request (UPDATE).  It is necessary to control the transfer down, the tree is not rubber :) <br>  - When deleting, if the Group is not ‚Äúlast right‚Äù in the Subgroup of the Parent, the vacant place must be filled with the rightmost Group of the same level.  It is done in one request (UPDATE). <br><br>  This has not yet been done (programming, for the last 15 years, only my hobby), but I see no obstacles to the implementation of these algorithms (the implementation ‚Äúon paper‚Äù already exists). <br><br>  Thus, it turned out a structure that works much faster than when using an encoded character key, well, and takes up less space. <br><br>  When using int64, the size limit of the hierarchical table will be significantly lower.  But int32 is enough for most tasks, after all, only Groups are stored in the hierarchy, and I haven‚Äôt yet met directories with parameters where Children&gt; 39 and Levels&gt; 6, (well, or didn‚Äôt notice). <br><br>  I would be grateful for any comments. <br><br>  UPD 01/20/2013 <br>  I apologize for editing the article, but I forgot to mention, about the not obvious, maybe the moment ... Since the code of any element, if there are data on the dimension of the tree (and we have them), carries all the information about its position, then Group transfers in a table are made in one request. <br>  UPD 01/22/2013 <br>  Wrote a <a href="http://habrahabr.ru/post/166699/">more detailed article about this method</a> .  It has links to files with the full implementation of the algorithm on Django </div><p>Source: <a href="https://habr.com/ru/post/165713/">https://habr.com/ru/post/165713/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../165703/index.html">Saving Excel documents to PDF on server</a></li>
<li><a href="../165705/index.html">A couple of words about application internationalization</a></li>
<li><a href="../165707/index.html">SoapServer in PHP. Let array be always Map</a></li>
<li><a href="../165709/index.html">GCW Zero on Kickstarter</a></li>
<li><a href="../165711/index.html">Prototyping with Wireframesketcher</a></li>
<li><a href="../165715/index.html">Implementation of morphological search on Kohana (phpMorphy library)</a></li>
<li><a href="../165719/index.html">Find an idea: the ideal object</a></li>
<li><a href="../165723/index.html">Advanced VIM Setup</a></li>
<li><a href="../165725/index.html">Like I had for the first time with Kiwi</a></li>
<li><a href="../165727/index.html">How and why we made our micro markup validator</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>