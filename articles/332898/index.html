<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Why changes in the new Phoenix 1.3 are so important</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Phoenix Framework has always been awesome. But he has never been as cool as with the new release 1.3 (which is currently in the RC2 stage). 


 Th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Why changes in the new Phoenix 1.3 are so important</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/1ea/1ec/97a/1ea1ec97ad8b4907abe5d7e5273361b3.png"></p><br><p>  The Phoenix Framework has always been awesome.  But he has never been as cool as with the new release 1.3 (which is currently in the RC2 stage). </p><br><p>  There have been many significant changes.  Chris McCord has written a <a href="https://gist.github.com/chrismccord/71ab10d433c98b714b75c886eff17357">complete guide to change</a> .  His <a href="https://www.youtube.com/watch%3Fv%3DtMO28ar0lW8">speech with LonestarElixir</a> is also available, where he tells in detail about the key points.  Inspired by his works, in my article I will try to tell you about the most important changes in the Phoenix project. </p><br><p>  Let's start! </p><br><p>  <em>The translation was made by the author of the <a href="https://medium.com/wemake-services/why-changes-in-phoenix-1-3-are-so-important-2d50c9bdabb9">original article,</a> <a href="https://github.com/sobolevn">Nikita Sobolev</a> .</em> </p><a name="habracut"></a><br><h2 id="suschestvuyuschie-problemy">  Existing problems </h2><br><p>  Phoenix is ‚Äã‚Äãa new framework.  And, of course, he has some problems.  The core team worked very diligently to solve some of the most important ones.  So what are these problems? </p><br><h3 id="direktoriya-webnbspmdash-chistaya-magiya">  Web directory - pure magic </h3><br><p> When working on a project using Phoenix, you have two places for source code: <code>lib/</code> and <code>web/</code> .  The concept is: </p><br><ul><li>  Put all your business logic and utilities inside <code>lib/</code> . </li><li>  Put everything related to your web interface (controllers, views, templates) inside the web directory <code>web/</code> . </li></ul><br><p>  But is this clear to the developers?  I do not think so. </p><br><p>  Where does this web directory come from?  Is this a Phoenix feature?  Or other frameworks also use it?  Should I use <code>lib/</code> with Phoenix projects or is it reserved for some deep magic?  All these questions came to me after my first meeting with Phoenix. </p><br><p>  Prior to version 1.2, only the <code>web/</code> directory automatically rebooted.  So, why should I create any files inside <code>lib/</code> and restart the server when I can put them somewhere inside the <code>web/</code> for a quick reload? </p><br><p>  This leads us to even more important questions: do my model files (let's call them models in this particular context) relate to the <code>web</code> application or to the basic logic?  Is it possible to divide the logic into different domains or applications (for example, as in Django)? </p><br><p>  These questions remain unanswered. </p><br><h3 id="biznes-logika-vnbspkontrollerah">  Business logic in controllers </h3><br><p>  Moreover, the template code that goes to Phoenix suggests another way.  You can get the following code in a new project: </p><br><pre> <code class="hljs vbscript">defmodule Example.UserController <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> use Example.Web, :controller # ... def update(conn, %{<span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; id, <span class="hljs-string"><span class="hljs-string">"user"</span></span> =&gt; user_params}) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> user = Repo.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>!(User, id) changeset = User.changeset(user, user_params) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Repo.update(changeset) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {:ok, user} -&gt; render(conn, Example.UserView, <span class="hljs-string"><span class="hljs-string">"show.json"</span></span>, user: user) {:<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>, changeset} -&gt; conn |&gt; put_status(:unprocessable_entity) |&gt; render(Example.ChangesetView, <span class="hljs-string"><span class="hljs-string">"error.json"</span></span>, changeset: changeset) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  What should a developer do when an email is sent to the user after a successful update?  The controller asks to be expanded.  Just put one more line of code before <code>render/4</code> , what could go wrong?  But.  Phoenix has just pushed us to misuse its codebase: we write business logic in the controller! </p><br><p>  In fact, one extra line in the controller is normal.  All problems arise when the application grows.  There are many such lines, the application becomes unstable, unaffordable and repeats itself. </p><br><h3 id="shemy-nenbspyavlyayutsya-modelyami">  Schemes are not models </h3><br><p>  At some point, for no particular reason, the <code>Ecto</code> schemes became known as ‚Äúmodels‚Äù.  What is the difference between a ‚Äúmodel‚Äù and a ‚Äúscheme‚Äù?  A schema is just a way to define a structure ‚Äî a database structure in this particular case.  Models as a concept are much more complex than schemes.  Models must provide a way to manage data and perform various actions, like models in Django or Rails.  Elixir as a functional language is not suitable for the concept of "model", so they were abolished in the project <code>Ecto</code> . </p><br><p>  Files inside the <code>models/</code> were not organized.  As it grows, your application becomes chaotic.  How are these files related?  In what context do we use them?  It was hard to understand. </p><br><p>  In addition, the <code>models/</code> directory was considered as another place to put your business logic, which is normal for other languages ‚Äã‚Äãand frameworks.  There is the familiar concept of "fat models".  But this concept, again, is not suitable for Phoenix for the reasons already mentioned. </p><br><h2 id="resheniya">  Solutions </h2><br><p>  Since the last major release, much has changed.  The easiest way to show all changes is by example. </p><br><h3 id="trebovaniya">  Requirements </h3><br><p>  This guide assumes that you have <code>elixir-1.4</code> , and it works.  Not?  So <a href="http://elixir-lang.org/install.html">install it</a> ! </p><br><h3 id="ustanovka">  Installation </h3><br><p>  First you need to install a new version of Phoenix: </p><br><pre> <code class="bash hljs">mix archive.install https://github.com/phoenixframework/archives/raw/master/phx_new.ez</code> </pre> <br><h3 id="sozdanie-novogo-proekta">  Creating a new project </h3><br><p>  Upon completion of the installation, you need to check whether everything is in place.  <code>mix help</code> will give you something like this: </p><br><pre> <code class="bash hljs">mix phoenix.new <span class="hljs-comment"><span class="hljs-comment"># Creates a new Phoenix v1.1.4 application mix phx.new # Creates a new Phoenix v1.3.0-rc.1 application using the experimental generators</span></span></code> </pre> <br><p>  This is where the first change manifests itself: the new generators.  The old generators were called <code>phoenix</code> , and the new ones were just <code>phx</code> .  Now you need less typing.  And, more importantly, a new message to developers: these generators are new, they will do something new for your project. </p><br><p>  Then you need to create a new project structure by running: </p><br><pre> <code class="bash hljs">mix phx.new medium_phx_example --no-html --no-brunch</code> </pre> <br><p>  Before we see any results of this command, let's discuss the parameters.  <code>--no-html</code> removes some components for working with <code>html</code> , so <code>phx.gen.html</code> will no longer work.  But we build <code>json</code> API, and we do not need <code>html</code> .  Similarly, <code>--no-brunch</code> means: do not create a <code>brunch</code> file for working with statics. </p><br><h2 id="izmeneniya">  Changes </h2><br><h3 id="veb-direktoriya">  Web directory </h3><br><p>  Looking at your new files, you may wonder: where is the web directory?  Well, here is the second change.  And pretty big.  Now your web directory is inside <code>lib/</code> .  It was special, many people misunderstood its main goal, which was to keep the web interface for your application.  This is not the place for your business logic.  Now everything is clear.  Put everything inside <code>lib/</code> .  And leave only your controllers, templates and views inside the new web directory.  Here's what it looks like: </p><br><pre> <code class="bash hljs">lib ‚îî‚îÄ‚îÄ medium_phx_example ‚îú‚îÄ‚îÄ application.ex ‚îú‚îÄ‚îÄ repo.ex ‚îî‚îÄ‚îÄ web ‚îú‚îÄ‚îÄ channels ‚îÇ ‚îî‚îÄ‚îÄ user_socket.ex ‚îú‚îÄ‚îÄ controllers ‚îú‚îÄ‚îÄ endpoint.ex ‚îú‚îÄ‚îÄ gettext.ex ‚îú‚îÄ‚îÄ router.ex ‚îú‚îÄ‚îÄ views ‚îÇ ‚îú‚îÄ‚îÄ error_helpers.ex ‚îÇ ‚îî‚îÄ‚îÄ error_view.ex ‚îî‚îÄ‚îÄ web.ex</code> </pre> <br><p>  Where <code>medium_phx_example</code> is the name of the current application.  Applications can be many.  So now all the code lives in the same directory. </p><br><p>  The third change will open shortly after viewing the <code>web.ex</code> file: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">defmodule</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MediumPhxExample</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Web</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">do</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">def</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">controller</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">do</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">quote</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">do</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">use</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Phoenix</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Controller</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">namespace</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">MediumPhxExample</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Web</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Plug</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Conn</span></span> # <span class="hljs-selector-tag"><span class="hljs-selector-tag">Before</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">it</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">was</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">just</span></span>: # <span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MediumPhxExample</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Router</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Helpers</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MediumPhxExample</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Web</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Router</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Helpers</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MediumPhxExample</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Web</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Gettext</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">end</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">end</span></span> # <span class="hljs-selector-tag"><span class="hljs-selector-tag">Some</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">extra</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">code</span></span>: # ... <span class="hljs-selector-tag"><span class="hljs-selector-tag">end</span></span></code> </pre> <br><p>  Phoenix now creates a <code>.Web</code> namespace that <code>.Web</code> very well with the new file structure. </p><br><h3 id="sozdanie-shemy">  Creating a schema </h3><br><p>  This is the fourth and my favorite change.  Previously, we had a <code>web/models/</code> directory <code>web/models/</code> , which was used to store the schemes.  Now the concept of the models is completely dead.  Introduced a new philosophy: </p><br><ol><li>  the schema represents the data structure; </li><li>  context is used to store multiple schemas; </li><li>  context is used to provide a public external API.  In other words, it determines what can be done with your data. </li></ol><br><p>  Our application will contain only one context: <code>Audio</code> .  Let's start by creating an <code>Audio</code> Context with two <code>Album</code> and <code>Song</code> schemes: </p><br><pre> <code class="bash hljs">mix phx.gen.json Audio Album albums name:string release:utc_datetime mix phx.gen.json Audio Song songs album_id:references:audio_albums name:string duration:<span class="hljs-built_in"><span class="hljs-built_in">integer</span></span></code> </pre> <br><p>  The syntax of this generator has also changed.  Now it is required that the context name be the first argument.  Also note the <code>audio_albums</code> , the schemes now contain a prefix with the context name.  And this is what happens with the project structure after running two generators: </p><br><pre> <code class="bash hljs">lib ‚îî‚îÄ‚îÄ medium_phx_example ‚îú‚îÄ‚îÄ application.ex ‚îú‚îÄ‚îÄ audio ‚îÇ ‚îú‚îÄ‚îÄ album.ex ‚îÇ ‚îú‚îÄ‚îÄ audio.ex ‚îÇ ‚îî‚îÄ‚îÄ song.ex ‚îú‚îÄ‚îÄ repo.ex ‚îî‚îÄ‚îÄ web ‚îú‚îÄ‚îÄ channels ‚îÇ ‚îî‚îÄ‚îÄ user_socket.ex ‚îú‚îÄ‚îÄ controllers ‚îÇ ‚îú‚îÄ‚îÄ album_controller.ex ‚îÇ ‚îú‚îÄ‚îÄ fallback_controller.ex ‚îÇ ‚îî‚îÄ‚îÄ song_controller.ex ‚îú‚îÄ‚îÄ endpoint.ex ‚îú‚îÄ‚îÄ gettext.ex ‚îú‚îÄ‚îÄ router.ex ‚îú‚îÄ‚îÄ views ‚îÇ ‚îú‚îÄ‚îÄ album_view.ex ‚îÇ ‚îú‚îÄ‚îÄ changeset_view.ex ‚îÇ ‚îú‚îÄ‚îÄ error_helpers.ex ‚îÇ ‚îú‚îÄ‚îÄ error_view.ex ‚îÇ ‚îî‚îÄ‚îÄ song_view.ex ‚îî‚îÄ‚îÄ web.ex</code> </pre> <br><p>  What are the main changes in structures compared to the previous version? </p><br><ol><li>  Now the schemes do not belong to <code>web/</code> , and the <code>models/</code> directory has disappeared altogether. </li><li>  Schemes are now separated by a context that defines how they are related to each other. </li></ol><br><p>  And the diagrams right now are nothing more than a description of the table.  What should be the scheme in the first place.  Here are our schemes: </p><br><pre> <code class="hljs sql">defmodule MediumPhxExample.Audio.Album <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Ecto.Schema <span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> <span class="hljs-string"><span class="hljs-string">"audio_albums"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">field</span></span> :<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">field</span></span> :<span class="hljs-keyword"><span class="hljs-keyword">release</span></span>, :utc_datetime timestamps() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><pre> <code class="hljs sql">defmodule MediumPhxExample.Audio.Song <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Ecto.Schema <span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> <span class="hljs-string"><span class="hljs-string">"audio_songs"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">field</span></span> :<span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>, :<span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">field</span></span> :<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">field</span></span> :album_id, :<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> timestamps() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  Everything except the scheme itself has disappeared.  There are no required fields, no <code>changeset/2</code> or any other functions.  The generator now doesn't even create <code>belongs_to</code> for you.  You yourself manage the connections of your schemes. </p><br><p>  So now this is pretty clear: the schema is not the place for your business logic.  All of this is handled by the context, which looks like this: </p><br><pre> <code class="hljs ruby">defmodule MediumPhxExample.Audio <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> @moduledoc <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">" The boundary for the Audio system. "</span></span><span class="hljs-string"><span class="hljs-string">""</span></span> import Ecto.{Query, Changeset}, <span class="hljs-symbol"><span class="hljs-symbol">warn:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> MediumPhxExample.Repo <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> MediumPhxExample.Audio.Album <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">list_albums</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">do</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Repo</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">all</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Album)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_album!</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id)</span></span></span></span>, <span class="hljs-symbol"><span class="hljs-symbol">do:</span></span> Repo.get!(Album, id) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_album</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(attrs \\ </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">%{}</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> %Album{} <span class="hljs-params"><span class="hljs-params">|&gt; album_changeset(attrs) |</span></span>&gt; Repo.insert() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-comment"><span class="hljs-comment"># ... defp album_changeset(%Album{} = album, attrs) do album |&gt; cast(attrs, [:name, :release]) |&gt; validate_required([:name, :release]) end alias MediumPhxExample.Audio.Song def list_songs do Repo.all(Song) end def get_song!(id), do: Repo.get!(Song, id) def create_song(attrs \\ %{}) do %Song{} |&gt; song_changeset(attrs) |&gt; Repo.insert() end # ... defp song_changeset(%Song{} = song, attrs) do song |&gt; cast(attrs, [:name, :duration]) |&gt; validate_required([:name, :duration]) end end</span></span></code> </pre> <br><p>  The very context view sends a clear message: here is the place to put your code!  But be careful, context files can grow.  Separate them into several modules in this case. </p><br><h3 id="ispolzovanie-kontrollera">  Controller use </h3><br><p>  Previously, we had a lot of code in the controller by default and it was easy for the developer to extend the template code.  Here is the fifth change.  Starting with the new release, the template code in the controller has been reduced and reorganized: </p><br><pre> <code class="hljs vbscript">defmodule MediumPhxExample.Web.AlbumController <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> use MediumPhxExample.Web, :controller alias MediumPhxExample.Audio alias MediumPhxExample.Audio.Album action_fallback MediumPhxExample.Web.FallbackController # ... def update(conn, %{<span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; id, <span class="hljs-string"><span class="hljs-string">"album"</span></span> =&gt; album_params}) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> album = Audio.get_album!(id) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> {:ok, %Album{} = album} &lt;- Audio.update_album(album, album_params) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> render(conn, <span class="hljs-string"><span class="hljs-string">"show.json"</span></span>, album: album) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> # ... <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  In action <code>update/2</code> now there are only three meaningful lines of code. </p><br><p>  Currently, controllers use contexts directly, which makes them a very thin layer in the application.  It is very difficult to find a place for additional logic in the controller.  What was the main task during the reorganization. </p><br><p>  Controllers do not even handle errors.  A special new <code>fallback_controller</code> intended for working with errors.  This new concept is the sixth change.  It allows you to have all error handlers and error codes in one place: </p><br><pre> <code class="hljs ruby">defmodule MediumPhxExample.Web.FallbackController <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> @moduledoc <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">" Translates controller action results into valid `Plug.Conn` responses. See `Phoenix.Controller.action_fallback/1` for more details. "</span></span><span class="hljs-string"><span class="hljs-string">""</span></span> use MediumPhxExample.Web, <span class="hljs-symbol"><span class="hljs-symbol">:controller</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn, {</span></span><span class="hljs-symbol"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:error</span></span></span></span><span class="hljs-function"><span class="hljs-params">, %Ecto.Changeset{} = changeset})</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn <span class="hljs-params"><span class="hljs-params">|&gt; put_status(:unprocessable_entity) |</span></span>&gt; render(MediumPhxExample.Web.ChangesetView, <span class="hljs-string"><span class="hljs-string">"error.json"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">changeset:</span></span> changeset) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn, {</span></span><span class="hljs-symbol"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:error</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-symbol"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:not_found</span></span></span></span><span class="hljs-function"><span class="hljs-params">})</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn <span class="hljs-params"><span class="hljs-params">|&gt; put_status(:not_found) |</span></span>&gt; render(MediumPhxExample.Web.ErrorView, <span class="hljs-symbol"><span class="hljs-symbol">:</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">"404"</span></span></span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  What happens when the result from <code>Audio.update_album(album, album_params)</code> does not match <code>{:ok, %Album{} = album}</code> ?  In this situation, the controller defined in <code>action_fallback</code> .  And the correct <code>call/2</code> will be selected, which in turn returns the correct answer.  Easy and pleasant.  No exception handling in the controller. </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  The changes made are very interesting.  There are many of them; they are all focused on ruining the old habits of programmers who came from other programming languages.  And new changes are trying to supplement the philosophy of <code>Phoenix-Way</code> with new practices.  I hope this article was helpful and prompted you to use the Phoenix Framework to the maximum.  <a href="https://github.com/sobolevn">Come to my github</a> . </p><br><p>  <em>We thank Nikita for preparing the translation of our own original article and gladly publish material on Habr√©.</em>  <em>Nikita represents the <a href="http://elixir-lang.moscow/">ElixirLangMoscow</a> community, which organizes Elixir meetings in Moscow, as well as an active contributor to open-source and makes a significant contribution to our Wunsh <a href="https://wunsh.ru/">community</a> .</em>  <em>On the site you are waiting for 3 dozen feature articles, weekly newsletters and news from the world of Elixir.</em>  <em>And for questions we have a <a href="https://t.me/wunsh">chat in the Telegram</a> with excellent participants.</em> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/332898/">https://habr.com/ru/post/332898/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../332886/index.html">Dark moments of SELinux</a></li>
<li><a href="../332888/index.html">No rest for the wicked. Photo report from the far reaches of Russia, where we were thanks to Roshydromet</a></li>
<li><a href="../332890/index.html">Running Java classes and non-textbook JARs</a></li>
<li><a href="../332892/index.html">Vivaldi Sync: Answers to Questions</a></li>
<li><a href="../332896/index.html">Privileged ports cause global warming</a></li>
<li><a href="../332900/index.html">ES8 came out and here are its main new features.</a></li>
<li><a href="../332902/index.html">Pentest-laboratory "Pentestit Test lab v.11" - full passage</a></li>
<li><a href="../332904/index.html">Security issues of Android applications: classification and analysis</a></li>
<li><a href="../332906/index.html">What's new in CUBA Platform 6.5</a></li>
<li><a href="../332908/index.html">A little about the bugs in the BIOS / UEFI of Lenovo / Fujitsu / Toshiba / HP / Dell laptops</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>