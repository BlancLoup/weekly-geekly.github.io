<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Billing in a big project</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are different ways to monetize a project. But they have one common component - how the money goes from the user's wallet to the organization‚Äôs a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Billing in a big project</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage3/bef/7a5/352/bef7a5352861f00d5d35e66f1f0ac565.png" align="left">  There are different ways to monetize a project.  But they have one common component - how the money goes from the user's wallet to the organization‚Äôs account.  Today we will talk about how payment acceptance is organized at Badoo and what can be found on the payment gateway market.  We immediately warn you that in the article you will not find specific figures on the turnover of the company's funds, but everything else will be no less interesting. <br><br><h4>  What is "billing" </h4><br>  For us, billing is all about getting money from users: the configuration of prices, the payment acceptance page, the direct receipt and processing of payments, the provision of paid services, various promotions and, of course, the monitoring of everything described above. <br><a name="habracut"></a><br>  Initially, as in all startups, we did not have paid services.  The first serious steps towards monetization began back in 2008, despite the fact that the site was officially launched in 2006.  France was chosen for experiments, and payment was accepted only via SMS.  The acceptance of payments was organized on files.  Each request was recorded in a separate file, which was then transferred by bash scripts from one folder to another, which meant a change in processing status.  The database was used only to account for successfully processed transactions.  This scheme successfully worked for a little over a year, after which it became difficult to maintain, and we decided to abandon the files and rewrite everything using the database. <br><br>  The development of the new version was quite fast, as there were not many countries where paid services were available.  But it was designed only for receiving payments via SMS, because of this we even still have some funny artifacts, for example, the MSISDN (phone number) and short code (short number sent to a paid SMS) fields in the processed table payments. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now we accept payments almost all over the world.  Every second, users are trying to pay something on the website or in applications for all popular mobile platforms.  And if you put it on the map, you get the picture "View of Earth from space at night": <br><br><img src="https://habrastorage.org/storage3/312/09a/cb8/31209acb8ebfefbda120241dc4d6754e.png" alt="image"><br><br>  We have about 50 payment methods provided by different partners.  The most popular are bank cards, SMS &amp; Direct billing and purchases in mobile applications. <br><br><img src="https://habrastorage.org/storage3/84c/b17/8f5/84cb178f5f7f462bfb93fda89d9f7c7f.png" alt="image"><br><br>  Among them there are also exotic, for example, direct debiting from the account of an Internet provider or payment via a landline.  And once we received a payment through regular mail! <br><br><img src="https://habrastorage.org/storage3/aef/db9/de5/aefdb9de5ca46fe113607012b7631fd6.jpg" alt="image"><br><br><h4>  Bank charges </h4><br>  All payment systems allow you to accept payments from their users.  Such direct integration is convenient to do, as long as there are not many of them and you connect well-known systems with debugged processes.  But when you need to enter local markets, problems begin to appear.  Supporting the ‚Äúzoo‚Äù of various APIs is becoming increasingly difficult, the requirements of regulators differ, a popular local payment system may refuse to work with foreign clients at low speeds at all, or signing a contract and settling legal problems may drag on for a long time.  Despite such difficulties, local payment systems may pleasantly surprise you with their conversion.  For example, Holland, which we thought was not very promising, after connecting a popular payment method in this country, iDeal began to bring in 30-40% more money. <br><br>  If there is a demand, there will be an offer.  There are many aggregator companies on the market, or, in a different way, payment gateways ( <i>English</i> payment gateway), the purpose of which is to unite all popular payment systems, including local ones, under a single API.  By making one such integration, we are able to accept payments through dozens of payment systems worldwide.  You can not even make the payment page on your site, but use the already finished one provided by the aggregator, and only customize the design.  Particularly advanced companies make it possible to upload their CSS and JS files, change images, translations and even register the resulting page on your subdomain, for example, payments.example.com.  This gives a very rich opportunity for "customization", and the user gets the feeling that he does not leave your site.  We do not use this opportunity in our country, as we work simultaneously with several aggregators, but for some it may be a very convenient solution. <br><br>  Which way to use ‚Äî direct integration or through an aggregator ‚Äî depends primarily on the size of the commission.  The more your customers use the payment system, the more profitable it may be to save on commission and connect to it directly.  The second important factor is the quality of the API, the usability and stability.  Here aggregators allow smoothing the roughness, and sometimes provide a more stable service than the direct connection. <br><br><h4>  SMS payments </h4><br>  Independently are payments via SMS and direct debit from the balance of a mobile phone.  They are under very tight control in many countries, especially in Europe.  Local regulators or the state itself may impose special requirements on how the payment page should look or what the text of sent SMS messages should be.  Changes to such requirements should be monitored and timely made changes on your site.  For example, in Belgium there is a rule that a short number should be written in white font on a black background, and its value should be indicated next to it. <br><br><img src="https://habrastorage.org/storage3/453/abf/7d0/453abf7d054393b7a97abf64489e1db4.png" alt="image"><br><br>  Different type of SMS-billing - MO (Mobile Originated) or MT (Mobile Terminated).  With MO-billing, everything is quite simple: the user sent an SMS to a short number, we received money.  But for MT there are several options.  Payment does not occur at the time the user sends an SMS, but after he receives a special paid SMS from us.  That is, the fact of payment is the notification received from the aggregator that a paid SMS has been successfully delivered.  The main goal of this approach is to add an additional check before sending a paid SMS message to the user and prevent errors associated with incorrect SMS text.  For this, payment takes place in two phases.  The first is that the user expresses a desire to pay for something, the second is a confirmation.  For example, the payment process might look like this: <br><ul><li>  we send an SMS to a short number, respond to the incoming SMS with a certain text or without it; </li><li>  send an SMS to a short number, enter the received PIN-code on the site; </li><li>  enter the phone number on the site, get the PIN code, enter it on the site. </li></ul><br>  Fortunately, there are aggregator companies on the SMS-payments market, whose services should be used.  They are for a modest, and sometimes not very, fee deprive you of the "pleasure" to deal with such details.  Another nice bonus is that they often take on some of the responsibilities for end-user support.  Users start writing about their problems directly to the owner of the short number, i.e.  aggregator. <br><br><h4>  Technical details </h4><br>  Badoo works on a PHP + MySQL bundle, so we use the same technologies for payment processing.  The code is executed on a separate server group, separated from the common pool.  Inside, we divided it into several logical subgroups: servers for processing incoming requests, servers for background operations and collecting statistics, database servers, servers for processing bank card payments.  The latter are separated into a separate group, because they must comply with the <a href="http://ru.wikipedia.org/wiki/PCI_DSS">PCI DSS</a> security standard developed with the participation of Visa, MasterCard, American Express, JCB and Discover for organizations operating or storing data of bank card holders. <br><br>  For payment processing, we use two database servers with MySQL from Percona, working in <i>master-master</i> replication.  The main load goes only to one of them, the second is used for hot-swapping in the event of an accident or for replacing the main one (for the time it is serviced, for requests from a monitoring system or collecting statistics). <br><br>  The whole billing system can be divided into several large parts: <br><ul><li>  Core.  This includes basic entities, such as <i>Order</i> , <i>Payment</i> , <i>Services</i> and the rules for their accounting and delivery, various infrastructural things. </li><li>  Plugins aggregators.  All that is responsible for the communication between us and the payment system. </li><li>  Page selection and payment services. </li></ul><br>  Connecting a new payment method to the system is to create its plug-in.  He is responsible for all the interactions between us and the payment gateway, which are of two kinds: when we are the initiator (pull request) and when the initiator is the aggregator (push request).  For pull requests, HTTP is usually used as a protocol, pure or as a transport for JSON / XML, or SOAP.  The concept of REST API, which has been popular lately, was not common for us, only for new companies in the market, for example, for the British GoCardless, or for old ones that decided to rework their API, for example, PayPal.  For push-requests, SOAP is practically not used (of those who offer such a format of push-notifications, only Qiwi is easily remembered).  Mainly pure HTTP is used or it is used as a transport for all the same JSON and XML. <br><br>  After the implementation of the API comes the testing phase.  On Habr√© there were already articles about how our <a href="http://habrahabr.ru/company/badoo/blog/170951/">process of development</a> and <a href="http://habrahabr.ru/company/badoo/blog/169417/">automation</a> looks.  But for billing there are some features related mainly to the fact that we have to test not just our code, but also the interaction with aggregators.  It is very convenient if they have a test environment for this, which fully emulates the actual acceptance of payments.  If it is not there, we do stubs that emulate the behavior of the aggregator.  This makes manual testing easier for us and allows us to write autotests that verify the entire payment process.  Here is an example of what one of the stubs looks like. <br><br><img src="https://habrastorage.org/storage3/29e/feb/b7e/29efebb7e0c319a83b6bf389931d4ba5.png" alt="image"><br><br>  After the test environment, you need to check how everything will work in life, to make a real payment.  But for SMS payments, you often have to get approval from regulators or operators, and this can take several months.  In order not to lay out the semi-ready code on the production servers, we came up with such a thing as External Shot.  This is our usual Shot, which is the directory with the task branch and is intended for testing it on production servers, but in addition to the local domain, it has an additional external address where anyone can go and see the changes made.  For security, such ‚Äúshots‚Äù are not created for every task, but only in cases where it is really necessary.  We give links to them to our partners, and they can check the changes made at any time of the day or night.  This is especially true for countries located in another hemisphere, with which the time difference can reach 12 hours. <br><br><h4>  Support and operation </h4><br>  After the new integration is laid out on production servers, the stage of its operation and support begins.  Technical support takes about 60-70% of our time. <br><br><img src="https://habrastorage.org/storage3/f67/c76/c6f/f67c76c6f681b024e3e5d5ac736866de.png" alt="image"><br><br>  This includes, firstly, the analysis of complaints from users.  All simple situations are solved by the first-line support team, it also translates for us complaints from different languages ‚Äã‚Äãinto English.  Therefore, we get only the most complex cases that really require the attention of developers. <br><br>  The second component of technical support is the correction of errors or the introduction of changes to existing integrations.  Errors occur for various reasons.  For example, due to inattentive reading of documentation or gaps in it.  Once, instead, we even had to use chat logs with the aggregator developer, because the documentation for their new system was not yet ready.  There were cases when the aggregator changed the interaction protocol or its parameters without notice.  Another time, the acquiring bank disconnected our gateway, and we had to urgently redirect traffic to another location.  As it turned out, it was an ancient server from the 80s, which, according to the bank, did not have to process anything at all.  In general, there is no need to be bored, especially considering that every minute of idle time is a lost profit. <br><br>  To solve such problems, we write detailed logs of the application.  It includes not only errors, but also all interactions with aggregator systems or just important events that occur during the execution of queries.  Each request has its own unique identifier, by which you can find all records associated with it and restore its processing.  This is especially useful when you have to deal with errors, since which several weeks or months have already passed. <br><br>  That's how billing is organized in Badoo.  Of course, there are still a lot of interesting topics that we plan to tell the future about, such as monitoring, PCI DSS certification and processing of bank card payments.  If you have questions or suggestions on future articles, welcome to the comments. <br><br>  Anatoly Panov <br>  Lead Developer </div><p>Source: <a href="https://habr.com/ru/post/194850/">https://habr.com/ru/post/194850/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../194836/index.html">Why is the frequency not increasing?</a></li>
<li><a href="../194838/index.html">PHP extension or everything will be in Zephir</a></li>
<li><a href="../194842/index.html">play rock, or comand-line internet radio</a></li>
<li><a href="../194844/index.html">The Startup AddVenture conference offers a new interactive format of interaction with venture capital investors and experts from Silicon Valley.</a></li>
<li><a href="../194848/index.html">We clean the HTML code when pasting text from MS Word to HTML5 WYSIWYG editor (contenteditable)</a></li>
<li><a href="../194852/index.html">Rejecting jParser (in favor of working directly with Node.js buffers) speeds up the script by an order of magnitude</a></li>
<li><a href="../194854/index.html">Today, the Android OS is exactly 5 years old</a></li>
<li><a href="../194856/index.html">Google glass from a developer‚Äôs point of view</a></li>
<li><a href="../194860/index.html">BlackBerry leaves consumer market</a></li>
<li><a href="../194862/index.html">Hardware and software automation platform Tibbo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>