<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a server that does not fall under load</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From the translator: This is the fifth article from the cycle about Node.js from the Mozilla Identity team that deals with the Persona project. 

  Al...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a server that does not fall under load</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/1cd/114/dcc/1cd114dccef67edc3ab87f77457332d9.jpg" align="left">  <i><b>From the translator:</b> This is the fifth article from the <a href="https://hacks.mozilla.org/category/a-node-js-holiday-season/">cycle about Node.js</a> from the Mozilla Identity team that deals with the <a href="http://ru.wikipedia.org/wiki/Mozilla_Persona">Persona</a> project.</i> <i><br><br></i> <div class="spoiler">  <b class="spoiler_title">All articles of the cycle:</b> <div class="spoiler_text"><ol><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/195494/">Hunting for memory leaks in Node.js</a> " </li><li>  "We <a href="http://habrahabr.ru/company/nordavind/blog/195686/">load Node to the eyeballs</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196018/">Store the session on the client to simplify application scaling</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196358/">Frontend performance. Part 1 - concatenation, compression, caching</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196518/">We write a server that does not fall under load</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196818/">Frontend performance. Part 2 - we cache dynamic content using etagify</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/197166/">Taming Web Application Configurations with node-convict</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/197370/">Frontend performance. Part 3 - font optimization</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/197566/">Localization of Node.js Applications. Part 1</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/198154/">Localization of Node.js Applications. Part 2: Toolkit and Process</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/198252/">Localization of Node.js Applications. Part 3: Localization in Action</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/198590/">Awsbox - PaaS infrastructure for deploying Node.js applications in the Amazon cloud</a> " </li></ol><br></div></div><br><br><hr><br>  How to write a Node.js application that will continue to work even under an impossible load?  This article shows the methodology and library node-toobusy, which embodies it, the essence of which can be most briefly conveyed by this code snippet: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> toobusy = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'toobusy'</span></span>); app.use(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (toobusy()) res.send(<span class="hljs-number"><span class="hljs-number">503</span></span>, <span class="hljs-string"><span class="hljs-string">"I'm busy right now, sorry."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> next(); });</code> </pre> <br><h4>  What is the problem? </h4><br>  If your application performs an important task for people, it is worth spending a little time thinking about the most disastrous scenarios.  It can be a disaster in a good way - when your site is in the spotlight of social media, and instead of ten thousand visitors a day, you suddenly receive a million.  Preparing in advance, you can create a website that can withstand a sudden increase in attendance that exceeds the usual load by orders of magnitude.  If, however, these preparations are neglected, the site will fall exactly when you least want it, when it is visible to everyone. <br><br>  This could be a malicious surge of traffic, for example, from a DoS attack.  The first step to combat such attacks is to write a server that does not crash. <br><a name="habracut"></a><br><h4>  Your server is under load </h4><br>  To show how a regular, unprepared for attendance surge behaves, the server, I wrote a <a href="https://gist.github.com/4532177">demo application</a> that makes five asynchronous calls for each request, all in all spending five milliseconds of CPU time. <br><br>  This roughly corresponds to the usual application, which can, with each request, write something to the logs, access the database, render the template and send a response to the client.  Below is a graph of the delay and TCP error versus the number of connections. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fba/32f/c4a/fba32fc4aa7b84706164a6dc5b5a4ac9.png" alt="image"><br><br>  The analysis of this data is quite obvious: <br><br><ul><li>  The server can not be called responsive.  Under load, six times the nominal (1,200 requests per second), he squeaks out an answer after an average of 40 seconds. </li><li>  Failures look terrible.  In 80% of cases, the user receives an error message after almost a minute of anxious waiting. </li></ul><br><h4>  Learning to refuse politely </h4><br>  For comparison, I <a href="https://gist.github.com/lloyd/4532198">applied</a> the approach described at the beginning of the article to the demo application.  It allows you to determine when the load exceeds the allowable and immediately respond with an error message.  Here is a schedule similar to the first example for it: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6fb/e0e/8a6/6fbe0e8a61867170b17efe1c3d21e8e4.png" alt="image"><br><br>  The graph does not show the number of errors with code 503 ( <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BF%25D0%25B8%25D1%2581%25D0%25BE%25D0%25BA_%25D0%25BA%25D0%25BE%25D0%25B4%25D0%25BE%25D0%25B2_%25D1%2581%25D0%25BE%25D1%2581%25D1%2582%25D0%25BE%25D1%258F%25D0%25BD%25D0%25B8%25D1%258F_HTTP">service unavailable</a> ) - it gradually increases with increasing load.  What conclusions can be made by looking at this chart? <br><br><ul><li>  Forward error messages add reliability.  Under load, ten times the full-time, the application behaves quite responsive. </li><li>  Successful response or failure occurs quickly.  The average response time is almost always less than 10 seconds. </li><li>  Failures occur politely.  By rejecting the request in the event of an overload, we replace the awkward time-out with the instant response with the 503rd error. </li></ul><br>  In order to force the server to accurately report the 503rd error, it is only necessary to create a small template with a message for the user.  An example of such an answer can be seen on many popular sites. <br><br><h4>  How to use node-toobusy </h4><br>  The node-toobusy module is available as an <a href="https://npmjs.org/package/toobusy">npm</a> package and <a href="https://github.com/lloyd/node-toobusy">on Github</a> .  After installation ( <code>npm install toobusy</code> ), it is normally included in the application: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> toobusy = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'toobusy'</span></span>);</code> </pre><br>  After connecting, the module begins actively monitoring the process in order to determine when it is overloaded.  You can check its status anywhere in the application, but it is better to do this in the early stages of processing the request. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//      middleware,  //    ,       -  app.use(function(req, res, next) { //    -  toobusy()  , //         if (toobusy()) res.send(503, "I'm busy right now, sorry."); else next(); });</span></span></code> </pre><br>  Already in this form, the node-toobusy module significantly increases the resistance of the application under load.  It remains to choose the <a href="https://github.com/lloyd/node-toobusy">value of sensitivity</a> , the most suitable for your application. <br><br><h4>  How it works? </h4><br>  How can you reliably determine that the Node application is too busy? <br><br>  This is a more interesting question than one would expect, especially considering that node-toobusy works in any out-of-box application.  Consider some approaches to solving this problem: <br><br>  <b>Tracking CPU usage for the current process.</b>  We could use the number shown by the <code>top</code> command - the percentage of time that the processor spends on the application.  If, for example, this figure exceeds 90%, we can conclude that the application is overloaded.  But if several processes work on the machine, one cannot be sure that the process with the Node application can use the processor 100%.  In such a scenario, the application may never reach this 90% and at the same time practically lie. <br><br>  <b>Track total system load.</b>  We could calculate the total system load to take it into account when determining application overload.  We would also have to take into account the number of available processor cores, etc.  Very quickly, this approach turns out to be too complicated, it requires platform-specific extensions, and the process priority must also be taken into account! <br><br>  We need a solution that just works.  All we need is to determine that our application is unable to respond to requests at an acceptable rate.  This criterion does not depend on the platform or on other processes in the system. <br><br>  In node-toobusy, the main event loop delay measurement is used.  This cycle underlies any Node.js application.  All work is queued, and in the main loop, tasks from this queue are executed sequentially.  When the process is overloaded, the queue begins to grow - work becomes more than can be done.  To find out the degree of overload, it is enough to measure the time it takes a tiny task to defend the entire queue.  For this, node-toobusy uses a callback that must be called every 500 milliseconds.  By subtracting 500 ms from the actual measured interval value, you can get the time during which the task was in the queue, that is, the desired delay. <br><br>  Thus, node-toobusy for determining the process overload constantly measures the delay of the main event cycle - it is a simple and reliable method that works in any environment on any server. <br><br><hr><br><div class="spoiler">  <b class="spoiler_title">All articles of the cycle:</b> <div class="spoiler_text"><ol><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/195494/">Hunting for memory leaks in Node.js</a> " </li><li>  "We <a href="http://habrahabr.ru/company/nordavind/blog/195686/">load Node to the eyeballs</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196018/">Store the session on the client to simplify application scaling</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196358/">Frontend performance. Part 1 - concatenation, compression, caching</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196518/">We write a server that does not fall under load</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196818/">Frontend performance. Part 2 - we cache dynamic content using etagify</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/197166/">Taming Web Application Configurations with node-convict</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/197370/">Frontend performance. Part 3 - font optimization</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/197566/">Localization of Node.js Applications. Part 1</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/198154/">Localization of Node.js Applications. Part 2: Toolkit and Process</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/198252/">Localization of Node.js Applications. Part 3: Localization in Action</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/198590/">Awsbox - PaaS infrastructure for deploying Node.js applications in the Amazon cloud</a> " </li></ol><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/196518/">https://habr.com/ru/post/196518/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../196500/index.html">How to disable the search on a new tab Chrome</a></li>
<li><a href="../196504/index.html">Sprint Driver - Feel the power of speed</a></li>
<li><a href="../196510/index.html">The digest of news from the world of mobile development for the last week ‚Ññ27 (September 30 ‚Äî October 6, 2013)</a></li>
<li><a href="../196514/index.html">The system of automatic counting circles and time for RC-car. Part 2 Protocols AMB20 and AMBRc</a></li>
<li><a href="../196516/index.html">6-axis 3D printer works small wonders</a></li>
<li><a href="../196522/index.html">My new tripod ‚ÄúKrutoy_duvuk‚Äù and how I went green</a></li>
<li><a href="../196524/index.html">BlackBerry is negotiating the sale of its assets with Intel, LG, Samsung, Cisco and other</a></li>
<li><a href="../196528/index.html">The FBI does not know what to do with the withdrawn Bitcoins of the Silk Road resource, the FBI does not yet have access to Ross Ulbricht‚Äôs wallet.</a></li>
<li><a href="../196530/index.html">DHTML violence and javascript output to desktop. Restoration of old games. Building Web Applications</a></li>
<li><a href="../196532/index.html">RuSSIR Music Hackathon 2013: notes of the organizer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>