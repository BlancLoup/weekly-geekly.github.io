<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Jii: Scalable comets server and client</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuing a series of articles about the Jii Framework . Today came the time of release of the comet, which I will discuss in this article. 



 Jii-...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Jii: Scalable comets server and client</h1><div class="post__text post__text-html js-mediator-article">  Continuing a series of articles about the <a href="http://www.jiiframework.ru/">Jii Framework</a> .  Today came the time of release of the comet, which I will discuss in this article. <br><br><img src="https://habrastorage.org/files/c04/cc0/3b8/c04cc03b88cb4c61a1c8cda3fde2b632.jpg"><br><br>  <a href="https://github.com/jiisoft/jii-comet"><b>Jii-comet</b></a> is a scalable transport that is ready for high loads and bad Internet, realizing constant communication between the client and the server for instant data exchange. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Jii-comet provides a set of components and classes that make it easy to exchange messages between channels, subscribe to them, exchange data between servers, and so on.  The module itself does not know how to deliver messages to the client and back, but it contains an abstraction so that any of the existing popular libraries (for example, <a href="http://socket.io/">socket.io</a> , <a href="https://github.com/sockjs/sockjs-client">sockjs</a> ) can do this, as well as reliably and scalable. <br><a name="habracut"></a><br>  For those who hears about this framework for the first time, I recommend reading <a href="http://habrahabr.ru/search/%3Fq%3D%255Bjii%255D%26target_type%3Dposts">previous articles</a> or <a href="http://jiiframework.ru/">visiting the site</a> .  In short, <br><blockquote>  Jii is a framework, whose architecture and API is based on the PHP framework Yii 2.0, taking the best sides out of it and retaining the benefits of JavaScript. </blockquote><br><h1>  Overview </h1><br>  First, a little help on what comets are ( <a href="https://ru.wikipedia.org/wiki/Comet_(%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5)">wiki</a> ): <br><blockquote>  Comet (in web development) - any model of a web application, in which a permanent HTTP connection allows the web server to send (push) data to the browser without an additional request from the browser. </blockquote><br><h2>  Jii-comet features </h2><br>  Customer: <br><ul><li>  Sending and receiving messages from channels </li><li>  Subscribe to channels </li><li>  Calling up actions on the server </li><li>  Balancing (random server selection) </li><li>  The ability to change the transport of messages </li></ul><br>  Server: <br><ul><li>  Sending and receiving messages from channels </li><li>  Subscribe to messages from the channel </li><li>  Signing a channel connection </li><li>  Send messages to the connection </li><li>  The ability to change the message transport, hub and queue </li><li>  Scaling to multiple processes and servers </li><li>  Listen-only mode </li><li>  Starting actions from a queue </li></ul><br><h2>  Installation </h2><br>  A comet is installed as a <a href="http://www.jiiframework.ru/guide/structure-application-components">component of the application</a> , on the server and client respectively.  On the server, the comets open and ‚Äúlisten‚Äù to data from the specified port, and the client, when the application is initialized, connects to this port and waits for information. <br><br>  Consider an example of an application where a client subscribes to a <i>test</i> channel on a server and sends a message to it. <br>  Server: <br><br><pre><code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Jii = <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'jii'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'jii-comet'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'jii-workers'</span></span>) .application(<span class="hljs-string"><span class="hljs-string">'comet'</span></span>, Jii.mergeConfigs( { application: { basePath: __dirname, components: { comet: { className: <span class="hljs-string"><span class="hljs-string">'Jii.comet.server.Server'</span></span>, port: <span class="hljs-number"><span class="hljs-number">4401</span></span>, <span class="hljs-comment"><span class="hljs-comment">/** * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> {Jii.comet.server.ConnectionEvent} event */</span></span> <span class="hljs-string"><span class="hljs-string">'on addConnection'</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span><span class="hljs-function"> </span></span>{ Jii.app.comet.subscribe(event.connection.id, <span class="hljs-string"><span class="hljs-string">'test'</span></span>); } } } } }, custom.comet || {} ));</code> </pre> <br>  Customer: <br><br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'jii/deps'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'jii-comet/sockjs'</span></span>); Jii.createWebApplication({ application: { basePath: location.href, components: { comet: { className: <span class="hljs-string"><span class="hljs-string">'Jii.comet.client.Client'</span></span>, serverUrl: <span class="hljs-string"><span class="hljs-string">'http://localhost:4401/comet'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/** * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> {Jii.base.Event} event */</span></span> <span class="hljs-string"><span class="hljs-string">'on open'</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span><span class="hljs-function"> </span></span>{ Jii.app.comet.send(<span class="hljs-string"><span class="hljs-string">'test'</span></span>, {message: <span class="hljs-string"><span class="hljs-string">'Hello World'</span></span>}); }, <span class="hljs-comment"><span class="hljs-comment">/** * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> {Jii.comet.ChannelEvent} event */</span></span> <span class="hljs-string"><span class="hljs-string">'on channel:test'</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span><span class="hljs-function"> </span></span>{ console.log(<span class="hljs-string"><span class="hljs-string">'Income message: '</span></span> + event.params.message); } } } } }).start();</code> </pre><br>  Next, let's look at server and client components. <br><br><h1>  Comet server </h1><br><div style="text-align:center;"><img src="https://habrastorage.org/files/fab/f7a/243/fabf7a24320a4f25964953d5fe1aae57.jpg"></div><br>  <b>Jii-comet</b> provides two classes for creating a server: <br><ul><li>  <i>Jii.comet.server.HubServer</i> is a server configured only for listening to messages from connections, but it does not have the connections itself, but it can send data to a connection that is in a neighboring process.  Those.  It is impossible to connect directly to such a server (on the port), however, the message can be sent through other processes (to which clients are connected). </li><li>  <i>Jii.comet.server.Server</i> is a full-fledged server, inherited from the previous one.  Stores and maintains direct connection with clients, can exchange data with the client. </li></ul><br>  This separation is necessary for flexible application scaling.  For example, you can create several processes with the <i>Jii.comet.server.Server</i> component, which will only maintain connection with clients, but not process business logic.  And create multiple <i>Jii.comet.server.HubServer</i> processes that will perform heavy calculations.  This will make the comet channel more responsive: if all operations were on the same server, complex operations would slow down the process, and all subsequent requests (even light ones) would be delayed. <br><br>  If you do not have large loads or you do not know what to choose, choose the <i>Jii.comet.server.Server</i> component, as it contains all the functionality. <br><br>  The configuration example for the server looks like this: <br><br><pre> <code class="hljs cs">application: { components: { comet: { className: <span class="hljs-string"><span class="hljs-string">'Jii.comet.server.Server'</span></span>, host: <span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span>, port: <span class="hljs-number"><span class="hljs-number">3100</span></span> }, <span class="hljs-comment"><span class="hljs-comment">// ... } }</span></span></code> </pre><br>  A complete list of properties, methods and events is presented below. <br><br><h3>  Jii.comet.server.HubServer </h3><br><h4>  Properties </h4><br><ul><li>  <i>listenActions</i> (boolean) - whether to accept requests to <i>invoke</i> actions from clients.  By default, <i>true</i> . </li><li>  <i>hub</i> (object) - a hub, component, or its configuration that implements the <i>Jii.comet.server.hub.HubInterface</i> interface for exchanging messages between processes or servers.  By default, the <i>Jii.comet.server.hub.Redis</i> component is <i>created</i> . </li><li>  <i>queue</i> (object) - a queue, a component or its configuration that implements the <i>Jii.comet.server.queue.QueueInterface</i> interface for accumulating a queue of actions (actions).  By default, the <i>Jii.comet.server.queue.Redis</i> component is <i>created</i> . </li></ul><br><h4>  Methods </h4><br><ul><li>  <i>start ()</i> - opens the connection for the <i>hub</i> and <i>queue</i> components, starts listening to messages from the channels. </li><li>  <i>stop ()</i> - breaks all connections of components and stops listening to information from the outside. </li><li>  <i>sendToChannel (channel, data)</i> - sends a message to the channel within the hub.  Here <i>channel</i> is (string) the name of the channel, and <i>data</i> is (string | object | *) the data to send. </li><li>  <i>sendToConnection (id, data)</i> - like the previous method, sends data, but not to the channel, but directly to the connection.  Here <i>id</i> (string) is the connection identifier taken from <i>Jii.comet.server.Connection</i> , and <i>data</i> is (string | object | *) the data to send. </li><li>  <i>on (name, handler, data, isAppend)</i> and <i>off (name, handler)</i> - methods for subscribing and unsubscribing to events.  The event list is described below, a description of the arguments can be found in <a href="http://www.jiiframework.ru/guide/concept-events">the event section</a> . </li><li>  <i>hasChannelHandlers (name)</i> - Returns <i>true</i> if the <i>name</i> (string) channel has subscribers to this process. </li></ul><br><h4>  Developments </h4><br><ul><li>  <i>channel</i> - Event is triggered by any incoming message to any channel.  The first handler argument will be passed an instance of the <i>Jii.comet.ChannelEvent</i> class with the <i>channel</i> (string) and <i>message</i> (string) parameters. </li><li>  <i>channel:% my_channel_name%</i> - Event is triggered by any incoming message to the channel specified after </li></ul>  For example, when you call <i>Jii.app.comet.on ('channel: test', ...)</i> , you subscribe to messages in the <i>test</i> channel.  As above, an instance of the <i>Jii.comet.ChannelEvent</i> class with the parameters <i>channel</i> (string) and <i>message</i> (string) will be passed to the event handler as the first argument. <br>  <i>message</i> - The event runs on any incoming message in the hub.  The first argument of the handler will be an instance of the <i>Jii.comet.server.MessageEvent</i> class with the <i>message</i> (string) parameter. <br><br><h3>  Jii.comet.server.Server </h3><br>  Inherits the above properties, methods, and events, and adds the following: <br><br><h4>  Properties </h4><br><ul><li>  <i>host</i> (string) - the host waiting for incoming connections from clients.  The default is <i>0.0.0.0</i> . </li><li>  <i>port</i> (number) - port for incoming connections.  The default is <i>4100</i> . </li><li>  <i>transport</i> (object) - a component or its configuration that implements the <i>Jii.comet.server.transport.TransportInterface</i> interface for exchanging messages directly with clients (browser). </li></ul><br><h4>  Methods </h4><br><ul><li>  <i>subscribe (connectionId, channel)</i> and <i>unsubscribe (connectionId, channel)</i> - subscribes and unsubscribes the connection to the specified channel.  Jii recommends that you subscribe to the channel on the server to avoid a message race.  In the <i>connectionId</i> (string) methods, this is the connection identifier taken from <i>Jii.comet.server.Connection</i> , and <i>channel</i> (string) is the name of the channel. </li></ul><br><h4>  Developments </h4><br><ul><li>  <i>addConnection</i> - The event occurs when a new client is joined.  The first handler argument will be passed an instance of the <i>Jii.comet.server.ConnectionEvent</i> class with the <i>connection</i> parameter ( <i>Jii.comet.server.Connection</i> ). </li><li>  <i>removeConnection</i> - The event occurs when the connection to the client is lost.  Similar to the previous one, the first argument of the handler will be an instance of the <i>Jii.comet.server.ConnectionEvent</i> class. </li></ul><br><h3>  Jii.comet.server.Connection </h3><br>  Contains client connection information <br><br><h4>  Properties </h4><br><ul><li>  <i>id</i> (string) - connection identifier.  Used to send messages directly to the connection. </li><li>  <i>request</i> ( <i>Jii.comet.server.Request</i> ) - connection information: headers, ip address, connection port, and so on. </li><li>  <i>originalConnection</i> (object) - an internal instance of the connection received from the transport.  Specific to each transport. </li></ul><br><h1>  Comet client </h1><br><div style="text-align:center;"><img src="https://habrastorage.org/files/097/b90/0aa/097b900aa4ea472e801b8f91567df656.jpg"></div><br>  The client is a little simpler: there is one <i>Jii.comet.client.Client</i> component that connects to one of the servers and communicates. <br><br><pre> <code class="hljs cs">application: { components: { comet: { className: <span class="hljs-string"><span class="hljs-string">'Jii.comet.client.Client'</span></span>, serverUrl: <span class="hljs-string"><span class="hljs-string">'http://localhost:4401/comet'</span></span>, autoOpen: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, <span class="hljs-comment"><span class="hljs-comment">// ... } }</span></span></code> </pre><br>  A complete list of properties, methods and events is presented below. <br><br><h3>  Jii.comet.client.Client </h3><br><h4>  Properties </h4><br><ul><li>  <i>transport</i> (object) - a component or its configuration that implements the <i>Jii.comet.client.transport.TransportInterface</i> interface for exchanging messages with the server. </li><li>  <i>plugins</i> (object) - a set of components or their configuration, each of which implements the <i>Jii.comet.client.plugin.PluginInterface</i> interface to extend the capabilities of the client‚Äôs comets. </li><li>  <i>workersCount</i> (number | null) - the maximum number of server workers.  This setting is used for load balancing on the client.  By default, <i>null</i> is disabled. </li><li>  <i>autoOpen</i> (boolean) - if <i>true</i> , the client will automatically connect to the server when the comets application is initialized.  By default, <i>true</i> . </li></ul><br><h4>  Developments </h4><br><ul><li>  <i>open</i> - Event is triggered upon successful opening of the connection. </li><li>  <i>close</i> - The event is triggered when the connection is closed. </li><li>  <i>beforeSend</i> - The event is triggered by any outgoing message.  The first argument of the handler will be an instance of the <i>Jii.comet.client.MessageEvent</i> class with the <i>message</i> parameter.  You can change the sent message by changing the <i>message</i> parameter, the data from the <i>message</i> parameter will be sent to the server. </li><li>  <i>channel</i> - The event is triggered by any incoming message to any subscribed channel.  The first handler argument will be passed an instance of the <i>Jii.comet.ChannelEvent</i> class with the <i>channel</i> (string) and <i>message</i> (string) parameters. </li><li>  <i>channel:% my_channel_name%</i> - The event is triggered by any incoming message to the subscribed channel specified after <i>:.</i>  For example, when you call <i>Jii.app.comet.on ('channel: test', ...)</i> , you subscribe to messages in the <i>test</i> channel.  As above, an instance of the <i>Jii.comet.ChannelEvent</i> class with the parameters <i>channel</i> (string) and <i>message</i> (string) will be passed to the event handler as the first argument. </li><li>  <i>message</i> - The event is triggered by any incoming message.  The first argument of the handler will be an instance of the <i>Jii.comet.server.MessageEvent</i> class with the <i>message</i> (string) parameter. </li><li>  <i>beforeRequest</i> - The event runs before the client tries to send a request to the server to perform an action.  The first argument of the handler will be an instance of the <i>Jii.comet.client.RequestEvent</i> class with the <i>route</i> (string) and <i>params</i> (object) parameters.  You can change the request parameters in this event, the data from the <i>params</i> parameter will be sent to the server. </li><li>  <i>request</i> - The event is triggered when the server responds to the action requested previously.  The first argument of the handler will be an instance of the <i>Jii.comet.client.RequestEvent</i> class with the <i>route</i> (string) and <i>params</i> (object) parameters. </li></ul><br><h2>  Plugins </h2><br>  Plugins allow you to extend the capabilities of client comets.  By default, the plugin is installed to automatically reconnect <i>Jii.comet.client.plugin.AutoReconnect</i> .  The plugin is very easy to create and connect.  The interface of the <i>Jii.comet.client.plugin.PluginInterface</i> plugin <i>does</i> not require the implementation of methods, but only provides access to the comet client via the <i>comet</i> parameter through which you can subscribe to comet events.  The plugin is installed and configured through the configuration, by adding it to the <i>plugins</i> section: <br><br><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">application:</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">components:</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">comet:</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">className:</span></span> <span class="hljs-string"><span class="hljs-string">'Jii.comet.client.Client'</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ... <span class="hljs-symbol"><span class="hljs-symbol">plugins:</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">autoReconnect:</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">enable:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> }, <span class="hljs-symbol"><span class="hljs-symbol">myPlugin:</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">className:</span></span> <span class="hljs-string"><span class="hljs-string">'app.components.MyCometPlugin'</span></span> } } }, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ... } }</code> </pre><br><h1>  How it works </h1><br><div style="text-align:center;"><img src="https://habrastorage.org/files/59f/0a7/613/59f0a7613f0b4226945a382f41a39cf2.jpg"></div><br>  At first glance, jii-comet is a wrapper over the library of comets-transport (sockjs, socket.io - to choose from), but this is not so.  From the transport library, only the message delivery functionality to the client and back is taken.  The implementation of channels, subscriptions, scaling and additional chips made it in jii-comet.  Architecturally, "under the hood" jii-comet is divided into the following components: <br><br>  Server: <br><ul><li>  Transport ( <i>Jii.comet.server.transport.TransportInterface</i> ) is an abstraction for exchanging messages between a client and a server. </li><li>  Hub ( <i>Jii.comet.server.hub.HubInterface</i> ) is an abstraction for exchanging messages between processes and servers. </li><li>  The queue ( <i>Jii.comet.server.queue.QueueInterface</i> ) is an abstraction for accumulating action calls. </li><li>  Connection ( <i>Jii.comet.server.Connection</i> ) - an instance of this class contains information about the connection and is available as a <a href="http://www.jiiframework.ru/guide/structure-context-components">component of the context</a> . </li></ul><br>  Customer: <br><ul><li>  Transport ( <i>Jii.comet.client.transport.TransportInterface</i> ) is an abstraction for exchanging messages between a client and a server. </li><li>  The plugin ( <i>Jii.comet.client.plugin.PluginInterface</i> ) is an abstraction for extending the capabilities of the client's comets.  By default, the plugin is installed to automatically reconnect <i>Jii.comet.client.plugin.AutoReconnect</i> . </li></ul><br>  All of these abstractions can be configured and redefined via application <a href="http://www.jiiframework.ru/guide/concept-configurations">configuration</a> and context. <br><br><h2>  Examples </h2><br><ul><li>  several clients </li><li>  several server processes only for maintaining connections ( <i>Jii.comet.server.Server</i> and <i>listenActions</i> = <i>false</i> ) </li><li>  several server processes for maintaining connections and handling actions ( <i>Jii.comet.server.Server</i> and <i>listenActions</i> = <i>true</i> ) </li><li>  several server processes for processing actions only ( <i>Jii.comet.server.HubServer</i> and <i>listenActions</i> = <i>true</i> ) </li></ul><br><h3>  Example: The client sends a message to the channel. </h3><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7cb/96b/cdc/7cb96bcdcfcd4c69b07542c9f1bf873a.png" alt="jii-comet: The client sends a message to the channel"></div><br><br><ol><li>  The client sends a message to the <i>test</i> channel. </li><li>  The server process supporting the connection accepts this message and sends it to the hub ( <i>Jii.comet.server.hub.HubInterface</i> ). </li><li>  The hub sends this message to all server processes that are subscribed to this channel (or their connections are signed). </li><li>  Server processes receive a message and send it to connections that are subscribed to it. </li></ol><br><h3>  Example: Client triggers server action </h3><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/1af/055/c8d/1af055c8d58d4a8dbc023e2df62ba39e.png" alt="jii-comet: The client invokes the action on the server"></div><br><ol><li>  The client sends a request to perform the <i>site / test</i> action. </li><li>  The server process supporting the connection accepts it and drops it into the action queue ( <i>Jii.comet.server.queue.QueueInterface</i> ), as well as through the hub ( <i>Jii.comet.server.hub.HubInterface</i> ) sends a notification to all servers that process the actions ( <i>listenActions</i> = <i>true</i> ) that the queue is refreshed. </li><li>  One of the server processes with <i>listenActions</i> = <i>true</i> takes the request out of the queue (using the <a href="http://redis.io/commands/lpop">lpop</a> method in the implementation of Redis) and starts the action itself. </li><li>  After performing the action, the server process sends the result of the action (response) back to the client.  Since this server process does not have a direct connection with the client, it sends it to the hub ( <i>Jii.comet.server.hub.HubInterface</i> ). </li><li>  The hub sends a message to a server process subscribed to messages for this connection. </li><li>  The server process supporting this connection receives the message and sends it directly to the client. </li></ol><br>  In the third paragraph, a request from the queue could pull out any server process with <i>listenActions</i> = <i>true</i> .  This works on the principle of "who had time" and, as a rule, the least loaded server will have time.  Thus, balancing of action calls between servers and their processes is performed. <br><br><h2>  Internal communication channel </h2><br>  Jii-comet has an abstraction that allows you to use any library as an internal channel of communication between the client and the server.  At the moment, an adapter has been made for the <a href="https://github.com/sockjs/sockjs-client">sockjs</a> library, in the future it will also appear for <a href="http://socket.io/">socket.io</a> . <br><br>  In the configuration, the transport is declared in the <i>transport</i> section.  By default, the class <i>Jii.comet.server.transport.Sockjs</i> in the north and <i>Jii.comet.client.transport.Sockjs</i> on the client are used. <br>  Vehicles can be configured and redefined via configuration: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">comet</span></span>: { <span class="hljs-attribute"><span class="hljs-attribute">className</span></span>: <span class="hljs-string"><span class="hljs-string">'Jii.comet.client.Client'</span></span>, transport: { className: <span class="hljs-string"><span class="hljs-string">'Jii.comet.client.transport.Sockjs'</span></span>, transports: [ <span class="hljs-string"><span class="hljs-string">'websocket'</span></span>, <span class="hljs-string"><span class="hljs-string">'xhr-streaming'</span></span>, <span class="hljs-string"><span class="hljs-string">'xdr-streaming'</span></span>, <span class="hljs-string"><span class="hljs-string">'jsonp-polling'</span></span> ] } }</code> </pre><br><h1>  The end </h1><br>  <a href="http://www.jiiframework.ru/">Framework</a> Site - <a href="http://www.jiiframework.ru/">jiiframework.ru</a> <br>  GitHub - <a href="https://github.com/jiisoft">github.com/jiisoft</a> <br>  Send your suggestions and suggestions to affka@affka.ru <br><br><blockquote><h2>  Like the idea of ‚Äã‚Äãthe framework?  Put a <a href="https://github.com/jiisoft/jii/stargazers">star</a> on the <a href="https://github.com/jiisoft/jii">githaba</a> ! </h2></blockquote><br><div class="spoiler">  <b class="spoiler_title">Article Navigation</b> <div class="spoiler_text"><ul><li>  <a href="http://habrahabr.ru/post/268361/">Jii: A complete application with Yii2 architecture in the browser</a> </li><li>  <a href="http://habrahabr.ru/post/266929/">Jii: configuration and scaling</a> </li><li>  <a href="http://habrahabr.ru/post/260931/">Jii - a JavaScript framework with architecture from Yii 2</a> </li><li>  <a href="http://habrahabr.ru/post/260569/">Jii: Active Record for Node.js with API from Yii 2</a> </li><li>  <a href="http://habrahabr.ru/post/260295/">Jii: Full Query Builder for Node.js with API from Yii 2</a> </li></ul></div></div></div><p>Source: <a href="https://habr.com/ru/post/268817/">https://habr.com/ru/post/268817/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268807/index.html">ZFS on CentOS: work on the bugs</a></li>
<li><a href="../268809/index.html">The task of Alexander Ivanovich Koreyko</a></li>
<li><a href="../268811/index.html">How to protect your company from zero-day attacks</a></li>
<li><a href="../268813/index.html">Engineering infrastructure as the basis of the information system</a></li>
<li><a href="../268815/index.html">Not all widgets are equally useful.</a></li>
<li><a href="../268819/index.html">Adobe has updated its products</a></li>
<li><a href="../268821/index.html">CISCO 7942G and 7940 phones in conjunction with Asterisk 11</a></li>
<li><a href="../268823/index.html">How to install Nutanix CE under VMware ESXi</a></li>
<li><a href="../268825/index.html">Angular XSLT module</a></li>
<li><a href="../268827/index.html">How to do without WDS server when installing Windows from WIM images over a network</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>