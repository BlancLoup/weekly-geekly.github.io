<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A few words about REST API on symfony in the FOSRestBundle + JMSSerializerBundle bundle</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! Let's talk about building a REST API solution on the FOSRestBundle + JMSSerializerBundle. 


 A bit of our history. 
 Our journey to the develo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A few words about REST API on symfony in the FOSRestBundle + JMSSerializerBundle bundle</h1><div class="post__text post__text-html js-mediator-article">  Hello!  Let's talk about building a REST API solution on the FOSRestBundle + JMSSerializerBundle. <br><a name="habracut"></a><br><br><h2>  A bit of our history. </h2><br>  Our journey to the development of the REST API began about four years ago (we are <a href="http://glavweb.ru/">GLAVWEB</a> ).  The first attempt was to write your own bike on the Yii framework.  Happened.  And in the future, with minor modifications, we applied this solution on several small projects.  Since I do not have third-party ‚Äúbicycles‚Äù of my own, in the following projects we already use one of the restful extensions of the Yii framework, periodically finishing it. <br><br>  Then symfony came to our company.  New projects on Yii, we have not taken.  Began to look what exist REST solutions for symfony.  Of course, the first thing we started experimenting with is the standard FOSRestBundle + JMSSerializer build (+ NelmioApiDocBundle for generating documentation).  If anyone is interested, the documentation is <a href="http://symfony.com/doc/current/bundles/FOSRestBundle/index.html">here</a> .  What was pleasant about it is the absence of magic with controllers (I mean the dynamic generation of routes based on the models and the processing of all requests in the basic controller) and the presence of magic with the generation of documentation. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  So, FOSRestBundle + JMSSerializerBundle </h2><br>  The solution based on FOSRestBundle + JMSSerializer has a good reputation in our projects.  But before you develop a project more than your own blog, you need to decide on the following issues: <br><ul><li>  How to implement an access rights management system? </li><li>  How to organize filtering of lists? </li><li>  How to determine the boundaries of nesting entities in each arc? </li><li>  How to return only certain fields of an entity? </li><li>  How to return a specific set of fields depending on the request? </li><li>  How to modify return values? </li><li>  how to organize file upload in PUT? </li><li>  How to test REST API? </li></ul><br>  Let's take a closer look at each of them. <br><br>  <b>How to implement an access rights management system?</b> <br><br>  A symphony out of the box has a couple of solutions to this effect: <br>  - use ACL, you can read <a href="http://symfony.com/doc/current/cookbook/security/acl.html">here</a> ; <br>  - to organize a system of separation of access rights based on roles + voter (voter), read <a href="http://symfony.com/doc/current/cookbook/security/voters.html">here</a> . <br><br>  For ourselves, we chose the second option. <br><br>  <b>How to organize filtering of lists?</b> <br><br>  At first, as most developers probably did, we created a basic controller.  It implemented the basic methods for filtering, creating and updating entities.  A method that implements filtering dynamically generated a queribiler based on the parameters passed in the request.  We transferred this controller from project to project.  Somewhere it was finished as needed.  Ultimately, in different projects this basic controller had significant differences. <br><br>  Next, we decided to make it a little.  Brought filtering to a special service, logic with the addition and updating of entities in a separate class (action pattern).  This is how <a href="https://github.com/glavweb/GlavwebRestBundle">GlavwebRestBundle</a> was born.  At the time, he looked something <a href="https://github.com/glavweb/GlavwebRestBundle/tree/92727e583f203c53b4aa8ee413ae83ec0b8045d5">like this</a> . <br><br>  <b>How to determine the boundaries of nesting entities in each arc?</b> <br><br>  And I mean, that situation when one entity contains a collection of others.  To solve this problem, the JMSSerializer has an attribute ‚ÄúMaxDepth‚Äù, in essence it looks like this: <br><br><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@JMS</span></span></span><span class="hljs-comment">\MaxDepth(depth=2) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $groups;</code> </pre> <br><br>  But there are pitfalls.  The depth is considered from the beginning of the json object of the resulting, and not based on the essence.  Those.  if our object is nested in a collection, then the depth should be 3, and if we return our object in a single copy, then depth = 2. When entities are nested into each other many times, we get terrible things like: <a href="https://habrahabr.ru/users/jms/" class="user_link">JMS</a> \ MaxDepth (depth = 7) .  Below I will show how we got rid of MaxDepth. <br><br>  <b>How to return only certain fields of an entity?</b> <br><br>  Suppose we have the ‚Äúuser‚Äù entity, the user contains a number of fields, including the password that we don‚Äôt want to show in api.  The ExclusionPolicy strategy and the Expose attribute in the JMSSerializer will help us with this. <br><br>  For the class, we define the ExclusionPolicy strategy: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">JMS</span></span>\<span class="hljs-title"><span class="hljs-title">Serializer</span></span>\<span class="hljs-title"><span class="hljs-title">Annotation</span></span> <span class="hljs-title"><span class="hljs-title">as</span></span> <span class="hljs-title"><span class="hljs-title">JMS</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@JMS</span></span></span><span class="hljs-comment">\ExclusionPolicy("all") */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MedicalEscortType</span></span></span><span class="hljs-class"> </span></span>{</code> </pre><br><br>  And we specify Expose for those fields that we need in api, all the rest will be skipped by the JMSSerializer <br><br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@JMS</span></span></span><span class="hljs-comment">\Expose * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> integer */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $name;</code> </pre><br><br>  <b>How to return a specific set of fields depending on the query?</b> <br><br>  Often, for a list of objects, we need a limited set of data, and to view a specific object - a complete one.  This is possible using the ‚ÄúGroups‚Äù attribute in the JMSSerializer.  For each entity, we defined at least two groups: entity_list and entity_view. <br><br>  In the controller via the request parameters, we get the necessary values ‚Äã‚Äãand transfer them to the SerializerContext serializer. <br><br><pre> <code class="php hljs">$scopes = array_map(<span class="hljs-string"><span class="hljs-string">'trim'</span></span>, explode(<span class="hljs-string"><span class="hljs-string">','</span></span>, $request-&gt;get(<span class="hljs-string"><span class="hljs-string">'_scope'</span></span>))); $serializationContext = SerializationContext::create() -&gt;setGroups(array_merge($scopes, [GroupsExclusionStrategy::DEFAULT_GROUP])) ; $view = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;view($data, $statusCode, $headers); $view-&gt;setSerializationContext($serializationContext) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $view;</code> </pre><br><br>  This solved the nesting problem; we no longer need to specify MaxDepth for fields.  Now the client, turning to the api, could configure the nesting he needed and select one of two sets of fields (list or view). <br><br>  <b>How to modify return values?</b> <br><br>  Here, too, the JMSSerializer comes to the rescue, we define the listener and change the output in it as we like. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">JMS</span></span>\<span class="hljs-title"><span class="hljs-title">Serializer</span></span>\<span class="hljs-title"><span class="hljs-title">EventDispatcher</span></span>\<span class="hljs-title"><span class="hljs-title">EventSubscriberInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">JMS</span></span>\<span class="hljs-title"><span class="hljs-title">Serializer</span></span>\<span class="hljs-title"><span class="hljs-title">EventDispatcher</span></span>\<span class="hljs-title"><span class="hljs-title">ObjectEvent</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Vich</span></span>\<span class="hljs-title"><span class="hljs-title">UploaderBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Templating</span></span>\<span class="hljs-title"><span class="hljs-title">Helper</span></span>\<span class="hljs-title"><span class="hljs-title">UploaderHelper</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Class SerializationListener * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@package</span></span></span><span class="hljs-comment"> AppBundle\Listener */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SerializationListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventSubscriberInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> UploaderHelper */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $uploaderHelper; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> UploaderHelper $uploaderHelper */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UploaderHelper $uploaderHelper)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;uploaderHelper = $uploaderHelper; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSubscribedEvents</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'event'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'serializer.post_serialize'</span></span>, <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'AppBundle\Entity\User'</span></span>, <span class="hljs-string"><span class="hljs-string">'method'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'onPostSerializeUserAvatar'</span></span>) ); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> ObjectEvent $event */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPostSerializeUserAvatar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ObjectEvent $event)</span></span></span><span class="hljs-function"> </span></span>{ $url = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;uploaderHelper-&gt;asset($event-&gt;getObject(), <span class="hljs-string"><span class="hljs-string">'avatarFile'</span></span>); $event-&gt;getVisitor()-&gt;addData(<span class="hljs-string"><span class="hljs-string">'avatarUrl'</span></span>, $url); }</code> </pre><br><br>  <b>How to organize uploading files to PUT?</b> <br><br>  Since  the PUT method does not allow to send the form, there were options to update the files, use POST or encode the files in base64.  Neither one nor the other did not suit us.  It was decided to load and delete files with the help of separate requests to api for each field.  Suppose a user has an ‚Äúavatar‚Äù field, respectively, you need to implement two additional methods: POST / api / user / {user} / avatar to upload a new avatar (submit a form with one file field) and DELETE / api / user / {user} / avatar to remove the existing avatar. <br><br>  <b>How to test REST API?</b> <br><br>  A very important question, at least for us.  There are enough nuances, I will describe them in more detail in one of the following articles.  In short, we used LiipFunctionalTestBundle + fixtures in conjunction with AliceBundle.  And we wrote our own class in which we implemented the necessary functions.  This component was also defined in the <a href="https://github.com/glavweb/GlavwebRestBundle/tree/master/Test">GlavwebRestBundle</a> . <br><br><h2>  Conclusion </h2><br>  As practice has shown, the FOSRestBundle + JMSSerializer solution is generally working.  But the world dictates more and more demands.  This forced us to revise the concept of implementing REST API on symfony.  We will talk about this in the <a href="https://habrahabr.ru/post/303366/">next article</a> . </div><p>Source: <a href="https://habr.com/ru/post/302902/">https://habr.com/ru/post/302902/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302892/index.html">HPE invests in containers</a></li>
<li><a href="../302894/index.html">How to bring a remote command</a></li>
<li><a href="../302896/index.html">Asynchrony in JavaScript: A guide for those who want to understand</a></li>
<li><a href="../302898/index.html">Mozilla Firefox 48 beta web browser has the ability to split processes</a></li>
<li><a href="../302900/index.html">How to trick the GPS Glonass without vandalism</a></li>
<li><a href="../302904/index.html">The difference between disaster recovery, backup and business continuity</a></li>
<li><a href="../302906/index.html">In the data center market. Apple and Microsoft are expanding their holdings</a></li>
<li><a href="../302910/index.html">Selecting and configuring the Garbage Collector for Highload system in the Hotspot JVM</a></li>
<li><a href="../302912/index.html">Programming skills</a></li>
<li><a href="../302914/index.html">Quantity and quality: how do task trackers develop in a competitive environment</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>