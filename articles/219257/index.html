<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Eron-dong-dong or what else could your Windows Phone do?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello to all habrazhiteli! 

 Surely, many people in childhood liked cars on the radio. And not only in childhood: I am sure that in the age group of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Eron-dong-dong or what else could your Windows Phone do?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/58d/bc2/d26/58dbc2d264a469ee9d6efff9063e006e.gif" alt="image"><br><br>  Hello to all habrazhiteli! <br><br>  Surely, many people in childhood liked cars on the radio.  And not only in childhood: I am sure that in the age group of 30+ there will be a lot of fans of a dashing ride on a miniature scale.  So I dreamed of such a typewriter since childhood, but girls are usually not given cars but dolls, and my dream remained unfulfilled until recently.  But now I grew up, and a simple radio-controlled machine seemed rather boring to me.  And one fine day I had an idea how to entertain myself and at the same time modernize a car: I decided to organize its management from a smartphone via WiFi. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I caught fire with this idea, especially since the target smartphone is the Nokia Lumia 620, and I was interested in programming in C # before.  The work on the software part promised to be cloudless and fascinating, but with the hardware, everything was a little more complicated, and I began to google and study the hardware. <br><br>  Since I am not an electrician, in order to organize the work of the hardware of my machine, I had to search around the Internet for a long time in search of guides on the basics of robotics for blondes.  As always, the beloved Habr helped, namely <a href="http://habrahabr.ru/post/153017/">this post</a> , written in a language understandable even for a person very far from electronics.  Everything is painted there very well, so I will not dwell on the hardware in detail; I will only tell you about the differences between my typewriter and the WiFi bot described there: <br><br>  ‚Ä¢ Since the machine is intended for entertainment, and not for monitoring the premises, it doesn‚Äôt need a webcam (although it may be worth developing this topic in the future ...).  The same applies to the autonomous charging system.  A full battery charge (I used the Sanyo Eneloop AA with a capacity of 2500 mAh) is quite enough in time to play enough. <br><br>  ‚Ä¢ So that all the stuffing got into the body of the machine, and also not to suffer especially with soldering (I'm blonde, after all ...) I used a slightly smaller Arduino Nano v3.0 microcontroller with a USB interface.  The presence of a USB interface, in addition to connecting the MC to the router without soldering, also greatly simplifies the process of programming the arduin: connected to a computer -&gt; filled in the sketch directly from the Arduino IDE -&gt; enjoy.  I also took the other router, TP-LINK WR703N, it is slightly less than the TL-MR3020, but otherwise they are almost identical. <br><br>  ‚Ä¢ Since we do not solder the MK to the router, but connect via USB, then the UART's forwarding is performed virtually with the help of the ser2net daemon, which by default is present in the OR-WRT firmware of our router.  All you have to do is add the following line to the ser2net.conf file on the router (or replace it if something is already written to port 2000): <br><img src="https://habrastorage.org/getpro/habr/post_images/a5c/774/0e4/a5c7740e49ebc4b94858cd5a0629db1f.png" alt="image"><br>  In principle, it is not necessary to use exactly 2000 port, you can take any free one. <br><br>  So, to summarize.  The hardware part of the machine in my version of kitchen robotics is ‚Äúprepared‚Äù according to this recipe: <br><br>  <u><i>Ingredients:</i></u> <br>  Jeepik on radio control, TP-LINK TL-MR3020 or WR703N router, Arduino Nano microcontroller, L293D engine driver, 2 non-microUSB cables, 4 batteries. <br><br>  <u><i>Cooking:</i></u> <br>  1. Reflash the router with OR-WRT firmware and carry out the initial configuration. <br>  2. Configure communication with arduine using ser2net. <br>  3. Remove the radio control board from the machine. <br>  4. Power up the router.  Alternatively, this can be done in the simplest and most obvious way: since the router is powered through its microUSB interface, we cut a piece of the right size from one cable with the end on which there is a small connector.  Cut off the end of the solder to the wiring coming from the battery compartment of the machine (pinout wires: pin1 - V + (5V), pin5 - V- (GND)), plug the connector into the appropriate slot. <br>  5. Connect the MC to the router using the second microUSB cable and solder the required (see later) outputs of the MC to the corresponding inputs of the motor driver chip, and its outputs directly to the engines of the machine. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9e8/6a4/e9f/9e86a4e9ff38b194340db17ce14d7cde.png" alt="image"><br>  <i>Structural scheme</i> <br><br>  Voila, the machine itself is ready!  I repeat, this is a very schematic and simplified description of the procedure, more detailed instructions - in <a href="http://habrahabr.ru/post/153017/">this source</a> . <br><br>  And now the most interesting and creative (at least for me) part of the work is the creation of a program that will manage all this happiness.  Its essence lies in the fact that when you press the control buttons to send the appropriate signals to the router, which, in turn, will give them to Ardouin, and it controls the engines of the machine through the engine driver.  That is, the software part consists of two components: a program for a smartphone and a program for MC. <br><br>  I thought for a long time exactly how best to send a typewriter signals, tried a bunch of options and stopped at this: when you press a certain control button, the typewriter will send a signal about the beginning of movement (activation of the corresponding engine), and when released - about the termination of movement (engine deactivation) .  I coded the control signals as follows: <br><img src="https://habrastorage.org/getpro/habr/post_images/caa/9a2/0cb/caa9a20cbc9799d3adc0009d1e57c070.png" alt="image"><br>  1 - start moving forward, 2 - start moving left, 3 - start moving back, 4 - start moving right.  And, accordingly, 5 - to finish the movement forward, 6 - to finish the movement to the left, 7 - to finish the movement back, 8 - to finish the movement to the right.  Buttons "forward" and "back" work with the main engine of the typewriter, and the "left" and "right" - with a rotary. <br><br>  After that, you can safely begin programming the arduin, which is to check the presence of incoming data in the cycle while it is on, and set the HIGH or LOW level on the corresponding leg when you take a certain digit.  <a href="http://pastebin.com/JuRL0nuw">The</a> sketch <a href="http://pastebin.com/JuRL0nuw">code is</a> elementary, switch / case to help us. <br><br>  But the mobile application will be more difficult.  First of all, we need to contact the machine, namely, with our machine, if there are several available WiFi networks around.  First, let's configure the router to work in the access point mode using its new web interface. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/22c/8f6/ab1/22c8f6ab1008fad2d689e6dc648b2f72.png" alt="image"><br><br>  As you can see, after flashing, the IP address of the router in the access point mode - 192.168.218.1 - does not change.  It is to this address that we will send data to the router.  We will invent a network of our typewriter SSID and password to avoid connecting to the machine of other devices besides ours.  Of course, we can not exclude the possibility of hacking our network, but it is extremely unlikely that someone will suffer such nonsense, for obvious reasons. <br><br>  Now our network is unique and only our smartphone can connect to it.  Therefore, the first thing that our application should do is to check the connection of the phone to the typewriter.  And if the check is successful, you can start (the start button, inactive by default, is activated), and if not, you need to send the user to check the connection. <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">var</span></span></span><span class="hljs-function"> network </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> new </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NetworkInterfaceList</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>))</span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">//    { if ((network.InterfaceType == NetworkInterfaceType.Wireless80211) &amp;&amp; (network.InterfaceState == ConnectState.Connected) &amp;&amp; (network.InterfaceName == "WiFi_Car"))//   ‚Äì   –Ü 80211 (WiFi),  SSID   SSID  { CarName.Text = network.InterfaceName; // SSID     StartButton.IsEnabled = true; //   ¬´¬ª  break; } else { CarName.Text = "  .  WiFi-."; StartButton.IsEnabled = false; } }</span></span></span></span></code> </pre> <br>  Here is the layout of the application's start page: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/90b/5f9/3e9/90b5f93e9d7be15aa86b10877a99f4e1.png" alt="image"><br><br>  When we have successfully connected to the typewriter, clicking on the ‚ÄúSTARTING UP!‚Äù Button takes you to the main page of the application, from which we will control the machine: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a2a/6e3/4ab/a2a6e34ab6af346e70826185c234c9a1.png" alt="image"><br><br>  And here it is - the moment of truth: the transfer of typewriter control signals.  We will organize this process using a socket.  When you open this page, a socket connection with the router is established.  To do this, we need to create several components: <br><br><pre> <code class="cs hljs">IPEndPoint routerPort = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IPEndPoint(IPAddress.Parse(<span class="hljs-string"><span class="hljs-string">"192.168.218.1"</span></span>), <span class="hljs-number"><span class="hljs-number">2000</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    ,   IP-    ,      ser2net Socket S = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp); //    SocketAsyncEventArgs socketEventArgs = new SocketAsyncEventArgs();// -       byte[] buf = new byte[1]; // ‚Äì     (     1 )</span></span></code> </pre><br>  After that we will connect: <br><br><pre> <code class="cs hljs">socketEventArgs.RemoteEndPoint = routerPort; <span class="hljs-comment"><span class="hljs-comment">//        S.ConnectAsync(socketEventArgs); //    socketEventArgs.SetBuffer(buf, 0, 1); //    </span></span></code> </pre><br>  The functions of capturing pressing and releasing control buttons are implemented, respectively, by the methods <i>MouseEnter</i> and <i>MouseLeave</i> .  To exclude emergency situations associated, for example, with simultaneous pressing of buttons of opposite directions, we enter for each button a flag that will be an indicator of the movement of the machine in the corresponding direction.  The push and release functions of all the arrow buttons have the same structure. <br><br>  <b>Pressing:</b> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> [ ]_MouseEnter (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, System.Windows.Input.MouseEventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (![  ] &amp;&amp; ![  ]) { buf[<span class="hljs-number"><span class="hljs-number">0</span></span>] = [-     ]; Socket.SendToAsync(socketEventArgs); [  ] = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }</code> </pre><br>  <b>Release:</b> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> [ ]_MouseLeave(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, System.Windows.Input.MouseEventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([  ]) { buf[<span class="hljs-number"><span class="hljs-number">0</span></span>] = [     ]; Socket.SendToAsync(socketEventArgs); [  ] = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }</code> </pre><br>  It is worth noting here that the transfer of data to the remote node should be done using the <i>SendToAsync</i> method and not confuse it with a similar method, <i>SendAsync</i> .  The difference is that <i>SendAsync</i> sends data from our socket to another socket, and <i>SendToAsync</i> is just to the remote node, which is what we need, so if you confuse the methods, the data will not be sent. <br><br>  Also note that when I test-drive a car from a laptop, I discovered that when both engines, main and turn, are working simultaneously, there are occasional emergency situations like loss of communication with the router.  I suspect that this is due to the subsidence of the voltage on the inside of the machine, because similar bugs were also noticed when the batteries are low.  After all, so many consumers are fed by poor 4 batteries.  Therefore, I removed the spring from the swivel wheels, which returned them to their original position, so that the motors could be started sequentially, and in the mobile application they did not intentionally provide for the possibility of simultaneous operation of both engines.  So far, and when there is a way to improve the power supply system of the machine, then it will be possible to think about expanding its functional capabilities. <br>  Now the matter remains for the small: to implement the closure of the socket connection and return to the start page when we roll.  I have these functions as a button in the form of an ignition key: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">key_MouseEnter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, System.Windows.Input.MouseEventArgs e</span></span></span><span class="hljs-function">)</span></span> { S.Close(); <span class="hljs-comment"><span class="hljs-comment">//     NavigationService.Navigate(new Uri("/MainPage.xaml", UriKind.Relative)); }</span></span></code> </pre><br>  So, in general, that's all, now you can play safely!  For full immersion, you can also add a button to turn on / off the music, and put some suitable song to play.  For example, I could not resist, and my machine goes under <i>Lil Jon &amp; the Eastside Boyz - Get Low</i> . <br><br>  I offer you a short video about the results of my inspired work: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/EXr6JbH0_hc%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700191,15700253&amp;usg=ALkJrhj0nlePL1o56BYpYO13PCcIOXNYzQ" frameborder="0" allowfullscreen=""></iframe><br><br>  <b>PS:</b> I would be very happy for constructive criticism and optimization suggestions.  But do not judge strictly, please, this is my first project of this magnitude. <br><br>  <b>PPS:</b> Thank you so much <a href="http://habrahabr.ru/users/svavan/" class="user_link">svavan</a> for help with the hardware!  Since I was familiar with electronics and the process of flashing routers very vaguely, I would not have managed without this help. </div><p>Source: <a href="https://habr.com/ru/post/219257/">https://habr.com/ru/post/219257/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../219247/index.html">Twitter: Revolutions Continue?</a></li>
<li><a href="../219249/index.html">Automatic monitoring using Nagios and Puppet</a></li>
<li><a href="../219251/index.html">Connecting the VFD Futaba GP1183A01B display to the Raspberry Pi</a></li>
<li><a href="../219253/index.html">Quadcopter DJI Phantom FC40 - mini-stripping and first flight</a></li>
<li><a href="../219255/index.html">L√ñVE + Android + AdMob = friendship</a></li>
<li><a href="../219259/index.html">5 The most exciting events that occurred in space [translation]</a></li>
<li><a href="../219261/index.html">Monitoring and diagnostics of virtual desktop infrastructure</a></li>
<li><a href="../219263/index.html">Batl: STM32 Developer Platform</a></li>
<li><a href="../219267/index.html">Database design. Design and method</a></li>
<li><a href="../219269/index.html">Teachers removed from teaching for "dangerous" scientific experiments</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>