<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>7 lessons learned from creating Reddit</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="UPD. The original article is quite old - 2010. Now the situation looks different. 

 In December 2010, Reddit had 829M hits and 119 servers. 
 At the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>7 lessons learned from creating Reddit</h1><div class="post__text post__text-html js-mediator-article">  <b>UPD.</b>  The original article is quite old - 2010.  Now the situation looks different. <br><br>  In December 2010, Reddit had 829M hits and 119 servers. <br>  At the end of 2011 - 2.07B views and 240 servers. <br><br>  Thank you <a href="http://habrahabr.ru/users/potomushto/" class="user_link">potomushto</a> for the update. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>UPD 2.</b> Corrected scheme for people with color perception problems.  Thank you <a href="http://habrahabr.ru/users/second_pilot/" class="user_link">second_pilot</a> and <a href="http://habrahabr.ru/users/spiritedflow/" class="user_link">spiritedflow</a> <br><hr><br><br>  Steve Huffman, one of the creators of Reddit, told at the presentation what they had learned while building and developing Reddit to 7.5 million users per month, 270 million page views per month and more than 20 database servers. <br><br><br>  Steve said that most of the lessons learned were obvious, so the presentation will not be radically new ideas.  But Steve has a lot of experience, and if he couldn't see this rake, then maybe you should pay attention to these ‚Äúobvious things‚Äù. <br><br><br>  Each of the 7 lessons will be discussed in the corresponding section. <br><ul><li>  Fall often </li><li>  Separation of services </li><li>  Open data schema </li><li>  Avoid storing states </li><li>  Memcache </li><li>  Save redundant data </li><li>  Perform maximum work in the background </li></ul><br><a name="habracut"></a><br>  The most interesting point of the Reddit architecture is ‚ÄúLesson 6 - save redundant data‚Äù.  The basic idea is very simple - we reach speed by making a pre-calculation of everything and caching it.  Reddit uses the maximum pre-calculation.  It seems that everything that you see on Reddit was calculated in advance and cached, regardless of how many versions of the data they have to store.  For example, they cache all 15 ways to sort messages (hot, new, best old, this week, etc.) for a list of messages as soon as someone adds a link.  Ordinary developers will be afraid to make such an extreme cache, considering it a waste of resources.  But the Reddit team thinks it's better to spend some resources than to slow down.  Spending disk space and memory is better than keeping users waiting.  So, if you were embarrassed to use pre-calculation and caching to the maximum, you have a good precedent. <br><br><br><h5>  Lesson 1: Fall down often </h5><br><br>  The essence of the lesson is simple - automatically restart the crashed or failed services. <br><br>  The problem with using dedicated servers is that you are constantly responsible for their support.  When your service crashes, you should fix it right now, even at 2 am.  This creates a constant background tension in your life.  You must constantly carry a computer with you, and you know that at any moment someone can call to report about another disaster.  Which will have to rake.  Such an approach makes life unbearable. <br><br>  One of the methods to solve this problem is to restart the service, which has died or began to behave incorrectly.  Reddit uses supervisors to restart applications.  Special monitoring programs kill processes that eat up too much memory, CPU time, or just hang.  Instead of worrying, just restart the system.  Of course, you will have to read the logs in order to understand the reason for the fall.  But such an approach will keep you calm and reasonable. <br><br><br><h5>  Lesson 2: Sharing Services </h5><br><br>  The essence of the lesson - group similar processes and data on different machines. <br><br>  Performing too many actions on one machine will require a large context switch for tasks.  Try to make each of your servers serve a particular data type in a specific way.  This means that all your indexes will fall into the cache, and will not fall out of it.  Keep similar data as close as possible to each other.  Do not use Python streams.  They slow down.  Reddit developers have divided everything into several services.  Services include spam checking, image processing and query caching.  This makes it easy to spread them across multiple machines.  Thus, they solved the problem of process interactions.  And when this problem is solved, the architecture becomes cleaner and grows easier. <br><br><br><h5>  Lesson 3: Open Database Schema </h5><br><br>  The essence of the lesson - do not worry about the scheme. <br><br>  The developers of Reddit have spent a lot of time worrying about the data structure and their normalization.  Scheme changes became more and more expensive as they grew.  Adding one column to 10 million lines required a bunch of locks, and worked very poorly.  Reddit used replication for scaling and backup.  Updating the schema and replication support is hard work.  Sometimes you had to restart replication, and the backup might not work all day.  The releases also caused problems, because they had to make sure that the software update and the update of the database schema were completed simultaneously. <br><br><br>  Instead, they use the Table of Entities and the Data Table.  In Reddit-e, everything is an entity ‚Äî users, links, comments, sub-forums, awards, etc.  Entities share several common attributes, such as votes for / against, type, date of creation.  The Data Table contains 3 columns - thing id, key, value.  On line for each attribute.  There is a line for the title, for the link, the author, votes for spam, etc.  Now, when adding a new feature, they don‚Äôt have to worry about the structure of the database.  No need to add new tables for new entities or worry about updates.  Easier to design and maintain.  Price - the inability to use cool relational capabilities.  You cannot use join and you must manually ensure data integrity.  You do not have to worry about foreign keys when you join, or how to split data.  In general, it turned out well.  Concerns about relational databases are a thing of the past. <br><br><br><br><h5>  Lesson 4: Avoid storing states </h5><br><br>  The goal of each server is simple - to process a request of any type.  And while Reddit was growing up, they had to use more and more machines, and it was already impossible to rely on the application server cache.  Initially, they duplicated the state of each application server, which was a waste of RAM.  They could not use memcached, because they kept a huge amount of small data in their memory, which did not give an increase in speed.  They rewrote the service to support memcache and no longer store state in the application servers.  Even if the application servers are falling - life does not stop.  And scaling is now just a matter of adding new servers. <br><br><br><h5>  Lesson 5: Memcache </h5><br><br>  The essence of the lesson - use memcache for everything. <br><br>  Reddit uses memcache for: <br><ol><li>  Database data </li><li>  Session data </li><li>  Generated pages </li><li>  Memoisation (caching previously calculated results) of internal functions </li><li>  Restrictions on the number of requests </li><li>  Storage of pre-calculated lists and pages </li><li>  Global locks </li></ol><br><br><br><br>  Now they store all the data in Memcachedb, not Postgres.  This is an analogue of memcache, but saves data to disk.  Very quick fix.  All requests are generated by the same piece of code and cached in memcache.  Changed passwords, links are cached for 20 minutes or so.  The same can be said about captcha.  They use the same approach for links that do not want to keep forever. <br><br>  They have built in their framework memoizatsiyu.  Calculated results are also cached: normalized pages, lists, and everything else. <br><br>  They limit the number of requests using memcache + a limited request lifetime.  A good way to protect your system from attacks.  Without such a subsystem, any unscrupulous user could put systems.  Do not feng shui.  Therefore, for users and indexers, they store data in memcache.  If the user makes a second call in less than a second, he bounces off.  Regular users do not click so quickly, so they do not notice anything.  Google's indexer will process you as often as you allow, so when everything starts to slow down, just limit the frequency of requests.  And the system will start to work quieter, without creating inconvenience for users. <br><br>  Everything in Reddit is a list.  Home page, private messages, comments page.  All of them are calculated in advance and placed in the cache.  When you get a list, it is taken from the cache.  Each link and each comment is likely saved in 100 different variations.  For example, a link with 2 votes created 30 seconds ago is expected and saved separately.  After 30 seconds, it is rendered again.  And so on.  Every bit of HTML comes from the cache.  Therefore, processor time is not spent on rendering pages.  If everything starts to slow down - just add more cache. <br><br>  When they come to work with their inconsistent database, they use memcache as a global lock.  It works, although it is not the best option. <br><br><br><h5>  Lesson 6: Save redundant data </h5><br><br>  The essence of the lesson: in order to achieve maximum speed - calculate everything in advance and cache the result. <br><br>  A guaranteed way to make a slow web site is to have a normalized database, access it on demand, and then generate HTML.  It takes forever even for a single request.  Therefore, if you have data that can be displayed in several formats, the links on the main page, in incoming messages, profiles, store all these views separately.  But when someone comes in and accesses the data, they are ready. <br><br>  Each list can have 15 different sorting orders (hot, new, best, old, current week).  When someone adds a new link, they recount all the lists that this may concern.  At first glance, it looks too wasteful, but it is better to spend money first than to brake.  To waste disk space and memory is better than making the user wait. <br><br><br><h5>  Lesson 7: Maximize your work in the background. </h5><br>  The essence of the lesson: make at least the server part, and tell the user that everything is ready. <br><br>  If you need to do something, do it when the user is not waiting for you.  Put the job in the queue.  When a user votes on Reddit, the lists, user's karma, and many other things are updated.  Therefore, the voting database is updated to mark the fact of voting.  After this task is queued, and the task knows all 20 things that need to be updated.  When the user returns, all the necessary data will be cached. <br><br><br>  What Reddit does in the background: <br><br><ol><li>  Cache Lists </li><li>  Process images </li><li>  Detect cheaters </li><li>  Remove spam </li><li>  Calculate rewards </li><li>  Update Search Index </li></ol><br><br>  There is no need to do these things while the user is waiting for you.  For example, when Reddit became popular, attempts to cheat the rating increased.  Therefore, they spend a lot of server time to detect such situations.  The work of this service in the background does not prevent users from voting further. <br><br><br>  An architecture diagram is provided below: <br><img src="https://habrastorage.org/storage2/be6/4d9/6e3/be64d96e3b34f09e4484afb29df34793.jpg"><br><br>  Blue arrows indicate what happens when a request is received.  Suppose someone leaves a link or votes.  This data goes to the cache, the main database, and to the work queue.  The result is returned to the user.  The remaining things that happen offline are represented by yellow arrows.  Services like Spam, Precomputer, and Thumnailer receive tasks from the queue, execute them, and update the database.  The main highlight of the technological solution is RabbitMQ. <br><br>  PS It is very interesting to compare the lessons of Reddit with the practitioners of designing applications for Erlang.  Let it fail, Supervision tree, mnesia.  Russian translation of OTP documentation can be found <a href="http://erlanger.ru/wiki/index.php/%25D0%2597%25D0%25B0%25D0%25B3%25D0%25BB%25D0%25B0%25D0%25B2%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2581%25D1%2582%25D1%2580%25D0%25B0%25D0%25BD%25D0%25B8%25D1%2586%25D0%25B0">here</a> . <br><br>  PPS There is an idea to translate a couple of chapters from RabbitMQ in Action.  How interesting will it be? </div><p>Source: <a href="https://habr.com/ru/post/150802/">https://habr.com/ru/post/150802/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../150796/index.html">Motorola is going to show a smartphone with a screen in the entire front panel of the device</a></li>
<li><a href="../150797/index.html">The story of our startup Dia-Life - the service of adherence to diets and compensation for diabetes</a></li>
<li><a href="../150798/index.html">Generators vs classes</a></li>
<li><a href="../150800/index.html">Microsoft Project delenda est</a></li>
<li><a href="../150801/index.html">A little bit about multi-threaded programming. Part 1. Synchronization is evil or not.</a></li>
<li><a href="../150803/index.html">JSON-RPC 2.0 and PHP</a></li>
<li><a href="../150804/index.html">Researchers uncover the location of the Pirate Bay uploaders</a></li>
<li><a href="../150805/index.html">LISP interpreter on pure C</a></li>
<li><a href="../150806/index.html">Yii in phar</a></li>
<li><a href="../150807/index.html">Moscow Air Quality Monitoring System</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>