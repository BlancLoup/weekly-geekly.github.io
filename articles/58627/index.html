<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Typography and WPF - Draw beautiful text</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Important: this approach is outdated, now you can just use DirectWrite and get all the OpenType buns. An example of a specific implementation can be f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Typography and WPF - Draw beautiful text</h1><div class="post__text post__text-html js-mediator-article"><p>  <strong>Important:</strong> this approach is outdated, now you can just use DirectWrite and get all the OpenType buns.  An example of a specific implementation can be found <a href="http://bitbucket.org/nesteruk/typografix">here</a> . </p><br><br><h3>  Introduction </h3><br><img src="http://nesteruk.org/pix/nhs/5.png" align="right">  As you know, WPF has a fairly powerful built-in typography system.  Unfortunately, this system is mainly focused on working with documents and, thus, all typographic delights like OpenType support cannot be used for some simple controls like Label.  But, no matter what, there is still an opportunity to get high-quality text rendering - you just need to suffer a little. <br><a name="habracut"></a><br><h3>  Task </h3><br><p> Why bother to draw text at all?  Well, for example, I want to have beautiful headlines on the blog - made by the fonts that I chose.  Of course, there are already solutions based on images or Flash, but they are either resource-intensive (like drawing SVG, for example), or incompatible with IE (for example, those using the <code>Canvas</code> element).  In addition, none of the available systems support either OpenType or ClearType, that is, it is not convenient for small text, and does not allow you to fully depreciate your investments in expensive fonts <sup><a href="https://habr.com/ru/post/58627/" title="In addition, some systems require you to upload your fonts to the developers on the site.">1</a></sup> . <br><br></p><h3>  Decision </h3><br><p>  In order to get our headlines, we will use the WPF typographic system.  Since our goals are rather primitive, we will use only three main classes: </p><br><ul><li>  <code>Run</code> - this class contains the minimum amount of text in WPF and is analogous to <code>&lt;span&gt;</code> in HTML.  Each <code>Run</code> can have its own typographical style, which allows us to mix bold text, italics, and other styles in one sentence when linking. <br></li><li>  <code>Paragraph</code> is a paragraph or some analogue of <code>&lt;div&gt;</code> in HTML.  Its essence is to contain several Runs (and not only) and show them as one unit.  Since we are planning to make headings, one paragraph is enough for us. <br></li><li>  <code>FlowDocument</code> is a document that can contain paragraphs.  In fact, it is a kind of contractor that holds different text blocks and can adapt, for example, to different page sizes.  We do not really need this, but the document as a container will be useful to us, because we‚Äôll just pull out the visual information (that is, the texture) from it. <br></li></ul><br><p>  The three constructs described above are very easy to use.  Here is a fairly simple example: <br></p>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote> <code><font color="black"><font color="#008000">// &lt;br/&gt;</font> <br> Run r = <font color="#0000FF">new</font> Run( <font color="#800000">"Hello rich WPF typography"</font> );&lt;br/&gt; <br> <font color="#008000">// &lt;br/&gt;</font> <br> Paragraph p = <font color="#0000FF">new</font> Paragraph();&lt;br/&gt; <br> p.Inlines.Add( r );&lt;br/&gt; <br> <font color="#008000">//  &lt;br/&gt;</font> <br> FlowDocument fd = <font color="#0000FF">new</font> FlowDocument();&lt;br/&gt; <br> fd.Blocks.Add(p);&lt;br/&gt; <br></font></code> </blockquote><h3>  Subpixel optimization </h3><br><p>  At this stage, we could just draw our <code>FlowDocument</code> into the texture, but then we would get a simple black and white antialiasing, while with sub-pixel rendering, the text looks much clearer. <br></p><br><br><p>  Let's look at how you can get an effect similar to ClearType.  First, since we need to get 3 times more information horizontally, let's stretch our text so that it is 3 times wider. <br></p><br><br><blockquote> <code><font color="black">DocumentPaginator dp = ((IDocumentPaginatorSource)fd).DocumentPaginator;&lt;br/&gt; <br> ContainerVisual cv = <font color="#0000FF">new</font> ContainerVisual();&lt;br/&gt; <br> cv.Transform = <font color="#0000FF">new</font> ScaleTransform(3.0, 1.0);&lt;br/&gt; <br> cv.Children.Add(dp.GetPage(0).Visual);&lt;br/&gt; <br></font></code> </blockquote><p>  So, we created a container for <code>Visual</code> elements (for the visual component of the document), pulled the first page out of the document, placed it in this <code>ContainerVisual</code> , and stretched it 3 times horizontally.  Everything is good, but for now it‚Äôs just a <code>Visual</code> that needs to be drawn somehow.  Not a problem - for this there is a corresponding API that draws <code>Visual</code> directly into a bitmap.  Or rather not in <code>Bitmap</code> but in <code>RenderTargetBitmap</code> : <br></p><br><br><blockquote> <code><font color="black"><font color="#008000">// .       3&lt;br/&gt;</font> <br> RenderTargetBitmap rtb = <font color="#0000FF">new</font> RenderTargetBitmap(2400, 100, 72, 72, PixelFormats.Pbgra32);&lt;br/&gt; <br> rtb.Render(cv);&lt;br/&gt; <br></font></code> </blockquote><p>  Perhaps this is where the ‚Äúwhims‚Äù of WPF begin, because there is no direct conversion into the <code>System.Drawing.Bitmap</code> we are used to.  But this is nothing - it is enough to serialize the data into a stream and then get them from this stream and we will get essentially the same thing: <br></p><br><br><blockquote> <code><font color="black">PngBitmapEncoder enc = <font color="#0000FF">new</font> PngBitmapEncoder();&lt;br/&gt; <br> enc.Frames.Add(BitmapFrame.Create(rtb));&lt;br/&gt; <br> Bitmap zeroth;&lt;br/&gt; <br> <font color="#0000FF">using</font> (MemoryStream ms = <font color="#0000FF">new</font> MemoryStream())&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#008000">//     &lt;br/&gt;</font> <br> enc.Save(ms);&lt;br/&gt; <br> <font color="#008000">//      &lt;br/&gt;</font> <br> zeroth = <font color="#0000FF">new</font> Bitmap(ms);&lt;br/&gt; <br> }&lt;br/&gt; <br></font></code> </blockquote><p>  So, we got a ‚Äúzero‚Äù bitmap, that is, a stove, from which we will dance.  If you now take and save the bitmap, you get something like this: </p><br><br><p><img src="http://nesteruk.org/pix/nhs/1.png"></p><br><br><p>  One should not be surprised - it is really just a text that is stretched 3 times using the typographical system WPF.  Now, in order to prepare our picture for sub-pixel optimization, let's distribute the energy of each pixel to its neighbors - two on the left and two on the right <sup><a href="https://habr.com/ru/post/58627/" title="This algorithm is taken from here. The only difference is &amp; ndash; I used those coefficients that are easier to use to get by with a shift instead of a multiplication.">2</a></sup> .  This will allow us to make a very smooth, not annoying user, drawing.  To do this, create a useful structure called <code>argb</code> : <br></p><blockquote> <code><font color="black"><font color="#0000FF">public</font> <font color="#0000FF">struct</font> argb&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#0000FF">public</font> <font color="#0000FF">int</font> a, r, g, b;&lt;br/&gt; <br> <font color="#0000FF">public</font> <font color="#0000FF">void</font> AddShift(Color color, <font color="#0000FF">int</font> shift)&lt;br/&gt; <br> {&lt;br/&gt; <br> a += color.A &gt;&gt; shift;&lt;br/&gt; <br> r += color.R &gt;&gt; shift;&lt;br/&gt; <br> g += color.G &gt;&gt; shift;&lt;br/&gt; <br> b += color.B &gt;&gt; shift;&lt;br/&gt; <br> }&lt;br/&gt; <br> }&lt;br/&gt; <br></font></code> </blockquote><p>  This structure has only one purpose - to take the constituent elements of a certain <code>Color</code> , to modulate its parameters by shifting, and to record the result.  And now we will use this structure: <br></p><br><br><blockquote> <code><font color="black"><font color="#0000FF">public</font> Bitmap Coalesce(Bitmap bmp)&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#0000FF">int</font> width = bmp.Width;&lt;br/&gt; <br> <font color="#0000FF">int</font> height = bmp.Height;&lt;br/&gt; <br> Bitmap output = <font color="#0000FF">new</font> Bitmap(width, height);&lt;br/&gt; <br> <font color="#0000FF">for</font> ( <font color="#0000FF">int</font> y = 0; y &lt; height; ++y)&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#0000FF">for</font> ( <font color="#0000FF">int</font> x = 2; x &lt; width - 2; ++x)&lt;br/&gt; <br> {&lt;br/&gt; <br> argb final = <font color="#0000FF">new</font> argb();&lt;br/&gt; <br> final.AddShift(bmp.GetPixel(x - 2, y), 3);&lt;br/&gt; <br> final.AddShift(bmp.GetPixel(x - 1, y), 2);&lt;br/&gt; <br> final.AddShift(bmp.GetPixel(x, y), 1);&lt;br/&gt; <br> final.AddShift(bmp.GetPixel(x + 1, y), 2);&lt;br/&gt; <br> final.AddShift(bmp.GetPixel(x + 2, y), 3);&lt;br/&gt; <br> output.SetPixel(x, y, System.Drawing.Color.FromArgb(&lt;br/&gt; <br> Clamp(final.a),&lt;br/&gt; <br> Clamp(final.r),&lt;br/&gt; <br> Clamp(final.g),&lt;br/&gt; <br> Clamp(final.b)));&lt;br/&gt; <br> }&lt;br/&gt; <br> }&lt;br/&gt; <br> <font color="#0000FF">return</font> output;&lt;br/&gt; <br> }&lt;br/&gt; <br></font></code> </blockquote><br><br><p>  Above, we also used the <code>Clamp()</code> function, which ensures that the color value is always less than or equal to 255. </p><br><br><p>  If we now look at this text again, then we will not see anything interesting - just the text is a bit "smeared" horizontally: <br></p><br><br><img src="http://nesteruk.org/pix/nhs/2.png"><p></p><br><br><p>  The next stage is to get the final image, i.e.  squeeze it horizontally 3 times, using the alpha values ‚Äã‚Äãof the subpixels as red, blue, and green, respectively.  The only amendment is that we need to invert these alpha values, that is, subtract the value from 255: <br></p><br><br><blockquote> <code><font color="black">Bitmap second = <font color="#0000FF">new</font> Bitmap(( <font color="#0000FF">int</font> )(first.Width / 3), first.Height);&lt;br/&gt; <br> <font color="#0000FF">for</font> ( <font color="#0000FF">int</font> y = 0; y &lt; first.Height; ++y)&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#0000FF">for</font> ( <font color="#0000FF">int</font> x = 0; x &lt; second.Width; ++x)&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#008000">//    -,     255&lt;br/&gt;</font> <br> System.Drawing.Color final = System.Drawing.Color.FromArgb(255,&lt;br/&gt; <br> 255 - first.GetPixel(x * 3, y).A,&lt;br/&gt; <br> 255 - first.GetPixel(x * 3 + 1, y).A,&lt;br/&gt; <br> 255 - first.GetPixel(x * 3 + 2, y).A);&lt;br/&gt; <br> second.SetPixel(x, y, final);&lt;br/&gt; <br> }&lt;br/&gt; <br> }&lt;br/&gt; <br></font></code> </blockquote><br><br><p>  The last thing you can do is trim the bitmap.  That's all: </p><br><br><img src="http://nesteruk.org/pix/nhs/3.png"><p></p><br><br><p>  As a result, we got text with ClearType support.  And as for OpenType support, it's simple.  For example, on my website I use this script: </p><br><br><blockquote> <code><font color="black">Run r1 = <font color="#0000FF">new</font> Run(text.Substring(0, 1))&lt;br/&gt; <br> {&lt;br/&gt; <br> FontFamily = <font color="#0000FF">new</font> FontFamily(fontName),&lt;br/&gt; <br> FontSize = fontSize,&lt;br/&gt; <br> FontStyle = FontStyles.Italic&lt;br/&gt; <br> };&lt;br/&gt; <br> <font color="#0000FF">if</font> ( <font color="#0000FF">char</font> .IsLetter(text[0]))&lt;br/&gt; <br> r1.SetValue(Typography.StandardSwashesProperty, 1);&lt;br/&gt; <br> Run r2 = <font color="#0000FF">new</font> Run(text.Substring(1, text.Length - 2))&lt;br/&gt; <br> {&lt;br/&gt; <br> FontFamily = <font color="#0000FF">new</font> FontFamily(fontName),&lt;br/&gt; <br> FontSize = fontSize,&lt;br/&gt; <br> FontStyle = FontStyles.Italic&lt;br/&gt; <br> };&lt;br/&gt; <br> r2.SetValue(Typography.NumeralStyleProperty, FontNumeralStyle.OldStyle);&lt;br/&gt; <br> Run r3 = <font color="#0000FF">new</font> Run(text.Substring(text.Length - 1))&lt;br/&gt; <br> {&lt;br/&gt; <br> FontFamily = <font color="#0000FF">new</font> FontFamily(fontName),&lt;br/&gt; <br> FontSize = fontSize,&lt;br/&gt; <br> FontStyle = FontStyles.Italic&lt;br/&gt; <br> };&lt;br/&gt; <br> r3.SetValue(Typography.StylisticAlternatesProperty, 1);&lt;br/&gt; <br></font></code> </blockquote><br><br><p>  I think everything is clear here without words - the first letter of the title uses a ‚Äúhandwritten‚Äù form, and the last one is an alternative one.  You can apply to our headline: </p><br><br><p><img src="http://nesteruk.org/pix/nhs/4.png"></p><br><br><p>  However, since our header has no alternative for the final letter s, we can take something more ‚Äúindicative‚Äù: <br></p><br><br><p><img src="http://nesteruk.org/pix/nhs/6.png"></p><br><br><h3>  Conclusion </h3><br><p>  Examples of using all of the above are in my <a href="http://nesteruk.org/blog">blog</a> - I use this subsystem to generate titles.  And before you ask - no, such an approach does not interfere with indexing (if you do not believe, make a 'view source' and see how it is implemented), and there are no problems with ‚Äúreaders‚Äù like Google Reader either.  On the other hand, on my blog you can see some system bugs that I‚Äôm currently fixing. <br></p><br><br><p>  What I described above is a terribly slow approach.  The functions <code>GetPixel()</code> and <code>SetPixel()</code> are a real evil, and in a good way all manipulations with bitmaps should be done in C ++ using OpenMP or Intel TBB.  But in my case, the image needs to be generated only once (and I generate it - right after I add the blog entry), so I don‚Äôt care.  And getting the bytes out of the bitmap and processing them through P / Invoke is easy. <br></p><br><br><h3>  Notes </h3><br><ol><li>  <a href="https://habr.com/ru/post/58627/" title="Back to text">‚Üë</a> <p>  In addition, some systems require you to upload your fonts to the developers on the site. </p></li><li>  <a href="https://habr.com/ru/post/58627/" title="Back to text">‚Üë</a> <p>  This algorithm is taken <a href="http://www.grc.com/ct/cttech.htm">from here</a> .  The only difference is that I used those coefficients that are easier to use in order to get by with a shift instead of a multiplication. </p></li></ol><br><br><p> <a href="http://spbalt.net/"><img src="http://nesteruk.org/pix/spbalt.net.png" alt="Petersburg Group ALT.NET"></a> </p></div><p>Source: <a href="https://habr.com/ru/post/58627/">https://habr.com/ru/post/58627/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../58615/index.html">Torment with Ubuntu</a></li>
<li><a href="../58619/index.html">T-shirt Viva La Distribuci√≥n!</a></li>
<li><a href="../58621/index.html">CMS Magazine: Web Development Market Research</a></li>
<li><a href="../58624/index.html">"Cutting off the excess." How to limit your imagination and imagination of the customer?</a></li>
<li><a href="../58626/index.html">Holy cow Habra?</a></li>
<li><a href="../58629/index.html">Survey of interesting events in the market of information carriers. March-April 2009</a></li>
<li><a href="../58630/index.html">Windows 7 Federated Search</a></li>
<li><a href="../58631/index.html">Programming languages ‚Äã‚Äã- Who has the shorter code?</a></li>
<li><a href="../58633/index.html">Department site development</a></li>
<li><a href="../58634/index.html">The dynamics of the form and site design</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>