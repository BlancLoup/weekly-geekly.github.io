<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>QScintilla: write your lexer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 

 UPD : the third part of the cycle. 

 This is the second article of the cycle about QScintilla. The first is here . First I want to say a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>QScintilla: write your lexer</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr! <br><br>  <b>UPD</b> : the <a href="http://habrahabr.ru/post/144855/">third</a> part of the cycle. <br><br>  This is the second article of the cycle about QScintilla.  The first is <a href="http://habrahabr.ru/post/144411/">here</a> .  <strong>First I want to say a huge thank you to everyone who brought me out of karmoyam!</strong>  And now you can start.  What are we going to do today?  We will write a lexer for Assembler!  "In the box" it is not present - it does not matter, we will write it yourself!  The process is quite lengthy, so I‚Äôm going to paint and comment a little less.  Moreover, I don‚Äôt know assembly language, so the lexer will be terribly primitive and will only draw commands and comments. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As Gagarin said - ‚ÄúLet's go!‚Äù <br><a name="habracut"></a><br>  At this stage, I believe that you have already read the first article (see above) and know how to create an editor and customize it.  We continue with the same project that we edited last time and with the same set of tools (those who have not read the first article caught here). <br><br><h2>  Challenge and ideas </h2><br>  Write the syntax coloring for the Assembler language.  But there is no default lexer (color scheme) in QScintilla.  Nothing, we will write.  To do this, there is a class QsciLexerCustom (in secret: it has virtual methods). <br><br><h2>  Stocking </h2><br>  Let's make our lexer <s>dough</s> .  The blank looks like this: <br><br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QsciLexerASM</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> QsciLexerCustom { Q_OBJECT <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">explicit</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">QsciLexerASM</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(QObject *parent = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; ~QsciLexerASM(); <span class="hljs-comment"><span class="hljs-comment">//!     (  ) void styleText(int start, int end); //!    (  styleText()) void paintKeywords(const QString &amp;source, int start); void paintComments(const QString &amp;source, int start); //!   (   ASM const char * language() const; //!    QColor defaultColor(int style) const; //!   QString description(int style) const; //!   enum { Default = 0, Comment = 1, Keyword = 2 }; private: QsciLexerASM(const QsciLexerASM &amp;); QsciLexerASM &amp;operator=(const QsciLexerASM &amp;); QStringList keywordsList; };</span></span></code> </pre> <br><br>  Some functions listed here are not needed by us, but by QScintilla.  But if they are needed by someone, then we will implement them in mainwindow.h: <br><br><pre> <code class="cpp hljs">QString QsciLexerASM::description(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> style) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(style) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Default: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Default"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Comment: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Comment"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Keyword: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Keyword"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> QString(style); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * QsciLexerASM::language() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"ASM"</span></span>; }</code> </pre><br><br>  I think everything is clear.  Let's go further.  Now we need to implement the default color for all styles: <br><br><pre> <code class="cpp hljs">QColor QsciLexerASM::defaultColor(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> style) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(style) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Comment: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Qt::darkGreen; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Keyword: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Qt::blue; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Qt::black; }</code> </pre><br><br>  But now we will color our code.  To do this, we need to know what keywords are in the assembler.  I found a little bit on <a href="http://ru.wikipedia.org/wiki/%25D0%25AF%25D0%25B7%25D1%258B%25D0%25BA_%25D0%25B0%25D1%2581%25D1%2581%25D0%25B5%25D0%25BC%25D0%25B1%25D0%25BB%25D0%25B5%25D1%2580%25D0%25B0">Wikipedia</a> .  To do this, set our keywordsList in the constructor: <br><br><pre> <code class="cpp hljs">QsciLexerASM::QsciLexerASM(QObject *parent) : QsciLexerCustom(parent) { keywordsList &lt;&lt; <span class="hljs-string"><span class="hljs-string">"mov"</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"add"</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"sub"</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"imul"</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"or"</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"and"</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"xor"</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"shr"</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"jmp"</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"loop"</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"ret"</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"int"</span></span>; }</code> </pre><br><br>  We continue.  Now you have to be very careful - we have come to the place where we will color the syntax!  I will list the function code styleText (), and then briefly comment on it: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> QsciLexerASM::styleText(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> start, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> end) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!editor()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-comment"><span class="hljs-comment">//        char * data = new char[end - start + 1]; //   Scintilla editor()-&gt;SendScintilla(QsciScintilla::SCI_GETTEXTRANGE, start, end, data); QString source(data); delete [] data; if(source.isEmpty()) return; //  ! paintKeywords(source, start); paintComments(source, start); }</span></span></code> </pre><br><br>  One moment.  The last two lines of the method.  The paintKeyword () and paintComments () functions are used to color keywords and comments, respectively.  We call the design of teams, and only then comments.  Why?  Guess it. <br><br>  Now everything is fine.  Almost all methods are implemented.  It remains only to implement paintKeyword () and paintComments (): <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> QsciLexerASM::paintKeywords(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString &amp;source, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> start) { foreach(QString word, keywordsList) { <span class="hljs-comment"><span class="hljs-comment">//    if(source.contains(word)) { int p = source.count(word); //   int index = 0; //    c 0 while(p != 0) { int begin = source.indexOf(word, index); //    index = begin+1; //       startStyling(start + begin); //      setStyling(word.length(), Keyword); //   word.length   Keyword startStyling(start + begin); //   p--; } } } } void QsciLexerASM::paintComments(const QString &amp;source, int start) { int p = source.count(";"); //     if(p == 0) return; int index = 0; //    ";"  0 while(p != 0) { int begin = source.indexOf(";", index); //    int length=0; //   index = begin+1; //       for(int k = begin; source[k] != '\n'; k++) //  source    length++; startStyling(start + begin); //      setStyling(length, Comment); //   length   Comment startStyling(start + begin); //   p--; } }</span></span></code> </pre><br><br>  Is done.  Now our lexer can do something.  You can compile.  Yes you can.  Yes, you can definitely compile. <br><br><h2>  Result </h2><br>  With the assembler, I did not work.  So wildly sorry.  I do not even know the basic principles of working with him.  But I thought that it was perfect as an example to this article. <br><br>  Here's what we got: <br><br> <a href=""><img src="http://dl.dropbox.com/u/7131620/Habr/lexer/program.png"><br></a> <br><br>  Some bugs can be seen, for example, in the word ‚Äúdword‚Äù the occurrence of ‚Äúor‚Äù is highlighted as key.  As suggested by the comrade of <a href="http://habrahabr.ru/users/thehorse/" class="user_link">TheHorse</a> - you need to check that the occurrence of keywords in the text is divided by separators.  But by the end of this article, I was so tired that I decided not to fix this bug, but leave it fixed to readers :) <br><br>  And here is our creation: <a href="">qscintilla-demo-2</a> <br><br>  Thank you, and once again I apologize for the choice of language. </div><p>Source: <a href="https://habr.com/ru/post/144714/">https://habr.com/ru/post/144714/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../144708/index.html">ZooKeeper or write distributed locking service</a></li>
<li><a href="../144709/index.html">Fidel.ru - everything</a></li>
<li><a href="../144710/index.html">‚ÄúRunet today‚Äù, May 28, 2012. Experts of the issue: Maria Chernitskaya, Alexey Andreev</a></li>
<li><a href="../144712/index.html">Instant file search in Windows. Sleight of hand and no fraud</a></li>
<li><a href="../144713/index.html">Registration for PHDays 2012 contests has begun</a></li>
<li><a href="../144715/index.html">Why will I never use discount coupons again?</a></li>
<li><a href="../144716/index.html">How did you manage to make friends with the TP-LINK router and mobile devices</a></li>
<li><a href="../144717/index.html">Django do-it-yourself part 1: Putting templates for jinja2</a></li>
<li><a href="../144718/index.html">Border control of biometric passports</a></li>
<li><a href="../144720/index.html">jClever - smart jNice with buns. Styling HTML Forms</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>