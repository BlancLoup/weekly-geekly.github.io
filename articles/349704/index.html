<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We expand the bundle of Nginx + Php-Fpm + MySQL with magento2 on board and decompose it in containers in the Docker</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! 

 Increasingly, knocking on various developer companies as an DevOps engineer, I get about the same test items. They differ from each other...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We expand the bundle of Nginx + Php-Fpm + MySQL with magento2 on board and decompose it in containers in the Docker</h1><div class="post__text post__text-html js-mediator-article">  Good day! <br><br>  Increasingly, knocking on various developer companies as an DevOps engineer, I get about the same test items.  They differ from each other in PHP versions or projects that need to be run. <br><br>  But in general, they run into one bundle, this is Nginx \ Appache, SQL (there are many variations, it all depends on the preferences of the customer), PHP and it is desirable that this be decomposed into containers. <br>  Therefore, I decided to tell by example how to raise all this effortlessly. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Perhaps it will help someone to understand, with a simple example, what's what.  I will not describe what a Docker is, because  articles on this topic car and small truck. <br><br>  In this article, we will prepare a small structure: <br><br><ul><li>  Nginx will be used as a web server with minimal configuration to launch the project. </li><li>  As SQL will use MySQL. </li><li>  PHP7.0-fpm version with small add-ins to run our project. </li><li>  As a project that we will deploy - take magento2. </li></ul><a name="habracut"></a><br>  First, install Docker. <br><br>  It all depends on the system in which you want to work, in terms of cross-platform, docker pleasantly surprises (the same configuration file allows you to build and run containers on any system * nix, Win, iOS). <br><br>  <i>For Linux (for example on CentOS)</i> <br><br>  Install: <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># yum install docker</span></span></code> </pre> <br>  We turn on and start the service: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># systemctl enable docker.service # systemctl start docker.service</span></span></code> </pre><br>  In order to create our structure with one team, we need docker-compose. <br><br>  To begin with, we put the necessary components for it: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># yum install epel-release # yum install -y python-pip</span></span></code> </pre><br>  Next install docker-compose and update python: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># yum install docker-compose</span></span></code> </pre> <br>  (or # pip install docker-compose) <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># yum upgrade python*</span></span></code> </pre> <br>  <i>For Win systems (many consider this a perversion)</i> <br><br>  But if you decide, I strongly recommend that you do this on a version that supports Hyper-V (for example, win10 Prof). <br><br>  We enable the Hyper-V component in Turning Windows Features on or Off. <br><br>  Download the installer from the Docker's site and install it.  Also, in addition, you can put the GUI (Kitematis) for visual display. <br><br>  Let's start creating the environment: <br><br>  To begin with, we will create a folder for this project and go to it: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mkdir /mage (     ) # cd /mage</span></span></code> </pre><br>  Next, we build the folder structure in this way: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mkdir MySQL Nginx PHP</span></span></code> </pre><br>  Create a clear environment for nginx: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cd Nginx # mkdir core html Logs www</span></span></code> </pre><br>  MySQL - databases will be stored in this folder.  Convenient to back up and transfer. <br>  Nginx - logs, configuration file and our project will be stored here. <br>  PHP - here we add Dockerfile with settings and php.ini. <br>  at the root (in our case the / mage folder) will be the docker-compose.yml file. <br><br>  Create a configuration file for Nginx: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cd /mage/Nginx/core # touch nginx.conf # nano nginx.conf</span></span></code> </pre><br>  You can use any other editor.  If not, you can install it using: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># yum install nano</span></span></code> </pre> <br>  And we add the following to nginx.conf: <br><br><pre> <code class="python hljs">server { listen <span class="hljs-number"><span class="hljs-number">80</span></span>; index index.php index.html index.htm; server_name magento2.dev; set $MAGE_ROOT /var/www/magento2; error_log /var/log/nginx/error.log; access_log /var/log/nginx/access.log; root $MAGE_ROOT; location ~* \.php$ { try_files $uri $uri/ /index.php last; fastcgi_split_path_info (.+?\.php)(/.*)$; fastcgi_pass php:<span class="hljs-number"><span class="hljs-number">9000</span></span>; fastcgi_index index.php; include fastcgi_params; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_param PATH_INFO $fastcgi_path_info; } location ~* .php/ { rewrite (.*.php)/ $<span class="hljs-number"><span class="hljs-number">1</span></span> last; } }</code> </pre><br>  This is the minimum config for everything to start.  In the first block we describe which port to listen to, list possible index pages, call names, create alias for the long path where magento2 lies, write what logs are needed and specify where they should be stored, specify the folder where magento2 lives (in this case our alias $ MAGE_ROOT) . <br><br>  In the second block, write the parameters fastcgi. <br><br>  The third block is needed to solve the mapping problem, the project showed a blank page.  From the documentation I read that magento2 requires rewriting.  (on other projects there were no such problems). <br><br>  In the www folder, create a directory for our project: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cd /mage/Nginx/www # mkdir magento2</span></span></code> </pre><br>  Download from the magento2 <a href="https://magento.com/tech-resources/download">site</a> <br>  and extract from the archive to the folder / mage / Nginx / www / magento2 <br><br>  With the settings for Nginx, we are finished. <br><br>  Now let's do PHP: <br><br>  Let's start with the Dockerfile <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cd /mage/PHP # touch Dockerfile php.ini # nano Dockerfile</span></span></code> </pre><br>  We collect ourselves: <br><br><pre> <code class="python hljs">FROM php:<span class="hljs-number"><span class="hljs-number">7.0</span></span>-fpm RUN apt-get update &amp;&amp; apt-get install -y \ curl \ wget \ git \ libfreetype6-dev \ libjpeg62-turbo-dev \ libxslt-dev \ libicu-dev \ libmcrypt-dev \ libpng12-dev \ libxml2-dev \ &amp;&amp; docker-php-ext-install -j$(nproc) iconv mcrypt mbstring mysqli pdo_mysql zip \ &amp;&amp; docker-php-ext-configure gd --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-freetype-dir=/usr/include/ --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-jpeg-dir=/usr/include/ \ &amp;&amp; docker-php-ext-install -j$(nproc) gd RUN docker-php-ext-configure intl RUN docker-php-ext-install intl RUN docker-php-ext-install xsl RUN docker-php-ext-install soap RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer ADD php.ini /usr/local/etc/php/conf.d/<span class="hljs-number"><span class="hljs-number">40</span></span>-custom.ini WORKDIR /var/www/magento2 CMD [<span class="hljs-string"><span class="hljs-string">"php-fpm"</span></span>]</code> </pre><br>  This is necessary so that we can use those modules that are needed specifically for this project. <br><br>  In this file we told what should be installed in this image, and also indicated where the root directory will be located and where to copy the settings from php.ini <br><br>  Now configure php.ini: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># nano php.ini</span></span></code> </pre> <br>  This is taken from php.ini.sample that Magento2 developers themselves offer.  There is nothing supernatural I did not add to it. <br><br><pre> <code class="php hljs">memory_limit = <span class="hljs-number"><span class="hljs-number">2</span></span>G always_populate_raw_post_data = <span class="hljs-number"><span class="hljs-number">-1</span></span> cgi.fix_pathinfo = <span class="hljs-number"><span class="hljs-number">1</span></span> fastcgi_split_path_info = <span class="hljs-number"><span class="hljs-number">1</span></span> max_execution_time = <span class="hljs-number"><span class="hljs-number">18000</span></span> flag session.auto_start = off zlib.output_compression = on suhosin.session.cryptua = off display_errors = Off</code> </pre><br>  That's it, the PHP setup is over. <br><br>  Next, create a docker-compose file that will bring us all into one convenient system. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cd /mage # touch docker-compose.yml # nano docker-compose.yml</span></span></code> </pre><br>  Here we will write out what services and with what settings should start: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   version: '3.3' #   services: nginx: #       image: nginx:latest #      container_name: nginx #   ports: - "80:80" - "443:443" #   volumes: - ./Nginx/core:/etc/nginx/conf.d - ./Nginx/www:/var/www/ - ./Nginx/Logs:/var/log/nginx/ - ./Nginx/html:/usr/share/nginx/html/ #   links: - php mysql: image: mysql:latest ports: - "3306:3306" container_name: mysql #  ,    mypassword   ,   root environment: - MYSQL_ROOT_PASSWORD=mypassword - MYSQL_DATABASE=magento2 - MYSQL_USER=magento2 - MYSQL_PASSWORD=magento2 volumes: - ./MySQL:/var/lib/mysql php: #    dockerfile      build: ./PHP container_name: php-fpm volumes: - ./Nginx/www:/var/www links: - mysql phpmyadmin: image: phpmyadmin/phpmyadmin container_name: phpmyadmin ports: - 8090:80 links: - mysql:db</span></span></code> </pre><br>  (or if you don‚Äôt want to watch the containers work, you can add -d) <br><br>  And the lines will run across the screen, and you can safely pour yourself a mug of hot coffee while the machine works for you. <br><br>  After installation, you will create many files and folders in your MySQL folder, one of which will be magento2, and 2 logs will appear in the Nginx / Logs folder. <br><br>  Opening the browser and typing <a href="http://localhost/">localhost</a> there you should see an invitation to install Magento2. <br><br>  If all the same something did not work out, then perhaps this list of solutions can help you: <br><br>  1) The version of the docker-compose file did not fit, then you need to correct the "version: '3.3'", to see which one is <a href="https://docs.docker.com/compose/compose-file/">right for</a> you <a href="https://docs.docker.com/compose/compose-file/">here</a> <a href="https://docs.docker.com/compose/compose-file/"><br></a> <br><br>  2) Everything started fine, but the browser opens a clean page, without a single error - a line in nginx.conf will help <br><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">"location ~* .php/ { rewrite (.*.php)/ $1 last; }"</span></span></code> </pre> <br>  3) If, after installing Magento2 itself (in the browser), you do not draw frames and everything looks like a text version of the site, you need to do the following: <br><br>  3.1 in SQL, I advise you to go through phpmyadmin <a href="http://localhost/">localhost</a> : 8090 login root password mypassword, select the base magento2 and enter the sql query <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> core_config_data (config_id, <span class="hljs-keyword"><span class="hljs-keyword">scope</span></span>, scope_id, <span class="hljs-keyword"><span class="hljs-keyword">path</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">'default'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'dev/static/sign'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br>  3.2 connect to a PHP container (php-fpm) and type <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># php bin/magento cache:clean config # php bin/magento setup:static-content:deploy</span></span></code> </pre> <br>  He has to recount and check everything.  And after that, everything should be displayed correctly. <br><br>  4) If Docker does not have permissions to write to folders (he will say this if you have typed) docker-compose up (without -d) <br><br>  4.1 in Linux, you must disable the protection policy <br><br>  Shutdown before reboot <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># setenforce Permissive</span></span></code> </pre> <br>  on or off forever <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># nano /etc/selinux/config</span></span></code> </pre> <br>  we change the line <br><br><pre> <code class="hljs objectivec"><span class="hljs-string"><span class="hljs-string">"SELINUX=disabled"</span></span></code> </pre> <br>  4.2 In windows, in the docker settings, select shared drivers and select the disk on which you have the project.  After restarting Docker, the problem will go away. <br><br>  Good luck in your endeavors, gentlemen! <br><br>  Link to the finished assembly <a href="https://github.com/Avb-89/kt-team">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/349704/">https://habr.com/ru/post/349704/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../349690/index.html">Rise of one small wayward neural network, or how to make a codewar-game in 3 days</a></li>
<li><a href="../349692/index.html">QA at CodeFest: the future, iOS farms and backdoors</a></li>
<li><a href="../349694/index.html">Fintech Digest: blockchain legalization, reduction of branches in favor of IT</a></li>
<li><a href="../349698/index.html">Comparative analysis of physical and functional objects</a></li>
<li><a href="../349700/index.html">OWASP Automated Threat: Automated Web Application Threats</a></li>
<li><a href="../349706/index.html">Kill the Dragon: The Thorny Path to Agile</a></li>
<li><a href="../349708/index.html">We focused on the client (and not on competitors) - and over the year received over a million new users</a></li>
<li><a href="../349710/index.html">How not to go crazy in the development of regulatory information management systems. From the history of our projects</a></li>
<li><a href="../349714/index.html">Using ReSwift: Writing the Memory Game Application</a></li>
<li><a href="../349716/index.html">A Cloud Guru portal interview with Kelsey Hightower: about DevOps, Kubernetes and serverless</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>