<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>In search of a non-existent time</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On Friday, in the application installed on the test site, a bug related to the library conflict was found, which for some reason did not manifest itse...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>In search of a non-existent time</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/05d/624/606/05d6246062ca4651b55a6b917133fa3f.jpg" alt="image"><br><br>  On Friday, in the application installed on the test site, a bug related to the library conflict was found, which for some reason did not manifest itself at the development stage and which stopped the process being processed.  We promptly prepared a fix and passed the updated distribution to the implementation team.  In turn, the implementation team created a request for the administration team to install the distribution on the test site.  At the weekend, the duty shift got to this application and updated the application.  On Monday morning, it was discovered that the process had stalled again. <br><a name="habracut"></a><br>  An analysis of the application server logs was discovered many lines of the form: <br><blockquote>  ORA-01878: specified field not found in datetime or interval </blockquote><br>  Google on the error code suggested to me <a href="http://stackoverflow.com/questions/22305466/oracle-date-compare-broken-because-of-dst">http://stackoverflow.com/questions/22305466/oracle-date-compare-broken-because-of-dst</a> <br><br>  The culprit was found very quickly - a task handler of the following type was implemented in the spring integration application: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">inbound-channel-adapter</b> <div class="spoiler_text"><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">int-jdbc:inbound-channel-adapter</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">query</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" SELECT ID, UPDATE_TIME FROM TASK WHERE UPDATE_TIME IS NULL OR SYSTIMESTAMP&gt;(UPDATE_TIME+ INTERVAL '3500' SECOND) SKIP LOCKED"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">channel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"target"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-source</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dataSource"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">update</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"update task set UPDATE_TIME = SYSTIMESTAMP where id in (:id)"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">int:poller</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">fixed-rate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1000"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">int:poller</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">int-jdbc:inbound-channel-adapter</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br></div></div><br>  Actually, the culprit <br><blockquote><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>, UPDATE_TIME <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TASK <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> UPDATE_TIME <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> SYSTIMESTAMP&gt;(UPDATE_TIME+ <span class="hljs-built_in"><span class="hljs-built_in">INTERVAL</span></span> <span class="hljs-string"><span class="hljs-string">'3500'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SECOND</span></span>)</code> </pre></blockquote><br>  The request was successfully worked out on the basis of the developers, but fell on the test base. The search for solutions was started. <br>  First, on the advice of the article was tested <b>option number 1</b> <br><blockquote><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>, UPDATE_TIME <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TASK <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> UPDATE_TIME <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> SYSTIMESTAMP&gt;<span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(UPDATE_TIME+ <span class="hljs-built_in"><span class="hljs-built_in">INTERVAL</span></span> <span class="hljs-string"><span class="hljs-string">'3500'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SECOND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span> ZONE)</code> </pre></blockquote><br>  The request was successfully worked out on the basis of developers, and on a test base from the administrator console.  A distributive distribution kit was prepared and promptly installed.  Which in fact did not fix anything.  It became clear that the problem depends on the session connection parameters. <br>  Were requested and obtained data tables from the test site.  And two lines immediately aroused suspicion of UPDATE_TIME in them on March 29, 1:30 am - the last Sunday of March.  After calculation <pre> <code class="sql hljs">UPDATE_TIME+ INTERVAL '3500' SECOND</code> </pre>  just falls in the interval between 2:00 and 3:00 at night - the non-existent time for the time zone using DST. <br>  To check the suspicions, similar data were entered into the development database - The request continued to work without fail. <br>  I try with <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">session</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">time_zone</span></span> =<span class="hljs-string"><span class="hljs-string">'europe/warsaw'</span></span></code> </pre>  And I hit the target - I managed to repeat the mistake on the development site.  This could have stopped by requesting the installation of the corresponding time zone updates on the database (detailed information on Oracle updates at the end of the article).  But I wondered if it was possible to correct this behavior by rewriting the SQL query. <br><br>  I try to transfer the entropy from one part of the expression to another <b>option number 2</b> <br><blockquote><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>, UPDATE_TIME <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TABLE1 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> UPDATE_TIME <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> ( SYSTIMESTAMP - <span class="hljs-built_in"><span class="hljs-built_in">INTERVAL</span></span> <span class="hljs-string"><span class="hljs-string">'3500'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SECOND</span></span> )&gt; UPDATE_TIME</code> </pre></blockquote><br>  Everything is OK, but we make the assumption that the SYSTIMESTAMP value can still be taken from ‚Äúnon-existent time‚Äù and, accordingly, one hour is possible in a year when the application is not working. <br><br>  We come to <b>option number 3</b> <br><blockquote><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>, UPDATE_TIME <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TASK <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> UPDATE_TIME <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> ( SYSTIMESTAMP - UPDATE_TIME ) &gt; <span class="hljs-built_in"><span class="hljs-built_in">INTERVAL</span></span> <span class="hljs-string"><span class="hljs-string">'3500'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SECOND</span></span></code> </pre><br></blockquote><br><br>  Everything seems to be fine, but what if you insert into the table an entry with a time between 2:00 and 3:00 in the morning.  I try March 29 at 2:30 am - requests stop working. <br><blockquote>  ORA-01878: specified field not found in datetime or interval </blockquote><br><br>  There is no reception against scrap - <b>option number 4</b> <br><blockquote><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>, UPDATE_TIME <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TASK <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> UPDATE_TIME <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (to_timestamp_tz(to_char(SYSTIMESTAMP,<span class="hljs-string"><span class="hljs-string">'rrrr-mm-dd hh24:mi:ss'</span></span>)||<span class="hljs-string"><span class="hljs-string">' '</span></span>||<span class="hljs-string"><span class="hljs-string">'UTC'</span></span>,<span class="hljs-string"><span class="hljs-string">'rrrr-mm-dd hh24:mi:ss tzr'</span></span>) - to_timestamp_tz(to_char(UPDATE_TIME,<span class="hljs-string"><span class="hljs-string">'rrrr-mm-dd hh24:mi:ss'</span></span>)||<span class="hljs-string"><span class="hljs-string">' '</span></span>||<span class="hljs-string"><span class="hljs-string">'UTC'</span></span>,<span class="hljs-string"><span class="hljs-string">'rrrr-mm-dd hh24:mi:ss tzr'</span></span>) ) &gt; <span class="hljs-built_in"><span class="hljs-built_in">INTERVAL</span></span> <span class="hljs-string"><span class="hljs-string">'3500'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SECOND</span></span></code> </pre></blockquote><br>  Everything works - but I want to find a solution easier.  I reread the article on <a href="http://stackoverflow.com/questions/22305466/oracle-date-compare-broken-because-of-dst">stackoverflow</a> and the <a href="http://docs.oracle.com/cd/E11882_01/server.112/e10729/ch4datetime.htm">Oracle documentation</a> before the onset of enlightenment: <br><ol><li>  The problem is that UPDATE_TIME, unlike SYSTIMESTAMP, is declared without a time zone, which leads to implicit type conversion in the original query and queries 2 and 3. The query for verification <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(UPDATE_TIME+ <span class="hljs-built_in"><span class="hljs-built_in">INTERVAL</span></span> <span class="hljs-string"><span class="hljs-string">'3500'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SECOND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span> ZONE) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TASK</code> </pre><br></li><li>  If you use LOCALTIMESTAMP instead of SYSTIMESTAMP, then everything will work <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>, UPDATE_TIME <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TASK <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> UPDATE_TIME <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOCALTIMESTAMP</span></span> &gt;(UPDATE_TIME+ <span class="hljs-built_in"><span class="hljs-built_in">INTERVAL</span></span> <span class="hljs-string"><span class="hljs-string">'3500'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SECOND</span></span>)</code> </pre><br></li><li>  You can also change the type of the UPDATE_TIME field to TIMESTAMP with time zone and remember to install the time zone updates on Oracle </li><li>  You can put the current date as a parameter and transfer it from the application - everything will work. </li><li>  If for some reason you need a timestamp without a time zone in conjunction with SYSTIMESTAMP - then you need to bring not the type returned by SYSTIMESTAMP to the type of field UPDATE_TIME <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>, UPDATE_TIME <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TASK <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> UPDATE_TIME <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(SYSTIMESTAMP <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span>) &gt;(UPDATE_TIME+ <span class="hljs-built_in"><span class="hljs-built_in">INTERVAL</span></span> <span class="hljs-string"><span class="hljs-string">'3500'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SECOND</span></span>)</code> </pre><br></li></ol><br><br>  ZY  As promised above, a description of the installation of updates of time zones of the database can be read in the article <a href="http://sbrazgin.blogspot.ru/2014/10/oracle-2014.html">‚ÄúSwitching to the Oracle database winter time in 2014‚Äù</a> . </div><p>Source: <a href="https://habr.com/ru/post/255129/">https://habr.com/ru/post/255129/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255119/index.html">CompTIA certifications for IT professionals. Part 6 of 7. CompTIA Storage +</a></li>
<li><a href="../255121/index.html">How to integrate email and instant messenger for team work</a></li>
<li><a href="../255123/index.html">"Another" look at the choice of a new flash drive</a></li>
<li><a href="../255125/index.html">10 paper encryption methods for schoolchildren with ABBYY FineReader</a></li>
<li><a href="../255127/index.html">Automated testing survey results: 620 responses</a></li>
<li><a href="../255131/index.html">‚ÄúNot a single break!‚Äù Or why should a customer fight with technical support</a></li>
<li><a href="../255133/index.html">How I fumbled with one button different data in the Android application</a></li>
<li><a href="../255135/index.html">Reverse Engineering ESP8266 - Part 1</a></li>
<li><a href="../255137/index.html">Exploring JavaScript Symbols. Symbol - new data type in javascript</a></li>
<li><a href="../255139/index.html">Collect the best of two worlds - frameworks and CMS (part 2)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>