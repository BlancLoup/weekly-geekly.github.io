<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Microsoft DocumentDB: second article, resources and concepts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As already mentioned in the first article, DocumentDB exposes access to its functionality in the form of a RESTful programming model, and entities sto...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Microsoft DocumentDB: second article, resources and concepts</h1><div class="post__text post__text-html js-mediator-article">  As already mentioned in the first article, DocumentDB exposes access to its functionality in the form of a RESTful programming model, and entities stored inside the database are called resources and are addressed by URI.  To access these resources, you can use standard HTTP verbs, headers and status codes. <br>  While we are preparing a good example about DocumentDB (not a quick and thoughtful thing) and answers to your questions in the first article, we suggest reading a little more about the resources and concepts on which DocumentDB works. <br><img src="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-01-44-06-metablogapi/1031.image_5F00_7F1F5D5E.png"><br><a name="habracut"></a><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/1fwnhh0tqc2is001_tzml_0-y"><br><br>  The DocumentDB resource model consists of a set of resources that are stored in a specific structure within the account, and each of them is accessible by a constant URI.  So, everything starts with a DocumentDB account.  An account is a logical container in which databases are stored, each of which contains collections, which, in turn, contain stored procedures, triggers, UDFs, etc. Each database has users who have a set of permissions to manipulate documents.  Permissions look like tokens, collections are containers of JSON documents and logic on JS. <br><br>  System resources ‚Äî accounts, databases, collections, users, stored procedures, triggers, and UDF ‚Äî have a fixed schema; documents and attachments do not have constraints on the schema and, accordingly, are called user resources.  Resources of both types are described by JSON. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/262/fd1/3fb/262fd13fb006f70c1e03103d4de99b69.png"><br><br>  Each account, which can be many within a single Azure subscription, is a collection container consisting of units that combine SSD storage and a fixed throughput rate.  Units can be added or removed at any time.  You can create and modify account settings on the Microsoft Azure Management Portal - <a href="http://portal.azure.com/">portal.azure.com</a> - or using the REST API (a good part of the platform functionality is set up for managing by REST API). <br>  If the account is a logical container of the highest level, then the database is a container for collections and a user.  Inside the account can be as many databases. <br><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/pe2fyskk9h_59utujdpoqw"><br><br>  You can store as much data in the database as you need - from several gigabytes to petabytes - and all this storage will work on SSD with fixed bandwidth.  However, the database is not fixed within a single machine ‚Äî it can be a large database in which thousands of collections and terabytes of documents are stored. <br><br>  <b>A collection</b> is a container of the next nesting level, already for JSON documents.  The collection as a container serves not only for joining, but also as a scaling unit - transactions and queries.  The easiest way to scale is to add more collections and distribute SSD storage over them.  Automatic scaling is already working - the collection automatically changes its size as you add or delete documents.  While DocumentDB is in the preview and has only one mode of operation (Standard Preview), the maximum size to which collections can be scaled is 10 GB. <br><br><h4>  Automatic indexing </h4><br><br>  DocumentDB does not require you to schedule a system for you at all.  Documents do not imply its presence and, as soon as you add them to the collection, DocumentDB automatically indexes them (=&gt; you can execute queries).  Automatically indexing documents without having to think about the layout and secondary indexes is one of the main features of DocumentDB.  At the same time, there is a stable and stable number of very fast write operations with successive requests. <br>  Automatic indexing can be slightly corrected by choosing an indexing policy and, thus, gaining in performance and storage.  You can either disable automatic indexing altogether, or select only some documents that will be indexed (and select which will NOT be indexed) and choose between synchronous (consistent) and asynchronous (lazy) modes (by default, the index is updated synchronously on each Insert operation, Replace or Delete, this behavior can be corrected to the "lazy" mode and, perhaps, to get some performance benefits with, for example, collections with a large number of reads). <br><br><h4>  Multi-document transactions </h4><br><br>  In RDBMS, business logic is usually written using stored procedures and triggers, starting as a transaction, which imposes on the developer the need to know two different development languages ‚Äã‚Äã- the application development language (JS, Python, etc.) and T-SQL.  In DocumentDB, the JS execution model is available for collections in the form of stored procedures and triggers, which allows for efficient concurrency control, indexing, and not being distracted by an abundance of application tools. <br>  DocumentDB independently wraps this logic in Ambient ACID transaction with snapshot isolation and, if JS throws an exception in the JS process, then the entire transaction is rolled back.  JS execution takes place inside the engine in the same address space as the Buffer Pool, which has a good effect on performance. <br><br><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">businessLogic</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name, author</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = getContext(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> collectionManager = context.getCollection(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> collectionLink = collectionManager.getSelfLink() <span class="hljs-comment"><span class="hljs-comment">//  . collectionManager.createDocument(collectionLink, {id: name, author: author}, function(err, documentCreated) { if(err) throw new Error(err.message); //     var filterQuery = "SELECT * from root r WHERE r.author = 'George R.'"; collectionManager.queryDocuments(collectionLink, filterQuery, function(err, matchingDocuments) { if(err) throw new Error(err.message); context.getResponse().setBody(matchingDocuments.length); //   for (var i = 0; i &lt; matchingDocuments.length; i++) { matchingDocuments[i].author = "George RR Martin"; // we don't need to execute a callback because they are in parallel collectionManager.replaceDocument(matchingDocuments[i]._self, matchingDocuments[i]); } }) }) };</span></span></code> </pre> <br>  All this is successfully wrapped in transactional execution via HTTP POST. <br><br><pre> <code class="javascript hljs">client.createStoredProcedureAsync(collection._self, {<span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"CRUDProc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">body</span></span>: businessLogic}) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">createdStoredProcedure</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.executeStoredProcedureAsync(createdStoredProcedure.resource._self, <span class="hljs-string"><span class="hljs-string">"NoSQL Distilled"</span></span>, <span class="hljs-string"><span class="hljs-string">"Martin Fowler"</span></span>); }) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">result</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(result); }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(error); });</code> </pre><br><br>  JSON and JS our hero understands out of the box, so no problems with the types occur.  Learn more - <a href="http://go.microsoft.com/fwlink/p/%3Flinkid%3D402413%26clcid%3D0x409">Azure DocumentDB REST APIs</a> . <br><br><h4>  Stored procedures, triggers and UDF </h4><br><br>  As already mentioned, business logic can be written entirely in JS as a stored procedure, trigger or UDF.  A JS application can be registered for execution for triggers, stored procedures and UDFs, triggers and stored procedures can CRUD, while UDFs do not have write access, and permission is only to perform simple operations, such as enumerations and creating new results previous operation.  Each procedure, trigger, and UDF use a fixed amount of resources while not being able to access external JS libraries.  If the allocated resources are exceeded, operations are blocked. <br><br>  The procedure, trigger, and UDF can be registered for execution using the REST API, and after registration, the stored procedure, trigger, or UDF are precompiled and stored as a bytecode that is launched for execution. <br><br><h4>  Registration of stored procedures </h4><br><br>  Registering a stored procedure = creating a resource for a new procedure and assigning its collection with HTTP POST. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> storedProc = { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"validateAndCreate"</span></span>, <span class="hljs-attr"><span class="hljs-attr">body</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">documentToCreate</span></span></span><span class="hljs-function">) </span></span>{ documentToCreate.id = documentToCreate.id.toUpperCase(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> collectionManager = getContext().getCollection(); collectionManager.createDocument(collectionManager.getSelfLink(), documentToCreate, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, documentCreated</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(err) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'Error while creating document: '</span></span> + err.message; getContext().getResponse().setBody(<span class="hljs-string"><span class="hljs-string">'success - created '</span></span> + documentCreated.name); }); } }; client.createStoredProcedureAsync(collection._self, storedProc) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">createdStoredProcedure</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Successfully created stored procedure"</span></span>); }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Error"</span></span>); });</code> </pre><br><br><h4>  Execution of the stored procedure </h4><br><br>  Execution of the stored procedure is done again with HTTP POST with the transfer of the necessary parameters in the request body. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> inputDocument = {<span class="hljs-attr"><span class="hljs-attr">id</span></span> : <span class="hljs-string"><span class="hljs-string">"document1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">author</span></span>: <span class="hljs-string"><span class="hljs-string">"GG Marquez"</span></span>}; client.executeStoredProcedureAsync(createdStoredProcedure.resource._self, inputDocument) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">executionResult</span></span></span><span class="hljs-function">) </span></span>{ assert.equal(executionResult, <span class="hljs-string"><span class="hljs-string">"success - created DOCUMENT1"</span></span>); }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Error"</span></span>); });</code> </pre><br><br><h4>  Trigger Registration </h4><br><br>  Trigger Registration = Create a new resource for the collection with HTTP POST, and in the process, you can specify whether the trigger will be called before or after and the type of operation to be performed (CRUD). <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> preTrigger = { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"upperCaseId"</span></span>, <span class="hljs-attr"><span class="hljs-attr">body</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> item = getContext().getRequest().getBody(); item.id = item.id.toUpperCase(); getContext().getRequest().setBody(item); }, <span class="hljs-attr"><span class="hljs-attr">triggerType</span></span>: TriggerType.Pre, <span class="hljs-attr"><span class="hljs-attr">triggerOperation</span></span>: TriggerOperation.All } client.createTriggerAsync(collection._self, preTrigger) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">createdPreTrigger</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Successfully created trigger"</span></span>); }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Error"</span></span>); });</code> </pre><br><br>  You can remove the registration of a trigger by executing HTTP DELETE on the trigger resource. <br><br><pre> <code class="javascript hljs">client.deleteTriggerAsync(createdPreTrigger._self); .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Error"</span></span>); });</code> </pre><br><br><h4>  Attachments </h4><br><br>  In DocumentDB, you can store binary files (blobs) that look like special entities - attachments.  An attachment is a special document (JSON) that <b>refers</b> to a real file.  For example: <br>  The content of a book is in storage in DocumentDB or any other. <br>  The application can store each user's metadata as a separate document - for example, Alex for book1 will be available via the link / colls / alex / docs / book1. <br>  Attachments point to the pages of the book, that is, / colls / alex / docs / book1 / chapter1, chapter2, etc. <br><br><h4>  Summary </h4><br><br>  In this introductory article, we looked at the very basic principles and concepts of DocumentDB.  The service is new, so we are actively studying it ourselves, and we hope that soon we will be able to present some beautiful example of use.  Stay in touch :) <br><br><h3>  useful links </h3><br><ul><li>  <a href="http://l.techdays.ru/go/azuretrial">Try Azure</a> for free for 30 days! </li><li>  <a href="http://l.techdays.ru/go/mva">Explore</a> Microsoft Virtual Academy <a href="http://l.techdays.ru/go/mva">courses</a> on cloud and other technologies </li><li>  <a href="http://l.techdays.ru/go/getvs">Download</a> free or trial Visual Studio </li><li>  <a href="http://www.azurehub.ru/">Microsoft Azure Development Center (azurehub.ru)</a> - scripts, tutorials, examples, design recommendations </li><li>  <a href="http://www.twitter.com/windowsazure_ru">Twitter.com/windowsazure_ru</a> - the latest Microsoft Azure news </li><li>  <a href="http://www.facebook.com/groups/azurerus/">Microsoft Azure Community on Facebook</a> - experts, questions </li><li>  <a href="http://l.techdays.ru/go/winstart">Become a</a> universal Windows application <a href="http://l.techdays.ru/go/winstart">developer</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/241307/">https://habr.com/ru/post/241307/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../241297/index.html">Do you use the mouse while working?</a></li>
<li><a href="../241299/index.html">Resurrect FTDI in pictures</a></li>
<li><a href="../241301/index.html">MindStream. How do we write software under FireMonkey. Part 3. DUnit + FireMonkey</a></li>
<li><a href="../241303/index.html">We use closures in Swift in full</a></li>
<li><a href="../241305/index.html">As we voiced the stadium "Spartak"</a></li>
<li><a href="../241309/index.html">Passive fingerprinting to detect synthetic traffic</a></li>
<li><a href="../241311/index.html">A. Kibkalo - Windows Server "10": what's new in virtualization (practice)</a></li>
<li><a href="../241313/index.html">Active Directory vs. Azure Active Directory</a></li>
<li><a href="../241315/index.html">How to make data talk</a></li>
<li><a href="../241317/index.html">Markov random fields</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>