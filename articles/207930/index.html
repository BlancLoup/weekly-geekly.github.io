<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Basic Node.JS application using express</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. 
 I was looking for an article on how to make a basic Node.JS application using express, or rather, what the basic structure should be for a pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Basic Node.JS application using express</h1><div class="post__text post__text-html js-mediator-article">  Hello. <br>  I was looking for an article on how to make a basic Node.JS application using express, or rather, what the basic structure should be for a project, but I did not find anything like it. <br>  Therefore I decided to write my own, in order to explain in the same way as I how to do it and how it should look. <br><br>  Details under the cut.  Caution.  Lots of text and code. <br><a name="habracut"></a><br>  Before starting, I want to note that this is my first article.  I may not be taking into account something, or vice versa, focusing on something more attention, I will be grateful for the amendments and clarifications on the article, as well as on the approach. <br><br>  The task was the following: to make a basic application that could process requests, and display the correct pages, or the correct answers to requests. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So.  Let's start with the modules used inside the application: <br><br><pre><code class="hljs 1c">express -  , <span class="hljs-keyword"><span class="hljs-keyword"></span></span>  http- mongoose - , <span class="hljs-keyword"><span class="hljs-keyword"></span></span>    MongoDB mongodb - native-driver <span class="hljs-keyword"><span class="hljs-keyword"></span></span>   MongoDB  connect-mongo -  <span class="hljs-keyword"><span class="hljs-keyword"></span></span>  express  session node-uuid - <span class="hljs-keyword"><span class="hljs-keyword"></span></span>   <span class="hljs-keyword"><span class="hljs-keyword"></span></span>  (   -) async - <span class="hljs-keyword"><span class="hljs-keyword"></span></span>     ,  Promise ejs-locals -  ,     nconf - <span class="hljs-keyword"><span class="hljs-keyword"></span></span>      ( config.json) string - <span class="hljs-keyword"><span class="hljs-keyword"></span></span>     ,      ,  html    validator -   winston - <span class="hljs-keyword"><span class="hljs-keyword"></span></span>   </code> </pre> <br><br>  Each of the modules can be installed using the command: <br>  npm install &lt;&lt; module_name &gt;&gt; --save <br><br>  <b>--save is</b> needed to save the module in dependency (package.json), to further deploy the application on other machines. <br><br>  The structure of the application is obtained as follows: <br><br><pre> <code class="hljs pgsql"> /config config.json <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.js /middleware checkAuth.js errorHandler.js <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.js /models <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.js /<span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-comment"><span class="hljs-comment">/*JS, CSS, HTML static files*/</span></span> /routes authentication.js error.js <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.js main.js register.js /utils <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.js <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>.js mongoose.js <span class="hljs-keyword"><span class="hljs-keyword">validate</span></span>.js /views <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.ejs manage.js package.json <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.js</code> </pre><br><br>  Now, strictly speaking, I will explain the salt of each of the directories and its scripts. <br>  Let's start with the most important script that initiates all our applications. <br><br><h3>  server.js </h3><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> express = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>), http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>), app = express(), middleware = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./middleware'</span></span>)(app, express), config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./config'</span></span>), log = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./utils/log'</span></span>)(app, <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>); http.createServer(app).listen(config.get(<span class="hljs-string"><span class="hljs-string">'port'</span></span>), <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">'Express server listening on port '</span></span> + config.get(<span class="hljs-string"><span class="hljs-string">'port'</span></span>)); });</code> </pre><br><br>  In <b>server.js,</b> we create an epxress <b>app</b> , connect the <b>middleware</b> module in which all the necessary middleware applications are connected. <br>  Next, create a server that will handle all incoming connections through the port that is specified in the config. <br><br><h3>  package.json </h3><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"test_express_app"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"private"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"scripts"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: <span class="hljs-string"><span class="hljs-string">"node server.js"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"dependencies"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"express"</span></span>: <span class="hljs-string"><span class="hljs-string">"~3.4.6"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"mongoose"</span></span>: <span class="hljs-string"><span class="hljs-string">"~3.8.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"node-uuid"</span></span>: <span class="hljs-string"><span class="hljs-string">"~1.4.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"nconf"</span></span>: <span class="hljs-string"><span class="hljs-string">"~0.6.9"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"winston"</span></span>: <span class="hljs-string"><span class="hljs-string">"~0.7.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"async"</span></span>: <span class="hljs-string"><span class="hljs-string">"~0.2.9"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"mongodb"</span></span>: <span class="hljs-string"><span class="hljs-string">"~1.3.22"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ejs-locals"</span></span>: <span class="hljs-string"><span class="hljs-string">"~1.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"connect-mongo"</span></span>: <span class="hljs-string"><span class="hljs-string">"~0.4.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"validator"</span></span>: <span class="hljs-string"><span class="hljs-string">"~2.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"string"</span></span>: <span class="hljs-string"><span class="hljs-string">"~1.7.0"</span></span> } }</code> </pre><br><br>  It contains all the necessary information about the project, as well as all the required packages. <br><br><h3>  manage.js </h3><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mongoose = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./utils/mongoose'</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'async'</span></span>), User = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./models/user'</span></span>), log = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./utils/log'</span></span>)(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>), config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./config'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">openConnection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">cb</span></span></span><span class="hljs-function">) </span></span>{ mongoose.connection.on(<span class="hljs-string"><span class="hljs-string">'open'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">'connected to database '</span></span> + config.get(<span class="hljs-string"><span class="hljs-string">'db:name'</span></span>)); cb(); }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dropDatabase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">cb</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> db = mongoose.connection.db; db.dropDatabase(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">'dropped database '</span></span> + config.get(<span class="hljs-string"><span class="hljs-string">'db:name'</span></span>)); cb(); }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createBaseUser</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">cb</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> admin = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User({ <span class="hljs-attr"><span class="hljs-attr">username</span></span>: <span class="hljs-string"><span class="hljs-string">'admin'</span></span>, <span class="hljs-attr"><span class="hljs-attr">password</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'project:admin:password'</span></span>), <span class="hljs-attr"><span class="hljs-attr">email</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'project:admin:email'</span></span>), <span class="hljs-attr"><span class="hljs-attr">role</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> }); admin.save(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">'created database '</span></span> + config.get(<span class="hljs-string"><span class="hljs-string">'db:name'</span></span>)); log.info(<span class="hljs-string"><span class="hljs-string">'created base admin user'</span></span>); cb(); }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ensureIndexes</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">cb</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">async</span></span>.each(<span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.keys(mongoose.models), <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">model, callback</span></span></span><span class="hljs-function">) </span></span>{ mongoose.models[model].ensureIndexes(callback); }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">'indexes ensured completely'</span></span>); cb(); }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">closeConnection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ mongoose.disconnect(); log.info(<span class="hljs-string"><span class="hljs-string">'disconnected'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">async</span></span>.series( [ openConnection, dropDatabase, createBaseUser, ensureIndexes ], closeConnection );</code> </pre><br><br>  It is necessary to initialize the database, filling in the default information with which the server will operate. <br><br><h3>  config </h3><br><h4>  config.json </h4><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"port"</span></span>: <span class="hljs-number"><span class="hljs-number">3000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"db"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"connection"</span></span>: <span class="hljs-string"><span class="hljs-string">"mongodb://localhost"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"db_name"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"options"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"server"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"socketOptions"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"keepAlive"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> } } } }, <span class="hljs-attr"><span class="hljs-attr">"session"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"secret"</span></span>: <span class="hljs-string"><span class="hljs-string">"secret_key"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"cid"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cookie"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"path"</span></span>: <span class="hljs-string"><span class="hljs-string">"/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"httpOnly"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"maxAge"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> } } }</code> </pre><br><br><h4>  index.js </h4><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nconf = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'nconf'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> path = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); nconf.argv() .env() .file({<span class="hljs-attr"><span class="hljs-attr">file</span></span>: path.join(__dirname, <span class="hljs-string"><span class="hljs-string">'config.json'</span></span>)}); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = nconf;</code> </pre><br><br>  The <b>config.js</b> file contains information about database connection settings, as well as session settings. <br>  To work with the <b>config</b> , the <b>nconf</b> package is <b>used</b> , which allows manipulating the settings object via getter and setter.  You can also use embedded objects through the symbol:: <br><br><pre> <code class="javascript hljs">config.get(<span class="hljs-string"><span class="hljs-string">'session:secret'</span></span>); config.get(<span class="hljs-string"><span class="hljs-string">'session:cookie:path'</span></span>);</code> </pre><br><br><h3>  middleware </h3><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">app, express</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ejs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'ejs-locals'</span></span>), path = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>), config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../config'</span></span>), mongoose = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../utils/mongoose'</span></span>), MongoStore = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'connect-mongo'</span></span>)(express), router = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../routes'</span></span>), errorHandler = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./errorHandler'</span></span>)(app, express), checkAuth = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./checkAuth'</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** * Page Rendering * */</span></span> app.engine(<span class="hljs-string"><span class="hljs-string">'html'</span></span>, ejs); app.engine(<span class="hljs-string"><span class="hljs-string">'ejs'</span></span>, ejs); app.set(<span class="hljs-string"><span class="hljs-string">'views'</span></span>, path.join(__dirname, <span class="hljs-string"><span class="hljs-string">'../views'</span></span>)); app.set(<span class="hljs-string"><span class="hljs-string">'view engine'</span></span>, <span class="hljs-string"><span class="hljs-string">'ejs'</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** * Favicon * */</span></span> app.use(express.favicon(<span class="hljs-string"><span class="hljs-string">'public/images/favicon.ico'</span></span>)); <span class="hljs-comment"><span class="hljs-comment">/** * Logger * */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (app.get(<span class="hljs-string"><span class="hljs-string">'env'</span></span>) == <span class="hljs-string"><span class="hljs-string">'development'</span></span>) { app.use(express.logger(<span class="hljs-string"><span class="hljs-string">'dev'</span></span>)); } <span class="hljs-comment"><span class="hljs-comment">/** * Session * */</span></span> app.use(express.bodyParser()); app.use(express.cookieParser()); app.use(express.session({ <span class="hljs-attr"><span class="hljs-attr">secret</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'session:secret'</span></span>), <span class="hljs-attr"><span class="hljs-attr">key</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'session:key'</span></span>), <span class="hljs-attr"><span class="hljs-attr">cookie</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'session:cookie'</span></span>), <span class="hljs-attr"><span class="hljs-attr">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MongoStore({<span class="hljs-attr"><span class="hljs-attr">mongoose_connection</span></span>: mongoose.connection}) })); <span class="hljs-comment"><span class="hljs-comment">/** * Authorization Access * */</span></span> app.use(checkAuth); <span class="hljs-comment"><span class="hljs-comment">/** * Routing * */</span></span> app.use(app.router); router(app); <span class="hljs-comment"><span class="hljs-comment">/** * Public directory * */</span></span> app.use(express.static(path.join(__dirname, <span class="hljs-string"><span class="hljs-string">'../public'</span></span>))); app.use(<span class="hljs-string"><span class="hljs-string">"/public"</span></span>, express.static(path.join(__dirname, <span class="hljs-string"><span class="hljs-string">'../public'</span></span>))); <span class="hljs-comment"><span class="hljs-comment">/** * Error handing * */</span></span> app.use(errorHandler); };</code> </pre><br><br>  Thus, we will connect all <b>middleware</b> without clogging up the main part of the server code, perhaps, it will have to be expanded as the application is written. <br><br>  I also want to note - <b>errorHandler</b> middleware is intended for the own handling of server errors, and the output of the error page <br><br><h4>  errorHandler </h4><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../config'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sendHttpError = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error, res</span></span></span><span class="hljs-function">) </span></span>{ res.status(error.status); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (res.req.xhr) { res.json(error); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { res.render(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">error</span></span>: { <span class="hljs-attr"><span class="hljs-attr">status</span></span>: error.status, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: error.message, <span class="hljs-attr"><span class="hljs-attr">stack</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'debug'</span></span>) ? error.stack : <span class="hljs-string"><span class="hljs-string">''</span></span> }, <span class="hljs-attr"><span class="hljs-attr">project</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'project'</span></span>) }); } }; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">app, express</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> log = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../utils/log'</span></span>)(app, <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>), HttpError = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../error'</span></span>).HttpError; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, req, res, next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> err === <span class="hljs-string"><span class="hljs-string">'number'</span></span>) { err = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpError(err); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> HttpError) { sendHttpError(err, res); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (app.get(<span class="hljs-string"><span class="hljs-string">'env'</span></span>) === <span class="hljs-string"><span class="hljs-string">'development'</span></span>) { express.errorHandler()(err, req, res, next); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { log.error(err); err = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpError(<span class="hljs-number"><span class="hljs-number">500</span></span>); sendHttpError(err, res); } } }; };</code> </pre><br><br>  I would also like to note middleware <b>checkAuth</b> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> HttpError = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../error'</span></span>).HttpError; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!req.session.user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> next(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpError(<span class="hljs-number"><span class="hljs-number">401</span></span>, <span class="hljs-string"><span class="hljs-string">"You are not authorized!"</span></span>)); } next(); };</code> </pre><br>  Which will check requests for the presence of the session and, in the case of its absence, will throw an error.  It can be used as a global middleware or you can specify the method where it will be used: <br><br><pre> <code class="javascript hljs">app.get(<span class="hljs-string"><span class="hljs-string">'/user-info'</span></span>, checkAuth, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//do your staff });</span></span></code> </pre><br><br><h2>  models </h2><br>  With Mongoose, we will create our own models for working with data.  An example of a model might look like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> crypto = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'crypto'</span></span>), mongoose = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../utils/mongoose'</span></span>), Schema = mongoose.Schema, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'async'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> User = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Schema({ <span class="hljs-attr"><span class="hljs-attr">username</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, <span class="hljs-attr"><span class="hljs-attr">unique</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">required</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, <span class="hljs-attr"><span class="hljs-attr">hashedPassword</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, <span class="hljs-attr"><span class="hljs-attr">required</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, <span class="hljs-attr"><span class="hljs-attr">salt</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, <span class="hljs-attr"><span class="hljs-attr">required</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }); User.methods.encryptPassword = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">password</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crypto.createHmac(<span class="hljs-string"><span class="hljs-string">'sha1'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.salt).update(password).digest(<span class="hljs-string"><span class="hljs-string">'hex'</span></span>); }; User.virtual(<span class="hljs-string"><span class="hljs-string">'password'</span></span>) .set(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">password</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._plainPassword = password; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.salt = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() + <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.hashedPassword = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.encryptPassword(password); }) .get(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._plainPassword; }); User.methods.checkPassword = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">password</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.encryptPassword(password) === <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.hashedPassword; }; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = mongoose.model(<span class="hljs-string"><span class="hljs-string">'User'</span></span>, User);</code> </pre><br><br><h3>  public </h3><br>  This directory will contain all scripts and css files that are accessible from the outside.  This option is implemented using the following setting: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Public directory * */</span></span> app.use(express.static(path.join(__dirname, <span class="hljs-string"><span class="hljs-string">'../public'</span></span>))); app.use(<span class="hljs-string"><span class="hljs-string">"/public"</span></span>, express.static(path.join(__dirname, <span class="hljs-string"><span class="hljs-string">'../public'</span></span>)));</code> </pre><br><br><h2>  routes </h2><br>  Perhaps the most interesting.  In this directory, we declare a module that will be responsible for routing.  <b>index.js</b> file <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> main = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./main'</span></span>), register = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./register'</span></span>), authentication = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./authentication'</span></span>), error = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./error'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">app</span></span></span><span class="hljs-function">) </span></span>{ app.get(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, main.home); app.post(<span class="hljs-string"><span class="hljs-string">'/register'</span></span>, register.requestRegistration); app.get(<span class="hljs-string"><span class="hljs-string">'/users'</span></span>, authentication.users); app.get(<span class="hljs-string"><span class="hljs-string">'/users/:id'</span></span>, authentication.user); app.get(<span class="hljs-string"><span class="hljs-string">'*'</span></span>, error[<span class="hljs-string"><span class="hljs-string">'404'</span></span>]); };</code> </pre><br><br>  Here we simply declare our routes, and simply delegate the execution to other modules.  For example, <b>route "/"</b> : <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Method: GET * URI: / * */</span></span> exports.home = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ res.render(<span class="hljs-string"><span class="hljs-string">'index'</span></span>); };</code> </pre><br><br>  Actually, that's all.  In this case, how the base application will work.  To support the session, we enable the corresponding <b>middleware</b> .  All business logic associated with the user is transferred to <b>models / user.js</b> , in particular validation and registration, for example. <br><br>  PS: <br>  In writing this article was used information from screencasts I. Kantor.  Screencast link. <br>  Also used information from courses on <a href="https://education.mongodb.com/"><b>MongoDB</b></a> </div><p>Source: <a href="https://habr.com/ru/post/207930/">https://habr.com/ru/post/207930/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../207920/index.html">Development of tile games in JavaScript (Robbo)</a></li>
<li><a href="../207922/index.html">Identification based on movement data (tracking)</a></li>
<li><a href="../207924/index.html">Intellij IDEA: Oracle Cloud Integration</a></li>
<li><a href="../207926/index.html">Oracle Business Intelligence Overview</a></li>
<li><a href="../207928/index.html">How we helped the blind grandfather. Making the indicator of the level of liquid in the cup with your own hands</a></li>
<li><a href="../207932/index.html">Conceptual features of the design of smart home systems</a></li>
<li><a href="../207934/index.html">Disable extra Asterisk modules</a></li>
<li><a href="../207936/index.html">New job in the new year</a></li>
<li><a href="../207938/index.html">New Year's gift from Nokia</a></li>
<li><a href="../207944/index.html">Happy New Year 2014!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>