<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Security Reverse Engineering vk.com</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This post is a small report on the process of reverse design and analysis of the work of the most popular social. networks in the CIS - vk.com. Most o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Security Reverse Engineering vk.com</h1><div class="post__text post__text-html js-mediator-article">  This post is a small report on the process of reverse design and analysis of the work of the most popular social.  networks in the CIS - vk.com.  Most of the analysis was carried out by the security side (although the social network itself is very attractive as a high-load project, of course).  For myself, made some interesting decisions and just got pleasure.  The post turned out to be a bit muddled, so it went down just in interesting moments for me. <br><br><h4>  Content </h4><br><h5>  Overview </h5><br><h5>  Architecture </h5><br><ul><li>  php 5.2 / 5.3 </li><li>  Load periods (off tape auto load) </li><li>  Message Wrappers </li><li>  Different code for mobile and full versions </li></ul><br><h5>  Security </h5><br><ul><li>  Features <br><ul><li>  Authorization </li><li>  Anti-CSRF tokens </li><li>  Ban iframe </li><li>  POST disabled on content servers </li></ul></li><li>  Fiche-bugs <ul><li>  Find out age through search </li></ul></li><li>  Bugs <ul><li>  Xss </li><li>  Loading unnamed documents </li><li>  Uploading ajax photos from closed albums (?) </li><li>  Not everywhere anti csrf </li></ul></li></ul><br><h5>  miscellanea </h5><br><a name="habracut"></a><br><br><h5>  Overview </h5>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First of all, you should read a couple of old, but interesting articles: <br><ul><li>  Two very similar articles - <a href="http://www.insight-it.ru/masshtabiruemost/arkhitektura-vkontakte/">[1]</a> , <a href="http://www.xakep.ru/post/55052/">[2]</a> </li><li>  A slightly different side is <a href="http://spb-borodin.livejournal.com/596.html">spb-borodin.livejournal.com/596.html</a> </li></ul><br>  After turning on firebug and seeing the site just from the side of the web developer, it immediately becomes clear that there is some mess inside (we‚Äôll return to it at the end of the article), the lack of dispatchers (perhaps to reduce the load), scattered styles and js files and much more.  But in general, a straightforward web application that uses nodejs in busy places, and for the rest ‚Äústandard‚Äù (I would even say ‚Äúworn out‚Äù) development technologies (excluding their undisclosed database. I also tune the balancers configuration). <br><br><h5>  Architecture </h5><br><ul><li>  <b>php 5.2 / 5.3</b> <br>  In the course of working with the application, depending on which backend we fall on, we come across different versions of php (5.2 / 5.3).  Those.  This most likely means that the php version is changing more because of the fixation of various bugs in the interpreter itself, than because of the innovations in php 5.3.  By the way, suhosin is installed </li><li>  <b>Load periods (off tape auto load)</b> <br>  Most likely, a monitor is written that looks after the load and dynamically balances the configs of the scripts.  For example, towards evening the automatic loading of the tape is turned off, which, with a few mln users, can significantly reduce the load. </li><li> <b>Message Wrappers</b> <br>  The feature of adding different content in messages is made quite primitive, but maybe this is true.  When adding a video, sending a message looks like this: <br> <code>act=a_send&amp;al=1&amp;chas=XXXXXXXXXXXXXX&amp;from=box&amp;media=video%3A-22558194_163667075&amp;message=&amp;title=&amp;to_ids=6254003</code> <br>  Those.  just indicate the type of attachment (video, audio, map etc ...) and an internal link to it.  I have been digging with this moment for a long time, trying to slip something in there ‚Äî it didn't work out. <br></li><li>  <b>Different code for mobile and full versions</b> <br>  This is probably obvious, but not gud.  Most likely due to the low code abstraction, which does not allow you to simply take a method and call it on another (for example, mobile) interface.  There are confirmations, for example, various translations (the status of ‚Äúsingle‚Äù is translated into English as ‚ÄúSingle‚Äù in the full version, and ‚ÄúNot married‚Äù in the mobile version. I wrote a ticket to this).  But these are only templates, there are other points that indirectly indicate different code (perhaps the code is simply truncated-duplicated) </li></ul><br><br><h5>  Security </h5><br>  Before starting this section, I will <a href="http://e-kaspersky.livejournal.com/70000.html">send a link</a> to the post of Eugene Kaspersky, although some points are already irrelevant - <a href="http://e-kaspersky.livejournal.com/70000.html">e-kaspersky.livejournal.com/70000.html</a> <br><ul><li>  Features <br><ul><li>  <b>Authorization</b> <br>  This is just the first item.  Authorization takes place according to the following scheme - the action of the form leads on https to login.vk.com, there he sets up a cookie for himself (https://login.vk.com) and for <a href="http://vk.com/">vk.com</a> (remixsid).  If something is wrong with the cookie on the ‚Äúworking‚Äù domain (changed, the last IP did not match, etc.), a redirect to login.vk.com automatically occurs.  And if the password was actually entered on this browser, there will be a persistent cookie (which was set when the original password was entered), which will be used for automatic login.  If not (for example, cookies were taken away and logged in from another ip) then they will not allow your account.  By the way, when I found the XSS I got excited.  In fact, hitting cookies does not give anything (of course, if it is not XSS on login.vk.com).  The same is the record of the last active sessions - 6 pieces, which are considered "alive" </li><li>  <b>Anti-CSRF tokens</b> <br>  I think (I think, not only me) that this method is the best protection against CSRF.  But how beautifully they implemented it ... The first moment is standard, for any action a unique code is generated for the user, which is impossible to predict.  But here the peculiarity of tokens is that they depend on the parameters of the action.  In this case, we have - from_id, to_id, action_id, and sometimes some more parameters.  A hash is taken from all of them (most likely some kind of fast 72-bit hash function), most likely salt is added (static?) (Although, recently it is not passed from_id explicitly) and added to the form.  Those.  for each action with different parameters - a different token. </li><li>  <b>Ban iframe</b> <br>  Actually, the subject.  The site can not be displayed in the iframe, which is correct.  There are various ways to prohibit the display of a site in an iframe. </li><li>  <b>POST disabled on content servers</b> <br>  For various reasons, this is true to limit the server to available methods.  POST is disabled on all content servers. </li></ul></li><li>  Fiche-bugs <ul><li>  <b>Find out age through search</b> <br>  Little trick.  If a person has an age, but is set not to display it - then you can find it out if you find a person through a search and begin to select an age (by filter).  Probably a hyper-bearded fiche-bug. </li></ul></li><li>  Bugs <ul><li>  <b>Xss</b> <br>  Probably, it all started with the fact that I wanted to find XSS, personally for myself.  It was found in the main module of the site - search.  The vector was: <br> <code><a href="http://vk.com/search%3Fc%255Bage_from%255D%3Dalert"></a> vk.com/search?c%5Bage_from%5D=alert(String.fromCharCode(88, 83, 83, 32, 101, 120, 97, 109, 112, 108, 101, 33))&amp;c%5Bname%5D=1&amp;c%5Bsection%5D=people</code> <br> <br><img src="https://habrastorage.org/getpro/habr/post_images/c89/2f6/b1c/c892f6b1c6f5d4753f5067ac3210b55c.jpg"><br>  Alert screen <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6fb/68b/574/6fb68b5743b86e9d06218eac75957b3a.jpg"><br>  Source <br><br>  The number to search for age in its pure form was substituted into the js-function by the parameter.  The only restriction that I ‚Äúcaught here‚Äù is the impossibility of using quotes (they were transformed), which is easily bypassed by string functions.  Corrected just a day or two.  They don't have a ‚Äúbounty‚Äù program.  In response, it was said - corrected, check and everything.  PS Sniffer successfully infiltrated, but it gave nothing, because of the first point about the authorization system. <br></li><li>  <b>Loading unnamed documents</b> <br>  This bug and the next did not have enough time to investigate.  But something and so the article is constantly postponed, so as it is.  When loading documents, he looks at the file extension and either accepts the file or not (essno, I tried to load htaccess and reassign the file roles by extension).  There was a bug with the .model file. The script missed it, but it is always "404" </li><li>  <b>Uploading ajax photos from closed albums (?)</b> <br>  By creating an ajax request for the desired document, we can get the full image of the photo (I think, we noticed in the news feed), which is closed by the privacy settings for you personally.  Maybe it's worth digging. </li><li>  <b>Not everywhere anti CSRF tokens</b> <br>  It really is.  But the places I found were uncritical. </li></ul></li></ul><br><br>  miscellanea <br><ul><li>  <b>Files are not deleted, even after deletion.</b> <br>  Many users somehow care.  If you read the articles at the beginning, you can find out that there are two versions about this - the fragmentation of data on hard drives and the problem of data integrity control.  The second point is really complicated.  The same picture can be deleted, and it may be used somewhere.  Analyzing the entire database for an example of using the document is not easy.  But it's okay hotlink.  But the documents are available only by contacting through the script, but even the documents, after deletion, remain available, although you could add a check.  The technical support answer was: ‚Äúthe document will be available by reference, even if it is deleted.‚Äù And that's it. </li><li>  <b>https is not enabled by default</b> <br>  Coming back to the Kaspersky letter - right now I advise you to forcibly change your bookmarks from http to https, if this has not yet been done.  Now mitm is so simple that enough of any android-smartphone with root.  The droidsheep is installed and clicking on just a couple of buttons will already turn out to sniff cookies (and not only) and automatically go to the site with them </li></ul><br><br>  Garbage <br><ul><li>  Trite, but <a href="http://vk.com/config.php">vk.com/config.php</a> exists :) In general, such things are taken out for htdocs </li><li>  <a href="http://vk.com/admin.html">vk.com/admin.html</a> </li><li>  <a href="http://vk.com/test.html">vk.com/test.html</a> </li><li>  <a href="http://vk.com//login.html">vk.com//login.html</a> </li><li>  <a href="http://vk.com/test.php">vk.com/test.php</a> </li><li>  <a href="http://vk.com//index.php%3F%3DPHPB8B5F2A0-3C92-11d3-A3A9-4C7B08C10000">vk.com//index.php?=PHPB8B5F2A0-3C92-11d3-A3A9-4C7B08C10000</a> - PHP EGGS </li><li>  <a href="http://vk.com/.DS_Store">vk.com/.DS_Store</a> - WTF?  Mac? </li></ul><br><br>  And "in detail".  Base begin to clean.  For example, the limit of messages with the user in the correspondence is large, but already cleared.  Various other developments left trash in a notebook. <br><br>  Maybe somewhere I was mistaken in the idea of ‚Äã‚Äãthe work of the resource and you have a clearer idea about some of the points described above or studied something yourself - I will be glad to hear and discuss them in the comments. </div><p>Source: <a href="https://habr.com/ru/post/156517/">https://habr.com/ru/post/156517/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../156495/index.html">Photographing via WIA on .NET</a></li>
<li><a href="../156501/index.html">Basic themes of popular CMS on Twitter Bootstrap</a></li>
<li><a href="../156507/index.html">Digital Silicone-Free: Digital Marketing Conference</a></li>
<li><a href="../156509/index.html">Some impressions of Surface</a></li>
<li><a href="../156511/index.html">SMB Transparent Failover in Windows Server 2012</a></li>
<li><a href="../156519/index.html">OfficeRecovery is a web API for recovering damaged files.</a></li>
<li><a href="../156525/index.html">Nokia Lumia 920/820 - First Look</a></li>
<li><a href="../156529/index.html">Monument web developer</a></li>
<li><a href="../156533/index.html">MPLS VPN with TE in corporate networks</a></li>
<li><a href="../156537/index.html">CFP started at Positive Hack Days III</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>