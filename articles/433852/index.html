<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The story of one experiment with Cython and C ++ vector</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One  warm  on a cold winter evening, I wanted to warm up in the office and test the theory of one colleague that the C ++ vector could cope with the t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The story of one experiment with Cython and C ++ vector</h1><div class="post__text post__text-html js-mediator-article"><p>  One <del>  warm </del>  on a cold winter evening, I wanted to warm up in the office and test the theory of one colleague that the C ++ vector could cope with the task faster than the CPython list. </p><br><p>  In the company we are developing products based on Django and it so happened that it was necessary to process one large array of dictionaries.  A colleague suggested that the implementation in C ++ would be much faster, but I had the feeling that Guido and the community were probably a little steeper than us in C and could have already decided and avoided all the pitfalls, having implemented everything much faster. </p><br><p>  To test the theory, I decided to write a small test file in which I decided to loop through the insertion of 1M dictionaries of the same content into an array and vector 100 times in a row. </p><br><p>  The results, though expected, were also sudden. </p><a name="habracut"></a><br><p>  It so happened that we actively use Cython, so in general, the results will differ in fully CPython implementation. </p><br><h3 id="stend">  Stand </h3><br><ul><li>  Calculate Linux onegreyonewhite 4.18.14-calculate # 1 SMP PREEMPT Sat Oct 13 21:03:27 UTC 2018 x86_64 Intel¬Æ Core (TM) i7-4770 CPU @ 3.40GHz GenuineIntel GNU / Linux </li><li>  Python 2.7 and 3.6 </li><li>  Cython 0.28.3 </li><li>  gcc (Gentoo 7.3.0-r3 p1.4) </li></ul><br><h3 id="skript">  Script </h3><br><p>  By the way, I had to tinker here.  In order to get the most real numbers (i.e., not just to make it super-optimized, but also so that we can use it without dancing with a tambourine), we had to do everything in the main script, and reduce all additional <em>.h</em> to a minimum. </p><br><p>  The first problem was that the Cython wrapper for the vector does not want to work in this form: </p><br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#    ctypedef vector[object] dict_vec #     (   vector.push_back(dict())) ctypedef vector[PyObject*] dict_vec #   ,   ( ,    object   PyObject.) ctypedef vector[PyObject] dict_vec</span></span></code> </pre> <br><p>  With all this, they got an error that it is impossible to cast dict to PyObject.  Of course, these are Cython problems, but since we use it, we need to solve this particular problem. <br>  I had to make a little crutch in the form <br></p><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Python.h"</span></span></span><span class="hljs-meta"> static PyObject * convert_to_pyobject(PyObject *obj) { return obj; }</span></span></code> </pre> <br><p>  The most amazing thing is that it worked.  What scares me the most is that I do not fully understand why and what the consequences are. </p><br><div class="spoiler">  <b class="spoiler_title">Final Sources</b> <div class="spoiler_text"><p>  cython_experiments.h </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Python.h"</span></span></span><span class="hljs-meta"> static PyObject * convert_to_pyobject(PyObject *obj) { return obj; }</span></span></code> </pre> <br><p>  cython_experiments.pyx </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- # distutils: language = c++ # distutils: include=['./'] # distutils: extra_compile_args=["-O1"] from __future__ import unicode_literals import time from libc.stdlib cimport free from cpython.dict cimport PyDict_New, PyDict_SetItemString from cpython.ref cimport PyObject from libcpp.string cimport string from libcpp.vector cimport vector cdef extern from "cython_experiments.h": PyObject* convert_to_pyobject(object obj) ctypedef vector[PyObject*] dict_vec range_attempts = 10 ** 6 # Insert time cdef test_list(): t_start = time.time() data_list = list() for i from 0 &lt;= i &lt; range_attempts: data_list.append(dict( name = 'test_{}'.format(i), test_data = i, test_data2 = str(i), test_data3 = range(10), )) del data_list return time.time() - t_start cdef test_vector(): t_start = time.time() cdef dict_vec *data_list data_list = new dict_vec() data_list.resize(range_attempts) for i from 0 &lt;= i &lt; range_attempts: data = PyDict_New() PyDict_SetItemString(data, 'name', 'test_{}'.format(i)) PyDict_SetItemString(data, 'test_data', i) PyDict_SetItemString(data, 'test_data2', str(i)) PyDict_SetItemString(data, 'test_data3', range(10)) data_list.push_back(convert_to_pyobject(data)) free(data_list) return time.time() - t_start # Get statistic times = dict(list=[], vector=[]) attempts = 100 for i from 0 &lt;= i &lt; attempts: times['list'].append(test_list()) times['vector'].append(test_vector()) print(''' Attempt: {} List time: {} Vector time: {} '''.format(i, times['list'][-1], times['vector'][-1])) avg_list = sum(times['list']) / attempts avg_vector = sum(times['vector']) / attempts print(''' Statistics: attempts: {} list avg time: {} vector avg time: {} '''.format(attempts, avg_list, avg_vector))</span></span></code> </pre> </div></div><br><h3 id="popytka-1">  Attempt 1 </h3><br><p>  I really want to be able to collect * .whl for the project and that it all started on almost any system, so the optimization flag was first set to 0. This led to a strange result: </p><br><pre> <code class="plaintext hljs">Python 2.7 Statistics: attempts: 100 list avg time: 2.61709237576 vector avg time: 2.92562381506</code> </pre> <br><p>  After some thought, I decided that we would still use the -O1 flag, so I set it up and got it: </p><br><pre> <code class="plaintext hljs">Python 2.7 Statistics: attempts: 100 list avg time: 2.49274396896 vector avg time: 0.922211170197</code> </pre> <br><p>  Once I got a little excited: all the same, the belief in the professionalism of Guido and Co. let me down.  But then, I noticed that the script is somehow suspiciously eating the memory, and by the end it ate up about 20GB of RAM.  The problem was as follows: in the final script, you can observe the function free, after passing the cycle.  At this iteration it was not yet.  Then I thought ... </p><br><h3 id="a-ne-otklyuchit-li-mne-gc">  And if I do not disable gc? </h3><br><p>  Between attempts I did <em>gc.disable ()</em> and after trying <em>gc.enable ()</em> .  I run the build and script and get: </p><br><pre> <code class="plaintext hljs">Python 2.7 Statistics: attempts: 100 list avg time: 1.00309731514 vector avg time: 0.941153049469</code> </pre> <br><p>  In general, the difference is not big, so I thought that there is no point <del>  overpay </del>  try to somehow pervert and just use CPython, but still collect it with Cython. <br>  Probably many have a question: "And what about memory?"  The most amazing (no) is that nothing.  She grew at the same rate and in the same amount.  An <a href="https://habr.com/company/wunderfund/blog/328404/">article</a> came to mind, but I didn‚Äôt want to go into Python sources.  And this meant only one thing - the problem in the implementation of the vector. </p><br><h3 id="final">  The final </h3><br><p>  After long torment with type conversion, namely, that the vector takes a pointer to the dictionary, that final script was obtained and with gc turned on, I received an average difference of 2.6 times (vector faster) and relatively good work with memory. </p><br><p>  Suddenly it dawned on me that I collect everything only under Py2.7 and did not even try to do anything with 3.6. </p><br><p>  And here I was really surprised (after previous results, the surprise was natural): </p><br><pre> <code class="plaintext hljs">Python 3.6 Statistics: attempts: 100 list avg time: 0.8771139788627624 vector avg time: 1.075702157020569 Python 2.7 Statistics: attempts: 100 list avg time: 2.61709237576 vector avg time: 0.92562381506</code> </pre> <br><p>  With all this, gc still worked, the memory was not erased and it was the same script.  Understanding that after a little more than a year, I would have to say goodbye to 2.7, I still didn‚Äôt give rest that there was such a difference.  Most often, I heard / read / experimented and Py3.6 was slower than Py2.7.  However, the guys from Cython-developers did something incredible and changed the situation at the root. </p><br><h3 id="itog">  Total </h3><br><p>  After this experiment, we decided not to bother much with the support of Python 2.7 and the alteration of any parts of the applications in C ++, simply because it is not worth it.  Everything has already been written to us, we can only use this correctly to solve a specific problem. </p><br><p>  UPD 12/24/2018: <br>  According to the advice of <a href="https://habr.com/users/icpu/" class="user_link">iCpu,</a> and after attacks to the side, what is being checked is not understanding what and how, I tried to rewrite the C ++ part as convenient as possible for further development, as well as minimize abstractions.  It turned out even worse: </p><br><div class="spoiler">  <b class="spoiler_title">The result of poor knowledge of C ++</b> <div class="spoiler_text"><p>  cython_experiments.h </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Python.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;vector&gt; #include &lt;algorithm&gt; #ifndef PyString_AsString #define PyString_AsString PyUnicode_AsUTF8 #define PyString_FromString PyUnicode_FromString #endif typedef struct { char* name; bool reverse; } sortFiled; class cmpclass { public: cmpclass(std::vector&lt;char*&gt; fields) { for (std::vector&lt;char*&gt;::iterator it = fields.begin() ; it &lt; fields.end(); it++){ bool is_reverse = false; char* name; if (it[0] == "-"){ is_reverse = true; for(int i=1; i&lt;strlen(*it); ++i) name[i] = *it[i]; } else { name = *it; } sortFiled field = {name, is_reverse}; this-&gt;fields_to_cmp.push_back(field); } } ~cmpclass() { this-&gt;fields_to_cmp.clear(); this-&gt;fields_to_cmp.shrink_to_fit(); } bool operator() (PyObject* left, PyObject* right) { // bool result = false; for (std::vector&lt;sortFiled&gt;::iterator it = this-&gt;fields_to_cmp.begin() ; it &lt; this-&gt;fields_to_cmp.end(); it++){ // PyObject* str_name = PyString_FromString(it-&gt;name); PyObject* right_value = PyDict_GetItem(right, str_name); PyObject* left_value = PyDict_GetItem(left, str_name); if(!it-&gt;reverse){ result = left_value &lt; right_value; } else { result = (left_value &gt; right_value); } PyObject_Free(str_name); if(!result) return false; } return true; } private: std::vector&lt;sortFiled&gt; fields_to_cmp; }; void vector_multikeysort(std::vector&lt;PyObject *&gt; items, PyObject* columns, bool reverse) { std::vector&lt;char *&gt; _columns; for (int i=0; i&lt;PyList_GET_SIZE(columns); ++i) { PyObject* item = PyList_GetItem(columns, i); char* item_str = PyString_AsString(item); _columns.push_back(item_str); } cmpclass cmp_obj(_columns); std::sort(items.begin(), items.end(), cmp_obj); if(reverse) std::reverse(items.begin(), items.end()); } std::vector&lt;PyObject *&gt; _test_vector(PyObject* store_data_list, PyObject* columns, bool reverse = false) { int range_attempts = PyList_GET_SIZE(store_data_list); std::vector&lt;PyObject *&gt; data_list; for (int i=0; i&lt;range_attempts; ++i) { data_list.push_back(PyList_GetItem(store_data_list, i)); } vector_multikeysort(data_list, columns, reverse); return data_list; }</span></span></span></span></code> </pre> <br><p>  cython_experiments.pyx </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- # distutils: language = c++ # distutils: include=['./'] # distutils: extra_compile_args=["-O2", "-ftree-vectorize"] from __future__ import unicode_literals import time from libc.stdlib cimport free from cpython.dict cimport PyDict_New, PyDict_SetItemString from cpython.ref cimport PyObject from libcpp.string cimport string from libcpp.vector cimport vector import gc cdef extern from "cython_experiments.h": vector[PyObject*] _test_vector(object store_data_list, object columns, int reverse) range_attempts = 10 ** 6 store_data_list = list() for i from 0 &lt;= i &lt; range_attempts: store_data_list.append(dict( name = 'test_{}'.format(i), test_data = i, test_data2 = str(i), test_data3 = range(10), )) # Insert time def multikeysort(items, columns, reverse=False): items = list(items) columns = list(columns) columns.reverse() for column in columns: # pylint: disable=cell-var-from-loop is_reverse = column.startswith('-') if is_reverse: column = column[1:] items.sort(key=lambda row: row[column], reverse=is_reverse) if reverse: items.reverse() return items cdef test_list(): t_start = time.time() data_list = list() for i in store_data_list: data_list.append(i) data_list = multikeysort(data_list, ('name', '-test_data'), True) for i in data_list: i del data_list return time.time() - t_start cdef test_vector(): t_start = time.time() data_list = _test_vector(store_data_list, ['name', '-test_data'], 1) for i in data_list: i return time.time() - t_start # Get statistic times = dict(list=[], vector=[]) attempts = 10 gc.disable() for i from 0 &lt;= i &lt; attempts: times['list'].append(test_list()) times['vector'].append(test_vector()) gc.collect() print(''' Attempt: {} List time: {} Vector time: {} '''.format(i, times['list'][-1], times['vector'][-1])) del store_data_list avg_list = sum(times['list']) / attempts avg_vector = sum(times['vector']) / attempts print(''' Statistics: attempts: {} list avg time: {} vector avg time: {} '''.format(attempts, avg_list, avg_vector))</span></span></code> </pre></div></div><br><pre> <code class="plaintext hljs">Python 3.6 Statistics: attempts: 10 list avg time: 0.2640914678573608 vector avg time: 2.5774293661117555</code> </pre> <br><p>  Any idea what could be improved in the coparator to make it work faster? </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/433852/">https://habr.com/ru/post/433852/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../433842/index.html">[Friday] ASCII graffiti on retro monitors and other surfaces</a></li>
<li><a href="../433844/index.html">About the three components necessary for the success of IT</a></li>
<li><a href="../433846/index.html">Nuclear power before the NPP</a></li>
<li><a href="../433848/index.html">Apple patent for electric cars</a></li>
<li><a href="../433850/index.html">Luxon - a new library for working with dates from the team Moment.js</a></li>
<li><a href="../433854/index.html">Flying cars, robots, doctors and blockchain: what came true in 2018</a></li>
<li><a href="../433856/index.html">And who is in your gang?</a></li>
<li><a href="../433858/index.html">The best reports of the JPoint 2018: Java / JVM and its performance, Kotlin, Spring, Docker</a></li>
<li><a href="../433860/index.html">Taking care of the user, or how to protect customers from mistakes</a></li>
<li><a href="../433864/index.html">Improving Development Productivity with Vue - Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>