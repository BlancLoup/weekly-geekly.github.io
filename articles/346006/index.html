<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Beginners on Arduino: We pack the state machine in a separate class and library</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last article about writing finite automata, I promised to pack our ingenious code in the form of a class in C ++ for repeated convenient use. I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Beginners on Arduino: We pack the state machine in a separate class and library</h1><div class="post__text post__text-html js-mediator-article"><p>  In the <a href="https://habrahabr.ru/post/345960/">last article about writing finite automata,</a> I promised to pack our ingenious code in the form of a class in C ++ for repeated convenient use.  I will do the same on the example of my old development <a href="https://github.com/nw-wind/SmartButton">SmartButton</a> .  So, we get into the incomprehensible world of arduin libraries and <abbr title="Object Oriented Programming">PLO</abbr> . </p><br><p><img src="https://habrastorage.org/webt/nu/v5/ph/nuv5phywxlaedikjdodtastzuwa.png" alt="Folders with Libraries"></p><a name="habracut"></a><br><h2 id="zachem-vsyo-eto-nuzhno">  Why is all this necessary? </h2><br><p>  Arduino IDE allows you to use C ++ 11 syntax, it turns out.  That is, there is a very developed object-oriented language.  We want to focus on our ingenious code and the excess logic spread over the program often prevents us from concentrating.  Take, for example, all kinds of displays, buttons, sensors, and relays - each has its own logic, why mix it with the general logic of the program.  The same, for example, the display.  It has many fields, static and changeable.  Oh, the field is the same class.  A field can enter a menu (menu class) or not, be part of a virtual display (class), which in the physical environment can be as much (displays: working, settings, diagnostics, etc.).  The menu, in turn, is controlled by buttons (classes of buttons can be different) or a joystick (class).  All this together - the class "display", which can be declared in your program as: </p><br><pre><code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Display.h"</span></span></span><span class="hljs-meta"> Display disp(   );</span></span></code> </pre> <br><p>  If you are doing a project not entirely on your knee, not something like you are going to change something or reuse some of your own developments - it is better to arrange it in the form of Arduino libraries.  Ideally, of course, put in <a href="http://github.com/">Github</a> for other people, if you don‚Äôt feel sorry and you don‚Äôt mind if someone corrects or supplements your code. </p><br><p>  Since in the last article we made a button, let's design it as a class and a library? </p><br><p>  So, our task is to make it so that we can write in our sketches: </p><br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"myButton.h"</span></span></span><span class="hljs-meta"> myButton b1(4),b2(5),b3(12); </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//     4, 5  12. loop() { b1.run(); b2.run(); b3.run(); // ... if (b1.clicked()) doSomething(); //     ,  . // ... }</span></span></span></span></code> </pre> <br><h2 id="kak-sdelat-biblioteku-arduino">  How to make an Arduino library? </h2><br><p>  It's simple! </p><br><p>  First you need to decide how your library will be called.  Let for example, it will be <strong>MyLib</strong> . </p><br><p>  Find where your sketches are on the computer.  They each lie in their daddy, and next to them is the <strong>libraries</strong> folder.  For example, on the Mac / Users / User / Documents / Arduino / libraries and on Windows: c: \ Users \ User \ Documents \ Arduino \ libraries.  I myself am sitting on a Mac and I don‚Äôt know the path in Windows.  Find it. </p><br><p>  Here in this libraries folder create a new folder MyLib, that is, with the name of your library.  Go there. </p><br><p>  In this new folder you need to create at least one file MyLib.h, the one that you will include in your project.  Its minimum content looks like this: </p><br><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#ifndef</span></span> <span class="hljs-type"><span class="hljs-type">MYLIB_H</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">MYLIB_H</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#if</span></span> <span class="hljs-type"><span class="hljs-type">ARDUINO</span></span> &gt;= <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;<span class="hljs-type"><span class="hljs-type">Arduino</span></span>.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#else</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;<span class="hljs-type"><span class="hljs-type">WProgram</span></span>.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> //    <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span></code> </pre> <br><p>  I'll tell you what here is why.  The construction below allows you to include your library in the code several times without errors.  It is better to use the name of your library in capital letters.  This is not harshly straightforward, but everyone does it and you don‚Äôt stand out.  The task is to come up with a unique word, in our case MYLIB_H, an identifier for this header file. </p><br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> MYLIB_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MYLIB_H </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//   #endif</span></span></span></span></code> </pre> <br><p>  That is, in your sketch there can be several such lines: </p><br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"MyLib.h"</span></span></span></span></code> </pre> <br><p>  You say "bye, yes, I, yes I follow, yes I ..." and you will be wrong.  It is better to write such a construction in one file once, than to correct your finished sketches, if you suddenly want to put one into another, or your library will be included in another, and so on.  This code checks whether the word MYLIB_H is defined; if not, it identifies it and includes further code.  If the word is already defined, then the second time you do not need to compile the code. </p><br><p>  The following important piece of code: </p><br><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#if</span></span> <span class="hljs-type"><span class="hljs-type">ARDUINO</span></span> &gt;= <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;<span class="hljs-type"><span class="hljs-type">Arduino</span></span>.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#else</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;<span class="hljs-type"><span class="hljs-type">WProgram</span></span>.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span></code> </pre> <br><p>  Includes definitions from the Arduino UDE runtime.  Without this, your library simply won't compile. </p><br><p>  Everything.  Close the Arduino IDE. Reopen.  Create a new sketch, write #include "MyLib.h" there and hooray, your library is there and connected! </p><br><h2 id="ya-smotrel-v-biblioteke-vrode-kak-mnogo-faylov-dolzhno-byt">  I looked, in the library it seems like how many files should be? </h2><br><p>  Yes of course.  We took minimal steps to create a library.  Now it‚Äôs time to plan. </p><br><p>  So that I can put pieces of my code here with copy-paste, I will call the SmartButton library, okay?  The pig MyLib can be nailed as unnecessary. </p><br><p>  By analogy with the previous item, create a folder SmartButton, in it: </p><br><ul><li>  SmartButton.h - What we will include in our programs.  There will only be definitions, without a code. </li><li>  SmartButton.cpp - Class program code.  This is not a sketch!  Please note that the file extension is cpp (C ++). </li><li>  README.md - Library file "for people", that is, documentation.  "md" means MarkDown, that is, with markup.  Just name the README. </li><li>  library.json - a library description for the Arduino IDE in a clever JSON format. </li><li>  examples - a folder with examples, which will then be visible in the Arduino IDE.  It should contain the folder with the names of the examples, and in them with the same name files with the ino extension - sketches. </li></ul><br><p><img src="https://habrastorage.org/webt/sy/59/ue/sy59uemo9motq06y2-hze7hp6tu.png" alt="Location of files in the libraries folder"></p><br><p>  SmartButton.h </p><br><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#ifndef</span></span> <span class="hljs-type"><span class="hljs-type">SMART_BUTTON_H</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">SMART_BUTTON_H</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#if</span></span> <span class="hljs-type"><span class="hljs-type">ARDUINO</span></span> &gt;= <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;<span class="hljs-type"><span class="hljs-type">Arduino</span></span>.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#else</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;<span class="hljs-type"><span class="hljs-type">WProgram</span></span>.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> //    include    <span class="hljs-symbol"><span class="hljs-symbol">#ifndef</span></span> <span class="hljs-type"><span class="hljs-type">SmartButton_debounce</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">SmartButton_debounce</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#ifndef</span></span> <span class="hljs-type"><span class="hljs-type">SmartButton_hold</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">SmartButton_hold</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#ifndef</span></span> <span class="hljs-type"><span class="hljs-type">SmartButton_long</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">SmartButton_long</span></span> <span class="hljs-number"><span class="hljs-number">5000</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#ifndef</span></span> <span class="hljs-type"><span class="hljs-type">SmartButton_idle</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">SmartButton_idle</span></span> <span class="hljs-number"><span class="hljs-number">10000</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> class <span class="hljs-type"><span class="hljs-type">SmartButton</span></span> { //    . //        //     . //        . private: byte btPin; // ,     [   ](https://habrahabr.ru/post/<span class="hljs-number"><span class="hljs-number">345960</span></span>/) enum state {<span class="hljs-type"><span class="hljs-type">Idle</span></span>, <span class="hljs-type"><span class="hljs-type">PreClick</span></span>, <span class="hljs-type"><span class="hljs-type">Click</span></span>, <span class="hljs-type"><span class="hljs-type">Hold</span></span>, <span class="hljs-type"><span class="hljs-type">LongHold</span></span>, <span class="hljs-type"><span class="hljs-type">ForcedIdle</span></span>}; enum input {<span class="hljs-type"><span class="hljs-type">Press</span></span>, <span class="hljs-type"><span class="hljs-type">Release</span></span>, <span class="hljs-type"><span class="hljs-type">WaitDebounce</span></span>, <span class="hljs-type"><span class="hljs-type">WaitHold</span></span>, <span class="hljs-type"><span class="hljs-type">WaitLongHold</span></span>, <span class="hljs-type"><span class="hljs-type">WaitIdle</span></span>}; enum state btState = <span class="hljs-type"><span class="hljs-type">Idle</span></span>; enum input btInput = <span class="hljs-type"><span class="hljs-type">Release</span></span>; unsigned long pressTimeStamp; //   ,    . private: void <span class="hljs-type"><span class="hljs-type">DoAction</span></span>(enum input in); //  ,   . public: //   . //   ,     . <span class="hljs-type"><span class="hljs-type">SmartButton</span></span>(); <span class="hljs-type"><span class="hljs-type">SmartButton</span></span>(int pin); <span class="hljs-type"><span class="hljs-type">SmartButton</span></span>(int pin, int mode) {btPin=pin; pinMode(pin,mode);} ~<span class="hljs-type"><span class="hljs-type">SmartButton</span></span>(); //   <span class="hljs-type"><span class="hljs-type">Arduino</span></span> <span class="hljs-type"><span class="hljs-type">IDE</span></span>   begin void begin(int p, int m) {btPin=p; pinMode(p,m);} //      loop(). void run(); //    . public: inline virtual void onClick() {}; // <span class="hljs-type"><span class="hljs-type">On</span></span> click. inline virtual void onHold() {}; // <span class="hljs-type"><span class="hljs-type">On</span></span> hold. inline virtual void onLongHold() {}; // <span class="hljs-type"><span class="hljs-type">On</span></span> long hold. inline virtual void onIdle() {}; // <span class="hljs-type"><span class="hljs-type">On</span></span> timeout with too long key pressing. inline virtual void offClick() {}; // <span class="hljs-type"><span class="hljs-type">On</span></span> depress after click. inline virtual void offHold() {}; // <span class="hljs-type"><span class="hljs-type">On</span></span> depress after hold. inline virtual void offLongHold() {}; // <span class="hljs-type"><span class="hljs-type">On</span></span> depress after long hold. inline virtual void offIdle() {}; // <span class="hljs-type"><span class="hljs-type">On</span></span> depress after too long key pressing. }; <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span></code> </pre> <br><p>  Let's explain the essence of the venture.  We do not know what we will need from the button.  Our ICA is able to be in the states of Click, Press, Hold, and TooLong-Hold, as well as exit from these states to the Off state.  Since we are making the library universal, it is necessary to provide an opportunity for another programmer to insert their code into state handlers.  OOP has a great tool for this ‚Äî inheritance. </p><br><p>  We are making a class that has several methods (functions) and they are empty.  That is, they are, they will be called at the right time, but there is no code in them.  Why is this?  Then, in the sketch, it will be possible to create your own class on the basis of ours, to determine there only the necessary ones from the methods and fill them with your own code. </p><br><p>  For example, we want to make a toggle button, that is, one press is on, the other is off.  We will light and dim the LED and provide the isOn () function for use in the classic form in the loop () function. </p><br><pre> <code class="hljs lua">#include <span class="hljs-string"><span class="hljs-string">"SmartButton.h"</span></span> #define LED_PIN (<span class="hljs-number"><span class="hljs-number">13</span></span>) //      SmartButton class Toggle : public SmartButton { private: <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> sw = <span class="hljs-number"><span class="hljs-number">0</span></span>; //   <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> led; //    public: Toggle(<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> bt_pin, <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> led_pin) : SmartButton(bt_pin) { // . led=led_pin; }; //   //    . <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> isOn() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sw; } //    . virtual void onClick() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sw) { //  . . digitalWrite(led,LOW); //         . } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { //  . . digitalWrite(led,HIGH); //         . } sw=!sw; //  . } }; //   bt   .   . Toggle bt(<span class="hljs-number"><span class="hljs-number">4</span></span>,LED_PIN); //  <span class="hljs-number"><span class="hljs-number">4</span></span>,  . Toggle drill(<span class="hljs-number"><span class="hljs-number">12</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>) //  <span class="hljs-number"><span class="hljs-number">12</span></span>,    <span class="hljs-number"><span class="hljs-number">8.</span></span> void loop() { bt.run(); drill.run(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bt.isOn()) { // -  } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // -   } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (drill.isOn()) { // -  } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // -   } }</code> </pre> <br><p>  As you can see, we are absolutely not interested in the ICA buttons from the previous article, there is no code for this button, it is hidden.  We added our functionality to the base class and made the switch on click.  Our new Toggle class can also be formatted as a library, by the way, or put it in a separate Toggle.h file next to your sketch, you just need to connect it with the #include directive.  We also set foot with LED to highlight the button.  Please note that we just created two objects (bt and drill) of the new Toggle class, and the ICA handle the buttons for us is hidden and does not care. </p><br><p>  Based on the SmartButton class, you can make your classes that they understand double click, for example, they move the cursor on the menu or turn the machine gun turret slowly-faster, depending on how long the button is held.  To do this, it is enough to define your methods described in SmartButton.h as virtual.  It is not necessary to determine everything, only you need. </p><br><p>  At the request of the target audience, here is an example of a PressButton class that provides methods: </p><br><ul><li>  pressed () - the button was pressed, you can call many times. </li><li>  ok () - I understand, listen to the button further, that is, reset. </li></ul><br><pre> <code class="hljs lua">#include <span class="hljs-string"><span class="hljs-string">"SmartButton.h"</span></span> #define LED_PIN (<span class="hljs-number"><span class="hljs-number">13</span></span>) //      SmartButton class PressButton : public SmartButton { private: <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> sw = <span class="hljs-number"><span class="hljs-number">0</span></span>; //   public: PressButton(<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> bt_pin) : SmartButton(bt_pin) {}; // . //   //     . <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> pressed() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sw; }; //   ,   . void ok() { sw=<span class="hljs-number"><span class="hljs-number">0</span></span>; }; //    . virtual void onClick() { sw=<span class="hljs-number"><span class="hljs-number">1</span></span>; }; }; //   bt   .   . PressButton bt(<span class="hljs-number"><span class="hljs-number">4</span></span>); //  <span class="hljs-number"><span class="hljs-number">4.</span></span> PressButton drill(<span class="hljs-number"><span class="hljs-number">12</span></span>) //  <span class="hljs-number"><span class="hljs-number">12.</span></span> void loop() { bt.run(); drill.run(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bt.pressed()) { // -  bt.ok(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // -   } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (drill.pressed()) { // -  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (__) drill.ok(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // -   } }</code> </pre> <br><p>  Thus, we get two independently working "sticky" buttons, which after pressing are in the pressed state until they are reset using the ok () method. </p><br><p>  If you have a menu, you can define onClick () methods for the up and down buttons that will cause the menu cursor to move on the display in the appropriate direction.  The definition of onHold () in them can cause the cursor to move to the beginning and end of the menu, for example.  In the "Enter" button, you can define onClick () as a menu selection, onHold () as an exit with saving, and onLongHold () as an exit without saving. </p><br><p>  If you need a double click, well, define onClick so that you have a click counter there and a time since the previous click.  Then you can distinguish between single and double clicks. </p><br><p>  SmartButton is just an ICA, it is a tool for implementing the behavior of your buttons. </p><br><p>  Where is all the magic hidden?  The magic lies in the file SmartButton.cpp </p><br><pre> <code class="hljs lua">#include <span class="hljs-string"><span class="hljs-string">"SmartButton.h"</span></span> //    . SmartButton::SmartButton() {} SmartButton::~SmartButton() {} //   . //    . SmartButton::SmartButton(int pin) { btPin = pin; pinMode(pin, INPUT_PULLUP); } //     : //   -     , //     [ ](https://habrahabr.ru/post/<span class="hljs-number"><span class="hljs-number">345960</span></span>/). //       on*  off*. void SmartButton::DoAction(enum <span class="hljs-built_in"><span class="hljs-built_in">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>) { enum state st=btState; switch (<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>) { case Release: btState=Idle; switch (st) { case Click: offClick(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case Hold: offHold(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case LongHold: offLongHold(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case ForcedIdle: onIdle(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case WaitDebounce: switch (st) { case PreClick: btState=Click; onClick(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case WaitHold: switch (st) { case Click: btState=Hold; onHold(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case WaitLongHold: switch (st) { case Hold: btState=LongHold; onLongHold(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case WaitIdle: switch (st) { case LongHold: btState=ForcedIdle; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case Press: switch (st) { case Idle: pressTimeStamp=millis(); btState=PreClick; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } //     . //     loop() void SmartButton::run() { unsigned long mls = millis(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!digitalRead(btPin)) DoAction(Press); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> DoAction(Release); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mls - pressTimeStamp &gt; SmartButton_debounce) DoAction(WaitDebounce); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mls - pressTimeStamp &gt; SmartButton_hold) DoAction(WaitHold); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mls - pressTimeStamp &gt; SmartButton_long) DoAction(WaitLongHold); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mls - pressTimeStamp &gt; SmartButton_idle) DoAction(WaitIdle); }</code> </pre> <br><p>  The logic is controversial in places, I know :) But it works. </p><br><p>  Now it remains to fill out the README file with the description of your library and fill in the file library.json file, where the fields are quite obvious: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"SmartButton"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"keywords"</span></span>: <span class="hljs-string"><span class="hljs-string">"button, abstract class, oop"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"The SmartButton abstract class for using custom buttons in Arduino sketches."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"repository"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"git"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://github.com/nw-wind/SmartButton"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"authors"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Sergei Keler"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://github.com/nw-wind"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"frameworks"</span></span>: <span class="hljs-string"><span class="hljs-string">"arduino"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"platforms"</span></span>: <span class="hljs-string"><span class="hljs-string">"*"</span></span> }</code> </pre> <br><p>  If you do not have a repository, you can omit this section. </p><br><p>  Hooray!  The library is ready.  You can pack a folder in a ZIP and distribute it to your friends or copy to your other computers. </p><br><p>  By analogy, you can make a class for any ICA.  The principle is general: you make a class, define virtual methods that you will then need to override to insert your own code or ready-made methods, if universality is not required. </p><br><h2 id="chto-za-github-i-zachem-on-mne">  What kind of Github and why me? </h2><br><p>  Github is a huge community of programmers.  Yes, your code will be publicly lit for the entire Internet, but ... anyone can suggest their own changes to your code.  For example, two people helped me a lot with SmartDelay, one of whom made his own similar library and we looked at each other's code a little bit.  Better two good libraries than two glitches, right? </p><br><p>  To put your library on Github, you need to create an account there, generate a key and create a repository with the same name as your library (folder).  Files can be downloaded via the web interface. </p><br><p>  To install the library from Github to the Arduino IDE, just copy the URL and use the git utility: </p><br><p><img src="https://habrastorage.org/webt/np/9d/oe/np9doelgukzdbidufsdavkyip3y.png"></p><br><p>  Or download the ZIP - it will be just the Arduino library, like all other libraries. </p><br><p>  How to use git in general and Github in particular, there are many articles for sure.  Try searching.  If you do not find it, I will write how I use it. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/346006/">https://habr.com/ru/post/346006/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345988/index.html">The principle of Anna Karenina in programming and IT</a></li>
<li><a href="../345990/index.html">Recovering data from CockroachDB</a></li>
<li><a href="../345994/index.html">About the shape of a rotating fluid</a></li>
<li><a href="../345998/index.html">Why is it bad to be an excellent student</a></li>
<li><a href="../346000/index.html">Business function modeling</a></li>
<li><a href="../346010/index.html">Path maker: from scratch to senor</a></li>
<li><a href="../346014/index.html">Smart voice extension for garlands (esp8266 + stm32)</a></li>
<li><a href="../346016/index.html">[Translation] The anemic domain model is not an anti-pattern, but architecture based on the SOLID principles</a></li>
<li><a href="../346018/index.html">Current trends EdTech</a></li>
<li><a href="../346020/index.html">The decision that must be made in order not to regret life in 30 years</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>