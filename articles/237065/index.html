<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mega-Tutorial Flask, Part 15: Ajax</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the fifteenth article in the series, where I describe my experience of writing a Python web application using the Flask mic framework. 

 The ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mega-Tutorial Flask, Part 15: Ajax</h1><div class="post__text post__text-html js-mediator-article">  This is the fifteenth article in the series, where I describe my experience of writing a <a href="http://python.org/">Python</a> web application using the <a href="http://flask.pocoo.org/">Flask</a> mic framework. <br><br>  The purpose of this guide is to develop a fairly functional microblog application, which I decided to call microblog, in the absence of originality. <br><br><div class="spoiler">  <b class="spoiler_title">Table of contents</b> <div class="spoiler_text">  <a href="http://habrahabr.ru/post/193242/">Part 1: Hello, World!</a> <br>  <a href="http://habrahabr.ru/post/193260/">Part 2: Templates</a> <br>  <a href="http://habrahabr.ru/post/194062/">Part 3: Forms</a> <br>  <a href="http://habrahabr.ru/post/196810/">Part 4: Database</a> <br>  <a href="http://habrahabr.ru/post/222983/">Part 5: User Login</a> <br>  <a href="http://habrahabr.ru/post/223375/">Part 6: Profile Page and Avatars</a> <br>  <a href="http://habrahabr.ru/post/223783/">Part 7: Unit Testing</a> <br>  <a href="http://habrahabr.ru/post/230643/">Part 8: Subscribers, Contacts and Friends</a> <br>  <a href="http://habrahabr.ru/post/230897/">Part 9: Pagination</a> <br>  <a href="http://habrahabr.ru/post/234613/">Part 10: Full Text Search</a> <br>  <a href="http://habrahabr.ru/post/234737/">Part 11: Email Support</a> <br>  <a href="http://habrahabr.ru/post/234785/">Part 12: Reconstruction</a> <br>  <a href="http://habrahabr.ru/post/236753/">Part 13: Date and Time</a> <br>  <a href="http://habrahabr.ru/post/236861/">Part 14: I18n and L10n</a> <br>  <a href="http://habrahabr.ru/post/237065/">Part 15: Ajax (this article)</a> <br>  <a href="http://habrahabr.ru/post/237317/">Part 16: Debugging, Testing, and Profiling</a> <br>  <a href="http://habrahabr.ru/post/237489/">Part 17: Deploying to Linux (even to Raspberry Pi!)</a> <br>  <a href="http://habrahabr.ru/post/237517/">Part 18: Deploying to Heroku Cloud</a> <br></div></div><br><a name="habracut"></a><br>  This will be the last article on the topic of internationalization and localization (I18n and L10n), which we will summarize our efforts to increase the availability of our microblog application for non-English speaking users. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article, we will leave the ‚Äúcomfort zone‚Äù of server development, to which we have become accustomed, and will start working on the functionality for which the server and client components are equally important.  Have you ever seen the "Translate" button that some sites show next to user content?  These links automatically translate content into the user's native language in real time.  The translated content is usually inserted below the original.  Google uses this approach for search results in a foreign language, Facebook for posts.  Today we will add this behavior to our microblog! <br><br><h4>  <b>Server-side vs.</b>  <b>Client-side</b> </h4><br>  In the traditional model of client-server interaction, which we have followed so far, we have a client (client's web browser) sending requests to the server.  The request simply requests a web page, as in the case when you click the ‚ÄúMy Profile‚Äù link, or it can perform some action on the server, as in the case when the user edits his profile and clicks ‚ÄúSend‚Äù.  Regardless of the type, the server responds to the request by sending a new page to the client directly or via a redirect.  Then the browser replaces the current page with a new one.  This cycle is repeated as long as the user remains on the site.  We call this model ‚Äúserver‚Äù because the server does all the work of generating pages, but the client simply displays the pages as they are received. <br><br>  In the ‚Äúclient‚Äù model, we still have a browser that sends requests to the server.  The server responds with a page that is similar to what happened when using the ‚Äúserver‚Äù model, but not all data is represented by HTML, code is also present there, mainly in javascript.  As soon as the client receives the page, it displays it and then executes the code that came instead of with the page.  Now we have an active client that can work without constant interaction with the server.  In the ideal case, the application is downloaded to the client upon initial download, and then it runs and runs on the client even without refreshing the page, interacting with the server only to receive and save data.  This type of application is called <a href="https://ru.wikipedia.org/wiki/Single_Page_Application">Single Page Applications</a> or SPA. <br><br>  Most real-world applications are a combination of these two approaches.  Our application, at the moment, works entirely on the server, but today we will add some logic on the client side.  In order to translate posts in real time, the browser will send requests to the server, but the server will respond with translated text without causing the page to refresh on the client.  The client will then dynamically add the translation to the current page.  This technique is known as <a href="https://ru.wikipedia.org/wiki/AJAX">Ajax</a> , short for Asynchronous Javascript and XML (even though today XML is often replaced with JSON). <br><br><h4>  <b>Translation of custom content</b> </h4><br>  At the moment, our support for foreign languages ‚Äã‚Äãis quite good, thanks to Flask-Babel.  We can publish our application in a huge number of languages, you just need to find translators ready to help us. <br><br>  But we missed one moment.  We made the application available to users who speak different languages, so now, perhaps, we will begin to appear and write in different languages.  And now, our users, looking at the records, are likely to encounter records in languages ‚Äã‚Äãthat they do not understand.  It would be nice to offer an automatic translation feature, right?  The quality of automatic translation remains not very high, but in most cases it is enough to understand the meaning of what has been written, so that all our users (including us) will benefit from having such a function. <br><br>  This function is ideal for implementing it with Ajax.  Suppose that our main page may contain several posts in different languages.  If we implemented the translation of posts in the traditional way, a request to translate a post would cause a replacement of the current page with a new page with the translation of the selected post.  After reading, the user would have to press the "Back" button to return to the list of all posts.  The fact is that requesting translation of a post is not an important enough task to cause a full page refresh.  It would be better if the translated text were simply inserted under the original text of the post, leaving the rest of the content intact.  Therefore, today we are implementing our first Ajax service! <br><br>  The implementation of automatic translation will require several steps from us.  First we need to define the language of the post that we are going to translate.  Knowing the language of the post, we can find out whether its translation is required for a specific user, because we know the language chosen by the user.  If a translation is necessary and the user wishes to see it, we will use our Ajax translation service that runs on the server.  As a result, client-side javascript will add a translation of the post to the page. <br><br><h4>  <b>Post Language Definition</b> </h4><br>  Our first task is to determine the source language of the post.  It is not always possible to accurately determine the language, so we just try to do everything that is possible for this.  To solve this problem, we use the module <a href="http://code.google.com/p/guess-language/">guess-language</a> .  So let's install it.  Linux and Mac OS X users: <br><br><pre><code class="bash hljs">flask/bin/pip install guess-language</code> </pre> <br>  Windows users: <br><pre> <code class="bash hljs">flask\Scripts\pip install guess-language</code> </pre><br>  With this module, we scan the text of each post, trying to determine its language.  Since  we would not like to scan one and tezhe posts over and over again, we will do it once for each post when sent by the user.  Then we will save information about the language of the post along with the post itself in our database. <br><br>  Let's add a language field to our Posts table: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Post</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(db.Model)</span></span></span><span class="hljs-class">:</span></span> __searchable__ = [<span class="hljs-string"><span class="hljs-string">'body'</span></span>] id = db.Column(db.Integer, primary_key = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) body = db.Column(db.String(<span class="hljs-number"><span class="hljs-number">140</span></span>)) timestamp = db.Column(db.DateTime) user_id = db.Column(db.Integer, db.ForeignKey(<span class="hljs-string"><span class="hljs-string">'user.id'</span></span>)) language = db.Column(db.String(<span class="hljs-number"><span class="hljs-number">5</span></span>))</code> </pre><br>  With every change in the database, we should not forget about migrations: <br><br><pre> <code class="bash hljs">$ ./db_migrate.py New migration saved as microblog/db_repository/versions/005_migration.py Current database version: 5</code> </pre><br><br>  Now that we have a place to save information about the post language, let's add the definition of the language to the process of adding a new post: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> guess_language <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> guessLanguage @app.route(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, methods = [<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'POST'</span></span>]) @app.route(<span class="hljs-string"><span class="hljs-string">'/index'</span></span>, methods = [<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'POST'</span></span>]) @app.route(<span class="hljs-string"><span class="hljs-string">'/index/&lt;int:page&gt;'</span></span>, methods = [<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'POST'</span></span>]) @login_required <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">index</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(page = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> form = PostForm() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> form.validate_on_submit(): language = guessLanguage(form.post.data) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> language == <span class="hljs-string"><span class="hljs-string">'UNKNOWN'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> len(language) &gt; <span class="hljs-number"><span class="hljs-number">5</span></span>: language = <span class="hljs-string"><span class="hljs-string">''</span></span> post = Post(body = form.post.data, timestamp = datetime.utcnow(), author = g.user, language = language) db.session.add(post) db.session.commit() flash(gettext(<span class="hljs-string"><span class="hljs-string">'Your post is now live!'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> redirect(url_for(<span class="hljs-string"><span class="hljs-string">'index'</span></span>)) posts = g.user.followed_posts().paginate(page, POSTS_PER_PAGE, <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> render_template(<span class="hljs-string"><span class="hljs-string">'index.html'</span></span>, title = <span class="hljs-string"><span class="hljs-string">'Home'</span></span>, form = form, posts = posts)</code> </pre><br>  If it is not possible to find out the language of the post or an unexpectedly long result is returned, we save an empty string in the language field.  This will be a marker of the fact that the language of the post is unknown to us. <br><br><h4>  <b>Displaying the "Translate" link</b> </h4><br>  The next step is to display the "Translate" link for each post written in a language other than the language used by the user (file app / templates / post.html): <br><br><pre> <code class="html hljs xml">{% if post.language != None and post.language != '' and post.language != g.locale %} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag">&gt;</span></span>{{ _('Translate') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> {% endif %}</code> </pre><br><br>  We did this in the post.html template, thereby adding translation functionality to all pages of the displaying posts.  The ‚ÄúTranslate‚Äù link will be displayed if we can define the language of the post and the specific language is different from the language returned by the localeselector function from Flask-Babel and available to us through g.locale. <br><br>  This link requires the addition of a new text, the words "Translate", which must be included in our translation files, including.  we immediately wrap the string in the _ () function to mark this string for Flask-Babel.  To translate this word, we need to update our language reference (tr_update.py), translate it using poedit and compile (tr_compile.py), as we did in the <a href="http://habrahabr.ru/post/236861/">previous article</a> . <br><br>  At the moment we don‚Äôt know to the end what we should do to launch the translation, so the link will be a stub for now. <br><br><h4>  <b>Translation Services</b> </h4><br>  Before moving on, we need to pick up a translation service. <br><br>  There are many services that provide translation services, but unfortunately, most of them are either paid or have significant limitations. <br><br>  The two leading translation services are <a href="https://developers.google.com/translate/">Google Translate</a> and <a href="http://www.microsofttranslator.com/dev/">Microsoft Translator</a> .  Both are paid, but Microsoft offers a free plan with a small volume of translations.  Google offered free translation earlier, but no more.  And it simplifies our choice of service. <br><br><h4>  <b>Using the Microsoft Translator Service</b> </h4><br>  To use Microsoft Translator there is a set of requirements: <br><ul><li>  The application developer must register with the <a href="https://datamarket.azure.com/dataset/1899a118-d202-492c-aa16-ba21c33c06cb">Microsoft Translator app</a> on the Azure Marketplace.  Here you can choose a tariff plan (free is at the bottom). </li><li>  Then the developer must <a href="https://datamarket.azure.com/developer/applications/">register the application</a> .  The Client ID and Client Secret code will be issued to the registered application, which will be used when sending a request to the service. </li></ul><br>  After registration is complete, the transfer request process is as follows: <br><ul><li>  <a href="http://msdn.microsoft.com/en-us/library/hh454950.aspx">Get access token by</a> passing client id and secret. </li><li>  Call the preferred method - <a href="http://msdn.microsoft.com/en-us/library/ff512404.aspx">Ajax</a> , <a href="http://msdn.microsoft.com/en-us/library/ff512419.aspx">HTTP</a> or <a href="http://msdn.microsoft.com/en-us/library/ff512435.aspx">SOAP</a> , passing the access token and text for translation. </li></ul><br>  It actually sounds harder than it actually is, t.ch.  without getting into details, here‚Äôs the function that does all the work and translates the text into another language (file app / translate.py): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> urllib, httplib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask.ext.babel <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> gettext <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> config <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MS_TRANSLATOR_CLIENT_ID, MS_TRANSLATOR_CLIENT_SECRET <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">microsoft_translate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text, sourceLang, destLang)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> MS_TRANSLATOR_CLIENT_ID == <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> MS_TRANSLATOR_CLIENT_SECRET == <span class="hljs-string"><span class="hljs-string">""</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> gettext(<span class="hljs-string"><span class="hljs-string">'Error: translation service not configured.'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-comment"><span class="hljs-comment"># get access token params = urllib.urlencode({ 'client_id': MS_TRANSLATOR_CLIENT_ID, 'client_secret': MS_TRANSLATOR_CLIENT_SECRET, 'scope': 'http://api.microsofttranslator.com', 'grant_type': 'client_credentials' }) conn = httplib.HTTPSConnection("datamarket.accesscontrol.windows.net") conn.request("POST", "/v2/OAuth2-13", params) response = json.loads (conn.getresponse().read()) token = response[u'access_token'] # translate conn = httplib.HTTPConnection('api.microsofttranslator.com') params = { 'appId': 'Bearer ' + token, 'from': sourceLang, 'to': destLang, 'text': text.encode("utf-8") } conn.request("GET", '/V2/Ajax.svc/Translate?' + urllib.urlencode(params)) response = json.loads("{\"response\":" + conn.getresponse().read().decode('utf-8-sig') + "}") return response["response"] except: return gettext('Error: Unexpected error.')</span></span></code> </pre><br>  This function imports two new items from our configuration file, the id and secret codes given to us by Microsoft (the config.py file): <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># microsoft translation service MS_TRANSLATOR_CLIENT_ID = '' #    app id MS_TRANSLATOR_CLIENT_SECRET = '' #   secret</span></span></code> </pre><br><br>  To use the service, you need to register yourself and register an application to receive data for these configuration variables.  Even if you just want to test our microblog, you need to register (it's free). <br><br>  We added some new text - a few error messages.  They need to be localized, so we run tr_update.py, poedit, and tr_compile.py again to update our translation files. <br><br><h4>  <b>Let's translate something!</b> </h4><br>  So how do we use the translation service?  In fact, it is simple.  Here is an example: <br><br><pre> <code class="bash hljs">$ flask/bin/python Python 2.6.8 (unknown, Jun 9 2012, 11:30:32) &gt;&gt;&gt; from app import translate &gt;&gt;&gt; translate.microsoft_translate(<span class="hljs-string"><span class="hljs-string">'Hi, how are you today?'</span></span>, <span class="hljs-string"><span class="hljs-string">'en'</span></span>, <span class="hljs-string"><span class="hljs-string">'es'</span></span>) u<span class="hljs-string"><span class="hljs-string">'¬øHola, c√≥mo est√°s hoy?'</span></span></code> </pre><br><br><h4>  <b>Ajax on the server</b> </h4><br>  Now we can translate texts from one language to another, t.ch.  we are ready to integrate this functionality into our application. <br><br>  When a user clicks on the ‚ÄúTranslate‚Äù link of the post, an Ajax request is sent to the server.  We will see how to send this request a little later, and now let's focus on the implementation of processing the request on the server side. <br><br>  Ajax service on the server will be an ordinary presentation function with one difference - instead of an HTML page or redirect, it will return data, usually in <a href="https://ru.wikipedia.org/wiki/XML">XML</a> or <a href="https://ru.wikipedia.org/wiki/JSON">JSON format</a> .  Since JSON is somewhat closer to Javascript, we will use this format (file app / views.py): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> jsonify <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> translate <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> microsoft_translate @app.route(<span class="hljs-string"><span class="hljs-string">'/translate'</span></span>, methods = [<span class="hljs-string"><span class="hljs-string">'POST'</span></span>]) @login_required <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">translate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> jsonify({ <span class="hljs-string"><span class="hljs-string">'text'</span></span>: microsoft_translate( request.form[<span class="hljs-string"><span class="hljs-string">'text'</span></span>], request.form[<span class="hljs-string"><span class="hljs-string">'sourceLang'</span></span>], request.form[<span class="hljs-string"><span class="hljs-string">'destLang'</span></span>]) })</code> </pre><br><br>  There is not much new for us.  This submission will process a POST request, which should contain the text for translation and the codes of the source language and the language to which the text should be translated.  Since this is a POST request, we access this data as if it were submitted from an HTML form using the request.form dictionary.  We call one of our translation functions with this data and, after receiving the translation, we convert the answer into JSON using the Flask function jsonify ().  The data that the client will see as an answer to his request will have the following format: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"&lt;   &gt;"</span></span> }</code> </pre><br><br><h4>  <b>Ajax on the client</b> </h4><br>  Now we have to call the Ajax view function from our browser, so we return to the post.html template to finish what we started earlier. <br><br>  We begin by enclosing the text of the post in a span element with a unique id, so that later it is easy to find it in the DOM (file app / templates / post.html): <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"post{{post.id}}"</span></span></span><span class="hljs-tag">&gt;</span></span>{{post.body}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Notice how we created a unique id using the post id.  If the post has id = 3, then the id of the element will be post3. <br><br>  We will also place the ‚ÄúTranslate‚Äù link on the span with a unique id in order to be able to hide this link after the translation is displayed: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"translation{{post.id}}"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag">&gt;</span></span>{{ _('Translate') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Similar to the example above, the translation link will be in the element with id equal to translation3. <br>  And to increase the attractiveness and convenience of the user, we will add an animation informing the user that the translation process on the server is running.  It will be hidden after the page loads and will be displayed only during translation, and will also have a unique id: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"loading{{post.id}}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"display: none"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/static/img/loading.gif"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  So now we have: <br><ul><li>  an element with id equal to post &lt;id&gt; containing the text to translate, </li><li>  an element with id equal to translation &lt;id&gt;, which contains the ‚ÄúTranslate‚Äù link and which will later be replaced with the translated text </li><li>  and an image with id equal to loading &lt;id&gt;, which will be displayed while the translation is being processed. </li></ul><br><br>  The &lt;id&gt; suffix makes these elements unique.  We can have as many posts on a page as desired and they will all have their own set of these three values. <br><br>  Now, by clicking on the ‚ÄúTranslate‚Äù link, we need to send an Ajax request.  To do this, we will create a Javascript function that will do all the work.  Let's start by adding a function call by clicking on the "Translate" link: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"javascript:translate('{{post.language}}', '{{g.locale}}', '#post{{post.id}}', '#translation{{post.id}}', '#loading{{post.id}}');"</span></span></span><span class="hljs-tag">&gt;</span></span>{{ _('Translate') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  The template variables confuse the code a bit, but the function call itself is quite simple.  Consider a post with id = 23, written in Spanish and viewed by a user using the English version of the site.  In this case, the function will be called like this: <br><br><pre> <code class="html hljs xml">translate('es', 'en', '#post23', '#translation23', '#loading23')</code> </pre><br><br>  Those.  the function will receive the languages ‚Äã‚Äãof the original and the destination, as well as selectors of the three post-related elements. <br><br>  We added the function call directly to the post.html template, since it is used to display each post.  We will create the same function in our base template in order to have access to it on all pages of the application (file app / templates / base.html): <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="javascript"><span class="hljs-function"><span class="hljs-title">translate</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">sourceLang, destLang, sourceId, destId, loadingId</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ $(destId).hide(); $(loadingId).show(); $.post(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'/translate'</span></span></span><span class="javascript">, { </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">text</span></span></span><span class="javascript">: $(sourceId).text(), </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">sourceLang</span></span></span><span class="javascript">: sourceLang, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">destLang</span></span></span><span class="javascript">: destLang }).done(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">translated</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ $(destId).text(translated[</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'text'</span></span></span><span class="javascript">]) $(loadingId).hide(); $(destId).show(); }).fail(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ $(destId).text(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"{{ _('Error: Could not contact server.') }}"</span></span></span><span class="javascript">); $(loadingId).hide(); $(destId).show(); }); } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  To implement the required functionality, we use jQuery.  Let me remind you that we connected jQuery earlier, when we connected Bootstrap. <br><br>  We start by hiding the ‚ÄúTranslate‚Äù link and displaying the download indicator. <br><br>  Then we use the $ .post () function to send an Ajax request to our server.  The $ .post function sends a POST request, which is indistinguishable to the server from the request sent by the browser when the form is submitted.  The difference is that on the client this request is sent in the background, without the need to reload the entire page.  When a response is received from the server, the function will be executed which is an argument to the done () function that will try to insert the received data into the page.  This function receives the answer as an argument, t.ch.  we simply replace the ‚ÄúTranslate‚Äù link in the DOM with the translated text, then hide the download indicator, and finally, display the translated text to the user.  Done! <br><br>  If something happened that prevented the client from receiving a response from the server, then the function that is the function argument fail () is executed.  In this case, we simply display an error message, which should also be translated into all supported languages ‚Äã‚Äãand update our translation base. <br><br><h4>  <b>Unit testing</b> </h4><br>  Remember our testing framework?  Always after adding a new code to the application, it is worth assessing whether it makes sense to write tests for this code.  Appeal to the translation service can be broken by us in the process of subsequent work on the code, or in consequence of updates in the work of the service itself.  Let's write a quick test to make sure that we have access to the service and can get a translation: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> app.translate <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> microsoft_translate <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestCase</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(unittest.TestCase)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#... def test_translation(self): assert microsoft_translate(u'English', 'en', 'es') == u'Ingl√©s' assert microsoft_translate(u'Espa√±ol', 'es', 'en') == u'Spanish'</span></span></code> </pre><br><br>  At the moment we do not have a framework for testing client side code, so we will not test the full Ajax request cycle. <br>  Running tests should pass without errors: <br><br><pre> <code class="bash hljs">$ ./tests.py ..... ---------------------------------------------------------------------- Ran 5 tests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 5.932s OK</code> </pre><br>  But if you run tests before specifying data access to the Microsoft Translator, you will receive the following: <br><br><pre> <code class="bash hljs">$ ./tests.py ....F ====================================================================== FAIL: test_translation (__main__.TestCase) ---------------------------------------------------------------------- Traceback (most recent call last): File <span class="hljs-string"><span class="hljs-string">"./tests.py"</span></span>, line 120, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> test_translation assert microsoft_translate(u<span class="hljs-string"><span class="hljs-string">'English'</span></span>, <span class="hljs-string"><span class="hljs-string">'en'</span></span>, <span class="hljs-string"><span class="hljs-string">'es'</span></span>) == u<span class="hljs-string"><span class="hljs-string">'Ingl√©s'</span></span> AssertionError ---------------------------------------------------------------------- Ran 5 tests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 3.877s FAILED (failures=1)</code> </pre><br><br><h4>  <b>Conclusion</b> </h4><br>  On this we finish this article.  I hope you read the article no less enjoyable than writing it to me! <br><br>  Recently I was informed about some problems with the database, when using Flask-WhooshAlchemy for full-text search.  In the next article, I use this problem as a pretext for an excursion into some of the debugging techniques I use when working with applications on Flask.  Expect part XVI! <br><br>  Here is a link to the latest microblog version: <br><br>  Download <a href="">microblog-0.15.zip.</a> <br><br>  Or, if you like it better, you can find the source code on <a href="">GitHub</a> . <br><br>  Miguel </div><p>Source: <a href="https://habr.com/ru/post/237065/">https://habr.com/ru/post/237065/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../237051/index.html">Palo Alto Longevity Prize: a million dollars for slowing the aging process</a></li>
<li><a href="../237055/index.html">Small aircraft, flying drones, IT and my dream ...</a></li>
<li><a href="../237059/index.html">Mozilla has outlined a plan for the release of Rust 1.0</a></li>
<li><a href="../237061/index.html">Square payment service rejected Apple‚Äôs offer to buy for $ 3 billion</a></li>
<li><a href="../237063/index.html">Astronauts will be delivered to the ISS by Boeing and SpaceX.</a></li>
<li><a href="../237071/index.html">Why does light move at the speed of light?</a></li>
<li><a href="../237075/index.html">AirVR video glasses: Samsung Gear VR for iPad</a></li>
<li><a href="../237077/index.html">10 reasons for a failed pitch</a></li>
<li><a href="../237079/index.html">Makeblock Starter Robot Kit V2.0 Review. Part 1. Unpack</a></li>
<li><a href="../237081/index.html">Profession Data Scientist: how not to make a mistake</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>