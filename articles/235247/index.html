<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Common mistakes when protecting sites from CSRF attacks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Currently, a very interesting situation has arisen in the field of security of websites and applications: on the one hand, some developers pay special...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Common mistakes when protecting sites from CSRF attacks</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/ffc/919/01d/ffc91901d4024e0091cfeeedb61783b0.jpg"><br><br>  Currently, a very interesting situation has arisen in the field of security of websites and applications: on the one hand, some developers pay special attention to security, on the other hand, they completely forget about some types of attacks and do not consider errors that allow these attacks to execute vulnerabilities.  For example, CSRF (Cross Site Request Forgery) can be attributed to this category.  This attack allows you to perform various actions on a vulnerable site on behalf of an authorized user.  If you have not heard of this, then I recommend reading the <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B5%25D0%25B6%25D1%2581%25D0%25B0%25D0%25B9%25D1%2582%25D0%25BE%25D0%25B2%25D0%25B0%25D1%258F_%25D0%25BF%25D0%25BE%25D0%25B4%25D0%25B4%25D0%25B5%25D0%25BB%25D0%25BA%25D0%25B0_%25D0%25B7%25D0%25B0%25D0%25BF%25D1%2580%25D0%25BE%25D1%2581%25D0%25B0">relevant</a> Wikipedia <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B5%25D0%25B6%25D1%2581%25D0%25B0%25D0%25B9%25D1%2582%25D0%25BE%25D0%25B2%25D0%25B0%25D1%258F_%25D0%25BF%25D0%25BE%25D0%25B4%25D0%25B4%25D0%25B5%25D0%25BB%25D0%25BA%25D0%25B0_%25D0%25B7%25D0%25B0%25D0%25BF%25D1%2580%25D0%25BE%25D1%2581%25D0%25B0">article</a> to get a general idea of ‚Äã‚Äãthis type of attack.  The main part of the article is intended for those who are concerned about the proper protection of their sites from CSRF. <br><a name="habracut"></a><br><br>  Note 1: formally, CSRF is an attack, not a vulnerability, like XSS.  The vulnerability is improper handling of input data, and CSRF uses this. <br>  Note 2: if any errors seemed obvious to you and are not worth mentioning, then I am happy for you.  However, this material is based on the real vulnerabilities of large sites, and each item shows an error of a development team that turned into a security hole. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  List of errors: </h4><br><h6>  1) There is no protection against CSRF. </h6><br>  From my own experience I can say that at present this is the most common mistake.  It can be found both on obscure blogs and on large projects.  The only good reason not to use protection against this type of attack is that the site does not store any user data, and you do not use the admin panel to edit materials. <br><br><h6>  2) Not all requests are protected. </h6><br>  I would put this error in second place.  On many sites where any protection against CSRF is implemented, vulnerable queries can be found.  For example, if you use the Habr search <a href="http://habrahabr.ru/search/%3Fq%3DCSRF">habrahabr.ru/search/?q=CSRF</a> , you will see a significant number of articles telling about vulnerabilities found on those services where there is protection. <br>  You must protect absolutely all requests that change anything on the site.  You have added a token in the form of changing the email address, and the attacker will not be able to seize the account of your user, changing the mail on his behalf, and then the password?  Great.  That's just such a measure is useless if you can just send a request for the transfer of money from the victim's account to the attacker's wallet, bypassing your protection. <br>  Convenience security is one of the reasons to use only the POST method for requests that change user data.  If you follow this advice, you just need to make sure that all POST requests contain a reliable and correct token.  This will be discussed below. <br><br><h6>  3) Use to protect against CSRF anything other than tokens. </h6><br>  It would seem very convenient to use HTTP referer (https://ru.wikipedia.org/wiki/HTTP_referer) to protect against attacks.  If the title is not a page from your domain, then the request was forged.  But not everything is so rosy.  A small part of HTTP referer users may be empty for various reasons.  In addition, it can be tampered with using old versions of Flash, which puts at risk those who have not updated anything on their computer for a very long time. <br><br>  How about using captcha?  I heard a fairly large number of questions from the developers about the possibility of using them to protect against attacks.  My definitive answer is no.  First, you obviously will not force the user to enter a captcha for every sneeze: this will lead to error number 2. Secondly, not all methods of implementing captcha will provide you with adequate protection that an attacker cannot bypass.  Since this topic is very controversial and relevant, in the future I will devote a separate article to it. <br><br>  To protect against CSRF, you must use anti-CSRF tokens and only them.  Only they provide proper protection for your sites.  In general, the mechanism of tokens is described in Wikipedia: <br><blockquote>  Another common method of protection is the mechanism by which an additional secret key is associated with each user session, which is intended to fulfill requests.  The user sends this key among the parameters of each request, and the server checks this key before performing any actions.  The advantage of this mechanism, compared to the Referer check, is the guaranteed protection against attacks of this type.  The disadvantages are: requirements for the ability to organize user sessions and dynamically generate the HTML code of the active pages of the site. <br></blockquote><br><br><h6>  4) No verification of anti-CSRF token when processing the request. </h6><br>  I encountered a similar error on the websites of very serious companies whose security should be at their best. <br>  There is a token in the request itself, but it is not checked during its processing.  You can insert any string in this field, the request will still be processed correctly.  There is nothing special to comment on, you just need to indicate that using the isset () <a href="http://php.net/manual/ru/function.isset.php">function php.net/manual/ru/function.isset.php</a> to verify the token is completely unacceptable. <br><br><h6>  5) Partial check of anti-CSRF token. </h6><br>  I met this error at once on several large sites of the RuNet in different variations.  For example, one of the sites used tokens of the form "User_Name. Current_Time.Long_Spouse_Number".  In this case, only the correspondence of the username in the token and the login of the person on whose behalf the request was sent was checked.  This complicates the attack a little, but does not make it impossible. <br><br><h6>  6) Ability to use one token for different users. </h6><br>  I met this error once, but on a fairly large site, so I consider it necessary to mention it.  An attacker could register a new account on the site, copy the token from the source code of the page and use it for CSRF.  Do not make such an error, as it completely destroys all the advantages of tokens on your site. <br><br><h6>  7) Insufficient length of the token. </h6><br>  Your token should be so long that an attacker spends at least as much time on selecting him as he does on selecting a user password.  I have seen tokens of 2 characters, they will not help much if someone really wants to make a CSRF attack. <br><br><h6>  8) Predictable tokens. </h6><br>  When designing the token generation algorithm, be sure to use random data in the token (the advice is relevant if you are developing the entire system from scratch. If you use a framework or CMS, you must rely on their developers).  Believe me, the ‚Äúmd5 (user_id)‚Äù token is a very bad idea. <br><br><h6>  9) Lack of tokens in the admin panel or system for technical support staff. </h6><br>  Even if the entire site accessible to your users is protected from CSRF, then you should not forget about the admin panel.  In one narrowly known billing system, there was a lot of CSRF in the admin panel (although they were in the public part of the system, but this is not so important).  And anyone who knew the query structure could use a CSRF attack on a tech support employee and get access to the data of all clients of the company using this billing system.  The only problem is the need to find out the structure of requests: for this you can use social engineering, download a copy from open sources, or just hack a less secure site using the same system. <br><br><h6>  10) Transfer of tokens in open form, especially in GET requests. </h6><br>  On several sites I saw situations when users' tokens were transmitted in open form: if the token is contained in the page address, the user can copy the entire link and place it somewhere, without even knowing about the danger.  You do not need to worry much about the hidden transfer of tokens only when they are disposable, and the user can accidentally reveal only the used token.  However, this is still not very good, as it signals some problems with the architecture of the application: for example, you use GET, and not POST for requests that modify user data. <br><br>  The presence of these errors even on large and serious sites shows that the problem of protection against CSRF attacks is quite acute.  Of course, this list is not exhaustive.  I am sure that you can find a few more errors and ways to exploit them.  However, if you check your sites for the problems described in this article and fix them, you will significantly increase the security of the project. </div><p>Source: <a href="https://habr.com/ru/post/235247/">https://habr.com/ru/post/235247/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../235227/index.html">Welcome to Moscow Django MeetUp ‚Ññ 22</a></li>
<li><a href="../235231/index.html">Awesome WM and Dbus</a></li>
<li><a href="../235233/index.html">Experience with American payment systems</a></li>
<li><a href="../235235/index.html">Apple fixes an important iCloud vulnerability</a></li>
<li><a href="../235245/index.html">Why is it important to maintain temperature in the server. As usual cooling server</a></li>
<li><a href="../235249/index.html">Review of the EcoReco M3 E-Scooter Electric Scooter</a></li>
<li><a href="../235251/index.html">Drupal 7 module. Transfer of meter readings</a></li>
<li><a href="../235253/index.html">Hadoop, java MapReduce: launch from arbitrary web / EE container</a></li>
<li><a href="../235255/index.html">How I studied in high school</a></li>
<li><a href="../235259/index.html">Draw will be cast ¬©</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>