<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Inside the MP3. And how is it all arranged?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once I needed to solve a simple (as it seemed to me then) task - in the PHP script, find out the duration of the mp3 file. I heard about ID3 tags and ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Inside the MP3. And how is it all arranged?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/a09be482/b8ac9b0f/56d8bf37/7e3e0f51.jpg" align="left"><br><br>  Once I needed to solve a simple (as it seemed to me then) task - in the PHP script, find out the duration of the mp3 file.  I heard about ID3 tags and immediately thought that the duration information is stored either in tags or in mp3 file headers.  Superficial searches on the Internet have shown that in a couple of minutes this problem cannot be solved.  Since I am by nature quite curious and the time was not tight - I decided not to use third-party tools but to figure out one of the most popular formats on my own. <br><br>  If you are interested in what's inside - welcome to the cut (traffic). <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article we will not dwell on extracting ID3v2 tags - this can be put in a separate article, as there are various nuances.  And also on header fragments that are practically not used at present (for example, part of Emphasis of an mp3 frame header).  We also do not consider the structure of the audio data itself - the ones that are heard from the speakers. <br><br><h1>  ID3 tags </h1><br><blockquote>  ID3 (from the English. Identify a MP3) is a metadata format most commonly used in MP3 audio files.  The ID3 signature contains information about the title of the track, album, artist name, etc., which are used by multimedia players and other programs, as well as by hardware players, to display information about the file and automatically organize the audio collection. </blockquote><br>  <a href="http://ru.wikipedia.org/wiki/ID3_(%25D0%25BC%25D0%25B5%25D1%2582%25D0%25B0%25D0%25B4%25D0%25B0%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5)">Wikipedia</a> <br><br>  There are two completely different versions of ID3 data: ID3v1 and ID3v2. <br><br>  <b>ID3v1</b> - has a fixed size of 128 bytes, which are appended to the end of the mp3 file.  There you can store: track name, artist, album, year, comment, track number (for version 1.1) and genre. <br><br><img src="https://habrastorage.org/storage/ed686fd3/fca5d20b/e186ab9a/0f43a778.jpg" title="ID3v1 tag format"><br><br>  Pretty soon it became clear to everyone that 128 bytes is a very small place to store such data.  And therefore, over time, the second version of the data, <b>ID3v2</b> , appeared and is being successfully used. <br>  Unlike the first version, v2 tags have a variable length and are placed at the beginning of the file, which allows you to support streaming playback.  (The ID3v2.4 format also allows storing data at the end of the file). <br>  ID3v2 data consists of a header and subsequent ID3v2 frames.  For example, in version ID3v2.3 there are more than 70 frame types. <br><br><img src="https://habrastorage.org/storage/19b5f521/4c9bc2e4/0ff82194/df18a129.jpg" title="ID3v2 tag header"><br><ul><li>  <b>the marker is</b> always 'ID3' </li><li>  Currently there are three <b>versions of</b> ID3v2.2, ID3v2.3 and ID3v2.4 <br>  Version v2.2 is considered outdated. <br>  v2.3 - the most popular version. <br>  v2.4 - is gaining popularity.  One of the differences from v2.3 is that it allows you to use UTF-8 encoding (and not just UTF-16) </li><li>  <b>Flags</b> .  Currently, only three (5,6,7) bits are used: <br>  bin:% abc00000 <br>  a 'unsynchronisation' - used only with MPEG-2 and MPEG-2.5 formats. <br>  b 'Extended header' - indicates the presence of an extended header <br>  with 'Experimental indicator' - an experimental indicator </li><li>  <b>Length</b>  The peculiarity of specifying the length of ID3v2 data is that in each byte the 7th bit is not used and is always set to 0. </li></ul><br>  Consider an example: <br><br><img src="https://habrastorage.org/storage/de6debbd/340d1252/dd5696fb/a3955c30.jpg"><br><br>  In this case, along with the ID3v2 header (10 bytes) - ID3v2 data takes 1024 bytes. <br><br>  After the ID3v2 header, the actual tags go.  A detailed analysis of the reading of ID3v2 tags, as mentioned above, I decided not to include in this article. <br><br>  Now we have information on the availability and length of ID3 tags and we can proceed to the analysis of the mp3-frame and understand the same - where is the duration stored.  But at the same time understand everything else. <br><br><h1>  MP3 frame </h1><br><br>  The entire mp3 file consists of frames, which can only be extracted sequentially.  The frame contains a header and audio data.  Since we are not aiming to write a firmware for a tape recorder, we are interested in the frame header. <br><br><h4>  More about him (a bunch of tables and dry information) </h4><br><br>  Header size is 4 bytes. <br><br><img src="https://habrastorage.org/storage/a6abcb8c/66101ca8/57efbf9c/c0247346.jpg"><br><br>  Description: <br><ul><li>  <b>[0-10]</b> Marker - 11 bits, filled with units (Frame sync) </li><li>  <b>[11-12]</b> MPEG version index (Audio version ID) <br><img src="https://habrastorage.org/storage/4f6ed639/6da95ebc/ee898522/a80061b4.jpg"></li><li>  <b>[13-14]</b> Layer version index (Layer index) <br><img src="https://habrastorage.org/storage/7de2f032/88a3f3a0/cf70234c/6fd20c2a.jpg"><br>  <i>By the way, MP3 is MPEG-1 Layer III</i> </li><li>  <b>[15]</b> Protection bit <br>  <i>1 - no protection</i> <i><br></i>  <i>0 - 16-bit header is protected.</i>  <i>CRC (follows heading)</i> </li><li>  <b>[16-19]</b> Bitrate index <br><img src="https://habrastorage.org/storage/9c7e9dca/a5b8a08e/30b4317b/0c8f6e41.jpg"><br>  <i>The table stores the bitrate values ‚Äã‚Äãin kilobits / sec.</i>  <i>However, in this format it is assumed that 1 kilobit = 1000 bits, not 1024. Thus, 96 Kbps = 96000 bits / sec.</i> </li><li>  <b>[20-21]</b> Sampling rate index <br><img src="https://habrastorage.org/storage/0199e213/f07803aa/9ff4fe1e/00777dbe.jpg"></li><li>  <b>[22]</b> Padding bit <br>  <i>If it is installed, the data is shifted by 1 byte.</i>  <i>This is important for calculating the frame size.</i> </li><li>  <b>[23]</b> Bit private (for information only) </li><li>  <b>[24-25]</b> Channel mode <br><img src="https://habrastorage.org/storage/ad77558e/54326519/67225647/c6384487.jpg"></li><li>  <b>[26-27]</b> Expanding channel mode.  (Mode extension) Used only with joint stereo </li><li>  <b>[28]</b> Copyright (Copyright bit) - for information only </li><li>  <b>[29]</b> Original (original bit) - for information only. </li><li>  <b>[30-31]</b> Accent (Emphasis) - practically not used at the moment. </li></ul><br><h3>  Compression modes or what is the bit rate </h3><br><br>  There are 3 data compression modes: <br><br>  <b>CBR</b> (constant bitrate) - constant bitrate.  Does not change throughout the track. <br><br>  <b>VBR</b> (variable bitrate) - variable bitrate.  With this compression, the bitrate is constantly changing throughout the track. <br><br>  <b>ABR</b> (average bitrate) - averaged bitrate.  This concept is used only when encoding a file.  At the "output" file is obtained with VBR. <br><br><h4>  CBR </h4><br>  If the file is encoded with a constant bit rate - then we can <s>finally!</s>  get the duration of our track by the following formula: <br><blockquote>  Duration = Audio data size / Bit rate (in bits!) * 8 </blockquote><br>  For example, the file has a size of 350,670 bytes.  There are ID3v1 tags (128 bytes) and ID3v2 tags (1024 bytes).  Bitrate = 96. Therefore, the size of the audio data is 350670 - 128 - 1024 = 349518 bytes. <br>  Duration = 349518/96000 * 8 = 29.1265 = 29 seconds <br><br><h4>  VBR </h4><br>  It is necessary to explain how to determine the compression mode.  It's simple.  If the file is compressed with VBR, then a VBR header is added.  By its presence, we can understand that a variable bitrate is used. <br>  There are two kinds of headers: Xing and VBRI. <br>  Xing is placed with the offset from the beginning of the first mp3-frame in position, according to the table: <br><br><img src="https://habrastorage.org/storage/7374bde5/bc6e896e/0908663b/45765263.jpg"><br><br>  For example: our ID3v2 tag is 1024 bytes.  If our mp3-file has the channel mode ‚ÄúStereo‚Äù - then the VBR Xing header will start with an offset of 1024 + 32 = 1056 bytes. <br><br>  The VBRI header is always placed with an offset of +32 bytes from the beginning of the first mp3 frame. <br><br>  The first four bytes in both headers contain the 'Xing' or 'Info' marker for Xing.  And 'VBRI' for VBRI. <br><br>  These VBR headers are of variable length and contain various information about the encoding of the file.  More information about the structure of VBR headers (and not only) can be read, for example, <a href="http://www.codeproject.com/KB/audio-video/mpegaudioinfo.aspx">here</a> . <br><br>  I will only talk about what interests us at the moment.  Namely - the number of frames (Number of Frames).  This number is 4 bytes long. <br>  In the Xing header, it is contained by offset +8 bytes from the beginning of the header.  In VBRI +14 bytes from the beginning of the header. <br><br>  Using the Sampler Per Frame table we can get the duration of an mp3 file encoded with a variable bit rate. <br><br><img src="https://habrastorage.org/storage/75cfbe49/fc1e8634/be25a67d/c22f7000.jpg"><br><br><blockquote>  Duration = Number of frames * Samples per frame / Sample rate </blockquote><br><br>  For example: from the VBRI header received the number of frames 1118, samples per frame = 1152. The sampling frequency = 44100. <br>  Duration = 1118 * 1152/44100 = 29.204 = 29 seconds. <br><hr><br>  That's all for today.  If someone was useful - <b>thanks</b> . <br><br>  For those who want to immediately dig out the insides of mp3 - <a href="">Here</a> lies the script in php, which I wrote for myself at the same time with this article and four small mp3-files for the test. <br><br><h4>  Links </h4><br>  <a href="http://id3.org/">id3.org - Read about ID3</a> <br>  <a href="http://id3.org/mp3Frame">id3.org - and something about the mp3 frame</a> <br>  <a href="http://www.codeproject.com/KB/audio-video/mpegaudioinfo.aspx">In some detail about the mp3 frame</a> <br>  <a href="http://getid3.sourceforge.net/">getID3: A good library for getting mp3 information.</a>  <a href="http://getid3.sourceforge.net/">(Php)</a> </div><p>Source: <a href="https://habr.com/ru/post/103635/">https://habr.com/ru/post/103635/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../103627/index.html">There is no need to edit anything in the conservatory. Everything will correct itself</a></li>
<li><a href="../103628/index.html">The art of programming under Unix (and not only). Part Five, ‚Äúthe rule of simplicity‚Äù</a></li>
<li><a href="../103631/index.html">Thoughts about IFA: 3D, tablets and other imposed crap</a></li>
<li><a href="../103632/index.html">Alternative view of the page for opera speed dial</a></li>
<li><a href="../103634/index.html">One and a half month with iPad, impressions</a></li>
<li><a href="../103636/index.html">Google SketchUp 8</a></li>
<li><a href="../103638/index.html">Quick search for matching objects by their checksums using the example of searching for duplicate images</a></li>
<li><a href="../103640/index.html">Expanding horizons. SharpDevelop AddIns</a></li>
<li><a href="../103641/index.html">Errors in the laws</a></li>
<li><a href="../103642/index.html">Cosmonaut-blogger denied the title of Hero of Russia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>