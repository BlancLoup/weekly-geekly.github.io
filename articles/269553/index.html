<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A note about collections in C # and structures. Memory issue</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This information will be useful to those who only deal with C #, in practice trying to understand the theory without reading the books to the end. Thi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A note about collections in C # and structures. Memory issue</h1><div class="post__text post__text-html js-mediator-article">  This information will be useful to those who only deal with C #, in practice trying to understand the theory without reading the books to the end.  This is most likely a margin note, rather than a detailed description and analysis of the topic.  So, who cares how structures behave in memory when working with collections in C #, welcome. <br><a name="habracut"></a><br>  Reading Richter in the evenings, I decided to understand every detail in more detail, having a great desire to understand the .Net ideology more deeply.  Scrolling through the pages of the book, I came to the conclusion that a lot of things that are projected and written every day constantly violate some of the foundations of .Net. <br><br>  Consider the example of structures and collections.  I will not remind that structures are value-types and behave differently than reference ones. <br><br>  Example 1. Using the old ArrayList. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cs hljs">System.Int32 myInt = <span class="hljs-number"><span class="hljs-number">7</span></span>; ArrayList al = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList(); al.Add(myInt);</code> </pre> <br>  The expected result will be the presence of two different elements in a stack of type System.Int32.  Moreover, one of them will already be a reference type.  If you open the IL-representation of this code, you will see a fair confirmation: <br><br><pre> IL_0002: stloc.0 // myInt
  IL_0003: newobj System.Collections.ArrayList..ctor
  IL_0008: stloc.1 // al
  IL_0009: ldloc.1 // al
  IL_000A: ldloc.0 // myInt
  IL_000B: box System.Int32
  IL_0010: callvirt System.Collections.ArrayList.Add
</pre><br>  The box (boxing) operation creates an object on an Int32 heap.  When adding an element of the structure type, each time its analog will be created in the heap, and the link will be added to the collection.  In time, generic collections came to help this action.  Consider an example and its IL representation: <br><br>  Example 2. Using generalizations for collections: <br><br><pre> <code class="cs hljs">System.Int32 myInt = <span class="hljs-number"><span class="hljs-number">7</span></span>; List&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; l = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); l.Add(myInt);</code> </pre><br>  This code is converted to: <br><br><pre> IL_0002: stloc.0 // myInt
  IL_0003: newobj System.Collections.Generic.List..ctor
  IL_0008: stloc.1 // l
  IL_0009: ldloc.1 // l
  IL_000A: ldloc.0 // myInt
 IL_000B: callvirt System.Collections.Generic.List.Add
</pre><br>  Such collections are more perfect and can work with value-types more intelligently, without using box \ unbox operations.  This significantly reduces memory costs, increases productivity, and reduces the number of garbage collections. <br><br>  However, experimenting with the collections for some time in more detail, I came across an unexpected moment.  Sometimes there is a need to write something in such a style as: <br><br><pre> IList l = new List &lt;T&gt; ();
</pre><br>  The code is simple, but its result for structures turned out to be ambiguous. <br><br>  If we look at the IL representation of such code: <br><br><pre> System.Int32 myInt = 7;
  IList l = new List &lt;int&gt; ();
  l.Add (myInt);
</pre><br>  Then we get the following: <br><br><pre>  IL_0002: stloc.0 // myInt
  IL_0003: newobj System.Collections.Generic.List..ctor
  IL_0008: stloc.1 // l
  IL_0009: ldloc.1 // l
  IL_000A: ldloc.0 // myInt
  IL_000B: box System.Int32
  IL_0010: callvirt System.Collections.IList.Add
</pre><br>  We again get to the packaging unit.  And again we will get the object in the heap as a copy of our myInt value.  Apparently, the developers implemented the collections in such a way that, in fact, an explicit indication of the type of generalization for a variable affects the further behavior of the collection object, especially for significant types. <br><br>  This was the first conclusion, which tried to explain what was happening.  As a result, an explanation was found a little later from the author himself.  Any interface variable should always be placed on the heap, which made an additional packing operation appear. <br><br>  The conclusion is simple.  Initially, the theory, and then practice, although it usually happens differently. </div><p>Source: <a href="https://habr.com/ru/post/269553/">https://habr.com/ru/post/269553/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../269535/index.html">PC Tuneup feature in Panda antivirus to optimize PC performance</a></li>
<li><a href="../269537/index.html">Manual editing of uboot-elf in the name of DHCP and SSH</a></li>
<li><a href="../269541/index.html">UnityEditor, dynamic content editor component</a></li>
<li><a href="../269543/index.html">Watch the Jump Start online event: Modern Hybrid Solutions at 11:00 on October 27</a></li>
<li><a href="../269551/index.html">October 28, 10:00 (MSK), join the Windows Camp online broadcast // Labs</a></li>
<li><a href="../269555/index.html">Joker 2015 Java Conference Report</a></li>
<li><a href="../269557/index.html">Big kitchen big data. Part 1</a></li>
<li><a href="../269559/index.html">HP Integrity NonStop X - 100% fault tolerance for standard architecture servers</a></li>
<li><a href="../269561/index.html">Low cost VDS hosting in Russia. Is it possible to?</a></li>
<li><a href="../269563/index.html">Vivaldi Beta RC</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>