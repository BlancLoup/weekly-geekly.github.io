<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>5 hacks to reduce overhead in garbage collection</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This post will look at five ways to improve code efficiency, helping the garbage collector spend less time allocating and freeing memory. A long garba...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>5 hacks to reduce overhead in garbage collection</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/cbb/1fe/0ca/cbb1fe0cad86b5214eec38d26bd0438d.png"><br>  This post will look at five ways to improve code efficiency, helping the garbage collector spend less time allocating and freeing memory.  A long garbage collection procedure can lead to a phenomenon known as ‚ÄúStop the world‚Äù. <br><br><h4>  General information </h4><br>  Garbage Collector (GC) exists to handle a large number of memory allocations for short-lived objects (for example, objects selected during the rendering of a web page become obsolete as soon as the page is displayed). <br><br>  GC in this case uses the so-called "young generation" ("young generation") - a segment of the heap, where new objects are located.  Each object has an ‚Äúage‚Äù field (‚Äúage‚Äù, located in the object header), which determines how many garbage collections it has experienced.  As soon as a certain age is reached, the object is copied to another area of ‚Äã‚Äãthe heap, called the ‚Äúold‚Äù generation. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The process is still effective, but already becoming noticeable.  The ability to reduce the amount of memory allocations for temporary objects will help us increase performance, especially in widely scaled environments or in Android applications where resources are more limited. <br><br>  Below are five ways that can be used in everyday development to improve the efficiency of working with memory, while not spending much of our time and do not reduce the readability of the code. <a name="habracut"></a><br><br><h4>  1. Avoid implicit use of strings. </h4><br>  Strings are an integral part of almost any data structure.  More demanding than other primitive types, they have a greater effect on memory consumption. <br><br>  Do not forget that the lines are immutable.  They are not modified after allocation.  Operators such as "+" when concatenating strings actually create a new String object containing string concatenation.  In addition, this leads to the implicit creation of a StringBuilder object, which performs the merge operation itself. <br><br>  Let's give an example: <br><pre><code class="java hljs">a = a + b; <span class="hljs-comment"><span class="hljs-comment">// a  b - </span></span></code> </pre> <br>  But the actual code generated by the compiler behind the scenes: <br><pre> <code class="java hljs">StringBuilder temp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(a). temp.append(b); a = temp.toString(); <span class="hljs-comment"><span class="hljs-comment">//    . //  ‚Äúa‚Äù   .</span></span></code> </pre><br>  The reality is <i>still worse</i> . <br>  Consider the following example: <br><pre> <code class="java hljs">String result = foo() + arg; result += boo(); System.out.println(‚Äúresult = ‚Äú + result);</code> </pre><br>  Here we have 3 StringBuilders allocated implicitly - one for each "+" operation and two additional strings - one, as a result of the second assignment, the other is passed to the println method.  As a result, we received 5 additional objects in the trivial code. <br><br>  Think about what happens in real programs, like generating a web page, working with XML, or reading text from a file.  Such code inside the loop will result in hundreds or thousands of implicitly allocated objects.  VM has mechanisms to deal with this, but everything has a price - and your users will pay it. <br><br>  <b>Solution:</b> one of the ways can be explicitly creating a StringBuilder.  In the example below, the same result is achieved, but the memory is allocated only for one StringBuilder and one string for the final result. <br><pre> <code class="java hljs">StringBuilder value = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(‚Äúresult = ‚Äú); value.append(foo()).append(arg).append(boo()); System.out.println(value);</code> </pre><br>  Keeping in mind that in such cases strings and StringBuilders are implicitly distinguished, you can significantly reduce the number of small memory allocations in frequently executed code. <br><br><h4>  2. Set the initial capacity of the lists. </h4><br>  Dynamically expandable collections, such as an ArrayList, are some of the basic structures designed to hold variable-length data.  ArrayList and other collections, for example, HashMap, TreeMap are implemented using the underlying Object [] array.  Just like strings (which are add-ons over arrays of characters), the size of the array is unchanged.  The obvious question is how do you add elements to the collection, with the immutable size of the underlying array?  The answer is no less obvious - the allocation <i>of</i> most of the arrays. <br><br>  Consider the following example: <br><pre> <code class="java hljs">List&lt;Item&gt; items = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;Item&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) { Item item = readNextItem(); items.add(item); }</code> </pre><br>  The value of the variable len defines the maximum number of elements processed before the end of the loop.  Nevertheless, this value is unknown to the ArrayList constructor, which is forced to allocate an array with the default size.  Whenever the capacity of the internal array becomes exceeded, it is replaced with a new one of sufficient length, as a result of which the previous one turns into garbage. <br><br>  If the cycle is executed a thousand times, it can lead to multiple allocation of new arrays and assembly of old ones.  For a program running in a highly scalable environment, these (de) allocations are uselessly subtracted from the processor cycles. <br><br>  <b>Solution:</b> specify the initial capacity wherever possible: <br><pre> <code class="java hljs">List&lt;MyObject&gt; items = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;MyObject&gt;(len);</code> </pre><br>  This ensures the absence of excessive memory allocation of internal arrays that occur during execution.  If the exact size is not known, then it is worth to indicate approximately or the expected average value, adding a couple of percent on top in case of an unexpected overflow. <br><br><h4>  3. Use efficient collections of primitive types. </h4><br>  Current versions of Java compilers support ordinary and associative arrays with keys and primitive type values ‚Äã‚Äãby using ‚Äúautoboxing‚Äù - wrapping a primitive value with a standard object that can be selected and deleted by the GC. <br><br>  This may have some <i>negative consequences</i> .  In Java, most of the collections are implemented using internal arrays.  Each key-value pair added to a HashMap causes a selection of an internal object to hold both values.  This inevitable evil accompanies the use of associative arrays - every time an element is added to the map, this results in the allocation of a new object and, possibly, an assembly of the old one.  There are also costs associated with excess capacity, i.e.  re-allocation of resources for a new internal array.  When we deal with a large associative array, with thousands or even more objects, these internal allocations can significantly affect the GC. <br><br>  A common case is to preserve any mapping between primitive types (for example, an identifier) ‚Äã‚Äãand an object.  Since HashMap is intended for storing object types, this means that each insert implies the creation of another object to ‚Äúpackage‚Äù values ‚Äã‚Äãof a primitive type. <br><br>  The standard Integer.valueOf () method caches values ‚Äã‚Äãbetween -128 and 127, but any number outside this range will result in a separate object for each key-value pair.  This results in a <i>triple</i> GC overhead in each associative array.  For those who come from C ++, this can be news - thanks to the patterns in STL, this problem is solved quite effectively. <br><br>  Fortunately, they are working on this in new versions of Java.  In the meantime, try to somehow improve efficiency with the help of wonderful third-party libraries that provide trees of primitive types, associative arrays and lists.  I highly recommend <a href="http://trove.starlight-systems.com/">Trove</a> , which I worked with for quite some time and I can confirm the real reduction in overhead costs for garbage collection in the critical code. <br><br><h4>  4. Use Streaming instead of buffers in memory. </h4><br>  Most of the data we use in server applications come to us as files or data streams from network connections or databases.  In most cases, the incoming data comes in serialized form and requires deserialization into objects before performing operations on them.  This stage is subject to implicit memory consumption, often in considerable amounts. <br><br>  Usually, data is read into memory using ByteArrayInputStream, ByteBuffe, then the result is transferred to deserialization. <br><br>  This can be a bad approach, because  you must first allocate, and then free up space for the data, but only after the completion of the construction of objects from them.  But as a rule, the size of the data is not known, which will lead, you guessed it, to a permanent re-allocation of memory for byte [] arrays, which will grow when the buffer capacity is exceeded. <br><br>  <b>The solution is</b> extremely simple.  Many libraries, such as the native Java serializer, Protocol Buffers, etc.  able to build deserialized objects using data directly from the network stream, i.e.  do not require data storage in memory and internal arrays.  If possible, use this approach - GC will say thank you. <br><br><h4>  5. Immunity is not always good </h4><br>  Immunity is an excellent thing, but in the case of high-performance computing it can be a serious disadvantage.  Consider a transfer scenario between methods of a list object. <br><br>  In the case of returning a collection from a function, it is usually recommended to create a collection object (for example, ArrayList) inside the method, fill it in and return it in the form of an immutable Collection interface. <br>  But in some cases <i>this is unacceptable</i> .  For example, in the case where collections returned from methods are collected in the final collection.  Although immunity provides transparency, in a high-load service situation, this can mean massive memory allocation for intermediate collections. <br><br>  <b>The solution</b> in this case is to avoid returning new collections from the methods; instead, pass the object of the resulting collection as a parameter to the method. <br><br>  Example 1. (Ineffective) <br><pre> <code class="java hljs">List&lt;Item&gt; items = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;Item&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (FileData fileData : fileDatas) { <span class="hljs-comment"><span class="hljs-comment">//       // , , -   items.addAll(readFileItem(fileData)); }</span></span></code> </pre><br>  Example 2 <br><pre> <code class="java hljs">List&lt;Item&gt; items = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;Item&gt;( fileDatas.size() * avgFileDataSize * <span class="hljs-number"><span class="hljs-number">1.5</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (FileData fileData : fileDatas) { readFileItem(fileData, items); <span class="hljs-comment"><span class="hljs-comment">//    }</span></span></code> </pre><br>  Example 2 neglects the immunity rules (which in typical situations is recommended to be observed), but we were able to avoid a lot of side allocations, which in the case of intensive calculations would have a very positive effect on GC. <br><br><h4>  What else to read? </h4><br>  1) <a href="http://plumbr.eu/blog/reducing-memory-usage-with-string-intern">About string interning</a> <br><br>  2) <a href="http://vanillajava.blogspot.co.il/2013/04/low-gc-coding-efficient-listeners.html">Pro effective wrappers</a> <br><br>  3) <a href="http://java-performance.info/primitive-types-collections-trove-library/">Trove Pro</a> <br><br>  4) <a href="http://habrahabr.ru/post/187234/">Pro Trove on Habr√©</a> </div><p>Source: <a href="https://habr.com/ru/post/187602/">https://habr.com/ru/post/187602/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../187586/index.html">Public development "More than a reader": functional design</a></li>
<li><a href="../187590/index.html">HTML5 and drag & drop multiple objects</a></li>
<li><a href="../187594/index.html">Creating a native extension library for OpenFL, part three</a></li>
<li><a href="../187596/index.html">Lambda expressions are backported to Java 7, 6 and 5</a></li>
<li><a href="../187600/index.html">Regex Tester extension now supports Visual Studio 2012</a></li>
<li><a href="../187604/index.html">Work with color: useful tools, books, articles for web designers</a></li>
<li><a href="../187608/index.html">First benchmarks of free x265 codec</a></li>
<li><a href="../187610/index.html">Chinese boy assembled a prototype of a combat robot from an old Nissan</a></li>
<li><a href="../187612/index.html">Hackers gained access to the OVH.com database</a></li>
<li><a href="../187616/index.html">AVG Antivirus Update blocks network (Internet)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>