<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing ORM for Delphi</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 
 Today I will tell you about my experience of writing ORM for Delphi using RTTI influenced by the practices of working with Doctrine and Java ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing ORM for Delphi</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br>  Today I will tell you about my experience of writing ORM for Delphi using RTTI influenced by the practices of working with <a href="http://www.doctrine-project.org/">Doctrine</a> and Java EE. <br><br><h2>  What for? </h2><br>  The old project on Delphi7 has recently come under my power, in which the active work with the database under Interbase 2009 is underway. The code in this project was pleasing, but exactly until the discussion turned to the interaction with the database itself.  Sampling data, updating, adding new records, deleting - all this took quite a few lines in the logic of the application, which made it sometimes difficult to understand the code (salvation in a bona fide developer who answered my stupid questions around the clock).  The project was transferred to my hands in order to eliminate old misfortunes and add a new module to it, the task of which is to cover the new database tables. <br><br>  I like the MVC approach and really wanted to share the logic code with the model code.  And even if it‚Äôs for cleanliness, I didn‚Äôt want to rewrite all get / set methods for each new table with a new one.  A couple of years ago I became acquainted with the concept of ORM and I liked it.  I liked the principle and I was delighted to apply it in my work. <br>  At the same time I rushed to look in Delphi7 at least something similar to Doctrine, or maybe the generators of the Entity / Facade classes for tables ... Neither one nor the other.  But in the search results there were several ready-made solutions.  For example <a href="https://code.google.com/p/delphi-orm/">DORM</a> .  In general, a great thing and, in fact, what you need! <br><a name="habracut"></a><br>  But, I don‚Äôt know if it happens to you, I refused the ready-made solution, since I need very limited functionality, and I don‚Äôt need to drag all the contents of DORM or tiOPF.  With the knowledge of what I want, with the understanding of all the flaws, I began this slippery slope and, it seems, came to ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Reflections </h2><br>  The absence of at least some similarity on the ORM is a headache.  What I am talking about is that in Java out of the box it is possible to create a set of entity classes and facades to work with the created entities using a ready-made database.  The purpose of these classes is to provide the developer with a ready-made tool for interacting with some database, clearing the main application logic code from the query texts and parsing the results of their execution.  These same things are used in all popular PHP frameworks, in Qt (if memory serves me) in one form or another. <br><br>  What was the difficulty in implementing a high-quality library for object mapping and including it in the IDE?  The task is to connect to the database, ask the user what tables he needs in the application, read the table fields and the relationships between them (on foreign keys), clarify whether all the links were correctly understood and generate classes from the collected data.  By generation, I mean the creation of classes of entities whose task is to be the repository of a single record from some table.  Knowing the name of the table, you can find out all its fields, field types and use this information to announce the necessary information, generate the published section, add the necessary setters and getters ... In general, the task is time-consuming, but realizable. <br>  After the generation of entity classes, IDE could start generating facade classes (or, as I call them, Adapters).  An adapter is an interlayer between a programmer and a database and its main task is to be able to receive an entity corresponding to a certain key, save changes to it, delete it.  In general, the essence of the Adapter is to provide the developer with methods for working with the database, the results of which will be represented as objects of their corresponding entities. <br><br>  I didn‚Äôt like this aspect of Delphi development.  My experience with him is already relatively large, I see many advantages in this difficult task, but the more I learn about new languages ‚Äã‚Äãand environments, I feel that Delphi is a suitable tool, but does not reach the required level, when it‚Äôs difficult dreary routine I do not have to spend so much time. <br><br>  I am ready to pass on the generation of entities on the shoulders of heroes.  Perhaps someone will even be able to inject this into the IDE itself as Castalia.  But I do not see any point in writing separately for each entity the methods of sampling, updating, deleting.  I do not want.  I want a class to which I will pass the name of the entity, which will call the findAll method and get all the records from the desired table.  Or write find (5) and get a record with the numeric key 5. <br><br><h2>  Process </h2><br>  We develop the TUAdapter class. <br>  What the Adapter should be able to do as a result: <br><ol><li>  Creates an object by class name </li><li>  Able to receive class fields </li><li>  Can get field value by field name </li><li>  Able to sample all data </li><li>  Able to get the entity by key </li><li>  Is able to update the data of the entity in the database </li><li>  Able to remove the entity from the database </li><li>  Able to add a new entity from the database. </li></ol><br>  My limitations: <br><ol><li>  No PDO - development for a single database - Interbase </li><li>  Delphi7 is still the old version of RTTI.  (in Rad 2010 RTTI has been greatly improved).  Only published fields can be obtained. </li><li>  Relationships and retrieval of entities by connections (for some internal reasons) will not be implemented. </li></ol><br><br><h4>  0. Abstract class TUEntity is the parent of all Entity </h4>  Must be inherited from TPersistent, otherwise we will not be able to fully apply RTTI.  In it we regulate the interface of entities.  In the course of its work, the Adapter will ask the entity the name of the table that it corresponds to, provide the name of the key field that will be searched, the value of this field, as well as the method for string representation of the entity (for Logs, for example). <br><div class="spoiler">  <b class="spoiler_title">Code.</b>  <b class="spoiler_title">Tuentity</b> <div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TUEntity</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> (TPersistent) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span>integer; <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getKeyName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> :</span></span> AnsiString; <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> AnsiString; <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTableName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> AnsiString; <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getKeyGenerator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span>AnsiString; <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br></div></div><br><h4>  1. Creating an object by its name </h4>  It has already been stated above that entities are inherited from the TPersistent class, but in order for an entity to be created by name, care must be taken to register the class of all necessary entities.  I do this in the constructor TUAdapter.Create () in the first line. <br><div class="spoiler">  <b class="spoiler_title">Code.</b>  <b class="spoiler_title">TUAdapter.Create</b> <div class="spoiler_text"><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TUAdapter</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(db : TDBase; entityName : AnsiString)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> RegisterClasses([TUObject, TUGroup, TUSource, TUFile]); self.db := db; self.entityName := <span class="hljs-string"><span class="hljs-string">'TU'</span></span> + entityName; uEntityObj := CreateEntity(); self.tblName := uEntityObj.getTableName; self.fieldsSql := getFields(); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br></div></div><br>  The very same method of creation looks like this.  Why am I not passing the name of an entity as an argument?  Because it is in the context of my task, I do not see the point of doing this, because in the course of the work objects are additionally created, and the name of the entity always remains the same - transferred when the Adapter is created <br><div class="spoiler">  <b class="spoiler_title">Code.</b>  <b class="spoiler_title">Creating an entity by its name</b> <div class="spoiler_text"><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TUAdapter</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateEntity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> TUEntity; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> result := TUEntity(GetClass(self.entityName).Create); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br></div></div><br><h4>  2. Getting class fields </h4>  I think this is a question that developers rarely ask for Delphi.  The main ‚Äúfeature‚Äù is that we cannot get all the fields as we would like, but only the property fields from the published section.  In fact, this is very good, because the properties in our task are very convenient to use. <br><div class="spoiler">  <b class="spoiler_title">Code.</b>  <b class="spoiler_title">Getting class fields</b> <div class="spoiler_text"><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TUAdapter</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProps</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">var</span></span></span></span><span class="hljs-function"><span class="hljs-params"> list: TStringList)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> props : PPropList; i: integer; propCount : integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (uEntityObj.ClassInfo = <span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> Exception.Create(<span class="hljs-string"><span class="hljs-string">'Not able to get properties!'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> propCount := GetPropList(uEntityObj.ClassInfo, props); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i:=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> propCount-<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> list.Add(props[i].<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> FreeMem(props); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br></div></div><br><h4>  3. Getting the value of the field object by the field name </h4>  To do this, you can use the GetPropValue method.  I‚Äôll dwell on the PreferStrings parameter - it influences how the result of fields like tkEnumeration and tkSet will be returned.  If it is set to True, then enum will return from tkEnumeration, and SetProp will return from tkSet. <br><pre> <code class="delphi hljs">(Instance: TObject; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PropName: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; PreferStrings: Boolean): Variant;.</code> </pre><div class="spoiler">  <b class="spoiler_title">Code.</b>  <b class="spoiler_title">Use GetPropValue</b> <div class="spoiler_text"><pre> <code class="delphi hljs">VarToStr(GetPropValue(uEntityObj, props.Strings[i], propName, true)</code> </pre><br></div></div><br><h4>  4,5,6 ... Working with the database </h4>  I think giving the whole code is a bad form (and its place at the end of the article).  And here I will only give a part, on the example of forming a request to select all data. <br>  To fetch the data, a read transaction is formed, a request is created.  We connect the query and the transaction, after which we run them and get all the values ‚Äã‚Äãin TIbSQL.  Using TIbSQL.EoF and TIbSQL, Next you can loop through all the records, which we are doing - by creating a new entity in turn, we put it into an array and fill its fields. <br><div class="spoiler">  <b class="spoiler_title">Code.</b>  <b class="spoiler_title">TUAdapter.FindAll Method</b> <div class="spoiler_text"><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TUAdapter</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> TEntityArray; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rTr : TIBTransaction; rSQL : TIbSQL; props: TStringList; i, k: integer; rowsCount : integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> db.CreateReadTransaction(rTr); rSql := TIbSQL.Create(<span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>); props := TStringList.Create(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> rSql.Transaction := rTr; rSQL.SQL.Add(<span class="hljs-string"><span class="hljs-string">'SELECT '</span></span> + fieldsSql + <span class="hljs-string"><span class="hljs-string">' FROM '</span></span>+ tblName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> rSql.Transaction.Active <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> rSQL.Transaction.StartTransaction; rSQL.Prepare; rSQl.ExecQuery; rowsCount := getRowsCount(); SetLength(result, rowsCount); getProps(props); i := <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> rSQl.Eof <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> result[i] := CreateEntity(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k:=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> props.Count-<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> VarIsNull(rSql.FieldByName(props.Strings[k]).AsVariant)) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> SetPropValue(result[i], props.Strings[k], rSql.FieldByName(props.Strings[k]).AsVariant); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; inc(i); rSql.Next; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> props.Destroy; rTr.Destroy; rSQL.Destroy; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br></div></div><br>  In other matters, I will not forget to mention a few difficulties.  First, the encoding.  If your database is created with WIN1251 encoding and Collation is installed win1251 and you will have to work with this DB from Delphi - you cannot simply take and add an entry with Cyrillic characters.  In this case, read the information on the link <a href="http://www.ibase.ru/devinfo/ibrusfaq.htm">IBase.ru Rus FAQ</a> .  Then they will teach you and poke your finger in all the pitfalls. <br><br>  My read aggregation looks like the following sequence of actions: <br><ol><li>  Run bdeAdmin.exe from the Borland Shared \ BDE \ folder </li><li>  In Configuration -&gt; System -&gt; Init, select the default Paradox driver and Langdriver = Pdox Ansi Cyrrilic </li><li>  In Configuration -&gt; Drivers -&gt; Native, put Langdriver = Pdox Ansi Cyrrilic in the drivers: Microsfot Paradox Driver, Data Direct ODBC to Interbase, Microsoft dBase Driver. </li><li>  Save the changes, staying on the changed items in the Object main menu by pressing Apply. </li></ol><br>  Such a sequence of actions helps to have no problems when querying for Update or Insert.  (and at Select there are no problems with Cyrillic). <br>  In some cases, it also helps instead of: <br> <code>UPDATE tablename SET field = '';</code> <br>  write: <br> <code>UPDATE tablename SET field = _win1251'';</code> <br>  But this will not work if you use a query with parameters, since TIbSQL is not familiar with the _win1251 function. <br>  For example, such a code will not work and will trigger an exception. <br><pre> <code class="delphi hljs">IbSQL.SQL.Add("UPDATE tablename <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> field = _win1251 :field"); IbSQL.Prepare(); <span class="hljs-comment"><span class="hljs-comment">// &lt;- Exception IbSQL.Params.byName('field').asString := '';</span></span></code> </pre><br>  In other matters, after you have done the above 4 steps - you do not need to use _win1251 and you are free to make a request.  Without realizing it, I chose a complex path and decided to independently form a request.  I did not take into account that the parameterization would take on some of the burden of filtering the transmitted parameters.  Do not understand what I mean? <br><br>  I encountered a problem when there is a quotation mark or a line break in the text field value.  And I had to write a method to replace these characters with valid ones: <br><div class="spoiler">  <b class="spoiler_title">Code.</b>  <b class="spoiler_title">TUAdapter.Escape ()</b> <div class="spoiler_text"><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TUAdapter</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StringReplaceExt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> S : </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; OldPattern, NewPattern: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">array</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">of</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; Flags: TReplaceFlags)</span></span></span><span class="hljs-function">:</span></span><span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i : integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Assert(Length(OldPattern)=(Length(NewPattern))); Result:=S; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i:= Low(OldPattern) <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> High(OldPattern) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> Result:=StringReplace(Result,OldPattern[i], NewPattern[i], Flags); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TUAdapter</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">escape</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> unescaped_string : </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span><span class="hljs-function"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result:=StringReplaceExt(unescaped_string, [ <span class="hljs-string"><span class="hljs-string">#39</span></span>, <span class="hljs-string"><span class="hljs-string">#34</span></span>, <span class="hljs-string"><span class="hljs-string">#0</span></span>, <span class="hljs-string"><span class="hljs-string">#10</span></span>, <span class="hljs-string"><span class="hljs-string">#13</span></span>, <span class="hljs-string"><span class="hljs-string">#26</span></span>], [<span class="hljs-string"><span class="hljs-string">'`'</span></span>,<span class="hljs-string"><span class="hljs-string">'`'</span></span>,<span class="hljs-string"><span class="hljs-string">'\0'</span></span>,<span class="hljs-string"><span class="hljs-string">'\n'</span></span>,<span class="hljs-string"><span class="hljs-string">'\r'</span></span>,<span class="hljs-string"><span class="hljs-string">'\Z'</span></span>] , [rfReplaceAll] ); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br></div></div><br><h2>  results </h2><br>  In general, we have developed requirements for the Enitity classes: <br><ol><li>  describe private fields </li><li>  describe the fields corresponding to the columns of the table as a property in the published section </li><li>  property names must match the corresponding column names </li><li>  if necessary, implement Get / Set methods for fields (for Boolean, TDateTime, for Blob fields) </li></ol><br>  So, let's say we have the following DB <br><img src="http://habrastorage.org/storage2/a5d/46b/1b3/a5d46b1b30b5878f981a91b2306c7caa.png"><br>  Create two Entity classes TUser and TPost. <br><div class="spoiler">  <b class="spoiler_title">Code.</b>  <b class="spoiler_title">TUser advertisement</b> <div class="spoiler_text"><pre> <code class="delphi hljs">TUsersArray = <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> TUser; <span class="hljs-title"><span class="hljs-title">TUser</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TUEntity) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> f_id: longint; f_name : longint; f_password : AnsiString; f_email : AnsiString; f_last_login : TDateTime; f_rate: integer; <span class="hljs-keyword"><span class="hljs-keyword">published</span></span> <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> id: integer <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> f_id <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> f_id; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> : AnsiString <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> f_name <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> f_name ; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> password : AnsiString <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> f_password <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> f_password ; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> email : AnsiString <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> f_email <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> f_email ; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> last_login: AnsiString <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> getLastLogin <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> setLastLogin; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> rate: integer <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> f_rate <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> f_rate; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setParams</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id, rate: longint; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">name</span></span></span></span><span class="hljs-function"><span class="hljs-params">, password, email: AnsiString)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setLastLogin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(datetime: AnsiString)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLastLogin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> AnsiString; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> integer; <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getKeyName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> AnsiString; <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> AnsiString; <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTableName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> AnsiString; <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getKeyGenerator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span>AnsiString; <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br>  TPost is announced in the same way. <br></div></div><br>  And the use in the code paired with the adapter will look like this: <br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Adapter : TUAdapter; users: TUsersArray; i: integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Adapter := TUAdapter.Create(db, <span class="hljs-string"><span class="hljs-string">'User'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> users:= TUsersArray(Adapter.FindAll()); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i:=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Length(users) -<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Grid.Cells[<span class="hljs-number"><span class="hljs-number">0</span></span>, i+<span class="hljs-number"><span class="hljs-number">1</span></span>] := VarToStr(users[i].id); Grid.Cells[<span class="hljs-number"><span class="hljs-number">1</span></span>, i+<span class="hljs-number"><span class="hljs-number">1</span></span>] := VarToStr(users[i].<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>); Grid.Cells[<span class="hljs-number"><span class="hljs-number">2</span></span>, i+<span class="hljs-number"><span class="hljs-number">1</span></span>] := VarToStr(users[i].email); Grid.Cells[<span class="hljs-number"><span class="hljs-number">3</span></span>, i+<span class="hljs-number"><span class="hljs-number">1</span></span>] := VarToStr(users[i].password); SetRateStars(i, VarToStr(users[i].rate)); Grid.Cells[<span class="hljs-number"><span class="hljs-number">5</span></span>, i+<span class="hljs-number"><span class="hljs-number">1</span></span>] := VarToStr(users[i].last_login); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> Adapter.Destroy; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><br><h4>  findings </h4><br>  I would like to focus on code performance using RTTI.  Experience suggests that frequent access to RTTI methods will slow down the application, but in my reality the speed of the developed class is enough.  I believe that the goal has been achieved and as a result we have got some semblance of an ORM with a small functionality, but honestly solving the tasks assigned to it. <br><br>  Project on <a href="https://artem_erofeev%40bitbucket.org/artem_erofeev/delphi-orm-adapter">BitBucket</a> . <br><br>  PS <br>  Let me remind you that the reader who has a predisposition to the eruption of negative thoughts in the direction of Delphi is not obliged to tell everyone about it.  So guys, keep yourself in hand. <br>  Sorry, I actually call MessageBox on an error, instead of throwing an Exception.  But I will correct, I promise. <br><br>  UPD: <br>  No more MessageBox in code. </div><p>Source: <a href="https://habr.com/ru/post/184732/">https://habr.com/ru/post/184732/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../184722/index.html">Three useful monads</a></li>
<li><a href="../184724/index.html">Ragdoll physics do-it-yourself. Part one</a></li>
<li><a href="../184726/index.html">The game on JavaScript "Corners"</a></li>
<li><a href="../184728/index.html">Digital Smoothing</a></li>
<li><a href="../184730/index.html">Introduction to Lightweight modular staging and Scala virtualized</a></li>
<li><a href="../184734/index.html">The site Boeing the opportunity to track the position of the aircraft is almost like in the simulator</a></li>
<li><a href="../184736/index.html">Digg Reader "Almost Ready"</a></li>
<li><a href="../184738/index.html">Work with cURL on android</a></li>
<li><a href="../184740/index.html">Lenses, Drones, Steadicam: Expanding Your Nokia Lumia</a></li>
<li><a href="../184742/index.html">Let's play RAR quest?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>