<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sharing shared assemblies between processes and domains in IIS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the microservice world, adding new functionality is done by writing a new service. At the same time, the cost of adding a new unit is at least 150 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sharing shared assemblies between processes and domains in IIS</h1><div class="post__text post__text-html js-mediator-article"><p>  In the microservice world, adding new functionality is done by writing a new service.  At the same time, the cost of adding a new unit is at least 150 MB of RAM, although our code in it is rather small and, as a rule, the same assemblies are used with slight differences in versions. </p><br><p>  This article will show how to optimize solely due to server settings, so rewriting and recompiling applications is not required.  The result will be 25 MB on average for one microservice. </p><a name="habracut"></a><br><h3 id="2-struktura-pamyati-processa">  2. The structure of the memory process </h3><br><p>  As a first step, you should determine what the process memory is occupied with, and whether this optimization is significant in a particular case.  To analyze the structure of the memory, we need one application from Sysinternals - <strong>VMMap</strong> . </p><br><p>  <strong>Let's</strong> open <strong>VMMap</strong> and consider the structure of a specific w3wp process where our site is hosted.  At the top of the application, we see 3 horizontal charts: <br>  Committed - memory ‚Äúavailable‚Äù for the process. <br>  Private Bytes - virtual memory <br>  Working Set - physical memory (RAM) </p><br><p> <a href=""><img src="https://habrastorage.org/webt/g-/xg/48/g-xg48w7gygk0_5-xytc6ryy0ki.png"></a> </p><br><p>  The colors in the diagrams denote different types of memory; we will cite only some of them, which make up the top 4 for the Working Set: </p><br><p>  Image - executable files, such as .exe or .dll, that can be loaded into the image loader process <br>  Managed Heap - memory allocated by .NET runtime, usually containing application data <br>  Page Table is a memory area responsible for mapping virtual addresses to physical ones. <br>  Heap - memory allocated with C or C ++ runtime, usually containing application data </p><br><p>  For each type of memory, you can get detailed information about how and where it is allocated: </p><br><p>  Total WS - amount of physical memory <br>  Private WS - the amount of physical memory that cannot be shared with other processes. <br>  Sharable WS - the amount of physical memory that can be used in conjunction with other processes <br>  Shared WS is the amount of physical memory currently used in conjunction with other processes. </p><br><p>  For a detailed description of the VMMap application, see the links [1], [2].  But back to our w3wp process and consider the top 3 by memory type: </p><br><p>  73 of 220 MB goes to Image <br>  60 out of 220 mb to Heap <br>  58 of 220 MB to Managed Heap </p><br><p>  It should be further noted that the memory allocated JIT is included in the Managed Heap.  It can be calculated as the size of the Managed Head minus the size of the GC. </p><br><h3 id="21-nachalnye-usloviya">  2.1 Initial conditions </h3><br><p>  We have an Amazon t2.large instance with 8 Gb of RAM, 2 Intel Xeon ES-2676 v3 2.40GHz cores and Windows Server 2012 R2 as an OS.  Inside 47 micro services running IIS. </p><br><p>  Each microservice has a controller with a method that returns the version of the assembly (see the example below).  That is what we will call to ‚Äúwarm up‚Äù sites. </p><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">VersionController</span></span> : <span class="hljs-title"><span class="hljs-title">ApiController</span></span> { [Route(<span class="hljs-string"><span class="hljs-string">"version"</span></span>)] [HttpGet] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IHttpActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Version</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Ok(Assembly.GetExecutingAssembly().GetName().Version); } }</code> </pre> <br><p>  Now we will consistently launch and ‚Äúwarm up‚Äù our sites to see the big picture.  To automate this process, here‚Äôs a script on PowerShell (link to github). <br>  As a result, 47 sites were launched in 6 minutes 43 seconds and occupied all the RAM of the server.  The average size of one microservice was 7 GB / 47 = 152 MB (1 GB per OS). </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ta/rs/sx/tarssxbyzzbjuby_wxx_tvm3r80.png"></a> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/uw/yq/-q/uwyq-q69g9l7vwh7kflewhxkyju.png"></a> </p><br><h3 id="3-sharing-sborok-mezhdu-domenami-v-odnom-prilozhenii-ponyatie-domen-neytralnoy-sborki-domain-neutral-assembly">  3. Sharing inter-domain assemblies in a single application, the concept of a domain neutral assembly </h3><br><p>  Now consider the w3wp process through the prism of a <strong>ProcessExplorer</strong> .  Going to the tab. NET Assemblies, we will see 3 so-called.  <em>application domains: sharedDomain, defaultDomain and siteDomain</em> (/ LM / W3SVC / 3 /).  The latter is true, however, only when we create our own application pool for each site. <br> <a href=""><img src="https://habrastorage.org/webt/oc/pt/_o/ocpt_oiavxslv9uaydxfjtgqw7i.png"></a> </p><br><p>  What changes will follow if we combine several sites into one <em>application pool</em> ?  N <em>appDomains</em> with the names / LM / W3SVC / 3 / ... will be added - <em>siteDomain</em> , where N is the number of added sites. </p><br><p>  Now let's note that some of the assemblies are in <em>sharedDomain</em> , and some of the assemblies in <em>appDomains</em> .  In this case, the assemblies that are located in <em>sharedDomain</em> are present in the application in a single instance, and the assemblies that are located <em>siteDomains</em> will be loaded independently for each domain. </p><br><p>  It should be noted that the assemblies located in the <em>sharedDomain</em> have the DomainNeutral flag and the path that points either to the GAC (Global Assembly Cache) or to the cache of native images (native images). </p><br><p>  MSDN [3] gives the following definition of ‚ÄúDomain Neutral Assembly‚Äù: </p><br><ul><li>  assembly that exists in a single instance and is shared between appDomains within the same process </li><li>  an assembly that Jitted once and shares with another appDomain common data structures: MethodTables, MethodDescs </li><li>  an assembly can be Domain Neutral if it and all its dependencies are placed in the GAC (only signed assemblies can be placed in the GAC) </li></ul><br><p>  In the book ‚ÄúPro .NET Performance: Optimize Your C #‚Äú [4], it is recommended to place signed assemblies (strong name assemblies) in the GAC, otherwise loading the assembly will require its full reading to confirm its digital signature. <br>  The latter also facilitates the creation of native images for all applications that reference this assembly. </p><br><p>  Therefore, to facilitate the size of the application, we will need to place the signed assemblies in the GAC and group the sites in applicationPools by their load profile. </p><br><p>  To solve the first problem, there is a console application <strong>aspnet_intern.exe</strong> , supplied with the Windows SDK. <br>  The application analyzes the used assemblies and then copies them to the specified directory, while replacing the source file with a symbolic link, which saves disk space and speeds up the launch of the w3wp process [5]. </p><br><p>  Example: <br>  open the command prompt in administrator mode and go to the Windows SDK directory </p><br><pre> <code class="hljs tex">cd C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Program</span></span></span></span> Files (x86)<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span> SDKs<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">v</span></span></span></span>10.0A<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bin</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NETFX</span></span></span></span> 4.6 Tools<span class="hljs-tag"><span class="hljs-tag">\</span></span></code> </pre> <br><p>  for help on all possible options run </p><br><pre> <code class="hljs">aspnet_intern.exe /?</code> </pre> <br><p>  To get a list of all the assemblies without actually interning them, let's execute </p><br><pre> <code class="hljs tex">aspnet_intern -mode analyze -sourcedir "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span>.NET<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Framework</span></span></span></span>64<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">v</span></span></span></span>4.0.30319<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Temporary</span></span></span></span> ASP.NET Files" &gt; C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">internReport</span></span></span></span>.txt</code> </pre> <br><p>  * for a 32-bit application, use the path: C: \ Windows \ Microsoft.NET \ Framework \ v4.0.30319 \ Temporary ASP.NET Files <br>  directly for interning the assemblies to the C: \ ASPNETCommonAssemblies directory, execute the following command </p><br><pre> <code class="hljs tex">aspnet_intern -mode exec -sourcedir "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span>.NET<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Framework</span></span></span></span>64<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">v</span></span></span></span>4.0.30319<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Temporary</span></span></span></span> ASP.NET Files" -interndir C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ASPNETCommonAssemblies</span></span></span></span></code> </pre> <br><p>  PowerShell Example </p><br><pre> <code class="hljs tex"><span class="hljs-formula"><span class="hljs-formula">$intern_path = 'C:</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Program</span></span></span></span></span><span class="hljs-formula"> Files (x86)</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span></span><span class="hljs-formula"> SDKs</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">v</span></span></span></span></span><span class="hljs-formula">10.0A</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">bin</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">NETFX</span></span></span></span></span><span class="hljs-formula"> 4.6 Tools</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">aspnet</span></span></span></span></span><span class="hljs-formula">_intern.exe' $</span></span>intern_param = '-mode', 'exec', '-sourcedir', 'C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span>.NET<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Framework</span></span></span></span>64<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">v</span></span></span></span>4.0.30319<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Temporary</span></span></span></span> ASP.NET Files', '-interndir', 'C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ASPNETCommonAssemblies</span></span></span></span>' &amp; <span class="hljs-formula"><span class="hljs-formula">$intern_path $</span></span>intern_param</code> </pre> <br><p>  To upload the assemblies to the GAC, we will need to again refer to the Windows SDK, but already for the <strong>gacutil.exe</strong> application.  After internment, we received a directory containing signed and unsigned assemblies. <br>  Since it is possible to install into GAC only those that are signed, we will need to write a small Powershell script to install them: </p><br><pre> <code class="hljs smalltalk"><span class="hljs-string"><span class="hljs-string">$a</span></span>sm_path = <span class="hljs-string"><span class="hljs-string">'C:\git\IISSharingAssemblies\common-assemblies-legacy'</span></span> <span class="hljs-string"><span class="hljs-string">$g</span></span>ac_path = <span class="hljs-string"><span class="hljs-string">'C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.6 Tools\gacutil.exe'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#install</span></span> assembly to <span class="hljs-type"><span class="hljs-type">GAC</span></span> <span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">ChildItem</span></span> -recurse <span class="hljs-string"><span class="hljs-string">$a</span></span>sm_path | where {<span class="hljs-string"><span class="hljs-string">$_</span></span>.extension -eq <span class="hljs-comment"><span class="hljs-comment">".dll"</span></span>} | <span class="hljs-type"><span class="hljs-type">ForEach</span></span>-<span class="hljs-type"><span class="hljs-type">Object</span></span> { <span class="hljs-type"><span class="hljs-type">Write</span></span>-<span class="hljs-type"><span class="hljs-type">Host</span></span> <span class="hljs-comment"><span class="hljs-comment">"Try to install assembly $_"</span></span> &amp; <span class="hljs-string"><span class="hljs-string">$g</span></span>ac_path <span class="hljs-comment"><span class="hljs-comment">"/i"</span></span>, <span class="hljs-string"><span class="hljs-string">$_</span></span>.<span class="hljs-type"><span class="hljs-type">FullName</span></span> } <span class="hljs-symbol"><span class="hljs-symbol">#uninstall</span></span> assembly from <span class="hljs-type"><span class="hljs-type">GAC</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#Get</span></span>-<span class="hljs-type"><span class="hljs-type">ChildItem</span></span> <span class="hljs-string"><span class="hljs-string">$a</span></span>sm_path | where {<span class="hljs-string"><span class="hljs-string">$_</span></span>.extension -eq <span class="hljs-comment"><span class="hljs-comment">".dll"</span></span>} | <span class="hljs-type"><span class="hljs-type">ForEach</span></span>-<span class="hljs-type"><span class="hljs-type">Object</span></span> { # &amp; <span class="hljs-string"><span class="hljs-string">$g</span></span>ac_path <span class="hljs-comment"><span class="hljs-comment">"/u"</span></span>, ([<span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">Reflection</span></span>.<span class="hljs-type"><span class="hljs-type">AssemblyName</span></span>]::<span class="hljs-type"><span class="hljs-type">GetAssemblyName</span></span>(<span class="hljs-string"><span class="hljs-string">$_</span></span>.<span class="hljs-type"><span class="hljs-type">FullName</span></span>).<span class="hljs-type"><span class="hljs-type">FullName</span></span>) #}</code> </pre> <br><p>  We will conduct an experiment with the integration of sites in applicationPools manually, although the latter can be done using PowerShell through the WebAdministration module [7]. <br>  In the specific case, we will combine 47 microservices into 6 applicationPools according to their load profile.  To backup, restore or transfer the configuration to other machines, I recommend to pay attention to <strong>appcmd.exe</strong> [7], [8] </p><br><pre> <code class="hljs dos">#clean all sites <span class="hljs-built_in"><span class="hljs-built_in">cmd</span></span>.exe /c "<span class="hljs-variable"><span class="hljs-variable">%windir%</span></span>\system32\inetsrv\appcmd.exe list site /xml | <span class="hljs-variable"><span class="hljs-variable">%windir%</span></span>\system32\inetsrv\appcmd delete site /<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>" #cleam all pools <span class="hljs-built_in"><span class="hljs-built_in">cmd</span></span>.exe /c "<span class="hljs-variable"><span class="hljs-variable">%windir%</span></span>\system32\inetsrv\appcmd.exe list apppool /xml | <span class="hljs-variable"><span class="hljs-variable">%windir%</span></span>\system32\inetsrv\appcmd delete apppool /<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>" #To Export the Application Pools on IIS <span class="hljs-number"><span class="hljs-number">7</span></span> : #<span class="hljs-built_in"><span class="hljs-built_in">cmd</span></span>.exe /c "<span class="hljs-variable"><span class="hljs-variable">%windir%</span></span>\system32\inetsrv\appcmd list apppool /config /xml &gt; c:\apppools.xml" #To Export all you're website: #<span class="hljs-built_in"><span class="hljs-built_in">cmd</span></span>.exe /c "<span class="hljs-variable"><span class="hljs-variable">%windir%</span></span>\system32\inetsrv\appcmd list site /config /xml &gt; c:\sites.xml" #To import the Application Pools: <span class="hljs-built_in"><span class="hljs-built_in">cmd</span></span>.exe /c "<span class="hljs-variable"><span class="hljs-variable">%windir%</span></span>\system32\inetsrv\appcmd add apppool /<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt; c:\apppools.xml" #Stop all Application Pools: <span class="hljs-built_in"><span class="hljs-built_in">cmd</span></span>.exe /c "<span class="hljs-variable"><span class="hljs-variable">%windir%</span></span>\system32\inetsrv\appcmd.exe list apppool /xml | <span class="hljs-variable"><span class="hljs-variable">%windir%</span></span>\system32\inetsrv\appcmd stop apppool /<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>" #To Import the website: <span class="hljs-built_in"><span class="hljs-built_in">cmd</span></span>.exe /c "<span class="hljs-variable"><span class="hljs-variable">%windir%</span></span>\system32\inetsrv\appcmd add site /<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt; c:\sites.xml"</code> </pre> <br><p>  After the done changes, we have the following picture: 47 sites ‚Äúwarmed up‚Äù in 2 minutes and 33 seconds, which is 2.6 times faster.  The total size of the RAM used was 4.1 GB.  At the same time, the average size of one microservice was 3.1 GB / 47 = 67 MB, which is 2.2 times less. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/yj/uu/-t/yjuu-t7f6g4nsqpmhm23l-spgbg.png"></a> <br> <a href=""><img src="https://habrastorage.org/webt/iy/8b/an/iy8bankbp0lziusk6vf8c1grzpg.png"></a> </p><br><h3 id="4-sharing-sborok-mezhdu-razlichnymi-prilozheniyami-ponyatie-nativnogo-obraza-native-image">  4. Sharing assemblies between different applications, the concept of a native image (native image) </h3><br><p>  In addition to sharing between assemblies between domains in a single process, sharing between different processes is possible, but the latter requires creating a native image and putting it in a cache.  For this purpose we will use <strong>ngen.exe</strong> [9]. </p><br><p>  We list the advantages of using native images: </p><br><ul><li>  can be shared between processes </li><li>  can be shared between domains in the same process </li><li>  use less RAM because they do not require JIT compilation </li><li>  load faster because it does not require JIT compilation and type-safety verification </li></ul><br><p>  Creating native images is possible for both signed and unsigned assemblies.  However, there are nuances: if the assembly is loaded not in the sharedDomain, then it will not be able to be shared with other appDomains. </p><br><pre> <code class="hljs smalltalk"><span class="hljs-string"><span class="hljs-string">$a</span></span>sm_path = <span class="hljs-string"><span class="hljs-string">'C:\git\IISSharingAssemblies\common-assemblies-legacy'</span></span> <span class="hljs-string"><span class="hljs-string">$n</span></span>gn_path = <span class="hljs-string"><span class="hljs-string">'C:\Windows\Microsoft.NET\Framework64\v4.0.30319\ngen.exe'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#install</span></span> native images from cache <span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">ChildItem</span></span> -<span class="hljs-type"><span class="hljs-type">Recurse</span></span> <span class="hljs-string"><span class="hljs-string">$a</span></span>sm_path | where {<span class="hljs-string"><span class="hljs-string">$_</span></span>.extension -eq <span class="hljs-comment"><span class="hljs-comment">".dll"</span></span>} | <span class="hljs-type"><span class="hljs-type">ForEach</span></span>-<span class="hljs-type"><span class="hljs-type">Object</span></span> { &amp; <span class="hljs-string"><span class="hljs-string">$n</span></span>gn_path <span class="hljs-comment"><span class="hljs-comment">"install"</span></span>, ([<span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">Reflection</span></span>.<span class="hljs-type"><span class="hljs-type">AssemblyName</span></span>]::<span class="hljs-type"><span class="hljs-type">GetAssemblyName</span></span>(<span class="hljs-string"><span class="hljs-string">$_</span></span>.<span class="hljs-type"><span class="hljs-type">FullName</span></span>).<span class="hljs-type"><span class="hljs-type">FullName</span></span>) } <span class="hljs-symbol"><span class="hljs-symbol">#uninstall</span></span> native images from cache <span class="hljs-symbol"><span class="hljs-symbol">#Get</span></span>-<span class="hljs-type"><span class="hljs-type">ChildItem</span></span> <span class="hljs-string"><span class="hljs-string">$a</span></span>sm_path | where {<span class="hljs-string"><span class="hljs-string">$_</span></span>.extension -eq <span class="hljs-comment"><span class="hljs-comment">".dll"</span></span>} | <span class="hljs-type"><span class="hljs-type">ForEach</span></span>-<span class="hljs-type"><span class="hljs-type">Object</span></span> { # &amp; <span class="hljs-string"><span class="hljs-string">$n</span></span>gn_path <span class="hljs-comment"><span class="hljs-comment">"uninstall"</span></span>, ([<span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">Reflection</span></span>.<span class="hljs-type"><span class="hljs-type">AssemblyName</span></span>]::<span class="hljs-type"><span class="hljs-type">GetAssemblyName</span></span>(<span class="hljs-string"><span class="hljs-string">$_</span></span>.<span class="hljs-type"><span class="hljs-type">FullName</span></span>).<span class="hljs-type"><span class="hljs-type">FullName</span></span>) #}</code> </pre> <br><p>  At this stage we will have to repeat all previous steps and execute one new one: </p><br><ul><li>  upload signed assemblies to GAC </li><li>  combining sites in applicationPools </li><li>  creating native images for assemblies uploaded to the GAC </li></ul><br><p>  As a result, we will see the following picture: </p><br><ul><li>  total warm-up time 2 minutes 12 seconds </li><li>  total size of used RAM 2.2 GB </li><li>  average size of one microservice is 1.2 Gb / 47 = 26.1 Mb </li></ul><br><p> <a href=""><img src="https://habrastorage.org/webt/ac/ot/0v/acot0v2un7j6sm3jote_fxe0j3s.png"></a> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/k9/zg/gu/k9zgguxa3mwshejyfho9dkildkw.png"></a> </p><br><h3 id="5-rezultaty">  5. Results </h3><br><table><thead><tr><th>  Step </th><th>  Total warm-up time </th><th>  The total size of the used RAM </th><th>  The average size of one microservice </th><th>  Note </th></tr></thead><tbody><tr><td>  Initial conditions </td><td>  6 min 43 sec </td><td>  8 GB </td><td>  7 GB / 47 = 152 MB </td><td>  1 GB on OS.  Native image cache not used by IIS </td></tr><tr><td>  Combining sites into appPools, uploading assemblies to the GAC </td><td>  2 min 33 sec </td><td>  4.1 GB </td><td>  3.1 GB / 47 = 67 MB </td><td>  1 GB on OS.  Native image cache not used by IIS </td></tr><tr><td>  Combining sites into appPools, loading assemblies into GAC, creating native images </td><td>  2 min 12 sec </td><td>  2.2 GB </td><td>  1.2 Gb / 47 = 26.1 Mb </td><td>  1 GB on OS.  IIS uses native image cache </td></tr></tbody></table><br><h3 id="ssylki">  Links </h3><br><ol><li>  Windows Sysinternals Administrator's Reference.  Pages 216-218 </li><li>  <a href="http://blogs.microsoft.co.il/sasha/2016/01/05/windows-process-memory-usage-demystified/">http://blogs.microsoft.co.il/sasha/2016/01/05/windows-process-memory-usage-demystified/</a> </li><li>  <a href="https://blogs.msdn.microsoft.com/junfeng/2004/08/05/domain-neutral-assemblies/">https://blogs.msdn.microsoft.com/junfeng/2004/08/05/domain-neutral-assemblies/</a> </li><li>  Pro .NET Performance: Optimize Your C # Applications.  Page 289 </li><li>  Introduction .NET 4.5 Alex Mackey, William Stewart Tulloch, Mahesh Krishnan.  Page 149 </li><li>  <a href="https://technet.microsoft.com/ru-ru/library/ee790599.aspx">https://technet.microsoft.com/ru-ru/library/ee790599.aspx</a> </li><li>  <a href="http://www.microsoftpro.nl/2011/01/27/exporting-and-importing-sites-and-app-pools-from-iis-7-and-7-5/">http://www.microsoftpro.nl/2011/01/27/exporting-and-importing-sites-and-app-pools-from-iis-7-and-7-5/</a> </li><li>  <a href="https://technet.microsoft.com/en-us/library/ea8d442e-9a0c-49bb-b940-50b22fa64dd4">https://technet.microsoft.com/en-us/library/ea8d442e-9a0c-49bb-b940-50b22fa64dd4</a> </li><li>  <a href="https://docs.microsoft.com/en-us/dotnet/framework/tools/ngen-exe-native-image-generator">https://docs.microsoft.com/en-us/dotnet/framework/tools/ngen-exe-native-image-generator</a> </li></ol><br><h3 id="ishodnyy-kod">  Source </h3><br><ol><li>  <a href="https://github.com/sflusov/IISSharingAssemblies">https://github.com/sflusov/IISSharingAssemblies</a> </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/341950/">https://habr.com/ru/post/341950/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341934/index.html">UX Writer: The Anatomy of a Unicorn</a></li>
<li><a href="../341936/index.html">Mobile marketing: discrepancies in installation statistics</a></li>
<li><a href="../341938/index.html">US Securities and Exchange Commission attack: stolen data can be used for insider trading</a></li>
<li><a href="../341944/index.html">We write really tested code</a></li>
<li><a href="../341946/index.html">JTAG to every home: full access via USB</a></li>
<li><a href="../341952/index.html">ZeroNights 2017 program</a></li>
<li><a href="../341954/index.html">The rules of English that violate your foreign colleagues</a></li>
<li><a href="../341956/index.html">Motivation system: carrot front or rear carrot</a></li>
<li><a href="../341962/index.html">AI on Fiztekh: digital economy, blockchain, chat bots and that's it</a></li>
<li><a href="../341964/index.html">Introducing 3CX v15.5 Update 2 Beta: auto-tuning by QR code, server CRM integration and more</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>