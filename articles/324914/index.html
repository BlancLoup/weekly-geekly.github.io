<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We develop video chat between the browser and the mobile application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Evil empires often receive hate rays from end users. In spite of this, Uber partially pays for our trips, albeit temporarily, and Google gave a signif...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We develop video chat between the browser and the mobile application</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/18b/79f/c9a/18b79fc9a8944cf8a505ba68bda5a309.png"></div><br>  <b>Evil empires</b> often receive hate rays from end users.  In spite of this, Uber partially pays for our trips, albeit temporarily, and Google gave a significant acceleration of the <b>WebRTC</b> technology, which would have remained proprietary and heavily paid software for narrow b2b goals, if not for <b>IZ</b> . <br><br>  After the advent of WebRTC, video chats became easier to do.  Various APIs and services appeared, servers and frameworks.  In this article, we describe in detail another way to develop video chat between a <b>web browser</b> and a native <b>Android application.</b> <a name="habracut"></a><br><br><h2>  Video chat in browser </h2><br>  Classic WebRTC video chat between browsers begins with the SDP (session description protocol) exchange.  <b>Alice</b> sends her SDP over the network to <b>Boris</b> , and Boris answers hers.  SDP, which is such a config: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <font color="#999999">o = - 1468792194439919690 2 IN IP4 127.0.0.1</font> <font color="#999999"><br></font>  <font color="#999999">s = -</font> <font color="#999999"><br></font>  <font color="#999999">t = 0 0</font> <font color="#999999"><br></font>  <font color="#999999">a = group: BUNDLE audio video</font> <font color="#999999"><br></font>  <font color="#999999">a = msid-semantic: WMS 9nKsWmxMvOQBYaz9xhRffWeWSUbCbnox6aQ4</font> <font color="#999999"><br></font>  <font color="#999999">m = audio 9 UDP / TLS / RTP / SAVPF 111 103 104 9 0 8 106 105 13 110 112 113 126</font> <font color="#999999"><br></font>  <font color="#999999">c = IN IP4 0.0.0.0</font> <font color="#999999"><br></font>  <font color="#999999">a = rtcp: 9 IN IP4 0.0.0.0</font> <font color="#999999"><br></font>  <font color="#999999">a = ice-ufrag: kSrQ</font> <font color="#999999"><br></font>  <font color="#999999">a = ice-pwd: 4uIyZd / mbVSVe2iMFgC1i3qn</font> <font color="#999999"><br></font>  <font color="#999999">a = fingerprint: sha-256 6B: 29: 2F: 47: EB: 38: 64: F3: 25: CE: BD: E6: B0: 3F: A6: FA: 55: 57: A9: EA: 44: 0B : 7C: 45: D2: 0D: F4: 96: 8D: B2: 9F: BA</font> <font color="#999999"><br></font>  <font color="#999999">a = setup: actpass</font> <font color="#999999"><br></font>  <font color="#999999">a = mid: audio</font> <font color="#999999"><br></font>  <font color="#999999">a = extmap: 1 urn: ietf: params: rtp-hdrext: ssrc-audio-level</font> <font color="#999999"><br></font>  <font color="#999999">a = sendonly</font> <font color="#999999"><br></font>  <font color="#999999">a = rtcp-mux</font> <font color="#999999"><br></font>  <font color="#999999">a = rtpmap: 111 opus / 48000/2</font> <font color="#999999"><br></font>  <font color="#999999">a = rtcp-fb: 111 transport-cc</font> <font color="#999999"><br></font>  <font color="#999999">a = fmtp: 111 minptime = 10; useinbandfec = 1</font> <font color="#999999"><br></font>  <font color="#999999">a = rtpmap: 103 ISAC / 16000</font> <font color="#999999"><br></font>  <font color="#999999">a = rtpmap: 104 ISAC / 32000</font> <font color="#999999"><br></font>  <font color="#999999">a = rtpmap: 9 G722 / 8000</font> <font color="#999999"><br></font>  <font color="#999999">a = rtpmap: 0 PCMU / 8000</font> <font color="#999999"><br></font>  <font color="#999999">a = rtpmap: 8 PCMA / 8000</font> <font color="#999999"><br></font>  <font color="#999999">a = rtpmap: 106 CN / 32000</font> <font color="#999999"><br></font>  <font color="#999999">a = rtpmap: 105 CN / 16000</font> <font color="#999999"><br></font>  <font color="#999999">a = rtpmap: 13 CN / 8000</font> <font color="#999999"><br></font>  <font color="#999999">a = rtpmap: 110 telephone-event / 48000</font> <font color="#999999"><br></font>  <font color="#999999">a = rtpmap: 112 telephone-event / 32000</font> <font color="#999999"><br></font>  <font color="#999999">a = rtpmap: 113 telephone-event / 16000</font> <font color="#999999"><br></font>  <font color="#999999">a = rtpmap: 126 telephone-event / 8000</font> <font color="#999999"><br></font>  <font color="#999999">a = ssrc: 3525514540 cname: drYey7idt605CcEG</font> <font color="#999999"><br></font>  <font color="#999999">a = ssrc: 3525514540 msid: 9nKsWmxMvOQBYaz9xhRffWeWSUbCbnox6aQ4 09bdb6e7-b4b3-437b-945e-771f535052e3</font> <font color="#999999"><br></font>  <font color="#999999">a = ssrc: 3525514540 mslabel: 9nKsWmxMvOQBYaz9xhRffWeWSUbCbnox6aQ4</font> <font color="#999999"><br></font>  <font color="#999999">a = ssrc: 3525514540 label: 09bdb6e7-b4b3-437b-945e-771f535052e3</font> <font color="#999999"><br></font>  <font color="#999999">m = video 9 UDP / TLS / RTP / SAVPF 96 98 100 102 127 97 99 101 125</font> <font color="#999999"><br></font>  <font color="#999999">c = IN IP4 0.0.0.0</font> <font color="#999999"><br></font>  <font color="#999999">a = rtcp: 9 IN IP4 0.0.0.0</font> <font color="#999999"><br></font>  <font color="#999999">a = ice-ufrag: kSrQ</font> <font color="#999999"><br></font>  <font color="#999999">a = ice-pwd: 4uIyZd / mbVSVe2iMFgC1i3qn</font> <font color="#999999"><br></font>  <font color="#999999">a = fingerprint: sha-256 6B: 29: 2F: 47: EB: 38: 64: F3: 25: CE: BD: E6: B0: 3F: A6: FA: 55: 57: A9: EA: 44: 0B : 7C: 45: D2: 0D: F4: 96: 8D: B2: 9F: BA</font> <font color="#999999"><br></font>  <font color="#999999">a = setup: actpass</font> <font color="#999999"><br></font>  <font color="#999999">a = mid: video</font> <font color="#999999"><br></font>  <font color="#999999">a = extmap: 2 urn: ietf: params: rtp-hdrext: toffset</font> <font color="#999999"><br></font>  <font color="#999999">a = extmap: 3 <a href="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time">www.webrtc.org/experiments/rtp-hdrext/abs-send-time</a></font> <font color="#999999"><br></font>  <font color="#999999">a = extmap: 4 urn: 3gpp: video-orientation</font> <font color="#999999"><br></font>  <font color="#999999">a = extmap: 5 <a href="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01">www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01</a></font> <font color="#999999"><br></font>  <font color="#999999">a = extmap: 6 <a href="http://www.webrtc.org/experiments/rtp-hdrext/playout-delay">www.webrtc.org/experiments/rtp-hdrext/playout-delay</a></font> <font color="#999999"><br></font>  <font color="#999999">a = sendonly</font> <font color="#999999"><br></font>  <font color="#999999">a = rtcp-mux</font> <font color="#999999"><br></font>  <font color="#999999">a = rtcp-rsize</font> <font color="#999999"><br></font>  <font color="#999999">a = rtpmap: 96 VP8 / 90000</font> <font color="#999999"><br></font>  <font color="#999999">a = rtcp-fb: 96 ccm fir</font> <font color="#999999"><br></font>  <font color="#999999">a = rtcp-fb: 96 nack</font> <font color="#999999"><br></font>  <font color="#999999">a = rtcp-fb: 96 nack pli</font> <font color="#999999"><br></font>  <font color="#999999">a = rtcp-fb: 96 goog-remb</font> <font color="#999999"><br></font>  <font color="#999999">a = rtcp-fb: 96 transport-cc</font> <font color="#999999"><br></font>  <font color="#999999">a = rtpmap: 98 VP9 / 90000</font> <font color="#999999"><br></font>  <font color="#999999">a = rtcp-fb: 98 ccm fir</font> <font color="#999999"><br></font>  <font color="#999999">a = rtcp-fb: 98 nack</font> <font color="#999999"><br></font>  <font color="#999999">a = rtcp-fb: 98 nack pli</font> <font color="#999999"><br></font>  <font color="#999999">a = rtcp-fb: 98 goog-remb</font> <font color="#999999"><br></font>  <font color="#999999">a = rtcp-fb: 98 transport-cc</font> <font color="#999999"><br></font>  <font color="#999999">a = rtpmap: 100 H264 / 90000</font> <font color="#999999"><br></font>  <font color="#999999">a = rtcp-fb: 100 ccm fir</font> <font color="#999999"><br></font>  <font color="#999999">a = rtcp-fb: 100 nack</font> <font color="#999999"><br></font>  <font color="#999999">a = rtcp-fb: 100 nack pli</font> <font color="#999999"><br></font>  <font color="#999999">a = rtcp-fb: 100 goog-remb</font> <font color="#999999"><br></font>  <font color="#999999">a = rtcp-fb: 100 transport-cc</font> <font color="#999999"><br></font>  <font color="#999999">a = fmtp: 100 level-asymmetry-allowed = 1; packetization-mode = 1; profile-level-id = 42e01f</font> <font color="#999999"><br></font>  <font color="#999999">a = rtpmap: 102 red / 90000</font> <font color="#999999"><br></font>  <font color="#999999">a = rtpmap: 127 ulpfec / 90000</font> <font color="#999999"><br></font>  <font color="#999999">a = rtpmap: 97 rtx / 90000</font> <font color="#999999"><br></font>  <font color="#999999">a = fmtp: 97 apt = 96</font> <font color="#999999"><br></font>  <font color="#999999">a = rtpmap: 99 rtx / 90000</font> <font color="#999999"><br></font>  <font color="#999999">a = fmtp: 99 apt = 98</font> <font color="#999999"><br></font>  <font color="#999999">a = rtpmap: 101 rtx / 90000</font> <font color="#999999"><br></font>  <font color="#999999">a = fmtp: 101 apt = 100</font> <font color="#999999"><br></font>  <font color="#999999">a = rtpmap: 125 rtx / 90000</font> <font color="#999999"><br></font>  <font color="#999999">a = fmtp: 125 apt = 102</font> <font color="#999999"><br></font>  <font color="#999999">a = ssrc-group: FID 2470936840 2969787502</font> <font color="#999999"><br></font>  <font color="#999999">a = ssrc: 2470936840 cname: drYey7idt605CcEG</font> <font color="#999999"><br></font>  <font color="#999999">a = ssrc: 2470936840 msid: 9nKsWmxMvOQBYaz9xhRffWeWSUbCbnox6aQ4 ce9235c5-f300-466a-aadd-b969dc2f3664</font> <font color="#999999"><br></font>  <font color="#999999">a = ssrc: 2470936840 mslabel: 9nKsWmxMvOQBYaz9xhRffWeWSUbCbnox6aQ4</font> <font color="#999999"><br></font>  <font color="#999999">a = ssrc: 2470936840 label: ce9235c5-f300-466a-aadd-b969dc2f3664</font> <font color="#999999"><br></font>  <font color="#999999">a = ssrc: 2969787502 cname: drYey7idt605CcEG</font> <font color="#999999"><br></font>  <font color="#999999">a = ssrc: 2969787502 msid: 9nKsWmxMvOQBYaz9xhRffWeWSUbCbnox6aQ4 ce9235c5-f300-466a-aadd-b969dc2f3664</font> <font color="#999999"><br></font>  <font color="#999999">a = ssrc: 2969787502 mslabel: 9nKsWmxMvOQBYaz9xhRffWeWSUbCbnox6aQ4</font> <font color="#999999"><br></font>  <font color="#999999">a = ssrc: 2969787502 label: ce9235c5-f300-466a-aadd-b969dc2f3664</font> <br><br>  For example, from this SDP-config it can be said that it is proposed to use <b>H.264</b> and <b>VP8</b> codecs for video and <b>Opus</b> for audio.  In addition, you can get a lot of other useful information for phoning, such as priority of codecs, use of feedback, <b>fir</b> , <b>nack</b> , <b>pli</b> , profile and level for <b>H.264</b> 42e01f codec - Baseline 3.1, etc. <br><br>  In the process of implementing video chat on the native <b>WebRTC API,</b> it is desirable to understand what SDP is, candidates (candidates), codecs, ICE, STUN, TURN and many other scary words. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/5aa/3a3/be9/5aa3a3be9d63468d8a1ec9866d9da4c2.jpg"></div><br><h2>  WebRTC, Websockets and SIP </h2><br>  The concepts regarding WebRTC and Websocket are often confused.  Sometimes SIP is added to this confusion. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/2b1/77e/3a9/2b177e3a92a9439285ad084bed7934f2.jpg"></div><br>  It can be said for sure that <b>WebRTC</b> has no direct relation to <b>either Websockets or SIP</b> . <br><br>  <b>Websockets</b> is only a convenient opportunity to transfer <b>SDP</b> from Boris to Alice.  Instead of Websockets, we could use plain <b>HTTP</b> or send SDP text by mail.  SDP messaging is signaling information and this data can be transmitted over any protocol you like.  For browsers, the default data transfer protocols are: Websockets and HTTP.  Therefore, Websockets is used as a more real-time option compared to HTTP.  No audio or video is transmitted via Websockets.  Only signaling information: text and commands. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/830/5ef/946/8305ef9463254abbb3168a97a3d01449.jpg"></div><br>  <b>SIP</b> is a text messaging protocol.  WebRTC is sometimes unfairly called <b>SIP-ohm</b> in the browser, most likely for the fact that SIP messages also use SDP for configuring codecs and establishing connections. <br><br>  On the other hand, when we speak, for example, a <b>SIP phone</b> , we mean a device that, along with the <b>SIP protocol (RFC3261),</b> supports a dozen other network specifications and protocols: RTP, SDP, AVPF, etc. <br><br>  Indeed, WebRTC at the network level uses similar building blocks with those that use a SIP phone (SRTP, STUN, etc.).  Therefore, it can be said that both WebRTC and SIP devices / software use a similar technology base.  But it would be incorrect to call WebRTC SIP in the browser, if only because there is no SIP in the out-of-box browsers. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cf1/d4a/6a5/cf1d4a6a52ed423387361d8ae7a6365a.jpg"></div><br>  <b>WebRTC</b> is a technology that has three main functions in terms of audio / video transmission: <br><br><ul><li> Capture, encode, and send </li><li>  Receive decoding and playback </li><li>  Bridging NAT and Firewall </li></ul><br>  And many support functions, such as jitter control, adaptive bitrate, network overload control, etc. <br><br>  As described above, for the WebRTC media transfer to take place, Alice and Boris must exchange SDP, which contain detailed information about the formats of video streams, packetization and other parameters that determine exactly how the party will receive the video. <br><br>  In addition to SDP exchange, a <b>TURN server</b> may be required, which will allow video traffic to pass through itself if the Peer-to-Peer connection is not established, for example, if Alice or Boris has a rather unfriendly (for example, <b>symmetric</b> ) NAT. <br><br>  Suppose we wanted to add a third active participant or just a viewer to the chat.  A good example in this case is the debate.  Two participants are talking - the rest are watching.  Another example is a chat for three or more participants. <br><br>  When a third participant appears, the scheme is complicated by the fact that each of the participants has to <b>capture and press</b> already <b>two video streams</b> instead of one, and also <b>establish connections in pairs</b> , trying to overcome <b>NAT</b> .  In this case, the connection setup time may dramatically increase and its stability decreases.  Simultaneous compression and sending of two or more video streams creates a serious load on the processor and the network and affects the quality for the worse, especially on mobile devices: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b15/896/e02/b15896e0215c49c0b8ceefa3f4d9bf1f.jpg"></div><br>  Similar tasks such as <br><br><ul><li>  connect three or more participants </li><li>  connecting additional video chat viewers </li><li>  video chat entry </li></ul><br>  go beyond the successful applicability of peer-to-peer and require a central WebRTC server that manages these connections. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/585/aca/6cf/585aca6cfec64648905e9fa5e241b9d1.jpg"></div><br>  As mentioned above, there are services and servers, convenient and inconvenient APIs over the WebRTC API that allow you to speed up the development of video chats and work with more convenient abstractions, such as <b>video stream</b> (Stream), <b>room</b> (Room), <b>publishing</b> (Publisher), <b>viewer</b> (Subscriber) , etc. <br><br>  For example, to create the simplest video chat it would be enough to exchange the names of the streams.  Boris knows the flow of Alice.  Alice knows the flow of Boris - and video chat is ready: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f41/ded/169/f41ded169e5a49d1a0053d083bbfa90a.jpg"></div><br><h2>  Sample video chat in the browser </h2><br>  In this article, we will show how the Streaming API works with <b>Web Call Server 5</b> - a WebRTC server for video chatting and online broadcasting. <br><br>  Video chat in action can be illustrated in the following two screenshots.  The first <b>Alice</b> member will see a video chat like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a3f/863/103/a3f8631039e64220aa9c46ef7c397c8a.jpg"></div><br>  The second <b>Edward</b> member will see a video chat like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/0dc/3c8/e4f/0dc3c8e4fe79458f9277a5ed09a654fa.jpg"></div><br>  In this example, the following happens: <br><br><ol><li>  Alice sent a video stream from a browser named Alice to the server. </li><li>  Edward sent a video stream from a browser called Edward to the server. </li><li>  Alice took and lost the video stream named Edward. </li><li>  Edward took and lost the video stream with the name Alice. </li></ol><br>  As you can see from this example, we built a video chat based only on the fact that Alice and Edward know the names of each other's streams.  We did not have to work directly with SDP, PeerConnection, NAT, TURN, etc. <br><br>  Thus, <b>video chat can be implemented simply by transferring the names of streams to those who have to lose them.</b> <br><br>  In this simple concept, you can use any front-end and back-end technologies, such as Jquery, Bootstrap, React, Angular, PHP, Java, .Net, etc.  And the good news is that embedding support for video streams and video chat does not affect the existing web application.  You control your video chat by simply allowing (or not allowing) its participants to play the desired video streams. <br><br><h2>  Video chat code in the browser </h2><br>  Now we will show how it looks in code.  The video chat HTML page contains two main <b>div elements</b> : <br><br><ul><li>  localVideo - video captured from a webcam </li><li>  remoteVideo - video that is played from the server </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b51/135/98f/b5113598f9db4ea49d9a8211da94ecf0.jpg"></div><br><br>  You can give these elements any arbitrary identifiers, such as id = "captureVideo" or id = "playbackVideo", but it is important that these elements are present on the page. <br><br>  A working HTML page with <b>localVideo</b> and <b>remoteVideo blocks</b> looks like this: <br><br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">language</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"flashphoner.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">language</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"video-chat.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onLoad</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"init()"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>Video Chat<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"localVideo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"width:320px;height:240px;border: 1px solid"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"remoteVideo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"width:320px;height:240px;border: 1px solid"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"connect"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"connect()"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"publish"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"publish('Alice')"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"play"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"play('Edward')"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"status"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Now we give the code that is directly responsible for sending and playing the video. <br><br><h3>  Send stream from webcam </h3><br>  When sending, we use the API method <b>session.createStream (). Publish ()</b> and specify for this stream an HTML div element in which the <b>localVideo</b> video captured from the camera will be displayed, as well as the name of the <b>Alice</b> video stream, knowing that the other stream can play the video by the client. <br><br><pre> <code class="javascript hljs">session.createStream({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Alice"</span></span>, <span class="hljs-attr"><span class="hljs-attr">display</span></span>: localVideo, <span class="hljs-attr"><span class="hljs-attr">cacheLocalResources</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">receiveVideo</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">receiveAudio</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }).on(Flashphoner.constants.STREAM_STATUS.PUBLISHING, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">publishStream</span></span></span><span class="hljs-function">) </span></span>{ setStatus(Flashphoner.constants.STREAM_STATUS.PUBLISHING); }).on(Flashphoner.constants.STREAM_STATUS.UNPUBLISHED, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ setStatus(Flashphoner.constants.STREAM_STATUS.UNPUBLISHED); }).on(Flashphoner.constants.STREAM_STATUS.FAILED, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ setStatus(Flashphoner.constants.STREAM_STATUS.FAILED); }).publish();</code> </pre><br><h3>  Play video from the server </h3><br>  During playback, we specify the name of the stream that will be played and the HTML div element <b>remoteVideo</b> , in which the stream received from the server will be played.  The API method <b>session.createStream (). Play () is used</b> . <br><br><pre> <code class="javascript hljs"> session.createStream({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Edward"</span></span>, <span class="hljs-attr"><span class="hljs-attr">display</span></span>: remoteVideo, <span class="hljs-attr"><span class="hljs-attr">cacheLocalResources</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">receiveVideo</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">receiveAudio</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }).on(Flashphoner.constants.STREAM_STATUS.PLAYING, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">playStream</span></span></span><span class="hljs-function">) </span></span>{ setStatus(Flashphoner.constants.STREAM_STATUS.PLAYING); }).on(Flashphoner.constants.STREAM_STATUS.STOPPED, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ setStatus(Flashphoner.constants.STREAM_STATUS.STOPPED); }).on(Flashphoner.constants.STREAM_STATUS.FAILED, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ setStatus(Flashphoner.constants.STREAM_STATUS.FAILED); }).play();</code> </pre><br>  While working with the server, the HTML page will receive various statuses, such as <b>PLAYING</b> , <b>STOPPED</b> for playback and <b>PUBLISHING</b> , <b>UNPUBLISHED</b> for publishing the stream. <br><br>  Thus, the main thing that is required for video chatting is to place on the web page two div-blocks and connect the corresponding scripts that run stream.play () and stream.publish () by the stream name. <br><br>  The full source code for the <b>Two Way Streaming</b> sample is available for download <a href="https://github.com/flashphoner/flashphoner_client/tree/wcs_api-2.0/examples/demo/streaming/two_way_streaming">here</a> . <br><br><h2>  Sample WebRTC video chat in an Android application </h2><br>  Video chat for Android will work exactly the same way as video chat in a browser.  The application will establish a connection with the server, send a video stream from the camera of an Android device, receive and play another video stream from the server. <br><br>  Below is the Android application <b>Streaming Min</b> (analogous to the Two Way Streaming example for video chat in the browser) that allows you to share video streams. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/170/cbc/dd0/170cbcdd08df4c4ca36f89ce02973b8f.jpg"></div><br>  From the screenshot it can be seen that nothing has changed.  We have two video windows.  On the left is the video captured from the webcam, and on the right is the video that comes from the server.  The exchange of video streams is carried out in the same way, using names.  We publish one stream and lose the other. <br><br><h2>  Android video chat code </h2><br>  If to create a video chat for the browser, we used the <b>Web SDK</b> , which includes the <b>flashphoner.js</b> API <b>script</b> , to create a full-fledged native Android application, you need to import the Android SDK <b>aar file</b> into the project. <br><br>  To figure out how this works, the easiest way is to build and run the Streaming Min sample based on the Android SDK.  All examples are available in <a href="https://github.com/flashphoner/wcs-android-sdk-samples">the github repository</a> . <br><br>  1. Download all the examples. <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/flashphoner/wcs-android-sdk-samples.git</code> </pre> <br>  2. Download the SDK <br><br><pre> <code class="bash hljs">wget https://flashphoner.com/downloads/builds/flashphoner_client/wcs-android-sdk/aar/wcs-android-sdk-1.0.1.25.aar</code> </pre> <br>  3. We hook the SDK as an aar file to the examples. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ./export.sh /tmp/wcs-android-sdk-1.0.1.25.aar</code> </pre> <br>  Please note that we have specified the export.sh script path to the downloaded file <b>wcs-android-sdk-1.0.1.25.aar</b> - Android SDK <br><br>  As a result, in the <b>export / output</b> folder will be a fully configured project that can be opened in <b>Android Studio</b> <br><br>  It remains only to collect examples using <b>gradle</b> . <br><br>  1 - Create launch configuration <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/383/e1a/f9c/383e1af9cb5541a3a5d7728edec4a62f.png"></div><br>  2 - Choose Gradle Script <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/796/7ee/27f/7967ee27f2b0438ea42944ae6e58be06.jpg"></div><br>  3 - Run the build <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7d6/6af/298/7d66af2987d34ca088db27ad9c149e63.jpg"></div><br>  As a result of the build, we need to get <b>apk-files</b> that can already be installed on the Android device. <br><br>  In this example, we exchanged video streams with the browser.  The <b>test33</b> video stream was sent from the Android device to the server and played back in the browser.  Video stream <b>8880</b> was sent by the browser and played on the Android device.  In this way, we received two-way audio and video communication between the browser and the Android application. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/170/cbc/dd0/170cbcdd08df4c4ca36f89ce02973b8f.jpg"></div><br>  If we used HTML div elements for video in the web version of video chat, in Android we use renderers <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SurfaceViewRenderer localRender; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SurfaceViewRenderer remoteRender;</code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/files/13f/974/9e1/13f9749e1c844105aad58cbab3fddb9e.jpg"></div><br>  The <b>localRenderer</b> displays video captured from the camera of an Android device.  The <b>remoteRenderer</b> displays the video that came from the server. <br><br>  1. Create a connection to the server and indicate that renderers will be used ... <br><br><pre> <code class="java hljs">sessionOptions = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SessionOptions(mWcsUrlView.getText().toString()); sessionOptions.setLocalRenderer(localRender); sessionOptions.setRemoteRenderer(remoteRender); ... session = Flashphoner.createSession(sessionOptions); ‚Ä¶ session.connect(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Connection());</code> </pre><br>  2. Create a stream with an arbitrary name and publish the stream to the server. <br><br><pre> <code class="java hljs">StreamOptions streamOptions = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StreamOptions(mPublishStreamView.getText().toString()); publishStream = session.createStream(streamOptions); ... publishStream.publish();</code> </pre><br>  3. Specify the name of the stream during playback and take the stream from the server. <br><br><pre> <code class="java hljs">StreamOptions streamOptions = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StreamOptions(mPlayStreamView.getText().toString()); playStream = session.createStream(streamOptions); ... playStream.play();</code> </pre><br>  The full code for the class <b>StreamingMinActivity.java</b> is available <a href="">here</a> .  And the code for the entire Streaming Min example for Android is available in the repository via <a href="https://github.com/flashphoner/wcs-android-sdk-samples/tree/master/streaming-min">this link</a> . <br><br><h2>  Web call server </h2><br>  As a result, we showed how to organize a simple exchange of video streams between the HTML page in the browser and the Android application. <br><br>  Video streams pass through the Web Call Server, which is simultaneously a signaling server and proxies through itself audio and video traffic. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/3a4/d68/cd2/3a4d68cd25a2489bab9689b820f92805.jpg"></div><br>  Web Call Server is a <b>server software</b> that can be installed on a Linux system on a virtual server or on a physical (dedicated) server.  WCS is a <b>WebRTC video streaming server</b> and can serve video streams from browsers, iOS and Android devices. <br><br><h2>  Links </h2><br><h4>  Technologies and Protocols </h4><br>  <a href="https://webrtc.org/">WebRTC</a> - WebRTC technology <br>  <a href="https://tools.ietf.org/html/rfc4566">SDP</a> - Session description protocol, RFC <br>  <a href="https://tools.ietf.org/html/rfc6455">Websocket</a> - Websocket Protocol, RFC <br><br><h4>  Server and API for developing video chat </h4><br>  <a href="https://flashphoner.com/">Web Call Server</a> - WebRTC video streaming server for video chat <br>  <a href="https://flashphoner.com/download/">Download Web Call Server</a> - server installation <br>  <a href="https://aws.amazon.com/marketplace/pp/B01D1L5EAK">Web Call Server on EC2</a> - running a server image on Amazon EC2 <br>  <a href="https://flashphoner.com/wcs-web-sdk/">Web SDK</a> - Web SDK for developing video chat with WebRTC support <br>  <a href="https://flashphoner.com/wcs-android-sdk/">Android SDK</a> - Android SDK for developing video chat with WebRTC support <br><br><h4>  Working examples </h4><br>  <a href="https://wcs5-eu.flashphoner.com/login.xhtml">Web Two Way Streaming</a> - an example of sharing video streams for the Web <br>  <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.flashphoner.wcsexample.two_way_streaming">Android Two Way Streaming</a> - a sample video sharing application for Android <br><br><h4>  Source code examples </h4><br>  <a href="https://github.com/flashphoner/flashphoner_client/tree/wcs_api-2.0/examples/demo/streaming/two_way_streaming">Web Two Way Streaming</a> - code example video sharing for Web <br>  <a href="https://github.com/flashphoner/wcs-android-sdk-samples/tree/master/streaming-min">Android Two Way Streaming</a> - code example video sharing for Android </div><p>Source: <a href="https://habr.com/ru/post/324914/">https://habr.com/ru/post/324914/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324904/index.html">Five important principles of working with data, which we forget when preparing a project presentation</a></li>
<li><a href="../324906/index.html">The story of how I went to Google Next 17. A brief pressing on the announcements and the most important</a></li>
<li><a href="../324908/index.html">A brief history of javascript. Part 3</a></li>
<li><a href="../324910/index.html">Why do you need a manufacturer‚Äôs service for IT equipment and its cost estimate?</a></li>
<li><a href="../324912/index.html">PayPal Node.js</a></li>
<li><a href="../324916/index.html">The winning decision of the ML Boot Camp III contest</a></li>
<li><a href="../324918/index.html">Docker and detection of available resources inside the container</a></li>
<li><a href="../324920/index.html">How the CIA caused the rain: using Rain Maker to gather information from closed objects</a></li>
<li><a href="../324922/index.html">Threat Horizon 2017-2019 by the International Security Forum (executive executive)</a></li>
<li><a href="../324924/index.html">Cook ML Boot Camp III: Starter Kit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>