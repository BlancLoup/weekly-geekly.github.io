<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development of the game in 115 kb - hacks, bugs and annoyance</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In early November, I participated in the 115th account of the Independent Games Developers Contests (IGDC) community contest, the theme of which was t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development of the game in 115 kb - hacks, bugs and annoyance</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/e65/09d/ede/e6509dedeff44f17851d3438f1b7a2f1.png"></div><br>  In early November, I participated in the 115th account of the Independent Games Developers Contests (IGDC) community contest, the theme of which was the development of an arcade shooter with a limit of 115 kilobytes per week.  Under the cut, the history of the development of the game on OpenGL + Free Pascal, experiments with LZO, bypassing the bugs of the <abbr title="Free pascal compiler">FPC</abbr> compiler for uFMOD, the simplest generation of textures and the annoying bug on NVidia video cards, which spoiled everything. <br><br>  Video, binary for Windows and source code are also attached - look at the end of the article. <br><a name="habracut"></a><br><h3>  Lyrical introduction </h3><br>  Game development is my main favorite and very old hobby.  I rotate in amateur gamedev without much success, high-profile releases and titanic protracted about 10 years.  A lot of frozen projects brought to mind are few.  At some point, I despaired that nothing came of it.  And then I realized that I like not only the final result, but also the game development process itself.  From this moment on, life has become calmer, but I still do not let go of the thought that someday I will overpower myself and bring some project to a commercial level. <br><br>  At some point, I came across the <a href="http://igdc.ru/">IGDC</a> community <a href="http://igdc.ru/">,</a> which held short (from a couple of days to 3 weeks) competitions to develop games on a given topic.  Very, you know, warm and lamp contests, in which the main thing is participation, not a prize.  The experience and pleasure from the work done, not marketing and monetization. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Nowadays, when the threshold for entry into gamedev has decreased by several times, and the flow of frankly unsuccessful games floods mobile platforms, the authors of which dream of earning a comfortable life with another Flappy Bird ... At this time, it is difficult to find people involved in game development for fun, not profit. <br><br>  Of course, there is the mighty <a href="http://ludumdare.com/">Ludum Dare</a> , but its hardcore terms still go against my family life. <br><br><h3>  Start </h3><br>  So, on November 7, 2014, the next contest is announced on the community site.  Conditions: <br><br><ul><li>  "Pysch-pyshch" and enemies - these are the words the moderator described the arcade shooter </li><li>  Size - strictly up to 115 kilobytes, because the competition - the 115th in a row </li><li>  Deadline - a week </li></ul><br>  Permanent mandatory conditions are added to these conditions: it should work offline and without installing third-party packages and redistributable.  All that is required to start the game and is not bundled with the system should be supplied with the release and fit into those same 115 kilobytes. <br><br>  The restriction is indecently large for true demoscene (4k, 32k ...), but sufficient to properly ‚Äúdistort‚Äù.  A cursory analysis of development tools gives a rather impressive list of what fits into these requirements: <br><br><ul><li>  Flash </li><li>  html5 + js </li><li>  C, C ++, C # </li><li>  Delphi, FreePascal </li><li>  ... </li></ul><br>  Unity, Cry Engine, Unreal Engine, JVM-based languages ‚Äã‚Äã(jre preinstalled required), as well as most of the game designers are overboard. <br><br><div class="spoiler">  <b class="spoiler_title">About Flash</b> <div class="spoiler_text">  Despite the fact that Flash requires the installed Adobe Flash Player, it is still allowed for use, as an exception (it is believed that Adobe Flash Player is still in the majority).  It happened historically. <br></div></div><br>  During my life I managed to try a lot of languages ‚Äã‚Äãand technologies, and most of the list above is familiar to me not by hearsay.  But your humble servant chose not the easiest option - Free Pascal.  Why not the easiest? <br><br>  First, in 2014, Free Pascal (like Delphi) is considered unfashionable - as a result, the FPC compiler has few users and quite a few bugs, despite Open Source and cross-platform.  Secondly, the size of the compiled exe for the Lazarus IDE + FPC bundle is a reason for a <a href="http://wiki.freepascal.org/Size_Matters/ru">separate page in the wiki</a> .  Thirdly, there is very little syntactic sugar, which is acutely felt when constantly using many other languages ‚Äã‚Äãand technologies. <br><br>  Of course, there are pluses: <br><br><ul><li>  Properly prepared exe is self-sufficient, while comparable to exe from C / C ++ with static linking CRT </li><li>  With the default settings, it does not allow you to shoot yourself in the foot, as in C / C ++ </li><li>  With the right settings, it shoots both legs completely (which sometimes you want) </li><li>  <i>Quite by chance</i> , I already have a mini-framework on Free Pascal + OpenGL </li></ul><br><div class="spoiler">  <b class="spoiler_title">And I already did a free remake of it on Lunar Lander</b> <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/files/be6/968/5ef/be69685efd7d40219a1550bcfd3a053c.png"></div><br></div></div><br><h3>  Go! </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e48/52c/040/e4852c040ea3458b85051f2fc600df7d.png"></div><br>  First of all, I decided on the concept of the future game - an arcade 2D-shooter with a top view, in which the player controls the ‚Äútank‚Äù and shoots crowds of enemies in every possible way, from which bonuses for even more funny shooting of enemies fall.  Bacchnalia continues until death separates you from your alter-ego.  The closest analogue is <a href="http://ru.wikipedia.org/wiki/Crimsonland">Crimsonland</a> . <br><br>  Having familiarized myself with the template, I created the first problem for myself - a compiled exe with my framework, taking into account all the cunning options of the compiler, took 120 kilobytes.  Of course, given the fact that the framework is able (and keeping in mind that this is still FPC), this is even an achievement.  But it absolutely does not suit us, so ruthlessly we cut the exe using <abbr title="the ultimate packer for eXecutables">UPX</abbr> - 48 kilobytes.  It is quite possible to work with this. <br><br>  Of course, here you could still win a few kilobytes, if you cut down the functionality of the framework to the most necessary.  I refused this due to lack of time, as it turned out later - for good reason.  As a result, the limit of 115 kilobytes was enough for me. <br><br><h3>  We implement LZO </h3><br>  A rare game can do without displaying textual or numeric information.  Although, initially it was in my mind that the idea to create such a game was vital, but it was not possible to come up with an interesting implementation. <br><br>  Therefore, the task - to display text on the screen by OpenGL.  Without resorting to the archaic method of outputting vector text, you should use bitmap fonts.  My framework already had support for text output using pre-generated and carefully "baked" bitmap fonts.  Problem solved? <br><br><div class="spoiler">  <b class="spoiler_title">Briefly about implementation</b> <div class="spoiler_text">  There is a bicycle utility of its own, which packs the necessary characters relatively compactly, and then ‚Äúbakes‚Äù into a bmp-file, at the end of which service information about the character metric (coordinates, size, original size, etc) is mercilessly added.  Any graphics editor does not see the catch and quite correctly opens the file.  Another thing is to teach these same editors not to overwrite the entire file while saving, and it would be possible to impose post-effects on such a font ... <br><div style="text-align:center;"><img src="https://habrastorage.org/files/3f9/42c/f28/3f942cf28ce74edbb7f30ed92006d0d8.png"></div><br></div></div><br>  No, the task is complicated.  The resulting file with Russian and Latin letters (plus special characters and numbers) took 135 kilobytes.  We remove Russian characters, reduce the physical size of the font itself, the image is halved in one dimension and, accordingly, doubled in size - 67 kilobytes.  But this is still no good, since in total with the ‚Äúempty‚Äù project it gives exactly 115 kilobytes. <br><br>  Now I realize that the most correct and simple step would be to simply take and generate a font right at launch, from the system font, the benefit of the ‚Äúcopy-paste‚Äù code is simple.  Moreover, in my previous framework, this is how fonts were generated - in runtime from system fonts or otf / ttf files. <br><br>  But the soul wanted romance, and the fifth point - torment.  And I remembered that Comrade <a href="http://habrahabr.ru/users/xproger/" class="user_link">XProger,</a> in the distant 2010, <a href="http://xproger.mentalx.org/archives/175">committed an act of violence</a> against the MiniLZO library, pulling its dump and wrapping it in simple asm instructions.  It looks like this, in the case of extraction: <br><br><pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lzo_decompress</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CData; CSize: LongInt; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">var</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Data; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">var</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Size: LongInt)</span></span></span><span class="hljs-function">:</span></span> LongInt; <span class="hljs-keyword"><span class="hljs-keyword">cdecl</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">asm</span></span> DB $<span class="hljs-number"><span class="hljs-number">51</span></span> DD $<span class="hljs-number"><span class="hljs-number">458</span></span>B5653,$C558B08,$F08BD003,$<span class="hljs-number"><span class="hljs-number">33</span></span>FC5589,$<span class="hljs-number"><span class="hljs-number">144</span></span>D8BD2,$<span class="hljs-number"><span class="hljs-number">68</span></span>A1189,$<span class="hljs-number"><span class="hljs-number">3</span></span>C10558B,$<span class="hljs-number"><span class="hljs-number">331</span></span>C7611,$<span class="hljs-number"><span class="hljs-number">83</span></span>C88AC9 DD $<span class="hljs-number"><span class="hljs-number">8346</span></span>EFC1,$<span class="hljs-number"><span class="hljs-number">820</span></span>F04F9,$<span class="hljs-number"><span class="hljs-number">1</span></span>C9,$<span class="hljs-number"><span class="hljs-number">8846068</span></span>A,$<span class="hljs-number"><span class="hljs-number">75494202</span></span>,$<span class="hljs-number"><span class="hljs-number">3366</span></span>EBF7,$<span class="hljs-number"><span class="hljs-number">460</span></span>E8AC9,$F10F983,$<span class="hljs-number"><span class="hljs-number">8</span></span>D83,$<span class="hljs-number"><span class="hljs-number">75</span></span>C98500,$<span class="hljs-number"><span class="hljs-number">8107</span></span>EB18 DD $FFC1,$<span class="hljs-number"><span class="hljs-number">3</span></span>E804600,$<span class="hljs-number"><span class="hljs-number">33</span></span>F47400,$<span class="hljs-number"><span class="hljs-number">83068</span></span>AC0,$C8030FC0,$<span class="hljs-number"><span class="hljs-number">83068</span></span>B46,$<span class="hljs-number"><span class="hljs-number">28904</span></span>C6,$<span class="hljs-number"><span class="hljs-number">4904</span></span>C283,$F9832F74,$<span class="hljs-number"><span class="hljs-number">8</span></span>B217204,$<span class="hljs-number"><span class="hljs-number">83028906</span></span> DD $C68304C2,$<span class="hljs-number"><span class="hljs-number">4</span></span>E98304,$<span class="hljs-number"><span class="hljs-number">7304</span></span>F983,$<span class="hljs-number"><span class="hljs-number">76</span></span>C985EE,$<span class="hljs-number"><span class="hljs-number">46068</span></span>A14,$<span class="hljs-number"><span class="hljs-number">49420288</span></span>,$<span class="hljs-number"><span class="hljs-number">9</span></span>EBF775,$<span class="hljs-number"><span class="hljs-number">8846068</span></span>A,$<span class="hljs-number"><span class="hljs-number">75494202</span></span>,$<span class="hljs-number"><span class="hljs-number">8</span></span>AC933F7 DD $F983460E,$C12B7310,$<span class="hljs-number"><span class="hljs-number">828</span></span>D02E9,$FFFFF7FF,$C933C12B,$C1460E8A,$C12B02E1,$<span class="hljs-number"><span class="hljs-number">8840088</span></span>A,$<span class="hljs-number"><span class="hljs-number">88</span></span>A420A,$<span class="hljs-number"><span class="hljs-number">420</span></span>A8840 DD $<span class="hljs-number"><span class="hljs-number">288008</span></span>A,$<span class="hljs-number"><span class="hljs-number">113</span></span>E942,$F9830000,$<span class="hljs-number"><span class="hljs-number">8</span></span>B207240,$FF428DD9,$<span class="hljs-number"><span class="hljs-number">8302</span></span>EBC1,$C32B07E3,$<span class="hljs-number"><span class="hljs-number">1</span></span>E8ADB33,$<span class="hljs-number"><span class="hljs-number">3</span></span>E3C146,$<span class="hljs-number"><span class="hljs-number">2</span></span>B05E9C1 DD $D9E949C3,$<span class="hljs-number"><span class="hljs-number">83000000</span></span>,$<span class="hljs-number"><span class="hljs-number">2</span></span>F7220F9,$<span class="hljs-number"><span class="hljs-number">851</span></span>FE183,$EB1875C9,$FFC18107,$<span class="hljs-number"><span class="hljs-number">46000000</span></span>,$<span class="hljs-number"><span class="hljs-number">74003</span></span>E80,$<span class="hljs-number"><span class="hljs-number">8</span></span>AC033F4,$<span class="hljs-number"><span class="hljs-number">1</span></span>FC08306 DD $F46C803,$FBC11EB7,$FF428D02,$C683C32B,$<span class="hljs-number"><span class="hljs-number">8369</span></span>EB02,$<span class="hljs-number"><span class="hljs-number">457210</span></span>F9,$D98BC28B,$C108E383,$C32B0BE3,$<span class="hljs-number"><span class="hljs-number">8507</span></span>E183 DD $EB1875C9,$FFC18107,$<span class="hljs-number"><span class="hljs-number">46000000</span></span>,$<span class="hljs-number"><span class="hljs-number">74003</span></span>E80,$<span class="hljs-number"><span class="hljs-number">8</span></span>ADB33F4,$<span class="hljs-number"><span class="hljs-number">7</span></span>C3831E,$F46CB03,$FBC11EB7,$<span class="hljs-number"><span class="hljs-number">83</span></span>C32B02,$D03B02C6 DD $<span class="hljs-number"><span class="hljs-number">9</span></span>A840F,$<span class="hljs-number"><span class="hljs-number">2</span></span>D0000,$EB000040,$<span class="hljs-number"><span class="hljs-number">2</span></span>E9C11F,$<span class="hljs-number"><span class="hljs-number">2</span></span>BFF428D,$<span class="hljs-number"><span class="hljs-number">8</span></span>AC933C1,$E1C1460E,$<span class="hljs-number"><span class="hljs-number">8</span></span>AC12B02,$A884008,$<span class="hljs-number"><span class="hljs-number">88008</span></span>A42 DD $<span class="hljs-number"><span class="hljs-number">51</span></span>EB4202,$<span class="hljs-number"><span class="hljs-number">7206</span></span>F983,$<span class="hljs-number"><span class="hljs-number">2</span></span>BDA8B37,$<span class="hljs-number"><span class="hljs-number">4</span></span>FB83D8,$<span class="hljs-number"><span class="hljs-number">188</span></span>B2E7C,$<span class="hljs-number"><span class="hljs-number">8904</span></span>C083,$<span class="hljs-number"><span class="hljs-number">4</span></span>C2831A,$<span class="hljs-number"><span class="hljs-number">8</span></span>B02E983,$<span class="hljs-number"><span class="hljs-number">831</span></span>A8918,$C08304C2 DD $<span class="hljs-number"><span class="hljs-number">4</span></span>E98304,$<span class="hljs-number"><span class="hljs-number">7304</span></span>F983,$<span class="hljs-number"><span class="hljs-number">76</span></span>C985EE,$<span class="hljs-number"><span class="hljs-number">40188</span></span>A20,$<span class="hljs-number"><span class="hljs-number">49421</span></span>A88,$<span class="hljs-number"><span class="hljs-number">15</span></span>EBF775,$<span class="hljs-number"><span class="hljs-number">8840188</span></span>A,$<span class="hljs-number"><span class="hljs-number">188</span></span>A421A,$<span class="hljs-number"><span class="hljs-number">421</span></span>A8840,$<span class="hljs-number"><span class="hljs-number">8840188</span></span>A DD $<span class="hljs-number"><span class="hljs-number">7549421</span></span>A,$<span class="hljs-number"><span class="hljs-number">8</span></span>AC933F7,$E183FE4E,$FC98503,$FFFE4284,$<span class="hljs-number"><span class="hljs-number">46068</span></span>AFF,$<span class="hljs-number"><span class="hljs-number">49420288</span></span>,$C933F775,$E9460E8A,$FFFFFECA DD $<span class="hljs-number"><span class="hljs-number">8</span></span>B10552B,$<span class="hljs-number"><span class="hljs-number">10891445</span></span>,$<span class="hljs-number"><span class="hljs-number">75</span></span>FC753B,$EBC03304,$FFF8B80D,$<span class="hljs-number"><span class="hljs-number">753</span></span>BFFFF,$<span class="hljs-number"><span class="hljs-number">830372</span></span>FC,$<span class="hljs-number"><span class="hljs-number">5</span></span>B5E04C0,$<span class="hljs-number"><span class="hljs-number">90</span></span>C35D59 <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  ... and a similar witch for proper compression.  This works fine (although I didn‚Äôt manage to start it right away), but I wouldn‚Äôt recommend this for a production code.  There is a slight inconvenience when debugging ... <br><br>  After compressing the font, we get 17 kilobytes instead of 67. <s>And we could have 2-3 kilobytes, if I just implemented the generation on the fly.</s>  . <br><div style="text-align:center;"><img src="https://habrastorage.org/files/e25/a72/dc4/e25a72dc4c9d4d1083e36ee01e27ac65.png"></div><br><br><h3>  Use uFMOD for audio output. </h3><br>  No one wants to play games without sounds or, at least, music.  Before this contest, I had experience with the bass library, however, I had to leave it behind - the necessary dll was eaten up as much as 97 kilobytes.  In the reporting theme of the competition, <a href="http://ufmod.sourceforge.net/">uFMOD was</a> mentioned - a miniature library for outputting xm music, written in assembler.  Looking ahead, I will say that its introduction to the project in the end had practically no effect on the size of the exe file. <br><br>  But there was one little nuance.  This library did not work on more or less modern versions of the FPC compiler (above 2.2.x).  And the problem lies in the <a href="http://mantis.freepascal.org/view.php%3Fid%3D20745">ambiguous behavior of the</a> linker.  I doubt that I can describe the technical aspects of this problem as faithfully as possible - in other words, why the external functions declared in the header file are not visible for the object file that is immediately attached.  This behavior remains on the conscience of compiler developers.  I will give an example of a ‚Äúbypass‚Äù of this behavior for one of the functions. <br><br>  It was like this: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waveOutClose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(hwo:Pointer)</span></span></span><span class="hljs-function">:</span></span>LongWord; <span class="hljs-keyword"><span class="hljs-keyword">stdcall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> <span class="hljs-string"><span class="hljs-string">'winmm.dll'</span></span>;</code> </pre><br>  And I had to wrap it like this: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">my_waveOutClose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(hwo:Pointer)</span></span></span><span class="hljs-function">:</span></span>LongWord; <span class="hljs-keyword"><span class="hljs-keyword">stdcall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> <span class="hljs-string"><span class="hljs-string">'winmm.dll'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-string"><span class="hljs-string">'waveOutClose'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> _</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waveOutClose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(hwo:Pointer)</span></span></span><span class="hljs-function">:</span></span>LongWord; <span class="hljs-keyword"><span class="hljs-keyword">stdcall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-string"><span class="hljs-string">'waveOutClose'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := my_waveOutClose(hwo); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br>  And so for a couple of dozen functions required by the library.  I will clarify that I took the implementation of uFMOD through winmm, as the most lightweight and easy to use.  Of the minuses of simplicity - it allowed to play only one stream at a time.  Thus, music appeared in my game, but I had to give up the sounds. <br><br>  Actually, I took the xm-track <a href="http://keygenmusic.net/">here</a> , after which the utility from uFMOD turned it into <a href="">such a</a> pas-file, which saved me a bit more space. <br><br><h3>  Texture generation </h3><br>  To paraphrase a classic - which demoscene project will do without generating textures?  Initially, I wanted to omit this topic - it was too easy and I made the generation of a whole (!) Texture ‚Äúhead on‚Äù.  But, perhaps, to someone from beginners the similar approach is useful. <br><br>  Almost all sprites in the game use the same texture: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/952/36f/636/95236f6368b84259bd8ce3b658b51f02.png"></div><br><br>  Just a striped texture with a ‚Äúborder‚Äù around for greater aesthetics.  Taking into account the color tint (that is, ‚Äúmultiplying‚Äù the desired color on such a texture) we get striped textures of any colors. <br><br>  I do not like the generation code at all, it is clearly possible to write it more optimally.  Moreover, there is a persistent feeling that the border is drawn incorrectly. <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TGame</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GenerateTexture</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(aWidth, aHeight, aBorderSize: Integer)</span></span></span><span class="hljs-function">:</span></span> TglrTexture; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m, m_origin: PByte; i, j: Integer; value: Byte; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> m := GetMemory(aWidth * aHeight * <span class="hljs-number"><span class="hljs-number">3</span></span>); m_origin := m; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> aHeight - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> aWidth - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i &lt; aBorderSize) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (j &lt; aBorderSize) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (i &gt; aWidth - aBorderSize - <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (j &gt; aHeight - aBorderSize - <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> value := <span class="hljs-number"><span class="hljs-number">196</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((i + j) <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>) &gt;= <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> value := <span class="hljs-number"><span class="hljs-number">255</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> value := <span class="hljs-number"><span class="hljs-number">196</span></span>; m^ := value; m+=<span class="hljs-number"><span class="hljs-number">1</span></span>; m^ := value; m+=<span class="hljs-number"><span class="hljs-number">1</span></span>; m^ := value; m+=<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; Result := TglrTexture.Create(m_origin, aWidth, aHeight, tfRGB8); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br>  For a change, the shade of red in enemies varies slightly with random (). <br><br><h3>  Annoying bug on NVidia </h3><br>  After submitting the work for the competition, the presenter collects an archive of the submitted works and puts it on public display.  The task of the participants is to arrange places for each other, except for themselves.  The assessment is given for three days, so you can relax after an emergency development.  But it was not there! <br><br>  But one by one, the contestants unsubscribe that my game works incorrectly for them - the player‚Äôs ‚Äútank‚Äù is not visible in principle, many enemy tanks are not visible, sometimes they flash.  Enemies can only be determined by the smoke from the exhaust pipe.  Such problems are manifested in all contestants on Nvidia video cards.  Moreover, one of the contestants has a configuration identical to mine, but my bug does not manifest at all.  Someone helped launch in compatibility mode with Windows 95 (!), But there were a few. <br><br>  I laid out different builds (which is slightly contrary to the rules of the contest), clearing all suspicious places in the code, advised different settings, but it was all in vain.  Finally, one of the participants, the most meticulous, for which many thanks to him (hello, pelmenka!), Discovered the reason - if you turn off threading optimization in the Nvidia control panel, the game works correctly.  It's a shame that I have turned off this setting since time immemorial, when it became the cause of BSOD in some games. <br><br>  Thanks to this valuable information, I was able to reproduce the bug in my room and start fixing it, although I already knew in my heart that most of the contestants had already voted, and in general, I‚Äôm angry Pinocchio to myself that I didn‚Äôt check the game on the Nvidia control panel . <br><br>  I will not long describe the process of finding solutions to problems.  I can only say that in the search process, I realized that: <br><br><ul><li>  Stream optimization brings more problems than benefits.  A simple search for ‚Äúnvidia threading optimization‚Äù provides links to game forums where it is strongly advised to disable this setting in order to avoid ‚Äúblinking‚Äù of games. </li><li>  There is no specification that explains what this optimization is doing at the driver level (or is there?) </li><li>  A number of themes from indie developers who complained about bugs when streaming optimization is enabled.  No answers except ‚Äújust turn it off, mate‚Äù </li></ul><br>  Finally, my attention was attracted by the topic in which they complained about the incorrect operation of the function glBufferSubData with the enabled Piece, Which Cannot Be Called.  This gave me a clue, and after a while (debugs, checks) I isolated the essence of the problem: <br><br>  The <a href="">glBufferSubData</a> function updates the data in the vertex buffer.  The main purpose of this function is to update the ‚Äúpiece‚Äù of the buffer, but it should also be used when it is necessary to update the entire buffer without reallocating the memory (my case). <br><br>  When streaming optimization is enabled, the NVidia driver, following only the slave features, sometimes (always?) Places the calls to this function in a separate thread and immediately returns control, which leads to a disastrous result.  How much data will have time to ‚Äúfill‚Äù in the buffer before drawing it goes - is unknown.  And Nvidia‚Äôs OpenGL driver doesn‚Äôt see a problem.  Ahead of your question, I will answer: no, the size of the transmitted data is negligible, a couple of kilobytes (especially compared to the bus bandwidth), so the matter is not in fatty data. <br><br>  The OpenGL specification does not tell us that this function can be run in a separate thread.  Personal initiative from the guys from Nvidia? <br><br>  In the case of a single use of glBufferSubData per frame, you will not notice anything, because the driver will "cache" the drawing of this buffer and call it, waiting for all the operations on this buffer to end (probably). <br><br>  And in my case, one buffer is used several times per frame.  I.e: <br><br><pre> <code class="delphi hljs">glBindBuffer(GL_ARRAY_BUFFER, BufferId); glBufferSubData(GL_ARRAY_BUFFER, <span class="hljs-number"><span class="hljs-number">0</span></span>, Size, Data); glDrawElements(...); glBindBuffer(GL_ARRAY_BUFFER, <span class="hljs-number"><span class="hljs-number">0</span></span>); ... glBindBuffer(GL_ARRAY_BUFFER, BufferId); glBufferSubData(GL_ARRAY_BUFFER, <span class="hljs-number"><span class="hljs-number">0</span></span>, OtherSize, OtherData); glDrawElements(...); glBindBuffer(GL_ARRAY_BUFFER, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><br>  And here you will feel stream optimization in all its glory.  What will be displayed on the screen determines the blind case. <br><br>  The glFinish () call helps, although this is a so-so solution.  Personally, I slightly changed the logic of updating data in the buffer to avoid such delicate situations. <br><br>  <b>Q:</b> Why not merge data and not draw at once? <br>  <b>A:</b> Between these calls there is a rendering of other elements, you cannot change the order of drawing. <br><br>  <b>Q:</b> Why not use different buffers? <br>  <b>A: The</b> data in the buffer is updated every frame. Keeping multiple buffers is a waste of resources. <br><br><h3>  Total </h3><br>  As a result, I received the fourth place in the competition, although I could easily compete for the second or third.  It was not the fact that I flew past the ‚Äútroika‚Äù of leaders, but rather the realization that I had ‚Äúruined‚Äù a fit game and 7 days of my work with one little nuisance, which caused disappointment. <br><br>  Short video gameplay: <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/tTLxLNT4OD4%3Ffeature%3Doembed&amp;xid=17259,15700002,15700022,15700186,15700191,15700253&amp;usg=ALkJrhigjPTfF018ysWYfhp1OOu8cbv4eg" frameborder="0" allowfullscreen=""></iframe><br><br>  The total release size was almost 80 kilobytes.  They include: <br><br><ul><li>  62.0 kb - exe </li><li>  17.3 kb - font </li><li>  0.52 kb - shaders </li></ul><br>  - <a href="">Download release</a> (all necessary sources are attached). <br>  - <a href="https://github.com/perfectdaemon/tiny-glr/tree/master/src/demos/shooter%25202D">Sources on github</a> </div><p>Source: <a href="https://habr.com/ru/post/244417/">https://habr.com/ru/post/244417/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../244397/index.html">Monetization of Oculus Rift and Leap motion in quests in reality</a></li>
<li><a href="../244405/index.html">Expressive JavaScript: Project: Platformer game</a></li>
<li><a href="../244407/index.html">We build robotboks with Wifi control, camera, gun, blackjack, etc.</a></li>
<li><a href="../244413/index.html">Update the app and get a comprehensive promotion package.</a></li>
<li><a href="../244415/index.html">Project Miranda NG receives the ‚ÄúWild Signs‚Äù award (part two)</a></li>
<li><a href="../244419/index.html">Productivity without slaps</a></li>
<li><a href="../244421/index.html">PHPStamp - fair generation of DOCX documents from a template</a></li>
<li><a href="../244423/index.html">Notifications based on the builder with custom layout and picture</a></li>
<li><a href="../244427/index.html">"Raspberry Eye" - webcam on the servo</a></li>
<li><a href="../244429/index.html">Black Friday gamification. How we made the game in 10 days</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>