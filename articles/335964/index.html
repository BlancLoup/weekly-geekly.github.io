<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How cloud service Drimkas Cabinet copes with spontaneous loads</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One afternoon, the site collapsed. Immediately after the reboot, he fell again. We knew that this was not DDOS, but organic traffic: we received typic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How cloud service Drimkas Cabinet copes with spontaneous loads</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/bw/th/jd/bwthjd700a4uh4huqnxk9txtkvg.jpeg" alt="image"><br><br><p>  One afternoon, the site collapsed.  Immediately after the reboot, he fell again.  We knew that this was not DDOS, but organic traffic: we received typical requests, but the servers did not cope.  The increase in iron power did not help.  It became clear that it was time to optimize our system. </p><br><p>  Young startups may be interested in how to cope with the increased workloads of the still weak server software. </p><a name="habracut"></a><br><h2>  Cabinet Drimkas - cloud service for the owner of the box office </h2><br>  In a previous post, I described how the Drimkas Cabinet uses WebHooks.  In this article I will focus on how the Cabinet appeared and what problems we had to solve as the service develops. <br><br> <a href="https://habrahabr.ru/company/dreamkas/blog/332798/"><img src="https://habrastorage.org/webt/br/qw/rc/brqwrctl9a9abalc06pct1vp62i.png" alt="Implement webcams to interact with third-party services with cloud services"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>  Drimkas produces online cash registers.  In 2016, a new version of the law on cash registers was adopted.  One of the main innovations is that each cash desk should send sales data to the tax in real time.  For us, this meant that now all cash registers had to be connected to the Internet in order to send checks to the FTS. </p><br><p>  Since our cash registers still send sales data, it seems logical to collect this data in the cloud so that the owner always has remote access to them.  So <a href="https://kabinet.dreamkas.ru/">Cabinet Drimkas</a> appeared. </p><br><h2>  How the Cabinet was arranged at the beginning </h2><br><p>  Started to implement.  The first idea is to create one logical server, to which all cash registers will directly contact - the developers have rejected. </p><br><p>  The difficulty is that we have several models of cash registers on Linux in the market, one on Windows 10 and fiscal registrars without any operating system at all.  There were other devices in the plans, but then nobody knew what they would work on.  This meant that you need to support different versions of protocols and data formats - the development of new features is overly complicated. </p><br><p>  We decided to create an intermediate node - ‚ÄúHub‚Äù, which will support different versions, cash register models, communication transports and even encodings, if necessary.  The site - ‚ÄúDrimkas Cabinet‚Äù - will receive normalized data and a generalized protocol for communicating with all devices. </p><br><img src="https://habrastorage.org/webt/el/oo/jv/eloojv9qhddwd5uxwf4ksem1b5w.png" alt="image"><br>  <sup>The hub normalizes data from different models of cash registers for the Cabinet.</sup>  <sup>External systems communicate with the Cabinet via API</sup> <br><br><p>  To test the hypothesis - do users need such a service at all?  - launched the first version.  We received feedback - we were asked for reports, uploading data to Excel, working with products, an open API for integrators.  The project turned out to be in demand, we released new features. </p><br>  The hub with the Cabinet communicated with standard HTTPS requests with a timeout of 5 seconds: <br><br><ul><li>  <b>Cash desks</b> sent to the Hub information about the opening / closing of the shift and new checks.  Once a minute they checked if there were any new tasks for them. </li><li>  <b>The hub</b> received tasks from the cash registers, kept them at home and once every 10 seconds a pack of 100 tasks sent to the Cabinet.  Received tasks from the Cabinet and sent them to the checkout when she again knocks on him. </li><li>  <b>The Cabinet</b> accepted and processed checks, shifts and sent changes to old goods and the creation of new ones at the box office. </li></ul><br><p>  If the Cabinet for any reason could not take at least one check from the pack, Hub assumed that not a single task was accepted, and sent the entire pack again, until the Cabinet reported on the successful acceptance of the entire pack. </p><br><p>  Checks are the hardest of all types of assignments.  You need to go through all the positions, create new products in Postgres, and then put the entire check in MongoDB.  Why the checks decided to be kept in Monga is a separate question, there are pros and cons.  This is especially true now, when there is a lot of data and you need to do complex samples with aggregations. </p><br><p>  So the system worked, while about two thousand cash desks were connected to the Cabinet, and the share of checks among the other tasks was no more than 15%. </p><br><h2>  When there were more users, we stopped coping with the loads. </h2><br><p>  It is interesting how the unstable Internet of our users reflected on us.  When the Internet disappears in stores, the cashier continues to sell, collecting checks.  As soon as the Internet appears, it sends all the data at once to both the CRF and the Hub.  The load on our servers jumped.  With the increase in the number of cash registers, a similar load chart became a real threat. </p><br><p>  We began to notice jerking by day that intensified over time.  Then the server just fell and could not rise, because it was immediately flooded with new tasks. </p><br><p>  The Hub had no problems - it added all the data to the database without heavy logic and sent it further.  The trouble was that a pack of tasks with a high percentage of checks can be processed longer than the timeout request for nginx.  This resulted in a 500 timeout from the Cabinet, and the Hub immediately tried to feed the same data again, although the Cabinet was still processing the previous ones.  As a result, the Hub just started the DOS Cabinet, until the latter falls. </p><br><p>  If we increase the timeout by nginx or decrease the number of tasks sent at once, we will get a small delay and in a month we will return to the same problem, but the scale of the consequences will increase.  There will be more connected cash registers, we will let more people down. </p><br><h2>  To avoid a crush, we organized a queue </h2><br><p>  If you look at the average statistics - the power of iron was enough.  There was little data available, and during the day, peak loads were followed by a decline.  It was necessary to smooth the load so as not to fall during the peaks. </p><br><p>  The solution is a queue of tasks, where you can add tasks at any intervals and jumps to process them as far as possible.  Since the problem was on the side of the Cabinet, we decided to screw it inside it.  RabbitMQ was chosen as a queue.  All tasks from the Hub one by one got there and the workers processed them. </p><br><p>  The idea turned out to be so successful that the Hub wanted to do the same at home, because we, too, sometimes could send a hundred thousand tasks at once.  So we decided to use rabbitMQ as a transport between the Hub and the Cabinet. </p><br><p> If earlier when saving goods on the site of the Hub lay, then we threw out the error "Repeat later."  Now the data will be saved in the database.  The task is placed in the queue much faster, because we do not wait for confirmation from the Hub, and he himself takes it as far as possible.  If suddenly the Cabinet has not finished processing the task, and the connection with the worker has been interrupted, this task will again appear in the queue.  All this Rabbit does out of the box, no error handling on our side is required. </p><br><p>  Having seen how cool it works, they decided to find out the upper limit of the strength of the transport and conducted load testing.  Office network resisted, but still fell.  And Rabbit just saved up all the tasks and waited for the workers to process them.  Hence the conclusion - the capacity of the rabbit is enough for us, the main thing is to give it a little SSD and more RAM. </p><br><h2>  Conclusion </h2><br><p>  It can not be considered that the initial communication through task bundles was incorrect.  In the early stages of development, the main resource is time.  If we thought about too distant future and optimized everything in advance, then the release could not be reached. </p><br><p>  Thus, the main thing is to understand in time that your service has outgrown the old solutions, and for stable operation and subsequent growth you need to slow down the development of new features and revise the architecture of the project. </p></div><p>Source: <a href="https://habr.com/ru/post/335964/">https://habr.com/ru/post/335964/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335952/index.html">Multiformat banners in Tinkoff.ru and the approach to the layout of responsive banners in Google AdWords</a></li>
<li><a href="../335954/index.html">ReactOS versus Windows XP SP3: the epic battle in 3DMark</a></li>
<li><a href="../335958/index.html">Implementation, analog and adaptation for ‚Äúpure‚Äù javascript JavaScript jQuery () functions; and adjacent to it</a></li>
<li><a href="../335960/index.html">Playfully bash'im</a></li>
<li><a href="../335962/index.html">Parametric modeling in CAD SolveSpace: "The ways of the Solver are inscrutable" or "Newton's Wormholes"</a></li>
<li><a href="../335966/index.html">Celesta and Flute: Creating Business Logic in the Java Ecosystem</a></li>
<li><a href="../335968/index.html">Cloning the Lode Runner game from the first PC in the USSR "BK-0010" plus a few words about the programming of games in the late 80s</a></li>
<li><a href="../335970/index.html">We break haks completely. We read machine codes as an open book.</a></li>
<li><a href="../335972/index.html">Game model of behavior in the market of two competing firms in Python</a></li>
<li><a href="../335974/index.html">Labyrinth generation by Eller algorithm in Unity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>