<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bezamochnye algorithms: model "make, write, (try again)"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The atomic multiplication we implemented last time is an example of a more general model, which Raymond called ‚Äúmake, write, (try again)‚Äù. 



 for (;...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bezamochnye algorithms: model "make, write, (try again)"</h1><div class="post__text post__text-html js-mediator-article">  The atomic multiplication we implemented <a href="http://habrahabr.ru/blogs/system_programming/118390/">last time</a> is an example of a more general model, which Raymond called ‚Äúmake, write, (try again)‚Äù. <br><br><pre> for (;;) {
  // take the initial value of the shared variable
  // which we are going to change
  oldValue = sharedVariable;

  ... take the initial values ‚Äã‚Äãof other parameters ...

  newValue = ... calculate the new value using
                 oldValue and copies of other parameters ...

  // instead of xxx can be Acquire, Release, or nothing
  if (InterlockedCompareExchangeXxx (
             &amp; sharedVariable,
             newValue, oldValue) == oldValue) {
   break;  // write failed
  }

  ... delete newValue ...

 } // try again
</pre><br>  We calculate a new value, and then by calling <code>InterlockedCompareExchange</code> write it to a common variable <i>only if its value has not changed.</i>  If it has changed, then another stream has preceded us;  in this case, we will try to perform the operation in a new way, from the very beginning, in the hope that next time no one will ‚Äúcut off‚Äù us. <br><a name="habracut"></a><br>  It is important to understand that the ‚Äúmake, write, try again‚Äù model does not guarantee that the stream that first started updating the variable value will win the ‚Äúrace‚Äù first.  The ‚Äúunsuccessful‚Äù stream may, at each attempt, again and again yield to faster rivals;  it is theoretically possible that he <i>will</i> never complete the operation initiated (but each of the streams that overtake him will complete his own).  This feature is typical for lockless algorithms - unlike locks, which, as a rule, implement the waiting queue: the first one came - the first one passed. <br><br>  The translator dared to come up with his own analogy: the ticket office at McDonalds is a castle, behind which a line of waiting customers lined up.  If the customer standing at the cash register‚Äôs time rummaging through his pockets in search of small things, then the other customers and the cashier are wasting their time waiting;  the system as a whole is idle.  On the other hand, the waiter in the restaurant is a non-stop resource.  Every client calls him to pay for lunch;  but another customer can ‚Äúmeet‚Äù and intercept the waiter on the way.  It is not known how many times the waiter will be distracted until he finally reaches your table;  but on the other hand, if he doesn‚Äôt approach you, then now he is serving someone else.  In general, the system is not idle. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <hr><br>  The <code>InterlockedMultiply</code> function from the previous post corresponds to the pattern given here almost verbatim: ‚Äúanother parameter‚Äù is a multiplier passed to the function parameter;  ‚ÄúNew meaning‚Äù is a work.  If the entry of a new value failed, then someone else changed it, and we start the operation again. <br><br>  The initialization of static variables in the past post also corresponds to the model ‚Äúmake, write, (try again)‚Äù, just the stage ‚Äútry again‚Äù is optimized: we know that its result would be the same values ‚Äã‚Äãthat were already written to common variables by the stream overtaking;  therefore, this stage can not be performed.  In the case of variable initialization, <code>InterlockedCompareExchange</code> used in the Release version, because the new value is valid only with other data in memory (only with <code>a</code> ), and should be recorded only after them. <br><br>  Another ‚Äúoptimized‚Äù version of the model is ‚Äúmake, write, (drop it)‚Äù.  There is also no cycle in it: if the entry of a new value fails, the function considers the failure fatal, and refrains from further attempts.  This is how, for example, <code>TryEnterCriticalSection</code> .  It uses <code>InterlockedCompareExchangeAcquire</code> : changes made from within the critical section should not be written into memory before it is written that the section is busy. <br><br>  If the common variable is not a number, but a pointer, then you need to take care that the already mentioned ‚ÄúABA problem‚Äù does not arise when the same pointer points to a new object.  Initialization of static objects does not require additional difficulties: the pointer can change only from NULL to <i>something</i> , and once it has become non-NULL, the pointer no longer changes.  If the pointer can change arbitrarily, then, as a rule, this pointer and the ‚Äúversion number‚Äù are combined in a common variable, which increases with each pointer change. <br><br>  In the following example of using the model ‚Äúmake, write, (try again)‚Äù, the version number will be stored in a common variable.  To begin with, two auxiliary functions: <br><br><pre> LONG InterlockedReadAcquire (__ in LONG * pl, __in LONG lUnlikely)
 {
   return InterlockedCompareExchangeAcquire (pl, lUnlikely, lUnlikely);
 }

 LONG InterlockedReadRelease (__ in LONG * pl, __in LONG lUnlikely)
 {
   return InterlockedCompareExchangeRelease (pl, lUnlikely, lUnlikely);
 }
</pre><br>  Unlike reading LONG variables directly, these functions impose restrictions on the order of writing to memory.  Since the compared and the new value in the <code>InterlockedCompareExchange</code> operation coincide, the value to be tested does not change for any outcome of the operation.  Actions performed are similar to code: <br><pre> if (* pl == lUnlikely) * pl = lUnlikely;
</pre><br>  As <code>lUnlikely</code> Raymond advises choosing an unlikely value so that in most cases the assignment is not performed and the cache block is not ‚Äúdirty‚Äù.  (Not on all processors this helps prevent writing to memory, but such cunning will not be superfluous.) <br><br>  So, our example: <br><br><pre> LONG g_lColorChange;  // version number of colors

 ...
 case WM_SYSCOLORCHANGE:
  InterlockedIncrement (&amp; g_lColorChange);
  ...

 int CalculateSomethingAboutSystemColors ()
 {
  LONG lColorChangeStart;
  do {
   lColorChangeStart = InterlockedReadAcquire (&amp; g_lColorChange, -1);
   COLORREF clrWindow = GetSysColor (COLOR_WINDOW);
   COLORREF clrHighlight = GetSysColor (COLOR_HIGHLIGHT);
   ... other calculations using GetSysColor (...)
  } while (InterlockedReadRelease (
                        &amp; g_lColorChange, -1)! = lColorChangeStart);
  return iResult;
 }
</pre><br>  We take the old value of the version number, and begin our calculations.  We take it with an Acquire operation, so the read version number is written into memory before the color values ‚Äã‚Äãthat we use for calculations. <br>  When the calculations are completed, we compare the current version number with the saved one.  If they do not match, then the colors have changed in the course of our calculations, so they will have to be redone. <br>  The ABA problem is possible if the colors during the calculations have changed four billion times: because of the overflow of the counter, we will not notice.  It is clear that in reality this is unlikely to happen. </div><p>Source: <a href="https://habr.com/ru/post/118466/">https://habr.com/ru/post/118466/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../118459/index.html">Create an application for Windows Phone 7 from start to finish. Part 13. Application recovery after decontamination</a></li>
<li><a href="../118460/index.html">How to raise server for python scripts in 1 minute</a></li>
<li><a href="../118461/index.html">Create an application for Windows Phone 7 from start to finish. Part 14. Validation of input data.</a></li>
<li><a href="../118462/index.html">Create an application for Windows Phone 7 from start to finish. Part 15. Access to photos on Windows Phone</a></li>
<li><a href="../118465/index.html">Presented by the official LiveJournal application for Android</a></li>
<li><a href="../118468/index.html">User profiles: pros, cons, pitfalls</a></li>
<li><a href="../118470/index.html">AlterRussia.ru or "If I were president"!</a></li>
<li><a href="../118472/index.html">An interesting feature of Grub2: loading from ISO file</a></li>
<li><a href="../118474/index.html">St. Petersburg radio market Juno</a></li>
<li><a href="../118475/index.html">How to become a system administrator - a guide for beginners (Part 1)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>