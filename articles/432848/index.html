<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Gocritic's journey into the past</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share the results of the work of the last few days, which included an analysis of the git history of some large Go projects with the aim of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Gocritic's journey into the past</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/de/ui/zg/deuizg9w3z_5h9mc9him0m50a3e.png"></p><br><p>  I want to share the results of the work of the last few days, which included an analysis of the <a href="https://git-scm.com/">git</a> history of some large <a href="https://golang.org/">Go</a> projects with the aim of finding commits, which corrected errors and then formalized them for detection if they appeared in the new code. </p><br><p>  In the second part of the article, we will look at some new diagnostics in the <a href="https://github.com/go-critic/go-critic/">go-critic</a> , which allow us to find code that is highly error-prone. </p><a name="habracut"></a><br><h1 id="poisk-idey-v-proshlom">  Search for ideas in the past </h1><br><p>  To find ideas for new code inspections, you can pry into static analyzers for other programming languages, you can manually explore open source code with an attempt to find erroneous code templates in it, or you can look into history. </p><br><p> Suppose you are testing a <code>Go-Files</code> project.  After launching the linter (static analyzer) the problems are not found, the audit of the source texts also did not bring much results.  Should I hurry to put <code>Go-Files</code> aside?  Not really. </p><br><p>  During the existence of the <code>Go-Files</code> had some number of easily detected defects, but now they have already been fixed.  What we need to do is start analyzing the git repository history. </p><br><p><img src="https://habrastorage.org/webt/jh/mn/nb/jhmnnbbrjp-yrbpqsklp25md5ju.png"></p><br><p>  Bugs somewhere nearby. </p><br><h1 id="sbor-interesuyuschih-nas-kommitov">  Collecting commits of interest </h1><br><p>  <strong>Problems:</strong> </p><br><ul><li>  There can be a lot of commits. </li><li>  Sometimes unrelated things are performed in the same audit. </li><li>  Sometimes a comment on a commit does not quite match the actual changes. </li><li>  Some people underestimate the benefits of a good commit message (we will not point the finger) </li></ul><br><p>  First of all, we want to reduce the amount of information that will have to be processed without automation.  The problem of false-negative responses can be solved by increasing the sample size (download more Go packets to the control group). </p><br><p>  You can analyze it in different ways, it was enough for me to " <code>git log --grep</code> " on a set of templates, with overstatement and understating of the weight (score) of the commit depending on the content of its commit message.  If the commit is too huge, you can immediately drop it, because it is very likely to figure out what is happening there will be nontrivial. </p><br><p>  I would also like to add that, along with corrections or finding errors, quite often there are not very optimistic and sometimes not quite cultural descriptions of patches: </p><br><pre> <code class="plaintext hljs">- "We check length later, but we assumed it was always 1 bytes long. Not always the case. I'm a little depressed that this bug was there" - "Really fixed the bug now" - "WTF, the changes that actually fixed the bug for the accesspattern wasn't actually committed" - "how do i pronounce this damn project" ( traefic) - "damnit travis" - "one f*cking dot" (./.. =&gt; ./...  .travis.yml)</code> </pre> <br><p>  The most useless "bug fixes" are editing syntax errors or other problems that prevent the project from even <code>go build</code> through the <code>go build</code> .  Not all projects use <a href="https://en.wikipedia.org/wiki/Continuous_integration">CI</a> or <a href="https://xakep.ru/2016/02/11/git-hook-magic/">pre-commit hooks</a> , so such broken revisions sometimes fall into the master branch. </p><br><h1 id="istoricheskie-oshibki">  Historical errors </h1><br><p>  Let's go over some of the most interesting bugs that were found under a blanket of git logs. </p><br><h2 id="vozvrat-nil-vmesto-realnogo-rezultata">  Return nil instead of the actual result </h2><br><p>  <a href="https://github.com/gin-gonic/gin/commit/5636afe02d00308bc5ade9dd80acfa7646b608df">gin-gonic / gin: fix bug, return err when failed binding bool</a> : </p><br><pre> <code class="diff hljs"> if err == nil { field.SetBool(boolVal) } - return nil + return err }</code> </pre> <br><p>  <a href="https://github.com/go-pg/pg/commit/c10d76d6a679e5f4b61c17ebdaf710ffa5921e8f">go-pg / pg: AppendParam bug fix</a> : </p><br><pre> <code class="diff hljs"> return method.AppendValue(b, m.strct.Addr(), 1), true } - return nil, false + return b, false }</code> </pre> <br><h2 id="otsutstvie-return-v-fast-path">  Absence of return in the fast path </h2><br><p>  <a href="https://github.com/gonum/gonum/commit/f142409d829436e33dc8ec4463928537e4e627a4">gonum / gonum: fixed bug in dswap fast path</a> : </p><br><pre> <code class="diff hljs"> for i := 0; i &lt; n; i++ { x[i], y[i] = y[i], x[i] } + return }</code> </pre> <br><h2 id="zapusk-gorutiny-bez-wgadd1">  Run gorutiny without wg.Add (1) </h2><br><p>  <a href="https://github.com/btcsuite/btcd/commit/bd98836a2b7525c93e7b3b60d9732e13c28e36eb">btcsuite / btcd: Fix several bugs in the RPC server shutdown</a> : </p><br><pre> <code class="diff hljs"><span class="hljs-addition"><span class="hljs-addition">+s.wg.Add(1) go s.walletListenerDuplicator()</span></span></code> </pre> <br><h2 id="nekorrektnoe-logicheskoe-uslovie">  Incorrect logical condition </h2><br><p>  <a href="https://github.com/gorgonia/gorgonia/commit/eb7da5862b1ba302bbb54d0ac580a752c59a308d">gorgonia / gorgonia: fixed a few bugs as well</a> : </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-for i := 0; i &gt; start; i++ { +for i := 0; i &lt; start; i++ { retVal[i] = 0 }</span></span></code> </pre> <br><p>  <a href="https://github.com/src-d/go-git/commit/7418b411660aaa3d8d54eb602fda8accaed2833f">src-d / go-git: plumbing / idxfile: fix bug searching in MemoryIndex</a> : </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-if low &lt; high { +if low &gt; high { break }</span></span></code> </pre> <br><p>  <a href="https://github.com/go-xorm/xorm/commit/6b6721cccc0015ea5275fdb3ae233872e1f654df">go-xorm / xorm: fix bug on sum</a> : </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-if !strings.Contains(colName, " ") &amp;&amp; strings.Contains(colName, "(") { +if !strings.Contains(colName, " ") &amp;&amp; !strings.Contains(colName, "(") {</span></span></code> </pre> <br><p>  <a href="https://github.com/btcsuite/btcd/commit/0734b553631c3e59d438c6acc1a8d00b22d385fd">btcsuite / btcd: server: Fix bug disconnecting peer on filteradd</a> : </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-if sp.filter.IsLoaded() { +if !sp.filter.IsLoaded() {</span></span></code> </pre> <br><p>  <a href="https://github.com/btcsuite/btcd/commit/bac455cdd2326897b3e56539081cdd19212504e9">btcsuite / btcd: Fix reversed test bug with the max operations handling</a> : </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-if pop.opcode.value &lt; OP_16 { +if pop.opcode.value &gt; OP_16 { s.numOps++</span></span></code> </pre> <br><h2 id="obnovlenie-receivera-thisself-peredavaemogo-po-znacheniyu">  Update the receiver (this / self) transmitted by value </h2><br><p>  Classic.  Inside the method, a copy of the object is modified, which is why the caller will not see the expected results. </p><br><p>  <a href="https://github.com/gonum/gonum/commit/a342f2e9ed5637e064c03741ed13ea5e1f7015ff">Fixed a stack / queue / deque bug (pointer receiver)</a> : </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-func (s Stack) Push(x interface{}) { - s = append(s, x) +func (s *Stack) Push(x interface{}) { + *s = append(*s, x) }</span></span></code> </pre> <br><h2 id="obnovlenie-kopiy-obektov-vnutri-cikla">  Updating copies of objects within a loop </h2><br><p>  <a href="https://github.com/containous/traefik/commit/3174fb88613c1b7841f89995e5cf3ee2a85b3011">containous / traefik: Assign filtered tasks to apps contained in slice</a> : </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-for _, app := range filteredApps { - app.Tasks = fun.Filter(func(task *marathon.Task) bool { +for i, app := range filteredApps { + filteredApps[i].Tasks = fun.Filter(func(task *marathon.Task) bool { return p.taskFilter(*task, app) }, app.Tasks).([]*marathon.Task)</span></span></code> </pre> <br><p>  <a href="https://github.com/containous/traefik/commit/2f06f339eca65568a4bfe50262090cef953e8064">containous / traefik: Add unit tests for package safe</a> : </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-for _, routine := range p.routines { +for i := range p.routines { p.waitGroup.Add(1) - routine.stop = make(chan bool, 1) + p.routines[i].stop = make(chan bool, 1) Go(func() { - routine.goroutine(routine.stop) + p.routines[i].goroutine(p.routines[i].stop) p.waitGroup.Done() }) }</span></span></code> </pre> <br><h2 id="rezultat-oborachivayuschey-funkcii-ne-ispolzuetsya">  The result of the wrapping function is not used. </h2><br><p>  <a href="https://github.com/gorgonia/gorgonia/commit/7b264e55887f4c1dc0871a5e8db8aca7bb32441a">gorgonia / gorgonia: Fixed a tiny nonconsequential bug in Grad ()</a> : </p><br><pre> <code class="diff hljs">if !n.isInput() { - errors.Wrapf(err, ...) - // return + err = errors.Wrapf(err, ...) + return nil, err }</code> </pre> <br><h2 id="nepravilnaya-rabota-s-make">  Wrong work with make </h2><br><p>  Sometimes young gophers make " <code>make([]T, count)</code> " followed by <code>append</code> inside the loop.  The correct option here is " <code>make([]T, 0, count)</code> ". </p><br><p>  <a href="https://github.com/HouzuoGuo/tiedot/commit/3af35e191cd3a944ceb0a1abdc47923d11111144">HouzuoGuo / tiedot: fix a collection scan bug</a> : </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-ids := make([]uint64, benchSize) +ids := make([]uint64, 0)</span></span></code> </pre> <br><p>  The correction above corrects the original error, but has one flaw that was corrected in one of the following commits: </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-ids := make([]uint64, 0) +ids := make([]uint64, 0, benchSize)</span></span></code> </pre> <br><p>  But some operations, such as <code>copy</code> or <code>ScanSlice</code> may require the "correct" length. </p><br><p>  <a href="https://github.com/go-xorm/xorm/commit/2cadda5fe5e472658c47d23d2e3c07672b873284">go-xorm / xorm: bug fix for SumsInt return empty slice</a> : </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-var res = make([]int64, 0, len(columnNames)) +var res = make([]int64, len(columnNames), len(columnNames)) if session.IsAutoCommit { err = session.DB().QueryRow(sqlStr, args...).ScanSlice(&amp;res) } else {</span></span></code> </pre> <br><p>  Soon <a href="https://github.com/go-critic/go-critic">go-critic</a> will help in finding errors of this class. </p><br><h2 id="ostalnye-oshibki">  The remaining errors </h2><br><p>  The listing turns out to be rather cumbersome, the rest of which I carry under the spoiler.  This part is optional, so you can leave it for later or safely move on. </p><br><div class="spoiler">  <b class="spoiler_title">I want more!</b> <div class="spoiler_text"><hr><br><p>  The following fragment is interesting in that although it corrects the error, the iterated key is named with the same name that was used for the iterated value.  The new code does not look correct and may confuse the next programmer. </p><br><p>  <a href="https://github.com/gonum/gonum/commit/62ea9c8bfdc284d53170a37303e9f0c0e359673f">gonum / gonum: Fixed bug in subset functions</a> : </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-for _, el := range *s1 { +for el := range *s1 { if _, ok := (*s2)[el]; !ok { return false }</span></span></code> </pre> <br><p>  Named results are practically the same ordinary variables, so they are initialized by the same rules.  Pointers will have the value <code>nil</code> and if you need to work with this object, you must explicitly initialize this pointer (for example, using <code>new</code> ). </p><br><p>  <a href="https://github.com/dgraph-io/dgraph/commit/33f936dd18cee4b2359e2966d6f8c1acf34cd8c7">dgraph-io / dgraph: fixing nil pointer reference bug in server / main.go</a> : </p><br><pre> <code class="diff hljs">func (s *server) Query(ctx context.Context, - req *graph.Request) (resp *graph.Response, err error) { + req *graph.Request) (*graph.Response, error) { + resp := new(graph.Response)</code> </pre> <br><p>  More often and most <a href="https://www.google.com/search%3Fq%3Dgolang%2Bshadowing">shadowing</a> bites when dealing with errors. </p><br><p>  <a href="https://github.com/btcsuite/btcd/commit/be191ca111b494bb1ccdbeb7295723ee56949d07">btcsuite / btcd: blockchain / indexers: fix bug in indexer re-org catch up</a> : </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-block, err := btcutil.NewBlockFromBytes(blockBytes) +block, err = btcutil.NewBlockFromBytes(blockBytes) if err != nil { return err }</span></span></code> </pre> <br><p>  <a href="https://github.com/go-xorm/xorm/commit/a9eb28a00e4b93817906eac5c8af2a566e8c73af">go-xorm / xorm: fix insert err bug</a> : </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-err = session.Rollback() +err1 := session.Rollback() +if err1 == nil { + return lastId, err +} +err = err1</span></span></code> </pre> <br><p>  <a href="https://github.com/gin-gonic/gin/commit/44f024a413c9afc57970740a5fe3b6b6597bfe75">gin-gonic / gin: Fixed newline problem with debugPrint in Run * functions</a> : </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-debugPrint("Listening and serving HTTP on %s", addr) +debugPrint("Listening and serving HTTP on %s\n", addr)</span></span></code> </pre> <br><p>  The introduction of the mutex in the example below led me to the idea of ‚Äã‚Äãwriting a validation check that reports the use of <code>*sync.Mutex</code> as a member of the structure.  Dave Cheney recommends that you <a href="https://twitter.com/davecheney/status/743289114980548612">always use the mutex value</a> , not the pointer to it. </p><br><p>  <a href="https://github.com/tealeg/xlsx/commit/dacfeea7a608cbaa21da22bd608441c207b53d70">tealeg / xlsx: fix bug when loading spreads</a> : </p><br><pre> <code class="diff hljs"> styleCache map[int]*Style `-` + lock *sync.RWMutex }</code> </pre> <br><hr></div></div><br><h1 id="krestovyy-pohod-protiv-podozritelnogo-koda">  Crusade against suspicious code </h1><br><h2 id="badcond">  badCond </h2><br><p>  The <code>badCond</code> check finds potentially incorrect logical expressions. </p><br><p>  Examples of suspicious logical expressions: </p><br><ul><li>  The result is always <code>true</code> or <code>false</code> </li><li>  The expression is written in a form that is almost indistinguishable from the erroneous </li></ul><br><p>  This check also works on operations like " <code>x == nil &amp;&amp; x == y</code> ".  One simple solution is to rewrite to " <code>x == nil &amp;&amp; y == nil</code> ".  The readability of the code does not suffer, but the linter will not see anything suspicious in this code. </p><br><p>  Here is an example of fixing a bug that can be found <code>badCond</code> : </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-if err1 := f(); err != nil &amp;&amp; err == nil { +if err1 := f(); err1 != nil &amp;&amp; err == nil { err = err1 }</span></span></code> </pre> <br><p>  <strong>Trophies:</strong> </p><br><ul><li>  <a href="https://github.com/moby/buildkit/pull/747">moby / buildkit: snapshot: fix impossible condition</a> </li><li>  <a href="https://github.com/tdewolff/parse/issues/46">tdewolff / parse: EqualFold from util.go has weird condition</a> </li><li>  <a href="https://github.com/HouzuoGuo/tiedot/issues/164">HouzuoGuo / tiedot: httpapi: suspicious condition in srv_test.go</a> </li></ul><br><h2 id="weakcond">  weakCond </h2><br><p>  <code>weakCond</code> is similar to <code>badCond</code> , but the confidence level of warnings is somewhat lower. </p><br><p>  A weak condition is a condition that does not sufficiently cover the input data. </p><br><p>  A good example of a weak (insufficient) condition is to check a slice for <code>nil</code> with the subsequent use of the first element.  The " <code>s != nil</code> " conditions are not enough.  The correct condition is " <code>len(s) != 0</code> " or its equivalent: </p><br><pre> <code class="diff hljs">func addRequiredHeadersToRedirectedRequests( req *http.Request, via []*http.Request) error { - if via != nil &amp;&amp; via[0] != nil { + if len(via) != 0 &amp;&amp; via[0] != nil {</code> </pre> <br><p>  <strong>Trophies:</strong> </p><br><ul><li>  <a href="https://github.com/etcd-io/etcd/issues/10315">etcd-io / etcd: etcdserver / api / v2v3: indexing after nil check without len ‚Äã‚Äãcheck</a> </li><li>  <a href="https://github.com/moby/moby/issues/38347">moby / moby: registry: indexing after nil check without len ‚Äã‚Äãcheck</a> </li><li>  <a href="https://github.com/inkyblackness/hacked/issues/52">inkyblackness / hacked: ss1 / content / text: indexing after nil check without len ‚Äã‚Äãcheck</a> </li></ul><br><h2 id="duparg">  dupArg </h2><br><p>  For some functions, passing the same value (or variable) as several arguments does not make much sense.  Quite often this signals a <a href="https://www.viva64.com/en/t/0068/">copy / paste</a> error. </p><br><p>  An example of such a function is <code>copy</code> .  The expression <code>copy(xs, xs)</code> does not make sense. </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-if !bytes.Equal(i2.Value, i2.Value) { +if !bytes.Equal(i1.Value, i2.Value) { return fmt.Errorf("tries differ at key %x", i1.Key) }</span></span></code> </pre> <br><p>  <strong>Trophies:</strong> </p><br><ul><li>  <a href="https://github.com/ethereum/go-ethereum/pull/18269">ethereum / go-ethereum: light: fix duplicated argument in bytes.Equal call</a> </li><li>  <a href="https://github.com/openshift/origin/pull/21640">openshift / origin: fix reflect.DeepEqual (x, x) bug</a> </li></ul><br><h2 id="dupcase">  dupCase </h2><br><p>  You probably know that in Go you cannot use duplicate <code>case</code> values ‚Äã‚Äãinside a <code>switch</code> . </p><br><p>  The example below <a href="https://play.golang.org/p/imRt9SsnZ7P">does not compile</a> : </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> x := <span class="hljs-number"><span class="hljs-number">0</span></span>; x { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: fmt.Println(<span class="hljs-string"><span class="hljs-string">"first"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: fmt.Println(<span class="hljs-string"><span class="hljs-string">"second"</span></span>) }</code> </pre> <br><blockquote>  Compile error: duplicate case 1 in switch. </blockquote><p>  But what if you take the <a href="https://play.golang.org/p/8hUHft5Ac8-">example more interesting</a> : </p><br><pre> <code class="go hljs">one := <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> x := <span class="hljs-number"><span class="hljs-number">1</span></span>; x { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> one: fmt.Println(<span class="hljs-string"><span class="hljs-string">"first"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> one: fmt.Println(<span class="hljs-string"><span class="hljs-string">"second"</span></span>) }</code> </pre> <br><p>  Through the variable to use duplicate values ‚Äã‚Äãare allowed.  In addition, the <code>switch true</code> gives even more room for errors: </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> x := <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-literal"><span class="hljs-literal">true</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> x == <span class="hljs-number"><span class="hljs-number">1</span></span>: fmt.Println(<span class="hljs-string"><span class="hljs-string">"first"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> x == <span class="hljs-number"><span class="hljs-number">1</span></span>: fmt.Println(<span class="hljs-string"><span class="hljs-string">"second"</span></span>) }</code> </pre> <br><p>  Here is an example of correcting a real error: </p><br><pre> <code class="diff hljs">switch { case m &lt; n: // Upper triangular matrix. //   . case m == n: // Diagonal matrix. //   . -case m &lt; n: // Lower triangular matrix. +case m &gt; n: // Lower triangular matrix. //   . }</code> </pre> <br><p>  <strong>Trophies:</strong> </p><br><ul><li>  <a href="https://github.com/mellium/sasl/pull/2">mellium / sasl: remove duplicated switch case</a> </li><li>  <a href="https://github.com/gonum/gonum/pull/758">gonum / gonum: fix duplicated switch case</a> </li><li>  <a href="https://github.com/pact-foundation/pact-go/pull/104">pact-foundation / pact-go: remove duplicated switch case</a> </li><li>  <a href="https://github.com/minio/minio/issues/6948">minio / minio: suspicious duplicated switch case clause in cmd / object-api-error.go</a> </li><li>  <a href="https://github.com/henrylee2cn/pholcus/pull/101">henrylee2cn / pholcus: common / bytes: remove duplicated switch case</a> </li><li>  <a href="https://github.com/go-ble/ble/pull/39">go-ble / ble: linux / att: fix duplicated switch case error</a> </li><li>  <a href="https://github.com/docker/distribution/pull/2785">docker / distribution: registry / storage: fix duplicated switch case</a> </li></ul><br><h2 id="dupbranchbody">  dupBranchBody </h2><br><p>  In conditional statements such as <code>if/else</code> and <code>switch</code> there are bodies for execution.  When the condition is fulfilled, control is transferred to the associated block of operations.  While other diagnostics check that the conditions of these blocks are different, <code>dupBranchBody</code> checks that the executable blocks themselves are not completely identical. </p><br><p>  The presence of duplicate bodies within conditional statements, unless it is a <code>type switch</code> , is at least suspicious. </p><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-if s, err := r.ReceivePack(context.Background(), req); err != nil { - return s, err -} else { - return s, err -} +return r.ReceivePack(context.Background(), req)</span></span></code> </pre> <br><p>  The judgments about the degree of correctness of the code below are left to the readers: </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> field.IsMessage() || p.IsGroup(field) { <span class="hljs-comment"><span class="hljs-comment">//   . } else if field.IsString() { if nullable &amp;&amp; !proto3 { p.generateNullableField(fieldname, verbose) } else { pP(`if this.`, fieldname, ` != that1.`, fieldname, `{`) } } else { if nullable &amp;&amp; !proto3 { p.generateNullableField(fieldname, verbose) } else { pP(`if this.`, fieldname, ` != that1.`, fieldname, `{`) } } }</span></span></code> </pre> <br><p>  The bodies inside " <code>if field.IsString()</code> " and its associated " <code>else</code> " are identical. </p><br><p>  <strong>Trophies:</strong> </p><br><ul><li>  <a href="https://github.com/src-d/go-git/issues/1035">src-d / go-git: Suspicious duplicated branch bodies</a> </li></ul><br><h2 id="caseorder">  caseOrder </h2><br><p>  All types inside the <code>type switch</code> iterated sequentially to the first compatible one.  If the tag value is of type <code>*T</code> , and implements interface <code>I</code> , then you need <em>to</em> put a label with " <code>case *T</code> " <em>up to the</em> label with " <code>case I</code> ", otherwise only " <code>case I</code> " will be executed, since <code>*T</code> compatible with <code>I</code> (but not the other way around). </p><br><pre> <code class="diff hljs">case string: res = append(res, NewTargetExpr(v).toExpr().(*expr)) -case Expr: - res = append(res, v.toExpr().(*expr)) case *expr: res = append(res, v) +case Expr: + res = append(res, v.toExpr().(*expr))</code> </pre> <br><p>  <strong>Trophies:</strong> </p><br><ul><li>  <a href="https://go-review.googlesource.com/c/tools/%2B/153397">cmd / guru: fix incorrect order order in describe.go</a> </li><li>  <a href="https://go-review.googlesource.com/c/text/%2B/153399">message / pipeline: fix type switch case order</a> </li><li>  <a href="https://github.com/coyove/goflyway/pull/129">coyove / goflyway: proxy: fix case order in a type switch</a> </li><li>  <a href="https://github.com/go-graphite/carbonapi/pull/381">go-graphite / carbonapi: pkg / parser: fix type switch case order</a> </li></ul><br><h2 id="offby1">  offBy1 </h2><br><p>  Error on the unit is so popular that it even has <a href="https://en.wikipedia.org/wiki/Off-by-one_error">its own page on Wikipedia</a> . </p><br><pre> <code class="diff hljs">if len(optArgs) &gt; 1 { return nil, ErrTooManyOptArgs } -node = optArgs[1] +node = optArgs[0]</code> </pre> <br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-last := xs[len(xs)] +last := xs[len(xs) - 1]</span></span></code> </pre> <br><p>  There are limited possibilities to find such errors in the <code>go-critic</code> , but so far no corrections have been sent to the public repository.  Here are some corrections that were found when viewing the story: </p><br><ul><li>  <a href="https://github.com/btcsuite/btcd/commit/b3b8b37855011495127b1949e78f1ea315e3b580">btcsuite / btcd: test and fix bugs in getaddednodeinfo</a> </li><li>  <a href="https://github.com/btcsuite/btcd/commit/e1dd773e7c8d964ced5bf8b6acc64adacab4b845">btcsuite / btcd: Improve test coverage and fix some bugs found by tests</a> </li></ul><br><h1 id="nemnogo-uzhasov-naposledok">  A bit of horror in the end </h1><br><p>  <code>go vet</code> has a good check for expressions like " <code>x != a || x != b</code> ".  It would seem that people might not know about the <code>gometalinter</code> , but almost everyone runs <code>gometalinter</code> <code>go vet</code> , right? </p><br><p>  Using the <a href="https://github.com/mvdan/gogrep">gogrep</a> utility <a href="https://github.com/mvdan/gogrep">,</a> I compiled a small list of similar expressions that are still in the master branches of some projects. </p><br><div class="spoiler">  <b class="spoiler_title">For the bravest seals</b> <div class="spoiler_text"><hr><br><p>  I propose to consider this list and send pull requests. </p><br><pre> <code class="plaintext hljs">cloud.google.com/go/trace/trace_test.go:943:7: expectTraceOption != ((o2&amp;1) != 0) || expectTraceOption != ((o3&amp;1) != 0) github.com/Shopify/sarama/mocks/sync_producer_test.go:36:5: offset != 1 || offset != msg.Offset github.com/Shopify/sarama/mocks/sync_producer_test.go:44:5: offset != 2 || offset != msg.Offset github.com/docker/libnetwork/api/api_test.go:376:5: id1 != i2e(i2).ID || id1 != i2e(i3).ID github.com/docker/libnetwork/api/api_test.go:408:5: "sh" != epList[0].Network || "sh" != epList[1].Network github.com/docker/libnetwork/api/api_test.go:1196:5: ep0.ID() != ep1.ID() || ep0.ID() != ep2.ID() github.com/docker/libnetwork/api/api_test.go:1467:5: ep0.ID() != ep1.ID() || ep0.ID() != ep2.ID() github.com/docker/libnetwork/ipam/allocator_test.go:1261:5: len(indices) != len(allocated) || len(indices) != num github.com/esimov/caire/grayscale_test.go:27:7: r != g || r != b github.com/gogo/protobuf/test/bug_test.go:99:5: protoSize != mSize || protoSize != lenData github.com/gogo/protobuf/test/combos/both/bug_test.go:99:5: protoSize != mSize || protoSize != lenData github.com/gogo/protobuf/test/combos/marshaler/bug_test.go:99:5: protoSize != mSize || protoSize != lenData github.com/gogo/protobuf/test/combos/unmarshaler/bug_test.go:99:5: protoSize != mSize || protoSize != lenData github.com/gonum/floats/floats.go:65:5: len(dst) != len(s) || len(dst) != len(y) github.com/gonum/lapack/testlapack/dhseqr.go:139:7: wr[i] != h.Data[i*h.Stride+i] || wr[i] != h.Data[(i+1)*h.Stride+i+1] github.com/gonum/stat/stat.go:1053:5: len(x) != len(labels) || len(x) != len(weights) github.com/hashicorp/go-sockaddr/ipv4addr_test.go:659:27: sockaddr.IPPort(p) != test.z16_portInt || sockaddr.IPPort(p) != test.z16_portInt github.com/hashicorp/go-sockaddr/ipv6addr_test.go:430:27: sockaddr.IPPort(p) != test.z16_portInt || sockaddr.IPPort(p) != test.z16_portInt github.com/nats-io/gnatsd/server/monitor_test.go:1863:6: v.ID != c.ID || v.ID != r.ID github.com/nbutton23/zxcvbn-go/adjacency/adjcmartix.go:85:7: char != "" || char != " " github.com/openshift/origin/pkg/oc/cli/admin/migrate/migrator_test.go:85:7: expectedInfos != writes || expectedInfos != saves github.com/openshift/origin/test/integration/project_request_test.go:120:62: added != deleted || added != 1 github.com/openshift/origin/test/integration/project_request_test.go:126:64: added != deleted || added != 4 github.com/openshift/origin/test/integration/project_request_test.go:132:62: added != deleted || added != 1 gonum.org/v1/gonum/floats/floats.go:60:5: len(dst) != len(s) || len(dst) != len(y) gonum.org/v1/gonum/lapack/testlapack/dhseqr.go:139:7: wr[i] != h.Data[i*h.Stride+i] || wr[i] != h.Data[(i+1)*h.Stride+i+1] gonum.org/v1/gonum/stat/stat.go:1146:5: len(x) != len(labels) || len(x) != len(weights)</code> </pre> <br><hr></div></div><br><h1 id="uchimsya-na-chuzhih-oshibkah">  Learn from the mistakes of others </h1><br><p><img src="https://habrastorage.org/webt/ys/9n/qo/ys9nqo2yu_gvopttkccqvn3cd4c.png"></p><br><p>  No, even in the last part there will be nothing about <a href="http://lmgtfy.com/%3Fq%3D%25D0%25B8%25D0%25B2%25D0%25B0%25D0%25BD%2B%25D0%25B8%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25BE%25D0%25B2%25D0%25B8%25D1%2587">machine learning</a> . </p><br><p>  But what it will be written here about is <a href="https://github.com/golangci/golangci-lint">golangci-lint</a> , which integrated <a href="https://github.com/go-critic/go-critic">go-critic</a> in one of the latest releases.  <code>golangci-lint</code> is an analogue of <a href="https://github.com/alecthomas/gometalinter">gometalinter</a> , which you can read about the merits of, for example, in the article <a href="https://habr.com/company/roistat/blog/413175">"Static analysis in Go: how we save time when checking code</a> . <a href="https://habr.com/company/roistat/blog/413175">"</a> </p><br><p>  The <code>go-critic</code> recently rewritten using <a href="https://github.com/go-lintpack/lintpack">lintpack</a> .  For details, go to <a href="https://habr.com/post/430196/">"Go lintpack: composable linters manager"</a> . </p><br><p>  If you have not yet begun to actively use the tools to analyze your programs for potential errors, both stylistic and logical, I recommend today to think again about your behavior while having a cup of tea with your colleagues.  You will succeed. </p><br><p>  All good. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/432848/">https://habr.com/ru/post/432848/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../432838/index.html">Software development through the prism of Milgram's experiment ‚ÄúSubmission to authority‚Äù</a></li>
<li><a href="../432840/index.html">How to improve the efficiency of learning English and start writing better: choose an online assistant</a></li>
<li><a href="../432842/index.html">Some notes on the design of information systems</a></li>
<li><a href="../432844/index.html">Pre-project survey in the development of an information system</a></li>
<li><a href="../432846/index.html">Noam Chomsky: where did artificial intelligence go wrong?</a></li>
<li><a href="../432852/index.html">Development of technical specifications according to GOST 34 is easy and simple</a></li>
<li><a href="../432858/index.html">Very corporate post 2: opening report in Moscow</a></li>
<li><a href="../432860/index.html">PlayStation Classic hacked, now games can be run from a flash drive</a></li>
<li><a href="../432862/index.html">The prototype of the citizen‚Äôs digital profile platform will be launched in Russia by the end of 2019</a></li>
<li><a href="../432866/index.html">Made a redesign - lost a billion</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>