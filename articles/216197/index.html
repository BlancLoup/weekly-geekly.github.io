<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Learning NAS Synology to route traffic to an OpenVPN tunnel with certificate authentication</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It took me that some sites thought that I was not in Europe, but in Russia. And I wanted to hide my interest in torrents from local authorities (I'm n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Learning NAS Synology to route traffic to an OpenVPN tunnel with certificate authentication</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/b08/b34/f28/b08b34f28648cbd23ecf1d3179729ed4.jpg" alt="image"><br>  It took me that some sites thought that I was not in Europe, but in Russia.  And I wanted to hide my interest in torrents from local authorities (I'm not sure what they are watching, but nonetheless.) And I had an OpenVPN client configuration file and certificates for it.  In addition, I really did not want to install OpenVPN on every device on the network.  The home router belongs to the extremely lower price group and definitely does not know how to work with OpenVPN.  And I remembered about my online data storage, which I just have what it stores.  Previously, the torrents also swung, but after moving from the torrents, it was decided to temporarily give up.  That's it (Synology DS211j) and it was decided to turn it into a gateway to the Russian Internet, and the fact that the processor power is idle. <a name="habracut"></a><br><br>  I warn you in advance that all the manipulations were performed on DSM version 5.0-4458 and on other versions everything may be different. <br><br><h4>  Configure OpenVPN connections on synology </h4><br>  First of all, go to the web-interface of our repository in the section ‚ÄúControl Panel&gt; Network&gt; Network Interface‚Äù and create an OpenVPN profile there.  Unfortunately, the web-interface is designed only to create a connection with password authentication.  We are also interested in certificate authentication.  Therefore, we fill in the proposed fields with any data: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/fc0/ec3/c4a/fc0ec3c4a2ea9e4cb095b55aedafaf94.jpg" alt="image"><br><br>  Click next, and set the following settings: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4bf/cbe/ae8/4bfcbeae8f9ba02f7e9925d8d6c8f1c4.jpg" alt="image"><br><br>  Pay attention to the second item of settings.  What is meant is not very clear.  In DSM version 4.3, I did not notice such translation deficiencies. <br><br>  Then in the section ‚ÄúControl Panel&gt; Terminal and SNMP&gt; Terminal‚Äù we enable the method of communication with the storage which is ideologically closer to you: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d48/f06/05a/d48f0605a963fd483c2d0d5e7b906987.jpg" alt="image"><br><br>  Connect to synology using the selected protocol.  Then we will need to fix the automatically created / usr / syno / etc / synovpnclient / openvpn / client_oXXXXXXXXXX file.  The vi guru can do it right in the console, the rest can be convenient to copy the file to themselves in the shared folder and edit the file there using more familiar tools.  This is done by the following command <br><br> <code>cp /usr/syno/etc/synovpnclient/openvpn/client_oXXXXXXXXXX /volume1/Share</code> <br> <br>  When editing a file, note that Linux and windows have different approaches to designating the end of a line, so use a text editor that can save the file in the usual synology format. <br>  In my case, the configuration file looks like this: <br><br> <code>client</code> <br> <code>dev tun</code> <br> <code>proto udp</code> <br> <code>remote 255.255.255.255 1194</code> <br> <code>resolv-retry infinite</code> <br> <code>nobind</code> <br> <code>persist-key</code> <br> <code>persist-tun</code> <br> <code>ca keys/ca.crt</code> <br> <code>cert keys/client.crt</code> <br> <code>key keys/client.key</code> <br> <code>ns-cert-type server</code> <br> <code>cipher AES-128-CBC</code> <br> <code>auth SHA1</code> <br> <code>redirect-gateway def1</code> <br> <br>  Then, using the mkdir command, we create the keys directory in the / usr / syno / etc / synovpnclient / openvpn / directory where and put the certificate files and keys from them with the cp command.  Using the same command, you must copy the modified configuration file back to the appropriate directory. <br><br>  In order to connect to the OpenVPN server, go to ‚ÄúControl Panel&gt; Network&gt; Network Interface‚Äù, select the connection created by us and click on the ‚ÄúConnect‚Äù button.  Thanks to the string ‚Äúredirect-gateway def1‚Äù in the configuration file, synology will use the created tunnel as the main channel to access the Internet, and when disconnected from the VPN server, our storage will again use the router‚Äôs local network access to the global network. <br><br><h4>  We configure other devices </h4><br>  Now it remains to teach the rest of the device to choose the path to the Internet.  For this, I have created two scripts with the following contents: <br>  directly.bat: <br><br> <code>route change 0.0.0.0 mask 0.0.0.0 255.255.255.254 metric 1</code> <br> <br>  through the tunnel.bat: <br><br> <code>route change 0.0.0.0 mask 0.0.0.0 255.255.255.255 metric 1</code> <br>  where 255.255.255.254 is the address of the home router, and 255.255.255.255 is the address of the synology in the local network. <br><br>  If it is necessary to release one of the devices to the Internet via the Russian channel on synology, the VPN connection is raised via the web interface, and the default gateway is changed on the PC using a script.  When the need disappears - the connection to synology is extinguished, and on the PC, using another script, the default gateway comes back. <br><br><h5>  Speed </h5><br>  With my pattern of using such a configuration, the load on the storage processor does not exceed 80%, which is a lot, but not critical.  We should not also forget that this configuration introduces large delays, and the speed through the tunnel in my case does not exceed 8 megabits with a home Internet speed of 20 megabits and a speed of 40 megabits at that end of the tunnel. </div><p>Source: <a href="https://habr.com/ru/post/216197/">https://habr.com/ru/post/216197/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216185/index.html">Work with Korutins in Unity</a></li>
<li><a href="../216187/index.html">Kohana-form: module of management and form generation</a></li>
<li><a href="../216189/index.html">Undefined behavior in C ++</a></li>
<li><a href="../216191/index.html">Develop.re - social link aggregator for programmers</a></li>
<li><a href="../216193/index.html">Asterisk + Cisco SPA5XX, SPA3XX - DND with server notification</a></li>
<li><a href="../216199/index.html">Logitech G700. One year later</a></li>
<li><a href="../216201/index.html">Collect and analyze logs with Lumberjack + Logstash + Elasticsearch + RabbitMQ</a></li>
<li><a href="../216203/index.html">Notes for sales managers in a web-studio or ‚ÄúSay a word about a poor marketer‚Äù</a></li>
<li><a href="../216205/index.html">Raspbian and QEMU</a></li>
<li><a href="../216207/index.html">Implementing Koh-Zhao steganographic method on Ruby</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>