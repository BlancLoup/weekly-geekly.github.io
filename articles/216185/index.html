<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Work with Korutins in Unity</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Korutin (Coroutines, coroutines) in Unity is a simple and convenient way to run functions that should work in parallel for some time. There is nothing...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Work with Korutins in Unity</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/d61/e90/5eb/d61e905eb505a1669f207aef4e2cf2cb.jpg" align="left"><br>  Korutin (Coroutines, coroutines) in Unity is a simple and convenient way to run functions that should work in parallel for some time.  There is nothing fundamentally difficult in working with Korutins, and the Internet is full of articles with a superficial description of their work.  However, I never managed to find a single article that would describe the possibility of launching a group of Coroutines with the continuation of work after their completion. <br>  I want to offer you a small pattern that realizes this possibility, as well as a selection of information about the korutinas. <br><br><a name="habracut"></a><br><br>  Cortinos are simple C # iterators that return <b>IEnumerator</b> and use the <b>yield</b> keyword.  In Unity, cortices are registered and executed before the first <b>yield</b> using the <b>StartCoroutine</b> method.  Next, Unity polls the registered cortices after each call to Update and before calling LateUpdate, determining by the return value in the yield, when it is necessary to proceed to the next block of code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There are several options for return values: <br><br>  Continue after the next FixedUpdate: <br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">yield</span></span></span><span class="hljs-function"> return new </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WaitForFixedUpdate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>;</code> </pre> <br><br>  Continue after the next LateUpdate and scene rendering: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">yield</span></span></span><span class="hljs-function"> return new </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WaitForEndOfFrame</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>;</code> </pre><br><br>  Continue after a while: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">yield</span></span></span><span class="hljs-function"> return new </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WaitForSeconds</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.1f</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    100ms</span></span></code> </pre><br><br>  Continue on completing another quorutine: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">yield</span></span></span><span class="hljs-function"> return </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StartCoroutine</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">AnotherCoroutine(</span></span></span><span class="hljs-function">))</span></span>;</code> </pre><br><br>  Continue after downloading a remote resource: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">yield</span></span></span><span class="hljs-function"> return new </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WWW</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">someLink</span></span></span><span class="hljs-function">)</span></span>;</code> </pre><br><br>  All other return values ‚Äã‚Äãindicate that you must continue after passing the current iteration of the Update loop: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>;</code> </pre><br><br>  You can quit korutin like this: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;</code> </pre><br><br>  Using <b>WaitForSeconds</b> creates a long-lived object in memory (a managed heap), so using it in fast loops can be a bad idea. <br><br>  I already wrote that the corutines are working in parallel, it should be clarified that they do not work asynchronously, that is, they are executed in the same thread. <br><br>  A simple example of korutin: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { StartCoroutine(TestCoroutine()); } <span class="hljs-function"><span class="hljs-function">IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestCoroutine</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; Debug.Log(Time.deltaTime); } }</code> </pre><br><br>  This code runs a corute with a loop that will write to the console the time elapsed since the last frame. <br>  You should pay attention to the fact that first <i>return return null</i> is called in Coroutine, and only then the log is written.  In our case, it matters, because the execution of korutin starts at the moment <i>when StartCoroutine (TestCoroutine ()) is called</i> , and the transition to the next code block after <i>yield return null</i> will be done after the <b>Update</b> method, so that before and after the first <i>yield return null</i> <b>Time. deltaTime</b> will point to the same value. <br><br>  You should also note that an endless loop corutin can still be interrupted by calling <b>StopAllCoroutines ()</b> , <b>StopCoroutine (‚ÄúTestCoroutine‚Äù)</b> , or destroying the parent GameObject. <br><br>  Good.  So with the help of corutines, we can create triggers that check certain values ‚Äã‚Äãfor each frame, we can create a sequence of corortines launched one after another, for example, playing a series of animations, with different calculations at different stages.  Or just run other corutins inside a quorutine without a <i>yield return</i> and continue execution.  But how to start a group of korutinov, working in parallel, and continue only after their completion? <br><br>  Of course, you can add to the class in which corutin is defined, a variable indicating the current state: <br><br>  Class to move: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsMoving = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-function"><span class="hljs-function">IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MoveCoroutine</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Vector3 moveTo</span></span></span><span class="hljs-function">)</span></span> { IsMoving = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-comment"><span class="hljs-comment">//        var iniPosition = transform.position; while (transform.position != moveTo) { //              //     yield return null; } IsMoving = false; }</span></span></code> </pre><br><br>  A class that works with a group of classes that need to be moved: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">IEnumetaror </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PerformMovingCoroutine</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//   foreach(MovableObjectScript s in objectsToMove) { //   StartCoroutine(s.MoveCoroutine(moveTo)); } bool isMoving = true; while (isMoving) { isMoving = false; Array.ForEach(objectsToMove, s =&gt; { if (s.IsMoving) isMoving = true; }); if (isMoving) yield return null; } //    }</span></span></code> </pre><br><br>  The ‚Äúdo more things‚Äù block will start to run after the MoveCoroutine <b>corortin is completed</b> on each object in the <b>objectsToMove</b> array. <br><br>  Well, already interesting. <br>  But what if we want to create a group of korutin, with the possibility to check, at any place and at any time, whether the group has completed the job? <br>  Let's do it! <br><br>  For convenience, we will do everything in the form of extension methods: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CoroutineExtension</span></span> { <span class="hljs-comment"><span class="hljs-comment">//     &lt; ,   &gt; static private readonly Dictionary&lt;string, int&gt; Runners = new Dictionary&lt;string, int&gt;(); // MonoBehaviour          public static void ParallelCoroutinesGroup(this IEnumerator coroutine, MonoBehaviour parent, string groupName) { if (!Runners.ContainsKey(groupName)) Runners.Add(groupName, 0); Runners[groupName]++; parent.StartCoroutine(DoParallel(coroutine, parent, groupName)); } static IEnumerator DoParallel(IEnumerator coroutine, MonoBehaviour parent, string groupName) { yield return parent.StartCoroutine(coroutine); Runners[groupName]--; } //   ,   ,       public static bool GroupProcessing(string groupName) { return (Runners.ContainsKey(groupName) &amp;&amp; Runners[groupName] &gt; 0); } }</span></span></code> </pre><br><br>  Now it is enough to call the ParallelCoroutinesGroup method on the corints and wait until the <b>CoroutineExtension.GroupProcessing</b> method returns true: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CoroutinesTest</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Use this for initialization void Start() { StartCoroutine(GlobalCoroutine()); } IEnumerator GlobalCoroutine() { for (int i = 0; i &lt; 5; i++) RegularCoroutine(i).ParallelCoroutinesGroup(this, "test"); while (CoroutineExtension.GroupProcessing("test")) yield return null; Debug.Log("Group 1 finished"); for (int i = 10; i &lt; 15; i++) RegularCoroutine(i).ParallelCoroutinesGroup(this, "anotherTest"); while (CoroutineExtension.GroupProcessing("anotherTest")) yield return null; Debug.Log("Group 2 finished"); } IEnumerator RegularCoroutine(int id) { int iterationsCount = Random.Range(1, 5); for (int i = 1; i &lt;= iterationsCount; i++) { yield return new WaitForSeconds(1); } Debug.Log(string.Format("{0}: Coroutine {1} finished", Time.realtimeSinceStartup, id)); } }</span></span></code> </pre><br><br>  Done! <br><br><img src="//habrastorage.org/files/34d/aaa/36c/34daaa36c5f44af59f6c48e19e86f17e.png" align="left"></div><p>Source: <a href="https://habr.com/ru/post/216185/">https://habr.com/ru/post/216185/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216169/index.html">Interaction of vulnerability scanners with Metasploit. Part 2</a></li>
<li><a href="../216173/index.html">Samba4 as AD + file server</a></li>
<li><a href="../216177/index.html">How I did USB MFP wireless</a></li>
<li><a href="../216179/index.html">Data collection methods for analyzing the effectiveness of contextual advertising in offline sales</a></li>
<li><a href="../216181/index.html">C ++ web application, or taming the FastCGI daemon</a></li>
<li><a href="../216187/index.html">Kohana-form: module of management and form generation</a></li>
<li><a href="../216189/index.html">Undefined behavior in C ++</a></li>
<li><a href="../216191/index.html">Develop.re - social link aggregator for programmers</a></li>
<li><a href="../216193/index.html">Asterisk + Cisco SPA5XX, SPA3XX - DND with server notification</a></li>
<li><a href="../216197/index.html">Learning NAS Synology to route traffic to an OpenVPN tunnel with certificate authentication</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>