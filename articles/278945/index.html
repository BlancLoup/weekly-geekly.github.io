<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Android runtime permissions. Why, why, and how</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Often when installing an application on Android, we had to see that it asks for some unthinkable number of permissions. For example: 



 Well, if you...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Android runtime permissions. Why, why, and how</h1><div class="post__text post__text-html js-mediator-article">  Often when installing an application on Android, we had to see that it asks for some unthinkable number of permissions.  For example: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/3c4/f18/c35/3c4f18c3577c4adeb5366c0fe1570618.png"></div><br><br>  Well, if you install the application from a well-known developer who you can trust.  But it is very suspicious if you install a new music player, and for work it is required, for example, to receive your location.  Or, especially, a flashlight that requires access to SMS and calls. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Some developers, in order to reduce mistrust, add to the description of the application on Google Play why they need this or that permission. <br><br>  By the sixth version of Android, the situation has changed.  Now permissions must be requested in the process.  How this new opportunity to use and some of its pitfalls will be discussed below. <br><a name="habracut"></a><br><h4>  general information </h4><br>  Just as it happens in iOS, when prompted, a system dialog will appear asking for permission. <br><table><tbody><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/files/ed6/395/9a2/ed63959a24b34ebea49bf53362f38ffe.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/files/5f0/77e/616/5f077e616e264666bfddee59830ddeb7.png"></div></td></tr></tbody></table><br>  The difference is that after pressing the ‚ÄúDeny‚Äù button, the permission will not be completely prohibited for the application, as it happens with Apple.  You can request it again, but in this case the option ‚ÄúNever ask again‚Äù will appear, after selecting which ‚ÄúDeny‚Äù works like ‚ÄúDon't allow‚Äù in iOS. <br><br>  Permissions are divided into two types (there are others, but they do not interest us): <br><br><ul><li>  normal (normal); </li><li>  dangerous (dangerous). </li></ul><br>  Normal permissions will be obtained by the application during installation, no confirmation from the user is required (a little controversial point, in my opinion, it would be worth notifying the user of the required permissions).  In the future, to withdraw them from the application will be impossible.  Dangerous must be requested during the operation of the application and can be withdrawn at any time.  The list of dangerous and not very permissions can be found <a href="http://developer.android.com/intl/ru/guide/topics/security/permissions.html">here</a> . <br><br>  You can see that access to the Internet is not considered dangerous.  Anyone who uses advertising in their programs can breathe a sigh of relief: you can‚Äôt turn it off just by selecting permission (you can still just turn off the Internet, but the fact remains). <br><br>  In order to revoke the permission that was previously issued (or grant it if you selected ‚ÄúNever ask again‚Äù), go to the application settings (Settings-&gt; Apps -&gt; * AppName *) in the Permissions section and click on the appropriate switches.  In this menu, you can also view all the permissions of this program by selecting ‚ÄúAll permissions‚Äù from the context menu.  You can also see which applications have been given a specific permission (and, accordingly, grant or select it).  To do this, in the settings in the Apps section, click on the menu with the gear icon and select App permissions in the opened section.  Next, selecting the desired resolution, you can see all the applications that need it. <br><table><tbody><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/files/76a/5aa/fee/76a5aafeeeb74d7db1dda3ea257879b3.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/files/73c/014/5a0/73c0145a0f36444b9dc2e9cc5e3d82c7.png"></div></td></tr></tbody></table><br><h4>  User interaction </h4><br>  Let's see how to make user interaction.  We start directly with a request for permission.  With normal permissions, everything is clear, this is the application installer‚Äôs business, it doesn‚Äôt interest us, and how we request dangerous permissions depends on two things. <br><br>  The first one is the importance of this permission for your application, it depends on when you need to make a request.  If the function is critical and without it the program will not make sense, then feel free to ask permission right at the start of the application.  For example, if you are developing an application for the exchange of sms, then without the appropriate permissions you can‚Äôt do anything with it, it loses all meaning.  And if the user refused, then we do not skip it further, but we give the opportunity to once again trigger the request dialog and give instructions on what to do. <br><br>  If the resolution requires some kind of secondary function, then you do not need to ask about it immediately.  Do this only when the user wants to take advantage of this opportunity. <br><table><tbody><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/files/8d8/d86/063/8d8d860639834030a0c46cc009a90cc4.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/files/e4f/056/956/e4f0569564a94ed5ae6c53e6424c42f0.png"></div></td></tr></tbody></table><br>  The second point is how clear it will be to the person what this permission is for.  Why does the SMS application have access to the calendar?  Probably for some cool function that will facilitate the transfer of dates from messages to the calendar and the like.  But only you know about it, so you first need to explain the reason for the request and show what possibilities will give access to this permission.  This applies to both primary and secondary permissions. <br><table><tbody><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/files/d06/889/d7c/d06889d7cc834f5a91ac8f9df35ea573.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/files/19d/b33/690/19db336905b74f948d5186d95cfb34b4.png"></div></td></tr></tbody></table><br>  Once again briefly: <br><br><ul><li>  important permissions are requested at startup, secondary permissions when the corresponding function is first used; </li><li>  If you understand why permission is necessary, we provide an explanation. </li></ul><br>  In the case when you still refused, an explanation of the reason for the next time is mandatory.  And if, in addition to the refusal, the user asked you never to request this permission using the ‚ÄúNever ask again‚Äù option, but tries to use the appropriate function of the application, ask him to go to your program settings and manually enable the necessary permissions.  This is especially important if the resolution is critical for the operation of the program. <br><table><tbody><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/files/09d/b94/e34/09db94e3419b4169b90355b02b909896.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/files/6c1/d16/9ec/6c1d169ec0654b0d9f3a12cdbc9ce3a9.png"></div></td></tr></tbody></table><br><h4>  Code </h4><br>  The logical question will be: what happens if you run your unsupported permissions under runtime permissions application on Android Marshmallow?  The answer depends on whether you dare to change targetSdk to version 23 (compileSdk and buildTools are not interested in this case).  If yes, then I have not the best news for you: it is very likely that you will get a SecurityException.  This will not necessarily be the case; perhaps somewhere you will get null instead of the requested information, but the probability is far from zero.  If you use targetSdk version 22 and below, then all permissions will be issued to the application as before, including dangerous ones.  This does not negate the fact that the user may revoke any of them after installation.  At the same time, he will receive a warning that the application is not adapted to runtime permissions and may not work correctly.  How incorrect it will work is completely up to you, that is, if you checked the returned values ‚Äã‚Äãto null or were ready to zero instead of the sane value, then nothing terrible will happen: the application simply will not fully function (which looks still better than the fall from due to NullPointerException). <br><br>  But even if you are doing well with checks and there is no opportunity to engage in the introduction of new features, you should double-check whether everything works correctly, because sometimes you can get null not where you expect it.  So, for example, when using Environment.getExternalStorageDirectory () without permission from the Storage group, we get File, but list () will return us the cherished null.  The documentation describes this outcome, but for the situation when File is not a directory.  So check in any case will not be superfluous. <br><br>  It is possible to add permission only for Android M and above.  To do this, you need to use the new &lt;uses-sdk-23 /&gt; tag (previously called &lt;uses-sdk-m /&gt;) in the manifest.  Its syntax is similar to the usual &lt;uses-permission /&gt;.  This can be useful if you want to add an ability to an existing application that requires additional permission.  As you remember, if the new version of the program requires additional rights, the user must manually confirm its update.  This can be avoided if the new function is not very important by disabling it for earlier versions of the system, using the previously described tag.  In this case, this permission will be absent altogether. <br><br>  In the process of debugging often have to enable / disable permissions.  Going to this every time in the application settings is not very convenient.  Fortunately, this can be done using adb: <br><br><pre><code class="bash hljs">adb shell pm grant &lt;app package&gt; &lt;permission name&gt; adb shell pm revoke &lt;app package&gt; &lt;permission name&gt;</code> </pre> <br>  And a few more useful commands, the meaning of which is clear from the title: <br><br><pre> <code class="bash hljs">adb shell pm reset-permissions adb shell pm list permission-groups adb shell pm list permissions</code> </pre><br>  Let us proceed to the immediate implementation (we will not forget to upgrade compileSdkVersion and targetSdkVersion to version 23 beforehand). <br><br>  Until the moment when Marshmallow becomes the minimum version of android for your applications, it is still far, so you need to take care of backward compatibility.  Of course, you can check the version of sdk, but why, if everything is implemented for us in the support library v4 (ActivityCompat) and v13 (FragmentCompat).  If you still need the original methods, then find them is not difficult. <br><br>  All examples use ActivityCompat, as they were made for the activity.  For fragment you need to use FragmentCompat.  If for some reason you do not use activity and fragment from the support libraries, then you need to implement the ActivityCompat.OnRequestPermissionsResultCallback or FragmentCompat.OnRequestPermissionsResultCallback interface, respectively. <br><br>  Every time we want to use a method that requires dangerous permission, it is necessary to check whether we have it.  To do this, we use the ContextCompat.checkSelfPermission (Context context, String permission) method, which returns us one of the int values: PackageManager.PERMISSION_GRANTED in case there is permission or PackageManager.PERMISSION_DENIED if it is not present.  The resolution name is one of the constants of the class Manifest.permission. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> File[] getExternalStorageFiles() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ContextCompat.checkSelfPermission(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, Manifest.permission.READ_EXTERNAL_STORAGE) == PackageManager.PERMISSION_GRANTED) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> File externalStorage = Environment.getExternalStorageDirectory(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (externalStorage != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> externalStorage.listFiles(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }</code> </pre><br>  Further, if there is permission, we perform the action we need, and if not, then we need to request it.  At the same time, you can request multiple permissions (the user will be shown a request for each of them in turn), if necessary. <br><br>  It is worth mentioning that if the permissions are in the same permission group, then you only need to request one of them, since all the other elements of this group will also be available.  But this is not necessary.  Because in the future, the composition of groups may change, so when requesting permits, it is not necessary to make assumptions as to whether they are in the same group or not. <br><br>  <b>UPD</b> as if in confirmation of the previous paragraph, starting with Android 8.0, permissions from one permission group are not issued immediately - each permission must be requested separately, but all permissions from one group will be issued automatically, without user participation, at their first request. <br><br>  <b>UPD2</b> the same behavior was noticed on Android 7.0 - if part of the permissions from the group were issued (I can not say with certainty whether it matters which ones), then the rest will be issued on request immediately without showing a dialog.  This can cause problems if your application explains to the user why she needs this or that permission even before his request.  In real life, this rarely can occur (only when using adb commands), but you should take this into account when debugging an application. <br><br>  The request uses the ActivityCompat.requestPermissions method (Activity activity, String [] permissions, int requestCode).  The permissions array accordingly contains the names of the permissions you want to request.  This shows that you can simultaneously request multiple permissions.  requestCode is a value by which in the future it will be possible to determine which request for permission you received an answer just as we get the result from the activity using startActivityForResult.  By the way, if you look at the requestPermission code, you will find that this is just a special version of startActivityForResult. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requestMultiplePermissions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ActivityCompat.requestPermissions(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[] { Manifest.permission.READ_EXTERNAL_STORAGE, Manifest.permission.READ_SMS }, PERMISSION_REQUEST_CODE); }</code> </pre><br>  As you can see, you can directly request permissions only from an Activity or Fragment.  If permission is required by the service, you will have to start an Activity, from which you can already make a request.  The best thing to do is to show a notification containing information about the missing resolution with a button to launch this Activity itself. <br><br>  The result of the permission request should be processed in onRequestPermissionsResult (int requestCode, @NonNull String [] permissions, @NonNull int [] grantResults).  The requestCode and permissions parameters contain the data you passed when requesting permissions.  The main data here is carried by an array of grantResults, which contains information about whether or not permissions are obtained.  Each i-th permissions element corresponds to the i-th element from grantResults.  Their possible values ‚Äã‚Äãare similar to the checkSelfPermission result. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onRequestPermissionsResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> requestCode, @NonNull String[] permissions, @NonNull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] grantResults)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (requestCode == PERMISSION_REQUEST_CODE &amp;&amp; grantResults.length == <span class="hljs-number"><span class="hljs-number">2</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (grantResults[<span class="hljs-number"><span class="hljs-number">0</span></span>] == PackageManager.PERMISSION_GRANTED) { showExtDirFilesCount(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (grantResults[<span class="hljs-number"><span class="hljs-number">1</span></span>] == PackageManager.PERMISSION_GRANTED) { showUnreadSmsCount(); } } <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onRequestPermissionsResult(requestCode, permissions, grantResults); }</code> </pre><br>  The size of the grantResults array is checked to ensure that the permission request has not been interrupted (in this case, the permissions and grantResults will not contain elements).  Such a situation should not be viewed as a prohibition of permission, but as a cancellation of a request for it. <br><br>  If you have previously requested permission, but the user declined to provide it, you must explain the reason for the request.  This need not be done if the reason for which you are requesting permission is absolutely clear.  If there is a possibility that the question ‚ÄúWhy does the application need it?‚Äù Will arise, then this is highly desirable to explain.  To find out if an explanation needs to be shown, there is the method shouldShowRequestPermissionRationale (@NonNull Activity activity, @NonNull String permission), which is returned by the boolean.  The very same explanation can be implemented, for example, with the help of Snackbar with an action button, upon clicking on which the permission is requested, or in a dialog box if the permission is critical. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requestPermissionWithRationale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ActivityCompat.shouldShowRequestPermissionRationale(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, Manifest.permission.READ_EXTERNAL_STORAGE)) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String message = <span class="hljs-string"><span class="hljs-string">"Storage permission is needed to show files count"</span></span>; Snackbar.make(view_, message, Snackbar.LENGTH_LONG) .setAction(<span class="hljs-string"><span class="hljs-string">"GRANT"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> View.OnClickListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View v)</span></span></span><span class="hljs-function"> </span></span>{ requestReadExtStorage(); } }) .show(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { requestReadExtStorage(); } }</code> </pre><br><h5>  Never ask again </h5><br>  One of the problems may be the option ‚ÄúNever ask again‚Äù, which appears when you re-request permission, after the user has already refused earlier.  As the name implies, when you select it, the request dialog will no longer appear.  shouldShowRequestPermissionRationale will give out false, and on onquestPermissionsResult will get the result PackageManager.PERMISSION_DENIED.  And we will get permission only if we enable it directly through the application settings in the Permissions section. <br><br>  What can be done with this?  First of all, of course, inform the user that there are no necessary rights to perform the action.  Further possible action may be a suggestion to go to the settings and grant this permission manually.  Not the best option, but better than nothing.  This can be implemented again using the Snackbar with an action button. <br><br>  Go directly to the page with permissions will not work, so the best thing you can do is open the settings of your application.  After that you can, for example, show Toast with the information that needs to be done. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">showNoStoragePermissionSnackbar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Snackbar.make(view_, <span class="hljs-string"><span class="hljs-string">"Storage permission isn't granted"</span></span> , Snackbar.LENGTH_LONG) .setAction(<span class="hljs-string"><span class="hljs-string">"SETTINGS"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> View.OnClickListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View v)</span></span></span><span class="hljs-function"> </span></span>{ openApplicationSettings(); Toast.makeText(getApplicationContext(), <span class="hljs-string"><span class="hljs-string">"Open Permissions and grant the Storage permission"</span></span>, Toast.LENGTH_SHORT) .show(); } }) .show(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">openApplicationSettings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Intent appSettingsIntent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS, Uri.parse(<span class="hljs-string"><span class="hljs-string">"package:"</span></span> + getPackageName())); startActivityForResult(appSettingsIntent, PERMISSION_REQUEST_CODE); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onActivityResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> requestCode, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> resultCode, Intent data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (requestCode == PERMISSION_REQUEST_CODE) { showExtDirFilesCount(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onActivityResult(requestCode, resultCode, data); }</code> </pre><br>  The example uses startActivityForResult and onActivityResult to determine that the user returned from the settings activity back to the application and try an action that could not be done without the required permission.  In the showExtDirFilesCount method, you need to check again whether there is permission to ensure that the user issued it after all. <br><br>  There may be a situation that does not particularly hinder if you use Snackbar to show rationale, but spoils the UX, if you decide to use dialogs (we do not touch on the reasons for this decision).  Namely, the double appearance of rationale, before the request for permission and after it.  How can this happen?  We have only two methods by which we can judge the state of resolution.  The problem is that before requesting permission, the situation when we have never requested this permission, and the situation when the user previously chose ‚ÄúNever ask again‚Äù, is exactly the same in terms of values.  Namely, checkSeflPermission returns us PERMISSION_DENIED, a shouldShowRequestPermissionRationale - false.  So, we‚Äôll show a dialog for opening settings in onRequestPermissionsResult, where the value of shouldShowRequestPermissionRationale will be exactly different for these two situations.  All perfectly?  Not really.  In this callback, there is no way to determine whether a rationale was shown or not.  Therefore, if you show the reason for the request, and then the user asks him not to ask about this permission anymore, after clicking on the DENY button, he will receive another rationale dialog inviting him to the program settings.  Good programs do not behave this way. <br><br>  What to do in this situation?  There are a couple of not very nice solutions on the network: one of them is to save information about whether you have permission or not in SharedPreferences, and the other to store a flag about whether a rationale was shown inside a class or not.  The first decision is not good because while the application is not working, the user can change the permissions settings and the information in the preferences will be irrelevant.  The second method is not very beautiful. <br><br>  A good option (in my opinion) is to have two requestCode for each request, one for use in rationale and the other in other cases.  This method is also not perfect and not particularly beautiful, but it helps to adhere to existing methods without contributing anything new. <br><br><h5>  Intent </h5><br>  There is another important recommendation when using runtime permissions.  Do not use them.  More precisely, use it, but only when the functionality that you are going to implement with their help, has not been done by someone before you. <br><br>  As the most illustrative example, the camera is most often remembered.  Use the standard camera application (or other applications that can do this) if you only need to take a photo without some special logic.  Intensions will help you with this ( <a href="http://developer.android.com/intl/ru/training/camera/photobasics.html">more</a> ). <br><br>  Thus, you can get rid of some dangerous permissions and simplify work with the application. <br><br><h4>  Conclusion </h4><br>          .   ,      ,       (, ,      ,   ).         ,   ,   . ,         ,   ,     ,    (     ,         ). ,    , Google   ,   ,         . </div><p>Source: <a href="https://habr.com/ru/post/278945/">https://habr.com/ru/post/278945/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278935/index.html">What is new is waiting for us in Laravel 5.2.23</a></li>
<li><a href="../278937/index.html">Testing Bash Applications</a></li>
<li><a href="../278939/index.html">Our experience with Docker</a></li>
<li><a href="../278941/index.html">How our testing is arranged and why QA participates in the formulation of problems to our developers</a></li>
<li><a href="../278943/index.html">OpenConfig - a standardized approach to configuring network equipment</a></li>
<li><a href="../278947/index.html">Speed ‚Äã‚ÄãDevelopment Unity3D games for the competition</a></li>
<li><a href="../278949/index.html">Spiceworks research: insider threats will be the biggest information security challenge in 2016</a></li>
<li><a href="../278951/index.html">We collect Electron.js rake or desktop JS-applications in practice</a></li>
<li><a href="../278953/index.html">Web merge sync on MS SQL</a></li>
<li><a href="../278955/index.html">An error in the AMD processor microcode allows virtual machine users to access the hypervisor host system</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>