<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>LINQ to SQL and SQL Server Spatial Data</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Starting from version 2008 (and so far ending with it) MS SQL Server has built-in support for spatial data. Perfectly! 

 At the moment, there are alr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>LINQ to SQL and SQL Server Spatial Data</h1><div class="post__text post__text-html js-mediator-article">  Starting from version 2008 (and so far ending with it) MS SQL Server has built-in support for spatial data.  Perfectly! <br><br>  At the moment, there are already several DBMSs offering indexed storage of spatial data.  Probably the most popular ones are: MySql and PostGIS. <br><br>  When programming in c #, naturally, in very many cases, you give preference to Microsoft products and solutions.  The reasons are simple: better support of some technologies by others, good documentation, better implementation, for example, data providers, and much less buggy.  I chose SQL Server.  At the same time I wanted to learn LINQ in general and LINQ to SQL in.  particular. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At first everything was fine.  For me, a good start was made by the article ‚Äú <a title="LINQ to SQL: .NET Language-Integrated Query for Relational Data" href="http://msdn.microsoft.com/en-us/library/bb425822.aspx">LINQ to SQL: .NET <nobr>Language-Integrated</nobr> Query for Relational Data</a> ‚Äù found on msdn. <br>  But I was not very surprised when ‚Äúall is well‚Äù ended. <br><br>  Two additional types have been introduced to store geometric data in SQL Server: geometry and geography.  The first is used to store geometric objects described in the Cartesian coordinate system, and the second - for geometric objects specified by geographic coordinates (latitude / longitude). <br>  <i>This separation, apparently, had to be done <nobr>due to</nobr> the fact that the spatial index is implemented in SQL Server based on <nobr>B-trees</nobr> .</i>  <i>When using this index, the space is patterned by the grid several times and references to geometric objects are saved in the ‚Äúcells‚Äù of this grid.</i>  <i>And it turned out to be impossible to build a universal partition for both the rectangular coordinate system and the ellipsoidal one.</i>  <i>In MySql, for example, a different indexing algorithm based on <nobr>R-trees</nobr> , operating on a completely different principle, is chosen, and one data type is used.</i>  <i>Which way of indexing is better and which is worse is</i> <i>not obvious, so it is not yet clear who to swear at and whether it is worth it.</i> <i><br></i> <br>  It turned out that LINQ to SQL does not understand these data types and refuses to work with them, as well as with the built-in geometric functions.  Although it is probably more correct to say that the provider does not understand them.  In any case, I am sure that these data will be supported, but now there is no such support. <br><br>  I could not find a solution in the Internet that avoided this problem, so I had to invent it myself.  There are no amazing moves here, but there are details that I think will be interesting.  Also in this great note, for your interest, I will describe a <nobr>little bit</nobr> how to work with LINQ to SQL. <br><a name="habracut"></a><br><h2>  Database </h2><br><br>  For example, we will use the following table. <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/df9/b70/efa/df9b70efa78b593d6cabe315df631843.png"></a> <br><br>  To create it, use the following script. <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">USE</font> ExampleDatabase; <font color="#0000ff">GO</font> -- <font color="#0000ff">Create</font> <font color="#0000ff">table</font> <font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> Boundaries_Country( FeatureID UNIQUEIDENTIFIER <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> , CountryName <font color="#0000ff">VARCHAR</font> (100) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">UNIQUE</font> , CountryBoundary GEOGRAPHY <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ) <font color="#0000ff">CREATE</font> SPATIAL <font color="#0000ff">INDEX</font> SpatialIndex <font color="#0000ff">ON</font> Boundaries_Country (CountryBoundary); <font color="#0000ff">GO</font></font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <ol><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">USE</font> ExampleDatabase; <font color="#0000ff">GO</font> -- <font color="#0000ff">Create</font> <font color="#0000ff">table</font> <font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> Boundaries_Country( FeatureID UNIQUEIDENTIFIER <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> , CountryName <font color="#0000ff">VARCHAR</font> (100) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">UNIQUE</font> , CountryBoundary GEOGRAPHY <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ) <font color="#0000ff">CREATE</font> SPATIAL <font color="#0000ff">INDEX</font> SpatialIndex <font color="#0000ff">ON</font> Boundaries_Country (CountryBoundary); <font color="#0000ff">GO</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">USE</font> ExampleDatabase; GO -- <font color="#0000ff">Create</font> <font color="#0000ff">table</font> <font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> Boundaries_Country( FeatureID UNIQUEIDENTIFIER <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> , CountryName <font color="#0000ff">VARCHAR</font> (100) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">UNIQUE</font> , CountryBoundary GEOGRAPHY <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ) <font color="#0000ff">CREATE</font> SPATIAL <font color="#0000ff">INDEX</font> SpatialIndex <font color="#0000ff">ON</font> Boundaries_Country (CountryBoundary); <font color="#0000ff">GO</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">USE</font> ExampleDatabase; <font color="#0000ff">GO</font> -- <font color="#0000ff">Create</font> <font color="#0000ff">table</font> <font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> Boundaries_Country( FeatureID UNIQUEIDENTIFIER <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> , CountryName <font color="#0000ff">VARCHAR</font> (100) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">UNIQUE</font> , CountryBoundary GEOGRAPHY <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ) <font color="#0000ff">CREATE</font> SPATIAL <font color="#0000ff">INDEX</font> SpatialIndex <font color="#0000ff">ON</font> Boundaries_Country (CountryBoundary); <font color="#0000ff">GO</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">USE</font> ExampleDatabase; <font color="#0000ff">GO</font> -- <font color="#0000ff">Create</font> <font color="#0000ff">table</font> <font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> Boundaries_Country( FeatureID UNIQUEIDENTIFIER <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> , CountryName <font color="#0000ff">VARCHAR</font> (100) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">UNIQUE</font> , CountryBoundary GEOGRAPHY <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ) <font color="#0000ff">CREATE</font> SPATIAL <font color="#0000ff">INDEX</font> SpatialIndex <font color="#0000ff">ON</font> Boundaries_Country (CountryBoundary); <font color="#0000ff">GO</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">USE</font> ExampleDatabase; <font color="#0000ff">GO</font> -- <font color="#0000ff">Create</font> <font color="#0000ff">table</font> <font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> Boundaries_Country( FeatureID UNIQUEIDENTIFIER <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> , CountryName <font color="#0000ff">VARCHAR</font> (100) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">UNIQUE</font> , CountryBoundary GEOGRAPHY <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ) <font color="#0000ff">CREATE</font> SPATIAL <font color="#0000ff">INDEX</font> SpatialIndex <font color="#0000ff">ON</font> Boundaries_Country (CountryBoundary); <font color="#0000ff">GO</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">USE</font> ExampleDatabase; <font color="#0000ff">GO</font> -- <font color="#0000ff">Create</font> <font color="#0000ff">table</font> <font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> Boundaries_Country( FeatureID UNIQUEIDENTIFIER <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> , CountryName <font color="#0000ff">VARCHAR</font> (100) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">UNIQUE</font> , CountryBoundary GEOGRAPHY <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ) <font color="#0000ff">CREATE</font> SPATIAL <font color="#0000ff">INDEX</font> SpatialIndex <font color="#0000ff">ON</font> Boundaries_Country (CountryBoundary); <font color="#0000ff">GO</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">USE</font> ExampleDatabase; <font color="#0000ff">GO</font> -- <font color="#0000ff">Create</font> <font color="#0000ff">table</font> <font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> Boundaries_Country( FeatureID UNIQUEIDENTIFIER <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> , CountryName <font color="#0000ff">VARCHAR</font> (100) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">UNIQUE</font> , CountryBoundary GEOGRAPHY <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ) <font color="#0000ff">CREATE</font> SPATIAL <font color="#0000ff">INDEX</font> SpatialIndex <font color="#0000ff">ON</font> Boundaries_Country (CountryBoundary); <font color="#0000ff">GO</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">USE</font> ExampleDatabase; <font color="#0000ff">GO</font> -- <font color="#0000ff">Create</font> <font color="#0000ff">table</font> <font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> Boundaries_Country( FeatureID UNIQUEIDENTIFIER <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> , CountryName <font color="#0000ff">VARCHAR</font> (100) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">UNIQUE</font> , CountryBoundary GEOGRAPHY <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ) <font color="#0000ff">CREATE</font> SPATIAL <font color="#0000ff">INDEX</font> SpatialIndex <font color="#0000ff">ON</font> Boundaries_Country (CountryBoundary); <font color="#0000ff">GO</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">USE</font> ExampleDatabase; <font color="#0000ff">GO</font> -- <font color="#0000ff">Create</font> <font color="#0000ff">table</font> <font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> Boundaries_Country( FeatureID UNIQUEIDENTIFIER <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> , CountryName <font color="#0000ff">VARCHAR</font> (100) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">UNIQUE</font> , CountryBoundary GEOGRAPHY <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ) <font color="#0000ff">CREATE</font> SPATIAL <font color="#0000ff">INDEX</font> SpatialIndex <font color="#0000ff">ON</font> Boundaries_Country (CountryBoundary); <font color="#0000ff">GO</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">USE</font> ExampleDatabase; <font color="#0000ff">GO</font> -- <font color="#0000ff">Create</font> <font color="#0000ff">table</font> <font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> Boundaries_Country( FeatureID UNIQUEIDENTIFIER <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> , CountryName <font color="#0000ff">VARCHAR</font> (100) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">UNIQUE</font> , CountryBoundary GEOGRAPHY <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ) <font color="#0000ff">CREATE</font> SPATIAL <font color="#0000ff">INDEX</font> SpatialIndex <font color="#0000ff">ON</font> Boundaries_Country (CountryBoundary); <font color="#0000ff">GO</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">USE</font> ExampleDatabase; <font color="#0000ff">GO</font> -- <font color="#0000ff">Create</font> <font color="#0000ff">table</font> <font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> Boundaries_Country( FeatureID UNIQUEIDENTIFIER <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> , CountryName <font color="#0000ff">VARCHAR</font> (100) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">UNIQUE</font> , CountryBoundary GEOGRAPHY <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ) <font color="#0000ff">CREATE</font> SPATIAL <font color="#0000ff">INDEX</font> SpatialIndex <font color="#0000ff">ON</font> Boundaries_Country (CountryBoundary); GO <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> </ol> <code><font color="gray"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">USE</font> ExampleDatabase; <font color="#0000ff">GO</font> -- <font color="#0000ff">Create</font> <font color="#0000ff">table</font> <font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> Boundaries_Country( FeatureID UNIQUEIDENTIFIER <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> , CountryName <font color="#0000ff">VARCHAR</font> (100) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">UNIQUE</font> , CountryBoundary GEOGRAPHY <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ) <font color="#0000ff">CREATE</font> SPATIAL <font color="#0000ff">INDEX</font> SpatialIndex <font color="#0000ff">ON</font> Boundaries_Country (CountryBoundary); <font color="#0000ff">GO</font></font> * This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  In line 11, for the CountryBoundary field with the geography data type, a spatial index is created with default settings. <br><br>  In order to have something to work with, I filled out the table with multipolygons of the countries of the world, the shape-file for which was found on the Internet.  Several countries did not want to convert - I did not understand why it was not important, although for Russia, of course, insulting. <br><br>  SQL Server has a nice built-in viewer (well, now everyone can see that I am writing with errors). <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/a73/0d5/199/a730d5199bf49dd5c6c8307481d44573.png"></a> <br><br><h2>  Getting Started with LINQ to SQL </h2><br><br>  To work with LINQ to SQL, you need to add references to two assemblies to your project: System.Data.Linq and Microsoft.SqlServer.Types.  If there are no problems with the first library (it can be found on the ‚Äú.NET‚Äù tab of the ‚ÄúAdd Reference‚Äù form - adding links to the library used in the project), then the second one will need to be searched in the ‚ÄúC: \ Program Files \ Microsoft SQL Server \ 100 directory‚Äù \ SDK \ Assemblies \ ".  In order for the last build to continue to be displayed in the ‚Äú.NET‚Äù tab of the add assembly form, you need to register it once with the gacutil utility. <br><br>  The first step in using LINQ to SQL is to create mapping classes for database tables. <br><br>  One table - one class. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">using</font> System; </li><li>  <font color="#0000ff">using</font> System.Data.Linq.Mapping; </li><li>  <font color="#0000ff">using</font> Microsoft.SqlServer.Types; </li><li>  <font color="#0000ff">namespace</font> mynamespace </li><li>  { </li><li>  [Table ()] </li><li>  <font color="#0000ff">public</font> <font color="#0000ff">sealed</font> <font color="#0000ff">class</font> Boundaries_Country </li><li>  { </li><li>  [Column (AutoSync = AutoSync.OnInsert, DbType = <font color="#A31515">"uniqueidentifier"</font> , IsPrimaryKey = <font color="#0000ff">true</font> , IsDbGenerated = <font color="#0000ff">true</font> , UpdateCheck = UpdateCheck.Never)] </li><li>  <font color="#0000ff">public</font> <font color="#2B91AF">Guid</font> FeatureID; </li><li>  [Column (DbType = <font color="#A31515">"varchar (100)"</font> , CanBeNull = <font color="#0000ff">false</font> )] </li><li>  <font color="#0000ff">public</font> <font color="#0000ff">string</font> CountryName; </li><li>  [Column ( <font color="#008000">/ * DbType = "geography", * /</font> CanBeNull = <font color="#0000ff">false</font> )] </li><li>  <font color="#0000ff">public</font> SqlGeography CountryBoundary; </li><li>  } </li><li>  } </li><li></li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br><br>  Attributes are placed above the class declaration and above the fields.  For example, in line 7, the Table attribute indicates that this class is associated with a table in the database.  If the class name matches the table name, then the attribute can be written as I have, and if not, then the Name property should be specified: [Table (Name = "Boundaries_Country")]. <br><br>  In line 16, when describing an attribute for a field containing spatial data, in theory, I have to specify the geography data type, but since I don‚Äôt specify support for this data type yet, I don‚Äôt specify it. <br><br>  Another class is needed to create a database context.  We can use the already existing DataContext, but it is better to make our successor for strong typing. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">using</font> System.Data.Linq; </li><li></li><li>  <font color="#0000ff">namespace</font> mynamespace </li><li>  { </li><li>  <font color="#0000ff">public</font> <font color="#0000ff">class</font> ExampleDatabase: DataContext </li><li>  { </li><li>  <font color="#0000ff">public</font> table &lt;Boundaries_Country&gt; BoundariesCountry; </li><li>  <font color="#0000ff">public</font> ExampleDatabase ( <font color="#0000ff">string</font> connectionString) </li><li>  : <font color="#0000ff">base</font> (connectionString) </li><li>  { </li><li></li><li>  } </li><li>  } </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br><br>  An example, we will remove from the database all that is, but so that the name of the country begins with the letter "C". <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">static</font> <font color="#0000ff">void</font> Main ( <font color="#0000ff">string</font> [] args) </li><li>  { </li><li>  ExampleDatabase db = <font color="#0000ff">new</font> ExampleDatabase ( <font color="#A31515">@ "..."</font> ); </li><li></li><li>  <font color="#0000ff">var</font> q = <font color="#0000ff">from</font> item <font color="#0000ff">in</font> db.BoundariesCountry </li><li>  <font color="#0000ff">where</font> item.CountryName.StartsWith ( <font color="#A31515">"C"</font> ) </li><li>  <font color="#0000ff">select</font> item; </li><li></li><li>  <font color="#0000ff">foreach</font> ( <font color="#0000ff">var</font> item <font color="#0000ff">in</font> q) </li><li>  <font color="#2B91AF">Console</font> .WriteLine (item.CountryName); </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br><br>  It turned out not so much. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/a65/6b0/6ec/a656b06ec754e17ea2a53c1f3e8ebecc.png"></a>  One interesting point.  If, in debug mode, stop the execution of the program on line 9 and view the contents of the variable q, then we will see a LINQ to SQL generated query. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/032/743/f64/032743f64af50c21b69e21fcd9dbea4c.png"></a> <br><br><h2>  LINQ to SQL: working with spatial data </h2><br><br>  Consider a query that selects countries from a database that fall into a given rectangle, and whose name begins with the letter ‚ÄúC‚Äù. <br><br>  The rectangle is defined by a polygon (WKT-representation): POLYGON ((40 -28, 40 30, 5 30, 5 -28, 40 -28)). <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">var</font> q = <font color="#0000ff">from</font> item <font color="#0000ff">in</font> db.BoundariesCountry </li><li>  <font color="#0000ff">where</font> item.CountryName.StartsWith ( <font color="#A31515">"C"</font> ) &amp;&amp; </li><li>  item.CountryBoundary.STIntersects (sqlEnvelope) .Value </li><li>  <font color="#0000ff">select</font> item; </li><li></li><li>  <font color="#0000ff">foreach</font> ( <font color="#0000ff">var</font> item <font color="#0000ff">in</font> q) </li><li>  <font color="#2B91AF">Console</font> .WriteLine (item.CountryName); </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br><br>  This code will compile, but will not work. <br><br>  At runtime, on line 5, when LINQ to SQL needs to send a request to the server, an exception will be thrown: ‚ÄúMethod 'System.Data.SqlTypes.SqlBoolean STIntersects (Microsoft.SqlServer.Types.SqlGeography) . " <br><br>  To solve this problem, we will use stored procedures and table-valued functions, and we will send the geometric objects to the server in a well-understood SQL Server'u binary WKB format. <br><br><h3>  Stored procedures </h3><br><br>  To sample geometric shapes according to the criterion of hitting a given rectangle for one particular table, it is sufficient to create the following simple stored procedure. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> [dbo]. [Sp_bbx_Boundaries_Country] </li><li>  @boundingBox varbinary ( <font color="#0000ff">max</font> ) </li><li>  <font color="#0000ff">AS</font> </li><li>  <font color="#0000ff">BEGIN</font> </li><li>  <font color="#0000ff">SET</font> NOCOUNT <font color="#0000ff">ON</font> ; </li><li>  <font color="#0000ff">SELECT</font> * </li><li>  <font color="#0000ff">FROM</font> dbo.Boundaries_Country </li><li>  <font color="#0000ff">WHERE</font> GEOGRAPHY :: STGeomFromWKB (@boundingBox, </li><li>  4326) .STIntersects (CountryBoundary) = 1; </li><li>  <font color="#0000ff">RETURN</font> ; </li><li>  <font color="#0000ff">END</font> </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br><br>  The input parameter is a rectangle (specified by a polygon) in WKB format.  In line 8, it is converted by the static method STGeomFromWKB into an object of the geography data type and already on it the STIntersects function is called, which checks for a specific boundary in a rectangle. <br><br>  In the program, in the class that implements DataContext (we have this class called ExampleDatabase), we will describe the wrapper for calling this procedure. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  [Function ()] </li><li>  <font color="#0000ff">public</font> ISingleResult &lt;Boundaries_Country&gt; sp_bbx_Boundaries_Country ( </li><li>  [Parameter (DbType = <font color="#A31515">"varbinary (max)"</font> )] <font color="#0000ff">byte</font> [] boundingBox) </li><li>  { </li><li>  IExecuteResult execResult = <font color="#0000ff">this</font> .ExecuteMethodCall ( <font color="#0000ff">this</font> , ((MethodInfo) </li><li>  (MethodInfo.GetCurrentMethod ())), boundingBox); </li><li>  ISingleResult &lt;Boundaries_Country&gt; result = </li><li>  ((ISingleResult &lt;Boundaries_Country&gt;) execResult.ReturnValue); </li><li>  <font color="#0000ff">return</font> result; </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br><br>  Here, as well as for tables, attributes for functions and parameters are described. <br><br>  In line 4, the stored procedure is called and the result is stored in execResult, then, in line 5, it is converted to the required data type and returned to the main program. <br><br>  We use this "joy" as follows: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">var</font> q = <font color="#0000ff">from</font> item <font color="#0000ff">in</font> db.sp_bbx_Boundaries_Country ( </li><li>  sqlEnvelope.STAsBinary (). Buffer) </li><li>  <font color="#0000ff">where</font> item.CountryName.StartsWith ( <font color="#A31515">"C"</font> ) </li><li>  <font color="#0000ff">select</font> item; </li><li>  <font color="#0000ff">foreach</font> ( <font color="#0000ff">var</font> item <font color="#0000ff">in</font> q) </li><li>  <font color="#2B91AF">Console</font> .WriteLine (item.CountryName); </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br><br>  Result to console. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/55e/4df/6b3/55e4df6b38cc38fefdb2f4e5643a8a5a.png"></a>  Note, if you, as in my working draft, have several tables with geographic data, then the following options are available. <br><br><ol><li>  For each table, create its own stored procedure, and in the program for each stored procedure its own wrapper function.  You can simplify the life of the user api if you write a ‚Äúcentral‚Äù generic method in which, according to the current type used when calling the generic method, the private method wrapper of stored procedures will be called and the necessary type conversions will be performed. <br></li><li>  Write one stored procedure using dynamic sql.  The program will need to make one generic method, from which also, as in the previous version, specialized (by data type) wrapper methods around the same procedure will be called (it was not possible to escape from the attack, did not fight). </li></ol><br><br>  Stored procedures are good, but when used in LINQ to SQL, in the described manner, they have one major drawback: the stored procedures are executed immediately and from the server to the client all that fall into a given region, countries, and only then over this array are executed additional filtering.  Those.  Translation in SQL of the entire LINQ expression does not occur.  To avoid this problem, we can use SQL Server inline functions. <br><br><h3>  Table-valued functions </h3><br><br>  A table-valued function that retrieves records from a database table by the criterion of entering a specified region can be created as follows. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">CREATE</font> <font color="#0000ff">FUNCTION</font> [dbo]. [F_bbx_Boundaries_Country] </li><li>  ( </li><li>  @boundingBox varbinary ( <font color="#0000ff">max</font> ) </li><li>  ) </li><li>  <font color="#0000ff">RETURNS</font> <font color="#0000ff">TABLE</font> </li><li>  <font color="#0000ff">AS</font> </li><li>  <font color="#0000ff">RETURN</font> </li><li>  ( </li><li>  <font color="#0000ff">SELECT</font> * </li><li>  <font color="#0000ff">FROM</font> dbo.Boundaries_Country </li><li>  <font color="#0000ff">WHERE</font> GEOGRAPHY :: STGeomFromWKB ( </li><li>  @boundingBox, 4326) .STIntersects (CountryBoundary) = 1 </li><li>  ) </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br><br>  Those.  the content is completely similar to the stored procedure described earlier. <br><br>  For the function, you also need to create your own wrapper. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  [Function (IsComposable = <font color="#0000ff">true</font> )] </li><li>  <font color="#0000ff">public</font> IQueryable &lt;Boundaries_Country&gt; f_bbx_Boundaries_Country ( </li><li>  [Parameter (DbType = <font color="#A31515">"varbinary (max)"</font> )] <font color="#0000ff">byte</font> [] boundingBox) </li><li>  { </li><li>  <font color="#0000ff">return</font> <font color="#0000ff">this</font> .CreateMethodCallQuery &lt;Boundaries_Country&gt; ( <font color="#0000ff">this</font> , </li><li>  ((MethodInfo) (MethodInfo.GetCurrentMethod ())), boundingBox); </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br><br>  In the attribute of the method, we specify the IsComposable property, which says that now we will run the function on SQL Server, and not the stored procedure.  To call a function, use the CreateMethodCallQuery method. <br><br>  See an example. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">var</font> q = <font color="#0000ff">from</font> item <font color="#0000ff">in</font> db.f_bbx_Boundaries_Country ( </li><li>  sqlEnvelope.STAsBinary (). Buffer) </li><li>  <font color="#0000ff">where</font> item.CountryName.StartsWith ( <font color="#A31515">"C"</font> ) </li><li>  <font color="#0000ff">select</font> item; </li><li>  <font color="#0000ff">foreach</font> ( <font color="#0000ff">var</font> item <font color="#0000ff">in</font> q) </li><li>  <font color="#2B91AF">Console</font> .WriteLine (item.CountryName); </li><li></li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br><br>  The result is the same as when using a stored procedure. <br><br>  And in debugging we see a beautiful picture (all linq-expression was translated into a sql query): <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/dc9/74a/48c/dc974a48c467558efcb8b3126b42e25b.png"></a> <br>  Everything, I have nothing more to say to the people. <br></div><p>Source: <a href="https://habr.com/ru/post/49358/">https://habr.com/ru/post/49358/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../49353/index.html">Let's beat Ruby together! Drop nine</a></li>
<li><a href="../49354/index.html">Did Twitter find its business model?</a></li>
<li><a href="../49355/index.html">HP Alumni Program</a></li>
<li><a href="../49356/index.html">Welcome to Hollywood!</a></li>
<li><a href="../49357/index.html">Opera is watching you!</a></li>
<li><a href="../49359/index.html">Holidays are over, surprises continue ...</a></li>
<li><a href="../49360/index.html">Bottom-up development and database.</a></li>
<li><a href="../49361/index.html">The simplest drawing using PIL</a></li>
<li><a href="../49365/index.html">Design patterns for humans.</a></li>
<li><a href="../49372/index.html">Asus A6R and Ubuntu 8.10</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>