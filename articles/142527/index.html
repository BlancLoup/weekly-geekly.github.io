<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>TCP / IP proxy on Go</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I again returned to my favorite task for mastering new languages . After writing a blog engine for Go , I wanted to stretch my fingers again, the dise...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>TCP / IP proxy on Go</h1><div class="post__text post__text-html js-mediator-article">  I again returned to my favorite <a href="http://demin.ws/blog/russian/2011/11/19/problem-to-try-new-languages/">task for mastering new languages</a> .  After <a href="http://habrahabr.ru/post/142287/">writing a blog engine for Go</a> , I wanted to stretch my fingers again, the disease TCP / IP proxy / debugger is now written in Go. <br><br>  In short, TCP / IP proxy is a program that can accept connections and ‚Äúforward‚Äù them to the specified address.  Along the way, logs are transmitted data.  This is very useful when debugging various self-made network protocols. <br><br>  In terms of functionality, the Go version, like <a href="http://demin.ws/blog/russian/2011/11/26/improved-tcpip-proxy-in-erlang/">Erlang</a> , has three logs: a bi-directional hex dump and binary logs in both directions, ‚Äúfrom‚Äù and ‚Äúto‚Äù the remote host.  <a href="http://demin.ws/blog/russian/2009/09/04/multi-threaded-tcpip-debugger/">Python version of</a> binary logs does not lead. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Of course, everything is multithreaded.  And since in Go, parallel programming is so simple (and safe), the number of parallel activities for each connection is even greater than in the Erlang version. <br><a name="habracut"></a><br>  The following four streams worked on the Erlang for each connection: <br><ul><li>  bidirectional dump logger </li><li>  two streams for binary logs of received and sent data </li><li>  main stream multiplexing reading from local and remote sockets </li></ul><br>  In the version on Go, it is a little different: <br><ul><li>  bidirectional dump logger </li><li>  two streams for binary logs of received and sent data </li><li>  two <b>independent</b> threads for reading from local and remote socket </li></ul><br>  Total 5. <br><br>  In both cases, the reading threads log the data by sending messages to the logger threads.  Of course, there are no stupid things like mutexes or conditional variables.  Matching problems are elegantly solved through the Go channels. <br><br>  Below is the source.  It differs from that in the repository by the presence of abundant comments.  For people who are not very familiar with Go, some moments may be interesting. <br><br><pre><code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"flag"</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"net"</span></span> <span class="hljs-string"><span class="hljs-string">"os"</span></span> <span class="hljs-string"><span class="hljs-string">"strings"</span></span> <span class="hljs-string"><span class="hljs-string">"time"</span></span> <span class="hljs-string"><span class="hljs-string">"encoding/hex"</span></span> <span class="hljs-string"><span class="hljs-string">"runtime"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ( host *<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> = flag.String(<span class="hljs-string"><span class="hljs-string">"host"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"target host or address"</span></span>) port *<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> = flag.String(<span class="hljs-string"><span class="hljs-string">"port"</span></span>, <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-string"><span class="hljs-string">"target port"</span></span>) listen_port *<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> = flag.String(<span class="hljs-string"><span class="hljs-string">"listen_port"</span></span>, <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-string"><span class="hljs-string">"listen port"</span></span>) ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">die</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(format </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, v ...</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span></span> { os.Stderr.WriteString(fmt.Sprintf(format+<span class="hljs-string"><span class="hljs-string">"\n"</span></span>, v...)) os.Exit(<span class="hljs-number"><span class="hljs-number">1</span></span>) } <span class="hljs-comment"><span class="hljs-comment">//       . func connection_logger(data chan []byte, conn_n int, local_info, remote_info string) { log_name := fmt.Sprintf("log-%s-%04d-%s-%s.log", format_time(time.Now()), conn_n, local_info, remote_info) logger_loop(data, log_name) } //     . func binary_logger(data chan []byte, conn_n int, peer string) { log_name := fmt.Sprintf("log-binary-%s-%04d-%s.log", format_time(time.Now()), conn_n, peer) logger_loop(data, log_name) } //     .  -   //  .   -      //  .     - . // func logger_loop(data chan []byte, log_name string) { f, err := os.Create(log_name) if err != nil { die("Unable to create file %s, %v\n", log_name, err) } defer f.Close() //      . for { b := &lt;-data if len(b) == 0 { break } f.Write(b) f.Sync() //    flush'. } } func format_time(t time.Time) string { return t.Format("2006.01.02-15.04.05") } func printable_addr(a net.Addr) string { return strings.Replace(a.String(), ":", "-", -1) } // ,     . ,  //    . type Channel struct { from, to net.Conn logger, binary_logger chan []byte ack chan bool } // , ""         . //   . func pass_through(c *Channel) { from_peer := printable_addr(c.from.LocalAddr()) to_peer := printable_addr(c.to.LocalAddr()) b := make([]byte, 10240) offset := 0 packet_n := 0 for { n, err := c.from.Read(b) if err != nil { c.logger &lt;- []byte(fmt.Sprintf("Disconnected from %s\n", from_peer)) break } if n &gt; 0 { //  - ,      . c.logger &lt;- []byte(fmt.Sprintf("Received (#%d, %08X) %d bytes from %s\n", packet_n, offset, n, from_peer)) //  ,      hex-. ,   ? c.logger &lt;- []byte(hex.Dump(b[:n])) c.binary_logger &lt;- b[:n] c.to.Write(b[:n]) c.logger &lt;- []byte(fmt.Sprintf("Sent (#%d) to %s\n", packet_n, to_peer)) offset += n packet_n += 1 } } c.from.Close() c.to.Close() c.ack &lt;- true //     ,   . } //    .      //  . func process_connection(local net.Conn, conn_n int, target string) { //    ,    . remote, err := net.Dial("tcp", target) if err != nil { fmt.Printf("Unable to connect to %s, %v\n", target, err) } local_info := printable_addr(remote.LocalAddr()) remote_info := printable_addr(remote.RemoteAddr()) //   . started := time.Now() //      . logger := make(chan []byte) from_logger := make(chan []byte) to_logger := make(chan []byte) //       . ack := make(chan bool) //  . go connection_logger(logger, conn_n, local_info, remote_info) go binary_logger(from_logger, conn_n, local_info) go binary_logger(to_logger, conn_n, remote_info) logger &lt;- []byte(fmt.Sprintf("Connected to %s at %s\n", target, format_time(started))) //   . go pass_through(&amp;Channel{remote, local, logger, to_logger, ack}) go pass_through(&amp;Channel{local, remote, logger, from_logger, ack}) //     . &lt;-ack &lt;-ack //   . finished := time.Now() duration := finished.Sub(started) logger &lt;- []byte(fmt.Sprintf("Finished at %s, duration %s\n", format_time(started), duration.String())) //    .       // ,         ,    //   . logger &lt;- []byte{} from_logger &lt;- []byte{} to_logger &lt;- []byte{} } func main() { //  Go      . runtime.GOMAXPROCS(runtime.NumCPU()) //    (,   ?) flag.Parse() if flag.NFlag() != 3 { fmt.Printf("usage: gotcpspy -host target_host -port target_port -listen_post=local_port\n") flag.PrintDefaults() os.Exit(1) } target := net.JoinHostPort(*host, *port) fmt.Printf("Start listening on port %s and forwarding data to %s\n", *listen_port, target) ln, err := net.Listen("tcp", ":"+*listen_port) if err != nil { fmt.Printf("Unable to start listener, %v\n", err) os.Exit(1) } conn_n := 1 for { //   . if conn, err := ln.Accept(); err == nil { //    . go process_connection(conn, conn_n, target) conn_n += 1 } else { fmt.Printf("Accept failed, %v\n", err) } } }</span></span></code> </pre> <br>  Again, each connection is served by <b>five</b> threads.  And I did it not for fun.  It just seemed to me that logically there are clearly independent subtasks that it would be logical to run in parallel.  If I wrote everything in C ++ / boost, I‚Äôd most likely fouled everything up with one thread for each connection (and maybe the whole program would be purely single-threaded through some sophisticated multiplexing libraries), and it‚Äôs possible that in C ++ also would work faster, despite one flow.  But I do not want to say this.  Go pushes for multi-threaded programming (and does not repel, like C ++, even on steroids of the new standard).  Anyway, there will be tasks where convenient multithreading will become a key factor. <br><br>  You can start this way (at least Go release 1 is required): <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">go</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">run</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">gotcpspy</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.go</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-host</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pop</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yandex</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ru</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-port</span></span> 110 <span class="hljs-selector-tag"><span class="hljs-selector-tag">-local_port</span></span> 8080</code> </pre><br>  Output: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">Start</span></span> listening <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> port <span class="hljs-number"><span class="hljs-number">8080</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> forwarding <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> pop.yandex.ru:<span class="hljs-number"><span class="hljs-number">110</span></span></code> </pre><br>  Then, if you enter in another window: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">telnet</span></span> localhost <span class="hljs-number"><span class="hljs-number">8080</span></span></code> </pre><br>  and enter, for example, " <code>USER test</code> ", " <code>ENTER</code> " and " <code>PASS none</code> ", " <code>ENTER</code> ", three logs will be created (the date in the name will, of course, be different). <br><br>  The general log of <code>log-2012.04.20-19.55.17-0001-192.168.1.41-49544-213.180.204.37-110.log</code> : <br><br><pre> <code class="hljs go"> Connected to pop.yandex.ru:<span class="hljs-number"><span class="hljs-number">110</span></span> at <span class="hljs-number"><span class="hljs-number">2012.04</span></span><span class="hljs-number"><span class="hljs-number">.20</span></span><span class="hljs-number"><span class="hljs-number">-19.55</span></span><span class="hljs-number"><span class="hljs-number">.17</span></span> Received (#<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">00000000</span></span>) <span class="hljs-number"><span class="hljs-number">38</span></span> bytes from <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.41</span></span><span class="hljs-number"><span class="hljs-number">-49544</span></span> <span class="hljs-number"><span class="hljs-number">00000000</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>b <span class="hljs-number"><span class="hljs-number">4f</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>b <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">4f</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">59</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">76</span></span> <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>e <span class="hljs-number"><span class="hljs-number">30</span></span> |+OK POP Ya! v1<span class="hljs-number"><span class="hljs-number">.0</span></span>| <span class="hljs-number"><span class="hljs-number">00000010</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>e <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>e <span class="hljs-number"><span class="hljs-number">61</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">36</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>a <span class="hljs-number"><span class="hljs-number">4</span></span>a <span class="hljs-number"><span class="hljs-number">69</span></span> <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> |<span class="hljs-number"><span class="hljs-number">.0</span></span>na@<span class="hljs-number"><span class="hljs-number">26</span></span> HtjJitcP| <span class="hljs-number"><span class="hljs-number">00000020</span></span> <span class="hljs-number"><span class="hljs-number">52</span></span> <span class="hljs-number"><span class="hljs-number">75</span></span> <span class="hljs-number"><span class="hljs-number">51</span></span> <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">0d</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>a |RuQ1..| Sent (#<span class="hljs-number"><span class="hljs-number">0</span></span>) to [-<span class="hljs-number"><span class="hljs-number">-1</span></span>]<span class="hljs-number"><span class="hljs-number">-8080</span></span> Received (#<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">00000000</span></span>) <span class="hljs-number"><span class="hljs-number">11</span></span> bytes from [-<span class="hljs-number"><span class="hljs-number">-1</span></span>]<span class="hljs-number"><span class="hljs-number">-8080</span></span> <span class="hljs-number"><span class="hljs-number">00000000</span></span> <span class="hljs-number"><span class="hljs-number">55</span></span> <span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-number"><span class="hljs-number">45</span></span> <span class="hljs-number"><span class="hljs-number">52</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">65</span></span> <span class="hljs-number"><span class="hljs-number">73</span></span> <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">0d</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>a |USER test..| Sent (#<span class="hljs-number"><span class="hljs-number">0</span></span>) to <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.41</span></span><span class="hljs-number"><span class="hljs-number">-49544</span></span> Received (#<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">00000026</span></span>) <span class="hljs-number"><span class="hljs-number">23</span></span> bytes from <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.41</span></span><span class="hljs-number"><span class="hljs-number">-49544</span></span> <span class="hljs-number"><span class="hljs-number">00000000</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>b <span class="hljs-number"><span class="hljs-number">4f</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>b <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">70</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span> <span class="hljs-number"><span class="hljs-number">73</span></span> <span class="hljs-number"><span class="hljs-number">73</span></span> <span class="hljs-number"><span class="hljs-number">77</span></span> <span class="hljs-number"><span class="hljs-number">6f</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>c <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">70</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c |+OK password, pl| <span class="hljs-number"><span class="hljs-number">00000010</span></span> <span class="hljs-number"><span class="hljs-number">65</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span> <span class="hljs-number"><span class="hljs-number">73</span></span> <span class="hljs-number"><span class="hljs-number">65</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>e <span class="hljs-number"><span class="hljs-number">0d</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>a |ease...| Sent (#<span class="hljs-number"><span class="hljs-number">1</span></span>) to [-<span class="hljs-number"><span class="hljs-number">-1</span></span>]<span class="hljs-number"><span class="hljs-number">-8080</span></span> Received (#<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0000000</span></span>B) <span class="hljs-number"><span class="hljs-number">11</span></span> bytes from [-<span class="hljs-number"><span class="hljs-number">-1</span></span>]<span class="hljs-number"><span class="hljs-number">-8080</span></span> <span class="hljs-number"><span class="hljs-number">00000000</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">41</span></span> <span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>e <span class="hljs-number"><span class="hljs-number">6f</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>e <span class="hljs-number"><span class="hljs-number">65</span></span> <span class="hljs-number"><span class="hljs-number">0d</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>a |PASS none..| Sent (#<span class="hljs-number"><span class="hljs-number">1</span></span>) to <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.41</span></span><span class="hljs-number"><span class="hljs-number">-49544</span></span> Received (#<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">0000003</span></span>D) <span class="hljs-number"><span class="hljs-number">72</span></span> bytes from <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.41</span></span><span class="hljs-number"><span class="hljs-number">-49544</span></span> <span class="hljs-number"><span class="hljs-number">00000000</span></span> <span class="hljs-number"><span class="hljs-number">2d</span></span> <span class="hljs-number"><span class="hljs-number">45</span></span> <span class="hljs-number"><span class="hljs-number">52</span></span> <span class="hljs-number"><span class="hljs-number">52</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>b <span class="hljs-number"><span class="hljs-number">41</span></span> <span class="hljs-number"><span class="hljs-number">55</span></span> <span class="hljs-number"><span class="hljs-number">54</span></span> <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">5d</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c <span class="hljs-number"><span class="hljs-number">6f</span></span> <span class="hljs-number"><span class="hljs-number">67</span></span> <span class="hljs-number"><span class="hljs-number">69</span></span> |-ERR [AUTH] logi| <span class="hljs-number"><span class="hljs-number">00000010</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>e <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span> <span class="hljs-number"><span class="hljs-number">69</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c <span class="hljs-number"><span class="hljs-number">75</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-number"><span class="hljs-number">65</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">6f</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">4f</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> |n failure or POP| <span class="hljs-number"><span class="hljs-number">00000020</span></span> <span class="hljs-number"><span class="hljs-number">33</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">69</span></span> <span class="hljs-number"><span class="hljs-number">73</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span> <span class="hljs-number"><span class="hljs-number">62</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c <span class="hljs-number"><span class="hljs-number">65</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>c <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-number"><span class="hljs-number">79</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> |<span class="hljs-number"><span class="hljs-number">3</span></span> disabled, try | <span class="hljs-number"><span class="hljs-number">00000030</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c <span class="hljs-number"><span class="hljs-number">61</span></span> <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">65</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>e <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">73</span></span> <span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-number"><span class="hljs-number">3d</span></span> <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>a <span class="hljs-number"><span class="hljs-number">4</span></span>a <span class="hljs-number"><span class="hljs-number">69</span></span> <span class="hljs-number"><span class="hljs-number">74</span></span> |later. sc=HtjJit| <span class="hljs-number"><span class="hljs-number">00000040</span></span> <span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">52</span></span> <span class="hljs-number"><span class="hljs-number">75</span></span> <span class="hljs-number"><span class="hljs-number">51</span></span> <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">0d</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>a |cPRuQ1..| Sent (#<span class="hljs-number"><span class="hljs-number">2</span></span>) to [-<span class="hljs-number"><span class="hljs-number">-1</span></span>]<span class="hljs-number"><span class="hljs-number">-8080</span></span> Disconnected from <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.41</span></span><span class="hljs-number"><span class="hljs-number">-49544</span></span> Disconnected from [-<span class="hljs-number"><span class="hljs-number">-1</span></span>]<span class="hljs-number"><span class="hljs-number">-8080</span></span> Finished at <span class="hljs-number"><span class="hljs-number">2012.04</span></span><span class="hljs-number"><span class="hljs-number">.20</span></span><span class="hljs-number"><span class="hljs-number">-19.55</span></span><span class="hljs-number"><span class="hljs-number">.17</span></span>, duration <span class="hljs-number"><span class="hljs-number">5.253979s</span></span></code> </pre><br>  The binary log of outgoing data <code>log-binary-2012.04.20-19.55.17-0001-192.168.1.41-49544.log</code> : <br><br><pre> <code class="hljs pgsql"> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> test PASS <span class="hljs-keyword"><span class="hljs-keyword">none</span></span></code> </pre><br>  The binary log of the incoming data <code>log-binary-2012.04.20-19.55.17-0001-213.180.204.37-110.log</code> : <br><br><pre> <code class="hljs pgsql"> +OK POP Ya! v1<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>na@<span class="hljs-number"><span class="hljs-number">26</span></span> HtjJitcPRuQ1 +OK <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>, please. -ERR [AUTH] <span class="hljs-keyword"><span class="hljs-keyword">login</span></span> failure <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> POP3 disabled, try later. sc=HtjJitcPRuQ1</code> </pre><br>  Now measure the performance.  Bleed the file directly, and then through this program. <br><br>  Download directly (file size is about 72MB): <br><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">time</span></span> wget http://www.erlang.org/download/otp_src_R15B01.tar.gz ... Saving to: `otp_src_R15B01.tar.gz<span class="hljs-string"><span class="hljs-string">' ... real 1m2.819s</span></span></code> </pre><br>  Now we download through the program, after running it: <br><br><pre> <code class="hljs go"> <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> run gotcpspy.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> -host=www.erlang.org -port=<span class="hljs-number"><span class="hljs-number">80</span></span> -listen_port=<span class="hljs-number"><span class="hljs-number">8080</span></span></code> </pre><br>  Downloading: <br><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">time</span></span> wget http://localhost:8080/download/otp_src_R15B01.tar.gz ... Saving to: `otp_src_R15B01.tar.gz.<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">' ... real 0m56.209s</span></span></code> </pre><br>  Just in case, you can compare the results: <br><br><pre>  diff otp_src_R15B01.tar.gz otp_src_R15B01.tar.gz.1
</pre><br>  I have the same files, then everything works correctly. <br><br>  Now is the time.  I repeated the experiment several times (on Mac Air), and, surprisingly, downloading through the program was always not that slower, but even a little faster.  For example, directly - 1m2.819s, through the program - 0m56.209s.  The only explanation is that wget probably works in one thread, and the program accepts data from a local and remote socket in two threads, which can give a slight acceleration.  But, the difference is still minimal, and perhaps on another machine or network it will not be visible, but the main thing is that it works at least <b>not more slowly</b> than directly, despite the creation of very massive logs during the transfer. <br><br>  So, so far among the three options for such a program, on Piton, Erlang and Go, the last one I like the most. <br><br>  It seemed to me a good experiment with parallelism in Go. <br><br><h3>  Posts on the topic </h3><br><ul><li>  <a href="http://demin.ws/blog/russian/2011/11/22/tcpip-proxy-in-erlang/">TCP / IP proxy on Erlang'e</a> </li><li>  <a href="http://demin.ws/blog/russian/2011/11/26/improved-tcpip-proxy-in-erlang/">Improved TCP / IP proxy on Erlang'e</a> </li><li>  <a href="http://demin.ws/blog/russian/2009/09/04/multi-threaded-tcpip-debugger/">Multi-thread debugger for TCP / IP connections</a> (on Python) </li></ul><br><h3>  Repository links </h3><br><ul><li>  <a href="https://github.com/begoon/go-tcpspy">Go</a> </li><li>  <a href="https://github.com/begoon/erl-tcpspy">Erlang</a> </li><li>  <a href="https://github.com/begoon/py-tcpspy">Python</a> </li></ul><br><h3>  PS </h3><br>  By the way, if one of the javistes would have muddied a similar program (if possible, which does not require Eclipse / IDEA / ant / maven / spring / log4j / ivy, etc.) to build, it would be very interesting to compare.  And not in terms of efficiency and speed, but in terms of beauty, elegance. </div><p>Source: <a href="https://habr.com/ru/post/142527/">https://habr.com/ru/post/142527/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../142520/index.html">And the winner was ... The results of our survey on the use of .Net ORM</a></li>
<li><a href="../142521/index.html">Malicious Extensions Spread on Chrome Webstore</a></li>
<li><a href="../142522/index.html">User Koavf made 1 million Wikipedia edits</a></li>
<li><a href="../142524/index.html">Sites under LSD</a></li>
<li><a href="../142526/index.html">Ukrainian deputies want to close any site without trial for 7 days</a></li>
<li><a href="../142528/index.html">Simple WEB-quest for non-IT students</a></li>
<li><a href="../142530/index.html">Practical optimization and scalability of MySQL InnoDB on large amounts of data</a></li>
<li><a href="../142533/index.html">IT (and not only) life in Brazil 2</a></li>
<li><a href="../142534/index.html">Shadow Triangles on CSS</a></li>
<li><a href="../142537/index.html">Podcast "Notes on Qt" s01e02</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>