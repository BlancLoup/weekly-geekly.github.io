<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A little more about Xiaomi phones and fighting with them. Updated</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Honestly, I didn‚Äôt have plans to write and publish this article, but after two months I saw 5 colleagues in the closest circle of colleagues from Xiao...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A little more about Xiaomi phones and fighting with them. Updated</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/8de/2e9/3a7/8de2e93a76599f0a3107eca4caccd6d4.jpg" alt="image"><br><br>  Honestly, I didn‚Äôt have plans to write and publish this article, but after two months I saw 5 colleagues in the closest circle of colleagues from Xiaomi‚Äôs newly purchased phones, and a recent <a href="https://geektimes.ru/company/gearbest/blog/276400/">article</a> on Geektimes advertising smart home management from Xiaomi to me conscience came and, <s>bitch</s> , demanded to share knowledge with the rest. <br><a name="habracut"></a><br>  For a start, a small introduction for those who are not in the subject.  There is a company Xiaomi, which makes quite good stuff on the phone and floods them with customized Android.  The business model, as it was officially announced recently, ‚ÄúIn fact, we distribute our smartphones, without earning money from it.  We care more about long-term sources of income.  We could sell 10 billion smartphones and not earn a cent from them. ‚Äù  Source <a href="http://www.playground.ru/blogs/other/xiaomi_priznalas_chto_prodaet_svoi_smartfony_po_sebestoimosti-224463/">one</a> and <a href="http://www.reuters.com/article/us-xiaomi-china-idUSKBN13K0XE">two</a> . <br><br>  Glancing at the September <a href="http://www.securitylab.ru/news/483861.php">article</a> on Security lab and yet <a href="http://en.miui.com/forum.php%3Fmod%3Dviewthread%26tid%3D370873%26page%3D3">this</a> complaint, I personally had the feeling that the Xiaomi phone is something like a leash on which the Big Brother drives the owner (I exaggerate, of course). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This was the main motive for conducting a study of the behavior of the phone Xiaomi redmi 3S <br>  with firmware MIUI Global 8.1 Stable 8.1.1.0 (MALMIDI) <br><br>  Test rabbit test and problem detection <br>  I take a new phone out of the box.  I turn it on and go through the initial setup wizard by first turning on the traffic recording on the Wi-Fi router.  Exactly two seconds later, after the phone connected to the access point, the download of a file of about 8 MB in size from one of the Xiaomi servers began.  It was a regular zip archive, inside of which lay a lot of everything, including the AnalyticsCore.apk file mentioned in the article on SecurityLab. <br><br>  Further more.  In total, for all the observation time, I counted a <b>little less than eight dozen server names</b> in different domains.  I‚Äôll just say that there are no Google and Facebook servers in this number, the applications of which are also preinstalled.  Just because I counted them separately.  With them, too, everything is "fun." <br><br>  Most of the connections to the Xiaomi servers were via HTTPS, so it was not possible to figure out the details exactly what was transmitted directly.  Disabling all sorts of logins, syncs, etc.  to the disappearance of this traffic has not led. <br><br>  Additionally, it was embarrassing that most of the requests were small (the amount of received transmitted TCP traffic of sessions did not exceed 1-2 Kb), but since  Our mobile operators round up the traffic volume up (for example, Tele2 to 150Kb), then, if an unsuccessful coincidence occurs, you can ‚Äúpump‚Äù substantial amounts of traffic in this way, and in roaming you can suddenly get money. <br><br>  Those who are not confused by this fact can no longer read, because  Further, there will be a description of the specifics of isolating traffic from applications embedded in the factory firmware. <br><br><h3>  Prerequisites </h3><br>  The first thing you need is to rant the phone.  How this is done in the case of Xiaomi, I will not describe here, referring those who wish to go this way to the full version of this article (link at the end). <br>  The second is to inject the firmware through the cable into the phone and erase ALL user data. <br>  Third, the phone MUST NOT have access to the Internet after a fresh firmware download. <br>  Update.  Until the installation of the following limitations, of course. <br><br>  <b>Disclamier.</b>  <b>All further manipulations on the phone you do at your own peril and risk.</b> <b><br></b>  <b>Responsibility for any outcome lies with who exactly did the actions described below.</b> <br><br><h3>  Small technical introduction </h3><br>  The servers accessed by the phone are mostly located in the Amazon cloud, so calls are made to them by names that are resolved via round-robin DNS to different IP addresses from different subnets / 16.  Blocking them all by subnets makes no sense - you can filter out half of the Internet, which is not good.  Blocking by name is good, but not the fact that host names from L3 domains are not dynamically generated.  It would be ideal to nail all applications that access Xiaomi servers, but, as practice has shown, the depth of their integration into Android is such that after removing some of them, the phone may simply refuse to boot. <br><br>  Further.  External servers are accessed not by one process, but by many, and the task is complicated by the availability of Android UID sharing, when different processes (applications) can generate network traffic under one UID.  Moreover, one of the useful processes (responsible for GPS) must be released to the outside world in order to download small updates, but at the same time it sat under the same UID as the eight pieces of processes rushing to Xiaomi servers. <br><br>  It is also necessary to mention the limitations of the tools available for solving the above tasks, because  Most of the applications with the name of the firewall available on the Play Market work through the so-called.  VPN, i.e.  they do not protect them from information plums to launching the application. <br><br>  Much of what will be discussed later for professional Android developers is a banal truth, but for everyone else this will make it possible to understand why filtering is built in this way. <br><br>  Unlike regular Linux, where there are configuration files and startup scripts in / etc, everything is different in Android.  The overall network management is performed by the Connection Manager, which is pulled by the netd system daemon, which, in turn, calls iptables with certain command line parameters.  Accordingly, there is no special reason to call IPtables from the initial boot script (init and others) - netd will still invoke iptables at the start, clear the rules and flood its own ones. <br><br>  The only solution left by Google is to write the necessary iptables configuration commands in the /system/bin/oem-iptables-init.sh script.  The path to this script and its name are hard-coded inside the source code of the netd daemon. <br><br>  To filter static host names, you can edit the / etc / hosts file, but be aware of their number and the possibility of their dynamic generation. <br>  Next will be the story of how it all was done. <br><br><h3>  Remove and freeze (if not sure) unnecessary programs </h3><br>  With the free version of Titanium Backup, you can see the correspondence between the program name shown in the system (Play Market), its codename (com.google.vending) and, if necessary, delete what is <b>clearly</b> not necessary. <br><br>  The disadvantage of the free version is that it does not know how to freeze programs, therefore we freeze through the ADB shell using the package manager.  Example: <br><br><pre><code>root@land:/ # pm disable com.miui.analytics
pm disable com.miui.analytics
Package com.miui.analytics new state: disabled
root@land:/ # pm disable com.miui.systemAdSolution
pm disable com.miui.systemAdSolution
Package com.miui.systemAdSolution new state: disabled
root@land:/ # reboot
reboot</code></pre><br>
<h3>  </h3><br>
<i>Disclamier 2.       ¬´¬ª   .    ‚Äî    .</i><br>
<br>
   .<br>
<br>
<b>1.</b> C  ‚Äî   /etc/hosts    c IP  127.0.0.1.      <a href="https://drive.google.com/drive/folders/0B_27A62KIOxURzhBaWxzRFo3Znc%3Fusp%3Dsharing">Google Drive</a>   Files.<br>
  ‚Äî           L3/L4.<br>
<br>
<b>Update.</b>      Netfilter/IPtables.           ,   .      ‚Äî     . <s> -,   .<br>
</s> <a href="http://ipset.netfilter.org/iptables.man.html"></a>    --wait,       . ,    ,    IPtables    ,    ,     ,  ,      ,    .<br>
<br>
<b>2.</b>        /16  /24   Netfilter/IPtables   oem-iptables-init.sh.    ,    ,      .<br>
Update.   ‚Äî       Amazon    (round-robin DNS) IP .           /16,    .      .     (  )    .<br>
<br>
<b>3.</b>  DNS     .   ,   .<br>
<br>
Updated.  IPtables,    Android    ,     . ,  DNS    (UID 0)  :<br>
<br>
<pre><code>$IPTABLES -A oem_out --protocol udp --dport 53 -m owner --uid-owner 0 -m string --algo bm --hex-string '|04|miui|03|com|00|' -m comment --comment "Deny UID 0 DNS queries for miui.com domain" -j DROP
#
$IPTABLES -A oem_out --protocol udp --dport 53 -m owner --uid-owner 0 -j ACCEPT</code></pre><br>
Updated.     UDP ,   (UID 0)  53 UDP   IP       046d69756903636f6d00 (  DNS     .miui.com). IPtables    |04|miui|03|com|00|     046d69756903636f6d00. <br>
        --hex-string ‚Äî ,  IPtables   . -      DNS     ,      .      (00h).<br>
<br>
     DNS .     ,   iptables -L -v    .<br>
<br>
<b>4.</b>   Assited GPS       QualComm   UID 1000.   , ..     ,    DNS ,   ‚Äî    TCP  c  SYN, ACK <b></b>      ,     HTTP ,      HTTP  <b></b>       .       TCP    ,      .<br>
           3-4 :<br>
<br>
<pre><code>#    TCP   80      UID 1000.
$IPTABLES -A oem_out -m owner --uid-owner 1000 --protocol tcp --dport 80 -m conntrack --ctstate NEW -j ACCEPT
#   xtrapath   TCP     80    UID 1000        5555.
$IPTABLES -A oem_out -m owner --uid-owner 1000 --protocol tcp --dport 80 -m conntrack --ctstate ESTABLISHED -m string --algo bm --string 'xtrapath' -j CONNMARK --set-xmark 0x5555
#       UID 1000 TCP       5555
$IPTABLES -A oem_out -m owner --uid-owner 1000 --protocol tcp --dport 80 -m conntrack --ctstate ESTABLISHED -m connmark ! --mark 0x5555 -j DROP
</code></pre><br>
<b>5.</b>       (  Google Chrome  UID 10060).     Google Chrome     .<br>
<br>
<pre><code>$IPTABLES -A oem_out -m owner --uid-owner 10060 -m comment --comment "Permit Google Chrome internet access" -j ACCEPT
#
# Block all other processes
#
$IPTABLES -A oem_out -m owner --uid-owner 0-9999 -m comment --comment "Block all other system processes internet access" -j DROP
$IPTABLES -A oem_out -m owner --uid-owner 10000-99999 -m comment --comment "Block all other user processes internet access" -j DROP
</code></pre><br>
           UID         Netfilter/IPtables.     TCP    Google,     UID.  ,      Google Captive portal login.       ‚Äî       ADB shell:<br>
<br>
<pre><code>root@land:/ # settings put global captive_portal_detection_enabled 0
root@land:/ # reboot
</code></pre><br>
<s>,  (        Wi-Fi ),        UID    .<br>
</s><br>
<b>Update. </b>     .  ¬´¬ª  ,            127.0.0.1,  .<br>
   .<br>
,    ,         :<br>
<pre><code>$IPTABLES -A oem_out --protocol all --source 127.0.0.0/8 --destination 127.0.0.0/8 -m comment --comment "Accept internal traffic" --jump ACCEPT
$IPTABLES -A oem_out --protocol all -m owner ! --uid-owner 0-99999 -m comment --comment "Drop any traffic which does not have UID." --jump DROP
</code></pre><br>
<b>Update. </b>        ,  UID ,     ,   /     . ,             Netfilter/IPtables .<br>
       ,       ,       , ,  ,    UID    (   )   Netfilter/IPtables. <br>
<i>  ‚Äî      ‚Äî   .    ,     ,          ‚Äî .   /dev    . ,        .<br>
</i>    ,   .<br>
<cut><br>
<pre><code># Permit intenet access for the packages listed at the end of this file. White list mode. 
#
SU=`/system/bin/which su`
# changing reading file behavior (read whole file with \r\n into variable)
IFS=""
# reading first and second fields of every line of the system packages database into variable PACKAGESDB. 
# Escalating privileges via su because of filesystem packages database file access limitations.
PACKAGESDB=`$SU -c "/system/bin/cut -d' ' -f 1,2 /data/system/packages.list"`
#
# Reading last lines of current script form the end till "exit 0" line
# Filtering empty lines, lines started with # and all symbols after # (comments) in every line.
# 
# 's/#.*//' - remove all in every line after #
# '/^#/d' - remove lines staring with #
# '/./!d' - remove empty lines
# '/exit 0/,$ d' - remove all lines starting line with "exit 0"
# 's/ //g' - remove spaces from line
#
/system/bin/tac $0 | /system/bin/sed -e '/^#/d' -e 's/#.*//' -e '/exit 0/,$ d' -e '/./!d' -e 's/ //g'| while read line;
do
# Just in case 8-)
OUR_PACKAGE_NAME=$line
# Strict checking for existence of our package name in the system packages database. Checking first field.
PACKAGE_NAME_IN_DB=`echo $PACKAGESDB | /system/bin/cut -f 1 -d' ' | /system/bin/grep -Fx "$line"`
if
# Checking grep utility exit code. "0" means pattern found
test "$?" == "0"
then
#
# Looking for package UID in database. Checking second field. VERY important space after $line!!!
#
PACKAGE_UID=`echo $PACKAGESDB |  /system/bin/grep "$line " | /system/bin/cut -f 2 -d' '`
else
# All other exit codes return us to the beginning of the cycle.
# echo "Package $OUR_PACKAGE_NAME not found"
$IPTABLES -A $CHAIN -m comment --comment "Package name $OUR_PACKAGE_NAME not found. Check package name." --jump LOG
continue
fi
#
# Set the package right for Internet access
# 
$IPTABLES -A $CHAIN -m owner --uid-owner $PACKAGE_UID -m comment --comment "Permit $OUR_PACKAGE_NAME Internet access" -j ACCEPT
#
done
######
... skipped...
####
exit 0
#### 
####### Do NOT edit before this line #########
# Please add package names and comments after this line for granting them internet access.
#####
# Google Play Store and its companion processes
# 
com.google.android.gms # Google Services Framework Internet access
com.android.vending # Google Play Market internet access
com.android.providers.downloads # Download manager service internet access
#
# Other Google apps
com.google.android.youtube # Youtube application internet access
com.google.android.apps.maps # Google Maps application internet access
com.google.android.googlequicksearchbox # Google Assistant internet access
#
#
com.android.chrome # Google Chrome browser internet access
</code></pre><br>
<cut><br>
 /      .<br>
<br>
<b>6.</b>      Netfilter/IPtables      :<br>
<br>
<pre><code>$IPTABLES -A oem_out --source 10.1.30.42 --protocol tcp --jump LOG --log-prefix "IPtables log:" --log-uid</code></pre><br>
 IP   (--source 10.1.30.42)  ,           ,    127.0.0.1  hosts.      dmesg (dmesg | grep IPtables)  ADB Shell.<br>
<br>
 ,           Xioami Redmi 3S    <a href="https://drive.google.com/drive/folders/0B_27A62KIOxURzhBaWxzRFo3Znc%3Fusp%3Dsharing">Google Drive</a>.       - .<br>
<br>
<b>P.S.</b>    Android-,         . ,  ,     ‚Äî .  .<br>
<br>
<b>P.P.S.</b>      Zyxel Keenetic Extra.      Wi-Fi         .</cut></cut></div><p>Source: <a href="https://habr.com/ru/post/320612/">https://habr.com/ru/post/320612/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320598/index.html">Crowd development of a scoring system for the IEM system</a></li>
<li><a href="../320600/index.html">The system of decision making and risk management on the example of life</a></li>
<li><a href="../320602/index.html">Fighting cheaters in online games: 22 ‚Äúmust‚Äù and ‚Äúcannot‚Äù</a></li>
<li><a href="../320604/index.html">What has changed in 2016 in the field of programming? Results of the past year and plans for 2017</a></li>
<li><a href="../320610/index.html">Paradise perfectionist or what should be cable management</a></li>
<li><a href="../320614/index.html">‚ÄúWe have come from the corner,‚Äù or who might be forced out of the market by a competitor. Part One, Pessimistic</a></li>
<li><a href="../320620/index.html">Looking for Performance: Monitoring JVM performance under Linux with BPF</a></li>
<li><a href="../320622/index.html">February 11: The Techleads meetup. How to create and maintain dynamic development</a></li>
<li><a href="../320624/index.html">Connecting ATOL KKM to AndroidStudio (update to FZ-54)</a></li>
<li><a href="../320632/index.html">‚ÄúThe worst practices‚Äù of working with backup products on the example of Veeam Backup & Replication</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>