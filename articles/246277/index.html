<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Assembling and installing Calamari monitoring system packages for CEPH 0.87 distributed storage on Ubuntu 04/14/1 (Trusty Tahr)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Given: existing CEPH 0.87 cluster. Objective: to ensure monitoring. Problem number 2: Write instructions (easier). 

 I googled and found Calamari. Du...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Assembling and installing Calamari monitoring system packages for CEPH 0.87 distributed storage on Ubuntu 04/14/1 (Trusty Tahr)</h1><div class="post__text post__text-html js-mediator-article">  Given: existing CEPH 0.87 cluster.  Objective: to ensure monitoring.  Problem number 2: Write instructions (easier). <br><br>  I googled and found Calamari.  Dug further and found several articles in English on the assembly and installation.  I tried to put, stepped on a few "rake".  As a result, came to writing this article. <br>  I note that the packages compiled as a result are unlikely to fully comply with debian-policy for building deb packages.  Provide monitoring is more important. <br><a name="habracut"></a><br><h4>  <b>0. Brief Description of Calamari</b> </h4><br>  Calamari is a CEPH distributed file storage cluster monitoring and management system.  It includes: <br><ul><li>  calamari-server - the server itself, the backend </li><li>  calamari-clients - front-end (web interface), installed with the server </li><li>  salt-master - configuration file management server, installed with calamari-server </li><li>  salt-minon - client receiving configuration files, installed on all CEPH cluster machines </li><li>  diamond - statistics collector, installed on all machines of the CEPH cluster </li></ul><br>  Of course, other software will also be required (for example, PostgresQL).  But it does not need to be further configured, unlike those mentioned.  Only required to install. <br><br><h4>  <b>1. Initial Distribution Settings</b> </h4><br>  1. Install fresh <i>Ubuntu 04/14/1 (Trusty Tahr)</i> . <br>  In my version the minimum standard server configuration is set, i.e.  the following line is present in /var/log/apt/history.log <br><pre><code class="bash hljs">Commandline: apt-get -o APT::Status-Fd=4 -o APT::Keep-Fds::=5 -o APT::Keep-Fds::=6 -q -y install minimal^ openssh-server^ server^ standard^</code> </pre> <br>  Thus, some packages (for example: <i>software-properties-common</i> ) are already present in the system. <br>  Also, although some packages necessary for building (for example: <i>libssl-dev</i> ) will come depending on the packages being installed, I will still specify them for installation, as they are indicated in the documentation and articles reviewed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For convenience, <i>Midnight Commander is</i> installed. <br><br>  Created user <i>ceph</i> with <i>root</i> rights via <i>sudo</i> . <br><br>  By default, <i>aptitude is</i> configured to automatically install recommended packages.  Leave unchanged. <br><br>  I assume that you can do everything written earlier without anyone‚Äôs help.  And then I will try to describe my actions as detailed as possible. <br>  2. Update: <br><pre> <code class="bash hljs">sudo aptitude update &amp;&amp; sudo aptitude -y upgrade</code> </pre><br>  3. If something important has been updated.  For example, in my case, this is a <i>linux-image</i> kernel package, then reboot <br><pre> <code class="bash hljs">sudo reboot</code> </pre><br>  4. Change the time zone from Samara to Moscow (optional): <br><pre> <code class="bash hljs">sudo dpkg-reconfigure tzdata</code> </pre><br>  5. Install the tools to build packages: <br><pre> <code class="bash hljs">sudo aptitude -y install build-essential debhelper devscripts git make g++</code> </pre><br>  <b>Important:</b> In the next three points, I will build packages.  Each of the packages can be assembled on a separate machine, but the initial settings of the distribution should be carried out necessarily. <br><br><h4>  <b>2. Installing the environment for calamari-server and building the package</b> </h4><br>  Install dependencies to build <i>calamari-server</i> .  They are listed in <i>Build-Depends</i> or found by me as important to the build process.  As mentioned at the beginning of the article - some of them have already been installed. <br><pre> <code class="bash hljs">sudo aptitude -y install libcairo2-dev libpq-dev python-dev python-pip python-virtualenv python-crypto python-m2crypto python-mako \ python-msgpack python-zmq cython libssl-dev lsb-release openssl curl software-properties-common swig libzmq-dev python-cairo \ python-sphinx reprepro</code> </pre><br>  Create a directory in which we will work and clone repositories with <i>calamari-server</i> . <br><pre> <code class="bash hljs">ceph@calamari:~$ mkdir -p ~/dev; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/dev ceph@calamari:~/dev$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/ceph/calamari.git ceph@calamari:~/dev$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> calamari</code> </pre><br>  We try to collect <br><pre> <code class="bash hljs">ceph@calamari:~/dev/calamari$ dpkg-buildpackage</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Get</b> <div class="spoiler_text"><pre> <code class="bash hljs">dpkg-buildpackage: <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> package calamari dpkg-buildpackage: <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> version 1.0.0-1 dpkg-buildpackage: <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> distribution precise dpkg-buildpackage: <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> changed by Gary Lowell &lt;glowell@pudgy.ops.newdream.net&gt; dpkg-buildpackage: host architecture amd64 dpkg-source --before-build calamari fakeroot debian/rules clean dh clean --with python2 dh_testdir dh_auto_clean make -j1 clean make[1]: Entering directory `/home/ceph/dev/calamari<span class="hljs-string"><span class="hljs-string">' target: clean rm -rf venv rest-api/calamari_rest/version.py make[1]: Leaving directory `/home/ceph/dev/calamari'</span></span> dh_clean rm -f debian/calamari-server.substvars rm -f debian/calamari-server.*.debhelper rm -rf debian/calamari-server/ rm -f debian/*.debhelper.log rm -f debian/files find . \( \( -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> f -a \ \( -name <span class="hljs-string"><span class="hljs-string">'#*#'</span></span> -o -name <span class="hljs-string"><span class="hljs-string">'.*~'</span></span> -o -name <span class="hljs-string"><span class="hljs-string">'*~'</span></span> -o -name DEADJOE \ -o -name <span class="hljs-string"><span class="hljs-string">'*.orig'</span></span> -o -name <span class="hljs-string"><span class="hljs-string">'*.rej'</span></span> -o -name <span class="hljs-string"><span class="hljs-string">'*.bak'</span></span> \ -o -name <span class="hljs-string"><span class="hljs-string">'.*.orig'</span></span> -o -name .*.rej -o -name <span class="hljs-string"><span class="hljs-string">'.SUMS'</span></span> \ -o -name TAGS -o \( -path <span class="hljs-string"><span class="hljs-string">'*/.deps/*'</span></span> -a -name <span class="hljs-string"><span class="hljs-string">'*.P'</span></span> \) \ \) -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -f {} + \) -o \ \( -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> d -a -name autom4te.cache -prune -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -rf {} + \) \) rm -f *-stamp dpkg-source -b calamari dpkg-source: error: can<span class="hljs-string"><span class="hljs-string">'t build with source format '</span></span>3.0 (quilt)<span class="hljs-string"><span class="hljs-string">': no upstream tarball found at ../calamari_1.0.0.orig.tar.{bz2,gz,lzma,xz} dpkg-buildpackage: error: dpkg-source -b calamari gave error exit status 255</span></span></code> </pre><br></div></div><br>  We see an error <br><pre> <code class="bash hljs">dpkg-source: error: can<span class="hljs-string"><span class="hljs-string">'t build with source format '</span></span>3.0 (quilt)<span class="hljs-string"><span class="hljs-string">': no upstream tarball found at ../calamari_1.0.0.orig.tar.{bz2,gz,lzma,xz} dpkg-buildpackage: error: dpkg-source -b calamari gave error exit status 255</span></span></code> </pre><br>  and three lines that have eyes hurt: <br><pre> <code class="bash hljs">dpkg-buildpackage: <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> version 1.0.0-1 dpkg-buildpackage: <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> distribution precise dpkg-buildpackage: <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> changed by Gary Lowell &lt;glowell@pudgy.ops.newdream.net&gt;</code> </pre><br>  The <i>Calamari</i> version is no longer the same.  The distribution should be <i>trusty</i> .  Yes, and I collect the package, not Gary.  I also do not like the error that caused the build to stop building. <br><br>  Therefore, I will collect the package in my own way. <br><br>  <b>BugFix</b> <i>dpkg-buildpackage error</i> occurs because in the version from the developer the debian package format is specified <br>  version '3.0 (quilt)'.  Change the format. <br><pre> <code class="bash hljs">ceph@calamari:~/dev/calamari$ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'3.0 (native)'</span></span> &gt; debian/<span class="hljs-built_in"><span class="hljs-built_in">source</span></span>/format</code> </pre><br>  <b>Putting the package</b> together <b>:</b> Changing the debian / changelog file according to our name, email address, version, revision, release, and importance of the package. <br><pre> <code class="bash hljs">ceph@calamari:~/dev/calamari$ DEBEMAIL=your@email.com DEBFULLNAME=<span class="hljs-string"><span class="hljs-string">"Your Name"</span></span> dch \ -v `./get-versions.sh VERSION`-`./get-versions.sh REVISION`-1 -D trusty -u low <span class="hljs-string"><span class="hljs-string">'Switch to dpkg-source 3.0 (native) format'</span></span></code> </pre><br>  Check <br><pre> <code class="bash hljs">ceph@calamari:~/dev/calamari$ head -5 debian/changelog calamari (1.2.1-100-ge0b9b21-1) trusty; urgency=low * Switch to dpkg-source 3.0 (native) format -- Your Name &lt;your@email.com&gt; Wed, 10 Dec 2014 17:05:10 +0300</code> </pre><br>  After that, the package is assembled without errors, with the correct version, revision, release and importance.  For obvious reasons, I do not provide the output of dpkg-buildpackage. <br><pre> <code class="bash hljs">ceph@calamari:~/dev/calamari$ dpkg-buildpackage</code> </pre><br>  Check <br><pre> <code class="bash hljs">ceph@calamari:~/dev/calamari$ ls -la .. total 12016 drwxrwxr-x 3 ceph ceph 4096 Dec 10 17:20 . drwxr-xr-x 5 ceph ceph 4096 Dec 10 17:11 .. drwxrwxr-x 20 ceph ceph 4096 Dec 10 17:11 calamari -rw-rw-r-- 1 ceph ceph 1396 Dec 10 17:20 calamari_1.2.1-100-ge0b9b21-1_amd64.changes -rw-rw-r-- 1 ceph ceph 750 Dec 10 17:11 calamari_1.2.1-100-ge0b9b21-1.dsc -rw-rw-r-- 1 ceph ceph 1278706 Dec 10 17:11 calamari_1.2.1-100-ge0b9b21-1.tar.gz -rw-r--r-- 1 ceph ceph 10998618 Dec 10 17:20 calamari-server_1.2.1-100-ge0b9b21-1_amd64.deb</code> </pre><br>  Go back to the parent directory <br><pre> <code class="bash hljs">ceph@calamari:~/dev/calamari$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ..</code> </pre><br><h4>  <b>3. Setting the environment and assembling the diamond</b> </h4><br>  <b>Important:</b> If we build a package on a separate machine, do not forget about the implementation of the 1st paragraph of the article. <br><br>  Install dependencies to build a <i>diamond</i> <br><pre> <code class="bash hljs">sudo aptitude -y install python-mock cdbs python-support python-configobj</code> </pre><br>  Download the <i>diamond</i> repository. <br><pre> <code class="bash hljs">mkdir -p ~/dev; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/dev ceph@calamari:~/dev$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/ceph/Diamond.git --branch=calamari ceph@calamari:~/dev$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> Diamond ceph@calamari:~/dev/Diamond$ DEBEMAIL=your@email.com DEBFULLNAME=<span class="hljs-string"><span class="hljs-string">"Your Name"</span></span> dch -v `./version.sh`-1 -D trusty \ -u low `/bin/<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -n <span class="hljs-string"><span class="hljs-string">"built on "</span></span>; date`</code> </pre><br>  Check <br><pre> <code class="bash hljs">ceph@calamari:~/dev/Diamond$ head -5 debian/changelog diamond (3.4.67-1) trusty; urgency=low * built on Wed Dec 10 17:57:02 MSK 2014 -- Your Name &lt;your@email.com&gt; Wed, 10 Dec 2014 17:57:02 +0300</code> </pre><br>  We collect package <br><pre> <code class="bash hljs">ceph@calamari:~/dev/Diamond$ dpkg-buildpackage</code> </pre><br>  Check <br><pre> <code class="bash hljs">ceph@calamari:~/dev/Diamond$ ls -la .. total 4572 drwxrwxr-x 3 ceph ceph 4096 Dec 10 18:00 . drwxr-xr-x 4 ceph ceph 4096 Dec 10 17:54 .. drwxrwxr-x 11 ceph ceph 4096 Dec 10 18:00 Diamond -rw-r--r-- 1 ceph ceph 232292 Dec 10 18:00 diamond_3.4.67-1_all.deb -rw-rw-r-- 1 ceph ceph 1182 Dec 10 18:00 diamond_3.4.67-1_amd64.changes -rw-rw-r-- 1 ceph ceph 723 Dec 10 18:00 diamond_3.4.67-1.dsc -rw-rw-r-- 1 ceph ceph 4427329 Dec 10 18:00 diamond_3.4.67-1.tar.gz</code> </pre><br>  Go back to the parent directory <br><pre> <code class="bash hljs">ceph@calamari:~/dev/Diamond$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ..</code> </pre><br><h4>  <b>4. Setting up the environment for calamari-clients and building it</b> </h4><br>  <b>Important:</b> If we build a package on a separate machine, do not forget about the implementation of the 1st paragraph of the article. <br><br>  Add repositories with <i>node.js</i> : <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb http://ppa.launchpad.net/chris-lea/node.js/ubuntu trusty main"</span></span> | sudo tee /etc/apt/sources.list.d/nodejs.list sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys B9316A7BC7917B12</code> </pre><br>  Updating package lists: <br><pre> <code class="bash hljs">sudo aptitude update</code> </pre><br>  Install dependencies to build calamari-clients: <br><pre> <code class="bash hljs">sudo aptitude -y install ruby1.9.1 ruby1.9.1-dev python-software-properties nodejs</code> </pre><br>  Install dependencies using NPM and Gem: <br><pre> <code class="bash hljs">sudo npm install -g bower@1.3.8 sudo npm install -g grunt-cli sudo gem install compass</code> </pre><br>  In some articles it is recommended to put a <i>gem</i> without <i>sudo</i> , but I swore for access rights to system directories.  Stepping on another ‚Äúrake‚Äù, set via <i>sudo</i> and the next line corrected the consequences of the <i>root user</i> <br><pre> <code class="bash hljs">sudo chown -R ceph ~/.npm</code> </pre><br>  <b>Warning:</b> Installing dependencies via <i>NPM</i> and <i>Gem</i> , and the build of <i>calamari-clients</i> coincided with the blocking time of github.  Be carefull.  Without access to this resource you will catch a lot of problems.  Perhaps, not solved without a full-fledged (not anonymous) proxy or vpn. <br><br>  Download <i>calamari-clients</i> repository <br><pre> <code class="bash hljs">mkdir -p ~/dev; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/dev ceph@calamari:~/dev$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/ceph/calamari-clients.git ceph@calamari:~/dev$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> calamari-clients</code> </pre><br>  Download the patch (in the parent directory) <br><pre> <code class="bash hljs">ceph@calamari:~/dev/calamari-clients$ wget https://raw.githubusercontent.com/avssav/patches/master/calamari-clients/makefile.patch -qO \ ../makefile.patch</code> </pre><br>  In case the githab fall off again I will leave the diff file here.  <b>When copying from the screen, the diff file is crooked.</b> <br><div class="spoiler">  <b class="spoiler_title">../makefile.patch</b> <div class="spoiler_text"><pre> <code class="bash hljs">ceph@calamari:~/dev/calamari-clients$ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'diff -ruN a/Makefile b/Makefile --- a/Makefile 2014-12-03 10:13:32.486463458 +0300 +++ b/Makefile 2014-12-03 10:14:10.994462934 +0300 @@ -45,7 +45,7 @@ DATESTR=$(shell /bin/echo -n "built on "; date) set_deb_version: DEBEMAIL=$(DEBEMAIL) dch \ - --newversion $(VERSION)-$(REVISION)$(BPTAG) \ + --newversion $(VERSION)-$(REVISION)$(BPTAG) -u low \ -D $(DIST) --force-bad-version --force-distribution "$(DATESTR)" build:'</span></span> &gt; ../makefile.patch</code> </pre><br></div></div><br>  Apply patch: <br><pre> <code class="bash hljs">ceph@calamari:~/dev/calamari-clients$ patch -ZEfsp1 &lt; ../makefile.patch</code> </pre><br>  We collect calamari-clients deb-package. <br><pre> <code class="bash hljs">ceph@calamari:~/dev/calamari-clients$ DEBEMAIL=your@email.com DEBFULLNAME=<span class="hljs-string"><span class="hljs-string">"Your Name"</span></span> DIST=trusty BPTAG=-1 REAL_BUILD=y make dpkg</code> </pre><br>  Check <br><pre> <code class="bash hljs">ceph@calamari:~/dev/calamari-clients$ ls -la .. total 936 drwxrwxr-x 3 ceph ceph 4096 Dec 10 18:54 . drwxr-xr-x 8 ceph ceph 4096 Dec 10 18:45 .. drwxrwxr-x 11 ceph ceph 4096 Dec 10 18:41 calamari-clients -rw-r--r-- 1 ceph ceph 838592 Dec 10 18:54 calamari-clients_1.2.1.1-53-gddd7187-1_all.deb -rw-rw-r-- 1 ceph ceph 810 Dec 10 18:54 calamari-clients_1.2.1.1-53-gddd7187-1_amd64.changes -rw-rw-r-- 1 ceph ceph 92902 Dec 10 18:54 calamari-clients-make-dpkg.txt -rw-rw-r-- 1 ceph ceph 431 Dec 10 18:41 makefile.patch</code> </pre><br>  Go back to the parent directory <br><pre> <code class="bash hljs">ceph@calamari:~/dev/calamari-clients$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ..</code> </pre><br><h4>  <b>5. Installing calamari-server</b> </h4><br>  I install the server on a separate machine.  I carry out all subparagraphs of point 1, <b>except the last (5).</b> <br><br>  <b>UPDATE 2015.07:</b> <br>  Saltstack from the developer has been updated to version 2015.07.  Calamari does not work with him.  Set the saltstack as follows <br><pre> <code class="bash hljs">sudo aptitude -y install python-pip sudo pip install <span class="hljs-string"><span class="hljs-string">'salt==2014.7.0'</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">Setting salt-master until 2015.07 (leave for information)</b> <div class="spoiler_text">  Add repositories with <i>saltstack</i> : <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb http://ppa.launchpad.net/saltstack/salt/ubuntu trusty main"</span></span> | sudo tee /etc/apt/sources.list.d/saltstack.list sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 4759FA960E27C0A6 sudo aptitude update</code> </pre><br>  Install the configuration management system: <br><pre> <code class="bash hljs">sudo aptitude -y install salt-master salt-minion salt-syndic</code> </pre><br></div></div><br>  Installing dependencies for <i>calamari-server</i> <br><pre> <code class="bash hljs">sudo aptitude install -y apache2 libapache2-mod-wsgi libcairo2 supervisor python-cairo libpq5 postgresql python-txamqp python-gevent \ python-sqlalchemy</code> </pre><br>  Install <i>calamari-server</i> and <i>calamari-clients</i> <br><pre> <code class="bash hljs">sudo dpkg -i ./calamari-server_1.2.1-100-ge0b9b21-1_amd64.deb sudo dpkg -i calamari-clients_1.2.1.1-53-gddd7187-1_all.deb</code> </pre><br>  Calamari setup <br><pre> <code class="bash hljs">ceph@calamari:~$ sudo calamari-ctl initialize [INFO] Loading configuration.. [INFO] Starting/enabling salt... [INFO] Starting/enabling postgres... [INFO] Initializing database... [INFO] Initializing web interface... [INFO] You will now be prompted <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> login details <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the administrative user account. This is the account you will use to <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> into the web interface once setup is complete. Username (leave blank to use <span class="hljs-string"><span class="hljs-string">'root'</span></span>): Email address: your@email.com Password: Password (again): Superuser created successfully. [INFO] Starting/enabling services... [INFO] Restarting services... [INFO] Complete.</code> </pre><br><h4>  <b>6. Add Ceph nodes to calamari monitoring</b> </h4><br>  <b>UPDATE 2015.07:</b> <br>  Saltstack from the developer has been updated to version 2015.07.  Calamari does not work with him.  Set the saltstack as follows. <br>  On all nodes <br>  Install gdebi <br><pre> <code class="bash hljs">sudo aptitude -y install gdebi-core</code> </pre><br>  Diamond and its settings <br><pre> <code class="bash hljs">sudo gdebi --option=APT::Get::force-yes=1,APT::Get::Assume-Yes=1 -n diamond_3.4.67-1_all.deb sudo cp /etc/diamond/diamond.conf.example /etc/diamond/diamond.conf</code> </pre><br>  Salt-minion and its settings <br><pre> <code class="bash hljs">wget https://github.com/avssav/packages/raw/master/saltstack/salt-common_2014.7.0%2Bds-2trusty1_all.deb wget https://github.com/avssav/packages/raw/master/saltstack/salt-minion_2014.7.0%2Bds-2trusty1_all.deb sudo gdebi --option=APT::Get::force-yes=1,APT::Get::Assume-Yes=1 -n salt-common_2014.7.0+ds-2trusty1_all.deb sudo gdebi --option=APT::Get::force-yes=1,APT::Get::Assume-Yes=1 -n salt-minion_2014.7.0+ds-2trusty1_all.deb <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"master: CALAMARI_SERVER_IP"</span></span> | sudo tee /etc/salt/minion.d/calamari.conf sudo update-rc.d salt-minion defaults</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Setting salt-minion to 2015.07 (leave for information)</b> <div class="spoiler_text">  On all nodes <br>  Add a salt-minion repository <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb http://ppa.launchpad.net/saltstack/salt/ubuntu trusty main"</span></span> | sudo tee /etc/apt/sources.list.d/saltstack.list wget -q -O - <span class="hljs-string"><span class="hljs-string">"http://keyserver.ubuntu.com:11371/pks/lookup?op=get&amp;search=0x4759FA960E27C0A6"</span></span> | sudo apt-key add - sudo aptitude update</code> </pre><br>  Install dependencies to install diamond <br><pre> <code class="bash hljs">sudo aptitude -y install python-support python-configobj</code> </pre><br>  Diamond and its settings <br><pre> <code class="bash hljs">sudo dpkg -i diamond_3.4.67-1_all.deb sudo cp /etc/diamond/diamond.conf.example /etc/diamond/diamond.conf</code> </pre><br>  Salt-minion and its settings <br><pre> <code class="bash hljs">sudo aptitude -y install salt-minion <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"master: CALAMARI_SERVER_IP"</span></span> | sudo tee /etc/salt/minion.d/calamari.conf sudo update-rc.d salt-minion defaults</code> </pre><br></div></div><br>  Restart <br><pre> <code class="bash hljs">sudo service salt-minion restart sudo service diamond restart</code> </pre><br><h4>  <b>7. Authorization of the Ceph cluster in Calamari</b> </h4><br>  After completing the previous item, salt-minion clients from Ceph machines will attempt to upgrade from the wizard. <br>  On the machine with calamari-server and salt-master we perform <br><pre> <code class="bash hljs">ceph@calamari:~$ sudo salt-key -L Accepted Keys: Unaccepted Keys: ceph1 ceph2 ceph3 ceph4 ceph5 Rejected Keys:</code> </pre><br>  We see the list of cluster machines.  We allow them access <br><pre> <code class="bash hljs">ceph@calamari:~$ sudo salt-key -A The following keys are going to be accepted: Unaccepted Keys: ceph1 ceph2 ceph3 ceph4 ceph5 Proceed? [n/Y] y Key <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> minion ceph1 accepted. Key <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> minion ceph2 accepted. Key <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> minion ceph3 accepted. Key <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> minion ceph4 accepted. Key <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> minion ceph5 accepted.</code> </pre><br><h4>  <b>9. Everything should work</b> </h4><br>  Login using the browser on <a href="http://calamari_server_ip/">http: // CALAMARI_SERVER_IP</a> with the login and password specified during setup (calamari-ctl initialize). <br><h4>  <b>10. Useful stuff</b> </h4><br>  The synchronization of the diamond settings on the Ceph nodes occurs automatically.  However, there is a command to update the settings manually. <br><pre> <code class="bash hljs">sudo salt-call state.highstate</code> </pre><br>  The following command will check the connectivity of Ceph nodes with calamari-server <br><pre> <code class="bash hljs">sudo salt-call ceph.get_heartbeats</code> </pre><br>  Check on the salt-master of all connected salt-minions <br><pre> <code class="bash hljs">sudo salt <span class="hljs-string"><span class="hljs-string">'*'</span></span> ceph.get_heartbeats</code> </pre><br>  <b>Note:</b> The article does not include some intermediate results.  For example, a patch that <a href="http://tracker.ceph.com/issues/9701">eliminated an</a> unpleasant <a href="http://tracker.ceph.com/issues/8566">error was</a> excluded.  But, checking the article, I once again cloned calamari from the github, applied my patch and the patch did not work.  In general, as it turned out, while I was writing an article - calamari'vtsy fixed a bug in the main branch. <br><h4>  <b>9. Materials</b> </h4><br>  <a href="http://bryanapperson.com/blog/compiling-calamari-ceph-ubuntu-14-04/">Compiling Calamari for Ceph on Ubuntu 14.04</a> <br>  <a href="http://karan-mj.blogspot.ru/2014/09/ceph-calamari-survival-guide.html">Ceph Calamari: Step-by-Step</a> <br>  <a href="http://marcosmamorim.wordpress.com/2014/07/11/build-package-and-install-calamari-on-debian-weezy/">Build package and Install Calamari on Debian Weezy</a> <br>  <a href="http://ceph.com/category/calamari/">Ceph Calamari: The Survival Guide</a> <br>  <a href="http://calamari.readthedocs.org/en/latest/contents.html">Calamari Documentation</a> <br>  <a href="https://github.com/ceph/calamari-clients/wiki/Precise-Build-Instructions">Precise Build Instructions</a> </div><p>Source: <a href="https://habr.com/ru/post/246277/">https://habr.com/ru/post/246277/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../246263/index.html">5 improvements for the site, which can increase sales by 3 times</a></li>
<li><a href="../246265/index.html">C # for AS3 developers. Part 2: Extending Classes and Implementing Interfaces</a></li>
<li><a href="../246269/index.html">Promotional codes for the free Microsoft 70-695, 70-696 exams</a></li>
<li><a href="../246273/index.html">WordPress updated to version 4.1</a></li>
<li><a href="../246275/index.html">The best instant messenger for team work: Compare HipChat, Slack and Kato</a></li>
<li><a href="../246279/index.html">Steam Stealer or Trojan stealing things on Steam. The history of the appearance and scheme of work</a></li>
<li><a href="../246281/index.html">Talk about VPNs? Types of VPN connections. VPN scaling</a></li>
<li><a href="../246283/index.html">Maintaining a "third-party" information resource. How and for what</a></li>
<li><a href="../246285/index.html">Testing GWT MVP Architecture Applications</a></li>
<li><a href="../246287/index.html">The last day of your discount is 89% on the annual program of Stratoplan</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>