<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Geo-targeting by city (region, country) for WordPress</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Reasons for creating 
 Recently asked to do geo-targeting by city for a wordpress site. Having reviewed existing geo-targeting plug-ins (including pai...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Geo-targeting by city (region, country) for WordPress</h1><div class="post__text post__text-html js-mediator-article"><h2>  Reasons for creating </h2><br>  Recently asked to do geo-targeting by city for a wordpress site.  Having reviewed existing geo-targeting plug-ins (including paid ones), I didn‚Äôt find more than one working with cities (only countries).  Therefore, I decided to make my own, using some existing base for determining the location by IP address.  First I started by developing the function in the template, but then I decided to create a plugin and put it on github, because I think it might be useful to someone else. <br><a name="habracut"></a><br><h2>  Base selection </h2><br>  The first step was to choose a base.  And this is probably one of the most difficult problems.  In the development process I tried many options, even made CURL requests for sites that determine the location of ip, and parsil them.  But all of them were not accurate, for example, one Moscow IP was defined as Moscow, the other - just Russia.  It was also necessary for the plugin to work not only with Russia, but also with Belarus and Ukraine.  Having tried <strike>a</strike> lot of bases, I stopped at Sypex Geo.  They have conditionally paid and free versions of databases.  Conditionally-paid uses REST API and returns data in the form of xml, json and jsonp.  Free can be downloaded as a file, you can also download a class to work with it.  The conditionally paid version is more accurate, but provides only 10,000 requests for free.  The free version is also quite accurate and updated on the site. <br><br><h2>  Functional </h2><br>  As I already wrote, I started to do not with the plugin, but with the function in the template.  At first I was thinking only about the conditionally paid version of the database, but the number of free requests ended in a day or two.  Therefore, I switched to a free one, using a ready-made class for working with a database file. <br><br>  When developing the plugin, I decided to make a choice between the local database and the REST API.  In the future I plan to make the button automatically update the database. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Also from the database you can return the Russian and English names of cities (countries, regions).  In this regard, made the choice of language. <br>  Still faced with the fact that you need to include a list of several cities, or vice versa, to exclude some. <br><br><img src="https://habrastorage.org/files/4de/385/96f/4de38596f97b44dba7f8cdd5104e818e.png"><br>  <i>Configure the plugin in the admin panel</i> <br><br><h2>  Implementation </h2><br>  Since I rarely work with Wordpress (as with all CMS) and never wrote plug-ins for it, I began to read how to write them and see how the existing ones are arranged.  The idea of ‚Äã‚Äãimplementation took from existing geo-plugins.  I thought for a long time to write functionally or object-oriented.  I decided functionally, since the plugin is not big. <br><br>  Briefly describe his work. <br><br>  When activating the plugin, we initiate two options: the type of database and the language in which we will enter the names. <br><br><pre><code class="php hljs">register_activation_hook(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>, <span class="hljs-string"><span class="hljs-string">'wp_sypexgeo_activation'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wp_sypexgeo_activation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ update_option(<span class="hljs-string"><span class="hljs-string">'sgeo_language'</span></span>, <span class="hljs-string"><span class="hljs-string">'en'</span></span>); update_option(<span class="hljs-string"><span class="hljs-string">'sgeo_dbase'</span></span>, <span class="hljs-string"><span class="hljs-string">'loc'</span></span>); }</code> </pre> <br>  Further <pre> <code class="php hljs"> add_filter(<span class="hljs-string"><span class="hljs-string">'the_content'</span></span>, <span class="hljs-string"><span class="hljs-string">'geotargeting_filter'</span></span>); add_filter(<span class="hljs-string"><span class="hljs-string">'the_content_rss'</span></span>, <span class="hljs-string"><span class="hljs-string">'geotargeting_filter'</span></span>); add_filter(<span class="hljs-string"><span class="hljs-string">'the_excerpt'</span></span>, <span class="hljs-string"><span class="hljs-string">'geotargeting_filter'</span></span>); add_filter(<span class="hljs-string"><span class="hljs-string">'the_excerpt_rss'</span></span>, <span class="hljs-string"><span class="hljs-string">'geotargeting_filter'</span></span>);</code> </pre>  call function <div class="spoiler">  <b class="spoiler_title">geotargeting_filter</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">geotargeting_filter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($s)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//parse Country preg_match_all("#\[" . GEOTARGETING_COUNTY . "\s*(in|out)=([^\]]+)\](.*?)\[/" . GEOTARGETING_COUNTY . "\]#isu", $s, $country); //parse Country preg_match_all("#\[" . GEOTARGETING_REGION . "\s*(in|out)=([^\]]+)\](.*?)\[/" . GEOTARGETING_REGION . "\]#isu", $s, $region); //parse Country preg_match_all("#\[" . GEOTARGETING_CITY . "\s*(in|out)=([^\]]+)\](.*?)\[/" . GEOTARGETING_CITY . "\]#isu", $s, $city); if (empty($country) &amp;&amp; empty($region) &amp;&amp; empty($city)) { return $s; } $base_type = get_option('sgeo_dbase'); if ($base_type == 'loc') { $ipdata = getLocInfo(); } elseif ($base_type == 'rm') { $ipdata = getRemInfo(); } if (!empty($country)) { foreach ($country[0] as $i =&gt; $raw) { $type = strtolower($country[1][$i]); $countries = strtolower(trim(str_replace(array("\"", "'", "\n", "\r", "\t", " "), "", $country[2][$i]))); $content = $country[3][$i]; $countries = explode(",", $countries); $replacement = ""; if ((($type == "in") &amp;&amp; in_array($ipdata['country'], $countries)) || (($type == "out") &amp;&amp; !in_array($ipdata['country'], $countries))) { $replacement = $content; } $s = str_replace($raw, $replacement, $s); } } if (!empty($region)) { foreach ($region[0] as $i =&gt; $raw) { $type = strtolower($region[1][$i]); $regions = strtolower(trim(str_replace(array("\"", "'", "\n", "\r", "\t"), "", $region[2][$i]))); $content = $region[3][$i]; $regions = explode(",", $regions); $replacement = ""; if ((($type == "in") &amp;&amp; in_array($ipdata['region'], $regions)) || (($type == "out") &amp;&amp; !in_array($ipdata['region'], $regions))) { $replacement = $content; } $s = str_replace($raw, $replacement, $s); } } if (!empty($city)) { foreach ($city[0] as $i =&gt; $raw) { $type = strtolower($city[1][$i]); $cities = strtolower(trim(str_replace(array("\"", "'", "\n", "\r", "\t", " "), "", $city[2][$i]))); $content = $city[3][$i]; $cities = explode(",", $cities); $replacement = ""; if ((($type == "in") &amp;&amp; in_array($ipdata['city'], $cities)) || (($type == "out") &amp;&amp; !in_array($ipdata['city'], $cities))) { $replacement = $content; } $s = str_replace($raw, $replacement, $s); } } return $s; }</span></span></code> </pre> </div></div>  In which comes the current content.  Depending on the type of database, the function is called to get the data.  Then it searches for special tags in the template and compares them with the location data.  If the data matches, the construction is replaced with the content from the tags, if not, it is deleted. <br><br><h2>  Using </h2><br>  To specify a list of countries: <pre> <code class="php hljs">[GeoCountry in=Belarus,Russia] Belarus,Russia![/GeoCountry]</code> </pre> <br>  To specify a list of regions: <pre> <code class="php hljs">[GeoRegion in=Moscow] Moscow Region![/GeoRegion]</code> </pre> <br>  To specify a list of cities: <pre> <code class="php hljs">[GeoCity in=,] ,![/GeoCity]</code> </pre> <br>  If you want to select countries (regions, cities) with the exception of those specified, use "out": <pre> <code class="php hljs">[GeoRegion out=Minsk,Brest] ,  Minsk,Brest![/GeoRegion]</code> </pre> <br><br>  Example of use in the template: <br><br>  <i>Welcome to WordPress.</i>  <i>This is your first post.</i>  <i>Edit or delete it, then start blogging!</i>  <i>Our contacts: [GeoCity in = Minsk] +375295552255 [/ GeoCity] [GeoCity out = Minsk] +375475552255 [/ GeoCity]</i> <br><br><h2>  Conclusion </h2><br>  I hope my plugin is useful to someone.  If you have any questions or suggestions - write.  Also, if someone thinks that you need to use another database (geoservice or something else), suggest, I will add, or you can add. <br><br>  Link to plugin: <a href="https://github.com/akalevich/wp-sypexgeo">wp-sypexgeo</a> </div><p>Source: <a href="https://habr.com/ru/post/258705/">https://habr.com/ru/post/258705/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../258691/index.html">Motion sensor for switching radio stations - part I</a></li>
<li><a href="../258693/index.html">Again about domain-based development (Domain-Driven Design, DDD)</a></li>
<li><a href="../258695/index.html">Oberon in UAV programming</a></li>
<li><a href="../258699/index.html">Robots and 3D printing</a></li>
<li><a href="../258701/index.html">IBM FlashSystem 820 storage system overview and testing</a></li>
<li><a href="../258707/index.html">Digestible call of Java methods from native code</a></li>
<li><a href="../258709/index.html">Transparent transition PgQ -> RabbitMQ</a></li>
<li><a href="../258711/index.html">Podcast "Five Minute PHP"</a></li>
<li><a href="../258715/index.html">The long-awaited domestic processor Baikal-T1 was released</a></li>
<li><a href="../258717/index.html">Windows Preinstallation Network Download Guide (WinPE)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>