<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Homemade security system based on products for smart home from Nootehnika</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, dear community. I want to share with you an experiment in the implementation of a security system for a home based on devices for a smart ho...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Homemade security system based on products for smart home from Nootehnika</h1><div class="post__text post__text-html js-mediator-article">  Good day, dear community.  I want to share with you an experiment in the implementation of a security system for a home based on devices for a smart home from the company Nootehnika.  Immediately I want to make a reservation that this is one of the first experiments, and I set myself the goal of not "building an impregnable bastion", but a demonstration of the possibilities of using the devices I have chosen, experiment and learning lessons, as well as receiving feedback from you. <br><br>  In short, the system I designed should, in arming mode, photograph each person approaching the front door and send a photo to an e-mail address, as well as send an e-mail message in the case of movement registration in the hallway (i.e., there is movement inside the apartment) . <a name="habracut"></a>  So, to the formulation of the problem. <br><br><h2>  <b>1. Statement of the problem</b> </h2><br>  The system I design should: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  in the arming mode, take photographs of each person approaching the front door and send the photo to an e-mail address; </li><li>  in the arming mode, send an e-mail message in case of registration of traffic in the hallway (without a photo, since I don‚Äôt have IP cameras); </li><li>  provide various interfaces for arming and disarming. </li></ul><br>  By various arming interfaces, I mean: <br><br><ul><li>  transfer to protection mode and disarming by means of radio switches Nootech; </li><li>  transfer to protection mode and disarming via a web interface for controlling a smart home. </li></ul><br><h2>  <b>2. Description of the solution</b> </h2><br>  To solve this problem, I used the following hardware: <br><br><ul><li>  two motion sensors PM112; </li><li>  signal receiver from sensors and switches RX2164; </li><li>  switch PU311-2; </li><li>  nettop 3VI (based on the processor Atom D525); </li><li>  Chinese noname IP camera. </li></ul><br>  I have already cited a brief description of the devices for building the smart home of the company Notechnika in the ‚ÄúIntroduction‚Äù <a href="https://habrahabr.ru/post/318162/">section of the article</a> , so I will not focus on this issue here.  In addition, in all details about the devices can be found on the off.site website. <br><br>  So, to the description of the system.  Debian Linux 7, Simple Event Correlation (SEC) software and a linux toolkit for controlling Nootech devices from <a href="https://github.com/olegart/noolite">Oleg Artamonov are</a> installed on the 3VI nettop. <br><br>  Motion sensors (PM112) are installed in the vestibule in front of the entrance door and in the corridor (inside the apartment).  A RX2164 USB receiver is connected to the nettop.  The receiver receives signals from the sensors and switches, and the utilities for controlling the devices of the Technician (hereinafter referred to as the Noolite utilities) installed on the nettop, transmit the received signals to the syslog.  SEC reads the file to which it writes syslog data and processes it according to the configured rules.  As a result of processing, actions such as receiving photos from an IP camera and sending emails are performed. <br><br>  Enabling (and disabling) of the security mode is carried out in two ways: <br><br><ol><li>  by pushing a button on the switch PU311-2; </li><li>  pushing a button in the web interface of the smart home control system. </li></ol><br>  A block diagram illustrating the operation of the system is shown in Figure 1. <br><br><img src="https://habrastorage.org/files/ac2/e02/b20/ac2e02b2021f408f95d5fe039beb7588.jpg"><br><br>  <b>Figure 1</b> - Block diagram illustrating the operation of the system <br><br><h2>  <b>3. Installing the system hardware</b> </h2><br>  For this system I use the same 2 motion sensors, the installation of which I described in section 4 of the <a href="https://habrahabr.ru/post/318162/">article</a> . <br><br>  In short, one of the sensors is installed near the entrance door in the vestibule (outside the apartment).  The sensitivity of this sensor is set at such a level as to record movement in the immediate vicinity of the door.  The second sensor is installed immediately near the entrance door, but already inside the apartment.  Sensitivity is adjusted in such a way as to fix the movement in the immediate vicinity of the door. <br><br>  The IP camera is installed outside the apartment in the vestibule under the ceiling.  An entrance door and about 1.5 meters of space in front of her fall into her field of view. <br><br>  The PU311-2 switch is installed inside the cabinet so as not to catch the eye and not be accidentally pressed. <br><br>  The 3VI nettop with the RX2164 signal receiver is located nearby on the mezzanine to ensure stable reception of signals from sensors and switches. <br><br>  The equipment installation diagram is shown in Figure 2. <br><br><img src="https://habrastorage.org/files/210/f9b/27b/210f9b27bd7349fbaa3ac91752612f73.jpg" height="300" width="180"><br><br>  <b>Figure 2</b> - Equipment installation diagram <br><br><h2>  <b>4. Setting up the software</b> </h2><br>  Software setup includes: <br><br><ul><li>  setting up Noolite utilities for receiving signals from sensors and switches; </li><li>  setting up SEC rules for triggering on signals coming from sensors and switches; </li><li>  creating a script that will receive photos from the camera and send emails; </li><li>  creation of the on / off button of the system in the web interface. </li></ul><br><h3>  <b>Setting up Noolite utilities for receiving signals from sensors and switches</b> </h3><br>  In order for the RX2164 receiver to start receiving signals from a sensor or a switch, it is necessary to ‚Äúbind‚Äù it.  To do this, press the ‚Äúbind‚Äù button on the sensor itself (on the back side), and execute the command on the computer to which the receiver is connected: nooliterxcfg ‚Äìbind &lt;channel number from 1 to 64&gt;.  Similarly, the binding of the switch to the receiver. <br><br>  In my case, the sensor in the vestibule was connected to channel 3, the sensor in the apartment was connected to channel 2 and the two switch buttons to channels 1 and 4, respectively. <br><br>  To receive signals from sensors in real time, you need to run the nooliterx utility in daemon mode.  The installation process of utilities and their settings are described by the developer himself (Oleg Artamonov in the documentation for the utilities) and also by me in section 4 of the article (LINK).  As a result, we obtain the recording of signals from sensors and switches in the syslog.  It remains only to configure the recording of these messages to a file in the syslog itself and the output is the following (samples of messages from the sensors): <br><br><pre><code class="bash hljs">Jan 7 15:47:39 vmon nooliterx[23022]: Received: status 133, channel 3, <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> 25, format 1, data 2 0 0 0 Jan 7 18:43:58 vmon nooliterx[23022]: Received: status 135, channel 2, <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> 25, format 1, data 1 0 0 0</code> </pre> <br>  Sample messages from the switches (when you press the buttons on them) look a little different: <br><br><pre> <code class="bash hljs">Jan 5 22:29:43 vmon nooliterx[23022]: Received: status 26, channel 1, <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> 4, format 0, data 1 0 0 0 Jan 5 22:27:55 vmon nooliterx[23022]: Received: status 145, channel 4, <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> 4, format 0, data 1 0 0 0</code> </pre> <br><h3>  <b>Set up SEC rules for triggering on signals coming from sensors and switches.</b> </h3><br>  SEC is a utility for handling event logs.  In short, at the input it receives a stream of events, each of which checks for compliance with the templates of customized rules.  If a match is found, it launches the action specified in the corresponding rule.  The thing is amazingly flexible to use.  There is a detailed man page on the web. <br><br>  SEC is used in my system in order to find messages from sensors and switches in the event flow in order to launch a script that takes a photo and sends emails, or simply translate the system on and off. <br><br>  In the SEC, I set up 4 rules.  2 - for processing events from motion sensors and two - for processing signals from two buttons on the switch.  The rules are in the /etc/sec.conf file. <br><br>  <b>Rule 1: Processing of the signal from the motion sensor in the vestibule (the sensor associated with channel 3)</b> <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=SingleWithSuppress ptype=RegExp pattern=\w+\s+\d+\s+\d+\:\d+\:\d+\s+\w+\s+nooliterx\S+\s+Received\:\s+status\s+\d+,\s+channel\s+(3),\s+<span class="hljs-built_in"><span class="hljs-built_in">command</span></span>\s+25.* desc=Motion sensor frontdoor <span class="hljs-variable"><span class="hljs-variable">$1</span></span> triggered action=shellcmd (/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/smarthome/security/send_photo_alert.sh <span class="hljs-variable"><span class="hljs-variable">$1</span></span>); event %s window=60</code> </pre> <br>  The type of this rule - ‚ÄúSingleWithSurpress‚Äù - is intended to respond only to the first registered event during the time interval specified by the ‚Äúwindow‚Äù parameter in seconds.  Those.  this setting says that the rule will not work more than once per minute and the action specified in the ‚Äúaction‚Äù parameter will be launched no more than once per minute.  This is done to ensure that in the event that someone tinkers around the door for a few minutes not to spam their mail with tons of letters.  The ‚Äúpattern‚Äù parameter contains a regular expression, according to which events are searched from the sensor tied to channel 3. The ‚Äúaction‚Äù parameter contains two actions - the shellcmd, which executes the script and passes the parameter selected from the regular expression (in this case of representing the number ‚Äú3‚Äù), and the second action ‚Äúevent% s‚Äù is used to transfer the expression written in the ‚Äúdesc‚Äù parameter to other rules that are not necessary for the operation of this system and can be omitted.  The ‚Äúdesc‚Äù parameter contains additional service information that is used by other rules.  For this system, it is not necessary and arbitrary data can be entered there. <br><br>  <b>Rule 2: Processing the signal from the movement sensor in the corridor (sensor linked to channel 2)</b> <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=SingleWithSuppress ptype=RegExp pattern=\w+\s+\d+\s+\d+\:\d+\:\d+\s+\w+\s+nooliterx\S+\s+Received\:\s+status\s+\d+,\s+channel\s+(2),\s+<span class="hljs-built_in"><span class="hljs-built_in">command</span></span>\s+25.* desc=Motion sensor lobby <span class="hljs-variable"><span class="hljs-variable">$1</span></span> triggered action=shellcmd (/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/smarthome/security/send_photo_alert.sh <span class="hljs-variable"><span class="hljs-variable">$1</span></span>); event %s window=60</code> </pre> <br>  Here, everything is similar to rule 1. It is worth noting that the script is passed the number "2", obtained from the regular expression. <br><br>  <b>Rule 3: Processing the signal from the switch button tied to channel 1</b> <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=single ptype=regexp pattern=\w+\s+\d+\s+\d+\:\d+\:\d+\s+\w+\s+nooliterx\S+\s+Received\:\s+status\s+\d+,\s+channel\s+(1),\s+<span class="hljs-built_in"><span class="hljs-built_in">command</span></span>\s+4.* desc=switch guard mode online action=shellcmd (/bin/<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"online"</span></span> &gt; /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/smarthome/security/status)</code> </pre> <br>  This rule is still simpler - it works on every event that matches the regular expression specified in the parameter ‚Äúpattern‚Äù.  As an action, it records in the system status file.  This file is analyzed by a script run by rules 1 and 2. In the case of the status ‚Äúonline‚Äù, the script is triggered, in the case of the value ‚Äúoffline‚Äù - the script does not trigger.  More on this a little further. <br><br>  <b>Rule 4: Processing the signal from a switch button tied to channel 4</b> <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=single ptype=regexp pattern=\w+\s+\d+\s+\d+\:\d+\:\d+\s+\w+\s+nooliterx\S+\s+Received\:\s+status\s+\d+,\s+channel\s+(4),\s+<span class="hljs-built_in"><span class="hljs-built_in">command</span></span>\s+4.* desc=switch guard mode offline action=shellcmd (/bin/<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"offline"</span></span> &gt; /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/smarthome/security/status)</code> </pre> <br>  Everything is similar to rule 3, only the status is set to ‚Äúoffline‚Äù. <br><br><h3>  <b>The script that performs the reception of photos from the camera and sending emails</b> </h3><br>  The script run by rules 1 and 2 checks the status of the system in the status file and, depending on its value (‚Äúonline‚Äù or ‚Äúoffline‚Äù), performs or does not perform the following actions: <br><br><ul><li>  receives a photo from the IP camera in the vestibule and sends it by e-mail in the event of a sensor in the vestibule; </li><li>  sends an alarm message in the event of a sensor in the corridor. </li></ul><br>  Below is the body of the script.  At its input, it receives (from the SEC) the channel number to which the sensor is attached, and depending on this number and the system status, performs certain actions. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh dir="/usr/local/smarthome/security" MAIL=$dir/mail.letter stat_file="$dir/status" dt=`date` if [ "$1" -eq 2 ] then if grep "online" $stat_file then cd $dir rm -f $dir/snapshot.cgi wget http://&lt;IP  &gt;/snapshot.cgi --user=&lt;username&gt; --password=&lt;password&gt; mpack -s "Someone at the door at $dt" $dir/snapshot.cgi d.shulinin@gmail.com fi elif [ "$1" -eq 3 ] then if grep "online" $stat_file then printf "Subject: Motion in the lobby spotted at $dt\n" &gt; $MAIL /usr/sbin/ssmtp email@gmail.com &lt; $MAIL fi else echo "no legitimate input detected" fi</span></span></code> </pre> <br>  To get photos from my IP camera, I use wget and a line like this: <br><br><pre> <code class="bash hljs">wget http://&lt;IP  &gt;/snapshot.cgi --user=&lt;username&gt; --password=&lt;password&gt;</code> </pre> <br>  For other IP cameras, you may need to look for other options, there is no single solution.  RTFM to the camera, as they say. <br><br>  Buttons on and off the system in the web interface.  To enable and disable the security mode, I also added a couple of buttons to my samopisny web interface to control the lights of the smart home. <br><br>  They look like this: <br><br><pre> <code class="bash hljs">&lt;?php <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isset(<span class="hljs-variable"><span class="hljs-variable">$_POST</span></span>[<span class="hljs-string"><span class="hljs-string">'button9_on'</span></span>])) { <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span>(<span class="hljs-string"><span class="hljs-string">'/bin/echo "online" &gt; /usr/local/smarthome/security/status'</span></span>); } ?&gt; &lt;?php <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isset(<span class="hljs-variable"><span class="hljs-variable">$_POST</span></span>[<span class="hljs-string"><span class="hljs-string">'button9_off'</span></span>])) { <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span>(<span class="hljs-string"><span class="hljs-string">'/bin/echo "offline" &gt; /usr/local/smarthome/security/status'</span></span>); } ?&gt; &lt;p&gt;&lt;h2&gt;Guard mode&lt;/h2&gt;&lt;/p&gt; &lt;form method=<span class="hljs-string"><span class="hljs-string">"post"</span></span>&gt; &lt;p&gt; &lt;button name=<span class="hljs-string"><span class="hljs-string">"button9_on"</span></span>&gt;ON&lt;/button&gt; &lt;button name=<span class="hljs-string"><span class="hljs-string">"button9_off"</span></span>&gt;OFF&lt;/button&gt; &lt;/p&gt;</code> </pre> <br>  Everything is simple here - when you click on the "ON" button, online is written to the status file, when you click on OFF, offline. <br><br><h2>  <b>5. Conclusion</b> </h2><br>  As a result, I got a system that, when activated, takes pictures of anyone who approaches the door and sends the photo to e-mail.  And in the case of movement within the apartment, it simply sends an alert by e-mail. <br><br>  Something like this is a sample email message (see Figure 3).  The images themselves, of course, are larger and unfold when you click on them with the mouse. <br><br><img src="https://habrastorage.org/files/fe5/9d4/689/fe59d468920b4e9fbfb5059d3f1d40aa.jpg"><br>  <i><b>Figure 3</b> - Example of an email with a photo</i> <br><br>  The system can be activated and deactivated by pressing a button on the switch and also by means of buttons in the web interface of the smart home control system. <br><br>  In the short term, I also want to display the current status of the system (active / inactive) in the web interface. </div><p>Source: <a href="https://habr.com/ru/post/401909/">https://habr.com/ru/post/401909/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../401899/index.html">Multifunctional GPSLogger do it yourself. Part 1</a></li>
<li><a href="../401901/index.html">Moon vent to the universe</a></li>
<li><a href="../401903/index.html">How sounds affect our sleep and productivity</a></li>
<li><a href="../401905/index.html">Apple Power Mac G4 Cube and its contemporaries in a small photo review</a></li>
<li><a href="../401907/index.html">Robotic cars must learn to understand people.</a></li>
<li><a href="../401911/index.html">Power backup in the Maria-Ra data center</a></li>
<li><a href="../401913/index.html">1-Wire bus driver for power controllers less than 5V</a></li>
<li><a href="../401915/index.html">MWC 2017: smartphones</a></li>
<li><a href="../401917/index.html">Toys all ages</a></li>
<li><a href="../401919/index.html">ONO 3D printer. Stereolithography - to the masses</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>