<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fix corrupted MySQL tables with myisamchk</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="MyISAM is the main, or rather, one of the main (along with InnoDB) storage systems in the MySQL DBMS. At the same time MyISAM tables are damaged very ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fix corrupted MySQL tables with myisamchk</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/688/858/fac/688858fac7ffcf5a6dcf8dea6af3f720.jpg" align="left">  MyISAM is the main, or rather, one of the main (along with InnoDB) storage systems in the MySQL DBMS.  At the same time MyISAM tables are damaged very simply - there are no problems with this.  It is more difficult to repair all damage, although this can also be done fairly quickly.  This article explains how to solve the problem using myisamchk to identify the problem with MyISAM and fix it. <br><br>  It is well known that when creating a table in MySQL, three different files are created: * .frm - table format, * .MYD (MyData) - data storage, * .MYI (MyIndex) - index.  For large databases, use InnoDB because there is some similarity with Oracle and the corresponding functionality. <br><a name="habracut"></a><br>  As an example of the demonstration of the error, we will use this: <br><br><pre><code class="sql hljs">undef error - DBD::mysql::db selectrow_array failed: Table 'attach_data' is marked as crashed and should be repaired [for Statement "<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LENGTH</span></span>(thedata) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> attach_data <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = ?<span class="hljs-string"><span class="hljs-string">"] at Bugzilla/Attachment.pm line 344 Bugzilla::Attachment::datasize('Bugzilla::Attachment=HASH(0x9df119c)') called</span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It is clear that the attach_data table is damaged and needs to be fixed.  The table will be fixed using myisamchk. <br><br><h3>  1. Determine all damaged tables using myisamchk </h3><br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment"># myisamchk /var/lib/mysql/bugs/*.MYI &gt;&gt; /tmp/myisamchk_log.txt myisamchk: error: Wrong bytesec: 0-0-0 at linkstart: 18361936 MyISAM-table 'attach_data.MYI' is corrupted Fix it using switch "-r" or "-o" myisamchk: warning: 1 client is using or hasn't closed the table properly MyISAM-table 'groups.MYI' is usable but should be fixed myisamchk: warning: 1 client is using or hasn't closed the table properly MyISAM-table 'profiles.MYI' is usable but should be fixed</span></span></code> </pre> <br><br>  If you specify the output of myisamchk to a temporary file, only the names of the damaged tables will be displayed.  But in the /tmp/myisamchk_log.txt file there will be much more data including the names of the intact tables: <br><br><pre> <code class="sql hljs">Checking MyISAM file: user_group_map.MYI Data records: 182 Deleted blocks: 0 - <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">size</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-built_in"><span class="hljs-built_in">record</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">chain</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">chain</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">reference</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-built_in"><span class="hljs-built_in">record</span></span> <span class="hljs-keyword"><span class="hljs-keyword">references</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><br><h3>  2. Fix corrupted tables using myisamchk </h3><br><br>  To do this, use myisamchk, with the -r option, as shown below: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment"># myisamchk -r profiles.MYI - recovering (with sort) MyISAM-table 'profiles.MYI' Data records: 80 - Fixing index 1 - Fixing index 2</span></span></code> </pre> <br><br>  An error message may appear here: clients should, if the tables are still used by any application or other tables.  In order to avoid this error, you should complete mysqld before you begin fixing the tables.  Here you can use FLUSH TABLES. <br><br><h3>  3. Run the check and fix for the entire MySQL database. </h3><br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment"># myisamchk --silent --force --fast --update-state /var/lib/mysql/bugs/*.MYI myisamchk: MyISAM file /var/lib/mysql/bugs/groups.MYI myisamchk: warning: 1 client is using or hasn't closed the table properly myisamchk: MyISAM file /var/lib/mysql/bugs/profiles.MYI myisamchk: warning: 1 client is using or hasn't closed the table properly</span></span></code> </pre> <br><br>  -s: print only errors.  You can use double -s -s to make it as quiet as possible; <br>  -f: automatically restart myisamchk with the -r option, there are errors found; <br>  -F: check only tables that were not closed in normal mode; <br>  -U: mark tables as damaged if errors are found. <br><br><h3>  4. The use of additional memory for large MySQL databases </h3><br><br>  In the case of working with large databases, recovery may take several hours.  If there are additional resources, they can be used to speed up the process: <br><br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment"># myisamchk --silent --force --fast --update-state \ --key_buffer_size=512M --sort_buffer_size=512M \ --read_buffer_size=4M --write_buffer_size=4M \ /var/lib/mysql/bugs/*.MYI</span></span></code> </pre> <br><br><h3>  5. Using myisamchk to retrieve table data </h3><br><br>  If necessary, you can get quite a lot of data. <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment"># myisamchk -dvv profiles.MYI MyISAM file: profiles.MYI Record format: Packed Character set: latin1_swedish_ci (8) File-version: 1 Creation time: 2007-08-16 18:46:59 Status: open,changed,analyzed,optimized keys,sorted index pages Auto increment key: 1 Last value: 88 Data records: 88 Deleted blocks: 0 Datafile parts: 118 Deleted data: 0 Datafile pointer (bytes): 4 Keyfile pointer (bytes): 4 Datafile length: 6292 Keyfile length: 6144 Max datafile length: 4294967294 Max keyfile length: 4398046510079 Recordlength: 2124 table description: Key Start Len Index Type Rec/key Root Blocksize 1 2 3 unique int24 1 1024 1024 2 5 765 unique char packed stripped 1 2048 4096 Field Start Length Nullpos Nullbit Type 1 1 1 2 2 3 no zeros 3 5 765 no endspace</span></span></code> </pre> <br><br><h3>  6. All options myisamchk </h3><br><br>  In order to get additional information on the team, you should use the help: <br><br>  # myisamchk - help <br><br>  <b>General options:</b> <br><br>  -s: only error output; <br>  -v: output more information; <br>  -V: output version and exit; <br>  -w: wait if the table is locked. <br><br>  <b>Scan options:</b> <br><br>  -c: check tables for errors; <br>  -e: very "rough" check.  It should be used only as a last resort, if in normal mode errors are not detected; <br>  -F: quick check, only tables that are not closed correctly are checked; <br>  -C: checking only tables that have changed since the last calibration; <br>  -f: automatically restart myisamchk with the -r option, there are errors found; <br>  -i: show statistics on checked tables; <br>  -m: lite check mode, 99.99% of errors are faster than normal; <br>  -U: status update: mark tables as damaged if any errors are detected; <br>  -T: Do not mark tables as checked. <br><br>  <b>Correction options:</b> <br><br>  -B: backup file .MYD, "filename-time.BAK"; <br>  --correct-checksum; <br>  -e: attempt to correct the maximum number of lines in the data file.  In addition, this command finds ‚Äújunk‚Äù strings.  You should not use this command if the situation is not hopeless; <br>  -f: overwrite old temporary files; <br>  -r: fixes almost everything except unique keys that are not really unique; <br>  -n: force sorting, even if the temporary file is very large; <br>  -o: use the old recovery method; <br>  -q: quick fix without modifying the data file; <br>  -u: unpacking a file packed with myisampack. </div><p>Source: <a href="https://habr.com/ru/post/257291/">https://habr.com/ru/post/257291/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257279/index.html">STM32. We connect ISO7816 smart cards</a></li>
<li><a href="../257281/index.html">We spread PHP</a></li>
<li><a href="../257283/index.html">What prepares us for C # 7 (Part 2. Pattern matching)</a></li>
<li><a href="../257285/index.html">Cards, money, two stars</a></li>
<li><a href="../257287/index.html">Head Unit - as a target for a hacker</a></li>
<li><a href="../257293/index.html">Attackers use Linux / Mumblehard to compromise servers, part 2</a></li>
<li><a href="../257295/index.html">Just about corporate IaaS: what it is, for whom, and how it is paid</a></li>
<li><a href="../257297/index.html">Centralized collection and processing of Windows print logs</a></li>
<li><a href="../257299/index.html">How clouds have changed the architecture of data centers</a></li>
<li><a href="../257301/index.html">2.5 million views - did you work well? Time to go on</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>