<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We're friends with Prometheus with Cach√©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prometheus is one of the monitoring systems adapted for collecting time series data . 
 It is quite simple in installation and initial setup. It has a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We're friends with Prometheus with Cach√©</h1><div class="post__text post__text-html js-mediator-article">  <a href="https://prometheus.io/">Prometheus</a> is one of the monitoring systems adapted for collecting <a href="https://en.wikipedia.org/wiki/Time_series_database">time series data</a> . <br>  It is quite simple in installation and initial setup.  It has a built-in graphic subsystem for displaying <a href="https://prometheus.io/docs/visualization/promdash/">PromDash</a> data, but the developers themselves recommend using the free third-party product <a href="http://grafana.org/">Grafana</a> .  Prometheus can monitor a lot of things (hardware, containers, various DBMS), but in this article I would like to dwell on the implementation of monitoring the <a href="">Cach√©</a> instance (more precisely, the instance will be Ensemble, but we will take the metrics porridge).  To whom it is interesting - you are welcome under the cat. <br> <a href="https://habrahabr.ru/company/intersystems/blog/318940/"><img src="https://habrastorage.org/files/79a/658/0d5/79a6580d5724411785cd221e860efbee.jpg"></a> <br><a name="habracut"></a><br>  In our simplest case, Prometheus and Cach√© will live on the same machine (Fedora Workstation 24 x86_64).  Cach√© Version: <br><br><blockquote>  % Sys&gt; <b>write $ zv</b> <br>  Cache for UNIX (Red Hat Enterprise Linux for x86-64) 2016.1 (Build 656U) Fri Mar 11 2016 17:58:47 EST </blockquote><br><h3>  Installation and configuration </h3><br>  Downloading a suitable Prometheus distribution from offsite and save it to the / opt / prometheus directory. <br><br><img src="https://habrastorage.org/files/32c/8e6/597/32c8e6597ec3463e996ae281380c6cb7.jpg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We unpack archive, we rule the available sample config according to our needs and we start Prometheus.  By default, Prometheus will log its work directly to the console, so we will redirect its activity records to a log file. <br><br><div class="spoiler">  <b class="spoiler_title">Launch Prometheus</b> <div class="spoiler_text">  # <b>pwd</b> <br>  / opt / prometheus <br>  # <b>ls</b> <br>  prometheus-1.4.1.linux-amd64.tar.gz <br>  # <b>tar -xzf prometheus-1.4.1.linux-amd64.tar.gz</b> <br>  # <b>ls</b> <br>  prometheus-1.4.1.linux-amd64 prometheus-1.4.1.linux-amd64.tar.gz <br>  # <b>cd prometheus-1.4.1.linux-amd64 /</b> <br>  # <b>ls</b> <br>  console_libraries consoles LICENSE NOTICE prometheus prometheus.yml promtool <br>  # <b>cat prometheus.yml</b> <br>  <i>global:</i> <i><br></i>  <i>scrape_interval: 15s # Set the scrape interval to every 15 seconds.</i>  <i>Default is every 1 minute.</i> <i><br><br></i>  <i>scrape_configs:</i> <i><br></i>  <i>- job_name: 'isc_cache'</i> <i><br></i>  <i>metrics_path: '/ metrics / cache'</i> <i><br></i>  <i>static_configs:</i> <i><br></i>  <i>- targets: ['localhost: 57772']</i> <br>  # <b>./prometheus&gt; /var/log/prometheus.log 2&gt; &amp; 1 &amp;</b> <br>  [1] 7117 <br>  # <b>head /var/log/prometheus.log</b> <br>  time = "2017-01-01T09: 01: 11 + 02: 00" level = info msg = "Starting prometheus (version = 1.4.1, branch = master, revision = 2a89e8733f240d3cd57a6520b52c36ac4744ce12)" source = "main.go: 77" <br>  time = "2017-01-01T09: 01: 11 + 02: 00" level = info msg = "Build context (go = go1.7.3, user = root @ e685d23d8809, date = 20161128-09: 59: 22)" source = "Main.go: 78" <br>  time = "2017-01-01T09: 01: 11 + 02: 00" level = info msg = "Loading configuration file prometheus.yml" source = "main.go: 250" <br>  time = "2017-01-01T09: 01: 11 + 02: 00" level = info msg = "Loading series map and head chunks ..." source = "storage.go: 354" <br>  time = "2017-01-01T09: 01: 11 + 02: 00" level = info msg = "23 series loaded." source = "storage.go: 359" <br>  time = "2017-01-01T09: 01: 11 + 02: 00" level = info msg = " <b>Listening on: 9090</b> " source = "web.go: 248" <br></div></div><br>  The prometheus.yml config is described in a <a href="https://ru.wikipedia.org/wiki/YAML">YAML</a> language that does not like tabs, only spaces should be used.  Above, we indicated that we will pull the metrics from the address <a href="http://localhost:57772/">http: // localhost: 57772</a> and we will poll the application / metrics / cache (the name of the application is chosen arbitrarily), i.e.  The final address for collecting metrics will be <a href="http://localhost:57772/metrics/cache">http: // localhost: 57772 / metrics / cache</a> .  The label ‚Äújob = isc_cache‚Äù will be added to each metric.  The label is, quite roughly, the equivalent of WHERE for SQL.  In our case, it will not be used, but for the number of servers, more than one, it is even suitable.  For example, the names of servers (and / or instances) can be stored in labels and, in future, with labels, parameterize requests for drawing graphs.  Let's check that Prometheus has earned (higher in the output we see the port that it is listening on - 9090): <br><br><img src="https://habrastorage.org/files/8a7/9f0/051/8a79f0051a9f48548dd997c8dd03486a.jpg" alt="image"><br><br>  The web interface has opened, so Prometheus is working.  However, he still doesn‚Äôt see the Cach√© metrics, of course (check by clicking Status ‚Üí Targets): <br><br><img src="https://habrastorage.org/files/e7d/cb3/cdc/e7dcb3cdce634226a2efbd0c5d34e42e.jpg" alt="image"><br><h3>  Preparation of metrics </h3><br>  Our task is to make it so that at <a href="http://localhost:57772/metrics/cache">http: // localhost: 57772 / metrics / cache</a> it is possible to pull down the metrics in a way that is clear to Prometheus.  We will use <a href="">Cach√© REST capabilities</a> due to their simplicity.  Immediately, we note that Prometheus "understands" only numeric metrics, so we will not export string metrics.  To get test metrics we will use the API class <a href="">SYS.Stats.Dashboard</a> .  These metrics are used by Cach√© itself to display the System toolbar: <br><br><img src="https://habrastorage.org/files/7d9/a17/1eb/7d9a171eba444586b6959b22efefc3d4.jpg" alt="image"><br><br><div class="spoiler">  <b class="spoiler_title">An example of the same in the Terminal</b> <div class="spoiler_text">  % SYS&gt; <b>set dashboard = ## class (SYS.Stats.Dashboard) .Sample ()</b> <br>  % <b>Sys</b> &gt; <b>zwrite dashboard</b> <br>  dashboard = &lt;OBJECT REFERENCE&gt; [2@SYS.Stats.Dashboard] <br>  + ----------------- general information - |  oref value: 2 <br>  |  class name: SYS.Stats.Dashboard <br>  |  reference count: 2 <br>  + ----------------- attribute values ‚Äã‚Äã- |  ApplicationErrors = 0 <br>  |  CSPSessions = 2 <br>  |  CacheEfficiency = 280.03 <br>  |  DatabaseSpace = "Normal" <br>  |  DiskReads = 2317 <br>  |  DiskWrites = 329 <br>  |  ECPAppServer = "OK" <br>  |  ECPAppSrvRate = 0 <br>  |  ECPDataServer = "OK" <br>  |  ECPDataSrvRate = 0 <br>  |  GloRefs = 740953 <br>  |  GloRefsPerSec = "166.00" <br>  |  GloSets = 60947 <br>  |  JournalEntries = 403 <br>  ... <br></div></div><br>  The USER area will serve as a sandbox.  First, create a REST web application / metrics.  For at least some security, we specify the login to the application with a password, we also indicate that there will be a certain resource corresponding to this web application, let's call it PromResource.  In a resource we close public access.  That is, do the following: <br><blockquote>  % SYS&gt; <b>write ## class (Security.Resources) .Create ("PromResource", "Resource for Metrics web page", "")</b> <br>  one </blockquote><br>  Settings of our web application: <br><br><img src="https://habrastorage.org/files/66a/9f0/b3c/66a9f0b3c3744302b41e54625ebbd072.jpg" alt="image"><br><br>  We will need a user who can use this resource.  Also, the user must have the rights to read the working database (in our case, USER) and write to it.  In addition, he will need the right to read the CACHESYS system database, since we will move to the% SYS area below in the implementation code.  We will follow the standard scheme, i.e.  create a PromRole role with these capabilities, then create a PromUser user with this role.  Password, for example, choose "Secret": <br><blockquote>  % SYS&gt; <b>write ## class (Security.Roles) .Create ("PromRole", "Role for PromResource", "PromResource: U,% DB_USER: RW,% DB_CACHESYS: R")</b> <br>  one <br>  % SYS&gt; <b>write ## class (Security.Users) .Create ("PromUser", "PromRole", "Secret")</b> <br>  one </blockquote><br>  We will specify this PromUser user for authentication in the Prometheus config.  Then we re-read the config by sending the SIGHUP signal to the server process. <br><br><div class="spoiler">  <b class="spoiler_title">Safer config</b> <div class="spoiler_text">  # <b>cat /opt/prometheus/prometheus-1.4.1.linux-amd64/prometheus.yml</b> <br>  <i>global:</i> <i><br></i>  <i>scrape_interval: 15s # Set the scrape interval to every 15 seconds.</i>  <i>Default is every 1 minute.</i> <i><br><br></i>  <i>scrape_configs:</i> <i><br></i>  <i>- job_name: 'isc_cache'</i> <i><br></i>  <i>metrics_path: '/ metrics / cache'</i> <i><br></i>  <i>static_configs:</i> <i><br></i>  <i>- targets: ['localhost: 57772']</i> <i><br></i>  <i><b>basic_auth:</b></i> <i><br></i>  <i><b>username: 'PromUser'</b></i> <i><br></i>  <i><b>password: 'Secret'</b></i> <br>  # <br>  # <b>kill -SIGHUP $ (pgrep prometheus)</b> # or kill -1 $ (pgrep prometheus) <br></div></div><br>  Prometheus can now successfully authenticate to use a web application with metrics. <br><br>  Metrics will be given to us by the my.Metrics REST request handler class. <br><br><div class="spoiler">  <b class="spoiler_title">Here is its implementation</b> <div class="spoiler_text"><pre><code class="hljs lua">Class my.Metrics Extends %CSP.REST { Parameter ISCPREFIX = <span class="hljs-string"><span class="hljs-string">"isc_cache"</span></span>; Parameter DASHPREFIX = {..#ISCPREFIX_<span class="hljs-string"><span class="hljs-string">"_dashboard"</span></span>}; XData UrlMap [ XMLNamespace = <span class="hljs-string"><span class="hljs-string">"http://www.intersystems.com/urlmap"</span></span> ] { &lt;Routes&gt; &lt;Route Url=<span class="hljs-string"><span class="hljs-string">"/cache"</span></span> Method=<span class="hljs-string"><span class="hljs-string">"GET"</span></span> Call=<span class="hljs-string"><span class="hljs-string">"getMetrics"</span></span>/&gt; &lt;/Routes&gt; } /// Output should obey the Prometheus exposition formats. Docs: /// https://prometheus.<span class="hljs-built_in"><span class="hljs-built_in">io</span></span>/docs/instrumenting/exposition_formats/ /// /// The protocol is line-oriented. A line-feed character (\n) separates <span class="hljs-built_in"><span class="hljs-built_in">lines</span></span>. /// The last line must <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> with a line-feed character. Empty <span class="hljs-built_in"><span class="hljs-built_in">lines</span></span> are ignored. ClassMethod getMetrics() As %Status { set nl = $c(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ..getDashboardSample(.dashboard) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ..getClassProperties(dashboard.%ClassName(<span class="hljs-number"><span class="hljs-number">1</span></span>), .propList, .descrList) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i=<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:$ll(propList) { set descr = $lg(descrList,i) set propertyName = $lg(propList,i) set propertyValue = $property(dashboard, propertyName) // Prometheus supports <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> series database // so <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> we get empty (<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> example, backup metrics) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> non-digital metrics // we just omit them. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((propertyValue <span class="hljs-string"><span class="hljs-string">'= "") &amp;&amp; ('</span></span>$<span class="hljs-built_in"><span class="hljs-built_in">match</span></span>(propertyValue, <span class="hljs-string"><span class="hljs-string">".*[-A-Za-z ]+.*"</span></span>))) { set metricsName = ..#DASHPREFIX_..camelCase2Underscore(propertyName) set metricsValue = propertyValue // Write description (help) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> each metrics. // Format is that the Prometheus requires. // Multiline descriptions we have to join <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> one <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>. <span class="hljs-built_in"><span class="hljs-built_in">write</span></span> <span class="hljs-string"><span class="hljs-string">"# HELP "</span></span>_metricsName_<span class="hljs-string"><span class="hljs-string">" "</span></span>_$replace(descr,nl,<span class="hljs-string"><span class="hljs-string">" "</span></span>)_nl <span class="hljs-built_in"><span class="hljs-built_in">write</span></span> metricsName_<span class="hljs-string"><span class="hljs-string">" "</span></span>_metricsValue_nl } } <span class="hljs-built_in"><span class="hljs-built_in">write</span></span> nl quit $$$OK } ClassMethod getDashboardSample(Output dashboard) { new $namespace set $namespace = <span class="hljs-string"><span class="hljs-string">"%SYS"</span></span> set dashboard = ##class(SYS.Stats.Dashboard).Sample() } ClassMethod getClassProperties(className As %String, Output propList As %List, Output descrList As %List) { new $namespace set $namespace = <span class="hljs-string"><span class="hljs-string">"%SYS"</span></span> set propList = <span class="hljs-string"><span class="hljs-string">""</span></span>, descrList = <span class="hljs-string"><span class="hljs-string">""</span></span> set properties = ##class(%Dictionary.ClassDefinition).%OpenId(className).Properties <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i=<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:properties.Count() { set property = properties.GetAt(i) set propList = propList_$lb(property.Name) set descrList = descrList_$lb(property.Description) } } /// Converts metrics name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> camel case to underscore name with <span class="hljs-built_in"><span class="hljs-built_in">lower</span></span> case /// Sample: <span class="hljs-built_in"><span class="hljs-built_in">input</span></span> = WriteDaemon, <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> = _write_daemon ClassMethod camelCase2Underscore(metrics As %String) As %String { set result = metrics set regexp = <span class="hljs-string"><span class="hljs-string">"([AZ])"</span></span> set matcher = ##class(%Regex.Matcher).%New(regexp, metrics) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (matcher.Locate()) { set result = matcher.ReplaceAll(<span class="hljs-string"><span class="hljs-string">"_"</span></span>_<span class="hljs-string"><span class="hljs-string">"$1"</span></span>) } // To <span class="hljs-built_in"><span class="hljs-built_in">lower</span></span> case set result = $zcvt(result, <span class="hljs-string"><span class="hljs-string">"l"</span></span>) // _e_c_p (_c_s_p) to _ecp (_csp) set result = $replace(result, <span class="hljs-string"><span class="hljs-string">"_e_c_p"</span></span>, <span class="hljs-string"><span class="hljs-string">"_ecp"</span></span>) set result = $replace(result, <span class="hljs-string"><span class="hljs-string">"_c_s_p"</span></span>, <span class="hljs-string"><span class="hljs-string">"_csp"</span></span>) quit result } }</code> </pre> <br></div></div><br>  In the console, let's check that our works were not in vain (the --silent key was added so that curl does not interfere with its progress bar): <br><br><div class="spoiler">  <b class="spoiler_title">Checking unloading metrics</b> <div class="spoiler_text">  # <b>curl --user PromUser: Secret --silent -XGET 'http: // localhost: 57772 / metrics / cache' |</b>  <b>head -20</b> <br>  # HELP isc_cache_dashboard_application_errors Number of application errors <br>  isc_cache_dashboard_application_errors 0 <br>  # HELP isc_cache_dashboard_csp_sessions Most recent number of CSP sessions. <br>  isc_cache_dashboard_csp_sessions 2 <br>  HELP isc_cache_dashboard_cache_efficiency Most recently measured cache efficiency (Global references / (physical reads + writes)) <br>  isc_cache_dashboard_cache_efficiency 439.56 <br>  # HELP isc_cache_dashboard_disk_reads Number of physical block read operations since system startup. <br>  isc_cache_dashboard_disk_reads 2605 <br>  # HELP isc_cache_dashboard_disk_writes Number <br>  isc_cache_dashboard_disk_writes 1021 <br>  # HELP isc_cache_dashboard_ecp_app_srv_rate Most recently measured ECP. <br>  isc_cache_dashboard_ecp_app_srv_rate 0 <br>  # HELP isc_cache_dashboard_ecp_data_srv_rate Most recently measured ECP. <br>  isc_cache_dashboard_ecp_data_srv_rate 0 <br>  # HELP isc_cache_dashboard_glo_refs Number of Global references since system startup. <br>  isc_cache_dashboard_glo_refs 1593830 <br>  # HELP isc_cache_dashboard_glo_refs_per_sec Most recently measured number of global references per second. <br>  isc_cache_dashboard_glo_refs_per_sec 131.00 <br>  # HELP isc_cache_dashboard_glo_sets Number of Global Sets and Kills since system startup. <br>  isc_cache_dashboard_glo_sets 132003 <br></div></div><br>  Now you can check in the interface of Prometheus: <br><br><img src="https://habrastorage.org/files/1e1/f4c/401/1e1f4c4013784334b03b035971d61a97.jpg" alt="image"><br><br>  Here is a list of our metrics: <br><br><img src="https://habrastorage.org/files/520/4e7/437/5204e7437ba74f1799d39e9ea4893807.jpg" alt="image"><br><br>  We will not dwell on their viewing in the Prometheus itself.  Those interested can select the desired metric and click the ‚ÄúExecute‚Äù button.  By selecting the ‚ÄúGraph‚Äù tab, you can see the graph (the cache efficiency is shown): <br><br><img src="https://habrastorage.org/files/f12/fd4/b31/f12fd4b312464296b9ae20068c0770b6.jpg" alt="image"><br><br><h3>  Visualization of metrics </h3><br>  For the graphic display we will set ourselves <a href="http://grafana.org/download/">Grafana</a> .  For this article, an installation of tarball was chosen.  But there are many installation options, from packages to container.  Perform these steps (just create the directory / opt / grafana and go into it): <br><br><img src="https://habrastorage.org/files/43a/abd/153/43aabd1532754c20a57230bc217b4c5b.jpg" alt="image"><br><br>  Config while we will leave as is.  And in the last step, we will start Grafana in the background.  The Grafana log will be redirected to a file, as is the case with Prometheus: <br><blockquote>  # ./bin/grafana-server&gt; /var/log/grafana.log 2&gt; &amp; 1 &amp; </blockquote><br>  The default Grafana web interface is available on port 3000. Login / password: admin / admin. <br><br><img src="https://habrastorage.org/files/184/88f/ee6/18488fee6c404bd4a84cb3b3a18de652.jpg" alt="image"><br><br>  How to make friends Prometheus with Grafana is described <a href="https://prometheus.io/docs/visualization/grafana/">here</a> .  If in your own words, then we add a new Data Source with the type Prometheus.  As direct / proxy access, choose your option: <br><br><img src="https://habrastorage.org/files/3a1/cc8/68a/3a1cc868a63f4971a31ca4a84139e8b9.jpg" alt="image"><br><br>  Then we add a dashboard with the panels we need.  Dashboard Dashboard is available in <a href="https://github.com/myardyas/prometheus">public</a> .  There is also a class code for collecting metrics.  Dashboards can be simply imported into your Grafana (Dashboards ‚Üí Import): <br><br><img src="https://habrastorage.org/files/e11/93f/be6/e1193fbe63634d2a87ff816cef517f39.jpg" alt="image"><br><br>  After the import, we get the following picture: <br><br><img src="https://habrastorage.org/files/710/cd6/691/710cd669177c4cb38c7b574eb1cb37a8.jpg" alt="image"><br><br>  Let's save Dashboard: <br><br><img src="https://habrastorage.org/files/2c0/be6/781/2c0be678188540068bde680190b3adab.jpg" alt="image"><br><br>  The time range selection and update period are selected at the top right: <br><br><img src="https://habrastorage.org/files/041/351/9a4/0413519a4ffc4e90afc68daa0649a5b7.jpg" alt="image"><br><br><h3>  Examples of monitoring work </h3><br>  Test the monitoring of access to globals: <br><blockquote>  USER&gt; for i = 1: 1: 1000000 {set ^ prometheus (i) = i} <br>  USER&gt; kill ^ prometheus </blockquote><br>  We see that the number of references to globals per second has increased, while the cache efficiency has fallen (the global ^ prometheus was not in the cache yet): <br><br><img src="https://habrastorage.org/files/38a/c5f/add/38ac5faddd2f44ea923efdeb8b36ddef.jpg" alt="image"><br><br>  Check the use of licenses.  Create a primitive CSP page PromTest.csp in the USER area: <br><blockquote>  &lt;html&gt; <br>  &lt;head&gt; &lt;title&gt; Prometheus Test Page &lt;/ title&gt; &lt;/ head&gt; <br>  &lt;body&gt; Monitoring works fine! &lt;/ body&gt; <br>  &lt;/ html&gt; </blockquote><br>  And we will visit it a certain number of times (we assume the application / csp / user is not password protected): <br><blockquote>  # ab -n77 <a href="">http: // localhost: 57772 / csp / user / PromTest.csp</a> </blockquote><br>  We will see this picture with licenses: <br><br><img src="https://habrastorage.org/files/fe7/8c0/a34/fe78c0a34bfe41ea8f1a762925fbb9b8.jpg" alt="image"><br><br><h3>  Brief conclusions </h3><br>  As you can see, the implementation of such monitoring is not difficult.  Already at the initial stage, we can obtain important information about the operation of the system, such as: the use of licenses, the effectiveness of the global cache, the presence of application errors.  For example, the <a href="">SYS.Stats.Dashboard</a> class was taken, but other classes of the SYS,% SYSTEM,% SYS packages deserve no less attention.  Also, no one limits in imagination and the possibility of writing your own class, which, upon request, gives out the metrics of your application, for example, the number of documents of one type or another.  Some useful metrics are planned to be put in a separate template for Grafana. <br><br><h3>  To be continued </h3><br>  If this topic is interesting, the sequel will follow.  What are the plans: <br><br><ol><li>  Preparing a template for Grafana with metrics for the daemon write operation.  It would be nice to make a certain graphical analogue of the <a href="">^ mgstat utility</a> , in any case, for a part of its metrics. </li><li>  The password for the web application is good, but I would like to check the possibility of using certificates. </li><li>  The use of Prometheus, Grafana and some exporters for Prometheus is already in the form of Docker containers. </li><li>  Use discovery services to automatically add new Cach√© instances to Prometheus monitoring.  Here I would also like to show in practice such a convenient Grafana thing as templates.  This is something like dynamic panels, when depending on the selected server, only its metrics are shown, but all this is on the same Dashboard. </li><li>  Alert Manager Prometheus. </li><li>  Prometheus configuration settings regarding data retention time, as well as optimization options for systems with a large number of metrics and a small collection interval. </li><li>  Different nuances that will emerge along the way. </li></ol><br><h3>  Links </h3><br>  In the process of preparing this article, a number of useful places were visited and a number of videos were viewed: <br><br><ul><li>  <a href="https://prometheus.io/">Prometheus project website</a> </li><li>  <a href="http://grafana.org/">Grafana project website</a> </li><li>  <a href="https://blog.selectel.ru/monitoring-servisov-s-prometheus/">Selectel blog</a> </li><li>  <a href="https://www.robustperception.io/blog/">The blog of one of the developers of Prometheus named Brian Brazil</a> </li><li>  <a href="https://www.digitalocean.com/community/tutorials/how-to-use-prometheus-to-monitor-your-ubuntu-14-04-server">Tutorial on DigitalOcean site</a> </li><li>  <a href="https://www.youtube.com/channel/UCtiFWOeRSTP3M6QUnTEKwpw">A little video from the company Robust Perception</a> </li><li>  <a href="https://www.youtube.com/channel/UC4pLFely0-Odea4B2NL1nWA/videos">Lots of videos from the Prometheus conference</a> </li></ul><br>  Thanks to read to this line! <br><br>  PS Added the <a href="https://habrahabr.ru/company/intersystems/blog/331594/">second part</a> . </div><p>Source: <a href="https://habr.com/ru/post/318940/">https://habr.com/ru/post/318940/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318928/index.html">Promotion of new agency on upwork from scratch - personal experience</a></li>
<li><a href="../318930/index.html">Client communities at a glance</a></li>
<li><a href="../318934/index.html">Abstracted from hotkeys in desktop applications, or how to debug in any IDE with the same buttons</a></li>
<li><a href="../318936/index.html">Solution Architecture in 2017: interview with Eli Feldman, SRT EPAM</a></li>
<li><a href="../318938/index.html">Game HellWorm. Development history</a></li>
<li><a href="../318944/index.html">In search of free tickets, the study of the game Aeroflot: Mission 2017</a></li>
<li><a href="../318946/index.html">How to find a way to win the Russian AI Cup 2016, but in the wrong direction</a></li>
<li><a href="../318948/index.html">Finding GDI Object Leaks: How to Drive a Mastodon</a></li>
<li><a href="../318950/index.html">NativeScript, what kind of beast and what is it for?</a></li>
<li><a href="../318952/index.html">Let's Encrypt and nginx: configuration in Debian and Ubuntu</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>