<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Basics of Android NDK on the example of working with OpenAL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, dear Habrayuzer! 

 Recently, I have been developing applications for Android, in particular, developing games. It so happened that for one ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Basics of Android NDK on the example of working with OpenAL</h1><div class="post__text post__text-html js-mediator-article">  Good day, dear Habrayuzer! <br><br>  Recently, I have been developing applications for Android, in particular, developing games.  It so happened that for one project I had to work with Android ndk.  In principle, it is impossible to consider all the difficulties and nuances of working with native in one article, I decided to write a small introduction to ndk in this article. <br>  And so that the article was interesting not only for beginners, I will show how to work with OpenAL and WAV, OGG formats. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Introduction </h4><br>  About setting the environment to write a lot is not worth it, I think.  Regardless of the environment in which you develop (Eclipse, IntelliJ IDEA, etc.), the setup is quite simple. <br><ol><li>  <a href="http://developer.android.com/sdk/ndk/index.html">Android NDK itself</a> . </li><li>  To build under WIn you need <a href="http://www.cygwin.com/">Cygwin</a> . </li><li>  Plugins for the same Eclipse: <a href="http://download.eclipse.org/tools/cdt/releases/indigo/">CDT</a> . </li></ol><br>  Naturally, you should already have ADT, JDK. <br><br><h5>  Why do you need NDK? </h5><br><ul><li>  Work with OpenGL ES.  I think most of those who use NDK use it just for writing games. </li><li>  Using cross-platform game engines like Cocos2Dx </li><li>  The most obvious case is when you need to use code already written in C ++.  Over the decades, C ++ has already written a lot of things.  And not everything can be rewritten, I think the same openCV would be pointless to rewrite, at that time when you can simply connect the ready source. </li></ul><br><br><h4>  Calling C ++ code from Java </h4><br>  In general, everything is quite simple, the main steps: <br><ol><li>  Creating files with C ++ and defining methods for export. </li><li>  Create .mk files. </li><li>  Library generation </li><li>  Connect Library in Java. </li></ol><br><br><br>  About the Makefiles (.mk) will not paint.  You can read about him <a href="http://mrbook.org/tutorials/make/">here</a> .  In addition, on Habr√© there is a <a href="http://habrahabr.ru/post/155201/">good article on working with .mk files</a> from <a href="https://habrahabr.ru/users/bubavv/" class="user_link">BubaVV</a> . <br><br>  About libraries from ndk you can read <a href="http://mobilepearls.com/labs/native-android-api/">here</a> . <br><br><h5>  Creating C ++ Files </h5><br>  You need to define methods for export, which we will call from Java.  As an example, when you start the application, we will load the music in OpenAL.  To do this, we define the method: <br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">JNIEXPORT </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> JNICALL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_ru_suvitruf_androidndk_tutorial4_MainActivity_loadAudio</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv *pEnv, jobject pThis, jobject pNativeCallListener, jobject assetManager)</span></span></span></span>;</code> </pre> <br><br>  I write all this with pens, but there is a handy utility for automatically generating <a href="http://docs.oracle.com/javase/6/docs/technotes/tools/solaris/javah.html">javah</a> . <br><br>  Then we will need to implement it, but more on that later. <br><div class="spoiler">  <b class="spoiler_title">A little about the name</b> <div class="spoiler_text">  It is necessary to say a little about the name of the methods.  <b>Java_</b> is a required prefix.  <b>ru_suvitruf_androidndk_tutorial4</b> , since we have a package <b>ru.suvitruf.androidndk.tutorial4</b> , well, then the name of the class and method on the Java side.  Each function has <b>JNIEnv *</b> as an argument - an interface for working with Java, using it you can call Java methods, create Java objects.  The second required parameter - <b>jobject</b> or <b>jclass</b> - depending on whether the method is static.  If the method is static, then the argument will be of <b>jclass</b> type (reference to the class of the object in which the method is declared), if not static, <b>jobject</b> is a reference to the object on which the method was called. <br></div></div><br><br><h5>  Java library connection </h5><br>  After generating the library, you need to connect it to Java. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> { System.loadLibrary(<span class="hljs-string"><span class="hljs-string">"AndroidNDK"</span></span>); }</code> </pre><br><br>  And define a method with the same name as in C ++ code: <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//  native public void loadAudio(NativeCalls nativeCallListener, AssetManager mng);</span></span></code> </pre><br><br>  Call this: <br><pre> <code class="cpp hljs">loadAudio(activity, activity.getResources().getAssets());</code> </pre><br><br><h4>  Calling Java from C ++ </h4><br>  A little more complicated, but not so scary.  What we need: <br><ol><li>  Define the class method (in Java) that we want to call. </li><li>  Get the handle of the desired class (in C ++). </li><li>  Describe the method signature. </li><li>  Get method ID (link). </li><li>  Call the method at the desired object. </li></ol><br><br>  Of course, you can simply define the method of the class, but it is better to use interfaces.  Then we don‚Äôt have to change the native code if we want to work with another class. <br><br>  As an example, create an interface with just one method: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NativeCalls</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendLog</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String result)</span></span></span></span>; }</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">CalledFromWrongThreadException and proper implementation of the interface</b> <div class="spoiler_text">  Oh, those flows.  The problem is that you cannot affect a view from another thread.  Therefore, the entire implementation of the interface will be something like this: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> Handler handler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Handler() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Message msg)</span></span></span><span class="hljs-function"> </span></span>{ showResult(msg.getData().getString(<span class="hljs-string"><span class="hljs-string">"result"</span></span>)); } }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">showResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String result)</span></span></span></span>{ ((TextView) findViewById(R.id.log)). setText(((TextView) findViewById(R.id.log)).getText()+result+<span class="hljs-string"><span class="hljs-string">"\n"</span></span>); } <span class="hljs-comment"><span class="hljs-comment">//    @Override public void sendLog(String result){ Message msg = new Message(); Bundle data = new Bundle(); data.putString("result", result); msg.setData(data); handler.sendMessage(msg); }</span></span></code> </pre><br></div></div><br><br>  There may be no problems with threads, but in our case, when the application starts, we will create a separate thread to load resources, so the question is relevant for us. <br><br>  The Java interface in native C ++ code will correspond to the following class: <br><div class="spoiler">  <b class="spoiler_title">NativeCallListener</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NativeCallListener</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: NativeCallListener(JNIEnv* pJniEnv, jobject pWrapperInstance); NativeCallListener() {} <span class="hljs-comment"><span class="hljs-comment">//  //   Java  void sendLog(jobject log); //   void destroy(); ~NativeCallListener(){ } void loadAudio(); //void play(); //void playOGG(); ALCdevice* device; ALCcontext* context; private: JNIEnv* getJniEnv(); //   jmethodID sendLogID; //   jobject mObjectRef; JavaVM* mJVM; ALuint soundWAV; ALuint soundOGG; void load(); void clean(); };</span></span></code> </pre></div></div><br><br>  Now you can show the implementation of the loadAudio method, which was in the first part of the article. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">JNIEXPORT </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> JNICALL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_ru_suvitruf_androidndk_tutorial4_MainActivity_loadAudio</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv *pEnv, jobject pThis, jobject pNativeCallListener, jobject assetManager)</span></span></span><span class="hljs-function"> </span></span>{ listener = NativeCallListener(pEnv, pNativeCallListener); mgr = AAssetManager_fromJava(pEnv, assetManager); listener.loadAudio(); }</code> </pre><br><br>  In the class constructor, we save the class descriptor and get a reference to its method: <br><pre> <code class="cpp hljs">NativeCallListener::NativeCallListener(JNIEnv* pJniEnv, jobject pWrappedInstance) { pJniEnv-&gt;GetJavaVM(&amp;mJVM); mObjectRef = pJniEnv-&gt;NewGlobalRef(pWrappedInstance); jclass cl = pJniEnv-&gt;GetObjectClass(pWrappedInstance); <span class="hljs-comment"><span class="hljs-comment">// ,       Java sendLogID = pJniEnv-&gt;GetMethodID(cl, "sendLog", "(Ljava/lang/String;)V"); }</span></span></code> </pre><br><br>  Now we can call the Java method by writing: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> NativeCallListener::sendLog(jobject <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>) { JNIEnv* jniEnv = getJniEnv(); jniEnv-&gt;CallIntMethod(mObjectRef, sendLogID, <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>); }</code> </pre><br><br><h4>  AAssetManager </h4><br>  Previously used open source library libzip to work with application resources. <br>  With the 2.3 version of the API in Android ndk, a wonderful class appeared for working with the assets directory directly from C ++ code. <br>  The methods are similar to the methods for working with files from stdio.h.  AAssetManager_open instead of fopen, AAsset_read instead of fread, AAsset_close instead of fclose. <br><br>  I wrote for him a small wrapper.  I will not insert the code here, since in general the work is the same as with FILE normal. <br><br><h4>  Work with OpenAL </h4><br>  The article is already quite a big one, but has not started the most interesting.  Please forgive me for this ... <br><br><h5>  Training </h5><br>  First you need to collect OpenAL.  This is enough to work with WAV, but we also want to work with OGG.  OGG needs a <a href="http://svn.xiph.org/trunk/Tremor/">Tremor</a> decoder. <br><br>  For sound, I wrote wrappers with the necessary methods.  It makes no sense to bring all the code here, I will cover the most interesting, namely the download. <br><br><h5>  Read wav file </h5><br>  First, it is necessary to describe the structure for headers: <br><div class="spoiler">  <b class="spoiler_title">BasicWAVEHeader</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> riff[<span class="hljs-number"><span class="hljs-number">4</span></span>];<span class="hljs-comment"><span class="hljs-comment">//'RIFF' unsigned int riffSize; char wave[4];//'WAVE' char fmt[4];//'fmt ' unsigned int fmtSize; unsigned short format; unsigned short channels; unsigned int samplesPerSec; unsigned int bytesPerSec; unsigned short blockAlign; unsigned short bitsPerSample; char data[4];//'data' unsigned int dataSize; }BasicWAVEHeader;</span></span></code> </pre><br></div></div><br><br>  Now we read: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> OALWav::load(AAssetManager *mgr, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* filename){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;filename = filename; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;data = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  this-&gt;data = this-&gt;readWAVFull(mgr, &amp;header); //  getFormat(); // OpenAL  createBufferFromWave(data); source = 0; alGenSources(1, &amp;source); alSourcei(source, AL_BUFFER, buffer); }</span></span></code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">readWAVFull</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* OALWav::readWAVFull(AAssetManager *mgr, BasicWAVEHeader* header){ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* buffer = <span class="hljs-number"><span class="hljs-number">0</span></span>; AAssetFile f = AAssetFile(mgr, filename); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (f.null()) { LOGE(<span class="hljs-string"><span class="hljs-string">"no file %s in readWAV"</span></span>,filename); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> res = f.read(header,<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(BasicWAVEHeader),<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(res){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!( <span class="hljs-comment"><span class="hljs-comment">//    . //   ,    . //          =/ memcmp("RIFF",header-&gt;riff,4) || memcmp("WAVE",header-&gt;wave,4) || memcmp("fmt ",header-&gt;fmt,4) || memcmp("data",header-&gt;data,4) )){ buffer = (char*)malloc(header-&gt;dataSize); if (buffer){ if(f.read(buffer,header-&gt;dataSize,1)){ f.close(); return buffer; } free(buffer); } } } f.close(); return 0; }</span></span></code> </pre><br></div></div><br>  It is worth saying something about WAV.  At times, the file on the PC seems to be heard perfectly, but errors occur when working with OpenAL.  This is due to the fact that broken headers.  I met many converters that wrote some kind of nonsense to the headers (my logo as an example), usually in <b>dataSize</b> .  So why does not work, but on the PC plays? <br>  The <b>actual</b> audio data itself is stored after the header and their size in <b>dataSize</b> .  If there is something wrong with this field, there will be errors.  You can really count the size in the forehead.  <b>Data Size = File Size - Header Size</b> .  So, I think the players take the size of the data by subtracting, not from the header. <br><br>  It seems to be easy to work with WAV, since the format is not compressed.  When working with <b>.Ogg</b> everything is more complicated. <br><br><h5>  Read the Ogg file </h5><br>  What is special about <b>Ogg</b> compared to <b>WAV</b> ?  This is a compressed format.  So, before there how to write data to the OpenAL buffer, we need to decode the data. <br>  The catch is that by default Vorbis streams out of FILE, so we need to override all the callback methods for working with data: <br><br><div class="spoiler">  <b class="spoiler_title">callbacks</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> size_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* ptr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nmemb, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* datasource)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> uiBytes = Min(suiSize - suiCurrPos, (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)nmemb * (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)size); <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(ptr, (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*)datasource + suiCurrPos, uiBytes); suiCurrPos += uiBytes; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> uiBytes; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">seek_func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* datasource, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ogg_int64_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> offset, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> whence)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (whence == SEEK_SET) suiCurrPos = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)offset; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (whence == SEEK_CUR) suiCurrPos = suiCurrPos + (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)offset; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (whence == SEEK_END) suiCurrPos = suiSize; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">close_func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* datasource)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tell_func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* datasource)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)suiCurrPos; }</code> </pre><br></div></div><br><br>  Now you need to read: <br><div class="spoiler">  <b class="spoiler_title">Reading ogg</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> OALOgg::getInfo(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> uiOggSize, <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* pvOggBuffer){ <span class="hljs-comment"><span class="hljs-comment">//   ov_callbacks callbacks; callbacks.read_func = &amp;read_func; callbacks.seek_func = &amp;seek_func; callbacks.close_func = &amp;close_func; callbacks.tell_func = &amp;tell_func; suiCurrPos = 0; suiSize = uiOggSize; int iRet = ov_open_callbacks(pvOggBuffer, &amp;vf, NULL, 0, callbacks); //  vi = ov_info(&amp;vf, -1); uiPCMSamples = (unsigned int)ov_pcm_total(&amp;vf, -1); } void * OALOgg::ConvertOggToPCM(unsigned int uiOggSize, char* pvOggBuffer) { if(suiSize == 0){ getInfo( uiOggSize, pvOggBuffer); current_section = 0; iRead = 0; uiCurrPos = 0; } void* pvPCMBuffer = malloc(uiPCMSamples * vi-&gt;channels * sizeof(short)); //  do { iRead = ov_read(&amp;vf, (char*)pvPCMBuffer + uiCurrPos, 4096, ¬§t_section); uiCurrPos += (unsigned int)iRead; } while (iRead != 0); return pvPCMBuffer; } void OALOgg::load(AAssetManager *mgr, const char* filename){ this-&gt;filename = filename; char* buf = 0; AAssetFile f = AAssetFile(mgr, filename); if (f.null()) { LOGE("no file %s in readOgg",filename); return ; } buf = 0; buf = (char*)malloc(f.size()); if (buf){ if(f.read(buf,f.size(),1)){ } else { free(buf); f.close(); return; } } char * data = (char *)ConvertOggToPCM(f.size(),buf); f.close(); if (vi-&gt;channels == 1) format = AL_FORMAT_MONO16; else format = AL_FORMAT_STEREO16; alGenBuffers(1,&amp;buffer); alBufferData(buffer,format,data,uiPCMSamples * vi-&gt;channels * sizeof(short),vi-&gt;rate); source = 0; alGenSources(1, &amp;source); alSourcei(source, AL_BUFFER, buffer); }</span></span></code> </pre><br></div></div><br><br>  When loading an application, we call the C ++ method loadAudio, which calls load on NativeCallListener, which loads the title and: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> NativeCallListener:: load(){ oalContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OALContext(); <span class="hljs-comment"><span class="hljs-comment">//sound = new OALOgg(); sound = new OALWav(); char * fileName = new char[64]; strcpy(fileName, "audio/industrial_suspense1.wav"); //strcpy(fileName, "audio/Katatonia - Deadhouse_(piano version).ogg"); sound-&gt;load(mgr,fileName); }</span></span></code> </pre><br>  I have a <code>sound</code> like <code>OALSound</code> .  To work with WAV and Ogg, I have classes that inherit from it.  All we need for them is to write a load implementation by overriding the base class method <code>virtual void load(AAssetManager *mgr, const char* filename)= 0;</code> <br>  This allows you to unify the work with sounds. <br><br><h4>  Conclusion </h4><br>  Once again, I apologize that the article was quite voluminous, otherwise I can‚Äôt imagine how to write.  Using the presented implementation, you can work with sound regardless of the platform.  Let's say if you are writing a game engine for iOS and Android. <br><br>  There is a nuance here - the audio is loaded entirely.  Therefore, this solution is excellent for sounds, but not for music.  Imagine how much memory an unpacked .ogg song will consume.  Therefore, it will be great if someone based on this decision writes audio playback with streaming, rather than full loading into the buffer. <br><br><h6>  Sources </h6><br>  The project is written in Eclipse.  Sources can be viewed on <a href="https://github.com/Suvitruf/Android-ndk/tree/master/AndroidNDK-Tutorial4">github</a> . <br><br>  PS waiting for critics and advice <br>  PPS If you find grammatical errors in the text, then it is better to write in PM. </div><p>Source: <a href="https://habr.com/ru/post/176559/">https://habr.com/ru/post/176559/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../176547/index.html">"Russian Public Initiative" under the onslaught of Habr and LJ. [UPD]</a></li>
<li><a href="../176549/index.html">Recommender systems: You can (not) advise</a></li>
<li><a href="../176551/index.html">Right now there is a lecture ‚ÄúPractical Font Course‚Äù</a></li>
<li><a href="../176555/index.html">Samsung Galaxy S4 review and comparison with S3</a></li>
<li><a href="../176557/index.html">DARPA created a chip for navigation without GPS</a></li>
<li><a href="../176561/index.html">Mobilefest 2013 - Short Report</a></li>
<li><a href="../176567/index.html">Cube U30GT2 - Budget Quad-Core Tablet</a></li>
<li><a href="../176569/index.html">65 statistics from the world of mobile games to impress friends</a></li>
<li><a href="../176571/index.html">The three most hated things in computers</a></li>
<li><a href="../176573/index.html">Premiere of the domestic fan-movie on the game "Half-life 2"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>