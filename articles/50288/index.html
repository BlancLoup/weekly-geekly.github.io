<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write the Referrer tracker: small and remote, with MySQL stored procedures</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Often there is a desire to see people come to your site to go there to read what they write about us, and zealously enter into polemics without depart...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write the Referrer tracker: small and remote, with MySQL stored procedures</h1><div class="post__text post__text-html js-mediator-article">  Often there is a desire to see people come to your site to go there to read what they write about us, and zealously enter into polemics without departing from the ticket office.  It would seem that such a popular thing as Google Analitycs should do it, but there is one problem - GET-parameters are cut off in the report, and if you see that the link is from a huge forum, then you still have to find the right topic, which takes time (it‚Äôs worth mentioning that Google Analitycs requires additional JS code on the pages, which also takes time and traffic). <br><a name="habracut"></a><br>  We have 3 options: <br><ol><li>  Other JS-based systems, analogs of Google Analitycs, decided not to touch, because  The idea of ‚Äã‚Äãadditionally weighing up JS clients does not like </li><li>  AwStats and other log analysis tools are a bulletproof solution (and probably the best) if you have full access to the server.  Does not require code modification at all.  It is a pity that I have shared-hosting, and there is no direct access to the logs. </li><li>  Any means requiring php-instrumentation (since the code is called on each page). </li></ol><br>  Having rummaged in the internet, I found some quite good variants of the latter type (PHP), some were not so good in terms of functionality (in particular, it didn‚Äôt show referrer badly), eventually settled on <a href="http://www.tracewatch.com/">TraceWatch</a> , as it turned out to be Iranian-made.  :-) Having started the installation, I was shocked - all the code was processed by the obfuscator, and the author in the license prohibits him from bringing to normal form.  This, along with free of charge, immediately caused a great suspicion.  After this crap failed to make money not in the default directory (the path to the inclusions was prescribed absolute and not relative), and attempts to fix it to the code, I realized that I would not wait for anything good from this craft. <br><br><h1>  Then I decided to write my Referrer tracker </h1><br>  The task was as follows: show referrals broken down by day.  You need to count how many times you came from (with GET parameters), filter Google, nothing else is needed.  No IP log, countries, counting visits, etc.  (although it's easy enough to implement) <br><br><h1>  MySQL 5 database </h1><br><blockquote><code><font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> ` <font color="#0000ff">ref</font> ` ( <br> `id` <font color="#0000ff">int</font> (11) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> auto_increment, <br> `ref_url` <font color="#0000ff">varchar</font> (950) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , <br> `ref_date` <font color="#0000ff">date</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , <br> `ref_count` <font color="#0000ff">int</font> (11) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">default</font> <font color="#A31515">'0'</font> , <br> <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> (`id`), <br> <font color="#0000ff">UNIQUE</font> <font color="#0000ff">KEY</font> `url` (`ref_url`,`ref_date`), <br> <font color="#0000ff">KEY</font> `ref_date` (`ref_date`) <br> ) ENGINE=MyISAM <font color="#0000ff">DEFAULT</font> CHARSET=cp1251 AUTO_INCREMENT=138 ; <br></font> <br></code> </blockquote>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And here - the holy grail of MySQL 5 - stored procedures with error checking - guaranteed a maximum of 1 query to the database for 1 user.  In this case, sometimes all the same it is possible (albeit with a very small probability) an error per unit when creating a record (since stored procedures are not atomic), but I thought that the risk / loss of speed from locking / unlocking the table is not worth this lost item . <br><br><blockquote> <code><font color="black">DELIMITER $$ <br> <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `process_url`(new_url <font color="#0000ff">VARCHAR</font> (900)) <br> <font color="#0000ff">BEGIN</font> <br> <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">SQLEXCEPTION</font> <font color="#0000ff">UPDATE</font> <font color="#0000ff">ref</font> <font color="#0000ff">SET</font> ref_count=ref_count+1 <font color="#0000ff">WHERE</font> ref_date=CURDATE() <font color="#0000ff">AND</font> ref_url=new_url; <br> <font color="#0000ff">INSERT</font> <font color="#0000ff">INTO</font> <font color="#0000ff">ref</font> (ref_url,ref_date,ref_count) <font color="#0000ff">VALUES</font> (new_url,CURDATE(),1); <br> <font color="#0000ff">END</font> $$</font></code> </blockquote> <br><br>  <b>NB</b> : INSERT INTO ref SET ref_url = '$ ref', ref_date = NOW () ON DUPLICATE KEY UPDATE ref_count = ref_count + 1 - thanks to the Habroyuser Nc_soft, we know that this code is simpler and faster 2-4 times: - ) <br><br><h1>  We collect statistics </h1><br>  This should be inserted somewhere in the general file that is included everywhere.  It is understood that the connection to the database has already been established, and the database is selected: <br><blockquote> <code><font color="black">function process_referrer() <br> { <br> $referrer = $_SERVER[ <font color="#A31515">"HTTP_REFERER"</font> ]; <br> <font color="#0000ff">if</font> (strpos($referrer, <font color="#A31515">"your_site_name_here"</font> )===FALSE &amp;&amp; strlen($referrer)&gt;0) <br> { <br> <font color="#008000">//google support, remove redundant parameters &amp; multiple records for the same query from different countries like google.nl</font> <br> <font color="#0000ff">if</font> (strpos($referrer, <font color="#A31515">"www.google"</font> )!==FALSE) <br> { <br> <font color="#0000ff">if</font> (preg_match( <font color="#A31515">"/[?&amp;]q=([^&amp;]+)/"</font> , $referrer, $matches)) { <br> $referrer = <font color="#A31515">"Google Search: "</font> .htmlspecialchars(urldecode($matches[1])); <br> } <font color="#0000ff">else</font> <br> $referrer = <font color="#A31515">"Google Search: broken query, $referrer"</font> ; <br> } <br> <font color="#008000">//and finally, store it :crazy:</font> <br> sqlexec( <font color="#A31515">'CALL process_url("'</font> .mysql_real_escape_string($referrer). <font color="#A31515">'");'</font> ); <br> } <br> } <br></font></code> </blockquote><br><br>  What we see here is not pulling the database if the user walks through our pages, or if he has typed the address with his hands (or a cunning firewall has cut it).  Do not forget that the evil hacker could give us SQL Injection in the referrer, so mysql_real_escape_string is required, as always. <br><br>  The main thing remains :-) <br><br><h1>  See the results </h1><br><blockquote> <code><font color="black">$max_date = sqlcount( <font color="#A31515">"select MIN(ref_date) from (select DISTINCT ref_date from ref ORDER by ref_date DESC LIMIT 7) as tmp"</font> ); <br> $result = sqlexec( <font color="#A31515">"select * from ref WHERE ref_date&gt;='$max_date' order by ref_date DESC,ref_count DESC"</font> ); <br> $prev_date = <font color="#A31515">""</font> ; <br> <font color="#0000ff">while</font> ($row = mysql_fetch_array($result)) <br> { <br> <font color="#0000ff">if</font> ($row[ <font color="#A31515">'ref_date'</font> ]!=$prev_date) <br> { <br> $articlesList .= <font color="#A31515">"&lt;h1&gt;{$row['ref_date']}&lt;/h1&gt;"</font> ; <br> $prev_date = $row[ <font color="#A31515">'ref_date'</font> ]; <br> } <br> <font color="#008000">//Print $row data here with nice design</font> <br> }</font></code> </blockquote> <br><br>  At the beginning, the last 7 dates in the database are determined (although it is possible to subtract 7 from the current date).  Then we get all the records for the last 7 days and display them by day.  Links can be immediately with target = "_ blank" <br><br><h1>  Auxiliary procedures </h1><br><blockquote> <code><font color="black">function sqlexec($sql) <br> { <br> <font color="#0000ff">if</font> (!($result = mysql_query($sql))) showerror(); <br> <font color="#0000ff">return</font> ($result); <br> } <br> function sqlcount($sql) <br> { <br> $res = mysql_fetch_array(sqlexec($sql)); <br> <font color="#0000ff">return</font> ($res[0]); <br> } <br></font></code> </blockquote><br><h1>  Result </h1><br>  You can click on the links and immediately read what they write about you :-) <br><img src="https://habrastorage.org/getpro/habr/post_images/c9e/672/ac0/c9e672ac06d9024ed0a8a493121aad60.jpg"><br><br>  The original is here: <a href="http://3.14.by/ru/read/writing-php-referrer-tracker">http://3.14.by/ru/read/writing-php-referrer-tracker</a> </div><p>Source: <a href="https://habr.com/ru/post/50288/">https://habr.com/ru/post/50288/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../50280/index.html">We are fighting with Radarix.com. Part one.</a></li>
<li><a href="../50281/index.html">Editor for habr</a></li>
<li><a href="../50282/index.html">Silverlight training in Moscow</a></li>
<li><a href="../50286/index.html">Twitter received funding for a $ 250 million valuation project.</a></li>
<li><a href="../50287/index.html">Youtube in Google Chrome</a></li>
<li><a href="../50289/index.html">The programmers would go, let them teach me</a></li>
<li><a href="../50290/index.html">The best movie and cybersquatters</a></li>
<li><a href="../50293/index.html">The idea for the competition. Criticize.</a></li>
<li><a href="../50294/index.html">Startup - or birth, or reality.</a></li>
<li><a href="../50298/index.html">Socio-creative photo project</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>