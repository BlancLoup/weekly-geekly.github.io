<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automated refactoring in a big project</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you work in a large development team on the same project, then refactoring becomes a very difficult task. Here is an example: we want to rename the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automated refactoring in a big project</h1><div class="post__text post__text-html js-mediator-article"> <a href=""><img src="https://habrastorage.org/storage2/99c/761/12a/99c76112a20a171c7389f6ed747b9cbd.jpg" align="left"></a>  If you work in a large development team on the same project, then refactoring becomes a very difficult task.  Here is an example: we want to rename the do_something () function to do_something_with_blackjack ().  We renamed all occurrences of this function in our branch and sent the task for testing.  At the same time, someone else added another function call, but with the old name, also in its branch.  Individually, the changesets will work, but after the merge, you get an error. <br><br>  The article will consider a technique that can be called "automated refactoring" - the use of samopisny scripts that do the necessary work for you, allowing you to refactor after merging all the branches and before directly laying on staging / production. <br><br>  Using the example of phpBB, it will be shown how to ‚Äúrefactor‚Äù calls to SQL queries so that they use automatic screening of the input data (and thus help solve the problem of SQL injections). <br><a name="habracut"></a><br><h3>  Description of the approach </h3><br>  Let's start with the theory: we will describe the problem and the proposed ways to solve it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Automatic merge change issues </h3><br>  Suppose we are refactoring the code and want to rename the function (in the examples - the code in PHP).  Suppose we changed the code as follows (the first ‚Äú-‚Äù character means deleting a line, and ‚Äú+‚Äù means adding a line): <br><br><pre><code class="diff hljs">&lt;?php -function do_something() +function print_hello() { echo "Hello world!\n"; } $a = 1; -do_something(); +print_hello(); $b = 2; $c = 3;</code> </pre> <br>  While we were doing this, our colleague managed to add the use of the old function name in another branch: <br><br><pre> <code class="diff hljs"> &lt;?php function do_something() { echo "Hello world!\n"; } $a = 1; do_something(); $b = 2; +do_something(); $c = 3;</code> </pre><br>  Since the changes are consistent (we worked with different lines of code), after the automatic merging of our branches with the changes, we get the following code: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print_hello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Hello world!\n"</span></span>; } $a = <span class="hljs-number"><span class="hljs-number">1</span></span>; print_hello(); $b = <span class="hljs-number"><span class="hljs-number">2</span></span>; do_something(); $c = <span class="hljs-number"><span class="hljs-number">3</span></span>;</code> </pre><br>  Thus, in the final version there will be a call to a non-existent function (do_something).  Such code obviously will not work.  Some cite the possibility of such behavior as an argument against the use of ‚Äúfeature branches‚Äù, when one branch is used for one task.  You can offer various solutions to this problem, but one thing is clear: it is not easily solved, and you have to pay a lot for the possibility of refactoring in an actively developing project. <br><br><h3>  Automated refactoring </h3><br>  The essence of the approach is that we have to postpone the implementation of most of the changes in the code in such a way that the replacements are performed after the merging of all branches.  That is, you first need to apply the changes made by your colleagues, and only then proceed to your work and perform a renaming after all other changes.  You also need to introduce a mechanism that would prohibit the use of the code in the old style. <br><br>  Therefore, to perform refactoring you need to write the following scripts: <br><br><ul><li>  check on the use of old code; </li><li>  performing an automatic replacement; </li><li>  collecting statistics on the use of old and new code (optional). </li></ul><br>  More about each of them. <br><br><h3>  Check for old code </h3><br>  To prevent the use of the old-style code during the refactoring process and after its completion, you need to write a script that would allow you to unequivocally and reliably establish that the code is no longer used.  For our simple example, the script will look something like this: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh grep do_something file.php</span></span></code> </pre><br>  The script returns lines in the file that contain the old function name - do_something. <br><br><h3>  Perform Auto Replace </h3><br>  For our simple example, it will be enough to use sed to replace all the do_something entries with print_hello.  In more complex cases, this will not be enough and more careful handling will be needed (for example, if the substring do_something may be present in the project and not a function call). <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh sed -i 's/do_something/print_hello/g' file.php</span></span></code> </pre><br><h3>  Collect statistics using the old and new code </h3><br>  Our replacement script, although it should replace all the do_something occurrences with print_hello, but it cannot do anything, for example, with this code: <br><br><pre> <code class="php hljs">$func_prefix = <span class="hljs-string"><span class="hljs-string">"do_"</span></span>; $func_name = $func_prefix . <span class="hljs-string"><span class="hljs-string">"something"</span></span>; <span class="hljs-comment"><span class="hljs-comment">// , PHP      ,    $func_name();</span></span></code> </pre><br>  This problem exists even in statically typed languages, such as C and Java.  In C, you can always write #define and make macros, and in Java there is a Reflection mechanism.  To do this, we introduce a new version of the do_something function (you need to ensure that this function is not automatically replaced by the script above): <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">do_something</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ error_log(<span class="hljs-keyword"><span class="hljs-keyword">__FUNCTION__</span></span> . <span class="hljs-string"><span class="hljs-string">" found. Trace: "</span></span> . (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>())); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> print_hello(); }</code> </pre><br>  As a result, after executing unit tests or after laying out this code in production (if you do not have 100% coverage), you can find missing references to the old function.  These fragments can be analyzed and handled accordingly. <br><br><h3>  Stages of application of written scripts </h3><br>  After the corresponding scripts are written, you need to apply them correctly.  It is proposed to do this as follows: <br><br><ol><li>  merge all the latest developer changes; </li><li>  run a script for automatic replacement and commit changes to the version control system; </li><li>  check that there are no more references to the old code; </li><li>  add logging using old code; </li><li>  run the unit tests, put the code on production; </li><li>  Immediately after the code hits the main development branch, you need to configure the "hooks" of your version control system so that it no longer misses the use of old code; </li><li>  add a check for the use of old code in scripts that run before the production code hits; </li><li>  (optional) collect from the production logs using the old code and fix the corresponding places manually. </li><li>  You have successfully refactored! </li></ol><br>  The presence of item 7 is important because the repository may contain old code in other branches that have not yet been merged with the main branch of development.  The merging of such branches can take place without conflicts, but they may contain references to the old code. <br><br>  An important point in the described method is the possibility of applying changes at one time, using scripts and a small amount of manual work.  It is also possible to do a lot of refactoring completely manually, but this is a very difficult path to follow only if you have no other options. <br><br><h3>  Refactoring the use of SQL in phpBB </h3><br>  To illustrate the approach in more realistic examples, we would like to show how to refactor the phpBB code in order to save it from SQL injection as much as possible: <br><br><h3>  Work with SQL in phpBB </h3><br>  Let's see how the work with SQL in phpBB is arranged and why the mechanism used is imperfect. <br><br>  First, the implementation of the database classes themselves is in includes / db, and the global variable $ db is created in common.php, which contains an instance of the corresponding class for working with the database. <br><br><pre> <code class="bash hljs">$ ls includes/db db_tools.php index.htm mssqlnative.php oracle.php dbal.php mssql.php mysql.php postgres.php firebird.php mssql_odbc.php mysqli.php sqlite.php</code> </pre><br>  Thus, the ‚Äúincludes / db‚Äù directory should be excluded from our scripts during the automatic replacement - we will perform the corresponding replacements manually. <br><br>  To assess the scale of the problem, let's use a wonderful tool called grep: <br><pre> <code class="bash hljs">$ grep -RF <span class="hljs-string"><span class="hljs-string">'sql_query('</span></span> * | wc -l 1611</code> </pre><br>  That is about 1,600 calls to sql_query ().  We believe it becomes clear that manually replacing such a number of places is not a good idea.  Probably so many places is one of the reasons why phpBB developers haven‚Äôt done anything with these calls so far. <br><br>  Let's now still see what's wrong with them? <br><br>  Here is the definition of sql_query: <br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sql_query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($query = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">, $cache_ttl = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> ‚Ä¶</span></span></code> </pre> <br>  From here we can easily see that only the request itself receives the method, and the caller must do the escaping of the values ‚Äã‚Äãon its own. <br><br>  Example from viewtopic.php: <br><br><pre> <code class="php hljs">$sql = <span class="hljs-string"><span class="hljs-string">'SELECT forum_id FROM '</span></span> . TOPICS_TABLE . <span class="hljs-string"><span class="hljs-string">" WHERE topic_id = $topic_id"</span></span>; $result = $db-&gt;sql_query($sql);</code> </pre> <br>  Since $ topic_id comes from the outside and may not be processed properly, it is possible to get both a SQL error and a real SQL injection.  Using UNION can even allow us to pull data from another table, so you should avoid writing such code with all your might. <br><br>  Instead, we could write something like the following: <br><br><pre> <code class="php hljs">$sql = <span class="hljs-string"><span class="hljs-string">'SELECT forum_id FROM '</span></span> . TOPICS_TABLE . <span class="hljs-string"><span class="hljs-string">' WHERE topic_id = ?d'</span></span>; $result = $db-&gt;sql_query_escaped($sql, $topic_id);</code> </pre> <br>  That is, instead of ‚Äú$ topic_id‚Äù write ‚Äú? D‚Äù, which will be interpreted by the sql_query_escaped method and will always be explicitly treated as a number. <br><br><h3>  SQL queries with automatic screening of values </h3><br>  It is proposed for example to make the simplest wrapper of the following type and put it in dbal.php: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Execute escaped SQL query * * First parameter, $query_template is the SQL template that has the following placeholders: * * ?d - value is integer * ?s - value is string (escaped by default) * ?a - array of integers for usage like IN(?a) * ?r - raw SQL (eg for use in dynamic part of SQL expression) * * Example: * * sql_query_escaped("SELECT * FROM table WHERE table_id = ?d", 42) will be executed as * * SELECT * FROM table WHERE table_id = 42 * * sql_query_escaped("SELECT * FROM table WHERE table_id IN(?a)", array(1, 2, 3)) will be executed as * * SELECT * FROM table WHERE table_id IN(1, 2, 3) * */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sql_query_escaped</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($query_template)</span></span></span><span class="hljs-function"> </span></span>{ $values = func_get_args(); array_shift($values); $regexp = <span class="hljs-string"><span class="hljs-string">'/\\?[dsar]/s'</span></span>; preg_match_all($regexp, $query_template, $matches); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($matches[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $i =&gt; $m) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($m == <span class="hljs-string"><span class="hljs-string">'?d'</span></span>) $values[$i] = intval($values[$i]); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($m == <span class="hljs-string"><span class="hljs-string">'?s'</span></span>) $values[$i] = <span class="hljs-string"><span class="hljs-string">"'"</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sql_escape($values[$i]) . <span class="hljs-string"><span class="hljs-string">"'"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($m == <span class="hljs-string"><span class="hljs-string">'?a'</span></span>) $values[$i] = implode(<span class="hljs-string"><span class="hljs-string">','</span></span>, array_map(<span class="hljs-string"><span class="hljs-string">'intval'</span></span>, $values[$i])); } $idx = <span class="hljs-number"><span class="hljs-number">0</span></span>; $replace_func = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($placeholder)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($values, &amp;$idx)</span></span></span><span class="hljs-function"> </span></span>{ $placeholder = $placeholder[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $values[$idx++]; }; $query = preg_replace_callback($regexp, $replace_func, $query_template); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sql_query($query); }</code> </pre><br>  The implementation and the way to solve the problem are not so fundamental for us, because this is just an example.  If you really want to do something like this, you can come up with a better solution or use standard solutions, such as PDO. <br><br><h3>  Debugging SQL Queries </h3><br>  In phpBB, for some reason, there is no easy way to output SQL queries on the current page, so we will add a small temporary patch: <br><br><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/includes/db/mysqli.php +++ b/includes/db/mysqli.php @@ -151,6 +151,8 @@ class dbal_mysqli extends dbal return true; } + var $queries = array(); + /** * Base query method * @@ -162,6 +164,7 @@ class dbal_mysqli extends dbal */ function sql_query($query = '', $cache_ttl = 0) { + $this-&gt;queries[] = $query; if ($query != '') { global $cache; --- a/includes/functions.php +++ b/includes/functions.php @@ -4735,6 +4735,10 @@ function page_footer($run_cron = true) } $debug_output .= ' | &lt;a href="' . build_url() . '&amp;explain=1"&gt;Explain&lt;/a&gt;'; + + foreach ($db-&gt;queries as $query) { + $debug_output .= "&lt;pre style='text-align: left; margin-bottom: 10px;'&gt;" . htmlspecialchars($query) . "&lt;/pre&gt;\n&lt;hr/&gt;\n"; + } } }</span></span></code> </pre><br><br><h3>  Analysis of the use of sql_query () </h3><br>  One of the most important moments while writing scripts for automatic refactoring is the so-called ‚Äúgaze method‚Äù.  We need to look at how the method we are going to change is used, and find the main patterns of its use by scrutinizing the code. <br><br>  So, once again we will use grep, but this time we will look through the eyes of the mention of sql_query () and try to formulate the main patterns found: <br><pre> <code class="bash hljs">$ grep -RF <span class="hljs-string"><span class="hljs-string">'sql_query('</span></span> * | less</code> </pre> <br>  Basic patterns: <br><br><ol><li>  $ result = $ db-&gt; sql_query ($ sql);  // $ sql variable contains the query text; </li><li>  $ db-&gt; sql_query ("DELETE | UPDATE | SELECT ...");  // request is specified explicitly. </li></ol><br>  You may also notice that the same name is always used for the database object ‚Äú$ db‚Äù.  However, you need to make sure that the database object is not used under a different name and there is no sql_query method in other classes: <br><pre> <code class="bash hljs">$ grep -RF <span class="hljs-string"><span class="hljs-string">'sql_query('</span></span> * | grep -vF <span class="hljs-string"><span class="hljs-string">'$db-&gt;sql_query('</span></span></code> </pre> <br>  Having executed this code, we will see that there are still mentions.  They can be divided into several categories: <br><br><ul><li>  docs / *. html - skip, because this is the documentation; </li><li>  includes / db / db_tools.php - the class contains the sql_table_exists, sql_alter_table, and other DDL methods; </li><li>  includes / db / dbal.php: used in the sql_query_limit method, as well as in insert methods, which themselves escape values; </li><li>  includes / db / (mysql | mssql, firebird | ...). php - mysql_query calls, mssql_query, etc .; </li><li>  includes / functions_convert.php - functions for converting the database (from one version of phpBB to another); </li><li>  install / convertors / convert _ *. php - scripts for database conversion; </li><li>  install / install_convert.php is also a script for converting the database. </li></ul><br>  From all this we really should pay attention to the calls to sql_query () in the heirs of dbal, as well as in the dbal itself.  Thus, from our additional analysis, it became clear that we also need to refactor all the sql_query_limit calls. <br><br>  Theoretically, the scripts for database conversion may also contain SQL injections.  However, these scripts make up a small part of all SQL queries and most likely do not contain SQL injections because of their specificity.  Therefore, these places we miss. <br><br><h3>  Pattern analysis $ db-&gt; sql_query ('SELECT / UPDATE / DELETE ...') </h3><br>  Let's now write a script that will find us all the references to sql_query, when the SQL query is written directly.  There are not too many such places compared to sql_query ($ sql), but first we will choose a simpler task. <br><br>  The algorithm is as follows: we divide the contents of the files into tokens and find the sequence ‚Äú$ db‚Äù, ‚Äú-&gt;‚Äù, and ‚Äúsql_query‚Äù there.  After that, the expression in brackets will be the same request.  The code will be written in PHP 5.3 using the tokenizer extension. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//        ,    : $files = exec('grep -RF \'$db-&gt;sql_query(\' * | awk -F: \'{print $1;}\'', $out, $retval); if ($retval) exit(1); //       replacer/ $excludes = array('includes/db/', 'replacer/'); $num_lines = 0; foreach (array_unique($out) as $filename) { foreach ($excludes as $excl) { if (strpos($filename, $excl) === 0) continue(2); } $contents = file_get_contents($filename); if ($contents === false) exit(1); $lines = explode("\n", $contents); //       $tokens = token_get_all($contents); $num = count($tokens); $line = 1; $type = $text = ''; //    5   : '$db', '-&gt;', 'sql_query', '('    //         ¬´¬ª $accepted_value_types = array(T_CONSTANT_ENCAPSED_STRING, T_ENCAPSED_AND_WHITESPACE, '"'); foreach ($tokens as $cur_idx =&gt; $tok) { parse_token($tok, $type, $text, $line); //     ,       5  if ($cur_idx &gt;= $num - 5) continue; $ln = $line; $i = $cur_idx + 1; //      (http://php.net/manual/tokens.php) if ($type !== T_VARIABLE || $text !== '$db') continue; parse_token($tokens[$i++], $type, $text, $ln); if ($type !== T_OBJECT_OPERATOR || $text !== '-&gt;') continue; parse_token($tokens[$i++], $type, $text, $ln); if ($type !== T_STRING || $text !== 'sql_query') continue; parse_token($tokens[$i++], $type, $text, $ln); if ($type !== '(') continue; parse_token($tokens[$i++], $type, $text, $ln); if (!in_array($type, $accepted_value_types, true)) continue; //    :   ,      $depth = 1; $query = ''; for ($i = $i - 1; $i &lt; $num; $i++) { parse_token($tokens[$i], $type, $text, $ln); if ($type === '(') $depth++; else if ($type === ')') $depth--; if ($depth == 0) break; $query .= $text; } $query = preg_replace(array("/[\t ]+/s", '/^/m'), array(' ', ' '), $query); $results[$filename][] = $query; $num_lines++; } } foreach ($results as $filename =&gt; $list) { echo "$filename\n"; foreach ($list as $row) echo "$row\n"; echo "\n"; } echo "Total lines recognized: $num_lines\n"; // .       token_get_all function parse_token($tok, &amp;$type, &amp;$text, &amp;$line) { if (is_array($tok)) list($type, $text, $line) = $tok; else $type = $text = $tok; }</span></span></code> </pre><br>  After the launch, we will see that our script has recognized about 130 lines, which is about 8% of all the ‚Äúsql_query‚Äù text entries in the project.  You may also notice that a significant part of the found rows are strings of the form <br><br><pre> <code class="hljs php">includes/acp/acp_attachments.php <span class="hljs-string"><span class="hljs-string">'INSERT INTO '</span></span> . EXTENSIONS_TABLE . <span class="hljs-string"><span class="hljs-string">' '</span></span> . $db-&gt;sql_build_array(<span class="hljs-string"><span class="hljs-string">'INSERT'</span></span>, $sql_ary) includes/acp/acp_bbcodes.php <span class="hljs-string"><span class="hljs-string">'INSERT INTO '</span></span> . BBCODES_TABLE . $db-&gt;sql_build_array(<span class="hljs-string"><span class="hljs-string">'INSERT'</span></span>, $sql_ary)</code> </pre><br>  That is, the sql_build_array method is used to insert values ‚Äã‚Äãinto the fields, and the values ‚Äã‚Äãin this method are already escaped and nothing can be touched here. <br><br><h3>  Analysis of the $ db-&gt; sql_query Pattern ($ sql) </h3><br>  Now let's learn how to get the text of an SQL query in the case when its value is taken from the $ sql variable.  Let's look at the context of the request call and try to find a way to uniquely get the request itself: <br><pre> <code class="bash hljs">$ grep -A 5 -B 5 -RF <span class="hljs-string"><span class="hljs-string">'$db-&gt;sql_query($sql'</span></span> * | less</code> </pre> <br>  From the code you can see that most of the requests are called as follows: <br><pre> <code class="php hljs">$sql = <span class="hljs-string"><span class="hljs-string">'...'</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   $db-&gt;sql_query($sql);</span></span></code> </pre> <br>  In other words, the definition of the $ sql variable and the assignment of a value occurs immediately before the sql_query () call.  Therefore, we write the processing of just such a case as the most common and simple.  First of all, we print the query strings so that it is clear what we are dealing with: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//        ,     $files = exec('grep -RF \'$db-&gt;sql_query($sql\' * | awk -F: \'{print $1;}\'', $out, $retval); if ($retval) exit(1); //       replacer/ $excludes = array('includes/db/', 'replacer/'); $num_lines = 0; foreach (array_unique($out) as $filename) { foreach ($excludes as $excl) { if (strpos($filename, $excl) === 0) continue(2); } echo "$filename\n"; $contents = file_get_contents($filename); if ($contents === false) exit(1); $lines = explode("\n", $contents); //       $tokens = token_get_all($contents); $num = count($tokens); $line = 1; $type = $text = ''; //    5   : '$db', '-&gt;', 'sql_query', '('  '$sql' foreach ($tokens as $cur_idx =&gt; $tok) { parse_token($tok, $type, $text, $line); //     ,       5  if ($cur_idx &gt;= $num - 5) continue; $ln = $line; $i = $cur_idx + 1; //      (http://php.net/manual/tokens.php) if ($type !== T_VARIABLE || $text !== '$db') continue; parse_token($tokens[$i++], $type, $text, $ln); if ($type !== T_OBJECT_OPERATOR || $text !== '-&gt;') continue; parse_token($tokens[$i++], $type, $text, $ln); if ($type !== T_STRING || $text !== 'sql_query') continue; parse_token($tokens[$i++], $type, $text, $ln); if ($type !== '(') continue; parse_token($tokens[$i++], $type, $text, $ln); if ($type !== T_VARIABLE || $text !== '$sql') continue; //     .     grep printf("%6d %s\n", $line, ltrim($lines[$line - 1])); $positions = find_dollar_sql_assignment($tokens, $cur_idx); if (!is_array($positions)) { echo " $positions\n\n"; continue; } $query = ''; for ($i = $positions['begin']; $i &lt;= $positions['end']; $i++) { parse_token($tokens[$i], $type, $text, $ln); $query .= $text; } $query = preg_replace(array("/[\t ]+/s", '/^/m'), array(' ', ' '), $query); echo "\n" . $query . "\n\n"; $num_lines++; } echo "\n"; } echo "Total lines recognized: $num_lines\n"; // .       token_get_all function parse_token($tok, &amp;$type, &amp;$text, &amp;$line) { if (is_array($tok)) list($type, $text, $line) = $tok; else $type = $text = $tok; } //  $sql = '...';  $db-&gt;sql_query($sql function find_dollar_sql_assignment($tokens, $db_idx) { $depth = 0; $line = 1; $type = $text = ''; //        $sql for ($idx = $db_idx - 1; $idx &gt; 0; $idx--) { parse_token($tokens[$idx], $type, $text, $line); //    if ($type === ')') $depth++; else if ($type === '(') $depth--; if ($depth &lt; 0) { return "depth &lt; 0 on line " . __LINE__; } /*         ,      : if (...) { $sql = 'SELECT * FROM Table1 WHERE user_id = $user_id'; } else { $sql = 'SELECT * FROM Table2'; } $result = $db-&gt;sql_query($sql); */ if ($type === '{' || $type === '}') { return "open/close brace found on line " . __LINE__; } if ($type === T_VARIABLE &amp;&amp; $text === '$sql') { $i = $idx + 1; parse_token($tokens[$i++], $type, $text, $line); if ($type === T_WHITESPACE) parse_token($tokens[$i++], $type, $text, $line); if ($type !== '=') continue; //   "$sql = " ! $begin_pos = $i; break; } } //      ¬´$sql = ¬ª,     //  ,        ¬´;¬ª $depth = 0; for ($idx = $begin_pos; $idx &lt; $db_idx; $idx++) { parse_token($tokens[$idx], $type, $text, $line); if ($type === '(') $depth++; else if ($type === ')') $depth--; if ($depth &lt; 0) { return "depth &lt; 0 on line " . __LINE__; } if ($depth === 0 &amp;&amp; $type === ';') { return array('begin' =&gt; $begin_pos, 'end' =&gt; $idx - 1); } } //   ,       $db-&gt;sql_query  ¬´;¬ª //  ,     return "Statement does not terminate on line " . __LINE__; }</span></span></code> </pre><br>  In addition to the direct output of queries, we also display at the end the number of recognized lines (about 1150).  This represents approximately 70% of all sql_query text entries!  Let's now give examples of the output of our script: <br><br><pre> <code class="hljs php">cron.php <span class="hljs-number"><span class="hljs-number">59</span></span> $db-&gt;sql_query($sql); <span class="hljs-string"><span class="hljs-string">'UPDATE '</span></span> . CONFIG_TABLE . <span class="hljs-string"><span class="hljs-string">" SET config_value = '"</span></span> . $db-&gt;sql_escape(CRON_ID) . <span class="hljs-string"><span class="hljs-string">"' WHERE config_name = 'cron_lock' AND config_value = '"</span></span> . $db-&gt;sql_escape($config[<span class="hljs-string"><span class="hljs-string">'cron_lock'</span></span>]) . <span class="hljs-string"><span class="hljs-string">"'"</span></span> ‚Ä¶ includes/acp/acp_forums.php <span class="hljs-number"><span class="hljs-number">243</span></span> $result = $db-&gt;sql_query($sql); <span class="hljs-string"><span class="hljs-string">'SELECT * FROM '</span></span> . FORUMS_TABLE . <span class="hljs-string"><span class="hljs-string">" WHERE forum_id = $forum_id"</span></span> ... <span class="hljs-number"><span class="hljs-number">1096</span></span> $db-&gt;sql_query($sql); <span class="hljs-string"><span class="hljs-string">'DELETE FROM '</span></span> . FORUMS_TABLE . <span class="hljs-string"><span class="hljs-string">' WHERE '</span></span> . $db-&gt;sql_in_set(<span class="hljs-string"><span class="hljs-string">'forum_id'</span></span>, $forum_ids) includes/acp/acp_reasons.php ... <span class="hljs-number"><span class="hljs-number">96</span></span> $result = $db-&gt;sql_query($sql); <span class="hljs-string"><span class="hljs-string">'SELECT reason_id FROM '</span></span> . REPORTS_REASONS_TABLE . <span class="hljs-string"><span class="hljs-string">" WHERE reason_title = '"</span></span> . $db-&gt;sql_escape($reason_row[<span class="hljs-string"><span class="hljs-string">'reason_title'</span></span>]) . <span class="hljs-string"><span class="hljs-string">"'"</span></span> ... includes/acp/acp_search.php <span class="hljs-number"><span class="hljs-number">320</span></span> $result = $db-&gt;sql_query($sql); <span class="hljs-string"><span class="hljs-string">'SELECT post_id, poster_id, forum_id FROM '</span></span> . POSTS_TABLE . <span class="hljs-string"><span class="hljs-string">' WHERE post_id &gt;= '</span></span> . (int) ($post_counter + <span class="hljs-number"><span class="hljs-number">1</span></span>) . <span class="hljs-string"><span class="hljs-string">' AND post_id &lt;= '</span></span> . (int) ($post_counter + <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;batch_size)</code> </pre><br>  Pay attention to the direct use of the $ db-&gt; sql_escape and $ db-&gt; sql_in_set methods: we should handle calls of such methods separately and take into account the presence of screening in the direct code.  Also calls to intval () and type conversion to int should also be considered when rewriting this code. <br><br><h3>  Request text conversion </h3><br>  Now that we have learned how to isolate the query text, it's time to write a function with the ability to accept an array of tokens that match the query, and at the output return another array of tokens containing the query template for sql_query_escaped, as well as an array of arguments that will be passed to this method.  In other words, we want the following: <br><br><pre> <code class="php hljs">$sql = <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-string"><span class="hljs-string">'SELECT user_id, author_id FROM '</span></span> . PRIVMSGS_TO_TABLE . <span class="hljs-string"><span class="hljs-string">' WHERE msg_id = '</span></span> . $attachment[<span class="hljs-string"><span class="hljs-string">'post_msg_id'</span></span>] <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span>; $result = $db-&gt;sql_query($sql); <span class="hljs-comment"><span class="hljs-comment">//     $sql = 'SELECT user_id, author_id FROM ' . PRIVMSGS_TO_TABLE . ' WHERE msg_id = ?d'; $result = $db-&gt;sql_query_escaped($sql, $attachment['post_msg_id']);</span></span></code> </pre><br>    ¬´?d¬ª,     ,    ,     ¬´_id¬ª,     .       ,      ,        ¬´¬ª . <br><br>  ,  ,    .          ,     ,   .     '?r',      sql_query() ,    sql_query_escaped(),     . <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rewrite_tokens</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($in_tokens)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $string_types = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(T_CONSTANT_ENCAPSED_STRING, T_ENCAPSED_AND_WHITESPACE, <span class="hljs-string"><span class="hljs-string">'"'</span></span>); $type = $text = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; $line = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   ,     ,  ,  ,  : // ($action == 'add') ? 'INSERT INTO ' . EXTENSION_GROUPS_TABLE . ' ' : 'UPDATE ' . EXTENSION_GROUPS_TABLE . ' SET ' parse_token($in_tokens[0], $type, $text, $line); if ($type === T_WHITESPACE) parse_token($in_tokens[1], $type, $text, $line); if (!in_array($type, $string_types, true)) return "Expected first token to be string (got $type)"; $out_params = $out_tokens = array(); //    ,     : // // 'SELECT * FROM ' . TABLE_SOMETHING . ' WHERE lang_id = ' . intval($lang_id) // //    // // array(array('SELECT * FROM ', TABLE_SOMETHING), array(' WHERE lang_id = ', intval($lang_id))) // // ,       ,      $state = 'begin'; $left_tokens = $right_tokens = $groups = array(); $depth = 0; //   foreach ($in_tokens as $tok) { parse_token($tok, $type, $text, $line); if ($type === '(') $depth++; else if ($type === ')') $depth--; if ($depth &lt; 0) return "Brace depth less than zero"; if ($state == 'begin') { //    ¬´¬ª ,      if ($depth &gt; 0 || $type !== '.') { $left_tokens[] = $tok; } else { $state = 'end'; } } else { //   ,          $groups if ($depth &gt; 0 || $type !== '.') { $right_tokens[] = $tok; } else { $state = 'begin'; $groups[] = array($left_tokens, $right_tokens); $left_tokens = $right_tokens = array(); } } } //   -  ,     if (count($left_tokens)) $groups[] = array($left_tokens, $right_tokens); foreach ($groups as $grp) { list($left_tokens, $right_tokens) = $grp; //    ,        parse_token($left_tokens[0], $type, $text, $line); if ($type === T_WHITESPACE) parse_token($left_tokens[1], $type, $text, $line); if (!in_array($type, $string_types, true)) return "first token in a group is not string"; //   ,     foreach ($left_tokens as $tok) { parse_token($left_tokens[0], $type, $text, $line); $out_tokens[] = $tok; } if (!count($right_tokens)) break; $out_tokens[] = '.'; //   -    *_TABLE,  ,   $param = tokens_to_string($right_tokens); if (preg_match('/^\\s*([A-Z0-9_]+)_TABLE\\s*$/s', $param)) { foreach ($right_tokens as $tok) $out_tokens[] = $tok; } else { //    '?r', ¬´¬ª  $out_tokens[] = array(T_CONSTANT_ENCAPSED_STRING, "'?r'", $line); $out_params[] = $param; } $out_tokens[] = '.'; } //       , //  ,    syntax error parse_token(end($out_tokens), $type, $text, $line); if ($type === '.') array_pop($out_tokens); return array( 'tokens' =&gt; $out_tokens, 'params' =&gt; $out_params, ); } function tokens_to_string($tokens) { $str = ''; $type = $text = null; $line = 1; foreach ($tokens as $tok) { parse_token($tok, $type, $text, $line); $str .= $text; } $str = preg_replace(array("/[\t ]+/s", '/^/m'), array(' ', ' '), $str); return $str; }</span></span></code> </pre><br>       ,   (  cron.php): <br><br><pre> <code class="php hljs">$sql = <span class="hljs-string"><span class="hljs-string">'UPDATE '</span></span> . CONFIG_TABLE . <span class="hljs-string"><span class="hljs-string">" SET config_value = '"</span></span> .<span class="hljs-string"><span class="hljs-string">'?r'</span></span>. <span class="hljs-string"><span class="hljs-string">"' WHERE config_name = 'cron_lock' AND config_value = '"</span></span> .<span class="hljs-string"><span class="hljs-string">'?r'</span></span>. <span class="hljs-string"><span class="hljs-string">"'"</span></span>; $db-&gt;sql_query_escaped($sql, $db-&gt;sql_escape(CRON_ID), $db-&gt;sql_escape($config[<span class="hljs-string"><span class="hljs-string">'cron_lock'</span></span>]));</code> </pre><br>    : <br><br><pre> <code class="diff hljs"> $sql = 'UPDATE ' . CONFIG_TABLE . " - SET config_value = '" . $db-&gt;sql_escape(CRON_ID) . "' - WHERE config_name = 'cron_lock' AND config_value = '" . $db-&gt;sql_escape($config['cron_lock']) . "'"; -$db-&gt;sql_query($sql); + SET config_value = '" .'?r'. "' + WHERE config_name = 'cron_lock' AND config_value = '" .'?r'. "'"; +$db-&gt;sql_query_escaped($sql, $db-&gt;sql_escape(CRON_ID), $db-&gt;sql_escape($config['cron_lock']));</code> </pre><br>   ,      $sql: <br><br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">- $db-&gt;sql_query('UPDATE ' . CONFIG_TABLE . ' SET config_value = ' . $sql_update . " WHERE config_name = '" . $db-&gt;sql_escape($config_name) . "'"); + $db-&gt;sql_query_escaped('UPDATE ' . CONFIG_TABLE . ' SET config_value = ' .'?r'. " WHERE config_name = '" .'?r'. "'", $sql_update, $db-&gt;sql_escape($config_name));</span></span></code> </pre><br>      - '?r',    .           (  ¬´WHERE id = $forum_id¬ª).         , ¬´¬ª        .    ,           . <br><br> ,   : <br><pre> <code class="bash hljs">$ grep -RF <span class="hljs-string"><span class="hljs-string">'sql_query('</span></span> * | wc -l 335</code> </pre> <br>  ,     80%  .  20%    ,   ,     80%  ,   . <br><br><h3> ,      </h3><br>       ,      ¬´¬ª .  ,    ,    : <br><br><ul><li>    sql_query_escaped    sql_query; </li><li>         "?r"; </li><li>      ; </li><li>       ,    ¬´¬ª SQL. </li></ul><br>          "?r",    : <br><br><ul><li>   ,   SQL-,     ; </li><li>    ‚Äî   ,    ¬´?d¬ª; </li><li>      <code>"... '?r' ..."</code> ,        <code>"... ?s ..."</code> ; </li><li>        SQL,     . </li></ul><br><h3>      </h3><br> <a href="http://pastebin.com/MPv53dri">replacer/direct_sql.php</a> ‚Äî  SQL   sql_query() <br> <a href="http://pastebin.com/53G77qu5">replacer/sql_assignment.php</a> ‚Äî  sql_query($sql) <br> <a href="http://pastebin.com/QqBAFZyf">replacer/rewrite.php</a> ‚Äî    SQL  </div><p>Source: <a href="https://habr.com/ru/post/167337/">https://habr.com/ru/post/167337/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../167325/index.html">Simple tips for the beginning freelancer</a></li>
<li><a href="../167327/index.html">The establishment of standards for the transmission of telemechanical data in the power industry (IEC 101/104) - features of the development</a></li>
<li><a href="../167329/index.html">Practical recommendations for iOS developers (Part 1) - Globalization of the mobile application market</a></li>
<li><a href="../167331/index.html">Apple, China and China Mobile: Successes and Obstacles</a></li>
<li><a href="../167333/index.html">Looking to the future: CSS4</a></li>
<li><a href="../167339/index.html">IBM gel kills bacteria, even antibiotic-resistant</a></li>
<li><a href="../167341/index.html">Statistical tests in R. Part 1: Binary classification</a></li>
<li><a href="../167343/index.html">Using RichText in Android. Spannable</a></li>
<li><a href="../167347/index.html">Automated functional testing of Windows applications using Ranorex</a></li>
<li><a href="../167349/index.html">dynDNS for Amazon EC2 or how to automate IP auto-update on hosting with dynamic public IP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>