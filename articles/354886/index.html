<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ReactiveValidation: data validation in WPF</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr! 

 I would like to talk about the Open Source library for WPF - ReactiveValidation, in the process of writing which I tried to focus on F...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ReactiveValidation: data validation in WPF</h1><div class="post__text post__text-html js-mediator-article">  Hello, Habr! <br><br>  I would like to talk about the Open Source library for WPF - ReactiveValidation, in the process of writing which I tried to focus on FluentValidation and Reactive UI.  Its task is to validate the form each time the user changes the data inside it. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cy/p_/rl/cyp_rluivymo_mlzjnchrcunmbe.png"></div><br>  <font color="gray"><i>An example of working with the library.</i></font>  <font color="gray"><i>Good news - you can use your template</i></font> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The main features of the library: <br><br><ul><li>  Rules are created via the fluent interface. </li><li>  Full internal control over property changes </li><li>  Localization support (including on-the-fly) </li><li>  GUI message display </li></ul><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Reasons for creating</b> <div class="spoiler_text">  There is an application on WPF that receives data from the user and sends it to the server.  The server, in turn, calls the database stored procedures.  A complete check of the validity of the input data is implemented in the code of the stored procedure, so the user, passing incorrect parameters, is guaranteed to receive an exception with a message (it will be returned to the application and displayed).  Obviously, we can predict some of the exceptions on the client, and we must process them there.  At the beginning we used the following constructions: <br><br><pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(Property1) == <span class="hljs-literal"><span class="hljs-literal">true</span></span>) { MessageBox.Show(<span class="hljs-string"><span class="hljs-string">"  Property1"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Property2 &lt; Property3) { MessageBox.Show(<span class="hljs-string"><span class="hljs-string">"Property2     Property3"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } ... <span class="hljs-comment"><span class="hljs-comment">//   do(); }</span></span></code> </pre> <br>  The disadvantages of this option include: <br><br><ul><li>  Excess code </li><li>  User interaction only through pop-ups </li></ul><br>  The next step was the implementation of validation through annotation attributes (DataAnnotations) and the use of IDataErrorInfo.  The result is the following code: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ViewModel</span></span> : <span class="hljs-title"><span class="hljs-title">BaseViewModel</span></span> { [IsRequired] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Property1 { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> {...} <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> {...} } [CustomValidation(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ViewModel), <span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(ValidateProperty2))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? Property2 { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> {...} <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> {...} } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? Property3 { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> {...} <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> {...} } [UsedImplicitly] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ValidationResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ValidateProperty2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">? property2, ValidationContext validationContext</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> viewModel = (ViewModel)validationContext.ObjectInstance; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (viewModel.Property2 &lt; viewModel.Property3) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValidationResult(<span class="hljs-string"><span class="hljs-string">"Property2     Property3"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ValidationResult.Success; } }</code> </pre><br>  BaseViewModel implements a mechanism that, through reflection (reflection), obtains a list of properties and their validation attributes.  When a property is changed, the check of all attributes is called, and the results are written to the dictionary.  When calling the indexer <code>string this[string columnName]</code> from the IDataErrorInfo interface, these values ‚Äã‚Äãare returned (message concatenation). <br><br>  This approach greatly simplified the most frequent use cases of validation - checking the required values, comparisons with constants, and so on.  The implementation of the IDataErrorInfo interface allows displaying non-valid fields in the GUI.  It is also possible to block the execution button until the user completes all the fields correctly.  In this form, the work of the library completely suited us, but then we got properties dependent on each other ... <br>  The very example I gave above illustrates this problem.  If the test uses two values ‚Äã‚Äãthat may change, then when one changes, it is necessary to revalue and another.  The mechanism I described above did not support this, which in some places caused the code to crack from crutches supporting it all in working condition (I did not give them in the example, but they are based on calls of a PropertyChanged of another property with looping control).  Listening to the advice of my colleagues, I wrote a new mechanism that corrected the aforementioned deficiencies, after which there was a desire to use it without a twinge of conscience in other projects not related to work.  That is why I wanted to rewrite all the code from scratch, given the errors of the original design <s>and adding new ones</s> . <br></div></div><br>  In the development process, I tried to focus on FluentValidation, so the syntax is easily recognizable.  However, there are differences: something was adapted to the task, something was not implemented, but first things first. <br><br>  All information about the state of the object is stored in the property Validator, which is formed using rules.  Let's consider its creation on the example of machine properties: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CarViewModel</span></span> : <span class="hljs-title"><span class="hljs-title">ValidatableObject</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CarViewModel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Validator = GetValidator(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> IObjectValidator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetValidator</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> builder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValidationBuilder&lt;CarViewModel&gt;(); builder.RuleFor(vm =&gt; vm.Make).NotEmpty(); builder.RuleFor(vm =&gt; vm.Model).NotEmpty().WithMessage(<span class="hljs-string"><span class="hljs-string">"Please specify a car model"</span></span>); builder.RuleFor(vm =&gt; vm.Mileage).GreaterThan(<span class="hljs-number"><span class="hljs-number">0</span></span>).When(model =&gt; model.HasMileage); builder.RuleFor(vm =&gt; vm.Vin).Must(BeAValidVin).WithMessage(<span class="hljs-string"><span class="hljs-string">"Please specify a valid VIN"</span></span>); builder.RuleFor(vm =&gt; vm.Description).Length(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> builder.Build(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BeAValidVin</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> vin</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  VIN    } //     INotifyPropertyChanged }</span></span></code> </pre><br>  This example is very similar to the one that offers FluentValidation, so I hope that it does not need comments.  I focus on the fact that the validator is an internal object in relation to the ViewModel, and is finally built no earlier than in the constructor. <br><br>  To be able to display errors in the user interface, you need to connect the resource dictionary from the library (containing the ControlTemplate by default) and, preferably, create a style (have to do this for each type of control) and redefine the Attached property inside it ReactiveValidation.AutoRefreshErrorTemplate and ReactiveValidation.ErrorTemplate, as shown in the example: <br><br><pre> <code class="hljs xml">xmlns:b="clr-namespace:ReactiveValidation.WPF.Behaviors;assembly=ReactiveValidation" ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ResourceDictionary</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ResourceDictionary.MergedDictionaries</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ResourceDictionary</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Source</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/ReactiveValidation;component/WPF/Themes/Generic.xaml"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ResourceDictionary.MergedDictionaries</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Style</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TextBox"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TargetType</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TextBox"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Setter</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Property</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"b:ReactiveValidation.AutoRefreshErrorTemplate"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Value</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"True"</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Setter</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Property</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"b:ReactiveValidation.ErrorTemplate"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Value</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"{StaticResource ValidationErrorTemplate}"</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> </span><span class="hljs-comment"><span class="xml"><span class="hljs-comment">&lt;!-- Margin    --&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Setter</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Property</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"Margin"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Value</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"3"</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Style</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ResourceDictionary</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  <font color="gray"><i>This code is most conveniently placed in App.xaml, where it will be available to the entire application.</i></font> <br><br>  I think the reasons for adding a ControlTemplate are obvious.  But the properties may cause confusion.  Unfortunately, the standard Validation from WPF contains many problems that lead to incorrect display of the error pattern (used when the property is valid and vice versa).  To avoid this, a handful of crutches were written that work through the attached properties. <br><br>  It remains only to apply the style to the controls and everything will work: <br><br><pre> <code class="hljs pgsql">&lt;TextBlock Grid.<span class="hljs-keyword"><span class="hljs-keyword">Row</span></span>="0" Grid.Column="0" Margin="3" <span class="hljs-type"><span class="hljs-type">Text</span></span>="Make: " /&gt; &lt;TextBox Grid.<span class="hljs-keyword"><span class="hljs-keyword">Row</span></span>="0" Grid.Column="1" Style="{StaticResource TextBox}" <span class="hljs-type"><span class="hljs-type">Text</span></span>="{Binding Make, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" /&gt; &lt;TextBlock Grid.<span class="hljs-keyword"><span class="hljs-keyword">Row</span></span>="1" Grid.Column="0" Margin="3" <span class="hljs-type"><span class="hljs-type">Text</span></span>="Model: " /&gt; &lt;TextBox Grid.<span class="hljs-keyword"><span class="hljs-keyword">Row</span></span>="1" Grid.Column="1" Style="{StaticResource TextBox}" <span class="hljs-type"><span class="hljs-type">Text</span></span>="{Binding Model, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" /&gt; &lt;TextBlock Grid.<span class="hljs-keyword"><span class="hljs-keyword">Row</span></span>="2" Grid.Column="0" Margin="3" <span class="hljs-type"><span class="hljs-type">Text</span></span>="Has mileage: " /&gt; &lt;CheckBox Grid.<span class="hljs-keyword"><span class="hljs-keyword">Row</span></span>="2" Grid.Column="1" Margin="3" IsChecked="{Binding HasMileage, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" /&gt; &lt;TextBlock Grid.<span class="hljs-keyword"><span class="hljs-keyword">Row</span></span>="3" Grid.Column="0" Margin="3" <span class="hljs-type"><span class="hljs-type">Text</span></span>="Mileage: " /&gt; &lt;TextBox Grid.<span class="hljs-keyword"><span class="hljs-keyword">Row</span></span>="3" Grid.Column="1" Style="{StaticResource TextBox}" IsEnabled="{Binding HasMileage}" <span class="hljs-type"><span class="hljs-type">Text</span></span>="{Binding Mileage, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" /&gt; &lt;TextBlock Grid.<span class="hljs-keyword"><span class="hljs-keyword">Row</span></span>="4" Grid.Column="0" Margin="3" <span class="hljs-type"><span class="hljs-type">Text</span></span>="Vin: " /&gt; &lt;TextBox Grid.<span class="hljs-keyword"><span class="hljs-keyword">Row</span></span>="4" Grid.Column="1" Style="{StaticResource TextBox}" <span class="hljs-type"><span class="hljs-type">Text</span></span>="{Binding Vin, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" /&gt; &lt;TextBlock Grid.<span class="hljs-keyword"><span class="hljs-keyword">Row</span></span>="5" Grid.Column="0" Margin="3" <span class="hljs-type"><span class="hljs-type">Text</span></span>="Description: " /&gt; &lt;TextBox Grid.<span class="hljs-keyword"><span class="hljs-keyword">Row</span></span>="5" Grid.Column="1" Style="{StaticResource TextBox}" <span class="hljs-type"><span class="hljs-type">Text</span></span>="{Binding Description, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" /&gt;</code> </pre><br>  If everything is collected, we get the following simple application: <br><br><img src="https://habrastorage.org/webt/zi/km/pu/zikmpugr3h63ut063feemhpjfb4.png"><br><br>  As you fill the fields, the red triangle will disappear, indicating an error: <br><img src="https://habrastorage.org/webt/di/fm/dr/difmdryoxvyohqakohnxpfifmc0.png"><br><br>  <b>Message text and localization</b> <br><br>  In applications where there is no need to use localization, you can use the usual static strings.  Below is an example to change the entire message text for a property validator: <br><br><pre> <code class="hljs javascript">builder.RuleFor(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">vm</span></span></span><span class="hljs-function"> =&gt;</span></span> vm.PhoneNumber) .NotEmpty() .When(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">vm</span></span></span><span class="hljs-function"> =&gt;</span></span> Email, email =&gt; string.IsNullOrEmpty(email) == <span class="hljs-literal"><span class="hljs-literal">true</span></span>) .WithMessage(<span class="hljs-string"><span class="hljs-string">"You need to specify a phone or email"</span></span>) .Matches(@<span class="hljs-string"><span class="hljs-string">"^\d{11}$"</span></span>) .WithMessage(<span class="hljs-string"><span class="hljs-string">"Phone number must contain 11 digits"</span></span>);</code> </pre><br>  To specify the display name of the property, you can use the DisplayName attribute (from the namespace ReactiveValidation.Attributes) <br><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">DisplayName(DisplayName = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Minimal amount"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MinAmount { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; }</code> </pre><br>  To localize messages, the ResourceManager class is used, which is created along with the resources.  By creating two files Default.resx and Default.ru.resx, you can provide support for two languages. <br><br>  For convenience, using the static class, you can set the default resource manager - for this, it is enough to assign its value to ValidationOptions.LanguageManager.DefaultResourceManager.  However, it is possible to use another resource manager.  All of the above is demonstrated in this example: <br><br><pre> <code class="hljs javascript">builder.RuleFor(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">vm</span></span></span><span class="hljs-function"> =&gt;</span></span> vm.Email) .NotEmpty() .When(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">vm</span></span></span><span class="hljs-function"> =&gt;</span></span> PhoneNumber, phoneNumber =&gt; string.IsNullOrEmpty(phoneNumber) == <span class="hljs-literal"><span class="hljs-literal">true</span></span>) .WithLocalizedMessage(nameof(Resources.Default.PhoneNumberOrEmailRequired)) .Matches(@<span class="hljs-string"><span class="hljs-string">"^\w+@\w+.\w+$"</span></span>) .WithLocalizedMessage(Resources.Additional.ResourceManager, nameof(Resources.Additional.NotValidEmail));</code> </pre><br>  If the Email or PhoneNumber value is empty, a message will be displayed from the default resource with the PhoneNumberOrEmailRequired key.  In addition, the mail must satisfy the regular expression, and if there is a mismatch, the message will be output from the Additional resource with the NotValidEmail key. <br><br>  To localize the displayed names, you need to use the attribute and pass the DisplayNameKey and ResourceType to override the resource (you cannot use the ResourceManager for the attributes, so its type is used): <br><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">DisplayName(DisplayNameKey = nameof(Resources.Default.PhoneNumber))</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> PhoneNumber { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [DisplayName(ResourceType = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Resources.Additional), DisplayNameKey = <span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(Resources.Additional.Email))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; }</code> </pre><br>  Culture is taken from CultureInfo.CurrentUICulture for localization.  In addition, it is possible to override it with the help of ValidationOptions.LanguageManager.CurrentCulture.  By default, the text of the messages does not change when the culture is changed, however, this behavior can be enabled using the ValidationOptions.LanguageManager.TrackCultureChanged option, and a number of features should be taken into account: <br><br><ul><li>  The change of localization ‚Äúon the fly‚Äù is based on the fact that within the ValidationMessage class there is a subscription to an event of the LanguageManager class. </li><li>  Subscription occurs only if the TrackCultureChanged property is true.  Therefore, it should be asked only once - at the start of the application and no longer change. </li><li>  If culture is changed using CultureInfo.CurrentUICulture, after changing it, you need to call the ValidationOptions.LanguageManager.OnCultureChanged () method </li></ul><br>  In addition, it does not make sense to include this behavior if the localization change in the interface is not supported. <br><br>  <b>Additional features:</b> <br><br><ul><li>  There are 2 main types of messages: errors (Error) and warnings (Warining).  Warnings are also displayed on the GUI (only in orange), but the model is considered valid.  In addition, there is a gradation of ordinary / simple (Simple).  Regular messages are shown when focusing or hovering the cursor on a control, while simple messages are displayed only when hovering. </li><li>  The rules are based on extensions-methods, so you can easily extend them with your own validators. </li><li>  The basic interface required for the object being validated is IValidatableObject.  In the library there is an implementation ValidatableObject based on INPC.  You can easily define your own base class with this interface, since its implementation contains a bit of code (the project shows examples with the redefinition from ReactiveObject from Reactive UI) </li><li>  If a property inherited from INotifyPropertyChanged or INotifyCollectionChanged is validated, then special adapter classes monitor their call, initiating revalidation.  You can extend subscriptions with your own classes, for example, add IReactiveNotifyCollectionItemChanged &lt;&gt; from Reactive UI </li></ul><br>  <b>What I would like to say:</b> <br><br><ul><li>  There is no asynchronous validation.  I think it is possible to discuss whether it is needed or not, but nevertheless, it is not supported now. </li><li>  I am ashamed, but errors are possible.  I hope that they will be quickly found and corrected. </li><li>  This is my first development experience for Open Source.  I am very worried that the opportunities that I initially invested will not be enough.  Hope this will also be easily fixable. </li></ul><br>  <a href="https://github.com/Karnah/ReactiveValidation">Source code available on GitHub, MIT license</a> <br>  <a href="https://www.nuget.org/packages/ReactiveValidation">In addition, you can download from Nuget</a> <br><br>  <i>Projects mentioned in the article:</i> <br><br><ul><li>  <a href="https://github.com/JeremySkinner/FluentValidation">FluentValidation</a> , which I often see in applications like Web API </li><li>  <a href="https://reactiveui.net/">Reactive UI</a> , in addition, I recommend this series of articles ( <a href="https://habr.com/post/303650">first</a> , <a href="https://habr.com/post/303898">second</a> and <a href="https://habr.com/post/305350">third</a> parts) </li></ul><br>  <font color="gray"><i>I would like to thank my <a href="https://habr.com/users/adeptuss/" class="user_link">adeptuss</a> and @baisel colleagues.</i></font> <font color="gray"><i><br></i></font>  <font color="gray"><i>for helping to develop the first version of the project.</i></font> <font color="gray"><i><br><br></i></font>  <font color="gray"><i>And also @truetanchik for patience and error correction.</i></font> </div><p>Source: <a href="https://habr.com/ru/post/354886/">https://habr.com/ru/post/354886/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354876/index.html">Swift for data scientist: quick dive in 2 hours</a></li>
<li><a href="../354878/index.html">Richard Hamming: Chapter 15. Digital Filters - 2</a></li>
<li><a href="../354880/index.html">Is it possible to consciously refuse functional programming?</a></li>
<li><a href="../354882/index.html">LAppS application server for microservice architecture</a></li>
<li><a href="../354884/index.html">The city falls asleep, hackers wake up</a></li>
<li><a href="../354888/index.html">Practice implementing Cisco ISE. Engineer's look</a></li>
<li><a href="../354890/index.html">We optimize the web with Vitaly Friedman, - compression, images, fonts, HTTP / 2 features and Resource Hints</a></li>
<li><a href="../354892/index.html">Commenting code: good, bad, evil</a></li>
<li><a href="../354894/index.html">MIT course "Computer Systems Security". Lecture 1: "Introduction: threat models", part 2</a></li>
<li><a href="../354896/index.html">MIT course "Computer Systems Security". Lecture 1: "Introduction: threat models", part 3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>