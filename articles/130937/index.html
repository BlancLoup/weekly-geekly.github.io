<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Deploy billing for a small network from scratch</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Background : 
 Some good people decided to start a provider business. Stretched and unwound the optics in a small area, put the boxes, put there minim...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Deploy billing for a small network from scratch</h1><div class="post__text post__text-html js-mediator-article">  <b>Background</b> : <br>  Some good people decided to start a provider business.  Stretched and unwound the optics in a small area, put the boxes, put there minimal switches with which you can organize VLAN-Per-User, bought a small, for a start, channel from the nearest highway.  They have a question about what users should consider traffic / money and cut speeds. <br>  The general network layout should look like this: <br><br><img src="https://habrastorage.org/storage1/8fd86e8c/d6da58eb/9052dab5/9b72b429.png"><br><br>  To whom it is interesting, further under the cut there are a lot of letters and pictures. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Conventions</b> : <br>  - Gateway uplink will be 1.2.3.3 <br>  - NAS network adapters looking at the uplink will be on the network 1.2.3.3/24 <br>  - The network provided to users will be 172.16.0.0/18, or, if you like, 255.255.192.0 <br>  - we reserve IP addresses 172.16.0.0-172.16.0.10 for access servers and other own needs <br>  - The user statistics server will be available at <a href="http://stat.isp/">stat.isp</a> and, taking into account the budget of the solution, will be located on the same host as the billing server, although it is good practice not only to separate the billing and subscriber traffic, but also to distribute the database, the billing core and the web to separate hosts. -interface. <br><br>  <b>Initial requirements were clearly stated:</b> <br>  - Design network capacity - up to 10,000 subscribers <br>  - Distribution of IP to subscribers using DHCP <br>  - Authorization or on a bunch of IP + MAC <br>  - Several fully unlimited fares <br>  - Traffic is still necessary to control <br>  - It is very desirable to see the activity of each individual user. <br>  - The division of the rights of cashiers / accountants / managers / administrators <br>  - Ability to scale decisions regarding the growth in the number of subscribers <br>  ‚ÄúSince there is no speaker yet, and there are three and a half ip cards issued by an aplink, the first users are supposed to be NAT. <br>  - Naturally, all this is the most budget :) <br>  A cursory examination of the range of opensource billing systems showed that <a href="http://stg.dp.ua/">Stargazer</a> might be optimal in this situation for the following reasons: <br>  - The project is open, actively developing, new versions are released with enviable consistency. <br>  - It does not suffer from congenital monostroid and allows you to finish the functional without becoming attached to the internal mechanics <br>  - The kernel is written in C / C ++ and absolutely fast <br>  - A large selection of methods for counting traffic <br>  - Optional storage support in Files / MySQL / Firebird / PostgreSQL <br>  - The magic mechanism for executing commands on remote servers <br>  The installation will run on the bare FreeBSD 8.2-RELEASE installed in the kern-developer + ports option.  All user traffic will be driven through a remote NAS to all <br>  the same FreeBSD 8.2, producing NAT / Shape / NetFlow and drawing schedules for the subscriber channel using bandwidthd.  As a webinterface for stargazer 2.407-p1, we will be the last one at the time of writing the topic Ubilling 0.1.7, although Stargazer has a wide choice of frontends - from the Win-configurator to several console and XML-RPC API. <br>  Further direct copy-paste from the console with periodic focus on conceptual points. <br><br>  <b>So let's start setting up the billing server</b> . <br><br>  1. Moral prepare <br>  2. Installing dependencies <br><pre>   # cd / usr / ports / databases / mysql51-server / &amp;&amp; make install
   # cd / usr / ports / textproc / expat2 &amp;&amp; make install
   # cd / usr / ports / devel / libtool &amp;&amp; make all &amp;&amp; make install
   # cd / usr / ports / security / sudo &amp;&amp; make install
</pre><br>  For simplicity, isc-dhcp is compiled without DHCP_PARANOIA <br><pre>  
   # cd / usr / ports / net / isc-dhcp31-server / &amp;&amp; make install
</pre><br>  php5 should be compiled with at least CLI support and the Apache module (the latter should be fine with dependency) <br><pre>  
   # cd / usr / ports / lang / php5 &amp;&amp; make install
</pre><br>  We collect vital PHP extensions, namely: put a tick on MYSQL, MBSTRING and ICONV <br><pre>   # cd / usr / ports / lang / php5-extensions / &amp;&amp; make config &amp;&amp; make install
</pre><br><br>  3. We assemble the stargazer itself and its console configurators in two lines :) <br><pre>   # fetch http://stg.dp.ua/download/server/2.407-p1/stg-2.407-p1.tar.gz &amp;&amp; tar zxvf stg-2.407-p1.tar.gz &amp;&amp; cd stg-2.407-p1 / projects / stargazer / &amp;&amp; ./build &amp;&amp; gmake install 
   # cd ../sgconf &amp;&amp; ./build &amp;&amp; gmake &amp;&amp; gmake install &amp;&amp; cd ../sgconf_xml/ &amp;&amp; ./build &amp;&amp; gmake &amp;&amp; gmake install
</pre><br><br>  4. Expand the current version of Ubilling <br><pre>   # cd / usr / local / www / data /
   # mkdir billing
   # cd billing
   # fetch http://ubilling.net.ua/ub.tgz
   # tar zxvf ub.tgz
   # chmod -R 777 content / config / multinet / exports / remote_nas.conf vservices.php
</pre><br>  5. Make special symlink magic <br><pre>   # mkdir / etc / stargazer / dn
   # chmod -R 777 / etc / stargazer / dn
   # ln -fs / usr / local / www / data / billing / multinet / usr / local / etc / multinet
   # ln -fs /usr/local/www/data/billing/remote_nas.conf /etc/stargazer/remote_nas.conf
   # ln -fs / etc / stargazer / dn / usr / local / www / data / billing / content / dn 
</pre><br>  6. Start Apache and MySQL <br><pre>   # /usr/local/etc/rc.d/mysql-server start
   # /usr/local/etc/rc.d/apache onestart
</pre><br><br>  7. Set a new root user password for mysql (newpassword - for example) <br>  #mysqladmin -u root password newpassword <br><br>  8. We give /etc/stargazer/stargazer.conf to the following form <br><pre> LogFile = /var/log/stargazer.log 
 PIDFile = /var/run/stargazer.pid 
 Rules = / etc / stargazer / rules 
 DetailStatWritePeriod = 1/4 
 StatWritePeriod = 10 
 DayFee = 1 
 DayFeeIsLastDay = no 
 DayResetTraff = 1 
 SpreadFee = no 
 FreeMbAllowInet = no 
 WriteFreeMbTraffCost = yes 
 FullFee = yes 
 &lt;DirNames&gt; 
   DirName0 = Internet 
   DirName1 =
   DirName2 = 
   DirName3 = 
   DirName4 = 
   DirName5 = 
   DirName6 = 
   DirName7 = 
   DirName8 = 
   DirName9 = 
 &lt;/ DirNames&gt; 
 ExecutersNum = 1 
 ModulesPath = / usr / lib / stg 
 &lt;StoreModule store_mysql&gt; 
   dbhost = localhost 
   dbname = stg 
   dbuser = root 
   rootdbpass = newpassword 
 &lt;/ StoreModule&gt; 
 &lt;Modules&gt; 
 &lt;Module auth_ao&gt; 
 &lt;/ Module&gt; 
 &lt;Module auth_ia&gt; 
   Port = 5555 
   UserDelay = 60 
   UserTimeout = 65 
   FreeMb = cash 
 &lt;/ Module&gt; 
 &lt;Module conf_sg&gt; 
   Port = 5555 
 &lt;/ Module&gt; 
 &lt;Module cap_nf&gt;
         TCPPort = 42111
         UDP port = 42111
 &lt;/ Module&gt;

 &lt;Module remote_script&gt; 
 SendPeriod = 10
 SubnetFile = / etc / stargazer / remote_nas.conf
 Password = password_for_rscriptd
 UserParams = Cash Tariff
 Port = 9999 
 &lt;/ Module&gt;
 &lt;/ Modules&gt; 
</pre><br><br>  9. We edit the config / etc / stargazer / rules leaving only one direction we need, namely the Internet. <br><pre>  # echo "ALL 0.0.0.0/0 DIR0"&gt; / etc / stargazer / rules
 </pre><br><br>  10. Add our first NAS to /etc/stargazer/remote_nas.conf <br><pre>  # echo "172.16.0.0/18 172.16.0.2"&gt; /etc/stargazer/remote_nas.conf
</pre><br><br>  10. start / stop stargazer <br><pre>   # stargazer
   # killall stargazer
</pre><br><br>  11. Make sure that the default database is deployed <br><pre>  # mysql -u root -p stg -e "S Enter password:
 + --------------- +
 |  Tables_in_stg |
 + --------------- +
 |  admins |
 |  messages |
 |  stat |
 |  tariffs |
 |  users |
 + --------------- +
</pre><br><br>  12. Edit / usr / local / etc / sudoers, adding a user there, under which the Web interface will work <br><pre> User_Alias ‚Äã‚ÄãBILLING = www
 BILLING ALL = NOPASSWD: ALL
</pre><br><br>  13. Deploy dump Ubilling <br><pre>   # cd / usr / local / www / data / billing /
   # cat docs / test_dump.sql |  mysql -u root -p stg
</pre><br><br>  14. Make sure everything is fine. <br><pre>  
 #mysql -u root -p stg -e "SHOW TABLES" Enter password: + ----------------- + |  Tables_in_stg |  + ----------------- + |  address |  |  admins |  |  ahenassign |  |  apt |  |  build |  |  cardbank |  |  cardbrute |  |  cashtype |  |  cfitems |  |  cftypes |  |  city ‚Äã‚Äã|  |  contracts |  |  contrahens |  |  cpe |  |  cpetypes |  |  dhcp |  |  directions |  |  dshape_time |  |  emails |  |  employee |  |  jobs |  |  jobtypes |  |  messages |  |  modem_templates |  |  modems |  |  nas |  |  nethosts |  |  networks |  |  notes |  |  payments |  |  phones |  |  realname |  |  services |  |  servtariff |  |  speeds |  |  stat |  |  street |  |  switches |  |  switchmodels |  |  tags |  |  tagtypes |  |  tariffs |  |  taskman |  |  userreg |  |  users |  |  userspeeds |  |  vcash |  |  vcashlog |  |  vservices |  |  weblogs |  + ----------------- + </pre><br><br>  15. Edit the file config / billing.ini, bringing it up to standard: <br><pre> baseconf = sgconfxml
 SGCONF = / usr / sbin / sgconf
 SGCONFXML = / usr / sbin / sgconf_xml
 STG_HOST = localhost
 STG_PORT = 5555
 XMLRPC_PORT = 8081
 STG_LOGIN = admin
 STG_PASSWD = new_password_starmin_azer
 Sudo = / usr / local / bin / sudo
 TOP = / usr / bin / top -b
 CAT = / bin / cat
 Grep = / usr / bin / grep
 RC_DHCPD = / usr / local / etc / rc.d / isc-dhcpd
 UPTIME = / usr / bin / uptime
 Ping = / sbin / ping
 KILL = / bin / kill
 STGPID = / var / run / stargazer.pid
 STGNASHUP = 1
 PHPSYSINFO = phpsysinfo /
 LANG = ua
 TASKBAR_ICON_SIZE = 128
 REGRANDOM_MAC = 1
 REGALWONLINE = 1
 REGDISABLEDSTAT = 1
</pre><br><br>  16. Expand billet launch scripts <br><pre>   # cp -f docs / presets / FreeBSD / etc / stargazer / config / etc / stargazer /
   # cp -f docs / presets / FreeBSD / etc / stargazer / GetMac / etc / stargazer /
   # chmod a + x / etc / stargazer / *
</pre><br><br>  17. And we do nailing IP + MAC in the script / etc / stargazer / OnConnect <br><br><pre>  
 #! / bin / sh
 LOGIN = $ 1
 IP = $ 2
 CASH = $ 3
 ID = $ 4
 MAC = `php / etc / stargazer / GetMac $ LOGIN`
 / usr / sbin / arp -S $ IP $ MAC
</pre><br>  18. We edit the config / etc / stargazer / config, writing in it the current MySQL parameters <br><br><pre> host = localhost 
 username = root 
 password = newpassword 
 database = stg
</pre><br><br>  19. Similarly, we edit the config config / mysql.ini <br><br><pre> ; database host
 server = "localhost"
 ; database port
 port = "3306"
 ; user login
 username = "root"
 ; user password
 password = "newpassword"
 ; database name to use
 db = "stg"
 character = "UTF8"
 prefix = "billing"
</pre><br><br>  20. Start the stargazer and change the default administrator password. <br><pre>   # stargazer
   # sgconf_xml -s localhost -p 5555 -a admin -w 123456 -r "&lt;ChgAdmin Login = \" admin \ "Password = \" new_password_admin_stargazer \ "/&gt;"
</pre><br><br>  21. bring our /etc/rc.conf to the form <br><pre> gateway_enable = "YES"
 hostname = "billing.isp"
 ifconfig_em0 = "inet 172.16.0.1 netmask 255.255.192.0"
 inetd_enable = "YES"
 keymap = "ru.koi8-r"
 sshd_enable = "YES"
 named_enable = "YES"
 sendmail_enable = "NO"
 mysql_enable = "YES"
 apache_enable = "YES"
 dhcpd_enable = "YES"
 dhcpd_flags = "- q"
 dhcpd_conf = "/ usr / local / etc / multinet / dhcpd.conf"
 dhcpd_ifaces = "em0"
</pre><br><br>  22. Add the ".isp" service zone to /etc/namedb/named.conf <br><pre> acl internals {172.16.0.0/18;  };
 acl local {127.0.0.1;  };

 zone "isp" {
     type master;
     file "/ etc / namedb / master / isp";
     allow-query {internals;  local;  };
 };
</pre><br><br>  and in / etc / namedb / master / isp <br><br><pre> $ TTL 86400
 @ IN SOA isp.  admin.isp.  (
                         2011101001;  Serial
                                 8H;  Refresh
                                 1D;  Retry
                                 2W;  Expire
                                 1D);  Negative Cache TTL

         IN NS dns.isp.
 @ IN A 172.16.0.1


 billing IN A 172.16.0.1
 stat IN A 172.16.0.1
 nas1 IN A 172.16.0.2
</pre><br><br>  23. Create a stargazer startup script in /etc/rc.d/billing <br><pre> #! / bin / sh
 / usr / sbin / stargazer
</pre><br><br>  and assign him the necessary rights <br><br><pre> # chmod a + x /etc/rc.d/billing
</pre><br><br>  24. We register the necessary virtualkhosty in /usr/local/etc/apache/httpd.conf <br><pre> NameVirtualHost *: 80

 &lt;VirtualHost *: 80&gt;
 ServerName billing.isp
 DocumentRoot "/ usr / local / www / data / billing /"
 AddDefaultCharset utf-8
 &lt;/ Virtualhost&gt;


 &lt;VirtualHost *: 80&gt;
 ServerName stat.isp
 DocumentRoot "/ usr / local / www / data / billing / userstats /"
 AddDefaultCharset utf-8
 &lt;/ Virtualhost&gt;
</pre><br><br>  25. We rule the global template by which dhcp configs will be generated, it is located here: /usr/local/www/data/billing/config/dhcp/global.template <br><br><pre> option domain-name "isp";
 option domain-name-servers 172.16.0.1;
 default-lease-time 3600;
 max-lease-time 43200;
 authoritative;
 ddns-update-style none;
 log facility local7;
 one-lease-per-client true;
 deny duplicates;

 shared-network ourisp {
 {SUBNETS}
 }
</pre><br><br>  26. Set the required logging level for dhcpd in /etc/syslog.conf <br><br>  27. We can make a preventive reboot to see how everything rises, or perezaprazvatit all that we have already built manually. <br><br>  28. And now the most interesting thing for which everything was started :) <br><br>  We go to our <a href="http://servername.isp/billing/">servername.isp / billing</a> and log in with the default username and password <b>admin / demo</b> (do not forget to change immediately) and see the following picture: <br><br><img src="https://habrastorage.org/storage1/6292f467/29d03fb9/22128980/b4ce114b.png"><br><br>  Add the traffic class we need: <br><br><img src="https://habrastorage.org/storage1/dcc22113/fcbb23ef/d0da8808/a8e9bcc9.png"><br><br>  We add network and service (I remind you that we reserve the first 10 IP for our needs) <br><br><img src="https://habrastorage.org/storage1/fcc8d9ee/e9789f7a/15e6fbde/6b657cd2.png"><br><br>  Adding network handler DHCP <br><br><img src="https://habrastorage.org/storage1/e3e65dce/aaa6db9b/eece5ba3/9e949224.png"><br><br>  and apply to it your subnet pattern <br><pre> subnet {NETWORK} netmask {MASK} {
 default-lease-time 3600;
 option domain-name "ourisp";
 option subnet-mask {MASK};
 option routers 172.16.0.2;
 include "/ usr / local / etc / multinet / {HOSTS}";
 }
</pre><br><br>  hinting in such a way that the default gateway should be towards our NAS server. <br><br>  Check if the dhcpd.conf config is successfully created in the ‚ÄúNetworks‚Äù directory <br><br><img src="https://habrastorage.org/storage1/609ff64d/caccf034/76e7116b/686dfa73.png"><br><br>  Add your first fare, let it be called Unlim-1 and be unlimited with a subscription fee of 50 money per month <br><br><img src="https://habrastorage.org/storage1/d9a21fc9/e5d28178/9bc54056/b25c2aa3.png"><br><br>  We hang on it symmetrical speed of 1 megabit / s <br><br><img src="https://habrastorage.org/storage1/85a7e3ce/7cd5b1d5/d2ee2c6d/9dc710c4.png"><br><br>  Add our access server which we will configure a little later. <br><br><img src="https://habrastorage.org/storage1/ccd9974c/26ff3a61/4f1bd274/d1b1b116.png"><br><br>  In reference books of Cities, Streets and houses we add our settlement, streets and houses where subscribers will live <br><br><img src="https://habrastorage.org/storage1/103859c3/8d24f8bd/9cb2518c/25f064cb.png"><br><img src="https://habrastorage.org/storage1/01f65afa/10fe9c57/d9796ac8/56a6dd9d.png"><br><img src="https://habrastorage.org/storage1/fe594603/bf53ec4a/3b3cd8d9/d4c8c682.png"><br><br>  Well, like everything, we register our first subscriber <br><br><img src="https://habrastorage.org/storage1/26c9d427/5f74291a/735b9d41/1ba3c853.png"><br><img src="https://habrastorage.org/storage1/66cddfc8/8c660f06/e97845b6/97983bef.png"><br><br>  We assign him MAC, tariff, enter the full name.  and all that is needed in ‚Äúediting‚Äù, and, in general, it should work. <br><br>  <b>Configure NAS server.</b> <br><br>  Again, we have FreeBSD 8.2 Naked, from which we want it to act as the default gateway for our users. <br>  The necessary module can be simply loaded, but this is a matter of habit, so we will assemble the core with our hands and throw away everything we don‚Äôt need. <br><br><pre> # cd / usr / src / sys / i386 / conf /
 # cp GENERIC NAS1
</pre><br><br>  We replace in the config of our new kernel ident GENERIC on NAS1 <br><br><pre> options IPFIREWALL 
 options IPFIREWALL_DEFAULT_TO_ACCEPT 
 options IPFIREWALL_FORWARD 
 options IPFIREWALL_VERBOSE 
 options IPFIREWALL_VERBOSE_LIMIT = 50 
 options IPFIREWALL_NAT 
 options LIBALIAS 
 options ROUTETABLES = 2 
 options DUMMYNET 
</pre><br><br>  And collect / put it in one line: <br><br><pre> # config NAS1 &amp;&amp; cd ../compile/NAS1 &amp;&amp; make cleandepend &amp;&amp; make depend &amp;&amp; make &amp;&amp; make install
</pre><br><br>  We make sure that our /etc/rc.conf looks like this somewhere: <br><br><pre> defaultrouter = "1.2.3.3"
 gateway_enable = "YES"
 hostname = "nas1"
 ifconfig_em1 = "inet 1.2.3.4 netmask 255.255.255.0 -rxcsum -txcsum -tso"
 ifconfig_em0 = "inet 172.16.0.2 netmask 255.255.192.0 -rxcsum -txcsum -tso"
 inetd_enable = "YES"
 sshd_enable = "YES"
 firewall_enable = "YES" 
 firewall_nat_enable = "YES" 
 dummynet_enable = "YES" 
 firewall_script = "/ etc / firewall.conf" 
 thttpd_enable = "YES"
 thttpd_enable = "YES" 
</pre><br><br>  Install thttpd with which we will show graphs. <br><pre>  # cd / usr / ports / www / thttpd / &amp;&amp; make install
</pre><br><br>  Excellent NetFlow sensor <br><pre>   # cd / usr / ports / net-mgmt / softflowd / &amp;&amp; make install
</pre><br><br>  Expat needed <br><pre>   #cd / usr / ports / textproc / expat2 &amp;&amp; make install
</pre><br><br>  And moderately vruchy, but ideally easy to set up bandwidthd for drawing per-user plots <br><pre>   # cd / usr / ports / net-mgmt / bandwidthd / &amp;&amp; make install
</pre><br>  PHP build with CLI support <br><pre>   # cd / usr / ports / lang / php5 &amp;&amp; make install
</pre><br>  And the MYSQL module to it <br><pre>   # cd / usr / ports / lang / php5-extensions / &amp;&amp; make config &amp;&amp; make install
</pre><br>  We bring our /etc/firewall.conf to the form: <br><br><pre> #! / bin / sh
 # send netflow to billing server
 / usr / local / sbin / softflowd -i em0 -n 172.16.0.1:42111
 FwCMD = "/ sbin / ipfw -q"
 $ {FwCMD} -f flush
 # user network
 $ {FwCMD} table 2 add 172.16.0.0/18
 # networks which will not be NAT-it
 $ {FwCMD} table 9 add 1.2.3.4/24
 #NAT
 $ {FwCMD} nat 1 config log if em1 reset same_ports
 $ {FwCMD} add 600 nat 1 ip from table \ (2 \) to not table \ (9 \) via em1
 $ {FwCMD} add 601 nat 1 ip from any to 1.2.3.4 via em1
 # default blocking policy
 $ {FwCMD} add 65533 deny all from table \ (2 \) to any via em0
 $ {FwCMD} add 65534 deny all from any to any table \ (2 \) via em0
 $ {FwCMD} add 65535 allow
</pre><br><br>  We expose the correct rights to our firewall initialization script <br><pre>    # chmod a + x /etc/firewall.conf
 </pre><br>  We collect rscriptd and ensure its launch upon reboot <br><br><pre> # fetch http://stg.dp.ua/download/server/2.407-p1/stg-2.407-p1.tar.gz &amp;&amp; tar zxvf stg-2.407-p1.tar.gz &amp;&amp; cd stg-2.407-p1 / projects / rscriptd / &amp;&amp; ./build &amp;&amp; gmake install
</pre><br><br>  edit /etc/rc.d/rscriptd, making it look like <br><br><pre> #! / bin / sh
 / usr / sbin / rscriptd
</pre><br>  and assign him the right rights <br><br><pre> #chmod a + x /etc/rc.d/rscriptd
</pre><br><br>  Expand Ubilling script blanks <br><br><pre> # mkdir ubilling &amp;&amp; fetch http://ubilling.net.ua/ub.tgz &amp;&amp; tar zxvf ub.tgz &amp;&amp; cd ubilling
 # mkdir / etc / stargazer / dn &amp;&amp; chmod a + w / etc / stargazer / dn
 # cp -f docs / presets / FreeBSD / etc / stargazer / * / etc / rscripd /
 # chmod a + x / etc / rscriptd / *
</pre><br><br>  We edit the config / etc / rscriptd / config, writing to it the current MySQL parameters so that the GetSpeed, GetUpSpeed, GetMAC scripts can receive user information normally. <br>  Also, do not forget to fix / etc / rscriptd / OnConnect, specifying in it the input interface for shaping, which in our case <br><br><pre> IFACE = "em0"
</pre><br><br>  We configure bandwidthd so that he draws beautiful graphics, which we then have to contemplate in Ubilling: <br><br>  In the file /usr/local/bandwidthd/etc/bandwidthd.conf we enter the network of our users <br><pre> subnet 172.16.0.0/18
 dev "em0"
 output_cdf true
 recover_cdf true
</pre><br>  add periodic SIGHUP for bandwidthd to crontab -e <br><pre>   3 3 * * * / bin / kill -HUP `cat / var / run / bandwidthd.pid` 
</pre><br>  And again terrible simlinkovaya magic, so that our thttpd could normally show graphs <br><br><pre> # mv / usr / local / bandwidthd / htdocs / usr / local / www / data / band
 # ln -fs / usr / local / www / data / band / / usr / local / bandwidthd / htdocs
 # cp /usr/local/etc/thttpd.conf.sample /usr/local/etc/thttpd.conf
</pre><br><br>  We provide start up when loading <br><pre>   # / usr / local / bandwidthd / bandwidthd
   # /usr/local/etc/rc.d/thttpd start
</pre><br>  And as a final touch, we add more or less universal things that help to somehow improve the speed in future in /etc/sysctl.conf <br><pre> net.inet.ip.fw.one_pass = 1 
 net.inet.ip.fastforwarding = 1 
 net.inet.tcp.nolocaltimewait = 1
</pre><br>  After a reboot, we get a working NAS, remotely receiving commands from the billing system, sending it traffic information and everything else that was required of it. <br>  I would also like to write about setting up a user account, undocumented "features" with the transition to the next month and other things that you can stumble at first.  But the article was already too monstrous and boring.  I promise, if karma allows, to describe all these things in a separate legend in a week. <br><br>  <a href="http://stg.dp.ua/">Offsite Stargazer</a> <br>  <a href="http://ubilling.net.ua/">Offsite Ubilling</a> </div><p>Source: <a href="https://habr.com/ru/post/130937/">https://habr.com/ru/post/130937/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../130931/index.html">Google AI Challenge. How to write your bot. Part 1, 2</a></li>
<li><a href="../130932/index.html">Vertical screens in digital signage</a></li>
<li><a href="../130933/index.html">Universal plugs</a></li>
<li><a href="../130935/index.html">How to bypass the security code on ipad2 using the smart cover</a></li>
<li><a href="../130936/index.html">Making Releases with Maven in Java</a></li>
<li><a href="../130938/index.html">How does knowing MVP help save a startup time and effort?</a></li>
<li><a href="../130943/index.html">Logitech Squeezebox Radio - for those who love radio and the Internet</a></li>
<li><a href="../130945/index.html">Dynamic programming and lazy computing</a></li>
<li><a href="../130946/index.html">Ants AI Challenge. Tutorial novice bosses</a></li>
<li><a href="../130947/index.html">As a web studio does not quarrel with the customer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>