<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Defer: from Go to PHP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Go has a useful defer construct. It is usually used to release resources and works as follows: a function is passed as an argument to defer, which is ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Defer: from Go to PHP</h1><div class="post__text post__text-html js-mediator-article"><p>  Go has a useful <a href="https://habrahabr.ru/post/118898/">defer</a> construct.  It is usually used to release resources and works as follows: a function is passed as an argument to defer, which is placed in the list of functions.  This list of functions is performed when leaving the ambient function. </p><br><p>  Defer has several obvious and not so merits: </p><br><ul><li>  Improves understanding of the code - when creating a resource, the code responsible for its release is immediately visible.  No need to look for try {} finally {} or all function exit points. </li><li>  allows you to avoid frequent errors associated with the release of resources, for example, with unhandled exceptions, or in the case of opening several resources. </li></ul><a name="habracut"></a><br><p>  For example, such code: </p><br><pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Utils</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copyFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $sourceName, string $destName)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ $readHandle = fopen($sourceName, <span class="hljs-string"><span class="hljs-string">"r"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($readHandle === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(); } $writeHandle = fopen($destName, <span class="hljs-string"><span class="hljs-string">"w"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($writeHandle === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { fclose($readHandle); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (($buffer = fgets($readHandle)) !== <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { $wasFailure = fwrite($writeHandle, $buffer); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($wasFailure) { fclose($readHandle); fclose($writeHandle); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!feof($readHandle)) { fclose($readHandle); fclose($writeHandle); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(); } fclose($readHandle); fclose($writeHandle); } }</code> </pre> <br><p>  It could be turned into such: </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Utils</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copyFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $sourceName, string $destName)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ $readHandle = fopen($sourceName, <span class="hljs-string"><span class="hljs-string">"r"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($readHandle === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(); } defer fclose($readHandle); $writeHandle = fopen($destName, <span class="hljs-string"><span class="hljs-string">"w"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($writeHandle === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(); } defer fclose($writeHandle); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (($buffer = fgets($readHandle)) !== <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { $wasFailure = fwrite($writeHandle, $buffer); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($wasFailure) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!feof($readHandle)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(); } } }</code> </pre> <br><p>  In the second case, working with closing files is much easier - each file needs to be closed only once.  It reduces the likelihood that someone will forget to close the file, especially if they are not 2, but more. </p><br><p>  But unfortunately, there is no defer in PHP.  But you can write your own implementation.  It looks like this: </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DeferredContext</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $deferredActions = []; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">defer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(callable $deferAction)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;deferredActions[] = $deferAction; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">executeDeferredActions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $actionsCount = count(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;deferredActions); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($actionsCount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = $actionsCount - <span class="hljs-number"><span class="hljs-number">1</span></span>; $i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; $i--) { $action = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;deferredActions[$i]; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $action(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (\<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> $e) { } <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;deferredActions[$i]); } } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;deferredActions = []; } } <span class="hljs-keyword"><span class="hljs-keyword">trait</span></span> DeferredTrait { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deferred</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(callable $callback)</span></span></span><span class="hljs-function"> </span></span>{ $context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DeferredContext(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $callback($context); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { $context-&gt;executeDeferredActions(); } } }</code> </pre> <br><p>  DeferredContext - a class in which handler functions accumulate.  When exiting the function, you must call the executeDeferredActions () method, which will execute all the handlers.  In order not to manually create DeferredContext, you can use the DeferredTrait treit, which encapsulates the logic of working with DeferredContext. </p><br><p>  Using this approach, the code from the example above will look like this: </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Utils</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">DeferredTrait</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copyFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $sourceName, string $destName)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;deferred(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DeferredContext $context)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($destName, $sourceName)</span></span></span><span class="hljs-function"> </span></span>{ $readHandle = fopen($sourceName, <span class="hljs-string"><span class="hljs-string">"r"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($readHandle === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(); } $context-&gt;defer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($readHandle)</span></span></span><span class="hljs-function"> </span></span>{ fclose($readHandle); }); $writeHandle = fopen($destName, <span class="hljs-string"><span class="hljs-string">"w"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($writeHandle === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(); } $context-&gt;defer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($writeHandle)</span></span></span><span class="hljs-function"> </span></span>{ fclose($writeHandle); }); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (($buffer = fgets($readHandle)) !== <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { $wasFailure = fwrite($writeHandle, $buffer); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($wasFailure) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!feof($readHandle)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(); } }); } }</code> </pre> <br><p>  I hope that this idea will help you reduce the number of bugs in the code and create more reliable programs. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/346176/">https://habr.com/ru/post/346176/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../346166/index.html">Choosing a reliable database in a high load project</a></li>
<li><a href="../346168/index.html">Top 10 universities in Europe to study IT</a></li>
<li><a href="../346170/index.html">Divide users by role in FeathersJs</a></li>
<li><a href="../346172/index.html">Moving to Japan</a></li>
<li><a href="../346174/index.html">Analyzing local functions in C # 7</a></li>
<li><a href="../346178/index.html">640 KB is really enough for everyone</a></li>
<li><a href="../346180/index.html">Algorithm Paccos. Understandable article on consensus in a distributed system</a></li>
<li><a href="../346184/index.html">Bioinformatic Pipeline with Docker</a></li>
<li><a href="../346186/index.html">Practice writing tests. Yandex lecture</a></li>
<li><a href="../346188/index.html">Web messengers and the event 'beforeunload': how to save a million messages when you close the page</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>