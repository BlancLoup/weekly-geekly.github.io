<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We collect the Shark under iOS and OSX</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Yes, this title is not very meaningful, so I will give a few explanations for those who still think "to go under the cat or not?". 

 Shark is a set o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We collect the Shark under iOS and OSX</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/586/8e7/df7/5868e7df70116af2c59bee3ab3904a4c.png" alt="image"><br>  Yes, this title is not very meaningful, so I will give a few explanations for those who still think "to go under the cat or not?". <br><br>  <a href="https://sourceforge.net/projects/shark-project/">Shark</a> is a set of C ++ machine learning libraries (Machine Learning), namely linear and nonlinear optimization, neural networks, and with and without teacher training, evolutionary algorithms, and much more.  A more detailed description can be found on <a href="https://sourceforge.net/projects/shark-project/">the project website</a> . <br><br>  If you are interested in the answers to the following questions <br><ul><li>  How to build a static library for iOS? </li><li>  How to create a framework for iOS? </li><li>  How to publish iOS and OSX framework via CocoaPods? </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Then you under the cat. <br><a name="habracut"></a>  . <br><br><h4>  What for? </h4><br>  One could simply answer, ‚ÄúFor more libraries to be good and useful for iOS,‚Äù but I had another reason.  While working on a board game under iOS, I wanted to use machine learning to develop Artificial Intelligence (AI) of a computer opponent. <br><br>  The plan was simple, first teach the AI, driving the neural network through tens of thousands of games, running them on powerful hardware under Mac OS, then take the trained network and use it in the application on the iPhone / iPad.  The first part of the plan was relatively easy to implement, if only because Shark version 2.3.4 can be installed on the poppy using <code>brew install shark</code> . <br><br><blockquote>  It‚Äôs time to point out that the article deals with version 2.3.4 of the library.  The project itself is already far from 2.3.4, <a href="http://image.diku.dk/shark/sphinx_pages/build/html/index.html">beta version 3.0</a> is currently available.  The code for the new version has been significantly reworked, using <a href="http://www.boost.org/">boost</a> as a third-party library, so this is a completely different story, especially in the context of iOS. </blockquote><br><br>  Let's return to the second part of the plan.  After training, I have a file with neural network coefficients in my hands.  The format of this file is not described anywhere (or I was looking badly), so the least expensive way to read and use it is with the same Shark, which means you need to port the library under iOS. <br><br><h4>  How? </h4><br>  The short answer is to take the sources and compile, the detailed answer is the article on Habr√©. <br><br>  Understandably, before writing on Habr, I first compiled the library and designed the whole thing as a <a href="https://github.com/mgrebenets/shark2-iosx">repository on GitHub</a> .  Therefore, for clarity, I will spice up the post with pieces of code from the build script. <br><br>  The whole process can be broken down into the following steps. <br><ul><li>  Download source code </li><li>  Patch source code </li><li>  Configure and build </li><li>  Make a "thick" library </li><li>  Pack in a framework </li><li>  Publish to CocoaPods </li></ul><br><br>  Yes, precisely, we will not just build a ‚Äúfat‚Äù (aka ‚Äúfat‚Äù or fat) static library for developing for iOS devices and a simulator (and separately for OSX), we will also design everything as a framework and make it available through <a href="http://beta.cocoapods.org/%3Fq%3Dshark-sdk">CocoaPods</a> . <br><br>  Well, let's get started, step by step. <br><br><h5>  Download source code </h5><br>  Everything is simple, I will not go into much detail so that it does not work out too chewed, download and unpack the archive. <br><div class="spoiler">  <b class="spoiler_title">Download and unpack</b> <div class="spoiler_text"><pre> <code class="bash hljs">VERSION=2.3.4 SHARK_ZIP=shark-<span class="hljs-variable"><span class="hljs-variable">$VERSION</span></span>.zip <span class="hljs-comment"><span class="hljs-comment"># --- download() { if [ ! -s $SHARK_ZIP ]; then echo Downloading shark source code $SHARK_ZIP... curl -L --progress-bar -o $SHARK_ZIP "http://sourceforge.net/projects/shark-project/files/Shark%20Core/Shark%20${VERSION}/shark-${VERSION}.zip/download" else echo Source code $SHARK_ZIP already downloaded... fi doneSection } SRC_DIR=src # --- unpackSource() { echo Unpacking $SHARK_ZIP to $SRC_DIR... [ -d $SRC_DIR ] || unzip -q $SHARK_ZIP -d $SRC_DIR [ -d $SRC_DIR ] &amp;&amp; echo " ...unpacked as $SRC_DIR" doneSection }</span></span></code> </pre><br></div></div><br><br><h5>  Patch source code </h5><br>  Initially, the code was developed using gcc 4.2, but we are trying to compile it using clang version 5.0.  Since the release of gcc 4.2, compilers and the C ++ standard have gone far ahead, so there is nothing surprising in the fact that some pieces of code will not like clang.  Nothing remains but to fix, i.e.  patch the problem code. <br><br><h6>  Default constructor </h6><br>  The first time the compiler stumbles on line 78 in the <code>ReClaM/EarlyStopping.cpp</code> . <br><pre> <code class="cpp hljs">EarlyStopping::EarlyStopping(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> sl = <span class="hljs-number"><span class="hljs-number">5</span></span>)</code> </pre><br>  The constructor of <code>EarlyStopping</code> has a single argument ( <code>unsigned sl</code> ) and the default value ( <code>5</code> ) is specified for this argument.  Thus, this constructor becomes the default constructor, ‚Äúso be it,‚Äù gcc 4.2 says, but clang has a completely different opinion on this.  On <a href="http://stackoverflow.com/">StackOverflow,</a> you can find a <a href="http://stackoverflow.com/questions/18313509/default-argument-gcc-vs-clang">discussion of</a> this error. <br><br>  We will correct ‚Äúin the forehead‚Äù, i.e.  just remove the default value. <br><pre> <code class="cpp hljs">EarlyStopping::EarlyStopping(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> sl)</code> </pre><br>  Wait a second!  - you say - but what if this constructor is used somewhere in the library code without an argument? <br>  Absolutely fair question.  Fortunately, this constructor is not invoked anywhere else in the code (both explicitly and implicitly), so there will be no harm from such a change, but you need to be careful when calling it in your code and be sure to pass the value for <code>sl</code> . <br><br><h6>  finite is not available for iOS </h6><br>  The next error is that the <code>finite(x)</code> function is not available (not included) for iOS, either for devices or for a simulator.  On the network, you can find references to this problem, for example <a href="http://createdigitalnoise.com/discussion/1754/can-t-compile-expr-with-xcode-4-5-2-same-project-works-in-xcode-4-4-1">here</a> . <br><br>  The solution is to use the <code>isfinite(x)</code> function.  Override <code>finite(x)</code> as <code>isfinite(x)</code> using preprocessing macros, to do this, add the following code to <code>SharkDefs.h</code> <br><div class="spoiler">  <b class="spoiler_title">SharkDefs.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> defined(__APPLE__) &amp;&amp; defined(__MACH__) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Apple OSX and iOS (Darwin). */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;TargetConditionals.h&gt; #if TARGET_IPHONE_SIMULATOR == 1 /* iOS in Xcode simulator */ #define finite(x) isfinite(x) #elif TARGET_OS_IPHONE == 1 /* iOS on iPhone, iPad, etc. */ #define finite(x) isfinite(x) // #define drem(x, y) remainder(x, y) #elif TARGET_OS_MAC == 1 /* OSX */ #endif #endif</span></span></span></span></code> </pre><br></div></div><br><br>  The logic here is the following, if we compile for one of Apple's operating systems, i.e.  <code>__APPLE__</code> and <code>__MACH__</code> , then we include the header file <code>TargetConditionals.h</code> , then we check the values <code>TARGET_IPHONE_SIMULATOR</code> , <code>TARGET_OS_IPHONE</code> and <code>TARGET_OS_MAC</code> , and redefine the <code>finite(x)</code> for the iOS device and simulator. <br><br>  Exactly the same problem with the <code>drem(x, y)</code> function, which needs to be replaced with <code>remainder(x, y)</code> .  However, Shark <code>drem(x, y)</code> does not use, so this is just a note of information. <br><br><h6>  FileUtil fixes </h6><br>  The following errors are related to the <code>FileUtil</code> module, namely the <code>FileUtil.h</code> file. <br><br>  At first, clang cannot find <code>iotype</code> type <code>iotype</code> and <code>SetDefault</code> , <code>ScanFrom</code> and <code>PrintTo</code> .  Let's give the compiler a hint using the namespace, i.e.  perform a simple replacement where needed <br><pre> <code class="cpp hljs">iotype -&gt; FileUtil::iotype SetDefault -&gt; FileUtil::SetDefault ScanFrom -&gt; FileUtil::ScanFrom PrintTo -&gt; FileUtil::PrintTo</code> </pre><br><br>  The last problem in this file is the <code>io_strict</code> function, which calls the <code>scanFrom_strict</code> and <code>printTo_strict</code> functions declared later. <br>  Decision?  Just move <code>io_strict</code> to the end of the file and there is no problem. <br><br><h6>  double erf (double) <s>throw ()</s> ; </h6><br>  Compiling <code>Mixture/MixtureOfGaussians.cpp</code> mark the following code as invalid <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">erf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">throw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre><br><br>  <code>extern "C"</code> declaration does not match the original prototype. <br>  In this case, the problem is solved by removing <code>throw()</code> . <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">erf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>;</code> </pre><br><br><blockquote>  I am aware that for some corrections I do not give a detailed explanation, such as removing <code>throw()</code> .  I would be happy to comment in the comments. </blockquote><br><br><h6>  RandomVector this-&gt; p </h6><br>  The next in line is the file <code>Mixture/RandomVector.h</code> , line 72. The compiler has no idea how to <code>Mixture/RandomVector.h</code> with <code>p</code> .  Also alarming is the comment to the code in this line ( <code>// !!!</code> ). <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> k = x.dim(<span class="hljs-number"><span class="hljs-number">0</span></span>); k--;) { l += <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(Shark::max(p(x[ k ]), <span class="hljs-number"><span class="hljs-number">1e-100</span></span>)); <span class="hljs-comment"><span class="hljs-comment">// !!! }</span></span></code> </pre><br>  After analyzing the code, I found this very <code>p</code> .  <code>RandomVector</code> inherits <code>RandomVar</code> , which declared the "lost" method <code>p</code> . <br><div class="spoiler">  <b class="spoiler_title">In search of p</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// RandomVar.h template &lt; class T &gt; class RandomVar { public: // *** virtual double p(const T&amp;) const = 0; // *** } // RandomVector.h template &lt; class T &gt; class RandomVector : public RandomVar&lt; Array&lt; T &gt; &gt; { public: // *** }</span></span></code> </pre><br></div></div><br><br>  The construction of <code>this-&gt;p</code> . <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> k = x.dim(<span class="hljs-number"><span class="hljs-number">0</span></span>); k--;) { l += <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(Shark::max(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;p(x[ k ]), <span class="hljs-number"><span class="hljs-number">1e-100</span></span>)); <span class="hljs-comment"><span class="hljs-comment">// !!! }</span></span></code> </pre><br><br><h6>  CMakeLists.txt </h6><br>  The last patch has nothing to do with compilation errors. <br>  Since we want to get a library for iOS, this library should be static, but the project will build a dynamic library by default.  To get the desired result, replace one line in the <code>CMakeLists.txt</code> file. <br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">ADD_LIBRARY</span></span>( shark SHARED <span class="hljs-variable"><span class="hljs-variable">${SRCS}</span></span> ) <span class="hljs-comment"><span class="hljs-comment">#   ADD_LIBRARY( shark STATIC ${SRCS} )</span></span></code> </pre><br>  In principle, you can not replace the line with ‚ÄúSHARED‚Äù, but simply add another one with ‚ÄúSTATIC‚Äù, then the dynamic and static libraries will be assembled as a result. <br><br><h6>  Apply patch </h6><br>  Of course, if you decide to repeat this process, it makes no sense to pick the code manually.  To save time and nerves there <a href="https://github.com/mgrebenets/shark2-iosx/blob/master/shark.patch">is a ready-made patch</a> . <br>  If you're interested, this patch is obtained using the <code>diff</code> utility. <br><pre> <code class="bash hljs">diff -crB shark_orig shark_patched &gt; shark.patch</code> </pre><br>  And to apply this patch, you need to use the utility, attention, <code>patch</code> <br><pre> <code class="bash hljs">SRC_DIR=src <span class="hljs-comment"><span class="hljs-comment"># --- patchSource() { echo Patching source code... patch -d $SRC_DIR/Shark -p1 --forward -r - -i ../../shark.patch doneSection }</span></span></code> </pre><br><br><h5>  Configure and build </h5><br>  Finally, the patches are over, you can proceed to the assembly directly. <br>  We will build the project with <code>make</code> , it remains only to configure everything correctly for each platform, this will be helped by the utility <code>cmake</code> (configure make), which will create a <code>Makefile</code> and other files needed by <code>make</code> .  We will have to configure and build the library 3 times, for the following platforms and architectures <br><ul><li>  iOS devices - <code>armv7</code> , <code>armv7s</code> , <code>arm64</code> architectures </li><li>  iOS simulator - <code>i386</code> and <code>x86_64</code> </li><li>  OSX - <code>x86_64</code> </li></ul><br><br><blockquote>  Yes, an important point, we will use Xcode 5. Support for the architecture of <code>armv6</code> officially removed from Xcode 5, so we don‚Äôt consider it at all. </blockquote><br><br>  Libraries for iOS devices and simulators, we will later merge into one ‚Äúthick‚Äù library, which can be used simultaneously for development on devices and simulators without unnecessary gestures. <br><br><h6>  Basics of cmake </h6><br>  So, <code>cmake</code> .  For each platform, we need to properly configure the environment using the following settings <br><ul><li>  <b>C ++ compiler</b> ( <code>CMAKE_CXX_COMPILER</code> ) <br>  The default is <code>/usr/bin/c++</code> , we also need to use <code>clang++</code> from the Xcode toolchain. </li><li>  <b>C ++ compiler flags</b> ( <code>CMAKE_CXX_FLAGS</code> ) <br>  It is with these flags that we will install the necessary architectures and other important compilation parameters. </li><li>  <b>C compiler</b> ( <code>CMAKE_C_COMPILER</code> ) <br>  Despite the lack of pure C code, it is still necessary to properly configure this parameter. </li><li>  <b>Root system directory</b> ( <code>CMAKE_OSX_SYSROOT</code> ) <br>  With this setting, we will tell the compiler where to look for all the standard system libraries for the selected platform. </li><li>  <b>Installation prefix</b> ( <code>CMAKE_INSTALL_PREFIX</code> ) <br>  This parameter is optional.  It is used by the <code>make install</code> command, but we will not do this. </li><li>  <b>Assembly file generator</b> ( <code>-G</code> flag) <br>  With this flag, we can choose one of many build systems.  In our case it will be ‚ÄúUnix Makefiles‚Äù, i.e.  <code>cmake</code> generate the familiar <code>Makefile</code> .  It would be logical to use the Xcode project, but I was not able to collect everything in this way. </li></ul><br><br><h6>  Xcode Toolkit </h6><br>  Maybe not the most successful translation of the term Toolchain, but certainly better than the "chain of tools."  Xcode contains all the tools we need (compilers, libraries for iPhone OS SDK and iPhone Simulator SDK, etc.) Clearly, Xcode should be installed, you also need to install the very same toolkit (Xcode Command Line Tools), you can do it in the settings of Xcode itself or using the <code>xcode-select --install</code> . <br><br>  Now use <code>xcode-select</code> to find all the necessary tools and directories. <br><div class="spoiler">  <b class="spoiler_title">Xcode Tools</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#     XCODE_ROOT=$(xcode-select -print-path) #   iPhone OS SDK XCODE_ARM_ROOT=$XCODE_ROOT/Platforms/iPhoneOS.platform/Developer #   iPhone Simulator SDK XCODE_SIM_ROOT=$XCODE_ROOT/Platforms/iPhoneSimulator.platform/Developer #    ,  ... XCODE_TOOLCHAIN_BIN=$XCODE_ROOT/Toolchains/XcodeDefault.xctoolchain/usr/bin # C++  CXX_COMPILER=${XCODE_TOOLCHAIN_BIN}/clang++ # C  C_COMPILER=${XCODE_TOOLCHAIN_BIN}/clang</span></span></code> </pre><br></div></div><br><br>  In the case of the Mac OS X SDK, <code>cmake</code> is smart enough to find the root system directory on its own, without further instructions. <br><br>  Next for each platform in order. <br><br>  <b>iOS devices (iPhone OS SDK)</b> <br>  We will collect in a separate folder, say <code>build/ios</code> . <br><br>  We already found compilers, now we will decide on flags for the C ++ compiler.  Since we will build for <code>armv7</code> , <code>armv7s</code> and <code>arm64</code> architectures, we will use the special <code>-arch</code> flag for <code>clang++</code> . <br><br>  All necessary system libraries for ARM architectures are located in the <code>SDKs/iPhoneOS7.0.sdk</code> subdirectory of <code>XCODE_ARM_ROOT</code> <br><pre> <code class="bash hljs">CXX_FLAGS=<span class="hljs-string"><span class="hljs-string">"-arch armv7 -arch armv7s -arch arm64"</span></span> SYSTEM_ROOT=<span class="hljs-variable"><span class="hljs-variable">${XCODE_ARM_ROOT}</span></span>/SDKs/iPhoneOS7.0.sdk</code> </pre><br><br>  The <code>cmake</code> call will look like this. <br><pre> <code class="bash hljs">mkdir -p build/ios <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> build/ios cmake \ -DCMAKE_CXX_COMPILER=<span class="hljs-variable"><span class="hljs-variable">$CXX_COMPILER</span></span> \ -DCMAKE_OSX_SYSROOT=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$SYSTEM_ROOT</span></span></span><span class="hljs-string">"</span></span> \ -DCMAKE_C_COMPILER=<span class="hljs-variable"><span class="hljs-variable">$C_COMPILER</span></span> \ -DCMAKE_CXX_FLAGS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$CXX_FLAGS</span></span></span><span class="hljs-string">"</span></span> \ -G <span class="hljs-string"><span class="hljs-string">"Unix Makefiles"</span></span> \ ../../src/Shark</code> </pre><br><br><blockquote>  By the way, <code>cmake</code> will do a lot of extra work for us.  We only need to specify C and C ++ compilers, <code>cmake</code> will find all other utilities from the same toolkit, for example, <code>ranlib</code> , <code>lipo</code> , <code>ld</code> , etc. </blockquote><br><br>  <b>iOS simulator (iPhone Simulator SDK)</b> <br>  Same compilers. <br><br>  The architecture we need at this time is <code>i386</code> and <code>x86_64</code> , the latter is needed for testing on a simulator of devices with 64-bit architecture, for example, ‚ÄúiPhone Retina (4-inch 64-bit)‚Äù. <br><br>  The required libraries are in <code>${XCODE_SIM_ROOT}/SDKs/iPhoneSimulator7.0.sdk</code> . <br><br>  And another very important point is that the code is collected for the simulator, and not OS X with the same architecture, the compiler should be given an additional prompt using the <code>-mios-simulator-version-min=7.0</code> flag <br><br><pre> <code class="bash hljs">mkdir -p build/sim <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> build/sim CXX_FLAGS=<span class="hljs-string"><span class="hljs-string">"-arch i386 -arch x86_64 -mios-simulator-version-min=7.0"</span></span> SYSTEM_ROOT=<span class="hljs-variable"><span class="hljs-variable">${XCODE_SIM_ROOT}</span></span>/SDKs/iPhoneSimulator7.0.sdk cmake \ -DCMAKE_CXX_COMPILER=<span class="hljs-variable"><span class="hljs-variable">$CXX_COMPILER</span></span> \ -DCMAKE_OSX_SYSROOT=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$SYSTEM_ROOT</span></span></span><span class="hljs-string">"</span></span> \ -DCMAKE_C_COMPILER=<span class="hljs-variable"><span class="hljs-variable">$C_COMPILER</span></span> \ -DCMAKE_CXX_FLAGS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$CXX_FLAGS</span></span></span><span class="hljs-string">"</span></span> \ -G <span class="hljs-string"><span class="hljs-string">"Unix Makefiles"</span></span> \ ../../src/Shark</code> </pre><br><br>  <b>Mac os x</b> <br>  Finally, Mac OS X. <br>  At this time, it suffices to specify only the C and C ++ compilers, <code>cmake</code> will find everything else itself. <br><pre> <code class="bash hljs">mkdir -p build/osx <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> build/osx cmake \ -DCMAKE_CXX_COMPILER=<span class="hljs-variable"><span class="hljs-variable">$CXX_COMPILER</span></span> \ -DCMAKE_C_COMPILER=<span class="hljs-variable"><span class="hljs-variable">$C_COMPILER</span></span> \ -G <span class="hljs-string"><span class="hljs-string">"Unix Makefiles"</span></span> \ ../../src/Shark</code> </pre><br><br><h6>  Tricks <code>cmake</code> </h6><br>  Well now let's do <code>make</code> !, - you think, but no. <br>  <code>cmake</code> has a couple of features to consider. <br><br>  <b>Compiler test</b> <br>  First, the very first run <code>cmake</code> runs a test for C and C ++ compilers.  Oddly enough, clang and clang ++ successfully fail this test for iOS platforms.  On the Internet, there are several recommendations on how to bypass this test, for example, in the <code>CMakeLists.txt</code> file, add <code>NONE</code> to the project description, but this did not help me. <br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">PROJECT</span></span>( shark NONE )</code> </pre><br><br>  The way that worked for me is to first run <code>cmake</code> without specifying clang and clang ++ compilers and other options.  <code>cmake</code> generate a <code>CMakeCache.txt</code> file and a <code>CMakeFiles</code> directory.  If you now run <code>cmake</code> with different settings, the compilers test will not be executed this time. <br><br>  <b>Configuration change</b> <br>  So, you need to run <code>cmake</code> at least 2 times - you will think again. <br>  And again - no. <br><br>  If important parameters, such as C and C ++ compilers, were changed during the next start, the changes will not take effect immediately.  <code>cmake</code> will issue a warning and advise you to run it again.  In fact, <code>cmake</code> will not say anything like that, but the <code>ccmake</code> utility <code>ccmake</code> provide more information.  <code>ccmake</code> is a console graphic interface for <code>cmake</code> . <br><br>  Generally <br><ul><li>  Once <code>cmake</code> , without parameters to pass the test </li><li>  Two <code>cmake</code> , with the necessary parameters </li><li>  Three <code>cmake</code> to make changes take effect. </li></ul><br><br><h6>  make </h6><br>  Yes, you can now perform the coveted <code>make</code> .  To make things go faster, you can parallelize the assembly using the <code>-j</code> flag. <br><pre> <code class="bash hljs">make -j16</code> </pre><br>  This process will not take much time, as a result we will have the static library <code>libshark.a</code> in our hands.  For every fireman, with the help of the <code>file</code> utility, make sure that the resulting libraries support all the necessary architectures. <br><div class="spoiler">  <b class="spoiler_title">Fat check</b> <div class="spoiler_text"><pre> <code class="bash hljs">$ file build/ios/libshark.a build/ios/libshark.a: Mach-O universal binary with 3 architectures build/ios/libshark.a (<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> architecture armv7): current ar archive random library build/ios/libshark.a (<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> architecture armv7s): current ar archive random library build/ios/libshark.a (<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> architecture cputype (16777228) cpusubtype (0)): current ar archive random library $ file build/sim/libshark.a build/sim/libshark.a: Mach-O universal binary with 2 architectures build/sim/libshark.a (<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> architecture i386): current ar archive random library build/sim/libshark.a (<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> architecture x86_64): current ar archive random library $ file build/osx/libshark.a build/osx/libshark.a: current ar archive random library</code> </pre><br></div></div><br><br><h5>  Make a "thick" library </h5><br>  Libraries for iOS devices and a simulator need to be combined into one ‚Äúthick‚Äù library. <br><br>  It's all quite simple, the <code>lipo</code> utility will cope with this task <code>lipo</code> <br><pre> <code class="bash hljs">mkdir -p lib/ios <span class="hljs-variable"><span class="hljs-variable">$XCODE_TOOLCHAIN_BIN</span></span>/lipo -create build/ios/libshark.a build/sim/libshark.a -o lib/ios/libshark.a</code> </pre><br>  Just in case, check the resulting library ( <code>file lib/ios/libshark.a</code> ) to make sure that all 5 architectures are in place. <br><br><h5>  Pack in a framework </h5><br>  The time has come to carefully pack the library in the form of a framework.  The framework directory is often referred to as a ‚Äúbundle‚Äù. <br><br><h6>  Create a bundle </h6><br>  At this stage, we will create the <code>Shark.framework</code> directory and the necessary folder structure inside, with all the necessary symbolic links, using <code>mkdir</code> and <code>ln</code> for this. <br><pre> <code class="bash hljs">Shark.framework/ ‚îú‚îÄ‚îÄ Documentation -&gt; Versions/Current/Documentation ‚îú‚îÄ‚îÄ Headers -&gt; Versions/Current/Headers ‚îú‚îÄ‚îÄ Resources -&gt; Versions/Current/Resources ‚îî‚îÄ‚îÄ Versions ‚îú‚îÄ‚îÄ A ‚îÇ ‚îú‚îÄ‚îÄ Documentation ‚îÇ ‚îú‚îÄ‚îÄ Headers ‚îÇ ‚îî‚îÄ‚îÄ Resources ‚îî‚îÄ‚îÄ Current -&gt; A</code> </pre><br><br><h6>  Copy the library </h6><br>  Now we will copy the static library inside the bundle, while renaming it to <code>Shark</code> . <br><pre> <code class="bash hljs">cp build/ios/libshark.a Shark.framework/Versions/A/Shark</code> </pre><br><br><h6>  Copy Header Files </h6><br>  Next, copy all <code>.h</code> files from the <code>src/Shark/include</code> to the <code>Headers</code> folder inside the bundle.  Then remove the unnecessary <code>statistics.h</code> .  This file is not needed at least because there is no corresponding <code>INSTALL</code> command in the <code>CMakeLists.txt</code> file. <br><pre> <code class="bash hljs">cp -r src/Shark/include/* Shark.framework/Headers/ rm Shark.framework/Headers/statistics.h</code> </pre><br><br>  <b>Patch header files</b> <br>  It would seem that heders copied everything, but again everything is not so obvious.  If you try to use the framework right now, it will pop up several obscure errors related to the paths to the header files.  And if in the case of the dynamic library under OS X I managed to get around the problem using the Header Search Path, then in the case of the framework, everything is not so simple. <br><br>  Since the Shark developers have not taken care of the correct paths for the <code>#include</code> directives, we will have to do this work for them. <br><br>  In search of the right approach, I turned my attention to an example of a well-organized library, namely - boost.  All paths in the <code>#include</code> directives for boost components start with <code>boost/</code> , for example <pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"boost/config.hpp"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;boost/type_traits/remove_reference.hpp&gt;</span></span></span></span></code> </pre><br><br>  Use the <code>sed</code> editor and patch files using the following rules for all <code>#include</code> directives <br><ul><li>  Add the missing space in "#include &lt;something&gt;" and "#include" something "" (yes, there were such) </li><li>  <code>SharkDefs.h</code> with <code>Shark/SharkDefs.h</code> </li><li>  Add <code>Shark/</code> in the path for all components of the library </li></ul><br><br>  Components here mean subdirectories of the <code>Headers</code> folder, i.e.  <code>Array, Rng, LinAlg, FileUtil, EALib, MOO-EALib, ReClaM, Mixture, TimeSeries, Fuzzy</code> . <br><br><div class="spoiler">  <b class="spoiler_title">Patch .h files</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#     "invalid character sequence" export LC_TYPE=C export LANG=C #     #include  #    SharkDefs.h #      #  -E     ,       "gnu vs non-gnu sed" components="Array|Rng|LinAlg|FileUtil|EALib|MOO-EALib|ReClaM|Mixture|TimeSeries|Fuzzy" find Shark.framework/Headers -type f -exec \ sed -E -i '' \ -e "s,#include([&lt;\"]),#include \1,g" \ -e "s,#include([ \t])([&lt;\"])(SharkDefs.h),#include\1\2Shark/\3,g" \ -e "s,#include([ \t])([&lt;\"])(${components}/),#include\1\2Shark/\3,g" \ {} +</span></span></code> </pre><br></div></div><br><br><h6>  Create an Info.plist </h6><br>  The last step in creating the framework is to create the appropriate Info.plist.  Important properties are the name and version of the framework. <br><div class="spoiler">  <b class="spoiler_title">Create Info.plist</b> <div class="spoiler_text"><pre> <code class="bash hljs">FRAMEWORK_NAME=Shark FRAMEWORK_CURRENT_VERSION=2.3.4 cat &gt; Shark.framework/Resources/Info.plist &lt;&lt;EOF &lt;?xml version=<span class="hljs-string"><span class="hljs-string">"1.0"</span></span> encoding=<span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>?&gt; &lt;!DOCTYPE plist PUBLIC <span class="hljs-string"><span class="hljs-string">"-//Apple//DTD PLIST 1.0//EN"</span></span> <span class="hljs-string"><span class="hljs-string">"http://www.apple.com/DTDs/PropertyList-1.0.dtd"</span></span>&gt; &lt;plist version=<span class="hljs-string"><span class="hljs-string">"1.0"</span></span>&gt; &lt;dict&gt; &lt;key&gt;CFBundleDevelopmentRegion&lt;/key&gt; &lt;string&gt;English&lt;/string&gt; &lt;key&gt;CFBundleExecutable&lt;/key&gt; &lt;string&gt;<span class="hljs-variable"><span class="hljs-variable">${FRAMEWORK_NAME}</span></span>&lt;/string&gt; &lt;key&gt;CFBundleIdentifier&lt;/key&gt; &lt;string&gt;dk.diku.image&lt;/string&gt; &lt;key&gt;CFBundleInfoDictionaryVersion&lt;/key&gt; &lt;string&gt;6.0&lt;/string&gt; &lt;key&gt;CFBundlePackageType&lt;/key&gt; &lt;string&gt;FMWK&lt;/string&gt; &lt;key&gt;CFBundleSignature&lt;/key&gt; &lt;string&gt;????&lt;/string&gt; &lt;key&gt;CFBundleVersion&lt;/key&gt; &lt;string&gt;<span class="hljs-variable"><span class="hljs-variable">${FRAMEWORK_CURRENT_VERSION}</span></span>&lt;/string&gt; &lt;/dict&gt; &lt;/plist&gt; EOF</code> </pre><br></div></div><br><br><blockquote>  Before the release of iOS 7, namely, devices with the <code>arm64</code> architecture, it was possible to create universal static libraries, and therefore frameworks, simultaneously for iOS and OSX, including a simulator.  Nothing prevented packing <code>armv6, armv7, armv7s, i386</code> and <code>x86_64</code> into one bold library.  Devices with 64-bit architecture confused all the cards.  In a ‚Äúthick‚Äù library, there cannot be two layers with the same architecture, which means you cannot get <code>x86_64</code> for iOS simulator of 64-bit devices and <code>x86_64</code> for OS X. </blockquote><br><br><h5>  Publish to CocoaPods </h5><br>  Right now, you can take a ready-made framework and safely add it to your projects, but I want to automate this stage too.  This is exactly what <a href="http://cocoapods.org/">CocoaPods is for</a> .  If for some reason you are behind the train and are not using CocoaPods yet, it's time to pay attention to this project. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating a specification for the hearth is another story. </font><font style="vertical-align: inherit;">Despite the fact that I almost painted every little thing up to this point, here I refer to the finished result.</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Shark-SDK.podspec</font></font></b> <div class="spoiler_text"><pre> <code class="ruby hljs">Pod::Spec.new <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|s|</span></span> s.name = <span class="hljs-string"><span class="hljs-string">'Shark-SDK'</span></span> s.version = <span class="hljs-string"><span class="hljs-string">'2.3.4'</span></span> s.license = { <span class="hljs-symbol"><span class="hljs-symbol">:type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'GPLv2'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:text</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'See https://sourceforge.net/directory/license:gpl/'</span></span> } s.summary = <span class="hljs-string"><span class="hljs-string">'iOS &amp; OS X framework for Shark: C++ Machine Learning Library'</span></span> s.description = &lt;&lt;-DESC SHARK provides libraries <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the design of adaptive systems, including methods <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> linear <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> nonlinear optimization (eg, evolutionary <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> gradient-based algorithms), kernel-based algorithms <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> neural networks, <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> other machine learning techniques. DESC s.homepage = <span class="hljs-string"><span class="hljs-string">'https://sourceforge.net/projects/shark-project/'</span></span> s.author = { <span class="hljs-string"><span class="hljs-string">'shark-admin'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'https://sourceforge.net/u/shark-admin/profile/'</span></span> } s.source = { <span class="hljs-symbol"><span class="hljs-symbol">:http</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'https://github.com/mgrebenets/shark2-iosx/releases/download/v2.3.4/Shark-SDK.tgz'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:type</span></span> =&gt; <span class="hljs-symbol"><span class="hljs-symbol">:tgz</span></span> } s.ios.vendored_frameworks = <span class="hljs-string"><span class="hljs-string">"Shark-iOS-SDK/Shark.framework"</span></span> s.osx.vendored_frameworks = <span class="hljs-string"><span class="hljs-string">"Shark-OSX-SDK/Shark.framework"</span></span> s.ios.deployment_target = <span class="hljs-string"><span class="hljs-string">'6.0'</span></span> s.osx.deployment_target = <span class="hljs-string"><span class="hljs-string">'10.7'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And an example of use. </font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Podfile</font></font></b> <div class="spoiler_text"><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># Podfile platform :ios, :deployment_target =&gt; '6.0' pod 'Shark-SDK' target :'shark2-osx-demo', :exclusive =&gt; true do platform :osx, :deployment_target =&gt; '10.7' pod 'Shark-SDK' end</span></span></code> </pre><br></div></div><br><br><h4>  Results </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, if you suddenly come up with yourself some kind of task, the result of which, to put it mildly, is not guaranteed, try to do something anyway. </font><font style="vertical-align: inherit;">You never know what new skills will be able to pump as a result.</font></font></div><p>Source: <a href="https://habr.com/ru/post/208052/">https://habr.com/ru/post/208052/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../208040/index.html">As a programmer has come to the site about fashion</a></li>
<li><a href="../208042/index.html">3d printers. Review of achievements for 2013</a></li>
<li><a href="../208044/index.html">Computer game "Noosphere" - suggestions for the scenario for the first levels</a></li>
<li><a href="../208048/index.html">Imperceptible difficulties of rocket technology</a></li>
<li><a href="../208050/index.html">COOLRF: recent history. Part one</a></li>
<li><a href="../208056/index.html">Authentication in Rails applications using Devise. Part 1: Basic Setup</a></li>
<li><a href="../208058/index.html">Video surveillance on the Raspberry Pi</a></li>
<li><a href="../208060/index.html">The true causes of blocking sites. Open Data Survey</a></li>
<li><a href="../208066/index.html">Another Enums implementation for Python</a></li>
<li><a href="../208068/index.html">The device is minimalistic landing pages</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>