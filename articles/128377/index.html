<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Realistic landscape in Ogre 3D</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hey. 
 After reading a few interesting articles on Habr√© about one of the most powerful Ogre3D render engines, I decided to share my experience in mod...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Realistic landscape in Ogre 3D</h1><div class="post__text post__text-html js-mediator-article">  Hey. <br>  After reading a <a href="http://habrahabr.ru/blogs/open_source/86017">few</a> <a href="http://habrahabr.ru/blogs/development/86207">interesting</a> <a href="http://habrahabr.ru/blogs/gdev/120638">articles</a> on <a href="http://ru.wikipedia.org/wiki/OGRE">Habr√©</a> about one of the most powerful <a href="http://ru.wikipedia.org/wiki/OGRE">Ogre3D</a> render engines, I decided to share my experience in modeling using it a realistic landscape with atmospheric effects, water surface and lush vegetation.  Under the cut - a recipe for screwing to Ogre all the necessary libraries. <br><a name="habracut"></a><br>  Looking ahead, the end result looks like this: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/e4d/f3b/9c1/e4df3b9c108562583c59a58d8578484b.png" height="311" width="400"></a> <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/f49/eb6/6ef/f49eb66ef2e7eddd56b3686083195636.png" height="311" width="400"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/ce1/98a/601/ce198a60120eda4b4e4267b27835d0c6.png" height="311" width="400"></a> <br><br>  Required libraries include: <br><ul><li>  <a href="http://www.ogre3d.org/tikiwiki/Caelum">Caelum</a> for atmospheric effects, namely sky and clouds; </li><li>  <a href="http://www.ogre3d.org/tikiwiki/Hydrax">Hydrax</a> for water surface; </li><li>  <a href="http://www.ogre3d.org/tikiwiki/PagedGeometry%2BEngine">Paged Geometry</a> for vegetation, including but not limited to trees, bushes and grass. </li></ul><br><h1>  Step One: Application Skeleton </h1><br>  As the skeleton of the application, we will use the slightly modified <a href="http://www.ogre3d.org/tikiwiki/Ogre%2BWiki%2BTutorial%2BFramework">Ogre Wiki Tutorial Framework</a> - a common framework for tutorials from the ogre wiki, since it is flexible enough to create applications of low complexity;  In addition, it includes quite a lot of functionality, in particular, camera movement on the WASD keys, mouse browsing, FPS counter and other useful things.  For compilation, I used Microsoft Visual C ++ 2008 and the CMake build system (the latter will allow compiling the project under any architecture supported by Ogre). <br>  I posted all the sources on <a href="https://github.com/lockie/Landscape">Github</a> (however, in order not to mess with git, you can download them at <a href="https://github.com/lockie/Landscape/zipball/master">this</a> address).  To compile, you will need to compile the 1.7 and <a href="http://www.cmake.org/cmake/resources/software.html">CMake</a> branches prepared in advance by the 2008 <a href="http://sourceforge.net/projects/ogre/files/ogre/1.7/OgreSDK_vc9_v1-7-2.exe/download">Ogre</a> studio;  in order for the latter to correctly locate Ogre, you need to add the <code>OGRE_HOME</code> environment variable equal to the directory in which it is installed. <br>  In addition, to run the test application you will need two archives: <a href="">media.zip</a> with textures, models and other necessary things, it will need to be unpacked directly into the project directory;  and the <a href="">configs.zip</a> containing the Ogre configuration files ‚Äî it needs to be unpacked into the build directory. <br>  To compile the project, first run the CMake GUI and select the directory with the project in the <i>Where is the source code</i> field, and arbitrary in the <i>Where to build the binaries</i> field, for example, you can select the project directory build subdirectory.  Then click the <i>Configure</i> button, select Visual Studio 2008 from the list of compilers, and if everything went fine and CMake didn‚Äôt complain about the absence of something, click <i>Generate</i> : <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/620/2b9/a0f/6202b9a0f2cac77f336ca8245af7ec3b.png" height="400" width="293"></a> <br><br>  As a result, the Visual Studio LandscapeApp.sln file-solution appears in the build directory, with which you can work directly - make changes to the code, compile and run a test project. <br>  Actually, after compiling and running, we are welcomed by the standard selection window of the Ogre rendering subsystem: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/b00/ad9/f80/b00ad9f80f35b6fa0f3c4b6c633b8e35.png" height="376" width="400"></a> <br><br>  Selecting, for example, <i>Direct3D9 Rendering Subsystem</i> as such, click OK and see a black window with a lonely FPS counter, which is clearly off scale - still, the scene is empty.  By the way, the counter can be minimized / expanded with the F key, so as not to interfere. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/000/c15/bd4/000c15bd41ffd524279274bddfa371ae.png" height="311" width="400"></a> <br><br>  Well, as one well-known politician said, ‚ÄúThe main thing is to begin!‚Äù <br><br><h1>  Step Two: Sky </h1><br>  Caelum is a GNU Lesser GPL-distributed plugin for Ogre to create photorealistic atmospheric effects, such as the color of the sky, the sun, the moon and the stars, taking into account the current time and coordinates of the observer, clouds, weather phenomena (rain, snow, fog), etc. d. <br>  Download the latest version of Caelum from the <a href="http://code.google.com/p/caelum/source/checkout">repository on Google Code</a> , because, judging by the <a href="http://www.ogre3d.org/addonforums/viewtopic.php%3Ff%3D21%26t%3D14202">messages on the forum</a> , this project has a new maintainer and some movement is observed - new features are added to the project and the old errors are corrected: <br><br> <code>hg clone https://code.google.com/p/caelum <br></code> <br>  To make it more convenient, I copied all the necessary sources into the test project tree, making small changes to correct the compiler warnings.  The authors of Caelum use the CMake build system, so its addition to our build system is limited to the line <br><blockquote> <code><font color="#008000">add_subdirectory</font> ( <font color="#BA2121">Caelum</font> ) <br></code> </blockquote><br>  in the CMakeLists.txt file, adding the <code>Caelum/main/include</code> and <code>${CMAKE_BINARY_DIR}/Caelum/main/include</code> subdirectories to the list of include directories via the <code>include_directories</code> command, and adding Caelum to the list of linked libraries through the <code>target_link_libraries</code> command: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><blockquote> <code><font color="#008000">include_directories</font> ( <font color="#666666">${</font> <font color="#19177C">OIS_INCLUDE_DIRS</font> <font color="#666666">}</font> <br> <font color="#666666">${</font> <font color="#19177C">OGRE_INCLUDE_DIRS</font> <font color="#666666">}</font> <br> <font color="#666666">${</font> <font color="#19177C">OGRE_SAMPLES_INCLUDEPATH</font> <font color="#666666">}</font> <br> <font color="#BA2121">"Caelum/main/include"</font> <br> <font color="#BA2121">"${CMAKE_BINARY_DIR}/Caelum/main/include"</font> <br> <font color="#408080"><em># ... <br></em></font> <font color="#008000">target_link_libraries</font> ( <font color="#BA2121">LandscapeApp</font> <font color="#666666">${</font> <font color="#19177C">OGRE_LIBRARIES</font> <font color="#666666">}</font> <font color="#666666">${</font> <font color="#19177C">OIS_LIBRARIES</font> <font color="#666666">}</font> <font color="#BA2121">Caelum</font> ) <br></code> </blockquote><br></div></div><br>  The code itself will require a bit more changes.  First, let's include the Caelum header file in our main header file, LandscapeApplication.hpp: <br><blockquote> <code><font color="#BC7A00">#include &lt;Caelum.h&gt; <br></font></code> </blockquote><br>  and include the corresponding namespace in the LandscapeApplication.cpp source file: <br><blockquote> <code><font color="#008000"><strong>using</strong></font> <font color="#008000"><strong>namespace</strong></font> Caelum; <br></code> </blockquote><br>  Further, Caelum itself is a set of separate components for rendering sky and atmosphere, which are controlled by the root class <code>CaelumSystem</code> .  This class controls all components and updates ( <i>update</i> ) their internal state when needed.  Create an instance of this class, to do this, add a pointer to it in our <code>LandscapeApplication</code> root class: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><blockquote> <code><font color="#008000"><strong>class</strong></font> <font color="#0000FF"><strong>LandscapeApplication</strong></font> <font color="#666666">:</font> <font color="#008000"><strong>public</strong></font> BaseApplication <br> { <br> <font color="#408080"><em>// ... <br></em></font> <font color="#008000"><strong>protected</strong></font> <font color="#666666">:</font> <br> <font color="#008000"><strong>virtual</strong></font> <font color="#B00040">void</font> createScene( <font color="#B00040">void</font> ); <br> Caelum <font color="#666666">::</font> CaelumSystem <font color="#666666">*</font> mCaelumSystem; <br> }; <br></code> </blockquote><br></div></div><br>  And call the constructor in the <code>createScene</code> method: <br><blockquote> <code><font color="#B00040">void</font> LandscapeApplication <font color="#666666">::</font> createScene( <font color="#B00040">void</font> ) <br> { <br> mCaelumSystem <font color="#666666">=</font> <font color="#008000"><strong>new</strong></font> CaelumSystem(mRoot, mSceneMgr, CaelumSystem <font color="#666666">::</font> CAELUM_COMPONENTS_DEFAULT); <br></code> </blockquote><br>  The most important is the last parameter, which is a <a href="http://caelum.sourceforge.net/doc/trunk/html/classCaelum_1_1CaelumSystem.html">bitmask</a> that indicates which Caelum components we will use.  <code>CAELUM_COMPONENTS_DEFAULT</code> is the default set, it includes all stable components. <br>  <code>CaelumSystem</code> and its components have a huge number of settings, most of which are accessible from the code as <code>get/set</code> methods and described in the <a href="http://caelum.sourceforge.net/doc/trunk/html">documentation</a> ;  Another more obvious way of tuning is the <a href="http://ogitor.org/">Ogitor</a> 3D editor, created specifically for Ogre and supporting all the libraries described in this article (and some not described): <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/145/06b/a8d/14506ba8d2302e2639635a9bee49ae2f.png" height="309" width="400"></a> <br><br>  The final touch - to change the atmospheric effects over time, you need to update the Caelum every frame;  all you need to do is add our copy of CaelumSystem to the <a href="http://www.ogre3d.org/tikiwiki/Basic%2BTutorial%2B4">Frame Listener</a> list and Ogre <a href="http://www.ogre3d.org/docs/api/html/classOgre_1_1RenderTargetListener.html">Render Target Listener</a> list: <br><blockquote> <code>mCaelumSystem <font color="#666666">=</font> <font color="#008000"><strong>new</strong></font> CaelumSystem(mRoot, mSceneMgr, CaelumSystem <font color="#666666">::</font> CAELUM_COMPONENTS_DEFAULT); <br> mRoot <font color="#666666">-&gt;</font> addFrameListener(mCaelumSystem); <br> mWindow <font color="#666666">-&gt;</font> addListener(mCaelumSystem); <br></code> </blockquote><br>  Voila - we are greeted by a blue sky with the sun slowly setting for sunset, sparse clouds and gray fog: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/382/4ce/d60/3824ced6047749dc51e4a18ea909f378.png" height="311" width="400"></a> <br><br>  Let's tweak some of the parameters of Caelum for more entertainment: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><blockquote> <code><font color="#408080"><em>// ... <br></em></font> mWindow <font color="#666666">-&gt;</font> addListener(mCaelumSystem); <br> <br> mCaelumSystem <font color="#666666">-&gt;</font> getUniversalClock() <font color="#666666">-&gt;</font> setTimeScale( <font color="#666666">100</font> ); <font color="#408080"><em>//     <br></em></font> FlatCloudLayer <font color="#666666">*</font> cloudLayer <font color="#666666">=</font> <font color="#408080"><em>//     , <br></em></font> mCaelumSystem <font color="#666666">-&gt;</font> getCloudSystem() <font color="#666666">-&gt;</font> createLayer(); <font color="#408080"><em>// : <br></em></font> cloudLayer <font color="#666666">-&gt;</font> setCloudCover( <font color="#666666">0.8f</font> ); <font color="#408080"><em>//   <br></em></font> cloudLayer <font color="#666666">-&gt;</font> setCloudSpeed(Vector2( <font color="#666666">0.0001f</font> , <font color="#666666">0.0001f</font> )); <font color="#408080"><em>//   <br></em></font> cloudLayer <font color="#666666">-&gt;</font> setHeight( <font color="#666666">5000</font> ); <font color="#408080"><em>//   </em></font> <br></code> </blockquote><br></div></div><br>  As a result, the sky looks like this: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/1dc/4f7/62d/1dc4f762db05a824db198b342c69eb4b.png" height="311" width="400"></a> <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/fe9/46e/8c1/fe946e8c1fa32b6747c34b8be33b3bf3.png" height="311" width="400"></a> <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/fd3/1e9/487/fd31e948768977ea8d8eb3b38a869dd7.png" height="311" width="400"></a> <br><br>  The time has come to add the surface of the earth to our application so that the sun and moon will have where to go. <br><br><h1>  Step Three: Earth </h1><br>  We will use the native Ogrov terrain system ( <a href="http://www.ogre3d.org/tikiwiki/Ogre%2BTerrain%2BSystem">Ogre Terrain System</a> ) subsystem to add a ground surface to our application.  This system was created in 2009 by the creator of Ogre <a href="http://www.ogre3d.org/tikiwiki/User%253ASinbad">Steve Striting</a> to replace outdated terrain rendering add-ons and is a completely separate optional component (however, from version 1.7 included in the Ogre distribution).  Ogre Terrain System includes everything you need both to create small test applications like ours, and for huge worlds loaded into memory in individual small pieces of pages - for more information about this you can read on the ogre forum, for example, <a href="http://www.ogre3d.org/forums/viewtopic.php%3Ff%3D2%26t%3D60456">here</a> ;  Moreover, one of the GSoC'11 projects is the <a href="http://www.ogre3d.org/tikiwiki/SoC2011%2BTerrain%2BPaging%2BImprovements">improvement of the page load mechanism</a> . <br>  First of all, let's let CMake know about our intentions: in the CMakeLists.txt file, add <code>${OGRE_Terrain_LIBRARIES}</code> to the list of linked libraries via the <code>target_link_libraries</code> command: <br><blockquote> <code><font color="#008000">target_link_libraries</font> ( <font color="#BA2121">LandscapeApp</font> <font color="#666666">${</font> <font color="#19177C">OGRE_LIBRARIES</font> <font color="#666666">}</font> <font color="#666666">${</font> <font color="#19177C">OGRE_Terrain_LIBRARIES</font> <font color="#666666">}</font> <font color="#666666">${</font> <font color="#19177C">OIS_LIBRARIES</font> <font color="#666666">}</font> <font color="#BA2121">Caelum</font> ) <br></code> </blockquote><br>  Now we <code>LandscapeApplication::createScene</code> add to the <code>LandscapeApplication::createScene</code> code to load one page of the terrain (taken by me from the Terrain example in Ogre), almost identical to the code from <a href="http://www.ogre3d.org/tikiwiki/Basic%2BTutorial%2B3">Ogre Basic Tutorial 3</a> : <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><blockquote> <code>mCamera <font color="#666666">-&gt;</font> setPosition(Vector3( <font color="#666666">1683</font> , <font color="#666666">50</font> , <font color="#666666">2116</font> )); <font color="#408080"><em>//   <br></em></font> mCamera <font color="#666666">-&gt;</font> lookAt(Vector3( <font color="#666666">1963</font> , <font color="#666666">50</font> , <font color="#666666">1660</font> )); <br> <br> Vector3 lightdir( <font color="#666666">0.55f</font> , <font color="#666666">-0.3f</font> , <font color="#666666">0.75f</font> ); <font color="#408080"><em>//      <br></em></font> lightdir.normalise(); <br> Light <font color="#666666">*</font> light <font color="#666666">=</font> mSceneMgr <font color="#666666">-&gt;</font> createLight( <font color="#BA2121">"tstLight"</font> ); <br> light <font color="#666666">-&gt;</font> setType(Light <font color="#666666">::</font> LT_DIRECTIONAL); <br> light <font color="#666666">-&gt;</font> setDirection(lightdir); <br> light <font color="#666666">-&gt;</font> setDiffuseColour(ColourValue <font color="#666666">::</font> White); <br> light <font color="#666666">-&gt;</font> setSpecularColour(ColourValue( <font color="#666666">0.4f</font> , <font color="#666666">0.4f</font> , <font color="#666666">0.4f</font> )); <br> <br> mTerrainGlobals <font color="#666666">=</font> OGRE_NEW TerrainGlobalOptions; <font color="#408080"><em>//    <br></em></font> mTerrainGroup <font color="#666666">=</font> OGRE_NEW TerrainGroup(mSceneMgr, <font color="#408080"><em>//    <br></em></font> Terrain <font color="#666666">::</font> ALIGN_X_Z, <font color="#666666">513</font> , <font color="#666666">12000</font> ); <br> mTerrainGroup <font color="#666666">-&gt;</font> setOrigin(Vector3 <font color="#666666">::</font> ZERO); <br> mTerrainGlobals <font color="#666666">-&gt;</font> setLightMapDirection(light <font color="#666666">-&gt;</font> getDerivedDirection()); <br> mTerrainGlobals <font color="#666666">-&gt;</font> setCompositeMapAmbient(mSceneMgr <font color="#666666">-&gt;</font> getAmbientLight()); <br> mTerrainGlobals <font color="#666666">-&gt;</font> setCompositeMapDiffuse(light <font color="#666666">-&gt;</font> getDiffuseColour()); <br> mSceneMgr <font color="#666666">-&gt;</font> destroyLight( <font color="#BA2121">"tstLight"</font> ); <br> <br> mTerrainGroup <font color="#666666">-&gt;</font> defineTerrain( <font color="#666666">0</font> , <font color="#666666">0</font> ); <font color="#408080"><em>//        (0, 0) <br></em></font> mTerrainGroup <font color="#666666">-&gt;</font> loadAllTerrains( <font color="#008000"><strong>true</strong></font> ); <font color="#408080"><em>// ,        <br></em></font> mTerrainGroup <font color="#666666">-&gt;</font> freeTemporaryResources(); <font color="#408080"><em>// </em></font> <br></code> </blockquote><br></div></div><br>  And, of course, <code>mTerrainGlobals</code> and <code>mTerrainGroup</code> pointers to our main class: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><blockquote> <code><font color="#BC7A00">#include &lt;Terrain/OgreTerrain.h&gt; <br> #include &lt;Terrain/OgreTerrainGroup.h&gt; <br></font> <br> <font color="#008000"><strong>class</strong></font> <font color="#0000FF"><strong>LandscapeApplication</strong></font> <font color="#666666">:</font> <font color="#008000"><strong>public</strong></font> BaseApplication <br> { <br> <font color="#408080"><em>// ... <br></em></font> <font color="#008000"><strong>protected</strong></font> <font color="#666666">:</font> <br> <font color="#408080"><em>// ... <br></em></font> Ogre <font color="#666666">::</font> TerrainGlobalOptions <font color="#666666">*</font> mTerrainGlobals; <br> Ogre <font color="#666666">::</font> TerrainGroup <font color="#666666">*</font> mTerrainGroup; <br> }; <br></code> </blockquote><br></div></div><br>  If no special parameters are specified, the page with the coordinate (0, 0) will be loaded from the file terrain_00000000.dat, which I added to the above-mentioned <a href="">archive media.zip</a> . <br>  The result is not long in coming: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/4bf/a50/f5d/4bfa50f5d2c99147bd61ee66592e5420.png" height="311" width="400"></a> <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/3d5/e2b/e02/3d5e2be025e7e185c46d4212d3167168.png" height="311" width="400"></a> <br><br><h1>  Step Four: Water </h1><br>  The most widely used library for rendering water surfaces using a <a href="http://uraldev.ru/articles/id/35/page/3">projection grid</a> in Ogre - Hydrax, is distributed under the GNU Lesser GPL license. <br>  Downloading <a href="http://www.ogre3d.org/addonforums/viewtopic.php%3Ff%3D20%26t%3D8391">from here</a> (link at the bottom of the first post) archive, for further work, you will need the Hydrax-v0.5.1 / Hydrax / src / Hydrax directory from it, which I copied to the test project tree. <br>  Unfortunately, Hydrax does not support the CMake build system, so I had to write the Hydrax / CMakeLists.txt file for it, which, however, is only slightly more complicated than simply listing the sources and header files.  To integrate Hydrax into the build system, mainly CMakeLists.txt, add the following: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><blockquote> <code><font color="#008000">include_directories</font> ( <br> <font color="#408080"><em># ... <br></em></font> <font color="#BA2121">"Hydrax"</font> <br> ) <br> <font color="#008000">add_subdirectory</font> ( <font color="#BA2121">Hydrax</font> ) <br> <font color="#408080"><em># ... <br></em></font> <font color="#008000">target_link_libraries</font> ( <font color="#BA2121">LandscapeApp</font> <font color="#666666">${</font> <font color="#19177C">OGRE_LIBRARIES</font> <font color="#666666">}</font> <font color="#666666">${</font> <font color="#19177C">OGRE_Terrain_LIBRARIES</font> <font color="#666666">}</font> <font color="#666666">${</font> <font color="#19177C">OIS_LIBRARIES</font> <font color="#666666">}</font> <font color="#BA2121">Caelum</font> <font color="#BA2121">Hydrax</font> ) <br></code> </blockquote><br></div></div><br>  Further, to add water effects to our application, you need a properly initialized instance of the class <code>Hydrax::Hydrax</code> : <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><blockquote> <code><font color="#408080"><em>//   LandscapeApplication.hpp <br></em></font> <font color="#008000"><strong>class</strong></font> <font color="#0000FF"><strong>LandscapeApplication</strong></font> <font color="#666666">:</font> <font color="#008000"><strong>public</strong></font> BaseApplication <br> { <br> <font color="#408080"><em>// ... <br></em></font> <font color="#008000"><strong>protected</strong></font> <font color="#666666">:</font> <br> <font color="#408080"><em>// ... <br></em></font> Hydrax <font color="#666666">::</font> Hydrax <font color="#666666">*</font> mHydrax; <br> }; <br> <br> <font color="#408080"><em>//   LandscapeApplication.cpp <br></em></font> <font color="#B00040">void</font> LandscapeApplication <font color="#666666">::</font> createScene( <font color="#B00040">void</font> ) <br> { <br> <font color="#408080"><em>// ... <br></em></font> mHydrax <font color="#666666">=</font> <font color="#008000"><strong>new</strong></font> Hydrax <font color="#666666">::</font> Hydrax(mSceneMgr, mCamera, mWindow <font color="#666666">-&gt;</font> getViewport( <font color="#666666">0</font> )); <br> Hydrax <font color="#666666">::</font> Module <font color="#666666">::</font> ProjectedGrid <font color="#666666">*</font> mModule <font color="#666666">=</font> <font color="#008000"><strong>new</strong></font> Hydrax <font color="#666666">::</font> Module <font color="#666666">::</font> ProjectedGrid( <font color="#408080"><em>//    <br></em></font> mHydrax, <font color="#408080"><em>//     Hydrax <br></em></font> <font color="#008000"><strong>new</strong></font> Hydrax <font color="#666666">::</font> Noise <font color="#666666">::</font> Perlin( <font color="#408080"><em>/*    */</em></font> ), <font color="#408080"><em>//     <br></em></font> Ogre <font color="#666666">::</font> Plane(Ogre <font color="#666666">::</font> Vector3( <font color="#666666">0</font> , <font color="#666666">1</font> , <font color="#666666">0</font> ), Ogre <font color="#666666">::</font> Vector3( <font color="#666666">0</font> , <font color="#666666">0</font> , <font color="#666666">0</font> )), <font color="#408080"><em>//   <br></em></font> Hydrax <font color="#666666">::</font> MaterialManager <font color="#666666">::</font> NM_VERTEX, <font color="#408080"><em>//    <br></em></font> Hydrax <font color="#666666">::</font> Module <font color="#666666">::</font> ProjectedGrid <font color="#666666">::</font> Options( <font color="#666666">64</font> )); <font color="#408080"><em>//   <br></em></font> mHydrax <font color="#666666">-&gt;</font> setModule(mModule); <br> mHydrax <font color="#666666">-&gt;</font> loadCfg( <font color="#BA2121">"HydraxDemo.hdx"</font> ); <br> mHydrax <font color="#666666">-&gt;</font> create(); <br> } <br></code> </blockquote><br></div></div><br>  Running our application, we see an unexpected picture: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/c47/7e0/438/c477e0438431ddb5b26d880e53b0da75.png" height="311" width="400"></a> <br><br>  Instead of water, some kind of ink.  What happened? <br>  The fact is that Caelum fits the Ogre options associated with the fog so that they most closely match the atmospheric model used in the Caelum.  However, these options do not allow the water from Hydrax to render correctly.  <code>mCaelumSystem-&gt;setGlobalFogDensityMultiplier(0.01)</code> Caelum options a bit (namely, by saying <code>mCaelumSystem-&gt;setGlobalFogDensityMultiplier(0.01)</code> , i.e. reducing the fog density), you can make sure that the water created by Hydrax is actually in place: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/323/491/dcc/323491dcc9082767612433db544c0591.png" height="311" width="400"></a> <br><br>  Careful adjustment of fog parameters is beyond the scope of this article, so in our test application we simply turn off the fog: <br><blockquote> <code><font color="#B00040">void</font> LandscapeApplication <font color="#666666">::</font> createScene( <font color="#B00040">void</font> ) <br> { <br> <font color="#408080"><em>// ... <br></em></font> cloudLayer <font color="#666666">-&gt;</font> setHeight( <font color="#666666">5000</font> ); <br> mCaelumSystem <font color="#666666">-&gt;</font> setManageSceneFog(Ogre <font color="#666666">::</font> FOG_NONE); <br></code> </blockquote><br>  Here we are waiting for the following surprise: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/3c8/e3e/2c3/3c8e3e2c30887af147cbf3de947ec89c.png" height="311" width="400"></a> <br><br>  This unflattering picture is the result of the fact that the landscape that we added in the third step is not an ordinary <a href="http://www.ogre3d.org/docs/api/html/classOgre_1_1Entity.html">Ogre <i>entity</i></a> , so Hydrax does not take it into account when calculating the water surface.  To remedy this situation, it is enough to add <a href="http://www.ogre3d.org/docs/manual/manual_15.html">the</a> depth <a href="http://www.ogre3d.org/docs/manual/manual_15.html">technique</a> to the landscape material: <br><blockquote> <code><font color="#B00040">void</font> LandscapeApplication <font color="#666666">::</font> createScene( <font color="#B00040">void</font> ) <br> { <br> <font color="#408080"><em>// ... <br></em></font> mHydrax <font color="#666666">-&gt;</font> create(); <br> <br> mHydrax <font color="#666666">-&gt;</font> getMaterialManager() <font color="#666666">-&gt;</font> addDepthTechnique( <br> mTerrainGroup <font color="#666666">-&gt;</font> getTerrain( <font color="#666666">0</font> , <font color="#666666">0</font> ) <font color="#666666">-&gt;</font> getMaterial() <font color="#666666">-&gt;</font> createTechnique()); <br></code> </blockquote><br>  As a result, we get the following pleasing picture: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/6f9/7bf/712/6f97bf7127b4ecee8c0b1969a934c89f.png" height="311" width="400"></a> <br><br>  Carefully observing our application, we can conclude that Caelum and Hydrax do not even realize that each other exists - for example, after sunset and <a href="http://ru.wikipedia.org/wiki/%25D0%259A%25D0%25B0%25D1%2583%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25B0">caustics</a> remain on the water before the moon rises, which cannot be physically possible: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/dc3/660/5b4/dc36605b4b67573620881e8c9869dca4.png" height="311" width="400"></a> <br><br>  In addition, the location of the sun flare on the water does not correspond to the actual position of the sun, moreover, the flare remains even after its setting: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/46b/5ec/0c8/46b5ec0c800a3a0f2207609916f1e533.png" height="311" width="400"></a> <br><br>  To solve this problem, use the slightly modified <a href="http://tracker.ogitor.org/projects/ogitor/changeset/view/2142">code</a> responsible for integrating Caelum and Hydrax from the above Ogitor editor: <br><div class="spoiler">  <b class="spoiler_title">Cat</b> <div class="spoiler_text"><blockquote> <code><font color="#408080"><em>//   LandscapeApplication.hpp <br></em></font> <font color="#008000"><strong>class</strong></font> <font color="#0000FF"><strong>LandscapeApplication</strong></font> <font color="#666666">:</font> <font color="#008000"><strong>public</strong></font> BaseApplication <br> { <br> <font color="#408080"><em>// ... <br></em></font> <font color="#008000"><strong>protected</strong></font> <font color="#666666">:</font> <br> <font color="#008000"><strong>virtual</strong></font> <font color="#B00040">bool</font> frameEnded( <font color="#008000"><strong>const</strong></font> Ogre <font color="#666666">::</font> FrameEvent <font color="#666666">&amp;</font> evt); <br> Ogre <font color="#666666">::</font> Vector3 mOriginalWaterColor; <br> <br> <font color="#408080"><em>//   LandscapeApplication.cpp <br></em></font> <font color="#B00040">void</font> LandscapeApplication <font color="#666666">::</font> createScene( <font color="#B00040">void</font> ) <br> { <br> <font color="#408080"><em>// ... <br></em></font> mHydrax <font color="#666666">-&gt;</font> loadCfg( <font color="#BA2121">"HydraxDemo.hdx"</font> ); <br> mOriginalWaterColor <font color="#666666">=</font> mHydrax <font color="#666666">-&gt;</font> getWaterColor(); <br> <font color="#408080"><em>// ... <br></em></font> <br> <font color="#B00040">bool</font> LandscapeApplication <font color="#666666">::</font> frameEnded( <font color="#008000"><strong>const</strong></font> Ogre <font color="#666666">::</font> FrameEvent <font color="#666666">&amp;</font> evt) <br> { <br> Vector3 value <font color="#666666">=</font> mCaelumSystem <font color="#666666">-&gt;</font> getSun() <font color="#666666">-&gt;</font> getSceneNode() <font color="#666666">-&gt;</font> _getDerivedPosition(); <br> ColourValue cval <font color="#666666">=</font> mCaelumSystem <font color="#666666">-&gt;</font> getSun() <font color="#666666">-&gt;</font> getBodyColour(); <br> mHydrax <font color="#666666">-&gt;</font> setSunPosition(value); <br> mHydrax <font color="#666666">-&gt;</font> setSunColor(Vector3(cval.r,cval.g,cval.b)); <br> Caelum <font color="#666666">::</font> LongReal mJulian <font color="#666666">=</font> mCaelumSystem <font color="#666666">-&gt;</font> getUniversalClock() <font color="#666666">-&gt;</font> getJulianDay(); <br> cval <font color="#666666">=</font> mCaelumSystem <font color="#666666">-&gt;</font> getSunLightColour(mJulian, <br> mCaelumSystem <font color="#666666">-&gt;</font> getSunDirection(mJulian)); <br> mHydrax <font color="#666666">-&gt;</font> setWaterColor(Vector3(cval.r <font color="#666666">-</font> <font color="#666666">0.3</font> , cval.g <font color="#666666">-</font> <font color="#666666">0.2</font> , cval.b)); <br> Vector3 col <font color="#666666">=</font> mHydrax <font color="#666666">-&gt;</font> getWaterColor(); <br> <font color="#B00040">float</font> height <font color="#666666">=</font> mHydrax <font color="#666666">-&gt;</font> getSunPosition().y <font color="#666666">/</font> <font color="#666666">10.0f</font> ; <br> Hydrax <font color="#666666">::</font> HydraxComponent c <font color="#666666">=</font> mHydrax <font color="#666666">-&gt;</font> getComponents(); <br> <font color="#008000"><strong>if</strong></font> (height <font color="#666666">&lt;</font> <font color="#666666">0</font> ) <br> { <br> <font color="#008000"><strong>if</strong></font> (mHydrax <font color="#666666">-&gt;</font> isComponent(Hydrax <font color="#666666">::</font> HYDRAX_COMPONENT_CAUSTICS)) <br> mHydrax <font color="#666666">-&gt;</font> setComponents(Hydrax <font color="#666666">::</font> HydraxComponent( <br> c <font color="#666666">^</font> Hydrax <font color="#666666">::</font> HYDRAX_COMPONENT_CAUSTICS)); <br> } <font color="#008000"><strong>else</strong></font> { <br> <font color="#008000"><strong>if</strong></font> ( <font color="#666666">!</font> mHydrax <font color="#666666">-&gt;</font> isComponent(Hydrax <font color="#666666">::</font> HYDRAX_COMPONENT_CAUSTICS)) <br> mHydrax <font color="#666666">-&gt;</font> setComponents(Hydrax <font color="#666666">::</font> HydraxComponent( <br> c <font color="#666666">|</font> Hydrax <font color="#666666">::</font> HYDRAX_COMPONENT_CAUSTICS)); <br> } <br> <font color="#008000"><strong>if</strong></font> (height <font color="#666666">&lt;</font> <font color="#666666">-99.0f</font> ) <br> { <br> col <font color="#666666">=</font> mOriginalWaterColor <font color="#666666">*</font> <font color="#666666">0.1f</font> ; <br> height <font color="#666666">=</font> <font color="#666666">9999.0f</font> ; <br> } <br> <font color="#008000"><strong>else</strong></font> <font color="#008000"><strong>if</strong></font> (height <font color="#666666">&lt;</font> <font color="#666666">1.0f</font> ) <br> { <br> col <font color="#666666">=</font> mOriginalWaterColor <font color="#666666">*</font> ( <font color="#666666">0.1f</font> <font color="#666666">+</font> ( <font color="#666666">0.009f</font> <font color="#666666">*</font> (height <font color="#666666">+</font> <font color="#666666">99.0f</font> ))); <br> height <font color="#666666">=</font> <font color="#666666">100.0f</font> <font color="#666666">/</font> (height <font color="#666666">+</font> <font color="#666666">99.001f</font> ); <br> } <br> <font color="#008000"><strong>else</strong></font> <font color="#008000"><strong>if</strong></font> (height <font color="#666666">&lt;</font> <font color="#666666">2.0f</font> ) <br> { <br> col <font color="#666666">+=</font> mOriginalWaterColor; <br> col <font color="#666666">/=</font> <font color="#666666">2.0f</font> ; <br> <font color="#B00040">float</font> percent <font color="#666666">=</font> (height <font color="#666666">-</font> <font color="#666666">1.0f</font> ); <br> col <font color="#666666">=</font> (col <font color="#666666">*</font> percent) <font color="#666666">+</font> (mOriginalWaterColor <font color="#666666">*</font> ( <font color="#666666">1.0f</font> <font color="#666666">-</font> percent)); <br> } <br> <font color="#008000"><strong>else</strong></font> <br> { <br> col <font color="#666666">+=</font> mOriginalWaterColor; <br> col <font color="#666666">/=</font> <font color="#666666">2.0f</font> ; <br> } <br> mHydrax <font color="#666666">-&gt;</font> setWaterColor(col); <br> mHydrax <font color="#666666">-&gt;</font> setSunArea(height); <br> mHydrax <font color="#666666">-&gt;</font> update(evt.timeSinceLastFrame); <br> <font color="#008000"><strong>return</strong></font> <font color="#008000"><strong>true</strong></font> ; <br> } <br></code> </blockquote><br></div></div><br>  As a result, we get a romantic sunset and ... a couple of new artifacts: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/015/fb7/6a5/015fb76a58cc6fad02b460343f4fde2f.png" height="311" width="400"></a> <br><br>  First, when moving the camera on the horizon, long white stripes appear and disappear.  This happens because the water surface intersects with the <i>far clipping plane</i> ( <i>far clipping plane</i> ) at a fairly close distance, which gives rise to visible artifacts.  The solution to this problem is nowhere easier; it is enough to increase the distance to this plane: <br><blockquote> <code>mCamera <font color="#666666">-&gt;</font> setFarClipDistance( <font color="#666666">1000000</font> ); <br></code> </blockquote><br>  Secondly, the lower part of the sun, "gone" under the water, which should not be seen at all, has glaring white edges.  The root of this problem is the same as that of the landscape problem: the sun (and the moon) are not ordinary Ogre objects;  to correct it, you also need to add a depth technique to the material of these objects.  The best place for this is the Sun.material and moon.material files in the media / Caelum directory;  it is necessary to add the following paragraph to each material described in these files: <br><blockquote> <code>technique HydraxDepth <br> { <br> scheme HydraxDepth <br> pass <br> { <br> lighting off <br> texture_unit <br> { <br> colour_op_ex modulate src_manual src_current <font color="#666666">0</font> <font color="#666666">0</font> <font color="#666666">0</font> <br> } <br> } <br> } <br></code> </blockquote><br>  Archive media_fixed.zip with all necessary fixes can be downloaded <a href="">here</a> .  After launching the application, everything falls into place with them: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/33f/4a5/9a0/33f4a59a04f22665925dcefe21c06fc8.png" height="311" width="400"></a> <br><br><h1>  Step Five: Vegetation </h1><br>  The final touch is to add some flora to our cozy landscape.  The Ogre Paged Geometry Engine library is best suited for this, because it allows you to render huge amounts of small meshes over long distances, which is especially valuable for building, for example, a forest scene with trees, bushes, grass, stones, and so on.  This library is distributed under one of the most liberal among the free licenses - MIT (like Ogre itself). <br>  The latest version of Paged Geometry can be downloaded to <a href="http://code.google.com/p/ogre-paged/downloads/list">this address</a> ; again, I copied all the necessary files into the source tree of the test project.  The library supports CMake, so you need to add just a few lines to our CMakeLists.txt: the location of the header files, the location of the library file and the location of the library sources themselves: <br><blockquote> <code><font color="#008000">include_directories</font> ( <br> <font color="#408080"><em># ... <br></em></font> <font color="#BA2121">"PagedGeometry/include"</font> <br> <font color="#BA2121">"${CMAKE_BINARY_DIR}/PagedGeometry/include"</font> <br> <br> <font color="#408080"><em># ... <br></em></font> <font color="#008000">add_subdirectory</font> ( <font color="#BA2121">PagedGeometry</font> ) <br> <font color="#408080"><em># ... <br></em></font> <font color="#008000">target_link_libraries</font> ( <font color="#BA2121">LandscapeApp</font> <font color="#666666">${</font> <font color="#19177C">OGRE_LIBRARIES</font> <font color="#666666">}</font> <font color="#666666">${</font> <font color="#19177C">OGRE_Terrain_LIBRARIES</font> <font color="#666666">}</font> <font color="#666666">${</font> <font color="#19177C">OIS_LIBRARIES</font> <font color="#666666">}</font> <br> <font color="#BA2121">Caelum</font> <font color="#BA2121">Hydrax</font> <font color="#BA2121">PagedGeometry</font> ) <br></code> </blockquote><br>  Further, in our application, we limit ourselves to adding three types of objects: <br><ol><li>  herbs; </li><li>  trees; </li><li>  other vegetation (bushes, flowers and mushrooms). </li></ol><br>  To do this, we add pointers to instances of the <code>Forests::PagedGeometry</code> key class (and auxiliary <code>Forests::GrassLoader</code> ) to our main class, not forgetting the <code>Forests::GrassLoader</code> files for this: <br><blockquote> <code><font color="#BC7A00">#include &lt;PagedGeometry.h&gt; <br> #include &lt;GrassLoader.h&gt; <br></font> <br> <font color="#008000"><strong>class</strong></font> <font color="#0000FF"><strong>LandscapeApplication</strong></font> <font color="#666666">:</font> <font color="#008000"><strong>public</strong></font> BaseApplication <br> { <br> <font color="#408080"><em>// ... <br></em></font> <font color="#008000"><strong>protected</strong></font> <font color="#666666">:</font> <br> <font color="#408080"><em>// ... <br></em></font> Forests <font color="#666666">::</font> PagedGeometry <font color="#666666">*</font> grass, <font color="#666666">*</font> trees, <font color="#666666">*</font> bushes; <br> Forests <font color="#666666">::</font> GrassLoader <font color="#666666">*</font> grassLoader; <br> }; <br></code> </blockquote><br>  Then we initialize these pointers with zeros, modifying the <code>LandscapeApplication</code> constructor as follows: <br><blockquote> <code>LandscapeApplication <font color="#666666">::</font> LandscapeApplication( <font color="#B00040">void</font> ) <font color="#666666">:</font> grass( <font color="#008000">NULL</font> ), trees( <font color="#008000">NULL</font> ), bushes( <font color="#008000">NULL</font> ) <br> { <br> } <br></code> </blockquote><br>  In addition, we need a function that returns the height of the landscape at a point with given x and z coordinates;  by calling this function, Paged Geometry will correctly place all its props on the ground.  You will need exactly the function, not the class method, since  the class pointer is implicitly passed to the class methods, which the library will simply nowhere to get.  Therefore, we need a global variable ‚Äî a pointer to the class that controls the landscape page group, for the connection between the landscape itself and our function.  Well, we realize our plans: <br><blockquote> <code><font color="#008000"><strong>static</strong></font> TerrainGroup <font color="#666666">*</font> terrainGroup <font color="#666666">=</font> <font color="#008000">NULL</font> ; <br> <br> <font color="#008000"><strong>static</strong></font> <font color="#B00040">float</font> getTerrainHeight( <font color="#B00040">float</font> x, <font color="#B00040">float</font> z, <font color="#B00040">void</font> <font color="#666666">*</font> userData) <br> { <br> OgreAssert(terrainGroup, <font color="#BA2121">"Terrain isn't initialized"</font> ); <br> <font color="#008000"><strong>return</strong></font> terrainGroup <font color="#666666">-&gt;</font> getHeightAtWorldPosition(x, <font color="#666666">0</font> , z); <br> } <br></code> </blockquote><br>  Since this variable is initially <code>NULL</code> , it is necessary to initialize it with a pointer to an instance of the <code>TerrainGroup</code> class, which we will do with the following line after the landscape initialization code in the <code>createScene</code> method: <br><blockquote> <code>terrainGroup <font color="#666666">=</font> mTerrainGroup; <br></code> </blockquote><br>  Finally, you can now add initialization code for all the objects we need to the <code>createScene</code> method: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><blockquote> <code><font color="#408080"><em>//  <br></em></font> grass <font color="#666666">=</font> <font color="#008000"><strong>new</strong></font> PagedGeometry(mCamera); <br> grass <font color="#666666">-&gt;</font> addDetailLevel <font color="#666666">&lt;</font> GrassPage <font color="#666666">&gt;</font> ( <font color="#666666">160</font> ); <font color="#408080"><em>//  :     60    <br></em></font> grassLoader <font color="#666666">=</font> <font color="#008000"><strong>new</strong></font> GrassLoader(grass); <br> grass <font color="#666666">-&gt;</font> setPageLoader(grassLoader); <br> grassLoader <font color="#666666">-&gt;</font> setHeightFunction(getTerrainHeight); <font color="#408080"><em>// ,       <br></em></font> GrassLayer <font color="#666666">*</font> l <font color="#666666">=</font> grassLoader <font color="#666666">-&gt;</font> addLayer( <font color="#BA2121">"3D-Diggers/plant1sprite"</font> ); <font color="#408080"><em>//    <br></em></font> l <font color="#666666">-&gt;</font> setMinimumSize( <font color="#666666">0.9f</font> , <font color="#666666">0.9f</font> ); <font color="#408080"><em>// ... <br></em></font> l <font color="#666666">-&gt;</font> setMaximumSize( <font color="#666666">2</font> , <font color="#666666">2</font> ); <font color="#408080"><em>//  ...    <br></em></font> l <font color="#666666">-&gt;</font> setAnimationEnabled( <font color="#008000"><strong>true</strong></font> ); <font color="#408080"><em>//   <br></em></font> l <font color="#666666">-&gt;</font> setSwayDistribution( <font color="#666666">7.0f</font> ); <font color="#408080"><em>//     <br></em></font> l <font color="#666666">-&gt;</font> setSwayLength( <font color="#666666">0.1f</font> ); <font color="#408080"><em>//   - 0.1  <br></em></font> l <font color="#666666">-&gt;</font> setSwaySpeed( <font color="#666666">0.4f</font> ); <font color="#408080"><em>//   <br></em></font> l <font color="#666666">-&gt;</font> setDensity( <font color="#666666">3.0f</font> ); <font color="#408080"><em>//   <br></em></font> l <font color="#666666">-&gt;</font> setRenderTechnique(GRASSTECH_SPRITE); <font color="#408080"><em>//     <br></em></font> l <font color="#666666">-&gt;</font> setFadeTechnique(FADETECH_GROW); <font color="#408080"><em>//        <br></em></font> l <font color="#666666">-&gt;</font> setColorMap( <font color="#BA2121">"terrain_texture2.jpg"</font> ); <font color="#408080"><em>//    <br></em></font> l <font color="#666666">-&gt;</font> setDensityMap( <font color="#BA2121">"densitymap.png"</font> ); <font color="#408080"><em>//   <br></em></font> l <font color="#666666">-&gt;</font> setMapBounds(TBounds( <font color="#666666">0</font> , <font color="#666666">0</font> , <font color="#666666">3000</font> , <font color="#666666">3000</font> )); <font color="#408080"><em>//   <br></em></font> <font color="#408080"><em>//  <br></em></font> trees <font color="#666666">=</font> <font color="#008000"><strong>new</strong></font> PagedGeometry(mCamera); <br> trees <font color="#666666">-&gt;</font> addDetailLevel <font color="#666666">&lt;</font> WindBatchPage <font color="#666666">&gt;</font> ( <font color="#666666">150</font> , <font color="#666666">30</font> ); <font color="#408080"><em>//      150  180  <br></em></font> trees <font color="#666666">-&gt;</font> addDetailLevel <font color="#666666">&lt;</font> ImpostorPage <font color="#666666">&gt;</font> ( <font color="#666666">900</font> , <font color="#666666">50</font> ); <font color="#408080"><em>//       900  950  <br></em></font> TreeLoader2D <font color="#666666">*</font> treeLoader <font color="#666666">=</font> <font color="#008000"><strong>new</strong></font> TreeLoader2D(trees, TBounds( <font color="#666666">0</font> , <font color="#666666">0</font> , <font color="#666666">5000</font> , <font color="#666666">5000</font> )); <br> trees <font color="#666666">-&gt;</font> setPageLoader(treeLoader); <br> treeLoader <font color="#666666">-&gt;</font> setHeightFunction(getTerrainHeight); <font color="#408080"><em>// ,       <br></em></font> treeLoader <font color="#666666">-&gt;</font> setColorMap( <font color="#BA2121">"terrain_lightmap.jpg"</font> ); <font color="#408080"><em>//    <br></em></font> Entity <font color="#666666">*</font> tree1 <font color="#666666">=</font> mSceneMgr <font color="#666666">-&gt;</font> createEntity( <font color="#BA2121">"Tree1"</font> , <font color="#BA2121">"fir05_30.mesh"</font> ); <font color="#408080"><em>//    <br></em></font> Entity <font color="#666666">*</font> tree2 <font color="#666666">=</font> mSceneMgr <font color="#666666">-&gt;</font> createEntity( <font color="#BA2121">"Tree2"</font> , <font color="#BA2121">"fir14_25.mesh"</font> ); <br> trees <font color="#666666">-&gt;</font> setCustomParam(tree1 <font color="#666666">-&gt;</font> getName(), <font color="#BA2121">"windFactorX"</font> , <font color="#666666">15</font> ); <font color="#408080"><em>//   <br></em></font> trees <font color="#666666">-&gt;</font> setCustomParam(tree1 <font color="#666666">-&gt;</font> getName(), <font color="#BA2121">"windFactorY"</font> , <font color="#666666">0.01f</font> ); <br> trees <font color="#666666">-&gt;</font> setCustomParam(tree2 <font color="#666666">-&gt;</font> getName(), <font color="#BA2121">"windFactorX"</font> , <font color="#666666">22</font> ); <br> trees <font color="#666666">-&gt;</font> setCustomParam(tree2 <font color="#666666">-&gt;</font> getName(), <font color="#BA2121">"windFactorY"</font> , <font color="#666666">0.013f</font> ); <br> <font color="#408080"><em>//    5000   <br></em></font> Vector3 position <font color="#666666">=</font> Vector3 <font color="#666666">::</font> ZERO; <br> Radian yaw; <br> Real scale; <br> <font color="#008000"><strong>for</strong></font> ( <font color="#B00040">int</font> i <font color="#666666">=</font> <font color="#666666">0</font> ; i <font color="#666666">&lt;</font> <font color="#666666">5000</font> ; i <font color="#666666">++</font> ) <br> { <br> yaw <font color="#666666">=</font> Degree(Math <font color="#666666">::</font> RangeRandom( <font color="#666666">0</font> , <font color="#666666">360</font> )); <br> position.x <font color="#666666">=</font> Math <font color="#666666">::</font> RangeRandom( <font color="#666666">0</font> , <font color="#666666">2000</font> ); <font color="#408080"><em>//  Y  , ..   <br></em></font> position.z <font color="#666666">=</font> Math <font color="#666666">::</font> RangeRandom( <font color="#666666">2300</font> , <font color="#666666">4000</font> ); <font color="#408080"><em>//    - getTerrainHeight,   <br></em></font> scale <font color="#666666">=</font> Math <font color="#666666">::</font> RangeRandom( <font color="#666666">0.07f</font> , <font color="#666666">0.12f</font> ); <br> <font color="#008000"><strong>if</strong></font> (Math <font color="#666666">::</font> UnitRandom() <font color="#666666">&lt;</font> <font color="#666666">0.5f</font> ) <br> { <br> <font color="#008000"><strong>if</strong></font> (Math <font color="#666666">::</font> UnitRandom() <font color="#666666">&lt;</font> <font color="#666666">0.5f</font> ) <br> treeLoader <font color="#666666">-&gt;</font> addTree(tree1, position, yaw, scale); <br> } <br> <font color="#008000"><strong>else</strong></font> <br> treeLoader <font color="#666666">-&gt;</font> addTree(tree2, position, yaw, scale); <br> } <br> <font color="#408080"><em>// / <br></em></font> bushes <font color="#666666">=</font> <font color="#008000"><strong>new</strong></font> PagedGeometry(mCamera); <br> bushes <font color="#666666">-&gt;</font> addDetailLevel <font color="#666666">&lt;</font> WindBatchPage <font color="#666666">&gt;</font> ( <font color="#666666">80</font> , <font color="#666666">50</font> ); <br> TreeLoader2D <font color="#666666">*</font> bushLoader <font color="#666666">=</font> <font color="#008000"><strong>new</strong></font> TreeLoader2D(bushes, TBounds( <font color="#666666">0</font> , <font color="#666666">0</font> , <font color="#666666">5000</font> , <font color="#666666">5000</font> )); <br> bushes <font color="#666666">-&gt;</font> setPageLoader(bushLoader); <br> bushLoader <font color="#666666">-&gt;</font> setHeightFunction(getTerrainHeight); <br> bushLoader <font color="#666666">-&gt;</font> setColorMap( <font color="#BA2121">"terrain_lightmap.jpg"</font> ); <br> Entity <font color="#666666">*</font> fern <font color="#666666">=</font> mSceneMgr <font color="#666666">-&gt;</font> createEntity( <font color="#BA2121">"Fern"</font> , <font color="#BA2121">"farn1.mesh"</font> ); <font color="#408080"><em>//    <br></em></font> Entity <font color="#666666">*</font> plant <font color="#666666">=</font> mSceneMgr <font color="#666666">-&gt;</font> createEntity( <font color="#BA2121">"Plant"</font> , <font color="#BA2121">"plant2.mesh"</font> ); <font color="#408080"><em>//    <br></em></font> Entity <font color="#666666">*</font> mushroom <font color="#666666">=</font> mSceneMgr <font color="#666666">-&gt;</font> createEntity( <font color="#BA2121">"Mushroom"</font> , <font color="#BA2121">"shroom1_1.mesh"</font> ); <font color="#408080"><em>//    <br></em></font> bushes <font color="#666666">-&gt;</font> setCustomParam(fern <font color="#666666">-&gt;</font> getName(), <font color="#BA2121">"factorX"</font> , <font color="#666666">1</font> ); <font color="#408080"><em>//   <br></em></font> bushes <font color="#666666">-&gt;</font> setCustomParam(fern <font color="#666666">-&gt;</font> getName(), <font color="#BA2121">"factorY"</font> , <font color="#666666">0.01f</font> ); <br> bushes <font color="#666666">-&gt;</font> setCustomParam(plant <font color="#666666">-&gt;</font> getName(), <font color="#BA2121">"factorX"</font> , <font color="#666666">0.6f</font> ); <br> bushes <font color="#666666">-&gt;</font> setCustomParam(plant <font color="#666666">-&gt;</font> getName(), <font color="#BA2121">"factorY"</font> , <font color="#666666">0.02f</font> ); <br> <font color="#408080"><em>//    20000     <br></em></font> <font color="#008000"><strong>for</strong></font> ( <font color="#B00040">int</font> i <font color="#666666">=</font> <font color="#666666">0</font> ; i <font color="#666666">&lt;</font> <font color="#666666">20000</font> ; i <font color="#666666">++</font> ) <br> { <br> yaw <font color="#666666">=</font> Degree(Math <font color="#666666">::</font> RangeRandom( <font color="#666666">0</font> , <font color="#666666">360</font> )); <br> position.x <font color="#666666">=</font> Math <font color="#666666">::</font> RangeRandom( <font color="#666666">0</font> , <font color="#666666">2000</font> ); <br> position.z <font color="#666666">=</font> Math <font color="#666666">::</font> RangeRandom( <font color="#666666">2300</font> , <font color="#666666">4000</font> ); <br> <font color="#008000"><strong>if</strong></font> (Math <font color="#666666">::</font> UnitRandom() <font color="#666666">&lt;</font> <font color="#666666">0.8f</font> ) { <br> scale <font color="#666666">=</font> Math <font color="#666666">::</font> RangeRandom( <font color="#666666">0.3f</font> , <font color="#666666">0.4f</font> ); <br> bushLoader <font color="#666666">-&gt;</font> addTree(fern, position, yaw, scale); <br> } <font color="#008000"><strong>else</strong></font> <font color="#008000"><strong>if</strong></font> (Math <font color="#666666">::</font> UnitRandom() <font color="#666666">&lt;</font> <font color="#666666">0.9</font> ) { <br> scale <font color="#666666">=</font> Math <font color="#666666">::</font> RangeRandom( <font color="#666666">0.2f</font> , <font color="#666666">0.6f</font> ); <br> bushLoader <font color="#666666">-&gt;</font> addTree(mushroom, position, yaw, scale); <br> } <font color="#008000"><strong>else</strong></font> { <br> scale <font color="#666666">=</font> Math <font color="#666666">::</font> RangeRandom( <font color="#666666">0.3f</font> , <font color="#666666">0.5f</font> ); <br> bushLoader <font color="#666666">-&gt;</font> addTree(plant, position, yaw, scale); <br> } <br> } <br></code> </blockquote><br></div></div><br>  ... and the code for finalizing the destructor <code>LandscapeApplication</code> : <br><div class="spoiler">  <b class="spoiler_title">Code finalization</b> <div class="spoiler_text"><blockquote> <code>LandscapeApplication <font color="#666666">::~</font> LandscapeApplication( <font color="#B00040">void</font> ) <br> { <br> <font color="#008000"><strong>if</strong></font> (grass) <br> { <br> <font color="#008000"><strong>delete</strong></font> grass <font color="#666666">-&gt;</font> getPageLoader(); <br> <font color="#008000"><strong>delete</strong></font> grass; <br> grass <font color="#666666">=</font> <font color="#008000">NULL</font> ; <br> } <br> <font color="#008000"><strong>if</strong></font> (trees) <br> { <br> <font color="#008000"><strong>delete</strong></font> trees <font color="#666666">-&gt;</font> getPageLoader(); <br> <font color="#008000"><strong>delete</strong></font> trees; <br> trees <font color="#666666">=</font> <font color="#008000">NULL</font> ; <br> } <br> <font color="#008000"><strong>if</strong></font> (bushes) <br> { <br> <font color="#008000"><strong>delete</strong></font> bushes <font color="#666666">-&gt;</font> getPageLoader(); <br> <font color="#008000"><strong>delete</strong></font> bushes; <br> bushes <font color="#666666">=</font> <font color="#008000">NULL</font> ; <br> } <br> mSceneMgr <font color="#666666">-&gt;</font> destroyEntity( <font color="#BA2121">"Tree1"</font> ); <br> mSceneMgr <font color="#666666">-&gt;</font> destroyEntity( <font color="#BA2121">"Tree2"</font> ); <br> mSceneMgr <font color="#666666">-&gt;</font> destroyEntity( <font color="#BA2121">"Fern"</font> ); <br> mSceneMgr <font color="#666666">-&gt;</font> destroyEntity( <font color="#BA2121">"Plant"</font> ); <br> mSceneMgr <font color="#666666">-&gt;</font> destroyEntity( <font color="#BA2121">"Mushroom"</font> ); <br> } <br></code> </blockquote><br></div></div><br>  (without this code, the application will crash when exiting). <br>  And the most important thing is that instances of the <code>Forests::PagedGeometry</code> need to call the <code>update()</code> method on each frame so that our forest is rendered, swaying smoothly under the gusts of virtual wind: <br><blockquote> <code><font color="#B00040">bool</font> LandscapeApplication <font color="#666666">::</font> frameEnded( <font color="#008000"><strong>const</strong></font> Ogre <font color="#666666">::</font> FrameEvent <font color="#666666">&amp;</font> evt) <br> { <br> <font color="#408080"><em>// ... <br></em></font> grass <font color="#666666">-&gt;</font> update(); <br> trees <font color="#666666">-&gt;</font> update(); <br> bushes <font color="#666666">-&gt;</font> update(); <br> <font color="#008000"><strong>return</strong></font> <font color="#008000"><strong>true</strong></font> ; <br> } <br></code> </blockquote><br>  By running the application, we can observe the pastoral forest landscape: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/8dd/15b/5b1/8dd15b5b1893bccea1c4e47c422c9596.png" height="311" width="400"></a> <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/693/f55/863/693f55863c00aa0b307f2ca974148267.png" height="311" width="400"></a> <br><br>  ... good, no pitfalls waiting for us here.  The only thing you should pay attention to is a drop in performance: despite many techniques for improving performance (starting from the banal <a href="http://ru.wikipedia.org/wiki/Level_of_Detail">LOD</a> and ending with a pagination mechanism similar to that in the landscape subsystem and replacing real trees with sprites at long distances), Paged Geometry is all still requires careful adjustment of the number of displayed instances of vegetation and image quality.  Here again, we can recommend using the Ogitor editor, which has the support of Paged Geometry, allowing you to easily sketch vegetation in the right places (like brushing with Paint in Paint) and adjust all the necessary parameters. <br><br>  A fully compiled and ready-to-run test project can be downloaded <a href="">here</a> . <br><br>  In gratitude to all who read to this place - a couple more nice screenshots: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/e06/70e/8b6/e0670e8b6da6170ce78be56d35ced8d1.png" height="311" width="400"></a> <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/ca6/6c7/d4f/ca66c7d4f8be140a7c2cf74e718a3069.png" height="311" width="400"></a> <br><br>  And the video (it was not made by me, but it was created using the libraries in question - Ogre, Hydrax and Caelum): <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/TzPpZ1HK-FY&amp;xid=17259,15700021,15700043,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhMYBJ1LHlHBhH5o43F9UskH4VQjQ" frameborder="0" allowfullscreen=""></iframe><br><br>  I also want to thank Sergey <a href="https://habrahabr.ru/users/viruscd/" class="user_link">ViruScD Habrayuzer</a> for his help in preparing the article, Andrew <a href="https://habrahabr.ru/users/engine9/" class="user_link">Engine9</a> for his help in working with the Ogre engine and the creators of the site <a href="http://dumpz.org/">dumpz.org</a> for the excellent syntax highlighting. <br><br>  <b>UPD</b> : I took screenshots with anti-aliasing <a href="https://habrahabr.ru/users/m1el/" class="user_link">turned</a> on, thanks <a href="https://habrahabr.ru/users/m1el/" class="user_link">m1el</a> for the comment. </div><p>Source: <a href="https://habr.com/ru/post/128377/">https://habr.com/ru/post/128377/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../128372/index.html">300 million US dollars to save 6 milliseconds</a></li>
<li><a href="../128373/index.html">I'll give the project (FB application for matchmaking) in good hands</a></li>
<li><a href="../128374/index.html">Super Pixel Bros</a></li>
<li><a href="../128375/index.html">Not in megahertz happiness</a></li>
<li><a href="../128376/index.html">Results of the recommendation contest or victory over the personnel crisis</a></li>
<li><a href="../128378/index.html">We write your first gem</a></li>
<li><a href="../128379/index.html">BookMyBest - hotel search and price comparison service</a></li>
<li><a href="../128380/index.html">WebSocket: Implementing a web application using Jetty Web Socket. Part 1</a></li>
<li><a href="../128381/index.html">LXML - problems with encoding when parsing HTML</a></li>
<li><a href="../128382/index.html">Development of a virtual system "Multimeter" based on National Instruments</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>