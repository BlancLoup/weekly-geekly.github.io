<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Custom templates in GTM: figure it out</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the end of May, Google introduced a new feature in Google Tag Manager (GTM): Custom Templates or custom templates. Let's see why it is needed, how ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Custom templates in GTM: figure it out</h1><div class="post__text post__text-html js-mediator-article">  At the end of May, Google introduced a new feature in Google Tag Manager (GTM): Custom Templates or custom templates.  Let's see why it is needed, how to use it, what are the differences from HTML tags and JavaScript variables. <br><br>  As an example, we will consider the creation of a Custom Template for a pixel of dynamic retargeting ‚ÄúVKontakte‚Äù and further customization of GTM tags through it. <br><br><img src="https://habrastorage.org/webt/c-/62/zr/c-62zrfxks1t6c2gfsv0kn2brjm.png"><br><a name="habracut"></a><br>  <a href="https://habr.com/ru/post/458788/">Simple words about Custom Templates</a> <br>  <a href="https://habr.com/ru/post/458788/">Creating a Custom Template</a> <br>  <a href="https://habr.com/ru/post/458788/">‚Ä¢ Info tab</a> <br>  <a href="https://habr.com/ru/post/458788/">‚Ä¢ Fields tab</a> <br>  <a href="https://habr.com/ru/post/458788/">‚Ä¢ Code tab</a> <br>  <a href="https://habr.com/ru/post/458788/">‚Ä¢ Permissions tab</a> <br>  <a href="https://habr.com/ru/post/458788/">Customize and test the tag according to the created Custom Template</a> <br>  <a href="https://habr.com/ru/post/458788/">‚Ä¢ Pageview</a> <br>  <a href="https://habr.com/ru/post/458788/">‚Ä¢ AddToCart</a> <br>  <a href="https://habr.com/ru/post/458788/">‚Ä¢ Test working out</a> <br>  <a href="https://habr.com/ru/post/458788/">Conclusion</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="1"></a><h2>  Simple words about Custom Templates </h2><br>  Custom Templates are templates for which users can create new tags or variables.  GTM has ready-made templates (in the Featured or Featured section), for example, Google Analytics tag, Google Optimize, and others.  Now we can add them with our own templates.  After creation, they will appear in the Custom tab: <br><br><img src="https://habrastorage.org/webt/nx/q_/mu/nxq_mu_uxl6tyiumnl8xbzt6o2c.png"><br><br>  The key difference from HTML tags and JS variables is that when a user creates a tag or a variable using a predefined template, it does not interact with the JS code. <br><br>  The code of the user template is written by the developer or web analyst at the stage of its creation.  Then, when creating a tag or variable using a custom template, all interaction takes place through the interface (which is also configured when creating a custom template): <br><br><img src="https://habrastorage.org/webt/pe/e2/te/pee2tevqbahm_nplbfgj0btis34.png"><br><br>  Accordingly, compared to writing an HTML tag or a JS variable, it becomes an order of magnitude easier to set up a tag or variable using a custom template, since it does not require knowledge and skills of working with JavaScript. <br><br>  Another big plus of custom templates is that the probability of ‚Äúputting‚Äù a site decreases due to an error in the JS code of the tag. <br><br>  In our example, to set up the tag of dynamic retargeting ‚ÄúVKontakte‚Äù you no longer need to contact the developers - everything can be set up independently, even the transfer of data about the goods (with Google‚Äôs advanced e-commerce site configured), having only GTM experience. <br><br><a name="2"></a><h2>  Creating a Custom Template </h2><br>  Since we are creating a tag template, we need to go to the Templates section and click the New button in the Tag Templates section. <br><br><img src="https://habrastorage.org/webt/ca/bt/sa/cabtsaamxy-zoglccqgvt1v_tra.png"><br><br>  After this, the Template Editor opens: <br><br><img src="https://habrastorage.org/webt/bf/c3/jf/bfc3jf2xgpkasmc3qvik2tp4wxy.png"><br><br>  In the left part of the editor there is a settings window, in the right part there is a preview window and a console.  In the settings window there are four tabs that are needed to create and work with the template. <br><br><a name="3"></a><h3>  Info tab </h3><br>  This tab contains information about the tag: name, description, icon.  This is the information that we will see when creating a new tag in the list of templates: <br><br><img src="https://habrastorage.org/webt/dd/nm/9f/ddnm9fvcygh2ob6jzkliccqgi1o.png"><br><br>  There are requirements for the tag icon: PNG, JPEG or GIF format, resolution at least 64x64 pixels and size no more than 50 KB. <br><br><a name="4"></a><h3>  Fields tab </h3><br>  This section creates our template interface.  The interface consists of various fields and forms with which the user interacts at the stage of creating a new tag or variable. <br><br>  Further, the information that the user entered when creating the tag using the interface is used in the template code. <br><br>  To add a new item, click the Add Field button.  The item type selection window appears: <br><br><img src="https://habrastorage.org/webt/g5/ko/d7/g5kod7ox7dal761180kpdfhojto.png"><br><br>  GTM allows you to select the following types of interface elements: <br><br><ul><li>  <b>text field</b> ; </li><li>  <b>drop-down menu</b> ; </li><li>  <b>checkbox</b> ; </li><li>  <b>switches</b> ; </li><li>  <b>simple table</b> , here you can edit each cell. </li><li>  <b>extended table</b> , you can edit only the row, this type of table is convenient to use to create a dictionary of pairs of ‚Äúkey - value‚Äù; </li><li>  <b>a group of elements</b> allows grouping several types into a group; </li><li>  <b>the label is</b> used to add text to the interface, does not require the user to enter any data. </li></ul><br>  After adding an element, you must give it a clear name, which will then be used in the code.  This is a kind of variable name - it should be clear and reveal the essence of the created interface element.  For example, the name ‚ÄúID‚Äù does not mean anything concrete, but the name ‚ÄúpixelIDs‚Äù already shows that this element stores the IDs of the pixels that the user entered: <br><br><img src="https://habrastorage.org/webt/fv/1h/ht/fv1hht_iaatbuhi1ejovajkehhc.png"><br><br>  Next, you need to go to the settings of each element and activate the necessary properties. <br>  In different situations, different properties of the interface element are required, so by default they are all hidden and we need to activate exactly those that are needed now: <br><br><img src="https://habrastorage.org/webt/ah/jx/o1/ahjxo1oz0w8fp6pntytshfs1y_o.png"><br><br>  Different types of elements have different properties, I will indicate the most frequently used, which almost all elements have: <br><br>  <b>1. Display name</b> .  This is the name that the user will see in the interface when creating the tag: <br><br><img src="https://habrastorage.org/webt/jf/lk/-g/jflk-glzt0dahft6vpdx9qrzy8q.png"><br><br>  <b>2. Example value</b> .  This is a hint to the user about what values ‚Äã‚Äãto enter in the field: <br><br><img src="https://habrastorage.org/webt/b6/zz/sc/b6zzscielm1pjho74x22rk88c0c.png"><br><br>  <b>3. Help text</b> .  This is the text that the user will see if the cursor hovers over the element's help icon: <br><br><img src="https://habrastorage.org/webt/nv/wo/qr/nvwoqraide7hp-qrbdjaomwvg3e.png"><br><br>  <b>4. Rules for data verification</b> .  In this property, you can set certain rules for checking data entered by the user in the field, and, if necessary, the error text that appears when you try to save a tag with data that did not pass the test. <br><br>  For example, you can specify that the field must be filled.  The second example: you need to get an email address from the user, then you can make sure that the data entered by the user must match the regular expression <b>. * @. * \ .. *</b> . <br><br><img src="https://habrastorage.org/webt/3s/ma/pb/3smapbl1aorsc4fsvhwpd-1oy4m.png"><br><br>  To specify the error text that appears if the entered data does not comply with the validation rules, you need to activate the advanced settings of the rule: <br><br><img src="https://habrastorage.org/webt/kb/zw/qr/kbzwqr32irigkreu9bbht9fxf1m.png"><br><br><img src="https://habrastorage.org/webt/ek/xh/hg/ekxhhgobsta59wpr6uxsbaqzdwg.png"><br><br>  Also in the advanced settings you can specify the conditions under which this rule is activated (the Enable Condition field). <br><br>  <b>5. Terms of inclusion</b> .  These are the conditions under which the user will have this interface element. <br><br>  For example, in order not to overload the template with interface elements, you can make the necessary elements appear when the checkbox is selected.  That is, suppose if a user wants to set up product data transfer to a pixel (this is possible when Google‚Äôs extended e-commerce site is configured), then he sets the ‚ÄúUse dataLayer to transfer product data‚Äù checkbox and after the checkbox is selected, elements appear in the tag interface required to configure such a transfer.  If the checkbox is not checked, then there are no elements in the interface. <br><br><img src="https://habrastorage.org/webt/rp/ui/x_/rpuix__y-ya--_uat8taekcwpa0.png"><br><br>  I note that here it is necessary to specify the name of the element, which was necessary to assign to it immediately after the addition. <br><br>  As settings are added and the interface is created, all changes can be immediately viewed and tested in the preview window: <br><br><img src="https://habrastorage.org/webt/df/bl/l9/dfbll9mc0qvpwcxnbzzx-fbg71g.png"><br><br><a name="5"></a><h3>  Code Tab </h3><br>  This tab is a code editor. <br><br>  The GTM Custom Templates code is written in ‚Äútrimmed‚Äù JavaScript ES6 and runs in an isolated environment, where all communication with global data (that is, directly with the page) occurs via the API.  There are no global objects, such as window or document, in it, respectively, the usual methods either.  For example, constructors (new Object and similar), setTimeout, parseInt, delete, etc.  - all this will not work in the Custom Template. <br><br>  But for all this there is an API.  And, therefore, the writing of code for the Custom Template must begin with the fact that we define the APIs that we will use in our code: <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// API //     const copyFromWindow = require('copyFromWindow'); //     const setInWindow = require('setInWindow'); //      const injectScript = require('injectScript'); //    const callInWindow = require('callInWindow'); //  ,     ,    const makeTableMap = require('makeTableMap'); //   URL  const getUrl = require('getUrl'); //    const getQueryParameters = require('getQueryParameters'); //     const makeInteger = require('makeInteger'); //    const makeString = require('makeString'); //  setTimeout const callLater = require('callLater'); //  console.log const logToConsole = require('logToConsole');</span></span></code> </pre> <br>  A full list of APIs with detailed documentation is available in the <a href="https://developers.google.com/tag-manager/templates/api">Google Help For Developers</a> . <br><br>  I will show you with examples how to work with the API: <br><div class="scrollable-table"><table><tbody><tr><th>  Action description </th><th>  Classic JS </th><th>  Custom Template API </th></tr><tr><td>  Console output </td><td>  console.log ('Hi'); </td><td>  logToConsole ('Hi'); </td></tr><tr><td>  Set timer </td><td>  setTimeout (function, 100); </td><td>  callLater (function); </td></tr><tr><td>  Conversion to string </td><td>  String (1234); </td><td>  makeString (1234); </td></tr><tr><td>  Convert to integer </td><td>  parseInt ('1234', 10); </td><td>  makeInteger ('1234'); </td></tr><tr><td>  Page host </td><td>  window.location.hostname </td><td>  getUrl ('host'); </td></tr></tbody></table></div><br>  As can be seen from the table of examples, after defining the API, it should be used instead of standard JS constructs. <br><br>  After we have defined the API, it is desirable to define an object with the settings that the user entered.  This can be done after, for example, during executable code, requesting the necessary data from the user's settings.  But if we define the settings object from the very beginning, then working with the code becomes simpler and clearer, since all user settings are stored in a separate object. <br><br>  To get data from an interface element, you need to use the data construct. <br><br>  {{item name}}: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    const settings = { //  event: data.event, //ID  () pixelIDs: data.pixelIDs, //ID - (  1 -) priceListId: data.priceListId, //   -? fewPriceLists: data.fewPriceLists, //ID - (    ) priceListIds: data.priceListIds === undefined ? data.priceListIds : makeTableMap(data.priceListIds,'hostname','priceListId'), //  ecommerce   ? ecommerceUse: data.ecommerceUse, // ecommerce   eventEcommerce: data.eventEcommerce, //     siteSearchQueryParam: data.siteSearchQueryParam };</span></span></code> </pre><br>  Note: if you pass undefined to the makeTableMap method, this will cause a script error, so I use the construction with the ternary operator (abbreviated if-else construction entry) to filter such scripts. <br><br><div class="spoiler">  <b class="spoiler_title">About the makeTableMap method.</b> <div class="spoiler_text">  If the interface uses an extended table, then the data in it is stored in this form: <br><br><pre> <code class="javascript hljs">[ <span class="hljs-string"><span class="hljs-string">'key'</span></span>: <span class="hljs-string"><span class="hljs-string">'k1'</span></span>, <span class="hljs-string"><span class="hljs-string">'value'</span></span>: <span class="hljs-string"><span class="hljs-string">'v1'</span></span>}, <span class="hljs-string"><span class="hljs-string">'key'</span></span>: <span class="hljs-string"><span class="hljs-string">'k2'</span></span>, <span class="hljs-string"><span class="hljs-string">'value'</span></span>: <span class="hljs-string"><span class="hljs-string">'v2'</span></span>} ]</code> </pre><br>  After being processed by the makeTableMap method, the data becomes a regular object with key-value pairs: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">'k1'</span></span>: <span class="hljs-string"><span class="hljs-string">'v1'</span></span>, <span class="hljs-string"><span class="hljs-string">'k2'</span></span>: <span class="hljs-string"><span class="hljs-string">'v2'</span></span> }</code> </pre><br></div></div><br>  Another requirement for the Custom Template code: in case of successful execution of the tag, you must call the data.gtmOnSuccess () method, and in case of an error, the data.gtmOnFailure () method. <br><br>  For example, in my code, the data.gtmOnSuccess () method is called after the successful sending of the request, and the data.gtmOnFailure () method - in the case of unsuccessful loading on the page of the external script VK openapi.js. <br><br>  After defining an API and defining an object with settings, you can start writing a pixel refinement algorithm. <br><br>  The main thing to remember is the following: <br><br>  ‚Ä¢ If you need to get a global variable - use the API method copyFromWindow. <br><br><pre> <code class="javascript hljs">copyFromWindow(<span class="hljs-string"><span class="hljs-string">'VK'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//VK -   ,    </span></span></code> </pre><br>  ‚Ä¢ If you need to set a global variable - use the API method setInWindow. <br><br><pre> <code class="javascript hljs">setInWindow(<span class="hljs-string"><span class="hljs-string">'openapiInject'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">//openapiInject -   ,    //1 - ,    .</span></span></code> </pre><br>  ‚Ä¢ If you need to run a global function, use the callInWindow API method. <br><br><pre> <code class="javascript hljs">callInWindow(<span class="hljs-string"><span class="hljs-string">'VK.Retargeting.Init'</span></span>, p); <span class="hljs-comment"><span class="hljs-comment">//VK.Retargeting.Init -   ,    //p - ,     </span></span></code> </pre><br>  ‚Ä¢ If you need to add an external script to the page - use the API injectScript method. <br><br><pre> <code class="javascript hljs">injectScript(<span class="hljs-string"><span class="hljs-string">'https://vk.com/js/api/openapi.js?159'</span></span>, pixel.setVkAsyncInit(), data.gtmOnFailure, <span class="hljs-string"><span class="hljs-string">'vkPixel'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//https://vk.com/js/api/openapi.js?159 -  ,      //pixel.setVkAsyncInit() - ,        //data.gtmOnFailure - ,        //vkPixel -  ,  ,   URL  .    ,   JavaScript      </span></span></code> </pre><br>  ‚Ä¢ If you need to get the URL (or part of it) - use the API getUrl method. <br><br><pre> <code class="javascript hljs">getUrl(<span class="hljs-string"><span class="hljs-string">'host'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//host -  URL,  .  ,  host: protocol, port, path, extension, fragment, query.</span></span></code> </pre><br>  As I wrote above, the Custom Template supports JS ES6.  It is desirable to use this syntax, as it reduces the code and makes it more readable, and the work of JS - more predictable and similar to other programming languages. <br><br><div class="spoiler">  <b class="spoiler_title">More on JS ES6 syntax</b> <div class="spoiler_text">  The main thing that is desirable to use is the arrow functions and the declaration of the variables const and let instead of var. <br><br>  A variable declared via const is a constant whose value cannot be changed. <br><br>  A variable declared via let differs from a variable declared through var as follows: <br><br><ul><li>  let is not added to the global window object; </li><li>  the visibility of the let variable is limited to the declaration block; </li><li>  variables declared via let cannot be redeclared. </li></ul><br>  Arrow functions are the abbreviated spelling of ordinary functions: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//1.   const func1 = function() { return 'test'; } //    const func1 = () =&gt; 'test'; //2.   const func2 = function(arg) { if (arg &gt; 0) return 'plus'; else return 'minus'; } //    const func2 = arg =&gt; { if (arg &gt; 0) return 'plus'; else return 'minus'; } //3.   const func3 = function(arg1, arg2){ if (arg1 &gt; arg2) return arg1; else return arg2; } //    const func3 = (arg1, arg2) =&gt; { if (arg1 &gt; arg2) return arg1; else return arg2; }</span></span></code> </pre><br></div></div><br>  Now that we understand how to use the Custom Template API, we can write the code for how the tag works using the JavaScript syntax ES6. <br><br>  My code contains methods for launching a pixel, installing VK openapi.js, retrieving data about a product from a dataLayer (when configured on the extended e-commerce site of Google), processing this data to bring them into the form required to send retargeting VKontakte to pixel , and the method of sending the event. <br><br>  The pixel trigger method supports three scenarios: <br><br><ol><li>  Pixel runs on the page where openapi.js is missing. </li><li>  Pixel is launched on the page where there is openapi.js, but it has not loaded yet. </li><li>  Pixel runs on a page loaded with openapi.js. </li></ol><br><div class="spoiler">  <b class="spoiler_title">The full code of my custom GTM template for a pixel dynamic retargeting VKontakte</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//api const copyFromWindow = require('copyFromWindow'); const setInWindow = require('setInWindow'); const injectScript = require('injectScript'); const callInWindow = require('callInWindow'); const makeTableMap = require('makeTableMap'); const getUrl = require('getUrl'); const getQueryParameters = require('getQueryParameters'); const makeInteger = require('makeInteger'); const makeString = require('makeString'); const callLater = require('callLater'); //    const settings = { event: data.event, pixelIDs: data.pixelIDs, priceListId: data.priceListId, fewPriceLists: data.fewPriceLists, priceListIds: data.priceListIds === undefined ? data.priceListIds : makeTableMap(data.priceListIds,'hostname','priceListId'), ecommerceUse: data.ecommerceUse, eventEcommerce: data.eventEcommerce, siteSearchQueryParam: data.siteSearchQueryParam }; //       const pixel = { //    getPageHostname: () =&gt; getUrl('host'), //    VK getVK: () =&gt; copyFromWindow('VK'), //    VK setVkAsyncInit: () =&gt; { setInWindow('vkAsyncInit', pixel.sendEvent); }, //       getSiteSearchPhrase: () =&gt; { if (settings.event === 'view_search') return getQueryParameters(settings.siteSearchQueryParam); else return undefined; }, //      getEventParams: (products, currencyCode, revenue) =&gt; { let eventParamsClean= {}; let eventParams = { products: eventProducts.getProductParams(products), category_ids: eventProducts.getCategoryString(products), currency_code: currencyCode, total_price: eventProducts.getTotalPrice(products, revenue), search_string: pixel.getSiteSearchPhrase() }; if (eventParams.products !== undefined) eventParamsClean.products = eventParams.products; if (eventParams.category_ids !== undefined) eventParamsClean.category_ids = eventParams.category_ids; if (eventParams.currency_code !== undefined) eventParamsClean.currency_code = eventParams.currency_code; if (eventParams.total_price !== undefined) eventParamsClean.total_price = eventParams.total_price; if (eventParams.search_string !== undefined) eventParamsClean.search_string = eventParams.search_string; return eventParamsClean; }, //  - getPriceListId: hostname =&gt; { if (settings.fewPriceLists) return settings.priceListIds[hostname]; else return settings.priceListId; }, //  openapi.js openapiInit: () =&gt; { injectScript('https://vk.com/js/api/openapi.js?159', pixel.setVkAsyncInit(), data.gtmOnFailure, 'vkPixel'); setInWindow('openapiInject', 1); }, //   sendEvent: () =&gt; { if (settings.event === 'hit') { settings.pixelIDs.split(',').forEach(p =&gt; { callInWindow('VK.Retargeting.Init',p); callInWindow('VK.Retargeting.Hit'); }); } else { const pricelist = pixel.getPriceListId(pixel.getPageHostname()); const name = settings.event; let products = []; if(settings.ecommerceUse) products = name === 'view_home' || name === 'view_category' || name === 'view_search' || name === 'view_other' ? settings.eventEcommerce : settings.eventEcommerce.products; else products = undefined; const currencyCode = settings.ecommerceUse ? settings.eventEcommerce.currencyCode : undefined; const revenue = (settings.ecommerceUse &amp;&amp; name === 'purchase') ? settings.eventEcommerce.actionField.revenue : undefined; const eventParams = settings.ecommerceUse ? pixel.getEventParams(products, currencyCode, revenue) : undefined; settings.pixelIDs.split(',').forEach(p =&gt; { callInWindow('VK.Retargeting.Init',p); callInWindow('VK.Retargeting.ProductEvent', pricelist, name, eventParams); }); }, //   start: () =&gt; { if (pixel.getVK() === undefined &amp;&amp; copyFromWindow('openapiInject') !== 1) { pixel.openapiInit(); data.gtmOnSuccess(); } else if (pixel.getVK() === undefined &amp;&amp; copyFromWindow('openapiInject') === 1) { if (pixel.count &lt; 50) { callLater(pixel.start); pixel.count++; } else return; } else { pixel.sendEvent(); data.gtmOnSuccess(); }, //   count: 0 }; //       const eventProducts = { //    products   getProductParams: products =&gt; { let arr = []; products.forEach(i =&gt; { let productParamsClean = {}; let productParams = { id: makeString(i.id), group_id: makeString(i.brand), price: makeInteger(i.price * 100) / 100 }; if (productParams.id !== 'undefined') productParamsClean.id = productParams.id; if (productParams.group_id !== 'undefined') productParamsClean.group_id = productParams.group_id; if (productParams.price !== 0) productParamsClean.price = productParams.price; arr.push(productParamsClean); }); return arr; }, //       'a,b,c'       getCategoryString: products =&gt; { let categoryId = ''; let check = []; products.forEach(i =&gt; { if(check.indexOf(i.category) === -1) { check.push(i.category); categoryId += ',' + i.category; }); return categoryId.slice(1); }, //     getTotalPrice: (products, revenue) =&gt; { let sumPrice = 0; if (revenue !== undefined ) return makeInteger(revenue * 100) / 100; else { products.forEach(i =&gt; { if (i.hasOwnProperty('quantity')) sumPrice += (makeInteger(i.price * 100) / 100) * makeInteger(i.quantity); else sumPrice += makeInteger(i.price * 100) / 100; }); return sumPrice; }; //  pixel.start();</span></span></code> </pre> <br></div></div><br><a name="6"></a><h2>  Permissions tab </h2><br>  After writing the tag code, the final stage remains - to issue permissions to interact with the global data of the page.  This is done just on the Permissions tab. <br><br>  Since the code is executed in an isolated environment, and interaction with global data occurs through the API, for each API method (where necessary) we need to manually specify permissions for certain actions. <br><br>  This is done in order to take the most thoughtful approach to working with the global data of the page, and, thereby, to minimize the chances of ‚Äúputting‚Äù the site in error in the code of our template. <br><br>  For the API methods used in my code, you need to issue three types of permissions: <br><br><img src="https://habrastorage.org/webt/29/og/lw/29oglwyra6zkhac7_2lr4jpqq5a.png"><br><br>  <b>1. Accesses Global Variables</b> - access to read, write, execute global variables that are used in our code.  Variables must be added manually and for each of them indicate what we are allowed to do. <br><br><img src="https://habrastorage.org/webt/f3/qb/6b/f3qb6b9sj6rn1v4q55t_z9f362e.png"><br><br>  For example, the VK variable can only be read, vkAsyncInit can be read and redefined, and the VK.Retargeting.Hit method can only be executed. <br><br>  <b>2. Reads URL</b> .  Here you need to specify which parts of the URL are allowed to receive.  I allow to receive any parts of the URL: <br><br><img src="https://habrastorage.org/webt/do/um/li/doumlixqd-rw2cppm4ordw1svae.png"><br><br>  But if you want, you can specify some specific ones: <br><br><img src="https://habrastorage.org/webt/sj/d3/ne/sjd3nefe52_foeat88kifeodi-w.png"><br><br>  <b>3. Injects Scripts</b> .  Here it is necessary to register addresses from which external scripts can be downloaded.  In my code, only one script is loaded with VK openapi.js, and I indicate its address: <br><br><img src="https://habrastorage.org/webt/xt/oy/hd/xtoyhd-yprd2sn_eu41mbquh2s0.png"><br><br>  That's it, the Custom Template setting is complete, you can save the template and proceed to testing. <br><br><a name="7"></a><h2>  Customize and test the tag according to the created Custom Template </h2><br>  As an example, create two tags of dynamic retargeting ‚ÄúVKontakte‚Äù using the created Custom Template: pageview and addToCart. <br><br><a name="8"></a><h3>  Pageview </h3><br>  Go to the desired GTM container, create a new tag, select the tag type VK Pixel in the Custom section: <br><br><img src="https://habrastorage.org/webt/gd/s-/fi/gds-fi0tqxxcmfkkccsi8trowq4.png"><br><br>  Fill in the tag name, track the event, select Hit (this is the standard pageview), specify the ID of two pixels in the ‚ÄúPixel ID‚Äù field and send the data to the ID, and set the All Pages trigger: <br><br><img src="https://habrastorage.org/webt/vr/op/-0/vrop-0cjfqndkh35qnbtdsoxpc4.png"><br><br>  Save the created tag. <br><br><a name="9"></a><h3>  AddToCart </h3><br>  Creating a tag for the event of adding a product to the cart will be a bit more complicated than the Hit tag. <br><br>  First, it is necessary to transfer the goods that are added to the basket.  As I wrote above, this is possible with Google‚Äôs advanced e-commerce site configured.  In this case, the product data is taken from the dataLayer. <br><br>  To do this, we need to create a dataLayer variable in GTM that will hold the ecommerce object for the addToCart event.  Variable settings look like this: <br><br><img src="https://habrastorage.org/webt/ko/r5/gu/kor5gumudjjzs9groemuo7nepco.png"><br><br>  Secondly, you need to create a trigger that will activate the tag when the ecommerce addToCart event occurs (the trigger will activate the tag when you push in the dataLayer at the addToCart event): <br><br><img src="https://habrastorage.org/webt/og/xl/lt/ogxlltp_4_spurvq8fesqg3uy0m.png"><br><br>  After creating the variable with the ecommerce object and the trigger, you can start creating the tag: <br><br><img src="https://habrastorage.org/webt/dp/qg/zq/dpqgzqb27rcdydnjeen5fftp6ba.png"><br><br>  In order: <br><br><ol><li>  As a tracked event, select Add To Cart. </li><li>  Fill in a comma-separated ID of two pixels to which you want to transfer data. </li><li>  Set the checkbox ‚ÄúUse multiple price lists‚Äù: for Moscow and St. Petersburg, in our example, you need to use different price lists. </li><li>  Fill the table with price lists. </li><li>  Check the box "Use ecommerce to transfer products and options." </li><li>  In the ecommerce object of this event, specify the variable created earlier. </li><li>  Set the trigger on the event being monitored, in this case AddToCart. </li><li>  We save. </li></ol><br><a name="10"></a><h3>  Testing check </h3><br>  To check the working off of pixels of dynamic retargeting ‚ÄúVKontakte‚Äù you need to activate the Preview mode in GTM, go to our website and open the Network section in the browser console and in the Filter field enter 'rtrg': <br><img src="https://habrastorage.org/webt/ci/m9/z8/cim9z824mbc9dfvdz-4425fe02w.png"><br><br>  After that we update the page, and we should have two requests - a Hit event sent in two pixels: <br><br><img src="https://habrastorage.org/webt/o0/5x/80/o05x80jeypiwcogusca_zgsnaju.png"><br><br>  Status 200 means that requests are sent and received by the server successfully. <br><br>  Also in the Preview GTM window we can see that our created tag worked correctly for the Page View event. <br><br>  To check the Add To Cart event, we add the item to the cart, and two more requests appear in the console: <br><br><img src="https://habrastorage.org/webt/wt/jm/-k/wtjm-k50mmapqa1xtyva_yd3wcc.png"><br><br>  In the Preview GTM window we see that the second tag worked successfully.  Data about the product from dataLayer was pulled up and processed correctly, the correct price list was also substituted. <br><br>  For the second host, the price list is also correctly substituted: <br><br><img src="https://habrastorage.org/webt/n3/de/h3/n3deh30jep61h2kv9zefwruu8cy.png"><br><br>  Tags for other events are configured and checked in the same way. <br><br><a name="11"></a><h2>  Conclusion </h2><br>  Custom patterns change the familiar GTM usage paradigm.  Everyone is used to HTML tags and JS variables, but now there is a great alternative. <br><br>  It is enough to create a high-quality user template once, and then anyone who is familiar with GTM will be able to use it. <br><br>  Given the opportunity to share the created templates, I think they should gain popularity among users. <br><br>  You can <a href="https://yadi.sk/d/l_7SK5sNScSzcA">download the custom</a> VKontakte dynamic retargeting pixel <a href="https://yadi.sk/d/l_7SK5sNScSzcA">template</a> that we discussed in this article. <br><br>  To import a template, you need to create a new Custom Template and select Import in the menu: <br><br><img src="https://habrastorage.org/webt/mx/nn/jc/mxnnjc0419poxmshokabjcgeoye.png"><br><br>  <i>Material prepared by me for the publication of ppc.world</i> </div><p>Source: <a href="https://habr.com/ru/post/458788/">https://habr.com/ru/post/458788/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../458774/index.html">Functional DBMS</a></li>
<li><a href="../458778/index.html">Satellite Reporting Engine 6.5: What It Is And Why</a></li>
<li><a href="../458782/index.html">Adaptation programs for the ZX Spectrum to TR-DOS with modern tools. Part 3</a></li>
<li><a href="../458784/index.html">Broadcasting projects and libraries from Altium Designer to PADS Professional</a></li>
<li><a href="../458786/index.html">The "keepers" of video games, step by step, preserve the gaming culture</a></li>
<li><a href="../458790/index.html">Introduction to the development of CatBoost. Yandex report</a></li>
<li><a href="../458792/index.html">"Burnt" employees: is there a way out?</a></li>
<li><a href="../458794/index.html">Mitap Business Analysts at Redmadrobot July 18</a></li>
<li><a href="../458796/index.html">How to prepare a website for large loads: 5 practical tips and useful tools</a></li>
<li><a href="../458798/index.html">NutritionBot or how I want to take away the bread from fitness trainers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>