<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we accelerated the search in Yandex. Mail and at the same time released 25 servers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We have already written about how the search for letters in Yandex.Mail is organized . Since then, many things have changed and improved, so we decide...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we accelerated the search in Yandex. Mail and at the same time released 25 servers</h1><div class="post__text post__text-html js-mediator-article">  We have already written about how the <a href="http://habrahabr.ru/company/yandex/blog/117232/">search for letters in Yandex.Mail is organized</a> .  Since then, many things have changed and improved, so we decided to share our experience and tell you about these changes. <br><br>  On the day about 100M of letters arrive at the Post, 10M of which - with attachments.  Despite the fact that only 10% of letters contain an attachment, among the letters with attachments there is a significant proportion of those in which there is more than one file.  On average, it turns out that the total number of letters is equal to the total number of attachments to them. <br><br> <a href="http://habrahabr.ru/company/yandex/blog/199432/"><img src="https://habrastorage.org/getpro/habr/post_images/5f6/f5a/7b9/5f6f5a7b9d811a72f2692cb7f325eddc.png" alt="image"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The average letter size with an attachment is 400 kb, and a letter without an attachment is 4 kb.  The total size of attachments in one letter can reach 30 mb.  TOP 10 types of attachments: .jpg, .pdf, .xls, .rar, .doc, .zip, .eml, .mp3, .tif, .docx.  Almost all file formats, except text, contain a significant amount of redundant service information.  So, for example: .docx format, contains on average only 10% of textual information, and from jpg we get only 0.25% of meta information for indexing into the search. <br><br>  This gives a total volume of incoming traffic of about 25 TB per day, which increases several times to ensure the operation of a large and complex product Mail.  To service such a load, Yandex.Mail has a large network, server and service infrastructure, which includes several clusters distributed across different data centers. <br><a name="habracut"></a><br>  All incoming emails get into the delivery system - a cluster consisting of hundreds of servers.  The delivery system tries to save letters in the store of letters, the storehouse of meta-information about letters and send them to the search ‚Äî that is, to three different places at once, each of which performs its own tasks. <br><br>  <b>The storage of letters</b> is responsible for the storage and return on request of the entire contents of each letter and for some reason is historically called mulca.  For storage of letters in Yandex. Mail 700 millechny servers are unrolled.  The contents of the letters, headers, attachments are stored here - in one word, everything related to the letter. <br><br>  <b>Meta-information storage</b> serves for quick display of inbox and contains only the narrative of the letter.  For example, the fields ‚ÄúFrom whom‚Äù, ‚ÄúTo‚Äù, ‚ÄúSubject‚Äù, the name of the folder in which the letter is located at the moment, its current label, the date of writing, etc.  Meta-cluster occupies 60 servers. <br><br>  <b>Search storage</b> is a search index that contains all the information from a letter that is needed to provide a quick full-text search by mailbox, taking into account the morphology.  Search service, performing the task of indexing and searching, are engaged in one hundred forty servers simultaneously. <br><br>  A letter is considered to have been delivered if it has fallen into the store of letters and the storehouse of meta-information.  Delivery of letters in the search is carried out after laying in storage.  A separate Services cluster consisting of twenty-five servers is allocated for the delivery of letters to the search.  On this cluster there are queues of letters awaiting indexation and programs that prepare data for indexing. <br><br>  Thus, letters, getting into the mail, go a long way.  First, they are added to the repository, then they fall into the Services cluster, and there they are preparing to be sent to the search. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6b5/2a1/32d/6b52a132dc00fc918a2dce80abe242ca.png" alt="image"><br><br>  But a <b>search by letters is not only a search by the body of the letter</b> , but also a search by the contents of attachments.  To provide it, the files sent as an attachment must be pre-processed, text extracted and sent as a text search. <br><br>  A few years ago, without changing the above-mentioned original architecture, we launched a search for the contents of attachments.  This caused a number of problems.  First, some types of files (especially .pdf) were processed for a long time - up to several minutes, and slowed down the delivery of new letters to the search.  Secondly, there was a constant competition for resources between the indexing program and the conversion program on the Services cluster, which also slowed down the number of new letters in the search.  And thirdly, when we started sending the entire letter with attachments to the Services cluster, we actually doubled the mail traffic within Yandex networks.  Intranet traffic has increased by 25 TB per day, and this is a burden on resources useful for personal services and for Yandex as a whole: servers, network infrastructure and total network performance. <br><br>  So, we had to fight for the quality of the service.  It was impossible to let the letters come to the search after minutes.  Moreover, before launching a search on attachments, 95% of all incoming emails got into the search in less than a second. <br><br>  There was a thought to deliver letters entirely to the repository, and to search only for structured text directly from the repositories.  Preliminary studies have shown that the average size of the text required for the search is 10 times smaller than the average size of the letter in the mail.  Therefore, if only text is sent to the search, then the network traffic consumed by the search will be 10 times less, which will save approximately 22 TB per day.  It seems that for the sake of saving traffic the game is worth the candle. <br><br>  It was also a tempting idea to use the storage performance by two orders of magnitude greater than a small Services cluster to pre-process files for search.  This would allow us to accelerate.  So did. <br><br>  In order for the voiced idea to be implemented, and we could receive the contents of letters and attachments directly from the repository, it was necessary to place a program for extracting the contents of attachments on its servers.  This program is based on <a href="http://tika.apache.org/">the Apache Tika library</a> , so for simplicity and consonance with the Russian language, the developer called it Tikaite.  Placing Tikaite on mulca-s it was important not to harm the storage of letters, so we studied the load in detail and saw that the storages are loaded in disk space and have sufficient free CPU performance that you can use. <br><br>  We placed in the storage a program for extracting text from various formats with severe restrictions: the program was provided with 50% of the processor performance and 1 GB of RAM was allocated on each of the servers.  Such restrictions allowed us to start the conversion process to the storage and did not interfere with the storage process. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8fb/f99/79b/8fbf9979b2d69312d1137ab2ca7e2eed.png" alt="image"><br><br>  As a result, we reduced parasitic intranet traffic and increased the performance of the email delivery system in the search by two orders of magnitude - again 95% of emails began to fall into the search within a second.  For delivery, we received an additional bonus in 25 free servers of the mail delivery cluster in the search.  If initially we planned to increase the Services cluster by 2 times and get 50 servers here to cope with the ever-increasing flow, now that all the data necessary for the search is being prepared directly into the storage of letters, we actually have a whole cluster of 25 servers free.  So in the near future we will be able to use it for other tasks, which we will certainly tell about. <br><br>  PS And to search by mail, it is periodically necessary to re-index all the emails that have been accumulated over the entire existence of Yandex.Mail.  This happens when it is necessary to change the search algorithm, and there is not enough data in the search for this.  At this time we are actually processing the entire array of letters stored in the mail, and this is now about 10 petabytes.  And it is here that it turns out just a huge savings in network traffic and performance. <br><br>  PPS Despite the results, we do not plan to stop there.  We will strive to make the delivery of letters to the search at the same time as they are laid in the repository and for this we will use the vacant cluster.  Wait for information about this in the new publications about search in Yandex. Mail. </div><p>Source: <a href="https://habr.com/ru/post/199432/">https://habr.com/ru/post/199432/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../199420/index.html">Anonymous hacked mail Ministry of Foreign Affairs of Ukraine</a></li>
<li><a href="../199422/index.html">Moscow number in code 495 for free</a></li>
<li><a href="../199424/index.html">Word for pixel values ‚Äã‚Äãmedia queries</a></li>
<li><a href="../199426/index.html">3/2 N: how to save on reliability increase?</a></li>
<li><a href="../199428/index.html">Applications for Firefox OS will run on Android, Windows, Mac OS X and Linux</a></li>
<li><a href="../199434/index.html">Windows 1.01 - now right in the browser</a></li>
<li><a href="../199436/index.html">The experience of writing a 2D MOBA-platform for several days</a></li>
<li><a href="../199438/index.html">Pessimal Algorithms and Computational Complication Analysis</a></li>
<li><a href="../199440/index.html">We get the type and size of the image without downloading it entirely, using Python</a></li>
<li><a href="../199446/index.html">American startup has developed a neural network that recognizes popular CAPTCHA with an accuracy of more than 90%</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>