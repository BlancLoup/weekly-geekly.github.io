<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Use memory wisely. Part 2. fapws3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous part, we started to fight for the memory on a 256 MB slice in a hurry. The result was, but not as spectacular as the one I achieved th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Use memory wisely. Part 2. fapws3</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="http://habrahabr.ru/blogs/django/51985/">previous part,</a> we started to fight for the memory on a 256 MB slice in a hurry.  The result was, but not as spectacular as the one I achieved this time. <br><br>  I always guessed that the reason for all my troubles - apache.  And the more I tried to tune it, the more convinced I was.  Conclusion?  Try to replace.  But one thing is that the transition should be as smooth as possible, since it is clearly a matter of production. <br><br>  Since I had experience with nginx, and to be precise - the experience with proxying, this particular web server was chosen.  In addition, he has good performance parameters. <br><a name="habracut"></a><br>  The first thing I tried to do was build nginx with mod_wsgi (not to be confused with the same for apache).  Collect something, but to make work - no.  Constantly lying around with the error "can not be corrupted as a module ...".  But it doesn‚Äôt matter, to get away from this move was also caused by some attenuation of the mod_wsgi project ... Although what I chose cannot be called actively developing and stable :) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After a lot of digging and listening to the guests of the conference pythonua@conference.jabber.ru, the gaze was <a href="http://william-os4y.livejournal.com/6485.html">focused</a> on <a href="http://william-os4y.livejournal.com/6485.html">fapws3</a> .  In short, this is a web server written in python.  Theoretically, it can be used just like that, without nginx, but I haven‚Äôt yet found a way to create virtual hosts by domains, and nginx handles much better with static. <br><br>  So, I have archlinux on a slice, respectively, everything below is true for him.  pacman is a software manager, you can use your apt-get etc.  by choice, unless the package names may vary. <br><br><h4>  fapws3 </h4><br>  There is nothing complicated about installing fapws3.  We swing <a href="">tarball</a> , we will unarchive, we execute <code>python setup.py install</code> .  Do not forget to install libev <br><br> <code>pacman -S libev</code> <br> <br>  fapws is based on it. <br><br>  In the archive you will find the examples daddy, and in it django.  Take run.py and throw in your project.  It is better to immediately check the performance by running it <code>python run.py</code> <br><br>  There is likely to get an ekspepshn, they say DJANGO_SETTINGS_MODULE is not defined ... But this is solved simply by adding <code>os.environ['DJANGO_SETTINGS_MODULE'] = 'kaexpert.settings'</code> in run.py (of course, replace with your module). <br><br>  Just need to change the ports.  Those.  for each site its own port.  I started numbering from 8081 and so on.  Further it will be required at the nginx settings.  By the way, the port is configured in <code>evwsgi.start("127.0.0.1", 8081)</code> (for testing, you can use IP 0.0.0.0 so that you can test operation without nginx, in our case, except for nginx, no one will contact the site directly ... more correct) <br><br><h4>  nginx </h4><br>  There is nothing complicated here either: <code>pacman -S nginx</code> .  Further settings.  Since I needed uninterrupted operation of the server, I installed <a href="http://sysoev.ru/nginx/">nginx</a> on port 8080, for this we find in /etc/nginx/conf/nginx.conf the line to <code>listen 80</code> and change 80 to 8080. <br><br>  All that is required of nginx is to proxy dynamic requests to the server fapws, and distribute the statics yourself.  For this we do for each site a server block inside http in /etc/nginx/conf/nginx.conf: <br><pre>  server {
         listen 80;
         server_name promex.su;
	 location / static {
		 root /srv/http/promex.su/;
	 }
	 location ~ * ^. + \. (jpg | jpeg | gif | png | ico | css | zip | tgz | gz | rar | bz2 | doc | xls | exe | pdf | ppt | txt | tar | mid | midi | wav | bmp | rtf | js | mov) {
		 access_log off;
		 expires 30d;
	         root /srv/http/promex.su/;
	 }
	 location / media {
		 root /usr/lib/python2.6/site-packages/django/contrib/admin/;
	 }<font></font>
<font></font>
         location / {
	     proxy_pass http://127.0.0.1:8082;
	     proxy_set_header X-Forwarded-Host $ server_name;
	     proxy_set_header X-Real-IP $ remote_addr;
	     proxy_set_header X-Forwarded-For $ remote_addr;
	 }<font></font>
<font></font>
         #error_page 404 /404.html;<font></font>
<font></font>
         # redirect server error pages to the static page /50x.html
         #
         error_page 500 502 503 504 /50x.html;
         location = /50x.html {
             root html;
         }
     }
</pre><br><br>  The proxy_pass line is important here, you need to specify the port from run.py in it.  In what places the static is tuned, I think clearly, we will not go into details, just correct the paths to our own. <br><br><h4>  supervisord </h4><br>  Since the fapws3 for each site is a separate daemon, you need to somehow manage all this beast.  For this, I took a <a href="http://supervisord.org/">supervisord</a> .  This is something like rc.d, only written in python and where it is more appropriate ... In terms of a person, I‚Äôm too lazy to write rc for each site, and then add it to rc.conf.  With the supervisor, we only need to add it to rc.d and configure the sites in its configuration (very simple).  It is put a little more difficult, through aur, but maybe in your distribution it is like a supported package.  Although with my <a href="http://wiki.archlinux.org/index.php/Yaourt">yaourt</a> it all comes down to the <code>yaourt -S supervisord</code> command :) I advise all arch users to use. <br><br>  It is added to rc.conf as follows: <code>DAEMONS=(syslog-ng network netfs crond sshd supervisord)</code> . <br><br>  The configuration is very simple, in appearance as win-ini.  For me it was enough to add such a block: <br><pre>  [program: kaexpert]
 command = / srv / http / ka-expert.ru / src / run.py
 process_name =% (program_name) s
 user = http </pre><br>  command - the command itself, do not forget to just make run.py executable <br>  process_name - process name <br>  user - from which user will be launched (the same as the web server, and nginx is for me under http and not for standard nginx, since everything is sharpened for http, because Apache) <br><br>  Well that's all.  Of course, this is necessary for each site.  Personally, I have also uncommented the [inet_http_server] section, which gives the web interface, but it works crookedly for me ... It only performs the informational function, does not work to restart the process, only through the supervisorctl, and that is with the exceptions (apparently, they were dealt with, but laziness). <br><br><h4>  Total </h4><br>  In total, we have released more than 100MB of memory, now the picture looks like <br><pre>  total used free shared buffers cached
 Mem: 256,113,142 0 4 32
 - / + buffers / cache: 75 180
 Swap: 511 27,484
</pre><br>  After the reboot, the swap should go away in mem, but until you get confused - let the uptime tick :) <br><br>  In general, and difficult, we got a huge savings in memory and an increase in speed in general.  Subjectively, the pages began to load 5 times faster, the tester did not measure, it suits me :) <br><br>  Good luck! <br><br>  Via <a href="http://retta-web.ru/">Retta Inc.</a> <br><br>  PS&gt; Plus in karma will not interfere - there are always good people who need an invite :) </div><p>Source: <a href="https://habr.com/ru/post/54464/">https://habr.com/ru/post/54464/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../54453/index.html">Yandex.News widget - memory leak?</a></li>
<li><a href="../54454/index.html">Tim O'Reilly: Do what matters!</a></li>
<li><a href="../54457/index.html">The problem with downloading avatars</a></li>
<li><a href="../54461/index.html">Sight restoration by the method of Shichko-Bates. Lectures Zhdanov V.G. Short review</a></li>
<li><a href="../54462/index.html">Apple logo as a second monitor</a></li>
<li><a href="../54465/index.html">Fly AJAX - write less, keep more. Non-standard AJAX and indexing by search engines.</a></li>
<li><a href="../54469/index.html">The evolution of interface design operating systems from 1981 to 2009</a></li>
<li><a href="../54470/index.html">How vim eclipse won (walk by functions as in eclipse)</a></li>
<li><a href="../54471/index.html">Hyper island</a></li>
<li><a href="../54474/index.html">African parable of good</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>