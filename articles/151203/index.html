<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Animated GIF with sound</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚Äú What allowed the GIF to remain is the looping animation that Netscape added. If Netscape had not added GIF support to its browser, GIF would have di...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Animated GIF with sound</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  ‚Äú <i>What allowed the GIF to remain is the looping animation that Netscape added.</i>  <i>If Netscape had not added GIF support to its browser, GIF would have died in 1998</i> " <br><br>  - Alexander Trevor, <br>  CompuServe GIF Team Leader <br></blockquote><br>  The GIF format in June of this year celebrated its 25th anniversary, and is today the oldest graphic format that is distributed on the Internet.  Devoting the weekend to viewing funny animated gifs you realize that some of them would be much better with sound.  All current solutions for looping animation with sound (for example: <a href="http://coub.com/">coub.com</a> , <a href="http://gifsound.com/">gifsound.com</a> ) offer to abandon the GIF, but this is not an option.  And I decided to donate by viewing the gifs on the weekend to solve this extremely important problem. <br><br>  The first gif on the Internet with the sound <a href="http://denyspotapov.com/gif-sound.html">of the link</a> .  It is necessary to press the blue button, and then on the gif.  The player should work in all modern browsers (tested in the latest Firefox and Chrome). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There will not be a gif under the cut, but there will be a process of creating an extension for the standard, writing a converter and a player. <br><a name="habracut"></a><br>  Since 1987, the GIF format has experienced only two significant changes: <br><ol><li>  In 89, the second version of the format (named GIF 89a) was released.  It became possible to specify the delay between pictures (several pictures in one file were in the first GIF format 87a).  Third-party developers are now able to add their own blocks to a file (Application Extension Block). </li><li>  In 90, Netscape added its own block, which allowed you to specify how many times the animation would repeat. </li></ol><br><h4>  Format expansion development </h4><br>  As mentioned above, the GIF 89a standard allows applications to place their data in a GIF file.  The format of the extension unit for applications: <br><table><tbody><tr><th>  Size, byte </th><th>  Content </th></tr><tr><td>  2 </td><td>  Application extension block header (always 0x21, 0xFF) </td></tr><tr><td>  one </td><td>  Block size (always 11) </td></tr><tr><td>  eight </td><td>  Application Id </td></tr><tr><td>  3 </td><td>  Application Authentication Code (can be used to verify that a block is created by a specific application) </td></tr><tr><td>  * </td><td>  Nested data blocks </td></tr><tr><td>  one </td><td>  Block end pointer (0x00) </td></tr></tbody></table><br>  Let's try to fit the WAVE file header here: <br><table><tbody><tr><th>  Size, byte </th><th>  Content </th></tr><tr><td>  four </td><td>  File Header (always ‚ÄúRIFF‚Äù) </td></tr><tr><td>  four </td><td>  Data size </td></tr><tr><td>  four </td><td>  Data format (for WAVE files - ‚ÄúWAVE‚Äù) </td></tr></tbody></table><br>  Since the block size is controlled by the GIF format, we remove the data size field from the header, and write ‚ÄúRIFFWAVE‚Äù to the application ID.  The remainder of the WAVE file is written as nested GIF blocks. <br><br>  We will insert the block with sound right in front of the first block with the image (in fact, you can insert it anywhere). <br><br><h4>  Converter Development </h4><br>  The input converter accepts GIF and WAVE files and outputs GIF with a RIFFWAVE block at the output.  The source code can be viewed on <a href="http://code.google.com/p/gif-sound/source/browse/wave2gif/wave2gif.py">google code</a> . <br><br>  The code is quite simple, read the WAVE file, create a GIF block from it.  Then we read the gif file and write down all the blocks, as soon as we find the first block with the picture, we insert a block with a sound in front of it.  The most important part of the code is the conversion of the WAVE file into a GIF block: <br><br><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_wav_block</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(file)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#     (signature, size, format) = unpack('4sI4s', file) if signature != 'RIFF': raise Exception('Not a RIFF file') if format != 'WAVE': raise Exception('Not a WAVE file') data = file.read(size - 4) #    wave_block_header = struct.pack('BBB8sBBB', 0x21, 0xff, 11, 'RIFFWAVE', 0, 0, 0) data_subblocks = [wave_block_header]; #      255  for i in range(0, len(data) // 255): data_subblocks.append(chr(0xff)) data_subblocks.append(data[i*255:(i + 1)*255]) if (len(data) % 255) &gt; 0: rest = len(data) % 255 data_subblocks.append(chr(rest)) data_subblocks.append(data[-rest:]) #     data_subblocks.append(chr(0)) return ''.join(data_subblocks)</span></span></code> </pre> <br><h4>  Making a gif with sound </h4><br>  Making an animated gif: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ffmpeg    ffmpeg -ss 0:00:9.73 -t 2.86 -i warlus.webm -s 500x280 -r 10 frames/image%03d.png #   GIF convert -delay 10 -loop 0 frames/*.png source.gif</span></span></code> </pre><br>  We get a sound and check that everything looks (and sounds) as we planned: <br><pre> <code class="bash hljs">mplayer -ss 0:00:9.73 -endpos 2.86 warlus.webm -ao pcm:file=<span class="hljs-string"><span class="hljs-string">"source.wav"</span></span> -vo null mplayer -loop 0 -audiofile source.wav source.gif</code> </pre><br>  Convert to GIF with sound <br><pre> <code class="bash hljs">python wave2gif.py example/source.gif example/source.wav result.gif</code> </pre><br><h4>  Making the player </h4><br>  The basis of the player will take <a href="http://slbkbs.org/jsgif/">jsgif</a> - a player for animated GIF in JavaScript.  jsgif parses the gif and loses by drawing each frame on the Canvas.  Add to it a function that, when a block is detected by the ‚ÄúRIFFWAVE‚Äù: <br><ul><li>  convert the data from the block back to the WAVE file format; </li><li>  convert the resulting file to the data: URL and pass to the Audio element. </li></ul><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> doSound = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sound</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Header var size = sound.data.length + 4 var size_text = String.fromCharCode(size &amp; 255, (size &gt;&gt; 8) &amp; 255, (size &gt;&gt; 16) &amp; 255, (size &gt;&gt; 24) &amp; 255); var header = [ "RIFF", size_text, // length "WAVE" ].join(''); var out = [header, sound.data].join(''); var dataURI = "data:audio/wav;base64," + escape(window.btoa(out)); sound_element = new Audio(); sound_element.src = dataURI; };</span></span></code> </pre><br>  jsgif does not work fast, but with the addition of sound, it became even slower.  Also, to get the file data, the player calls XMLHttpRequest, so the player works only with pictures from one domain.  But is it an interference to art. <br><br><h4>  What's next? </h4><br><br>  <s>Enjoy gifs with sound.</s>  You can implement a plugin for browsers that would allow to play such gifs without additional XMLHttpRequest, and which will probably work faster.  If someone came across a similar task, <b>I would be grateful for indicating which way to look in order to write a plugin that handles certain types of files</b> . <br><br><h4>  Sources </h4><br>  <a href="http://www.w3.org/Graphics/GIF/spec-gif89a.txt">GIF89a Specification</a> <br>  <a href="https://ccrma.stanford.edu/courses/422/projects/WaveFormat/">WAVE PCM soundfile format</a> <br>  <a href="http://slbkbs.org/jsgif/">jsgif: A GIF player in JavaScript</a> </div><p>Source: <a href="https://habr.com/ru/post/151203/">https://habr.com/ru/post/151203/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../151197/index.html">Improving the subjective speed of the site with the help of browser prompts</a></li>
<li><a href="../151198/index.html">Steam on your TV</a></li>
<li><a href="../151199/index.html">ebay Crime and Punishment</a></li>
<li><a href="../151201/index.html">Workplace standing for 600 rubles</a></li>
<li><a href="../151202/index.html">GoDaddy.com lies</a></li>
<li><a href="../151205/index.html">Well, that died dns server godaddy</a></li>
<li><a href="../151206/index.html">FBI talks about face recognition</a></li>
<li><a href="../151207/index.html">Godaddy lies under DDOS</a></li>
<li><a href="../151208/index.html">PDF Report: My first program for the iPhone</a></li>
<li><a href="../151209/index.html">Boston Dynamics LS3 - BigDog Big Brother</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>