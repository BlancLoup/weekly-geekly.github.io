<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Heterogeneous processor pool in XenServer 6</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, the customer became aware of the need to assemble a pool of virtual machines, which was to consist of HP ProLiant servers of 6 and 5 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Heterogeneous processor pool in XenServer 6</h1><div class="post__text post__text-html js-mediator-article">  Not so long ago, the customer became aware of the need to assemble a pool of virtual machines, which was to consist of <a href="http://welcome.hp.com/country/ru/ru/smb/servers.html">HP ProLiant servers of</a> 6 and 5 generations.  The processors in these servers are: Xeon <b>E5502</b> and <b>X3353</b> .  Starting with version 5.5, Xen supports a heterogeneous pool of processors. <br>  4 types of heterogeneous pools are described: <ol><li>  Adding more productive host to less productive; </li><li>  Adding less productive host to more productive; </li><li>  The combination of different and mutually exclusive hosts in the pool; </li><li>  A combination of different CPUs with identical capabilities. </li></ol><br><a name="habracut"></a><br>  Type 1 involves applying a mask to the connected CPU in order to achieve compatibility with the existing pool, which remains unmasked; this option is automatically included in the XenServer.  Type 2 involves applying a mask to an existing pool, the server being added remains unmasked.  Type 3 involves applying a common mask to the existing pool and the connected host to ensure compatibility.  Type 2 and type 3 are supported via XenAPI and Xe CLI.  Type 4 is suitable for models with different marketing names, but identical sets of flags and functions. <br>  In one of the blogs I came across a <a href="http://www.youtube.com/watch%3Ffeature%3Dplayer_embedded%26v%3DJC4ecjLbIiU">video</a> where 2 servers are added to the pool without changing the masks manually.  Unfortunately, in my case, for any combination, XenServer issued: "This server's hardware is incompatible with the master's."  It only remained to try to apply the mask. <br>  Applying a mask to an existing pool affects the running virtual machines, so you need to choose the time to reboot the hosts and apply the mask. <br>  An additional nuance is that new and old processors cannot always be described as more productive and less productive.  Newer models of processors often do not use functions that are present in older processors, which can lead to incompatibility.  Therefore, there will be no guarantee that when using a host mask with the latest processors, it is enough to attach it to the pool containing the old processor models. <br>  Supported processor combinations can be found in the <a href="http://hcl.xensource.com/CPUPoolsList.aspx">Hardware Compatibility List</a> . <br>  We proceed to the choice of a masking option. <br>  In <a href="http://www.citrix.com/lang/English/lp/lp_2307783.asp">Citrix Xen Server,</a> you need to decide which processors are used on the hosts. <br>  In our case, these were <b>X3353</b> (4 cores 2.66GHz) and <b>E5502</b> (2 cores 1.86GHz). <br>  Consider processor attributes using the <code>xe host-cpu-info</code> command in Citrix XenServer. <br><pre> <code class="python hljs">[host_a] <span class="hljs-comment"><span class="hljs-comment"># xe host-cpu-info cpu_count : 4 vendor: GenuineIntel speed: 1866.734 modelname: Intel(R) Xeon(R) CPU E5502 @ 1.87GHz family: 6 model: 26 stepping: 5 flags: fpu de tsc msr pae mce cx8 apic sep mtrr mca cmov pat clflush acpi mmx fxsr sse sse2 ss ht nx constant_tsc pni vmx est ssse3 sse4_1 sse4_2 popcnt features: 009ce3bd-bfebfbff-00000001-28100800 features_after_reboot: 009ce3bd-bfebfbff-00000001-28100800 physical_features: 009ce3bd-bfebfbff-00000001-28100800 maskable: full</span></span></code> </pre><br><pre> <code class="python hljs">[host_b] <span class="hljs-comment"><span class="hljs-comment"># xe host-cpu-info cpu_count : 4 vendor: GenuineIntel speed: 2666.668 modelname: Intel(R) Xeon(R) CPU X3353 @ 2.66GHz family: 6 model: 23 stepping: 6 flags: fpu de tsc msr pae mce cx8 apic sep mtrr mca cmov pat clflush acpi mmx fxsr sse sse2 ss ht constant_tsc pni vmx est ssse3 sse4_1 features: 000ce3bd-bfebfbff-00000001-20000800 features_after_reboot: 000ce3bd-bfebfbff-00000001-20000800 physical_features: 000ce3bd-bfebfbff-00000001-20000800 maskable: base</span></span></code> </pre><br>  Save the results to E5502.txt and X3353.txt. <br>  In XenServer 5.5, there is a condition that processors can be added to the pool only if they have the same vendor, model, family, and flag values. <br>  Starting with version 5.6, only the flag values ‚Äã‚Äãof the server pool and the plug-in host must be identical to create a heterogeneous pool. <br>  You can check compatibility masks using the <a href="http://www.citrix.com/ready/hcl">Heterogeneous CPU Pool Self-Test Kit</a> : <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># ./compare-cpu E5502.txt X3353.txt -v file1: E5502.txt file2: X3353.txt pool_mask: ffffff7f-ffffffff-ffffffff-ffffffff CPU 1: model name: Intel(R) Xeon(R) CPU E5502 @ 1.87GHz features: 009ce3bd-bfebfbff-00000001-28100800 masking level: full CPU 2: model name: Intel(R) Xeon(R) CPU X3353 @ 2.66GHz features: 000ce3bd-bfebfbff-00000001-20000800 masking level: base Result: CPU 1 and CPU 2 are compatible for masking Mask type: 1 CPU 1 has a superset of features to CPU 2 Mask: 000ce3bd-bfebfbff-00000001-20000800</span></span></code> </pre><br>  Conversely, if X3353 were added to the pool with E5502 processors: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># ./compare-cpu X3353.txt E5502.txt -v file1: X3353.txt file2: E5502.txt pool_mask: ffffff7f-ffffffff-ffffffff-ffffffff CPU 1: model name: Intel(R) Xeon(R) CPU X3353 @ 2.66GHz features: 000ce3bd-bfebfbff-00000001-20000800 masking level: base CPU 2: model name: Intel(R) Xeon(R) CPU E5502 @ 1.87GHz features: 009ce3bd-bfebfbff-00000001-28100800 masking level: full Result: CPU 1 and CPU 2 are compatible for masking Mask type: 2 CPU 1 has a subset of features to CPU 2 Mask: 000ce3bd-bfebfbff-00000001-20000800</span></span></code> </pre><br>  The mask is identical, but the type of action is different. <br>  What are the functions of the processors are compared?  There are 2 sets of processor functions: basic functions and advanced.  Both types are divided into 2 halves, known as <abbr title="Counter Register">ECX</abbr> and <abbr title="Data register">EDX</abbr> .  Determining the masking options for a given pair of processors requires a comparison of the values ‚Äã‚Äãof the functions in combination with the level of masking of these processors.  For brevity, XenServer stores function values ‚Äã‚Äãin hexadecimal. <br>  Consider the functions of the E5502 and X3353 processors: <br><pre> <code class="python hljs">|| CPU model || base_ecx || base_edx || ext_ecx || ext_edx || Masking level || | E5502 | <span class="hljs-number"><span class="hljs-number">009</span></span>ce3bd | bfebfbff | <span class="hljs-number"><span class="hljs-number">00000001</span></span> | <span class="hljs-number"><span class="hljs-number">28100800</span></span> | full | | X3353 | <span class="hljs-number"><span class="hljs-number">000</span></span>ce3bd | bfebfbff | <span class="hljs-number"><span class="hljs-number">00000001</span></span> | <span class="hljs-number"><span class="hljs-number">20000800</span></span> | base |</code> </pre><br>  There are differences in Base_ecx and Ext_edx, we convert the functions into binary code to see the specific differences in the bits of the functions: <br><pre> <code class="python hljs"> || CPU model || base_ecx (bin) || ext_edx (bin) || | E5502 | <span class="hljs-number"><span class="hljs-number">000100111001110001110111101</span></span> |<span class="hljs-number"><span class="hljs-number">101000000100000000100000000000</span></span> | | X3353 | <span class="hljs-number"><span class="hljs-number">000000011001110001110111101</span></span> |<span class="hljs-number"><span class="hljs-number">100000000000000000100000000000</span></span> | | | xx | xx | | | <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> | <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> |</code> </pre><br>  In the E5502 processor, bits 21 and 24 are present in the base_ecx, which are missing in the X3353 processor.  The ext_edx functions in the E5502 processor contain bits 21 and 28, which are missing in X3353.  Because  E5502 processor fully supports masking level: full, and X3353 processor supports masking level: base, then a unifying mask is possible.  The mask can be calculated by calculating the bitwise AND, mutually exclusive processor functions will be disabled. <br><pre> <code class="python hljs">|| CPU model || base_ecx (bin) || ext_edx (bin) || | E5502 | <span class="hljs-number"><span class="hljs-number">000100111001110001110111101</span></span> |<span class="hljs-number"><span class="hljs-number">101000000100000000100000000000</span></span> | | X3353 | <span class="hljs-number"><span class="hljs-number">000000011001110001110111101</span></span> |<span class="hljs-number"><span class="hljs-number">100000000000000000100000000000</span></span> | | | xx | xx | | Joint | <span class="hljs-number"><span class="hljs-number">000000011001110001110111101</span></span> | <span class="hljs-number"><span class="hljs-number">100000000000000000100000000000</span></span> |</code> </pre><br>  We translate into hexadecimal: <br><pre> <code class="python hljs">|| base_ecx || ext_edx || | <span class="hljs-number"><span class="hljs-number">000</span></span>ce3bd | <span class="hljs-number"><span class="hljs-number">20000800</span></span>|</code> </pre><br>  We add these values ‚Äã‚Äãwith the unchanged ext_ecx and base_edx and get the union mask: <br> <code>000ce3bd-bfebfbff-00000001-20000800</code> <br>  Having looked in the Hardware Compatibility List, we are convinced that the mask was correct. <br>  It remains to apply the mask to the host with an E5502 processor: <br><pre> <code class="python hljs">xe host-set-cpu-features features=<span class="hljs-number"><span class="hljs-number">000</span></span>ce3bd-bfebfbff<span class="hljs-number"><span class="hljs-number">-00000001</span></span><span class="hljs-number"><span class="hljs-number">-20000800</span></span> uuid=&lt;host_uuid&gt;</code> </pre><br>  After rebooting the host, the E5502 has the same functions as the X3353: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># xe host-cpu-info cpu_count : 4 vendor: GenuineIntel speed: 1866.734 modelname: Intel(R) Xeon(R) CPU E5502 @ 1.87GHz family: 6 model: 26 stepping: 5 flags: fpu de tsc msr pae mce cx8 apic sep mtrr mca cmov pat clflush acpi mmx fxsr sse sse2 ss ht nx constant_tsc pni vmx est ssse3 sse4_1 sse4_2 popcnt features: 000ce3bd-bfebfbff-00000001-20000800 features_after_reboot: 000ce3bd-bfebfbff-00000001-20000800 physical_features: 009ce3bd-bfebfbff-00000001-28100800 maskable: full</span></span></code> </pre><br>  Physical Features do not change. <br>  Currently, there are no new E5-2400 and E5-2600 processors in the compatibility <a href="http://hcl.xensource.com/CPUPoolsList.aspx">matrix</a> and the masking of new Gen8 processors will be supported after the release of the next BIOS update for HP ProLiant servers: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># xe host-cpu-info cpu_count : 32 vendor: GenuineIntel speed: 2700.068 modelname: Intel(R) Xeon(R) CPU E5-2680 0 @ 2.70GHz family: 6 model: 45 stepping: 7 flags: fpu de tsc msr pae mce cx8 apic sep mtrr mca cmov pat clflush acpi mmx fxsr sse sse2 ss ht nx constant_tsc nonstop_tsc aperfmperf pni pclmulqdq vmx est ssse3 sse4_1 sse4_2 x2apic popcnt aes hypervisor ida arat tpr_shadow vnmi flexpriority ept vpid features: 17bee3ff-bfebfbff-00000001-2c100800 features_after_reboot: 17bee3ff-bfebfbff-00000001-2c100800 physical_features: 17bee3ff-bfebfbff-00000001-2c100800 maskable: no</span></span></code> </pre><br>  You can see that the functions of the E5-2680 processor differ from the E5502 functions only in base_ecx and the new processors support the Flex Migration feature (as it should be), the mask will look like: <br>  <code>009ce3bd-bfebfbff-00000001-2c100800</code> , but only with an updated BIOS version.  According <a href="http://hcl.xensource.com/CPUMatrix.aspx">to the CPU matrix</a> , E5-2600 processors are supported and can be used in XenServer 6.0, but so far only in homogeneous pools. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/145665/">https://habr.com/ru/post/145665/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145658/index.html">30 most popular passwords stolen from LinkedIn</a></li>
<li><a href="../145659/index.html">Artificial intelligence, intelligence, life ... How long to wait for them?</a></li>
<li><a href="../145661/index.html">Ukrainian App Store will appear in June</a></li>
<li><a href="../145662/index.html">iOS 6 beta is available for download to developers.</a></li>
<li><a href="../145663/index.html">How we made a plugin for kate</a></li>
<li><a href="../145666/index.html">GPU acceleration of CSS filters in Chromium</a></li>
<li><a href="../145667/index.html">Hash + salt as a panacea for the decrypt</a></li>
<li><a href="../145668/index.html">Buying a brand on the conveyor</a></li>
<li><a href="../145669/index.html">Students fined for the site with subtitles</a></li>
<li><a href="../145670/index.html">What is Red Hat CloudForms?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>