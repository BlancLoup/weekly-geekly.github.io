<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We draw on electronic map tiles in MSSQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to tell the readers of the habr community how to use the Microsoft.SqlServer.Types CLR library to create tiles for an electronic map. The artic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We draw on electronic map tiles in MSSQL</h1><div class="post__text post__text-html js-mediator-article">  I want to tell the readers of the habr community how to use the <i>Microsoft.SqlServer.Types</i> CLR library to create tiles for an electronic map.  The article will discuss the generation of a list of cartographic tiles for their further rendering.  An algorithm for generating tiles according to the geometry of objects stored in an MS SQL 2008 database will be described. The entire rendering process will be described step by step using the example at the end of the article. <br><br><img src="https://habrastorage.org/files/0b3/fcf/13d/0b3fcf13d2b04cd4909167c16976ac33.png"><br><br><h4>  Content </h4><br><hr><br>  <a href="https://habr.com/ru/post/266363/">Problem</a> <br>  <a href="https://habr.com/ru/post/266363/">Initial data</a> <br>  <a href="https://habr.com/ru/post/266363/">Decision</a> <br>  <a href="https://habr.com/ru/post/266363/">Tile store</a> <br>  <a href="https://habr.com/ru/post/266363/">Stages of preparation of tiles</a> <br>  <a href="https://habr.com/ru/post/266363/">Functions Used</a> <br>  <a href="https://habr.com/ru/post/266363/">Broken line example</a> <br>  <a href="https://habr.com/ru/post/266363/">Crossing check</a> <br>  <a href="https://habr.com/ru/post/266363/">Tile Storage Tables</a> <br>  <a href="https://habr.com/ru/post/266363/">Placing an icon on a tile</a> <br>  <a href="https://habr.com/ru/post/266363/">Tile combining</a> <br>  <a href="https://habr.com/ru/post/266363/">Geometry drawing on tile</a> <br>  <a href="https://habr.com/ru/post/266363/">Conclusion</a> <br><a name="habracut"></a><br><a name="problem"></a><br><h4>  Problem </h4><br><hr><br>  When the browser displays a large amount of geo-data in vector graphics (using SVG or CANVAS), sometimes you have to wait not only until the data is uploaded to the client machine, but also until the rendering process takes place, which can take too long. <br>  When displaying a large number of icons on the map in the browser, you can apply clustering, but for complex geometric objects you need to use a different approach. <br><br clear="all"><br><h4>  Initial data: </h4><a name="source-data"></a><br><hr><br>  A set of geometric objects is stored in a Microsoft SQL 2008 database table. Node coordinates are latitude and longitude (EPSG: 4326).  The field with geo-data is of type <i>GEOMETRY</i> .  Objects should be displayed on the map as an icon for <i>Point</i> geometry.  In the form of a broken line of a certain thickness for the geometry of <i>Polyline</i> .  Polygon geometry should be displayed as one or more filled polygons with a contour.  Tiles must match the projection of the <a href="http://spatialreference.org/ref/sr-org/7483/">Web Mercator</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Decision: </h4><a name="solution"></a><br><hr><br>  Instead of vector graphics, we will display objects on the map as a raster layer, that is, with the same images (tiles) as the map itself.  To do this, it is necessary to prepare a set of map tiles for each scale with the image of objects.  For the formation of tiles, we will use the <i>Google Web Mercator</i> projection, that is, the transformation of latitude and longitude to map pixels will be performed using google code, which uses formulas describing the <a href="">Mercator projection</a> : <br>  Read more about the projection can be read <a href="http://habrahabr.ru/post/239251/">here</a> . <br>  Starting with Sql Server 2008, the <i>GEOMETRY</i> and <i>GEOGRAPHY</i> data <i>types are</i> supported for working with spatial data. <br>  Existing cartographic services from Yandex, Google or OpenStreetMap were provided as cartography in the form of PNG images, of fixed size, usually 256x256 pixels.  Although now there are services where tiles are formed using technologies such as SVG or CANVAS.  We will consider raster tiles in PNG format (picture network graphic).  PNG format supports transparency (indicated in the alpha channel), thanks to which it is possible to overlay the tiles on each other without absolute overlap, when displaying multiple layers. <br><br><h4>  Tile store </h4><a name="tile-storage"></a><br><hr><br>  For each scale a certain set of tiles is stored.  For the scale of the 0th level - 1 tile: <br><img src="https://habrastorage.org/getpro/habr/post_images/68a/598/90d/68a59890d1768a5786cfc0a18fa34555.jpg" alt="image"><br><br>  For the scale of the 1st level four tiles 2 * 2: <br><img src="https://habrastorage.org/files/a19/298/036/a192980365ba4a999d4260035d96d4ed.jpg"><br>  for the scale n, 2n * 2n tiles are stored.  The number of tiles with an increase in the scale number increases exponentially. <br><cut><br>  Tiles are stored in the file system of the Web server and sent to the client‚Äôs machine using an http request, for example: <br>  <a href="http://someurl/layer/">someurl / layer</a> {Z} / {X} / {Y} .png <br>  where Z, X, Y are respectively the scale, X is the position of the tile, Y is the position of the tile.  For example, by the following url, a tile with the image of the Trinity Bridge in St. Petersburg is available: <br>  <a href="">b.tile.openstreetmap.org/15/19144/9524.png</a> <br>  In this url: <br>  15 - scale number; <br>  19144‚Äì X tile position; <br>  9524 - Y tile position. <br>  Naturally, in different systems, the URL format of the request is different.  Instead of tile numbers and scale, a <a href="http://wiki.openstreetmap.org/wiki/QuadTiles">QUAD-key</a> can be used to request tiles.  Tile files can be sent to the client by the server directly from the file system or using http handlers.  We will consider the option with X, Y, Z. <br><a name="steps-to-prepare-tiles"></a><br><h4>  Stages of preparation of tiles </h4><br><hr><br><ul><li>  Forming a list of tiles by the geometry of each object; </li><li>  Generation of tiles for each object; </li><li>  Combining tiles to get a unique set; </li><li>  Save to file system. </li></ul><br><a name="functions-to-be-used"></a><br><h4>  Functions Used </h4><br><hr><br>  To accomplish the task, you will need a function for generating tile geometry by X, Y tile positions and a scale number.  The tile geometry in our case is a rectangle covering the tile with the coordinates of the angles expressed in latitude and longitude.  The formation of such a geometry can be implemented in the SQL function or in the SQL CLR function.  The difference in the runtime of the SQL CLR function and the normal SQL function is not noticeable.  The SQL CLR code of the function is implemented in the Coords2PixelConversion class in the attached source codes. <br>  The following geometry is the contour of this tile, that is, passes along its boundaries.  The vertex coordinates here are longitude and latitude. <br><div class="spoiler">  <b class="spoiler_title">Tile Border Geometry</b> <div class="spoiler_text"><pre><code class="sql hljs">'POLYGON ((30.322265625 59.955010262062061, 30.322265625 59.949509172252277, 30.333251953125 59.949509172252277, 30.333251953125 59.955010262062061, 30.322265625 59.955010262062061))'</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Scalar SQL function code tile.GetTileBounds ()</b> <div class="spoiler_text"><pre> <code class="sql hljs">tile.GetTileBounds(@level int, @x int, @y int) <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> [tile].[GetTileBounds] (@<span class="hljs-keyword"><span class="hljs-keyword">level</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, @x <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, @y <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> geometry <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @res GEOMETRY = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">level</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> @x <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> @y <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @n1 <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">PI</span></span>() - <span class="hljs-number"><span class="hljs-number">2.0</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">PI</span></span>() * @y / <span class="hljs-keyword"><span class="hljs-keyword">POWER</span></span>(<span class="hljs-number"><span class="hljs-number">2.0</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">level</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @n2 <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">PI</span></span>() - <span class="hljs-number"><span class="hljs-number">2.0</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">PI</span></span>() * (@y + <span class="hljs-number"><span class="hljs-number">1</span></span>) / <span class="hljs-keyword"><span class="hljs-keyword">POWER</span></span>(<span class="hljs-number"><span class="hljs-number">2.0</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">level</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @top <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> = (<span class="hljs-number"><span class="hljs-number">180.0</span></span> / <span class="hljs-keyword"><span class="hljs-keyword">PI</span></span>() * <span class="hljs-keyword"><span class="hljs-keyword">ATAN</span></span>(<span class="hljs-number"><span class="hljs-number">0.5</span></span> * (<span class="hljs-keyword"><span class="hljs-keyword">EXP</span></span>(@n1) - <span class="hljs-keyword"><span class="hljs-keyword">EXP</span></span>(-@n1)))); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @bottom <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> = (<span class="hljs-number"><span class="hljs-number">180.0</span></span> / <span class="hljs-keyword"><span class="hljs-keyword">PI</span></span>() * <span class="hljs-keyword"><span class="hljs-keyword">ATAN</span></span>(<span class="hljs-number"><span class="hljs-number">0.5</span></span> * (<span class="hljs-keyword"><span class="hljs-keyword">EXP</span></span>(@n2) - <span class="hljs-keyword"><span class="hljs-keyword">EXP</span></span>(-@n2)))); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @tileWidth <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> = <span class="hljs-number"><span class="hljs-number">360</span></span> / <span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">float</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">POWER</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">level</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> = @tileWidth * @x - <span class="hljs-number"><span class="hljs-number">180</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">right</span></span> <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> = @tileWidth * (@x + <span class="hljs-number"><span class="hljs-number">1</span></span>) - <span class="hljs-number"><span class="hljs-number">180</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @res = geometry::STPolyFromText(<span class="hljs-string"><span class="hljs-string">'POLYGON (('</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(@<span class="hljs-keyword"><span class="hljs-keyword">left</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)) + <span class="hljs-string"><span class="hljs-string">' '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(@top, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)) + <span class="hljs-string"><span class="hljs-string">', '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(@<span class="hljs-keyword"><span class="hljs-keyword">left</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)) + <span class="hljs-string"><span class="hljs-string">' '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(@bottom, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)) + <span class="hljs-string"><span class="hljs-string">', '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(@<span class="hljs-keyword"><span class="hljs-keyword">right</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)) + <span class="hljs-string"><span class="hljs-string">' '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(@bottom, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)) + <span class="hljs-string"><span class="hljs-string">', '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(@<span class="hljs-keyword"><span class="hljs-keyword">right</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)) + <span class="hljs-string"><span class="hljs-string">' '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(@top, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)) + <span class="hljs-string"><span class="hljs-string">', '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(@<span class="hljs-keyword"><span class="hljs-keyword">left</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)) + <span class="hljs-string"><span class="hljs-string">' '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(@top, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)) + <span class="hljs-string"><span class="hljs-string">'))'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> @res <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br></div></div><br>  How to use this feature will be discussed later in this article. <br><br>  Consider the methods of forming a list of tiles.  For different geometries, you can choose different approaches to the formation of a list of tiles. <br><br clear="all"><h6>  Method 1: </h6><br>  Let us take advantage of this circumstance: If on one scale the object does not intersect with the tile, then on a scale with a large number 4 tiles that overlap the checked tile, they also do not intersect with the object.  That is, when going to the next scale, we perform a tile check only if the previous scale tile intersects with the geometry of the object.  This eliminates unnecessary checks that are performed in method 2. <br><br><h6>  Method 2: </h6><br>  In fact, this way - the worst case scenario.  For each scale for each object, define a subset of tiles with the <i>GEOMETRY :: STEnvelope ()</i> function and check the intersection of the tile from this subset with the object.  This method is less effective, especially for objects with a large area or length, since more tiles are checked. <br><br><h6>  Method 3: </h6><br>  For each object to form the geometry of the tile grid, on the intersection of the grid with the geometry of the object to get a set of points.  For each obtained point, define two tiles and add them to the final list of tiles. For example, for a complex geographic line passing through the continent, you can find points of intersection with a grid passing along the borders of the tiles, and from these points you can determine the tiles for rendering.  The grid is created within the boundaries of the rectangular area containing the line, and is a set of vertical and horizontal lines.  It is much more efficient than checking each tile within the boundaries of a rectangular area of ‚Äã‚Äãan object. <br>  We describe the first method in more detail.  For feature geometries that have an area, a set of tiles for checking intersections with an object can be limited to the extreme tiles of a rectangular area (bbox) that overlaps the object. <br>  According to the geometry of the object (except for the <i>POINT</i> geometry type), a rectangle CLR is formed by the function MSSQL <i>GEOMETRY :: STEnvelope ().</i>  For <i>POINT</i> geometry objects, a rectangular area overlapping the object icon on the map is used as the bbox border.  The <i>GetImageBound</i> function, which returns a geometry overlapping icon, is implemented in the <i>GoogleProjection</i> class.  It also implemented methods for converting latitude and longitude into pixel position numbers.  The coordinates of the corner points of a rectangular area are expressed in latitude and longitude.  Next we get a subset of tiles covering the resulting rectangle.  To do this, we need the function of converting geographic coordinates into a tile number at the appropriate scale.  To get the X and Y positions of the tile in longitude and latitude, we can use either the SQL CLR functions, which will be given below, or the SQL functions listed below: <br><br><pre> <code class="sql hljs">tile.GetXTilePos((@Longitude FLOAT, @Zoom INT) tile.GetYTilePos((@Latitude FLOAT, @Zoom INT)</code> </pre><br><br>  After determining the positions of the corner tiles, all tiles that are in the rectangular area between the corner tiles found are checked for intersection with the geometry of the object in the <a href="https://habr.com/ru/post/266363/"><i>tile.fn_FetchGeometryTilesZoomDepth ()</i></a> function. <br><br><div class="spoiler">  <b class="spoiler_title">SQL function to get X tile position for longitude and scale number</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> tile.GetXTilePos(@Longitude <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span>, @Zoom <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @D <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span>,@E <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span>,@F <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span>,@G <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span>, @tileY <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, @tileX <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @D = <span class="hljs-number"><span class="hljs-number">128</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">POWER</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>, @Zoom) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @E = <span class="hljs-keyword"><span class="hljs-keyword">ROUND</span></span>(@D + @Longitude * <span class="hljs-number"><span class="hljs-number">256</span></span> / <span class="hljs-number"><span class="hljs-number">360</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">POWER</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>, @Zoom), <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @tileX = <span class="hljs-keyword"><span class="hljs-keyword">Floor</span></span>(@E / <span class="hljs-number"><span class="hljs-number">256</span></span>); RETURN @tileX <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br></div></div><br><br clear="all"><div class="spoiler">  <b class="spoiler_title">The function of getting the Y position of the tile for latitude and scale number</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> tile.GetYTilePos(@Latitude <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span>, @Zoom <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @A <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span>, @B <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span>, @C <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span>, @D <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span>, @E <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span>, @F <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span>, @G <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span>, @tileY <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @D = <span class="hljs-number"><span class="hljs-number">128</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">POWER</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>, @Zoom) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @A = <span class="hljs-keyword"><span class="hljs-keyword">Sin</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">PI</span></span>() / <span class="hljs-number"><span class="hljs-number">180</span></span> * @Latitude) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @B = <span class="hljs-number"><span class="hljs-number">-0.9999</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @C = <span class="hljs-number"><span class="hljs-number">0.9999</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @A &lt; @B <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @A = @B <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @A &gt; @C <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @A = @C <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @F = @A <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @G = <span class="hljs-keyword"><span class="hljs-keyword">Round</span></span>(@D + <span class="hljs-number"><span class="hljs-number">0.5</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">Log</span></span>((<span class="hljs-number"><span class="hljs-number">1.0</span></span> + @F) / (<span class="hljs-number"><span class="hljs-number">1.0</span></span> - @F)) * (<span class="hljs-number"><span class="hljs-number">-256</span></span>) * <span class="hljs-keyword"><span class="hljs-keyword">POWER</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>, @Zoom) / (<span class="hljs-number"><span class="hljs-number">2</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">PI</span></span>()),<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @tileY = <span class="hljs-keyword"><span class="hljs-keyword">Floor</span></span>(@G / <span class="hljs-number"><span class="hljs-number">256</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> @tileY <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br></div></div><br>  In the <a href="https://habr.com/ru/post/266363/"><i>tile.fn_FetchGeometryTilesZoomDepth ()</i></a> function, the left upper and right lower tile of the minimum rectangular area covering the geometry is calculated.  Then, to determine the intersection of a shape with a tile in a nested loop, we use the <a href="https://habr.com/ru/post/266363/"><i>tile.fn_GetTilesByTileNumZoomDepth ()</i></a> function for each tile in this area, passing from left to right and from top to bottom from the left top tile to the bottom right one.  The function returns a list of tiles for which the intersection with the object's geometry has been defined. <br><a name="fetch-geometry-tiles-zoom-deph-fn-source"></a><br><div class="spoiler">  <b class="spoiler_title">The function of getting a set of tiles</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> tile.fn_FetchGeometryTilesZoomDepth ( @GeoData GEOMETRY, @Zoom <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">Depth</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> @retTiles <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> ( Zoom <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, TileX <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, TileY <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">Left</span></span> <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">Right</span></span> <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span>, @Top <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span>, @Bottom <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @CurrentXTile <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, @CurrentYTile <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, @Quanttiles <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @Envelope GEOMETRY, @RightTop GEOMETRY, @LeftBottom GEOMETRY <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @CurTileGeom GEOMETRY, @res GEOMETRY <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @tiletop <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span>,@tilebottom <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span>,@tileleft <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span>, @tileright <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @LeftTilePos <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>,@RightTilePos <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>,@TopTilePos <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @BottomTilePos <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @envelope = @GeoData.STEnvelope() <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @RightTop = @envelope.STPointN(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @LeftBottom = @envelope.STPointN(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">Right</span></span> = @RightTop.STX <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">Left</span></span> = @LeftBottom.STX <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @Top = @RightTop.STY <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @Bottom = @LeftBottom.STY <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @LeftTilePos = tile.GetXTilePos( @<span class="hljs-keyword"><span class="hljs-keyword">Left</span></span>,@Zoom) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @RightTilePos = tile.GetXTilePos( @<span class="hljs-keyword"><span class="hljs-keyword">Right</span></span>,@Zoom) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @TopTilePos = tile.GetYTilePos( @Top,@Zoom) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @BottomTilePos = tile.GetYTilePos( @Bottom,@Zoom) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @CurrentXTile = @LeftTilePos <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @CurrentXTile &lt;= @RightTilePos <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @currentYTile = @TopTilePos <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @CurrentYTile &lt;= @BottomTilePos <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @retTiles (Zoom, TileX, TileY) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tile.fn_GetTilesByTileNumZoomDepth ( @GeoData, @Zoom, @CurrentXTile, @CurrentYTile, @<span class="hljs-keyword"><span class="hljs-keyword">Depth</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @CurrentYTile = @CurrentYTile + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @CurrentXTile =@CurrentXTile + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br></div></div><br>  Checking the intersection of the geometry of the tile with the geometry of the object will be a function <i>GEOMETRY :: STIntersects ()</i> .  If the geometry of the object and the geometry of the tile overlap, then we add an entry to the previously created table <i>tile.TileOverlap</i> and call the same function recursively for the four tiles of the next scale covering the current one, with the <i>@Depth</i> parameter reduced by a unit.  The intersection check is implemented in the <a href="https://habr.com/ru/post/266363/"><i>tile.fn_FetchGeometryTilesZoomDepth ()</i></a> function. <br><a name="get-tiles-by-tile-num-zoom-depth-fn-source"></a><br><div class="spoiler">  <b class="spoiler_title">Retrieving a list of tiles by geometry for the specified tile</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> tile.fn_GetTilesByTileNumZoomDepth ( @GeoData GEOMETRY, @Zoom <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, @tileX <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, @tileY <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">Depth</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> @retTiles <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> ( Zoom <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, X <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, Y <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @currentTile <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> ( Zoom <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, X <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, Y <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> GEOGRAPHY::STGeomFromWKB([tile].[GetTileBounds](@Zoom, @tileX, @tileY).STAsBinary(),<span class="hljs-number"><span class="hljs-number">4326</span></span>).STIntersects(GEOGRAPHY::STGeomFromWKB(@GeoData.MakeValid().STUnion(@GeoData.STStartPoint()).STAsBinary(),<span class="hljs-number"><span class="hljs-number">4326</span></span>)) = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @currentTile <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @Zoom , @tileX , @tileY <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @retTiles <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> d.zoom, dX, dY <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> @currentTile c <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">APPLY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [tile].[fn_GetTilesForObjectByTileNumZoomDepth]( @GeoData , c.Zoom + <span class="hljs-number"><span class="hljs-number">1</span></span>, cX * <span class="hljs-number"><span class="hljs-number">2</span></span>, cY * <span class="hljs-number"><span class="hljs-number">2</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">Depth</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">Depth</span></span> &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> d <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @retTiles <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> d.zoom, dX, dY <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> @currentTile c <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">APPLY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [tile].[fn_GetTilesForObjectByTileNumZoomDepth]( @GeoData , c.Zoom + <span class="hljs-number"><span class="hljs-number">1</span></span>, cX * <span class="hljs-number"><span class="hljs-number">2</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>, cY * <span class="hljs-number"><span class="hljs-number">2</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">Depth</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">Depth</span></span> &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> d <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @retTiles <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> d.zoom, dX, dY <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> @currentTile c <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">APPLY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [tile].[fn_GetTilesForObjectByTileNumZoomDepth]( @GeoData , c.Zoom + <span class="hljs-number"><span class="hljs-number">1</span></span>, cX * <span class="hljs-number"><span class="hljs-number">2</span></span>, cY * <span class="hljs-number"><span class="hljs-number">2</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">Depth</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">Depth</span></span> &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> d <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @retTiles <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> d.zoom, dX, dY <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> @currentTile c <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">APPLY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [tile].[fn_GetTilesForObjectByTileNumZoomDepth]( @GeoData , c.Zoom + <span class="hljs-number"><span class="hljs-number">1</span></span>, cX * <span class="hljs-number"><span class="hljs-number">2</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>, cY * <span class="hljs-number"><span class="hljs-number">2</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">Depth</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">Depth</span></span> &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> d <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @retTiles <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> @currentTile <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br></div></div><br><br clear="all">  If it is necessary to create tiles for one object, tile numbers can be written directly to the <i>tile.Tile</i> table, since the tile set will be unique.  To form a tile with which the geometries of several objects intersect, you need to combine the tiles created for different objects and overlapping each other. <br>  The <a href="https://habr.com/ru/post/266363/"><i>tile.fn_GetTilesByTileNumZoomDepth ()</i></a> function checks the intersection of object geometry with scale tiles, taking into account the specified depth.  The <i>@Depth</i> parameter specifies the check depth, for example, if <i>@Zoom</i> = 2 and <i>@Depth</i> = 1, then a scale 2 tile will be checked, and if there is an intersection, 4 scale tiles 3 will be checked. These tiles must be checked, since they overlap the tile from the previous scale .  The intersection check should be performed after converting the <i>GEOMETRY</i> data <i>type</i> to <i>GEOGRAPHY</i> , this is important, since for the <i>GEOGRAPHY</i> data type the check is performed taking into account that all coordinates of geometry points in the 4326 projection, that is, we deal with geometric objects on the sphere. <br><a name="polyline-example"></a><br><h4>  Broken line example </h4><br><hr><br>  Suppose we want to get tiles for the broken line connecting the center of St. Petersburg with the center of Moscow.  The length of approximately 800 km.  Broken will pass through the settlements: Novgorod - Vyshny drap - Tver. <br><div class="spoiler">  <b class="spoiler_title">Geometry of a broken line from St. Petersburg to Moscow</b> <div class="spoiler_text"><pre> <code class="sql hljs">'LINESTRING( 30.381113 59.971474, 31.26002 58.539215, 34.564158 57.591722, 35.915476 56.876838,37.622242 55.773125)'</code> </pre><br></div></div><br>  For this geometry from 3 to 17 the scale we get the total of tiles 11076, the distribution of the number of tiles intersecting with the geometry by scales is given in <a href="https://habr.com/ru/post/266363/">table 1</a> <br><a name="tiles-count-distribution-by-zoom-table"></a><br><div class="spoiler">  <b class="spoiler_title">Table 1 - Distribution of the number of tiles by scale levels</b> <div class="spoiler_text"><table><tbody><tr><th>  Scale </th><th>  Number of tiles </th></tr><tr><td>  3 </td><td>  one </td></tr><tr><td>  four </td><td>  2 </td></tr><tr><td>  five </td><td>  3 </td></tr><tr><td>  6 </td><td>  four </td></tr><tr><td>  7 </td><td>  7 </td></tr><tr><td>  eight </td><td>  12 </td></tr><tr><td>  9 </td><td>  23 </td></tr><tr><td>  ten </td><td>  45 </td></tr><tr><td>  eleven </td><td>  88 </td></tr><tr><td>  12 </td><td>  174 </td></tr><tr><td>  13 </td><td>  347 </td></tr><tr><td>  14 </td><td>  692 </td></tr><tr><td>  15 </td><td>  1383 </td></tr><tr><td>  sixteen </td><td>  2766 </td></tr><tr><td>  17 </td><td>  5529 </td></tr></tbody></table><br></div></div><br>  Tiles obtained for the 3rd and 4th scale are shown in Figure 1: <br><img src="https://habrastorage.org/files/c84/948/b5e/c84948b5e595451caf72736ee6995ae3.png"><img src="https://habrastorage.org/files/c6a/fd5/480/c6afd548047b418a970c57c2ff2ae7d0.png"><br><br>  Figure 1 - Tiles: 3/4/2 and 4/9/4 <br><br>  For each scale, a subset of tiles is formed and each tile is checked without exception.  On the 4-5 scale, the number of tiles falling into a rectangular area obtained by the <i>GEOMETRY :: STEnvelope ()</i> function on the geometry of the object will be small.  The total tiles on the 4 scale are 2 ^ 4 * 2 ^ 4 = 256. But on the 16 and 17 scales it will be necessary to check for many more tiles.  The elimination of ‚Äúextra‚Äù checks in the first method will speed up the work.  For objects with a point geometry ( <i>POINT</i> ), both methods will have the same efficiency. <br><br><a name="intersection-detection"></a><br><h4>  Crossing check </h4><br><hr><br>  The <i>GEOMETRY :: STIntersects ()</i> function may not determine the intersection of the object's geometry with the tile geometry, since the STIntersects () function for the GEOMETRY data type works with coordinates on a plane, and the latitude and longitude are not Cartesian coordinates.  Therefore, to reliably determine the intersection, we convert the type <i>GEOMETRY</i> into the type <i>GEOGRAPHY</i> .  It should be noted that, in contrast to the <i>GEOMETRY</i> data type, the <i>GEOGRAPHY</i> data type requires that the orientation of polygon rings is respected.  The coordinates of the outer rings should go counterclockwise.  For internal rings (voids), the coordinates should be listed clockwise.  To avoid errors in the formation of geography, we use the functions <i>GEOMETRY :: MakeValid ()</i> and <i>GEOMETRY :: STUnion ()</i> to obtain the correct coordinate sequence, when converting the type GEOMETRY to type GEOGRAPHY.  When creating geography, we specify the parameter SRID = 4326, which means that all operations on the coordinates are performed in a <a href="http://en.wikipedia.org/wiki/World_Geodetic_System">spherical system</a> . <br><br>  At this stage, when the list of tiles is received, that is, a table with three columns: Z, X, Y;  Further work can be performed using the mapnik rewriting <a href="https://github.com/mapnik/mapnik/wiki/XMLConfigReference">program</a> , which allows you to create tiles with an image of objects.  Organizing mapnik access to a Microsoft SQL Server database requires some effort.  Preparation for generating tiles in mapnik includes the following steps: <br>  ‚Ä¢ Declare the style of objects for rendering; <br>  ‚Ä¢ Describe the source of data geometry objects; <br>  ‚Ä¢ Specify a table with a list of tiles for rendering, so as not to generate all the tiles in a row. <br>  We will perform the generation of tiles within the MS SQL Server 2008 database. To do this, you must implement several CLR functions for working with the geometry stored in the database.  The main functions that we need are listed below: <br><ul><li>  <i>tile.IconTile (),</i> </li><li>  <i>tile.ShapeTile (),</i> </li><li>  <i>tile.TileAgg (),</i> </li><li>  <i>tile.SaveToFolderByZoomXY ()</i> </li></ul>  . <br><a name="tables-to-store-tile-images"></a><br><h4>  Tile Storage Tables </h4><br><hr><br>  <a href="https://habr.com/ru/post/266363/">Figure 2</a> shows the structure of the tables, where the list of tiles for rendering is stored.  In the Data field in these tables, a PNG image with the image of objects falling on the tile will be saved.  Storing and processing a large number of pictures in a table can affect performance.  For this task, a more suitable option is to generate tile images outside the database using the list of tiles generated in the table for each object and then saving to the file system. <br><a name="picture1-tables-to-store-tiles"></a><br><img src="https://habrastorage.org/files/010/700/c06/010700c06a0741af99006ddb3310e58b.png"><br>  Figure 2 - Tables for storing the list of tiles <br><a name="tile-positioning"></a><br><h4>  Placing an icon on a tile </h4><br><hr><br>  Let us analyze the positioning algorithms of the icon on the tile (POINT geometry type). <br>  There is a latitude and longitude of some object, there is a list of tiles of the current scale, on which the icon is superimposed.  The formation of the list of tiles was described earlier.  The calculation of the position of the icon on the tile consists of the following actions: <br>  1. First, convert latitude and longitude to absolute pixel coordinates; <br>  2. Then, for each tile, from the available list, on the current scale, we calculate the absolute pixel coordinates of the upper left corner.  coordinates of the upper left pixel of a tile (pixXtile, pixYtile) are calculated by multiplying the x and y position of the tile by its size, in our case, it is 256 pixels; <br><a name="point-positioning-step3"></a><br>  3. The difference between the absolute pixel coordinates of the object and the absolute pixel coordinates of the upper-left corner of the tile are defined in the function GetPixelXOnTile () and GetPixelXOnTile ().  This difference is the relative pixel coordinates of the center of the icon on the tile; <br>  4. To draw an icon on a tile, you need to get the borders of the drawing area on the tile in pixels, into which the insertion will take place.  The relative pixel coordinates of the object on the tile were obtained in the previous step.  Now, the size of the icon defines the borders of the rectangular area to be inserted. <br>  5. We draw the icon on the tile. <br><br><div class="spoiler">  <b class="spoiler_title">CLR SQL function placing the icon on the tile</b> <div class="spoiler_text"><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Microsoft.SqlServer.Server.SqlFunction</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> SqlBinary </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IconTile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SqlBinary image, SqlInt32 zoom, SqlDouble Lon, SqlDouble Lat, SqlInt32 xTile, SqlInt32 yTile, SqlDouble scale</span></span></span><span class="hljs-function">)</span></span> { SqlBinary result = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (Icon2TileRendering paster = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Icon2TileRendering()) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (MemoryStream ms = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemoryStream()) { ms.Write(image.Value, <span class="hljs-number"><span class="hljs-number">0</span></span>, image.Length); SetBeginPosition(ms); paster.PasteFromStreamScaledImageToTile((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)zoom, (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>)Lon, (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>)Lat, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)xTile, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)yTile, (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>)scale, ms); result = paster.GetBytes(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Get the bounds of the drawing area</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">region</span></span></span><span class="hljs-meta"> [Pixel Position Calculation] Rectangle GetTargetBound(int zoom, double Lon, double Lat, int xTile, int yTile, int width, int height) { int xPix = _conv.FromLongitudeToXPixel(Lon, zoom); int yPix = _conv.FromLatitudeToYPixel(Lat, zoom); int xPos = xPix - xTile * TILE_SIZE; int yPos = yPix - yTile * TILE_SIZE; int halfWidth = width / 2; int halfHeight = height / 2; return new Rectangle(xPos - halfWidth, yPos - halfHeight, width, height } int GetPixelXOnTile(int zoom, double Lon, int xTile) { return _conv.FromLongitudeToXPixel(Lon, zoom) - xTile * TILE_SIZE; } int GetPixelYOnTile(int zoom, double Lat, int yTile) { return _conv.FromLatitudeToYPixel(Lat, zoom) - yTile * TILE_SIZE; } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endregion</span></span></span><span class="hljs-meta"> [Pixel Position Calculation]</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Copying an icon to a tile</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="zoom"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="Lon"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="Lat"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="xTile"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="yTile"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="iconImage"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> public void PasteImageToTileByLatLon(int zoom, double Lon, double Lat, int xTile, int yTile, Bitmap iconImage) { int width = iconImage.Width; int height = iconImage.Height; CopyRegionIntoImage(iconImage, new Rectangle(0, 0, width, height), GetTargetBound(zoom, Lon, Lat, xTile, yTile, width, height)); }</span></span></code> </pre><br></div></div><br><a name="tile-combining"></a><br><h4>  Tile combining </h4><br><hr><br>  Icons of several objects can be superimposed on the same tile.  To get tiles with all objects, you can first create tiles for each object, then merge them into one.  Such a solution can be implemented by grouping rows of a database table; for this purpose, a CLR function has been created to aggregate <i>tile.TileAgg ()</i> , which combines tiles into one.  This solution has one drawback, since for each object that is intersecting with a tile, we will store a separate record with a BINARY field that stores a tile image, with an election of only this object, which requires a large amount of memory.  A better solution is to use one instance of the tile, and consistently display on it all the object icons falling on it.  Thus, we spend less memory.  In this case, there is simply nothing to group.  We want to use grouping. <br><div class="spoiler">  <b class="spoiler_title">Filling the table with tile positions and tile images with icons drawn on them</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> PROC [tile].[FillObjectTilesIntersection]( @StartZoom <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, @EndZoom <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @CurrentZoom <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @CurrentZoom = @StartZoom <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @CurrentZoom &lt;= @EndZoom <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> tile.Tile (X,Y,<span class="hljs-keyword"><span class="hljs-keyword">Data</span></span>,Zoom) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.TileX,t.TileY, [tile].[TileAgg] (tile.IconTile(i.Data, @CurrentZoom,o.Longitude,o.Latitude,t.tileX,t.tileY, <span class="hljs-number"><span class="hljs-number">1.0</span></span>) ),@CurrentZoom <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> Zoom <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tile.Shape o <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> tile.[Image] i <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> i.ImageID = o.ImageID <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">APPLY</span></span> tile.fn_FetchObjectTiles(tile.GetIconBoundForZoom(o.Longitude, o.Latitude, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, @CurrentZoom, <span class="hljs-number"><span class="hljs-number">0</span></span>),@CurrentZoom) t <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> o.TypeID = @TypeID <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t.TileX,t.TileY <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @CurrentZoom = @CurrentZoom + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br></div></div><br>  As the source of the objects we will use the <i>tile.Object</i> table with the coordinates of the objects and the identifier of the image of the icon stored in the <i>tile.Image</i> table in the <i>Binary</i> type field. <br><div class="spoiler">  <b class="spoiler_title">Script of formation of tiles 3/4/2 and 4/9/4 with positioning of the icon at longitude 30.381113 and latitude 59.971474</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @Image VARBINARY(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">1</span></span>) @image = ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OPENROWSET(<span class="hljs-keyword"><span class="hljs-keyword">BULK</span></span> N<span class="hljs-string"><span class="hljs-string">'d:\media\icons\pin_orange.png'</span></span>, SINGLE_BLOB) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> tile) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [tile].[SaveToFolderByZoomXY]([tile].[IconTile](@image, <span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">30.381113</span></span>, <span class="hljs-number"><span class="hljs-number">59.971474</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>), N<span class="hljs-string"><span class="hljs-string">'D:\Tiles\',3,4,2) SELECT [tile].[SaveToFolderByZoomXY]([tile].[IconTile](@image, 4,30.381113, 59.971474, 9, 4, 1.0), N'</span></span>D:\Tiles\<span class="hljs-string"><span class="hljs-string">',4,9,4)</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Figure 3 - The resulting tiles with the icon</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/52c/e97/58b/52ce9758bcc84a00b61a8f80d8325966.png"><img src="https://habrastorage.org/files/ddf/973/ad1/ddf973ad106e4baeaf45a45f166b6800.png"><br></div></div><br><br><a name="draw-geometry-on-a-tile"></a><br><h4>  Geometry drawing on tile </h4><br><hr><br>  For a polyline (POLYLINE, MULTIPOLYLINE), we combine the geometry of the tile with the geometry of the polyline, so part of the polyline is outside the tile area.  The algorithm for determining the contour and the region to be painted can be applied to geometries with an area, that is, <i>POLYGON</i> , <i>MULTIPOLYGON</i> , <i>GEOMETRYCOLLECTION</i> containing <i>POLYGON</i> or <i>MULTYPOLYGON</i> .  The algorithm is implemented in the <i>ShapeToTileRendering</i> class and includes the following steps: <br>  1. The coordinates (latitude, longitude) of the geometry are converted into pixel coordinates, taking into account the scale by converting the latitude, longitude into PSG3857 pixels (Google projection), and subtracting the coordinates of the upper left pixel of the target tile from each coordinate of the obtained geometry.  We obtain the so-called geometry ( <b>A</b> ).  These actions are implemented in the function <i>ConvertToZoomedPixelZeroedByTileGeometry (poly, Z, X, Y)</i> <br>  2. The geometry ( <b>B</b> ) of the tile is formed in pixel coordinates, taking into account the scale <br><a name="geometry-forming-step3"></a><br>  3. The geometry ( <b>C</b> ) obtained by the intersection ( <i>STIntersection</i> ) of the pixel geometry of the tile ( <b>B</b> ) with the geometry of the object ( <b>A</b> ) is formed <br>  4. A geometry is formed ( <b>D</b> ) resulting from the intersection of the geometry contour ( <b>C</b> ) and the geometry contour of the tile ( <b>B</b> ), we obtain the lines passing along the border of the tile and bordering with the intended area to be painted over within the tile.  Geometry ( <b>E</b> ) resulting from the subtraction is formed using the function <i>.STDifference (other_geometry)</i> <br><a name="geometry-forming-step5"></a><br>  5. Geometry ( <b>E</b> ) is the contour for drawing, which is obtained by subtracting from the contour ( <i>LINESTRING</i> or <i>MULTILINSTRING</i> ) geometry ( <b>C</b> ) geometry ( <b>D</b> ) using the function <br>  6. Filled geometry polygon ( <b>C</b> ) - received filled area <br>  7. The geometry of the ( <b>E</b> ) contour of the polygon is drawn after excluding the intersection with the tile bound <br>  8. Repeat steps 1 through 7 for all tiles of the current object and save them into the <i>tile.TileOverlap</i> table <i>.</i> <br>   3       15-   X    19144  Y    9524.      T-SQL .      ,   : <br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [tile].[GetTileBounds](<span class="hljs-number"><span class="hljs-number">15</span></span>,<span class="hljs-number"><span class="hljs-number">19144</span></span>,<span class="hljs-number"><span class="hljs-number">9524</span></span>).ToString()</code> </pre><br>   : <br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><pre> <code class="sql hljs"> 'POLYGON ((30.322265625 59.955010262062061, 30.322265625 59.949509172252277, 30.333251953125 59.949509172252277, 30.333251953125 59.955010262062061, 30.322265625 59.955010262062061))'</code> </pre><br></div></div><br>       ,      .       .           .  ,   ,        6367 .        , ( ),   ,         .   ,         .    ,    360    90 ,    .    ,  c               ,    .        : <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [tile].[fn_GetCircleSegment](<span class="hljs-number"><span class="hljs-number">30.3277587890625</span></span>, <span class="hljs-number"><span class="hljs-number">59.952259717159905</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">360</span></span>,<span class="hljs-number"><span class="hljs-number">440</span></span>,<span class="hljs-number"><span class="hljs-number">90</span></span>)</code> </pre><br>         <a href="https://jsfiddle.net/den367/nqf1eL13/embedded/result/">  <img width="30" height="30" src="https://habrastorage.org/files/73f/ec2/2f8/73fec22f8fae4ec59dfc05980dac5455.png"></a> <br><div class="spoiler"> <b class="spoiler_title">      </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> [tile].[fn_ GetCircleSegment] (@X <span class="hljs-built_in"><span class="hljs-built_in">float</span></span>, @Y <span class="hljs-built_in"><span class="hljs-built_in">float</span></span>, @azimuth <span class="hljs-built_in"><span class="hljs-built_in">float</span></span>, @angle <span class="hljs-built_in"><span class="hljs-built_in">float</span></span>, @distance <span class="hljs-built_in"><span class="hljs-built_in">float</span></span>, @step <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> geometry <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> EXEC <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> CALLER <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @X <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> @Y <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> @azimuth <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(@angle, <span class="hljs-number"><span class="hljs-number">0</span></span>) = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(@distance, <span class="hljs-number"><span class="hljs-number">0</span></span>) &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @sectorStepAngle <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @sectorStepAngle = @step <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ABS</span></span>(@angle) &gt; <span class="hljs-number"><span class="hljs-number">360</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @angle = <span class="hljs-number"><span class="hljs-number">360</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @pointsStr <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @firstPointsStr <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @earthRadius <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @lat <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @lon <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @d <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ABS</span></span>(@angle) &lt; <span class="hljs-number"><span class="hljs-number">360</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @pointsStr = <span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(@X, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)) + <span class="hljs-string"><span class="hljs-string">' '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(@Y, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @pointsStr = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @earthRadius = <span class="hljs-number"><span class="hljs-number">6367</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @lat = <span class="hljs-keyword"><span class="hljs-keyword">RADIANS</span></span>(@Y) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @lon = <span class="hljs-keyword"><span class="hljs-keyword">RADIANS</span></span>(@X) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @d = (@distance / <span class="hljs-number"><span class="hljs-number">1000</span></span>) / @earthRadius <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @angleStart <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @angleEnd <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @angleStart = @azimuth - @angle / <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @angleEnd = @azimuth + @angle / <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @pointsCount <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @pointsCount = <span class="hljs-keyword"><span class="hljs-keyword">FLOOR</span></span>(@angle / @sectorStepAngle) <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @brng <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @latRadians <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @lngRadians <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @ptX <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @ptY <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @i <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @i = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @addPrefix TINYINT <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ABS</span></span>(@angle) &lt; <span class="hljs-number"><span class="hljs-number">360</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @addPrefix = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @addPrefix = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @i &lt;= @pointsCount <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @brng = <span class="hljs-keyword"><span class="hljs-keyword">RADIANS</span></span>(@angleStart + @i * @sectorStepAngle); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @latRadians = <span class="hljs-keyword"><span class="hljs-keyword">ASIN</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SIN</span></span>(@lat) * <span class="hljs-keyword"><span class="hljs-keyword">COS</span></span>(@d) + <span class="hljs-keyword"><span class="hljs-keyword">COS</span></span>(@lat) * <span class="hljs-keyword"><span class="hljs-keyword">SIN</span></span>(@d) * <span class="hljs-keyword"><span class="hljs-keyword">COS</span></span>(@brng)); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @lngRadians = @lon + <span class="hljs-keyword"><span class="hljs-keyword">ATN2</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SIN</span></span>(@brng) * <span class="hljs-keyword"><span class="hljs-keyword">SIN</span></span>(@d) * <span class="hljs-keyword"><span class="hljs-keyword">COS</span></span>(@lat), <span class="hljs-keyword"><span class="hljs-keyword">COS</span></span>(@d) - <span class="hljs-keyword"><span class="hljs-keyword">SIN</span></span>(@lat) * <span class="hljs-keyword"><span class="hljs-keyword">SIN</span></span>(@latRadians)); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @ptX = <span class="hljs-number"><span class="hljs-number">180.0</span></span> * @lngRadians / <span class="hljs-keyword"><span class="hljs-keyword">PI</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @ptY = <span class="hljs-number"><span class="hljs-number">180.0</span></span> * @latRadians / <span class="hljs-keyword"><span class="hljs-keyword">PI</span></span>(); IF @addPrefix = 1 <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @pointsStr += <span class="hljs-string"><span class="hljs-string">', '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(@ptX, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)) + <span class="hljs-string"><span class="hljs-string">' '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(@ptY, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @pointsStr += <span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(@ptX, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)) + <span class="hljs-string"><span class="hljs-string">' '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(@ptY, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @addPrefix = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @i = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @firstPointsStr = <span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(@ptX, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)) + <span class="hljs-string"><span class="hljs-string">' '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(@ptY, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @i = @pointsCount <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (@angleStart + @pointsCount * @sectorStepAngle) &lt; @angleEnd <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @brng = <span class="hljs-keyword"><span class="hljs-keyword">RADIANS</span></span>(@angleEnd); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @latRadians = <span class="hljs-keyword"><span class="hljs-keyword">ASIN</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SIN</span></span>(@lat) * <span class="hljs-keyword"><span class="hljs-keyword">COS</span></span>(@d) + <span class="hljs-keyword"><span class="hljs-keyword">COS</span></span>(@lat) * <span class="hljs-keyword"><span class="hljs-keyword">SIN</span></span>(@d) * <span class="hljs-keyword"><span class="hljs-keyword">COS</span></span>(@brng)); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @lngRadians = @lon + <span class="hljs-keyword"><span class="hljs-keyword">ATN2</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SIN</span></span>(@brng) * <span class="hljs-keyword"><span class="hljs-keyword">SIN</span></span>(@d) * <span class="hljs-keyword"><span class="hljs-keyword">COS</span></span>(@lat), <span class="hljs-keyword"><span class="hljs-keyword">COS</span></span>(@d) - <span class="hljs-keyword"><span class="hljs-keyword">SIN</span></span>(@lat) * <span class="hljs-keyword"><span class="hljs-keyword">SIN</span></span>(@latRadians)); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @ptX = <span class="hljs-number"><span class="hljs-number">180.0</span></span> * @lngRadians / <span class="hljs-keyword"><span class="hljs-keyword">PI</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @ptY = <span class="hljs-number"><span class="hljs-number">180.0</span></span> * @latRadians / <span class="hljs-keyword"><span class="hljs-keyword">PI</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @pointsStr = @pointsStr + <span class="hljs-string"><span class="hljs-string">', '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(@ptX, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)) + <span class="hljs-string"><span class="hljs-string">' '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(@ptY, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @i = @i + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ABS</span></span>(@angle) &lt; <span class="hljs-number"><span class="hljs-number">360</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @pointsStr += <span class="hljs-string"><span class="hljs-string">', '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(@X, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)) + <span class="hljs-string"><span class="hljs-string">' '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(@Y, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @pointsStr += <span class="hljs-string"><span class="hljs-string">', '</span></span> + @firstPointsStr <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> geometry::STPolyFromText(<span class="hljs-string"><span class="hljs-string">'POLYGON (('</span></span> + @pointsStr + <span class="hljs-string"><span class="hljs-string">'))'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br></div></div><br><br>   ,  CLR ,    .            . <br><div class="spoiler"> <b class="spoiler_title">CLR    </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="longitude"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="latitude"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="azimuth"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="angle"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="radius"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> [Microsoft.SqlServer.Server.SqlFunction] public static SqlGeometry DrawGeoSpatialSectorVarAngle(SqlDouble longitude, SqlDouble latitude, SqlDouble azimuth, SqlDouble angle, SqlDouble radius, SqlDouble stepAngle) { if (longitude == SqlDouble.Null || latitude == SqlDouble.Null || azimuth == SqlDouble.Null || angle == SqlDouble.Null || radius == SqlDouble.Null || radius == 0 || angle == 0) return SqlGeometry.Parse("GEOMETRYCOLLECTION EMPTY"); SqlGeometryBuilder builder = new SqlGeometryBuilder(); builder.SetSrid(0); builder.BeginGeometry(OpenGisGeometryType.Polygon); double firstPointLon; double firstPointLat; double sectorStepAngle = (double) stepAngle; const double earthRadius = 6367.0; double lat = (double) latitude; double lon = (double) longitude; double azim = (double) azimuth; double ang = (double) angle; double piRad = (Math.PI/180.0); double tLat = piRad*lat; double tLon = piRad*lon; double distkm = ((double) radius/1000)/earthRadius; double angleStart = azim - ang/2; double angleEnd = azim + ang/2; var _angle = Math.Abs(ang); if (_angle &gt; 360.0) { angle = 360.0; } int pointCount = (int) Math.Floor(ang/sectorStepAngle); double brng; double latRadians; double lngRadians; double ptX; double ptY; int i = 0; if (angle </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt; 360.0) { builder.BeginFigure(lon, lat); firstPointLon = lon; firstPointLat = lat; } else { brng = piRad*(angleStart); latRadians = Math.Asin(Math.Sin(tLat)*Math.Cos(distkm) + Math.Cos(tLat)*Math.Sin(distkm)*Math.Cos(brng)); lngRadians = tLon + Math.Atan2(Math.Sin(brng)*Math.Sin(distkm)*Math.Cos(tLat), Math.Cos(distkm) - Math.Sin(tLat)*Math.Sin(latRadians)); ptX = 180.0*lngRadians/Math.PI; ptY = 180.0*latRadians/Math.PI; builder.BeginFigure(ptX, ptY); firstPointLon = ptX; firstPointLat = ptY; } while (i &lt;= pointCount) { brng = piRad*(angleStart + i*sectorStepAngle); latRadians = Math.Asin(Math.Sin(tLat)*Math.Cos(distkm) + Math.Cos(tLat)*Math.Sin(distkm)*Math.Cos(brng)); lngRadians = tLon + Math.Atan2(Math.Sin(brng)*Math.Sin(distkm)*Math.Cos(tLat), Math.Cos(distkm) - Math.Sin(tLat)*Math.Sin(latRadians)); ptX = 180.0*lngRadians/Math.PI; ptY = 180.0*latRadians/Math.PI; builder.AddLine(ptX, ptY); i = i + 1; } if (((angleStart + pointCount * sectorStepAngle) &lt; angleEnd)) { brng = piRad * (angleEnd); latRadians = Math.Asin(Math.Sin(tLat) * Math.Cos(distkm) + Math.Cos(tLat) * Math.Sin(distkm) * Math.Cos(brng)); lngRadians = tLon + Math.Atan2(Math.Sin(brng) * Math.Sin(distkm) * Math.Cos(tLat), Math.Cos(distkm) - Math.Sin(tLat) * Math.Sin(latRadians)); ptX = 180.0 * lngRadians / Math.PI; ptY = 180.0 * latRadians / Math.PI; builder.AddLine(ptX, ptY); } builder.AddLine(firstPointLon, firstPointLat); builder.EndFigure(); builder.EndGeometry(); return builder.ConstructedGeometry; }</span></span></span></span></code> </pre><br></div></div><br><br><div class="spoiler"> <b class="spoiler_title">        ()</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @bbox GEOMETRY <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @octagon GEOMETRY <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @bbox = [tile].[GetTileBounds](<span class="hljs-number"><span class="hljs-number">15</span></span>,<span class="hljs-number"><span class="hljs-number">19144</span></span>,<span class="hljs-number"><span class="hljs-number">9524</span></span>), @octagon = [tile].[fn_GetCircleSegment](<span class="hljs-number"><span class="hljs-number">30.3277587890625</span></span>, <span class="hljs-number"><span class="hljs-number">59.952259717159905</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">360</span></span>,<span class="hljs-number"><span class="hljs-number">440</span></span>,<span class="hljs-number"><span class="hljs-number">90</span></span>)</code> </pre><br></div></div><br>  30.3277587890625, 59.952259717159905 ‚Äì   ; <br><br>   ,        : <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @bbox.STIntersection(@octagon)</code> </pre><br>   : <br><div class="spoiler"> <b class="spoiler_title">        </b> <div class="spoiler_text"><pre> <code class="sql hljs">'POLYGON ((30.3253442162734 59.949509172234684, 30.3301733618516 59.949509172234684, 30.333251953125 59.9510505967796, 30.333251953125 59.953468509045528, 30.330173073498937 59.955010262085125, 30.325344504626063 59.955010262085125, 30.322265625 59.953468509045528, 30.322265625 59.9510505967796, 30.3253442162734 59.949509172234684))'</code> </pre><br></div></div><br><br>         ,          : <br><div class="spoiler"> <b class="spoiler_title">     X  Y  </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [tile].[GetPixelXPosFromLongitude](<span class="hljs-number"><span class="hljs-number">30.3253442162734</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>), [tile].[GetPixelYPosFromLatitude](<span class="hljs-number"><span class="hljs-number">59.949509172234684</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>) , [tile].[GetPixelXPosFromLongitude](<span class="hljs-number"><span class="hljs-number">30.3301733618516</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>), [tile].[GetPixelYPosFromLatitude]( <span class="hljs-number"><span class="hljs-number">59.949509172234684</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>) , [tile].[GetPixelXPosFromLongitude](<span class="hljs-number"><span class="hljs-number">30.333251953125</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>), [tile].[GetPixelYPosFromLatitude]( <span class="hljs-number"><span class="hljs-number">59.9510505967796</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>) , [tile].[GetPixelXPosFromLongitude](<span class="hljs-number"><span class="hljs-number">30.333251953125</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>), [tile].[GetPixelYPosFromLatitude]( <span class="hljs-number"><span class="hljs-number">59.953468509045528</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>) , [tile].[GetPixelXPosFromLongitude](<span class="hljs-number"><span class="hljs-number">30.330173073498937</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>), [tile].[GetPixelYPosFromLatitude]( <span class="hljs-number"><span class="hljs-number">59.955010262085125</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>) , [tile].[GetPixelXPosFromLongitude](<span class="hljs-number"><span class="hljs-number">30.325344504626063</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>), [tile].[GetPixelYPosFromLatitude]( <span class="hljs-number"><span class="hljs-number">59.955010262085125</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>) ,[tile].[GetPixelXPosFromLongitude](<span class="hljs-number"><span class="hljs-number">30.322265625</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>), [tile].[GetPixelYPosFromLatitude]( <span class="hljs-number"><span class="hljs-number">59.953468509045528</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>) , [tile].[GetPixelXPosFromLongitude](<span class="hljs-number"><span class="hljs-number">30.322265625</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>), [tile].[GetPixelYPosFromLatitude]( <span class="hljs-number"><span class="hljs-number">59.9510505967796</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>) , [tile].[GetPixelXPosFromLongitude](<span class="hljs-number"><span class="hljs-number">30.3253442162734</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>), [tile].[GetPixelYPosFromLatitude]( <span class="hljs-number"><span class="hljs-number">59.949509172234684</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>)</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">      </b> <div class="spoiler_text"><table><tbody><tr><th>  </th><th>  </th><th> X  15-  </th><th> Y  15-  </th></tr><tr><td> 30.3253442162734 </td><td> 59.949509172234684 </td><td> 4900936 </td><td> 2438400 </td></tr><tr><td> 30.3301733618516 </td><td> 59.949509172234684 </td><td> 4901048 </td><td> 2438400 </td></tr><tr><td> 30.333251953125 </td><td> 59.9510505967796 </td><td> 4901120 </td><td> 2438328 </td></tr><tr><td> 30.333251953125 </td><td> 59.953468509045528 </td><td> 4901120 </td><td> 2438216 </td></tr><tr><td> 30.330173073498937 </td><td> 59.955010262085125 </td><td> 4901048 </td><td> 2438144 </td></tr><tr><td> 30.325344504626063 </td><td> 59.955010262085125 </td><td> 4900936 </td><td> 2438144 </td></tr><tr><td> 30.322265625 </td><td> 59.953468509045528 </td><td> 4900864 </td><td> 2438216 </td></tr><tr><td> 30.322265625 </td><td> 59.9510505967796 </td><td> 4900864 </td><td> 2438328 </td></tr><tr><td> 30.3253442162734 </td><td> 59.949509172234684 </td><td> 4900936 </td><td> 2438400 </td></tr></tbody></table><br></div></div><br>            : <br><div class="spoiler"> <b class="spoiler_title">        </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> GEOMETRY::STGeomFromText(<span class="hljs-string"><span class="hljs-string">'LINESTRING(4900936 2438400, 4901048 2438400, 4901120 2438328, 4901120 2438216, 4901048 2438144, 4900936 2438144, 4900864 2438216, 4900864 2438328, 4900936 2438400 )'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre><br></div></div><br><br>  ( <b></b> )   <a href="https://habr.com/ru/post/266363/"> 3</a> ,   ,     4 . <br><img src="https://habrastorage.org/files/bfe/63b/6f3/bfe63b6f342d45e7bdd3f1e29eb557c4.jpg"><br>  4 ‚Äì        <br><br>  ( <b>D</b> )    ,          ,  ,    <a href="https://habr.com/ru/post/266363/"> 5</a> ,     ( <b></b> )  ( <b>D</b> ),       <a href="https://habr.com/ru/post/266363/"> 5.</a> <br>              . <br><br>     ( <b>E</b> ): <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> GEOMETRY::STGeomFromText(<span class="hljs-string"><span class="hljs-string">'MULTILINESTRING((4901048 2438400, 4901120 2438328),( 4901120 2438216, 4901048 2438144),( 4900936 2438144, 4900864 2438216), (4900864 2438328, 4900936 2438400) )'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre><br><a name="geometry-forming-picture5"></a><br><img src="https://habrastorage.org/files/3bd/aa6/d99/3bdaa6d991df4709bc60306b313e7769.jpg"><br>  5 ‚Äì     ( ) <br><br>  T-SQL       PNG          Z/X/Y.    . <br><div class="spoiler"> <b class="spoiler_title">     </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @bbox GEOMETRY <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @rhomb GEOMETRY <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @image VARBINARY(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @bbox = [tile].[GetTileBounds](<span class="hljs-number"><span class="hljs-number">15</span></span>,<span class="hljs-number"><span class="hljs-number">19144</span></span>,<span class="hljs-number"><span class="hljs-number">9524</span></span>), @rhomb = [tile].[fn_GetSector](<span class="hljs-number"><span class="hljs-number">30.3277587890625</span></span>, <span class="hljs-number"><span class="hljs-number">59.952259717159905</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">360</span></span>,<span class="hljs-number"><span class="hljs-number">440</span></span>,<span class="hljs-number"><span class="hljs-number">90</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @image = [tile].[ShapeTile]( @octagon,<span class="hljs-number"><span class="hljs-number">15</span></span>,<span class="hljs-number"><span class="hljs-number">19144</span></span>,<span class="hljs-number"><span class="hljs-number">9524</span></span>,<span class="hljs-string"><span class="hljs-string">'4400B050'</span></span>,<span class="hljs-string"><span class="hljs-string">'9601B41E'</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span>[tile].[SaveToFolderByZoomXY](@image,<span class="hljs-string"><span class="hljs-string">'d:/tiles'</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>,<span class="hljs-number"><span class="hljs-number">19144</span></span>,<span class="hljs-number"><span class="hljs-number">9524</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @image = [tile].[ShapeTile]( @octagon,<span class="hljs-number"><span class="hljs-number">15</span></span>,<span class="hljs-number"><span class="hljs-number">19143</span></span>,<span class="hljs-number"><span class="hljs-number">9524</span></span>,<span class="hljs-string"><span class="hljs-string">'4400B050'</span></span>,<span class="hljs-string"><span class="hljs-string">'9601B41E'</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span>[tile].[SaveToFolderByZoomXY](@image,<span class="hljs-string"><span class="hljs-string">'d:/tiles'</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>,<span class="hljs-number"><span class="hljs-number">19143</span></span>,<span class="hljs-number"><span class="hljs-number">9524</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @image = [tile].[ShapeTile]( @octagon,<span class="hljs-number"><span class="hljs-number">15</span></span>,<span class="hljs-number"><span class="hljs-number">19145</span></span>,<span class="hljs-number"><span class="hljs-number">9524</span></span>,<span class="hljs-string"><span class="hljs-string">'4400B050'</span></span>,<span class="hljs-string"><span class="hljs-string">'9601B41E'</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span>[tile].[SaveToFolderByZoomXY](@image,<span class="hljs-string"><span class="hljs-string">'d:/tiles'</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>,<span class="hljs-number"><span class="hljs-number">19145</span></span>,<span class="hljs-number"><span class="hljs-number">9524</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @image = [tile].[ShapeTile]( @octagon,<span class="hljs-number"><span class="hljs-number">15</span></span>,<span class="hljs-number"><span class="hljs-number">19144</span></span>,<span class="hljs-number"><span class="hljs-number">9523</span></span>,<span class="hljs-string"><span class="hljs-string">'4400B050'</span></span>,<span class="hljs-string"><span class="hljs-string">'9601B41E'</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span>[tile].[SaveToFolderByZoomXY](@image,<span class="hljs-string"><span class="hljs-string">'d:/tiles'</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>,<span class="hljs-number"><span class="hljs-number">19144</span></span>,<span class="hljs-number"><span class="hljs-number">9523</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @image = [tile].[ShapeTile]( @octagon,<span class="hljs-number"><span class="hljs-number">15</span></span>,<span class="hljs-number"><span class="hljs-number">19144</span></span>,<span class="hljs-number"><span class="hljs-number">9525</span></span>,<span class="hljs-string"><span class="hljs-string">'4400B050'</span></span>,<span class="hljs-string"><span class="hljs-string">'9601B41E'</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span>[tile].[SaveToFolderByZoomXY](@image,<span class="hljs-string"><span class="hljs-string">'d:/tiles'</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>,<span class="hljs-number"><span class="hljs-number">19144</span></span>,<span class="hljs-number"><span class="hljs-number">9525</span></span>)</code> </pre><br></div></div><br>  PNG    : <br><img src="https://habrastorage.org/files/c1e/da1/b7c/c1eda1b7c5cd4e4590f9d4219e2b05e7.png"><br><img src="https://habrastorage.org/files/161/2e8/1fd/1612e81fd13e44eebd647b85569dbc82.png"><img src="https://habrastorage.org/files/81b/adf/f43/81badff4353b4cecac28cd7c0eb10cc2.png"><img src="https://habrastorage.org/files/c95/30e/b43/c9530eb433244bbb8fc95d84c2acde94.png"><img src="https://habrastorage.org/files/bc0/7bc/a02/bc07bca024c44606b56f87af40de525d.png"><br><br>       <i>DrawPartObjectShapeOnTile()</i>  <i>ShapeToTileRendering</i> : <br><div class="spoiler"> <b class="spoiler_title">     </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">      </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="shape"&gt;</span></span></span><span class="hljs-comment">       </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="X"&gt;</span></span></span><span class="hljs-comment">X  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="Y"&gt;</span></span></span><span class="hljs-comment">Y  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="Zoom"&gt;</span></span></span><span class="hljs-comment">  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="argbFill"&gt;</span></span></span><span class="hljs-comment">    ARGB</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="argbStroke"&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="strokeWidth"&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> public void DrawPartObjectShapeOnTile(SqlGeometry shape, int X, int Y, int Zoom, string argbFill, string argbStroke, int strokeWidth) { PasteShapeOnTile(CreateColor(argbFill), CreateColor(argbStroke), strokeWidth, CutPolygonByZoomedPixelZeroTile(shape, X, Y, Zoom)); }</span></span></code> </pre><br></div></div><br>   <i>PasteShapeOnTile()</i>      . <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PasteShapeOnTile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Color fillcolor, Color strokecolor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> width, List&lt;SqlGeometry&gt; geom</span></span></span><span class="hljs-function">)</span></span> { SqlGeometry shape = geom[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> geomnum = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) shape.STNumGeometries(); SqlGeometry stroke = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; SqlGeometry ring; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> intnum; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (geom != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (GetOpenGisGeometryType(shape)) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> OpenGisGeometryType.LineString: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> OpenGisGeometryType.MultiLineString: DrawMultiLineStringBordered2(shape, fillcolor, strokecolor, width, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> OpenGisGeometryType.Polygon: intnum = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) shape.STNumInteriorRing(); ring = shape.STExteriorRing(); <span class="hljs-comment"><span class="hljs-comment">// 1.      FillPolygonOnTile(fillcolor, ring.ToPointsArray()); // 2.    if (geomnum &gt;= 1) stroke = geom[1]; for (int i = 1; i &lt;= intnum; i++) { FillTransparentPolygonOnTile(shape.STInteriorRingN(i).ToPointsArray()); } // 3.   if (geom.Count &gt; 1) { stroke = geom[1]; DrawContourOnTile(stroke, strokecolor, width); } break; case OpenGisGeometryType.MultiPolygon: break; } }</span></span></code> </pre><br><br>  3-7,           ,    <i>CutPolygonByZoomedPixelZeroTile()</i> ,       . <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">            </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="poly"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="X"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="Y"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="Z"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-comment">          </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> private List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;SqlGeometry&gt;</span></span></span><span class="hljs-comment"> CutPolygonByZoomedPixelZeroTile(SqlGeometry poly, int X, int Y, int Z) { return CutZoomedPixelPolygonByZeroTile(_parser.ConvertToZoomedPixelZeroedByTileGeometry(poly,Z,X,Y); }</span></span></code> </pre><br>   <i>GeometryParser</i>           ¬´¬ª ‚Äî         X, Y.        ,              : <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary ///            /// &lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="shape"&gt;</span></span></span><span class="hljs-comment">    </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="zoom"&gt;</span></span></span><span class="hljs-comment">  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="tileX"&gt;</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="tileY"&gt;</span></span></span><span class="hljs-comment">Y  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-comment">        </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> public SqlGeometry ConvertToZoomedPixelZeroedByTileGeometry(SqlGeometry shape,int zoom, int tileX,int tileY) { return CreateGeometryFromZoomedPixelInfo (ConvertToGeometryZoomedPixelsZeroTileShiftedInfo( GetGeometryInfo(shape), zoom, tileX, tileY)); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary ///            /// &lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="info"&gt;</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="zoom"&gt;</span></span></span><span class="hljs-comment">  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="x"&gt;</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="y"&gt;</span></span></span><span class="hljs-comment">Y  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-comment">       </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> private GeometryZoomedPixelsInfo ConvertToGeometryZoomedPixelsZeroTileShiftedInfo (GeometryInstanceInfo info, int zoom, int x, int y) { int tilezeroshiftX = x*TILE_SIZE; int tilezeroshiftY = y*TILE_SIZE; var result = new GeometryZoomedPixelsInfo(); var pixelCoordsListList = new List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;List&lt;GeometryPixelCoords&gt;</span></span></span><span class="hljs-comment">&gt;(); var geomPixCoordsList = new List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;GeometryPixelCoords&gt;</span></span></span><span class="hljs-comment">(); var coords = new GeometryPixelCoords {InnerRing = false}; OpenGisGeometryType type = info.ShapeType; result.ShapeType = type; switch (type) { case OpenGisGeometryType.Point: PointF[] geopoints = info.Points[0][0].PointList; coords.PixelCoordList = new[] {new Point{X = _conv.FromLongitudeToXPixel(geopoints[0].X, zoom) - tilezeroshiftX, Y = _conv.FromLatitudeToYPixel(geopoints[0].Y, zoom) - tilezeroshiftY } }; geomPixCoordsList.Add(coords); pixelCoordsListList.Add(geomPixCoordsList); break; case OpenGisGeometryType.LineString: coords.PixelCoordList = GetPixelCoordsShifted( info.Points[0][0].PointList, zoom, tilezeroshiftX, tilezeroshiftY); geomPixCoordsList.Add(coords); pixelCoordsListList.Add(geomPixCoordsList); break; case OpenGisGeometryType.Polygon: foreach (var list in info.Points) foreach (GeometryPointSequence pointseq in list) { coords.PixelCoordList = GetPixelCoordsShifted(pointseq.PointList, zoom, tilezeroshiftX, tilezeroshiftY); coords.InnerRing = pointseq.InnerRing; geomPixCoordsList.Add(coords); } pixelCoordsListList.Add(geomPixCoordsList); break; case OpenGisGeometryType.MultiPoint: case OpenGisGeometryType.MultiLineString: case OpenGisGeometryType.MultiPolygon: pixelCoordsListList = GetGeometryPixelCoordsShifted(info.Points, zoom, tilezeroshiftX, tilezeroshiftY); break; case OpenGisGeometryType.GeometryCollection: GeometryInstanceInfo[] geomColl = info.GeometryInstanceInfoCollection; int n = info.GeometryInstanceInfoCollection.Length; var geomPixZoomInfoCollection = new GeometryZoomedPixelsInfo[n]; for (int i = 0; i </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt; n; i++) { var geom = new GeometryZoomedPixelsInfo(); geom.ShapeType = geomColl[i].ShapeType; geom.Points = GetGeometryPixelCoordsShifted(geomColl[i].Points, zoom, tilezeroshiftX, tilezeroshiftY); geomPixZoomInfoCollection[i] = geom; } result.GeometryInstanceInfoCollection = geomPixZoomInfoCollection; break; } if (type != OpenGisGeometryType.GeometryCollection) result.Points = pixelCoordsListList; return result; }</span></span></span></span></code> </pre><br>   <i>ShapeToTileRendering</i>   <i>CutZoomedPixelPolygonByZeroTile()</i> .         .  ,    <i>poly</i>    ,       . <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;SqlGeometry&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CutZoomedPixelPolygonByZeroTile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SqlGeometry poly, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> X, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Y</span></span></span><span class="hljs-function">)</span></span> { List&lt;SqlGeometry&gt; result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;SqlGeometry&gt;(); SqlGeometry stroke = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; SqlGeometry contour; SqlGeometry tileLineString; SqlGeometry tobecut; SqlGeometry tile = _conv.GetTilePixelBound(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tiled = poly.STIntersection(tile); result.Add(tiled); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (GetOpenGisGeometryType(tiled)) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> OpenGisGeometryType.Polygon: <span class="hljs-comment"><span class="hljs-comment">//         MULTILINESTRING contour = PolygonToMultiLineString(tiled); //        tileLineString = tile.ToLineString(); tobecut = contour.STIntersection(tileLineString); stroke = contour.STDifference(tobecut); break; case OpenGisGeometryType.MultiPolygon: //         MULTILINESTRING contour = MultiPolygonToMultiLineString(tiled); //        tileLineString = tile.ToLineString(); tobecut = contour.STIntersection(tileLineString); stroke = contour.STDifference(tobecut); break; } result.Add(stroke); return result; }</span></span></code> </pre><br><br>          .  <i>tile.FillShapeTiles</i>     ,      <i>@GeoData</i>            <i>@FolderPath</i> . <br>        CLR : <br><ul><li> <i><a href="https://habr.com/ru/post/266363/">tile.ShapeTile();</a></i> </li><li> <i>tile.SaveToFolderByZoomXY()</i> </li></ul>  . <br>     <i>BitmapFunctions</i> SQL CLR  <i>SqlBitmapOperation</i> : <br>  <i>ShapeTile()</i>  PNG             xTile, yTile: <br><a name="shape-tile-sql-function"></a><br><div class="spoiler"> <b class="spoiler_title">ShapeTile()</b> <div class="spoiler_text"><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">SqlFunction</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> SqlBinary </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ShapeTile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SqlGeometry shape, SqlInt32 zoom, SqlInt32 xTile, SqlInt32 yTile, SqlString argbFill,SqlString argbStroke,SqlInt32 strokeWidth</span></span></span><span class="hljs-function">)</span></span> { SqlBinary result = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (ShapeToTileRendering paster = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ShapeToTileRendering()) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (MemoryStream ms = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemoryStream()) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { paster.DrawPartObjectShapeOnTile(shape, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) xTile, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) yTile, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) zoom, argbFill.ToString(), argbStroke.ToString(), (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) strokeWidth); result = paster.GetBytes(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (System.Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> innerMessage = ex.InnerException.Message; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"zoom: {1}; X:{2}; Y:{3} {0} , inner: {4}"</span></span>, shape, zoom, xTile,yTile, innerMessage)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } } }</code> </pre><br></div></div><br><br>  <i>SqlBitmapOperation</i>      <i>TileRendering</i> . <br>  .NET TileRendering   .NET : <br><ul><li> System </li><li> Microsoft.SqlServer.Types </li><li> System.Drawing </li></ul><br><br> <a href="https://msdn.microsoft.com/en-us/library/ms345099.aspx">msdn.microsoft.com/en-us/library/ms345099.aspx</a> <br>    <i>SqlBitmapOperation</i>  <i>TileRendering</i> ,         ,     : <br><div class="spoiler"> <b class="spoiler_title">       </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ASSEMBLY</span></span> [Microsoft.SqlServer.Types] AUTHORIZATION [dbo] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">'d:\SQLCLR\BIN\TileRendering\Microsoft.SqlServer.Types.dll'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> PERMISSION_SET = <span class="hljs-keyword"><span class="hljs-keyword">UNSAFE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ASSEMBLY</span></span> [System.Drawing] AUTHORIZATION [dbo] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">'d:\SQLCLR\BIN\TileRendering\ System.Drawing.dll'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> PERMISSION_SET = <span class="hljs-keyword"><span class="hljs-keyword">UNSAFE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ASSEMBLY</span></span> [TileRendering] AUTHORIZATION [dbo] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">'d:\SQLCLR\BIN\TileRendering\TileRendering.dll'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> PERMISSION_SET = <span class="hljs-keyword"><span class="hljs-keyword">UNSAFE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ASSEMBLY</span></span> nQuant.Core <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">'d:\SQLCLR\BIN\TileRendering\ nQuant.Core.dll'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> PERMISSION_SET = <span class="hljs-keyword"><span class="hljs-keyword">UNSAFE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ASSEMBLY</span></span> SqlBitmapOperation <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">'d:\SQLCLR\BIN\TileRendering\SqlBitmapOperation.dll'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> PERMISSION_SET = <span class="hljs-keyword"><span class="hljs-keyword">UNSAFE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br></div></div><br> <i>SqlBitmapOperation</i>   <a href="https://nquant.codeplex.com/">nQuant.Core</a>   .     PNG    8      . <br><br>     <i>SqlGeometry</i>     <i>Microsoft.SqlServer.Types</i>   ,  Microsoft.SqlServer.Types      . <br> <i>System.Drawing</i> ‚Äì     GDI+ c  ,       <i>EXTERNAL_ACCESS</i>   ,    <i>Sytem.Drawing</i> .          ,        <i>EXTERNAL_ACCESS</i>  <i>UNSAFE</i>   T-SQL : <br><pre> <a href="https://msdn.microsoft.com/en-us/ms131071"><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> [dataBaseName] <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> TRUSTWORTHY <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>;</code></a> </pre><br><br>   CLR    ,   ,        : <br><div class="spoiler"> <b class="spoiler_title">     </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AGGREGATE</span></span> [tile].[TileAgg] (@<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span> [varbinary](<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span>[varbinary](<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">EXTERNAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> [SqlBitmapOperation].[TileAgg] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AGGREGATE</span></span> [tile].[IconTileAgg] (@<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span> [varbinary](<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>), @PixelX [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>], @PixelY [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span>[varbinary](<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">EXTERNAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> [SqlBitmapOperation].[IconTileAgg] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> [tile].[IconTile](@image [varbinary](<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>), @zoom [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>], @Lon [<span class="hljs-built_in"><span class="hljs-built_in">float</span></span>], @Lat [<span class="hljs-built_in"><span class="hljs-built_in">float</span></span>], @xTile [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>], @yTile [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>], @scale [<span class="hljs-built_in"><span class="hljs-built_in">float</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> [varbinary](<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> CALLER <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXTERNAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> [SqlBitmapOperation].[BitmapFunctions].[IconTile] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-comment"><span class="hljs-comment">--ShapeTile(SqlGeometry shape, SqlInt32 zoom, SqlInt32 xTile, SqlInt32 yTile, SqlString argbFill,SqlString argbStroke,SqlInt32 strokeWidth) CREATE FUNCTION [tile].[ShapeTile](@shape GEOMETRY, @zoom [int], @xTile [int], @yTile [int], @argbFill NVARCHAR(10),@argbStroke NVARCHAR(10), @strokeWidth INT) RETURNS [varbinary](max) WITH EXECUTE AS CALLER AS EXTERNAL NAME [SqlBitmapOperation].[BitmapFunctions].[ShapeTile] GO --SaveToFolderByZoomXY(SqlBinary image, SqlString rootFolderPath, SqlInt32 Zoom, SqlInt32 X,SqlInt32 Y) CREATE FUNCTION tile.SaveToFolderByZoomXY(@image VARBINARY(MAX),@rootFolderPat NVARCHAR(512) , @Zoom [int], @xTile [int], @yTile [int]) RETURNS BIT WITH EXECUTE AS CALLER AS EXTERNAL NAME [SqlBitmapOperation].[BitmapFunctions].[SaveToFolderByZoomXY] GO</span></span></code> </pre><br></div></div><br>  <i>ShapeToTileRendering</i>      .        4326      .      GeometryParser,       PSG3857,     . <i>PastShapeOnTile</i>  ,    <i>geom</i>   .      256     . <br><div class="spoiler"> <b class="spoiler_title">    </b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PasteShapeOnTile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Color fillcolor,Color strokecolor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> width, List&lt;SqlGeometry&gt; geom</span></span></span><span class="hljs-function">)</span></span> { SqlGeometry shape = geom[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> geomnum = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)shape.STNumGeometries(); SqlGeometry stroke = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; SqlGeometry ring; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> intnum; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (geom != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (GetOpenGisGeometryType(shape)) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> OpenGisGeometryType.LineString: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> OpenGisGeometryType.MultiLineString: DrawMultiLineStringBordered2(shape, fillcolor, strokecolor, width, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> OpenGisGeometryType.Polygon: intnum = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)shape.STNumInteriorRing(); ring = shape.STExteriorRing(); <span class="hljs-comment"><span class="hljs-comment">// 1.      FillPolygonOnTile(fillcolor, ring.ToPointsArray()); // 2.    if (geomnum &gt;= 1) stroke = geom[1]; for (int i = 1; i &lt;= intnum; i++) { FillTransparentPolygonOnTile(shape.STInteriorRingN(i).ToPointsArray()); } // 3.   if (geom.Count &gt; 1) { stroke = geom[1]; DrawContourOnTile(stroke, strokecolor, width); } break; case OpenGisGeometryType.MultiPolygon: break; } }</span></span></code> </pre><br></div></div><br>    <i>tile.FillShapeTiles</i>         . <br><div class="spoiler"> <b class="spoiler_title">  tile.FillShapeTiles</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> PROC tile.FillShapeTiles @GeoData GEOMETRY, @fillArgb <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>),@strokeArgb <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>), @FolderPath <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>), @EndZoom <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-number"><span class="hljs-number">17</span></span>, @StartZoom <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-number"><span class="hljs-number">4</span></span>, @Thickness <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @EndZoom &lt; @StartZoom <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> @GeoData <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> tile.tile (Zoom, X,Y,<span class="hljs-keyword"><span class="hljs-keyword">Data</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.Zoom, t.TileX <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> X,t.TileY <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> Y, tile.ShapeTile(@GeoData, t.Zoom, t.TileX, t.TileY, @fillArgb, @strokeArgb ,@Thickness) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tile.fn_FetchGeometryTilesZoomDepth(@GeoData,@StartZoom, @EndZoom - @StartZoom)) t <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> tile.SaveToFolderByZoomXY (<span class="hljs-keyword"><span class="hljs-keyword">Data</span></span>, @FolderPath ,Zoom,X,Y) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tile.Tile <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br></div></div><br><br>   ,  100 000 ,        .            .      ,     CLR  . <br><br>  <i>tile.FillShapeTilesIntersection()</i>  CLR  <i>tile.ShapeTile()</i>      .PNG   ,     .    CLR    .   ,  CLR  <i>tile.TileAgg(@Data VARBINARY(MAX))</i> ,         .PNG ,      VABINARY(MAX). <br>   CLR      : <br><ul><li> <i>Init();</i> </li><li> <i>Accumulate(value);</i> </li><li> <i>Merge(Agg);</i> </li><li> <i>Terminate()</i> </li></ul><br><div class="spoiler"> <b class="spoiler_title"> SQL CLR </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//------------------------------------------------------------------------------ // &lt;copyright file="CSSqlAggregate.cs" company="Microsoft"&gt; // Copyright (c) Microsoft Corporation. All rights reserved. // &lt;/copyright&gt; //------------------------------------------------------------------------------ using System; using System.Collections.Generic; using System.Data.SqlClient; using System.Data.SqlTypes; using Microsoft.SqlServer.Server; using TileRendering; using System.IO; using System.Drawing; using System.Drawing.Imaging; [Serializable] [SqlUserDefinedAggregate(Format.UserDefined, IsInvariantToDuplicates = true, IsInvariantToNulls = true, IsInvariantToOrder = false, IsNullIfEmpty = false, MaxByteSize = -1)] public struct TileAgg : IBinarySerialize { Bitmap _bitmap; ImageFormat _format; Graphics _graphics; ImageCodecInfo _codecInfo; const int TILE_SIZE = 256; Bitmap GetInitialTile() { Bitmap DrawArea = new Bitmap(TILE_SIZE, TILE_SIZE); using (Graphics xGraph = Graphics.FromImage(DrawArea)) { xGraph.FillRectangle(Brushes.Transparent, 0, 0, TILE_SIZE, TILE_SIZE); _graphics = Graphics.FromImage(DrawArea); return DrawArea; } } #region [Aggregate artifacts] public void Init() { _codecInfo = GetEncoderInfo("image/png"); _bitmap = GetInitialTile(); DetectFormat(); } public void Accumulate(SqlBinary Value) { using (MemoryStream ms = new MemoryStream()) { ms.Write(Value.Value, 0, Value.Length); ms.Seek(0, SeekOrigin.Begin); ms.Position = 0; PasteFromStreamImageToTile( ms); } } public void Merge(TileAgg Group) { PasteGroup(Group.Terminate()); } public SqlBinary Terminate() { return GetBytes(); } #endregion [Aggregate artifacts] void PasteFromStreamImageToTile( Stream stream) { using (Bitmap iconImage = new Bitmap(stream, false)) { DetectFormat(); int width = iconImage.Width; int height = iconImage.Height; var area = new Rectangle(0, 0, width, height); CopyRegionIntoImage(iconImage,area, area); } } void CopyRegionIntoImage(Bitmap srcBitmap, Rectangle srcRegion, Rectangle destRegion) { _graphics.DrawImage(srcBitmap, destRegion, srcRegion, GraphicsUnit.Pixel); srcBitmap.Dispose(); } void PasteGroup(SqlBinary Value) { using (MemoryStream ms = new MemoryStream()) { ms.Write(Value.Value, 0, Value.Length); ms.Seek(0, SeekOrigin.Begin); ms.Position = 0; PasteTile(ms); } } void PasteTile(Stream stream) { Rectangle bounds = new Rectangle(0, 0, TILE_SIZE, TILE_SIZE); CopyRegionIntoImage(new Bitmap(stream), bounds, bounds); } byte[] GetBytes() { return _bitmap.ToByteArray(ImageFormat.Png); } #region [IBinarySerialize] public void Read(BinaryReader reader) { _bitmap = new Bitmap(new MemoryStream(reader.ReadBytes((int)reader.BaseStream.Length))); DetectFormat(); } public void Write(BinaryWriter writer) { EncoderParameters encodeParams = new EncoderParameters(1); encodeParams.Param[0] = new EncoderParameter(System.Drawing.Imaging.Encoder.Quality, 100); _bitmap.Save(writer.BaseStream, _codecInfo, encodeParams); } #endregion [IBinarySerialize] /// &lt;summary&gt; ///    /// &lt;/summary&gt; void DetectFormat() { _format = _bitmap.GetImageFormat(); } ImageCodecInfo GetEncoderInfo(string mimeType) { //     string lookupKey = mimeType.ToLower(); ImageCodecInfo foundCodec = null; Dictionary&lt;string, ImageCodecInfo&gt; encoders = Encoders(); if (encoders.ContainsKey(lookupKey)) { //    foundCodec = encoders[lookupKey]; } return foundCodec; } private Dictionary&lt;string, ImageCodecInfo&gt; Encoders() { Dictionary&lt;string, ImageCodecInfo&gt; encoders = new Dictionary&lt;string, ImageCodecInfo&gt;(); foreach (ImageCodecInfo codec in ImageCodecInfo.GetImageEncoders()) { encoders.Add(codec.MimeType.ToLower(), codec); } return encoders; } }</span></span></code> </pre><br></div></div><br>   <a href="https://habr.com/ru/post/266363/"><i>tile.FillShapeTilesIntersection</i></a>       tile.Shape.   @StartZoom ‚Äì  , @EndZoom ‚Äî  .   <i>tile.Shapes.fillArgb</i>  <i>tile.Shapes.strokeArgb</i>      .   : <i>AARRGGBB</i> , <br>  AA ‚Äì   (), RR ‚Äì  , GG ‚Äî  , BB ‚Äì     . : DDDDFFDD. <br><a name="forming-tiles-for-set-of-objects"></a><br><div class="spoiler"> <b class="spoiler_title">    </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> PROC tile.FillShapeTilesIntersection( @StartZoom <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, @EndZoom <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @Shape GEOMETRY <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @CurrentZoom <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @ObjectTypeID <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @fillArgb <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>), @strokeArgb <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @ObjectTypeID <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @CurrentZoom = @StartZoom <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> shape_cursor <span class="hljs-keyword"><span class="hljs-keyword">CURSOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> o.Shape, fillARGB, strokeARGB <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tile.Shape o <span class="hljs-keyword"><span class="hljs-keyword">OPEN</span></span> shape_cursor <span class="hljs-keyword"><span class="hljs-keyword">FETCH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> shape_cursor <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @Shape, @fillArgb, @strokeArgb <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @@FETCH_STATUS = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @CurrentZoom = @StartZoom <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @CurrentZoom &lt;= @EndZoom <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> tile.tileOverlap (Zoom, X,Y,<span class="hljs-keyword"><span class="hljs-keyword">Data</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.Zoom, t.TileX <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> X,t.TileY <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> Y, tile.ShapeTile(@Shape, t.Zoom, t.TileX, t.TileY, @fillArgb, @strokeArgb ,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tile.fn_FetchGeometryTiles(@Shape,@CurrentZoom)) t <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @CurrentZoom = @CurrentZoom + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FETCH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> shape_cursor <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @Shape, @fillArgb, @strokeArgb <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLOSE</span></span> shape_cursor; <span class="hljs-keyword"><span class="hljs-keyword">DEALLOCATE</span></span> shape_cursor; <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> tile.TileOverlap <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br></div></div><br><a name="conclusion"></a><br><h4>  Conclusion </h4><br><hr><br>  ,  ,    ,     .        ‚Äî   ,     .   -     ,                  SQL Server. <br> <a href="https://github.com/Den367/TileRendering"><img src="https://habrastorage.org/files/410/7bb/30e/4107bb30ec3048f3ae5ebfba66665b41.png">     github</a> <br><br> <a href="https://drive.google.com/uc%3Fexport%3Ddownload%26id%3D0BzNljve6KtsmZFp1OXMzUzJzQ3c">       3.5</a> </cut></div><p>Source: <a href="https://habr.com/ru/post/266363/">https://habr.com/ru/post/266363/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266353/index.html">Ansible and Rails - flexible replacement for Capistrano while maintaining familiar comfort</a></li>
<li><a href="../266355/index.html">Firebase queue: steroids for firebase</a></li>
<li><a href="../266357/index.html">100 out of 100 in Google PageSpeed ‚Äã‚ÄãInsights (Bug or feature)?</a></li>
<li><a href="../266359/index.html">In the guests' sitting "Grasshopper"</a></li>
<li><a href="../266361/index.html">1–°: Programmers Club - Teacher‚Äôs View</a></li>
<li><a href="../266367/index.html">We write a simple * game physics of the aircraft</a></li>
<li><a href="../266369/index.html">How to write dizdok</a></li>
<li><a href="../266371/index.html">Announcement of the third meeting of the Java User Group Sevastopol</a></li>
<li><a href="../266373/index.html">Another performance comparison of C ++ and C #</a></li>
<li><a href="../266375/index.html">Customize keyboard shortcuts in Linux like Mac OS X</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>