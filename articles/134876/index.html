<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Object-Oriented Gin Installer Development</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Link to the first part 
 Link to the second part 
 Content and container commands 
 Some commands involve working with files originally stored on the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Object-Oriented Gin Installer Development</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://habrahabr.ru/blogs/refactoring/134439/">Link to the first part</a> <br>  <a href="http://habrahabr.ru/blogs/refactoring/134512/">Link to the second part</a> <br><h4>  Content and container commands </h4><br>  Some commands involve working with files originally stored on the package developer‚Äôs computer.  It is clear that these files need to be delivered along with the package (and preferably, right inside the package) to the package consumer.  Let's try to begin to imagine how this will work. <br>  We have an instance of the PackageBuilder class, to which when constructing we specify the PackageBody argument, which contains, among other things, the Command command, which is the root node of the package command tree.  The SaveResult () method of an instance of the PackageBuilder class should recursively traverse the entire tree, and for those commands that use content files located on the developer's computer, include the contents of all these files in the package body.  It should also include an xml file in the package body into which PackageBody itself will be serialized with a complete description of the package and the commands it performs. <br><a name="habracut"></a><br>  How can the SaveResult () method, when recursively traversing the command tree, find out if the current command contains files that need to be included in the package?  If we make it a simple check of the type of such pseudocode: ‚ÄúIf the current command is CreateFile, then we extract the SourceFile file from it‚Äù, then we get the fact that the developer of extensions for the installer, without having access to the source code of the PackageBuilder class, can no longer add here another check for your new content team.  Here we could gain the creation of another abstract class like ContentCommand, from which we would inherit, but it is not clear where in the command hierarchy we would embed this class?  At the moment, the CreateFile command is inherited from TransactionalCommand, and CreateFile implies that it is also a content command.  But WriteRegistry is also inherited from TransactionalCommand, however it cannot be content, because it simply writes the value to the registry with a certain key.  By the way, the WriteRegistryFileCommand team is also a TransactionalCommand, and at the same time it is also a content one, because it requires * .reg, a file that describes all registry keys to be modified. <br><br>  Thus, it is not exactly clear where the ContentCommand class can be embedded in the hierarchy, and since you cannot use impurity classes in C #, as in C ++ (source), we will solve this issue by introducing the new IContentCommand interface that we will implement in each content team .  Fortunately, each specific class can implement any number of interfaces, which is good for us. <br><br>  The IContentCommand interface in the first approximation is as follows: <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IContentCommand</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ContentPath { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre> <br>  Please note that we provide both a getter and a setter for a single interface element.  We need the setter to replace the initial value of the full path to the file on the package developer‚Äôs machine with the short file name inside the finished package.  Thus, on the consumer's machine package, the team will extract the content files from the package by their short name inside the package.  And this is logical, the consumer does not have access to the developer‚Äôs machine, which means he doesn‚Äôt have to know the full paths to the source files, and indeed the file system structure on the developer‚Äôs machine. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The implementation of this interface for each content team is simple and obvious.  For example, for the CreateFile command, it will be: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ContentPath { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SourcePath; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { SourcePath = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } }</code> </pre><br><br>  Similarly, it will look for any other content team. <br><br>  The only drawback of the IContentCommand interface is that it operates on one single file path, that is, with one file or one folder.  And what if the command contains pointers to two or more files or folders?  Then the interface will look like this: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IMultipleContentCommand</span></span> { IEnumerable&lt;ContentPath&gt; ContentPaths { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } }</code> </pre><br>  Now, instead of a simple string, I had to return a collection of objects of type ContentPath that support writing and reading to the specified property of the object owner.  I could not think of any other options besides using type reflection, and therefore I implemented the ContentPath type as follows: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ContentPath</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Command _command; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PropertyInfo _property; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ContentPath</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Command command, PropertyInfo property</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(command <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> IMultipleContentCommand)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"Must be the IMultipleContentCommand"</span></span>); } _command = command; _property = property; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _property.Name; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)_property.GetValue(_command, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { _property.SetValue(_command, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); } } }</code> </pre><br><br>  Here, I just showed the possibility of creating multi-content commands, but so far I can not imagine a single command that requires such functionality (I am going to attribute teams with folders to ordinary content commands that operate with one single path).  Therefore, the IMultipleContentCommand interface will remain only in drafts, I am going to accept the decision on its use later, without complicating the application class interfaces unnecessarily. <br><br>  As we remember, we use an instance of the PackageBuilder class to generate an installation package file.  Until now, he was responsible only for generating an XML file containing the package body with the command tree included in it.  After we realized the need to store in the package not only the XML file, but also the rest of the content files, we need to revise the algorithm of the PackageBuilder class.  Now he is responsible for the following things: <br><ol><li>  Generating an XML file containing package commands </li><li>  Inclusion in the package of all content files originally stored on the package developer‚Äôs machine </li><li>  Combining an array of files into one archive file. </li></ol><br>  In order not to lay my implementation of a specific type of archive (zip, rar, tar, or something else) in my implementation, I encapsulate this behavior in a separate PackageContent class. <br><img src="https://habrastorage.org/getpro/habr/post_images/72a/a8d/2c3/72aa8d2c3c3910217be74e8f87a3eb34.jpg" alt="image"><br>  As you can see, PackageBuilder now knows nothing about the methods for generating the resulting package, that is, about how exactly one is created from many disparate files.  You will also need to ensure that the Package class does not rely on this knowledge at runtime, but uses the open methods of the PackageBuilder class.  Thus, we provide complete encapsulation of the package-unpacking of packages, and we leave no chance for user classes to learn about the internal implementation of this algorithm.  Let the PackageContent class have two constructors: the first creates an empty package for the needs of the PackageBuilder, the second constructor receives the path to the package file as input, and creates an instance already filled with content for the needs of the Package instance and its Execute () method. <br><img src="https://habrastorage.org/getpro/habr/post_images/5d0/6c4/df1/5d06c4df166b20041cf4e36bf196b76b.jpg" alt="image"><br>  In my case, I suggest using tar archiving as the easiest way to package files.  I'm not going to go into the details of this method, since the meaning of the article is not in these details. <br><br>  I will note the following.  When forming a package, it is possible that the same content file is used in several different commands.  In order not to keep its identical copies inside the package, it is necessary for PackageContent to keep a list of all files uploaded to it, and to always answer the question - is there already this file inside of me?  This check will be made according to the similarity of the absolute path to the file.  And one more note.  It is also possible that inside the package two different files are added from different folders, but with the same name.  Since the package hierarchy is unlikely to exist (or rather, it may or may not exist) file hierarchy, you should save files inside the package under the newly generated names, it is desirable to generate them using the Guid class, so surely the names of the files inside the package are not matched.  Accordingly, after renaming a file and saving it inside a package under a new name, you need to change the original path in the corresponding command to a new relative path. <br><br>  In order for PackageBuilder to figure out whether the current command has commands embedded in it, we‚Äôll make sure that all commands (let's call them containers) containing other commands can report this to the calling code.  To do this, they will implement the IContainerCommand interface, here is its description: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IContainerCommand</span></span> { IEnumerable&lt;Command&gt; InnerCommands { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } }</code> </pre><br><br>  Implementing this interface for container commands will be trivial.  For example, CommandSequence will simply return its Commands property: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IEnumerable&lt;Command&gt; InnerCommands { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Commands; } }</code> </pre><br><br>  And ExecuteIf will return a list consisting of one Command: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IEnumerable&lt;Command&gt; InnerCommands { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Command&gt;() { Command }; } }</code> </pre><br><br>  I will now give the code for the SaveResult and ProcessIncludedFiles methods for an accurate understanding of how it all works: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> MAIN_PACKAGE_FILENAME = <span class="hljs-string"><span class="hljs-string">"package.xml"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> PACKAGE_FILE_EXTENSION = <span class="hljs-string"><span class="hljs-string">".gin"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> PACKAGE_CONTENT_FILE_EXTENSION = <span class="hljs-string"><span class="hljs-string">".cnt"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SaveResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> filePath</span></span></span><span class="hljs-function">)</span></span> { ProcessIncludedFiles(_body.Command); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> xmlFilePath = GinSerializers.PackageBodySerializer.Serialize(_body); _content.AddContent(xmlFilePath, MAIN_PACKAGE_FILENAME); _content.SaveAs(filePath); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessIncludedFiles</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Command command</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> IContainerCommand) { IContainerCommand iContainer = (IContainerCommand)command; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (Command cmd <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> iContainer.InnerCommands) { ProcessIncludedFiles(cmd); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> IContentCommand) { IContentCommand cntCommand = (IContentCommand)command; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> sourceFilePath = cntCommand.ContentPath; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_content.ContainFilePath(sourceFilePath)) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> destFileName = GetGuidContentFileName(); _content.AddContent(sourceFilePath, destFileName); cntCommand.ContentPath = destFileName; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> destFileName = _content.GetFileName(sourceFilePath); cntCommand.ContentPath = destFileName; } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetGuidContentFileName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>) + PACKAGE_CONTENT_FILE_EXTENSION; }</code> </pre><br><br>  Just above, I have already described in detail the operation of this code. <br><br><h4>  Comparison operators </h4><br>  I considered string comparison operators in the first part.  Here I will try to implement comparison operators for numeric data.  As we remember, the ExecuteIf command requires for its execution the presence in the execution context (ExecutionContext) of a Boolean variable, which is the result of the comparison of two operands.  These operands can be of various types (int, double, etc.).  The comparison operator itself, in turn, can also be different (LessThan, GreaterThan, Equal, etc), and, as you can see, not all the set of operators can be applied to each specific type of operand, for example, the StartsWith operator is hardly worth applying to integer numbers.  As you can see, the creation of a team that implements the comparison of operands is a very nontrivial task, especially considering our desire to design the team so that the end user programmer can expand the basic set of comparison operators with their own operators. <br><br>  The first, most obvious, approach to implementing comparison operators looks like a command with arguments: <br><br>  string FirstOperandName, <br>  string SecondOperandName, <br>  CompareOperation Operation. <br><br>  For integers it looks like this: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> CompareOperation { Equals, GreaterThan } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">StringCompareCommand</span></span> : <span class="hljs-title"><span class="hljs-title">Command</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FirstOperandName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> SecondOperandName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CompareOperation Operation { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ExecutionContext _context; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StringCompareCommand</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ExecutionContext context</span></span></span><span class="hljs-function">)</span></span> { _context = context; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Do</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> compareResult = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> firstOperand = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)_context.GetResult(FirstOperandName); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> secondOperand = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)_context.GetResult(SecondOperandName); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (Operation) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CompareOperation.Equals: compareResult = firstOperand == secondOperand; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CompareOperation.GreaterThan: compareResult = firstOperand &lt; secondOperand; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } _context.SaveResult(ResultName, compareResult); } }</code> </pre><br><br>  Here I have described only two comparison operators, and only for integers.  Accordingly, if we want to compare decimal (decimal) numbers, we will add the DecimalCompareCommand class inheriting from the Command, almost completely repeating the IntCompareCommand class, except for the type conversion (decimal).  And if we want to add the LessThan statement to them, we will have to make changes to the two classes IntCompareCommand, DecimalCompareCommand in the switch statement of the Do () method. <br><br>  What I don't like about this approach?  A huge number of duplicate patterns - the code of each class is generally almost identical.  The inability of a third-party developer to add new comparison operators to the CompareOperation enumeration. <br><br>  I think that the switch statement should be replaced by the use of polymorphism.  Let's try to bring it to life. <br>  Since in our task two aspects can change over time - the type of operands and the type of operation, we should encapsulate each of these aspects into a separate abstract class.  Let them be called CompareCommand and CompareOperand. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CompareCommand</span></span>: <span class="hljs-title"><span class="hljs-title">Command</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FirstOperandName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> SecondOperandName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Do</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ExecutionContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> result = Compare(Subtract(context)); context.SaveResult(ResultName, result); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Compare</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> compareResult</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Subtract</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ExecutionContext context</span></span></span><span class="hljs-function">)</span></span> { CompareOperand firstOperand = CompareOperand.Create(context.GetResult(FirstOperandName)); CompareOperand secondOperand = CompareOperand.Create(context.GetResult(SecondOperandName)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (firstOperand - secondOperand); } }</code> </pre><br><br>  In this class there are: <br><ol><li>  two arguments, given their names in the execution context, </li><li>  the Do (ExecutionContext) method, which makes a comparison by finding the sign of the difference between two quantities (the Subtract method), and passing this sign to the Abstract method Compare (int).  The Compare method we implement in specific inheritors of the CompareCommand class. </li><li>  Abstract method Compare (int) </li><li>  A specific Subtract method that extracts two operands from the context and stores them in instances of the heirs of the CompareOperand abstract class, and then subtracts one from the other.  It is clear that there will also be used polymorphism. </li></ol><br><br>  Heirs will look like this: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CompareLessThan</span></span> : <span class="hljs-title"><span class="hljs-title">CompareCommand</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Compare</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> compareResult</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> compareResult &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>; } }</code> </pre><br><br>  We now describe the CompareOperand class: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CompareOperand</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> CompareOperand </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> operand</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (operand <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ULongCompareOperand() { Value = (<span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span>)operand }; } .. .. .. .. .. .. .. .. .. <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultCompareOperand() { Value = (DefaultType)operand }; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> -(CompareOperand operand1, CompareOperand operand2) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> operand1 - operand2; } }</code> </pre><br><br>  As you can see, the static Create method, in accordance with the type of the passed argument, creates an instance of one of the heirs of the CompareOperand class.  All its descendants will differ only in the type of the Value property and the implementation of the subtraction operator. <br><br>  And his heirs will be: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LongCompareOperand</span></span> : <span class="hljs-title"><span class="hljs-title">CompareOperand</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> Value { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> -(LongCompareOperand operand1, LongCompareOperand operand2) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Math.Sign(operand1.Value - operand2.Value); } }</code> </pre><br><br>  The scheme looks beautiful except that the subtraction operator is implemented as a static method, and therefore the polymorphism will not work in this case (the static method cannot be virtual, and therefore the polymorphism in its relation will not work).  This fact was immediately announced to us by VisualStudio after the launch of the test example - the call of the subtraction operator caused Stack Overflow, since the subtraction implemented in CompareOperand caused itself, and not the polymorphic subtraction operator of the base class.  Well, let's do the subtraction not by the ‚Äú-‚Äù operator, but by the Subtract () method. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CompareOperand</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> CompareOperand </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> operand</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultCompareOperand() { Value = (DefaultType)operand }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Subtract</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CompareOperand operand2</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> -(CompareOperand operand1, CompareOperand operand2) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> operand1.Subtract(operand2); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LongCompareOperand</span></span> : <span class="hljs-title"><span class="hljs-title">CompareOperand</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> Value { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Subtract</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CompareOperand operand2</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Math.Sign(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Value - ((LongCompareOperand)operand2).Value); } }</code> </pre><br><br>  The only thing I don‚Äôt like in this approach is the chain of if else statements in the CompareOperand.Create () method, but I don‚Äôt know how to fix the situation yet.  Now, if it becomes necessary to add support for operands for another type, you will need to implement a successor from the CompareOperand class, and add another If else method to the Create () method, which is impossible for a third-party developer who does not have access to the source code.  There is also an exception when trying to use two different types of operands within the same comparison. <br><br>  I did not manage to come up with a universal, flexible solution, and remembering the saying that the best is the enemy of the good, I decided to leave it at that.  Thus, we have a set of arithmetic comparison operators, based on the difference between numbers, for all the numeric types supported in the CLR.  I think that it can also be supplemented with non-numeric types that support differential operation, such as DateTime. <br>  I hope that the experts present in the blog will offer the most optimal method for solving the task of comparing various types of numerical data. <br><br>  <a href="http://habrahabr.ru/blogs/refactoring/135310/">Link to the fourth part</a> </div><p>Source: <a href="https://habr.com/ru/post/134876/">https://habr.com/ru/post/134876/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../134866/index.html">The past, present and future of mobile phones</a></li>
<li><a href="../134869/index.html">Online shops: preparing for holiday shopping</a></li>
<li><a href="../134870/index.html">Use $ _COOKIE as $ _SESSION</a></li>
<li><a href="../134872/index.html">Droider Show # 20. World without Wikipedia</a></li>
<li><a href="../134874/index.html">IM + today launches its own cross-platform multimedia messaging service "Beep"</a></li>
<li><a href="../134878/index.html">Meet the Gem. Part two</a></li>
<li><a href="../134879/index.html">"Ticking" clock with an alarm clock on the Atmega48 microcontroller</a></li>
<li><a href="../134880/index.html">Pro Wi-Fi in a dress, LED-linen and a pair of shoes</a></li>
<li><a href="../134881/index.html">ReactOS News Release # 89</a></li>
<li><a href="../134882/index.html">Sed, vari sed</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>