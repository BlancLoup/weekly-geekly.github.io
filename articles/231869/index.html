<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As we did a small security system on the RPi. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 I think many of you have heard about the Raspberry Pi, moreover, I think quite a large number of you have seen it live. At the beginning of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As we did a small security system on the RPi. Part 1</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  I think many of you have heard about the Raspberry Pi, moreover, I think quite a large number of you have seen it live.  At the beginning of 2014, I decided that it was time for me to order myself a couple of RPi too and do something interesting for them.  Since I am an iOS developer, I had the burning idea of ‚Äã‚Äãnecessarily attaching an application to this iOS project.  Well, because  RPi is pretty good at working with third-party hardware, I decided that I would make a small security system for personal use. <br><br><img src="https://habrastorage.org/files/7bb/cee/dd8/7bbceedd81994641a48666b75a98199b.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><h4>  Introduction </h4><br>  The first thing to do in this case was to determine what I want from this system.  I believe that for such a task there is nothing better than a thought map.  In general, after 5 minutes of deep reflection, this is what happened: <br><br><img src="https://habrastorage.org/files/f07/f42/091/f07f420913f14e358cbb552eebcdbb0c.png"><br><br>  About a month later I received two RPi models A from the UK, i.e.  with one USB, and no ethernet.  I bought a 16GB flash drive and installed Raspbian on it.  And then the first of the pitfalls began to emerge - drivers and the Internet.  I already had a 3G router won at the competition a couple of years ago, and it was I who planned to connect it to RPi in order for the Internet to appear there.  How wrong I was. <br><br>  Half an hour later I was already in the store looking for a USB-Ethernet adapter, the seller hardly found me a copy of D-Link.  Just before the release, I decided to play it safe and buy another ASUS wifi adapter, since  the time was later, and I really wanted to start work today, so there was simply no room for a mistake.  On both devices support Linux naturally flaunted. <br><br><img src="https://habrastorage.org/files/d71/d0e/1d5/d71d0e1d590d461ea3d3e91d30790246.jpg"><br><img src="https://habrastorage.org/files/510/981/03a/51098103a2c542108bb7519efd6aad5c.jpg"><br><br>  When I got home, I killed a good hour trying to install from a disk, and then find the latest D-Link drivers on the Internet.  It turned out that the guys from this company just stopped supporting this device 2 years ago!  I realized that they sold me junk ( <i>which I successfully changed the next day for two more flash drives</i> ).  There was a plan B, which worked surprisingly without any drivers, I just inserted the adapter from ASUS into USB and it was immediately defined in the system as a network card.  I‚Äôll say right away that it‚Äôs just impossible to work on the RPi model A in the graphical shell mode, everything is very slow, after the MacBook with the SSD, this is about hell.  So I decided not to torture him, just set up ssh for myself. <br><br>  Next came the question of the language in which I would write a system for working with hardware.  Of all, I chose Python, since there is work with iron out of the box, there is no need to additionally install any libraries and the like, well, plus I have long wanted to learn this language. <br><br>  In about a week, I learned everything I needed from Python, it was a very interesting week.  Remember in episode 9 of the first season of The Big Bang Theory, the main characters attached switches to some devices in their apartment that could be controlled via the Internet, and anyone could turn on / off their light or audio system?  I did the same with the LED connected to the RPi.  This is certainly not an audio system, but when the LED lights up from a mouse click on the opposite hemisphere of the planet, the sensations were indescribable :) <br><br><img src="https://habrastorage.org/files/0c4/e23/189/0c4e231894444c01a80c90e508737279.png"><br><br><h4>  Work with iron </h4><br>  The next question that I had to solve was how to connect and control the iron, because the motion and smoke sensor is not a LED, everything is somewhat more complicated.  With this question, I turned to my good friend, who just knows a lot about circuit design and is friends with a soldering iron better than me. <br><br>  From that moment on, two people began to work on the project, and I became a frequent visitor to the store for radio amateurs. <br><br>  In more detail about the operation of the scheme, I will tell in another article, but for now I‚Äôll briefly tell you how everything works. <br><br><img src="https://habrastorage.org/files/e49/249/477/e4924947768f459aae086786069d8831.JPG"><br><br>  In this diagram, there is a motion sensor on the left, a car alarm on the right, and a power supply connection below. <br><br>  Looking ahead, I want to say that the automatic switching to battery power was excluded from the circuit, because  A battery was purchased, which is connected just parallel with the mains supply and automatically starts feeding the circuit when 220V is lost.  It was decided to replace the limit switch for the door with reed switches. <br><br>  To connect and power the entire circuit, two separate boards were made, on one, work with iron through optocouplers was implemented, and on the other, mains voltage conversion of 220V to constant 12V and 5V.  From 12V sensors and a siren are powered, and from 5V, respectively, RPi. <br><br>  All this is good, but the next question was even more interesting, how do we get the data from the sensors.  We decided to do all the work with iron through GPIO, to be honest, I think this is the only way, the remaining inputs / outputs are designed for specific equipment, and we just need to get a 1 or 0 status from the sensors. <br><br><img src="https://habrastorage.org/files/61c/f68/c87/61cf68c87fab4c89a85e599eb1357051.jpg"><br><br>  The GPIO has 26 pins, from them: 2 to 5V, 2 to 3B, 5 ground, the rest can be both inputs and outputs, depending on the configuration that you specify. <br><br><img src="https://habrastorage.org/files/a90/cc1/89d/a90cc189da0742e9a328cd3e789ca18c.png"><br><br><h4>  Programming system work with iron </h4><br>  I decided to make a three-tier architecture: <b>RPi - Web Server - iOS</b> .  First, to increase resiliency, because  if we exclude the server from the chain, then the whole system becomes very vulnerable due to the fact that RPi can fail and we will not know how to do it.  Secondly, I decided to refuse sending SMS and dialing in favor of push-notifications, which of course the server will send. <br><br>  So, for programming the system to work with iron, I chose Python 2.5.  The first thing to do is install <a href="https://code.google.com/p/webiopi/">WebIOPi</a> .  This is an excellent open-source project that allows you to conveniently debug work with equipment through a browser.  It shows the status of GPIO ports, allows them to be configured for input / output and set manually at output 0 or 1. Everything is installed very simply, on the Internet even there is a detailed instruction in Russian. <br><br>  As I wrote above, in Python "out of the box" there is work with GPIO, for this you just need to connect a special library. <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> RPi.GPIO <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> GPIO</code> </pre> <br><br>  The GPIO has two contact numbering modes, by account on the board and by internal contact number.  I recommend using account numbering, it's just easier. <br><br><pre> <code class="python hljs">GPIO.setmode(GPIO.BOARD)</code> </pre> <br><br>  Before starting the system, we need to initialize all the necessary ports, namely, indicate how they will work, at the input or at the output, as well as specify the initial value of the port. <br><br><pre> <code class="python hljs">GPIO.setup(<span class="hljs-number"><span class="hljs-number">12</span></span>, GPIO.OUT, initial=GPIO.LOW) GPIO.setup(<span class="hljs-number"><span class="hljs-number">11</span></span>, GPIO.IN, pull_up_down=GPIO.PUD_DOWN)</code> </pre><br><br>  To read the port you need to use the following code: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GPIO.input(<span class="hljs-number"><span class="hljs-number">11</span></span>) == GPIO.HIGH)</code> </pre> <br><br>  To set port 1 or 0 output: <br><br><pre> <code class="python hljs">GPIO.output(<span class="hljs-number"><span class="hljs-number">12</span></span>, GPIO.HIGH) GPIO.output(<span class="hljs-number"><span class="hljs-number">12</span></span>, GPIO.LOW)</code> </pre><br><br>  Since the motion sensor issues a signal for a very short period of time, we need to read the ports all the time, and here we must say that this is very convenient in RPi.GPIO.  You can make it so that when an input is received at 1 or 0, a certain function is called.  Also for each port is set the frequency of reading. <br><br><pre> <code class="python hljs">GPIO.add_event_detect(<span class="hljs-number"><span class="hljs-number">11</span></span>, GPIO.FALLING, callback=move_sensor_callback, bouncetime=<span class="hljs-number"><span class="hljs-number">500</span></span>)</code> </pre><br><br>  Several important pitfalls.  In the program loop, it is necessary to sleep (1), otherwise the processor will always be 100% loaded, also when exiting the program it is recommended to perform GPIO.cleanup (). <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: GPIO.cleanup()</code> </pre><br><br>  Then I will tell you about an even more strange problem, the reasons for which I did not find, but I found a completely adequate solution.  After about 6 hours of continuous operation, the script stops responding to the sensors.  Most likely, the most convenient system that causes a callback function when a certain event occurs falls off.  This is solved very simply, the script must sometimes be reloaded, for example with the help of cron.  For greater reliability, on my system, cron reloads the script every hour, plus every minute it checks if the script is running and starts it if it is not. <br><br>  I did the work of the program as a daemon, I think I don‚Äôt need to explain anything here, this is a pretty standard thing.  If you wish, you can find examples on the Internet. <br><br>  Let's talk a little about the system architecture.  I carried out work with each piece of iron into a separate module.  Each module can initialize ports, turn on / off its hardware, carry out self-diagnostics, send messages to the server, for example, when a motion sensor is triggered, and of course, write your status to the log. <br><br>  Self-diagnostics is done quite simply, during initialization all the iron should have a unit at the output, so if we have zero there, then the sensor does not work or is not in the closed position (reed switch).  Accordingly, the whole system is built on the fact that the sensors have 1 in a quiet state, and accordingly 0, when they are triggered or something breaks. <br><br>  In general, the system consists of 4 sensors: a 360 ¬∞ motion sensor, a smoke sensor, 2 reed switches.  And of course the siren, ringing, car, in a closed room just breaks your ears. <br><br>  This is where the first part comes to an end, the next time I will tell you how the server part and the iOS application were made.  Thank you all for your attention, and if possible I will answer all questions on hardware and software in the comments. <br><br>  Well, at the end of a small spoiler for the second part :) <br><br><img src="https://habrastorage.org/files/7f1/8dc/82b/7f18dc82b7fa456da5b51d5c7af60463.png"></div><p>Source: <a href="https://habr.com/ru/post/231869/">https://habr.com/ru/post/231869/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../231855/index.html">Front-end developer tips</a></li>
<li><a href="../231859/index.html">The player continues to compete with the deceased father and does not want him to win, so as not to erase the ghost</a></li>
<li><a href="../231861/index.html">Tugging a Camel or integration with Camel. Part 2</a></li>
<li><a href="../231863/index.html">How-to: What is Russian Volatility Index and how it is calculated</a></li>
<li><a href="../231865/index.html">What's so complicated, or how I broke a new quadrocopter</a></li>
<li><a href="../231871/index.html">Alexander Zharov gave an interview for Vedomosti</a></li>
<li><a href="../231875/index.html">How to use .NET from LoadRunner</a></li>
<li><a href="../231877/index.html">AdSense money can now be withdrawn directly to a bank account.</a></li>
<li><a href="../231879/index.html">As I wrote my first technical task</a></li>
<li><a href="../231881/index.html">Study Abroad: Vietnam</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>