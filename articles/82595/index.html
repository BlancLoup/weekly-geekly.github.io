<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Paypal connection</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In general, they set before me at work the task of organizing the acceptance of payments to our project through Paypal. I was required to give all the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Paypal connection</h1><div class="post__text post__text-html js-mediator-article">  In general, they set before me at work the task of organizing the acceptance of payments to our project through Paypal.  I was required to give all the necessary data to set up an account (the account itself was configured by another person), well, actually, write a script that will receive data from paypal and charge the money to users. <br><br>  On Habr√© I found nothing sensible on this subject.  I had to deal with everything myself.  Below - the results of these proceedings :) <br><a name="habracut"></a><br><h4>  Types of payments </h4><br><br>  Paypal allows you to accept several types of payments.  Here are some of them: <br>  1. Buy now buttons - a one-time payment to pay for one or several goods (services).  Allows you to set the payment amount, description of goods (services), quantity of goods, address, delivery, weight of purchase, etc.  The amount of payment you can and do not ask, in this case, Paypal will give the user the opportunity to independently specify the amount he wants to pay. <br>  2. Donate buttons - in principle, the functionality is similar to ‚ÄúBuy now‚Äù, also a one-time payment, the amount can be set either forcibly or left to the user's discretion.  Otoichie that does not allow you to specify the delivery address and everything connected with it (shipping). <br>  3. Add to cart buttons - allows you to create a basket of your products, on the side of Paypal.  On your site, the user can only add products to the cart.  To view the contents of the cart or remove any items from there, you will have to log in to Paypal. <br>  4. Subscribe buttons - allows you to organize the reception of periodic payments, for example, payment account, services. <br>  5. Eslt still gift certificates, but did not even try to figure them out. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In my case, the ideal solution was the use of ‚ÄúBuy now‚Äù payments, which will be discussed further. <br><br>  You can buy Buy now on your website in two ways: <br>  1. create a button using Paypal's tools. <br>  2. create your own form. <br><br>  Personally, I used the second option, if only because it allows you to use your own design.  Although there are a couple more buns, about them later. <br><br><h4>  Creating a form of payment </h4><br><br>  aypal, which naturally, strictly regulates the names of the form fields.  A complete list of these fields can be found at <a href="https://cms.paypal.com/us/cgi-bin/%3F%26cmd%3D_render-content%26content_ID%3Ddeveloper/e_howto_html_Appx_websitestandard_htmlvariables">cms.paypal.com/us/cgi-bin/?&amp;cmd=_render-content&amp;content_ID=developer/e_howto_html_Appx_websitestandard_htmlvariables</a> .  What is used here: <br>  - cmd = _xclick - specify the type of payment ‚ÄúBuy now‚Äù; <br>  - business - here we specify email, account where payments will be accepted.  The address itself must be confirmed (confirmed somewhere in the account settings); <br>  - item_name - here we set the description of the product / service.  Will be displayed in Paypal when making a payment; <br>  - custom - here service info, then we will need to identify the user; <br>  - amount - payment amount; <br>  - currency - payment currency.  Possible options <a href="https://cms.paypal.com/us/cgi-bin/%3F%26cmd%3D_render-content%26content_ID%3Ddeveloper/e_howto_api_nvp_currency_codes">here</a> . <br>  - no_shipping = 1 - we indicate that the accession is not carried out. <br><br><h4>  Account setup </h4><br><br>  Further, to receive payments to your account, this same account must be properly configured. <br><br>  Paypal supports two methods of transferring transaction data to our script: PDT (Payment Data Transfer) and IPN (Instant Payment Notification).  As I understand it, the difference is that when using PDP from Paypal, one single message comes after the user makes a payment (that is, when money from the user is already on the way to your account).  When using IPN, Paypal generates several messages, notifying us of each separate stage of the payment.  To solve my problem, the PDT was quite enough, which I did. <br><br>  The process for enabling PDT is described <a href="https://cms.paypal.com/us/cgi-bin/%3F%26cmd%3D_render-content%26content_ID%3Ddeveloper/howto_html_paymentdatatransfer">here</a> .  Down there is an Activating PDT section. <br><br>  The essence of the PDT is at the end of the payment, Paypal sends the specified script GET-salary, in which it transfers the transaction number, its status, amount, etc.  Paypal itself has a transaction authentication mechanism - we send a certain type POST request to their address with the received transaction number.  In response, either an error code or a description of the transaction is received - the status, the amount, and a bunch of other official data. <br><br><h4>  Script Algorithm </h4><br><br>  Actually, what is required from the script: <br>  1. get this data. <br>  2. check the type of transfer - if you use regular payment (buy now).  then the transaction type must be web_accept; <br>  3. check the recipient's email and recipient's account id.  (bussiness, receiver_email, receiver_id fields); <br>  4. The custom field contains the service info received from us, for example <br>  Id user - check it. <br>  5. The txn_id field contains the transfer number in the paypal system.  check <br>  so that there are no repeat payments. <br>  6. after that, if the payment_status = Complete field, i.e.  payment <br>  normally completed, then we carry out the payment already at home, with any other <br>  status - some troubles. <br>  The amount and currency will be in the mc_gross and mc_currency fields. <br>  A complete list of all the parameters transmitted by Paypal using PDT (and even with IPN too) <a href="https://cms.paypal.com/us/cgi-bin/%3F%26cmd%3D_render-content%26content_ID%3Ddeveloper/e_howto_html_IPNandPDTVariables">here</a> . <br><br>  Now about the buns that promised earlier.  They belong to the custom field, which we ourselves send Paypal.  You can, of course, simply write the user id there and not bathe, but we are not looking for easy ways.  In this field, it is quite possible to record the id of the record with the description of the payment in our system, and already there the user is saved, remember the type of service to which the user has purchased, the amount, etc.  This will allow, for example, to track purchases that have not been paid, as well as, when receiving data from Paypal, you can check with your saved, which gives a small + to security. <br><br>  And finally, a bit of code <br><br><blockquote><ol><li>  <font color="#000080">&lt;</font> <font color="#008080">?</font>  php </li><li>  <font color="#666666">// this function is used to get data about transfer from Paypal</font> </li><li>  <font color="#666666">// the code of the function itself is taken from Paypal's site; there are examples in different languages ‚Äã‚Äãsomewhere</font> </li><li>  function get_paypal_data <font color="#008000">(</font> $ tx_token, $ auth_token <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  $ req <font color="#000080">=</font> <font color="#FF0000">'cmd = _notify-synch'</font> <font color="#008080">;</font> </li><li>  $ req.  <font color="#000080">=</font> <font color="#FF0000">"&amp; tx = $ tx_token &amp; at = $ auth_token"</font> <font color="#008080">;</font> </li><li></li><li>  <font color="#666666">// post back to paypal system to validate</font> </li><li>  $ header.  <font color="#000080">=</font> <font color="#FF0000">"POST / cgi-bin / webscr HTTP / 1.0 <font color="#000099">\ r</font> <font color="#000099">\ n</font> "</font> <font color="#008080">;</font> </li><li>  $ header.  <font color="#000080">=</font> <font color="#FF0000">"Content-Type: application / x-www-form-urlencoded <font color="#000099">\ r</font> <font color="#000099">\ n</font> "</font> <font color="#008080">;</font> </li><li>  $ header.  <font color="#000080">=</font> <font color="#FF0000">"Content-Length:"</font> .  <font color="#0000dd">strlen</font> <font color="#008000">(</font> $ req <font color="#008000">)</font> .  <font color="#FF0000">" <font color="#000099">\ r</font> <font color="#000099">\ n</font> <font color="#000099">\ r</font> <font color="#000099">\ n</font> "</font> <font color="#008080">;</font> </li><li>  $ fp <font color="#000080">=</font> fsockopen <font color="#008000">(</font> <font color="#FF0000">'www.paypal.com'</font> , <font color="#0000dd">80</font> , $ errno, $ errstr, <font color="#0000dd">30</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li></li><li>  <font color="#0000ff">if</font> <font color="#008000">(</font> <font color="#000040">!</font> $ fp <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  <font color="#666666">// HTTP ERROR</font> </li><li>  <font color="#0000ff">return</font> <font color="#0000ff">false</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> <font color="#0000ff">else</font> <font color="#008000">{</font> </li><li>  <font color="#0000dd">fputs</font> <font color="#008000">(</font> $ fp, $ header. $ req <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#666666">// read the body data</font> </li><li>  $ res <font color="#000080">=</font> <font color="#FF0000">''</font> <font color="#008080">;</font> </li><li>  $ headerdone <font color="#000080">=</font> <font color="#0000ff">false</font> <font color="#008080">;</font> </li><li>  <font color="#0000ff">while</font> <font color="#008000">(</font> <font color="#000040">!</font> <font color="#0000dd">feof</font> <font color="#008000">(</font> $ fp <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  $ line <font color="#000080">=</font> <font color="#0000dd">fgets</font> <font color="#008000">(</font> $ fp, <font color="#0000dd">1024</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#0000ff">if</font> <font color="#008000">(</font> <font color="#0000dd">strcmp</font> <font color="#008000">(</font> $ line, <font color="#FF0000">" <font color="#000099">\ r</font> <font color="#000099">\ n</font> "</font> <font color="#008000">)</font> <font color="#000080">==</font> <font color="#0000dd">0</font> <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  <font color="#666666">// read the header</font> </li><li>  $ headerdone <font color="#000080">=</font> <font color="#0000ff">true</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> elseif <font color="#008000">(</font> $ headerdone <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  <font color="#666666">// header has been read.</font>  <font color="#666666">now read the contents</font> </li><li>  $ res.  <font color="#000080">=</font> $ line <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li><li>  <font color="#008000">}</font> </li><li>  <font color="#008000">}</font> </li><li>  <font color="#0000ff">return</font> $ res <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li><li></li><li>  <font color="#666666">// from GET, we take only the ID of the transaction, everything else does not interest us, we will receive this data from Paypal in response to our request</font> </li><li>  $ tx <font color="#000080">=</font> @ $ _ GET <font color="#008000">[</font> <font color="#FF0000">'tx'</font> <font color="#008000">]</font> <font color="#008080">;</font> </li><li>  <font color="#0000ff">if</font> <font color="#008000">(</font> <font color="#000040">!</font> $ tx <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  error_log <font color="#008000">(</font> <font color="#FF0000">'[paypal] ERROR: Tx are absent !!!'</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#0000ff">return</font> <font color="#0000ff">false</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li><li></li><li>  <font color="#666666">// send a Paypal request to get transaction data</font> </li><li>  <font color="#666666">// PAYPAL_IDENTITY_TOKEN - constant with the token obtained when the PDT is activated</font> </li><li>  $ res <font color="#000080">=</font> get_paypal_data <font color="#008000">(</font> $ tx, PAYPAL_IDENTITY_TOKEN <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  $ history.  <font color="#000080">=</font> <font color="#008000">(</font> <font color="#FF0000">'[paypal] post request result for'</font> . $ tx. <font color="#FF0000">" <font color="#000099">\ n</font> "</font> . $ res <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#0000ff">if</font> <font color="#008000">(</font> <font color="#000040">!</font> $ res <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  $ history.  <font color="#000080">=</font> <font color="#008000">(</font> <font color="#FF0000">'[paypal] http error for'</font> . $ tx <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#0000dd">exit</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li><li></li><li>  <font color="#666666">// parsim answer</font> </li><li>  $ strs <font color="#000080">=</font> explode <font color="#008000">(</font> <font color="#FF0000">" <font color="#000099">\ n</font> "</font> , $ res <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#0000ff">if</font> <font color="#008000">(</font> $ strs <font color="#008000">[</font> <font color="#0000dd">0</font> <font color="#008000">]</font> <font color="#000080">==</font> <font color="#FF0000">'FAIL'</font> <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  <font color="#666666">// if the first line is FAIl, it means some sort of trampling</font> </li><li>  <font color="#666666">// handle the error as required and exit</font> </li><li>  <font color="#0000dd">exit</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> elseif <font color="#008000">(</font> $ strs <font color="#008000">[</font> <font color="#0000dd">0</font> <font color="#008000">]</font> <font color="#000080">==</font> <font color="#FF0000">'SUCCESS'</font> <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  <font color="#666666">// everything seems fine - parsim the rest of the parameters</font> </li><li>  $ res_vars <font color="#000080">=</font> array <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li></li><li>  <font color="#666666">// parse paypal answer to array where key it's varname</font> </li><li> <font color="#0000ff">for</font> <font color="#008000">(</font> $ i <font color="#000080">=</font> <font color="#0000dd">1</font> <font color="#008080">;</font> $ i <font color="#000080">&lt;</font> count <font color="#008000">(</font> $ strs <font color="#008000">)</font> <font color="#008080">;</font> $ i <font color="#000040">++</font> <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  $ strs <font color="#008000">[</font> $ i <font color="#008000">]</font> <font color="#000080">=</font> trim <font color="#008000">(</font> $ strs <font color="#008000">[</font> $ i <font color="#008000">]</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#0000ff">if</font> <font color="#008000">(</font> <font color="#000040">!</font> $ strs <font color="#008000">[</font> $ i <font color="#008000">]</font> <font color="#008000">)</font> <font color="#0000ff">continue</font> <font color="#008080">;</font> </li><li>  $ vars <font color="#000080">=</font> explode <font color="#008000">(</font> <font color="#FF0000">'='</font> , $ strs <font color="#008000">[</font> $ i <font color="#008000">]</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#0000ff">if</font> <font color="#008000">(</font> <font color="#000040">!</font> $ vars <font color="#000040">||</font> count <font color="#008000">(</font> $ vars <font color="#008000">)</font> <font color="#000040">!</font> <font color="#000080">=</font> <font color="#0000dd">2</font> <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  <font color="#666666">// some trouble - go to the next parameter</font> </li><li>  <font color="#0000ff">continue</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li><li>  $ res_vars <font color="#008000">[</font> $ vars <font color="#008000">[</font> <font color="#0000dd">0</font> <font color="#008000">]</font> <font color="#008000">]</font> <font color="#000080">=</font> $ vars <font color="#008000">[</font> <font color="#0000dd">1</font> <font color="#008000">]</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li><li>  <font color="#666666">// finally, in the res_vars array, we have all the transaction parameters</font> </li><li></li><li>  <font color="#666666">// in the txn_type field - type of transaction.</font>  <font color="#666666">we are only interested in web_accept</font> </li><li>  <font color="#0000ff">switch</font> <font color="#008000">(</font> $ res_vars <font color="#008000">[</font> <font color="#FF0000">'txn_type'</font> <font color="#008000">]</font> <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  <font color="#0000ff">case</font> <font color="#FF0000">'web_accept'</font> <font color="#008080">:</font> </li><li>  <font color="#666666">// here we check all other fields: bussiness, receiver_id ...</font> </li><li>  <font color="#666666">// if necessary, parse custom field</font> </li><li>  <font color="#666666">// if everything is fine, then check the status of the payment</font> </li><li>  <font color="#0000ff">switch</font> <font color="#008000">(</font> @ $ res_vars <font color="#008000">[</font> <font color="#FF0000">'payment_status'</font> <font color="#008000">]</font> <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  <font color="#0000ff">case</font> <font color="#FF0000">'Completed'</font> <font color="#008080">:</font> </li><li>  <font color="#666666">// everything is fine - we send the goods to the user, charge the money to the virtual account, etc.</font> </li><li>  <font color="#0000ff">break</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li><li>  <font color="#0000ff">break</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li><li>  <font color="#008000">}</font> </li><li>  <font color="#008080">?</font>  <font color="#000080">&gt;</font> </li><li></li></ol></blockquote></div><p>Source: <a href="https://habr.com/ru/post/82595/">https://habr.com/ru/post/82595/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../82575/index.html">Portable wind generator - take the future with you on the road</a></li>
<li><a href="../82576/index.html">Caution: black carbon!</a></li>
<li><a href="../82588/index.html">Electronics Library</a></li>
<li><a href="../82589/index.html">Nokia began to close its competitors</a></li>
<li><a href="../82590/index.html">New build opera dated January 30 (build 3216)</a></li>
<li><a href="../82597/index.html">Avast 5 is already here</a></li>
<li><a href="../82598/index.html">Is there life on Habr√©?</a></li>
<li><a href="../82600/index.html">Building and installing a kernel under Debian</a></li>
<li><a href="../82602/index.html">Work has begun on creating a Firewall API for applications.</a></li>
<li><a href="../82603/index.html">For those who are late or hdtracker again give invites</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>