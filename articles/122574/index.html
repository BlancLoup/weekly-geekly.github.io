<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Accelerate Testing Django-projects</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The question of testing Django applications has received much attention in various articles, including on Habr√©. Almost in each of them, at least a co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Accelerate Testing Django-projects</h1><div class="post__text post__text-html js-mediator-article">  The question of testing Django applications has received much attention in various articles, including on Habr√©.  Almost in each of them, at least a couple of sentences are devoted to ways and hacks to speed up the passing of tests, and therefore it is not easy to say something fundamentally new here. <br><br>  In the project of the hosting control panel, the development of which I do a significant part of my work with <a href="http://www.netangels.ru/">NetAngels</a> , there are 120 tables and about 500 objects from fixtures are loaded during testing.  It‚Äôs not that scary, but creating all the tables, adding indexes and loading objects each time you run a test is pretty annoying, especially if you run just one or a couple of tests. <br><br>  Under the cat quite briefly listed several ways to accelerate testing, proposed earlier, and at the end provides a detailed description of another useful recipe, which for me now, I hope, has finally solved the problem of the speed of test execution. <br><a name="habracut"></a><br>  In average applications, as a rule, most of the brakes will be associated with working with a database.  It is not surprising that almost all proposals are aimed at optimizing this particular component. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In turn, work with the database is mainly hampered by the disk subsystem, and it is logical to assume that if we somehow reduce this load, we will get a noticeable performance gain. <br><br><h4>  Insecure transaction settings </h4><br>  Nobody cares if during the testing process the electricity suddenly disappears, and the data will not be completely written to disk.  Usually, the database servers are set up in such a way as to minimize the sad consequences of such events.  If you use a separate MySQL or PostgreSQL server for tests, you can safely change the settings to unsafe. <br><br>  For MySQL, in particular, offer the following: <br><br> <code>[mysqld] <br> default-table-type=innodb <br> transaction-isolation=READ-COMMITTED <br> innodb_flush_log_at_trx_commit = 0 <br> skip-sync-frm=OFF <br></code> <br><br>  In PostgreSQL, for the same purpose, it is recommended to add the <code>fsync = off</code> option to postgresql.conf. <br><br><h4>  Using ramdisk </h4><br>  A more radical approach is not to use a disk at all, but instead to work with data in memory.  The general principle is that a new partition is created with the tmpfs file system, mounted in a separate directory, and then all database files are created in that directory.  Extra bonus - simply unmounting a partition deletes all data. <br><br><h4>  SQLite for tests </h4><br>  In fact, the Django developers have already done a lot to ensure that tests run as quickly as possible.  In particular, if you use SQLite as the database engine, then during testing, the database is created in memory (the string ": memory:" is passed to the driver as the file name), and this method alone is enough to most likely solve most problems with speed. <br><br>  Sometimes they complain that ORM Django does not thoroughly hide the details of the database, and therefore in some cases it may turn out that the code that worked in SQLite (i.e., the tests passed) suddenly breaks when you roll out to the system where it lives and running mysql.  Indeed, this sometimes happens, but as a rule, it is due to the fact that you did something ‚Äúunusual‚Äù, for example, you began to manually create queries using the QuerySet.extra method.  However, most likely, if you do such things, then you know what it may threaten. <br><br><h4>  Preliminary creation of SQLite test database </h4><br>  As you know, when running tests, Django performs the following sequence of actions: <br><br>  1. clears the test database with the user's permission if there is something in it <br>  2. creates all the tables and indexes in the test database <br>  3. download the fixtures set with the name initial_data <br>  4. performs tests, one by one <br>  5. deletes everything that was created during the execution of tests <br><br>  The first and last stage may not be performed if the data lives in memory, but steps 2 and 3 take a significant amount of time and bring down the high rate of iterations ‚Äúcorrected code - launched the test‚Äù.  Obviously, the database schema and set of fixtures change much less frequently than the code and tests, so it makes sense to somehow save on the constant creation of the database.  By the way, steps 2 and 3 are the usual execution of the syncdb management command. <br><br>  The general approach to speeding up the launch of tests is to run syncdb manually, and only when it is really necessary, and when running the tests, simply copy the previously prepared database.  Using SQLite, you could get by copying files, but you didn‚Äôt want to lose the benefits of working with tests in ": memory:". <br><br>  A short search showed that a solution to this case exists.  It turns out that SQLite has an interface for ‚Äúhot‚Äù backup (just like adults), and if we run such a copy from a previously prepared database into the database named: memory: before running the tests, we will get exactly what we need: an initialized database data in memory. <br><br>  The first difficulty in implementation is that the standard Python module sqlite3 does not support, and may never support this API, therefore, to perform such copying with Python tools they suggest using a third-party module named APSW (Another Python SQLite Wrapper). <br><br>  The second difficulty is that each new connection to the database in: memory: creates its own copy of the database (obviously empty), and therefore you must somehow teach the cursor that the ORM uses to use the connection initialized by APSW.  Fortunately, a hack is provided for this case: instead of the line with the file name, when creating a connection using sqlite3, you can send an apsw.Connection object that will proxy all requests on its own. <br><br>  Thus, the solution looks very simple: <br><br>  1. Create two ASPW Connection objects, one of which refers to a previously prepared database, and the second to a base in memory. <br>  2. Copy data from file to memory. <br>  3. As the NAME parameter for an alias with the name ‚Äúdefault‚Äù, we pass ASPW Connection, which refers to the memory. <br>  4. Initialize the cursor, and run the tests. <br><br>  The database is very simple to prepare: just add another alias with the name ‚Äúquickstart‚Äù to the DATABASES settings.py variable, and then execute <code>./manage.py syncdb --database quickstart</code> . <br><br>  All code that can perform these actions takes a little more than 20 lines and is shown below.  It‚Äôs enough to make it work <br><br>  1. Install APSW <br>  2. Copy the code into a separate file and place it in the project <br>  3. Add a database alias to settings.DABABASES named quickstart <br>  4. Create a database by executing <code>./manage.py syncdb --database quickstart</code> <br>  5. Set the TEST_RUNNER variable so that it refers to the class of the newly saved object <br>  6. Try to run some simple test. <br><br><blockquote> <code><a href="http://s-c.me/22196/s"></a> <a href="http://s-c.me/22196/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#0000ff">import</font> apsw </li><li>  <font color="#0000ff">from</font> django.  <b>test</b> .simple <font color="#0000ff">import</font> DjangoTestSuiteRunner </li><li>  <font color="#0000ff">from</font> django.db <font color="#0000ff">import</font> connections </li><li></li><li>  <font color="#0000ff">class</font> <font color="#cc6633">TestSuiteRunner</font> (DjangoTestSuiteRunner): </li><li></li><li>  <font color="#0000ff">def</font> <font color="#cc6633">setup_databases</font> (self, ** kwargs): </li><li>  quickstart_connection = connections [ <font color="#008000">'quickstart'</font> ] </li><li>  quickstart_dbname = quickstart_connection.settings_dict [ <font color="#008000">'NAME'</font> ] </li><li></li><li>  memory_connection = apsw.Connection ( <font color="#008000">': memory:'</font> ) </li><li>  quickstart_connection = apsw.Connection (quickstart_dbname) </li><li>  <font color="#0000ff">with</font> memory_connection.backup ( <font color="#008000">'main'</font> , quickstart_connection, <font color="#008000">'main'</font> ) <font color="#0000ff">as</font> backup: </li><li>  <font color="#0000ff">while not</font> backup.done: </li><li>  backup.step ( <font color="#008000">100</font> ) </li><li></li><li>  connection = connections [ <font color="#008000">'default'</font> ] </li><li>  connection.settings_dict [ <font color="#008000">'NAME'</font> ] = memory_connection </li><li>  cursor = connection.cursor () </li><li></li><li>  <font color="#0000ff">def</font> <font color="#cc6633">teardown_databases</font> (self, old_config, ** kwargs): </li><li>  <font color="#0000ff">pass</font> </li></ol></blockquote><br><br>  As a result, the execution time of one single test was reduced from 18 to 2 seconds; it is quite comfortable to run the test as often as I would like. <br><br>  This same code, but with comments and a fat warning ‚Äúyour tests can eat your data!‚Äù (Use only in the test environment) is posted on <a href="https://gist.github.com/1044215">gist.github.com/1044215</a> . <br><br>  I hope these simple recommendations will allow you to write code faster, more efficiently and more reliably. <br><br><h4>  Used sources </h4><br>  For details and other useful information I recommend to refer to the documentation for your database server, as well as to the following sources: <br><br>  - <a href="http://www.stereoplex.com/blog/speeding-up-django-unit-test-runs-with-mysql">Speeding up Django unit test runs with MySQL</a> <br>  - <a href="http://www.mysqlperformanceblog.com/2007/11/01/innodb-performance-optimization-basics/">Innodb Performance Optimization Basics</a> <br>  - <a href="http://www.sqlite.org/backup.html">Using the SQLite Online Backup API</a> <br>  - <a href="http://blog.marcus-brinkmann.de/2010/08/27/how-to-use-sqlites-backup-in-python/">How to use SQLite's backup in Python</a> </div><p>Source: <a href="https://habr.com/ru/post/122574/">https://habr.com/ru/post/122574/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../122569/index.html">ICFPC'11 Reports</a></li>
<li><a href="../122570/index.html">Team Fortress 2 is now free!</a></li>
<li><a href="../122571/index.html">gnome-terminal Closing a tab with the middle mouse button</a></li>
<li><a href="../122572/index.html">Get acquainted? .TEL</a></li>
<li><a href="../122573/index.html">Filtering collections in Visual Studio debug windows</a></li>
<li><a href="../122575/index.html">PVS-Studio has learned to follow how you program</a></li>
<li><a href="../122576/index.html">Twitter will launch a two-month advertising tweet service.</a></li>
<li><a href="../122577/index.html">Manage your testing process easier.</a></li>
<li><a href="../122578/index.html">Spawnfest July 9-10, 2011</a></li>
<li><a href="../122580/index.html">iDrive - we archive and SugarSync - we synchronize our data</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>