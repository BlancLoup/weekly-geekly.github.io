<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Controlled caching of pages in nginx</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 As you know, nginx can cache server response, and issue it on request instead of accessing the backend, thereby saving server resources...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Controlled caching of pages in nginx</h1><div class="post__text post__text-html js-mediator-article"><h6>  Introduction </h6><br>  As you know, nginx can cache server response, and issue it on request instead of accessing the backend, thereby saving server resources.  The speed of return of such cached pages sometimes is amazing, for the sake of such speeds it is sometimes not a shame to transfer many functions of the site to javascript just to be able to cache another 1 page entirely (For example, to render a drawing of a plate with user authorization to js which is identical for all users, except for this very plate). <br><br>  I used the possibility of caching nginx pages many times, and ran across a couple of inconvenient things for myself: <br><ul><li>  You can easily cache all pages altogether, but is it necessary for dynamic sites or for sites with authorization? </li><li>  It is possible to cache several URLs separately, of the form / album / *, but not to rewrite the same nginx config each time new sections of the site appear? </li></ul><br><a name="habracut"></a><br>  If the project, in addition to everything, is laid out by the admins, decomposed into several servers, processed by several nginx - rewriting configs becomes a non-trivial task. <br><br>  For myself, I solved this task with the help of the X-Accel-Expires header and several lines in the nginx configuration. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h6>  Task </h6><br>  For my decision to cache pages, I formed the following requirements: <br>  1. Manage the on or off caching of each page from php. <br>  2. Manage caching by full url. <br>  3. Manage the cache time of each individual page or section of the site. <br>  4. To be able to change the time of caching and all cache settings at any time without overwriting the nginx configuration. <br><br><h6>  Decision </h6><br>  In my case, use fastcgi (php for content upload, nginx for statics) <br><br>  We will solve the problem in several steps: <br>  1. Set up a new zone for caching in the nginx configuration.  The line is prescribed before the section "server" with the configuration of our site, for example. <br><pre><code class="cs hljs">fastcgi_cache_path /tmp/mycache levels=<span class="hljs-number"><span class="hljs-number">2</span></span> keys_zone=mycachename:<span class="hljs-number"><span class="hljs-number">5</span></span>m inactive=<span class="hljs-number"><span class="hljs-number">2</span></span>m max_size=<span class="hljs-number"><span class="hljs-number">1500</span></span>m;</code> </pre> <br><br>  2. In the server section, set page caching as follows: <br><pre> <code class="cs hljs">location / { root $PROJECT_ROOT/data/ ; fastcgi_cache mycachename; fastcgi_cache_valid <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">301</span></span> <span class="hljs-number"><span class="hljs-number">302</span></span> <span class="hljs-number"><span class="hljs-number">304</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span>m; fastcgi_cache_key <span class="hljs-string"><span class="hljs-string">"$request_method|$http_if_modified_since|$http_if_none_match|$host|$request_uri"</span></span>; fastcgi_cache_use_stale error timeout invalid_header; fastcgi_pass_header <span class="hljs-string"><span class="hljs-string">"X-Accel-Expires"</span></span>; fastcgi_pass <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">9900</span></span>; fastcgi_index index.php; }</code> </pre><br><br>  Here we pay attention to the following parameters: <br>  fastcgi_cache - the name of the zone specified in point 1 <br>  fastcgi_cache_valid - for which response codes we enable caching.  The last parameter ‚Äî cache time ‚Äî will actually be the maximum cache time for a page.  Those.  we can manage cache time from 1 second to 30 minutes. <br>  fastcgi_cache_key - not to cache really different requests in one file <br>  fastcgi_pass_header "X-Accel-Expires" - optional, but useful for debugging - to see how in the end we have cached the page. <br><br>  3. In php we add the following things: <br>  Set the default header: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> header(<span class="hljs-string"><span class="hljs-string">"X-Accel-Expires: 0"</span></span>);</code> </pre><br>  In order to default no answer, we have not cached. <br>  And in the function responsible for displaying data to the user: <br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flushResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$cache_time) { <span class="hljs-comment"><span class="hljs-comment">// nginx cache header("X-Accel-Expires: " . (self::$cache_time), true); } ob_flush(); }</span></span></code> </pre><br>  Here we check if the page can be cached (in my case, using some logic or from the configuration of each page of the site, we get the page cache time in seconds) and set the X-Accel-Expires header one more time, overwriting the previously set value with 0. <br><br><h6>  What's happening? </h6><br>  Thus, nginx does the following when processing the request: <br>  1. Checks whether the requested page is in the cache (the cache file name is determined by the parameter fastcgi_cache_key) <br>  2. If it lies, it gives content without accessing php and tearing up the connection. <br>  3. Runs the php script, gets the X-Accel-Expires header in response.  If it is 0, nothing is cached, otherwise it is cached for the number of seconds specified in the header.  In our case, the maximum time is 30 minutes, which is determined by the last argument of the fastcgi_cache_valid parameter. <br><br><h6>  Conclusion </h6><br>  Thus, you can comfortably manage the powerful caching of nginx without overwriting the server configuration.  It was ‚Äúrewriting the configuration‚Äù and prescribing the caching conditions in the configs that pushed me away from using this technology for a long time. <br><br>  I did not describe all the charms of the nginx caching mechanism, which has already been discussed many times.  The article is designed to help start using this technology for people who find it easier to write logic in their programming language, and not through the nginx configuration. </div><p>Source: <a href="https://habr.com/ru/post/163847/">https://habr.com/ru/post/163847/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../163835/index.html">CentOS 5.x and Motion: View video stream after authorization</a></li>
<li><a href="../163837/index.html">We understand the development of Windows 8 applications on XAML / –° #, implementing a simple RSS Reader. Part 2</a></li>
<li><a href="../163839/index.html">Product Lifecycle Management. Popularly about the processes of life cycle management of telecommunications services</a></li>
<li><a href="../163841/index.html">Display generated on the fly html pages without saving to the clipboard or file system</a></li>
<li><a href="../163845/index.html">When is MIN (DATE)! = MIN (DATE)?</a></li>
<li><a href="../163849/index.html">What is wrong with the work on the result</a></li>
<li><a href="../163853/index.html">Git internals: data storage and merge</a></li>
<li><a href="../163855/index.html">Creating a Django web application in Visual Studio 2012 and publishing it to the Windows Azure cloud</a></li>
<li><a href="../163857/index.html">EBS RAID for faster performance and cost effectiveness</a></li>
<li><a href="../163859/index.html">Multithreaded web server for 1C: Enterprise using .Net Framework</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>