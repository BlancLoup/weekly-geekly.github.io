<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>UserJS. Part 4: libretki framework</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="libretki is a framework designed to simplify the creation of userjs and provide a ready-made set of useful functions. 

 Other articles in the series:...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>UserJS. Part 4: libretki framework</h1><div class="post__text post__text-html js-mediator-article">  <em>libretki</em> is a framework designed to simplify the creation of userjs and provide a ready-made set of useful functions. <br><br>  Other articles in the series: <ul><li>  <a href="http://habrahabr.ru/blogs/opera/61835/">Part 1: Introduction</a> </li><li>  <a href="http://habrahabr.ru/blogs/opera/61837/">Part 2: Tricks</a> </li><li>  <a href="http://habrahabr.ru/blogs/opera/61840/">Part 3: Security</a> </li></ul><br><br><h4>  Core </h4>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The system kernel is represented by the file <em>libretki.core.js</em> , which is a development of <em>loader.js</em> from the second article.  The kernel also provides some basic functions.  If all you need is the ability to connect other files, the kernel is sufficient. <br><br>  Typical script using libretki: <br><pre> if (! ('libretki' in window)) {libretki = {__scripts: []};  }
 libretki .__ scripts.push ({
     name: 'habrahabr.example',
     requires: ['libretki.utilities'],

     init: function (unsafe) {
       // some code ...

       libretki.core.namespace ('habrahabr.example', {
         func: function () {/ * ... * /},
       });
     }
 });
</pre><br><br><a name="habracut"></a><br><br>  The func function is now available as habrahabr.example.func.  The ‚Äúunsafe‚Äù object is used as a namespace for functions that it is unsafe to give away userjs, such as file access. <br><br><h4>  Function libraries </h4><br><br><h5>  Utilities (libretki.utilities) </h5><br>  A set of small convenience essentials: working with collections ( <em>forEach</em> , <em>map</em> , <em>filter</em> , ...), with optional arguments ( <em>optional</em> ), updating objects ( <em>modifyObject</em> ) and other utilities without special focus. <br>  Used by almost all other scripts. <br><br>  Example: <br><pre> var positive = libretki.utilities.filter (arr, function (item) {return item.value&gt; 0;});
 libretki.utilities.forEach (positive, function (item) {item.func ();});
</pre><br><br><h5>  Cookies management (libretki.cookies) </h5><br><br>  Comfortable working with cookies, instead of directly accessing <em>document.cookies</em> and parsing the result, provides the functions <em>set</em> , <em>get,</em> and <em>del</em> . <br><br>  Example: <br><pre> libretki.cookies.set ('name', 'value');
 var value = libretki.cookies.get ('name');
</pre><br><br><h5>  JSON (libretki.json) </h5><br>  Serialization and deserialization of objects in JSON-format. <br><br>  Example: <br><pre> var str = libretki.json.stringify ({name: 'name', value: 'value', active: true});
 var obj = libretki.json.parse (str);
</pre><br><br><h5>  Storing objects in cookies (libretki.cookies_json) </h5><br>  Storing objects in cookies.  It is a simple combination of cookies and json libraries and, in principle, redundant, but remained for historical reasons. <br><br>  Example: <br><pre> libretki.cookies_json.set ('name', {value: 'value', active: true});
 var obj = libretki.cookies_json.get ('name');
</pre><br><br><h5>  XPath (libretki.xpath) </h5><br>  Getting items and values ‚Äã‚Äãusing XPath.  It is a thin layer above <em>document.evaluate</em> , but it eliminates memorization of specific constants and fields. <br><br>  Example: <br><pre> var nodes = libretki.xpath.getNodes (document.body, '// img [@ class = "adv"]');
 var value = libretki.xpath.getNumber (tbody, 'tr / td [@ id = "header"] / @ colspan');
</pre><br><br><h5>  Modifying a document with DOM (libretki.visual.dom) </h5><br>  It provides functions for quick and easy creation of elements, as well as functions for modifying the tree (‚Äúappend‚Äù, ‚Äúprepend‚Äù, ‚Äúbefore‚Äù, ‚Äúafter‚Äù, ...) and adding / deleting classes. <br><br>  Example: <br><pre> var dom = libretki.visual.dom;
 dom.before (elem, dom.html.a ({href: "http: // ...", className: "outlink"}, [
   dom.html.img ({src: "..."}), "link content"
 ]);
</pre><br><br><h5>  Animation (libretki.visual.animation) </h5><br>  Animation elements.  It was created for the toolbar, so for now it only contains animations ‚ÄúfadeIn‚Äù, ‚ÄúfadeOut‚Äù and ‚ÄúmoveY‚Äù. <br><br>  Example: <br><pre> libretki.visual.animation.fadeOut (elem, {time: 500});
</pre><br><br><h5>  General toolbar (libretki.visual.toolbar) </h5><br>  A common toolbar to which each script can add its own buttons.  The toolbar is displayed when you hover over a small square in the upper left corner of the page  You can add simple buttons and toggle buttons.  It doesn‚Äôt look very good - I‚Äôm not a designer, I threw in some kind of gradient and plunged into the code. <br><br> <a href="http://www.picamatic.com/view/3990072_toolbar/"><img src="http://www.picamatic.com/show/2009/06/14/06/04/3990072_bigthumb.png" alt="toolbar.png - image uploaded to Picamatic" title="toolbar.png" width="313" height="100"></a> <br><br>  Example: <br><pre> // Add our own button.
 libretki.toolbar.onShow (function (toolbar) {
   var group = new libretki.toolbar.ButtonsGroup ("Example");
   var button = new libretki.toolbar.CommandButton ("Alert", "data: image / svg + xml; base64, ...", function () {
     alert ("Example");
   });
   group.addButton (button);
   toolbar.addGroup (group);
 });
</pre><br><br><h5>  Services </h5><br><br>  A service is a code that listens and responds to XDM messages.  Services are necessary for the safe use of advanced userjs from any page. <br><br>  On the bare JavaScript service and using the code look like this: <br>  Service: <br><pre> if (location.href == 'http://0.0.0.0/') {
   window.addEventListener ('message', function (ev) {
     var fields = ev.data.split ('|');
     if (fields [0] == 'set') {
       // ...
       ev.source.postMessage ('ok');
     } else if (fields [0] == 'get') {
       // ...
       ev.source.postMessage (value);
     }
   }, true);
 }
</pre><br><br>  Using: <br><pre> window.addEventListener ('message', function (ev) {
   // Handle the response from the service.
 });
 var frame = document.createElement ('iframe');
 frame.onload = function () {
   // Here you can use the service.
   frame.contentWindow.postMessage ('get | key');
 };
 frame.src = 'http://0.0.0.0/';
 frame.style = 'display: none;';
 document.documentElement.appendChild (frame);
</pre><br><br>  As you can see, it is troublesome and has several disadvantages: <ul><li>  you can only pass strings, so you have to manually parse; </li><li>  for each service you have to upload a separate frame with a different address; </li><li>  Difficult to handle responses when using multiple services; </li><li>  It is possible to inadvertently create multiple frames with the same address; </li><li>  the service may be available to scripts from a page that is insecure. </li></ul><br><br>  Libretki assumes all these difficulties. <br><br><h6>  Cross-domain messaging (libretki.xdm) </h6><br>  Safe and convenient use of XDM.  It allows you to organize several services at the same address, distinguishing them by name.  Used by JSON to transfer objects.  Prevents access to service scripts from the page. <br><br>  Classes: <ul><li>  Server - accepts messages and can respond to them; </li><li>  Client - sends messages but cannot receive replies; </li><li>  Channel - the client and the server in one person, can send messages and receive answers to them; </li><li>  SeqClient, SeqServer are analogs of Channel and Server, respectively, but if the former do not track the correspondence between the request and the response, then they let you know which answer came from.  Also detects missing messages. </li></ul><br><br>  Sample Server / Channel service: <br><pre> if (location.href == 'http://0.0.0.0/') {
   new Server ('habrahabr.example', function (msg, client) {
     switch (msg.command) {
     case 'get':
       client.post ({command: 'get', key: msg.key, value: get_value (msg.key)});
       break;
     case 'set':
       set_value (msg.key, msg.value);
       client.post ({command: 'set', key: msg.key, success: true});
       break;
     }
   }
 }
</pre><br>  customer: <br><pre> load_page ('http://0.0.0.0/', function (win) {
   var channel = new Channel (win, 'habrahabr.example', function (msg) {
     switch (msg.command) {
       case 'get': data [msg.key] = msg.value;  break;
       case 'set': if (msg.success) written [msg.key] = true;  break;
     }
   }
   channel.post ({command: 'get', key: 'some'});
   channel.post ({command: 'set', key: 'some', value: 'bla'});
 });
</pre><br><br>  The same on SeqServer / SeqClient: <br><pre> new SeqServer ('habrahabr.example', function (msg) {
     switch (msg.command) {
     case 'get':
       return get_value (msg.key);
     case 'set':
       set_value (msg.key, msg.value);
       return true;
     }
 });
</pre><br><pre> load_page ('http://0.0.0.0/', function (win) {
   var client = new SeqClient (win, 'habrahabr.example');
   client.post ({command: 'get', key: 'some'}, function (result) {
     data ['some'] = result;
   });
   client.post ({command: 'set', key: 'some', value: 'bla'}, function (result) {
     if (result) written [some '] = true;
   });
 });
</pre><br><br><h6>  Remote procedure call (libretki.xdm.rpc) </h6><br>  Even more simplifies the task of creating a service.  Just write: <br><pre> unsafe.libretki.xdm.rpc.service ('http://0.0.0.0/', 'habrahabr.example', {
   get: function (key) {return data [key];  },
   set: function (key, value) {data [key] = value;  },
 });
</pre><br>  , use: <br><pre> var ex = unsafe .__ services.habrahabr.example;
 // Returns not just the result of the execution, but the function to be called
 // to get the result.  This is done so that you can pass exceptions.
 ex.get ('key', function (res) {data ['key'] = res ();});
 ex.set ('key', 'value', function (res) {res (); written ['key'] = true;});
</pre><br><br>  Significantly less code compared to the initial version, is not it?  Now you can take up the creation of useful services. <br><br><h6>  Shared data storage (libretki.xdm.storage) </h6><br>  Allows you to save data available from any page.  Implemented by saving cookies on the page 'http://0.0.0.0/'. <br><br>  Example: <br><pre> var storage = unsafe.__services.libretki.storage;
 storage.set ('habrahabr_auth', {login: 'login', password: '123qwe'});
 storage.get ('habrahabr_auth', function (res) {
   var data = res ();
   login (data.login, data.password);
 });
</pre><br><br><h6>  Clipboard (libretki.xdm.clipboard) </h6><br>  Requires Java. <br><br>  Example: <br><pre> var clipboard = unsafe .__ services.libretki.clipboard;
 clipboard.set ('text');
 clipboard.get (function (res) {
   var text = res ();
   alert ('Clipboard content:' + text);
 });
</pre><br><br><h6>  Access to the file system (libretki.xdm.io.file) </h6><br>  Allows you to create, delete and rename files and folders, scan folders.  Requires Java. <br><br>  Example: <br><pre> var file = unsafe .__ services.libretki.io.file;
 file.exists ('/ some / path', function (res) {alert (res ());});
 // Read a maximum of 10 lines.
 file.readLines ('/ another / path', 'utf-8', 10, function (res) {
   var lines = res ();
 });
</pre><br><br>
<h6>  Cross-domain XMLHttpRequest (libretki.xmlhttprequest) </h6><br>  I will not give you an example of using XMLHttpRequest, everything is as usual, only you need to use "libretki.xmlhttprequest.XMLHttpRequest". <br><br>  Emulation XMLHttpRequest is made to simplify the adaptation of someone else's code.  If you are writing userjs from scratch, the ‚Äúfetch‚Äù function is much more convenient: <br><pre> libretki.xmlhttprequest.fetch ('http: //some.url/path', {
   username: 'user',
   method: 'POST', content: 'blabla',
   onOpened: function () {},
   onDone: function (status, headers, response) {},
   onError: function () {},
 });
</pre><br><br><h5>  A set of scripts for uploading images in the "Show cached only" mode (libretki.imaginate) </h5><br>  This set of scripts is packaged in a separate archive.  I will not describe individual scripts, I will only say that they help when working in the mode of displaying cached images.  Since my channel is narrow, I use this mode all the time.  You can load individual images in various ways - by hovering the mouse on it, holding down the key, selecting the area on the screen, selecting a piece of text, loading the images visible in the window, etc. <br><br><h4>  Instruments </h4><br><br>  In the <em>libretki / tools</em> folder you can find several tools executed as HTML pages. <br><br><h5>  Setup (libretki / tools / libretki.settings.html) </h5><br><br>  Interface settings scripts. <br><br>  Configure the required parameters and do not forget to click the "Save" button.  It works without Java, but then you have to save the settings file manually. <br><br> <a href="http://www.picamatic.com/view/3988189_settings/"><img src="http://www.picamatic.com/show/2009/06/14/02/41/3988189_bigthumb.png" alt="settings.png - Picamatic - upload your images" title="settings.png" width="320" height="143"></a> <br><br><h5>  Script management (libretki / tools / libretki.scripts.html) </h5><br><br>  List of installed userjs with the ability to turn on and off.  Can be used as a browser sidebar.  Requires Java. <br><br> <a href="http://www.picamatic.com/view/3988471_scripts/"><img src="http://www.picamatic.com/show/2009/06/14/03/20/3988471_bigthumb.png" alt="scripts.png - Picamatic - upload your images" title="scripts.png" width="182" height="240"></a> <br><br><h5>  Creating buttons (libretki / tools / libretki.bookmarklets.html) </h5><br><br>  Automates the creation of bookmarklets for various commands.  Select a command, customize its arguments, give the command a name, and drag the resulting link to the toolbar or bookmark. <br><br> <a href="http://www.picamatic.com/view/3988444_bookmarklets/"><img src="http://www.picamatic.com/show/2009/06/14/03/17/3988444_bigthumb.png" alt="bookmarklets.png - image uploaded to Picamatic" title="bookmarklets.png" width="320" height="176"></a> <br><br><h4>  Where to get </h4><br>  Download <em>libretki</em> at <a href="http://libretki.kriomant.net/">libretki.kriomant.net</a> . <br><br><h4>  Installation </h4><br>  Installation is still quite complicated: <ol><li>  Unpack the contents of the archive into the folder of user scripts; </li><li>  Install Java if you want to use file access or clipboard; </li><li>  find out the location of the Java policy file (‚Äúopera: config # Java | SecurityPolicy‚Äù), copy it somewhere, add permissions using the sample in <em>libretki / opera.policy</em> , specify the path to the new file in the settings; </li><li>  open <em>libretki / tools / libretki.settings.html</em> and click ‚ÄúSave‚Äù, this is necessary to generate the unique code that is used for XDM </li></ol><br><br><h4>  Examples </h4><br>  In the folder "libretki / examples" there are examples of using some features.  Since some features are specifically hidden from scripts on the page, for the respective examples to work, you must place the file ‚Äúlibretki / examples / libretki.allow-unsafe.js‚Äù in the scripts folder. <br><br><h4>  Plans </h4><br>  In the process of writing are installers for Windows and Linux. <br><br><h4>  Problems </h4><br>  Firstly, feedback is required.  Announced <em>libretki</em> on OperaFan, like some people have downloaded, but have not left a single review.  Express your attitude: <ul><li>  it is a useless thing; </li><li>  too difficult to install; </li><li>  weighs too much; </li><li>  lack of documentation; </li><li>  another. </li></ul><br><br>  Secondly, <em>libretki</em> needs a logo and site design, I myself in this matter do not have a foot to tooth.  Place and domain already exist. </div><p>Source: <a href="https://habr.com/ru/post/62045/">https://habr.com/ru/post/62045/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../62028/index.html">Online P2P client</a></li>
<li><a href="../62030/index.html">Kerio vpn client for Gentoo</a></li>
<li><a href="../62039/index.html">ADOBE European Tour in Minsk. Open Lecture on Flex 4, Flex Builder 4, Flash Catalyst and ColdFusion June 26</a></li>
<li><a href="../62040/index.html">Several handy tools for testing the site</a></li>
<li><a href="../62043/index.html">Mandelbrot on .bat "for fun"</a></li>
<li><a href="../62047/index.html">Beautiful cartoon, nothing more</a></li>
<li><a href="../62049/index.html">The English section of Wikipedia discusses the admissibility of writing articles for money.</a></li>
<li><a href="../62051/index.html">Using Direct3D with Qt</a></li>
<li><a href="../62052/index.html">Macintosh Classic - Retro Classic</a></li>
<li><a href="../62053/index.html">Service exchange</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>