<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bulk recording from cameras on elections - 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Habr - not for politics. This article deals only with the technical aspects of the implementation of a specific software solution. For the common good...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bulk recording from cameras on elections - 2</h1><div class="post__text post__text-html js-mediator-article">  <strong>Habr - not for politics.</strong>  This article deals only with the technical aspects of the implementation of a specific software solution.  For the common good, please refrain from any political debates, speeches, campaigning and similar actions in the comments.  In addition, please do not apply this knowledge for destructive purposes, do not start backing up the entire video archive without special need, and so on.  Thank. <br><br>  September 8, single voting day.  This year, the general public is invited to monitor the elections for the capital‚Äôs mayor via the Internet.  A number of citizens find it interesting to record a picture from the cameras: someone has a politically motivated interest, and most are simply curious to look at themselves and those familiar with the eyes of the Internet.  This article is intended to demonstrate the principles of the current system and to offer working concepts. <br><br><a name="habracut"></a><br>  Since the last election, the system has changed a little bit (otherwise there would have been no article), so first <a href="http://habrahabr.ru/post/156417/">we will remember</a> how everything worked before and how it began to work now.  So, each camera has a unique <strong>uid</strong> and a pool of servers from which video is streamed.  Having formed a special request using this data, you can get a link to a piece of video recorded by the selected camera. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To begin, find the data on all existing cameras.  The following method seemed the easiest to me: let's start the search by site number, from 1 to 3800. To do this, send GET <a href="http://vybory.mos.ru/json/id_search/">vybory.mos.ru/json/id_search</a> <b>aaa</b> / <b>bbb</b> .json, where <b>bbb</b> is uid and <b>aaa</b> is len ( <strong>bbb</strong> ).  For example, <a href="">vybory.mos.ru/json/id_search/1/3.json</a> <br><br>  Get json with information about this site, something like this: <br><pre><code class="javascript hljs">[{<span class="hljs-string"><span class="hljs-string">"id"</span></span>:<span class="hljs-number"><span class="hljs-number">7933</span></span>,<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"   ‚Ññ3"</span></span>,<span class="hljs-string"><span class="hljs-string">"num"</span></span>:<span class="hljs-string"><span class="hljs-string">"3"</span></span>,<span class="hljs-string"><span class="hljs-string">"location_id"</span></span>:<span class="hljs-number"><span class="hljs-number">1162</span></span>,<span class="hljs-string"><span class="hljs-string">"address"</span></span>:<span class="hljs-string"><span class="hljs-string">" , 36/9"</span></span>,<span class="hljs-string"><span class="hljs-string">"raw_address"</span></span>:<span class="hljs-string"><span class="hljs-string">".,   .,  36/9"</span></span>,<span class="hljs-string"><span class="hljs-string">"is_standalone"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>,<span class="hljs-string"><span class="hljs-string">"size"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span>,<span class="hljs-string"><span class="hljs-string">"location"</span></span>:{<span class="hljs-string"><span class="hljs-string">"id"</span></span>:<span class="hljs-number"><span class="hljs-number">1162</span></span>,<span class="hljs-string"><span class="hljs-string">"address"</span></span>:<span class="hljs-string"><span class="hljs-string">", ,   , 36/9"</span></span>,<span class="hljs-string"><span class="hljs-string">"raw_address"</span></span>:<span class="hljs-string"><span class="hljs-string">".,   .,  36/9"</span></span>,<span class="hljs-string"><span class="hljs-string">"district_id"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">"area_id"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span>,<span class="hljs-string"><span class="hljs-string">"sub_area_id"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span>,<span class="hljs-string"><span class="hljs-string">"locality_id"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">"street_id"</span></span>:<span class="hljs-number"><span class="hljs-number">1590</span></span>,<span class="hljs-string"><span class="hljs-string">"lat"</span></span>:<span class="hljs-number"><span class="hljs-number">55.753266</span></span>,<span class="hljs-string"><span class="hljs-string">"lon"</span></span>:<span class="hljs-number"><span class="hljs-number">37.577301</span></span>,<span class="hljs-string"><span class="hljs-string">"max_zoom"</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>}}]</code> </pre> <br><br>  Of particular interest here is the <strong>id</strong> .  Send a GET of the form <a href="http://vybory.mos.ru/account/channels%3Fstation_id%3D">vybory.mos.ru/account/channels?station_id=</a> <strong>id</strong> , in this case <a href="http://vybory.mos.ru/account/channels%3Fstation_id%3D7933">vybory.mos.ru/account/channels?station_id=7933</a> <br><br>  In the answer we will get a line with krakozyablami, which my editor swears, but containing cameras' hashes and server addresses inside.  We extract the hashes from there by the regular form <br>  <strong>\ $ ([0-9a-h] {8} - [0-9a-h] {4} - [0-9a-h] {4} - [0-9a-h] {4} - [0- 9a-h] {12})</strong> and ip addresses of the regular form <strong>: *? (\ D {1,3} \. \ D {1,3} \. \ D {1,3} \. \ D {1,3 })</strong> <br><br>  As a result, we obtain the required information about the cameras of the current section: <br>  2e9dd8dc-edd4-11e2-9a6b-f0def1c0f84c 188.254.112.2 188.254.112.3 188.254.112.4 <br>  2ea32990-edd4-11e2-9a6b-f0def1c0f84c 188.254.112.2 188.254.112.3 188.254.112.4 <br><br>  Next come the nuances.  There are three types of cameras: old, new and missing.  How do they differ, I will tell you a little later, first we will figure out how to distinguish between them, and it is very simple to distinguish between them - you need to send a GET of the form http: // <strong>SERVER</strong> /master.m3u8?cid= <strong>UID</strong> <br>  New camera will return something like <br><br><blockquote>  # EXTM3U <br>  # EXT-X-VERSION: 2 <br>  # EXT-X-STREAM-INF: PROGRAM-ID = 777, BANDWIDTH = 3145728 <br>  /variant.m3u8?cid=e1164950-0c19-11e3-803b-00163ebf8df9&amp;var=orig <br></blockquote><br><br>  An old camera will return something like this: <br><blockquote>  # EXTM3U <br>  # EXT-X-MEDIA-SEQUENCE: 136 <br>  # EXT-X-TARGETDURATION: 15 <br>  # EXT-X-ALLOW-CACHE: NO <br>  # EXT-X-PROGRAM-DATE-TIME: 2013-09-04T12: 05: 40Z <br>  #EXTINF: 15, <br>  /segment.ts?cid=2ea32990-edd4-11e2-9a6b-f0def1c0f84c&amp;var=orig&amp;ts=1378296340.93-1378296355.93 <br>  #EXTINF: 15, <br>  /segment.ts?cid=2ea32990-edd4-11e2-9a6b-f0def1c0f84c&amp;var=orig&amp;ts=1378296355.93-1378296370.93 <br>  #EXTINF: 15, <br>  /segment.ts?cid=2ea32990-edd4-11e2-9a6b-f0def1c0f84c&amp;var=orig&amp;ts=1378296370.93-1378296385.93 <br>  #EXTINF: 15, <br>  /segment.ts?cid=2ea32990-edd4-11e2-9a6b-f0def1c0f84c&amp;var=orig&amp;ts=1378296385.93-1378296400.93 <br></blockquote><br><br>  Missing camera will not return anything except <strong>404 CID Was Not Found</strong> :) <br><br>  Now, when we are able to obtain information about the cameras of a particular site, we will write a multi-threaded parsile which will collect all the necessary information for us.  I prefer to add the data to a free Mongolian, but it is possible to do with the usual shelve.  Knowing that there are 3500+ plots in Moscow, let's run through the cycle from 1 to 3800. Below is a working code, sketched on the knee, but nevertheless.  In it, of course, you need to enter your cookies and passwords from the server of the monga. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- import json, re import httplib import threading from time import sleep import Queue from pymongo import MongoClient client = MongoClient('mongodb://admin:@.mongolab.com:43368/elections') db = client['elections'] data = db['data'] data.drop() def get_data(uid): print uid headers = {'Origin': 'vybory.mos.ru', 'X-Requested-With': 'XMLHttpRequest', 'User-Agent': 'Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0);', 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8', 'Accept': '*/*', 'Referer': 'http://vybory.mos.ru/', 'Accept-Encoding': 'deflate,sdch', 'Accept-Language': 'ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4', 'Accept-Charset': 'windows-1251,utf-8;q=0.7,*;q=0.3', 'Cookie': 'rack.session=' } try: conn = httplib.HTTPConnection('vybory.mos.ru') conn.request('GET', '/json/id_search/%d/%d.json'%(len(str(uid)), uid), None,headers) resp = conn.getresponse() try: content = json.loads(resp.read())[0] conn.request('GET', '/account/channels?station_id=%s'%content['id'], None,headers) resp = conn.getresponse() cont = resp.read() cnt=0 for i in cont.split('\x00')[1:]: cnt+=1 uid=re.findall(r'\$([0-9a-h]{8}-[0-9a-h]{4}-[0-9a-h]{4}-[0-9a-h]{4}-[0-9a-h]{12})', i)[0] ip=re.findall(r'.*?(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})', i) conn2 = httplib.HTTPConnection('%s'%ip[0]) conn2.request('GET', '/master.m3u8?cid=%s'%(uid), None,headers) info = conn2.getresponse().read() conn2.close() if '/segment.ts' in info: camtype='old' elif '/variant.m3u8' in info: camtype='new' else: camtype='nil' #print content data.insert({ 'name':content['name'], 'num':content['num'], 'addr':content['address'], 'uid':uid, 'ip':ip, 'cnt':str(cnt), 'type':camtype }) except Exception,e: pass except Exception,e: print e conn.close() queue = Queue.Queue() def repeat(): while True: try: item = queue.get_nowait() except Queue.Empty: break get_data(item) sleep(0.01) queue.task_done() for i in xrange(1, 3800): queue.put(i) for i in xrange(10): t = threading.Thread(target=repeat) t.start() queue.join() print data.find().count(),'all cams' print data.find({'type':'nil'}).count(),'offline cams' print data.find({'type':'old'}).count(),'old cams' print data.find({'type':'new'}).count(),'new cams'</span></span></code> </pre><br><br>  Now we have a fully assembled camera base.  At the time of writing the article, the old cameras were 544, with them, alas, it will only work as before. <br>  But now we have 5778 new cameras, and they have one feature.  Chunks from old cameras after a very short time foul - you need to constantly download a fresh playlist, rip out links to chunks and swing them until they are rotten.  New cameras lack this flaw.  You can download arbitrary sizes of chunks for an arbitrary period of time by sending a GET like http: // <strong>SERVER</strong> /segment.ts?cid= <strong>UID</strong> &amp; var = orig &amp; ts = <strong>BEGIN</strong> - <strong>END</strong> There can be not more than 15 seconds between <strong>BEGIN</strong> and <strong>END</strong> .  I stopped at the chunks lasting 5 minutes.  In fact, you can specify at least an hour, but in some cases, as far as I can tell, if the broadcast was interrupted during the chunk limits, the entire chunk will not download.  Roughly speaking, if you try to download 8 hours from the archive in chunks by the hour and at the same time there was virtually no broadcast during a few minutes of a single chunk, the entire hour chunk does not download.  Therefore, it is reasonable to choose a smaller chunk.  Algorithmization gurus (of which, as we remember, 10%) can write their binary search, so that not a single video is gone =) <br>  By the way, in order to close the question - the absent is the camera, which is registered in the portal, but in fact does not work. <br><br>  Automate the download process.  Here you could fence off your multi-threaded python bike, but I decided to use third-party software.  We will generate a metafile with links to chunks for <a href="http://aria2.sourceforge.net/">aria2c</a> , metafiles for <a href="http://www.videohelp.com/tools/tsMuxeR">tsmuxer</a> and launch them sequentially. <br><br>  For example, something like this: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- from time import sleep, time from pymongo import MongoClient import os import subprocess import shutil # ,     directory='e:/dumps' #  delta=300 #   num='666' client = MongoClient('mongodb://:@.mongolab.com:43368/elections') db = client['elections'] data = db['data'] #    8  start=int(time())-3600*8 #       try: os.mkdir('%s/%s'%(directory,num)) except: pass #           for i in data.find({'num':num}): if i['type']=='nil': print 'Offline camera',i['uid'] elif i['type']=='old': print 'Old camera',i['uid'] else: print 'New camera',i['uid'] f=open('links-%s-%s.txt'%(num, i['cnt']),'w') #     try: os.mkdir('%s/%s/%s'%(directory,num,i['cnt'])) except: pass cur=start files='' #      while True: if cur+delta&gt;time(): for ip in i['ip']: url = 'http://{0}/segment.ts?cid={1}&amp;var=orig&amp;ts={2}.00-{3}'.format(ip, i['uid'], cur, time()) f.write('%s\t'%url) f.write('\n dir={0}/{1}/{2}\n out={3}.ts\n'.format(directory,num,i['cnt'],url[-27:])) files += '"{0}/{1}/{2}/{3}.ts"+'.format(directory,num,i['cnt'],url[-27:]) break else: for ip in i['ip']: url = 'http://{0}/segment.ts?cid={1}&amp;var=orig&amp;ts={2}.00-{3}.00'.format(ip, i['uid'], cur, cur+delta) f.write('%s\t'%url) f.write('\n dir={0}/{1}/{2}\n out={3}.ts\n'.format(directory,num,i['cnt'],url[-27:])) files += '"{0}/{1}/{2}/{3}.ts"+'.format(directory,num,i['cnt'],url[-27:]) cur+=delta #        . m=open('%s-%s.meta'%(num,i['cnt']),'w') m.write('MUXOPT --no-pcr-on-video-pid --new-audio-pes --vbr --vbv-len=500\n') m.write('V_MPEG4/ISO/AVC, %s, fps=23.976, insertSEI, contSPS, track=3300\n'%files[:-1]) m.write('A_AAC, %s, timeshift=-20ms, track=3301\n'%files[:-1]) m.close() f.close() subprocess.Popen('aria2c.exe -i links-%s-%s.txt -d %s -x 16'%(num, i['cnt'], directory), shell=True).communicate() subprocess.Popen('tsMuxeR.exe %s-%s.meta %s/%s-%s.ts\n'%(num, i['cnt'], directory, num,i['cnt']), shell=True).communicate() shutil.rmtree('%s/%s'%(directory,num)) os.remove('%s-%s.meta'%(num, i['cnt'])) os.remove('links-%s-%s.txt'%(num, i['cnt']))</span></span></code> </pre><br><br>  Again, the code was written solely for the purpose of testing the concept and is not an example of compliance with PEP8, but it works fine.  Download speed for obvious reasons depends on many factors. <br><br>  <b>UPD</b> There is an opinion that the old cameras are systematically replaced with new ones.  Last night there were 337 old and 5776 new ones, this morning - 273 old, 5811 new ones. <br><br>  <b>UPD</b> It turns out that there is also <a href="http://webvybory2013.ru/">webvybory2013.ru</a> , where the picture goes with other <a href="http://webvybory2013.ru/">options</a> too.  All that is written in this article applies to them, only the domain needs to be changed. <br><br>  <b>UPD</b> Cameras are constantly changing their status, pay attention to it.  With the old system are replaced with new ones. </div><p>Source: <a href="https://habr.com/ru/post/192590/">https://habr.com/ru/post/192590/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../192572/index.html">Reading a great article is difficult ... Testing a complex product is easy</a></li>
<li><a href="../192580/index.html">Knowledge Factory</a></li>
<li><a href="../192584/index.html">Samsung introduced new devices at IFA 2013</a></li>
<li><a href="../192586/index.html">LG's End of the World</a></li>
<li><a href="../192588/index.html">Mini PC for Linux for $ 45</a></li>
<li><a href="../192592/index.html">The implementation of the site registry of prohibited sites: again, twenty-five!</a></li>
<li><a href="../192594/index.html">Joker java conference: choose reports together!</a></li>
<li><a href="../192596/index.html">myOpenID closes February 1, 2014</a></li>
<li><a href="../192598/index.html">Now push messages and in safari</a></li>
<li><a href="../192604/index.html">Jeff Dean from Google - Chuck Norris of our time</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>