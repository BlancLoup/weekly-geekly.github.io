<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sonata import bundle</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Until now, one of the best admin panels for symfony is SonataAdminBundle, and for good reason. Simple installation, configuration, many out-of-the-box...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sonata import bundle</h1><div class="post__text post__text-html js-mediator-article">  Until now, one of the best admin panels for symfony is SonataAdminBundle, and for good reason.  Simple installation, configuration, many out-of-the-box features and a large community. <br><br>  The only thing missing is the import of files.  Agree, an important function. <br><br>  The network contains many import implementations for Sonata, but there are minor flaws everywhere - the ability to import text fields only, not entities, does not work with collections, it‚Äôs problematic to load huge databases that can be processed for more than one hour ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Today I want to present you my implementation, which I have been using successfully for quite a long time, but only now my hands have come to comb it all and arrange it in a separate bundle. <br><br><img src="https://habrastorage.org/webt/59/ce/2c/59ce2c78073d5905628919.jpeg" alt="image"><br><a name="habracut"></a><br>  I will not describe the entire installation and configuration process here.  Moreover, unlike many implementations, it is extremely simple.  You can read all this in the README.md and wiki on github: <br><br><ul><li>  <a href="https://github.com/Doctrs/SonataImportBundle">github.com/Doctrs/SonataImportBundle</a> </li><li>  <a href="https://github.com/Doctrs/SonataImportBundle/wiki">github.com/Doctrs/SonataImportBundle/wiki</a> </li></ul><br>  In this article I want to describe only the interesting moments that I encountered during its creation. <br><br><h2>  Large amounts of data </h2><br>  For the first time, the idea of ‚Äã‚Äãimplementing this bundle came to me at a time when I needed to transfer a fairly large table of regions, cities, towns, squares, and everything, everything, to the customer‚Äôs base (~ 3 million lines).  Complicated all the fact that access to its server we did not have. <br>  I tried several ready-made solutions, but I realized that they are designed for small volumes that can be downloaded while waiting for a response from the server. <br><br><h4>  Decision </h4><br>  It was necessary to implement this not through a web server, but through php-cli.  Fortunately, symfony has very good tools for working with console commands. <br>  To call there is an excellent class <b>Application</b> : <br><br><pre><code class="php hljs">$application = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Application(); <span class="hljs-comment"><span class="hljs-comment">// ... register commands $application-&gt;run();</span></span></code> </pre> <br>  But this method is also not suitable, because it works through a web server.  Only one thing remains: <b>Symfony \ Component \ Process \ Process</b> , since it works directly with the console.  We create a simple command (thanks to <a href="https://habrahabr.ru/users/oxidmod/" class="user_link">oxidmod</a> for a more beautiful and correct solution): <br><br><pre> <code class="php hljs">$command = sprintf( <span class="hljs-string"><span class="hljs-string">'/usr/bin/php %s/console promoatlas:sonata:import %d "%s" "%s" &gt; /dev/null 2&gt;&amp;1 &amp;'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;get(<span class="hljs-string"><span class="hljs-string">'kernel'</span></span>)-&gt;getRootDir(), $fileEntity-&gt;getId(), <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;admin-&gt;getCode(), $fileEntity-&gt;getEncode() ? $fileEntity-&gt;getEncode() : <span class="hljs-string"><span class="hljs-string">'utf8'</span></span> );</code> </pre> <br>  Last line for asynchronous operation.  And run all this in the background. <br><br><h2>  Reporting </h2><br>  Agree that it is hard to wait more than a minute, not understanding what exactly is happening.  And if this process takes an hour?  Two? <br><br>  That is why we need some kind of log console command.  I usually use text files for logs, but this time, because of the amount of information, I decided to use a database. <br>  An entity is responsible for each line: <b>Doctrs \ SonataImportBundle \ Entity \ ImportLog</b> . <br>  Each entry corresponds to a line from a file and it has everything you need: <br><br><ul><li>  ts - timestamp, </li><li>  status - what happened to the string </li><li>  message - error messages </li><li>  line - the line number from the file, </li><li>  foreignId - entity id </li></ul><br>  It is for this data that we will further monitor the download process, and display the final detailed report. <br><br>  Since an iterator is used to parse the file, the percentage of completion will not work.  We display just the total number of records processed. <br><br><h2>  Errors </h2><br>  Unfortunately, I did not learn to catch FatalError.  Therefore, in the case of, for example, <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setOwner</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Owner $owner)</span></span></span></span>; $owner = $em-&gt;findOwner(); <span class="hljs-comment"><span class="hljs-comment">//  ,  null $entity-&gt;setOwner($owner);</span></span></code> </pre> <br>  command will drop with FatalError. <br><br>  Another exception I encountered is an ORMException. <br>  What is so interesting about it?  Normal exception when trying to process a request with incorrect data. <br><br>  Actually, this is exactly what it is meant for, though after throwing out such an exception, the EntityManager closes the connection, and responds to any attempts to query the database: <br>  <b>EntityManager is closed</b> <br><br>  In my bandle, such an exception is thrown in 2 cases.  The first is if the validation of the entity is incorrectly configured (they must be validated before adding to the base of the entity) <br><br><pre> <code class="php hljs">$validator = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getContainer()-&gt;get(<span class="hljs-string"><span class="hljs-string">'validator'</span></span>); $errors = $validator-&gt;validate($entity);</code> </pre> <br>  And the second is related to the work of the bundle with the fields of type <b>choice</b> and <b>entity</b> .  If we essentially have a subsidiary entity (for example, the book has an author. The author‚Äôs choice comes from the database), then when importing the book we can specify the author either by using the ID or by using the title.  If the field is not numeric, then the system tries to find the entity by the name field.  If the entity does not have such a field (for example, the author's name is stored not in name, but in login or username), then we get an ORMException. <br><br>  In principle, they were quite frequent, so I had to make a small hack to reload the EntityManager, so that after throwing an exception, the system could expose the STATUS_ERROR file, and successfully display all of this in the interface: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;em-&gt;isOpen()) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;em = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;em-&gt;create( <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;em-&gt;getConnection(), <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;em-&gt;getConfiguration() ); }</code> </pre> <br><h2>  Import / Export Setup </h2><br>  By default, Sonata exports only simple fields (text, date, numbers).  In order for it to export nested entities, they must be explicitly set in the getExportFields method.  In addition, nested entities need to configure the __toString () method;  The representation of the entity as a string will be exported. <br><br>  ImportBundle also uses this method so that the newly imported file can be loaded into the database without any changes.  In case you re-create the file, then the table with the corresponding column-field is on the import page. <br><br><h2>  Extensibility </h2><br>  I have never liked the fact that in order to change a couple of lines in a bundle, it is necessary to make (not that complicated, but not too comfortable) add-on using <b>easy-extends</b> . <br>  Therefore, all that is possible, I brought to the configs.  Even the class with which the file is parsed.  So, in which case, you can always implement loading and XML and JSON and XLS. <br><br><pre> <code class="hljs pgsql">doctrs_sonata_import: mappings: - { <span class="hljs-type"><span class="hljs-type">name</span></span>: center_point, <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>: promaotlas.form_format.point} - { <span class="hljs-type"><span class="hljs-type">name</span></span>: city_autocomplete, <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>: promoatlas.form_format.city_pa} upload_dir: %kernel.root_dir%/../web/uploads class_loader: Doctrs\SonataImportBundle\Loaders\CsvFileLoader encode: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: utf8 list: - cp1251 - utf8 - koir8</code> </pre> <br>  Read more about all configuration options <a href="https://github.com/Doctrs/SonataImportBundle/wiki/%25D0%259E%25D0%25BF%25D0%25B8%25D1%2581%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5-%25D0%25BF%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BC%25D0%25B5%25D1%2582%25D1%2580%25D0%25BE%25D0%25B2-%25D0%25BA%25D0%25BE%25D0%25BD%25D1%2584%25D0%25B8%25D0%25B3%25D1%2583%25D1%2580%25D0%25B0%25D1%2586%25D0%25B8%25D0%25B8">in the wiki.</a> <br><br><h2>  Custom field types </h2><br>  If you have non-standard fields in the database (for example, in my case, <b>center_point</b> is the coordinates in the database), you must declare a class that will process the data from the file, and bring them to the form in which they will poured into mysql. <br><br>  For example: the type <b>center_point</b> is the coordinate (MySql type is <b>point</b> ).  When added to the database and retrieved from the database, it is an object of the class <b>Point</b> .  The Point object has a __toString method. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ retrun <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;x . <span class="hljs-string"><span class="hljs-string">', '</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;y; }</code> </pre> <br>  It is used to import it, and we get beautiful coordinates in the import file.  If we try to fill the database with the same x, y, then an ORMException is waiting for us.  This is what the <b>mappings</b> array is intended for.  In this case, it simply takes the service with the id <b>doctrs.form_format.point</b> , which implements the <b>Doctrs \ SonataImportBundle \ Service \ ImportAbstract interface</b> , and, based on the obtained value, returns the necessary type, which we can fill in the base. <br><br>  Here is the code of the service itself <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Point</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImportAbstract</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFormatValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($value)</span></span></span></span>{ $value = explode(<span class="hljs-string"><span class="hljs-string">','</span></span>, $value); $point = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \PHPOpenGIS\MainBundle\Geometry\Point($value[<span class="hljs-number"><span class="hljs-number">0</span></span>], $value[<span class="hljs-number"><span class="hljs-number">1</span></span>] ?? <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $point; } }</code> </pre> <br>  Service code <b>doctrs.form_format.city_pa</b> <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CityPa</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImportAbstract</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContainerAwareInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $container; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setContainer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContainerInterface $container = null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;container = $container; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFormatValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($value)</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> ContainerInterface $container */</span></span> $container = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;container; $city = $container-&gt;get(<span class="hljs-string"><span class="hljs-string">'promoatlas.city_autocomplete'</span></span>)-&gt;byName($value); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $city; } }</code> </pre> <br>  As you can see, in the mappings parameter we specify not the names of the classes, but the id of the services, which gives us freedom of action.  For example, for a type conversion of city_autocomplete I needed container. <br><br><h2>  Conclusion </h2><br>  I used this bundle for half a year (at that time it was not yet issued and I just pulled it up with bitbucket).  Of course there were some uncritical errors, but after registering on <a href="https://packagist.org/">packagist.org</a> I try to fix everything so that there are no questions or vague error messages left. <br><br>  There are small plans to improve this bandla, but let's see if they can reach their hands. <br><br>  Any comments and comments will be glad. </div><p>Source: <a href="https://habr.com/ru/post/338986/">https://habr.com/ru/post/338986/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338974/index.html">National roaming in different countries of the world</a></li>
<li><a href="../338978/index.html">How the AI ‚Äã‚Äãsenses system was created in Thief: The Dark Project</a></li>
<li><a href="../338980/index.html">What is known about the attack on the supply chain CCleaner</a></li>
<li><a href="../338982/index.html">More Apple Surprises: Updated Posting Guidelines on the App Store</a></li>
<li><a href="../338984/index.html">Selenium and Node.js: we write reliable browser tests</a></li>
<li><a href="../338988/index.html">What is ERP-Platfoma</a></li>
<li><a href="../338990/index.html">Checklist: how to choose a model of an access rights management system and not miscalculate</a></li>
<li><a href="../338992/index.html">Simulation of the physical world</a></li>
<li><a href="../338994/index.html">404 pages</a></li>
<li><a href="../338996/index.html">‚ÄúWe have a normal UX. Ux? Not before us, we have deadlines here! ‚ÄùRemoving the mantle is my interpretation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>