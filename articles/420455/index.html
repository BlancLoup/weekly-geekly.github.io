<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>[Javawatch Live] The story of one pull request. `os.version` in SubstrateVM</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A year has passed since the previous trick was successful: publish a YouTube clip instead of a post. "Shameful talk about singletons" scored 7k views ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>[Javawatch Live] The story of one pull request. `os.version` in SubstrateVM</h1><div class="post__text post__text-html js-mediator-article">  A year has passed since the previous trick was successful: publish a YouTube clip instead of a post.  <a href="https://habr.com/post/335006/">"Shameful talk about singletons"</a> scored 7k views on YouTube and twice as much on Habr√© itself in the text version.  For an article written in a completely underhanded state and telling about the most ancient bayan - this is something like success. <br><br>  Today I installed a new edition all night.  This time the topic is much more recent: the history of committing to experimental technology - SubstrateVM.  But the degree of upward movement rose to a new level. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/f0nD_8G1uB0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Really looking forward to your comments!  I remind you that if you really want to improve something in this post, then it‚Äôs best to <a href="https://github.com/olegchir/javawatch_channel/issues">file your content on Github</a> .  I would like to say ‚Äúput likes and subscribe <a href="https://www.youtube.com/channel/UCvs4lQd7kinZMBEiSq1e_eg">to a new channel</a> , but after all, all its releases will already be in your Java hub? <br><br>  Technically: there is one glue in the video near the end.  I just wrote an uncompressed video, and my m2 ssd, the size of just five hundred gigabytes, quickly overflowed.  And no other hard disk could not withstand such a pressure data.  So I had to disconnect for half an hour and, having gotten tired of finding an additional fifty gigs to record the last few minutes.  This was achieved by deleting the files <a href="https://habr.com/company/jugru/blog/347024/">collected by GoogleChrome</a> .  Opinion about the recording software wrote in FB <a href="https://www.facebook.com/olegchir/posts/1940728572616807">right at the moment of recording</a> , there is a lot of pain. <br><br>  More from the technically interesting: YouTube for some reason blocked me live streaming.  At the same time on the account there is not a single strike and stigma.  Let's hope it's just a cant, and in 90 days everything will be back. <br><a name="habracut"></a><br><blockquote>  This article will be quotes from code owned by Oracle.  You cannot use this code in your home (unless you read the original license, and it allows it on terms, for example, the GPL).  It is not joke.  Olso, I warned. <br></blockquote><br><h1>  Tip (and the tale will be ahead) </h1><br>  Many have already heard enough stories that ‚Äúnew Java will be written in Java,‚Äù and they wondered how this could be.  There is a program document <a href="http://cr.openjdk.java.net/~jrose/metropolis/Metropolis-Proposal.html">Project Metropolis</a> and the corresponding letter from <a href="http://mail.openjdk.java.net/pipermail/discuss/2017-September/004336.html">John Rose</a> , but everything is rather vague. <br><br>  It sounds like some kind of creepy, bloody magic.  In the same thing you can try right now, not just there is no magic, but everything is stupid like the back of a shovel when you knock out your teeth.  Of course, there are some nuances, but this will someday be very much later. <br><br>  I will show it on the example of one instructive story that happened in the summer.  How is it in schools write an essay "how I spent my summer". <br><br>  To start a small remark.  The project that Ahead-of-Time is currently compiling with Oracle Labs is GraalVM.  The component that actually makes nishtyaki and turns the java code into an executable file (into an executable) is SubstrateVM or SVM for short.  Do not confuse this with the same abbreviation used by data-satanists (support vector machine).  This is about the SVM, as the key part, we'll talk further. <br><br><h1>  Formulation of the problem </h1><br>  So, "how I spent the summer".  I was on vacation, dvucheval F5 on the <a href="https://github.com/oracle/graal">Grail githabe</a> and came across <a href="https://github.com/oracle/graal/issues/557">this ishshshuyu</a> : <br><br><img src="https://habrastorage.org/webt/uy/pg/ig/uypgig4krayn8dmvfzif_rd3em0.png"><br><br>  A person wants <code>os.version</code> give the correct value. <br><br>  Well cho, I wanted to fix the bug?  The boy said - the boy did. <br><br>  We go to check if our patient is lying. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Main</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ System.out.println(System.getProperty(<span class="hljs-string"><span class="hljs-string">"os.version"</span></span>)); } }</code> </pre><br>  At the beginning, what the exhaust looks like on real Java: <code>4.15.0-32-generic</code> .  Yes, this is a fresh Ubuntu LTS Bionic. <br><br>  Now let's try to do the same on the SVM: <br><br><pre> <code class="bash hljs">$ ls Main.java $ javac -cp . Main.java $ ls Main.class Main.java $ native-image Main Build on Server(pid: 18438, port: 35415) classlist: 151.77 ms (<span class="hljs-built_in"><span class="hljs-built_in">cap</span></span>): 1,662.32 ms setup: 1,880.78 ms error: Basic header file missing (&lt;zlib.h&gt;). Make sure libc and zlib headers are available on your system. Error: Processing image build request failed</code> </pre><br>  Well yes.  This is because especially for the ‚Äúclean‚Äù test I made a completely new virtual machine. <br><br><pre> <code class="bash hljs">$ sudo apt-get install zlib1g-dev libc6 libc6-dev $ native-image Main Build on Server(pid: 18438, port: 35415) classlist: 135.17 ms (<span class="hljs-built_in"><span class="hljs-built_in">cap</span></span>): 877.34 ms setup: 1,253.49 ms (typeflow): 4,103.97 ms (objects): 1,441.97 ms (features): 41.74 ms analysis: 5,690.63 ms universe: 252.43 ms (parse): 1,024.49 ms (inline): 819.27 ms (compile): 4,243.15 ms compile: 6,356.02 ms image: 632.29 ms write: 236.99 ms [total]: 14,591.30 ms</code> </pre><br>  Absolute runtime numbers can be terrifying.  But, first of all, this is what was intended: very hellish optimizations are being applied here.  And secondly, it is a sickly virtual machine that you want. <br><br>  And finally, the moment of truth: <br><br><pre> <code class="hljs cs">$ ./main <span class="hljs-literal"><span class="hljs-literal">null</span></span></code> </pre><br>  It seems that our guest did not lie, really does not work. <br><br><h1>  The first approach: theft of properties from the host </h1><br>  Then I searched the global search for <code>os.version</code> and found that all these properties are in the class <code>SystemPropertiesSupport</code> . <br><br>  I will not write the full path to the file, because right in the SVM built the ability to generate the correct projects for IntelliJ IDEA and Eclipse.  This is very cool and does not at all resemble the torment that OpenJDK has to endure.  Let classes for us opens IDE.  So: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SystemPropertiesSupport</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String[] HOSTED_PROPERTIES = { <span class="hljs-string"><span class="hljs-string">"java.version"</span></span>, ImageInfo.PROPERTY_IMAGE_KIND_KEY, <span class="hljs-string"><span class="hljs-string">"line.separator"</span></span>, <span class="hljs-string"><span class="hljs-string">"path.separator"</span></span>, <span class="hljs-string"><span class="hljs-string">"file.separator"</span></span>, <span class="hljs-string"><span class="hljs-string">"os.arch"</span></span>, <span class="hljs-string"><span class="hljs-string">"os.name"</span></span>, <span class="hljs-string"><span class="hljs-string">"file.encoding"</span></span>, <span class="hljs-string"><span class="hljs-string">"sun.jnu.encoding"</span></span>, }; <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre><br>  Then I, completely without including my head, just <a href="https://github.com/oracle/graal/pull/568">went and added</a> another variable to this set: <br><br><pre> <code class="java hljs"><span class="hljs-string"><span class="hljs-string">"os.arch"</span></span>, <span class="hljs-string"><span class="hljs-string">"os.name"</span></span>, <span class="hljs-string"><span class="hljs-string">"os.version"</span></span></code> </pre><br>  I rebuild, I launch, I receive a treasured line <code>4.15.0-32-generic</code> .  Hooray! <br><br>  But here‚Äôs the problem: now, on <em>every</em> machine running this code, it always gives <code>4.15.0-32-generic</code> .  Even where <code>uname -a</code> gives up the previous version of the bucket, on the old Ubunt. <br><br>  It becomes clear that these variables are written to the source file at the time of compilation. <br>  And indeed, you need to carefully read the comments: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** System properties that are taken from the VM hosting the image generator. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String[] HOSTED_PROPERTIES</code> </pre><br>  It is necessary to apply other methods. <br><br><h2>  findings </h2><br><ul><li>  If you want the system property from ‚Äúmain java‚Äù to appear in SVM, this is very easy to do.  We register the desired property in the right place, everything. </li><li>  You can work in an IDE that supports both Java and Python.  For example, in IntelliJ IDEA Ultimate with a Python plugin or the same in Eclipse. </li></ul><br><h1>  Second approach </h1><br>  If you dig into the SystemPropertiesSupport <code>SystemPropertiesSupport</code> , we find a much more reasonable thing: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** System properties that are lazily computed at run time on first access. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Map&lt;String, Supplier&lt;String&gt;&gt; lazyRuntimeValues;</code> </pre><br>  Among other things, the use of these propertey still does not block the build process of the executable.  It is clear that if we cram a lot in <code>HOSTED_PROPERTIES</code> , then everything will slow down. <br><br>  Registration of the lazy properties occurs in an obvious way, by reference to the method that returns: <br><br><pre> <code class="hljs kotlin">lazyRuntimeValues.put(<span class="hljs-string"><span class="hljs-string">"user.name"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::userNameValue); lazyRuntimeValues.put(<span class="hljs-string"><span class="hljs-string">"user.home"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::userHomeValue); lazyRuntimeValues.put(<span class="hljs-string"><span class="hljs-string">"user.dir"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::userDirValue);</code> </pre><br>  And all these links to methods are interface, and the same <code>this::userDirValue</code> is implemented for each of the supported platforms.  In this case, it is <code>PosixSystemPropertiesSupport</code> and <code>WindowsSystemPropertiesSupport</code> . <br><br>  If out of curiosity to go to the implementation for Windows, we will see the sad: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userDirValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"C:\\Users\\somebody"</span></span>; }</code> </pre><br>  As you can see, Windows is not yet supported :-) However, the real problem is that the generation of executables for Windows has not yet been completed, so supporting these methods would actually be completely unnecessary efforts. <br><br>  That is, you need to implement the following method: <br><br><pre> <code class="java hljs">lazyRuntimeValues.put(<span class="hljs-string"><span class="hljs-string">"os.version"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::osVersionValue);</code> </pre><br>  And then support it in two or three available interfaces. <br><br>  But what to write there? <br><br><h2>  findings </h2><br><ul><li>  If you want to add a new property, calculated in runtime, then this is a matter of writing one method.  The result may depend on the current operating system, the switching mechanism is already working and there is no request. </li></ul><br><h1>  Bit of archeology </h1><br>  The first thing that comes to mind is to peek at the implementation in OpenJDK and brazenly copy-paste.  A little archeology and looting will never prevent the brave explorer! <br><br>  Feel free to open any Jav project in the Idea, write <code>System.getProperty("os.version")</code> , and by ctrl + click proceed to the implementation of the <code>getProperty()</code> method.  It turns out that all this is stupid in <code>Properties</code> . <br><br>  It would seem that it is enough to copy the place where these <code>Properties</code> are filled, and, laughing defiantly, to escape into the void.  Unfortunately, we come across a problem: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">native</span></span></span><span class="hljs-function"> Properties </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initProperties</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Properties props)</span></span></span></span>;</code> </pre><br>  Noooooooooooooo. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d4d/ca9/698/d4dca9698ffccaf0de2944194698e857.gif"><br><br>  But it all started well. <br><br><h1>  Was there a boy? </h1><br>  As we know, using C ++ is bad.  Is C ++ used in SVM? <br><br>  And how!  There is even a special package for this: <code>src/com.oracle.svm.native</code> . <br><br>  And in this package, horror-horror, is the file <code>getEnviron.c</code> with something like this: <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> **environ; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> **</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getEnviron</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> environ; }</code> </pre><br><h1>  It's time to smear C ++ </h1><br>  Now we dive a little deeper and open the full OpenJDK sources. <br><br>  If someone does not have them yet, then you can <a href="">look at the web</a> or download.  I warn you, they <a href="http://hg.openjdk.java.net/jdk/jdk">are</a> swinging <a href="http://hg.openjdk.java.net/jdk/jdk">from here</a> , still with the help of Mercurial, and still it will take about half an hour. <br><br>  The file we need is at <code>src/java.base/share/native/libjava/System.c</code> . <br><br>  Notice that this is the path to the file, and not just the name?  That's right, you can shove your new shiny, fashionable Idea, bought for $ 200 a year.  You can <a href="https://www.jetbrains.com/clion/specials/clion/clion.html">try CLion</a> , but in order to avoid irreversible mental damage, it is better to just take the <a href="https://code.visualstudio.com/">Visual Studio Code</a> .  He already highlights something, but still does not understand what he saw (he doesn‚Äôt cross out everything in red). <br><br>  A brief retelling of <code>System.c</code> : <br><br><pre> <code class="hljs lisp">java_props_t *sprops = GetJavaProperties(<span class="hljs-name"><span class="hljs-name">env</span></span>)<span class="hljs-comment"><span class="hljs-comment">; PUTPROP(props, "os.version", sprops-&gt;os_version);</span></span></code> </pre><br>  In turn, they are taken in <code>src/java.base/unix/native/libjava/java_props_md.c</code> . <br>  Each platform has its own such file, they are switched via <code>#define</code> . <br><br>  And here begins.  There are many platforms.  On any kind of necrophilia like AIX, you can score, because GraalVM officially does not support this (as far as I know, GNU-Linux, macOS and Windows are planned first).  GNU / Linux and Windows support the use of <code>&lt;sys/utsname.h&gt;</code> , which has ready-made methods for obtaining the name and version of the operating system. <br><br>  But here in macOS there is a <a href="">creepy piece of shit</a> . <br><br><ul><li>  It has the name "Mac OS X" (although it has long been macOS); </li><li>  It depends on the version of makosi.  Before 10.9 in the SDK there was no <code>operatingSystemVersion</code> function, and you had to read <code>SystemVersion.plist</code> hand; </li><li>  For this subtraction, it uses ObjC extensions something like this: </li></ul><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">// Fallback if running on pre-10.9 Mac OS if (osVersionCStr == NULL) { NSDictionary *version = [NSDictionary dictionaryWithContentsOfFile : @"/System/Library/CoreServices/SystemVersion.plist"]; if (version != NULL) { NSString *nsVerStr = [version objectForKey : @"ProductVersion"]; if (nsVerStr != NULL) { osVersionCStr = strdup([nsVerStr UTF8String]); } } }</span></span></code> </pre><br>  If initially the idea was to rewrite it manually in a good style, then it quickly broke about reality.  And what if I‚Äôm somewhere in the jungle of this noodles jungle, for someone it breaks, and I am hanged in the central square?  Well nafig.  <strong>Need to copy-paste.</strong> <br><br><h2>  findings </h2><br><ul><li>  IDE is not required; </li><li>  Any communication with C ++ is painful, unpleasant, not understood at first glance. </li></ul><br><h1>  Is copy-paste the norm? </h1><br>  This is an important question on which the amount of further torment depended.  I really didn‚Äôt want to rewrite manually, but it was even worse to go to court for violating licenses.  So I went to the githab and asked Codrut Stancu about it directly.  Here is what he <a href="https://github.com/oracle/graal/issues/557">said</a> : <br><br>  <em>¬ªReusing OpenJDK code, for example, copy-paste is a normal thing in terms of licensing.</em>  <em>However, for this you need to have a very good reason.</em>  <em>If the feature can be implemented by reusing the JDK code without copying, for example, patching it with a substitution, it will be much better. "</em> <br><br>  That sounds like official copy-paste permission! <br><br><h1>  Normally communicated ... </h1><br>  I began to transfer this piece of code, but rested on my laziness.  To check the work under macOS of different versions, you need to find at least one with necrofile 10.8 Mountain Lion.  I have two of my apple devices and one of my friend, plus you can deploy to some kind of VMWare trial. <br><br>  But laziness.  And this laziness saved me. <br><br>  I went to <a href="https://gitter.im/graalvm/graal-core">chat</a> and asked Chris Seaton which toolchain is the right one for the build.  What is the supported version of the operating system, C ++ compiler and so on. <br><br>  In response, he received a surprised silence of the chat and Chris's answer that he did not understand the essence of the question. <br><br>  It was dofig time before Chris could understand what I want to do, and asked him <strong>not to do so</strong> . <br><blockquote>  That's really the idea of ‚Äã‚ÄãSVM.  SVM is pure Java, it‚Äôs not a code.  But nobody wants C ++ code from OpenJDK.  That's the last thing we want. <br></blockquote><br>  The example with mathematical libraries did not convince him.  At a minimum, they are written in C, and the inclusion of C ++ would mean the connection of a perfect new language into the code base.  And this, that fufufu. <br><br>  What to do?  Write on <strong>System Java</strong> . <br><br>  And if a call to the C / C ++ Platform SDK cannot be avoided, then it must be some kind of single system call wrapped in a C API.  The data is drawn in Java and then business logic is written strictly in Java, even if the Platform SDK has convenient ready-made ways to do it differently on the C ++ side. <br><br>  I sighed and began to study the source code in order to figure out how this can be done differently. <br><br><h2>  findings </h2><br><ul><li>  <a href="https://gitter.im/graalvm/graal-core">Talk to</a> all the unclear details with the people in the <a href="https://gitter.im/graalvm/graal-core">chat</a> .  They answer if the questions are not completely idiotic.  Although this example shows that Chris is ready to discuss idiotic questions, even if it does not save his time personally; </li><li>  C ++ is not present in the project at all.  There is no reason to believe that someone will let him drag under the hollow; </li><li>  Instead, you need to write to System Java, using C as a last resort (for example, when calling the platform SDK). </li></ul><br><h1>  Fiddler is not needed </h1><br><blockquote>  A fiddler is not needed, dear.  He only eats extra fuel. <br></blockquote><br>  Here I felt some sadness, because look here.  If we have <code>&lt;sys/utsname.h&gt;</code> on Windows, and we stupidly hope for its answer, this is easy and simple. <br><br>  But if it's not there, you have to do what? <br><br><ul><li>  Call cmd builtins or windows utilities?  Issuing text in Russian, which must parse.  This is the bottom, and it may not coincide with the fact that in this place the real OpenJDK will respond. </li><li>  Take from the Registry?  Even here there are nuances, for example, when switching from Windows 7 to 10, the method of storing tsiferok in the Registry has changed, and in Windows 10, you need to either glue the hands of the major and minor components, or simply answer that this is Windows 10 with a single digit.  Which of these methods is more correct (it will not make the users asses their asses) is unclear. </li></ul><br>  Fortunately, my mental anguish was <a href="https://github.com/oracle/graal/commit/4529207aa55cd8a09c95c2be89f9723e55422f2f">interrupted by a pulquest</a> Paul Woegerer, who repaired it all. <br><br>  It is interesting that at first everything was fixed in the wizard ( <code>os.version</code> stopped giving <code>null</code> in the test), and only then I noticed a pullrequest.  The problem is that this commit is not marked as a pullrequest on Github - it is a simple commit with the <code>PullRequest: graal/1885</code> .  The fact is that the dudes in Oracle Labs do not use Github, they need it only to interact with external committers.  All of us who are not fortunate enough to work at Oracle Labs need to subscribe to alerts about new commits to the repository and read them all. <br><br>  But now you can relax and see how to implement this feature <em>correctly</em> . <br><br>  Let's see what this beast is, System Java. <br><br>  As I said earlier, everything is as simple as the back of a spade when they try to knock your teeth out.  And just as painful.  Let's look at a quote from the pool: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">osVersionValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (osVersionValue != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> osVersionValue; } <span class="hljs-comment"><span class="hljs-comment">/* On OSX Java returns the ProductVersion instead of kernel release info. */</span></span> CoreFoundation.CFDictionaryRef dict = CoreFoundation._CFCopyServerVersionDictionary(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dict.isNull()) { dict = CoreFoundation._CFCopySystemVersionDictionary(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dict.isNull()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> osVersionValue = <span class="hljs-string"><span class="hljs-string">"Unknown"</span></span>; } CoreFoundation.CFStringRef dictKeyRef = DarwinCoreFoundationUtils.toCFStringRef(<span class="hljs-string"><span class="hljs-string">"MacOSXProductVersion"</span></span>); CoreFoundation.CFStringRef dictValue = CoreFoundation.CFDictionaryGetValue(dict, dictKeyRef); CoreFoundation.CFRelease(dictKeyRef); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dictValue.isNull()) { dictKeyRef = DarwinCoreFoundationUtils.toCFStringRef(<span class="hljs-string"><span class="hljs-string">"ProductVersion"</span></span>); dictValue = CoreFoundation.CFDictionaryGetValue(dict, dictKeyRef); CoreFoundation.CFRelease(dictKeyRef); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dictValue.isNull()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> osVersionValue = <span class="hljs-string"><span class="hljs-string">"Unknown"</span></span>; } osVersionValue = DarwinCoreFoundationUtils.fromCFStringRef(dictValue); CoreFoundation.CFRelease(dictValue); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> osVersionValue; }</code> </pre><br>  In other words, we write in Java word for word what we would have written in C. <br><br>  Look at how <code>DarwinExecutableName</code> written: <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* Find out how long the executable path is. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> CIntPointer sizePointer = StackValue.get(CIntPointer.class); sizePointer.write(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DarwinDyld._NSGetExecutablePath(WordFactory.nullPointer(), sizePointer) != -<span class="hljs-number"><span class="hljs-number">1</span></span>) { VMError.shouldNotReachHere(<span class="hljs-string"><span class="hljs-string">"DarwinExecutableName.getExecutableName: Executable path length is 0?"</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/* Allocate a correctly-sized buffer and ask again. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] byteBuffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[sizePointer.read()]; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (PinnedObject pinnedBuffer = PinnedObject.create(byteBuffer)) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> CCharPointer bufferPointer = pinnedBuffer.addressOfArrayElement(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DarwinDyld._NSGetExecutablePath(bufferPointer, sizePointer) == -<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* Failure to find executable path. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String executableString = CTypeConversion.toJavaString(bufferPointer); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String result = realpath(executableString); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }</code> </pre><br>  All these <code>CIntPointer</code> , <code>CCharPointer</code> , <code>PinnedObject</code> , what. <br><br>  For my taste, this is inconvenient and ugly.  You need to manually work with pointers that look like Java classes.  It is necessary to call the appropriate <code>release</code> in time so that the memory does not flow away. <br><br>  But if it seems to you that these are <em>unjustified</em> measures, you can again look at the <a href="">implementation of GC in .NET</a> and be terrified, what does C ++ lead to if you don‚Äôt stop in time.  Remember, this is one huge CPP file of more than a megabyte size.  There are <a href="">some descriptions of</a> his work, but they are clearly insufficient for understanding by an external contributor.  The code above, albeit ugly looking, is quite understandable and analyzed by means of static analysis for Java. <br><br>  As for the essence of the commit, I have questions for him.  And at least there is no support for Windows.  When kodgen appears for Windows, I'll try to take on this task. <br><br><h2>  findings </h2><br><ul><li>  It is necessary to write on System Java.  To extol, call sweet bread.  There are no options anyway; </li><li>  Sign up for notifications from the repository on GitHub and read commits, otherwise important PR will fly by; </li><li>  If possible, ask about any big features of those responsible for this area.  There are a lot of things that are implemented, but they are not yet known to the general public.  There is a chance to invent a bicycle, and much more bad, than made by guys from Oracle Labs; </li><li>  When you take on a feature, be sure to tell the person responsible for the github.  If he does not answer - write a letter, the addresses of all team members are easy to google. </li></ul><br><h1>  Epilogue </h1><br>  This battle ends, but not a war at all. <br><br>  Fighter, sensitively wait for new articles on Habr√© and <a href="https://github.com/oracle/graal">fit into our ranks</a> ! <br><br>  I want to remind you that Oleg Shelayev, the only <strong>official</strong> GraalVM evangelist from Oracle, will come to the <a href="https://jokerconf.com/">next Joker conference</a> .  Not just "the only Russian-speaking", but "the only one in general."  The title of the report ( <em><a href="https://jokerconf.com/2018/talks/71se7uhnhi2kygm40qeigm/">‚ÄúCompiling Java ahead-of-time with GraalVM‚Äù</a></em> ) hints that it won't do without SubstrateVM. <br><br>  By the way, Oleg recently issued a service weapon - an account on Habr√©, <a href="https://habr.com/users/shelajev-oleg/" class="user_link">shelajev-oleg</a> .  There are no posts there yet, but you can cast on this username. <br><br>  You can chat with Oleg and Oleg in our chat-room at the Telegram: <a href="https://t.me/graalvm_ru">@graalvm_ru</a> .  Unlike ishshuyov on Gitkhab, you can communicate in any form, and no one will be banned ( <em>but this is not accurate</em> ). <br><br>  Also I remind you that every week we, together with the podcast ‚ÄúDebriefing‚Äù, make an issue of ‚ÄúJava-digest‚Äù.  For example, this was the <a href="https://jug.ru/2018/08/digest-week-70/">last digest</a> .  From time to time, there is also news about GraalVM (in fact, I don‚Äôt turn the whole issue into a GraalVM news release just because of respect for the audience :-) <br><br>  Thank you for reading this - and see you soon! </div><p>Source: <a href="https://habr.com/ru/post/420455/">https://habr.com/ru/post/420455/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../420443/index.html">Cybersecurity experts created a skimmer detector - SkimReaper</a></li>
<li><a href="../420447/index.html">Computer History Museum - the place where IT is logged</a></li>
<li><a href="../420449/index.html">Mask reports on the sale of the company to private investors interested in the US regulator</a></li>
<li><a href="../420451/index.html">Server in the clouds: getting ready to run</a></li>
<li><a href="../420453/index.html">Friday webinars from Skillbox: development and everything about it</a></li>
<li><a href="../420457/index.html">Simplify3D 3D Printing Software Review</a></li>
<li><a href="../420459/index.html">Icon with a counter in the upper toolbar: an example of the diversity of approaches to a single task</a></li>
<li><a href="../420461/index.html">10 quotes bad designers</a></li>
<li><a href="../420463/index.html">ICO is deservedly in a downturn, but they have a chance to change</a></li>
<li><a href="../420465/index.html">Nginx variables with njs: easy, painless and through javascript</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>