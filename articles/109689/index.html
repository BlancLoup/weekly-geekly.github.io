<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reverse engineering obfuscated assembly .NET</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 In this article, I want to share with the respected community my experience of analyzing and modifying the obfuscated .NET assembly usi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reverse engineering obfuscated assembly .NET</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  In this article, I want to share with the respected community my experience of analyzing and modifying the obfuscated .NET assembly using the example of the PokeIn COMET library. <br><br><img src="http://palisade.plynt.com/images/defend-reverse-engineering.jpg" alt="Reverse engineering"><br><br>  A few days ago I became interested in COMET solutions for ASP.NET and found some interesting libraries, among which there was a formerly free PokeIn.  Obviously she enjoyed some popularity, as the authors transferred it from the category of open source to paid.  The library website has the opportunity to download a free version with some limitations, among which, perhaps the most important is the limitation of 10 simultaneous connections.  With him we will fight. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Decompilation </h4><br>  The first tool for reverse engineering and analyzing .NET assemblies is the well-known Reflector.  <a href="http://pokein.com/">We</a> download the free version of the library from the <a href="http://pokein.com/">PokeIn</a> website, look for the assembly for the .NET Framework in the archive and run Reflector.  Here we are waiting for the first disappointment: Reflector refuses to open the assembly at all. <br><br><img src="https://habrastorage.org/storage/habraeffect/f9/3c/f93c143ad0483e8a40fca7ee01626415.png" alt="Reflector Fail"><br><br>  Okay, close Reflector and recall ildasm.exe, a utility from the Windows SDK for decompiling .NET assemblies into MSIL code (Microsoft Intermediate Language).  This will certainly give us a lower-level code and it will not be so convenient to work with it, but, in fact, it is not much more complicated. <br>  So, launch ildasm, open our build ... and again the file: ‚ÄúProtected module - can not disassemble‚Äù. <br><br><img src="https://habrastorage.org/storage/habraeffect/0c/8f/0c8fff85a8ee9fa7d1cbe8820fb95181.png" alt="ILDasm Fail"><br><br>  This means that the assembly is compiled with the SupressIldasmAttribute attribute.  To decompile this assembly, we need to get rid of this attribute.  For this I used a free utility for editing PE files <a href="http://www.ntcore.com/exsuite.php">CFF Explorer</a> .  It has full support for .NET metadata assemblies.  Open our file and look for metadata: '.NET Directory' / 'MetaData Streams' / '# ~' / 'Tables'.  In the table of type references metadata (TypeRef) we find a reference to the SupressIldasmAttribute type and delete it by setting the Name and Namespace fields to 0. <br><br><img src="https://habrastorage.org/storage/habraeffect/2f/d9/2fd9f241bcf590239cfd2cf2113b2438.png" alt="CFF Explorer Win"><br><br>  Now we can open the build in ildasm and view the MSIL code, this is not bad.  But in Reflector, our file still does not open.  To do this, save the MSIL to a file with the command " <i>ildasm.exe pokein.dll / source / out</i> : <i>pokein.il</i> " and reassemble the assembly using the ilasm utility, which is included in the .NET Framework <i>distribution</i> : " <i>ilasm.exe pokein.il / dll /out:pokein.dll</i> ".  Unfortunately, the benefits of this are few, since most obfuscated methods will still be unavailable, and the list of classes / fields / methods can be viewed in the Object Browser. <br><br><h4>  Code analysis </h4><br>  Let's start analyzing the code.  The meager documentation and example from the archive make it possible to understand that the main work takes place in the static class PokeIn.Comet.CometWorker.  In a more detailed study of it, we find the static property ActiveClientCount, the name of which hints that it can be used when checking the limit on the number of clients, as well as several overloaded Bind methods that are obviously caused when a new client is connected. <br>  We continue to work with the il-file.  When searching by the ActiveClientCount string, we find several invocations of the following property: <br><br> <code>IL_0007: call int32 PokeIn.Comet.CometWorker::get_ActiveClientCount() <br> IL_000c: ldc.i4.s 10 <br> IL_000e: ble IL_0027</code> <br> <br>  Let us analyze this code line by line: <br>  IL_0007: calls the getter of the ActiveClientCount property and pushes the result onto the stack. <br>  IL_000c: pushes 10 onto the stack. <br>  IL_000e: if the first operand from the stack is less than or equal to the second, go to IL_0027 <br><br>  Tellingly, these calls are in the Bind and DynamicBind methods, which indicates that we are on the right track. <br><br><h4>  MSIL Debugging </h4><br>  The next step is optional, but I‚Äôm always interested to see how it works live, so we‚Äôll try to run the build in debug mode. <br>  Stop, we don‚Äôt have any source code, since Reflector didn‚Äôt cope with decompilation, or debug information? <br>  That's right, but there are several ways to debug MSIL code directly.  I‚Äôm used to debugging Visual Studio, so I‚Äôll tell you about this method. <br>  To generate debug information, we rebuild the library with the / debug key: " <i>ilasm.exe pokein.il / dll / debug /out:pokein.dll</i> ".  A debugging pdb will also appear in the folder with the dll file.  In the test project, we replace the link from the original pokein.dll with a new one, and set the breakpoints directly in the il file on get_ActiveClientCount () calls.  To emulate several clients, simply open the test page in several tabs in the browser.  When opening each new tab, we will have a breakpoint in one of the Bind () methods.  When the tab becomes over 10, we will get on the javascript alert page with the information that we have exceeded the maximum number of simultaneous connections. <br><br><h4>  MSIL Modification </h4><br>  Now we need to remove the limit on 10 simultaneous connections.  Open the il file and go to the verification code.  The first line (in the example - IL_0007) is left unchanged.  As we remember, calling the property will put the result on the stack, so we need to pick it up from there - replace <br> <code>IL_000c: ldc.i4.s 10</code> <br>  on <br> <code>IL_000c: pop</code> <br>  Now replace the conditional transition <br> <code>IL_000e: ble IL_0027</code> <br>  on unconditional <br> <code>IL_000d: br IL_0027</code> <br> <br>  In fact, the call to ActiveClientCount can also be removed.  I leave it to you as a homework. <br>  We repeat this operation in all the places where connections are checked, we assemble the il file back with the ilasm utility, update the link in the test project, check that there are no more restrictions, no alerts appear, the task is completed. <br><br>  In the free version of this library there are some other limitations that can be eliminated in the same way. <br><br>  This article is written for educational purposes, and is not a call or instructions for hacking paid programs. <br>  I hope you liked it, and you learned something new for yourself. </div><p>Source: <a href="https://habr.com/ru/post/109689/">https://habr.com/ru/post/109689/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../109675/index.html">The reference book of the architect for the software project - "Basics of Religious Studies"</a></li>
<li><a href="../109677/index.html">Network services monitoring and ping</a></li>
<li><a href="../109678/index.html">Sponsored accounts: the ability to get premium Evernote subscriptions for groups of any size</a></li>
<li><a href="../109683/index.html">Instead of singing a song about me ... about the domain!</a></li>
<li><a href="../109685/index.html">Small ProLiant (Just Right Home Server)</a></li>
<li><a href="../109690/index.html">1st Startup Point in Krasnodar and Omsk</a></li>
<li><a href="../109691/index.html">Perl Workshop "Saint Perl - 2" in St. Petersburg, December 18</a></li>
<li><a href="../109692/index.html">Human Jukebox - a man like an audio system</a></li>
<li><a href="../109700/index.html">OpenID, OAuth and other buns</a></li>
<li><a href="../109703/index.html">Java Mobile Agent - now with Jabber</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>