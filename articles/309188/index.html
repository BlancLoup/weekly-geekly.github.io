<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Security Monitoring with Sysdig Falco</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O Sysdig ‚Äî a tool for kernel tracing ‚Äî we told you two years ago . More recently, in May of this year, the developers of Sysdig presented another inte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Security Monitoring with Sysdig Falco</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/5a6/5a3/f7c/5a65a3f7c77de0ae2fabc6c5451f27b8.png" alt="Sysdig falco" width="100%" height="100%"><br><br>  O <a href="http://www.sysdig.org/" rel="nofollow">Sysdig ‚Äî a</a> tool for kernel tracing ‚Äî we <a href="https://habrahabr.ru/company/selectel/blog/222839/">told you two years ago</a> .  More recently, in May of this year, the developers of Sysdig presented another interesting product: the <a href="http://www.sysdig.org/falco/" rel="nofollow">Falco</a> Anomaly Detection System. <br><a name="habracut"></a><br>  Falco consists of two main components: the sysdig_probe kernel module (on the basis of which Sysdig also runs) and the daemon that writes the collected information to disk. <br><br>  Based on user-defined rules, Falco monitors the operation of applications and, when an anomaly is detected, writes information to a standard output, syslog, or user-specified file.  Developers <a href="https://sysdig.com/blog/sysdig-falco/" rel="nofollow">in their blog</a> jokingly call Falco "a hybrid of snort, ossec and strace" and position it as a simple IDS, which almost does not create a load on the system. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We would briefly describe Sysdig Falco in a slightly different way: it is an advanced auditing tool.  It can track the same events as the <a href="https://habrahabr.ru/company/selectel/blog/267833/">Linux audit subsystem</a> ‚Äî but not only.  This is not a complete list: <br><br><ul><li>  running a shell inside a container; </li><li>  writing to the / dev directory of files that have nothing to do with devices (for example, some rootkits do this); </li><li>  unusual application-initiated network connections; </li><li>  attempts to change files in critical directories ‚Äî for example, / etc / passwd; </li><li>  atypical events in the work of individual applications. </li></ul><br>  Falco by itself does not provide any protection, but only collects information about system events that meet specified conditions.  Based on this information, certain conclusions can be drawn and, if necessary, additional measures can be taken. <br><br><h2>  Installation </h2><br>  Before installing Falco, you need to add the corresponding repository (hereinafter all examples of commands are given for Ubuntu 16.04 OS): <br><br><pre><code class="bash hljs">$ curl -s https://s3.amazonaws.com/download.draios.com/DRAIOS-GPG-KEY.public | apt-key add - $ curl -s -o /etc/apt/sources.list.d/draios.list http://download.draios.com/stable/deb/draios.list $ sudo apt-get update</code> </pre> <br>  We also need to install the kernel headers: <br><br><pre> <code class="bash hljs">$ sudo apt-get -y install linux-headers-$(uname -r)</code> </pre><br>  After that, install Falco and add the sysdig_probe module to the kernel: <br><br><pre> <code class="bash hljs">$ sudo apt-get -y install falco $ modprobe sysdig-probe</code> </pre><br>  This completes the installation.  After that, Falco can be run: <br><br><pre> <code class="bash hljs">$ sudo service falco start</code> </pre><br>  Information about all detected events will be recorded in the syslog.  You can also run Falco online: <br><br><pre> <code class="bash hljs">$ falco</code> </pre><br>  All information about suspicious events will immediately be recorded in the standard output. <br>  The default settings and rules will be more than enough to get started. <br>  The file / etc/falco_rules.yaml already prescribed rules for all occasions.  There are even ready-made rules for a variety of applications and services: MySQL, MongoDB, CouchDB, Fluentd, Elasticsearch, and others. <br><br>  If necessary, you can always change existing rules and even add new ones.  Consider the structure of the Falco configuration files in more detail. <br><br><h2>  Basic settings </h2><br>  Falco's basic settings are stored in the /etc/falco.yaml file.  By default, it looks like this: <br><br><pre> <code class="hljs pgsql"># File containing Falco rules, loaded at startup. rules_file: /etc/falco_rules.yaml # Whether <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> output events <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-type"><span class="hljs-type">json</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-type"><span class="hljs-type">text</span></span> json_output: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> # Send information logs <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> stderr <span class="hljs-keyword"><span class="hljs-keyword">and</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">or</span></span> syslog Note these are *<span class="hljs-keyword"><span class="hljs-keyword">not</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">security</span></span> # notification logs! These are just Falco lifecycle (<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> possibly error) logs. log_stderr: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> log_syslog: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">Where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">security</span></span> notifications should go. # Multiple outputs can be enabled. syslog_output: enabled: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> file_output: enabled: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> filename: ./events.txt stdout_output: enabled: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> program_output: enabled: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> program: mail -s "Falco Notification" someone@example.com</code> </pre><br>  As you can see, here it is indicated in which file the rule is stored, in which format the output should be presented (plain text or json) and where the information about the detected anomalies should be recorded.  Falco can write messages to standard output, to syslog, as well as to a user-specified text file. <br><br><h2>  Rules and their syntax </h2><br>  The /etc/falco_rules.yaml file contains rules that indicate which particular features in the behavior of the Falco Sysdig system should pay special attention.  Here is a fragment of this file: <br><br><pre> <code class="hljs pgsql"> - <span class="hljs-keyword"><span class="hljs-keyword">rule</span></span>: write_etc <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>: an attempt <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> file below /etc, <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> a pipe installer <span class="hljs-keyword"><span class="hljs-keyword">session</span></span> condition: write_etc_common <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> proc.sname=fbash output: "File below /etc opened for writing (user=%user.name command=%proc.cmdline file=%fd.name)" priority: <span class="hljs-built_in"><span class="hljs-built_in">WARNING</span></span></code> </pre><br>  Everything is simple and understandable here: the rule indicates that Falco should inform about any attempt to open any file in the / etc directory for writing (except when files in / etc are created when installing programs. <br><br>  Each rule consists of the following fields: <br><br><ul><li>  desc - description of the rule in any form; </li><li>  condition is the condition under which the rule is triggered (the standard Sysdig syntax is used for writing conditions; see the <a href="http://www.sysdig.org/wiki/sysdig-user-guide/" rel="nofollow">official documentation</a> for more details <a href="http://www.sysdig.org/wiki/sysdig-user-guide/" rel="nofollow">)</a> , as well as <a href="https://blog.selectel.ru/sysdig-instrument-dlya-diagnostiki-linux-sistem/">in our article</a> ); </li><li>  output - the output that will be displayed when the rule is triggered; </li><li>  prioriry - priority (INFO, WARNING, ALERT, DEBUG, CRITICAL). </li></ul><br>  Let's see how this rule works.  Launch Falco in live monitoring mode: <br><br><pre> <code class="bash hljs">$ falco</code> </pre><br>  In another terminal, try opening a file in the / etc directory.  We will see that messages like the following will immediately fall into the standard output: <br><br><pre> <code class="bash hljs">12:43:52.640375428: Warning File below /etc opened <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> writing (user=useri <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=nano /etc/default/grub file=/etc/default/.grub.swp) 12:43:52.640973730: Warning File below /etc opened <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> writing (user=useri <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=nano /etc/default/grub file=/etc/default/grub)</code> </pre><br>  If we stop Falco by pressing Ctrl + C, a brief summary of all detected events will be displayed on the console: <br><br><pre> <code class="bash hljs">Events detected: 2 Rule counts by severity: Error: 0 Warning: 2 Informational: 0 Triggered rules by rule name: write_etc: 2</code> </pre><br>  Consider another example and show how Falco can be used to audit system events in containers. <br><br><h2>  Watching the container </h2><br>  Falco Sysdig is well suited for monitoring what happens inside containers.  Let's see how it works. <br><br>  Create a Docker container: <br><br><pre> <code class="bash hljs">$ docker pull:ubuntu 14.04</code> </pre><br>  After that, add an additional rule to /etc/falco_rules.yaml (an example is taken <a href="https://komunity.komand.com/learn/featured/introduction-to-sysdig-falco/" rel="nofollow">from here</a> ): <br><br><pre> <code class="bash hljs">- rule: system_binaries_network_activity_container desc: any network activity performed by system binaries that are not expected to send or receive any network traffic <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> a container condition: ((inbound or outbound) and (fd.sockfamily = ip)) and fd.name != <span class="hljs-string"><span class="hljs-string">''</span></span> and container output: <span class="hljs-string"><span class="hljs-string">"Suspicious binary sent/received network traffic from container=%container.id (user=%user.name command=%proc.cmdlin e connection=%fd.name type=%evt.type)"</span></span> priority: WARNING</code> </pre><br>  Save the changes and restart Falco.  After that we enter the container: <br><br><pre> <code class="bash hljs">$ docker run --rm -it ubuntu:14.04 /bin/bash</code> </pre><br>  We will execute the following command in the container: <br><br><pre> <code class="bash hljs">$ ping ya.ru</code> </pre><br>  The following messages appear on the main host in syslog: <br><br><pre> <code class="bash hljs">16:08:56.944164593: Warning Suspicious binary sent/received network traffic from container=0b86d8efdf0a (user=root <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ping ya.ru connection=172.17.0.2:47776-&gt;123.45.67.89:53 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=connect) 16:08:56.945398068: Warning Suspicious binary sent/received network traffic from container=0b86d8efdf0a (user=root <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ping ya.ru connection=172.17.0.2:38643-&gt;123.45.67.89:1025 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=connect)</code> </pre><br>  They contain the container id, the user name and the command that resulted in the network connection being initiated. <br><br><h2>  Conclusion </h2><br>  Sysdig Falco is an interesting and promising tool.  It has the same advantages as Sysdig: flexibility, convenient syntax of rules, comprehensible form of conclusions.  With it, you can get a lot of valuable information about the system, which is impossible to obtain using other tools. <br>  If you already use Falco in practice, we invite you to share your experience in the comments. <br><br>  In conclusion, we present a selection of useful links for those who want to learn more: <br><br><ul><li>  <a href="https://github.com/draios/falco" rel="nofollow">https://github.com/draios/falco</a> - Falco official repository on GitHub; </li><li>  <a href="https://github.com/draios/falco/wiki" rel="nofollow">https://github.com/draios/falco/wiki</a> - Falco official documentation; </li><li>  <a href="https://sysdig.com/blog/tag/falco/" rel="nofollow">https://sysdig.com/blog/tag/falco/</a> - a series of articles about Falco in the Draios blog; </li><li>  <a href="https://www.youtube.com/watch%3Fv%3Dflcu2Mz9bpo" rel="nofollow">https://www.youtube.com/watch?v=flcu2Mz9bpo</a> - a review lecture on Sysdig Falco. </li></ul><br>  If for one reason or another you cannot leave comments here - welcome to <a href="https://blog.selectel.ru/monitoring-bezopasnosti-s-sysdig-falco/">our corporate blog</a> . </div><p>Source: <a href="https://habr.com/ru/post/309188/">https://habr.com/ru/post/309188/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309174/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ226 (August 29 - September 4, 2016)</a></li>
<li><a href="../309176/index.html">PHPixie vs Laravel</a></li>
<li><a href="../309180/index.html">Digest of grocery design, August 2016</a></li>
<li><a href="../309182/index.html">Graphic models based on Gaussian copulas</a></li>
<li><a href="../309184/index.html">Automatic change of product types in Magento 2</a></li>
<li><a href="../309190/index.html">3D Microservice Scaling</a></li>
<li><a href="../309192/index.html">New leak: 43 million accounts Last.Fm published online</a></li>
<li><a href="../309194/index.html">The game of digital wallets: the era of the Cold War between the West and the East</a></li>
<li><a href="../309196/index.html">Discussion of analytics tools for working with big data in St. Petersburg on September 14</a></li>
<li><a href="../309200/index.html">Android: a retractable bottom screen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>