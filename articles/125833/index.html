<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Page Visibility API and Visibility.js</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Page Visibility API is a new API in JavaScript that allows you to find out if a user sees your site or, for example, has opened another tab. 

 How ca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Page Visibility API and Visibility.js</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/597/1ad/fb4/5971adfb4b87c628becfafc5199970b1.jpg" alt="Shroedinger`s cat"><br><br>  Page Visibility API is a new API in JavaScript that allows you to find out if a user sees your site or, for example, has opened another tab. <br><br>  How can this API make our web friendlier and more comfortable?  Well, the most obvious: <br><ul><li>  <b>To make the site more user-friendly</b> , "raise usability."  For example, turn off the slideshow or pause the video when you switch to another tab (for example, you watch the video on YouTube and you receive an urgent email). </li><li>  <b>Do not consume extra resources.</b>  Turn off the excess logic when it is not needed, because the user does not see the site.  For example, in the background tab, disable complex JS calculations or less frequently check for new AJAX messages. </li><li>  <b>Read more accurate statistics.</b>  For example, do not count users who opened your site in a new tab and closed it without viewing. </li><li>  <b>Maintain a new <a href="http://blog.chromium.org/2011/06/prerendering-in-chrome.html">pre-rendering</a> technology from Google Chrome</b> when the browser pre-loads and renders the specified page to open it instantly.  For example, in a Google search, the first issue will be marked for prerending. </li><li>  Make the Schr√∂dinger Cat emulator (in the illustration), which will display a live or dead cat only when the user opens the tab loaded in the background. </li></ul><br>  To make working with Page Visibility API more convenient, I (to the glory of <a href="http://evilmartians.ru/">Evil Martians</a> ) developed the <a href="">Visibility.js</a> library.  It allows you to forget about vendor prefixes and adds ‚Äúsugar‚Äù of high-level functions to write short clean code (for example, <code>Visibility.every</code> is an analogue of <code>setInterval</code> , but only works if the site is in an open tab). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="http://www.samdutton.com/pageVisibility/">A nice example of a video player</a> that stops a video when a page becomes invisible (open in Google Chrome 13). <br><a name="habracut"></a><br><h4>  Browser support </h4><br>  Page Visibility API is now supported in Google Chrome 13 and IE 10. For Firefox 5 and above, there is a <a href="https://github.com/private-face/mozvisibility">MozVisibility</a> hack from private_face that emulates the Page Visibilty API (this hack must be enabled in the page before Visibility.js). <br><br>  There is already a <a href="http://www.w3.org/TR/2011/WD-page-visibility-20110602/">draft</a> of the W3C <a href="http://www.w3.org/TR/2011/WD-page-visibility-20110602/">Page Visibility API</a> standard, so support in other browsers is a matter of time. <br><br>  But it‚Äôs not at all necessary that the browsers of all your users support this API ‚Äî it‚Äôs just an improvement, not a new feature added, like the <code>&lt;video&gt;</code> .  If there is support, it will be more convenient for the user; if not, the site will work like regular sites and think that the user always sees the site.  High-level functions in Visibility.js are specifically made so that the developer can not think about whether there is support for the API or not. <br><br><h4>  States </h4><br>  Now there are 4 possible states of visibility of the page in the standard: <br><ul><li>  <code>visible</code> - the user now sees the page. </li><li>  <code>hidden</code> - the page is not visible to the user, since another tab is open in the browser, the browser window is minimized or the OS has completely blocked the screen.  The truth is, in reality, Chrome only checks whether the current tab is open or not; minimizing the browser has no effect. </li><li>  <code>prerender</code> - the browser loaded and rendered the page in advance, to show it to the user instantly.  That is, now the user does not see the page, unnecessary calculations and multimedia should be removed, and in statistics this view is not yet considered.  All technology is supported only in Google Chrome, although it already exists in the standard. </li><li>  <code>preview</code> - the site is open in a small preview window.  For example, in the mozayka of frequently opened sites in the new tab.  The theoretical property of the standard, since it is not supported by any browser. </li></ul><br>  And what will happen when another state is added to the standard, and you will need to check whether the site is visible to the user or not.  To do this, there is a <code>document.hidden</code> property (don't forget about vendor prefixes, in Chrome it will be <code>document.webkitHidden</code> ) or the <code>Visibility.hidden()</code> method in Visibility.js.  If you need to check whether the site is visible - use this property, and not compare the name of the state with <code>"hidden"</code> . <br><br><h4>  Visibility.js </h4><br>  In order not to be intimidated by low-level code with a bunch of checks for vendor prefixes, I will show you how to work with the Page Visibility API right away using Visibility.js as an example, and at the end of the article I will talk about low-level API methods. <br><br>  The library code is completely covered with modular <a href="">tests</a> , is documented and the library is already being successfully used in <a href="http://groupon.ru/">Russian Group</a> .  In the compressed version, it only weighs 1 KB, but it saves you a lot of extra code. <br><br><h5>  Visibility.every </h5><br>  <code>Visibility.every(interval, callback)</code> is an analogue of <code>setInterval(callback, interval)</code> , but starts the <code>callback</code> only if the user now sees the page. <br><br>  For example, we will show the animation of the countdown only when the user sees the page: <br><pre> <code class="hljs matlab">Visibility.every(<span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateCountdownAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; });</span></span></code> </pre><br><br>  <code>Visibility.every(visible, hidden, callback)</code> can take 2 time intervals - <code>visible</code> will use when the page is visible to the user, and <code>hidden</code> - when hidden. <br><br>  For example, you can check new messages every minute when a user has opened a site (that is, it is important to him).  And when the user does not see the site (reads another page) we will save his traffic and check mail every 5 minutes: <br><pre> <code class="hljs matlab">var minute = <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>; Visibility.every(minute, <span class="hljs-number"><span class="hljs-number">5</span></span> * minute, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkForEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; });</span></span></code> </pre><br><br>  But in general, to indicate the time in milliseconds is a mockery of a person.  Therefore, Visibility.js supports integration with the <a href="https://github.com/avk/jQuery-Chrono">jQuery Chrono plugin</a> (you just need to connect it before Visibility.js).  The code becomes clear and sweet candied: <br><pre> <code class="hljs matlab">Visibility.every(<span class="hljs-string"><span class="hljs-string">'minute'</span></span>, <span class="hljs-string"><span class="hljs-string">'5 minutes'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkNewMails</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; });</span></span></code> </pre><br><br>  To stop a timer started using <code>Visibility.every</code> , use <code>Visibility.stop(timerID)</code> ( <code>clearInterval</code> will not work): <br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> slideshow = Visibility.every(<span class="hljs-number"><span class="hljs-number">5</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ nextSlide(); }); $(<span class="hljs-string"><span class="hljs-string">'.stopSlideshow'</span></span>).click(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ Visibility.stop(slideshow); });</code> </pre><br><br>  If the browser does not support the Page Visibility API, then <code>Visibility.every</code> will assume that the user always sees the site (that is, it becomes a complete analog of <code>setInterval</code> , but nothing terrible happens). <br><br><h5>  Visibility.onVisible </h5><br>  Another standard situation is when we wait until the user sees the site (for example, because he opened the link in the background tab).  For this, there is a <code>Visibility.onVisible(callback)</code> method that executes the code only when the page becomes visible.  If the page is already visible, the <code>callback</code> called right away. <br><br>  For example, when visiting websites we show some kind of notification and after 10 seconds we hide it beautifully.  But if the user opens the site immediately in the background tab, he can skip the notification.  Let's then count down 10 seconds after the user actually sees the site: <br><pre> <code class="hljs actionscript">Visibility.onVisible(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Notification.hide(); }, <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>); });</code> </pre><br><br>  If the browser does not support the Page Visibility API, then the <code>Visibility.onVisible(callback)</code> will trigger a <code>callback</code> right away. <br><br><h5>  Visibility.afterPrerendering </h5><br>  Firefox has <code><a href="https://developer.mozilla.org/en/Link_prefetching_FAQ"></a> rel="prefetch"</code>  <code><a href="https://developer.mozilla.org/en/Link_prefetching_FAQ"></a> rel="prefetch"</code> for links, which tells the browser that the user is likely to open the link later, so the browser loads its contents in advance.  This is necessary, for example, to download the next chapter of the article or for the first result in search results. <br><br>  Google chrome went ahead and did <code><a href="http://code.google.com/chrome/whitepapers/prerender.html"></a> rel="prerender"</code>  <code><a href="http://code.google.com/chrome/whitepapers/prerender.html"></a> rel="prerender"</code> - it not only loads, but also renders the page in advance to open it instantly ( <a href="http://www.youtube.com/watch%3Fv%3D_Jn93FDx9oI">video</a> example from Google). <br><br>  However, there are many limitations when the page will not be displayed.  It is forbidden to make AJAX requests, place audio or video, open pop-ups, carry out heavy calculations.  Plus, it is advisable not to consider the user in the statistics of visits until he really opens the site. <br><br>  For all these tasks, there is a <code>Visibility.afterPrerendering(callback)</code> , which will perform a <code>callback</code> only when the page opens for real (that is, leaves the state of pre-rendering) or performs a <code>callback</code> immediately, if the page was immediately opened normally.  In the <code>callback</code> you can enable auto-update via AJAX, add it to the <code>&lt;video&gt;</code> page and count the user in the statistics. <br><br><pre> <code class="hljs matlab">Visibility.afterPrerendering(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Statistics</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">countVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; });</span></span></code> </pre><br><br>  If the browser does not support the Page Visibility API or pre-rendering, then <code>Visibility.afterPrerendering(callback)</code> will trigger the <code>callback</code> immediately. <br><br><h5>  Low-level functions </h5><br>  If you want to understand on the basis of what all the ‚Äúsugar‚Äù from the examples above works, or you can do something more complicated, then you will need low-level Visibility.js functions.  I'll show you how the Page Visibility API works. <br><br>  <code>Visibility.isSupported()</code> returns <code>true</code> if the browser supports Page Visibility API.  The browser does not support Page Visibility API, you can easily find out - it will have <code>document.hidden</code> <code>undefined</code> , not <code>true</code> or <code>false</code> (just do not forget about the vendor prefix, for example, <code>document.webkitHidden</code> ). <br><br>  <code>Visibility.state()</code> returns the state name ( <code>"visible"</code> , <code>"hidden"</code> or <code>"prerenderer"</code> ).  This method simply looks at the <code>document.visibilityState</code> property, taking into account the vendor prefix (for example, <code>document.webkitVisibilityState</code> ).  A small example to fix: <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( Visibility.isSupported() ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-string"><span class="hljs-string">'hidden'</span></span> == Visibility.state() ) { <span class="hljs-keyword"><span class="hljs-keyword">Statistics</span></span>.userOpenPageInBackgroundTab(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-string"><span class="hljs-string">'prerender'</span></span> == Visibility.state() ) { <span class="hljs-keyword"><span class="hljs-keyword">Statistics</span></span>.pageIsPrerendering(); } })</code> </pre><br><br>  If you just need to check whether the user sees the page or not, then it is better to use <code>Visibility.hidden()</code> (since the list of states can be replenished in the future).  She just looks at the <code>document.hidden</code> property.  The following example includes autoplaying video only if the page is opened immediately in the active tab (and not in the new background): <br><pre> <code class="hljs javascript">$(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>).load(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !Visibility.hidden() ) { VideoPlayer.play(); } });</code> </pre><br><br>  To monitor the page state change, the <code>document</code> has a <code>visibilitychange</code> event (in Chrome, <code>webkitvisibilitychange</code> ).  In Visibility.js there is a shorter way - the method <code>Visibility.change(callback)</code> itself hangs up the event handler and calls a <code>callback</code> every time the page visibility changes.  The first argument to the <code>callback</code> is the event object, and the second is the name of the state.  Example: <br><pre> <code class="hljs matlab">Visibility.change(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e, state)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Statistics</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackChangeVisibility</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(state)</span></span></span><span class="hljs-function">; });</span></span></code> </pre><br><br><h5>  Installation </h5><br><ul><li>  If you use Ruby on Rails 3.1, the easiest is for you.  Connect the <code>visibilityjs</code> gems in the gemfile: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">gem</span></span> <span class="hljs-string"><span class="hljs-string">'visibilityjs'</span></span></code> </pre> <br>  and connect the library to <code>app/assets/javascripts/application.js.coffee</code> : <br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#= require visibility</span></span></code> </pre> <br></li><li>  If you are using some kind of static collector, for example, <a href="http://documentcloud.github.com/jammit/">Jammit</a> , then download <a href="">lib / visibility.js</a> to your project‚Äôs <code>public/javascripts/lib</code> and <code>config/assets.yml</code> Visibility.js in the package settings in <code>config/assets.yml</code> : <br><pre> <code class="hljs swift">javascripts: application: - <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>/javascripts/lib/visibility.js</code> </pre></li><li>  If for some reason you do not think about client optimization and do not merge all the JS-files of the project for subsequent compression, then you can download the already compressed version of Visibility.js - <a href="">visibility.min.js</a> . </li></ul><br><h4>  Links </h4><br><ul><li>  <a href="http://code.google.com/chrome/whitepapers/pagevisibility.html">Good description of Google's Page Visibility API</a> </li><li>  <a href="http://www.w3.org/TR/2011/WD-page-visibility-20110602/">Draft specification from W3C</a> </li><li>  <a href="">Visibility.js library to make working with Page Visibility API easy and enjoyable</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/125833/">https://habr.com/ru/post/125833/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../125826/index.html">Several major US Internet service providers made money on customer search queries.</a></li>
<li><a href="../125828/index.html">Introduction to Storage Systems</a></li>
<li><a href="../125829/index.html">Experience in building an assembly and testing management system</a></li>
<li><a href="../125831/index.html">A new interface has appeared in Google Docs.</a></li>
<li><a href="../125832/index.html">HTML5 Audio Visualization</a></li>
<li><a href="../125835/index.html">QNX RTOS: Flow Planning</a></li>
<li><a href="../125836/index.html">Quick change of network settings</a></li>
<li><a href="../125839/index.html">Through what hole hacked the site?</a></li>
<li><a href="../125841/index.html">9 useful applications for amateurs</a></li>
<li><a href="../125845/index.html">Qt for Android (Necessitas Framework) - does it really work?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>