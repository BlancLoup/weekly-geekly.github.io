<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>An example of creating a Makefile for Go applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this tutorial, we‚Äôll look at how a Go developer can use a Makefile to develop their own applications. 



 What are Makefiles? 
 Makefile is an inc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>An example of creating a Makefile for Go applications</h1><div class="post__text post__text-html js-mediator-article">  <i><b>In this tutorial, we‚Äôll look at how a Go developer can use a Makefile to develop their own applications.</b></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cb0/edd/88b/cb0edd88b4d9c23bb66277e0a8207518.gif" alt="image"><br><br><h3>  What are Makefiles? </h3><br>  Makefile is an incredibly useful automation tool that you can use to run and build applications not only on Go, but also in most other programming languages. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It can often be seen in the root directory of many Go apps on Github and Gitlab.  It is widely used as a tool for automating tasks that often accompany developers. <br><br>  If you use Go to create web services, then the Makefile will help solve the following problems: <br><br><ul><li>  Automation of calling simple commands, such as: compile, start, stop, watch, etc. </li><li>  Manage project-specific environment variables.  It should include the .env file. </li><li>  A development mode that automatically compiles upon change. </li><li>  A development mode that shows compilation errors. </li><li>  Defining GOPATH for a specific project so that we can store dependencies in the vendor folder. </li><li>  Simplified file monitoring, for example, make watch run = ‚Äúgo test.  / ... " </li></ul><a name="habracut"></a><br>  Here is a typical directory structure for a project: <br><br><pre><code class="bash hljs">.env Makefile main.go bin/ src/ vendor/</code> </pre> <br>  If we call the make command in this directory, we get the following output: <br><br><pre> <code class="bash hljs">$ make Choose a <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> run <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> my-web-server: install Install missing dependencies. Runs `go get` internally. start Start <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> development mode. Auto-starts when code changes. stop Stop development mode. compile Compile the binary. watch Run given <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> when code changes. eg; make watch run=<span class="hljs-string"><span class="hljs-string">"go test ./..."</span></span> <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> Run given <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>, wrapped with custom GOPATH. eg; make <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> run=<span class="hljs-string"><span class="hljs-string">"go test ./..."</span></span> clean Clean build files. Runs `go clean` internally.</code> </pre> <br><h3>  Environment variables </h3><br>  The first thing we want from the Makefile is to include the environment variables that we defined for the project.  Therefore, the first line will look like this: <br><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">include</span></span> .env</code> </pre> <br>  Next, we define the project name, Go folders / files, paths to pid ... <br><br><pre> <code class="cmake hljs">PROJECTNAME=$(shell basename <span class="hljs-string"><span class="hljs-string">"$(PWD)"</span></span>) <span class="hljs-comment"><span class="hljs-comment"># Go . GOBASE=$(shell pwd) GOPATH=$(GOBASE)/vendor:$(GOBASE):/home/azer/code/golang #       . GOBIN=$(GOBASE)/bin GOFILES=$(wildcard *.go) #     ,       . STDERR=/tmp/.$(PROJECTNAME)-stderr.txt # PID-    ,       PID=/tmp/.$(PROJECTNAME)-api-server.pid # Make     Linux.   silent. MAKEFLAGS += --silent</span></span></code> </pre> <br>  In the remainder of the Makefile, we will often use the GOPATH variable.  All our teams must be associated with the GOPATH of a specific project, otherwise they will not work.  This provides a clean isolation of our projects, but at the same time complicates the work.  To simplify the task, we can add an exec command that will execute any command with our GOPATH. <br><br><pre> <code class="cmake hljs"><span class="hljs-comment"><span class="hljs-comment"># exec:     GOPATH. : make exec run = " go test ./...‚Äù exec: @GOPATH=$(GOPATH) GOBIN=$(GOBIN) $(run)</span></span></code> </pre> <br>  However, it is worth remembering that you only need to use exec if you need to do something that cannot be written in the makefile. <br><br><h3>  Development mode </h3><br>  The development mode should: <br><br><ul><li>  Clear build cache </li><li>  Compile code </li><li>  Run the service in the background </li><li>  Repeat these steps when the code changes. </li></ul><br>  That sounds easy.  However, the difficulty lies in the fact that we simultaneously run both the service and the file-watcher.  Before starting a new process, we must ensure that it stops correctly and that we don‚Äôt break the normal behavior of the command line when pressing Control-C or Control-D. <br><br><pre> <code class="cmake hljs">start: bash -c <span class="hljs-string"><span class="hljs-string">"trap 'make stop' EXIT; $(MAKE) compile start-server watch run='make compile start-server'"</span></span> stop: stop-server</code> </pre> <br>  The code described above solves the following tasks: <br><br><ul><li>  Compiles and runs the service in the background. </li><li>  The main process does not run in the background, so we can interrupt it using Control-C. </li><li>  Stops background processes when the main process is interrupted.  trap is needed just for this. </li><li>  Re-compiles and restarts the server when the code changes. </li></ul><br>  In the following sections, I will explain these commands in more detail. <br><br><h3>  Compilation </h3><br>  The compile command does not just call go compile in the background - it clears the error output and prints a simplified version. <br><br>  This is what the command line output looks like when we made breaking edits: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/809/7cc/823/8097cc823632bcaa0a1329217e4d61f8.png" alt="image"><br><br><pre> <code class="cmake hljs">compile: @-touch $(STDERR) @-rm $(STDERR) @-$(MAKE) -s go-compile <span class="hljs-number"><span class="hljs-number">2</span></span>&gt; $(STDERR) @cat $(STDERR) | sed -e '<span class="hljs-number"><span class="hljs-number">1</span></span>s/.*/\nError:\n/' | sed 's/make\[.*/ /' | sed <span class="hljs-string"><span class="hljs-string">"/^/s/^/ /"</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre><br><h3>  Server start / stop </h3><br>  start-server starts a binary compiled in the background, saving its PID to a temporary file.  stop-server reads the PID and kills the process if necessary. <br><br><pre> <code class="cmake hljs">start-server: @echo <span class="hljs-string"><span class="hljs-string">" &gt; $(PROJECTNAME) is available at $(ADDR)"</span></span> @-$(GOBIN)/$(PROJECTNAME) <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span> &amp; echo $$! &gt; $(PID) @cat $(PID) | sed <span class="hljs-string"><span class="hljs-string">"/^/s/^/ \&gt; PID: /"</span></span> stop-server: @-touch $(PID) @-kill `cat $(PID)` <span class="hljs-number"><span class="hljs-number">2</span></span>&gt; /dev/null || <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> @-rm $(PID) restart-server: stop-server start-server</code> </pre> <br><h3>  Change monitoring </h3><br>  We need a watcher file to track changes.  I tried many, but could not find a suitable one, so I wrote my own file monitoring tool - <a href="https://github.com/azer/yolo"><i>yolo</i></a> .  Install it using the command: <br><br><pre> <code class="bash hljs">$ go get github.com/azer/yolo</code> </pre> <br>  After installation, we can observe changes in the project directory, excluding the vendor and bin folders. <br><br><pre> <code class="cmake hljs"><span class="hljs-comment"><span class="hljs-comment">## watch:      ,  make watch run="echo 'hey'" watch: @yolo -i . -e vendor -e bin -c $(run)</span></span></code> </pre> <br>  We now have a watch command that recursively tracks changes to the project directory, with the exception of the vendor directory.  We can just pass any command to run. <br>  For example, start calls make-start-server when the code changes: <br><br><pre> <code class="bash hljs">make watch run=<span class="hljs-string"><span class="hljs-string">"make compile start-server"</span></span></code> </pre> <br>  We can use it to run tests or check race conditions automatically.  Environment variables will be set at runtime, so you don't need to worry about GOPATH: <br><br><pre> <code class="bash hljs">make watch run=<span class="hljs-string"><span class="hljs-string">"go test ./..."</span></span></code> </pre> <br>  A nice feature of <i>Yolo</i> is its web interface.  If you enable it, you can immediately see the output of your command in the web interface.  All you need to do is pass the -a option: <br><br><pre> <code class="bash hljs">yolo -i . -e vendor -e bin -c <span class="hljs-string"><span class="hljs-string">"go run foobar.go"</span></span> -a localhost:9001</code> </pre> <br>  Open localhost: 9001 in a browser and immediately see the result of work: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/89d/6ae/520/89d6ae52007cb50e39d73bb979fdafc9.gif" alt="image"><br><br><h3>  Dependency Installation </h3><br>  When we make changes to the code, we would like the missing dependencies to be loaded before compilation.  The install command will do the job for us: <br><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">install</span></span>: go-get</code> </pre> <br>  We will automate the install call when the file changes before compilation, so the dependencies will be installed automatically.  If you want to install the dependency manually, you can run: <br><br><pre> <code class="bash hljs">make install get=<span class="hljs-string"><span class="hljs-string">"github.com/foo/bar"</span></span></code> </pre> <br>  Internally, this command will be converted to: <br><br><pre> <code class="bash hljs">$ GOPATH=~/my-web-server GOBIN=~/my-web-server/bin go get github.com/foo/bar</code> </pre> <br>  How it works?  See the next section where we add regular Go commands to implement higher level commands. <br><br><h3>  Go Teams </h3><br>  Since we want to install GOPATH in the project directory in order to simplify dependency management, which has not yet been officially decided in the Go ecosystem, we need to wrap all Go commands in the Makefile. <br><br><pre> <code class="cmake hljs">go-compile: go-clean go-get go-build go-build: @echo <span class="hljs-string"><span class="hljs-string">" &gt; Building binary..."</span></span> @GOPATH=$(GOPATH) GOBIN=$(GOBIN) go build -o $(GOBIN)/$(PROJECTNAME) $(GOFILES) go-generate: @echo <span class="hljs-string"><span class="hljs-string">" &gt; Generating dependency files..."</span></span> @GOPATH=$(GOPATH) GOBIN=$(GOBIN) go generate $(generate) go-get: @echo <span class="hljs-string"><span class="hljs-string">" &gt; Checking if there is any missing dependencies..."</span></span> @GOPATH=$(GOPATH) GOBIN=$(GOBIN) go get $(get) go-<span class="hljs-keyword"><span class="hljs-keyword">install</span></span>: @GOPATH=$(GOPATH) GOBIN=$(GOBIN) go <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> $(GOFILES) go-clean: @echo <span class="hljs-string"><span class="hljs-string">" &gt; Cleaning build cache"</span></span> @GOPATH=$(GOPATH) GOBIN=$(GOBIN) go clean</code> </pre> <br><h3>  Help </h3><br>  Finally, we need the help command to see a list of available commands.  We can automatically generate beautifully formatted help output using the sed and column commands: <br><br><pre> <code class="cmake hljs">help: Makefile @echo <span class="hljs-string"><span class="hljs-string">" Choose a command run in "</span></span>$(PROJECTNAME)<span class="hljs-string"><span class="hljs-string">":"</span></span> @sed -n 's/^<span class="hljs-comment"><span class="hljs-comment">##//p' $&lt; | column -t -s ':' | sed -e 's/^/ /'</span></span></code> </pre> <br>  The following command scans the Makefile for lines starting with ## and displays them.  That way, you can simply comment on specific commands, and comments will be displayed with the help command. <br><br>  If we add a few comments: <br><br><pre> <code class="cmake hljs"><span class="hljs-comment"><span class="hljs-comment">## install: Install missing dependencies. Runs `go get` internally. install: go-get ## start: Start in development mode. Auto-starts when code changes. start: ## stop: Stop development mode. stop: stop-server</span></span></code> </pre> <br>  We'll get: <br><br><pre> <code class="bash hljs">$ make <span class="hljs-built_in"><span class="hljs-built_in">help</span></span> Choose a <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> run <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> my-web-server: install Install missing dependencies. Runs `go get` internally. start Start <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> development mode. Auto-starts when code changes. stop Stop development mode.</code> </pre> <br><h3>  Final version </h3><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">include</span></span> .env PROJECTNAME=$(shell basename <span class="hljs-string"><span class="hljs-string">"$(PWD)"</span></span>) <span class="hljs-comment"><span class="hljs-comment"># Go related variables. GOBASE=$(shell pwd) GOPATH="$(GOBASE)/vendor:$(GOBASE)" GOBIN=$(GOBASE)/bin GOFILES=$(wildcard *.go) # Redirect error output to a file, so we can show it in development mode. STDERR=/tmp/.$(PROJECTNAME)-stderr.txt # PID file will keep the process id of the server PID=/tmp/.$(PROJECTNAME).pid # Make is verbose in Linux. Make it silent. MAKEFLAGS += --silent ## install: Install missing dependencies. Runs `go get` internally. eg; make install get=github.com/foo/bar install: go-get ## start: Start in development mode. Auto-starts when code changes. start: bash -c "trap 'make stop' EXIT; $(MAKE) compile start-server watch run='make compile start-server'" ## stop: Stop development mode. stop: stop-server start-server: stop-server @echo " &gt; $(PROJECTNAME) is available at $(ADDR)" @-$(GOBIN)/$(PROJECTNAME) 2&gt;&amp;1 &amp; echo $$! &gt; $(PID) @cat $(PID) | sed "/^/s/^/ \&gt; PID: /" stop-server: @-touch $(PID) @-kill `cat $(PID)` 2&gt; /dev/null || true @-rm $(PID) ## watch: Run given command when code changes. eg; make watch run="echo 'hey'" watch: @GOPATH=$(GOPATH) GOBIN=$(GOBIN) yolo -i . -e vendor -e bin -c "$(run)" restart-server: stop-server start-server ## compile: Compile the binary. compile: @-touch $(STDERR) @-rm $(STDERR) @-$(MAKE) -s go-compile 2&gt; $(STDERR) @cat $(STDERR) | sed -e '1s/.*/\nError:\n/' | sed 's/make\[.*/ /' | sed "/^/s/^/ /" 1&gt;&amp;2 ## exec: Run given command, wrapped with custom GOPATH. eg; make exec run="go test ./..." exec: @GOPATH=$(GOPATH) GOBIN=$(GOBIN) $(run) ## clean: Clean build files. Runs `go clean` internally. clean: @(MAKEFILE) go-clean go-compile: go-clean go-get go-build go-build: @echo " &gt; Building binary..." @GOPATH=$(GOPATH) GOBIN=$(GOBIN) go build -o $(GOBIN)/$(PROJECTNAME) $(GOFILES) go-generate: @echo " &gt; Generating dependency files..." @GOPATH=$(GOPATH) GOBIN=$(GOBIN) go generate $(generate) go-get: @echo " &gt; Checking if there is any missing dependencies..." @GOPATH=$(GOPATH) GOBIN=$(GOBIN) go get $(get) go-install: @GOPATH=$(GOPATH) GOBIN=$(GOBIN) go install $(GOFILES) go-clean: @echo " &gt; Cleaning build cache" @GOPATH=$(GOPATH) GOBIN=$(GOBIN) go clean .PHONY: help all: help help: Makefile @echo @echo " Choose a command run in "$(PROJECTNAME)":" @echo @sed -n 's/^##//p' $&lt; | column -t -s ':' | sed -e 's/^/ /' @echo</span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/461467/">https://habr.com/ru/post/461467/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461459/index.html">Happy system administrator day</a></li>
<li><a href="../46146/index.html">Yahoo tightens military intelligence at analytics</a></li>
<li><a href="../461461/index.html">Backup thrives in the cloud age, but tape reels are not forgotten. Conversation with Veeam</a></li>
<li><a href="../461463/index.html">Business processes in enterprise companies: speculation and reality. Shed light with R</a></li>
<li><a href="../461465/index.html">Measurement Guide</a></li>
<li><a href="../461469/index.html">What is it like listening to code at 1000 words per minute</a></li>
<li><a href="../46147/index.html">Selected: Grouping</a></li>
<li><a href="../461473/index.html">Debugging algorithms on graphs - now with pictures</a></li>
<li><a href="../461475/index.html">AMA with Habr. 1011</a></li>
<li><a href="../461483/index.html">Openstack Load Balancing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>