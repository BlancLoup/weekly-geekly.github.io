<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>RabbitMQ unrestricted migration to Kubernetes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="RabbitMQ is a message broker written in Erlang that allows you to organize a failover cluster with full data replication to several nodes, where each ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>RabbitMQ unrestricted migration to Kubernetes</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/gj/nl/hr/gjnlhrbjftwmdqsokcczdh6x_6o.png"><br><br>  RabbitMQ is a message broker written in Erlang that allows you to organize a failover cluster with full data replication to several nodes, where each node can serve read and write requests.  Having a lot of Kubernetes clusters in production-operation, we support a large number of RabbitMQ installations and are faced with the need to migrate data from one cluster to another without downtime. <a name="habracut"></a><br><br>  We needed this operation in at least two cases: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Transferring data from a RabbitMQ cluster that is not in Kubernetes to a new ‚Äî already ‚Äúcubed‚Äù (i.e., operating in K8s pods) - cluster. </li><li>  RabbitMQ migration within Kubernetes from one namespace to another (for example, if the contours are delimited by name spaces, then to transfer the infrastructure from one contour to another). </li></ol><br>  The recipe proposed in the article is focused on situations (but not limited to them at all), in which there is an old RabbitMQ cluster (for example, from 3 nodes) located either in K8s or on some old servers.  An application placed in Kubernetes works with it (already there or in the future): <br><br><img src="https://habrastorage.org/webt/0t/nv/vw/0tnvvwspr5t-cwbvwzae5p2h9re.png"><br><br>  ... and we are faced with the task of migrating it to a new production in Kubernetes. <br><br>  First, a general approach to the migration itself will be described, and after that - technical details on its implementation. <br><br><h2>  Migration Algorithm </h2><br>  The first, preliminary, stage before any actions is to check that the old installation of RabbitMQ has High Availability Mode ( <a href="https://www.rabbitmq.com/ha.html">HA</a> ) enabled.  The reason is obvious - we do not want to lose any data.  To perform this check, you can go to the RabbitMQ admin panel and in the Admin ‚Üí Policies tab, make sure that the value of <code>ha-mode: all</code> : <br><br><img src="https://habrastorage.org/webt/fz/sj/cc/fzsjcc5rvcdzqvzrwklrkomoqny.png"><br><br>  The next step is to raise a new RabbitMQ cluster in Kubernetes pods (in our case, for example, consisting of 3 nodes, but their number may be different). <br><br>  After that, we merge the old and new RabbitMQ clusters, getting a single cluster (of 6 nodes): <br><br><img src="https://habrastorage.org/webt/br/ds/wx/brdswxtjfd97eg1jc6yuy0m6w6c.png"><br><br>  The process of data synchronization between the old and new RabbitMQ clusters is initiated.  After all data is synchronized between all nodes in the cluster, we can switch the application to use the new cluster: <br><br><img src="https://habrastorage.org/webt/mh/wu/py/mhwupy0059dj_m8xn-guonlq_i0.png"><br><br>  After these operations, it is enough to remove the old nodes from the RabbitMQ cluster, and the move can be considered complete: <br><br><img src="https://habrastorage.org/webt/_2/_q/cr/_2_qcrxnt_1j4hzazxfsagyr9i8.png"><br><br>  We have repeatedly used this scheme in production.  However, for their own convenience, they implemented it as part of a specialized system that distributes typical RMQ configurations on sets of Kubernetes clusters <i>(for those who are curious: this is about the <a href="https://github.com/flant/addon-operator">addon-operator</a> , which we <a href="https://habr.com/ru/company/flant/blog/449096/">recently told you about</a> )</i> .  Below will be presented separately taken instructions that everyone can apply on their installations to try the proposed solution in action. <br><br><h2>  We try in practice </h2><br><h3>  Requirements </h3><br>  Details are very simple: <br><br><ol><li>  Kubernetes cluster (minikube will do); </li><li>  RabbitMQ cluster (it can be deployed on bare metal, and made as a regular cluster in Kubernetes from the official Helm-chart). </li></ol><br>  For the example below, I deployed RMQ in Kubernetes and called it <code>rmq-old</code> . <br><br><h3>  Stand preparation </h3><br>  1. Download the Helm-chart and edit it a bit: <br><br><pre> <code class="bash hljs">helm fetch --untar stable/rabbitmq-ha</code> </pre> <br>  For convenience, we set a password, <code>ErlangCookie</code> and make a <code>ha-all</code> policy so that by default the queues are synchronized between all the nodes of the RMQ cluster: <br><br><pre> <code class="plaintext hljs">rabbitmqPassword: guest rabbitmqErlangCookie: mae9joopaol7aiVu3eechei2waiGa2we definitions: policies: |- { "name": "ha-all", "pattern": ".*", "vhost": "/", "definition": { "ha-mode": "all", "ha-sync-mode": "automatic", "ha-sync-batch-size": 81920 } }</code> </pre> <br>  2. Set the chart: <br><br><pre> <code class="bash hljs">helm install . --name rmq-old --namespace rmq-old</code> </pre> <br>  3. Go to the RabbitMQ admin area, create a new queue and add several messages.  They will be needed so that after migration we can make sure that all the data was saved and that we did not lose anything: <br><br><img src="https://habrastorage.org/webt/de/pb/_o/depb_oq1aa_rpozeaymiik6acqm.png"><br><br>  The test bench is ready: we have an ‚Äúold‚Äù RabbitMQ with data that needs to be transferred. <br><br><h3>  RabbitMQ Cluster Migration </h3><br>  1. First, let's deploy a new RabbitMQ in a <b>different</b> namespace with <b>the same</b> <code>ErlangCookie</code> and password for the user.  To do this, we perform the operations described above, changing the final RMQ installation command to the following: <br><br><pre> <code class="bash hljs">helm install . --name rmq-new --namespace rmq-new</code> </pre> <br>  2. Now you need to merge the new cluster with the old one.  To do this, we go into each of the pods of the <b>new</b> RabbitMQ and execute the commands: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> OLD_RMQ=rabbit@rmq-old-rabbitmq-ha-0.rmq-old-rabbitmq-ha-discovery.rmq-old.svc.cluster.local &amp;&amp; \ rabbitmqctl stop_app &amp;&amp; \ rabbitmqctl join_cluster <span class="hljs-variable"><span class="hljs-variable">$OLD_RMQ</span></span> &amp;&amp; \ rabbitmqctl start_app</code> </pre> <br>  The variable <code>OLD_RMQ</code> is the address of one of the nodes of the <b>old</b> RMQ cluster. <br><br>  These commands will stop the current node of the <b>new</b> RMQ cluster, attach it to the old cluster and restart it. <br><br>  3. RMQ cluster of 6 nodes is ready: <br><br><img src="https://habrastorage.org/webt/1k/1z/cr/1k1zcrq3-hn-k_k6y10z-ktteqc.png"><br><br>  You must wait until the messages are synchronized between all nodes.  It is not difficult to guess that the time of message synchronization depends on the power of the iron in which the cluster is deployed, and on the number of messages.  In the described scenario, there are only 10 of them, so the data was synchronized instantly, but with a sufficiently large number of messages, the synchronization can take hours. <br><br>  So, the synchronization status: <br><br><img src="https://habrastorage.org/webt/32/rb/gl/32rbglvg5f9vnxjaee0ewii0pmo.png"><br><br>  Here, <code>+5</code> means that messages are <b>already</b> on <b>another</b> 5 nodes (except for what is indicated in the <code>Node</code> field).  Thus, the synchronization was successful. <br><br>  4. It remains only to switch the address of the RMQ to the new cluster in the application (specific actions here depend on the technological stack you are using and other specifics of the application), after which you can say goodbye to the old one. <br><br>  For the last operation (ie, <b>after</b> switching the application to the new cluster), we go to each node of the <b>old</b> cluster and execute the commands: <br><br><pre> <code class="bash hljs">rabbitmqctl stop_app rabbitmqctl reset</code> </pre> <br>  Cluster "forgot" about the old nodes: you can delete the old RMQ, on which the move will be completed. <br><br>  <i><b>Note</b> : If you use RMQ with certificates, then nothing changes fundamentally - the process of moving will be carried out in the same way.</i> <br><br><h2>  findings </h2><br>  The described scheme is suitable for almost all cases when we need to move RabbitMQ or just move to a new cluster. <br><br>  In our case, difficulties arose only once, when RMQ was contacted from many places, and we did not have the opportunity to change the address of RMQ everywhere to a new one.  Then we launched the new RMQ in the same namespace with the same labels, so that it would fall under the already existing services and Ingress, and when the pod was started, hands were manipulating the labels, deleting them at the beginning, so that no queries would get on the empty RMQ, and adding them back after syncing messages. <br><br>  We used the same strategy when upgrading RabbitMQ to a new version with a modified configuration - everything worked like a clock. <br><br><h2>  PS </h2><br>  As a logical continuation of this material, we are preparing articles about MongoDB (migration from the iron server to Kubernetes) and MySQL (one of the options for ‚Äúpreparing‚Äù this DBMS inside Kubernetes).  They will be published in the coming months. <br><br><h2>  Pps </h2><br>  Read also in our blog: <br><br><ul><li>  " <a href="https://habr.com/company/flant/blog/431500/">Databases and Kubernetes (review and video of the report)</a> "; </li><li>  ‚Äú <a href="https://habr.com/ru/company/flant/blog/417509/">K8s tips &amp; tricks: Accelerate the bootstrap of large databases.</a> ‚Äù </li></ul></div><p>Source: <a href="https://habr.com/ru/post/450662/">https://habr.com/ru/post/450662/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../450642/index.html">PHP Digest 155 (April 22 - May 6, 2019)</a></li>
<li><a href="../450644/index.html">Cryptocurrency: lives or dies? Part 3</a></li>
<li><a href="../45065/index.html">Q3 MoneyTreeReport - US Venture Report</a></li>
<li><a href="../450658/index.html">Intel Processor Mega Launch - Series Enrichment</a></li>
<li><a href="../450660/index.html">Will the introduction of a 15% tax overseas e-commerce kill</a></li>
<li><a href="../450666/index.html">Does React have a bad effect on Angular?</a></li>
<li><a href="../450672/index.html">Construction of a metal platform on a pile foundation in SPDS Metal structures</a></li>
<li><a href="../450674/index.html">Moving to Armenia</a></li>
<li><a href="../450676/index.html">‚ÄúMetalworking 2019‚Äù: advanced 3D solutions for enterprises</a></li>
<li><a href="../45068/index.html">I will teach you how to use Google search.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>