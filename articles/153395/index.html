<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Weather station on STM32L-DISCOVERY</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From childhood, he dreamed of a room thermometer, hygrometer and barometer (they did not pass the lessons of natural history and biology for nothing)....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Weather station on STM32L-DISCOVERY</h1><div class="post__text post__text-html js-mediator-article">  From childhood, he dreamed of a room thermometer, hygrometer and barometer (they did not pass the lessons of natural history and biology for nothing).  Even a wall-mounted version was purchased with a Soviet-type switch instruments such as: <br><img src="https://habrastorage.org/storage2/307/947/f19/307947f19150153f3b0a5ffed925cf6a.jpg"><br>  But he was mistakenly hung on the door and after some time, having become unusable, from constant shaking, he began to show the same value.  Psychrometer frightened his appearance.  Yes, and write down every day testimony - a silly idea.  Mechanical systems were buried altogether with the arrival of controllers. <br><br>  Long looked after various debug boards.  On the advice of a friend, I bought a STM32L-Discovery debug board from ST, a detailed description <a href="http://www.compel.ru/2011/06/08/izuchaem-nizkopotreblyayushhij-cortex-m3-s-platoj-stm32l-discovery/">here</a> .  It is tempting that this is an ARM on the core of the Cortex-M3.  The heart of the board is STM32L152RBT6.  There is also an on-board ST-Link programmer and debugger and a six-segment LCD display. <br><a name="habracut"></a><img src="https://habrastorage.org/storage2/7fb/747/088/7fb747088dbb235f8c1e8a3e2da5a7e7.jpg"><br><br>  <a href="http://avrdevices.ru/termometr-na-sht21/">Post</a> <a href="http://cxem.net/house/1-247.php">your own weather station</a> , a <a href="http://avrdevices.ru/termometr-na-sht21/">thermometer on the SHT21</a> and the presence of STM32L-Discovery inspired the project. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Having a little accustomed to Keil, I downloaded instead of the example on board, another example is the Temperature project - and voila the thermometer is ready.  The microcontroller can measure Vref.  He also has his own chip temperature sensor. <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/wEvuCgFxQlg%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700191,15700253,15700255,15700259&amp;usg=ALkJrhibFKz48drSOh_o-wdiD3lSv7eUyw" frameborder="0" allowfullscreen=""></iframe><br>  Everything would be fine, but this sensor shows the crystal temperature, I decided to add a DS18B20 temperature sensor, and it would be nice to learn one-wire interface.  It turned out that in order to add anything, the first thing to do is get rid of the standard LCD screen, with its 6 characters it occupies almost all free ports of the processor. <br><br>  An old LCD screen assembled on Hitachi controllers lay in the bins of the homeland (8 lines of 25 characters each) <br><img src="https://habrastorage.org/storage2/795/aa0/11c/795aa011c47c628ee73e93b6752b14bf.png"><br>  The above mentioned article mentioned the HIH3610 digital humidity sensor, but the capacitive humidity sensor HCH1000 and the barometric sensor HSF1000 were purchased. <br><br>  So, we organized the tasks for connecting the equipment: <br>  1. Connecting and programming the LCD screen; <br>  2. Connect and receive data from RTL; <br>  2. Connecting a DS18B20 digital temperature sensor and reading one-wire data from it; <br>  3. Connecting a capacitive sensor HCH1000 and receiving data; <br>  4. Connecting the HSF1000 piezoelectric sensor and receiving data; <br><br>  That such a device came out: <br><img src="https://habrastorage.org/storage2/1e2/37a/5ad/1e237a5ad36f21266a1629321612f615.jpg"><br><img src="https://habrastorage.org/storage2/509/bd0/98f/509bd098f85d648c10dedda1bfa2b62b.jpg"><br><br><h4>  Connecting and programming the LCD screen </h4><br>  The copy I got in my hands turned out to be so old that there was no documentation from him.  It had 4 HD44102CH chips and 2 HD44102 chips, and 4 discrete chips which I did not find a description of. <br>  The reference manual on the HD44102 was found, and there were 8 legs of 4 microcircuits interconnected and mated to the connector - this was how D0-D7 was found, the power was found on discrete microcircuits.  There were RW, E, CS, R / S signals. The HLM9301 LCD module was found in youtub very similar to my LCD, the Italian on the <a href="http://www.lcdstudio.com/">www.lcdstudio.com</a> forum gave a pinout that coincided with the a priori I collected: <br>  1 GND;  2 VCC; <br>  3 contraste (generalmente terminal medio de potenciometro de 10k colocado entre vcc y gnd) 4 NC (no conectado); <br>  5 NC;  6 CS1; <br>  7 CS2;  8 CS3; <br>  9 NC;  10 E; <br>  11 R / W 12 R / S (DATA / INSTRUCTION) <br>  13 D0;  14 D1; <br>  15 D2;  16 D3 <br>  17 D4;  18 D5; <br>  19 D6;  20 D7. <br>  But when giving the commands, the matrix showed no signs of life. <br>  After a long, no less than the previous, search on the Internet, it turned out that the old graphic screens needed negative voltage for brightness.  A DC-DC P6AU0505 converter was turned on and a precision variable resistor 200kŒ© was installed between the brightness and ‚Äì5 outputs. <br>  The teams from HD44102 came up.  A library has been written to work with HLM9301.  On the forums, the guys claimed that everything worked with Arduino immediately with the standard GLCD library. <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/_FIBvI1rGSg%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700191,15700253,15700255,15700259&amp;usg=ALkJrhhR7cRqCze0X8flwwRFr0vmQZAoPw" frameborder="0" allowfullscreen=""></iframe><br>  The video shows the read data from the internal RTC and thermometer. <br><br><h4>  Connect and retrieve data from RTL </h4><br>  RTC initialization is as follows: <br><pre><code class="cpp hljs">RCC_APB2PeriphClockCmd(RCC_APB2Periph_ADC1 | RCC_APB2Periph_SYSCFG, ENABLE); PWR_RTCAccessCmd(ENABLE); RCC_LSEConfig(RCC_LSE_ON); <span class="hljs-comment"><span class="hljs-comment">//do not touch LSE to prevent RTC calendar reset while (RCC_GetFlagStatus(RCC_FLAG_LSERDY) == RESET) {} RCC_RTCCLKCmd(ENABLE);</span></span></code> </pre> <br>  Problem: when reset, the RTC was also reset.  The code snippet taken from the demo did something with the LSE - this was the reset of the RTC. <br>  Reading data: <br><pre> <code class="cpp hljs">RTC_DateTypeDef RTCDateStr; RTC_TimeTypeDef RTCTimeStr; RTC_GetTime(RTC_Format_BIN, &amp;RTCTimeStr); RTC_GetDate(RTC_Format_BIN, &amp;RTCDateStr); <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(strDisp, <span class="hljs-string"><span class="hljs-string">"%02d/%02d/%02d %02d:%02d:%02d"</span></span>, RTCDateStr.RTC_Year, RTCDateStr.RTC_Month, RTCDateStr.RTC_Date, RTCTimeStr.RTC_Hours, RTCTimeStr.RTC_Minutes, RTCTimeStr.RTC_Seconds);</code> </pre><br>  Then we got two new tasks ‚Äúor‚Äù: turn on the ionistor in the power supply circuit of the microcircuit and, if the supply voltage drops, go into ‚Äúsleep mode‚Äù, or attach an external RTC.  I think to try both methods ... <br><br><h4>  Connecting a digital temperature sensor DS18B20 </h4><br>  Thanks to the articles <a href="http://we.easyelectronics.ru/STM32/stm32-1-wire-dma-prodolzhenie.html">Stm32 + 1-wire + DMA (continued)</a> and <a href="http://we.easyelectronics.ru/STM32/stm32-1-wire-dma.html">Stm32 + 1-wire + DMA</a> , the onewire.c library has been added, but for the STM32L152 processor port initialization looks a bit different: <br><pre> <code class="cpp hljs">GPIO_InitStructure.GPIO_Pin = GPIO_Pin_2; GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF; GPIO_InitStructure.GPIO_Speed = GPIO_Speed_40MHz; GPIO_InitStructure.GPIO_OType = GPIO_OType_PP; GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_UP; GPIO_Init(GPIOA, &amp;GPIO_InitStructure); GPIO_PinAFConfig(GPIOA, GPIO_PinSource2, GPIO_AF_USART2); GPIO_InitStructure.GPIO_Pin = GPIO_Pin_3; GPIO_Init(GPIOA, &amp;GPIO_InitStructure); GPIO_PinAFConfig(GPIOA, GPIO_PinSource3, GPIO_AF_USART2);</code> </pre><br>  Connection diagram taken from datasheet: <br><img src="https://habrastorage.org/storage2/a46/574/10b/a4657410bc67fcad5b34e7d45f294eca.jpg"><br>  With the help <a href="http://we.easyelectronics.ru/STM32/stm32-1-wire-poisk-ustroystv.html">of the ‚ÄúDevice Search‚Äù article</a> , the ability to connect multiple devices to the one-wire bus was added.  The resolution at DS18B20 when reading all 12 bits is 0.0625 degrees Celsius. <br><br><h4>  Connecting a capacitive sensor HCH1000 </h4><br>  You can measure capacitance in different ways, the simplest method is to charge and monitor the voltage drop, considering the time to calculate the capacitance, or you can estimate the capacitance by AC resistance.  Honeywell graciously provided a datasheet in which the sensor was the master value in the generator at 555. I used the last method and put together a simple generator: <br><img src="https://habrastorage.org/storage2/b5a/4d1/d3d/b5a4d1d3d4727c903362f07e6e952667.jpg"><br>  It was not difficult to calculate the frequency. STM32L152 has several timers that can work in the mode of capturing the parameters of the PWM signal.  Details <a href="http://robocraft.ru/blog/ARM/739.html">here</a> . <br>  The difference was, as is the case with the one-wire port configuration: <br><pre> <code class="cpp hljs">GPIO_InitStructure.GPIO_Pin = GPIO_Pin_1; GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF; GPIO_InitStructure.GPIO_OType = GPIO_OType_PP; GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_UP; GPIO_InitStructure.GPIO_Speed = GPIO_Speed_40MHz; GPIO_Init(GPIOA, &amp;GPIO_InitStructure); GPIO_PinAFConfig(GPIOA, GPIO_PinSource1, GPIO_AF_TIM2);</code> </pre><br>  Otherwise, all the text in the interrupt subtract the values ‚Äã‚Äãof the counters, get the length of the period, multiplied by the coefficient is the capacity, from the capacity according to the graphs of the sensor went to humidity. <br><br><h4>  Connection of the piezoelectric sensor HSF1000 </h4><br>  I connected the sensor to Vref, GND and to the input of the ADC.  Experience has shown that the accuracy of a 12-bit ADC is not enough to evaluate the useful signal.  Connecting the AD8555 instrumentation amplifier according to the standard scheme to the sensor gave its fruits.  Gain 10 times was enough to raise the signal level to 0.7V. <br><img src="https://habrastorage.org/storage2/7e8/a7b/8d6/7e8a7b8d6b9f5fc9e64d3bc30ce1a94c.jpg"><br><br>  Here is the main screen of the device <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/GyWhbf63X5Y%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700191,15700253,15700255,15700259&amp;usg=ALkJrhiusSljKz8AEEDXjky5M6Sl8RjDwA" frameborder="0" allowfullscreen=""></iframe><br>  values ‚Äã‚Äãin the rows: <br>  1. date time from internal RTL; <br>  2. duty cycle and period of the signal from the generator, as well as the number of one-wire devices found; <br>  3. the capacity of the humidity sensor and humidity; <br>  4. one-wire identifier; <br>  5. temperature value; <br>  6. voltage value; <br>  7. crystal temperature value; <br>  8. pressure value. <br><br>  Project sources <a href="https://docs.google.com/viewer%3Fa%3Dv%26pid%3Dsites%26srcid%3DZGVmYXVsdGRvbWFpbnx0YXJhc2lpdmFuaXZ8Z3g6NjRiZmQ1NDZmZGFkNGE3OA">here</a> </div><p>Source: <a href="https://habr.com/ru/post/153395/">https://habr.com/ru/post/153395/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../153383/index.html">Through thorns to Haskell (translation). 2/2</a></li>
<li><a href="../153385/index.html">Painless migration from Gitosis to Gitolite</a></li>
<li><a href="../153387/index.html">Connecting an ASP.NET MVC project to an ASP.NET WebForms project</a></li>
<li><a href="../153389/index.html">Everything you wanted to know about implantable tags, but were afraid to ask</a></li>
<li><a href="../153391/index.html">Getting Genuine Windows Subsystem (csrss.exe) Process</a></li>
<li><a href="../153399/index.html">Lockitron: the world's smartest door lock</a></li>
<li><a href="../153401/index.html">HUAWEI network equipment configuration (switching, static routing)</a></li>
<li><a href="../153403/index.html">How to sell your program</a></li>
<li><a href="../153405/index.html">How to interest a foreign employer</a></li>
<li><a href="../153413/index.html">Automatic captcha input - the theory and practice of conquering the Internet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>