<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Modernization of operational data center</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In our blog, we write a lot about building a cloud service 1cloud (for example, on the implementation of the server disk space management function on ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Modernization of operational data center</h1><div class="post__text post__text-html js-mediator-article">  In our blog, we write a lot about building a cloud service <a href="https://1cloud.ru/">1cloud</a> (for example, on the implementation of the server <a href="http://habrahabr.ru/company/1cloud/blog/255913/">disk space management</a> function on the fly), but many interesting things can be learned from the experience of working with infrastructure of other companies. <br><br>  We have already talked about the imgix photoservice data center, described the search <a href="http://habrahabr.ru/company/1cloud/blog/262257/">history of</a> problems with SSD disks of the Algolia project, and today we will talk about upgrading the Stack Exchange data center. <br><br> <a href="http://habrahabr.ru/company/1cloud/blog/263701/"><img src="https://habrastorage.org/files/caa/5b1/a35/caa5b1a357514aca83212b2e8d79446a.jpg"></a> <a name="habracut"></a><br>  / <a href="https://www.flickr.com/photos/dvanzuijlekom/8523169462/in/photolist-dZatkC-5akwi9-7HWjHF-q1Snz8-5sAcGu-8Vvws-5svf7B-ocS7Dq-bf2wDV-iFVWP-4qFg4S-dZ4wtK-cs5Pnj-eZv37-6tEshe-ok8fq8-dZaXcj-q1Cob8-5hrCbv-chaxty-duKxtE-cs6brY-2jv4KX-pxDgC-nXpUbD-dZ8qHy-dZ8kg5-pWgAxh-8Vvwh-4D6r8-bqY66F-btU3pv-d75EoY-5sztxS-DqpnY-6tJA47-imfDLH-oJ5q6K-bqY7tn-8kYgmL-5JjiDv-4qETvU-6tJAa7-8eRC2-avnpd5-2jv36k-fTsy1Q-6tEsgr-dtbhzp-KCRFY">photo Dennis van Zuijlekom</a> <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Stack Exchange Network - a network of Q &amp; A related websites across a wide range of areas of expertise.  The first network site was launched in 2008, and in 2012 the network grew to 90 sections and 2 million users.  Among the social functions, voting for questions and answers is available, and editing content is possible in wiki mode.  One of the most popular platforms is Stack Overflow, which covers technological topics and questions on development and programming. <br><br>  The base infrastructure of the company is located in New York and New Jersey, and due to the general approach to sharing experiences, the company decided to talk about how engineers upgraded their <a href="http://blog.stackoverflow.com/2009/12/stack-overflow-rack-glamour-shots/">data center</a> and transferred it from New York. <br><br>  The decision to upgrade the equipment was made at headquarters in Denver.  At that meeting, the optimal life cycle of the hardware was determined (approximately 4 years).  This figure is based on the experience of operating the very first set, which just exceeded the mark of 4 years of work.  Of course, attracted <a href="http://blog.stackoverflow.com/2015/01/andreessen-horowitz-invests-in-stack-exchange/">investments</a> helped to make a decision. <br><br>  The preparation of the <a href="https://docs.google.com/document/d/1loi8aB7bLSZ04Ggs1Moc62ZKCKum6nEgq_8FhsrFQu0">plan</a> took three days.  The start of the update coincided with a warning about the <a href="http://www.wunderground.com/news/winter-storm-juno-blizzard-boston-nyc-new-england">snowfall</a> , but the team decided to continue working.  Before starting the upgrade, engineers solved an important task with the Redis servers, busy with Targeted Job ads.  These machines were originally managed by Cassandra, and then Elasticsearch. <br><br>  For these systems were ordered hard drives Samsung 840 Pro, which, as it turned out, have a <a href="http://www.anandtech.com/show/6483/update-on-samsung-ssd-840840-pro-failures">serious bug</a> in the firmware.  Because of this bug, copying from server to server in a duplicate 10 Gbps network would be done at a speed of 12 MB / s, but it was decided to update the firmware.  When the process was started, it went in the background, in parallel with another job (since it takes several tens of minutes to rebuild a RAID10 array with data on board, even if you use an SSD drive).  As a result, it was possible to increase the speed of copying files to 100-200 MB / s. <br><br>  In server rack C, it was planned to replace the SFP + 10 Gbps connection with an external channel width of 1 Gbps with a 10GBASE-T interface (RJ45 connector).  This was done for several reasons: the cable used for SFP + is called <a href="http://en.wikipedia.org/wiki/Twinaxial_cabling">twinaxial</a> : it is very difficult to lay it and it is not easy to directly connect to the daughter cards of Dell servers.  Also, <a href="http://www.cisco.com/c/en/us/products/switches/nexus-2232pp-10ge-fabric-extender/index.html">SFP + FEX</a> does not allow connecting 10GBASE-T standard devices that may appear later ( <i>they are not</i> in <i>this rack</i> , but they can be in others, for example, in a load balancer). <br><br>  The plans were to simplify the network configuration, reduce the number of cables and the number of elements as a whole, while saving 4U of free space.  During the work it was necessary to maintain the functioning of KVM, which temporarily relocated.  Next, the SFP + FEX was lowered down in order to install the new 10GBASE-T FEX in its place.  The principle of operation of the FEX technology allows us to allocate from 1 to 8 uplink ports for each switch.  During the upgrade, the connection scheme will change as follows: 8/0 -&gt; 4/4 -&gt; 0/8. <br><br>  It was decided to replace the old virtual servers with two <a href="http://www.dell.com/us/business/p/poweredge-fx/pd">Dell PowerEdge FX2</a> chassis (with two FC630 blades each).  The blade server has two Intel E5-2698v3 18-core processors and 768 GB of RAM.  Each hardware unit has uplink ports with a transfer rate of 80 Gbit / s and four dual-channel 10 Gigabit I / O modules.  <a href="http://www.dell.com/us/business/p/fn-io-aggregator/pd">I / O aggregators</a> , in their essence, are full switches with four external and eight internal ports at 10 Gbit / s (two for each blade server). <br><br>  When the new blade servers went online, all the virtual machines migrated to these two hosts and were able to dismantle the old servers in order to free up more space.  After that, the last two blade servers were launched.  As a result, the company had much more powerful processors, a larger amount of memory (the volume increased from 512 GB to 3078 GB) and an upgraded network component (new blade servers with 20 GB trunk ports with all networks). <br><br>  Next, the <a href="http://www.dell.com/us/business/p/equallogic-ps6210-series/pd">EqualLogic PS6210, the</a> new storage <a href="http://www.dell.com/us/business/p/equallogic-ps6210-series/pd">unit,</a> replaced the old PS6200 with twenty-four 10k HDDs for 900 GB and SFP + transceivers.  The newer version supports the 10GBASE-T standard and contains twenty-four 10k HDDs at 1.2 TB, which means it works faster, has large disk space and the ability to connect / disconnect to / from the storage system.  Along with the new storage system, a new server, NY-LOGSQL01, was installed, which replaced the outdated Dell R510.  The space freed from the virtual machine hosts made it possible to install a new file server and support server. <br><br>  Due to the deteriorating weather conditions, public transport stopped walking, and the storm even managed to <a href="http://imgur.com/1eQlkwZ">cut down</a> electricity.  The team decided to continue working as far as possible in order to get ahead of schedule.  The guys from <a href="http://www.qtsdatacenters.com/">QTS</a> came to the rescue, they ordered the manager to find at least some place to sleep. <br><br>  When all the virtual machines started working, the storage was set up, and several wires were torn out, the clock showed 9:30 am on Tuesday.  The second day began with the assembly of web servers: the R620 upgrade, replacing the four gigabit daughter boards with two 10-gigabit and two gigabit. <br><br>  At this stage, only the old storage system and the old network storage for SQL R510 remained connected, but there were some difficulties with installing a third PCIe card on the backup server.  Everything came up because of the tape drive, which needed another <a href="http://imgur.com/zgUCINN">SAS controller</a> , which was simply forgotten. <br><br>  The new plan included the use of existing 10 Gigabit network daughter cards (NDC), the removal of a PCIe SFP + adapter and the replacement of it with a new 12 Gigabit SAS controller.  For this, it was necessary to independently make a replacement of the mounting bracket from pieces of metal (the cards are supplied without brackets).  Further, it was decided to swap the last two SFP + units in the C rack with a backup server (including the new DAS MD1400). <br><br>  The last element, which took its place on the rack C, was NY-GIT02 - a new server Gitlab and TeamCity.  Then followed a long process of cable management, which had to deal with almost everything (and in relation to the previously previously connected equipment).  After completing work on the two web servers, cable management and removal of network equipment, the clock showed 8:30 in the morning. <br><br>  On the third day, the team returned to the data center around 5 pm.  It remained to replace the Redis servers and ‚Äúservice servers‚Äù (the server for the tag engine implementation, the ElasticSearch index server, and others).  One of the boxes designed for the tag engine was the already well-known R620, which received an upgrade to 10 Gbps a bit earlier, so now it has not been touched. <br><br>  The array rebuilding process looked like this: deploy from a Windows 2012 R2 image, install updates and DSC, and then specialized software through scripts.  StackServer (from the point of view of the sysadmin) is just a window service, and the build TeamCity controls the installation - there is a special flag for this.  These boxes also have small instances of IIS for internal services, which are a simple add-in.  Their last task is to organize shared access to the DFS storage. <br><br>  The old Dell R610 web server solution with two <a href="http://ark.intel.com/products/47923">Intel E5640 processors</a> and 48 GB of RAM (updated over time) was replaced by a new one with two <a href="http://ark.intel.com/products/81909%25D1%258A">Intel 2678W v3</a> processors and 64 GB of DDR4 memory. <br><br>  Day 4 went to work with stand D. It took a while to add cable sleeves (where they were missing) and meticulously replace most of the wires.  How to understand that the cable is plugged into the correct port?  How to know where his other end goes?  Tags  Lots and lots of tags.  It took a lot of time, but it will save it in the future. <br><br>  <a href="http://imgur.com/a/X1HoY">All photo report</a> <br><br>  <a href="https://twitter.com/search%3Ff%3Drealtime%26q%3D%2523SnowOps%26src%3Dtypd">Stream #SnowOps on Twitter</a> <br><br>  Upgrades to equipment of this magnitude do not go without problems.  Similar to the situation in 2010, when the database server was updated, and the performance improvement was not the way <a href="http://blog.stackoverflow.com/2010/10/database-upgrade/">I would like to</a> see it, a bug was found with a system with BIOS versions 1.0.4 / 1.1.4 (where the performance settings are simply not taken into account). <br><br>  Other issues included a problem when running DSC configuration scripts, starting a ‚Äúbare‚Äù server with IIS, moving disks from a RAID array R610 to R630 (prompting for booting via PXE) and so on.  In addition, it turned out that the DAS arrays of the Dell MD1400 (13th generation and 12Gbit / s) do not support connection to the 12th generation servers, for example, to the R620 backup server, and the diagnostics of the Dell hardware does not affect power supplies.  By the way, the hypothesis was confirmed that it is quite problematic to turn over a web server opened upside down, when several important elements were unscrewed from it. <br><br>  As a result, the team managed to reduce the page processing time from about 30-35 to 10-15 ms, but according to them, this is only a small tip of the iceberg. <br><br>  <b><i>PS We try not only the experience of working with the <b><a href="https://1cloud.ru/">1cloud</a></b> virtual infrastructure <b><a href="https://1cloud.ru/">service</a></b> , but also the experience of Western experts in our <a href="http://habrahabr.ru/company/1cloud/blog/">blog</a> on Habr√©.</i></b>  <b><i>Do not forget to subscribe to updates, friends!</i></b> </div><p>Source: <a href="https://habr.com/ru/post/263701/">https://habr.com/ru/post/263701/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../263691/index.html">vCloud Director for the smallest (part 5): VPN setup</a></li>
<li><a href="../263693/index.html">Why do we need business intelligence systems</a></li>
<li><a href="../263695/index.html">The ideal way to implement a static code analyzer</a></li>
<li><a href="../263697/index.html">Central Park NY: official app redesign</a></li>
<li><a href="../263699/index.html">How-to: responsive emails in Gmail</a></li>
<li><a href="../263703/index.html">Another hack FL.ru</a></li>
<li><a href="../263705/index.html">Testing serializers for .NET</a></li>
<li><a href="../263707/index.html">Who are the content hackers?</a></li>
<li><a href="../263711/index.html">SysLogViewer - simplify the process of analyzing AudioCodes logs</a></li>
<li><a href="../263713/index.html">Evolution of the Top Story application interface</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>