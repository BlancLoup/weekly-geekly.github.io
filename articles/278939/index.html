<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Our experience with Docker</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Instead of the preface 



 Today I had a dream, as if I had been squeezed down to the size of several 
 kilobyte, stuck in some socket and run in a c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Our experience with Docker</h1><div class="post__text post__text-html js-mediator-article"><h2>  Instead of the preface </h2><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/82d/f33/e64/82df33e643754a4687efc99effa66bef.png"></div><br><br><blockquote>  <i>Today I had a dream, as if I had been squeezed down to the size of several</i> <i><br></i>  <i>kilobyte, stuck in some socket and run in a container.</i> <i><br></i>  <i>Highlighted transport in the overlay network and allowed</i> <i><br></i>  <i>test services in other containers ...</i> <i><br></i>  <i>Docker rm is not done yet.</i> </blockquote>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Not so long ago I was lucky to become a member of a very cool team. <br>  <a href="http://centos-admin.ru/">Centos-admin.ru</a> , in which I met people like me: like-minded people with a passion for new technologies, enthusiasts and just great guys.  And now, on the second working day, my colleague and I were put to work on a single project, in which it was necessary to ‚Äúdock everything that could be verified‚Äù and it was critically important to ensure high availability of services. <br><br>  I will say right away that before this I was an ordinary Linux-admin room: I ran uptime, upt-get-installed packages, rules configs, restarted services, taylit logs.  In general, he did not have particularly outstanding practical skills; he knew absolutely nothing about the concept of <a href="http://www.tomsitpro.com/articles/openstack-pets-and-cattle,1-1759.html">The Pets vs.</a>  <a href="http://www.tomsitpro.com/articles/openstack-pets-and-cattle,1-1759.html">Cattle</a> , was practically not familiar with Docker and in general was very poorly aware of what opportunities he hides.  And from automation tools I used only ansible for setting up servers and various bash-scripts. <br><br><a name="habracut"></a><br><br>  Based on the experience that we managed to get when working with this project, I would like to share a bit of it. <br><br><br><br><h3>  What tasks our dockerized cluster should solve: </h3><br>  - dynamic infrastructure. <br>  - quick implementation of changes. <br>  - simplify the deployment of applications. <br><br><h3>  Tools used: </h3><br>  - Docker <br>  - Docker swarm (agent + manage) <br>  - Consul <br>  - Registrator <br>  - Consul Template <br>  - Docker compose <br>  - arms <br><br><h2>  Description of tools: </h2><br><br><h3>  Docker </h3><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d03/11a/9fc/d0311a9fc1c542ecb8ed97e47d184583.jpg"></div><br><br>  About Docker already there were many articles, including on Habr√©.  I think it is not necessary to describe in detail what it is. <br>  A tool that makes life easier for everyone.  Developer, tester, system administrator, architect. <br>  Docker allows us to create, launch, deploy almost any application and practically on any platform. <br>  Docker can be compared with git, but not in the context of working with code, but in the context of working with the application as a whole. <br><br>  Here you can talk a lot about the charms of this wonderful product. <br><br><h3>  Docker swarm </h3><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/22e/8c7/7d6/22e8c77d62cc4829b7d8e7b4b4a27c1e.gif"></div><br><br>  Swarm provides the functionality of the logical combination of all our hosts (node) into one cluster. <br>  It works in such a way that we don‚Äôt have to think about on which node we need to launch this or that container.  Swarm does it for us.  We just want to run the application "somewhere out there." <br>  Working with Swarm - we work with a pool of containers.  Swarm uses the Docker API to work with containers. <br><br>  Usually, when working on the command line, it is convenient to specify a variable. <br><pre><code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> DOCKER_HOST=tcp:<span class="hljs-comment"><span class="hljs-comment">//&lt;my_swarm_ip&gt;:3375</span></span></code> </pre> <br>  and use the docker commands as usual, but already working not with the local node, but with the cluster as a whole. <br><br>  Note the <i>--label option</i> .  With it, we can specify the label node.  For example, if we have a machine with SSD disks and we need to start the container with PosrgreSQL no longer ‚Äúsomewhere there‚Äù in the cluster, but on the node where the fast disks are installed. <br><br>  Assign daemon tag label: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> daemon --label com.example.storage=<span class="hljs-string"><span class="hljs-string">"ssd"</span></span></code> </pre> <br>  Run PostgreSQL with a filter for the specified tag: <br><pre> <code class="hljs pgsql">docker run -d -e <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span>:com.example.storage="ssd" postgres</code> </pre> <br><br>  <a href="https://docs.docker.com/swarm/scheduler/filter/">More about filters</a> <br><br>  It is also worth considering a parameter like <i>startegy</i> in a Swarm cluster.  This parameter allows you to more efficiently distribute the load between the nodes of the cluster. <br>  Node, you can assign three parameters to <i>strategy</i> : <br><br>  - spread <br>  It is used by default, unless another <i>strategy</i> parameter is specified.  In this case, the swarm will launch a new container if fewer containers are running on this node than on other nodes.  This parameter does not take into account the state of the containers.  They all can even be stopped, but this node will not be selected to launch a new container on it. <br><br>  - binpack <br>  With this parameter, on the contrary, swarm will try to score each node with containers out of the string.  It also takes into account stopped containers. <br><br>  - random <br>  The name speaks for itself. <br><br><h3>  Consul </h3><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/9a9/4f3/eae/9a94f3eaeb3247a7bdeb62112b16a029.png"></div><br><br>  Consul is another great product from the Mitchell Hashimoto gang, from <a href="https://www.hashicorp.com/">Hashicorp</a> , which makes us happy with such wonderful tools as Vagrant and many others. <br>  Consul performs the role of a distributed consistent storage configurations, which is kept up to date by the registrator. <br>  Consists of agents and servers (server quorum N / 2 + 1).  Agents run on the nodes of the cluster and register services, execute validation scripts, and report the results to the Consul-server. <br>  It is also possible to use Consul as a <a href="https://www.consul.io/intro/getting-started/kv.html">key-value store</a> for more flexible configuration of container links. <br>  In addition, Consul functions as a health-checker on its checklist, which the Registrator also supports. <br>  There is a web-UI in which you can view the status of services, checks, nodes, and, of course, the REST API. <br><br>  It is a little about checks: <br><br>  <b>Script</b> <br><br>  Check script.  The script must return the status code: <br><br>  - Exit code 0 - checking in the status of passing (i.e. everything is good with the service) <br>  - Exit code 1 - Check in the status of warning <br>  - Any other code - Check in failing status <br><br>  Example: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/with-contenv sh RESULT=`redis-cli ping` if [ "$RESULT" = "PONG" ]; then exit 0 fi exit 2</span></span></code> </pre><br><br>  The documentation also gives examples of using something like nagios-plugins. <br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"check"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"mem-util"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Memory utilization"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script"</span></span>: <span class="hljs-string"><span class="hljs-string">"/usr/local/bin/check_mem.py"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"interval"</span></span>: <span class="hljs-string"><span class="hljs-string">"10s"</span></span> } }</code> </pre><br><br>  <a href="https://gist.github.com/mtchavez/e367db8b69aeba363d21">gist.github.com/mtchavez/e367db8b69aeba363d21</a> <br><br>  <b>Tcp</b> <br><br>  Knocks on the socket of the specified hostname / IP address.  Example: <br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"ssh"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"SSH TCP on port 22"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tcp"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1:22"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"interval"</span></span>: <span class="hljs-string"><span class="hljs-string">"10s"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"timeout"</span></span>: <span class="hljs-string"><span class="hljs-string">"1s"</span></span> }</code> </pre><br><br>  <b>HTTP</b> <br><br>  An example of a standard HTTP check: <br><br>  In addition to registering checks through the REST API Consul, checks can be hung when the container is started using the argument -l ( <i>label</i> ) <br>  For example, I'll run a container with django + uwsgi inside: <br><pre> <code class="hljs perl">docker run -p <span class="hljs-number"><span class="hljs-number">8088</span></span>:<span class="hljs-number"><span class="hljs-number">3000</span></span> -d --name uwsgi-worker --<span class="hljs-keyword"><span class="hljs-keyword">link</span></span> consul:consul -l <span class="hljs-string"><span class="hljs-string">"SERVICE_NAME=uwsgi-worker"</span></span> -l <span class="hljs-string"><span class="hljs-string">"SERVICE_TAGS=django"</span></span> \ -l <span class="hljs-string"><span class="hljs-string">"SERVICE_3000_CHECK_HTTP=/"</span></span> -l <span class="hljs-string"><span class="hljs-string">"SERVICE_3000_CHECK_INTERVAL=15s"</span></span> -l <span class="hljs-string"><span class="hljs-string">"SERVICE_3000_CHECK_TIMEOUT=1s"</span></span> uwsgi-worker</code> </pre> <br><br>  In the Consul‚Äôs UI, we‚Äôll see the title of the standard django page.  We see that the verification status is passing, which means that the service is OK. <br><br><img src="https://habrastorage.org/files/e39/10c/043/e3910c043a7941fb8ad299a9356eaddd.png"><br><br>  Or you can make a request to the REST API at http: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">curl</span></span> http://&lt;consul_ip&gt;:8500/v1/health/service/uwsgi-worker | jq .</code> </pre> <br><pre> <code class="hljs json">[ { <span class="hljs-attr"><span class="hljs-attr">"Node"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Node"</span></span>: <span class="hljs-string"><span class="hljs-string">"docker0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Address"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"CreateIndex"</span></span>: <span class="hljs-number"><span class="hljs-number">370</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ModifyIndex"</span></span>: <span class="hljs-number"><span class="hljs-number">159636</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"Service"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"ID"</span></span>: <span class="hljs-string"><span class="hljs-string">"docker0:uwsgi-worker:3000"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Service"</span></span>: <span class="hljs-string"><span class="hljs-string">"uwsgi-worker"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Tags"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"django"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"Address"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Port"</span></span>: <span class="hljs-number"><span class="hljs-number">8088</span></span>, <span class="hljs-attr"><span class="hljs-attr">"EnableTagOverride"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"CreateIndex"</span></span>: <span class="hljs-number"><span class="hljs-number">159631</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ModifyIndex"</span></span>: <span class="hljs-number"><span class="hljs-number">159636</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"Checks"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"Node"</span></span>: <span class="hljs-string"><span class="hljs-string">"docker0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"CheckID"</span></span>: <span class="hljs-string"><span class="hljs-string">"serfHealth"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Serf Health Status"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Status"</span></span>: <span class="hljs-string"><span class="hljs-string">"passing"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Notes"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Output"</span></span>: <span class="hljs-string"><span class="hljs-string">"Agent alive and reachable"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ServiceID"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ServiceName"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"CreateIndex"</span></span>: <span class="hljs-number"><span class="hljs-number">370</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ModifyIndex"</span></span>: <span class="hljs-number"><span class="hljs-number">370</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"Node"</span></span>: <span class="hljs-string"><span class="hljs-string">"docker0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"CheckID"</span></span>: <span class="hljs-string"><span class="hljs-string">"service:docker1:uwsgi-worker:3000"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Service 'uwsgi-worker' check"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Status"</span></span>: <span class="hljs-string"><span class="hljs-string">"passing"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Notes"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Output"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ServiceID"</span></span>: <span class="hljs-string"><span class="hljs-string">"docker0:uwsgi-worker:3000"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ServiceName"</span></span>: <span class="hljs-string"><span class="hljs-string">"uwsgi-worker"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"CreateIndex"</span></span>: <span class="hljs-number"><span class="hljs-number">159631</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ModifyIndex"</span></span>: <span class="hljs-number"><span class="hljs-number">159636</span></span> } ] } ]</code> </pre><br><br>  As long as the HTTP service gives a 2xx response status, Consul considers it to be alive and well.  If the response code is 429 (Too Many Request), the check will be in the Warning state, all other codes will be marked as Failed and the Consul will mark this service as failure. <br>  The default http-check interval is 10 seconds.  You can set a different interval by defining the timeout parameter. <br>  The Consul Template, in turn, based on the result of the test, generates a configuration file for the balancer, with an N-number of healthy workers, and the balancer sends requests to the workers. <br><br>  Register a new check in the consul: <br><pre> <code class="hljs pgsql">curl -XPUT -d @_ssh_check.json http://&lt;consul_ip&gt;:<span class="hljs-number"><span class="hljs-number">8500</span></span>/v1/agent/<span class="hljs-keyword"><span class="hljs-keyword">check</span></span>/register</code> </pre> <br><br>  Where in the <i>ssh_check.json</i> file the <i>check</i> parameters are specified: <br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"ssh"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"SSH TCP on port 22"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tcp"</span></span>: <span class="hljs-string"><span class="hljs-string">"&lt;your_ip&gt;:22"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"interval"</span></span>: <span class="hljs-string"><span class="hljs-string">"10s"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"timeout"</span></span>: <span class="hljs-string"><span class="hljs-string">"1s"</span></span> }</code> </pre><br><br>  Disable verification: <br><pre> <code class="hljs objectivec">curl http:<span class="hljs-comment"><span class="hljs-comment">//&lt;consul_ip&gt;:8500/v1/agent/check/deregister/ssh_check</span></span></code> </pre> <br><br>  Consul's opportunities are very great and, unfortunately, it is problematic to cover them all in one article. <br>  Those interested can refer to the <a href="https://www.consul.io/docs/index.html">official documentation</a> in which there are a lot of examples and everything is described quite well. <br><br><h3>  Registrator </h3><br><br>  Registrator serves as an informer about changes to running Docker containers.  It monitors the lists of containers and makes the appropriate changes to the Consul in case of starting or stopping containers.  Including the creation of new containers Registrator immediately reflects in the list of services in Consul. <br>  He also adds entries for health-check in Consul, based on container metadata. <br>  For example, when starting a container with the command: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> run --restart=unless-stopped -v /root/html:/usr/share/nginx/html:ro --links consul:consul -l <span class="hljs-string"><span class="hljs-string">"SERVICE_NAME=nginx"</span></span> -l <span class="hljs-string"><span class="hljs-string">"SERVICE_TAGS=web"</span></span> -l <span class="hljs-string"><span class="hljs-string">"SERVICE_CHECK_HTTP=/"</span></span> -l <span class="hljs-string"><span class="hljs-string">"SERVICE_CHECK_INTERVAL=15s"</span></span> -l <span class="hljs-string"><span class="hljs-string">"SERVICE_CHECK_TIMEOUT=1s"</span></span> -p <span class="hljs-number"><span class="hljs-number">8080</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span> -d nginx</code> </pre> <br><br>  Registrator will add the nignx service to Consul and create an HTTP check for this service. <br><br>  <a href="http://gliderlabs.com/registrator/latest/user/run/">Read more</a> <br><br><h3>  Consul Template </h3><br><br>  Another great tool from the guys from Hashicorp.  It refers to the Consul and, depending on the state of the parameters / values ‚Äã‚Äãthat are in it, can generate the contents of the files according to their templates, for example, inside the container.  Consul Template can also execute various commands when updating data in Consul. <br>  Example: <br><br>  Nginx: <br><br>  Create a server.conf.ctmpl file <br><pre> <code class="hljs axapta">upstream fpm { least_conn; {{range service <span class="hljs-string"><span class="hljs-string">"php"</span></span>}}<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> {{.Address}}:{{.Port}} max_fails=<span class="hljs-number"><span class="hljs-number">3</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">60</span></span> weight=<span class="hljs-number"><span class="hljs-number">1</span></span>; {{<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>}}<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">65535</span></span>{{end}} } <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> { listen <span class="hljs-number"><span class="hljs-number">80</span></span>; root /var/www/html; <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.php <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.html <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.htm; server_name your.domain.com; sendfile off; location / { } location ~ \.php$ { fastcgi_param SCRIPT_FILENAME $document_root/$fastcgi_script_name; fastcgi_split_path_info ^(.+\.php)(/.+)$; fastcgi_pass fpm; fastcgi_index <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.php; include fastcgi_params; } }</code> </pre><br>  and run Consul Template: <br><pre> <code class="hljs pgsql">consul-<span class="hljs-keyword"><span class="hljs-keyword">template</span></span> -consul &lt;your_consul_ip&gt;:<span class="hljs-number"><span class="hljs-number">8500</span></span> -<span class="hljs-keyword"><span class="hljs-keyword">template</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.conf.ctmpl -once -dry</code> </pre><br>  The -dry parameter displays the resulting config in stdout, the -once parameter runs the consul-template once. <br><pre> <code class="hljs axapta">upstream fpm { least_conn; <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">9000</span></span> max_fails=<span class="hljs-number"><span class="hljs-number">3</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">60</span></span> weight=<span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> { listen <span class="hljs-number"><span class="hljs-number">80</span></span>; root /var/www/html; <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.php <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.html <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.htm; server_name your.domain.com; sendfile off; location / { } location ~ \.php$ { fastcgi_param SCRIPT_FILENAME $document_root/$fastcgi_script_name; fastcgi_split_path_info ^(.+\.php)(/.+)$; fastcgi_pass fpm; fastcgi_index <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.php; include fastcgi_params; } }</code> </pre><br>  As we can see, he asks Consul for IP addresses and ports of services called php and displays the resulting configuration file. <br>  We can maintain the current nginx configuration file: <br><pre> <code class="hljs pgsql">consul-<span class="hljs-keyword"><span class="hljs-keyword">template</span></span> -consul &lt;your_consul_ip&gt;:<span class="hljs-number"><span class="hljs-number">8500</span></span> -<span class="hljs-keyword"><span class="hljs-keyword">template</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.conf.ctmpl:/etc/nginx/conf.d/<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.conf:service nginx reload</code> </pre><br><br>  Thus, Consul Template will monitor the services and transfer them to the nginx config.  In case the service suddenly fell or its port changed, Consul Template will update the configuration file and do nginx reload. <br><br>  It is very convenient to use Consul Template for the balancer (nginx, haproxy). <br>  But this is just one of the user cases in which this wonderful tool can be used. <br><br>  <a href="https://github.com/hashicorp/consul-template">Read more about Consul Template</a> <br><br><h2>  Practice </h2><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/6cc/f05/f23/6ccf05f233de4fe2b99337e027794b7f.jpg"></div><br><br>  So, we have four virtual machines on localhost, Debian 8 Jessie is installed on them, the kernel version is&gt; 3.16, and we have time and desire to learn more about this technology stack and try running some web application in a cluster. <br><br>  Let's raise a simple wordpress blog on them. <br><br>  * <i>Here we omit the TLS configuration time * between the Swarm and Consul nodes.</i> <br><br><h3>  Setting the environment on the node. </h3><br><br>  Add a repository to each virtual machine (hereinafter referred to as node) <br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb http://apt.dockerproject.org/repo debian-jessie main"</span></span> &gt; /etc/apt/sources.<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>.d/docker.<span class="hljs-keyword"><span class="hljs-keyword">list</span></span></code> </pre><br>  And install the necessary packages for our environment. <br><pre> <code class="hljs sql">apt-get <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> ca-certificates apt-<span class="hljs-keyword"><span class="hljs-keyword">key</span></span> adv <span class="hljs-comment"><span class="hljs-comment">--keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D apt-get update apt-get install docker-engine aufs-tools</span></span></code> </pre><br>  Starting the binding on the primary node: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> run --restart=unless-stopped -d -h `hostname` --name consul -v /mnt:/data \ -p `ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">8300</span></span>:<span class="hljs-number"><span class="hljs-number">8300</span></span> \ -p `ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">8301</span></span>:<span class="hljs-number"><span class="hljs-number">8301</span></span> \ -p `ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">8301</span></span>:<span class="hljs-number"><span class="hljs-number">8301</span></span>/udp \ -p `ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">8302</span></span>:<span class="hljs-number"><span class="hljs-number">8302</span></span> \ -p `ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">8302</span></span>:<span class="hljs-number"><span class="hljs-number">8302</span></span>/udp \ -p `ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">8400</span></span>:<span class="hljs-number"><span class="hljs-number">8400</span></span> \ -p <span class="hljs-number"><span class="hljs-number">8500</span></span>:<span class="hljs-number"><span class="hljs-number">8500</span></span> \ -p <span class="hljs-number"><span class="hljs-number">172.17.0.1:53</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span>/udp \ gliderlabs/consul-server -server -rejoin -advertise `ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>` -bootstrap</code> </pre><br>  The <i>--restart = unless-stopped option</i> will keep the container in a running state even when the docker-daemon is restarted, if it has not been manually stopped. <br><br>  After running Consul, you need to correct the startup parameters of docker-daemon in systemd <br>  In the /etc/systemd/system/multi-user.target.wants/docker.service file, the ExecStart line should be reduced to the following form: <br><pre> <code class="hljs ruby">ExecStart=<span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/docker daemon -H fd:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ -H tcp:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/&lt;your_ip&gt;:2375 --storage-driver=aufs --cluster-store=consul:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/&lt;your_ip&gt;:8500 --cluster-advertise &lt;your_ip&gt;:2375</span></span></code> </pre><br>  And then restart the demon <br><pre> <code class="hljs pgsql">systemctl daemon-reload service docker <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span></code> </pre><br>  Check that Consul is up and running: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> ps</code> </pre> <br>  Now run the swarm-manager on the primary node. <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> run --restart=unless-stopped -d \ -p <span class="hljs-number"><span class="hljs-number">3375</span></span>:<span class="hljs-number"><span class="hljs-number">2375</span></span> \ swarm manage \ --replication \ --advertise `ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">3375</span></span> \ consul://`ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">8500</span></span>/</code> </pre><br>  The <i>manage</i> command will start the swarm manager on the node. <br>  The <i>--replication</i> parameter enables replication between the <i>primary</i> and <i>secondary</i> nodes of the cluster. <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> run --restart=unless-stopped -d \ swarm join \ --advertise=`ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">2375</span></span> \ consul://`ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">8500</span></span>/</code> </pre><br>  The join command will add a node to the swarm cluster, on which we will run applications in containers. <br>  Having transferred the Consul address, we will add the option of service discovery. <br><br>  And, of course, the Registrator: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> run --restart=unless-stopped -d \ --name=registrator \ --net=host \ --volume=/var/run/docker.sock:/tmp/docker.sock \ gliderlabs/registrator:latest \ consul://`ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">8500</span></span></code> </pre><br>  Now we proceed to the rest of the nodes. <br><br>  Run Consul: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> run --restart=unless-stopped -d -h `hostname` --name consul -v /mnt:/data \ -p `ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">8300</span></span>:<span class="hljs-number"><span class="hljs-number">8300</span></span> \ -p `ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">8301</span></span>:<span class="hljs-number"><span class="hljs-number">8301</span></span> \ -p `ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">8301</span></span>:<span class="hljs-number"><span class="hljs-number">8301</span></span>/udp \ -p `ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">8302</span></span>:<span class="hljs-number"><span class="hljs-number">8302</span></span> \ -p `ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">8302</span></span>:<span class="hljs-number"><span class="hljs-number">8302</span></span>/udp \ -p `ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">8400</span></span>:<span class="hljs-number"><span class="hljs-number">8400</span></span> \ -p `ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">8500</span></span>:<span class="hljs-number"><span class="hljs-number">8500</span></span> \ -p <span class="hljs-number"><span class="hljs-number">172.17.0.1:53</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span>/udp \ gliderlabs/consul-server -server -rejoin -advertise `ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>` -join &lt;primary_node_ip&gt;</code> </pre><br>  Here, in the <i>-join</i> parameter, <i>you</i> must specify the address of our primary-node, which we configured above. <br><br>  Swarm manager: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> run --restart=unless-stopped -d \ -p <span class="hljs-number"><span class="hljs-number">3375</span></span>:<span class="hljs-number"><span class="hljs-number">2375</span></span> \ swarm manage \ --advertise `ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">3375</span></span> \ consul://`ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">8500</span></span>/</code> </pre><br>  Attach the node to the cluster: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> run --restart=unless-stopped -d \ swarm join \ --advertise=`ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">2375</span></span> \ consul://`ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">8500</span></span>/</code> </pre><br>  And the Registrator for registering services in Consul. <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> run --restart=unless-stopped -d \ --name=registrator \ --net=host \ --volume=/var/run/docker.sock:/tmp/docker.sock \ gliderlabs/registrator:latest \ -ip `ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>` \ consul://`ifconfig eth0 | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>`:<span class="hljs-number"><span class="hljs-number">8500</span></span></code> </pre><br><br><h4>  A little bit about the "quick team" </h4><br>  Restart all containers <br><pre> <code class="hljs sql">docker <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> $(docker ps -aq);docker <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> $(docker ps -aq)</code> </pre> <br>  Remove all containers <br><pre> <code class="hljs sql">docker <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> $(docker ps -aq);docker rm $(docker ps -aq)</code> </pre> <br>  Delete all inactive containers: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> stop $(docker ps -a | grep <span class="hljs-string"><span class="hljs-string">'Exited'</span></span> | awk <span class="hljs-string"><span class="hljs-string">'{print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>) &amp;&amp; docker rm $(docker ps -a | grep <span class="hljs-string"><span class="hljs-string">'Exited'</span></span> | awk <span class="hljs-string"><span class="hljs-string">'{print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span>)</code> </pre> <br>  Delete all volumes (busy not deleted) <br><pre> <code class="hljs mel">docker volume rm $(docker volume <span class="hljs-keyword"><span class="hljs-keyword">ls</span></span> -q);</code> </pre> <br>  Delete all images (busy does not move) <br><pre> <code class="hljs mel">docker rmi $(docker images -q);</code> </pre> <br><br><h3>  Frontend </h3><br><br>  So, our cluster is ready for work and defense.  Let's go back to our primary node and start the front-end balancer. <br>  As I mentioned above, when working on the command line, it is convenient to specify a variable <br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> DOCKER_HOST=tcp:<span class="hljs-comment"><span class="hljs-comment">//&lt;my_swarm_ip&gt;:3375</span></span></code> </pre> <br>  and use the docker commands as usual, but already working not with the local node, but with the cluster as a whole. <br><br>  We will use the image of phusion-baseimage and modify it a bit in the process.  You need to add the Consul Template to it in order for it to keep the nginx configuration file up to date and keep a list of live and working workers in it.  Create the nginx-lb folder and create a Dockerfile file in it of approximately the following content: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> phusion/baseimage:<span class="hljs-number"><span class="hljs-number">0.9</span></span><span class="hljs-number"><span class="hljs-number">.18</span></span> ENV NGINX_VERSION <span class="hljs-number"><span class="hljs-number">1.8</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>~trusty ENV DEBIAN_FRONTEND=noninteractive # Avoid ERROR: invoke-rc.d: <span class="hljs-keyword"><span class="hljs-keyword">policy</span></span>-rc.d denied execution <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">start</span></span>. RUN echo "#!/bin/sh\nexit 0" &gt; /usr/sbin/<span class="hljs-keyword"><span class="hljs-keyword">policy</span></span>-rc.d RUN curl -sS http://nginx.org/keys/nginx_signing.key | sudo apt-key <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> - &amp;&amp; \ echo <span class="hljs-string"><span class="hljs-string">'deb http://nginx.org/packages/ubuntu/ trusty nginx'</span></span> &gt;&gt; /etc/apt/sources.list &amp;&amp; \ echo <span class="hljs-string"><span class="hljs-string">'deb-src http://nginx.org/packages/ubuntu/ trusty nginx'</span></span> &gt;&gt; /etc/apt/sources.list &amp;&amp; \ apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> -qq &amp;&amp; apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install -y unzip ca-certificates nginx=${NGINX_VERSION} &amp;&amp; \ rm -rf /var/lib/apt/lists<span class="hljs-comment"><span class="hljs-comment">/* &amp;&amp; \ ln -sf /dev/stdout /var/log/nginx/access.log &amp;&amp; \ ln -sf /dev/stderr /var/log/nginx/error.log EXPOSE 80 #      Consul Template ADD https://releases.hashicorp.com/consul-template/0.12.2/consul-template_0.12.2_linux_amd64.zip /usr/bin/ RUN unzip /usr/bin/consul-template_0.12.2_linux_amd64.zip -d /usr/local/bin ADD nginx.service /etc/service/nginx/run RUN chmod a+x /etc/service/nginx/run ADD consul-template.service /etc/service/consul-template/run RUN chmod a+x /etc/service/consul-template/run RUN rm -v /etc/nginx/conf.d/*.conf ADD app.conf.ctmpl /etc/consul-templates/app.conf.ctmpl CMD ["/sbin/my_init"]</span></span></code> </pre><br></div></div><br><br>  Now we need to create a nignx startup script.  Create the nginx.service file: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh /usr/sbin/nginx -c /etc/nginx/nginx.conf -t &amp;&amp; \ exec /usr/sbin/nginx -c /etc/nginx/nginx.conf -g "daemon off;"</span></span></code> </pre><br>  And the Consul Template start script: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh exec /usr/local/bin/consul-template \ -consul consul:8500 \ -template "/etc/consul-templates/app.conf.ctmpl:/etc/nginx/conf.d/app.conf:sv hup nginx || true"</span></span></code> </pre><br>  Fine.  Now we need a nginx configuration file for Consul Template.  Create app.conf: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="hljs ruby">upstream fpm { least_conn; {{range service <span class="hljs-string"><span class="hljs-string">"fpm"</span></span>}}server {{.Address}}<span class="hljs-symbol"><span class="hljs-symbol">:</span></span>{{.Port}} max_fails=<span class="hljs-number"><span class="hljs-number">3</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">60</span></span> weight=<span class="hljs-number"><span class="hljs-number">1</span></span>; {{<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>}}server <span class="hljs-number"><span class="hljs-number">127.0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">65535</span></span>{{<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>}} } server { listen <span class="hljs-number"><span class="hljs-number">80</span></span>; root /var/www/html; index index.php index.html index.htm; server_name domain.example.com; sendfile off; location / { try_files $uri $uri/ <span class="hljs-regexp"><span class="hljs-regexp">/index.php?q=$uri&amp;$args; } location /doc</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ { alias /usr</span></span><span class="hljs-regexp"><span class="hljs-regexp">/share/doc</span></span><span class="hljs-regexp"><span class="hljs-regexp">/; autoindex on; allow 127.0.0.1; allow ::1; deny all; } error_page 500 502 503 504 /</span></span><span class="hljs-number"><span class="hljs-number">50</span></span>x.html; location = <span class="hljs-regexp"><span class="hljs-regexp">/50x.html { root /usr</span></span><span class="hljs-regexp"><span class="hljs-regexp">/share/nginx</span></span><span class="hljs-regexp"><span class="hljs-regexp">/www; } location ~ \.php$ { try_files $uri =404; fastcgi_param SCRIPT_FILENAME $document_root/</span></span>$fastcgi_script_name; fastcgi_split_path_info ^(.+\.php)(<span class="hljs-regexp"><span class="hljs-regexp">/.+)$; fastcgi_pass fpm; fastcgi_index index.php; include fastcgi_params; } location ~ /</span></span>\.ht { deny all; } }</code> </pre><br></div></div><br><br>  Now we need to collect the modified image: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> build -t nginx-lb .</code> </pre> <br>  We have two options: to collect this image on each node of the cluster with our hands or to upload it to the free <a href="https://hub.docker.com/">Docker Hub cloud</a> , from where it can be taken anytime and from any place without unnecessary gestures.  Or in your personal <a href="https://docs.docker.com/registry/deploying/">Docker Registry.</a> <a href="https://docs.docker.com/registry/deploying/"><br></a>  <a href="https://docs.docker.com/registry/deploying/">Working with the Docker Hub is described in great detail in the</a> <a href="https://docs.docker.com/docker-hub/overview/">documentation</a> . <br><br>  Now is the time to see what happened.  We start the container: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> run -p <span class="hljs-number"><span class="hljs-number">80</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span> -v /mnt/storage/www:/var/www/html -d --name balancer --link consul:consul -l <span class="hljs-string"><span class="hljs-string">"SERVICE_NAME=balancer"</span></span> -l <span class="hljs-string"><span class="hljs-string">"SERVICE_TAGS=balancer"</span></span> \ -l <span class="hljs-string"><span class="hljs-string">"SERVICE_CHECK_HTTP=/"</span></span> -l <span class="hljs-string"><span class="hljs-string">"SERVICE_CHECK_INTERVAL=15s"</span></span> -l <span class="hljs-string"><span class="hljs-string">"SERVICE_CHECK_TIMEOUT=1s"</span></span> nginx-lb</code> </pre><br>  Check by poking at the browser.  Yes, he will give Bad Gateway, because  we have no static or backend. <br><br><h3>  Backend </h3><br><br>  Great, we figured out the front end.  Now someone has to process php-code.  This will help us a <a href="https://github.com/docker-library/wordpress/tree/master/fpm">WordPress image with FPM</a> <br>  Here we also need to correct the image a little.  Namely - add Consul Template to detect MySQL servers.  We don‚Äôt want to search every time on which node the database server is running and specify its address manually when launching the image?  It takes not very much time, but we are lazy, and ‚Äúlaziness is the engine of progress‚Äù (c). <br><br><div class="spoiler">  <b class="spoiler_title">Dockerfile</b> <div class="spoiler_text"><pre> <code class="hljs tex">FROM php:5.6-fpm # install the PHP extensions we need RUN apt-get update &amp;&amp; apt-get install -y unzip libpng12-dev libjpeg-dev &amp;&amp; rm -rf /var/lib/apt/lists/* <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&amp;&amp; docker-php-ext-configure gd --with-png-dir=/usr --with-jpeg-dir=/usr <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&amp;&amp; docker-php-ext-install gd mysqli opcache # set recommended PHP.ini settings # see https://secure.php.net/manual/en/opcache.installation.php RUN { <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>echo 'opcache.memory_consumption=128'; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>echo 'opcache.interned_strings_buffer=8'; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>echo 'opcache.max_accelerated_files=4000'; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>echo 'opcache.revalidate_freq=60'; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>echo 'opcache.fast_shutdown=1'; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>echo 'opcache.enable_cli=1'; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>} &gt; /usr/local/etc/php/conf.d/opcache-recommended.ini VOLUME /var/www/html ENV WORDPRESS_VERSION 4.4.2 ENV WORDPRESS_SHA1 7444099fec298b599eb026e83227462bcdf312a6 # upstream tarballs include ./wordpress/ so this gives us /usr/src/wordpress RUN curl -o wordpress.tar.gz -SL https://wordpress.org/wordpress-<span class="hljs-formula"><span class="hljs-formula">${WORDPRESS_VERSION}.tar.gz </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">&amp;&amp; echo "$</span></span>WORDPRESS_SHA1 *wordpress.tar.gz" | sha1sum -c - <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&amp;&amp; tar -xzf wordpress.tar.gz -C /usr/src/ <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&amp;&amp; rm wordpress.tar.gz <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&amp;&amp; chown -R www-data:www-data /usr/src/wordpress ADD https://releases.hashicorp.com/consul-template/0.12.2/consul-template_0.12.2_linux_amd64.zip /usr/bin/ RUN unzip /usr/bin/consul-template_0.12.2_linux_amd64.zip -d /usr/local/bin #    . ADD db.conf.php.ctmpl /db.conf.php.ctmpl #    consul-template ADD consul-template.sh /usr/local/bin/consul-template.sh #    MySQL      WP ADD mysql.ctmpl /tmp/mysql.ctmpl COPY docker-entrypoint.sh /entrypoint.sh # grr, ENTRYPOINT resets CMD now ENTRYPOINT ["/entrypoint.sh"] CMD ["php-fpm"]</code> </pre><br></div></div><br><br>  Create a MySQL settings template db.conf.php.ctmpl: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> {{range service <span class="hljs-string"><span class="hljs-string">"mysql"</span></span>}} define(<span class="hljs-string"><span class="hljs-string">'DB_HOST'</span></span>, <span class="hljs-string"><span class="hljs-string">'{{.Address}}'</span></span>); {{<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>}} define(<span class="hljs-string"><span class="hljs-string">'DB_HOST'</span></span>, <span class="hljs-string"><span class="hljs-string">'mysql'</span></span>); {{end}} <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br>  And the consul-template.sh startup script: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh echo "Starting Consul Template" exec /usr/local/bin/consul-template \ -consul consul:8500 \ -template "/db.conf.php.ctmpl:/var/www/html/db.conf.php"</span></span></code> </pre><br><br>  MySQL server mysql.ctmpl detection template: <br><pre> <code class="hljs django"><span class="xml"></span><span class="hljs-template-variable"><span class="xml"></span><span class="hljs-template-variable">{{range service "mysql"}}</span></span><span class="xml"></span><span class="hljs-template-variable"><span class="xml"></span><span class="hljs-template-variable">{{.Address}}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{.Port}}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{end}}</span></span><span class="xml"></span><span class="xml"></span></code> </pre><br>  In the <i>docker-entrypoint.sh</i> script <i>,</i> we should fix a few things.  Namely, connect the Consul Template to detect the MySQL server and move fpm to <i>0.0.0.0</i> , because by default it listens only to 127.0.0.1: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash set -e #    WORDPRESS_DB_HOST="$(/usr/local/bin/consul-template --template=/tmp/mysql-master.ctmpl --consul=consul:8500 --dry -once | awk '{print $1}' | tail -1)" #    WORDPRESS_DB_PORT="$(/usr/local/bin/consul-template --template=/tmp/mysql-master.ctmpl --consul=consul:8500 --dry -once | awk '{print $2}' | tail -1)" if [[ "$1" == apache2* ]] || [ "$1" == php-fpm ]; then if [ -n "$MYSQL_PORT_3306_TCP" ]; then if [ -z "$WORDPRESS_DB_HOST" ]; then WORDPRESS_DB_HOST='mysql' else echo &gt;&amp;2 'warning: both WORDPRESS_DB_HOST and MYSQL_PORT_3306_TCP found' echo &gt;&amp;2 " Connecting to WORDPRESS_DB_HOST ($WORDPRESS_DB_HOST)" echo &gt;&amp;2 ' instead of the linked mysql container' fi fi if [ -z "$WORDPRESS_DB_HOST" ]; then echo &gt;&amp;2 'error: missing WORDPRESS_DB_HOST and MYSQL_PORT_3306_TCP environment variables' echo &gt;&amp;2 ' Did you forget to --link some_mysql_container:mysql or set an external db' echo &gt;&amp;2 ' with -e WORDPRESS_DB_HOST=hostname:port?' exit 1 fi # if we're linked to MySQL and thus have credentials already, let's use them : ${WORDPRESS_DB_USER:=${MYSQL_ENV_MYSQL_USER:-root}} if [ "$WORDPRESS_DB_USER" = 'root' ]; then : ${WORDPRESS_DB_PASSWORD:=$MYSQL_ENV_MYSQL_ROOT_PASSWORD} fi : ${WORDPRESS_DB_PASSWORD:=$MYSQL_ENV_MYSQL_PASSWORD} : ${WORDPRESS_DB_NAME:=${MYSQL_ENV_MYSQL_DATABASE:-wordpress}} if [ -z "$WORDPRESS_DB_PASSWORD" ]; then echo &gt;&amp;2 'error: missing required WORDPRESS_DB_PASSWORD environment variable' echo &gt;&amp;2 ' Did you forget to -e WORDPRESS_DB_PASSWORD=... ?' echo &gt;&amp;2 echo &gt;&amp;2 ' (Also of interest might be WORDPRESS_DB_USER and WORDPRESS_DB_NAME.)' exit 1 fi if ! [ -e index.php -a -e wp-includes/version.php ]; then echo &gt;&amp;2 "WordPress not found in $(pwd) - copying now..." if [ "$(ls -A)" ]; then echo &gt;&amp;2 "WARNING: $(pwd) is not empty - press Ctrl+C now if this is an error!" ( set -x; ls -A; sleep 10 ) fi tar cf - --one-file-system -C /usr/src/wordpress . | tar xf - echo &gt;&amp;2 "Complete! WordPress has been successfully copied to $(pwd)" if [ ! -e .htaccess ]; then # </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">NOTE:</span></span></span><span class="hljs-comment"> The "Indexes" option is disabled in the php:apache base image cat &gt; .htaccess &lt;&lt;-'EOF' # BEGIN WordPress &lt;IfModule mod_rewrite.c&gt; RewriteEngine On RewriteBase / RewriteRule ^index\.php$ - [L] RewriteCond %{REQUEST_FILENAME} !-f RewriteCond %{REQUEST_FILENAME} !-d RewriteRule . /index.php [L] &lt;/IfModule&gt; # END WordPress EOF chown www-data:www-data .htaccess fi fi # TODO handle WordPress upgrades magically in the same way, but only if wp-includes/version.php's $wp_version is less than /usr/src/wordpress/wp-includes/version.php's $wp_version # version 4.4.1 decided to switch to windows line endings, that breaks our seds and awks # https://github.com/docker-library/wordpress/issues/116 # https://github.com/WordPress/WordPress/commit/1acedc542fba2482bab88ec70d4bea4b997a92e4 sed -ri 's/\r\n|\r/\n/g' wp-config* # FPM   0.0.0.0 sed -i 's/listen = 127.0.0.1:9000/listen = 0.0.0.0:9000/g' /usr/local/etc/php-fpm.d/www.conf if [ ! -e wp-config.php ]; then awk '/^\/\*.*stop editing.*\*\/$/ &amp;&amp; c == 0 { c = 1; system("cat") } { print }' wp-config-sample.php &gt; wp-config.php &lt;&lt;'EOPHP' // If we're behind a proxy server and using HTTPS, we need to alert Wordpress of that fact // see also http://codex.wordpress.org/Administration_Over_SSL#Using_a_Reverse_Proxy if (isset($_SERVER['HTTP_X_FORWARDED_PROTO']) &amp;&amp; $_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https') { $_SERVER['HTTPS'] = 'on'; } EOPHP #   Consul Template    MySQL DB_HOST_PRE=$(grep 'DB_HOST' wp-config.php) sed -i "s/$DB_HOST_PRE/include 'db.conf.php';/g" wp-config.php chown www-data:www-data wp-config.php fi # see http://stackoverflow.com/a/2705678/433558 sed_escape_lhs() { echo "$@" | sed 's/[]\/$*.^|[]/\\&amp;/g' } sed_escape_rhs() { echo "$@" | sed 's/[\/&amp;]/\\&amp;/g' } php_escape() { php -r 'var_export(('$2') $argv[1]);' "$1" } set_config() { key="$1" value="$2" var_type="${3:-string}" start="(['\"])$(sed_escape_lhs "$key")\2\s*," end="\);" if [ "${key:0:1}" = '$' ]; then start="^(\s*)$(sed_escape_lhs "$key")\s*=" end=";" fi sed -ri "s/($start\s*).*($end)$/\1$(sed_escape_rhs "$(php_escape "$value" "$var_type")")\3/" wp-config.php } set_config 'DB_HOST' "$WORDPRESS_DB_HOST" set_config 'DB_USER' "$WORDPRESS_DB_USER" set_config 'DB_PASSWORD' "$WORDPRESS_DB_PASSWORD" set_config 'DB_NAME' "$WORDPRESS_DB_NAME" # allow any of these "Authentication Unique Keys and Salts." to be specified via # environment variables with a "WORDPRESS_" prefix (ie, "WORDPRESS_AUTH_KEY") UNIQUES=( AUTH_KEY SECURE_AUTH_KEY LOGGED_IN_KEY NONCE_KEY AUTH_SALT SECURE_AUTH_SALT LOGGED_IN_SALT NONCE_SALT ) for unique in "${UNIQUES[@]}"; do eval unique_value=\$WORDPRESS_$unique if [ "$unique_value" ]; then set_config "$unique" "$unique_value" else # if not specified, let's generate a random value current_set="$(sed -rn "s/define\((([\'\"])$unique\2\s*,\s*)(['\"])(.*)\3\);/\4/p" wp-config.php)" if [ "$current_set" = 'put your unique phrase here' ]; then set_config "$unique" "$(head -c1M /dev/urandom | sha1sum | cut -d' ' -f1)" fi fi done if [ "$WORDPRESS_TABLE_PREFIX" ]; then set_config '$table_prefix' "$WORDPRESS_TABLE_PREFIX" fi if [ "$WORDPRESS_DEBUG" ]; then set_config 'WP_DEBUG' 1 boolean fi TERM=dumb php -- "$WORDPRESS_DB_HOST" "$WORDPRESS_DB_USER" "$WORDPRESS_DB_PASSWORD" "$WORDPRESS_DB_NAME" &lt;&lt;'EOPHP' &lt;?php // database might not exist, so let's try creating it (just to be safe) $stderr = fopen('php://stderr', 'w'); list($host, $port) = explode(':', $argv[1], 2); $maxTries = 10; do { $mysql = new mysqli($host, $argv[2], $argv[3], '', (int)$port); if ($mysql-&gt;connect_error) { fwrite($stderr, "\n" . 'MySQL Connection Error: (' . $mysql-&gt;connect_errno . ') ' . $mysql-&gt;connect_error . "\n"); --$maxTries; if ($maxTries &lt;= 0) { exit(1); } sleep(3); } } while ($mysql-&gt;connect_error); if (!$mysql-&gt;query('CREATE DATABASE IF NOT EXISTS `' . $mysql-&gt;real_escape_string($argv[4]) . '`')) { fwrite($stderr, "\n" . 'MySQL "CREATE DATABASE" Error: ' . $mysql-&gt;error . "\n"); $mysql-&gt;close(); exit(1); } $mysql-&gt;close(); EOPHP fi #  consul-template exec /usr/local/sbin/php-fpm &amp; exec /usr/local/bin/consul-template.sh exec "$@"</span></span></code> </pre><br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Well, now we will collect an image: </font></font><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> build -t fpm .</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It‚Äôs not worth running yet, since we don‚Äôt have a database server for full Wordpress work yet. </font></font><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> run --name fpm.<span class="hljs-number"><span class="hljs-number">0</span></span> -d -v /mnt/storage/www:/var/www/html \ -e WORDPRESS_DB_NAME=wordpressp -e WORDPRESS_DB_USER=wordpress -e WORDPRESS_DB_PASSWORD=wordpress \ --link consul:consul -l <span class="hljs-string"><span class="hljs-string">"SERVICE_NAME=php-fpm"</span></span> -l <span class="hljs-string"><span class="hljs-string">"SERVICE_PORT=9000"</span></span> -p <span class="hljs-number"><span class="hljs-number">9000</span></span>:<span class="hljs-number"><span class="hljs-number">9000</span></span> fpm</code> </pre><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Database: </font></font></h3><br><br><h4>  Master </h4><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a database, we use the </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL 5.7</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> image </font><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We also need to fix it a little. </font><font style="vertical-align: inherit;">Namely: to make two images. </font><font style="vertical-align: inherit;">One - for the Master, the second - for the Slave. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's start with the image for the Master.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Our Dockerfile</font></font></b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> debian:jessie # <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> our <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> first <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> make sure their IDs <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> assigned consistently, regardless <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> whatever dependencies <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> added RUN groupadd -r mysql &amp;&amp; useradd -r -g mysql mysql RUN mkdir /docker-entrypoint-initdb.d # FATAL ERROR: please install the <span class="hljs-keyword"><span class="hljs-keyword">following</span></span> Perl modules <span class="hljs-keyword"><span class="hljs-keyword">before</span></span> executing /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/mysql/scripts/mysql_install_db: # File::Basename # File::<span class="hljs-keyword"><span class="hljs-keyword">Copy</span></span> # Sys::Hostname # Data::Dumper RUN apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> &amp;&amp; apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install -y perl pwgen <span class="hljs-comment"><span class="hljs-comment">--no-install-recommends &amp;&amp; rm -rf /var/lib/apt/lists/* # gpg: key 5072E1F5: public key "MySQL Release Engineering &lt;mysql-build@oss.oracle.com&gt;" imported RUN apt-key adv --keyserver ha.pool.sks-keyservers.net --recv-keys A4A9406876FCBD3C456770C88C718D3B5072E1F5 ENV MYSQL_MAJOR 5.7 ENV MYSQL_VERSION 5.7.11-1debian8 RUN echo "deb http://repo.mysql.com/apt/debian/ jessie mysql-${MYSQL_MAJOR}" &gt; /etc/apt/sources.list.d/mysql.list # the "/var/lib/mysql" stuff here is because the mysql-server postinst doesn't have an explicit way to disable the mysql_install_db codepath besides having a database already "configured" (ie, stuff in /var/lib/mysql/mysql) # also, we set debconf keys to make APT a little quieter RUN { \ echo mysql-community-server mysql-community-server/data-dir select ''; \ echo mysql-community-server mysql-community-server/root-pass password ''; \ echo mysql-community-server mysql-community-server/re-root-pass password ''; \ echo mysql-community-server mysql-community-server/remove-test-db select false; \ } | debconf-set-selections \ &amp;&amp; apt-get update &amp;&amp; apt-get install -y mysql-server="${MYSQL_VERSION}" &amp;&amp; rm -rf /var/lib/apt/lists/* \ &amp;&amp; rm -rf /var/lib/mysql &amp;&amp; mkdir -p /var/lib/mysql # comment out a few problematic configuration values # don't reverse lookup hostnames, they are usually another container RUN sed -Ei 's/^(bind-address|log)/#&amp;/' /etc/mysql/my.cnf \ &amp;&amp; echo 'skip-host-cache\nskip-name-resolve' | awk '{ print } $1 == "[mysqld]" &amp;&amp; c == 0 { c = 1; system("cat") }' /etc/mysql/my.cnf &gt; /tmp/my.cnf \ &amp;&amp; mv /tmp/my.cnf /etc/mysql/my.cnf VOLUME /var/lib/mysql COPY docker-entrypoint.sh /entrypoint.sh ENTRYPOINT ["/entrypoint.sh"] EXPOSE 3306 CMD ["mysqld"]</span></span></code> </pre><br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MySQL startup script: </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docker-entrypoint.sh</font></font></b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash set -eo pipefail # if command starts with an option, prepend mysqld if [ "${1:0:1}" = '-' ]; then set -- mysqld "$@" fi if [ "$1" = 'mysqld' ]; then # Get config DATADIR="$("$@" --verbose --help 2&gt;/dev/null | awk '$1 == "datadir" { print $2; exit }')" if [ ! -d "$DATADIR/mysql" ]; then if [ -z "$MYSQL_ROOT_PASSWORD" -a -z "$MYSQL_ALLOW_EMPTY_PASSWORD" -a -z "$MYSQL_RANDOM_ROOT_PASSWORD" ]; then echo &gt;&amp;2 'error: database is uninitialized and password option is not specified ' echo &gt;&amp;2 ' You need to specify one of MYSQL_ROOT_PASSWORD, MYSQL_ALLOW_EMPTY_PASSWORD and MYSQL_RANDOM_ROOT_PASSWORD' exit 1 fi mkdir -p "$DATADIR" chown -R mysql:mysql "$DATADIR" echo 'Initializing database' "$@" --initialize-insecure echo 'Database initialized' "$@" --skip-networking &amp; pid="$!" mysql=( mysql --protocol=socket -uroot ) for i in {30..0}; do if echo 'SELECT 1' | "${mysql[@]}" &amp;&gt; /dev/null; then break fi echo 'MySQL init process in progress...' sleep 1 done if [ "$i" = 0 ]; then echo &gt;&amp;2 'MySQL init process failed.' exit 1 fi if [ -n "${REPLICATION_MASTER}" ]; then echo "=&gt; Configuring MySQL replication as master (1/2) ..." if [ ! -f /replication_set.1 ]; then echo "=&gt; Writting configuration file /etc/mysql/my.cnf with server-id=1" echo 'server-id = 1' &gt;&gt; /etc/mysql/my.cnf echo 'log-bin = mysql-bin' &gt;&gt; /etc/mysql/my.cnf touch /replication_set.1 else echo "=&gt; MySQL replication master already configured, skip" fi fi # Set MySQL REPLICATION - SLAVE if [ -n "${REPLICATION_SLAVE}" ]; then echo "=&gt; Configuring MySQL replication as slave (1/2) ..." if [ -n "${MYSQL_PORT_3306_TCP_ADDR}" ] &amp;&amp; [ -n "${MYSQL_PORT_3306_TCP_PORT}" ]; then if [ ! -f /replication_set.1 ]; then echo "=&gt; Writting configuration file /etc/mysql/my.cnf with server-id=2" echo 'server-id = 2' &gt;&gt; /etc/mysql/my.cnf echo 'log-bin = mysql-bin' &gt;&gt; /etc/mysql/my.cnf echo 'log-bin=slave-bin' &gt;&gt; /etc/mysql/my.cnf touch /replication_set.1 else echo "=&gt; MySQL replication slave already configured, skip" fi else echo "=&gt; Cannot configure slave, please link it to another MySQL container with alias as 'mysql'" exit 1 fi fi # Set MySQL REPLICATION - SLAVE if [ -n "${REPLICATION_SLAVE}" ]; then echo "=&gt; Configuring MySQL replication as slave (2/2) ..." if [ -n "${MYSQL_PORT_3306_TCP_ADDR}" ] &amp;&amp; [ -n "${MYSQL_PORT_3306_TCP_PORT}" ]; then if [ ! -f /replication_set.2 ]; then echo "=&gt; Setting master connection info on slave" echo "!!! DE</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">BUG:</span></span></span><span class="hljs-comment"> ${REPLICATION_USER}, ${REPLICATION_PASS}." "${mysql[@]}" &lt;&lt;-EOSQL -- What's done in this file shouldn't be replicated -- or products like mysql-fabric won't work SET @@SESSION.SQL_LOG_BIN=0; CHANGE MASTER TO MASTER_HOST='${MYSQL_PORT_3306_TCP_ADDR}',MASTER_USER='${REPLICATION_USER}',MASTER_PASSWORD='${REPLICATION_PASS}',MASTER_PORT=${MYSQL_PORT_3306_TCP_PORT}, MASTER_CONNECT_RETRY=30; START SLAVE ; EOSQL echo "=&gt; Done!" touch /replication_set.2 else echo "=&gt; MySQL replication slave already configured, skip" fi else echo "=&gt; Cannot configure slave, please link it to another MySQL container with alias as 'mysql'" exit 1 fi fi if [ -z "$MYSQL_INITDB_SKIP_TZINFO" ]; then # sed is for https://bugs.mysql.com/bug.php?id=20545 mysql_tzinfo_to_sql /usr/share/zoneinfo | sed 's/Local time zone must be set--see zic manual page/FCTY/' | "${mysql[@]}" mysql fi if [ ! -z "$MYSQL_RANDOM_ROOT_PASSWORD" ]; then MYSQL_ROOT_PASSWORD="$(pwgen -1 32)" echo "GENERATED ROOT PASSWORD: $MYSQL_ROOT_PASSWORD" fi "${mysql[@]}" &lt;&lt;-EOSQL -- What's done in this file shouldn't be replicated -- or products like mysql-fabric won't work SET @@SESSION.SQL_LOG_BIN=0; DELETE FROM mysql.user ; CREATE USER 'root'@'%' IDENTIFIED BY '${MYSQL_ROOT_PASSWORD}' ; GRANT ALL ON *.* TO 'root'@'%' WITH GRANT OPTION ; DROP DATABASE IF EXISTS test ; FLUSH PRIVILEGES ; EOSQL if [ ! -z "$MYSQL_ROOT_PASSWORD" ]; then mysql+=( -p"${MYSQL_ROOT_PASSWORD}" ) fi # Set MySQL REPLICATION - MASTER if [ -n "${REPLICATION_MASTER}" ]; then echo "=&gt; Configuring MySQL replication as master (2/2) ..." if [ ! -f /replication_set.2 ]; then echo "=&gt; Creating a log user ${REPLICATION_USER}:${REPLICATION_PASS}" "${mysql[@]}" &lt;&lt;-EOSQL -- What's done in this file shouldn't be replicated -- or products like mysql-fabric won't work SET @@SESSION.SQL_LOG_BIN=0; CREATE USER '${REPLICATION_USER}'@'%' IDENTIFIED BY '${REPLICATION_PASS}'; GRANT REPLICATION SLAVE ON *.* TO '${REPLICATION_USER}'@'%' ; FLUSH PRIVILEGES ; RESET MASTER ; EOSQL echo "=&gt; Done!" touch /replication_set.2 else echo "=&gt; MySQL replication master already configured, skip" fi fi if [ "$MYSQL_DATABASE" ]; then echo "CREATE DATABASE IF NOT EXISTS \`$MYSQL_DATABASE\` ;" | "${mysql[@]}" mysql+=( "$MYSQL_DATABASE" ) fi if [ "$MYSQL_USER" -a "$MYSQL_PASSWORD" ]; then echo "CREATE USER '$MYSQL_USER'@'%' IDENTIFIED BY '$MYSQL_PASSWORD' ;" | "${mysql[@]}" if [ "$MYSQL_DATABASE" ]; then echo "GRANT ALL ON \`$MYSQL_DATABASE\`.* TO '$MYSQL_USER'@'%' ;" | "${mysql[@]}" fi echo 'FLUSH PRIVILEGES ;' | "${mysql[@]}" fi echo for f in /docker-entrypoint-initdb.d/*; do case "$f" in *.sh) echo "$0: running $f"; . "$f" ;; *.sql) echo "$0: running $f"; "${mysql[@]}" &lt; "$f"; echo ;; *.sql.gz) echo "$0: running $f"; gunzip -c "$f" | "${mysql[@]}"; echo ;; *) echo "$0: ignoring $f" ;; esac echo done if [ ! -z "$MYSQL_ONETIME_PASSWORD" ]; then "${mysql[@]}" &lt;&lt;-EOSQL ALTER USER 'root'@'%' PASSWORD EXPIRE; EOSQL fi if ! kill -s TERM "$pid" || ! wait "$pid"; then echo &gt;&amp;2 'MySQL init process failed.' exit 1 fi echo echo 'MySQL init process done. Ready for start up.' echo fi chown -R mysql:mysql "$DATADIR" fi exec "$@"</span></span></code> </pre><br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And build: </font></font><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> build -t mysql-master .</code> </pre><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> run --name mysql-master.<span class="hljs-number"><span class="hljs-number">0</span></span> -v /mnt/volumes/master:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=rootpass -e MYSQL_USER=wordpress -e MYSQL_PASSWORD=wordpress -e MYSQL_DB=wordpress -e REPLICATION_MASTER=<span class="hljs-literal"><span class="hljs-literal">true</span></span> -e REPLICATION_USER=replica -e REPLICATION_PASS=replica --link consul:consul -l <span class="hljs-string"><span class="hljs-string">"SERVICE_NAME=master"</span></span> -l <span class="hljs-string"><span class="hljs-string">"SERVICE_PORT=3306"</span></span> -p <span class="hljs-number"><span class="hljs-number">3306</span></span>:<span class="hljs-number"><span class="hljs-number">3306</span></span> -d mysql-master</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> If you noticed, we added to the script the ability to pass startup parameters to configure MySQL replication (REPLICATION_USER, REPLICATION_PASS, REPLICATION_MASTER, REPLICATION_SLAVE). </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Slave </font></font></h4><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will make the Slave image in such a way that MySQL itself finds the Master server and includes replication. </font><font style="vertical-align: inherit;">Here again Consul Template comes to our rescue:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dockerfile</font></font></b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> debian:jessie # <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> our <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> first <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> make sure their IDs <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> assigned consistently, regardless <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> whatever dependencies <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> added RUN groupadd -r mysql &amp;&amp; useradd -r -g mysql mysql RUN mkdir /docker-entrypoint-initdb.d # FATAL ERROR: please install the <span class="hljs-keyword"><span class="hljs-keyword">following</span></span> Perl modules <span class="hljs-keyword"><span class="hljs-keyword">before</span></span> executing /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/mysql/scripts/mysql_install_db: # File::Basename # File::<span class="hljs-keyword"><span class="hljs-keyword">Copy</span></span> # Sys::Hostname # Data::Dumper RUN apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> &amp;&amp; apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install -y perl pwgen <span class="hljs-comment"><span class="hljs-comment">--no-install-recommends &amp;&amp; rm -rf /var/lib/apt/lists/* # gpg: key 5072E1F5: public key "MySQL Release Engineering &lt;mysql-build@oss.oracle.com&gt;" imported RUN apt-key adv --keyserver ha.pool.sks-keyservers.net --recv-keys A4A9406876FCBD3C456770C88C718D3B5072E1F5 ENV MYSQL_MAJOR 5.7 ENV MYSQL_VERSION 5.7.11-1debian8 RUN echo "deb http://repo.mysql.com/apt/debian/ jessie mysql-${MYSQL_MAJOR}" &gt; /etc/apt/sources.list.d/mysql.list # the "/var/lib/mysql" stuff here is because the mysql-server postinst doesn't have an explicit way to disable the mysql_install_db codepath besides having a database already "configured" (ie, stuff in /var/lib/mysql/mysql) # also, we set debconf keys to make APT a little quieter RUN { \ echo mysql-community-server mysql-community-server/data-dir select ''; \ echo mysql-community-server mysql-community-server/root-pass password ''; \ echo mysql-community-server mysql-community-server/re-root-pass password ''; \ echo mysql-community-server mysql-community-server/remove-test-db select false; \ } | debconf-set-selections \ &amp;&amp; apt-get update &amp;&amp; apt-get install -y mysql-server="${MYSQL_VERSION}" &amp;&amp; rm -rf /var/lib/apt/lists/* \ &amp;&amp; rm -rf /var/lib/mysql &amp;&amp; mkdir -p /var/lib/mysql # comment out a few problematic configuration values # don't reverse lookup hostnames, they are usually another container RUN sed -Ei 's/^(bind-address|log)/#&amp;/' /etc/mysql/my.cnf \ &amp;&amp; echo 'skip-host-cache\nskip-name-resolve' | awk '{ print } $1 == "[mysqld]" &amp;&amp; c == 0 { c = 1; system("cat") }' /etc/mysql/my.cnf &gt; /tmp/my.cnf \ &amp;&amp; mv /tmp/my.cnf /etc/mysql/my.cnf ADD https://releases.hashicorp.com/consul-template/0.12.2/consul-template_0.12.2_linux_amd64.zip /usr/bin/ RUN unzip /usr/bin/consul-template_0.12.2_linux_amd64.zip -d /usr/local/bin ADD mysql-master.ctmpl /tmp/mysql-master.ctmpl VOLUME /var/lib/mysql COPY docker-entrypoint.sh /entrypoint.sh ENTRYPOINT ["/entrypoint.sh"] EXPOSE 3306 CMD ["mysqld"]</span></span></code> </pre><br></div></div><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docker-entrypoint.sh</font></font></b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash set -eo pipefail #   Consul,     master MYSQL_PORT_3306_TCP_ADDR="$(/usr/bin/consul-template --template=/tmp/mysql-master.ctmpl --consul=consul:8500 --dry -once | awk '{print $1}' | tail -1)" MYSQL_PORT_3306_TCP_PORT="$(/usr/bin/consul-template --template=/tmp/mysql-master.ctmpl --consul=consul:8500 --dry -once | awk '{print $2}' | tail -1)" if [ "${1:0:1}" = '-' ]; then set -- mysqld "$@" fi if [ "$1" = 'mysqld' ]; then # Get config DATADIR="$("$@" --verbose --help 2&gt;/dev/null | awk '$1 == "datadir" { print $2; exit }')" if [ ! -d "$DATADIR/mysql" ]; then if [ -z "$MYSQL_ROOT_PASSWORD" -a -z "$MYSQL_ALLOW_EMPTY_PASSWORD" -a -z "$MYSQL_RANDOM_ROOT_PASSWORD" ]; then echo &gt;&amp;2 'error: database is uninitialized and password option is not specified ' echo &gt;&amp;2 ' You need to specify one of MYSQL_ROOT_PASSWORD, MYSQL_ALLOW_EMPTY_PASSWORD and MYSQL_RANDOM_ROOT_PASSWORD' exit 1 fi mkdir -p "$DATADIR" chown -R mysql:mysql "$DATADIR" echo 'Initializing database' "$@" --initialize-insecure echo 'Database initialized' "$@" --skip-networking &amp; pid="$!" mysql=( mysql --protocol=socket -uroot ) for i in {30..0}; do if echo 'SELECT 1' | "${mysql[@]}" &amp;&gt; /dev/null; then break fi echo 'MySQL init process in progress...' sleep 1 done if [ "$i" = 0 ]; then echo &gt;&amp;2 'MySQL init process failed.' exit 1 fi if [ -n "${REPLICATION_MASTER}" ]; then echo "=&gt; Configuring MySQL replication as master (1/2) ..." if [ ! -f /replication_set.1 ]; then echo "=&gt; Writting configuration file /etc/mysql/my.cnf with server-id=1" echo 'server-id = 1' &gt;&gt; /etc/mysql/my.cnf echo 'log-bin = mysql-bin' &gt;&gt; /etc/mysql/my.cnf touch /replication_set.1 else echo "=&gt; MySQL replication master already configured, skip" fi fi # Set MySQL REPLICATION - SLAVE if [ -n "${REPLICATION_SLAVE}" ]; then echo "=&gt; Configuring MySQL replication as slave (1/2) ..." if [ -n "${MYSQL_PORT_3306_TCP_ADDR}" ] &amp;&amp; [ -n "${MYSQL_PORT_3306_TCP_PORT}" ]; then if [ ! -f /replication_set.1 ]; then echo "=&gt; Writting configuration file /etc/mysql/my.cnf with server-id=2" echo 'server-id = 2' &gt;&gt; /etc/mysql/my.cnf echo 'log-bin = mysql-bin' &gt;&gt; /etc/mysql/my.cnf echo 'log-bin=slave-bin' &gt;&gt; /etc/mysql/my.cnf touch /replication_set.1 else echo "=&gt; MySQL replication slave already configured, skip" fi else echo "=&gt; Cannot configure slave, please link it to another MySQL container with alias as 'mysql'" exit 1 fi fi # Set MySQL REPLICATION - SLAVE if [ -n "${REPLICATION_SLAVE}" ]; then echo "=&gt; Configuring MySQL replication as slave (2/2) ..." if [ -n "${MYSQL_PORT_3306_TCP_ADDR}" ] &amp;&amp; [ -n "${MYSQL_PORT_3306_TCP_PORT}" ]; then if [ ! -f /replication_set.2 ]; then echo "=&gt; Setting master connection info on slave" "${mysql[@]}" &lt;&lt;-EOSQL -- What's done in this file shouldn't be replicated -- or products like mysql-fabric won't work SET @@SESSION.SQL_LOG_BIN=0; CHANGE MASTER TO MASTER_HOST='${MYSQL_PORT_3306_TCP_ADDR}',MASTER_USER='${REPLICATION_USER}',MASTER_PASSWORD='${REPLICATION_PASS}',MASTER_PORT=${MYSQL_PORT_3306_TCP_PORT}, MASTER_CONNECT_RETRY=30; START SLAVE ; EOSQL echo "=&gt; Done!" touch /replication_set.2 else echo "=&gt; MySQL replication slave already configured, skip" fi else echo "=&gt; Cannot configure slave, please link it to another MySQL container with alias as 'mysql'" exit 1 fi fi if [ -z "$MYSQL_INITDB_SKIP_TZINFO" ]; then # sed is for https://bugs.mysql.com/bug.php?id=20545 mysql_tzinfo_to_sql /usr/share/zoneinfo | sed 's/Local time zone must be set--see zic manual page/FCTY/' | "${mysql[@]}" mysql fi if [ ! -z "$MYSQL_RANDOM_ROOT_PASSWORD" ]; then MYSQL_ROOT_PASSWORD="$(pwgen -1 32)" echo "GENERATED ROOT PASSWORD: $MYSQL_ROOT_PASSWORD" fi "${mysql[@]}" &lt;&lt;-EOSQL -- What's done in this file shouldn't be replicated -- or products like mysql-fabric won't work SET @@SESSION.SQL_LOG_BIN=0; DELETE FROM mysql.user ; CREATE USER 'root'@'%' IDENTIFIED BY '${MYSQL_ROOT_PASSWORD}' ; GRANT ALL ON *.* TO 'root'@'%' WITH GRANT OPTION ; DROP DATABASE IF EXISTS test ; FLUSH PRIVILEGES ; EOSQL if [ ! -z "$MYSQL_ROOT_PASSWORD" ]; then mysql+=( -p"${MYSQL_ROOT_PASSWORD}" ) fi # Set MySQL REPLICATION - MASTER if [ -n "${REPLICATION_MASTER}" ]; then echo "=&gt; Configuring MySQL replication as master (2/2) ..." if [ ! -f /replication_set.2 ]; then echo "=&gt; Creating a log user ${REPLICATION_USER}:${REPLICATION_PASS}" "${mysql[@]}" &lt;&lt;-EOSQL -- What's done in this file shouldn't be replicated -- or products like mysql-fabric won't work SET @@SESSION.SQL_LOG_BIN=0; CREATE USER '${REPLICATION_USER}'@'%' IDENTIFIED BY '${REPLICATION_PASS}'; GRANT REPLICATION SLAVE ON *.* TO '${REPLICATION_USER}'@'%' ; FLUSH PRIVILEGES ; RESET MASTER ; EOSQL echo "=&gt; Done!" touch /replication_set.2 else echo "=&gt; MySQL replication master already configured, skip" fi fi if [ "$MYSQL_DATABASE" ]; then echo "CREATE DATABASE IF NOT EXISTS \`$MYSQL_DATABASE\` ;" | "${mysql[@]}" mysql+=( "$MYSQL_DATABASE" ) fi if [ "$MYSQL_USER" -a "$MYSQL_PASSWORD" ]; then echo "CREATE USER '$MYSQL_USER'@'%' IDENTIFIED BY '$MYSQL_PASSWORD' ;" | "${mysql[@]}" if [ "$MYSQL_DATABASE" ]; then echo "GRANT ALL ON \`$MYSQL_DATABASE\`.* TO '$MYSQL_USER'@'%' ;" | "${mysql[@]}" fi echo 'FLUSH PRIVILEGES ;' | "${mysql[@]}" fi echo for f in /docker-entrypoint-initdb.d/*; do case "$f" in *.sh) echo "$0: running $f"; . "$f" ;; *.sql) echo "$0: running $f"; "${mysql[@]}" &lt; "$f"; echo ;; *.sql.gz) echo "$0: running $f"; gunzip -c "$f" | "${mysql[@]}"; echo ;; *) echo "$0: ignoring $f" ;; esac echo done if [ ! -z "$MYSQL_ONETIME_PASSWORD" ]; then "${mysql[@]}" &lt;&lt;-EOSQL ALTER USER 'root'@'%' PASSWORD EXPIRE; EOSQL fi if ! kill -s TERM "$pid" || ! wait "$pid"; then echo &gt;&amp;2 'MySQL init process failed.' exit 1 fi echo echo 'MySQL init process done. Ready for start up.' echo fi chown -R mysql:mysql "$DATADIR" fi exec "$@"</span></span></code> </pre><br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And the template for Consul Template, mysql-master.ctmpl: </font></font><br><pre> <code class="hljs django"><span class="xml"></span><span class="hljs-template-variable"><span class="xml"></span><span class="hljs-template-variable">{{range service "master"}}</span></span><span class="xml"></span><span class="hljs-template-variable"><span class="xml"></span><span class="hljs-template-variable">{{.Address}}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{.Port}}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{end}}</span></span><span class="xml"></span><span class="xml"></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We collect: </font></font><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> build -t mysql-slave .</code> </pre><br>  Run: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> run --name mysql-slave.<span class="hljs-number"><span class="hljs-number">0</span></span> -v /mnt/volumes/slave:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=rootpass -e REPLICATION_SLAVE=<span class="hljs-literal"><span class="hljs-literal">true</span></span> -e REPLICATION_USER=replica -e REPLICATION_PASS=replica --link=consul:consul -l <span class="hljs-string"><span class="hljs-string">"SERVICE_NAME=slave"</span></span> -l <span class="hljs-string"><span class="hljs-string">"SERVICE_PORT=3307"</span></span> -p <span class="hljs-number"><span class="hljs-number">3307</span></span>:<span class="hljs-number"><span class="hljs-number">3306</span></span> -d mysql-slave</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> So now is the time to launch our backend. </font></font><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> run --name fpm.<span class="hljs-number"><span class="hljs-number">0</span></span> -d -v /mnt/storage/www:/var/www/html \ -e WORDPRESS_DB_NAME=wordpressp -e WORDPRESS_DB_USER=wordpress -e WORDPRESS_DB_PASSWORD=wordpress \ --link consul:consul -l <span class="hljs-string"><span class="hljs-string">"SERVICE_NAME=php-fpm"</span></span> -l <span class="hljs-string"><span class="hljs-string">"SERVICE_PORT=9000"</span></span> -l <span class="hljs-string"><span class="hljs-string">"SERVICE_TAGS=worker"</span></span> -p <span class="hljs-number"><span class="hljs-number">9000</span></span>:<span class="hljs-number"><span class="hljs-number">9000</span></span> fpm</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If everything went well, then, opening the address of our balancer in the browser, we will see Wordress greeting with a proposal to install it. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otherwise, we look at the logs.</font></font><br><pre> <code class="hljs xml">docker logs <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">container_name</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Docker-compose. </font></font></h3><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We collected images with the services necessary for our application, we can run it anytime, anywhere, but ... Why do we need to remember so many commands, launch parameters, variables to launch containers? Here another cool tool comes to our aid - </font></font><a href="https://docs.docker.com/compose/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docker-compose</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This tool is designed to run applications in multiple containers. Docker-compose uses a declarative script in YAML format, which specifies with which parameters and variables to start the container. Scripts are easy to read and easy to read. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will write such a simple script that will run in several containers everything you need for our web application docker-compose.yml.</font></font><br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="hljs mel">mysql-master: <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: mysql-master ports: - <span class="hljs-string"><span class="hljs-string">"3306:3306"</span></span> environment: - <span class="hljs-string"><span class="hljs-string">"MYSQL_DATABASE=wp"</span></span> - <span class="hljs-string"><span class="hljs-string">"MYSQL_USER=wordpress"</span></span> - <span class="hljs-string"><span class="hljs-string">"MYSQL_PASSWORD=wordpress"</span></span> - <span class="hljs-string"><span class="hljs-string">"REPLICATION_MASTER=true"</span></span> - <span class="hljs-string"><span class="hljs-string">"REPLICATION_USER=replica"</span></span> - <span class="hljs-string"><span class="hljs-string">"REPLICATION_PASS=replica"</span></span> external_links: - consul:consul labels: - <span class="hljs-string"><span class="hljs-string">"SERVICE_NAME=mysql-master"</span></span> - <span class="hljs-string"><span class="hljs-string">"SERVICE_PORT=3306"</span></span> - <span class="hljs-string"><span class="hljs-string">"SERVICE_TAGS=db"</span></span> volumes: - <span class="hljs-string"><span class="hljs-string">'/mnt/storage/master:/var/lib/mysql'</span></span> mysql-slave: <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: mysql-slave ports: - <span class="hljs-string"><span class="hljs-string">"3307:3306"</span></span> environment: - <span class="hljs-string"><span class="hljs-string">"REPLICATION_SLAVE=true"</span></span> - <span class="hljs-string"><span class="hljs-string">"REPLICATION_USER=replica"</span></span> - <span class="hljs-string"><span class="hljs-string">"REPLICATION_PASS=replica"</span></span> external_links: - consul:consul labels: - <span class="hljs-string"><span class="hljs-string">"SERVICE_NAME=mysql-slave"</span></span> - <span class="hljs-string"><span class="hljs-string">"SERVICE_PORT=3307"</span></span> - <span class="hljs-string"><span class="hljs-string">"SERVICE_TAGS=db"</span></span> volumes: - <span class="hljs-string"><span class="hljs-string">'/mnt/storage/slave:/var/lib/mysql'</span></span> wordpress: <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: fpm ports: - <span class="hljs-string"><span class="hljs-string">"9000:9000"</span></span> environment: - <span class="hljs-string"><span class="hljs-string">"WORDPRESS_DB_NAME=wp"</span></span> - <span class="hljs-string"><span class="hljs-string">"WORDPRESS_DB_USER=wordpress"</span></span> - <span class="hljs-string"><span class="hljs-string">"WORDPRESS_DB_PASSWORD=wordpress"</span></span> external_links: - consul:consul labels: - <span class="hljs-string"><span class="hljs-string">"SERVICE_NAME=php-fpm"</span></span> - <span class="hljs-string"><span class="hljs-string">"SERVICE_PORT=9000"</span></span> - <span class="hljs-string"><span class="hljs-string">"SERVICE_TAGS=worker"</span></span> volumes: - <span class="hljs-string"><span class="hljs-string">'/mnt/storage/www:/var/www/html'</span></span></code> </pre><br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now it remains to execute the command to launch our ‚Äúdocked‚Äù application, sit back and admire the result. </font></font><br><pre> <code class="hljs">docker-compose up</code> </pre><br><br><h2>  Conclusion </h2><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Of the merits </font></font></h4><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Distributed application architecture. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Swarm copes with load balancing. </font><font style="vertical-align: inherit;">We can run as many copies of the application as long as there are resources on the nodes. </font><font style="vertical-align: inherit;">And run "in one click." </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Easy scaling. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As you can see, to include a new node in the cluster is quite simple. </font><font style="vertical-align: inherit;">Connect the node - start the service. </font><font style="vertical-align: inherit;">If desired, this procedure can be further automated. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Dynamic application infrastructure. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each service can easily receive information about where it is and with whom it needs to interact. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Run the application in one command. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The docker-compose script allows us to deploy the entire infrastructure and link applications literally at the touch of a button.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Of disadvantages </font></font></h4><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Persistent data. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">More than once it has been said that Docker is not so smooth with stateful services. We tried the flocker, but it seemed very raw, the plugin was constantly ‚Äúfalling off‚Äù for unknown reasons. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We used to synchronize the persistent data first glusterfs, then lsyncd. Glusterfs, it seems, is doing quite well with its task, but in production we have not yet decided to use it. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perhaps you know a more elegant way to solve this problem - it would be great to hear it.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/576/9c1/392/5769c13923b949cf8af85bc1319cddef.jpg"></div><br><br>  <i>PS</i> <br> <i>       how-to,           . <br>       /  ,   ,      .</i> </div><p>Source: <a href="https://habr.com/ru/post/278939/">https://habr.com/ru/post/278939/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278929/index.html">Software-defined data center: why is it necessary in the practice of the sysadmin</a></li>
<li><a href="../278931/index.html">What a programmer should be able to get a job in finance</a></li>
<li><a href="../278933/index.html">Bulletin MS16-023: When a critical Windows security update affects more than just security</a></li>
<li><a href="../278935/index.html">What is new is waiting for us in Laravel 5.2.23</a></li>
<li><a href="../278937/index.html">Testing Bash Applications</a></li>
<li><a href="../278941/index.html">How our testing is arranged and why QA participates in the formulation of problems to our developers</a></li>
<li><a href="../278943/index.html">OpenConfig - a standardized approach to configuring network equipment</a></li>
<li><a href="../278945/index.html">Android runtime permissions. Why, why, and how</a></li>
<li><a href="../278947/index.html">Speed ‚Äã‚ÄãDevelopment Unity3D games for the competition</a></li>
<li><a href="../278949/index.html">Spiceworks research: insider threats will be the biggest information security challenge in 2016</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>