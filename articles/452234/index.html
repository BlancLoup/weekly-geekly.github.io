<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Thermometer & Hygrometer on ATMEGA 328P-MU - Raising the level of arduino developments</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today I want to share one of my Arduino projects. Once, not so long ago, I learned about Arduino somewhere on the Internet. I joined this business pre...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Thermometer & Hygrometer on ATMEGA 328P-MU - Raising the level of arduino developments</h1><div class="post__text post__text-html js-mediator-article"> Today I want to share one of my Arduino projects.  Once, not so long ago, I learned about Arduino somewhere on the Internet.  I joined this business pretty quickly, the level of entry there is not high.  After some time, having already gathered a bunch of sensors, sensors for a smart home, it began to catch itself at the thought that something like this was all wrong. <a name="habracut"></a>  Modules, large plain boxes, a bunch of wires and glue :).  Looking at my box with a temperature sensor and, for example, the temperature sensor of the same Xiaomi, I understood that I wanted to look like Xiaomi but at the same time that I could reprogram it like mine in a box measuring 10 cm by 6 cm with wires and hot melt.  And then that was probably the beginning of my DIY arduino projects on PCB boards. <br><br>  In today's article we will focus on the temperature and humidity sensor based on the atmega328p-mu processor.  This is the ‚Äúsmaller‚Äù version (absolute analogue) of the atmega328p-au processor (Arduino Uno, Pro Mini, Nano) izvetnom to all arduinschiki.  If someone has read my articles before, he knows that I prefer Mysensors.  What is it?  It is very simple and well-developed and what is equally important is the perfectly described library under Arduino IDE (and not only) for creating IOT radio networks at 2.4 GHz, 915, 868, 433 MHz frequencies, as well as wired networks on the 485 interface, maybe not all mentioned, TK protocol is constantly evolving, all the time something is added. <br><br>  The first thing that was done is the sensor itself on the PCB board.  I did without looking at the case, according to the principle, the main thing is to make a sensor, and as for the case, I‚Äôll print something, ... yes, don‚Äôt do so :).  In fact, the sensor itself is the same Arduinka Pro Mini, the nRF24l01 radio module, SHT20 temperature and humidity sensor, only without wires and hot melt.  From the ‚Äúbells and whistles‚Äù this is an external SPI flash drive for flashing through the air (you need the DualOptibut bootloader to work, later I stopped putting them (flash drives) on the boards, there are no pair of firmware in the air and half a battery) and a cryptto mic ATSHA204A for full Iron kit (in Mysensors, it is enough to simply specify the #def in the beginning of the sketch to activate signatures, encryption, and so on). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/mt/3r/ci/mt3rci4yk0yasyrccfbqe_ii3uw.jpeg"><br><br>  The fee itself was done in the program Diptreis, after watching video tutorials on YouTube, at first it seemed like something ‚Äúhellish‚Äù, but in fact it turned out to be not that difficult.  I ordered the boards in China on the jlcpcb.com website, 2 bucks, any color, and after 2 weeks you already get 10 pieces of ‚Äúyour creation‚Äù in your hands :). <br><br><img src="https://habrastorage.org/webt/g8/vt/89/g8vt89xocfduchhvirqldwcurh4.png"><br><br><img src="https://habrastorage.org/webt/zu/wm/zs/zuwmzsu8ervyhmnbxzdfprmdbcu.jpeg"><br><br>  The next stage was the development of the hull.  Oh, it turned out to be another problem.  In general, I did not look for easy ways, I decided to master Solid Works.  As it turned out, this is not at all like with Diptreys.  Nevertheless, I still recommend this particular editor for the study.  The learning process lasted for a month of leisurely watching video tutorials on YouTube and repeating lesson materials in the editor.  In the process of developing the case, it became clear what the device board should do without taking into account the parameters of the future case is a bad decision, from the series we put the sticks into our own wheels.  According to the results of the board versions, three came out considering the installation of the board in the case, and I think this is not the last option. <br><br>  At the beginning of the development of the case, the idea was to print it on an FDM 3D printer, but the farther into the forest it became clearer that it could not reproduce all my wishes.  By the time this understanding came, I already learned about another 3D printing technology - SLA.  Without thinking and impressed with the quality of the print, an Alike Wishlist was issued - <a href="https://ru.aliexpress.com/item/ANYCUBIC-SLA-3d-UV-lcd-2-K-Off/32846794715.html">ANYCUBIC Photon</a> .  (Link to Ali, not advertising, not affiliate, ... just a link). <br><br>  I will write right away, now, on the basis of my experience at the time of this writing, ... oh, and this is such a wonderful thing!  The body that was designed in the editor, of course, was not printed the first time and there were a lot of improvements.  Well, on the other probably does not happen.  As a result, I got the result that I wanted.  Quite a miniature device, a good DIY case with very accurate detailing, buttons, fonts, everything was presented in my head.  Added a magnet to the back cover, now it can be easily attached to iron surfaces. <br><br><img src="https://habrastorage.org/webt/q2/a8/yz/q2a8yzmu0x8pzg6qtxs9nf4d0sc.jpeg"><br><br><img src="https://habrastorage.org/webt/12/2j/pk/122jpkp-anp4zxqhshi7wp5bbga.jpeg"><br><br><img src="https://habrastorage.org/webt/er/il/ak/erilakhq5uhxtx09ab54rn5brao.jpeg"><br><br><img src="https://habrastorage.org/webt/d3/pa/fh/d3pafhom0t6ydozgxjgm_o0g9eo.jpeg"><br><br><img src="https://habrastorage.org/webt/k-/2i/yj/k-2iyjlk9snioo4vktlengxti_g.jpeg"><br><br><img src="https://habrastorage.org/webt/cc/du/yy/ccduyyya0_8awrvrplyrt4q3qze.jpeg"><br><br><img src="https://habrastorage.org/webt/et/nf/5w/etnf5wimx4pwsf6k76uh5gobk3e.jpeg"><br><br><img src="https://habrastorage.org/webt/re/g8/z9/reg8z9zer-swbz32kn5afhkvwsq.jpeg"><br><br>  These are attempts to print the same model on an FDM printer: <br><br><img src="https://habrastorage.org/webt/_i/et/hu/_iethu6tktjfhc85y3ulrh5xf8m.jpeg"><br><br><img src="https://habrastorage.org/webt/ow/6s/fh/ow6sfhpdvcmxy2lz0jemul6o0-i.jpeg"><br><br>  Since the device turned out to be small, but it is still Arduinka, I was puzzled by the output of miniature connectors for programming.  And accordingly, a small adapter was made to the connectors for convenient connection with the programmer and the TTL converter. <br><br><img src="https://habrastorage.org/webt/pl/-l/48/pl-l48rq33glvskysput8i6gu7y.jpeg"><br><br>  Everything was purchased on Ali (yes, it‚Äôs not only the Arduino modules) <br><br>  SMD tantalum capacitor 4.7uF - 4.7uF |  10v |  10% - C1 <br>  SMD ceramic capacitor 100nF |  Y5V - 100nF |  50v |  + 80-20% - C2, C3, C4, C5, C6, C7 <br>  LED - LED SIDE - D1 <br>  Pin Header Female - 2x3P |  6pin |  1.27mm - J1, J2 <br>  SMD resistor 20K Ohm - 20K |  5% - R1 <br>  SMD resistor 4.7K Ohm - 4.7K |  5% - R2, R3, R4 <br>  SMD resistor 470K Ohm - 470 |  1% - R5 <br>  SMD resistor 1M Ohm - 1M |  1% - R6 <br>  SMD resistor 18K Ohm - 18K |  5% - R7 <br>  SMD resistor 10K Ohm - 10K |  5% - R8 <br>  4-pin SMD side button - SW1, SW2 <br>  512-Kbit, 1.65V SPI Serial Flash Memory - AT25DF512C-SSHN-B - U1 <br>  Mini NRF24L01 + 2.4GHz 1.27MM RF - nRF24l01 1.27 SMD - U2 <br>  ATMEGA328P-MU QFN32 - U3 <br>  CRYPTO AUTHENTICATION, 1 WIRE - ATSHA204A-STUCZ-T - U4 <br>  Humidity and Temperature Sensor IC - SHT20 - U5 <br>  BATTERY HOLDER FOR CR2477-1 - L-KLS5-CR2477-1 - U6 <br><br>  The program code is quite simple.  An example of the DFRobot library was used to work with the SHT20 sensor.  In principle, any sketch, for any sensor, you can take 5 minutes to sketch in order to work on the network Mysensors. <br><br><div class="spoiler">  <b class="spoiler_title">Code listing</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Wire.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"DFRobot_SHT20.h"</span></span></span></span>
DFRobot_SHT20    sht20; <span class="hljs-comment"><span class="hljs-comment">// https://github.com/DFRobot/DFRobot_SHT20</span></span>

<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MY_DEBUG</span></span>
<span class="hljs-comment"><span class="hljs-comment">//#define MY_DISABLED_SERIAL</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MY_RADIO_RF24</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MY_PASSIVE_NODE</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MY_NODE_ID 200</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MY_PARENT_NODE_ID 0</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MY_PARENT_NODE_IS_STATIC</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MY_TRANSPORT_UPLINK_CHECK_DISABLED</span></span>
<span class="hljs-comment"><span class="hljs-comment">//#define MY_OTA_FIRMWARE_FEATURE</span></span>
<span class="hljs-comment"><span class="hljs-comment">//#define MY_SIGNING_ATSHA204</span></span>
<span class="hljs-comment"><span class="hljs-comment">//#define MY_SIGNING_ATSHA204_PIN A3</span></span>
<span class="hljs-comment"><span class="hljs-comment">//#define MY_SIGNING_REQUEST_SIGNATURES</span></span>

<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TEMP_SENS_ID 1</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> HUM_SENS_ID 2</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SETTING_LED_SENS_ID 100</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DELAY_TIME_SENS_ID 101</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BATTARY_SEND_SENS_ID 102</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BATTARY_DATA_SENS_ID 103</span></span>

<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BAT_COOF 3.04</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BAT_MIN 195</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BAT_MAX 295</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ON 1</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> OFF 0</span></span>

<span class="hljs-keyword"><span class="hljs-keyword">float</span></span> humd;
<span class="hljs-keyword"><span class="hljs-keyword">float</span></span> temp;
<span class="hljs-keyword"><span class="hljs-keyword">float</span></span> oldhumd;
<span class="hljs-keyword"><span class="hljs-keyword">float</span></span> oldtemp;
<span class="hljs-keyword"><span class="hljs-keyword">float</span></span> tempThreshold = <span class="hljs-number"><span class="hljs-number">0.5</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">float</span></span> humThreshold = <span class="hljs-number"><span class="hljs-number">10.0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> lightMillis;
<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> previousMillis;
<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> send_batteryTime;
<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> w_battetyTime = <span class="hljs-number"><span class="hljs-number">0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> led_pin = <span class="hljs-number"><span class="hljs-number">4</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> mode_pin = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-comment"><span class="hljs-comment">// interrupt</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> delayTime;
<span class="hljs-keyword"><span class="hljs-keyword">int8_t</span></span> battery;
<span class="hljs-keyword"><span class="hljs-keyword">int8_t</span></span> old_battery;
<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> set_led;
boolean sleep_mode;
boolean configMode = <span class="hljs-number"><span class="hljs-number">0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">int8_t</span></span> timer_status = <span class="hljs-number"><span class="hljs-number">0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> flag_mode_button = <span class="hljs-number"><span class="hljs-number">0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> sleep_flag = <span class="hljs-number"><span class="hljs-number">0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> listen_flag = <span class="hljs-number"><span class="hljs-number">0</span></span>;

<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;MySensors.h&gt;</span></span></span></span>

<span class="hljs-function"><span class="hljs-function">MyMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">msg_temp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TEMP_SENS_ID, V_TEMP)</span></span></span></span>;
<span class="hljs-function"><span class="hljs-function">MyMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">msg_hum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HUM_SENS_ID, V_HUM)</span></span></span></span>;
<span class="hljs-function"><span class="hljs-function">MyMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">msg_setting_led</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SETTING_LED_SENS_ID, V_VAR1)</span></span></span></span>;
<span class="hljs-function"><span class="hljs-function">MyMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">msg_delay_time</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DELAY_TIME_SENS_ID, V_VAR1)</span></span></span></span>;
<span class="hljs-function"><span class="hljs-function">MyMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">msg_battary_send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BATTARY_SEND_SENS_ID, V_VAR1)</span></span></span></span>;
<span class="hljs-function"><span class="hljs-function">MyMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">powerMsg</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BATTARY_DATA_SENS_ID, V_VAR1)</span></span></span></span>;

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">preHwInit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
  pinMode(led_pin, OUTPUT);
  digitalWrite(led_pin, OFF);
  pinMode(mode_pin, INPUT_PULLUP);
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">before</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
  set_led = loadState(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (set_led &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) {
    set_led = <span class="hljs-number"><span class="hljs-number">1</span></span>;
    saveState(<span class="hljs-number"><span class="hljs-number">100</span></span>, set_led);
  }
  delayTime = loadState(<span class="hljs-number"><span class="hljs-number">101</span></span>);
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (delayTime &gt; <span class="hljs-number"><span class="hljs-number">60</span></span>) {
    delayTime = <span class="hljs-number"><span class="hljs-number">3</span></span>;
    saveState(<span class="hljs-number"><span class="hljs-number">101</span></span>, delayTime);
  }
  send_batteryTime = loadState(<span class="hljs-number"><span class="hljs-number">102</span></span>);
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (send_batteryTime &gt; <span class="hljs-number"><span class="hljs-number">48</span></span>) {
    send_batteryTime = <span class="hljs-number"><span class="hljs-number">6</span></span>;
    saveState(<span class="hljs-number"><span class="hljs-number">102</span></span>, send_batteryTime);
  }


  digitalWrite(led_pin, ON);
}


<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">presentation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
  sendSketchInfo(<span class="hljs-string"><span class="hljs-string">"Temp &amp; Hum Sensor CR2477"</span></span>, <span class="hljs-string"><span class="hljs-string">"1.0"</span></span>);
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  present(TEMP_SENS_ID, S_TEMP, <span class="hljs-string"><span class="hljs-string">"TEMPERATURE DATA"</span></span>);
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  present(HUM_SENS_ID, S_HUM, <span class="hljs-string"><span class="hljs-string">"HUMIDITY DATA"</span></span>);
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  present(SETTING_LED_SENS_ID, S_CUSTOM, <span class="hljs-string"><span class="hljs-string">"LED MODE"</span></span>);
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  present(DELAY_TIME_SENS_ID, S_CUSTOM, <span class="hljs-string"><span class="hljs-string">"DELAY TIME/MIN"</span></span>);
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  present(BATTARY_SEND_SENS_ID, S_CUSTOM, <span class="hljs-string"><span class="hljs-string">"BATTERY SEND TIME/H"</span></span>);
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  present(BATTARY_DATA_SENS_ID, S_CUSTOM, <span class="hljs-string"><span class="hljs-string">"BATTERY DATA"</span></span>);
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
  <span class="hljs-comment"><span class="hljs-comment">//attachInterrupt(0, configListener, RISING);</span></span>
  digitalWrite(led_pin, OFF);
  wait(<span class="hljs-number"><span class="hljs-number">500</span></span>);
  digitalWrite(led_pin, ON);
  wait(<span class="hljs-number"><span class="hljs-number">75</span></span>);
  digitalWrite(led_pin, OFF);
  wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
  digitalWrite(led_pin, ON);
  wait(<span class="hljs-number"><span class="hljs-number">75</span></span>);
  digitalWrite(led_pin, OFF);
  wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
  digitalWrite(led_pin, ON);
  wait(<span class="hljs-number"><span class="hljs-number">75</span></span>);
  digitalWrite(led_pin, OFF);
  TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: OPERATING MODE\n"</span></span>));
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  readBatLev();
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  sht20.initSHT20();
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  send_data();
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  send(msg_delay_time.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(delayTime));
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  send(msg_setting_led.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(set_led));
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  send(msg_battary_send.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(send_batteryTime));
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (configMode == <span class="hljs-number"><span class="hljs-number">0</span></span>) {



    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sleep_flag == <span class="hljs-number"><span class="hljs-number">0</span></span>) {
      timer_status = sleep(digitalPinToInterrupt(mode_pin), FALLING, delayTime * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);
      <span class="hljs-comment"><span class="hljs-comment">//timer_status = sleep(digitalPinToInterrupt(mode_pin), RISING, delayTime * 60 * 1000, false);</span></span>
      sleep_flag = <span class="hljs-number"><span class="hljs-number">1</span></span>;
    }
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (timer_status == <span class="hljs-number"><span class="hljs-number">-1</span></span>) {

      w_battetyTime = w_battetyTime + (delayTime * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>);

      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (w_battetyTime &gt;= send_batteryTime * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>) {
        readBatLev();
        w_battetyTime = <span class="hljs-number"><span class="hljs-number">0</span></span>;
      }
      send_data();
      sleep_flag = <span class="hljs-number"><span class="hljs-number">0</span></span>;
    }
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (timer_status == <span class="hljs-number"><span class="hljs-number">0</span></span>) {
      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (digitalRead(<span class="hljs-number"><span class="hljs-number">2</span></span>) == LOW &amp;&amp; flag_mode_button == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
      {
        flag_mode_button = <span class="hljs-number"><span class="hljs-number">1</span></span>;
        previousMillis = millis();
        wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
      }
      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (digitalRead(<span class="hljs-number"><span class="hljs-number">2</span></span>) == LOW &amp;&amp; flag_mode_button == <span class="hljs-number"><span class="hljs-number">1</span></span>) {
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((millis() - previousMillis &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number"><span class="hljs-number">2000</span></span>)) {
          <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (millis() - lightMillis &gt; <span class="hljs-number"><span class="hljs-number">50</span></span>)    {
            lightMillis = millis();
            digitalWrite(led_pin, !digitalRead(led_pin));
          }
        }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((millis() - previousMillis &gt; <span class="hljs-number"><span class="hljs-number">2000</span></span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number"><span class="hljs-number">2500</span></span>)) {
          digitalWrite(led_pin, OFF);
        }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((millis() - previousMillis &gt; <span class="hljs-number"><span class="hljs-number">2500</span></span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number"><span class="hljs-number">4500</span></span>)) {
          <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (millis() - lightMillis &gt; <span class="hljs-number"><span class="hljs-number">25</span></span>)    {
            lightMillis = millis();
            digitalWrite(led_pin, !digitalRead(led_pin));
          }
        }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (millis() - previousMillis &gt; <span class="hljs-number"><span class="hljs-number">4500</span></span>) {
          digitalWrite(led_pin, OFF);
        }
      }
      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (digitalRead(<span class="hljs-number"><span class="hljs-number">2</span></span>) == HIGH &amp;&amp; flag_mode_button == <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">//   </span></span>
      {
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((millis() - previousMillis &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number"><span class="hljs-number">2000</span></span>)) {
          configMode = !configMode;
          flag_mode_button = <span class="hljs-number"><span class="hljs-number">0</span></span>;
          TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: CONFIGURATION MODE\n"</span></span>));
          sleep_flag = <span class="hljs-number"><span class="hljs-number">0</span></span>;
          digitalWrite(led_pin, OFF);
        }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((millis() - previousMillis &gt; <span class="hljs-number"><span class="hljs-number">2000</span></span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number"><span class="hljs-number">2500</span></span>)) {
          flag_mode_button = <span class="hljs-number"><span class="hljs-number">0</span></span>;
          sleep_flag = <span class="hljs-number"><span class="hljs-number">0</span></span>;
        }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((millis() - previousMillis &gt; <span class="hljs-number"><span class="hljs-number">2500</span></span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number"><span class="hljs-number">4500</span></span>))
        {
          flag_mode_button = <span class="hljs-number"><span class="hljs-number">0</span></span>;
          sleep_flag = <span class="hljs-number"><span class="hljs-number">0</span></span>;
          digitalWrite(led_pin, OFF);
        }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (millis() - previousMillis &gt; <span class="hljs-number"><span class="hljs-number">4500</span></span>) {
          flag_mode_button = <span class="hljs-number"><span class="hljs-number">0</span></span>;
          sleep_flag = <span class="hljs-number"><span class="hljs-number">0</span></span>;
          wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
        }
      }
    }
  } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (listen_flag == <span class="hljs-number"><span class="hljs-number">0</span></span>) {
      RF24_startListening();
      listen_flag = <span class="hljs-number"><span class="hljs-number">1</span></span>;
    }
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (millis() - lightMillis &gt; <span class="hljs-number"><span class="hljs-number">1000</span></span>) {
      lightMillis = millis();
      digitalWrite(led_pin, !digitalRead(led_pin));
    }
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (digitalRead(<span class="hljs-number"><span class="hljs-number">2</span></span>) == LOW &amp;&amp; flag_mode_button == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
    {
      flag_mode_button = <span class="hljs-number"><span class="hljs-number">1</span></span>;
      <span class="hljs-comment"><span class="hljs-comment">//previousMillis = millis();</span></span>
      wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
    }
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (digitalRead(<span class="hljs-number"><span class="hljs-number">2</span></span>) == LOW &amp;&amp; flag_mode_button == <span class="hljs-number"><span class="hljs-number">1</span></span>) {
      
    }
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (digitalRead(<span class="hljs-number"><span class="hljs-number">2</span></span>) == HIGH &amp;&amp; flag_mode_button == <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">//   </span></span>
    {
       
      configMode = !configMode;
      listen_flag = <span class="hljs-number"><span class="hljs-number">0</span></span>;
      flag_mode_button = <span class="hljs-number"><span class="hljs-number">0</span></span>;
      TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: OPERATING MODE\n"</span></span>));
      digitalWrite(led_pin, OFF);
      wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
    }
  }
}



<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MyMessage &amp; message)</span></span></span><span class="hljs-function">
</span></span>{
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.sensor == SETTING_LED_SENS_ID) {
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.type == V_VAR1) {
      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.getByte() &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>) {
        set_led = message.getBool();
        saveState(<span class="hljs-number"><span class="hljs-number">100</span></span>, set_led);
        send(msg_setting_led.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(set_led));
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (set_led == <span class="hljs-number"><span class="hljs-number">0</span></span>) {
          TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: STATUS LED: OFF\n"</span></span>));
        }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (set_led == <span class="hljs-number"><span class="hljs-number">1</span></span>) {
          TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: STATUS LED: ON\n"</span></span>));
          <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (set_led == <span class="hljs-number"><span class="hljs-number">1</span></span>) {
            digitalWrite(led_pin, ON);
            wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
            digitalWrite(led_pin, OFF);
          }
        }
      }
    }
  }
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.sensor == DELAY_TIME_SENS_ID) {
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.type == V_VAR1) {
      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.getULong() &lt;= <span class="hljs-number"><span class="hljs-number">60</span></span> &amp;&amp; message.getULong() != <span class="hljs-number"><span class="hljs-number">0</span></span>) {
        delayTime = message.getULong();
        saveState(<span class="hljs-number"><span class="hljs-number">101</span></span>, delayTime);
        send(msg_delay_time.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(delayTime));
        TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: THE NEW INTERVAL TEMP&amp;HUM SEND VALUE IS SET: %d MIN.\n"</span></span>), delayTime);
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (set_led == <span class="hljs-number"><span class="hljs-number">1</span></span>) {
          digitalWrite(led_pin, ON);
          wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
          digitalWrite(led_pin, OFF);
        }
      } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.getULong() &gt; <span class="hljs-number"><span class="hljs-number">60</span></span>) {
        delayTime = <span class="hljs-number"><span class="hljs-number">60</span></span>;
        saveState(<span class="hljs-number"><span class="hljs-number">101</span></span>, delayTime);
        send(msg_delay_time.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(delayTime));
        TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: THE NEW INTERVAL TEMP&amp;HUM SEND VALUE IS SET: %d MIN.\n"</span></span>), delayTime);
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (set_led == <span class="hljs-number"><span class="hljs-number">1</span></span>) {
          digitalWrite(led_pin, ON);
          wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
          digitalWrite(led_pin, OFF);
        }
      } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.getULong() == <span class="hljs-number"><span class="hljs-number">0</span></span>) {
        delayTime = <span class="hljs-number"><span class="hljs-number">1</span></span>;
        saveState(<span class="hljs-number"><span class="hljs-number">101</span></span>, delayTime);
        send(msg_delay_time.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(delayTime));
        TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: THE NEW INTERVAL TEMP&amp;HUM SEND VALUE IS SET: %d MIN.\n"</span></span>), delayTime);
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (set_led == <span class="hljs-number"><span class="hljs-number">1</span></span>) {
          digitalWrite(led_pin, ON);
          wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
          digitalWrite(led_pin, OFF);
        }
      }
    }
  }
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.sensor == BATTARY_SEND_SENS_ID) {
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.type == V_VAR1) {
      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.getULong() &lt;= <span class="hljs-number"><span class="hljs-number">168</span></span>) {
        send_batteryTime = message.getULong();
        saveState(<span class="hljs-number"><span class="hljs-number">102</span></span>, send_batteryTime);
        send(msg_battary_send.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(send_batteryTime));
        TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: THE NEW INTERVAL BATTERY SEND IS SET: %d HOUR\n"</span></span>), send_batteryTime);
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (set_led == <span class="hljs-number"><span class="hljs-number">1</span></span>) {
          digitalWrite(led_pin, ON);
          wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
          digitalWrite(led_pin, OFF);
        }
      }
    }
  }
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
  humd = sht20.readHumidity();
  temp = sht20.readTemperature();
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> t_humd = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)humd;
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> t_temp = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)temp;
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(temp - oldtemp) &gt;= tempThreshold) {
    send(msg_temp.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(temp, <span class="hljs-number"><span class="hljs-number">1</span></span>));
    oldtemp = temp;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (set_led == <span class="hljs-number"><span class="hljs-number">1</span></span>) {
      digitalWrite(led_pin, ON);
      wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
      digitalWrite(led_pin, OFF);
    }
  }
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(humd - oldhumd) &gt;= humThreshold) {
    send(msg_hum.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(humd, <span class="hljs-number"><span class="hljs-number">1</span></span>));
    oldhumd = humd;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (set_led == <span class="hljs-number"><span class="hljs-number">1</span></span>) {
      digitalWrite(led_pin, ON);
      wait(<span class="hljs-number"><span class="hljs-number">50</span></span>);
      digitalWrite(led_pin, OFF);
    }
  }
  TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: DATA - TEMPERATURE: %d, HUMIDITY %d\n"</span></span>), t_temp, t_humd);
}


<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readBatLev</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
  ADMUX = _BV(REFS1) | _BV(REFS0) | _BV(MUX0);
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  RF24_startListening();
  wait(<span class="hljs-number"><span class="hljs-number">200</span></span>);
  ADCSRA |= _BV(ADSC);
  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (bit_is_set(ADCSRA, ADSC));
  <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> low  = ADCL;
  <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> high = ADCH;
  <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> temp = (high &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | low;
  <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> vcc = temp * <span class="hljs-number"><span class="hljs-number">1.1</span></span> / <span class="hljs-number"><span class="hljs-number">1023</span></span> * BAT_COOF * <span class="hljs-number"><span class="hljs-number">100</span></span>;
  battery = <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)vcc, BAT_MIN, BAT_MAX, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>);
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (battery &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) {
    battery = <span class="hljs-number"><span class="hljs-number">0</span></span>;
  }
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (battery &gt; <span class="hljs-number"><span class="hljs-number">100</span></span>) {
    battery = <span class="hljs-number"><span class="hljs-number">100</span></span>;
  }
  TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: BATTERY LEVEL: %d, PREVIUS BATTERY LEVEL: %d\n"</span></span>), battery, old_battery);
  TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: BATTERY LEVEL ADC: %d\n"</span></span>), temp);

  <span class="hljs-comment"><span class="hljs-comment">/*
    if (old_battery != battery) {
      if (battery &lt; old_battery) {
        old_battery = battery;
        wait(100);
        sendBatteryLevel(battery);
        wait(100);
        send(powerMsg.set(temp));
        TRANSPORT_DEBUG(PSTR("MyS: SEND BATTERY LEVEL\n"));
      } else {
        battery = old_battery;
      }
    }
  */</span></span>
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  sendBatteryLevel(battery);
  wait(<span class="hljs-number"><span class="hljs-number">100</span></span>);
  send(powerMsg.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(temp));
  TRANSPORT_DEBUG(PSTR(<span class="hljs-string"><span class="hljs-string">"MyS: SEND BATTERY LEVEL\n"</span></span>));
}
</code></pre><br>
</div></div><br>
     :<br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/XWu5sogiiQg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
   :<br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/juQU4pSIvPg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
    (   ),   Mysensors(       Mysensors  )<br>
<br>
<img src="https://habrastorage.org/webt/8x/6i/ie/8x6iie5r4kpdwjan5kqdkvq337c.png"><br>
<br>
      .   ,  , , 3d      <a href="http://www.openhardware.io/">www.openhardware.io</a>.     ,         Mysensors         ‚Äî <b><a href="https://t.me/mysensors_rus">t.me/mysensors_rus</a></b>.</div><p>Source: <a href="https://habr.com/ru/post/452234/">https://habr.com/ru/post/452234/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../452214/index.html">Internships are cannon fodder to plug holes, not ‚Äúinvaluable experience and career prospects.‚Äù</a></li>
<li><a href="../45222/index.html">Work with branches in SVN. Changes in version 1.5.</a></li>
<li><a href="../452228/index.html">Anna Boyarkina, Miro (formerly RealtimeBoard): on grocery thinking, team culture, skills of the future</a></li>
<li><a href="../452230/index.html">We study the tunnel diode on the example of 3I306M</a></li>
<li><a href="../452232/index.html">ObjectRepository - .NET in-memory repository pattern for your home projects</a></li>
<li><a href="../452236/index.html">Harmony of scripts inside the Android application</a></li>
<li><a href="../45224/index.html">In Ukraine, the most popular browser is Opera 9.x</a></li>
<li><a href="../452248/index.html">We pump over development on Vue by means of patterns: HOC</a></li>
<li><a href="../45225/index.html">Sorry, but Gmail themes with Opera don't work for me?</a></li>
<li><a href="../452252/index.html">Security with a taste of Google</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>