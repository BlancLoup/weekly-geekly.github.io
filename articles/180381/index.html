<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Images: formats and compression (1/3)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What does a site consume more traffic? Most often these are pictures, and their total ‚Äúweight‚Äù is often several times larger than that of markup, scri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Images: formats and compression (1/3)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/126/349/aa3/126349aa3dff57f153d635f91bf5bfd7.png" width="228" height="201" alt="Schematic representation of PCX, GIF and PNG"><br><br>  What does a site consume more traffic?  Most often these are pictures, and their total ‚Äúweight‚Äù is often several times larger than that of markup, scripts and styles.  In image files of common formats, raster data is stored in a compressed form, and this is significantly better than uncompressed BMP.  And if you want even better?  After all, in fairly large projects every byte is on the account (for example, in TradingView, which is really too modest). <br><br>  There are many tools for perezhatiya graphics, from highly specialized to powerful combines.  On Habr√© already have a <a href="http://habrahabr.ru/post/168251/">wonderful overview of</a> such programs, and the question of how you can squeeze the picture, considered more than in detail. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But <em>how</em> do such programs work, what can be improved and how to make one's own?  I invite you to a tour of image formats and algorithms for compressing raster data. <br><a name="habracut"></a><br><h2>  Middle Ages </h2><br>  The eighties of the last century were the time of the formation of raster graphics.  Graphics as such has been used before, but now it has become much more accessible, and not least the game industry has influenced it.  Atari 2600 allowed to draw something more refined than a white rectangle.  And Commodore 64 had video memory, with real pixels, and it was more convenient to work with it than ‚Äú <a href="http://en.wikipedia.org/wiki/Television_Interface_Adapter">switch the color no later than the 31415th clock</a> ‚Äù. <br><br>  It is difficult to draw Mona Lisa on the screen, exposing the pixels manually using a tricky algorithm.  Yes, and not necessary, because from the video memory to pull out a piece of data and save it to a file, and then insert it from the file.  Such a memory dump in BASIC was made by the <code>BSAVE</code> team, and the format itself was named after it <a href="http://en.wikipedia.org/wiki/BSAVE_(graphics_image_format)">BSAVE'd</a> .  It became much more convenient to edit images, and simple graphical editors, which are mostly indistinguishable from each other, flourished in a lush color. <br><br>  But some of the editors have outgrown the childhood age and have become a very convenient and useful tool.  So in 1984 appeared PCPaint, in which you could draw with the mouse.  In addition to the obvious comforts of the user interface, PCPaint gave another advantage.  The fact is that the BSAVE dump did not include data on image size, color depth and palette, and if there were few video modes (and the color image was shown in black and white), then for the palette you had to use a separate PAL file.  In the PIC format of PCPaint, both the palette and the BSAVE dump were contained.  This is a small step for the programmer and a giant leap for the whole of humanity.  Something like ‚Äúlet's think out the MKV format, in which the subtitles can be stored inside, so that they do not need to be put in the correct daddy‚Äù. <br><br>  But one more problem remained unsolved: on the PC there is <code>BSAVE</code> and on Apple there is <code>BSAVE</code> , but they generate files of different formats.  This is not surprising, the internal representation of the picture in the memory differed.  There were transcoders, but it became clear that this vendor-dependent fuss would not last long.  In 1984, Truevision introduced the TARGA format, better known as TGA.  And the next in 1985 saw the light of PC Paintbrush.  Although PC Paintbrush sold worse, its PCX format, portable and fairly simple, lived longer than the PIC. <br><br>  Both in TGA and PCX, data on image size and palette were stored explicitly, without strong reference to hardware.  This became possible because pixel data no longer depended on a specific platform and were simply scanlines: from left to right, from top to bottom. <br><br>  But there was another important feature of these two formats, the raster data in them were stored in a compressed form.  The RLE algorithm used was not the height of efficiency, but it was already quite good. <br><br><h2>  RLE </h2><br>  RLE (Run length encoding) is quite a simple algorithm, but it shows well how data compression works.  To compress data without loss means to get rid of redundancy in them.  To do this, take a set of data, find a chain of duplicate values ‚Äã‚Äãin them and replace them with something more compact. <br><br>  <em>RLE is usually translated as ‚Äúrun length coding‚Äù, and such duplicate values ‚Äã‚Äãare called ‚Äúruns‚Äù.</em>  <em>And although I prefer the translation of the ‚Äúrun‚Äù, I can‚Äôt do anything, this is already an established term.</em> <br><br>  Most likely, you are already using it.  Let's look at the line ‚Äú <code>AAAAAAAAAAAABBBAAAAAAAAA</code> ‚Äù.  If we have to dictate it over the phone, it will sound like ‚Äútwelve capital letters A, three capital letters B, nine capital letters A‚Äù.  If we write this down, we get ‚Äú <u><code>12</code></u> <code>A</code> <u><code>3</code></u> <code>B</code> <u><code>9</code></u> <code>A</code> ‚Äù, and in order to avoid misunderstandings, then ‚Äú <u><code>9</code></u> <code>A</code> <u><code>3</code></u> <code>A</code> <u><code>3</code></u> <code>B</code> <u><code>9</code></u> <code>A</code> ‚Äù.  Much more compact. <br><br>  Now take another line, ‚Äú <code>0KXQsNCx0YDQsNGF0LDQsdGA</code> ‚Äù, and try to compress it like this.  It turns out " <u><code>1</code></u> <code>0</code> <u><code>1</code></u> <code>K</code> <u><code>1</code></u> <code>X</code> ...", stop-stop-stop!  The string is obtained twice as long as the original, it is never compression.  We modify the algorithm and add letters to the numbers: the letter A means that the next character is written "as is";  if B, then two;  if C, then three, and so on.  It turns out " <u><code>X</code></u> <code>0KXQsNCx0YDQsNGF0LDQsdGA</code> ".  So, at best, we get a compression of 350%, and at worst, we lose only 4%. <br><br>  Of course, in real conditions, bytes are usually encoded, not letters of the Latin alphabet, and sequence lengths are encoded with values ‚Äã‚Äãfrom 0 to 255. Plus, usually meaningless values ‚Äã‚Äãof run lengths are ignored: in our example, 1 and A do the same, and 0 in general does not make sense.  But these are the details, the essence remains the same. <br><br><h2>  Entropy </h2><br>  No matter how much you want to avoid the theory, this thing is too important to ignore.  Have you noticed that not all sequences can be compressed?  The <code>AAAAAAAAAAAABBBAAAAAAAAA</code> and <code>0KXQsNCx0YDQsNGF0LDQsdGA</code> lines are 24 characters long, but in the second, these characters are more chaotic and harder to compress. <br><br>  The measure of such randomness is informational entropy, which is defined as the amount of information in the message. <br><table><tbody><tr><th><img src="https://habrastorage.org/storage2/6cb/5ec/064/6cb5ec0648f5eea9170e720947124b17.png" width="131" height="131" title="By the way, pay attention to the size of these files."></th><th><img src="https://habrastorage.org/storage2/ea8/741/8da/ea87418da867c479ffc563e3072ee54a.png" width="131" height="131" title="By the way, pay attention to the size of these files."></th><th><img src="https://habrastorage.org/storage2/0a2/3df/7a9/0a23df7a94db5e18300759ee766f8c14.png" width="131" height="131" title="By the way, pay attention to the size of these files."></th></tr><tr><td>  Little entropy </td><td>  More </td><td>  More </td></tr></tbody></table><br>  The very presence of informational entropy suggests that the data can only be compressed to a certain length.  Further, no magic in the process is not involved.  And according to <a href="http://ru.wikipedia.org/wiki/%25D0%25A8%25D0%25B5%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25BD,_%25D0%259A%25D0%25BB%25D0%25BE%25D0%25B4">Claude Shannon</a> , the movie ‚ÄúClick‚Äù does not shrink to kilobytes. <br><br>  To illustrate this, we turn to the fact that at first glance it has nothing to do with IT. <br><table><tbody><tr><th><img src="https://habrastorage.org/storage2/adf/e41/8e0/adfe418e0e619b90a25c8b77d32de947.png" width="127" height="127" alt="Fully Solved Sudoku"></th><th><img src="https://habrastorage.org/storage2/6f3/b90/fa7/6f3b90fa706d63216275311a7f8447f3.png" width="127" height="127" alt="Sudoku"></th><th><img src="https://habrastorage.org/storage2/5ff/fc1/afa/5fffc1afac93ec728f8b067f229a159a.png" width="127" height="127" alt="Unsolvable Sudoku"></th></tr></tbody></table><br>  Sudoku on the left contains 81 figures and has already been resolved.  The one in the middle contains less information, 26 figures, but having solved it, you can restore all the original 81. <br><br>  But on the right side of Sudoku everything is very bad - too much data has been removed from it, and it is no longer solved, that is, we will not receive the initial data set. <br><br><h2>  PCX </h2><br>  But back to the PCX and do what no one else has done for ten years, create the PCX file, and manually.  You need to know your tool, so let's look at the specifications and find out what this format is.  Here are the main points: <br><br><ul><li>  The image can be up to 65536 √ó 65536.  Palette to 256 colors, or 24-bit color without a palette.  The header is always 128 bytes in size. It contains the image size, the number of colors and the palette up to 16 colors one byte per channel.  Naturally, the 256-color palette does not fit into such a header, and if it exists, it is added to the end of the file and has a size of 769 bytes (1 byte of signature and 256 √ó 3 bytes of data).  There is also a field for the CGA palette, but it is no longer supported. </li><li>  The raw data stream consists of scanlines ‚Äî horizontal lines into one scribble.  Up to 4 bit planes can be inside each scanline: R, G, B, A. All planes are written sequentially: <code>RRRRGGGGBBBBAAAA</code> .  Planes consist of a strictly even number of bytes, and, if necessary, placeholders are added to the raw data so that this condition is fulfilled.  Such data placeholders are ignored during decoding. </li><li>  Compression of "raw" raster data is performed line by line, using RLE.  ‚ÄúLine by line‚Äù means that the RLE series cannot go beyond the limits of the bit plane. </li><li>  In RLE, byte values ‚Äã‚Äãfrom 192 to 255 encode the number of repetitions of a character from 0 to 63 times, respectively.  The remaining values ‚Äã‚Äãare literal; if they are found on the place where the number of repetitions is expected, they are considered to be repeated once. </li></ul><br><br><h3>  PCX in practice </h3><br>  Now let's take this technical data sheet as an example.  Take for example such a picture (17 √ó 8, for convenience, increased 8 times): <br><br><img src="https://habrastorage.org/storage2/5bb/303/e79/5bb303e79dd76ea19c08a8e54ec83fb9.png" width="136" height="64" alt="Old school gradient"><br><br>  We will be defined with a palette.  In the image there are three different colors, so we are suitable palettes of 4, 16 and 256 colors, as well as Truecolor.  In the 4-color palette, we will have 4 values ‚Äã‚Äãin one byte (8 bits of a byte divided by 2 bits of the number in the palette);  in 16-color - 2 pixels per byte;  in 256-color - pixel per byte (plus 769 bytes of an additional palette);  in Truecolor, three bytes per pixel.  The choice is obvious, 4 colors. <br><br>  Colors arrange, for example, like this: <br><table><tbody><tr><th><img src="https://habrastorage.org/storage2/a0b/87f/90e/a0b87f90e49e2ba55c2d505c020ce259.png" width="64" height="64" alt="# 000000 0 (00)"></th><th><img src="https://habrastorage.org/storage2/3ed/258/a0b/3ed258a0bc11c044e2152d9438a4dbf4.png" width="64" height="64" alt="# 808080 1 (01)"></th><th><img src="https://habrastorage.org/storage2/93d/751/d1e/93d751d1eca9335012125eca6fd9b0eb.png" width="64" height="64" alt="# 404040 2 (10)"></th><th><img src="https://habrastorage.org/storage2/a3d/c78/53b/a3dc7853ba14cd2df30827257fa3c50b.png" width="64" height="64" alt="(not used)"></th></tr></tbody></table><br><br>  Now we write out the bit values ‚Äã‚Äãof the first line, starting with the most significant bits.  Listing in quaternary, separators - byte boundaries. <br><br> <b><code>0000 0000 0000 0000 0</code></b> <br> <br>  It turns out 4.25 bytes.  RLE with fractional bytes does not work, we finish up to five. <br><br>  <b><code>0000 0000 0000 0000 0</code></b> <code>000</code> <br><br>  The documentation states that there must be an even number of bytes in the scanline.  Nothing to do, we finish more. <br><br>  <b><code>0000 0000 0000 0000 0</code></b> <code>000 0000</code> <br><br>  Do the same with the rest of the lines, we get: <br><br>  <b><code>0000 0000 0000 0000 0</code></b> <code>000 0000</code> <br>  <b><code>0111 1111 1111 1111 0</code></b> <code>000 0000</code> <br>  <b><code>0121 2121 2121 2121 0</code></b> <code>000 0000</code> <br>  <b><code>0212 1212 1212 1212 0</code></b> <code>000 0000</code> <br>  <b><code>0222 2222 2222 2222 0</code></b> <code>000 0000</code> <br>  <b><code>0202 0202 0202 0202 0</code></b> <code>000 0000</code> <br>  <b><code>0020 2020 2020 2020 0</code></b> <code>000 0000</code> <br>  <b><code>0000 0000 0000 0000 0</code></b> <code>000 0000</code> <br><br>  Now let's see what values ‚Äã‚Äãcan be compressed.  We note only sequences of identical bytes longer than 2, because the encoding of a series of 2 bytes will take 2 bytes, and there is no special reason for this. <br><br>  <u><b><code>0000 0000 0000 0000 0</code></b> <code>000 0000</code></u> <br>  <b><code>0111</code> <u><code>1111 1111 1111</code></u> <code>0</code></b> <code>000 0000</code> <br>  <b><code>0121</code> <u><code>2121 2121 2121</code></u> <code>0</code></b> <code>000 0000</code> <br>  <b><code>0212</code> <u><code>1212 1212 1212</code></u> <code>0</code></b> <code>000 0000</code> <br>  <b><code>0222</code> <u><code>2222 2222 2222</code></u> <code>0</code></b> <code>000 0000</code> <br>  <b><u><code>0202 0202 0202 0202</code></u> <code>0</code></b> <code>000 0000</code> <br>  <b><code>0020</code> <u><code>2020 2020 2020</code></u> <code>0</code></b> <code>000 0000</code> <br>  <u><b><code>0000 0000 0000 0000 0</code></b> <code>000 0000</code></u> <br><br>  Please note that although zero bytes at the end of the last but one line are asked to cling to the last line, this will not work, the border of the scanline should not be crossed. <br>  Now the knight's move.  In the specification it is not written anywhere, what exactly is the need to finish scanlines to an even number of bytes.  All the same, the decoder will throw out these values.  Therefore, we can save as much as two bytes by doing this: <br><br>  <u><b><code>0000 0000 0000 0000 0</code></b> <code>000 0000</code></u> <br>  <b><code>0111</code> <u><code>1111 1111 1111</code></u> <code>0</code></b> <code>000 0000</code> <br>  <b><code>0121</code> <u><code>2121 2121 2121</code></u> <code>0</code></b> <code>000 0000</code> <br>  <b><code>0212</code> <u><code>1212 1212 1212</code></u> <code>0</code></b> <code>000 0000</code> <br>  <b><code>0222</code> <u><code>2222 2222 2222</code></u> <code>0</code></b> <code>000 0000</code> <br>  <u><b><code>0202 0202 0202 0202 0</code></b> <code>202 0202</code></u> <br>  <b><code>0020</code> <u><code>2020 2020 2020</code></u> <code>0</code></b> <code>000 0000</code> <br>  <u><b><code>0000 0000 0000 0000 0</code></b> <code>000 0000</code></u> <br><br>  Encode the resulting RLE.  It would probably be more convenient to move to a more familiar hexadecimal view: <br><br> <u><code>00 00 00 00 00 00</code></u> <br>  <code>15</code> <u><code>55 55 55</code></u> <code>00 00</code> <br>  <code>19</code> <u><code>99 99 99</code></u> <code>00 00</code> <br>  <code>26</code> <u><code>66 66 66</code></u> <code>00 00</code> <br>  <code>2A</code> <u><code>AA AA AA</code></u> <code>00 00</code> <br> <u><code>22 22 22 22 22 22</code></u> <br>  <code>08</code> <u><code>88 88 88</code></u> <code>00 00</code> <br> <u><code>00 00 00 00 00 00</code></u> <br> <br>  We encode the first line.  6 bytes <code>0x00</code> .  Repeat 6 times corresponds to the value 192 + 6 = 198 or <code>C6</code> .  After it we write what value we are going to repeat 6 times, it turns out <abbr title="x6"><code>0xC6</code></abbr> <code>0x00</code> .  The first scanline is ready. <br><br>  The second scanline starts from <code>0x15</code> .  This value can be encoded as <abbr title="x1"><code>0xC1</code></abbr> <code>0x15</code> (‚Äúonce <code>0x15</code> ‚Äù).  But due to the RLE feature in PCX, we can write it simply as <code>0x15</code> , and ‚Äúonce‚Äù will be implied. <br><br>  Then three identical bytes become <abbr title="x3"><code>0xC3</code></abbr> <code>0x55</code> . <br><br>  And at the end of the line are two null bytes, which can be represented in two ways: head on, <code>0x00 0x00</code> , or more cleverly, <abbr title="x2"><code>0xC2</code></abbr> <code>0x00</code> .  And this way and that two bytes.  It is unlikely that you will be able to impress girls with a cunning trick, but there are no other reasons <a href="http://lurkmore.to/1337">to do things more intricate than necessary</a> , so we just take <code>0x00 0x00</code> . <br><br>  <font color="gray"><em>By the way, about intricate things.</em></font>  <font color="gray"><em>Insert something like <abbr title="x0"><code>0xC0</code></abbr> <code>0x73</code> <abbr title="x0"><code>0xC0</code></abbr> <abbr title="x0"><code>0xC0</code></abbr> <code>0x73</code> <abbr title="x0"><code>0xC0</code></abbr> <code>0x65</code> <abbr title="x0"><code>0xC0</code></abbr> <code>0x63</code> <abbr title="x0"><code>0xC0</code></abbr> <code>0x72</code> <abbr title="x0"><code>0xC0</code></abbr> <code>0x65</code> <abbr title="x0"><code>0xC0</code></abbr> <code>0x74</code> , i.e., a series with a length of 0, and they will not affect the image itself.</em></font>  <font color="gray"><em>Wikipedia writes that it can be used for steganography, but as for me, it is so sewn with white thread, and it doesn‚Äôt work for anything other than inflating file size.</em></font> <br><br>  Continuing in this way, we get: <br><br>  <abbr title="x6"><code>C6</code></abbr> <code>00</code> <br>  <code>15</code> <abbr title="x3"><code>C3</code></abbr> <code>55 00 00</code> <br>  <code>19</code> <abbr title="x3"><code>C3</code></abbr> <code>99 00 00</code> <br>  <code>26</code> <abbr title="x3"><code>C3</code></abbr> <code>66 00 00</code> <br>  <code>2A</code> <abbr title="x3"><code>C3</code></abbr> <code>AA 00 00</code> <br>  <abbr title="x6"><code>C6</code></abbr> <code>22</code> <br>  <code>08</code> <abbr title="x3"><code>C3</code></abbr> <code>88 00 00</code> <br>  <abbr title="x6"><code>C6</code></abbr> <code>00</code> <br><br>  It remains to add a 128-byte header on top and that's it!  And to admire the resulting, you can run <a href="https://gist.github.com/subzey/e29406374b2cafc591eb">this script</a> .  It is on node.js, but I am sure that it‚Äôs easy to rewrite your favorite language. <br><br><h3>  PCX practice 2: palette </h3><br>  Now take another image and transfer it to PCX again, trying to compress as much as possible.  This time the picture is smaller, 7 √ó 5. <br><br><img src="https://habrastorage.org/storage2/9f3/a25/f7a/9f3a25f7adf79c51ab04afa163713825.png" width="112" height="80" alt="Highly artistic ufo image"><br><br>  This is a UFO.  I know that is not very similar. <br><br>  First of all, choose the color depth: 2 bits.  These are four colors, just as much as we need.  Define a palette, for example, like this: <br><br><table><tbody><tr><th><img src="https://habrastorage.org/storage2/4ce/0e3/9e9/4ce0e39e93e2ceec365f20a34180d2cf.png" width="64" height="64" alt="#FFFFFF 0 (00)"></th><th><img src="https://habrastorage.org/storage2/bef/5ff/f9f/bef5fff9fed09417bd7029c17597c519.png" width="64" height="64" alt="# 84A7CA 1 (01)"></th><th><img src="https://habrastorage.org/storage2/f20/685/046/f20685046398fd5bc6a437df5388d2b3.png" width="64" height="64" alt="# 666666 2 (10)"></th><th><img src="https://habrastorage.org/storage2/cf2/fa6/8ce/cf2fa68ce0fe97008f75e22afcfc7155.png" width="64" height="64" alt="# 404040 3 (11)"></th></tr></tbody></table><br><br>  Now it's the raster data queue.  For the second time, the tedious process of writing tsiferok will not be done, we will immediately write down the raw data and what came out of them in hexadecimal. <br><br><table><tbody><tr><td>  Raw data </td><td>  Compressed data </td></tr><tr><td> <code>0F C0</code> <br> <code>3A B0</code> <br> <code>FF FF</code> <br> <code>D9 9C</code> <br> <code>3F F0</code> </td> <td>  <code>0F</code> <abbr title="x1"><code>C1</code></abbr> <code>C0</code> <br> <code>3A B0</code> <br>  <abbr title="x2"><code>C2</code></abbr> <code>FF</code> <br>  <abbr title="x1"><code>C1</code></abbr> <code>D9 9C</code> <br>  <code>3F</code> <abbr title="x1"><code>C1</code></abbr> <code>F0</code> </td></tr></tbody></table><br><br>  Oops!  Compressed data turned out more in size than the original.  This is because the values ‚Äã‚Äãfrom <code>0xC0</code> to <code>0xFF</code> are repetition markers and cannot be written just like that.  Instead of <code>0xC0</code> had to substitute <abbr title="x1"><code>C1</code></abbr> <code>C0</code> , instead of <code>0xF0</code> - <abbr title="x1"><code>0xC1</code></abbr> <code>0xF0</code> and so on. <br><br>  In the case of <code>0xFF 0xFF</code> we were lucky - we did not lose precious bytes there.  But in general, a sad picture comes out: now RLE, instead of helping, only hinders. <br><br>  Towards hopelessness, let's see what can be done with this.  Markers are bytes with two high bits equal to one, 11 <i>XXXXXX</i> .  Data is written sequentially, starting with the most significant bit.  Reads, with a two-bit color depth, whether a byte is a marker or not, pixels are influenced by a 4 √ó n offset.  Namely, the pixels of color numbered 3 (in our case, dark gray). <br><br><img src="https://habrastorage.org/storage2/ffe/090/c9a/ffe090c9aa0a7b22b0aca9ef3413d8c5.png" width="113" height="81" alt="Columns are selected at offset 0 and 4"><br><br>  Here they are, the culprits of the proliferation of file sizes.  In the third line, the dark gray pixels also fall into the selected columns, but they do not make the weather for us: the line itself will give two identical bytes when encoding. <br><br>  We determine the order of colors in the palette ourselves, so we will select the color number 3 as the one that is least found at the 4 √ó n offset.  Blue is the best candidate, it does not occur in such places at all.  Redefine the palette and make a second attempt. <br><br><table><tbody><tr><th><img src="https://habrastorage.org/storage2/4ce/0e3/9e9/4ce0e39e93e2ceec365f20a34180d2cf.png" width="64" height="64" alt="#FFFFFF 0 (00)"></th><th><img src="https://habrastorage.org/storage2/457/bb9/4c1/457bb94c16c10f790b584eee918dd36e.png" width="64" height="64" alt="# 666666 1 (01)"></th><th><img src="https://habrastorage.org/storage2/154/cc7/ffa/154cc7ffa8cdd5257b08e76a123c18e6.png" width="64" height="64" alt="# 404040 2 (10)"></th><th><img src="https://habrastorage.org/storage2/6bb/845/0cd/6bb8450cdc6794115fa8e69010ca2e31.png" width="64" height="64" alt="# 84A7CA 3 (11)"></th></tr></tbody></table><br><table><tbody><tr><td>  Raw data </td><td>  Compressed data </td></tr><tr><td> <code>0A 80</code> <br> <code>25 60</code> <br> <code>AA AA</code> <br> <code>B7 78</code> <br> <code>2A A0</code> </td> <td> <code>0A 80</code> <br> <code>25 60</code> <br> <code>AA AA</code> <br> <code>B7 78</code> <br> <code>2A A0</code> </td> </tr></tbody></table><br><br>  Compressed data were identical to the original.  RLE this image was too tough, but at least there is no overhead projector.  Anyway, raster data is ready, and this is the maximum that can be squeezed out. <br><br>  Well, and demo: <a href="https://gist.github.com/subzey/9c7bfa3c0f888798ea15">UFO generator</a> <br><br><h3>  Total </h3><br>  Once again, briefly, techniques to help reduce the weight of PCX: <br><br><ul><li>  The choice of the minimum possible color depth (palette size); </li><li>  Optimization of garbage data; </li><li>  Delete meaningless data (series of length 0); </li><li>  Palette optimization. </li></ul><br><br><h2>  To be continued </h2><br>  Well, perhaps that's all.  I will not tell about the TGA, although it is different from the PCX, but there are much more similarities than differences.  And there were no other straightforward graphic formats of that time. <br><br>  Except, of course, the CompuServe GIF format.  We will rummage in it next time. </div><p>Source: <a href="https://habr.com/ru/post/180381/">https://habr.com/ru/post/180381/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../180367/index.html">Its cloud backend in one line of code. Overview BaaS platform "Backendless"</a></li>
<li><a href="../180373/index.html">Yahoo has confirmed the purchase of Tumblr for 1.1 billion dollars, Marissa Mayer has promised not to screw it up</a></li>
<li><a href="../180375/index.html">OData controllers in .NET MVC</a></li>
<li><a href="../180377/index.html">Shadow dom</a></li>
<li><a href="../180379/index.html">The digest of interesting news and materials from the world of PHP over the past two weeks, No. 17 (05/06/2013 - 05/21/2013)</a></li>
<li><a href="../180383/index.html">Flickr gives each user 1 terabyte for storing photos and videos.</a></li>
<li><a href="../180385/index.html">"Sockets" from Jolla</a></li>
<li><a href="../180387/index.html">Curiosity out of vacation</a></li>
<li><a href="../180389/index.html">Opera 14 for Android has been released!</a></li>
<li><a href="../180393/index.html">SmartDeblur 2.1 - recovery of blurred and defocused images</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>