<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Practical use of Desired State Configuration for Windows Server 2012 R2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Linux Administrators: This is an article about ‚ÄúPuppet‚Äù for Windows, and there is already a beta version of DSC for Linux. 
 For those who are in the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Practical use of Desired State Configuration for Windows Server 2012 R2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/720/8d7/fba/7208d7fbaa264104afaffd5d00351469.png"><br><br>  <i>Linux Administrators: This is an article about ‚ÄúPuppet‚Äù for Windows, and there is already a beta version of DSC for Linux.</i> <i><br></i>  <i>For those who are in the subject line: there will be nothing about updates to PowerShell 5.0, just what is available from the ‚Äúbox‚Äù of Windows Server 2012 R2.</i> <br><br><h3>  Preamble </h3><br>  In 2013, with the release of Windows Server 2012 R2, Microsoft announced the advent of Powershell Desired State Configuration (DSC). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At this point, I more or less imagined what similar systems for Linux were doing (for example, the already mentioned Puppet).  Therefore, the proposed features seemed to me insufficient for full automatic system configuration.  And only recent reports about the upcoming Powershell 5.0 and new features of DSC prompted me to pay attention to this technology again. <br><br>  To figure it out, I invented a simpler puzzle: <br><br><ul><li>  Suppose there is a client who wants to install an ASP.NET application developed by us on his server.  In addition to IIS, we need MS SQL Server, and we also need to make some settings of the operating system and install some important utilities. </li></ul><br>  Is it possible, instead of the installation and configuration instructions, to issue a configuration script that will do everything that is required on the newly installed Windows Server 2012 R2? <br><br>  For a better understanding of this article, you probably should first read the description in the Microsoft blog - <a href="http://habrahabr.ru/company/microsoft/blog/253497/">http://habrahabr.ru/company/microsoft/blog/253497/</a> . <br><a name="habracut"></a><br><h3>  Initial position </h3><br>  Initially it was assumed that somewhere at the hosting provider server was ordered.  It has Windows Server 2012 R2 installed and we just received a notification with the administrator password and the ip-address of the server. <br><br>  And we recruit one single command, for example: <br><br><pre><code class="hljs pgsql">makemagic -<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>.example.com</code> </pre> <br>  and after some time we get a ready-to-use system. <br><br>  Unfortunately, this is not possible yet.  But I have good news - this will be in the next version of Windows Server 2016. While I am writing this article, the configuration described below (of course, without installing updates) rolls onto only the installed Technical Preview 3. <br><br><h4>  Server </h4><br>  <i>If you have a Windows Server 2012 R2 image with integrated updates that you can use - feel free to skip this section.</i> <br><br>  In the current version (2012 R2) - a problem in the update chain: <br><br><ol><li>  One of the first tasks I tried to do was to check / adjust the time zone.  To do this, you need to install the latest update of time zones. </li><li>  This update is not installed because it requires a large update KB2919355. </li><li>  Which, in turn, wants to update KB2975061 - this is in my case. </li></ol><br>  None of these updates are available for installation through Windows Update on the newly installed system. <br><br>  Therefore, there are two options: 1) install all updates via Windows Update, but it will take a long time (this process can be done later), or 2) install only a couple of the most necessary ones. <br><br>  In the second case, we do this: connect via RDP to the server, launch the Powershell console with elevated privileges and download the updates we need via a direct link and install them: <br><br><pre> <code class="hljs tex">Invoke-WebRequest -Uri http://download.microsoft.com/download/3/9/7/3971FEA1-C483-409E-BF13-219F8A6E907E/Windows8.1-KB2975061-x64.msu -OutFile .<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Downloads</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span>8.1-KB2975061-x64.msu .<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Downloads</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span>8.1-KB2975061-x64.msu /quiet /norestart Invoke-WebRequest -Uri http://download.microsoft.com/download/2/5/6/256CCCFB-5341-4A8D-A277-8A81B21A1E35/Windows8.1-KB2919355-x64.msu -OutFile .<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Downloads</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span>8.1-KB2919355-x64.msu .<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Downloads</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span>8.1-KB2919355-x64.msu /quiet /promtrestart</code> </pre><br>  After the reboot, our server will be ready to receive the configuration. <br><br>  Once again I remind you that Windows Server 2016 TP3 is immediately ready for experiments with DSC. <br><br><h4>  Admin Computer </h4><br>  <i><b>Important:</b> So some of you might have skipped the previous section: To test this sample configuration, connect the MS SQL Server 2014 image on the server using any available method, I chose Express Edition and connected it as R :.</i> <br><br>  I must upset those who have already upgraded to Windows 10 - there are nuances that will not allow using the configurations created in this system.  The same applies to those who installed Powershell 5.0. <br><br>  Creating and applying configurations was done on Windows 8.1.  Powershell version: <br><br><pre> <code class="hljs tex">PS C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nelsh</span></span></span></span>&gt; <span class="hljs-formula"><span class="hljs-formula">$PSVersionTable Name Value ---- ----- PSVersion 4.0 WSManStackVersion 3.0 SerializationVersion 1.1.0.1 CLRVersion 4.0.30319.34209 BuildVersion 6.3.9600.17400 PSCompatibleVersions {1.0, 2.0, 3.0, 4.0} PSRemotingProtocolVersion 2.2</span></span></code> </pre><br>  But this is still not enough.  It is necessary to enable Powershell Remoting on the administrator‚Äôs computer (on the server, after installing two updates, PSRemoting is already enabled).  This is done in an elevated Powershell console: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Enable</span></span>-PSRemoting -Force</code> </pre><br>  In addition, you need to allow (!) From the administrator‚Äôs computer to connect to other computers. <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>-Item WSMan:\localhost\<span class="hljs-keyword"><span class="hljs-keyword">Client</span></span>\TrustedHosts -<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span> *</code> </pre><br>  For convenience, I also added a line with the ip-address of the created server to the <code>hosts</code> . <br><br><pre> <code class="hljs css">&lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">ip-address</span></span>&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">cs1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span></code> </pre><br>  The source code of the sample is available on Github: <a href="https://github.com/nelsh/DSC-WS2012R2">https://github.com/nelsh/DSC-WS2012R2</a> . <br><br><h3>  First configuration </h3><br>  This is a screenshot of the first version of the DSC-W2012R2.ps1 file (in the repository, for convenience, it lies under the name DSC-W2012R2-First.ps1). <br><br><img src="https://habrastorage.org/files/511/1cd/861/5111cd86146f4dbcba32e486ef99073b.png"><br><br><ul><li>  1-21 lines - the actual configuration itself, called DSCW2012R2. </li><li><ul><li>  In it, on line 3-7, we report that there will be only one parameter - an array of server names. </li><li>  On line 8, we connect the required PowerShell module </li><li>  10-20 lines - a list of used resources in the configuration.  In our case, there is only one ‚ÄúScript‚Äù resource, about it just below. </li></ul></li><li>  23-25 ‚Äã‚Äãlines - since one of the steps is to add a user, we will need to create a password for it.  In order not to deal with encryption - let's allow storing passwords in the configuration in the clear. </li><li>  27 line - creating a configuration.  As a result of executing this script, we will have the file DSCW2012R2 \ cs1.example.com.mof - something like a compiled configuration. </li><li>  29-31 lines - launches the application of the configuration to the server named cs1.example.com.  A standard window for requesting a name and password to access the server appears. </li><li>  Starting from line 33 - an example for simultaneously configuring a pair of servers </li></ul><br>  Back to resources - Powershell DSC has 12 built-in resources.  Most (or rather 11 out of 12) of them are simple and clear.  But for a full system setup, they are clearly not enough.  Microsoft proposes to independently create the necessary resources.  But, frankly, even now I have no particular desire to deal with this. <br><br>  However, when I first met, I did not pay attention to the <b>Script</b> resource.  Consider an example in more detail: <br><br><pre> <code class="hljs perl"> Script First { TestScript = { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-string"><span class="hljs-string">"Test script content"</span></span> ) { $true } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $false } } SetScript = { <span class="hljs-string"><span class="hljs-string">"Set script content"</span></span> } GetScript = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> @{ Result = <span class="hljs-string"><span class="hljs-string">"Result for GetScript"</span></span> GetScript = $GetScript; SetScript = $SetScript; TestScript = $TestScript } }</code> </pre><br>  This is the simplest option that does nothing.  How does he work: <br><br><ul><li>  To apply the configuration, we call the Start-DSCConfiguration command (line 29). </li><li>  When the script reaches the ‚ÄúScript First‚Äù resource during the processing of the resource list, it first calls the code from the TestScript variable.  In our example, it always returns $ true. </li><li>  But if he returned $ false, then the code from the SetScript variable would be called. </li></ul><br>  In these variables there can be any code on Powershell - the scales depend only on our fantasies.  Ideally, the code in TestScipt should verify the correctness of all settings that are performed in SetScript code. <br><br>  Let's try to run our first configuration (using the old habit I run from Far Manager): <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">powershell</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.exe</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-ExecutionPolicy</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RemoteSigned</span></span> .\<span class="hljs-selector-tag"><span class="hljs-selector-tag">DSC-WS2012R2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ps1</span></span></code> </pre><br><img src="https://habrastorage.org/files/49b/7d5/9b9/49b7d59b9dd34d08a168edf104992091.png"><br><br>  Completed without errors. <br><br>  In order not to explain how to start the scan from the administrator‚Äôs computer, I went to our server and ran a couple of commands. <br><br><img src="https://habrastorage.org/files/d09/91c/e1c/d0991ce1ce8e4dd9bd35e3371f66f069.png"><br><br>  First: <code>Test-DSCConfiguration</code> - checks the configuration.  Note the last message (after the yellow text) - True.  Those.  configuration checked and no error detected. <br><br>  The following command: <code>Get-DSCConfiguration</code> - reports details about the current configuration.  It is enough to check the code of our resource ‚ÄúScript First‚Äù with this screenshot in order to understand what is coming from. <br><br>  At this very moment, I realized that, perhaps, everything will turn out. <br><br>  So.  Go to ... <br><br><h3>  Advanced configuration </h3><br>  We start adding real tasks to the node configuration. <br><br>  The first thing I want to be sure of is the name of the computer and the main dns suffix.  If in our DNS zone this computer will be called cs1.example.com, then the name is cs1, and the dns suffix is ‚Äã‚Äãexample.com <br><br>  Let's start with the name.  At first I wrote this code: <br><br><pre> <code class="hljs ruby"> $shortName = $Server.Split(<span class="hljs-string"><span class="hljs-string">"."</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].ToLower() Script ComputerName { SetScript = { Rename-Computer -NewName $shortName } GetScript = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> @{ Result = $env<span class="hljs-symbol"><span class="hljs-symbol">:computerName</span></span> GetScript = $GetScript.Trim(); SetScript = $SetScript.Trim(); TestScript = $TestScript.Trim() } } TestScript = { $env<span class="hljs-symbol"><span class="hljs-symbol">:computerName</span></span>.ToLower() -eq $shortName } }</code> </pre><br>  But it does not work.  SetScript, GetScript, and TestScript do not know anything about variables outside of their range.  You can only transfer using string formatting.  Like this: <br><br><pre> <code class="hljs mel"> $shortName = $Server.Split(<span class="hljs-string"><span class="hljs-string">"."</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].ToLower() Script ComputerName { SetScript = ({ Rename-Computer -NewName <span class="hljs-string"><span class="hljs-string">"{0}"</span></span> } -f @($shortName)) GetScript = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> @{ Result = $env:computerName GetScript = $GetScript.Trim(); SetScript = $SetScript.Trim(); TestScript = $TestScript.Trim() } } TestScript = ({ $env:computerName.ToLower() -eq <span class="hljs-string"><span class="hljs-string">"{0}"</span></span> } -f @($shortName)) }</code> </pre><br>  With the verification of the dns suffix, everything turned out to be simpler - this is a parameter in the registry, so we use the standard Registry resource: <br><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">Registry</span></span> PrimaryDomainSuffix { <span class="hljs-attribute"><span class="hljs-attribute">Key</span></span> = <span class="hljs-string"><span class="hljs-string">"HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\" ValueName = "</span></span>NV Domain<span class="hljs-string"><span class="hljs-string">" Ensure = "</span></span>Present<span class="hljs-string"><span class="hljs-string">" ValueData = "</span></span>example.com<span class="hljs-string"><span class="hljs-string">" ValueType = "</span></span>String<span class="hljs-string"><span class="hljs-string">" }</span></span></code> </pre><br>  To not update automatically during the experiments, we‚Äôll configure Windows Update.  Only receive notifications about available updates: <br><br><pre> <code class="hljs php"> Script WindowsUpdateSettings { SetScript = { $WUSettings = (<span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-Object -com <span class="hljs-string"><span class="hljs-string">"Microsoft.Update.AutoUpdate"</span></span>).Settings $WUSettings.NotificationLevel=<span class="hljs-number"><span class="hljs-number">2</span></span> $WUSettings.IncludeRecommendedUpdates=$true $WUSettings.Save() } GetScript = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> @{ Result = <span class="hljs-string"><span class="hljs-string">''</span></span> GetScript = $GetScript; SetScript = $SetScript; TestScript = $TestScript } } TestScript = { $WUSettings = (<span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-Object -com <span class="hljs-string"><span class="hljs-string">"Microsoft.Update.AutoUpdate"</span></span>).Settings; $WUSettings.NotificationLevel -eq <span class="hljs-number"><span class="hljs-number">2</span></span> -<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> $WUSettings.IncludeRecommendedUpdates -eq $true } }</code> </pre><br><h4>  We get a couple of important updates and still set up the time zone </h4><br>  The next important parameter is the time zone.  And why did I assume that Moscow time is not for everyone?  Apparently, for this: <br><br>  So, the first problem: it looks like the built-in installation tools for a separate update via Windows Update do not exist.  Fortunately, there is a small utility for this task. <br><br>  Create a directory for the utility: <br><br><pre> <code class="hljs perl"> $abcUpdatePath = <span class="hljs-string"><span class="hljs-string">"C:\UTILS\ABC-Update"</span></span> $abcUpdateZip = Join-Path $abcUpdatePath <span class="hljs-string"><span class="hljs-string">"ABC-Update.zip"</span></span> File AbcUpdateDir { Ensure = <span class="hljs-string"><span class="hljs-string">"present"</span></span> DestinationPath = $abcUpdatePath Type = <span class="hljs-string"><span class="hljs-string">"Directory"</span></span> }</code> </pre><br>  Download: <br><br><pre> <code class="hljs ruby"> Script AbcUpdateDownload { DependsOn = <span class="hljs-string"><span class="hljs-string">"[File]AbcUpdateDir"</span></span> SetScript = ({ Invoke-WebRequest -Uri <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/abc-deploy.com/</span></span>Files/ABC-Update.zip -OutFile {<span class="hljs-number"><span class="hljs-number">0</span></span>} } -f @($abcUpdateZip)) GetScript = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> @{ Result = $TestScript GetScript = $GetScript; SetScript = $SetScript; TestScript = $TestScript } } TestScript = ({ Test-Path {<span class="hljs-number"><span class="hljs-number">0</span></span>} } -f @($abcUpdateZip)) }</code> </pre><br>  Unpack using the built-in Archive resource: <br><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">Archive</span></span> AbcUpdateUnpack { <span class="hljs-attribute"><span class="hljs-attribute">Ensure</span></span> = <span class="hljs-string"><span class="hljs-string">"Present"</span></span> DependsOn = <span class="hljs-string"><span class="hljs-string">"[Script]AbcUpdateDownload"</span></span> Path = <span class="hljs-variable"><span class="hljs-variable">$abcUpdateZip</span></span> Destination = <span class="hljs-variable"><span class="hljs-variable">$abcUpdatePath</span></span> }</code> </pre><br>  We start, and, in addition to updating time zones, we will immediately update the .NET Framework to version 4.5.2: <br><br><pre> <code class="hljs perl"> Script AbcUpdateNet452Install { DependsOn = <span class="hljs-string"><span class="hljs-string">"[Archive]AbcUpdateUnpack"</span></span> SetScript = { C:\UTILS\ABC-Update\ABC-Update.exe /a:install /k:<span class="hljs-number"><span class="hljs-number">2934520</span></span> } GetScript = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> @{ Result = <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( Get-HotFix -Id KB293452<span class="hljs-number"><span class="hljs-number">0</span></span> -ErrorAction SilentlyContinue ) { <span class="hljs-string"><span class="hljs-string">"KB2934520: Installed"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-string"><span class="hljs-string">"KB2934520: Not Found"</span></span> } GetScript = $GetScript; SetScript = $SetScript; TestScript = $TestScript } } TestScript = { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( Get-HotFix -Id KB293452<span class="hljs-number"><span class="hljs-number">0</span></span> -ErrorAction SilentlyContinue ) { $true } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $false } } } Script AbcUpdateTimeZoneInstall { DependsOn = <span class="hljs-string"><span class="hljs-string">"[Archive]AbcUpdateUnpack"</span></span> SetScript = { C:\UTILS\ABC-Update\ABC-Update.exe /a:install /k:<span class="hljs-number"><span class="hljs-number">3013410</span></span> } GetScript = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> @{ Result = <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( Get-HotFix -Id KB301341<span class="hljs-number"><span class="hljs-number">0</span></span> -ErrorAction SilentlyContinue ) { <span class="hljs-string"><span class="hljs-string">"KB3013410: Installed"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-string"><span class="hljs-string">"KB3013410: Not Found"</span></span> } GetScript = $GetScript; SetScript = $SetScript; TestScript = $TestScript } } TestScript = { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( Get-HotFix -Id KB301341<span class="hljs-number"><span class="hljs-number">0</span></span> -ErrorAction SilentlyContinue ) { $true } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $false } } }</code> </pre><br>  Finally we got to the time zones.  I chose the time zone near Lake Baikal as a scientific method. <br><br>  I found this option: you can only change the time zone using the tzutil.exe command line utility, and check only with Powershell.  But this case is special - when installing, one value is used ‚ÄúNorth Asia East Standard Time‚Äù, and a completely different ‚ÄúRussia TZ 7 Standard Time‚Äù is checked: <br><br><pre> <code class="hljs ruby"> Script TimeZoneSettings { SetScript = { tzutil.exe /s <span class="hljs-string"><span class="hljs-string">"North Asia East Standard Time"</span></span> } GetScript = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> @{ Result = [System.TimeZone]<span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:CurrentTimeZone</span></span>.StandardName GetScript = $GetScript.Trim(); SetScript = $SetScript.Trim(); TestScript = $TestScript.Trim() } } TestScript = { [System.TimeZone]<span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:CurrentTimeZone</span></span>.StandardName -eq <span class="hljs-string"><span class="hljs-string">"Russia TZ 7 Standard Time"</span></span> } }</code> </pre><br>  It seems that such a trouble with all the time zones of Russia. <br><br><h4>  Windows components </h4><br>  With them, everything is very simple and a very large number of examples on the Internet.  It may well seem that Windows administrators are only involved in installing and removing components.  Only the first two WindowsFeature resources from the configuration: <br><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">WindowsFeature</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>FSSMB1 { <span class="hljs-attribute"><span class="hljs-attribute">Ensure</span></span> = <span class="hljs-string"><span class="hljs-string">"Absent"</span></span> Name = <span class="hljs-string"><span class="hljs-string">"FS-SMB1"</span></span> } WindowsFeature WebAspNet45 { <span class="hljs-attribute"><span class="hljs-attribute">Ensure</span></span> = <span class="hljs-string"><span class="hljs-string">"Present"</span></span> Name = <span class="hljs-string"><span class="hljs-string">"Web-Asp-Net45"</span></span> IncludeAllSubFeature = <span class="hljs-variable"><span class="hljs-variable">$True</span></span> }</code> </pre><br>  In the first case, the component is deleted; in the second, it is put together with all dependencies. <br><br><h4>  Package installation </h4><br>  On the example of Far Manager.  First, you need to download the package in a way we already know: <br><br><pre> <code class="hljs tex"> Script FarDownLoad { SetScript = { Invoke-WebRequest -Uri http://www.farmanager.com/files/Far30b4400.x64.20150709.msi -OutFile C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Public</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Downloads</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Far</span></span></span></span>30b4400.x64.20150709.msi } GetScript = { return @{ Result = Test-Path C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Public</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Downloads</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Far</span></span></span></span>30b4400.x64.20150709.msi GetScript = <span class="hljs-formula"><span class="hljs-formula">$GetScript; SetScript = $</span></span>SetScript; TestScript = <span class="hljs-formula"><span class="hljs-formula">$TestScript } } TestScript = { Test-Path C:</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Public</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Downloads</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Far</span></span></span></span></span><span class="hljs-formula">30b4400.x64.20150709.msi } }</span></span></code> </pre><br>  In the parameters of the Package resource is "ProductId".  And there seems to be even a program that analyzes the msi file and reports this very ‚ÄúProductId‚Äù.  I went right through: I immediately tried to apply the configuration without this parameter and found the ‚ÄúProductId‚Äù as well as the correct ‚ÄúName‚Äù in the error text.  The description of the resource turned out the following: <br><br><pre> <code class="hljs pgsql"> Package FarInstall { Ensure = "Present" DependsOn = "[Script]FarDownLoad" <span class="hljs-type"><span class="hljs-type">Name</span></span> = "Far Manager 3 x64" ProductId = <span class="hljs-string"><span class="hljs-string">'E5512F32-B7C1-48E3-B6AF-E5F962F99ED6'</span></span> <span class="hljs-type"><span class="hljs-type">Path</span></span> = "C:\Users\Public\Downloads\Far30b4400.x64.20150709.msi" Arguments = <span class="hljs-string"><span class="hljs-string">''</span></span> LogPath = "C:\Users\Public\Downloads\FarInstall.log" }</code> </pre><br><h4>  Users and rights </h4><br>  By the formulation of the problem, the server is under the control of the customer, but nevertheless I have allowed that there will be a possibility of updating the web application using our continuous integration server.  We use Jenkins CI (by the way, all tasks in it are also implemented on Powershell). <br><br>  In the minimal version, we need a Jenkins user in the Users group and with write access to the directory where the web application is located.  Let it be <code>c:\web</code> . <br><br>  The user is created this way: <br><br><pre> <code class="hljs bash"> <span class="hljs-variable"><span class="hljs-variable">$JenkinsCredential</span></span> = New-Object System.Management.Automation.PSCredential(` <span class="hljs-string"><span class="hljs-string">"Jenkins"</span></span>, (<span class="hljs-string"><span class="hljs-string">"Pa`$`</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$w0rd</span></span></span><span class="hljs-string">"</span></span> | ConvertTo-SecureString -asPlainText -Force)` ) User JenkinsUser { UserName = <span class="hljs-string"><span class="hljs-string">"Jenkins"</span></span> Ensure = <span class="hljs-string"><span class="hljs-string">"Present"</span></span> Password = <span class="hljs-variable"><span class="hljs-variable">$JenkinsCredential</span></span> PasswordChangeNotAllowed = <span class="hljs-variable"><span class="hljs-variable">$true</span></span> PasswordNeverExpires = <span class="hljs-variable"><span class="hljs-variable">$true</span></span> }</code> </pre><br>  There is a way to use encrypted passwords in the configuration, but we will go easy.  In this case, the user ‚ÄúJenkins‚Äù will be created with the password ‚ÄúPa $$ w0rd‚Äù. <br><br>  Creating a directory is already done in the usual way.  But with the appointment of rights to directories and checking had to tinker: <br><br><pre> <code class="hljs swift"> $<span class="hljs-type"><span class="hljs-type">AccessStringTmpl</span></span> = <span class="hljs-string"><span class="hljs-string">"NT AUTHORITY\SYSTEM Allow FullControl`nBUILTIN\Administrators Allow FullControl`nBUILTIN\Users Allow ReadAndExecute, Synchronize`nCS1\Jenkins Allow Modify, Synchronize"</span></span> <span class="hljs-type"><span class="hljs-type">File</span></span> <span class="hljs-type"><span class="hljs-type">DirDweb</span></span> { <span class="hljs-type"><span class="hljs-type">Ensure</span></span> = <span class="hljs-string"><span class="hljs-string">"present"</span></span> <span class="hljs-type"><span class="hljs-type">DestinationPath</span></span> = <span class="hljs-string"><span class="hljs-string">"c:\web"</span></span> <span class="hljs-type"><span class="hljs-type">Type</span></span> = <span class="hljs-string"><span class="hljs-string">"Directory"</span></span> } <span class="hljs-type"><span class="hljs-type">Script</span></span> <span class="hljs-type"><span class="hljs-type">AclsDweb</span></span> { <span class="hljs-type"><span class="hljs-type">DependsOn</span></span> = <span class="hljs-string"><span class="hljs-string">"[File]DirDweb"</span></span> <span class="hljs-type"><span class="hljs-type">SetScript</span></span> = { icacls <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\web /reset /t /q takeown.exe /fc:\web /r /a /dy icacls.exe <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\web /inheritance:r icacls.exe <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\web /grant:r <span class="hljs-string"><span class="hljs-string">"Administrators:(OI)(CI)(F)"</span></span> <span class="hljs-string"><span class="hljs-string">"System:(OI)(CI)(F)"</span></span> <span class="hljs-string"><span class="hljs-string">"Users:(OI)(CI)(RX)"</span></span> <span class="hljs-string"><span class="hljs-string">"Jenkins:(OI)(CI)(M)"</span></span> /t /q } <span class="hljs-type"><span class="hljs-type">GetScript</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> @{ <span class="hljs-type"><span class="hljs-type">Result</span></span> = (<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-acl <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\web).<span class="hljs-type"><span class="hljs-type">AccessToString</span></span> <span class="hljs-type"><span class="hljs-type">GetScript</span></span> = $<span class="hljs-type"><span class="hljs-type">GetScript</span></span>; <span class="hljs-type"><span class="hljs-type">SetScript</span></span> = $<span class="hljs-type"><span class="hljs-type">SetScript</span></span>; <span class="hljs-type"><span class="hljs-type">TestScript</span></span> = $<span class="hljs-type"><span class="hljs-type">TestScript</span></span> } } <span class="hljs-type"><span class="hljs-type">TestScript</span></span> = ({ (<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-acl <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\web).<span class="hljs-type"><span class="hljs-type">AccessToString</span></span> -eq <span class="hljs-string"><span class="hljs-string">"{0}"</span></span> } -f @($<span class="hljs-type"><span class="hljs-type">AccessStringTmpl</span></span>)) }</code> </pre><br>  It's easier to assign permissions using <code>icacls.exe</code> .  In this case, it is performed in order: <br><br><ol><li>  in the first line: reset all rights and enable inheritance from the parent directory </li><li>  in the second: the owner is assigned to the built-in Administrators group </li><li>  in the third: inheritance is canceled and all rights are deleted </li><li>  in the fourth: the assignment of full rights for Administrators and SYSTEM, reading for users and change for Jenkins. </li></ol><br>  For verification, use the <code>(get-acl c:\web).AccessToString</code> - the resulting string must match the <code>$AccessStringTmpl</code> variable.  By the way, the error in the example - the name of the server ‚ÄúCS1‚Äù is explicitly indicated in the string - and the value <code>$Server.Split(".")[0].ToUpper()</code> should be substituted. <br><br><h4>  MS SQL </h4><br>  I was somewhat sorry that I decided not to use third-party modules.  Since there is already a module for installing and configuring MS SQL Server.  But I have a configuration file for automatic installation and I decided to try it. <br><br>  First, we need another Windows component ‚Äî the ‚ÄúWindowsFeature NetFrameworkCore‚Äù resource: <br><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">WindowsFeature</span></span> NetFrameworkCore { <span class="hljs-attribute"><span class="hljs-attribute">Ensure</span></span> = <span class="hljs-string"><span class="hljs-string">"Present"</span></span> Name = <span class="hljs-string"><span class="hljs-string">"Net-Framework-Core"</span></span> IncludeAllSubFeature = <span class="hljs-variable"><span class="hljs-variable">$True</span></span> }</code> </pre><br>  Secondly, the configuration file for the installer is the ‚ÄúScript MSSQLConfigDownLoad‚Äù resource: <br><br><pre> <code class="hljs tex"> Script MSSQLConfigDownLoad { SetScript = { Invoke-WebRequest -Uri https://raw.githubusercontent.com/nelsh/DSC-WS2012R2/master/SQL2014-Setup.ini -OutFile C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Public</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Downloads</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SQL</span></span></span></span>2014-Setup.ini } GetScript = { return @{ Result = Test-Path C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Public</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Downloads</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SQL</span></span></span></span>2014-Setup.ini GetScript = <span class="hljs-formula"><span class="hljs-formula">$GetScript; SetScript = $</span></span>SetScript; TestScript = <span class="hljs-formula"><span class="hljs-formula">$TestScript } } TestScript = { Test-Path C:</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Public</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Downloads</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">SQL</span></span></span></span></span><span class="hljs-formula">2014-Setup.ini } }</span></span></code> </pre><br>  Thirdly, you did not forget to connect the image with the distribution kit of any edition of MS SQL Server 2014? <br><br><pre> <code class="hljs perl"> Script MSSQL { SetScript = { r:\setup.exe /configurationfile=C:\Users\Public\Downloads\SQL2014-Setup.ini /SAPWD=<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-keyword"><span class="hljs-keyword">q</span></span>@w3e } GetScript = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> @{ Result = <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( Get-Service -Name <span class="hljs-string"><span class="hljs-string">"MSSQLSERVER"</span></span> -ErrorAction SilentlyContinue ) { <span class="hljs-string"><span class="hljs-string">"Servise MSSQLSERVER is exist"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-string"><span class="hljs-string">"Servise MSSQLSERVER not found"</span></span> } GetScript = $GetScript; SetScript = $SetScript; TestScript = $TestScript } } TestScript = { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( Get-Service -Name <span class="hljs-string"><span class="hljs-string">"MSSQLSERVER"</span></span> -ErrorAction SilentlyContinue ) { $true } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $false } } }</code> </pre><br>  I used the Express Edition disc, which is connected as R :.  The process will install the Database Engine plus FullSearch, as well as administrative tools.  Testing in TestScript is the easiest - is there a service MSSQLSERVER or not. <br><br>  <i>... And when, according to the list of processes on the server, I realized that the installation had started, it became clear that the experiment can be considered complete.</i> <br><br>  Further configuration may depend on the situation: if you need to urgently show a working application, then in some way we get and install our application. <br><br>  If we have a scheduled installation (without emergency hands), then you can pre-configure the firewall and install utilities (monitoring, backup) - everyone can have their own options.  From what is used here, only AWStats can cause the greatest difficulty: the code in TestScript will resemble a small program, but this can also be solved. <br><br>  Therefore, I decided to stop at this point.  In my opinion, it turned out a good example that anyone can adapt to their situation. <br><br><h3>  Preliminary results </h3><br>  In my opinion, DSC can be adopted without waiting for the next version of Windows Server. <br><br>  In domain infrastructure, this technology cannot completely replace group policies, but it has certain advantages: <br><br><ul><li>  It can be used both in manual mode and in automatic mode with a configuration server. </li><li>  It can be used regardless of the presence of Active Directory, and maybe together with group policies. </li><li>  The configuration directory can be put in the version control system. </li><li>  With the release of Powershell 5.0, we get a convenient way to use additional modules - see powershellgallery.com.  There are already several dozen modules created by the community.  Perhaps among them there are already those with which you can replace the scripts from my example. </li></ul><br>  Please note that errors in the example from this article are possible, and there are also probably more effective solutions. <br><br>  <b>Last important note</b> : as far as I understand, the issue of the necessary reboot in the configuration process, even in new versions, has no solution.  Therefore, the configuration described above is applied in two passes ‚Äî and for both 2012R2 and 2016 ‚Äî it is interrupted during the installation of components and asks for a reboot.  After that, you need to restart the application configuration. <br><br><h4>  useful links </h4><br><ul><li>  All examples from this article are in a project on Github. <br>  <a href="https://github.com/nelsh/DSC-WS2012R2">https://github.com/nelsh/DSC-WS2012R2</a> </li><li>  Windows PowerShell Desired State Configuration Overview <br>  <a href="https://technet.microsoft.com/ru-ru/library/dn249912.aspx">https://technet.microsoft.com/ru-ru/library/dn249912.aspx</a> </li><li>  Near future Powershell 5.0 and DSC <br>  <a href="https://www.powershellgallery.com/">https://www.powershellgallery.com/</a> <br>  <a href="http://blogs.msdn.com/b/powershell/archive/2015/09/15/updated-dsc-resource-kit-available-in-powershell-gallery.aspx">http://blogs.msdn.com/b/powershell/archive/2015/09/15/updated-dsc-resource-kit-available-in-powershell-gallery.aspx</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/267829/">https://habr.com/ru/post/267829/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../267817/index.html">Operation BATMAN: Adding Core Modules to Yocto on Intel Edison</a></li>
<li><a href="../267819/index.html">Escene ES330-N / ES330-PN IP Phones Review with Escene ESM 32 Expansion Module</a></li>
<li><a href="../267823/index.html">Who has not connected to the web? We connect remote regions with balloons, drones and an armada of satellites</a></li>
<li><a href="../267825/index.html">Unix shell: absolutely first steps</a></li>
<li><a href="../267827/index.html">Big Data vs Data Mining</a></li>
<li><a href="../267831/index.html">About the features of geolocation technology in MDK</a></li>
<li><a href="../267833/index.html">Audit of system events in Linux</a></li>
<li><a href="../267837/index.html">Todoist transition to Material Design</a></li>
<li><a href="../267839/index.html">Ready assembly of the news portal NewsModxBox</a></li>
<li><a href="../267841/index.html">Deploying your own OpenVPN</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>