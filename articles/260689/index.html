<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Battle for ADFS (Active Directory Federation Services)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 The project began as a portal based on SP 2007, and later on the basis of 2010 SP. Initially, all users were in Active Directory. There w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Battle for ADFS (Active Directory Federation Services)</h1><div class="post__text post__text-html js-mediator-article"><h4>  Prehistory </h4><br>  The project began as a portal based on SP 2007, and later on the basis of 2010 SP.  Initially, all users were in Active Directory.  There was only one type of user.  The links between them were fairly simple.  New types of users appeared that in a complex way became connected with each other.  Gradually, the project also acquired various related subsystems, some of which worked inside the portal, some outside.  And all this complicated the authorization scheme. <br><br><img src="https://habrastorage.org/files/9a7/803/233/9a78032337054a06af97eb9dc16513d5.jpg"><br><a name="habracut"></a><br><h4>  What problems? </h4><br>  Up to a certain point, using NTLM has satisfied all needs.  The only problem was that when faced with the transition to the related service, if the url-address was different from the portal address, it was necessary to re-enter the login and password.  In principle, such a problem could be solved with the help of the web application proxy product.  Later, however, Java modules appeared, and so the environment became largely heterogeneous.  Also on the horizon loomed the need to provide access to users from third-party domains.  To solve these problems, the need for Single Sign On (SSO) has become clear.  It was decided to implement ADFS and transfer the portal and all services to this technology. <br><br>  We discussed our vision with the customer and scheduled Day X, when everything should work on ADFS. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Course of events: </h4><br><br><h5>  Day X - 1 year </h5><br>  First of all, we decided to switch one of the modules to ADFS. <br>  The idea was to include ADFS on the portal, stuff all the bumps that you can stuff, burn yourself, where you can burn yourself, etc.  Having identified a certain number of problems, we successfully conducted this switch, as already <a href="http://habrahabr.ru/company/eastbanctech/blog/209834/">mentioned, habrahabr.ru/company/eastbanctech/blog/209834</a> . <br><br><h5>  Day X - 3 months </h5><br>  The first thing we started with is refactoring the code so that it works correctly under Claims Authentication.  A couple of examples from what we changed: <br><br>  1. Distribution of permissions to SharePoint list items for users and Active Directory groups.  Since permissions were now to be distributed to claims, we had to rewrite all these places.  It is good that almost all such places used one of our libraries for working with AD (and those that we did not use were changed in such a way that they also work with our library). <br><br>  Instead of distributing permissions to users of the ‚Äúdomain \ user‚Äù type, permissions were issued to the ‚Äúi: 0e.t | ADFS | user @ domain‚Äù screens.  For ‚Äúdomain \ group‚Äù - to the form ‚Äúc: 0-.t | ADFS | group‚Äù respectively.  We also had to separate the cases when permissions are issued to the user from the cases when they are issued to the group, because without using claims, domain groups look the same in MS SharePoint.  Thus, the GetPrincipalName method, which defines the full name of a principal, I turned into 2: <br><br><pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetGroupPrincipalName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">group</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(TrustedIdentityProviderName)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(CultureInfo.InvariantCulture, <span class="hljs-string"><span class="hljs-string">"{0}\\{1}"</span></span>, CurrentDomain, GetPrincipalNameWithoutDomain(<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Concat(<span class="hljs-string"><span class="hljs-string">"c:0-.t|"</span></span>, TrustedIdentityProviderName, <span class="hljs-string"><span class="hljs-string">"|"</span></span>, GetPrincipalNameWithoutDomain(@<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetUserPrincipalName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> user</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(TrustedIdentityProviderName)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(CultureInfo.InvariantCulture, <span class="hljs-string"><span class="hljs-string">"{0}\\{1}"</span></span>, CurrentDomain, GetPrincipalNameWithoutDomain(user.ToLower(CultureInfo.InvariantCulture))); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Concat(<span class="hljs-string"><span class="hljs-string">"i:0e.t|"</span></span>, TrustedIdentityProviderName, <span class="hljs-string"><span class="hljs-string">"|"</span></span>, GetPrincipalNameWithoutDomain(user), TrustedIdentityProviderDomain); }</code> </pre> <br>  2. Checks for group membership <br>  Checks for group membership also went through this library, so they didn‚Äôt have to be changed much.  Changed only the functionality defined by the user.  Now, it was possible to file as domain users as well as key users: <br><br><pre> <code class="hljs tex">public static string GetPrincipalNameWithoutDomain(string principal) { if (string.IsNullOrEmpty(principal)) return string.Empty; return Regex.Match(principal.Trim(), @"(i:)?0e.t.*<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">|</span></span></span></span>(?&lt;userName&gt;[<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">d</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w</span></span></span></span>_&amp;<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">.</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">s</span></span></span></span>-]+)@[<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">d</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">.</span></span></span></span>_]|(c:)?0-.t.*<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">|</span></span></span></span>(?&lt;userName&gt;[<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">d</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w</span></span></span></span>_&amp;<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">.</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">s</span></span></span></span>-]+)<span class="hljs-formula"><span class="hljs-formula">$|^(?&lt;userName&gt;[</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">d</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">w</span></span></span></span></span><span class="hljs-formula">_&amp;</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">.</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">s</span></span></span></span></span><span class="hljs-formula">-]+)@[</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">w</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">d</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">.</span></span></span></span></span><span class="hljs-formula">_]|^(?&lt;userName&gt;[</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">d</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">w</span></span></span></span></span><span class="hljs-formula">_&amp;</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">.</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">s</span></span></span></span></span><span class="hljs-formula">-]+)$</span></span>|[<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w</span></span></span></span>]+<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>(?&lt;userName&gt;[<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">d</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w</span></span></span></span>_&amp;<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">.</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">s</span></span></span></span>-]+)<span class="hljs-formula"><span class="hljs-formula">$") .Groups["userName"].Value; }</span></span></code> </pre><br><br>  Why was this done?  At some point, it turned out that part of the team is already working on servers transferred to ADFS, and the rest on servers with NTLM authentication.  Since we managed to ensure that our library worked in the same way for both NTLM and ADFS, this helped not to stop the process of developing new modules. <br><br><h5>  Day X - 2 months </h5><br>  After a month or two, the portal came to life, earned basic things, a news module, Sharepoint Workflows-based business processes and much more. <br><br>  After that, the portal migrated on the test environment, made a checklist for our endless modules, assigned those responsible for each module and flew according to the scheme: <br><br>  ‚Ä¢ module made <br>  ‚Ä¢ rolled out for testing <br>  ‚Ä¢ found a bunch of bugs, corrected <br>  ‚Ä¢ module is ready <br><br><h4></h4><h5>  Along the way, we met a couple of interesting problems. </h5><br><h5>  1. The first problem we encountered is a call to SOAP services. </h5><br>  Most of the wcf-services that ‚Äúlive‚Äù in the _vti_bin folder are used by scripts from the browser and via webHttpBinding.  Of the remaining, some services are used for inter-module communication, and the rest are needed by other client systems with which integration is configured.  Naturally, most of these interactions are based on SOAP (more convenient) and tied to NTLM authentication.  For a start, we tried to understand how problematic it would be to transfer all clients (at least ours, working on WCF) to ADFS.  We tried, were amazed at the number of necessary movements and the complexity of the client's configuration and forgot this thought.  We spent some time trying to get SharePoint to work simultaneously with two authentication schemes for services (yes, so that users don't notice).  It did not work, NTLM stubbornly refused to work (about the reasons below). <br><br>  Thus, we needed to urgently return the "real" NTLM for services.  Therefore, we turned to the possibility of SharePoint, as the extension (extend) of web applications.  We reasoned that the main address will remain REST-services for the browser, which the user's browser will authenticate, and all the service services will be transferred to the address of the extended site that will work with NTLM.  It would seem that everything is just ... Began. <br><br>  We expanded the portal already translated to ADFS using standard SharePoint tools (Extend Web application), choosing Authentication Provider for the extended NTLM site as the Authentication Provider.  Expected result: all users of WCF services from the ISAPI service directory in SharePoint work with them, as before, maximum - the address of the called service in the client section in the Web.config configuration file rules.  The extension of the main site, already translated to ADFS, did not immediately solve the problems of WCF-service calls for users through NTLM authentication - we inexorably received an answer to every WCF-service call: ‚ÄúThe HTTP request is unauthorized with client authentication scheme 'Ntlm'.  The authentication header received from the server was 'Negotiate, NTLM'. ‚Äù  The real cause of the problem was that when expanding the main site into the main configuration file ‚ÄúWeb.config‚Äù, Sharepoint copied the wrong authentication modules in the ‚Äúmodules‚Äù section: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"FederatedAuthentication"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Microsoft.SharePoint.IdentityModel.SPFederationAuthenticationModule ‚Ä¶"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"SessionAuthentication"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Microsoft.SharePoint.IdentityModel.SPSessionAuthenticationModule ‚Ä¶"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"SPWindowsClaimsAuthentication"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Microsoft.SharePoint.IdentityModel.SPWindowsClaimsAuthenticationHttpModule ‚Ä¶"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  Whereas the correct module for an NTLM site is: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Session"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.Web.SessionState.SessionStateModule"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  After a long discussion, we decided to act in the following sequence: <br>  - create an extension of the main site before its transfer to ADFS, then the previous correct NTLM authentication module will remain; <br>  - transfer the main portal site to Sharepoint on ADFS <br>  If you have the same WCF-services in ISAPI, which have endpoints simultaneously for both access via NTLM and ADFS, they will require simultaneous support of the IIS site for "Forms Authentication" and " Windows authentication.  In our case, we have the main Sharepoint site and its extension, which intentionally do not simultaneously support both authentication methods.  To solve this problem used: <br><br>  - Create two subfolders in the ISAPI "ModuleServiceAdfs", "ModuleServiceNtlm" <br><br>  - copy the WCF service svc file into both folders <br><br>  - create in each folder its own configuration file ‚ÄúWeb.config‚Äù - in the first for ADFS, in the second - for NTLM. <br><br><h4>  2. The second problem is the obsolescence of the saml token. </h4><br>  Most of the queries that were performed to the server worked through ajax via jquery.  In this case, periodically there are situations when the saml-token becomes invalid (when the token is outdated, when the sharepoint pool was restarted, when the ADFS pool was restarted).  The standard mechanism for redirecting to an authentication page with autoupdate of a token or entering a login / password and further returning to the original page does not work in the case of jquery.ajax.  And the situation itself, when the user has to be sent to the authentication page only to automatically return him to the original page, but with lost results of work, did not inspire enthusiasm.  A quick search on the Internet led us to <a href="https://adammills.wordpress.com/2013/12/02/making-ajax-play-with-passive-adfs-2-1-and-2-0-reactive-authentication/">this decision</a> .  For those who are too lazy to follow the link, the essence of the decision in the institution of the preauth page and wrapping all ajax requests with a handler, which, in case of a server 401 response, loads this page via iFrame, and then repeats the original request.  Creating a single point of fulfillment of ajax-requests for our case was not a problem, because the application was written in this manner (We already talked about our approach in <a href="http://habrahabr.ru/company/eastbanctech/blog/245361/">this</a> and <a href="http://habrahabr.ru/company/eastbanctech/blog/212197/">this</a> article). <br><br><h4>  We developed the solution found by making some additions: </h4><br>  1. In case several requests were made in a row, instead of creating for each iFrame when receiving 401, we return the same deferred for the second and subsequent requests that was created for the first request. <br><br>  2. This approach works when the token is outdated or when sharepoint has ‚Äúforgotten‚Äù it.  But it did not work in the case when ADFS ‚Äúforgot‚Äù us, in this case it is required to re-enter the login / password.  The approach described in the article on such cases led to an endless cycle of loading a preauth page through the iFrame without any result.  A direct redirect to the authentication page was also not very pleasant, since it meant a loss of user experience.  The solution was to display the modal to enter the login / password in case the download through iFrame did not help, and we again received 401. The modnale, in turn, makes a call to the custom service, which already performs authentication in ADFS.  After performing the authentication, we duplicate the original ajax request / requests. <br>  The updated code looks like this: <br><br><pre> <code class="javascript hljs">refreshToken: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wcfDispatcherDef.frameLoadPromise === <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> jquery.Deferred(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">d</span></span></span><span class="hljs-function">) </span></span>{ wcfDispatcherDef.frameLoadPromise = d; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> iFrame = jquery(<span class="hljs-string"><span class="hljs-string">'&lt;iframe&gt;&lt;/iframe&gt;'</span></span>); iFrame.hide(); iFrame.appendTo(<span class="hljs-string"><span class="hljs-string">'body'</span></span>); iFrame.attr(<span class="hljs-string"><span class="hljs-string">'src'</span></span>, wcfDispatcherDef.PreauthUrl); iFrame.load(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ wcfDispatcherDef.frameLoadPromise = <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>; d.resolve(); iFrame.remove(); }, <span class="hljs-number"><span class="hljs-number">100</span></span>); }); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> wcfDispatcherDef.frameLoadPromise; } }, <span class="hljs-attr"><span class="hljs-attr">makeServiceCall</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">settings, initialPromise</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> d = initialPromise || jquery.Deferred(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> promise = jquery.ajax(settings) .done(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ d.resolveWith(self.requestContext || self, jquery.makeArray(<span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>)); }).fail(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error.status * <span class="hljs-number"><span class="hljs-number">1</span></span> === ETR.HttpStatusCode.Unauthorized &amp;&amp; wcfDispatcherDef.HandleUnauthorizedError === <span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (initialPromise) { wcfDispatcherDef.AuthDialog.show().done(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">result</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result === <span class="hljs-literal"><span class="hljs-literal">true</span></span>) { self.makeServiceCall.call(self, settings, d).done(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ d.resolveWith(self.requestContext || self, jquery.makeArray(<span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>)); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { router.navigate(<span class="hljs-string"><span class="hljs-string">'#forbidden'</span></span>); } }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { self.refreshToken().then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ self.makeServiceCall.call(self, settings, d).done(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ d.resolveWith(self.requestContext || self, jquery.makeArray(<span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>)); }); }); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { d.rejectWith(self.requestContext || self, jquery.makeArray(<span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>)); } }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> d; },</code> </pre><br><br>  In addition, we have solved many interesting problems that we do not include here, since their description draws on a whole book. <br><br><h4>  Day X - 1 month </h4><br>  When we finished on the test environment, finalized the instructions, collected a huge package for updating and conducted a test migration on the prerelease server with real data.  For three days they fought with trivial matters (as without them, the test environment is not perfect), and they started testing from the very beginning, after which they appointed Day X. <br><br><h4>  Day X </h4><br>  Day X was scheduled for Saturday, we are going to the office at 9-00.  At the client‚Äôs office, they are their administrator, who actually does the deployment.  When the deployment is not yourself, but someone else according to your instructions, it is always scary, so the whole day we followed his every step through the shared screen in Lync.  At 15-00 migration is completed.  We check everything, we find that it did not take off, we finish the file with a file.  At 18-00, everything else worked, we are dissatisfied. <br><br><h4>  The first working day after Day X </h4><br>  It is Monday, the first working day.  HELL begins for us.  From the main, it turns out that: <br>  a.  Token swells more often than we thought; <br>  b.  The portal slows down more than usual; <br>  c.  Users are constantly thrown onto the login page, which is very, very difficult to work; <br>  d.  There is a problem not only with ajax requests.  If the user fills in the standard form of a new list item for half an hour, then with a probability of 90% he loses his changes while saving. <br><br>  We get access to the working server, analyze the logs, try to understand what is happening: <br><br>  The first "surprise".  We have a custom uploader of files with thumbnails, which saves temporary files on the disk (for cases when the object and files are created in one form and there is no place to attach files at the moment, but you need to show it in preview).  So, the uploader saves temporary files in a subdirectory of the application, such as C: \ inetpub \ Sharepoint \ Files while creating its own subdirectories there, and then deleting them.  These deletions led to the periodic recycle of the application pool.  And since Sharepoint Logon Token Cache lives just in memory, you could say goodbye to all the sessions.  I must admit that this Uploader has been living with us for a year now, and most likely it has overloaded the pool before, but nobody really noticed before that, with Windows authentication, this did not lead to a repeated request for credentials :).  As a result, the target uploader folder was promptly changed and the orgy became smaller. <br><br>  The second ‚Äúsurprise‚Äù.  Sometimes the process started to eat up all the memory, which caused the pool to overload.  To catch what exactly the portal loads, when hundreds of people work on it, the task is not simple and not fast.  We analyze database queries, logs, find those very critical places that periodically flood everyone up, understand how to do them differently, rewrite, roll in ... Breathing becomes easier.  Again, the problem of this non-optimality was always, but the periodic brakes used to turn a blind eye.  You never know what slows down, and with the lack of direct access to the prod server, on-line diagnostics is complicated by much, therefore, they ignored this problem. <br><br>  The portal works faster, no longer throws out every 5 minutes, but once a half hour or an hour a relogin occurs.  And here we discover for ourselves the basic things that should have been discovered at the very beginning - the Logon Token lifetime management for those who are interested in the details <a href="https://msdn.microsoft.com/ru-ru/library/office/hh147183">msdn.microsoft.com/ru-ru/library/office/hh147183</a> (v = office .14) .aspx (this topic was missed, since it didn‚Äôt arise much during testing. Testing of a separate test case easily fits into 5 minutes, and the tester changes users from case to case, and the session is updated. Long work from 9 to 6 is not emulated. Set up the session for 1 day and everything seemed to be good, but ... <br><br>  Another surprise.  Users continues to throw out.  Not so regularly, but there are cases, and mass ones.  Judging by the logs, the pool is not overloaded at this time.  What is the matter?  We read, understand how it all works, we find a useful article about caches <a href="http://blogs.msdn.com/b/besidethepoint/archive/2013/03/27/appfabric-caching-and-sharepoint-1.aspx">blogs.msdn.com/b/besidethepoint/archive/2013/03/27/appfabric-caching-and-sharepoint-1.aspx</a> We understand that the default cache size - only for 250 tokens, and when the cache is full, - hello everyone :) We increase the size of the cache - euphoria occurs ... The flow of negativity and angry letters subsides. <br><br><h4>  What's next </h4><br>  In principle, this could end, but curiosity takes up.  There is one more moment when sessions "go out."  The specificity of the business and the pace of development is such that a rare day goes without a hotfix.  At the time of the hotfix, you have to overload the application pool, and it was then that everyone ran to log in. <br><br>  Began to look, read, learn what you can do in this situation.  Literature, which reveals the mechanisms of SharePoint operation in detail, was not found as usual, so we went with heavy artillery - analysis of modules connected by SharePoint, disassembling assemblies, viewing how it all works from the inside.  Research day and find the villain: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Microsoft.SharePoint.IdentityModel.SPTokenCache, Microsoft.SharePoint.IdentityModel, Version=14.0.0.0, Culture=neutral, PublicKeyToken=71e9bce111e9429c"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  And in it is SPSecurityTokenCache private KeyValuePair &lt;string, SecurityToken&gt; [] m_StrongCache;  - that's how that StrongCache is implemented inside. <br><br>  For the sake of interest, we decided to try to write your TokenCache, but an attempt to do it in 5 minutes was not successful.  Rummaging deeper throughout the SP assembly line, we found that the connectivity of the components there is quite high.  As a result, they still wrote their version of TokenCache for test purposes, although in some places I still had to use Reflection. <br><br><h4>  Conclusion </h4><br>  What conclusions can be made, looking back.  Such changes are similar to the replacement of bricks at the base of the pyramid, which keeps the entire structure on itself.  Of course, one can say that it is not necessary to do this, that the system needs to be built on, and not rebuilt.  However, in real life, the moment will come when fundamental changes will be necessary.  And then, in our understanding, you need: <br>  a.  Thoroughly examine the internal mechanisms of what will change, no matter how many suppliers say about the ‚Äúwell-documented black box‚Äù; <br>  b.  How to best model the operation of the system, including scenarios of continuous use, high load, etc .; <br>  c.  Try to predict the consequences.  Work out rollback scripts if changes have to be removed anyway; <br>  d.  Agree with the client that failures are possible; <br>  e.  And get ready ... </div><p>Source: <a href="https://habr.com/ru/post/260689/">https://habr.com/ru/post/260689/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../260679/index.html">Aggregation of time series data</a></li>
<li><a href="../26068/index.html">C #: code writing guidelines</a></li>
<li><a href="../260681/index.html">Anatomy of virtual telephony. Introduction to the interface</a></li>
<li><a href="../260683/index.html">Free speech recognition from the Russian company Stel</a></li>
<li><a href="../260685/index.html">Erasure Code - more storage space on Nutanix</a></li>
<li><a href="../26069/index.html">Flexible website development: programming + design</a></li>
<li><a href="../260691/index.html">The history of light and shadow in one small but proud game</a></li>
<li><a href="../260693/index.html">Fighting phishing and malicious Web links in email</a></li>
<li><a href="../260695/index.html">Interesting for iOS developers for the week</a></li>
<li><a href="../260699/index.html">Cloud WLAN from Cisco Meraki: what it is and what it is eaten with</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>