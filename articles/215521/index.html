<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Arduino: IR control appliances</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! My name is Konstantin and I am a programmer, in particular, I am engaged in programming systems ‚ÄúSmart Home‚Äù. 
 During the four years of work i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Arduino: IR control appliances</h1><div class="post__text post__text-html js-mediator-article">  Hello!  My name is Konstantin and I am a programmer, in particular, I am engaged in programming systems ‚ÄúSmart Home‚Äù. <br>  During the four years of work in this area, I had the opportunity to try many interesting controllers and software for solving home automation problems.  One of the most interesting devices with which I had to deal was the Global Cache IP2IR series devices.  Their purpose is to accept a text command from a client and emit it through the LED of the IR spectrum. <br>  The use of such devices simplifies the life of users in several directions at once: <br><ul><li>  as a remote control, you can use tablets, phones and a PC (with a small reservation, you need a special software); </li><li>  management can be centralized i.  special software can be raised on the server and access it; </li><li>  There is no need for aimed shooting, if you don‚Äôt have such problems with a TV (we‚Äôre looking at it), then for devices like Blu-Ray players or MediaServer‚Äôs this can be a problem if they are locked in a cabinet or work in multiroom mode; </li><li>  One button of the remote control can perform a whole macro, for example, turn on the TV and Blu-Ray, then switch the TV to the desired source, for example HDMI1, and the user may not even bother about where and how his devices are connected. </li></ul><br>  Such a toy makes life easier, of course, but it also hits the pocket, if memory serves me, GlobalCache for managing three devices costs about 6000-7000 wooden rubles.  Not very humane pricing, so it was decided to make their own implementation of such a device. <br><a name="habracut"></a><br>  Honestly, the idea has been going around for a long time, but I don‚Äôt have experience, or almost no experience, for the circuitry and the MK programmer, because of these considerations, the Arduino platform was chosen with its short-term development.  Searches in the open spaces of the web gave me a ready-made solution called IRRemote, how did I spit when I found out that this module was sharpened to work with a single exit, obviously not what I needed, for viewing the source code gave me confidence in my theoretical knowledge of IR equipment control . <br><br>  The theory is simple, although manufacturers like to use their own protocols to describe commands, it all comes down to the same principle of data transfer.  On some sites you can find commands for their devices in the format of HEX or ProntoHEX, which is essentially the same thing. <br>  The command in HEX format is as follows: 0000 FREQ CNT1 CNT2 ON_1 OFF1 ON_2 OFF2 ON_n OFFn. <br>  The bottom line is: <br><ol><li>  0000 is always four zeros, but for our own purposes we will use the first two zeros with the number of repetitions of the code, the second two zeros will be the output number on the arduinka.  Thus, code 010D will repeat the command twice and send it to output 13 (the one with the built-in LED); </li><li>  FREQ is the reference frequency of the signal.  Usually in the range of 35-40 kHz and recorded cleverly - 36 kHz = 0073 = 115, it is not very clear why the decimal 115 gives the frequency of 36 kHz, I can only say that you can calculate it so 4145 / FREQ; </li><li>  CNT1 is not the most obligatory part, I ignore it; </li><li>  CNT2 - I also ignore, if anyone is interested, that this is the link below; </li><li>  ON - and this is the data.  This is the number of periods at the reference frequency when we ‚Äúflicker‚Äù with an infrared diode; </li><li>  OFF is the number of periods when we hold a logical zero on the leg. </li></ol><br>  In order not to force you to read thoughtfully into this theory, we simply illustrate the above: <br><img src="https://habrastorage.org/getpro/habr/post_images/552/f04/eec/552f04eecc57bd37591f215fbc6644d6.png" alt="illustration of the theory of infrared signal"><br>  Well, when we figured out the theory, it's time to start programming, I will not describe all the difficulties that I had at the beginning of work with a new animal for me and perhaps start with the following: <br>  As part of the Arduino environment, there is a special function tone (pin, frequency, duration), it generates a signal at the input / output port ‚Äî a rectangular ‚Äúwave‚Äù of a given frequency and with a 50% duty cycle using a timer interrupt. <br>  Svarganov in a hurry, more or less, working version using this function, I wanted to increase the accuracy of the results obtained, for this in the directory "\ Arduino \ hardware \ arduino \ cores \ arduino \" the file Tone.cpp was copied and renamed to IR_Gen.cpp .  Then in the resulting file I declared the missing variables and deleted the unnecessary ones, and there were those too.  The tone function has been modified to the startIR (frequency) function which is not declared anywhere and can only be used inside this file. <br>  We also added two more declared functions sendIR (char ir_string []) and sendLastIR () - which call the former tone () (startIR ()), but before starting the modulation you need to make sure that the string passed to sendIR is a set data of the IR command, the ParseIRString parsing function was enabled for this purpose, it will return zero if the data does not match the format of the IR command and returns the value of the reference frequency if the data matches.  I will give the code just in case that it would be clear how the string is parsed: <br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsigned</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ParseIRString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IRString[])</span></span></span></span>{ byte xBool = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bInt = <span class="hljs-number"><span class="hljs-number">0</span></span>; ir_data_array_length = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> IR_Frequency = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> IR_String_Length = <span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> Separator = <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> bChArr[<span class="hljs-number"><span class="hljs-number">4</span></span>] = {<span class="hljs-number"><span class="hljs-number">0</span></span>}; byte NumSys = <span class="hljs-number"><span class="hljs-number">16</span></span>; ir_out_pin = <span class="hljs-number"><span class="hljs-number">255</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(IRString[<span class="hljs-number"><span class="hljs-number">0</span></span>]==<span class="hljs-string"><span class="hljs-string">'s'</span></span>){ <span class="hljs-comment"><span class="hljs-comment">//    Global Cache ir_out_pin = (((IRString[7]-48)*3)-(3-(IRString[9]-48)))-1; bChArr[0] = IRString[19]; bChArr[1] = IRString[20]; bChArr[2] = IRString[21]; bChArr[3] = '\r'; ir_repeat_count = StrToInt(bChArr,10)-1; Separator = ','; i = 13; NumSys = 10; }else{ //    HEX bChArr[0] = IRString[3]; bChArr[1] = IRString[4]; bChArr[2] = '\r'; ir_out_pin = StrToInt(bChArr,16); bChArr[0] = IRString[0]; bChArr[1] = IRString[1]; ir_repeat_count = StrToInt(bChArr,16); } if ((ir_out_pin&gt;13)||(ir_out_pin&lt;0)){return 0;} for (i; i&lt;IR_String_Length; i++){ if((IRString[i]&gt;='a')&amp;&amp;(IRString[i]&lt;='f')){IRString[i]-=32;} //UpperCase if((IRString[i] != Separator)&amp;&amp;(IRString[i] != '\r')){ // ,    if((IRString[i]&gt;47)&amp;&amp;(IRString[i]&lt;58)){ //   bInt = bInt * NumSys + (IRString[i] - 48); //  }else{ if ((IRString[i]&gt;='A')&amp;&amp;(IRString[i]&lt;='F')&amp;&amp;(NumSys==16)){//  A  F bInt = bInt * NumSys + (IRString[i] - 55); //  }else{ return 0; } } }else{ if(IR_Frequency==0){ if(NumSys==16){ //  HEX IR_Frequency = (4145/bInt)*1000; //   }else{ // Global Cache IR_Frequency = bInt; //   } xBool++; }else{ if(xBool&gt;2){ ir_data_array[ir_data_array_length]=bInt*2; //  ir_data_array_length++; }else{ xBool++; } } bInt = 0; if(IRString[i] == '\r'){Serial.println(IR_Frequency,DEC); return IR_Frequency;} } } }</span></span></code> </pre> <br>  Then we correct the interruption of the timer for our purposes and, as a result, we have something like: <br><pre> <code class="cpp hljs">ISR(TIMER2_COMPA_vect){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ir_data_array[ir_data_current_step] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ir_data_current_step%<span class="hljs-number"><span class="hljs-number">2</span></span>==<span class="hljs-number"><span class="hljs-number">0</span></span>){ *timer2_pin_port ^= timer2_pin_mask; <span class="hljs-comment"><span class="hljs-comment">// }else{ *timer2_pin_port &amp;= ~(timer2_pin_mask); //  } ir_data_array[ir_data_current_step]--; }else{ ir_data_array[ir_data_current_step] = ir_data_buffer; ir_data_current_step++; ir_data_buffer = ir_data_array[ir_data_current_step]; } if (ir_data_current_step == ir_data_array_length){ if(ir_repeat_count&gt;0){ ir_repeat_count--; ir_data_current_step = 0; }else{ stopIR(tone_pins[0]); } } }</span></span></code> </pre><br><br>  At the end of this extravaganza in the Arduino.h file, you need to declare the newly created functions byte sendIR (char ir_string []);  byte sendLastIR ();  and voila, it's a hat.  The result was a slightly expanded environment of Arduino, which included a ready-made tool for controlling household appliances. <br>  I know, not everyone is fan of fixing anything in the development environment, but I honestly said it was more convenient, and in the end nothing hinders to do it just a third-party module. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Related information:</b> <br>  <a href="http://www.globalcache.com/">Global Cache Company Website</a> <br>  <a href="http://www.globalcache.com/files/docs/API-GC-100.pdf">PDF with a description of the API of Global Cache devices</a> <br>  <a href="http://arduino.ru/Reference/Tone">Russian-language help function tone</a> <br>  <a href="http://www.remotecentral.com/features/irdisp2.htm">As promised for the curious, add.</a>  <a href="http://www.remotecentral.com/features/irdisp2.htm">infa on IR control</a> <br>  <a href="https://github.com/shirriff/Arduino-IRremote">Well-known library IRRemote</a> </div><p>Source: <a href="https://habr.com/ru/post/215521/">https://habr.com/ru/post/215521/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../215507/index.html">We disassemble external batteries Gmini</a></li>
<li><a href="../215509/index.html">Monitoring Information Security Events with ZABBIX</a></li>
<li><a href="../215511/index.html">bb-mobile VOIIS GPS: a phone with large buttons, health control and remote control</a></li>
<li><a href="../215513/index.html">Developer Tools or Why aren't you using X? Part 1</a></li>
<li><a href="../215519/index.html">Production of LED display pilot batch LaMetric</a></li>
<li><a href="../215523/index.html">Landfill is not an option. 3 legal ways to get rid of old iron</a></li>
<li><a href="../215525/index.html">PonoMusic - digital music ecosystem</a></li>
<li><a href="../215527/index.html">Differential Cryptanalysis for Dummies</a></li>
<li><a href="../215529/index.html">Come to the jubilee XV International Software Quality Assurance Days International Conference</a></li>
<li><a href="../215531/index.html">How Russian online stores to deal with Amazon</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>