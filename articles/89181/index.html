<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A simple approach to versioning MS SQL Server databases</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A simple approach to versioning MS SQL Server databases 

 Preface. 
 Very often in application programs it is necessary to use modern databases that ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A simple approach to versioning MS SQL Server databases</h1><div class="post__text post__text-html js-mediator-article"><h4>  A simple approach to versioning MS SQL Server databases </h4><br><br><h5>  Preface. </h5><br>  Very often in application programs it is necessary to use modern databases that provide a developer with a lot of functionality, based not only on the data level, but also creating their own API to provide access to this data through stored procedures, triggers, functions.  Obviously, in this whole structure, depending on the circumstances, some changes may be needed.  And in the most innocuous case, when a developer deals with one client and one changing database (suppose at a small enterprise), the update process looks simple - we make the necessary changes in the structure, compare with the help of special utilities, such as SQL Examiner, old and new version and roll the generated sql script on the existing database.  As you can see in the described case, the data is migrated every time the database structure is updated.  But unfortunately, the described situation is extremely rare, more often - the clients and the corresponding databases for any product among developers are in the hundreds, if not more.  Thus, for a normal database life cycle, a versioning system is needed (not to be confused with source versioning systems of the Subversion type). <a name="habracut"></a><br><br><h5>  An approach </h5><br>  To better understand the purpose of this system, consider the following example: there is some desktop application - a list of office staff, upon request of the customer, this program should store the following data: "Last Name", "First Name", "Middle Name", job title and this program will be installed in each of the offices of the company, which are scattered throughout the city.  The last fact suggests that in the future there may be situations when updating software versions will not happen synchronously, for example, it is possible that the program will release version 10 already, and our first version will still be installed in any office, but when upgrading immediately to 10th, the administrator performing this update will not need to install all 10 updates, but he will need to provide one 10 updates at once, which will independently update the entire structure and migrate the data for the new application.  Thus, we formulate the main requirements for our database versioning system: <br><ol><li>  Data must be kept safe during migration. </li><li>  Data must be migrated regardless of their version. </li><li>  Migration tool should be as simple as possible. </li></ol><br>  The easiest version of the task of the migration commands is to develop a migration script in any language; in this example, standard windows bat files will be used. <br>  Now you need to create rules for saving entities. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  A script with DML definitions that creates a database or modifies an existing structure must be in a single file, the name of which will be alter.sql. </li><li>  Each stored procedure must have its own file, both for creation (for the first version) and for modification (for subsequent ones). </li><li>  For each entity in the database, it is as possible to use the following rule: create four procedures each, for selecting, adding, updating, deleting an entity, which should be named according to the rule [Action Entity].  For example, if we have an entity book - Book, then to access it we create four procedures - SelectBook, InsertBook, UpdateBook, DeleteBook.  The introduction of new rules is allowed, but they should be as unified as possible. </li><li>  Procedures for working with the same entity should be grouped in the same folder bearing the name of the entity. </li><li>  For each version, folders with the number of the version being implemented should be created, and they should contain the folders from step 4, as well as the initialization script or changes to the database structure from paragraph 1. </li></ol><br>  Fulfilling all of the above rules, you can achieve a hard cataloging, with which we will come to the required version. <br>  Let's return to our example.  In the first version, we will have one Person table, with three fields: FirstName, MiddleName, LastName.  First, create a Version folder - It will contain versions, now it is version 1, and below it is the Person folder and the initialization script, which is presented below: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> Person <br> ( <br> FirstName <font color="#0000ff">varchar</font> (50), <br> MiddleName <font color="#0000ff">varchar</font> (50), <br> LastName <font color="#0000ff">varchar</font> (50) <br> ) <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font></font></a> .</code> </blockquote>  Next, in the persons folder, we create four stored procedures, according to the rule from paragraph (3), call them SelectPerson, InsertPerson, UpdatePerson, DeletePerson respectively and put them inside the Person folder, we will not give the code due to elementary, but let's see turn out: <br><img src="https://habrastorage.org/getpro/habr/post_images/689/7f7/0b8/6897f70b861de9145e91411a76e07362.png" alt="image"><br><h5>  Creating a base deployment system </h5><br>  Now that all the files and directories have been assembled into a certain structure, we can start creating a mechanism that will deploy our database.  For MS SQL server there is an access utility from the command line - sqlcmd.exe is exactly what we will take as the sql command processor.  At the time of execution, it is assumed that the path to this utility is registered in the environment variable Path.  First, a little information about sqlcmd.exe: <br><ol><li>  This utility can execute files containing SQL commands, this is done using the ‚Äìi filename key </li><li>  It also can define variables that can be used in the sql code, the variable is defined using the ‚Äìv param = value key, and in the code they can be accessed using the syntax $ (param), and the executable processor simply replaces these tokens with the value , which was defined in the call with the -v option </li><li>  The utility allows in the sql script to call other sql scripts, this is done using the directive: r filename </li></ol><br>  These functions will help to create a flexible system for our purposes.  First, let's define the database deployment algorithm: <br><ol><li>  Determine whether the database exists, if not, then create a new one. </li><li>  We make backup data. </li><li>  Determine whether the initial configuration of the database is created for versioning, if not, then create it. </li><li>  We define the current version and call the migration script. </li></ol><br><br>  In order for the database to store its current version (for step 3), for this it is necessary to create a table with a field where this version will be stored: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> Settings <br> ( <br> DbVersion <font color="#0000ff">int</font> <br> ) <br> <font color="#0000ff">go</font> <br> <font color="#0000ff">INSERT</font> <font color="#0000ff">INTO</font> Settings(DbVersion) <font color="#0000ff">VALUES</font> (1) <br> <font color="#0000ff">go</font> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font></font></a> .</code> </blockquote> <br><br>  When changing the base version, the corresponding value in the DbVersion field in the created table will change. <br>  Now we define what parameters the deployment script should receive: <br><ol><li>  The database name is the workdbname variable. </li><li>  Instance name for SQL services. </li><li>  The path to the database files is the databasepath variable. </li><li>  The path to the backup file is the backuppath variable. </li></ol><br><br><h5>  Preparation stage </h5><br>  Here we will need to write the logic for checking the existence of the base and creating a new one.  Immediately it is worth mentioning that the sqlcmd.exe utility when a critical error occurs in the execution of the script, such as division by zero, returns an error code to the environment - 1. This can be used during the execution of the bat-script.  For the above check, create the following sql commands in the CheckDbExists.sql file: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font color="black"><font color="#0000ff">use</font> master; <br> <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> <font color="#0000ff">EXISTS</font> ( <font color="#0000ff">SELECT</font> * <font color="#0000ff">FROM</font> sysdatabases <font color="#0000ff">WHERE</font> [Name] = $(workdbname)') <br> <font color="#0000ff">BEGIN</font> <br> <font color="#0000ff">SELECT</font> 1/0; <br> <font color="#0000ff">END</font> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font></font></a> .</code> </blockquote> <br>  Now we will organize the first check in the file deploy.bat: <br><br> <code>"sqlcmd.exe" -S %2 -V 1 -v workdbname=%1 -i CheckDbExists.sql <br> IF ERRORLEVEL 1 GOTO :CREATENEW</code> <br> <br>  If our base does not exist, then the utility will return the termination code 1 to the execution environment and the logic will proceed to the execution of the physical creation of the base.  To do this, we write a sql script with the following content: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font color="black"><font color="#0000ff">use</font> master; <br> <font color="#0000ff">go</font> <br> <font color="#0000ff">CREATE</font> <font color="#0000ff">DATABASE</font> $(workdbname) <font color="#0000ff">ON</font> <font color="#0000ff">PRIMARY</font> <br> (Name = N <font color="#A31515">'$(workdbname)'</font> , FILENAME = N <font color="#A31515">'$(databasepath)'</font> ); <br> <font color="#0000ff">go</font> <br> <font color="#0000ff">use</font> $(workdbname); <br> <font color="#0000ff">go</font> <br> <br> <font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> Settings <br> ( <br> DbVersion <font color="#0000ff">int</font> <br> ) <br> <font color="#0000ff">go</font> <br> <font color="#0000ff">INSERT</font> <font color="#0000ff">INTO</font> Settings(DbVersion) <font color="#0000ff">VALUES</font> (1) <br> <font color="#0000ff">Go</font> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font></font></a> .</code> </blockquote> <br>  As you can see, the script uses two variables that will need to be passed when you call sqlcmd: <br><br> <code>"sqlcmd.exe" -S %2 -v workdbname=%1 -v databasepath=%3 -i InitDatabase.sql</code> <br> <br>  In the step of checking the existence of the database, it could happen that the database already exists, so you need to prepare it for the update, namely, to force the creation of backup data, you can do this by calling the following script: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font color="black"><font color="#0000ff">BACKUP</font> <font color="#0000ff">DATABASE</font> $(workdbname) <font color="#0000ff">TO</font> <font color="#0000ff">DISK</font> = N <font color="#A31515">'$(backuppath)'</font> <font color="#0000ff">WITH</font> INIT, <br> SKIP, NOREWIND, NOUNLOAD</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font></font></a> .</code> </blockquote> <br><br>  From the generated bat file: <br> <code>"sqlcmd.exe" -S %2 -v workdbname=%1 -v backuppath=%4 -i BackupDatabase.sql</code> <br> <br>  Now the time has come for the most important thing in our system - checking the current version; this will be done by a simple check for the specified version.  Since it is necessary to somehow notify the ‚Äúoutside world‚Äù about the version number, here again we apply the divide-by-zero error and file this code in the CheckVersion.sql file: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font color="black"><font color="#0000ff">use</font> $(workdbname); <br> <font color="#0000ff">go</font> <br> <font color="#0000ff">SELECT</font> [DbVersion]/($(checkedVersion) - [DbVersion]) <font color="#0000ff">FROM</font> Settings <br> <font color="#0000ff">Go</font> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font></font></a> .</code> </blockquote> <br><br>  And we will write a call with checking the first version: <br> <code>"sqlcmd.exe" -S %2 -V 1 -v workdbname=%1 -v checkedVersion=1 -i CheckVersion.sql</code> <br> <br>  At the first call, as expected, a division by zero error will occur, and code 1 will return to the execution environment. Thus, we can call a script that should make all the necessary changes to initialize the structure for the first version of the database: <br> <code>IF ERRORLEVEL 1 "sqlcmd.exe" -S %2 -v workdbname=%1 -i Version\1\alter.sql</code> <br>  The called alter.sql file for each version should work according to the following principle: <br><ol><li>  Must set the context of the database, the name of which was passed to it in the workdbname variable. </li><li>  Call using the directive: r all necessary files containing sql DML code. </li></ol><br>  For the first version of our example, the script in this file consists of the lines below, plus, at the end, a mandatory version update: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font color="black"><font color="#0000ff">use</font> $(workdbname); <br> <font color="#0000ff">go</font> <br> :r Version\1\script. <font color="#0000ff">sql</font> <br> <font color="#0000ff">go</font> <br> :r Version\1\Person\DeletePerson. <font color="#0000ff">sql</font> <br> <font color="#0000ff">go</font> <br> :r Version\1\Person\InsertPerson. <font color="#0000ff">sql</font> <br> <font color="#0000ff">go</font> <br> :r Version\1\Person\SelectPerson. <font color="#0000ff">sql</font> <br> <font color="#0000ff">go</font> <br> :r Version\1\Person\UpdatePerson. <font color="#0000ff">sql</font> <br> <font color="#0000ff">go</font> <br> <font color="#0000ff">UPDATE</font> Settings <font color="#0000ff">SET</font> DbVersion = 2 <br> Go</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font></font></a> .</code> </blockquote> <br>  At this point, the entire setup for working with the first version is completed, and the file structure should take the form shown in the image: <br><img src="https://habrastorage.org/getpro/habr/post_images/395/4bb/fd6/3954bbfd62b83886ea8eb22a5b16e0db.png" alt="image"><br><br><h5>  Creating new versions </h5><br>  When the time of the next release comes, all the changes that have accumulated during the work should be collected in a subfolder of the main Version branch.  For clarity, we assume that the next version of our database will include changes in the introduction of the new city table and the creation of a connection between the person and the city in which he was born, the structure migration script named script.sql will be as follows: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> City <br> ( <br> CityId <font color="#0000ff">int</font> <font color="#0000ff">identity</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , <br> Title <font color="#0000ff">varchar</font> (255) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , <br> <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> (CityID) <br> ) <br> <font color="#0000ff">go</font> <br> <font color="#0000ff">ALTER</font> <font color="#0000ff">TABLE</font> Person <font color="#0000ff">ADD</font> CityId <font color="#0000ff">int</font> <br> <font color="#0000ff">go</font> <br> <font color="#0000ff">ALTER</font> <font color="#0000ff">TABLE</font> Person <font color="#0000ff">ADD</font> <font color="#0000ff">FOREIGN</font> <font color="#0000ff">KEY</font> (CityID) <font color="#0000ff">REFERENCES</font> City (CityID) <br> <font color="#0000ff">go</font> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font></font></a> .</code> </blockquote> <br><br>  At the same time, you will need to create four procedures for working with the City entity and make changes to the storage for the Person entity.  Then write the update script to the alter.sql file: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font color="black"><font color="#0000ff">use</font> $(workdbname); <br> <font color="#0000ff">go</font> <br> :r Version\2\script. <font color="#0000ff">sql</font> <br> <font color="#0000ff">go</font> <br> :r Version\2\Person\InsertPerson. <font color="#0000ff">sql</font> <br> <font color="#0000ff">go</font> <br> :r Version\2\Person\SelectPerson. <font color="#0000ff">sql</font> <br> <font color="#0000ff">go</font> <br> :r Version\2\Person\UpdatePerson. <font color="#0000ff">sql</font> <br> <font color="#0000ff">go</font> <br> :r Version\2\City\SelectCity. <font color="#0000ff">sql</font> <br> <font color="#0000ff">go</font> <br> :r Version\2\City\InsertCity. <font color="#0000ff">sql</font> <br> <font color="#0000ff">go</font> <br> :r Version\2\City\UpdateCity. <font color="#0000ff">sql</font> <br> <font color="#0000ff">go</font> <br> :r Version\2\City\DeleteCity. <font color="#0000ff">sql</font> <br> <font color="#0000ff">go</font> <br> <font color="#0000ff">UPDATE</font> Settings <font color="#0000ff">SET</font> DbVersion = 3 <br> <font color="#0000ff">Go</font> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font></font></a> .</code> </blockquote> <br><br>  Upon completion, we will add the following lines to the version checking section of the main deploy.bat: <br> <code>"sqlcmd.exe" -S %2 -V 1 -v workdbname=%1 -v checkedVersion=2 -i CheckVersion.sql <br> IF ERRORLEVEL 1 "sqlcmd.exe" -S %2 -v workdbname=%1 -i Version\2\alter.sql</code> <br> <br>  For the second version, the structure of files and folders will look like: <br><img src="https://habrastorage.org/getpro/habr/post_images/edc/a9f/f7d/edca9ff7ddb374fc8f77a4d0236705e4.png" alt="image"><br><br><h5>  Conclusion </h5><br>  The described approach is applicable not only for MS SQL databases, but can be adapted to other DBMS.  For example, this method was developed in the process of creating a system for versioning the data schema for a project where the DBMS was Postgres.  All source scripts are available here. </div><p>Source: <a href="https://habr.com/ru/post/89181/">https://habr.com/ru/post/89181/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../89172/index.html">Fire in hosting center</a></li>
<li><a href="../89174/index.html">Full online store on your website</a></li>
<li><a href="../89175/index.html">PHPUnit. Part 03 Writing Tests for PHPUnit</a></li>
<li><a href="../89177/index.html">Robots: Part 1. Transferring material from the Big Picture website</a></li>
<li><a href="../89180/index.html">The site (hoster, registrar, shop) asks for personal data (passport, residence permit, etc.).</a></li>
<li><a href="../89182/index.html">The obvious business model of a successful writer of the early to mid-21st century</a></li>
<li><a href="../89183/index.html">Ubuntu One Music Store</a></li>
<li><a href="../89184/index.html">Django 1.2 and CSRF</a></li>
<li><a href="../89186/index.html">CSS Sticky Footer - new version</a></li>
<li><a href="../89187/index.html">AVG released Linux LiveCD to restore Windows-system</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>