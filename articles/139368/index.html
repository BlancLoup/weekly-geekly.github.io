<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Selectel accident</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="March 3, at about 10:50 pm Moscow time, the car stopped responding in a new cloud. 

 I managed to see the download schedule - the last 15 minutes on ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Selectel accident</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/db8/5b9/894/db85b9894c746c3089d5c5e4251af209.png"><br>  March 3, at about 10:50 pm Moscow time, the car stopped responding in a new cloud. <br><br>  I managed to see the download schedule - the last 15 minutes on it was zero processor activity. <br><br>  Made 2 attempts to reboot and 2 forced shutdowns - unsuccessfully. <br>  Cloud management is now disabled altogether. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The system engineer responded to the ticket: <br><blockquote>  Hello.  Indeed, in the work of several servers of our cloud, there was a failure.  Our experts are working on this problem. <br>  We apologize to you. </blockquote><br>  I create a topic to notify the community and slightly reduce the load on technical support. <br><br>  Unfortunately, the accident was <b>much</b> more serious. <br><a name="habracut"></a><br><br><h3>  Chronology </h3><br>  <b>22:50</b> The problems started.  Zero activity on the server, management does not work. <br>  <b>01:25</b> Machines began to rise. <br>  <b>02:05</b> Looks like it fell back - the car stopped responding in the same way.  Early rejoiced. <br>  <b>04:00</b> <a href="http://habrahabr.ru/users/amarao/" class="user_link">amarao</a> : <br><blockquote>  To blame.  The data was preserved without damage, but the connection between the storage system and the hosts, yes, broke, and twice. <br>  Now they have repaired, the injured cars have started. </blockquote><br>  <b>05:10</b> <a href="http://habrahabr.ru/users/dlussky/" class="user_link">Dlussky</a> discovered that ‚Äúnothing works,‚Äù judging by the charts, the car got out about 4x <br>  <b>05:25</b> <a href="http://habrahabr.ru/users/dlussky/" class="user_link">Dlussky</a> turned off the cloud control panel, in support they say about the recovery time 0.5-3 hours <br>  <a href="http://habrahabr.ru/users/amarao/" class="user_link">07:08 amarao</a> : <br><blockquote>  Still struggling with the problem and thinking about solutions.  Any relatively high activity on the disk leads to IO paralysis. </blockquote><br>  <b>10:00</b> No change.  Although there is no karma leaked.  If it drops to 8, I remove the topic in drafts. <br>  <b>11:12</b> <a href="http://habrahabr.ru/users/dyadyavasya/" class="user_link">dyadyavasya</a> : <blockquote>  Just answered the ticket: <br>  "According to preliminary estimates of specialists, the work will be completed within two hours." </blockquote><br>  <b>14:00</b> There are no special changes in the situation.  But karma has returned to normal, thanks to the kind people! <br>  <b>14:15 The</b> message in the control panel: <blockquote>  We start the car. </blockquote>  My up and running, but for now wait wait to rejoice. <br>  <b>15:00</b> My server of type works, the schedule of resource consumption is normal, it pings, but neither one site nor ssh access works.  <s>Either the work is not finished yet, or everything died there.</s>  Fsck was launched.  The server is alive. <br>  <b>15:04</b> <a href="http://habrahabr.ru/users/amarao/" class="user_link">amarao</a> : <br><blockquote>  The last traces of the accident eliminated. <br><br>  Sorry, people. <br><br>  Compensation will be, tomorrow I will fight for the size.  Now they have done so that the situation is not reproduced.  We will essentially solve with the highest priority. <br><br>  Sorry again. </blockquote><br><br><h2>  The official explanation of the situation from <a href="http://habrahabr.ru/users/amarao/" class="user_link">amarao</a> </h2><br><blockquote>  So what happened. <br><br>  If in short - by-turn (with an interval of 10 minutes), the raid10 arrays on both servers providing the storage cluster stopped.  On top of these arrays we have flashcache (caching layer) and drbd, working under protocol C (synchronous recording mode). <br><br>  The system was configured according to the following algorithm: if one of the storages falls, the second continues to work.  Which of the repositories is alive, which is not, is determined using multipathd on virtualization hosts. <br><br>  The basic tests that we drove before starting included: crashing one of the nodes (crash), power loss, taking out (killing) more disks than raid10 could survive, killing ssd raid death (also raid10), random admin who typed ' reboot ', removing the network cable and its "poking" there / back (protection from split brain).  All these tests passed and (I) had confidence that the system was sufficiently robust for our needs. <br><br>  On this night, the usual raid checking started.  An innocent process that checks the integrity of raids in the background.  The stores in the first pool continue this process slowly (about 2-5mb / s).  The kernel module that performs the verification ensures that latency does not increase significantly, so that clients in the normal mode of this process should not notice. <br><br>  However, a problem arose (our current hypothesis is a bug in the kernel module) and the presence of aggressive IO (about 25 IOPS on each disk of the array) simultaneously with the verification process caused IO to stop on the array.  Fully.  So much so that dd if = / dev / md10 of = / dev / null bs = 512 count = 1 just ‚Äúhung‚Äù.  At the same time, reading directly from all underlying disks was successful and occurred at normal speed.  This led to the fact that the iscsi target (and followed by everyone else in the chain) to io did not get any success or response.  In addition, the situation was complicated by the fact that the usual multipath "checker" checks the first 512 bytes of the disk for readability.  Guess whether these 512 bytes were cached in flashcache or not ... Another thing that was confusing was that part of the requests (those who were in the ssd cache) were served normally, and for some time the write requests also came without problems.  At some point, the ssd cache overflowed and there was a problem with it being thrown off.  Due to the synchronous mode of drbd, stopping (not an error, namely, stopping) led to the stopping of both peers.  In theory, the problem could be solved only by disabling the ‚Äúsick‚Äù feast (which we did at the beginning).  This helped for a while, after which the problem recurred in the second (which again speaks of the problem in the kernel module, and not in the hardware).  It was at this point that most customers noticed the problem.  Since the recording was completely paralyzed, we could not return to the place the previous feast, which had risen by this time (and continued to check the disc, as if nothing had happened).  The first ‚Äúglobal reboot‚Äù occurred.  We have an approximate lifting speed of cars of about 2-3s per car (the car starts longer, the start operation goes in parallel).  Somewhere on 300 machines, the synchronization speed began to plummet (in fact, it was already 0, and the ‚Äúdecrease in the average‚Äù was just an accidental effect).  Almost simultaneously, the problem was repeated at the second feast (which, by that time, had also been reset).  It was decided to try to update the kernel, this did not fix the situation.  Began to draw plans for "manual recovery".  At this time, my assistant offered to ‚Äúgive pre-order‚Äù.  Dali (350 minutes).  During this time, I even managed to take a short nap (since the time had already crawled by 7 am).  Just in case, this is not about ‚Äúrebuild‚Äù in case of a disk failure, but ‚Äúmonthly‚Äù checking the vividness of all the disks in the array.  This process went on all 10th raids, of which the storage was collected (in both storages at once) at a speed of about 200-250 Mb / s. <br><br>  By one o'clock the process was over, another 10 minutes was taken by the manual lifting of the cluster strapping, another 5 minutes of rebooting the pool (since all the machines in the second pool suffered, there was no point in manually correcting and understanding the multipathd opinion about who is alive and who is not).  The launch has begun.  By 2 pm, the start was over and manual analysis of all sorts of fsck began, asking to press a button on the screen. <br><br>  Conclusions and actions taken. <br>  1) As a local solution "in the coming days" - the launch of resync raids is prohibited. <br>  2) In the near future, the script ‚Äúdoes not work, but does not report an error‚Äù will be provided for the raid (and other block devices in the stack - flashcache, lvm, drbd, etc.) <br>  3) An equivalent (disks will be smaller and without SSD) stand will be built in parallel, where we will try to reproduce the situation and look for a configuration in which it does not manifest itself.  Our current assumption, raid0 over raid1 should not behave this way. <br>  4) Send bug report (if item 3 is successful). <br><br>  Apologies: <br><br>  To blame.  We understand that it is impossible to do this and we will make every effort to correct the situation. <br><br>  Compensation: <br><br>  In compensation, it was decided to return 100% of the money spent on the affected virtual machines. </blockquote></div><p>Source: <a href="https://habr.com/ru/post/139368/">https://habr.com/ru/post/139368/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../139362/index.html">Input focus on the ‚ÄúTry Again‚Äù button for network errors</a></li>
<li><a href="../139363/index.html">Zend Framework 2.0.0beta3 Released!</a></li>
<li><a href="../139364/index.html">Beautiful tips for jQuery Validation using qtip</a></li>
<li><a href="../139365/index.html">Exam: as it was</a></li>
<li><a href="../139367/index.html">The bank congratulated and presented the base of electronic addresses of customers and employees.</a></li>
<li><a href="../139370/index.html">RUBI 2012 implementation race</a></li>
<li><a href="../139371/index.html">How to return "Start / Start" in Windows 8 Consumer Preview</a></li>
<li><a href="../139373/index.html">TV rips go to x264</a></li>
<li><a href="../139375/index.html">FSF has provided evidence of the growing popularity of the GPL</a></li>
<li><a href="../139376/index.html">MariO - release</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>