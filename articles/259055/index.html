<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We test Spring Rest controllers: simpler, shorter, more reliable. Spring Security Test + JSON Matcher</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 
 Own JSON Matcher, the use of Spring Security Test , recently included in Spring Security 4.0, and the abandonment of transactions when testin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We test Spring Rest controllers: simpler, shorter, more reliable. Spring Security Test + JSON Matcher</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/d93/ff4/894/d93ff48942154c72914f9553761d6650.png"><br><br>  Hello! <br>  Own JSON Matcher, the use of <a href="http://docs.spring.io/spring-security/site/docs/4.0.x/reference/htmlsingle/">Spring Security Test</a> , recently included in Spring Security 4.0, and the abandonment of transactions when testing services can make tests easier and more reliable. <br><br>  I used this approach when creating an application on my Topjava course (Maven / Spring / Security / JPA (Hibernate) / Rest (Jackson) / Bootstrap (CSS) / jQuery + plugins), the source code of the project <a href="https://github.com/JavaWebinar/topjava02">can be taken on github</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This article is not <a href="http://www.petrikainulainen.net/programming/spring-framework/unit-testing-of-spring-mvc-controllers-rest-api/">another Spring REST Controller Testing Tutorial</a> and assumes that you are already familiar with it. <br><br>  I already wrote about the benefits of non-transactional transactions in a previous publication <a href="http://habrahabr.ru/post/232381/">In the footsteps of Spring Pet Clinic.</a>  <a href="http://habrahabr.ru/post/232381/">Maven / Spring Context / Spring Test / Spring ORM / Spring Data JPA</a> .  To the listed disadvantages of using @Transaction, you can still add the inability to view real requests when executing the service method to the database (for example, if hibernate.use_sql_comments is enabled) <br><br>  Here I will write as easier, shorter, more reliable to test Spring REST controllers. <a name="habracut"></a><br><br><h3>  Spring security test </h3><br>  Prior to the release of Spring Security 4.0, it was a <a href="http://spring.io/blog/2014/05/07/preview-spring-security-test-method-security">separate project</a> that was included in <a href="http://www.infoq.com/news/2015/04/spring-security-4">Spring Security 4.0</a> as Improved Testing Support. <br>  Now it is in the central maven repository and connects like this: <br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">properties</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">spring-security.version</span></span></span><span class="hljs-tag">&gt;</span></span>4.0.1.RELEASE<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">spring-security.version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">properties</span></span></span><span class="hljs-tag">&gt;</span></span> ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.springframework.security<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spring-security-test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>${spring-security.version}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  General code for testing controllers can be made an <a href="">abstract class</a> . <br>  Connecting security to Spring MVC tests has become a bit easier: <br><pre> <code class="java hljs"> mockMvc = MockMvcBuilders.webAppContextSetup(webApplicationContext) .apply(springSecurity()).build();</code> </pre><br>  For REST services, the project uses http-basic, <a href="&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgljXq2H1M7ah0zz4UMrrLLsu8wjg#testing-">whose support in Spring Security Test</a> is among many others. <br>  For convenience, we create <a href="">test data</a> and make httpBasic connection even easier: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> RequestPostProcessor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userHttpBasic</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(User user)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SecurityMockMvcRequestPostProcessors .httpBasic(user.getEmail(), user.getPassword()); } mockMvc.perform(get(REST_URL).contentType(MediaType.APPLICATION_JSON) .with(userHttpBasic(ADMIN))) .andExpect(...</code> </pre><br>  At the same time, in tests, there is no substitution of the security context, as you <a href="">had to do before</a> , but the httpBasic "Authorization" header is honestly set. <br><br><h3>  Checking the JSON content of the response through your own ResultMatcher </h3><br>  The usual practice in all REST testing guides is: use the <a href="https://code.google.com/p/json-path/">json-path</a> to selectively check the content fields of the json response (there is usually not enough patience for a full check).  Or the use of <a href="http://www.jayway.com/2014/01/14/unit-testing-spring-mvc-controllers-with-rest-assured/">more advanced libraries</a> , which does not change the essence of the approach. <br><br>  However, it is much better to compare at once the object with all the nested levels of the hierarchy!  Since  The string representation of JSON objects cannot be compared (it may have different formatting and field order), you need to serialize the contents of the JSON response into an object and compare objects.  Spring MVC is integrated with <a href="https://github.com/FasterXML/jackson">the Jackson JSON library</a> , so we can <a href="">configure ObjectMapper</a> as convenient for us (for example, disable <a href="https://github.com/FasterXML/jackson-datatype-hibernate">serialization of lazy loading of Hibernate object fields</a> ) and make a convenient utility class for <a href="">JSON serialization-deserialization</a> . <br><br>  For use in Spring Test syntax tests: <br><pre> <code class="java hljs">.andExpect(status().isOk()) .andExpect(content().contentType(MediaType.APPLICATION_JSON))</code> </pre><br>  We make <a href="">our own ResultMatcher</a> with the methods <b>contentMatcher</b> and <b>contentListMatcher</b> comparing objects and a list of objects, respectively.  It is enough to configure this Matcher to work with the necessary objects (in the simplest case, if the ORM object has the equals method set to PK and it cannot be used for comparison, <a href="">you can compare objects using toString</a> ): <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ModelMatcher&lt;UserMeal, String&gt; MATCHER = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ToStringModelMatcher&lt;&gt;(UserMeal.class);</code> </pre><br>  For more complex cases, for comparison, you will have to <a href="">make a wrapper over an ORM object</a> . <br>  But now the tests for checking the JSON object in the REST response with any level of attachments of the JSON object will look very simple: <br><br><pre> <code class="java hljs">mockMvc.perform(get(REST_URL + <span class="hljs-string"><span class="hljs-string">"by?email="</span></span> + USER.getEmail()) .with(userHttpBasic(ADMIN))) .andExpect(MATCHER.contentMatcher(USER)) .andExpect(...</code> </pre><br>  The REST tests of the project controllers are configured for in-memory hsqldb, so they can be run without connecting to the DB. <br>  I hope that these solutions will be useful to you and thank you for your attention. </div><p>Source: <a href="https://habr.com/ru/post/259055/">https://habr.com/ru/post/259055/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259035/index.html">Text Analytics as Commodity: Text Analytics Application Overview</a></li>
<li><a href="../259041/index.html">How to make a small contest in one day</a></li>
<li><a href="../259047/index.html">OWASP TOP-10: a practical look at web application security: # 1 - injections</a></li>
<li><a href="../259051/index.html">That new versions of UEFI standards are prepared for us, part one, PI 1.4</a></li>
<li><a href="../259053/index.html">The second version of the Evernote SDK for Android: new Evernote features in your applications</a></li>
<li><a href="../259057/index.html">SMS chat on my knees</a></li>
<li><a href="../259065/index.html">Digest news of the gaming industry</a></li>
<li><a href="../259067/index.html">Simple Web Service with Jetty Embedded</a></li>
<li><a href="../259069/index.html">Memory Optimization DataTable</a></li>
<li><a href="../259071/index.html">New to Wolfram SystemModeler: FMI Import</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>