<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development of RvaToRaw and RawToRva features</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Purpose of the article 
 The purpose of this article is the desire of the author to show some nuances in the development of the functions of RvaToRaw ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development of RvaToRaw and RawToRva features</h1><div class="post__text post__text-html js-mediator-article"><h4>  Purpose of the article </h4><br>  The purpose of this article is the desire of the author to show some nuances in the development of the functions of RvaToRaw / RawToRva, which are important for system utilities working with executable files of PE format. <br><br><h4>  Who is the article aimed at? </h4><br><ul><li>  The reader is familiar with the ‚ÄúPortable Executable‚Äù file format. </li><li>  The reader&gt; = 1 times wrote the parser of this file </li><li>  The reader is well aware of what RvaToRaw is. </li></ul><br><a name="habracut"></a><br><h4>  Terminology </h4><br><br>  <b>RVA</b> - This is an abbreviation of English.  Words Relative Virtual Address and means the offset in bytes from the beginning of the real or estimated module load address. <br>  <b>RAW</b> - File offset from the beginning of the file.  Another successful name is ‚ÄúFile offset‚Äù. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Development </h4><br>  When searching Google for the keywords ‚Äúrva to raw‚Äù or ‚Äúrva to offset‚Äù you may stumble upon the following code: <br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">DWORD </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RVAToOffset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IMAGE_NT_HEADERS32* pNtHdr, DWORD dwRVA)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i; WORD wSections; PIMAGE_SECTION_HEADER pSectionHdr; <span class="hljs-comment"><span class="hljs-comment">/* Map first section */</span></span> pSectionHdr = IMAGE_FIRST_SECTION(pNtHdr); wSections = pNtHdr-&gt;FileHeader.NumberOfSections; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; wSections; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pSectionHdr-&gt;VirtualAddress &lt;= dwRVA) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((pSectionHdr-&gt;VirtualAddress + pSectionHdr-&gt;Misc.VirtualSize) &gt; dwRVA) { dwRVA -= pSectionHdr-&gt;VirtualAddress; dwRVA += pSectionHdr-&gt;PointerToRawData; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (dwRVA); } pSectionHdr++; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-number"><span class="hljs-number">-1</span></span>); }</code> </pre> <br><br>  The code has a few blunders and is very popular. <br><br>  It does not include: <br><ul><li>  The rva value can be less than OptionalHeader.SizeOfHeaders, i.e.  the value may indicate inside the header </li><li>  Values ‚Äã‚Äãof VirtualAddress, VirtualSize, PointerToRawData are not aligned at all </li><li>  The macro <b>IMAGE_FIRST_SECTION is used</b> , which does not take into account 64-bit files, winnt.h honestly says this. </li></ul><br><br>  More correct code, from the point of view of the author: <br><br><div class="spoiler">  <b class="spoiler_title">Code class leveling offsets and addresses</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alignDown</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value_, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> factor)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value_ &amp; ~(factor<span class="hljs-number"><span class="hljs-number">-1</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alignUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value_, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> factor)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> alignDown(value_ - <span class="hljs-number"><span class="hljs-number">1</span></span>, factor) + factor; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Aligner</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> FORCED_FILE_ALIGNMENT = <span class="hljs-number"><span class="hljs-number">0x200</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> MIN_SECTION_ALIGNMENT = <span class="hljs-number"><span class="hljs-number">0x1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: Aligner(<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> fileAlignment_, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> sectionAlignement_) : fileAlignment(fileAlignment_) , sectionAlignement(sectionAlignement_) { } <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> getVirtualSize(<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> size) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> needAlign(sectionAlignement) ? alignUp(size, sectionAlignement) : size; } <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> getVirtualAddress(<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> address) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> needAlign(sectionAlignement) ? alignDown(address, sectionAlignement) : address; } <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> getFileOffset(<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> offset) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> needAlign(sectionAlignement) ? alignDown(offset, FORCED_FILE_ALIGNMENT) : offset; } <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> getSectionSize(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ImgSectionHeader&amp; header) { <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> fileSize = header.SizeOfRawData; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> virtualSize = header.Misc.VirtualSize; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (needAlign(sectionAlignement)) { fileSize = alignUp(fileSize, fileAlignment); virtualSize = alignUp(virtualSize, sectionAlignement); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::min(fileSize, virtualSize); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> fileAlignment; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> sectionAlignement; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">needAlign</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sectionAlignement)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sectionAlignement &gt;= MIN_SECTION_ALIGNMENT; } };</code> </pre><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Method code for converting Rva to Raw</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> numInvalidRaw = (<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>)( <span class="hljs-number"><span class="hljs-number">-1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> PeUtils::RvaToRaw( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PeImage&amp; peImage, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> rva ) { <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> result = INVALID_RAW; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span>&amp; optionalHeader = peImage.NtHeaders.OptionalHeader; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rva &lt; optionalHeader.SizeOfHeaders) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rva; <span class="hljs-function"><span class="hljs-function">Aligner </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">aligner</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(optionalHeader.FileAlignment, optionalHeader.SectionAlignment)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (peImage.NtHeaders.FileHeader.NumberOfSections &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span>&amp; section : peImage.Sections) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (section.PointerToRawData == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> sectionStart = aligner.getVirtualAddress(section.VirtualAddress); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> sectionSize = aligner.getSectionSize(section); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> sectionEnd = sectionStart + sectionSize; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sectionStart &lt;= rva &amp;&amp; rva &lt; sectionEnd) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> sectionOffset = aligner.getFileOffset(section.PointerToRawData); sectionOffset += (rva - sectionStart); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sectionOffset &lt; peImage.SizeOfFileImage) result = sectionOffset; } } <span class="hljs-comment"><span class="hljs-comment">// for } else if (rva &lt; aligner.getVirtualSize(optionalHeader.SizeOfImage)) { result = rva; } return result; }</span></span></code> </pre><br></div></div><br><br>  What is improved: <br><ul><li>  It takes into account the fact that it is not always necessary to align (see the needAlign method) </li><li>  The fact that the number of sections may be zero is taken into account.  And such a file can be downloaded! </li><li>  When required, the PointerToRawData and VirtualAddress values ‚Äã‚Äãare aligned down </li><li>  More correct section size calculation </li></ul><br><br>  Nota bene: <br>  In fact, even this is not the final version, but it is already closer to how the system loader understands such files. <br><br><h4>  Testing </h4><br>  Create a test suite of executable files and periodically check your RvaToRaw \ RawToRva for this set, which could be changed after refactoring or fixing bugs. <br><br>  Ways to get test files: <br><ol><li>  Apply an executable file wrapper that can create off-standard values ‚Äã‚Äãin the headers.  An example of such a packer is Upack.exe, but there are many other </li><li>  Periodically replenish their collection of new malicious files, for example with MDL (see additional sources) </li></ol><br><br>  <b>Nota bene:</b> <br>  I apologize for the reminder, but any doubtful file is best run in a guest virtual machine, for example, based on VMWare or VirtualBox. <br><br>  You can also check the correctness of your code using Hiew, IDA Pro or a debugger. <br><br><h4>  Additional sources: </h4><br><ol><li>  #include &lt;winnt.h&gt;.  Hider is included in MSVC and not only.  This leader should be a desktop reference for anyone who writes the parser of this file! </li><li>  Matt Pitrek.  "PE and COFF object file formats".  <a href="">rsdn.ru/article/baseserv/pe_coff.xml</a> </li><li>  Maxim M. Gumerov.  "PE File Downloader".  <a href="">rsdn.ru/article/baseserv/peloader.xml</a> </li><li>  Forums &gt;&gt; IDA Pro &gt;&gt; # new PE loader bug and new crack-me.  <a href="http://www.openrce.org/forums/posts/969">www.openrce.org/forums/posts/969</a> </li><li>  MDL.  <a href="http://www.malwaredomainlist.com/mdl.php">www.malwaredomainlist.com/mdl.php</a> .  Resource where you can download samples of questionable files </li></ol><br><br>  Post scriptum: <br><ul><li>  I emphasize that the author did not set himself the goal of surprise or ridicule anyone.  The author has a great desire to improve the quality of the system code.  I really hope that in the future ‚Äúgreat Google‚Äù will issue links to the fairly correct code RvaToRaw \ RawToRva </li><li>  The author will also be happy about any questions, any criticism and any wishes. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/129241/">https://habr.com/ru/post/129241/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../129235/index.html">Haskell in the real world</a></li>
<li><a href="../129236/index.html">Interfaces: Simplify the search engine (or why we don‚Äôt)</a></li>
<li><a href="../129237/index.html">Dojo-do-it-yourself widget</a></li>
<li><a href="../129239/index.html">Start Motivate Clock: ‚ÄúDo not think about seconds down‚Äù</a></li>
<li><a href="../129240/index.html">Tuning for the Public folder in Dropbox</a></li>
<li><a href="../129242/index.html">FluentMigrator - Version Migration System</a></li>
<li><a href="../129243/index.html">Web-to-Print technology: designer to himself</a></li>
<li><a href="../129244/index.html">BMW autopilot drove along the Munich-Nuremberg highway</a></li>
<li><a href="../129246/index.html">Work with last.fm API on JavaScript</a></li>
<li><a href="../129247/index.html">Evolution of understanding the PLO</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>