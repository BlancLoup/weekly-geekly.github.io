<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Scalable Mail System Architecture</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, we consider one of the options for implementing a scalable architecture of a large mail system. 

 December 6, 2012. Google stopped r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Scalable Mail System Architecture</h1><div class="post__text post__text-html js-mediator-article">  In this article, we consider one of the options for implementing a scalable architecture of a large mail system. <br><br>  December 6, 2012. Google stopped registering new accounts for the free version of Google Apps. <br><br>  Customers of <a href="http://centos-admin.ru/">our company</a> constantly have a need for e-mail serving their sites. <br>  We used to set up Google Apps for them, but after December 6, having studied the solutions offered on the market, we decided that it was time to build our own email system. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As you know, the appetite comes with eating.  If you have already decided to build something of your own, then you should immediately lay the opportunity for growth. <br>  For the projected mail system, the following requirements were formulated: <br><ul><li>  scalability (unlimited number of serviced domains, total mailboxes 100 terabytes and more); </li><li>  fault tolerance (all intermediate services must be duplicated); </li><li>  extensibility (adding new nodes to the system should be easy and simple). </li></ul><br><br><h5>  We started by choosing the storage for the letters ... </h5><br>  In fact, the choice was small: <br><ul><li>  dovecot / cyrus with file system storage via maildir / mailbox; </li><li>  dbmail with storage in the database. </li></ul><br>  After assessing the number of services provided out of the box, as well as studying the nuances of use, we decided to stop at <a href="http://dbmail.org/">dbmail</a> . <br>  Here is a short list of goodies that dbmail provides: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/981/5f9/75c/9815f975c5461dbeaa6ff94909536af2.png"><br><br><ul><li>  access to the boxes via IMAP, POP3; </li><li>  sieve scripts for sorting mail; </li><li>  receiving mail via smtp and lmtp protocols; </li><li>  administration through cli and SQL queries. </li></ul><br><br><a name="habracut"></a><br><br>  Postfix was selected as MTA.  Since we have been working with him for a long time, we confidently believe that it is quite a fast, flexible and easily customizable program.  Moreover, the dbmail website has instructions on how to configure the postfix + dbmail bundle. <br><br>  And the best proxy of all times and peoples works as a load balancer: nginx. <br>  A web interface to mailboxes can be provided by any of the dozens of programs available.  For a start, it was decided to use RoundCube. <br><br><h5>  As a result, the following project architecture emerged: </h5><br><br>  1. At the forefront, we run nginx with the Mail module enabled, it accepts SMTP, IMAP, POP3 connections from clients and, based on the user name and password, proxies the connection to the correct server. <br>  2. In the depth of the defense works a lot of postfix and dbmail, each of which serves its own domains. <br><br>  To the outside world, it all looks like one big mail server. <br><br><h5>  In theory, scalability has been achieved, now the task is to implement. </h5><br><br>  Each system module will work in its OpenVZ container.  As the load increases, we will clone / transfer containers to new physical servers. <br><br>  In separate containers we put nginx, postfix with different mail filters, dbmail and the storage of letters in the MySQL database we place in the same container, because dbmail does not have to heavily load the processor, and the data volumes transferred between dbmail and mysql will be large (duplication of data in the storage Letters will be implemented through the MySQL replication master-slave mechanism, organizing a hotbackup module for each dbmail module. <br><br>  Also, for convenience, web servers with a roundcube and a control panel of the entire system can be separated into separate containers. <br><br>  All containers communicate with each other over a local network with ‚Äúgray‚Äù addresses. <br>  It was planned to issue real Internet addresses only to nginx-containers. <br>  In the process of installing and configuring nginx, it turned out that he cannot proxy SMTP sessions without authorization.  Solving this problem slightly changed the originally planned project architecture, which led to increased resiliency and extensibility.  We refused to proxy SMTP traffic through nginx, and decided that postfix modules will receive it directly. <br><br>  All postfix modules of the system were made the same, each with its own real IP address, and we determine which dbmail module to send mail through transport_maps. <br>  As a result, any postfix-module can accept mail for any domain in the system, apply various filters and deliver to the necessary storage. <br>  They will be balanced through round-robin records in the DNS: <br><br><pre><code class="bash hljs">nginx1 IN A 1.1.2.1 nginx2 IN A 1.1.2.2 postfix1 IN A 1.1.1.1 postfix2 IN A 1.1.1.2 postfix3 IN A 1.1.1.3 mx1 IN A 1.1.1.1 IN A 1.1.1.2 IN A 1.1.1.3 mx2 IN A 1.1.1.2 IN A 1.1.1.3 IN A 1.1.1.1 mx3 IN A 1.1.1.3 IN A 1.1.1.2 IN A 1.1.1.1 imap IN A 1.1.2.1 IN A 1.1.2.2 pop3 IN A 1.1.2.1 IN A 1.1.2.2 smtp IN CNAME mx1 _spf IN TXT <span class="hljs-string"><span class="hljs-string">"v=spf1 ip4:1.1.1.1 ip4:1.1.1.2 ip4:1.1.1.3 ?all"</span></span></code> </pre> <br><br>  The necessary records are added to the client's domain: <br><pre> <code class="bash hljs">@ IN MX 10 mx1.dbmail.io. @ IN MX 20 mx2.dbmail.io. @ IN MX 30 mx3.dbmail.io. @ IN TXT <span class="hljs-string"><span class="hljs-string">"v=spf1 a mx include:_spf.dbmail.io -all"</span></span></code> </pre><br><br>  Mail clients of users are configured to receive mail with pop3.dbmail.io or imap.dbmail.io, and send mail via smtp.dbmail.io <br><br>  Only dbmail-modules were not duplicated and unique, but they are not directly accessible from the Internet, so there is no need to dynamically distribute the load on them yet. <br>  Each of the dbmail modules stores mail for several domains, if the module‚Äôs resources will run out, <br>  Some domains can be evicted into a separate module. <br><br>  And in the future there are plans to move to the storage of mail in a dedicated cluster database and unify dbmail-modules. <br><br><h5>  The result was such a scalable, fault-tolerant and expandable mail system: </h5><br><br><img src="https://habrastorage.org/storage2/1b5/8c0/a29/1b58c0a296b293aa66d2170e744d5fab.png"><br><br>  All elements of our postal system communicate with each other using standard protocols and, as it was naively thought, everything should have worked immediately and without the need to build props. <br>  Unfortunately, the design had to finish the file. <br>  History settings and debugs, read the following articles. </div><p>Source: <a href="https://habr.com/ru/post/167051/">https://habr.com/ru/post/167051/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../167037/index.html">Small crib on Cisco CSS 11500</a></li>
<li><a href="../167039/index.html">Incorrect work of the standard search for Windows operating systems</a></li>
<li><a href="../167041/index.html">Breaking matches, or Alice in the land of mathematical errors</a></li>
<li><a href="../167043/index.html">How to create a 3D panorama of the battle of Borodino</a></li>
<li><a href="../167045/index.html">Kiev. Saturday. Habrare</a></li>
<li><a href="../167053/index.html">Snippet menuCaching for MODX Revolution</a></li>
<li><a href="../167055/index.html">Antigua and Barbuda: a country that does not pay license fees in the US</a></li>
<li><a href="../167057/index.html">WindowsAndroid allows you to run Android 4.0 ICS as a Windows application</a></li>
<li><a href="../167059/index.html">Scrum - real experience in methodology</a></li>
<li><a href="../167061/index.html">Remember the real world</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>