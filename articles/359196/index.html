<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Google Tag Manager usage examples for customTask</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The material is based on the Simo Ahava article "customTask - The Guide" . 

 About a year ago (in 2017), the Universal Analytics JS library was updat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Google Tag Manager usage examples for customTask</h1><div class="post__text post__text-html js-mediator-article">  <i>The material is based on the Simo Ahava article <a href="https://www.simoahava.com/analytics/customtask-the-guide/">"customTask - The Guide"</a> .</i> <br><br>  About a year ago (in 2017), the Universal Analytics JS library was updated.  The update brought with it such a wonderful thing as <b>customTask</b> .  This feature, within the framework of Google Tag Manager, allows you to perform any ‚Äútasks‚Äù before sending a hit to Google Analytics. <br><br>  In the <a href="https://www.simoahava.com/analytics/customtask-the-guide/">original article,</a> Simo Ahava describes in detail the mechanism of how customTask works and shares useful examples.  You can also familiarize yourself with the <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/tasks">official manual</a> on the Universal Analytics library, which describes all tasks with their order of execution. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/q6/kt/zb/q6ktzb7tdecssudlibkjufuj_8a.png"><br>  <i>The order of the tasks analytics.js</i> <br><br>  Below is a brief overview of customTask usage examples.  I am sure some of the solutions will be useful for you. <br><a name="habracut"></a><br><h3>  Examples of using customTask (quick review) </h3><br>  <b>1. Record Client ID in custom dimension</b> <br><br>  The most reliable way to transfer Client ID to date.  Setup guides: <br><br><ul><li>  <a href="https://burgerdata.com/blog/kak-peredavat-clientid-cherez-customtask/">From burgerdata</a> </li><li>  <a href="https://www.simoahava.com/gtm-tips/use-customtask-access-tracker-values-google-tag-manager/">From Simo Ahava</a> </li></ul><br>  <b>2. Duplication of the GA hit and sending it to other places</b> <br><br>  Manuals: <br><br><ul><li>  <a href="https://www.simoahava.com/gtm-tips/send-google-analytics-tag-multiple-properties/">Sending to multiple GA property</a> , by Simo Ahava. <br>  A good idea for optimizing tags in GTM (no need to create additional tags to send data to multiple accounts).  The only drawback is that if there are cross-domains tracking in the tag settings, then the duplicate hit will leave without these settings (only the original hit will save the tag settings). </li><li>  <a href="https://habr.com/post/353836/">Sending to Google Sheet</a> by dkomarovskiy. <br>  Upload all hit data (payload) to Google Sheet.  Useful for debugging and data analysis (if the project is small). </li><li>  <a href="http://dmitriilin.com/exporting-data-google-analytics-google-bigquery/">Sending to Google Bigquery</a> ( <b>note!</b> <a href="http://dmitriilin.com/exporting-data-google-analytics-google-bigquery/">SendHitTask</a> <b>is used here, ie you cannot use customTask and sendHitTask at the same time; you can rewrite the code from sendHitTask to customTask - then everything is ok</b> ) by Dmitri Ilin. <br>  Steep manual if you need to completely get rid of the sampling and limitations of GA. </li><li>  <a href="https://www.simoahava.com/analytics/automatically-fork-google-analytics-hits-snowplow/">Sending to Snowplow</a> , by Simo Ahava. <br>  Snowplow is a service that allows you to create / organize your own pipeline for working with data, including  web analytics.  The service includes all processes of working with data: from collection / processing to storage / analysis / visualization, i.e.  You can make your own GA with blackjack and pivot tables. </li></ul><br>  <b>3. Removal of personal data from GA payload (GDPR *)</b> <br><br>  <a href="https://www.simoahava.com/gtm-tips/remove-pii-google-analytics-hits/">Manual</a> from Simo Ahava. <br><br>  First of all, it is useful for those who work with EU countries and are faced with meeting the requirements of the <a href="https://piwik.pro/blog/gdpr-interview-aurelie-pols/">GDPR</a> .  This solution allows you to remove all personal data from payload'a (wherever they are: URL, Custom Dimension, Event Label, etc.). <br><br>  For example page path: <br><br><pre><code class="xml hljs">/test?tel=+44012345678&amp;email=brian@me.com&amp;other=bclifton@DOMAIN.com&amp;firstName=brian&amp;password=hello</code> </pre> <br>  after modifying customTask will be like this: <br><br><pre> <code class="xml hljs">/test?tel=[REDACTED TELEPHONE]&amp;email=b[REDACTED EMAIL]om&amp;other=bcli[REDACTED SELF-EMAIL]OMAIN.com&amp;firstName=[REDACTED NAME]&amp;password=[REDACTED PASSWORD]</code> </pre><br>  <b>4. Tracking offline users</b> <br><br>  <a href="https://www.simoahava.com/analytics/track-users-who-are-offline-in-google-analytics/">Manual</a> from Simo Ahava. <br><br>  Solves the problem of a broken connection i.  for example, when the connection is terminated, sending the hit does not end with an error (because there is no connection), but is fixed in the queue in localStorage.  When the connection resumes, the hit is sent.  It is useful for projects with a high share of the audience from mobile traffic with unstable connections (often travel by subway for example). <br><br>  <b>5. Accounting user consent to send data to GA (GDPR *)</b> <br><br>  <a href="https://www.simoahava.com/gtm-tips/respect-opt-out-from-advertising-and-analytics/">Manual</a> from Simo Ahava. <br><br>  Useful in meeting the requirements of <a href="https://piwik.pro/blog/gdpr-interview-aurelie-pols/">GDPR</a> .  For example, on your site there is a pop-up in which the user agrees / does not agree to the processing of their personal data by 3 persons.  If refused, this customTask will not send data to GA and DoubleClick. <br><br>  <b>6. Submitting the Google Optimize Experiment ID to GA</b> <br><br>  <a href="https://www.simoahava.com/analytics/send-event-custom-dimension-google-optimize-experiment-running/">Manual</a> from Simo Ahava. <br><br>  Helps with the problem of displaying Google Optimize data in GA.  During the experiment, the user is assigned the variables Experiment Name and Experiment ID.  Linking this data to specific sessions / segments is a problem this customTask helps to cope with.  Task checks the Page View tag if it contains data about the experiment - writes it to the custom dimension and sends a hit. <br><br>  <b>7. Auto Link Domains as a regular expression</b> <br><br>  <a href="https://www.simoahava.com/gtm-tips/auto-link-domains-with-regex/">Manual</a> from Simo Ahava. <br><br>  Solves the problem of the inability to use regular expressions in GTM tags in the <b>Auto Link Domains</b> field when setting up inter-domain tracking. <br><br>  <b>8. GA Automatic Cutting GA Payload Lenght</b> <br><br>  <a href="https://www.simoahava.com/analytics/automatically-reduce-google-analytics-payload-length/">Manual</a> from Simo Ahava. <br><br>  A beautiful solution to the problem of exceeding payload lenght.  One by one, it removes unnecessary parameters from payload until it is less than 8192. You can customize what to throw out specifically. <br><br><h3>  Merge several solutions into one customTask </h3><br>  If you want to combine several solutions in one customTask, then you need to remember the following rules for working with customTask: <br><br><ul><li>  Only one customTask can be defined in a GTM tag. </li><li>  In JS code customTask'a, the <b>model</b> parameter is defined once. <br>  The sendHitTask <b>task is</b> also <b>sent</b> once (within one tag): <br>  <i>model.set ('sendHitTask', function (sendModel) {...});</i> <br>  If you write several sendHitTask in one customTask - only one (the last) is sent. </li></ul><br>  <b>An example of combining several solutions into one customTask</b> <br><br>  What we combine: <br><br><ul><li>  Client dimension definition in custom dimension </li><li>  removal of personal data (PII) from payload </li><li>  sending hit to several GA property </li></ul><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newTrackingId = <span class="hljs-string"><span class="hljs-string">'UA-12345678-1'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">model</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//Define client ID model.set('dimension1', model.get('clientId')); // Add the PII patterns into this array as objects var piiRegex = [{ name: 'EMAIL', regex: /(?&lt;=emailAddress=|email=).+?(?=@|%40)/gi }]; // Fetch reference to the original sendHitTask var globalSendTaskName = '_' + model.get('trackingId') + '_sendHitTask'; var originalSendTask = window[globalSendTaskName] = window[globalSendTaskName] || model.get('sendHitTask'); var i, hitPayload, parts, val, oldTrackingId; model.set('sendHitTask', function(sendModel) { // Overwrite sendHitTask with PII purger hitPayload = sendModel.get('hitPayload').split('&amp;'); for (i = 0; i &lt; hitPayload.length; i++) { parts = hitPayload[i].split('='); // Double-decode, to account for web server encode + analytics.js encode try { val = decodeURIComponent(decodeURIComponent(parts[1])); } catch (e) { val = decodeURIComponent(parts[1]); } piiRegex.forEach(function(pii) { val = val.replace(pii.regex, '[REDACTED ' + pii.name + ']'); }); parts[1] = encodeURIComponent(val); hitPayload[i] = parts.join('='); } sendModel.set('hitPayload', hitPayload.join('&amp;'), true); originalSendTask(sendModel); // Rewrite the tracking ID hitPayload = sendModel.get('hitPayload'); oldTrackingId = new RegExp(sendModel.get('trackingId'), 'gi'); sendModel.set('hitPayload', hitPayload.replace(oldTrackingId, newTrackingId), true); originalSendTask(sendModel); }); }; }</span></span></code> </pre><br>  First we determine the Client ID.  Then, through regular expressions, we specify what personal data we want to search.  In this example, only one parameter is specified - email.  More can be added (see the <a href="https://www.simoahava.com/gtm-tips/remove-pii-google-analytics-hits/">Simo Ahava manual</a> ). <br>  The next step is to check payload for personal data and overwrite it.  There is one nuance - double decoding.  A try ... catch statement has been added to catch instances if the percent sign is found at '%' (the condition% 40 has also been added to regex).  If this instruction is removed, then hits in which it is encountered '%' will not be available because  JS error occurs.  There are many ways of decoding, in this case, it is one of the working options.  You can try your own. <br>  The last steps are sending the modified payload to the original GA property and duplicating / sending to another GA property. <br><br>  If you have more examples of using customTask - share your experience.  I would be happy to add an article. </div><p>Source: <a href="https://habr.com/ru/post/359196/">https://habr.com/ru/post/359196/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../359186/index.html">MTS will spend on the implementation of the law of Spring 60 billion rubles</a></li>
<li><a href="../359188/index.html">Intelligent Decision Support Systems - Brief Overview</a></li>
<li><a href="../359190/index.html">As our customer did not want to let go of the provider</a></li>
<li><a href="../359192/index.html">Classic JavaScript algorithms and data structures</a></li>
<li><a href="../359194/index.html">Java and Project Reactor. Episode 2</a></li>
<li><a href="../359198/index.html">Create a calculator with units</a></li>
<li><a href="../359200/index.html">Google accused of spying on users Safari on iPhone</a></li>
<li><a href="../359204/index.html">Build projects with dapp. Part 2: JavaScript (frontend)</a></li>
<li><a href="../359206/index.html">Caution. How to use process metrics without harming process health</a></li>
<li><a href="../359208/index.html">How to quickly and efficiently work with priorities according to the Lean Prioritization method?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>