<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Testing with a database in .NET</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A common approach in .NET for testing applications that work with a database is dependency injection (Dependency Injection). It is proposed to separat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Testing with a database in .NET</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/b20/0b2/7a0/b200b27a05264e22918d78141f9f0903.jpg"></div><br><p>  A common approach in .NET for testing applications that work with a database is dependency injection (Dependency Injection).  It is proposed to separate the code working with the base from the main logic by creating an abstraction, which can later be replaced in tests.  This is a very powerful and flexible approach, which nevertheless has some drawbacks - increasing complexity, separating logic, explosive growth in the number of types.  More in the previous article <a href="https://habrahabr.ru/post/318642/">Something is not right with testing in .NET (Java, etc.)</a> or in <a href="https://en.wikipedia.org/wiki/Dependency_injection">Wiki / Dependency Injection</a> . </p><br><p>  There is a simpler approach, widespread in the world of dynamic languages.  Instead of creating an abstraction that can be controlled in tests, this approach suggests controlling the base itself.  The test framework provides a clean base for each test, and you can create a test script in it.  It is easier and gives more confidence in the tests. </p><br><a name="habracut"></a><br><h2>  Example </h2><br>  As the previous article showed, the example is very important.  If it is unsuccessful, the example itself is criticized, not the approach.  Here I gave him more attention, but of course he is not perfect either: <br><br><blockquote>  There is some kind of application for inventory accounting of goods.  Goods can be moved between warehouses using movement documents.  A method is needed that allows to obtain balances at a specified warehouse at a specified point in time. <br></blockquote><br>  To do this, we introduce the following method (and it will need to be tested): <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ReminesService</span></span> { <span class="hljs-function"><span class="hljs-function">RemineItem[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetReminesFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Storage storage, DateTime time</span></span></span><span class="hljs-function">)</span></span> { ... } }</code> </pre> <br>  The article will not implement this method, but it is in the repository on the githaba. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Test database </h2><br>  We will need a database for testing.  For simple projects you can use SQLite, this is a good compromise between the speed of tests and their reliability.  For more complex cases, it is better to use the same database as in the development.  In most cases, this is not a problem - MySql and PostgreSql are lightweight, for SQLServer there is a LocalDb mode. <br><br>  If you are working with SQLServer, it is convenient to use the LocalDb mode for the test database - it is much easier and faster than the full database, while fully functional.  To do this, you need to configure App.config in the test project: <br><br><div class="spoiler">  <b class="spoiler_title">Configuration for SQLServer LocalDb</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configSections</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">section</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"entityFramework"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.Data.Entity.Internal.ConfigFile.EntityFrameworkSection, EntityFramework, Version=6.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">requirePermission</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configSections</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">entityFramework</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">defaultConnectionFactory</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.Data.Entity.Infrastructure.LocalDbConnectionFactory, EntityFramework"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">parameters</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">parameter</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MSSQLLocalDB"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">parameters</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">defaultConnectionFactory</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">providers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">provider</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">invariantName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.Data.SqlClient"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.Data.Entity.SqlServer.SqlProviderServices, EntityFramework.SqlServer"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">providers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">entityFramework</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br><h2>  Framework </h2><br>  Since this approach is very rare in .NET, there are almost no ready-made libraries for its implementation.  Therefore, I designed the work in this area in a small library <a href="https://github.com/justserega/DbTest">DbTest</a> .  You can view the sources and examples on the githab or install into the project via nuget.  The project is in the preliminary version and the API may change - so be careful. <br><br><h2>  Initial data </h2><br>  In a real system, there are many relationships between models; in order to insert at least one row in the target table, you need to fill in a set of related tables.  For example, a product (Good) may refer to a manufacturer (Manufacturer), which in turn refers to a country (Country). <br><br>  To simplify the further creation of test scripts, you need to create a minimum set of common data for the system. <br><br>  To make it a bit more fun, let's take whiskey bottles as goods.  Let's start with the model that has no dependencies - the country of the manufacturer (Country): <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Countries</span></span> : <span class="hljs-title"><span class="hljs-title">IModelFixture</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Country</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TableName =&gt; <span class="hljs-string"><span class="hljs-string">"Countries"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Country Scotland =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Country { Id = <span class="hljs-number"><span class="hljs-number">1</span></span>, Name = <span class="hljs-string"><span class="hljs-string">"Scotland"</span></span>, IsDeleted = <span class="hljs-literal"><span class="hljs-literal">false</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Country USA =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Country { Id = <span class="hljs-number"><span class="hljs-number">2</span></span>, Name = <span class="hljs-string"><span class="hljs-string">"USA"</span></span>, IsDeleted = <span class="hljs-literal"><span class="hljs-literal">false</span></span> }; }</code> </pre><br>  In order for the framework to understand that this is a description of the initial data, the class must implement the <code>IModelFixture&lt;T&gt;</code> interface.  Instances of models are declared static to provide access to them from other fixtures and tests.  You must explicitly specify the primary keys ( <code>Id</code> ) and follow their uniqueness within the same model. <br><br>  Now you can create manufacturers: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Manufacturers</span></span> : <span class="hljs-title"><span class="hljs-title">IModelFixture</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Manufacturer</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TableName =&gt; <span class="hljs-string"><span class="hljs-string">"Manufacturers"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Manufacturer BrownForman =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Manufacturer { Id = <span class="hljs-number"><span class="hljs-number">1</span></span>, Name = <span class="hljs-string"><span class="hljs-string">"Brown-Forman"</span></span>, CountryId = Countries.USA.Id, IsDeleted = <span class="hljs-literal"><span class="hljs-literal">false</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Manufacturer TheEdringtonGroup =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Manufacturer { Id = <span class="hljs-number"><span class="hljs-number">2</span></span>, Name = <span class="hljs-string"><span class="hljs-string">"The Edrington Group"</span></span>, CountryId = Countries.Scotland.Id, IsDeleted = <span class="hljs-literal"><span class="hljs-literal">false</span></span> }; }</code> </pre><br>  And the goods: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Goods</span></span> : <span class="hljs-title"><span class="hljs-title">IModelFixture</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Good</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TableName =&gt; <span class="hljs-string"><span class="hljs-string">"Goods"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Good JackDaniels =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Good { Id = <span class="hljs-number"><span class="hljs-number">1</span></span>, Name = <span class="hljs-string"><span class="hljs-string">"Jack Daniels, 0.5l"</span></span>, ManufacturerId = Manufacturers.BrownForman.Id, IsDeleted = <span class="hljs-literal"><span class="hljs-literal">false</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Good FamousGrouseFinest =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Good { Id = <span class="hljs-number"><span class="hljs-number">2</span></span>, Name = <span class="hljs-string"><span class="hljs-string">"The Famous Grouse Finest, 0.5l"</span></span>, ManufacturerId = Manufacturers.TheEdringtonGroup.Id, IsDeleted = <span class="hljs-literal"><span class="hljs-literal">false</span></span> }; }</code> </pre><br>  Pay attention to foreign keys - they are not specified explicitly, but refer to another fixture. <br><br>  Such an approach has many advantages over sql files or json fixtures files: <br><br><ul><li>  when creating initial data, the studio suggests which fields are in the class, controls their types </li><li>  it is easy to relate the models to each other, in the same way you can use the initial data in the tests themselves </li><li>  with the development of the system and changes in models - the compiler will check for obvious errors in the types in the fixtures </li></ul><br>  <b>Important!</b>  This approach has a drawback - every time a static property is accessed, an instance of the model and all its dependent models are created (and their dependencies, too).  If you experience performance problems or circular references, you can fix this with lazy initialization Lazy &lt;T&gt;. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Good _famousGrouseFinest = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Lazy&lt;Good&gt;(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Good { Id = <span class="hljs-number"><span class="hljs-number">2</span></span>, Name = <span class="hljs-string"><span class="hljs-string">"The Famous Grouse Finest, 0.5l"</span></span>, ManufacturerId = Manufacturers.TheEdringtonGroup.Id, IsDeleted = <span class="hljs-literal"><span class="hljs-literal">false</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Good FamousGrouseFinest =&gt; _famousGrouseFinest.Value;</code> </pre><br><h2>  Environment preparation </h2><br>  The test environment is primarily a database, it can also be singletons and static variables (for example, <code>HttpContext</code> can be set in asp.net).  It is better to collect all these operations in one place and run before each test.  We have called such a place - World.  To prepare the database, you need to call the <code>ResetWithFixtures</code> method and pass a list of initial fixtures there. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">World</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitDatabase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyContext()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbTest = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EFTestDatabase&lt;MyContext&gt;(context); dbTest.ResetWithFixtures( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Countries(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Manufacturers(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Goods() ); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitContextWithUser</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { HttpContext.Current = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpContext( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpRequest(<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"http://your-domain.com"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpResponse(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringWriter()) ); HttpContext.Current.User = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GenericPrincipal( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GenericIdentity(<span class="hljs-string"><span class="hljs-string">"root"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>] ); } }</code> </pre><br>  The ability to set static variables and singletons is especially important when testing legacy code, where it is not so easy to change the architecture - but there is an urgent need for testing.  Separating the setting of the environment into several methods allows you to prepare the environment for each individual test.  For example, in unit tests the base is not used and there is no point in clearing the base for them.  Or you may need to prepare a different environment for different system states (authorized and unauthorized user). <br><br><h2>  Creating a test script </h2><br>  In tests, we have to do a lot of preparatory work, the Arrange phase of the test is the most crucial and difficult.  Therefore, it is desirable to create helpers that simplify this process, make the code easier to read.  One convenient mechanism is to create a ModelBuilder, which creates entities, saves them to the database and returns instances for further use: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ModelBuilder</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MoveDocument </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateDocument</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> time, Storage source, Storage dest</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> document = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MoveDocument { Number = <span class="hljs-string"><span class="hljs-string">"#"</span></span>, SourceStorageId = source.Id, DestStorageId = dest.Id, Time = ParseTime(time), IsDeleted = <span class="hljs-literal"><span class="hljs-literal">false</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyContext()) { db.MoveDocuments.Add(document); db.SaveChanges(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> document; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MoveDocumentItem </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddGood</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MoveDocument document, Good good, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">decimal</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> item = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MoveDocumentItem { MoveDocumentId = document.Id, GoodId = good.Id, Count = count }; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyContext()) { db.MoveDocumentItems.Add(item); db.SaveChanges(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> item; } }</code> </pre><br><h2>  We are testing </h2><br>  It's time to put everything together and see what happened: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">SetUp</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetUp</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { World.InitDatabase(); <span class="hljs-comment"><span class="hljs-comment">//      } [Test] public void CalculateRemainsForMoveDocuments() { /// ARRANGE -    var builder = new ModelBuilder(); //      var doc1 = builder.CreateDocument("15.01.2016 10:00:00", Storages.MainStorage, Storages.RemoteStorage); builder.AddGood(doc1, Goods.JackDaniels, 10); builder.AddGood(doc1, Goods.FamousGrouseFinest, 15); //      var doc2 = builder.CreateDocument("16.01.2016 20:00:00", Storages.RemoteStorage, Storages.MainStorage); builder.AddGood(doc2, Goods.FamousGrouseFinest, 7); /// ACT -    var remains = RemainsService.GetRemainFor(Storages.RemoteStorage, new DateTime(2016, 02, 01)); /// ASSERT -   Assert.AreEqual(2, remains.Count); Assert.AreEqual(10, remains.Single(x =&gt; x.GoodId == Goods.JackDaniels.Id).Count); Assert.AreEqual(8, remains.Single(x =&gt; x.GoodId == Goods.FamousGrouseFinest.Id).Count); }</span></span></code> </pre><br>  Note the use of initial fixtures in the test code. <br>  <code>Storages.MainStorage</code> , <code>Goods.JackDaniels</code> , <code>Goods.FamousGrouseFinest</code> , etc. <br><br>  It is very convenient that you have all the objects at hand that already exist in the database and can be used in any phase of the test. <br><br><h2>  Summary </h2><br>  This approach is unfairly bypassed in the world of strongly-typed languages, while it is very widespread in dynamic languages.  This is not a silver bullet and is not a substitute for DI, but it is a very convenient and appropriate approach in many cases. <br><br>  Compared to DI, testing with this database has the following advantages: <br><br><ul><li>  Less impact of tests on architecture </li><li>  Less abstraction layers - less complexity and easier to read code </li><li>  More confidence in the tests that actually read and insert data into the database </li><li>  Faster writing and easier support </li></ul><br>  The biggest fly in the ointment with integration tests is the run time, they are much slower, but this is a solvable problem.  At least server time is much cheaper than developer time. <br><br>  DI is a very good and my favorite technique, any self-respecting programmer should be able to use it.  However, in the field of testing there is a very good alternative, which has a different set of advantages and disadvantages.  I am in favor of having a large set of methods and approaches in the arsenal and each was applied according to the situation. <br><br><h2>  useful links </h2><br>  <a href="https://github.com/justserega/DbTest">DbTest</a> (repository with test framework and examples from the article) <br>  <a href="https://github.com/vanderkleij/Smocks">Smocks</a> (mock for static system methods) </div><p>Source: <a href="https://habr.com/ru/post/319568/">https://habr.com/ru/post/319568/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319554/index.html">The digest of interesting materials for the mobile # 186 developer (January 9-15)</a></li>
<li><a href="../319558/index.html">VoIP telephony. Asterisk. Non-standard approach to everything. Part 2</a></li>
<li><a href="../319562/index.html">Android Tips and Tricks</a></li>
<li><a href="../319564/index.html">Simple computer control with voice</a></li>
<li><a href="../319566/index.html">Tax gopher - 2. "Tax on Google" and agency VAT for Russian entrepreneurs and organizations</a></li>
<li><a href="../319570/index.html">Year without a single byte</a></li>
<li><a href="../319572/index.html">Data center infrastructure in 2016: original trends that will continue in 2017</a></li>
<li><a href="../319574/index.html">How to make money on augmented and virtual reality</a></li>
<li><a href="../319578/index.html">The digest of fresh materials from the world of the frontend for the last week No. 245 (January 9 - 15, 2017)</a></li>
<li><a href="../319580/index.html">PHP Digest number 100 - interesting news, materials and tools (January 1 - 15, 2017)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>