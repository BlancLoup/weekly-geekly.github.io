<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Design patterns in automaton programming</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From the theory of algorithms and automata, we know the concept of a finite automaton , which describes the behavior of some abstract model in terms o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Design patterns in automaton programming</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/storage1/17aae672/3598682a/2b4b6680/a94c9f05.png"><br>  From the theory of algorithms and automata, we know the concept of a <a href="http://en.wikipedia.org/wiki/Finite-state_machine">finite automaton</a> , which describes the behavior of some abstract model in terms of a finite set of states and events that initiate transitions between these states.  On the basis of this theory, the now widely spread paradigm of <a href="http://en.wikipedia.org/wiki/Automata-based_programming">automaton programming</a> was developed, using which the problem is solved in terms of finite automata ‚Äî that is,  in terms of states and events.  Explicitly, this paradigm is widely used in programming languages ‚Äã‚Äãwhen building lexers.  However, you can find a huge number of examples of software systems, in some sense, implemented on the basis of this paradigm. <br><br>  The article discusses the features of the use of templates <a href="http://sourcemaking.com/design_patterns/visitor">Visitor / Double Dispatch</a> and <a href="http://sourcemaking.com/design_patterns/state">State</a> in the implementation of the system based on the state machine.  In addition, the article can be viewed as a continuation of the <a href="http://spiff.habrahabr.ru/blog/84706/">cycle of publications on Habrahabr design patterns</a> . <br><br><a name="habracut"></a><br><h4>  Motivation </h4><br>  Automata programming is a very convenient and flexible tool that allows you to solve the problem in terms close to the concepts of the subject area.  For example, the problem of programming elevator behavior in a multi-storey building turns into a very formalized model of an automaton with the following states: ‚ÄúElevator goes up‚Äù, ‚ÄúElevator goes down‚Äù, ‚ÄúElevator stands on floor N‚Äù and events coming from the residents: ‚ÄúDown button pressed on the Nth floor ‚Äùand‚Äú Up button is pressed on the Nth floor ‚Äù. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      However, along with the obvious advantages of this approach, there is one small drawback - the coding of such a system is a very unpleasant process, accompanied by the use of a large number of branches and transitions. <br><br>  OOP and Visitor and State patterns exist to solve this problem. <br><br><h4>  Example </h4><br>  Consider the following problem.  Suppose you want to design and implement a primitive car radio that supports two modes of operation - ‚Äúradio‚Äù and ‚ÄúCD player‚Äù.  Switching between modes is performed using the toggle switch on the control panel (see the figure at the beginning of the article).  In addition, the radio tape recorder supports the switching mechanism of radio stations or tracks (the ‚ÄúNext‚Äù button), depending on the set mode. <br><br>  An excellent example of how this problem is solved on the basis of embedded branches (switch) of the C language can be viewed in <a href="http://en.wikipedia.org/wiki/Event-driven_finite-state_machine">Wikipedia</a> .  Consider his most significant section. <br><br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>( state ) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> RADIO: <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">event</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> mode: <span class="hljs-comment"><span class="hljs-comment">/* Change the state */</span></span> state = CD; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> next: <span class="hljs-comment"><span class="hljs-comment">/* Increase the station number */</span></span> stationNumber++; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CD: <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">event</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> mode: <span class="hljs-comment"><span class="hljs-comment">/* Change the state */</span></span> state = RADIO; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> next: <span class="hljs-comment"><span class="hljs-comment">/* Go to the next track */</span></span> trackNumber++; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; }</code> </pre> <br><br>  The code from the example is absolutely not readable and hard to expand.  For example, adding a new state or event is a very laborious operation that requires modification of a large amount of code.  In addition, such a <a href="http://en.wikipedia.org/wiki/Spaghetti_code">spaghetti code</a> provokes the developer to duplicate some sections (a situation is possible in which the same event should be treated the same in different states). <br><br>  The Visitor template and its special case <a href="http://en.wikipedia.org/wiki/Double_dispatch">Double Dispatch is</a> designed to solve this problem by separating the concepts of state and handler.  In this case, the final implementation of the event processing algorithm is selected in the process of execution, based on two factors: the type of event and the type of handler (hence the name ‚ÄúDouble Dispatching‚Äù). <br><br>  Thus, to add a new type of event or handler to the system, you just need to implement the required class, the successor of the classes ‚ÄúEvent‚Äù or ‚ÄúHandler‚Äù, respectively. <br><br><h4>  Class diagram </h4><br>  The main entities of the system: <br><ul><li>  Gramophone - radio, which can turn on - enable (), turn off - disable () and receive events - dispatch (event); </li><li>  GramophoneEvent - the interface of possible events with one single method - apply (handler) to ‚Äúapply‚Äù the handler to the event; </li><li>  GramophoneHandler - a handler interface that contains polymorphic methods (handle) for processing all events in the system; </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/af6/709/ba0/af6709ba085359cd942ce06faf261ffa.png"><br><br>  The GramophoneHandler interface, which is at the same time part of the Visitor design (as the visitor itself) and the self-contained State construction (as a state for the Gramophone), is of the most interest in the considered diagram.  Those.  we can assume that in the considered example a kind of composition of two templates is used. <br><br><h4>  Implementation </h4><br>  One of the options for using the system will be as follows: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String args[])</span></span></span><span class="hljs-function"> </span></span>{ Gramophone gramophone = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Gramophone(); <span class="hljs-comment"><span class="hljs-comment">// it's CD by default gramophone.enable(); // start event loop gramophone.dispatch(new ToogleEvent()); // toogle to radio gramophone.dispatch(new NextEvent()); // next station gramophone.dispatch(new ToogleEvent()); // toogle to CD player gramophone.dispatch(new NextEvent()); // next CD track gramophone.disable(); // stop event loop }</span></span></code> </pre><br><br>  We describe the possible variants of external events coming to the system. <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Events */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GramophoneEvent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GramophoneHandler handler)</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ToogleEvent</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GramophoneEvent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GramophoneHandler handler)</span></span></span><span class="hljs-function"> </span></span>{ handler.handle(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NextEvent</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GramophoneEvent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GramophoneHandler handler)</span></span></span><span class="hljs-function"> </span></span>{ handler.handle(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } }</code> </pre><br><br>  In the above code, the apply () method has the same implementation in all descendants.  This is the main idea of ‚Äã‚Äãthe template - polymorphic definition of the type of event in the process of code execution.  Those.  the handler will call the handle () method depending on the type of the event itself (such as the this link). <br><br>  In languages ‚Äã‚Äãthat do not support polymorphism (for example, in JavaScript), you can encapsulate information about the type of event being processed in the method name.  Then in our case the methods will look like handleNext (event) and handleToogle (event) and the calling code is: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> NextEvent = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.apply = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">handler</span></span></span><span class="hljs-function">) </span></span>{ handler.handleNext(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } }</code> </pre><br><br>  The implementation of the possible states of the system is the following code.  In our case, the state = handler. <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Visitor */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GramophoneHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ToogleEvent event)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(NextEvent event)</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RadioHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GramophoneHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Gramophone gramophone; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RadioHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Gramophone gramophone)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.gramophone = gramophone; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ToogleEvent event)</span></span></span><span class="hljs-function"> </span></span>{ gramophone.toogle(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CDHandler(gramophone)); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(NextEvent event)</span></span></span><span class="hljs-function"> </span></span>{ gramophone.nextStation(); } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CDHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GramophoneHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Gramophone gramophone; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CDHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Gramophone gramophone)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.gramophone = gramophone; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ToogleEvent event)</span></span></span><span class="hljs-function"> </span></span>{ gramophone.toogle(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RadioHandler(gramophone)); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(NextEvent event)</span></span></span><span class="hljs-function"> </span></span>{ gramophone.nextTrack(); } }</code> </pre><br><br>  Finally, we consider the implementation of the main class of the system - radio (Gramophone). <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * FSM (Finit-State-Machine) implementation */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Gramophone</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Runnable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> GramophoneHandler handler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CDHandler(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Queue&lt;GramophoneEvent&gt; pool = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LinkedList&lt;GramophoneEvent&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Thread self = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> track = <span class="hljs-number"><span class="hljs-number">0</span></span>, station = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> started = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">enable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ started = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; self.start(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ started = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; self.interrupt(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { self.join(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InterruptedException ignored) { } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dispatch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GramophoneEvent event)</span></span></span><span class="hljs-function"> </span></span>{ pool.offer(event); notify(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;!pool.isEmpty() || started;) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;!pool.isEmpty();) { GramophoneEvent event = pool.poll(); event.apply(handler); } <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { wait(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InterruptedException ignored) { } } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toogle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GramophoneHandler handler)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handler = handler; System.out.println(<span class="hljs-string"><span class="hljs-string">"State changed: "</span></span> + handler.getClass().getSimpleName()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextTrack</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ track++; System.out.println(<span class="hljs-string"><span class="hljs-string">"Track changed: "</span></span> + track); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextStation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ station++; System.out.println(<span class="hljs-string"><span class="hljs-string">"Station changed: "</span></span> + station); } }</code> </pre><br><br>  In the considered implementation, the toogle (), nextTrack () and nextStation () methods have scope only inside the package.  This is done in order to protect the system from direct external calls.  Moreover, in real conditions it is recommended to additionally check the nature of the calling thread.  For example, you can add the following verification code to each of the methods. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextTrack</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Thread.currentThread() != self) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(‚ÄúIllegal thread‚Äù); } track++; System.out.println(<span class="hljs-string"><span class="hljs-string">"Track changed: "</span></span> + track); }</code> </pre><br><br>  In addition, attention should be paid to the run () method, which implements the <a href="http://en.wikipedia.org/wiki/Event_loop">Event Loop</a> idiom.  In this case, the method contains two nested loops that ensure that the stream goes to sleep in the absence of events in the queue.  At the same time, adding each new event to the queue (see the dispatch () method) awakens it. <br><br><h4>  Conclusion </h4><br>  The article is not a promotion of the use of OOP and design patterns, but only reveals the features of the use of these tools to solve a specific problem. <br><br>  The code for this example is available on <a href="">GitHub</a> .  There you can also find <a href="https://github.com/vkostyukov/patterns-pack">examples of other patterns</a> , about which <a href="http://habrahabr.ru/blogs/personal/84706/">several articles</a> have already been written <a href="http://habrahabr.ru/blogs/personal/84706/">on Habrahabr</a> . </div><p>Source: <a href="https://habr.com/ru/post/133855/">https://habr.com/ru/post/133855/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../133847/index.html">Providers and court decisions</a></li>
<li><a href="../133848/index.html">New version of VDI-in-a-Box</a></li>
<li><a href="../133849/index.html">PHPShop online store can now be synchronized with R-Keeper StoreHouse</a></li>
<li><a href="../133850/index.html">Getting Realization Experience. Part 2 of 2</a></li>
<li><a href="../133851/index.html">Silicon Valley Islet</a></li>
<li><a href="../133856/index.html">Continuation of the story about the "Heart" of an electronic device or the simplest programming Silicon Labs C8051F320</a></li>
<li><a href="../133857/index.html">Imagine Cup Meeting in Novosibirsk</a></li>
<li><a href="../133858/index.html">Monetizing Android applications using AdMob ads with the option of paid disconnection. Part one</a></li>
<li><a href="../133859/index.html">UK intelligence agencies GCHQ launched a hacking code contest to attract new talent</a></li>
<li><a href="../133860/index.html">bash script with support for long (gnu-style) options</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>