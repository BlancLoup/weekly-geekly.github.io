<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Google, where are you going my place in GMail? Do you know exactly how labels work in GMail?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I began to notice that out of the 15 gigabytes of free space provided by Google, my mail already takes up almost 12 gigabytes. And this trend does not...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Google, where are you going my place in GMail? Do you know exactly how labels work in GMail?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/2c3/c9a/c28/2c3c9ac28f1641879c76e924be443e61.png"><br>  I began to notice that out of the 15 gigabytes of free space provided by Google, my mail already takes up almost 12 gigabytes.  And this trend does not please me. <br>  On the other hand, I use Thunderbird with full synchronization as an email client.  Those.  All letters must be downloaded.  So the Thunderbird folder with all the letters and indexes takes only 3 gigabytes.  Although according to the logic of things, the size should not just more or less coincide with the occupied place on GMail, but be bigger, since  Thunderbird does not archive letters, but stores as it is and also builds indexes to speed up the search. <br>  Problem on face!  We start to get to the bottom of the essence. <br><a name="habracut"></a><br>  I started the fact that I entered the label (yes, in the case of GMail, it‚Äôs correct to say just the label, not the folder, the details are <a href="https://support.google.com/mail/answer/118708%3Fhl%3Dru">here</a> ) ‚ÄúAll Mail‚Äù and saw that I have a little more than 500 thousand messages.  The situation was complicated by the fact that I have about 100 labels!  And the shortcuts in GMail are typical folders in Thunderbird.  How quickly I could not find the total number of letters in Thunderbird.  But looking ahead, I will say that I have about 200 thousand of them in it.  From here it becomes clear why there is less space on the disk. <br>  But still the same question remains: what are these 300 thousand messages in GMail, which are not visible in Thunderbird, but occupy a place on GMail? <br><br>  Inquisitiveness of the mind + the desire not to sleep at night + the desire to touch Go on a real task led me to the decision that you need to take the Go compiler, study the <a href="https://developers.google.com/gmail/api/">GMail API</a> and see what is under the hood of GMail. <br><div class="spoiler">  <b class="spoiler_title">Very briefly about the impressions of Go</b> <div class="spoiler_text">  Only the laziest did not write about error handling in Go.  Only on them I drew attention more intently. <br>  For the rest: <br><ul><li>  I started writing the next evening </li><li>  Another language </li><li>  Life will force - I will write on Go </li><li>  For me, C / C ++, Python, Java (and PHP too) are also languages ‚Äã‚Äãfor my niches </li><li>  I guess I'm just omnivorous. </li></ul><br>  And the article is not about Go. <br></div></div><br>  As I noted above, I have about hundreds of labels.  Letters usually have one label.  And I wanted to find out how many letters I have labeled with each label and how many they occupy in total space. <br>  I did not find a way to find out the sizes of labels in the GMail web-interface (the volume of letters marked with one or another label). <br>  I rolled up my sleeves, installed the Go compiler, picked up the MongoDB container in the Docker (Yes, I am such a pervert! But this is my pet project and what I want, I use it, especially for educational purposes) and began to <s>make shit</s> . <br>  Further I will refer to this this my <a href="https://github.com/Labutin/GMailMessagesSize">project</a> . <br>  I take all my tags from GMail and add them to the <a href="https://developers.google.com/gmail/api/v1/reference/users/labels/list">Users.labels</a> database <a href="https://developers.google.com/gmail/api/v1/reference/users/labels/list">: list</a> : <br><pre><code class="bash hljs">GMailMessagesSize -importLabels -mongoConnectionString 10.211.55.5 Imported labels: 112</code> </pre> <br>  I am taking the ID of all messages that are in the <a href="https://developers.google.com/gmail/api/v1/reference/users/messages/list">Users.messages: list</a> box: <br><pre> <code class="bash hljs">GMailMessagesSize -mongoConnectionString 10.211.55.5 -importMessages Processed 100 messages Processed 200 messages Processed 300 messages ....... Processed 523100 messages Processed 523115 messages</code> </pre><br>  Of course, it does not get quickly, but I could not find a parallelization here (the API does not allow). <br>  So far we only have a list of message IDs, but we need to know about each message its labels and size.  For this there is a method <a href="https://developers.google.com/gmail/api/v1/reference/users/messages/get">Users.messages: get</a> .  But it does not work quickly, even despite the fact that in the request I indicate exactly which fields interest me (internalDate, labelIds, sizeEstimate). <br>  I did not find the implementation of <a href="https://developers.google.com/gmail/api/guides/batch">Batching Requests</a> . <br>  But I write on Go and a sin not to use gorutiny!  No sooner said than done.  We pull the information in the number of threads (as we want, but I put a limit of 50).  If the Internet is fast and the computer is not stupid, then we begin to quickly rest against the <a href="https://developers.google.com/gmail/api/v1/reference/quota">limit of the rate of</a> requests from Google.  The script can be stopped and continued, or you can just persistently wait, because  when the limit is triggered, the gorutines sleep for 5 seconds and then continue to torment Google.  Yes, it would be possible to increase the sleep time each time, for example, twice and not forget about the restriction from above.  But in this case, a mere 5 seconds is quite a solution. <br>  I have processed my 500 thousand letters in total, it seems, in about 3 hours.  In general, the time sane. <br><pre> <code class="bash hljs">GMailMessagesSize -mongoConnectionString 10.211.55.5 -processMessages -procNum 20 ............................Procecced 100 messages ............................Procecced 200 messages ............................Procecced 300 messages .... ............................Processed 523100 messages ............................Processed 523115 messages</code> </pre><br>  There are not only points popping up.  If you rest against the limit, then instead of the S point (sleep) or maybe the message has already been deleted, then NF (NotFound). <br>  As a result of all the suffering listed above, MongoDB has a collection of labels and a collection of messages: <br><pre> <code class="bash hljs">{ <span class="hljs-string"><span class="hljs-string">"SizeEstimate"</span></span> : NumberLong(63422), <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"5677188d2afd90a80e5e06f2"</span></span>), <span class="hljs-string"><span class="hljs-string">"id"</span></span> : <span class="hljs-string"><span class="hljs-string">"136b83b1ff739dec"</span></span>, <span class="hljs-string"><span class="hljs-string">"internaldate"</span></span> : ISODate(<span class="hljs-string"><span class="hljs-string">"2012-04-15T22:47:51.000+0000"</span></span>), <span class="hljs-string"><span class="hljs-string">"labelids"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"CATEGORY_PROMOTIONS"</span></span> ], <span class="hljs-string"><span class="hljs-string">"processed"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span> }</code> </pre><br>  Now you have all the data at hand to start analyzing them. <br>  At first I decided to export the information on labels, the number of messages and their total size to CSV. <br><pre> <code class="bash hljs">GMailMessagesSize -mongoConnectionString 10.211.55.5 -showSizes LabelId;Label name;Messages size;Messages count Label_11;Archives;21279;4 Label_12;Archives/2012;18684;3 CATEGORY_FORUMS;CATEGORY_FORUMS;519396295;30038 CATEGORY_PERSONAL;CATEGORY_PERSONAL;5040188875;268116 CATEGORY_PROMOTIONS;CATEGORY_PROMOTIONS;2990655727;36508 CATEGORY_SOCIAL;CATEGORY_SOCIAL;205976374;6553 CATEGORY_UPDATES;CATEGORY_UPDATES;2769764066;180729 CHAT;CHAT;0;0 DRAFT;DRAFT;82817;6 IMPORTANT;IMPORTANT;6600492209;159268 INBOX;INBOX;40306538;334 UNREAD;UNREAD;479586429;11678 ..... Label_97;INBOX/Coursera;6021524;151 Label_77;INBOX/;1077571;28 Label_63;INBOX/!!!;6195999;12 Label_67;INBOX/  ;1693366;11</code> </pre><br>  This is a CSV, which was convenient for me to open in Excel and study (sort and filter). <br><img src="https://habrastorage.org/files/736/ea7/c60/736ea7c6047e4fe5bd9ce0d3b0bf3aec.png"><br>  And at this stage I seriously thought.  What are 6 gigs of some important (with the label IMPORTANT) messages?  What is 11678 unread messages (with UNREAD label)?  I (as I thought) all the messages read!  Even if you enter label: unread in the GMail search bar, it displays only 106 unread messages!  What's happening? <br><br>  Googling this situation led to forums where others wondered why messages deleted in Thunderbird are not deleted in GMail?  Well, there are many different cases.  I will tell you about the sad thing, in my opinion. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At this point, those who use GMail exclusively in the browser may regret having started reading this article.  BUT!!!  You may be reading mail, including from mobile.  And maybe you have a non-GMail client there.  In that case, maybe you have the same problem as me! <br><br>  I will not continue to torment and tell you what's going on. <br>  Watch your hands.  The sequence of events is as follows: <br><ol><li>  A letter arrives at GMail </li><li>  The letter is assigned the labels INBOX, UNREAD and ( <b>it‚Äôs important here</b> ) maybe some additional label, for example CATEGORY_PROMOTIONS </li><li>  In the mail client, you opened the letter.  The label UNREAD has appeared. </li><li>  In the mail client you deleted the letter </li><li>  Drum roll: label INBOX starred.  And ... everything, nothing more </li><li>  Message has CATEGORY_PROMOTIONS label. </li></ol><br>  Messages labeled CATEGORY_PROMOTIONS are displayed if you type in the search: category: promotions Often do you do this? <br>  If it is quite short, then the letters simply are not deleted!  I delete them, and they remain on GMail. <br>  Now is the time to recall the <a href="https://support.google.com/mail/answer/6576%3Fhl%3Dru">archiving of letters</a> .  And it seems that this is the case! <br>  When deletion is configured in Thunderbird via ‚ÄúMark for deletion‚Äù, then ‚ÄúCompression‚Äù: <br><img src="https://habrastorage.org/files/862/317/296/862317296cf545caa869d146882a6e61.png"><br>  And what should a daw be put in the basket: <br><img src="https://habrastorage.org/files/7d2/bd9/2e5/7d2bd92e5dbc402e90bf23bdaaa513d1.png"><br>  What happens is <b>EVERYTHING archiving</b> ! <br>  Total: letters go to the archive.  From the point of view of GMail, the archive is letters that have no visible labels and have not visited the basket. <br>  On the one hand, nothing terrible.  But letters can always be found through a search. <br>  And what if I do not want it?  What should I do now? <br>  How to find and delete all messages from the archive?  Here is <a href="http://webapps.stackexchange.com/questions/15911/how-to-show-all-archived-messages-in-gmail">a</a> good answer.  But I did not dare to delete everything at once. <br>  By the way, in the search bar I did not find a way to show messages that have only one specific label.  Those.  for example, I decided to delete all messages that have the CATEGORY_PROMOTIONS shortcut and no other.  I definitely do not need these promotional letters in the archive.  By the way, how many are there? <br><pre> <code class="bash hljs">GMailMessagesSize -mongoConnectionString 10.211.55.5 -showSizes -l CATEGORY_PROMOTIONS -onlyThisLabel LabelId;Label name;Messages size;Messages count CATEGORY_PROMOTIONS;CATEGORY_PROMOTIONS;1197364170;14618</code> </pre><br>  I have them there for gigabytes accumulated. <br>  -onlyThisLabel is an important option that just allows you to find only those messages that have this single label. <br><pre> <code class="bash hljs">GMailMessagesSize -mongoConnectionString 10.211.55.5 -showSizes -l CATEGORY_PROMOTIONS -l IMPORTANT -onlyThisLabel LabelId;Label name;Messages size;Messages count CATEGORY_PROMOTIONS;CATEGORY_PROMOTIONS;1197364170;14618</code> </pre><br>  Yes, I have another half a gigabyte of "important advertising" messages :) Please note that this is in addition to just a gigabyte of unimportant advertising. <br>  Hands immediately itched to remove it all! <br><pre> <code class="bash hljs">GMailMessagesSize -mongoConnectionString 10.211.55.5 -deleteMessages -l CATEGORY_PROMOTIONS -l IMPORTANT -onlyThisLabel -procNum 10</code> </pre><br>  In fact, letters are not deleted, but are placed in the basket.  There, after 30 days, they will either be removed completely, or you can go and manually clean it yourself. <br><br>  <b>TOTAL:</b> If you delete messages not through the GMail web interface, but through a third-party client (possibly mobile), then there is a possibility that your messages are not deleted, but archived.  For some, it is even good.  And for someone, this leads to the fact that the box just swells indecently. <br>  And it's not even 2 bucks a month.  You can eat 100 gigs and more.  I just wanted to understand the essence of the issue. <br><br>  ATTENTION!!!  The project was written for himself.  This is my first Go program.  For the safety of your letters, I do not answer!  But if you do not use the -deleteMessages option, then nothing will happen to your mailbox. <br><div class="spoiler">  <b class="spoiler_title">What can I do to make the application work?</b> <div class="spoiler_text"><ul><li>  <a href="https://console.developers.google.com/start/api%3Fid%3Dgmail">Click here</a> for the Google Developers Console and automatically turn on the API.  Click Continue, then Go to credentials. </li><li>  At the top of the page, select the OAuth consent screen tab.  Select an Email address, enter a Save Name button. </li><li>  Select the Credentials tab, click the Add credentials button and select the OAuth 2.0 client ID. </li><li>  Select the application type Other, enter the name "Gmail API Quickstart", and click the Create button. </li><li>  Click OK to dismiss the resulting dialog. </li><li>  Click the (Download JSON) button. </li><li>  Move this file to your client directory and rename it client_secret.json. </li></ul><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/273701/">https://habr.com/ru/post/273701/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../273689/index.html">Forecast 2016: Android attacks and large-scale infections are among the main security threats.</a></li>
<li><a href="../273693/index.html">Develop a cloud conferencing service for small businesses</a></li>
<li><a href="../273695/index.html">How to save a million dollars with Tarantool</a></li>
<li><a href="../273697/index.html">Microsoft improves SmartScreen</a></li>
<li><a href="../273699/index.html">Overview of Amperka Education Kit - TETRA</a></li>
<li><a href="../273703/index.html">Google stops supporting SHA-1 certificates after Mozilla and Microsoft</a></li>
<li><a href="../273705/index.html">Opinions: Swift became Open Source</a></li>
<li><a href="../273707/index.html">How to design a workplace that employees enjoy and why? BYOD means love</a></li>
<li><a href="../273711/index.html">Interview at UX Designer</a></li>
<li><a href="../273713/index.html">Internet Magnets 3 - P2P Website and Forum</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>