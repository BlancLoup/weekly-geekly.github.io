<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Django models and data concurrency problem solving</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 About Django models there are already a lot of articles on Habr√©, but I want to share with the public how to use them effectively and not st...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Django models and data concurrency problem solving</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  About Django models there are already a lot of articles on Habr√©, but I want to share with the public how to use them effectively and not step on the rake. <br><br><h4>  Starting data </h4><br><ul><li>  2 Django servers running under uWSGI </li><li>  1-2k requests per second </li><li>  The project with the movement of money inside </li></ul><br><a name="habracut"></a><br><h4>  What's next? </h4><br>  Suppose we implement a method of updating the balance for the user.  And this method looks like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Profile</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> ‚Ä¶. <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update_balance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, balance)</span></span></span><span class="hljs-function">:</span></span> self.balance += balance self.save()</code> </pre> <br><br>  In this case, if two simultaneous requests to update the balance come to us, then the balance will update only the second request, because the last request supplanted the first one and took the old data. <br><br>  At this stage, the <a href="https://docs.djangoproject.com/en/1.7/ref/models/queries/">F</a> method comes to help us in conjunction with .update () <br>  F () returns us the value from the database up to date.  and the previous section can be written as <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Profile</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> ‚Ä¶. <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update_balance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, balance)</span></span></span><span class="hljs-function">:</span></span> Profile.objects.\ filter(pk=self.pk)\ .update(balance=F(<span class="hljs-string"><span class="hljs-string">'balance'</span></span>) + balance)</code> </pre><br>  In this case, we always get the actual value of the field and some will say that this method solves the problem for us, but it is not.  In this case, although everything is implemented correctly, we believe, but this does not solve the problem. <br><br>  In this case comes to the aid of transactions at the database level. <br><br><h4>  What is this transaction and how to use it? </h4><br>  To begin with, in Django 1.4.x and 1.5.x, you can enable Transaction Middleware.  In Django 1.6+, it was replaced with the ATOMIC_REQUESTS constant, which can be included with each database used in the project. <br><br>  They work as follows.  When the request came to us and before sending this request for processing in view, Django opens a transaction.  If the request was processed without exceptions, then commit to the database or rollback is done, if an exception is thrown. <br><br>  The difference between ATOMIC_REQUESTS and Middleware is that Middleware is enabled for the entire project, and ATOMIC_REQUESTS can be used for one or several databases. <br><br>  The downside to using this approach is that it creates an overhead on the database. <br>  In this case, manual transaction management comes to the rescue. <br><br><h4>  Manual transaction management </h4><br>  Django provides many options for working with the django.db.transaction module. <br><br>  Consider one of the possible methods of manual control - this is transaction.atomic <br><br>  transaction.atomic is both a method and a decorator and is used only for view methods. <br><br>  You can secure the purchase of goods by wrapping the view in the decorator.  for example <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">... </span></span><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.db <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> transaction ... @transaction.atomic <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buy_something</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span> .... request.user.update_balance(money) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> render(request, template, data)</code> </pre><br><br>  In this case, we included the transaction atomicity for the purchase of goods.  All responsibility for data integrity was shifted to the database and atomicity solves our problem. <br><br>  Even in conjunction with atomic transactions, you can use the select_for_update method. <br>  In this case, the row being modified will be blocked for the change until update is called. <br>  Our balance update method can now be written like this: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Profile</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> ‚Ä¶. <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update_balance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, balance)</span></span></span><span class="hljs-function">:</span></span> Profile.objects.select_for_update().\ filter(pk=self.pk)\ .update(balance=F(<span class="hljs-string"><span class="hljs-string">'balance'</span></span>) + balance)</code> </pre><br><br><h4>  Findings: <br></h4><br><ul><li>  Atomicity comes to the rescue </li><li>  Make atomic only critical sections of code </li><li>  Use select for update to lock data during change. </li><li>  If possible, try to make transactions as short as possible so as not to block work with data in the database. </li></ul><br><br>  Extras: MySQL was told about transaction levels in <a href="http://habrahabr.ru/post/135217/">MySQL: transaction isolation levels</a> . </div><p>Source: <a href="https://habr.com/ru/post/252563/">https://habr.com/ru/post/252563/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252551/index.html">Tell me, uncle, it's not for nothing ... "Chips" CRM</a></li>
<li><a href="../252553/index.html">Weekly assembly Vivaldi 1.0.123.10</a></li>
<li><a href="../252555/index.html">Arduino & OpenHAB</a></li>
<li><a href="../252559/index.html">Weekly io.js, March 6, 2015</a></li>
<li><a href="../252561/index.html">Desktop Encryption Comparison</a></li>
<li><a href="../252565/index.html">Let's Lab. IS-IS routing protocol. Part 2</a></li>
<li><a href="../252567/index.html">OpenSMTPD + UW IMAP as an alternative to heavy mail systems</a></li>
<li><a href="../252569/index.html">Reverse engineering as a method of teaching electronics</a></li>
<li><a href="../252571/index.html">Machine learning - 2. Nonlinear regression and numerical optimization</a></li>
<li><a href="../252573/index.html">Conference. NEXT returns to Peter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>