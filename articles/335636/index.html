<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Warehouse management system using CQRS and Event Sourcing. Service layer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article will look at the Service Layer in Magento 2 and the services (API interfaces) for managing entities, which were described in a previous a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Warehouse management system using CQRS and Event Sourcing. Service layer</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/57b/bf8/8c1/57bbf88c130b4adabb238202c30d6b06.png"><br><br>  This article will look at the <a href="https://martinfowler.com/eaaCatalog/serviceLayer.html">Service Layer</a> in Magento 2 and the services (API interfaces) for managing entities, which were described in a <a href="https://habrahabr.ru/post/333678/">previous article</a> devoted to the design and allocation of domain entities for the warehouse management system (Inventory). <br><a name="habracut"></a><br><h2>  Service layer </h2><br>  Since the warehouse management system we write on the Magento 2 platform, respectively, the services we enter will be described taking into account the features of this platform. <br>  In Magento 2, to implement the principle of weak connectivity at the module level (within the Bounded Context), a Service Layer was introduced, which defines the set of available operations for each module in terms of interaction between customers and other modules of the system. <br><br>  <a href="http://devdocs.magento.com/guides/v2.1/extension-dev-guide/service-contracts/service-contracts.html">Service Layer (or Service Contracts) in Magento</a> is a set of PHP interfaces that are defined for a module and are located in the Api folder of this module.  Service contracts consist of Data Interfaces - DTO interfaces representing data from domain domain entities;  and Service Interfaces - interfaces that provide access to business logic that can be called by the client (controller, web service REST / SOAP, PHP code of other modules). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since it is assumed that all external clients of the module will work with it under the contracts described by the Service Layer, the Service Layer can actually be represented as <a href="https://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B0%25D1%2581%25D0%25B0%25D0%25B4_(%25D1%2588%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F)">Facade</a> , which conceals the implementation details and complexity of the business logic behind it. <br>  For clients, dependencies on well-defined APIs make it easier to upgrade to the next versions of the system, since the modules obey semantic versioning (Semantic Versioning). <br><br>  For better modularity and decoupling, service contracts from implementation sometimes service contracts are separated into a separate module.  For example, in the case of Inventory, we have two modules: one declares a set of <a href="https://github.com/magento-engcom/magento2/tree/develop/app/code/Magento/InventoryApi">InventoryAPI</a> service interfaces, and the second provides an implementation for these interfaces - <a href="https://github.com/magento-engcom/magento2/tree/develop/app/code/Magento/Inventory">Inventory</a> .  Thus, a third-party developer who wants to replace the base implementation is no longer tied to this implementation in code.  All it needs is interfaces, since other modules in the system depend on interfaces. <br><img src="https://habrastorage.org/web/9e8/68d/81a/9e868d81a6aa4fbbae94e3dd4706f743.jpg"><br><h2>  Repository Interfaces - Repository </h2><br>  Repositories are interfaces that provide a set of CRUD operations for entities. <br>  A typical repository interface consists of a set of the following methods: <br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\Magento\Module\Api\Data\DataInterface $entityData)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($entityId)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\Magento\Module\Api\Data\DataInterface $entityData)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($entityId)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SearchCriteriaInterface $searchCriteria)</span></span></span></span>;</code> </pre> <br>  The set of methods may be narrower (if the domain entity is not characterized by certain operations. For example, deletion), but not broader, since it is not recommended to add methods with semantics different from the predefined set.  Such methods are recommended to be placed in separate services. <br><br>  Repositories can be perceived as Facades, which combine sets of methods for managing entities. <br><br>  In the context of the Inventory module, repositories for the entities <a href="https://github.com/magento-engcom/magento2/blob/develop/app/code/Magento/InventoryApi/Api/Data/SourceInterface.php">Source</a> (the entity responsible for representing any physical warehouse where the goods may be located) and <a href="https://github.com/magento-engcom/magento2/blob/develop/app/code/Magento/InventoryApi/Api/Data/SourceItemInterface.php">SourceItem</a> (entity-bundle, represents the quantity of a specific SKU on a specific physical storage) appear. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * This is Facade for basic operations with Source * There is no delete method, as Source can't be deleted from the system because we want to keep Order information for all orders placed. Sources can be disabled instead. * * Used fully qualified namespaces in annotations for proper work of WebApi request parser * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@api</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SourceRepositoryInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Save Source data * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> \Magento\InventoryApi\Api\Data\SourceInterface $source * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> int * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> \Magento\Framework\Exception\CouldNotSaveException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SourceInterface $source)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Get Source data by given sourceId. If you want to create plugin on get method, also you need to create separate * plugin on getList method, because entity loading way is different for these methods * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $sourceId * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> \Magento\InventoryApi\Api\Data\SourceInterface * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> \Magento\Framework\Exception\NoSuchEntityException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($sourceId)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Load Source data collection by given search criteria * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> \Magento\Framework\Api\SearchCriteriaInterface $searchCriteria * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> \Magento\InventoryApi\Api\Data\SourceSearchResultsInterface */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SearchCriteriaInterface $searchCriteria = null)</span></span></span></span>; }</code> </pre><br>  In the case of the SourceRepository, we do not have a delete method, because such a business operation on Source entities does not exist, since it is necessary to always save all the information related to placed orders (including where the goods were delivered from).  Accordingly, it is necessary to prevent the possible loss of such data in the future (removing the Source from which delivery was performed).  Instead, the operation is used - mark Source as inactive (disabled). <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * This is Facade for basic operations with SourceItem * * The method save is absent, due to different semantic (save multiple) * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@see</span></span></span><span class="hljs-comment"> SourceItemSaveInterface * * There is no get method because SourceItem identifies by compound identifier (sku and source_id), * thus, it's needed to use getList() method * * Used fully qualified namespaces in annotations for proper work of WebApi request parser * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@api</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SourceItemRepositoryInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Load Source Item data collection by given search criteria * * We need to have this method for direct work with Source Items, as Source Item contains * additional data like qty, status (can be searchable by additional field) * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> \Magento\Framework\Api\SearchCriteriaInterface $searchCriteria * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> \Magento\InventoryApi\Api\Data\SourceItemSearchResultsInterface */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SearchCriteriaInterface $searchCriteria)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Delete Source Item data * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> SourceItemInterface $sourceItem * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> \Magento\Framework\Exception\NoSuchEntityException * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> \Magento\Framework\Exception\CouldNotDeleteException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SourceItemInterface $sourceItem)</span></span></span></span>; }</code> </pre> <br>  Since the main usage scenarios for the save operation occur with the SourceItems collection, and not with one entity, as the standard save contract in the repository assumes. <br>  For <i>multiple storage</i> , which can occur during import or synchronization of stock flows with external ERP or PIM systems, a separate <a href="https://github.com/magento-engcom/magento2/blob/develop/app/code/Magento/InventoryApi/Api/SourceItemSaveInterface.php">SourceItemSaveInterface</a> contract is introduced, which allows atomic saving of multiple SourceItem s in a single service call.  Such a contract allows you to process an insert operation using a single query into the database, which will significantly speed up processing.  The basic save operation that accepts a single entity is not added to the repository contract in order not to add several points for expansion, since in fact in this case the third-party developer <i>will have to pliginate both save operations (single and multiple)</i> .  Therefore, customization of one expansion point always looks preferable. <br><br>  The multiple save command contract looks like <a href="https://github.com/magento-engcom/magento2/blob/develop/app/code/Magento/InventoryApi/Api/SourceItemSaveInterface.php">Magento \ InventoryApi \ Api \ SourceItemSaveInterface</a> <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Service method for source items save multiple * Performance efficient API, used for stock synchronization * * Used fully qualified namespaces in annotations for proper work of WebApi request parser * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@api</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SourceItemSaveInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Save Multiple Source item data * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> \Magento\InventoryApi\Api\Data\SourceItemInterface[] $sourceItems * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> \Magento\Framework\Exception\InputException * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> \Magento\Framework\Exception\CouldNotSaveException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $sourceItems)</span></span></span></span>; }</code> </pre><br>  And its implementation, <a href="https://github.com/magento-engcom/magento2/blob/develop/app/code/Magento/Inventory/Model/SourceItemSave.php">SourceItemSave,</a> delegates the saving of the <a href="https://github.com/magento-engcom/magento2/blob/develop/app/code/Magento/Inventory/Model/ResourceModel/SourceItem/SaveMultiple.php">SaveMultiple</a> model <a href="https://github.com/magento-engcom/magento2/blob/develop/app/code/Magento/Inventory/Model/ResourceModel/SourceItem/SaveMultiple.php">resource</a> . <br><br>  Also, there is no get () method in the SourceItemRepository, since SourceItem is an entity-bundle and is defined by a composite identifier (SKU and SourceId). <br><br>  The repository for Stock (Virtual Aggregations of Entities) looks standard: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StockRepositoryInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Save Stock data * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> \Magento\InventoryApi\Api\Data\StockInterface $stock * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> int * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> \Magento\Framework\Exception\CouldNotSaveException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StockInterface $stock)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Get Stock data by given stockId. If you want to create plugin on get method, also you need to create separate * plugin on getList method, because entity loading way is different for these methods * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $stockId * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> \Magento\InventoryApi\Api\Data\StockInterface * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> \Magento\Framework\Exception\NoSuchEntityException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($stockId)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Find Stocks by given SearchCriteria * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> \Magento\Framework\Api\SearchCriteriaInterface|null $searchCriteria * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> \Magento\InventoryApi\Api\Data\StockSearchResultsInterface */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SearchCriteriaInterface $searchCriteria = null)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Delete the Stock data by stockId. If stock is not found do nothing * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $stockId * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> \Magento\Framework\Exception\CouldNotDeleteException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($stockId)</span></span></span></span>; }</code> </pre><br><h2>  Services for source and stock mapping </h2><br>  Guided by the rule "to reduce the amount of boilerplate code in the API client (in business logic code), we <b>do not</b> enter the Data interface SourceStockLinkInterface.  Instead, we introduce a set of domain service commands to assign the Source to the Stock. <br><br>  As a result, we get three commands: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AssignSourcesToStockInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Assign list of source ids to stock * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $stockId * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int[] $sourceIds * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> \Magento\Framework\Exception\InputException * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> \Magento\Framework\Exception\CouldNotSaveException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $sourceIds, $stockId)</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GetAssignedSourcesForStockInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Get Sources assigned to Stock * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $stockId * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> \Magento\InventoryApi\Api\Data\SourceInterface[] * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> \Magento\Framework\Exception\InputException * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> \Magento\Framework\Exception\LocalizedException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($stockId)</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UnassignSourceFromStockInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Unassign source from stock * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $sourceId * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $stockId * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> \Magento\Framework\Exception\InputException * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> \Magento\Framework\Exception\CouldNotDeleteException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($sourceId, $stockId)</span></span></span></span>; }</code> </pre><br><h2>  API vs SPI </h2><br>  Within this project, it was decided to explicitly separate the API (Application Programming Interface) from the SPI ( <a href="https://en.wikipedia.org/wiki/Service_provider_interface">Service Provider Interfaces</a> ) in order to improve the extensibility and reduce the connectivity of the components. <br><br><ul><li>  Repositories can be interpreted as an API, respectively, it is assumed that the methods of the repository interface are invoked in PHP business logic code. </li><li>  Separate command classes for which the class implementation of the repository proxies methods (such as Get, Save, GetList, Delete) can be interpreted as SPI interfaces for which a third-party developer can be offered to extend or replace the current behavior of the system. </li></ul><br>  Thus, for example, the implementation of the <a href="https://github.com/magento-engcom/magento2/blob/develop/app/code/Magento/Inventory/Model/StockRepository.php">Magento \ Inventory \ Model \ StockRepository repository</a> looks like this: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StockRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StockRepositoryInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> SaveInterface */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $commandSave; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> GetInterface */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $commandGet; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> DeleteByIdInterface */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $commandDeleteById; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> GetListInterface */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $commandGetList; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> SaveInterface $commandSave * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> GetInterface $commandGet * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> DeleteByIdInterface $commandDeleteById * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> GetListInterface $commandGetList */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( SaveInterface $commandSave, GetInterface $commandGet, DeleteByIdInterface $commandDeleteById, GetListInterface $commandGetList )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;commandSave = $commandSave; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;commandGet = $commandGet; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;commandDeleteById = $commandDeleteById; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;commandGetList = $commandGetList; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StockInterface $stock)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;commandSave-&gt;execute($stock); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($stockId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;commandGet-&gt;execute($stockId); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($stockId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;commandDeleteById-&gt;execute($stockId); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SearchCriteriaInterface $searchCriteria = null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;commandGetList-&gt;execute($searchCriteria); } }</code> </pre><br>  The constructor accepts a set of command interfaces for each of the operations provided.  And during a call to a public method from the repository, the call is proxied to the appropriate command. <br><br>  SPI command interfaces are as follows: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Save Stock data command (Service Provider Interface - SPI) * * Separate command interface to which Repository proxies initial Save call, could be considered as SPI - Interfaces * so that you should extend and implement to customize current behaviour, but NOT expected to be used (called) in the code * of business logic directly * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@see</span></span></span><span class="hljs-comment"> \Magento\InventoryApi\Api\StockRepositoryInterface * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@api</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SaveInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Save Stock data * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> StockInterface $stock * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> int * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> CouldNotSaveException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StockInterface $stock)</span></span></span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * Get Stock by stockId command (Service Provider Interface - SPI) * * Separate command interface to which Repository proxies initial Get call, could be considered as SPI - Interfaces * that you should extend and implement to customize current behavior, but NOT expected to be used (called) in the code * of business logic directly * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@see</span></span></span><span class="hljs-comment"> \Magento\InventoryApi\Api\StockRepositoryInterface * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@api</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GetInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Get Stock data by given stockId * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $stockId * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> StockInterface * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> NoSuchEntityException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($stockId)</span></span></span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * Delete Stock by stockId command (Service Provider Interface - SPI) * * Separate command interface to which Repository proxies initial Delete call, could be considered as SPI - Interfaces * that you should extend and implement to customize current behaviour, but NOT expected to be used (called) in the code * of business logic directly * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@see</span></span></span><span class="hljs-comment"> \Magento\InventoryApi\Api\StockRepositoryInterface * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@api</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DeleteByIdInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Delete the Stock data by stockId. If stock is not found do nothing * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $stockId * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> CouldNotDeleteException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($stockId)</span></span></span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * Find Stocks by SearchCriteria command (Service Provider Interface - SPI) * * Separate command interface to which Repository proxies initial GetList call, could be considered as SPI - Interfaces * that you should extend and implement to customize current behaviour, but NOT expected to be used (called) in the code * of business logic directly * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@see</span></span></span><span class="hljs-comment"> \Magento\InventoryApi\Api\StockRepositoryInterface * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@api</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GetListInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Find Stocks by given SearchCriteria * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> SearchCriteriaInterface|null $searchCriteria * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> StockSearchResultsInterface */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SearchCriteriaInterface $searchCriteria = null)</span></span></span></span>; }</code> </pre><br>  These commands represent the SPI module interfaces and are under the namespace. <br><br><pre> <code class="php hljs">Magento\Inventory\Model\Stock\Command\*</code> </pre> <br>  Command implementations are as follows ( <a href="https://github.com/magento-engcom/magento2/tree/develop/app/code/Magento/Inventory/Model/Stock/Command">Magento \ Inventory \ Model \ Stock \ Command \ *</a> ).  For example, the Stock save command: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Save</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SaveInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> StockResourceModel */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $stockResource; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> LoggerInterface */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $logger; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> StockResourceModel $stockResource * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> LoggerInterface $logger */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( StockResourceModel $stockResource, LoggerInterface $logger )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;stockResource = $stockResource; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger = $logger; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StockInterface $stock)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;stockResource-&gt;save($stock); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $stock-&gt;getStockId(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (\<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> $e) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger-&gt;error($e-&gt;getMessage()); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CouldNotSaveException(__(<span class="hljs-string"><span class="hljs-string">'Could not save Stock'</span></span>), $e); } } }</code> </pre><br><h2>  Product Backup Mechanism </h2><br>  The reservation object is created in order to have the current level of goods that we have for sale between the events of order creation and the decrease in the number of goods in specific physical warehouses. <br>  Implementing a business scenario of placing an order, described in detail in the <a href="https://habrahabr.ru/post/333678/">previous part</a> . <br><br>  We enter the Data Interface for backup <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * The entity responsible for reservations, created to keep inventory amount (product quantity) up-to-date. * It is created to have a state between order creation and inventory deduction (deduction of specific SourceItems) * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@api</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReservationInterface</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExtensibleDataInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Constants for keys of data array. Identical to the name of the getter in snake case */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> RESERVATION_ID = <span class="hljs-string"><span class="hljs-string">'reservation_id'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> STOCK_ID = <span class="hljs-string"><span class="hljs-string">'stock_id'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SKU = <span class="hljs-string"><span class="hljs-string">'sku'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QUANTITY = <span class="hljs-string"><span class="hljs-string">'quantity'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> STATUS = <span class="hljs-string"><span class="hljs-string">'status'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/**#@+ * Reservation possible statuses. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> STATUS_OPEN = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> STATUS_CLOSED = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-comment"><span class="hljs-comment">/**#@-*/</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * Get Reservation id * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> int|null */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getReservationId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Get stock id * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> int */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getStockId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Get Product SKU * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSku</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Get Product Qty * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> float */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getQuantity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Get Reservation Status * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> int */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getStatus</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre><br>  Since we perceive the reservation as an <i>Append-Only immutable entity</i> , we do not need modifiers (setter methods) in the ReservationInterface.  Accordingly, we need ReservationBuilderInterface in order to create reservation objects. <br><br><pre> <code class="php hljs">$reservationBuilder-&gt;setStockId(<span class="hljs-number"><span class="hljs-number">1</span></span>); $reservationBuilder-&gt;setSku(<span class="hljs-string"><span class="hljs-string">'sku'</span></span>); $reservationBuilder-&gt;setQty(<span class="hljs-number"><span class="hljs-number">10</span></span>); $newReservation = $reservationBuilder-&gt;build(); <span class="hljs-comment"><span class="hljs-comment">//now we could save Reservation entity $reservationAppend-&gt;execute([$newReservation]);</span></span></code> </pre><br><h2>  Object Reservation Services </h2><br>  The service of adding reservations (bookings) is used during order placement, order processing or order cancellation.  As well as creating and processing the return of goods.  At this time, a stack of reservations is created, one reservation per SKU, and added using this service for processing. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Command which appends reservations when order placed or canceled * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@api</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReservationAppend</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Append reservations when Order Placed (or Cancelled) * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Reservation[] $reservations * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> \Magento\Framework\Exception\InputException * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> \Magento\Framework\Exception\CouldNotSaveException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $reservations)</span></span></span></span>; }</code> </pre><br>  The following service is used to calculate the exact quantity (Quantity) of goods available for sale, as Quantity StockItem-a is updated with a latency caused by nature of Event Sourcing, because during placing an order, the system works with StockItem entity (virtual aggregation) and does not know from which physical warehouses (Source) will be written off.  Thus, between the operation of placing an order and processing, it may take some time. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Command which returns Reservation Quantity by Product SKU and Stock * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@api</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GetReservationQuantityForProduct</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Get Reservation Quantity for given SKU in a given Stock * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $sku * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $stockId * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> float */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($sku, $stockId)</span></span></span></span>; }</code> </pre><br>  Each reservation can be <i>open</i> or <i>closed</i> . <br>  Since the reservation is an immutable object that cannot be changed.  Instead of changing the state of the reservation, we simply create a second reserve, which ‚Äúdampens‚Äù the cancellation of the first one. <br>  For example, <br>  placing an order for 30 units of goods we create reservations: <br>  ReservationID - 1, StockId - 1, SKU - SKU-1, Qty - ( <b>-30</b> ), Status - OPEN <br>  Having processed this order - we create another reservation. <br>  ReservationID - 2, StockId - 1, SKU - SKU-1, Qty - ( <b>+30</b> ), Status - CLOSED <br><br>  In total, these two reserves (-30) + (+30) = 0 will not affect the Quantity, which is stored in StockItem. <br>  Here it is important to note two things: we do not introduce a connection (binding) between the reservation object and the Order (Order), since the reserve can be attached to other business operations.  And from the point of view of the warehouse (Inventory), the order number is not important to us, within which we need to ship the goods and reduce the stock. <br>  Using negative and positive values ‚Äã‚Äãfor reservations will help us to simplify the calculation of the total number we need to subtract from the Quantity stored in StockItem. <br><br>  For example, using this query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(r.qty) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> total_reservation_qty <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Reservations <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> stockId = {%<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>%} <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> sku = {%sku%}</code> </pre><br><h2>  Magento MSI (Multi Source Inventory) </h2><br>  This article is the third article in the ‚ÄúWarehouse Management System Using CQRS and Event Sourcing‚Äù cycle within which the collection of requirements, design and development of a warehouse management system will be considered using Magento 2 as an example. <br><br>  An open project, where development is underway, and where engineers from the community are involved, as well as where you can get acquainted with the current state of the project and documentation, is available <a href="https://github.com/magento-engcom/magento2/projects">here</a> <br><br>  More detailed documentation on <br><br><ul><li>  <a href="https://github.com/magento-engcom/magento2/wiki/Service-Contracts">MSI Service Contracts</a> (Eng.) </li><li>  <a href="https://github.com/magento-engcom/magento2/wiki/Reservations">Reservations</a> (Eng.) </li></ul></div><p>Source: <a href="https://habr.com/ru/post/335636/">https://habr.com/ru/post/335636/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335626/index.html">How we participated in the first Ligaltekh Hakatone of the CIS and why we decided to do one more in Moscow</a></li>
<li><a href="../335628/index.html">New features of Veeam Agent 2.0 for Microsoft Windows (in free and paid versions)</a></li>
<li><a href="../335630/index.html">Emercoin will reduce transaction fees by 100 times</a></li>
<li><a href="../335632/index.html">Placement of icons on the site page. Make it easier, support it easier</a></li>
<li><a href="../335634/index.html">How to find out the balance of someone else's bank card, knowing its number?</a></li>
<li><a href="../335638/index.html">The cost of real estate on heat maps</a></li>
<li><a href="../335642/index.html">Redesign Habrahabra and Hiktayms. Finish line</a></li>
<li><a href="../335644/index.html">Postgres 9.x Partitioning Using pg_pathman to optimize the insertion and pruning of partitions</a></li>
<li><a href="../335646/index.html">We are testing a new mechanism for synchronization of settings JetBrains IDEs</a></li>
<li><a href="../335648/index.html">Returning a Cisco router with a non-working CF or mini-flash card</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>