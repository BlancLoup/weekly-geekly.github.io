<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Decorator (Translation from the English chapter "Decorator" from the book "Pro Objective-C Design Patterns for iOS" by Carlo Chung)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Usually, when taking photographs, you do not think about how to decorate them later. You are taking pictures simply because you want to catch the mome...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Decorator (Translation from the English chapter "Decorator" from the book "Pro Objective-C Design Patterns for iOS" by Carlo Chung)</h1><div class="post__text post__text-html js-mediator-article">  Usually, when taking photographs, you do not think about how to decorate them later.  You are taking pictures simply because you want to catch the moment.  For example, you then printed one of the photos, then decided to put it in a frame with unusual glass.  But later you could put the same photo in a different frame, if you wanted.  Even though you changed the frame, the picture remained the same, because you just added something to it, but did not <i>change</i> it. <br><br>  In object-oriented programming, we borrowed a similar idea of ‚Äã‚Äãadding behavior to other objects without losing their original features, i.e., an extended object would be an improved version of the same class (photo in frame).  Any ‚Äúenhancement‚Äù (frame) can be applied and removed dynamically.  We call this design pattern the Decorator, since the decorator can be added to another decorator or source object to extend its properties, leaving the original behavior intact. <br><br><a name="habracut"></a>  In this chapter, we first discuss the concept of the pattern and when to use it.  Then we will discuss how to take advantage of this pattern to design a series of filtering class images for UIImage objects. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  What is a decorator pattern? </h4><br>  The Classic Decorator pattern contains the parent Abstract <code>Component</code> , which declares some common operations for other specific components.  The abstract <code>Component</code> class can be wrapped in another <code>Decorator</code> class.  <code>Decorator</code> contains a link to another <code>Component</code> .  <code>ConcreteDecorator</code> defines some extended behavior for other similar <code>Component</code> and <code>Decorator</code> and performs the operation of the <code>Component</code> object included in it.  Their relationship is illustrated in Figure 16-1. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dbf/052/b10/dbf052b10e3f695c63a8990c10adaa8f.png" alt="image"><br><br>  <b>Figure 16‚Äì1.</b>  Class diagram of the Decorator pattern <br><br>  The <code>Component</code> class defines an abstract <code>operation</code> method that its concrete classes override to have their own specific operations.  <code>Decorator</code> is a base class that defines ‚Äúdecorating‚Äù behavior to extend other instances of the <code>Component</code> (or <code>Decorator</code> ) by including it in the <code>Decorator</code> object.  His default <code>operation</code> method simply forwards the message to the included <code>component</code> .  <code>ConcreteDecoratorA</code> and <code>ConcreteDecoratorB</code> override the parent <code>operation</code> to add their own behavior to the call to the <code>operation</code> <code>component</code> method using <code>super</code> .  If you only need to extend the <code>component</code> once, then you can ignore the base <code>Decorator</code> class and allow <code>ConcreteDecorator</code> redirect any requests directly to the <code>component</code> .  This is similar to chaining with the addition of one behavior on top of another, as illustrated in the object diagram in Figure 16-2. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/874/911/f38/874911f3877acdccaa2cc1473cab33cb.png" alt="image"><br><br>  <b>Figure 16‚Äì2.</b>  Implementation of the Decorator pattern and its functionality <br><br>  Note.  <b>Pattern Decorator</b> : Adds additional features to an object dynamically.  Decorators provide a flexible alternative to inheritance to extend functionality. * <br><br>  * The original definition given in GoF‚Äôs Design Patterns (Addison Wesley, 1994). <br><br><h4>  When could you use the Decorator pattern? </h4><br>  There are three common situations in which you might consider using this pattern: <br><br><ul><li>  You want to add functionality to individual objects dynamically and transparently without affecting other objects. </li><li>  You want to extend the behavior of the class with which it would be impractical.  A class definition may be hidden and not available for inheritance from it, or extending the class behavior would require a huge number of subclasses to support each combination of possibilities. </li><li>  Extended class features may be optional. </li></ul><br><h4>  The change in the "skin" of an object in comparison with the change in "viscera </h4><br>  In the previous section, we discussed how different decorators can be connected at runtime by using an internal embedded component at each decorator node, as shown in Figure 16‚Äì2.  It is also illustrated here that each decorator changes its embedded component from the outside, that is, it simply changes the shell of the object.  The idea is that the node does not know that it is changing. <br><br>  However, when each node knows about other nodes, the chain will be built in a different direction, that is, from the inside.  Such a pattern is called Strategy (see chapter 19).  Each node needs to contain a set of different APIs to connect to another strategy node.  A visual representation of this concept is shown in Figure 16‚Äì3. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/345/38f/b77/34538fb7797f82d3eed547217ba9c2aa.png" alt="image"><br><br>  <b>Figure 16‚Äì3.</b>  Changing the "internals" of objects using the Strategy pattern <br><br>  The final differences between the ‚Äúskinning‚Äù (decorators) and ‚Äúviscera‚Äù (strategy) changes of the object are shown in Table 16-1. <br><br>  <b>Table 16-1.</b>  Summary table of differences between decorators and strategies <br><table><tbody><tr><td>  <b>Change "skins" (Decorators)</b> </td><td>  <b>Changing the "entrails" (Strategies)</b> </td></tr><tr><td>  Changes outside </td><td>  Changes from the inside </td></tr><tr><td>  Separate node not aware of changes </td><td>  The individual node knows the predefined change capabilities. </td></tr></tbody></table><br><h4>  Creating filters for UIImage images </h4><br>  Image filtering is the process by which we can change image attributes, such as colors and geometry.  We can have a filter that can change the hue of the image, or a Gaussian filter to darken it, so that it looks as if it is out of focus.  We can even apply a kind of 2D transformation to it so that it does not look flat on the surface.  There are many various filters that we can use to impose some ‚Äúspecial effects‚Äù on the image.  Many photo editors, such as Photoshop and GIMP, come with a large number of filters.  What does the image filter use first with the Decorator pattern? <br><br>  The Decorator pattern is a method of adding a new behavior to an object without changing the existing behavior and interface.  Let's say an image object contains only an interface for managing attributes and nothing more.  We want to add something unusual to it, such as a transforming filter, but we don‚Äôt want to modify the existing interfaces that the image object already has.  What we can do is define another class that is <i>the same</i> as the image object, but contains a link to another image object whose behavior needs to be expanded.  The new class contains a method for drawing itself in a graphic context.  In his drawing method, he applies the transform algorithm to the included image link, draws the entire picture, and returns the resulting image.  You can illustrate this process as the imposition of another layer of glass on top of the picture.  The image does not need to know anything about the glass, and when we look at it, we still consider it a picture.  The glass itself may have some kind of color, a wavy structure on the surface, or something else, so that the image looks different.  If we later want to apply another layer or filter to an image, then we can define another filter class, as in the case of transformation, with which we can use the same mechanism to change the image.  Other filters after transformation can pick up the resulting image and continue the process.  However, one thing is important to note - the image transmitted through the chain of filters does not have to be always the original, but it must be of the same type.  The image returned after the transformation filter is a transformed image.  Then, when it is transferred to the color filter, the returned image will be with the changed color and transformed, etc. <br><br>  <code>UIImage</code> in UIKit from the Cocoa Touch framework represents image objects.  The <code>UIImage</code> class <code>UIImage</code> has a rather limited interface for image manipulation.  There is nothing but a few properties of the image, such as size, color, etc. We will extend the usual image object with some of the features available in the Quartz 2D framework.  There are two approaches for the implementation of the pattern - subclasses and categories. <br><br><h5>  Implementing Decorators via Subclasses </h5><br>  In the case of a subclass-based approach, the structure will be similar to the original style of the pattern shown in Figure 16-1.  The only difference is that the final type of the element is the <code>UIImage</code> category, not its subclass.  There is one structural problem that <code>UIImage</code> us from sharing the same interface that a <code>UIImage</code> implements.  <code>UIImage</code> is a direct descendant of <code>NSObject</code> and no more.  This is a kind of final class.  To use some sort of ‚Äú <code>Component</code> ‚Äù interface (like the parent interface in the class diagram in Figure 16-1), in order to combine both <code>UIImage</code> and filter classes together, we need a workaround.  Now we have two problems: <br><br><ul><li>  We need to make our filter classes the same as the <code>UImage</code> , but the <code>UIImage</code> does not have a high-level interface for sharing (the inheritance from the <code>UIImage</code> is not assumed here). </li><li>  <code>UIImage</code> has several methods related to drawing content in the current context, such as <code>drawAsPatternInRect:</code> <code>drawAtPoint:</code> <code>drawAtPoint:blendMode:alpha:</code> <code>drawInRect:</code> and <code>drawInRect:blendMode:alpha:</code>  If we allow the filter classes to implement the same methods, then we will complicate everything and we may not get the result we want in accordance with the way Quartz 2D works.  We will come back to this later. </li></ul><br><br>  What are we going to do?  First of all, of course, we need an interface for separating a <code>UIImage</code> with a group of filter classes in order for this pattern to work and for both types of classes to share the same basic type.  The idea of ‚Äã‚Äãusing <code>UIImage</code> as a high-level type for this purpose (that is, inheriting from it) is bad, because then the filters will be difficult to use.  We create the <code>ImageComponent</code> interface in the form of a protocol as the optimal base type for all.  But wait a minute;  have we not mentioned that <code>UIImage</code> does not inherit from any interface, but simply directly inherits <code>NSObject</code> ?  Yes it is - this is where we need a creative solution.  We will create a <code>UIImage</code> category that implements the <code>ImageComponent</code> .  Then the compiler will know that <code>UIImage</code> and <code>ImageComponent</code> are relatives, and will not swear.  <code>UIImage</code> is not even aware that it now has a new base type.  Only those who will use filters need to know about it. <br><br>  Also, we are not going to bother with the original <code>draw*</code> methods defined in the <code>UIImage</code> , but how then will we expand the possibilities of drawing in another <code>ImageComponent</code> ?  We will come to this soon. <br><br>  The class diagram, which shows their relationships, is shown in Figure 16-4. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e5a/ddf/c7d/e5addfc7de982b19e1bfc69339de6055.png" alt="image"><br><br>  <b>Figure 16‚Äì4.</b>  A class diagram of various image filters that implement the Decorator pattern <br><br>  The <code>ImageComponent</code> protocol defines an abstract interface with all <code>draw*</code> methods from the <code>UIImage</code> class.  Any particular <code>ImageComponent</code> and similar decorators should be able to handle these calls.  The <code>draw*</code> message for a <code>UIImage</code> instance will allow it to draw its contents in the current graphics context.  Each of the methods can also create transformations and other effects in this context.  That way, we can inject our own filtering before any <code>draw*</code> operation. <br><br>  Our specific component here is a <code>UIImage</code> type, but we don‚Äôt want to create its subclass just to make it part of the game, so we define a category for it.  The <code>UIImage (ImageComponent)</code> category <code>UIImage (ImageComponent)</code> implements the <code>ImageComponent</code> protocol.  Since all the methods declared in the protocol are already in the <code>UIImage</code> class, we do not need to implement them in the category.  The category basically does nothing, but only informs the compiler that this is also a kind of <code>ImageComponent</code> . <br><br>  <code>ImageFilter</code> is like the <code>Decorator</code> class in Figure 16-1.  The <code>apply</code> method of the <code>ImageFilter</code> class allows specific filter classes to add additional behavior to the base <code>component_</code> .  Instead of overriding all <code>draw*</code> methods to implement filter actions, we use a single method <code>(id) forwardingTargetForSelector:(SEL)aSelector</code> to process them all.  <code>forwardingTargetForSelector:</code> defined in the <code>NSObject</code> class, which allows subclasses to return an alternate recipient to call the <code>aSelector</code> selector.  The <code>ImageFilter</code> instance <code>ImageFilter</code> first check if <code>aSelector</code> some of the <code>draw*</code> messages.  If so, it will send itself a <code>apply</code> message to introduce additional behavior before returning <code>component_</code> to invoke default actions.  The default implementation of the <code>apply</code> method does nothing.  Missing information must be provided by subclasses.  This approach is much simpler than if each filter class would implement the same mechanism for extending behavior. <br><br>  Both <code>ImageTransformFilter</code> and <code>ImageShadowFilter</code> focus on providing their own filtering algorithms by overriding the <code>apply</code> method.  They inherit from the base <code>ImageFilter</code> class, which has a link to another <code>ImageComponent</code> in the form of a private variable <code>component_</code> .  Various <code>ImageComponent</code> objects can be connected at run time, as shown in Figure 16-5. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/854/e38/13d/854e3813dc883e5a5e3fdd68c46acdc2.png" alt="image"><br><br>  <b>Figure 16-5.</b>  An object diagram showing that each ImageComponent is referenced in another ImageComponent instance at each level. <br><br>  The right end of this chain is the source image, which is shown on the left in Figure 16-6.  After we add it to <code>anImageTransformFilter</code> , and then add <code>anImageTransformFilter</code> to <code>anImageShadowFilter</code> , the client will get something like the right image in Figure 16-6.  Each node is encapsulated as a <code>component_</code> another <code>ImageComponent</code> instance.  An analogy can be drawn with how a larger fish swallows smaller ones.  Obviously, the client does not know any details of the decorators, but simply receives a link to an instance of the same old <code>UIImage</code> type (in the form of <code>ImageComponent</code> , because <code>UIImage</code> implements the <code>ImageComponent</code> through a category). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bd5/280/64b/bd528064bf0b12eed5aec4a6d887ea3b.png" alt="image"><br><br>  <b>Figure 16-6.</b>  Original image and the same image after applying a series of filters <br><br>  It is exciting.  Let's see how you can jot it down in code.  The first thing we look at is the <code>ImageComponent</code> , which is declared as a protocol in Listing 16-1. <br><br>  <b>Listing 16‚Äì1.</b>  ImageComponent.h <br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImageComponent</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class">&gt; //     //  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIImage</span></span></span><span class="hljs-class">   //   @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">optional</span></span></span><span class="hljs-class"> - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">drawAsPatternInRect</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CGRect</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rect</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">drawAtPoint</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CGPoint</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">point</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">drawAtPoint</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CGPoint</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">point</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">blendMode</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CGBlendMode</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">blendMode</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">alpha</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CGFloat</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">alpha</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">drawInRect</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CGRect</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rect</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">drawInRect</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CGRect</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rect</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">blendMode</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CGBlendMode</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">blendMode</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">alpha</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CGFloat</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">alpha</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br><br>  All <code>draw*</code> methods are declared as <code>@optional</code> , since we want every <code>ImageComponent</code> to support these operations, but do not actually redefine them in the implementing classes.  The <code>@optional</code> notifies the compiler that the corresponding method implementations may be missing. <br><br>  Listing 16‚Äì2 contains a category declaration for a <code>UIImage</code> , which we can use with other decorators later. <br><br>  <b>Listing 16‚Äì2.</b>  UIImage + ImageComponent.h <br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ImageComponent.h"</span></span></span><span class="hljs-meta"> @interface UIImage (ImageComponent) </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ImageComponent&gt;</span></span></span><span class="hljs-meta"> @end</span></span></code> </pre><br><br>  It (category) implements the <code>ImageComponent</code> protocol without any real implementation.  Now we turn to our main decorator class - <code>ImageFilter</code> .  His ad is shown in Listing 16‚Äì3. <br><br>  <b>Listing 16‚Äì3.</b>  ImageFilter.h <br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ImageComponent.h"</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"UIImage+ImageComponent.h"</span></span></span><span class="hljs-meta"> @interface ImageFilter : NSObject </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ImageComponent&gt;</span></span></span><span class="hljs-meta"> { @private id </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ImageComponent&gt;</span></span></span><span class="hljs-meta"> component_; } @property (nonatomic, retain) id </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ImageComponent&gt;</span></span></span><span class="hljs-meta"> component; - (void) apply; - (id) initWithImageComponent:(id </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ImageComponent&gt;</span></span></span><span class="hljs-meta">) component; - (id) forwardingTargetForSelector:(SEL)aSelector; @end</span></span></code> </pre><br><br>  It contains a link to the <code>ImageComponent</code> as <code>component_</code> , which can be decorated with any other specific decorators.  <code>ImageFilter</code> overrides <code>forwardingTargetForSelector:</code> and declares <code>apply</code> .  The implementation of the class is shown in Listing 16-4. <br><br>  <b>Listing 16‚Äì4.</b>  ImageFilter.m <br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ImageFilter.h"</span></span></span><span class="hljs-meta"> @implementation ImageFilter @synthesize component=component_; - (id) initWithImageComponent:(id </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ImageComponent&gt;</span></span></span><span class="hljs-meta">) component { if (self = [super init]) { //  ImageComponent [self setComponent:component]; } return self; } - (void) apply { //     //     } - (id) forwardingTargetForSelector:(SEL)aSelector { NSString *selectorName = NSStringFromSelector(aSelector); if ([selectorName hasPrefix:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"draw"</span></span></span><span class="hljs-meta">]) { [self apply]; } return component_; } @end</span></span></code> </pre><br><br>  The <code>initWithImageComponent:</code> method does not much useful <code>initWithImageComponent:</code>  It simply assigns a link to the <code>ImageComponent</code> from the method parameter to itself.  Also, his <code>apply</code> method doesn't do anything in this case until we see it again in specific filter classes. <br><br>  What is interesting here is that we use <code>forwardingTargetForSelector:</code> to intercept calls to messages that the <code>ImageFilter</code> instance <code>ImageFilter</code> not know how to handle.  This method allows subclasses to send another recipient's runtime so that the original message will be forwarded.  But we are only interested in everything that has the prefix <code>@‚Äúdraw‚Äù</code> , and then we redirect everything else directly to <code>component_</code> , returning it to the execution environment.  For example, when a <code>drawAtRect:</code> message <code>drawAtRect:</code> sent to an <code>ImageFilter</code> instance, it will be intercepted in the <code>forwardingTargetForSelector:</code> method, waiting for an alternate recipient because <code>ImageFilter</code> has no implementation for this.  Since the message contains the prefix ‚Äúdraw‚Äù, the method sends a message to <code>apply</code> to do something before the <code>component_</code> processes the message later. <br><br>  Now we can get a few real filters.  The first one we are going to create is ImageTransformFilter, as shown in Listing 16-5. <br><br>  <b>Listing 16-5.</b>  ImageTransformFilter.h <br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ImageFilter.h"</span></span></span><span class="hljs-meta"> @interface ImageTransformFilter : ImageFilter { @private CGAffineTransform transform_; } @property (nonatomic, assign) CGAffineTransform transform; - (id) initWithImageComponent:(id </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ImageComponent&gt;</span></span></span><span class="hljs-meta">)component transform:(CGAffineTransform)transform; - (void) apply; @end</span></span></code> </pre><br><br>  <code>ImageTransformFilter</code> is a subclass of <code>ImageFilter</code> and overrides the <code>apply</code> method.  It also declares the <code>transform_</code> private variable of type <code>CGAffineTransform</code> with its associated property to access it.  Since <code>CGAffineTransform</code> is a C structure, the property must be of the type to be assigned, since its value cannot be called <code>retain</code> like other Objective-C objects.  The filter has its own initialization method.  The <code><code>initWithImageComponent:(id )component transform: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code>transform</code>    ,     16‚Äì6. <br> <br> <b> 16‚Äì6.</b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize transform=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component transform:(CGAffineTransform)transform { if (self = [super initWithImageComponent:component]) { [self setTransform:transform]; } return self; } - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @end</code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz 2D <code>UIGraphicsGetCurrentContext()</code> .       Quartz 2D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    16‚Äì7,    ,    Quartz 2D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        16‚Äì6. <br> <br> <b> 16‚Äì7.</b> ImageShadowFilter.m <br> <code class="objectivec">#import "ImageShadowFilter.h" @implementation ImageShadowFilter - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); } @end</code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     16‚Äì8. <br> <br> <b> 16‚Äì8.</b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image transform:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>        ,      16‚Äì6.   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     16‚Äì9. <br> <br> <b> 16‚Äì9.</b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (void)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     16‚Äì6. <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   2D-  ,  ‚Äì   .  ,    ,    16‚Äì7. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> 16‚Äì7.</b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (Transform)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code>Transform</code>  <code>Shadow</code> . <code>BaseFilter</code>    2D  ,        ,     <code>ImageFilter</code>   .              .  <code>Transform</code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code>Transform</code>  <code>Shadow</code> ,     ,   .  <code>Transform</code>   <code>imageWithTransform:transform</code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    16‚Äì8. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> 16‚Äì8.</b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     16‚Äì6.       <code>Shadow</code>     <code>Transform</code> , ,     ,  -    16‚Äì6.        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     16‚Äì10. <br> <br> <b> 16‚Äì10.</b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (void) endContext; @end</code> <br> <br> <code>BaseFilter</code>   ,       ,  16‚Äì11. <br> <br> <b> 16‚Äì11.</b> UIImage+BaseFilter.m <br> <code class="objectivec">#import "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS 4    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; if (NULL != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, NO, 0); else UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); return context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); return imageOut; } - (void) endContext { UIGraphicsEndImageContext(); } @end</code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz 2D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code>Transform</code> .  <code>Transform</code>    ,    <code>CGAffineTransform</code>     .      16‚Äì12. <br> <br> <b> 16‚Äì12.</b> UIImage+Transform.h <br> <code class="objectivec">@interface UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform; @end</code> <br> <br>    ,     16‚Äì13. <br> <br> <b> 16‚Äì13.</b> UIImage+Transform.m <br> <code class="objectivec">#import "UIImage+Transform.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, transform); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code>transform</code>     Quartz 2D, <code>CGContextConcatCTM(context, transform)</code> .  <code>transform</code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code>Transform</code> .  ,   ?      <code>Shadow</code>   ,   ,     16‚Äì14. <br> <br> <b> 16‚Äì14.</b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @end</code> <br> <br>  ,    <code>Transform</code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code>Transform</code> .   ,        16‚Äì15. <br> <br> <b> 16‚Äì15.</b> UIImage+Shadow.m <br> <code class="objectivec">#import "UIImage+Shadow.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>      ,   ,     Quartz 2D, <code>CGSizeMake (-25, 15)</code> ,        X  Y.       <code>CGContextSetShadow(context, offset, 20.0)</code> ,   Quartz 2D,   20.0,    .  ,     <code>addTranform:</code>  <code>Transform</code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     16‚Äì16. <br> <br> <b> 16‚Äì16.</b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image view //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>    ,      ,     16‚Äì8   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> <code><code>initWithImageComponent:(id )component transform: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code>transform</code>    ,     16‚Äì6. <br> <br> <b> 16‚Äì6.</b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize transform=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component transform:(CGAffineTransform)transform { if (self = [super initWithImageComponent:component]) { [self setTransform:transform]; } return self; } - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @end</code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz 2D <code>UIGraphicsGetCurrentContext()</code> .       Quartz 2D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    16‚Äì7,    ,    Quartz 2D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        16‚Äì6. <br> <br> <b> 16‚Äì7.</b> ImageShadowFilter.m <br> <code class="objectivec">#import "ImageShadowFilter.h" @implementation ImageShadowFilter - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); } @end</code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     16‚Äì8. <br> <br> <b> 16‚Äì8.</b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image transform:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>        ,      16‚Äì6.   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     16‚Äì9. <br> <br> <b> 16‚Äì9.</b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (void)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     16‚Äì6. <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   2D-  ,  ‚Äì   .  ,    ,    16‚Äì7. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> 16‚Äì7.</b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (Transform)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code>Transform</code>  <code>Shadow</code> . <code>BaseFilter</code>    2D  ,        ,     <code>ImageFilter</code>   .              .  <code>Transform</code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code>Transform</code>  <code>Shadow</code> ,     ,   .  <code>Transform</code>   <code>imageWithTransform:transform</code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    16‚Äì8. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> 16‚Äì8.</b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     16‚Äì6.       <code>Shadow</code>     <code>Transform</code> , ,     ,  -    16‚Äì6.        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     16‚Äì10. <br> <br> <b> 16‚Äì10.</b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (void) endContext; @end</code> <br> <br> <code>BaseFilter</code>   ,       ,  16‚Äì11. <br> <br> <b> 16‚Äì11.</b> UIImage+BaseFilter.m <br> <code class="objectivec">#import "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS 4    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; if (NULL != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, NO, 0); else UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); return context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); return imageOut; } - (void) endContext { UIGraphicsEndImageContext(); } @end</code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz 2D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code>Transform</code> .  <code>Transform</code>    ,    <code>CGAffineTransform</code>     .      16‚Äì12. <br> <br> <b> 16‚Äì12.</b> UIImage+Transform.h <br> <code class="objectivec">@interface UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform; @end</code> <br> <br>    ,     16‚Äì13. <br> <br> <b> 16‚Äì13.</b> UIImage+Transform.m <br> <code class="objectivec">#import "UIImage+Transform.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, transform); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code>transform</code>     Quartz 2D, <code>CGContextConcatCTM(context, transform)</code> .  <code>transform</code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code>Transform</code> .  ,   ?      <code>Shadow</code>   ,   ,     16‚Äì14. <br> <br> <b> 16‚Äì14.</b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @end</code> <br> <br>  ,    <code>Transform</code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code>Transform</code> .   ,        16‚Äì15. <br> <br> <b> 16‚Äì15.</b> UIImage+Shadow.m <br> <code class="objectivec">#import "UIImage+Shadow.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>      ,   ,     Quartz 2D, <code>CGSizeMake (-25, 15)</code> ,        X  Y.       <code>CGContextSetShadow(context, offset, 20.0)</code> ,   Quartz 2D,   20.0,    .  ,     <code>addTranform:</code>  <code>Transform</code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     16‚Äì16. <br> <br> <b> 16‚Äì16.</b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image view //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>    ,      ,     16‚Äì8   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> <pre> <code class="hljs pgsql"><code>initWithImageComponent:(id )component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span></b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self = [super initWithImageComponent:component]) { [self setTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsGetCurrentContext()</code> .       Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7</span></span>,    ,    Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b> ImageShadowFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "ImageShadowFilter.h" @implementation ImageShadowFilter - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>        ,      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span></b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   <span class="hljs-number"><span class="hljs-number">2</span></span>D-  ,  ‚Äì   .  ,    ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> . <code>BaseFilter</code>    <span class="hljs-number"><span class="hljs-number">2</span></span>D  ,        ,     <code>ImageFilter</code>   .              .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> ,     ,   .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>   <code>imageWithTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>       <code>Shadow</code>     <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , ,     ,  -    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span></b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>BaseFilter</code>   ,       ,  <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span></b> UIImage+BaseFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS <span class="hljs-number"><span class="hljs-number">4</span></span>    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, <span class="hljs-keyword"><span class="hljs-keyword">NO</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext { UIGraphicsEndImageContext(); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>    ,    <code>CGAffineTransform</code>     .      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.h <br> <code class="objectivec">@interface UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Transform.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>)</code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  ,   ?      <code>Shadow</code>   ,   ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span></b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>  ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .   ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span></b> UIImage+Shadow.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Shadow.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>      ,   ,     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>)</code> ,        X  Y.       <code>CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>)</code> ,   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D,   <span class="hljs-number"><span class="hljs-number">20.0</span></span>,    .  ,     <code>addTranform:</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span></b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>    ,      ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8</span></span>   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> </pre> <code><code>initWithImageComponent:(id )component transform: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code>transform</code>    ,     16‚Äì6. <br> <br> <b> 16‚Äì6.</b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize transform=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component transform:(CGAffineTransform)transform { if (self = [super initWithImageComponent:component]) { [self setTransform:transform]; } return self; } - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @end</code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz 2D <code>UIGraphicsGetCurrentContext()</code> .       Quartz 2D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    16‚Äì7,    ,    Quartz 2D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        16‚Äì6. <br> <br> <b> 16‚Äì7.</b> ImageShadowFilter.m <br> <code class="objectivec">#import "ImageShadowFilter.h" @implementation ImageShadowFilter - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); } @end</code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     16‚Äì8. <br> <br> <b> 16‚Äì8.</b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image transform:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>        ,      16‚Äì6.   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     16‚Äì9. <br> <br> <b> 16‚Äì9.</b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (void)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     16‚Äì6. <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   2D-  ,  ‚Äì   .  ,    ,    16‚Äì7. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> 16‚Äì7.</b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (Transform)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code>Transform</code>  <code>Shadow</code> . <code>BaseFilter</code>    2D  ,        ,     <code>ImageFilter</code>   .              .  <code>Transform</code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code>Transform</code>  <code>Shadow</code> ,     ,   .  <code>Transform</code>   <code>imageWithTransform:transform</code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    16‚Äì8. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> 16‚Äì8.</b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     16‚Äì6.       <code>Shadow</code>     <code>Transform</code> , ,     ,  -    16‚Äì6.        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     16‚Äì10. <br> <br> <b> 16‚Äì10.</b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (void) endContext; @end</code> <br> <br> <code>BaseFilter</code>   ,       ,  16‚Äì11. <br> <br> <b> 16‚Äì11.</b> UIImage+BaseFilter.m <br> <code class="objectivec">#import "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS 4    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; if (NULL != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, NO, 0); else UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); return context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); return imageOut; } - (void) endContext { UIGraphicsEndImageContext(); } @end</code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz 2D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code>Transform</code> .  <code>Transform</code>    ,    <code>CGAffineTransform</code>     .      16‚Äì12. <br> <br> <b> 16‚Äì12.</b> UIImage+Transform.h <br> <code class="objectivec">@interface UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform; @end</code> <br> <br>    ,     16‚Äì13. <br> <br> <b> 16‚Äì13.</b> UIImage+Transform.m <br> <code class="objectivec">#import "UIImage+Transform.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, transform); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code>transform</code>     Quartz 2D, <code>CGContextConcatCTM(context, transform)</code> .  <code>transform</code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code>Transform</code> .  ,   ?      <code>Shadow</code>   ,   ,     16‚Äì14. <br> <br> <b> 16‚Äì14.</b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @end</code> <br> <br>  ,    <code>Transform</code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code>Transform</code> .   ,        16‚Äì15. <br> <br> <b> 16‚Äì15.</b> UIImage+Shadow.m <br> <code class="objectivec">#import "UIImage+Shadow.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>      ,   ,     Quartz 2D, <code>CGSizeMake (-25, 15)</code> ,        X  Y.       <code>CGContextSetShadow(context, offset, 20.0)</code> ,   Quartz 2D,   20.0,    .  ,     <code>addTranform:</code>  <code>Transform</code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     16‚Äì16. <br> <br> <b> 16‚Äì16.</b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image view //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>    ,      ,     16‚Äì8   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> <pre> <code class="hljs pgsql"><code>initWithImageComponent:(id )component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span></b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self = [super initWithImageComponent:component]) { [self setTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsGetCurrentContext()</code> .       Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7</span></span>,    ,    Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b> ImageShadowFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "ImageShadowFilter.h" @implementation ImageShadowFilter - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>        ,      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span></b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   <span class="hljs-number"><span class="hljs-number">2</span></span>D-  ,  ‚Äì   .  ,    ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> . <code>BaseFilter</code>    <span class="hljs-number"><span class="hljs-number">2</span></span>D  ,        ,     <code>ImageFilter</code>   .              .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> ,     ,   .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>   <code>imageWithTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>       <code>Shadow</code>     <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , ,     ,  -    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span></b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>BaseFilter</code>   ,       ,  <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span></b> UIImage+BaseFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS <span class="hljs-number"><span class="hljs-number">4</span></span>    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, <span class="hljs-keyword"><span class="hljs-keyword">NO</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext { UIGraphicsEndImageContext(); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>    ,    <code>CGAffineTransform</code>     .      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.h <br> <code class="objectivec">@interface UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Transform.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>)</code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  ,   ?      <code>Shadow</code>   ,   ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span></b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>  ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .   ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span></b> UIImage+Shadow.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Shadow.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>      ,   ,     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>)</code> ,        X  Y.       <code>CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>)</code> ,   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D,   <span class="hljs-number"><span class="hljs-number">20.0</span></span>,    .  ,     <code>addTranform:</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span></b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>    ,      ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8</span></span>   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> </pre> <code><code>initWithImageComponent:(id )component transform: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code>transform</code>    ,     16‚Äì6. <br> <br> <b> 16‚Äì6.</b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize transform=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component transform:(CGAffineTransform)transform { if (self = [super initWithImageComponent:component]) { [self setTransform:transform]; } return self; } - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @end</code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz 2D <code>UIGraphicsGetCurrentContext()</code> .       Quartz 2D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    16‚Äì7,    ,    Quartz 2D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        16‚Äì6. <br> <br> <b> 16‚Äì7.</b> ImageShadowFilter.m <br> <code class="objectivec">#import "ImageShadowFilter.h" @implementation ImageShadowFilter - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); } @end</code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     16‚Äì8. <br> <br> <b> 16‚Äì8.</b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image transform:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>        ,      16‚Äì6.   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     16‚Äì9. <br> <br> <b> 16‚Äì9.</b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (void)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     16‚Äì6. <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   2D-  ,  ‚Äì   .  ,    ,    16‚Äì7. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> 16‚Äì7.</b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (Transform)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code>Transform</code>  <code>Shadow</code> . <code>BaseFilter</code>    2D  ,        ,     <code>ImageFilter</code>   .              .  <code>Transform</code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code>Transform</code>  <code>Shadow</code> ,     ,   .  <code>Transform</code>   <code>imageWithTransform:transform</code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    16‚Äì8. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> 16‚Äì8.</b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     16‚Äì6.       <code>Shadow</code>     <code>Transform</code> , ,     ,  -    16‚Äì6.        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     16‚Äì10. <br> <br> <b> 16‚Äì10.</b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (void) endContext; @end</code> <br> <br> <code>BaseFilter</code>   ,       ,  16‚Äì11. <br> <br> <b> 16‚Äì11.</b> UIImage+BaseFilter.m <br> <code class="objectivec">#import "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS 4    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; if (NULL != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, NO, 0); else UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); return context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); return imageOut; } - (void) endContext { UIGraphicsEndImageContext(); } @end</code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz 2D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code>Transform</code> .  <code>Transform</code>    ,    <code>CGAffineTransform</code>     .      16‚Äì12. <br> <br> <b> 16‚Äì12.</b> UIImage+Transform.h <br> <code class="objectivec">@interface UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform; @end</code> <br> <br>    ,     16‚Äì13. <br> <br> <b> 16‚Äì13.</b> UIImage+Transform.m <br> <code class="objectivec">#import "UIImage+Transform.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, transform); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code>transform</code>     Quartz 2D, <code>CGContextConcatCTM(context, transform)</code> .  <code>transform</code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code>Transform</code> .  ,   ?      <code>Shadow</code>   ,   ,     16‚Äì14. <br> <br> <b> 16‚Äì14.</b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @end</code> <br> <br>  ,    <code>Transform</code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code>Transform</code> .   ,        16‚Äì15. <br> <br> <b> 16‚Äì15.</b> UIImage+Shadow.m <br> <code class="objectivec">#import "UIImage+Shadow.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>      ,   ,     Quartz 2D, <code>CGSizeMake (-25, 15)</code> ,        X  Y.       <code>CGContextSetShadow(context, offset, 20.0)</code> ,   Quartz 2D,   20.0,    .  ,     <code>addTranform:</code>  <code>Transform</code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     16‚Äì16. <br> <br> <b> 16‚Äì16.</b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image view //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>    ,      ,     16‚Äì8   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> <pre> <code class="hljs pgsql"><code>initWithImageComponent:(id )component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span></b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self = [super initWithImageComponent:component]) { [self setTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsGetCurrentContext()</code> .       Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7</span></span>,    ,    Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b> ImageShadowFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "ImageShadowFilter.h" @implementation ImageShadowFilter - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>        ,      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span></b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   <span class="hljs-number"><span class="hljs-number">2</span></span>D-  ,  ‚Äì   .  ,    ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> . <code>BaseFilter</code>    <span class="hljs-number"><span class="hljs-number">2</span></span>D  ,        ,     <code>ImageFilter</code>   .              .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> ,     ,   .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>   <code>imageWithTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>       <code>Shadow</code>     <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , ,     ,  -    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span></b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>BaseFilter</code>   ,       ,  <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span></b> UIImage+BaseFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS <span class="hljs-number"><span class="hljs-number">4</span></span>    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, <span class="hljs-keyword"><span class="hljs-keyword">NO</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext { UIGraphicsEndImageContext(); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>    ,    <code>CGAffineTransform</code>     .      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.h <br> <code class="objectivec">@interface UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Transform.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>)</code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  ,   ?      <code>Shadow</code>   ,   ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span></b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>  ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .   ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span></b> UIImage+Shadow.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Shadow.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>      ,   ,     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>)</code> ,        X  Y.       <code>CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>)</code> ,   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D,   <span class="hljs-number"><span class="hljs-number">20.0</span></span>,    .  ,     <code>addTranform:</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span></b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>    ,      ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8</span></span>   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> </pre> <code><code>initWithImageComponent:(id )component transform: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code>transform</code>    ,     16‚Äì6. <br> <br> <b> 16‚Äì6.</b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize transform=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component transform:(CGAffineTransform)transform { if (self = [super initWithImageComponent:component]) { [self setTransform:transform]; } return self; } - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @end</code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz 2D <code>UIGraphicsGetCurrentContext()</code> .       Quartz 2D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    16‚Äì7,    ,    Quartz 2D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        16‚Äì6. <br> <br> <b> 16‚Äì7.</b> ImageShadowFilter.m <br> <code class="objectivec">#import "ImageShadowFilter.h" @implementation ImageShadowFilter - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); } @end</code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     16‚Äì8. <br> <br> <b> 16‚Äì8.</b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image transform:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>        ,      16‚Äì6.   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     16‚Äì9. <br> <br> <b> 16‚Äì9.</b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (void)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     16‚Äì6. <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   2D-  ,  ‚Äì   .  ,    ,    16‚Äì7. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> 16‚Äì7.</b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (Transform)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code>Transform</code>  <code>Shadow</code> . <code>BaseFilter</code>    2D  ,        ,     <code>ImageFilter</code>   .              .  <code>Transform</code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code>Transform</code>  <code>Shadow</code> ,     ,   .  <code>Transform</code>   <code>imageWithTransform:transform</code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    16‚Äì8. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> 16‚Äì8.</b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     16‚Äì6.       <code>Shadow</code>     <code>Transform</code> , ,     ,  -    16‚Äì6.        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     16‚Äì10. <br> <br> <b> 16‚Äì10.</b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (void) endContext; @end</code> <br> <br> <code>BaseFilter</code>   ,       ,  16‚Äì11. <br> <br> <b> 16‚Äì11.</b> UIImage+BaseFilter.m <br> <code class="objectivec">#import "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS 4    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; if (NULL != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, NO, 0); else UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); return context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); return imageOut; } - (void) endContext { UIGraphicsEndImageContext(); } @end</code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz 2D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code>Transform</code> .  <code>Transform</code>    ,    <code>CGAffineTransform</code>     .      16‚Äì12. <br> <br> <b> 16‚Äì12.</b> UIImage+Transform.h <br> <code class="objectivec">@interface UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform; @end</code> <br> <br>    ,     16‚Äì13. <br> <br> <b> 16‚Äì13.</b> UIImage+Transform.m <br> <code class="objectivec">#import "UIImage+Transform.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, transform); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code>transform</code>     Quartz 2D, <code>CGContextConcatCTM(context, transform)</code> .  <code>transform</code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code>Transform</code> .  ,   ?      <code>Shadow</code>   ,   ,     16‚Äì14. <br> <br> <b> 16‚Äì14.</b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @end</code> <br> <br>  ,    <code>Transform</code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code>Transform</code> .   ,        16‚Äì15. <br> <br> <b> 16‚Äì15.</b> UIImage+Shadow.m <br> <code class="objectivec">#import "UIImage+Shadow.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>      ,   ,     Quartz 2D, <code>CGSizeMake (-25, 15)</code> ,        X  Y.       <code>CGContextSetShadow(context, offset, 20.0)</code> ,   Quartz 2D,   20.0,    .  ,     <code>addTranform:</code>  <code>Transform</code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     16‚Äì16. <br> <br> <b> 16‚Äì16.</b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image view //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>    ,      ,     16‚Äì8   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> <pre> <code class="hljs pgsql"><code>initWithImageComponent:(id )component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span></b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self = [super initWithImageComponent:component]) { [self setTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsGetCurrentContext()</code> .       Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7</span></span>,    ,    Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b> ImageShadowFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "ImageShadowFilter.h" @implementation ImageShadowFilter - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>        ,      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span></b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   <span class="hljs-number"><span class="hljs-number">2</span></span>D-  ,  ‚Äì   .  ,    ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> . <code>BaseFilter</code>    <span class="hljs-number"><span class="hljs-number">2</span></span>D  ,        ,     <code>ImageFilter</code>   .              .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> ,     ,   .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>   <code>imageWithTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>       <code>Shadow</code>     <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , ,     ,  -    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span></b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>BaseFilter</code>   ,       ,  <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span></b> UIImage+BaseFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS <span class="hljs-number"><span class="hljs-number">4</span></span>    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, <span class="hljs-keyword"><span class="hljs-keyword">NO</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext { UIGraphicsEndImageContext(); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>    ,    <code>CGAffineTransform</code>     .      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.h <br> <code class="objectivec">@interface UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Transform.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>)</code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  ,   ?      <code>Shadow</code>   ,   ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span></b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>  ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .   ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span></b> UIImage+Shadow.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Shadow.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>      ,   ,     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>)</code> ,        X  Y.       <code>CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>)</code> ,   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D,   <span class="hljs-number"><span class="hljs-number">20.0</span></span>,    .  ,     <code>addTranform:</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span></b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>    ,      ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8</span></span>   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> </pre> <code><code>initWithImageComponent:(id )component transform: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code>transform</code>    ,     16‚Äì6. <br> <br> <b> 16‚Äì6.</b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize transform=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component transform:(CGAffineTransform)transform { if (self = [super initWithImageComponent:component]) { [self setTransform:transform]; } return self; } - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @end</code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz 2D <code>UIGraphicsGetCurrentContext()</code> .       Quartz 2D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    16‚Äì7,    ,    Quartz 2D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        16‚Äì6. <br> <br> <b> 16‚Äì7.</b> ImageShadowFilter.m <br> <code class="objectivec">#import "ImageShadowFilter.h" @implementation ImageShadowFilter - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); } @end</code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     16‚Äì8. <br> <br> <b> 16‚Äì8.</b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image transform:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>        ,      16‚Äì6.   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     16‚Äì9. <br> <br> <b> 16‚Äì9.</b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (void)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     16‚Äì6. <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   2D-  ,  ‚Äì   .  ,    ,    16‚Äì7. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> 16‚Äì7.</b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (Transform)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code>Transform</code>  <code>Shadow</code> . <code>BaseFilter</code>    2D  ,        ,     <code>ImageFilter</code>   .              .  <code>Transform</code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code>Transform</code>  <code>Shadow</code> ,     ,   .  <code>Transform</code>   <code>imageWithTransform:transform</code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    16‚Äì8. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> 16‚Äì8.</b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     16‚Äì6.       <code>Shadow</code>     <code>Transform</code> , ,     ,  -    16‚Äì6.        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     16‚Äì10. <br> <br> <b> 16‚Äì10.</b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (void) endContext; @end</code> <br> <br> <code>BaseFilter</code>   ,       ,  16‚Äì11. <br> <br> <b> 16‚Äì11.</b> UIImage+BaseFilter.m <br> <code class="objectivec">#import "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS 4    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; if (NULL != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, NO, 0); else UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); return context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); return imageOut; } - (void) endContext { UIGraphicsEndImageContext(); } @end</code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz 2D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code>Transform</code> .  <code>Transform</code>    ,    <code>CGAffineTransform</code>     .      16‚Äì12. <br> <br> <b> 16‚Äì12.</b> UIImage+Transform.h <br> <code class="objectivec">@interface UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform; @end</code> <br> <br>    ,     16‚Äì13. <br> <br> <b> 16‚Äì13.</b> UIImage+Transform.m <br> <code class="objectivec">#import "UIImage+Transform.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, transform); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code>transform</code>     Quartz 2D, <code>CGContextConcatCTM(context, transform)</code> .  <code>transform</code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code>Transform</code> .  ,   ?      <code>Shadow</code>   ,   ,     16‚Äì14. <br> <br> <b> 16‚Äì14.</b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @end</code> <br> <br>  ,    <code>Transform</code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code>Transform</code> .   ,        16‚Äì15. <br> <br> <b> 16‚Äì15.</b> UIImage+Shadow.m <br> <code class="objectivec">#import "UIImage+Shadow.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>      ,   ,     Quartz 2D, <code>CGSizeMake (-25, 15)</code> ,        X  Y.       <code>CGContextSetShadow(context, offset, 20.0)</code> ,   Quartz 2D,   20.0,    .  ,     <code>addTranform:</code>  <code>Transform</code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     16‚Äì16. <br> <br> <b> 16‚Äì16.</b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image view //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>    ,      ,     16‚Äì8   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> <h5> <code><code>initWithImageComponent:(id )component transform: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code>transform</code>    ,     16‚Äì6. <br> <br> <b> 16‚Äì6.</b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize transform=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component transform:(CGAffineTransform)transform { if (self = [super initWithImageComponent:component]) { [self setTransform:transform]; } return self; } - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @end</code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz 2D <code>UIGraphicsGetCurrentContext()</code> .       Quartz 2D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    16‚Äì7,    ,    Quartz 2D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        16‚Äì6. <br> <br> <b> 16‚Äì7.</b> ImageShadowFilter.m <br> <code class="objectivec">#import "ImageShadowFilter.h" @implementation ImageShadowFilter - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); } @end</code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     16‚Äì8. <br> <br> <b> 16‚Äì8.</b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image transform:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>        ,      16‚Äì6.   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     16‚Äì9. <br> <br> <b> 16‚Äì9.</b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (void)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     16‚Äì6. <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   2D-  ,  ‚Äì   .  ,    ,    16‚Äì7. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> 16‚Äì7.</b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (Transform)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code>Transform</code>  <code>Shadow</code> . <code>BaseFilter</code>    2D  ,        ,     <code>ImageFilter</code>   .              .  <code>Transform</code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code>Transform</code>  <code>Shadow</code> ,     ,   .  <code>Transform</code>   <code>imageWithTransform:transform</code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    16‚Äì8. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> 16‚Äì8.</b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     16‚Äì6.       <code>Shadow</code>     <code>Transform</code> , ,     ,  -    16‚Äì6.        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     16‚Äì10. <br> <br> <b> 16‚Äì10.</b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (void) endContext; @end</code> <br> <br> <code>BaseFilter</code>   ,       ,  16‚Äì11. <br> <br> <b> 16‚Äì11.</b> UIImage+BaseFilter.m <br> <code class="objectivec">#import "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS 4    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; if (NULL != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, NO, 0); else UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); return context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); return imageOut; } - (void) endContext { UIGraphicsEndImageContext(); } @end</code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz 2D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code>Transform</code> .  <code>Transform</code>    ,    <code>CGAffineTransform</code>     .      16‚Äì12. <br> <br> <b> 16‚Äì12.</b> UIImage+Transform.h <br> <code class="objectivec">@interface UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform; @end</code> <br> <br>    ,     16‚Äì13. <br> <br> <b> 16‚Äì13.</b> UIImage+Transform.m <br> <code class="objectivec">#import "UIImage+Transform.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, transform); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code>transform</code>     Quartz 2D, <code>CGContextConcatCTM(context, transform)</code> .  <code>transform</code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code>Transform</code> .  ,   ?      <code>Shadow</code>   ,   ,     16‚Äì14. <br> <br> <b> 16‚Äì14.</b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @end</code> <br> <br>  ,    <code>Transform</code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code>Transform</code> .   ,        16‚Äì15. <br> <br> <b> 16‚Äì15.</b> UIImage+Shadow.m <br> <code class="objectivec">#import "UIImage+Shadow.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>      ,   ,     Quartz 2D, <code>CGSizeMake (-25, 15)</code> ,        X  Y.       <code>CGContextSetShadow(context, offset, 20.0)</code> ,   Quartz 2D,   20.0,    .  ,     <code>addTranform:</code>  <code>Transform</code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     16‚Äì16. <br> <br> <b> 16‚Äì16.</b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image view //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>    ,      ,     16‚Äì8   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> </h5> <code><code>initWithImageComponent:(id )component transform: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code>transform</code>    ,     16‚Äì6. <br> <br> <b> 16‚Äì6.</b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize transform=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component transform:(CGAffineTransform)transform { if (self = [super initWithImageComponent:component]) { [self setTransform:transform]; } return self; } - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @end</code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz 2D <code>UIGraphicsGetCurrentContext()</code> .       Quartz 2D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    16‚Äì7,    ,    Quartz 2D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        16‚Äì6. <br> <br> <b> 16‚Äì7.</b> ImageShadowFilter.m <br> <code class="objectivec">#import "ImageShadowFilter.h" @implementation ImageShadowFilter - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); } @end</code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     16‚Äì8. <br> <br> <b> 16‚Äì8.</b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image transform:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>        ,      16‚Äì6.   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     16‚Äì9. <br> <br> <b> 16‚Äì9.</b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (void)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     16‚Äì6. <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   2D-  ,  ‚Äì   .  ,    ,    16‚Äì7. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> 16‚Äì7.</b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (Transform)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code>Transform</code>  <code>Shadow</code> . <code>BaseFilter</code>    2D  ,        ,     <code>ImageFilter</code>   .              .  <code>Transform</code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code>Transform</code>  <code>Shadow</code> ,     ,   .  <code>Transform</code>   <code>imageWithTransform:transform</code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    16‚Äì8. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> 16‚Äì8.</b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     16‚Äì6.       <code>Shadow</code>     <code>Transform</code> , ,     ,  -    16‚Äì6.        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     16‚Äì10. <br> <br> <b> 16‚Äì10.</b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (void) endContext; @end</code> <br> <br> <code>BaseFilter</code>   ,       ,  16‚Äì11. <br> <br> <b> 16‚Äì11.</b> UIImage+BaseFilter.m <br> <code class="objectivec">#import "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS 4    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; if (NULL != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, NO, 0); else UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); return context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); return imageOut; } - (void) endContext { UIGraphicsEndImageContext(); } @end</code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz 2D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code>Transform</code> .  <code>Transform</code>    ,    <code>CGAffineTransform</code>     .      16‚Äì12. <br> <br> <b> 16‚Äì12.</b> UIImage+Transform.h <br> <code class="objectivec">@interface UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform; @end</code> <br> <br>    ,     16‚Äì13. <br> <br> <b> 16‚Äì13.</b> UIImage+Transform.m <br> <code class="objectivec">#import "UIImage+Transform.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, transform); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code>transform</code>     Quartz 2D, <code>CGContextConcatCTM(context, transform)</code> .  <code>transform</code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code>Transform</code> .  ,   ?      <code>Shadow</code>   ,   ,     16‚Äì14. <br> <br> <b> 16‚Äì14.</b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @end</code> <br> <br>  ,    <code>Transform</code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code>Transform</code> .   ,        16‚Äì15. <br> <br> <b> 16‚Äì15.</b> UIImage+Shadow.m <br> <code class="objectivec">#import "UIImage+Shadow.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>      ,   ,     Quartz 2D, <code>CGSizeMake (-25, 15)</code> ,        X  Y.       <code>CGContextSetShadow(context, offset, 20.0)</code> ,   Quartz 2D,   20.0,    .  ,     <code>addTranform:</code>  <code>Transform</code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     16‚Äì16. <br> <br> <b> 16‚Äì16.</b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image view //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>    ,      ,     16‚Äì8   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> <pre> <code class="hljs pgsql"><code>initWithImageComponent:(id )component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span></b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self = [super initWithImageComponent:component]) { [self setTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsGetCurrentContext()</code> .       Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7</span></span>,    ,    Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b> ImageShadowFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "ImageShadowFilter.h" @implementation ImageShadowFilter - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>        ,      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span></b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   <span class="hljs-number"><span class="hljs-number">2</span></span>D-  ,  ‚Äì   .  ,    ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> . <code>BaseFilter</code>    <span class="hljs-number"><span class="hljs-number">2</span></span>D  ,        ,     <code>ImageFilter</code>   .              .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> ,     ,   .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>   <code>imageWithTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>       <code>Shadow</code>     <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , ,     ,  -    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span></b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>BaseFilter</code>   ,       ,  <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span></b> UIImage+BaseFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS <span class="hljs-number"><span class="hljs-number">4</span></span>    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, <span class="hljs-keyword"><span class="hljs-keyword">NO</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext { UIGraphicsEndImageContext(); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>    ,    <code>CGAffineTransform</code>     .      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.h <br> <code class="objectivec">@interface UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Transform.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>)</code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  ,   ?      <code>Shadow</code>   ,   ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span></b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>  ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .   ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span></b> UIImage+Shadow.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Shadow.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>      ,   ,     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>)</code> ,        X  Y.       <code>CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>)</code> ,   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D,   <span class="hljs-number"><span class="hljs-number">20.0</span></span>,    .  ,     <code>addTranform:</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span></b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>    ,      ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8</span></span>   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> </pre> <code><code>initWithImageComponent:(id )component transform: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code>transform</code>    ,     16‚Äì6. <br> <br> <b> 16‚Äì6.</b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize transform=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component transform:(CGAffineTransform)transform { if (self = [super initWithImageComponent:component]) { [self setTransform:transform]; } return self; } - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @end</code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz 2D <code>UIGraphicsGetCurrentContext()</code> .       Quartz 2D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    16‚Äì7,    ,    Quartz 2D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        16‚Äì6. <br> <br> <b> 16‚Äì7.</b> ImageShadowFilter.m <br> <code class="objectivec">#import "ImageShadowFilter.h" @implementation ImageShadowFilter - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); } @end</code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     16‚Äì8. <br> <br> <b> 16‚Äì8.</b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image transform:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>        ,      16‚Äì6.   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     16‚Äì9. <br> <br> <b> 16‚Äì9.</b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (void)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     16‚Äì6. <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   2D-  ,  ‚Äì   .  ,    ,    16‚Äì7. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> 16‚Äì7.</b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (Transform)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code>Transform</code>  <code>Shadow</code> . <code>BaseFilter</code>    2D  ,        ,     <code>ImageFilter</code>   .              .  <code>Transform</code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code>Transform</code>  <code>Shadow</code> ,     ,   .  <code>Transform</code>   <code>imageWithTransform:transform</code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    16‚Äì8. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> 16‚Äì8.</b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     16‚Äì6.       <code>Shadow</code>     <code>Transform</code> , ,     ,  -    16‚Äì6.        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     16‚Äì10. <br> <br> <b> 16‚Äì10.</b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (void) endContext; @end</code> <br> <br> <code>BaseFilter</code>   ,       ,  16‚Äì11. <br> <br> <b> 16‚Äì11.</b> UIImage+BaseFilter.m <br> <code class="objectivec">#import "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS 4    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; if (NULL != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, NO, 0); else UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); return context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); return imageOut; } - (void) endContext { UIGraphicsEndImageContext(); } @end</code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz 2D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code>Transform</code> .  <code>Transform</code>    ,    <code>CGAffineTransform</code>     .      16‚Äì12. <br> <br> <b> 16‚Äì12.</b> UIImage+Transform.h <br> <code class="objectivec">@interface UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform; @end</code> <br> <br>    ,     16‚Äì13. <br> <br> <b> 16‚Äì13.</b> UIImage+Transform.m <br> <code class="objectivec">#import "UIImage+Transform.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, transform); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code>transform</code>     Quartz 2D, <code>CGContextConcatCTM(context, transform)</code> .  <code>transform</code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code>Transform</code> .  ,   ?      <code>Shadow</code>   ,   ,     16‚Äì14. <br> <br> <b> 16‚Äì14.</b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @end</code> <br> <br>  ,    <code>Transform</code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code>Transform</code> .   ,        16‚Äì15. <br> <br> <b> 16‚Äì15.</b> UIImage+Shadow.m <br> <code class="objectivec">#import "UIImage+Shadow.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>      ,   ,     Quartz 2D, <code>CGSizeMake (-25, 15)</code> ,        X  Y.       <code>CGContextSetShadow(context, offset, 20.0)</code> ,   Quartz 2D,   20.0,    .  ,     <code>addTranform:</code>  <code>Transform</code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     16‚Äì16. <br> <br> <b> 16‚Äì16.</b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image view //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>    ,      ,     16‚Äì8   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> <pre> <code class="hljs pgsql"><code>initWithImageComponent:(id )component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span></b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self = [super initWithImageComponent:component]) { [self setTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsGetCurrentContext()</code> .       Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7</span></span>,    ,    Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b> ImageShadowFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "ImageShadowFilter.h" @implementation ImageShadowFilter - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>        ,      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span></b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   <span class="hljs-number"><span class="hljs-number">2</span></span>D-  ,  ‚Äì   .  ,    ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> . <code>BaseFilter</code>    <span class="hljs-number"><span class="hljs-number">2</span></span>D  ,        ,     <code>ImageFilter</code>   .              .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> ,     ,   .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>   <code>imageWithTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>       <code>Shadow</code>     <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , ,     ,  -    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span></b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>BaseFilter</code>   ,       ,  <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span></b> UIImage+BaseFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS <span class="hljs-number"><span class="hljs-number">4</span></span>    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, <span class="hljs-keyword"><span class="hljs-keyword">NO</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext { UIGraphicsEndImageContext(); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>    ,    <code>CGAffineTransform</code>     .      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.h <br> <code class="objectivec">@interface UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Transform.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>)</code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  ,   ?      <code>Shadow</code>   ,   ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span></b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>  ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .   ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span></b> UIImage+Shadow.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Shadow.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>      ,   ,     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>)</code> ,        X  Y.       <code>CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>)</code> ,   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D,   <span class="hljs-number"><span class="hljs-number">20.0</span></span>,    .  ,     <code>addTranform:</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span></b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>    ,      ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8</span></span>   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> </pre> <code><code>initWithImageComponent:(id )component transform: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code>transform</code>    ,     16‚Äì6. <br> <br> <b> 16‚Äì6.</b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize transform=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component transform:(CGAffineTransform)transform { if (self = [super initWithImageComponent:component]) { [self setTransform:transform]; } return self; } - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @end</code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz 2D <code>UIGraphicsGetCurrentContext()</code> .       Quartz 2D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    16‚Äì7,    ,    Quartz 2D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        16‚Äì6. <br> <br> <b> 16‚Äì7.</b> ImageShadowFilter.m <br> <code class="objectivec">#import "ImageShadowFilter.h" @implementation ImageShadowFilter - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); } @end</code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     16‚Äì8. <br> <br> <b> 16‚Äì8.</b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image transform:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>        ,      16‚Äì6.   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     16‚Äì9. <br> <br> <b> 16‚Äì9.</b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (void)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     16‚Äì6. <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   2D-  ,  ‚Äì   .  ,    ,    16‚Äì7. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> 16‚Äì7.</b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (Transform)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code>Transform</code>  <code>Shadow</code> . <code>BaseFilter</code>    2D  ,        ,     <code>ImageFilter</code>   .              .  <code>Transform</code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code>Transform</code>  <code>Shadow</code> ,     ,   .  <code>Transform</code>   <code>imageWithTransform:transform</code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    16‚Äì8. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> 16‚Äì8.</b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     16‚Äì6.       <code>Shadow</code>     <code>Transform</code> , ,     ,  -    16‚Äì6.        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     16‚Äì10. <br> <br> <b> 16‚Äì10.</b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (void) endContext; @end</code> <br> <br> <code>BaseFilter</code>   ,       ,  16‚Äì11. <br> <br> <b> 16‚Äì11.</b> UIImage+BaseFilter.m <br> <code class="objectivec">#import "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS 4    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; if (NULL != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, NO, 0); else UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); return context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); return imageOut; } - (void) endContext { UIGraphicsEndImageContext(); } @end</code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz 2D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code>Transform</code> .  <code>Transform</code>    ,    <code>CGAffineTransform</code>     .      16‚Äì12. <br> <br> <b> 16‚Äì12.</b> UIImage+Transform.h <br> <code class="objectivec">@interface UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform; @end</code> <br> <br>    ,     16‚Äì13. <br> <br> <b> 16‚Äì13.</b> UIImage+Transform.m <br> <code class="objectivec">#import "UIImage+Transform.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, transform); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code>transform</code>     Quartz 2D, <code>CGContextConcatCTM(context, transform)</code> .  <code>transform</code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code>Transform</code> .  ,   ?      <code>Shadow</code>   ,   ,     16‚Äì14. <br> <br> <b> 16‚Äì14.</b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @end</code> <br> <br>  ,    <code>Transform</code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code>Transform</code> .   ,        16‚Äì15. <br> <br> <b> 16‚Äì15.</b> UIImage+Shadow.m <br> <code class="objectivec">#import "UIImage+Shadow.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>      ,   ,     Quartz 2D, <code>CGSizeMake (-25, 15)</code> ,        X  Y.       <code>CGContextSetShadow(context, offset, 20.0)</code> ,   Quartz 2D,   20.0,    .  ,     <code>addTranform:</code>  <code>Transform</code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     16‚Äì16. <br> <br> <b> 16‚Äì16.</b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image view //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>    ,      ,     16‚Äì8   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> <pre> <code class="hljs pgsql"><code class="objectivec"><code>initWithImageComponent:(id )component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span></b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self = [super initWithImageComponent:component]) { [self setTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsGetCurrentContext()</code> .       Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7</span></span>,    ,    Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b> ImageShadowFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "ImageShadowFilter.h" @implementation ImageShadowFilter - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>        ,      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span></b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   <span class="hljs-number"><span class="hljs-number">2</span></span>D-  ,  ‚Äì   .  ,    ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> . <code>BaseFilter</code>    <span class="hljs-number"><span class="hljs-number">2</span></span>D  ,        ,     <code>ImageFilter</code>   .              .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> ,     ,   .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>   <code>imageWithTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>       <code>Shadow</code>     <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , ,     ,  -    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span></b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>BaseFilter</code>   ,       ,  <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span></b> UIImage+BaseFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS <span class="hljs-number"><span class="hljs-number">4</span></span>    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, <span class="hljs-keyword"><span class="hljs-keyword">NO</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext { UIGraphicsEndImageContext(); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>    ,    <code>CGAffineTransform</code>     .      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.h <br> @interface UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <br> <br>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Transform.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>)</code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  ,   ?      <code>Shadow</code>   ,   ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span></b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>  ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .   ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span></b> UIImage+Shadow.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Shadow.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>      ,   ,     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>)</code> ,        X  Y.       <code>CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>)</code> ,   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D,   <span class="hljs-number"><span class="hljs-number">20.0</span></span>,    .  ,     <code>addTranform:</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span></b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>    ,      ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8</span></span>   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code></code> </pre> <code><code>initWithImageComponent:(id )component transform: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code>transform</code>    ,     16‚Äì6. <br> <br> <b> 16‚Äì6.</b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize transform=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component transform:(CGAffineTransform)transform { if (self = [super initWithImageComponent:component]) { [self setTransform:transform]; } return self; } - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @end</code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz 2D <code>UIGraphicsGetCurrentContext()</code> .       Quartz 2D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    16‚Äì7,    ,    Quartz 2D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        16‚Äì6. <br> <br> <b> 16‚Äì7.</b> ImageShadowFilter.m <br> <code class="objectivec">#import "ImageShadowFilter.h" @implementation ImageShadowFilter - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); } @end</code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     16‚Äì8. <br> <br> <b> 16‚Äì8.</b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image transform:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>        ,      16‚Äì6.   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     16‚Äì9. <br> <br> <b> 16‚Äì9.</b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (void)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     16‚Äì6. <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   2D-  ,  ‚Äì   .  ,    ,    16‚Äì7. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> 16‚Äì7.</b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (Transform)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code>Transform</code>  <code>Shadow</code> . <code>BaseFilter</code>    2D  ,        ,     <code>ImageFilter</code>   .              .  <code>Transform</code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code>Transform</code>  <code>Shadow</code> ,     ,   .  <code>Transform</code>   <code>imageWithTransform:transform</code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    16‚Äì8. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> 16‚Äì8.</b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     16‚Äì6.       <code>Shadow</code>     <code>Transform</code> , ,     ,  -    16‚Äì6.        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     16‚Äì10. <br> <br> <b> 16‚Äì10.</b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (void) endContext; @end</code> <br> <br> <code>BaseFilter</code>   ,       ,  16‚Äì11. <br> <br> <b> 16‚Äì11.</b> UIImage+BaseFilter.m <br> <code class="objectivec">#import "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS 4    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; if (NULL != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, NO, 0); else UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); return context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); return imageOut; } - (void) endContext { UIGraphicsEndImageContext(); } @end</code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz 2D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code>Transform</code> .  <code>Transform</code>    ,    <code>CGAffineTransform</code>     .      16‚Äì12. <br> <br> <b> 16‚Äì12.</b> UIImage+Transform.h <br> <code class="objectivec">@interface UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform; @end</code> <br> <br>    ,     16‚Äì13. <br> <br> <b> 16‚Äì13.</b> UIImage+Transform.m <br> <code class="objectivec">#import "UIImage+Transform.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, transform); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code>transform</code>     Quartz 2D, <code>CGContextConcatCTM(context, transform)</code> .  <code>transform</code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code>Transform</code> .  ,   ?      <code>Shadow</code>   ,   ,     16‚Äì14. <br> <br> <b> 16‚Äì14.</b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @end</code> <br> <br>  ,    <code>Transform</code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code>Transform</code> .   ,        16‚Äì15. <br> <br> <b> 16‚Äì15.</b> UIImage+Shadow.m <br> <code class="objectivec">#import "UIImage+Shadow.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>      ,   ,     Quartz 2D, <code>CGSizeMake (-25, 15)</code> ,        X  Y.       <code>CGContextSetShadow(context, offset, 20.0)</code> ,   Quartz 2D,   20.0,    .  ,     <code>addTranform:</code>  <code>Transform</code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     16‚Äì16. <br> <br> <b> 16‚Äì16.</b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image view //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>    ,      ,     16‚Äì8   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> <pre> <code class="hljs pgsql"><code>initWithImageComponent:(id )component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span></b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self = [super initWithImageComponent:component]) { [self setTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsGetCurrentContext()</code> .       Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7</span></span>,    ,    Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b> ImageShadowFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "ImageShadowFilter.h" @implementation ImageShadowFilter - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>        ,      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span></b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   <span class="hljs-number"><span class="hljs-number">2</span></span>D-  ,  ‚Äì   .  ,    ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> . <code>BaseFilter</code>    <span class="hljs-number"><span class="hljs-number">2</span></span>D  ,        ,     <code>ImageFilter</code>   .              .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> ,     ,   .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>   <code>imageWithTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>       <code>Shadow</code>     <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , ,     ,  -    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span></b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>BaseFilter</code>   ,       ,  <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span></b> UIImage+BaseFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS <span class="hljs-number"><span class="hljs-number">4</span></span>    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, <span class="hljs-keyword"><span class="hljs-keyword">NO</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext { UIGraphicsEndImageContext(); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>    ,    <code>CGAffineTransform</code>     .      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.h <br> <code class="objectivec">@interface UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Transform.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>)</code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  ,   ?      <code>Shadow</code>   ,   ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span></b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>  ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .   ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span></b> UIImage+Shadow.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Shadow.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>      ,   ,     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>)</code> ,        X  Y.       <code>CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>)</code> ,   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D,   <span class="hljs-number"><span class="hljs-number">20.0</span></span>,    .  ,     <code>addTranform:</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span></b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>    ,      ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8</span></span>   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> </pre> <code><code>initWithImageComponent:(id )component transform: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code>transform</code>    ,     16‚Äì6. <br> <br> <b> 16‚Äì6.</b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize transform=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component transform:(CGAffineTransform)transform { if (self = [super initWithImageComponent:component]) { [self setTransform:transform]; } return self; } - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @end</code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz 2D <code>UIGraphicsGetCurrentContext()</code> .       Quartz 2D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    16‚Äì7,    ,    Quartz 2D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        16‚Äì6. <br> <br> <b> 16‚Äì7.</b> ImageShadowFilter.m <br> <code class="objectivec">#import "ImageShadowFilter.h" @implementation ImageShadowFilter - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); } @end</code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     16‚Äì8. <br> <br> <b> 16‚Äì8.</b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image transform:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>        ,      16‚Äì6.   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     16‚Äì9. <br> <br> <b> 16‚Äì9.</b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (void)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     16‚Äì6. <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   2D-  ,  ‚Äì   .  ,    ,    16‚Äì7. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> 16‚Äì7.</b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (Transform)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code>Transform</code>  <code>Shadow</code> . <code>BaseFilter</code>    2D  ,        ,     <code>ImageFilter</code>   .              .  <code>Transform</code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code>Transform</code>  <code>Shadow</code> ,     ,   .  <code>Transform</code>   <code>imageWithTransform:transform</code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    16‚Äì8. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> 16‚Äì8.</b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     16‚Äì6.       <code>Shadow</code>     <code>Transform</code> , ,     ,  -    16‚Äì6.        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     16‚Äì10. <br> <br> <b> 16‚Äì10.</b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (void) endContext; @end</code> <br> <br> <code>BaseFilter</code>   ,       ,  16‚Äì11. <br> <br> <b> 16‚Äì11.</b> UIImage+BaseFilter.m <br> <code class="objectivec">#import "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS 4    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; if (NULL != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, NO, 0); else UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); return context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); return imageOut; } - (void) endContext { UIGraphicsEndImageContext(); } @end</code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz 2D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code>Transform</code> .  <code>Transform</code>    ,    <code>CGAffineTransform</code>     .      16‚Äì12. <br> <br> <b> 16‚Äì12.</b> UIImage+Transform.h <br> <code class="objectivec">@interface UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform; @end</code> <br> <br>    ,     16‚Äì13. <br> <br> <b> 16‚Äì13.</b> UIImage+Transform.m <br> <code class="objectivec">#import "UIImage+Transform.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, transform); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code>transform</code>     Quartz 2D, <code>CGContextConcatCTM(context, transform)</code> .  <code>transform</code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code>Transform</code> .  ,   ?      <code>Shadow</code>   ,   ,     16‚Äì14. <br> <br> <b> 16‚Äì14.</b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @end</code> <br> <br>  ,    <code>Transform</code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code>Transform</code> .   ,        16‚Äì15. <br> <br> <b> 16‚Äì15.</b> UIImage+Shadow.m <br> <code class="objectivec">#import "UIImage+Shadow.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>      ,   ,     Quartz 2D, <code>CGSizeMake (-25, 15)</code> ,        X  Y.       <code>CGContextSetShadow(context, offset, 20.0)</code> ,   Quartz 2D,   20.0,    .  ,     <code>addTranform:</code>  <code>Transform</code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     16‚Äì16. <br> <br> <b> 16‚Äì16.</b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image view //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>    ,      ,     16‚Äì8   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> <pre> <code class="hljs pgsql"><code class="objectivec"><code>initWithImageComponent:(id )component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span></b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self = [super initWithImageComponent:component]) { [self setTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsGetCurrentContext()</code> .       Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7</span></span>,    ,    Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b> ImageShadowFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "ImageShadowFilter.h" @implementation ImageShadowFilter - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>        ,      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span></b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   <span class="hljs-number"><span class="hljs-number">2</span></span>D-  ,  ‚Äì   .  ,    ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> . <code>BaseFilter</code>    <span class="hljs-number"><span class="hljs-number">2</span></span>D  ,        ,     <code>ImageFilter</code>   .              .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> ,     ,   .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>   <code>imageWithTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>       <code>Shadow</code>     <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , ,     ,  -    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span></b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>BaseFilter</code>   ,       ,  <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span></b> UIImage+BaseFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS <span class="hljs-number"><span class="hljs-number">4</span></span>    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, <span class="hljs-keyword"><span class="hljs-keyword">NO</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext { UIGraphicsEndImageContext(); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>    ,    <code>CGAffineTransform</code>     .      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.h <br> <code class="objectivec">@interface UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Transform.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>)</code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  ,   ?      <code>Shadow</code>   ,   ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span></b> UIImage+Shadow.h <br> @interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <br> <br>  ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .   ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span></b> UIImage+Shadow.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Shadow.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>      ,   ,     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>)</code> ,        X  Y.       <code>CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>)</code> ,   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D,   <span class="hljs-number"><span class="hljs-number">20.0</span></span>,    .  ,     <code>addTranform:</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span></b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>    ,      ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8</span></span>   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code></code> </pre> <code><code>initWithImageComponent:(id )component transform: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code>transform</code>    ,     16‚Äì6. <br> <br> <b> 16‚Äì6.</b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize transform=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component transform:(CGAffineTransform)transform { if (self = [super initWithImageComponent:component]) { [self setTransform:transform]; } return self; } - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @end</code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz 2D <code>UIGraphicsGetCurrentContext()</code> .       Quartz 2D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    16‚Äì7,    ,    Quartz 2D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        16‚Äì6. <br> <br> <b> 16‚Äì7.</b> ImageShadowFilter.m <br> <code class="objectivec">#import "ImageShadowFilter.h" @implementation ImageShadowFilter - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); } @end</code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     16‚Äì8. <br> <br> <b> 16‚Äì8.</b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image transform:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>        ,      16‚Äì6.   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     16‚Äì9. <br> <br> <b> 16‚Äì9.</b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (void)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     16‚Äì6. <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   2D-  ,  ‚Äì   .  ,    ,    16‚Äì7. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> 16‚Äì7.</b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (Transform)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code>Transform</code>  <code>Shadow</code> . <code>BaseFilter</code>    2D  ,        ,     <code>ImageFilter</code>   .              .  <code>Transform</code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code>Transform</code>  <code>Shadow</code> ,     ,   .  <code>Transform</code>   <code>imageWithTransform:transform</code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    16‚Äì8. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> 16‚Äì8.</b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     16‚Äì6.       <code>Shadow</code>     <code>Transform</code> , ,     ,  -    16‚Äì6.        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     16‚Äì10. <br> <br> <b> 16‚Äì10.</b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (void) endContext; @end</code> <br> <br> <code>BaseFilter</code>   ,       ,  16‚Äì11. <br> <br> <b> 16‚Äì11.</b> UIImage+BaseFilter.m <br> <code class="objectivec">#import "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS 4    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; if (NULL != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, NO, 0); else UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); return context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); return imageOut; } - (void) endContext { UIGraphicsEndImageContext(); } @end</code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz 2D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code>Transform</code> .  <code>Transform</code>    ,    <code>CGAffineTransform</code>     .      16‚Äì12. <br> <br> <b> 16‚Äì12.</b> UIImage+Transform.h <br> <code class="objectivec">@interface UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform; @end</code> <br> <br>    ,     16‚Äì13. <br> <br> <b> 16‚Äì13.</b> UIImage+Transform.m <br> <code class="objectivec">#import "UIImage+Transform.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, transform); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code>transform</code>     Quartz 2D, <code>CGContextConcatCTM(context, transform)</code> .  <code>transform</code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code>Transform</code> .  ,   ?      <code>Shadow</code>   ,   ,     16‚Äì14. <br> <br> <b> 16‚Äì14.</b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @end</code> <br> <br>  ,    <code>Transform</code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code>Transform</code> .   ,        16‚Äì15. <br> <br> <b> 16‚Äì15.</b> UIImage+Shadow.m <br> <code class="objectivec">#import "UIImage+Shadow.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>      ,   ,     Quartz 2D, <code>CGSizeMake (-25, 15)</code> ,        X  Y.       <code>CGContextSetShadow(context, offset, 20.0)</code> ,   Quartz 2D,   20.0,    .  ,     <code>addTranform:</code>  <code>Transform</code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     16‚Äì16. <br> <br> <b> 16‚Äì16.</b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image view //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>    ,      ,     16‚Äì8   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> <pre> <code class="hljs pgsql"><code>initWithImageComponent:(id )component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span></b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self = [super initWithImageComponent:component]) { [self setTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsGetCurrentContext()</code> .       Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7</span></span>,    ,    Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b> ImageShadowFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "ImageShadowFilter.h" @implementation ImageShadowFilter - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>        ,      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span></b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   <span class="hljs-number"><span class="hljs-number">2</span></span>D-  ,  ‚Äì   .  ,    ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> . <code>BaseFilter</code>    <span class="hljs-number"><span class="hljs-number">2</span></span>D  ,        ,     <code>ImageFilter</code>   .              .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> ,     ,   .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>   <code>imageWithTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>       <code>Shadow</code>     <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , ,     ,  -    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span></b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>BaseFilter</code>   ,       ,  <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span></b> UIImage+BaseFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS <span class="hljs-number"><span class="hljs-number">4</span></span>    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, <span class="hljs-keyword"><span class="hljs-keyword">NO</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext { UIGraphicsEndImageContext(); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>    ,    <code>CGAffineTransform</code>     .      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.h <br> <code class="objectivec">@interface UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Transform.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>)</code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  ,   ?      <code>Shadow</code>   ,   ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span></b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>  ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .   ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span></b> UIImage+Shadow.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Shadow.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>      ,   ,     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>)</code> ,        X  Y.       <code>CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>)</code> ,   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D,   <span class="hljs-number"><span class="hljs-number">20.0</span></span>,    .  ,     <code>addTranform:</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span></b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>    ,      ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8</span></span>   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> </pre> <code><code>initWithImageComponent:(id )component transform: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code>transform</code>    ,     16‚Äì6. <br> <br> <b> 16‚Äì6.</b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize transform=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component transform:(CGAffineTransform)transform { if (self = [super initWithImageComponent:component]) { [self setTransform:transform]; } return self; } - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @end</code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz 2D <code>UIGraphicsGetCurrentContext()</code> .       Quartz 2D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    16‚Äì7,    ,    Quartz 2D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        16‚Äì6. <br> <br> <b> 16‚Äì7.</b> ImageShadowFilter.m <br> <code class="objectivec">#import "ImageShadowFilter.h" @implementation ImageShadowFilter - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); } @end</code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     16‚Äì8. <br> <br> <b> 16‚Äì8.</b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image transform:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>        ,      16‚Äì6.   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     16‚Äì9. <br> <br> <b> 16‚Äì9.</b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (void)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     16‚Äì6. <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   2D-  ,  ‚Äì   .  ,    ,    16‚Äì7. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> 16‚Äì7.</b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (Transform)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code>Transform</code>  <code>Shadow</code> . <code>BaseFilter</code>    2D  ,        ,     <code>ImageFilter</code>   .              .  <code>Transform</code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code>Transform</code>  <code>Shadow</code> ,     ,   .  <code>Transform</code>   <code>imageWithTransform:transform</code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    16‚Äì8. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> 16‚Äì8.</b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     16‚Äì6.       <code>Shadow</code>     <code>Transform</code> , ,     ,  -    16‚Äì6.        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     16‚Äì10. <br> <br> <b> 16‚Äì10.</b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (void) endContext; @end</code> <br> <br> <code>BaseFilter</code>   ,       ,  16‚Äì11. <br> <br> <b> 16‚Äì11.</b> UIImage+BaseFilter.m <br> <code class="objectivec">#import "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS 4    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; if (NULL != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, NO, 0); else UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); return context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); return imageOut; } - (void) endContext { UIGraphicsEndImageContext(); } @end</code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz 2D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code>Transform</code> .  <code>Transform</code>    ,    <code>CGAffineTransform</code>     .      16‚Äì12. <br> <br> <b> 16‚Äì12.</b> UIImage+Transform.h <br> <code class="objectivec">@interface UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform; @end</code> <br> <br>    ,     16‚Äì13. <br> <br> <b> 16‚Äì13.</b> UIImage+Transform.m <br> <code class="objectivec">#import "UIImage+Transform.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, transform); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code>transform</code>     Quartz 2D, <code>CGContextConcatCTM(context, transform)</code> .  <code>transform</code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code>Transform</code> .  ,   ?      <code>Shadow</code>   ,   ,     16‚Äì14. <br> <br> <b> 16‚Äì14.</b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @end</code> <br> <br>  ,    <code>Transform</code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code>Transform</code> .   ,        16‚Äì15. <br> <br> <b> 16‚Äì15.</b> UIImage+Shadow.m <br> <code class="objectivec">#import "UIImage+Shadow.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>      ,   ,     Quartz 2D, <code>CGSizeMake (-25, 15)</code> ,        X  Y.       <code>CGContextSetShadow(context, offset, 20.0)</code> ,   Quartz 2D,   20.0,    .  ,     <code>addTranform:</code>  <code>Transform</code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     16‚Äì16. <br> <br> <b> 16‚Äì16.</b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image view //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>    ,      ,     16‚Äì8   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> <pre> <code class="hljs pgsql"><code>initWithImageComponent:(id )component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span></b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self = [super initWithImageComponent:component]) { [self setTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsGetCurrentContext()</code> .       Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7</span></span>,    ,    Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b> ImageShadowFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "ImageShadowFilter.h" @implementation ImageShadowFilter - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>        ,      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span></b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   <span class="hljs-number"><span class="hljs-number">2</span></span>D-  ,  ‚Äì   .  ,    ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> . <code>BaseFilter</code>    <span class="hljs-number"><span class="hljs-number">2</span></span>D  ,        ,     <code>ImageFilter</code>   .              .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> ,     ,   .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>   <code>imageWithTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>       <code>Shadow</code>     <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , ,     ,  -    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span></b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>BaseFilter</code>   ,       ,  <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span></b> UIImage+BaseFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS <span class="hljs-number"><span class="hljs-number">4</span></span>    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, <span class="hljs-keyword"><span class="hljs-keyword">NO</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext { UIGraphicsEndImageContext(); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>    ,    <code>CGAffineTransform</code>     .      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.h <br> <code class="objectivec">@interface UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Transform.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>)</code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  ,   ?      <code>Shadow</code>   ,   ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span></b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>  ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .   ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span></b> UIImage+Shadow.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Shadow.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>      ,   ,     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>)</code> ,        X  Y.       <code>CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>)</code> ,   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D,   <span class="hljs-number"><span class="hljs-number">20.0</span></span>,    .  ,     <code>addTranform:</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span></b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>    ,      ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8</span></span>   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> </pre> <code><code>initWithImageComponent:(id )component transform: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code>transform</code>    ,     16‚Äì6. <br> <br> <b> 16‚Äì6.</b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize transform=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component transform:(CGAffineTransform)transform { if (self = [super initWithImageComponent:component]) { [self setTransform:transform]; } return self; } - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @end</code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz 2D <code>UIGraphicsGetCurrentContext()</code> .       Quartz 2D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    16‚Äì7,    ,    Quartz 2D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        16‚Äì6. <br> <br> <b> 16‚Äì7.</b> ImageShadowFilter.m <br> <code class="objectivec">#import "ImageShadowFilter.h" @implementation ImageShadowFilter - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); } @end</code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     16‚Äì8. <br> <br> <b> 16‚Äì8.</b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image transform:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>        ,      16‚Äì6.   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     16‚Äì9. <br> <br> <b> 16‚Äì9.</b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (void)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     16‚Äì6. <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   2D-  ,  ‚Äì   .  ,    ,    16‚Äì7. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> 16‚Äì7.</b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (Transform)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code>Transform</code>  <code>Shadow</code> . <code>BaseFilter</code>    2D  ,        ,     <code>ImageFilter</code>   .              .  <code>Transform</code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code>Transform</code>  <code>Shadow</code> ,     ,   .  <code>Transform</code>   <code>imageWithTransform:transform</code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    16‚Äì8. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> 16‚Äì8.</b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     16‚Äì6.       <code>Shadow</code>     <code>Transform</code> , ,     ,  -    16‚Äì6.        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     16‚Äì10. <br> <br> <b> 16‚Äì10.</b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (void) endContext; @end</code> <br> <br> <code>BaseFilter</code>   ,       ,  16‚Äì11. <br> <br> <b> 16‚Äì11.</b> UIImage+BaseFilter.m <br> <code class="objectivec">#import "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS 4    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; if (NULL != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, NO, 0); else UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); return context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); return imageOut; } - (void) endContext { UIGraphicsEndImageContext(); } @end</code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz 2D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code>Transform</code> .  <code>Transform</code>    ,    <code>CGAffineTransform</code>     .      16‚Äì12. <br> <br> <b> 16‚Äì12.</b> UIImage+Transform.h <br> <code class="objectivec">@interface UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform; @end</code> <br> <br>    ,     16‚Äì13. <br> <br> <b> 16‚Äì13.</b> UIImage+Transform.m <br> <code class="objectivec">#import "UIImage+Transform.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, transform); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code>transform</code>     Quartz 2D, <code>CGContextConcatCTM(context, transform)</code> .  <code>transform</code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code>Transform</code> .  ,   ?      <code>Shadow</code>   ,   ,     16‚Äì14. <br> <br> <b> 16‚Äì14.</b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @end</code> <br> <br>  ,    <code>Transform</code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code>Transform</code> .   ,        16‚Äì15. <br> <br> <b> 16‚Äì15.</b> UIImage+Shadow.m <br> <code class="objectivec">#import "UIImage+Shadow.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>      ,   ,     Quartz 2D, <code>CGSizeMake (-25, 15)</code> ,        X  Y.       <code>CGContextSetShadow(context, offset, 20.0)</code> ,   Quartz 2D,   20.0,    .  ,     <code>addTranform:</code>  <code>Transform</code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     16‚Äì16. <br> <br> <b> 16‚Äì16.</b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image view //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>    ,      ,     16‚Äì8   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> <pre> <code class="hljs pgsql"><code class="objectivec"><code>initWithImageComponent:(id )component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span></b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self = [super initWithImageComponent:component]) { [self setTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsGetCurrentContext()</code> .       Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7</span></span>,    ,    Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b> ImageShadowFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "ImageShadowFilter.h" @implementation ImageShadowFilter - (<span class="hljs-type"><span class="hljs-type">void</span></span>) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>        ,      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">9.</span></span></b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span> <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   <span class="hljs-number"><span class="hljs-number">2</span></span>D-  ,  ‚Äì   .  ,    ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">7.</span></span></b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> . <code>BaseFilter</code>    <span class="hljs-number"><span class="hljs-number">2</span></span>D  ,        ,     <code>ImageFilter</code>   .              .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>  <code>Shadow</code> ,     ,   .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>   <code>imageWithTransform:<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8.</span></span></b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>       <code>Shadow</code>     <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , ,     ,  -    <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">6.</span></span>        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">10.</span></span></b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>BaseFilter</code>   ,       ,  <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">11.</span></span></b> UIImage+BaseFilter.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS <span class="hljs-number"><span class="hljs-number">4</span></span>    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, <span class="hljs-keyword"><span class="hljs-keyword">NO</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>) endContext { UIGraphicsEndImageContext(); } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code>    ,    <code>CGAffineTransform</code>     .      <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">12.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.h <br> <code class="objectivec">@interface UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">13.</span></span></b> UIImage+<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Transform.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (<span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span>) - (UIImage *) imageWithTransform:(CGAffineTransform)<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGContextConcatCTM(context, <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>)</code> .  <code><span class="hljs-keyword"><span class="hljs-keyword">transform</span></span></code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .  ,   ?      <code>Shadow</code>   ,   ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">14.</span></span></b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>  ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> .   ,        <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">15.</span></span></b> UIImage+Shadow.m <br> <code class="objectivec">#<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+Shadow.h" #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imageOut; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> <br> <br>      ,   ,     Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D, <code>CGSizeMake (<span class="hljs-number"><span class="hljs-number">-25</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>)</code> ,        X  Y.       <code>CGContextSetShadow(context, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, <span class="hljs-number"><span class="hljs-number">20.0</span></span>)</code> ,   Quartz <span class="hljs-number"><span class="hljs-number">2</span></span>D,   <span class="hljs-number"><span class="hljs-number">20.0</span></span>,    .  ,     <code>addTranform:</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">Transform</span></span></code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span> <br> <br> <b> <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">16.</span></span></b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / <span class="hljs-number"><span class="hljs-number">4.0</span></span>); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span>, image.size.height / <span class="hljs-number"><span class="hljs-number">8.0</span></span>); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:decoratorView]; }</code> <br> <br>    ,      ,     <span class="hljs-number"><span class="hljs-number">16</span></span>‚Äì<span class="hljs-number"><span class="hljs-number">8</span></span>   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow]; <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code></code> </pre> <code><code>initWithImageComponent:(id )component transform: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code>transform</code>    ,     16‚Äì6. <br> <br> <b> 16‚Äì6.</b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize transform=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component transform:(CGAffineTransform)transform { if (self = [super initWithImageComponent:component]) { [self setTransform:transform]; } return self; } - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @end</code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz 2D <code>UIGraphicsGetCurrentContext()</code> .       Quartz 2D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    16‚Äì7,    ,    Quartz 2D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        16‚Äì6. <br> <br> <b> 16‚Äì7.</b> ImageShadowFilter.m <br> <code class="objectivec">#import "ImageShadowFilter.h" @implementation ImageShadowFilter - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); } @end</code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     16‚Äì8. <br> <br> <b> 16‚Äì8.</b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image transform:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>        ,      16‚Äì6.   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     16‚Äì9. <br> <br> <b> 16‚Äì9.</b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (void)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     16‚Äì6. <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   2D-  ,  ‚Äì   .  ,    ,    16‚Äì7. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> 16‚Äì7.</b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (Transform)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code>Transform</code>  <code>Shadow</code> . <code>BaseFilter</code>    2D  ,        ,     <code>ImageFilter</code>   .              .  <code>Transform</code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code>Transform</code>  <code>Shadow</code> ,     ,   .  <code>Transform</code>   <code>imageWithTransform:transform</code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    16‚Äì8. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> 16‚Äì8.</b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     16‚Äì6.       <code>Shadow</code>     <code>Transform</code> , ,     ,  -    16‚Äì6.        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     16‚Äì10. <br> <br> <b> 16‚Äì10.</b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (void) endContext; @end</code> <br> <br> <code>BaseFilter</code>   ,       ,  16‚Äì11. <br> <br> <b> 16‚Äì11.</b> UIImage+BaseFilter.m <br> <code class="objectivec">#import "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS 4    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; if (NULL != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, NO, 0); else UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); return context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); return imageOut; } - (void) endContext { UIGraphicsEndImageContext(); } @end</code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz 2D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code>Transform</code> .  <code>Transform</code>    ,    <code>CGAffineTransform</code>     .      16‚Äì12. <br> <br> <b> 16‚Äì12.</b> UIImage+Transform.h <br> <code class="objectivec">@interface UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform; @end</code> <br> <br>    ,     16‚Äì13. <br> <br> <b> 16‚Äì13.</b> UIImage+Transform.m <br> <code class="objectivec">#import "UIImage+Transform.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, transform); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code>transform</code>     Quartz 2D, <code>CGContextConcatCTM(context, transform)</code> .  <code>transform</code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code>Transform</code> .  ,   ?      <code>Shadow</code>   ,   ,     16‚Äì14. <br> <br> <b> 16‚Äì14.</b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @end</code> <br> <br>  ,    <code>Transform</code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code>Transform</code> .   ,        16‚Äì15. <br> <br> <b> 16‚Äì15.</b> UIImage+Shadow.m <br> <code class="objectivec">#import "UIImage+Shadow.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>      ,   ,     Quartz 2D, <code>CGSizeMake (-25, 15)</code> ,        X  Y.       <code>CGContextSetShadow(context, offset, 20.0)</code> ,   Quartz 2D,   20.0,    .  ,     <code>addTranform:</code>  <code>Transform</code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     16‚Äì16. <br> <br> <b> 16‚Äì16.</b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image view //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>    ,      ,     16‚Äì8   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> <h4> <code><code>initWithImageComponent:(id )component transform: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code>transform</code>    ,     16‚Äì6. <br> <br> <b> 16‚Äì6.</b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize transform=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component transform:(CGAffineTransform)transform { if (self = [super initWithImageComponent:component]) { [self setTransform:transform]; } return self; } - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @end</code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz 2D <code>UIGraphicsGetCurrentContext()</code> .       Quartz 2D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    16‚Äì7,    ,    Quartz 2D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        16‚Äì6. <br> <br> <b> 16‚Äì7.</b> ImageShadowFilter.m <br> <code class="objectivec">#import "ImageShadowFilter.h" @implementation ImageShadowFilter - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); } @end</code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     16‚Äì8. <br> <br> <b> 16‚Äì8.</b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image transform:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>        ,      16‚Äì6.   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     16‚Äì9. <br> <br> <b> 16‚Äì9.</b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (void)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     16‚Äì6. <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   2D-  ,  ‚Äì   .  ,    ,    16‚Äì7. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> 16‚Äì7.</b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (Transform)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code>Transform</code>  <code>Shadow</code> . <code>BaseFilter</code>    2D  ,        ,     <code>ImageFilter</code>   .              .  <code>Transform</code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code>Transform</code>  <code>Shadow</code> ,     ,   .  <code>Transform</code>   <code>imageWithTransform:transform</code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    16‚Äì8. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> 16‚Äì8.</b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     16‚Äì6.       <code>Shadow</code>     <code>Transform</code> , ,     ,  -    16‚Äì6.        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     16‚Äì10. <br> <br> <b> 16‚Äì10.</b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (void) endContext; @end</code> <br> <br> <code>BaseFilter</code>   ,       ,  16‚Äì11. <br> <br> <b> 16‚Äì11.</b> UIImage+BaseFilter.m <br> <code class="objectivec">#import "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS 4    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; if (NULL != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, NO, 0); else UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); return context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); return imageOut; } - (void) endContext { UIGraphicsEndImageContext(); } @end</code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz 2D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code>Transform</code> .  <code>Transform</code>    ,    <code>CGAffineTransform</code>     .      16‚Äì12. <br> <br> <b> 16‚Äì12.</b> UIImage+Transform.h <br> <code class="objectivec">@interface UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform; @end</code> <br> <br>    ,     16‚Äì13. <br> <br> <b> 16‚Äì13.</b> UIImage+Transform.m <br> <code class="objectivec">#import "UIImage+Transform.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, transform); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code>transform</code>     Quartz 2D, <code>CGContextConcatCTM(context, transform)</code> .  <code>transform</code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code>Transform</code> .  ,   ?      <code>Shadow</code>   ,   ,     16‚Äì14. <br> <br> <b> 16‚Äì14.</b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @end</code> <br> <br>  ,    <code>Transform</code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code>Transform</code> .   ,        16‚Äì15. <br> <br> <b> 16‚Äì15.</b> UIImage+Shadow.m <br> <code class="objectivec">#import "UIImage+Shadow.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>      ,   ,     Quartz 2D, <code>CGSizeMake (-25, 15)</code> ,        X  Y.       <code>CGContextSetShadow(context, offset, 20.0)</code> ,   Quartz 2D,   20.0,    .  ,     <code>addTranform:</code>  <code>Transform</code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     16‚Äì16. <br> <br> <b> 16‚Äì16.</b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image view //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>    ,      ,     16‚Äì8   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> </h4> <code><code>initWithImageComponent:(id )component transform: (CGAffineTransform)tranform   ImageComponent</code>   <code>CGAffineTransform</code>   . <code>component</code>    <code>initWithComponent:</code>   <code>super</code> ,  <code>transform</code>    ,     16‚Äì6. <br> <br> <b> 16‚Äì6.</b> ImageTransformFilter.m <br> <code class="objectivec">@implementation ImageTransformFilter @synthesize transform=transform_; - (id) initWithImageComponent:(id &lt;ImageComponent&gt;)component transform:(CGAffineTransform)transform { if (self = [super initWithImageComponent:component]) { [self setTransform:transform]; } return self; } - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGContextConcatCTM(context, transform_); } @end</code> <br> <br>   <code>apply</code>    <code>CGContextRef</code>   Quartz 2D <code>UIGraphicsGetCurrentContext()</code> .       Quartz 2D .        ,    <code>transform_</code>  <code>CGContextConcatCTM()</code>     .        ,        <code>CGAffineTransform</code> .     . <br> <br>   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>      <code>ImageFilter</code>     <code>apply</code> .  ,    16‚Äì7,    ,    Quartz 2D <code>CGContextSetShadow()</code> ,   .     ,    <code>ImageTransformFilter</code> . ,    ,     ,        16‚Äì6. <br> <br> <b> 16‚Äì7.</b> ImageShadowFilter.m <br> <code class="objectivec">#import "ImageShadowFilter.h" @implementation ImageShadowFilter - (void) apply { CGContextRef context = UIGraphicsGetCurrentContext(); //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); } @end</code> <br> <br>           .  -      <code>DecoratorViewController</code> ,         <code>viewDidLoad</code> ,     16‚Äì8. <br> <br> <b> 16‚Äì8.</b>  viewDidLoad  DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,    id &lt;ImageComponent&gt; transformedImage = [[[ImageTransformFilter alloc] initWithImageComponent:image transform:finalTransform] autorelease]; id &lt;ImageComponent&gt; finalImage = [[[ImageShadowFilter alloc] initWithImageComponent:transformedImage] autorelease]; //   DecoratorView //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>        ,      16‚Äì6.   <code>CGAffineTransform</code>      .  ,       <code>ImageTransformFilter</code>   .     ,    <code>ImageShadowFilter</code> ,     ,   <code>ImageTransformFilter</code> .    <code>finalImage</code> ‚Äì   ,   <code>ImageTransformFilter</code> , <code>ImageShadowFilter</code>   .       <code>DecoratorView</code>  ,        <code>subview</code> . <code>DecoratorView</code>  ,       <code>drawRect:rect</code> ,     16‚Äì9. <br> <br> <b> 16‚Äì9.</b>  drawRect:rect  DecoratorView.m <br> <code class="objectivec">- (void)drawRect:(CGRect)rect { //  . [image_ drawInRect:rect]; }</code> <br> <br> <code>DecoratorView</code>      <code>UIImage</code>   <code>image_</code> .  <code>drawRect:rect</code>   <code>drawInRect:rect</code>  <code>image_</code>   <code>rect</code> .        . <code>ImageShadowFilter</code>   .  ,           <code>component_</code>   <code>forwardingTargetForSelector:</code> ,        <code>component_</code>   .    <code>component_</code> -    <code>ImageTransformFilter</code> ,       .     <code>forwardingTargetForSelector:</code>         <code>CGAffineTransform</code> .     <code>component_</code>  ,   <code>ImageShadowFilter</code> .        ,      <code>ImageTransformFilter</code>      ,     ,        .    ,        ,     16‚Äì6. <br> <br> :       . <br> <br>      ,  ,       .   ,   . <br> <br>      <br>  ,  ,        <code>UIImage</code>   ,         <code>UIImage</code> ,      .        Objective-C.     ,  -   2D-  ,  ‚Äì   .  ,    ,    16‚Äì7. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/c06/364/58e/c0636458ebeb00b4079a5b329b876d95.png" alt="image"> <br> <br> <b> 16‚Äì7.</b>     ,    UIImage <br> <br>     ,      .         - <code>UIImage (BaseFilter)</code> , <code>UIImage (Transform)</code>  <code>UIImage (Shadow)</code> .       <code>BaseFilter</code> , <code>Transform</code>  <code>Shadow</code> . <code>BaseFilter</code>    2D  ,        ,     <code>ImageFilter</code>   .              .  <code>Transform</code> ,  <code>Shadow</code>    <code>BaseFilter</code> ,     ,      ‚Äì  <code>UIImage</code> . ,   <code>BaseFilter</code> ,       <code>Transform</code>  <code>Shadow</code> ,     ,   .  <code>Transform</code>   <code>imageWithTransform:transform</code> ,      (   ),    ,    ,     .  <code>Shadow</code>   <code>imageWithDropShadow</code> ,               . ,   ,        ,   ,    .  ,   ,    16‚Äì8. <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/b0d/808/328/b0d8083289cb5de4023027792d0ef29f.png" alt="image"> <br> <br> <b> 16‚Äì8.</b>   ,   -     UIImage    <br> <br>    ‚Äì   ,  ,     16‚Äì6.       <code>Shadow</code>     <code>Transform</code> , ,     ,  -    16‚Äì6.        ,   ,     <code>self</code>           <code>component_</code> . <br> <br>    .     <code>BaseFilter</code> ,   ,         ,     16‚Äì10. <br> <br> <b> 16‚Äì10.</b> UIImage+BaseFilter.h <br> <code class="objectivec">@interface UIImage (BaseFilter) - (CGContextRef) beginContext; - (UIImage *) getImageFromCurrentImageContext; - (void) endContext; @end</code> <br> <br> <code>BaseFilter</code>   ,       ,  16‚Äì11. <br> <br> <b> 16‚Äì11.</b> UIImage+BaseFilter.m <br> <code class="objectivec">#import "UIImage+BaseFilter.h" @implementation UIImage (BaseFilter) - (CGContextRef) beginContext { //       //  iOS 4    UIGraphicsBeginImageContextWithOptions //    //    iOS  UIGraphicsBeginImageContext CGSize size = [self size]; if (NULL != UIGraphicsBeginImageContextWithOptions) UIGraphicsBeginImageContextWithOptions(size, NO, 0); else UIGraphicsBeginImageContext(size); CGContextRef context = UIGraphicsGetCurrentContext(); return context; } - (UIImage *) getImageFromCurrentImageContext { [self drawAtPoint:CGPointZero]; //  UIImage    UIImage *imageOut = UIGraphicsGetImageFromCurrentImageContext(); return imageOut; } - (void) endContext { UIGraphicsEndImageContext(); } @end</code> <br> <br> <code>beginContext</code> ‚Äì     ,     .      .     ,     . <br> <br> <code>getImageFromCurrentImageContext</code>             <code>UIGraphicsGetImageFromCurrentImageContext()</code> . <br> <br>   <code>endContext</code>     Quartz 2D <code>UIGraphicsEndImageContext()</code>   - . <br> <br>        . ,    , -   <code>Transform</code> .  <code>Transform</code>    ,    <code>CGAffineTransform</code>     .      16‚Äì12. <br> <br> <b> 16‚Äì12.</b> UIImage+Transform.h <br> <code class="objectivec">@interface UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform; @end</code> <br> <br>    ,     16‚Äì13. <br> <br> <b> 16‚Äì13.</b> UIImage+Transform.m <br> <code class="objectivec">#import "UIImage+Transform.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Transform) - (UIImage *) imageWithTransform:(CGAffineTransform)transform { CGContextRef context = [self beginContext]; //   CGContextConcatCTM(context, transform); //      UIImage *imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>    <code>CGAffineTransform</code> ,       .   <code>transform</code>     Quartz 2D, <code>CGContextConcatCTM(context, transform)</code> .  <code>transform</code>     .    <code>self</code>  <code>getImageFromCurrentImageContext</code> ,     <code>BaseFilter</code>    .  ,   <code>UIImage</code>   ,   <code>endContext</code>      ,   ,  . <br> <br>      <code>Transform</code> .  ,   ?      <code>Shadow</code>   ,   ,     16‚Äì14. <br> <br> <b> 16‚Äì14.</b> UIImage+Shadow.h <br> <code class="objectivec">@interface UIImage (Shadow) - (UIImage *) imageWithDropShadow; @end</code> <br> <br>  ,    <code>Transform</code> , <code>Shadow</code> ‚Äì    <code>UIImage</code> ,   .    ,       ,    <code>Transform</code> .   ,        16‚Äì15. <br> <br> <b> 16‚Äì15.</b> UIImage+Shadow.m <br> <code class="objectivec">#import "UIImage+Shadow.h" #import "UIImage+BaseFilter.h" @implementation UIImage (Shadow) - (UIImage *) imageWithDropShadow { CGContextRef context = [self beginContext]; //   CGSize offset = CGSizeMake (-25, 15); CGContextSetShadow(context, offset, 20.0); //      UIImage * imageOut = [self getImageFromCurrentImageContext]; [self endContext]; return imageOut; } @end</code> <br> <br>      ,   ,     Quartz 2D, <code>CGSizeMake (-25, 15)</code> ,        X  Y.       <code>CGContextSetShadow(context, offset, 20.0)</code> ,   Quartz 2D,   20.0,    .  ,     <code>addTranform:</code>  <code>Transform</code> ,    ,  <code>UIImag</code> e   . <br> <br>            <code>UIImag</code> e.     ?      <code>viewDidLoad</code>  <code>DecoratorViewController</code> ,     16‚Äì16. <br> <br> <b> 16‚Äì16.</b>  viewDidLoad   DecoratorViewController.m <br> <code class="objectivec">- (void)viewDidLoad { [super viewDidLoad]; //    UIImage *image = [UIImage imageNamed:@"Image.png"]; //   CGAffineTransform rotateTransform = CGAffineTransformMakeRotation(-M_PI / 4.0); CGAffineTransform translateTransform = CGAffineTransformMakeTranslation( -image.size.width / 2.0, image.size.height / 8.0); CGAffineTransform finalTransform = CGAffineTransformConcat(rotateTransform, translateTransform); // ,   //   UIImage *transformedImage = [image imageWithTransform:finalTransform]; //   id &lt;ImageComponent&gt; finalImage = [transformedImage imageWithDropShadow]; //   image view //    DecoratorView *decoratorView = [[[DecoratorView alloc] initWithFrame:[self.view bounds]] autorelease]; [decoratorView setImage:finalImage]; [self.view addSubview:decoratorView]; }</code> <br> <br>    ,      ,     16‚Äì8   .   ,  <code>imageWithTransform:</code> ,     ,         (  ).       <code>imageWithDropShadow</code> ,     ,            <code>finalImage</code> . <code>finalImage</code>    <code>imageView</code>    ,     .      : <br> <br> <code class="objectivec">finalImage = [[image imageWithTransform:finalTransform] imageWithDropShadow];</code> <br>    ,     ,  ,   ?  ‚Äì  <code>UIImage</code>    ‚Äì   ,    ,    .     ,   ,     ‚Äì   <code>UIImage</code> !   <code>ImageComponent</code>          ,    <code>UIImage</code>      .          . <br> <br>       .  ,           <code>UIImage</code>    .               . <br> <br> <b> Objective-C   </b> <br> <br>  ‚Äì    Objective-C,     (   )    .           .         . <br> <br>      ,       .      ;    ,    . ,   , -    ,  Objective-C    (     )     .           . <br> <br>    ,            ,          ,    .   <code>UIImag</code> e        ,       <code>self</code>  <code>UIImage</code> . <br> <br>  <br>              Objective-C.            . ,   ,    ,   .    ,         .            ,     .   ‚Äì          .                 <code>UIImage</code> . <br> <br>      ,   ,    .    .</code> </div><p>Source: <a href="https://habr.com/ru/post/212641/">https://habr.com/ru/post/212641/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../212631/index.html">This tiny chip makes the internet 4 times faster.</a></li>
<li><a href="../212633/index.html">To health! Wearable devices in sports and medicine</a></li>
<li><a href="../212635/index.html">The first open mass course of MIPT on the Coursera platform begins in 3 days</a></li>
<li><a href="../212637/index.html">A / B testing: time is nothing, animation is everything!</a></li>
<li><a href="../212639/index.html">Software Defined Network (SDN) based on Intel ONS open platform</a></li>
<li><a href="../212643/index.html">Sport and some linear equations</a></li>
<li><a href="../212645/index.html">Parking and IT: without gloss and embellishment</a></li>
<li><a href="../212649/index.html">In Japan, built energy storage of used batteries of electric vehicles</a></li>
<li><a href="../212651/index.html">Color organ installation "Baby-001"</a></li>
<li><a href="../212653/index.html">Decentralization: What services already exist?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>