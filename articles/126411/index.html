<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Virus analysis by example - investigating Trojan-Downloader.Win32.Zanoza.ab</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Have you ever thought about the fate of a virus caught by antivirus companies? What happens to him even before adding signatures to the database? More...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Virus analysis by example - investigating Trojan-Downloader.Win32.Zanoza.ab</h1><div class="post__text post__text-html js-mediator-article">  Have you ever thought about the fate of a virus caught by antivirus companies?  What happens to him even before adding signatures to the database?  More specifically, about virus analysis.  It may seem that doing a virus test yourself is difficult, unnecessary and dangerous, but in fact this is absolutely not the case.  Unnecessary skills will never hurt, and it is useful, sometimes, to look before launching what the executable file downloaded from the Internet is.  To start work, any knowledge of the assembler, debugger with disassembler and virtual machine will be suitable to choose from. <br><br>  Samples of viruses for analysis can, of course, be searched independently on the Internet, but for a start, we will go some other way.  A huge collection of viruses ready for analysis can be found at <a href="http://vx.netlux.org/">vx.netlux.org</a> .  The first virus I liked was Trojan-Downloader.Win32.Zanoza.ab.  His detailed analysis, we now deal with.  By the way, good descriptions of viruses can be viewed on the site securelist.com. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <habracut>  The first thing that catches your eye is the file size - just 1,901 bytes.  One might think that, due to its small size, the entire functionality of the virus will be clearly visible, but let's not hurry.  Make sure in any hex editor that the file is a Windows executable file (by MZ and PE signatures) and load it into any debugger-disassembler.  The picture opens is not joyful: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7dd/e52/27e/7dde5227ea6f1b6039df23d427f5bbce.jpg" alt="image"></div><br><br>  Not only are all sections and headers in one heap, the file is obviously packed with something.  Then you can go two ways.  The first is to manually trace the program until an entry point is detected and a further dump is taken (it is not recommended for a beginner).  The second is simpler - try to determine the program packer and unpack it automatically.  Let's go the second way.  Load the program in PIED: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/042/883/3d6/0428833d6d563e66b160d10f526e310b.jpg" alt="image"></div><br><br>  We were lucky, PIED successfully discovered the FSG packer.  Download any automatic FSG unpacker and successfully remove one layer of protection (for example, Unfsg2.0): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/591/cd6/a81/591cd6a81d8330a2840d2ca08f3a0b1a.jpg" alt="image"></div><br><br>  Again, load the program into the debugger-disassembler.  We will see another layer of protection: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/873/73f/06b/87373f06bee01a943184667f22eb72ac.jpg" alt="image"></div><br><br>  Yes, gaze opened to complete nonsense.  However, you can be sure that we are on the right track.  This is a completely normal executable code, only slightly obfuscated.  And badly obfuscated: smooth, the code is simply diluted by nothing doing nop commands and meaning nothing push reg and pop reg.  Scroll the program down a bit and see the main decryption loop: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a8d/110/dfd/a8d110dfd129dd55541bd4e4303469ff.jpg" alt="image"></div><br><br>  We trace the program to this place: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fd3/a56/d37/fd3a56d37d2ab1314326410d6f8b543f.jpg" alt="image"></div><br><br>  And we get to the already completely decoded program code (do not forget to update the debugger window in order to display the commands correctly): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1a6/ba7/6d2/1a6ba76d294e09e0d9da912222dc5674.jpg" alt="image"></div><br><br>  Now remove the resulting dump with any tool available to you.  Finally, we discovered some functionality of the virus: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/002/ea5/b86/002ea5b86d74073456e78e6422ab93b9.jpg" alt="image"></div><br><br>  Here begins the direct analysis.  The first thing to do when the virus starts is the procedure located at 0x401128.  It is easy to guess that this function creates a batch file with the name "c.bat", with the following content: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/393/c8b/32c/393c8b32cd3bb58749f472e6f042355f.jpg" alt="image"></div><br><br>  Go ahead.  After creating a bat-file, the program launches it for execution.  An endless loop of attempts to delete chkdsk * .exe files starts, as well as the source file itself, the path to which was carefully passed to the script via a command line parameter.  We will see on the screen a set of successive console windows.  Now comes the fun part.  The virus generates a child process svhost.exe in the suspended state and writes into it a code of 764 bytes in size, located at the offset 0x401180.  Obviously, the svhost.exe executable file was chosen in order to bypass some not very intelligent firewalls and antiviruses, as well as to prevent the user from accidentally ending the running virus process.  Where does the virus inject?  The programmer decided not to strain too much and simply overwritten the code pointed to by the entry point of the executable file.  How did he determine the right address?  The virus tritely loaded the svhost.exe image into its address space with the LoadLibraryEx function.  And after that, it was already easy to determine the desired address from the standard offsets of the Windows executable file (this section of the code is located at 0x4010A6 - 0x4010AC).  So, the injection is implemented and this executable file needs only to transfer the baton to the suspended schost.exe process.  The question arises, how to investigate an infected process?  You can, of course, manually select the necessary code and then analyze it separately, but at the same time its functionality and performance can suffer greatly.  I did not think long and decided to run all this on a virtual machine and skip svchost.exe while it is running.  So, we trace the main program before calling ResumeThread, open ProcessExplorer: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b33/551/f10/b33551f101ff8b27839140e59eefec2f.jpg" alt="image"></div><br><br>  And we find the PID of the process we need (in principle, it was possible to recognize the PID even in the debugger, but oh well).  We translate 1356 out of 10 into the 16-hereditary system, we get 0x54C.  Next, run LordPE and try to remove the dump from the process: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fc0/431/2f6/fc04312f635a3f288218a7b777f06d07.jpg" alt="image"></div><br><br>  We see that we do not have enough rights for this action due to the fact that the process is already being debugged by another program.  Because  we work in a virtual machine environment, then you can simply continue with the main program, and then easily remove the dump we need.  Attention!!!  This step is done at your own risk!  Everything went smoothly for me, and I got the infected svhost.exe file ready for analysis: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/db3/8e5/8b8/db38e58b8d81eb613d873ce0be308c8f.jpg" alt="image"></div><br><br>  We again see the decryption cycle: <br><br>  XOR BYTE PTR DS: [EBX-5], 0xB1 <br>  INC EBX <br>  LOOPD SHORT 0x100251D <br><br>  If you run this program for execution, it will crash with an error, because  no entry in the code section.  Let's think a bit: once the dump was taken from the process during operation, the decryption cycle has already been completed.  And now when you start the program will try to encrypt themselves already.  We do not need this, so for further analysis we will burst the entire decryption cycle.  At this point, we are much advanced, is not it?  We trace further in the virtual machine: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/11f/d65/ac7/11fd65ac7f3f7f9df7503713a9975d28.jpg" alt="image"></div><br><br>  We see the cycle located at the address 0x10255C-0x1002587.  Its purpose is to determine addresses of functions that are vital for the operation of WinAPI code.  The very comparison of names occurs in this place: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/990/8f6/e52/9908f6e5257b2d5491befb842db63f8d.jpg" alt="image"></div><br><br>  After determining the necessary addresses of WinAPI functions, we encounter another layer of protection.  The infected program calls the VirtualAlloc function to allocate an additional area of ‚Äã‚Äãmemory into which another layer of malicious code is copied, to which control is transferred using the JMP EAX command: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6f5/42b/9e5/6f542b9e52d14f4fe4c14ddd6b8c23b0.jpg" alt="image"></div><br><br>  Finally, we opened the actual functionality of the virus.  The malicious code loads the standard dynamic library ‚Äúurlmon.dll‚Äù to use the URLDownlodToFile function, after which it is used to directly load the chkdsk * .exe files.  Here is the moment of file upload: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/43d/453/089/43d45308915ba408663061910516b022.jpg" alt="image"></div><br><br>  This is where the loaded file is executed: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c1a/67e/251/c1a67e2515a99553e5ac644171a58a64.jpg" alt="image"></div><br><br>  And here is the completion of the process: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/db3/0cd/154/db30cd15460303c4137016fbc2f06f53.jpg" alt="image"></div><br><br>  We also note interesting links for further analysis: <br><br>  00270204 68 74 74 70 3A 2F 2F 77 77 77 2E 79 76 6F 6E 2D <a href="http://www.yvon-/">www.yvon-</a> <br>  00270214 70 75 62 6C 69 63 69 64 61 64 2E 63 6F 6D 2F 69 publicidad.com/i <br>  00270224 6D 61 67 65 73 2F 69 6D 61 67 65 73 2E 70 68 70 mages / images.php <br>  00270234 3F 77 3D 31 26 65 3D 32 00 68 74 74 70 3A 2F 2F? W = 1 &amp; e = 2.http: // <br>  00270244 77 77 77 2E 79 76 6F 6E 2D 70 75 62 6C 69 63 69 <a href="http://www.yvon-publici/">www.yvon-publici</a> <br>  00270254 64 61 64 2E 63 6F 6D 2F 69 6D 61 67 65 73 2F 69 dad.com/images/i <br>  00270264 6D 61 67 65 73 2E 70 68 70 3F 77 3D 32 26 65 3D mages.php? W = 2 &amp; e = <br>  00270274 32 00 68 74 74 70 3A 2F 2F 77 77 77 2E 79 76 6F 2.http: //www.yvo <br>  00270284 6E 2D 70 75 62 6C 69 63 69 64 61 64 2E 63 6F 6D n-publicidad.com <br>  00270294 2F 69 6D 61 67 65 73 2F 69 6D 61 67 65 73 2E 70 /images/images.p <br>  002702A4 68 70 3F 77 3D 33 26 65 3D 32 00 68 74 74 70 3A hp? W = 3 &amp; e = 2.http: <br>  002702B4 2F 2F 77 77 77 2E 79 76 6F 6E 2D 70 75 62 6C 69 //www.yvon-publi <br>  002702C4 63 69 64 61 64 2E 63 6F 6D 2F 69 6D 61 67 65 73 cidad.com/images <br>  002702D4 2F 69 6D 61 67 65 73 2E 70 68 70 3F 77 3D 34 26 /images.php?w=4&amp; <br><br>  Time to take stock: the program being analyzed without the user's knowledge downloads files of unknown content from the Internet and launches them for execution.  That's all that this malware can do, so it can be classified as Trojan-Downloader.  As you can see, malware analysis was not so difficult, although we were faced with a fairly large number of protection layers.  Good luck with your virus analysis! </habracut></div><p>Source: <a href="https://habr.com/ru/post/126411/">https://habr.com/ru/post/126411/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../126405/index.html">Samsung hired the founder of CyanogenMod</a></li>
<li><a href="../126407/index.html">Customer Response Solutions: extension dial</a></li>
<li><a href="../126408/index.html">What is wrong with Windows Phone 7?</a></li>
<li><a href="../126409/index.html">Multiple CSRF vulnerabilities in the largest portals of the Runet</a></li>
<li><a href="../126410/index.html">Building positioning systems for mobile services</a></li>
<li><a href="../126412/index.html">Synchronization of LanBilling and RTU class 4 & 5 account status</a></li>
<li><a href="../126415/index.html">Cluster systems</a></li>
<li><a href="../126416/index.html">Results of the competition Part 3. Quiz</a></li>
<li><a href="../126417/index.html">Social graph</a></li>
<li><a href="../126418/index.html">How to avoid collisions when writing to Memcache from PHP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>