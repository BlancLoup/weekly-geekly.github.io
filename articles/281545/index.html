<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The condition is</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello again, Habrovchane! In the last article I talked about the teams and how to use them, but today I will develop the topic and tell you how to tie...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The condition is</h1><div class="post__text post__text-html js-mediator-article">  Hello again, Habrovchane!  In the <a href="https://habrahabr.ru/post/280306/">last article</a> I talked about the teams and how to use them, but today I will develop the topic and tell you how to tie the team to the state machine.  The topic on Habr√© is not new, so I will not delve into explaining what a state machine is and why it is used, but focus on implementation.  Immediately, I‚Äôll make a reservation that for understanding it‚Äôs better to read the previous article, because the teams will be used as states without any changes.  Before starting, I want to say thanks to <a href="https://habrahabr.ru/users/onionfan/" class="user_link">OnionFan</a> for his comment - not all habits are good and his question allowed us to make typing finite automata more convenient, about which I will tell, simply by adding the params keyword (I corrected in the previous article). <br><a name="habracut"></a><br>  <b>Problem</b> <br>  In the comments to the previous article, there was a thought that the example was not chosen very well and not everyone took it seriously, so now, having a little thought, I decided to choose an example with a more practical tinge.  And so, today's example will be a little higher level and will relate to the game process, and more specifically to the states through which most game scenes pass. <br>  Offhand, you can immediately name at least three stages through which each game scene passes without fail: initialization of resources and models, the game state itself (it can be divided into several different states if, for example, there is a change in game mechanics or there is a cut scene) and the state of completion of the game (save progress and release resources).  I have often seen situations when it was solved either through the quortenants in the manager, who postponed the call of certain methods, or through fine-tuning the call order of the Awake () method through the editor, or simply in each Update () the scene was checked.  But, as it would have been easy to guess, I will offer you a method that is much nicer and more elegant with the use of finite automata.  Already at this stage, you can easily notice that each stage can be formed as a team (in which you can even use subcommands) and move on to the next stage only after the full completion of the current one.  And we will immediately agree that the states will be typed commands, since they will almost always need access to the controller.  Let's write the code, and then somehow a lot of water. <br>  Let's start with a simple, but already typed, state machine class. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">StateMachine</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">T</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> T _stateMachineController; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Command _currentState; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StateMachine</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T stateMachineController</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._stateMachineController = stateMachineController; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TCommand ApplyState&lt;TCommand&gt; (<span class="hljs-keyword"><span class="hljs-keyword">params</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] args) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TCommand : CommandWithType&lt;T&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_currentState != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) _currentState.Terminate (); _currentState = Command.ExecuteOn&lt;TCommand&gt; (_stateMachineController.gameObject, _stateMachineController, args); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _currentState <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TCommand; } }</code> </pre> <br></div></div><br>  Nothing unusual: we stop the previous state if there is one, start a new one on the controller's object, remember it as the current one and return it just in case. <br><div class="spoiler">  <b class="spoiler_title">Now the controller</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SceneController</span></span> : <span class="hljs-title"><span class="hljs-title">StateMachineHolder</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> StateMachine&lt;SceneController&gt; StateMachine { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SceneController</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { StateMachine = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StateMachine&lt;SceneController&gt; (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { StateMachine.ApplyState&lt;InitializeState&gt; (); } }</code> </pre><br></div></div><br>  Again, everything is simple: a public get-er for the object of the machine and the transition to the initialization state in Start ().  Thus, the Start () controller became the entry point into the scene, which gives full confidence in the correct sequence of calls of all states. <br>  And immediately a blank for the state of the scene and almost empty classes of the first two states: <br><div class="spoiler">  <b class="spoiler_title">You can not even watch</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SceneState</span></span>: <span class="hljs-title"><span class="hljs-title">CommandWithType</span></span>&lt;<span class="hljs-title"><span class="hljs-title">SceneController</span></span>&gt; { } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">InitializeState</span></span> : <span class="hljs-title"><span class="hljs-title">SceneState</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnStart</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnStart (args); <span class="hljs-comment"><span class="hljs-comment">//test UnityEngine.Debug.Log(string.Format("{0}", "Initialize state")); Controller.StateMachine.ApplyState&lt;ReadyState&gt; (); } } class ReadyState : SceneState { protected override void OnStart (object[] args) { base.OnStart (args); //test UnityEngine.Debug.Log(string.Format("{0}", "ready state")); } }</span></span></code> </pre><br></div></div><br>  It is easy to believe that the game state with this approach will start to be executed only after the initialization is fully completed, which is what we wanted. <br><br>  <b>Somehow it turned out a little</b> <br>  No brainer that the game states themselves can not be as simple as in the examples above.  For example, in the game state, you need to count points, update the state of the UI, create opponents and coins, move the camera and the like.  And if we write all this code right in the game state class, then why am I here? <br>  Take for example scoring.  For this we will write a separate command and we will launch it in the game state (until we are not familiar with MVC, we will write the account directly to the controller). <br><div class="spoiler">  <b class="spoiler_title">Primitive counting</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UpdateScoreCommand</span></span> : <span class="hljs-title"><span class="hljs-title">SceneState</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnStart</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnStart (args); StartCoroutine (UpdateScore()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateScore</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!IsRunning) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">yield</span></span></span><span class="hljs-function"> return new </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WaitForSeconds</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span></span><span class="hljs-function">)</span></span>; Controller.Score++; } } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Game state</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ReadyState</span></span> : <span class="hljs-title"><span class="hljs-title">SceneState</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UpdateScoreCommand _updateScoreCommand; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnStart</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnStart (args); <span class="hljs-comment"><span class="hljs-comment">//test UnityEngine.Debug.Log(string.Format("{0}", "ready state")); _updateScoreCommand = Command.ExecuteOn&lt;UpdateScoreCommand&gt; (Controller.gameObject, Controller); } protected override void OnReleaseResources () { base.OnReleaseResources (); _updateScoreCommand.Terminate (); } }</span></span></code> </pre><br></div></div><br>  I am already confused by the cumbersome start of the counting command compared to the launch of the state.  Also, the need to constantly keep all references to all the running commands at least depresses me and clutters up the state class.  Of course, links to some teams will have to be kept, but in the case of scoring, the team should simply work until the end of the game state and stop executing at the moment of transition of states in order not to overcharge.  You can easily force the state machine itself to follow such commands, telling it to simply stop all the commands launched from the state at the end of it.  Let's take this responsibility on him: <br><div class="spoiler">  <b class="spoiler_title">StateMachine vol.</b>  <b class="spoiler_title">2.0</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">StateMachine</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">T</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> T _stateMachineController; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Command _currentState; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;CommandWithType&lt;T&gt;&gt; _commands; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StateMachine</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T stateMachineController</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._stateMachineController = stateMachineController; _commands = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;CommandWithType&lt;T&gt;&gt; (); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TCommand ApplyState&lt;TCommand&gt; (<span class="hljs-keyword"><span class="hljs-keyword">params</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] args) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TCommand : CommandWithType&lt;T&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_currentState != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) _currentState.Terminate (<span class="hljs-literal"><span class="hljs-literal">true</span></span>); StopAllCommands (); _currentState = Command.ExecuteOn&lt;TCommand&gt; (_stateMachineController.gameObject, _stateMachineController, args); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _currentState <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TCommand; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TCommand Execute&lt;TCommand&gt; (<span class="hljs-keyword"><span class="hljs-keyword">params</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] args) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TCommand : CommandWithType&lt;T&gt; { TCommand command = Command.ExecuteOn&lt;TCommand&gt; (_stateMachineController.gameObject, _stateMachineController, args); _commands.Add (command); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> command <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TCommand; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StopAllCommands</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; _commands.Count; i++) { _commands [i].Terminate (); } } }</code> </pre><br></div></div><br>  Now the ApplyState () method will be used to start the states, and the Execute () method to run the commands in this state and at the completion of the states, we will automatically end all running commands.  And it made a much nicer call for auxiliary commands. <br><div class="spoiler">  <b class="spoiler_title">Call subcommands</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ReadyState</span></span> : <span class="hljs-title"><span class="hljs-title">SceneState</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnStart</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnStart (args); <span class="hljs-comment"><span class="hljs-comment">//test UnityEngine.Debug.Log(string.Format("{0}", "ready state")); Controller.StateMachine.Execute&lt;UpdateScoreCommand&gt; (); } }</span></span></code> </pre><br></div></div><br>  Now, the auxiliary commands can be simply launched and forgotten, the machine gun will remember them when the time comes. <br>  Everything turned out simply and beautifully, the minimum attention needs to be paid to the management of calls and command stops and everything is guaranteed to take place at the right moment. <br><br>  <b>Small pleasures</b> <br>  The state machine is completely ready to use, it remains only to tell about one small convenience.  With this implementation, state transitions should be written in the states themselves and this is very convenient for branching or decision making systems.  But there are situations where the state tree may not be very complex and, in this case, it is convenient to register the entire chain of states in one place. <br>  Before adding this feature, let's remember that a state is nothing but a command, and a team in our implementation can have two outcomes: successful and not successful execution.  This is quite enough to build simple trees of behavior and even with the possibility of looping (shoot, reload, shoot and then ask who it is). <br>  Due to the method of invoking a command, we cannot immediately make instances of all the commands we need and use them when necessary.  Therefore, let us dwell on the fact that we will store the entire chain (or tree) in the form of a list of types of necessary commands.  But for starters, such a system will have to slightly correct the class of the team so that it has not only a typed method of calling, but also a method in which you can pass the type of the command you need and the flag for the success of the command completion. <br><div class="spoiler">  <b class="spoiler_title">I will give only changes in the team</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> FinishResult { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> T ExecuteOn&lt;T&gt;(GameObject target, <span class="hljs-keyword"><span class="hljs-keyword">params</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] args) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : Command { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ExecuteOn (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T), target, args) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> T; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Command </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExecuteOn</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type type, GameObject target, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { Command command = (Command)target.AddComponent (type); command._args = args; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> command; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FinishCommand</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> result = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">true</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!IsRunning) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; OnReleaseResources (); OnFinishCommand (); FinishResult = result; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result) CallbackToken.FireSucceed (); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> CallbackToken.FireFault (); Destroy (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-number"><span class="hljs-number">1f</span></span>); }</code> </pre><br></div></div><br>  There is nothing to explain, because I will not.  Now let's write a container that will contain the type of the target command and the type of the following commands for cases with successful and not successful completion of the target: <br><div class="spoiler">  <b class="spoiler_title">Steam container</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CommandPair</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Type TargetType; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Type SuccesType; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Type FaultType; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CommandPair</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type targetType, Type succesType, Type faultType</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.TargetType = targetType; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SuccesType = succesType; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.FaultType = faultType; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CommandPair</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type targetType, Type succesType</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.TargetType = targetType; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SuccesType = succesType; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.FaultType = succesType; }</code> </pre><br></div></div><br>  Note that if only one type of the following command is passed to the constructor, there will be no branching and the command of the appropriate type will be called for any outcome of the target command. <br>  Now the queue goes to the container of our pairs: <br><div class="spoiler">  <b class="spoiler_title">Container Container</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CommandFlow</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;CommandPair&gt; _commandFlow; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CommandFlow</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._commandFlow = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;CommandPair&gt;(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddCommandPair</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CommandPair commandPair</span></span></span><span class="hljs-function">)</span></span> { _commandFlow.Add (commandPair); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Type </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNextCommand</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Command currentCommand</span></span></span><span class="hljs-function">)</span></span> { CommandPair nextPair = _commandFlow.FirstOrDefault (pair =&gt; pair.TargetType.Equals (currentCommand.GetType ())); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nextPair == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentCommand.FinishResult) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> nextPair.SuccesType; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> nextPair.FaultType; } }</code> </pre><br></div></div><br>  In addition to storing pairs of commands in itself, this container will still search for the next registered state according to the current one.  It remains only to tie our execution order to the finite state machine so that it itself can change states. <br><div class="spoiler">  <b class="spoiler_title">StateMachine vol.</b>  <b class="spoiler_title">3.0</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">StateMachine</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">T</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> T _stateMachineController; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> CommandFlow _commandFlow; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Command _currentState; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;CommandWithType&lt;T&gt;&gt; _commands; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StateMachine</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T stateMachineController</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._stateMachineController = stateMachineController; _commands = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;CommandWithType&lt;T&gt;&gt; (); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StateMachine</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T _stateMachineController, CommandFlow _commandFlow</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._stateMachineController = _stateMachineController; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._commandFlow = _commandFlow; _commands = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;CommandWithType&lt;T&gt;&gt; (); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TCommand ApplyState&lt;TCommand&gt; (<span class="hljs-keyword"><span class="hljs-keyword">params</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] args) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TCommand : CommandWithType&lt;T&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ApplyState (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(TCommand), args) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TCommand; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Command </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ApplyState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type type, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_currentState != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) _currentState.Terminate (<span class="hljs-literal"><span class="hljs-literal">true</span></span>); StopAllCommands (); _currentState = Command.ExecuteOn (type ,_stateMachineController.gameObject, _stateMachineController, args); _currentState.CallbackToken.AddCallback (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Callback&lt;Command&gt;(OnStateFinished, OnStateFinished)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _currentState; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnStateFinished</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Command command</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_commandFlow == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; Type nextCommand = _commandFlow.GetNextCommand (command); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nextCommand != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) ApplyState (nextCommand); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TCommand Execute&lt;TCommand&gt; (<span class="hljs-keyword"><span class="hljs-keyword">params</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] args) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TCommand : CommandWithType&lt;T&gt; { TCommand command = Command.ExecuteOn&lt;TCommand&gt; (_stateMachineController.gameObject, _stateMachineController, args); _commands.Add (command); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> command <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TCommand; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StopAllCommands</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; _commands.Count; i++) { _commands [i].Terminate (); } } }</code> </pre><br></div></div><br>  Let the machine itself keep the sequence in itself and change the state itself as we indicate to it, but leave the opportunity to start it without the sequence prepared earlier. <br>  Now it remains to learn how to use it all: <br><div class="spoiler">  <b class="spoiler_title">Using</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SceneController</span></span> : <span class="hljs-title"><span class="hljs-title">StateMachineHolder</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Score = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> StateMachine&lt;SceneController&gt; StateMachine { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SceneController</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { CommandFlow commandFlow = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CommandFlow (); commandFlow.AddCommandPair (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CommandPair(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(InitializeState), <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ReadyState), <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(OverState))); StateMachine = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StateMachine&lt;SceneController&gt; (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, commandFlow); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { StateMachine.ApplyState&lt;InitializeState&gt; (); } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">InitializeState</span></span> : <span class="hljs-title"><span class="hljs-title">SceneState</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnStart</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnStart (args); <span class="hljs-comment"><span class="hljs-comment">//test UnityEngine.Debug.Log(string.Format("{0}", "Initialize state")); FinishCommand (Random.Range (0, 100) &lt; 50); } }</span></span></code> </pre><br></div></div><br>  Voila!  Now, for convenient use of state branching, we only need to register a sequence of commands, transfer it to the state machine and run the first state, then everything will happen without our participation.  Now the topic is fully disclosed.  After all that was written, we got a good, flexible and easy-to-manage state machine.  Thanks for attention. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/281545/">https://habr.com/ru/post/281545/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../281533/index.html">Post nostalgia: how we started Acronis at MIPT and in the attic of the upper-air observatory</a></li>
<li><a href="../281535/index.html">What is ‚Äúpatreon.com‚Äù and what you need to know about it</a></li>
<li><a href="../281537/index.html">A tool to quickly find scenes in video files</a></li>
<li><a href="../281539/index.html">HoloLens, Xbox One Dev Mode and developer opportunities from the conference // Build</a></li>
<li><a href="../281543/index.html">The development of cloud technology and robotics in the new decade</a></li>
<li><a href="../281547/index.html">Regular expressions search with regular expressions</a></li>
<li><a href="../281549/index.html">Creating a simple game based on FPGA</a></li>
<li><a href="../281551/index.html">Top 5 reports from the Mobius 2015 Mobile Development Conference</a></li>
<li><a href="../281553/index.html">Fragility of data warehousing architecture</a></li>
<li><a href="../281555/index.html">How we did the Winter Internship on iOS- and Android-development in Redmadrobot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>