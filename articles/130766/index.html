<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Request spec in Action</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Testing has become an integral part of any software product development, be it an application for a desktop computer, mobile device or web. Already no...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Request spec in Action</h1><div class="post__text post__text-html js-mediator-article">  Testing has become an integral part of any software product development, be it an application for a desktop computer, mobile device or web.  Already no one denies the importance of this stage and the consequences that its absence will bring.  Among them are a lot of time checking every element (page), and unexpected surprises in the behavior of the product, increasing the cost of fixing the program.  The principle of writing tests is quite simple - "yellow color", "red color", "green color", refactoring.  Where yellow is not a created test (pending), red is not a passed test, and green is for the system to work as it should. <br><br>  For each type of programming, there are many types of testing.  But there are common points present everywhere.  Since the main kind of my work is the creation of web applications under ROR, let's talk about the features of testing application data. <br><br><a name="habracut"></a><br><h5>  Environment setup </h5>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      You can find many test environments (Test Unit, Rspec, Cucumber &amp; etc), but I personally use Rspec myself.  It allows you to give the tests a beautiful view, but at the same time preserve the appearance of the code.  Add a new group to the gemfile: <br><br> <code>group :development, :test do <br> gem "rspec-rails", "&gt;= 2.5" <br> end</code> <br> <br>  You may be surprised and ask: ‚ÄúWhy add rspec in development mode?‚Äù Everything is quite simple - rspec adds the corresponding specs when generating model, controller, scaffold.  Having installed gem, we will carry out the last installation command: <br><br> <code>rails g rspec:install</code> <br> <br>  Now we can run our tests with the rake rspec command.  The negative side of this approach is that with the slightest change in our project, we will have to perform this command again and again, which will run absolutely all tests.  From this it follows that it is necessary to find some watcher so that instead of us he performs the necessary commands.  At the moment I know about two quite good solutions - autotest and guard.  Autotest came to rails from other frameworks, having proved itself well, and I used only it before.  But recently I met a charming solution in the form of guard.  By itself, the guard does not carry the necessary functionality, but when used with add-ons, it turns out to be a very smart thing.  These additions have about 2 dozen guards, and they carry tremendous opportunities.  However, let us dwell on one thing - guard-rspec.  Install the necessary files: <br><br> <code>group :test do <br> gem 'guard-rspec' <br> end</code> <br> <br>  Execute the initialization command: <br><br> <code>guard init . <br> guard init rspec</code> <br> <br>  The first will create a guardfile (observer configuration file), the second will add rspec-specific actions.  Now, with the guard command, the watcher works for you, ready to pull the required spec at any time.  But the log of this solution is quite boring, so we will add some colors to it.  First, install the notification library.  And here we are faced with the first problems - you have a different OS with a partner (Mac OS and Linux), and everyone needs to be tested.  The solution for us was the following solution: <br><br> <code>gem 'libnotify' , :require =&gt; false if RUBY_PLATFORM =~ /linux/i <br> gem 'rb-inotify', :require =&gt; false if RUBY_PLATFORM =~ /linux/i <br> gem 'rb-fsevent', :require =&gt; false if RUBY_PLATFORM =~ /darwin/i</code> <br> <br>  Next, replace all points in rspec with a percentage calculation: <br><br> <code>gem 'fuubar'</code> <br> <br>  And finally, in the Guardfile we write the following: <br><br> <code>guard 'rspec', :cli =&gt;'--format Fuubar --color'</code> <br> <br>  Run the tests.  In the console we get a beautiful progress bar, and at the end of the test - a pop-up window. <br><br>  The next step to set up a test environment is to make our tests clean.  After all, no one wants to, when performing tests, we come across values ‚Äã‚Äãand records in the database from previous checks.  A good choice is gem database_cleaner.  Its configuration is shown below: <br><br> <code>config.before(:suite) do <br> DatabaseCleaner.strategy = :truncation <br> end <br> <br> config.before(:each) do <br> DatabaseCleaner.start <br> end <br> <br> config.after(:each) do <br> DatabaseCleaner.clean <br> end</code> <br> <br>  After setting up the cleaner, it's nice to talk about creating testable content.  Rspec suggests using mock-i, but personally I prefer to generate real objects.  You can use machinist or factory_girl to create various objects.  I don‚Äôt know much about machinist, so I can‚Äôt say anything about it.  But I have been working with factory_girl for a long time, and I never caused any complaints about the gem.  Add our gems to the test group: <br><br> <code>group :test do <br> gem 'guard_rspec' <br> gem 'factory_girl_rails' <br> gem 'database_cleaner' <br> end</code> <br> <br>  The rest of the use I propose to consider outside this article by <a href="https://github.com/thoughtbot/factory_girl/wiki/Example-factories.rb-file">reference.</a> <br><br><h5>  Self testing </h5><br><br>  By installing a basic testing environment, you can talk about its features.  Rspec divides all testing in parts, that is, copies of folders in the app section are created in the spec folder.  During my modest period of development and testing, I found it appropriate only sections models, helpers, mailers.  And then the question arises: ‚ÄúWhat to do with the most important components of controllers and views?‚Äù In my opinion, the solution that rspec offers is not entirely complete, and it creates an unrealistic situation of what is happening.  Therefore, for my development, I chose to test requests and responses received.  To do this, install capybara.  The author of the library (Jonas Nicklas) describes it as follows: <br><br>  ‚ÄúCapybara aims to simplify testing Rack applications such as Rails, Sinatra or Merb.  Capybara simulate show web user experience. ‚Äù <br><br>  What literally sounds like: <br><br>  "Capybara <s>guinea pig</s> simplifies the process of integrated testing, simulating user behavior in your application" <br><br>  Add it to the gemfile.  Then in the spec / test_helper.rb file you need to add the Capybara libraries: <br><br> <code>require 'capybara/rspec'</code> <br> <br>  Now our tests are filled with many functional and convenient methods of testing and manipulating the virtual page.  Let's start in order: <br><br>  A visit to the page is done by a clear visit method: <br><br> <code>visit '/'</code> <br> <br>  In addition to string addresses, the method accepts rails path helper: <br><br> <code>visit car_wheels_path(car)</code> <br> <br>  But the main functionality of the library is in the accessible page object.  This object is a virtual page for testing.  To get its content, you only need to refer to the body method: <br><br> <code>puts page.body</code> <br> <br>  Let's go through the list of commands manipulation.  Text and password fields are filled in by the fill_in method, which takes the first parameter id, class, name of the element, and the parameter with specifies the contents: <br><br> <code>fill_in 'car_manufacture', :with=&gt;'Audi' <br> fill_in 'car[model]', :with=&gt;'A4'</code> <br> <br>  To select a variant in select, the select method is used (thanks, Kep), which first takes a value, and then an element for manipulation: <br><br>  select 'Silver',: from =&gt; 'car [color]' <br><br>  There are also methods check, uncheck, choose, the purpose of which is to change the state of the checkbox and radio button.  They only accept the item ID: <br><br> <code>check 'car[full_package]' <br> choose 'car[year][2010]'</code> <br> <br>  But it happens that in the page there are several elements with the same name, or, God forbid, id.  For this there is a block method within, which limits the search inside the specified element: <br><br> <code>within 'form#payment_card' do <br> #  <br> end</code> <br> <br>  There are several methods for clicking buttons and links - universal (click_on) and specific (click_link, click_button): <br><br> <code>click_on 'submit_form' <br> click_link 'read_more'</code> <br> <br>  We now turn to verification of the structure obtained.  To check for the presence of a DOM element, the have_selector method is present: <br><br> <code>page.should have_selector('table tr')</code> <br> <br>  And what if you need to check the number of these elements?  Here and there, everything is quite simple - add the count parameter: <br><br> <code>page.should have_selector('table tr', :count=&gt;3)</code> <br> <br>  In situations where the element itself is not fazhen, and only the content is important is the page.have_content method useful? <br><br> <code>page.should have_content(‚ÄúAudi club‚Äù)</code> <br> <br><h5>  What about js? </h5><br><br>  Having written a couple of specs, you have already noticed that capybara completely ignores js scripts.  The developers have done this step due to the preservation of speed in passing the tests.  When there is a need to check our page with full functionality, use the parameter js spec: <br><br> <code>it 'should have many js', :js=&gt;true do <br> visit ‚Ä¶ <br> end</code> <br> <br>  A favorite browser window will appear in front of us, a test page will open, and the cursor will do all the movements.  Just magic, but let's figure it out.  In fact, capybara simply switched the web driver to handle the test page.  By default, the rack driver is used, which operates only with the content received with the response.  When using the js parameter, capybara starts to handle the selenium driver.  Selenium launches the system browser, if not specified, and performs all the desired actions.  Everything is good and beautiful, except for a couple of moments.  First, the test execution time becomes very long.  And not surprisingly, in addition to loading the rails environment itself, the test launches the browser, plus performing the manipulations also takes a certain amount of time.  Secondly, I did not like the constant display of the browser.  Therefore, I had to abandon selenium in favor of the alternative web driver, capybara-webkit.  This gem was specifically written to solve these problems.  To install the library, besides capybara-webkit itself, it is necessary to install another qt library.  After spec_helper we specify which driver to use for pages with javascript: <br><br> <code>Capybara.javascript_driver :webkit</code> <br> <br>  Now capybara will perform integral tests quickly and without any animation. <br><br>  Another interesting thing you will encounter is the verification of elements that are loaded using ajax.  The have_selector and have_content methods do not always pass, so we use methods such as all, find, first: <br><br> <code>first('div.info').should be <br> <br> all('tr.ads').should have(3).items</code> <br> <br>  Also, the find and first methods can be useful for emulating clicks on items other than buttons and links. <br><br> <code>first('div.catalog').click <br> find('p#info).click</code> <br> <br>  If you wanted to execute any script, then capybara will be useful here as well: <br><br> <code>page.execute_javascript ‚Äúalert('Hello world')‚Äù</code> <br> <br>  Initially, it seems utter nonsense - ‚ÄúWell, what's the point of performing js tests?‚Äù And the answer will be when you need to follow the page‚Äôs behavior to actions other than click and select: <br><br> <code>page.execute_javascript '$(‚Äúp.long_text‚Äù).hover();'</code> <br> <br>  This is how we emulated a paragraph cursor. <br><br>  Couple of life observations <br><br>  And at the end of my post a couple of tips from personal experience.  When using capybara, database_cleaner and factory_girl with any js web driver, the created resources will not be displayed on the test page.  To correct this situation the following setting: <br><br> <code>config.use_transactional_fixtures = false</code> <br> <br>  Another interesting trick is to focus on rspec, the effectiveness of which is indisputable in resource-intensive tests.  Adjusting the focus is as follows.  First, add the following line to the test environment configuration file: <br><br> <code>config.filter_run :focus=&gt;true <br> config.run_all_when_everything_filtered = true</code> <br> <br>  After that, to perform actions of interest, it will suffice to add a named parameter: focus =&gt; true and the list of specs will be filtered. <br><br><h6>  useful links </h6><br><br>  <a href="https://github.com/jnicklas/capybara">Capybara</a> <br>  <a href="http://robots.thoughtbot.com/post/4583605733/capybara-webkit">Capybara webkit</a> <br>  <a href="https://github.com/bmabey/database_cleaner">Data base cleaner</a> <br>  <a href="https://github.com/thoughtbot/factory_girl_rails">Factory girl rails</a> <br>  <a href="https://github.com/guard/guard">Guard</a> </div><p>Source: <a href="https://habr.com/ru/post/130766/">https://habr.com/ru/post/130766/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../130759/index.html">Using a smartphone as a keylogger for PC</a></li>
<li><a href="../130761/index.html">Bootstrapping like stupidity or cowardice?</a></li>
<li><a href="../130762/index.html">Programming Championships and more</a></li>
<li><a href="../130763/index.html">The recipe for cooking Xubuntu, or a netbook for a spouse</a></li>
<li><a href="../130764/index.html">46,000 people completed their first homework in ai-class</a></li>
<li><a href="../130767/index.html">How to find a common language with the developer? Master class for project managers</a></li>
<li><a href="../130769/index.html">How to Make Your Own Mobile Phone Suppressor</a></li>
<li><a href="../130770/index.html">Impressions and a first look at the Galaxy Nexus (Video)</a></li>
<li><a href="../130771/index.html">New level editor for Portal 2</a></li>
<li><a href="../130772/index.html">Questions to the vice president of RIM</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>