<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Evernote service architecture overview</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As promised, we began to translate some posts from the English- language Evernote Technolog , in which our engineers and developers talk about some of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Evernote service architecture overview</h1><div class="post__text post__text-html js-mediator-article"> <a href=""><img src="http://blog.evernote.com/tech/wp-content/uploads/2011/05/evernote-highlevel-architecture1-282x300.png" alt="image"></a> <br>  As promised, we began to translate some posts from the English- <a href="http://blog.evernote.com/tech/">language Evernote Technolog</a> , in which our engineers and developers talk about some of the details of the technical implementation of the service, share stories and just interesting facts from their work. <br><br>  Today we would like to start the overview of the architecture of Evernote with a general idea of ‚Äã‚Äãthe structure of the service.  Now we will not go into details regarding each component, leaving it for future posts. <br><br>  Let's start with the scheme presented above.  All statistics listed there are shown on May 17, 2011. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Network:</b> Almost all traffic to / from Evernote goes to <a href="http://www.evernote.com/">www.evernote.com</a> via HTTPS port 443. It includes both all ‚Äúweb activity‚Äù and synchronization with all software clients through our <a href="http://thrift.apache.org/">Thrift-</a> based API.  In total, about 150 million HTTPS requests per day are generated with peak traffic of about 250 Mbit / s.  Our night shift of administrators is especially ‚Äúglad‚Äù to this circumstance, since the weekly peak is at about 6:30 am Pacific time. <br><br>  We use <a href="http://en.wikipedia.org/wiki/Border_Gateway_Protocol">BGP</a> to send traffic directly through a fully independent network of channels provided by our main ( <a href="http://www.us.ntt.com/en/index.html">NTT</a> ) and additional ( <a href="http://www.level3.com/">Level 3</a> ) providers.  It is filtered through Vyatta on the way to the <a href="http://www.a10networks.com/">A10 load balancers</a> , which we installed in January, when we reached the SSL performance limit for our old balancers.  It is still quite convenient for us to handle existing traffic using one <a href="http://www.a10networks.com/products/axseries-product_specifications.php">AX 2500</a> plus a fault-tolerant server, but we are preparing to test their N + 1 configuration when creating our cluster in order to be ready for future growth. <br><br>  <b>Shards:</b> The core of the Evernote service is the server farm, which we call shards.  Each shard processes all data and all traffic (web and API) for a cohort of 100,000 Evernote users.  Since we already have more than 9 million users, it turns out about 90 shards. <br><br>  Each shard is a pair of <a href="http://www.supermicro.com/index.cfm">SuperMicro</a> servers with Intel dual-core processors, a huge amount of RAM, and fully clogged <a href="http://www.seagate.com/www/en-us/products/enterprise/">Seagate</a> industrial drives configured in mirrored RAID arrays.  At the head of each server, we have a <a href="http://www.debian.org/">Debian</a> host running a couple of <a href="http://www.xen.org/">Xen</a> virtual machines.  The core virtual machine runs the kernel from the following set of applications: Debian + <a href="http://www.oracle.com/technetwork/java/javase/overview/index-jsp-136246.html">Java 6</a> + <a href="http://tomcat.apache.org/">Tomcat</a> + <a href="http://www.hibernate.org/">Hibernate</a> + <a href="http://ehcache.org/">Ehcache</a> + <a href="http://www.stripesframework.org/display/stripes/Home">Stripes</a> + <a href="http://code.google.com/webtoolkit/">GWT</a> + <a href="http://www.mysql.com/">MySQL</a> (for metadata) + hierarchical local file systems (for file data). <br><br>  All user data in the master virtual machine on one server is synchronously duplicated in an additional machine on another server using <a href="http://www.drbd.org/">DRBD</a> .  This means that each byte of user data is stored on at least four different industrial drives physically located on two different servers.  And add to this nightly backup.  If we have any problem with the server, we can transfer work from the main virtual machine to an additional one located on another server with minimal downtime using <a href="http://linux-ha.org/wiki/Heartbeat">Heartbeat</a> . <br><br>  Since each user's data is stored completely locally on one (virtual) shard host, we can run each shard as an independent island with little or no interference and regardless of the situation in the rest of the farm.  It also means that problems with one shard do not affect the work of the others. <br><br>  The lion's share of work in the direction of users to their shards falls on load balancers, which have a set of instructions for finding a shard using URLs and / or cookies. <br><br>  <b>UserStore:</b> Although the vast majority of all data is stored on logically independent shards (‚ÄúNoteStore‚Äù), all of them are associated with a single user account database ‚ÄúUserStore‚Äù (also running on MySQL) with a small amount of information about each account, such as user name, MD5 password and user's shard id.  This database is small enough to fit in RAM, but at the same time we provide the same reliable backup using a similar combination of mirrored RAID and replications via DRBD for secondary and night backups. <br><br>  <b>Image Recognition Farm:</b> In order to ensure the search for words within images in your notes, we have selected a pool of 28 servers that use their 8-core processors daily to process new images.  On busy days, the flow can reach 1.3 or 1.4 million individual images.  Currently, a combination of Linux and Windows is used there, but the other day we plan to complete the migration to Debian to get rid of unnecessary dependencies. <br><br>  These servers provide the recognition process, which we call AIR (‚ÄúAdvanced Imaging and Recognition‚Äù).  The software for it was developed by our R &amp; D team.  This software processes each image, identifies areas containing text, and then tries to make a weighted list of possible matches for each word using ‚Äúrecognition engines‚Äù that generate sets of assumptions.  The work uses both the mechanisms developed by our team, which specializes in AIR (for example, handwriting recognition), and licensed technologies from commercial partners who have the best development in their field. <br><br>  <b>Other services:</b> All of the above servers are installed in pairs in the racks of our data center in Santa Clara, California.  In addition to the hardware that provides the basic operation of the service, we also have small groups of servers for simpler tasks that require one or two servers or Xen virtual machines.  For example, our SMTP gateway for incoming mail is provided by a couple of servers on Debian with <a href="http://www.postfix.org/">Postfix</a> and a special mail processor written in Java, installed on top of <a href="http://www.gnome.sk/Dwarf/dwarf.html">Dwarf</a> .  Our Twitter gateway for sending notes to your account using <a href="http://habrahabr.ru/company/evernote/blog/57286/">@myen</a> is just a small script using <a href="http://twitter4j.org/en/index.html">twitter4j</a> . <br><br>  Our corporate site works on <a href="httpd.apache.org/">Apache</a> , blogs - on <a href="http://wordpress.org/">WordPress</a> .  Most of our internal backup topology is provided by HP products.  We use <a href="http://www.puppetlabs.com/puppet/introduction/">Puppet</a> for configuration management, and <a href="http://www.zabbix.com/">Zabbix</a> , <a href="http://www.opsview.com/">Opsview</a> and <a href="http://www.alertsite.com/">AlertSite</a> for monitoring.  Night backup is provided by a combination of different software that transmits data over a dedicated gigabit channel to a backup data center. <br><br>  <b>Wait, why?</b>  We understand that this post raises many obvious questions about why we chose X rather than Y in a variety of situations.  Why did we choose our own servers instead of using the services of a "cloud" provider?  Why did we prefer old software (Java, SQL, local storage, etc.) instead of using the latest recipes? <br><br>  We will try to answer these questions in more detail in the next few months. </div><p>Source: <a href="https://habr.com/ru/post/120319/">https://habr.com/ru/post/120319/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../120311/index.html">Interactive articles on various interfaces and devices</a></li>
<li><a href="../120312/index.html">Say No to Smoking with your iPhone</a></li>
<li><a href="../120315/index.html">Chapter Two, in which Bookmate releases an Android app</a></li>
<li><a href="../120316/index.html">The best fonts for programming</a></li>
<li><a href="../120318/index.html">Web interfaces: development or vice versa?</a></li>
<li><a href="../120323/index.html">Wonderful joke in Ookla Speedtest for iOS</a></li>
<li><a href="../120324/index.html">New algorithm for depixing graphics</a></li>
<li><a href="../120325/index.html">Java Cloud Hosting - autoscaling, easy deploy, environment management</a></li>
<li><a href="../120326/index.html">Create your own schedule DrupalCamp Kyiv 2011</a></li>
<li><a href="../120328/index.html">Vertex Coverage Problem</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>