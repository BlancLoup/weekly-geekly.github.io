<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asynchronous recursive iterator and fight with callback in Node.js</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On Habr√©, there were already quite a lot of articles about new features of the ECMAScript 6 standard (for example, ‚ÄúWe refuse callbacks: Generators in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asynchronous recursive iterator and fight with callback in Node.js</h1><div class="post__text post__text-html js-mediator-article">  On Habr√©, there were already quite a lot of articles about new features of the ECMAScript 6 standard (for example, <a href="http://habrahabr.ru/post/210330/">‚ÄúWe refuse callbacks: Generators in ECMAScript 6‚Äù</a> ) and many use these features. <br><br>  Using examples from this article, we can: <br>  1. It is easy to write any iterator, for example, an iterator on a tree <br>  2. Write a pseudo-synchronous code (struggle with callback) <br><br>  But what if we need to write a recursive iterator on the tree, and getting the child nodes requires calling an asynchronous function with a callback transfer? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A simple recursive iterator (without invoking asynchronous functions) could look pretty simple and short: <br><br><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">iterTree</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">treenode</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> children = getChildren(treenode); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (children) { <span class="hljs-comment"><span class="hljs-comment">// inner node for (let i=0; i &lt; children.length; i++) { yield* iterTree(children[i]); // (*) recursion } } else { // leaf node yield treenode; } }</span></span></code> </pre> <br>  The above example is simple because it uses the synchronous call to the getChildren function.  If the getChildren function is asynchronous and requires the transfer of a callback (for example, this is receiving data from a disk or via a network), then everything becomes much more complicated.  We can no longer write so easily (following the examples from the above article) <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> children = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> getChildren(treenode, resumecallback);</code> </pre><br>  In this case, the iterTree function will stop at the place where the yield statement is called and transfer control to the calling function.  But we have a recursive function - and the calling function will also transfer control higher (operator yield *).  As a result, the user of our iterator will receive tree nodes interspersed with unexpected values. <br><a name="habracut"></a><br>  You can of course write special codes inside the function that uses this iterator to distinguish between the return values ‚Äã‚Äãof the iterator and the return values ‚Äã‚Äãwhen calling asynchronous functions.  You can also memorize the path from the root to the current vertex (actually creating a structure like a stack) and use this path in the callback function.  But in any case, the <b>code becomes quite complicated</b> - at least it stops being easy to read. <br><br>  <b>And yet, is it possible to write a simple and readable tree traversal iterator that requires calling asynchronous functions?</b> <b><br></b> <br>  Somewhat surprisingly, the new features of the language are perfectly combined with the good old <a href="https://github.com/laverdet/node-fibers">node-fiber</a> .  There are many libraries based on node-fiber, for example, <a href="https://github.com/luciotato/waitfor">wait.for</a> or <a href="https://github.com/ybogdanov/node-sync">node-sync</a> . <br>  For example, using <a href="https://github.com/luciotato/waitfor">wait.for</a> , you can write code that is almost identical to the simple iterator at the beginning of the article: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">iterTree</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">treenode</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> children = wait.for(getChildren, treenode); <span class="hljs-comment"><span class="hljs-comment">//  if (children) { // inner node for (let i=0; i &lt; children.length; i++) { yield* iterTree(children[i]); // (*) recursion } } else { // leaf node yield treenode; } }</span></span></code> </pre><br>  Using node-sync you can get a similar result. <br><br>  Sharing new features of ES6 and node-fiber (as well as libraries based on them) allows us to significantly simplify codes. <br><br>  <b>Sometimes combining alternative approaches gives an amazing result.</b> </div><p>Source: <a href="https://habr.com/ru/post/257323/">https://habr.com/ru/post/257323/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257305/index.html">Implementing Private Fields with WeakMap in JavaScript</a></li>
<li><a href="../257307/index.html">A meeting on Atlassian products took place in Moscow</a></li>
<li><a href="../257317/index.html">Apple Watch Human Interface Guideline</a></li>
<li><a href="../257319/index.html">Arbelos</a></li>
<li><a href="../257321/index.html">Another way to connect WS2812B to a microcontroller</a></li>
<li><a href="../257325/index.html">LA Workshop and MIPSfpga Initiatives in Russia and Electronics Teaching</a></li>
<li><a href="../257327/index.html">Victory over non-obvious. Collapsing indentation</a></li>
<li><a href="../257331/index.html">Computer little man</a></li>
<li><a href="../257333/index.html">Internship in Redmadrobot: hot, summer, interesting</a></li>
<li><a href="../257335/index.html">Happy birthday payler</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>