<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development of SELinux-module for the user</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the second article in the series. 
 Today we will talk about SELinux-users, their creation, binding, rights and other things. 

 Why do this? ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development of SELinux-module for the user</h1><div class="post__text post__text-html js-mediator-article"><h2>  This is the second article in the series. </h2><br><img src="https://habrastorage.org/files/829/d07/444/829d074443b74f6a95df53a53eebfb7b.png" align="left" width="200">  Today we will talk about SELinux-users, their creation, binding, rights and other things. <br><br>  Why do this?  There are many reasons.  For me, the main reason was to issue access for technical support for routine operations (such as reboot, cleaning logs, diagnostics, etc.), but without access to critical data and changes in system functions. <br><br><h3>  Assumptions </h3><br>  The text will contain a lot of technical information, so the author assumes that the reader: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Read the <a href="https://habrahabr.ru/post/320100/">last article</a> </li><li>  Has on hand CentOS 7 </li><li>  On which the packages setools-console, policycoreutils-devel, selinux-policy-devel, policycoreutils-newrole are installed </li><li>  And SELinux is enabled in enforcing mode with a targeted or minimum policy </li></ul><br>  Is this all about you?  Then let's go! <a name="habracut"></a><br><br><h3>  Users and Roles </h3><br>  The main purpose of users is to keep a list of roles that they can use. <br>  The default users are already represented in the policy of targeted or minimum, you can see the <b>semanage user -l command</b> . <br><br><img src="https://habrastorage.org/files/64c/20c/918/64c20c918d5148c3953d88379bdad32e.png"><br><br>  As is known from the previous article, it is the <b>roles that</b> are containers for <b>types</b> , namely, all necessary rules are hung on types. <br><br>  Thus, the user simply expands this tree, creating more options.  Note: if a user has one or another role, he can switch to it himself, using the <b>newrole</b> command.  Thus, by allowing the user the sysadm_r or unconfined_r role, you automatically give him unlimited rights to the system. <br><br><h3>  Users and Users </h3><br>  There is a fine connection between the Unix user (the one that has the UID) and the SELinux user (the one that has the context), which can be controlled using the <b>semanage login command</b> .  The connection is one-way: id -Z user1 will not show you anything.  The special user <b>__default__</b> denotes all users not listed in the system. <br><br><img src="https://habrastorage.org/files/ac9/f41/176/ac9f41176ddc48c0a13ab559a4c78845.png"><br><br><h3>  Create user (easy way) </h3><br>  The easiest way to create a user from ready-made roles is to use <b>semanage user -a</b> . <br><br>  Suppose we just need a new user with an additional set of roles: <br><br><img src="https://habrastorage.org/files/8a9/6e0/bea/8a96e0beab6e4e36b274e71e9b50ebf0.png"><br><br>  So we got a user who has the ability to adminit the web.  Now we can set a user for it: <br><br><img src="https://habrastorage.org/files/8cc/2bb/04e/8cc2bb04e9464fc0bc9d981770c4a01c.png"><br><br><h4>  Context </h4><br>  About this in few places they write, but it is not enough just to create a user.  If its context is different from <b>default_context</b> , it is necessary to configure the context file for it.  For details, see <a href="http://man7.org/linux/man-pages/man5/user_contexts.5.html">man user_contexts</a> . <br><br>  Configure the file for webadm_u: <br><br><img src="https://habrastorage.org/files/911/3a1/a48/9113a1a48ef9422e9aaa75f60846fad8.png"><br><br><h4>  Check </h4><br>  Log in as webadm user: <br><br><img src="https://habrastorage.org/files/afd/8ed/592/afd8ed5926724579ada8ee12358e47cd.png"><br><br>  Change the uid to 0 and try to break something: <br><br><img src="https://habrastorage.org/files/055/362/fb1/055362fb184e413bb6a26d2bef7e9cb7.png"><br><br>  Change the role to webadm_r and try now: <br><br><img src="https://habrastorage.org/files/a92/44f/dea/a9244fdeac2147519701918460b41127.png"><br><br>  What was required to prove - we did the admin, which can adminit only the web.  Unfortunately, the number of roles by default is very limited.  The list can be found <a href="https://selinuxproject.org/page/RefpolicyBasicRoleCreation">here</a> . <br><br><h3>  Create user (correct way) </h3><br>  Let's do the same thing, but for example to administer <b>docker</b> , and write it from scratch. <br><br>  The module will be very simple.  What do we need to allow? <br><br><ol><li>  Ssh login </li><li>  Access to sudo (UNIX-rights have not been canceled) * </li><li>  Administration of files, folders and docker services </li><li>  Execution of docker binaries (docker, runcon) </li><li>  Connect to dock socket </li></ol><br><div class="spoiler">  <b class="spoiler_title">*</b> <div class="spoiler_text">  The docker group on the latest version of CentOS7 does not have access to /run/docker.sock by default. <br></div></div><br>  Write the module and context file: <br><br><pre><code class="hljs 1c"><span class="hljs-meta"><span class="hljs-meta"># </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  policy_module(dockeradm, 1.0.3) #    role dockeradm_r; #   </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">- userdom_unpriv_user_template(dockeradm) #  dac_override allow dockeradm_t self:capability { dac_override dac_read_search }; #  sudo sudo_role_template(dockeradm, dockeradm_r, dockeradm_t) #       container_admin(dockeradm_t) #      container_runtime_exec(dockeradm_t) #      container_stream_connect(dockeradm_t) #  gen_user   -,  semanage user -a #         gen_user(dockeradm_u, dockeradm, dockeradm_r, s0, s0)</span></span></code> </pre> <br>  Compile and install the module: <br><br><img src="https://habrastorage.org/files/379/f4d/8a6/379f4d8a6bf4443da05519df94b93422.png"><br><br>  Set user and context: <br><br><img src="https://habrastorage.org/files/5c4/9f6/41a/5c49f641a61c45a19a767f382d5f7650.png"><br><br>  Let's check what lets us into the system: <br><br><img src="https://habrastorage.org/files/52c/35a/ddd/52c35addd0194e2589981ac40313b77b.png"><br><br>  Check our rights: <br><br><img src="https://habrastorage.org/files/559/d30/6a4/559d306a4b8248ad801a7e79e57142e2.png"><br><br>  As Apache says, <b>It works!</b> <br><br><h3>  Summarizing </h3><br>  Creating SELinux users is an important step towards creating a full-fledged working environment in which each employee does his own work and does not interfere with others.  Whether it is a hosting provider, a development studio or a bank, there are always situations when access sharing is necessary.  Turn on SELinux and enjoy :) </div><p>Source: <a href="https://habr.com/ru/post/322476/">https://habr.com/ru/post/322476/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../322464/index.html">How is ABC analysis used in stock?</a></li>
<li><a href="../322466/index.html">Where to talk "on IB": OWASP Russia Meetup # 6 will be held in the office of Positive Technologies</a></li>
<li><a href="../322468/index.html">February 23: there is no worse thing than an IT person</a></li>
<li><a href="../322470/index.html">What to read to the programmer at your leisure</a></li>
<li><a href="../322474/index.html">Events, tires and data integration in the challenging world of microservices</a></li>
<li><a href="../322478/index.html">The first way to generate collisions for SHA-1</a></li>
<li><a href="../322480/index.html">Upspin: Google's new global file system</a></li>
<li><a href="../322482/index.html">On the application of the scientific method in real life and activities</a></li>
<li><a href="../322484/index.html">MVC programming pattern as a way to implement the design process in Revit</a></li>
<li><a href="../322486/index.html">Detectable virtual machine in C #: 1 level</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>