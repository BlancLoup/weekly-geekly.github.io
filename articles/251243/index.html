<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We protect private keys from theft from VPS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the beginning of each semester, students of the master's program of the Department of MIT of the Academic University (St. Petersburg) and represent...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We protect private keys from theft from VPS</h1><div class="post__text post__text-html js-mediator-article"><img width="300" align="right" src="https://habrastorage.org/files/4ce/7f6/53b/4ce7f653b7514fbfa21ea08a2bd4ff79.png">  At the beginning of each semester, students of the master's program of the Department of <a href="http://mit.spbau.ru/">MIT of the Academic University (St. Petersburg)</a> and representatives of partner companies get together.  Representatives talk about projects that can be worked on, and students choose them. <br><br>  In one of the projects made at <a href="http://sp.parallels.com/ru/education/">Parallels Labs</a> , our student explored the possibility of implementing a virtual <a href="http://en.wikipedia.org/wiki/Hardware_security_module">Hardware Security Module (HSM)</a> .  As a result, he added his <a href="http://openvz.org/Virtual_HSM">VHSM</a> implementation to the open-source project <a href="http://openvz.org/Main_Page">OpenVZ</a> .  Read more about his decision under the cut. <br><a name="habracut"></a><br><h2>  What is HSM </h2><br>  Imagine an application that signs data sent to the server using a private key.  Let the loss of this key is unacceptable for its owner.  How to protect such valuable key from leakage as a result of remote hacking of the system?  The HSM approach suggests that we should not give the vulnerable part of the system access to the key content at all.  HSM is a physical device that itself stores digital keys or other secret data, controls them, generates them, and also performs cryptographic operations with them.  All operations on the data are performed inside the HSM, and the user has access only to the results of these operations.  The internal memory of the device is protected from physical access and hacking.  At attempt of penetration all confidential data is destroyed. <br><br>  To start using HSM, the user must authenticate themselves.  If authentication is performed through the HSM client application running in the vulnerable part of the system, then an HSM password could be intercepted by an attacker.  The intercepted password will allow an attacker to use HSM without obtaining the secret data stored in it.  Thus, it is desirable to perform authentication bypassing the vulnerable part of the system, for example, using physical PIN input. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The main barrier to using HSM is their high cost.  Depending on the class of the device, the price can vary from $ 10 (USB tokens, smart cards) to 30,000 + $ (devices with hardware accelerated cryptography, anti-burglary, high availability features).  Providers of cloud solutions have not ignored the HSM market.  For example, Amazon sells its cloudy HSM at an average price of $ 1,373 per month. <br><br>  One of the main features of HSM is the isolation of the vulnerable part of the system using cryptographic services from the HSM executing these services.  Note that individual instances (virtual machines, containers, etc.) are isolated from each other in the cloud, so if you take out the HSM functions outside the vulnerable instance in another instance that is isolated from the outside world, we will fairly accurately reproduce the functionality of the physical HSM.  We called this approach <a href="http://openvz.org/Virtual_HSM">Virtual HSM (VHSM)</a> .  Consider how it was implemented by our student for the <a href="http://openvz.org/Main_Page">OpenVZ</a> project. <br><br><h2>  What is OpenVZ </h2><br>  OpenVZ is one of the technologies for running a variety of isolated Linux operating systems on a single Linux kernel.  At the same time, they say that each Linux operating system runs in a separate container.  If to simplify greatly, then in fact, a functionality is built into the Linux kernel that allows you to isolate applications assigned to different containers so that they are unaware of the existence of each other.  Applications cannot change their container.  For better isolation and security, communication between applications from different containers using IPC tools is prohibited.  It is usually done using network connections.  As a result, we see the similarity of containers with ‚Äúordinary‚Äù virtual machines.  OpenVZ and technologies based on it are popular with hosting providers for creating VPS.  The Academic University has already made projects related to container virtualization.  For example <a href="http://habrahabr.ru/company/parallels/blog/174211/">habrahabr.ru/company/parallels/blog/174211</a> .  Parallels is the main developer of OpenVZ.  The implementation of VHSM for OpenVZ has become quite logical. <br><br><h2>  Virtual HSM Architecture </h2><br><div style="text-align:center;"><img width="500" src="http://habrastorage.org/files/f60/f83/e51/f60f83e5118143d4a052ad348c6713e4.jpg"></div><br><ul><li>  Client VE is an OpenVZ container in which user applications are executed that require cryptographic services for their work, such as encryption, signature, etc.  The container is available for remote attacks in order to steal digital keys. </li><li>  VHSM virtual environment (VHSM VE) - OpenVZ container in which the VHSM server is running - a daemon that receives commands from applications in Client VE and executes them.  No other applications in VHSM VE are running.  VHSM VE is isolated from regular custom containers using OpenVZ.  The container has no network interfaces and is not accessible over the network. </li><li>  Transport is a Linux kernel module designed to transfer messages from Client VE to VHSM VE and back. </li><li>  VHSM API is a library that implements part of the standard for HSM PKCS # 11 interface, which sends application commands from ClientVE to VHSM server using transport, and returns the result of the command execution to the application in ClientVE. </li></ul><br>  Consider each component in more detail. <br><br><h2>  VHSM virtual environment </h2><br>  The VHSM server is responsible for authenticating users, interacting with the secret data store, and performing cryptographic operations.  In addition to the VHSM server, VHSM VE contains Secure Storage, a database that stores sensitive information in encrypted form.  Each VHSM user has his master key that encrypts his data.  The master key is generated from the user's password using the <a href="http://en.wikipedia.org/wiki/PBKDF2">PBKDF2</a> function.  The salt transmitted to it at the input is stored in unencrypted form in the database.  Thus, VHSM does not store the user's master key in the database, and the use of PBKDF2 significantly reduces the speed at which the original user password is searched for when the database is stolen. <br><br>  The user is registered in VHSM by the administrator, in the role of which both the person and the program can act.  When registering a user, the VHSM generates a 256-bit authentication key and encrypts it with a master key using <a href="http://en.wikipedia.org/wiki/Galois/Counter_Mode">AES-GCM</a> .  Further, before using VHSM, the user authenticates himself with a login-password pair.  During authentication, a master key formed from a password and salt is used to decrypt the user authentication key.  Using GCM allows you to verify the master key during decryption.  The master key is obtained from the user password, and therefore checking its correctness allows you to check the user password itself, transmitted during authentication.  After successful authentication, cryptographic services using the user's digital keys stored in the VHSM become available to the user. <br><br>  VHSM requires an explicit choice of containers from which a particular user can work with VHSM.  Information about the container from which the user‚Äôs command is received is provided to OpenVZ. <br><br><h2>  VHSM API </h2><br>  This is a C-library located in user containers and implementing part of the standard for HSM PKCS # 11 interface, which allows you to manage keys, data, sessions, digital signature, encryption, etc.  Consider a specific example of using the VHSM API: <br><ol><li>  The application in the user container must sign the message being sent. </li><li>  Using the VHSM API, the application generates a public-private key pair, obtains the private key ID and the public key. </li><li>  The application sends the message to the VHSM API for signing with the private key with the desired ID.  The VHSM API returns a signed message. </li><li>  The signed message and the public key are transmitted to the recipient of the message.  At the same time, the private key is not accessible to the client container. </li></ol><br>  In the client part of the project, the OpenSSL engine and the PAM module were also implemented, which allow working with VHSM in existing applications using OpenSSL and PAM.  However, this part of the project is poorly developed and is rather a proof of concept. <br><br><h2>  VHSM Transport </h2><br>  As mentioned above, applications running in different containers cannot communicate with each other using the IPC Linux mechanisms.  Therefore, to transport messages from clients to the server and back, its own loadable Linux kernel module was implemented.  The module starts the Netlink server in the kernel, and the VHSM clients and the VHSM server connect to it.  The netlink server is responsible for sending messages from the source (VHSM client) to the receiver (VHSM server) and back.  Along the way, a message source container ID is added to messages so that, for example, the server can reject requests from containers from which a specific user is prohibited from using VHSM. <br><br><h2>  Conclusion </h2><br>  The main purpose of creating VHSM was to eliminate the possibility of stealing secret keys from the memory of user applications running in a user container.  This goal was achieved because  Secret data is only available in an insulated container (VHSM VE).  Isolation is implemented by OpenVZ. <br><br>  DB leakage from VHSM VE will not lead to immediate loss of secret data, since  they are stored in encrypted form.  The encryption key is not stored in the database, but is generated from the password of the user transmitted during its authentication. <br>  Like any information protection technology, the above solution is another barrier to the attacker and does not provide complete information protection. </div><p>Source: <a href="https://habr.com/ru/post/251243/">https://habr.com/ru/post/251243/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../251225/index.html">Unusual Playboy models, or about detecting outliers in data using Scikit-learn</a></li>
<li><a href="../251235/index.html">Anthology of Paul Graham</a></li>
<li><a href="../251237/index.html">Diffusion of innovations, part two</a></li>
<li><a href="../251239/index.html">Course program and materials on Scala</a></li>
<li><a href="../251241/index.html">Computer edition of publishing house Peter</a></li>
<li><a href="../251245/index.html">Show version and haiku, but not only: we are looking for all the hidden Junos commands</a></li>
<li><a href="../251247/index.html">The digest of interesting materials for the mobile developer # 91 (February 16-23)</a></li>
<li><a href="../251251/index.html">Today a free webinar will take place - Training of managers, managers and auditors for certification in the field of information security</a></li>
<li><a href="../251255/index.html">The digest of interesting materials from the world of Drupal # 5</a></li>
<li><a href="../251257/index.html">Disadvantages of Wordpress - the technical side</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>