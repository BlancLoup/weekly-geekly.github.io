<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What's New in PostgreSQL 11: INCLUDE Indexes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Release PostgreSQL 11 will not be soon, only in October. But feature freezes have already arrived, which means we know which features were included in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What's New in PostgreSQL 11: INCLUDE Indexes</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/04c/702/81a/04c70281a6745f83e911db28b807657f.jpg" alt="image"><br><br>  Release PostgreSQL 11 will not be soon, only in October.  But feature freezes have already arrived, which means we know which features were included in this release, and we can test them by <a href="https://eax.me/postgresql-build/">collecting PostgreSQL</a> from the master branch.  Particularly noteworthy feature called <b>INCLUDE-indices</b> .  <a href="https://git.postgresql.org/gitweb/%3Fp%3Dpostgresql.git%3Ba%3Dcommit%3Bh%3D8224de4f42ccf98e08db07b43d52fed72f962ebb">The patch</a> was originally written by <a href="https://habrahabr.ru/users/lubennikovaav/">Anastasia Lubennikova</a> , and then doped by <a href="https://habrahabr.ru/users/smagen/">Alexander Korotkov</a> and <a href="http://sigaev.ru/">Fyodor Sigaev</a> .  Pushing it into PostgreSQL took ‚Äúonly‚Äù something for about three years. <br><a name="habracut"></a><br>  Let's try to figure out what kind of indices for such.  To begin with we will create a tablet for experiences: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> (k <span class="hljs-built_in"><span class="hljs-built_in">serial</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, v <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, ts <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> (v, ts) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'key_'</span></span> || s , <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">10000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> s;</code> </pre> <br>  ... and build on it the usual btree-index: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> (v);</code> </pre><br>  Take a look at the execution plan for the following query: <br><br><pre> <code class="hljs delphi">=# explain select v, ts from test where v &gt; <span class="hljs-string"><span class="hljs-string">'key_1337'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> v &lt; <span class="hljs-string"><span class="hljs-string">'key_2337'</span></span>; QUERY PLAN ----------------------------------------------------------------------------- Bitmap Heap Scan <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> test (cost=<span class="hljs-number"><span class="hljs-number">31.57</span></span>..<span class="hljs-number"><span class="hljs-number">112.09</span></span> rows=<span class="hljs-number"><span class="hljs-number">1101</span></span> width=<span class="hljs-number"><span class="hljs-number">16</span></span>) Recheck Cond: ((v &gt; <span class="hljs-string"><span class="hljs-string">'key_1337'</span></span>::text) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (v &lt; <span class="hljs-string"><span class="hljs-string">'key_2337'</span></span>::text)) -&gt; Bitmap <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> Scan <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> test_v_idx (cost=<span class="hljs-number"><span class="hljs-number">0.00</span></span>..<span class="hljs-number"><span class="hljs-number">31.29</span></span> rows=<span class="hljs-number"><span class="hljs-number">1101</span></span> width=<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> Cond: ((v &gt; <span class="hljs-string"><span class="hljs-string">'key_1337'</span></span>::text) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (v &lt; <span class="hljs-string"><span class="hljs-string">'key_2337'</span></span>::text)) (<span class="hljs-number"><span class="hljs-number">4</span></span> rows)</code> </pre><br>  See what happens.  Since the index is built on the v column, and in the query we select v and ts, PostgreSQL is forced to execute the query in two steps.  First, it goes by the index and finds the rows that satisfy the condition.  Then he has to go to the table to get ts. <br><br>  The idea of ‚Äã‚ÄãINCLUDE-indexes is to include all the data necessary for the execution of the query directly into the index (but not index them).  Thus, the request becomes possible to execute in one index scan. <br><br>  Let's check: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> test_v_idx; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> (v) <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> (ts); <span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> v, ts <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> v &gt; <span class="hljs-string"><span class="hljs-string">'key_1337'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> v &lt; <span class="hljs-string"><span class="hljs-string">'key_2337'</span></span>;</code> </pre><br>  Result: <br><br><pre> <code class="hljs pgsql"> <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Only</span></span> Scan <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> test_v_ts_idx <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> test (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">0.29</span></span>.<span class="hljs-number"><span class="hljs-number">.46</span></span><span class="hljs-number"><span class="hljs-number">.30</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">1101</span></span> width=<span class="hljs-number"><span class="hljs-number">16</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> Cond: ((v &gt; <span class="hljs-string"><span class="hljs-string">'key_1337'</span></span>::<span class="hljs-type"><span class="hljs-type">text</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (v &lt; <span class="hljs-string"><span class="hljs-string">'key_2337'</span></span>::<span class="hljs-type"><span class="hljs-type">text</span></span>)) (<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>)</code> </pre><br>  Due to the fact that now we do not go to the table, the query should work faster.  However, it is worth noting that in practice everything depends on your data.  Each case is unique, so I deliberately do not cite any <a href="https://eax.me/benchmarks/">synthetic benchmarks here</a> .  It may turn out that on your volumes of data, index only scan with include indexes works as fast as in the case of regular indexes.  And even the accumulated statistics tell PostgreSQL that the query is faster to make a heap scan.  This can happen, for example, if your query selectivity is low. <br><br>  Anyway, knowing about this feature is useful, and I am sincerely glad that it will appear in PostgreSQL 11. </div><p>Source: <a href="https://habr.com/ru/post/353126/">https://habr.com/ru/post/353126/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353116/index.html">Dagaz: Looking for talents</a></li>
<li><a href="../353118/index.html">Sberbank Business Online on Windows 10 - a new solution for customers, or why UWP applications are driving</a></li>
<li><a href="../353120/index.html">How we did a project about the presidential elections in Russia in 2018</a></li>
<li><a href="../353122/index.html">Figma web-API - an interface that allows you to connect to other tools</a></li>
<li><a href="../353124/index.html">UL 3223: New Data Center Certification Standard introduced</a></li>
<li><a href="../353128/index.html">How I (re) made a bagel in a week</a></li>
<li><a href="../353130/index.html">Open webinar "Examples of patterns"</a></li>
<li><a href="../353134/index.html">Indoor geolocation based on iBeacon. Aruba Meridian Solution</a></li>
<li><a href="../353138/index.html">How to beat the routine, or the Ready application in Xcode in a couple of clicks</a></li>
<li><a href="../353140/index.html">Installing IP PBX 3CX in Microsoft Azure Cloud</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>