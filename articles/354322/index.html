<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Flask Mega-Tutorial, Part XXI: User Notifications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="(edition 2018) 
 Miguel grinberg 



 There 


 This is the twenty-first part of the Flask Mega-Tutorial, in which I will add the function of private ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Flask Mega-Tutorial, Part XXI: User Notifications</h1><div class="post__text post__text-html js-mediator-article"><h2 id="izdanie-2018">  (edition 2018) </h2><br><h3 id="miguel-grinberg">  <em>Miguel grinberg</em> </h3><br><hr><br><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://habrahabr.ru/post/353804/">There</a> <img src="https://habrastorage.org/webt/rw/dy/-g/rwdy-grsvbpcetjttrmecdkxtlk.png"></p><br><p>  This is the twenty-first part of the Flask Mega-Tutorial, in which I will add the function of private messages, as well as notifications to users that appear on the navigation bar without the need to refresh the page. </p><a name="habracut"></a><br><p>  Under the spoiler is a list of all articles in the 2018 series. </p><br><div class="spoiler">  <b class="spoiler_title">Table of contents</b> <div class="spoiler_text"><ul><li>  <a href="https://habrahabr.ru/post/346306/"><strong>Chapter 1: Hello world!</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346340/"><strong>Chapter 2: Templates</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346342/"><strong>Chapter 3: Web Forms</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346344/"><strong>Chapter 4: Database</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346346/"><strong>Chapter 5: User Logins</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346348/"><strong>Chapter 6: Profile Page and Avatars</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346880/"><strong>Chapter 7: Error Handling</strong></a> </li><li>  <a href="https://habrahabr.ru/post/347450/"><strong>Chapter 8: Subscribers, Contacts, and Friends</strong></a> </li><li>  <a href="https://habrahabr.ru/post/347926/"><strong>Chapter 9: Pagination</strong></a> </li><li>  <a href="https://habrahabr.ru/post/348566/"><strong>Chapter 10: Email Support</strong></a> </li><li>  <a href="https://habrahabr.ru/post/349060/"><strong>Chapter 11: Reconstruction</strong></a> </li><li>  <a href="https://habrahabr.ru/post/349604/"><strong>Chapter 12: Date and Time</strong></a> </li><li>  <a href="https://habrahabr.ru/post/350148/"><strong>Chapter 13: I18n and L10n</strong></a> </li><li>  <a href="https://habrahabr.ru/post/350626/"><strong>Chapter 14: Ajax</strong></a> </li><li>  <a href="https://habrahabr.ru/post/351218/"><strong>Chapter 15: Improving Application Structure</strong></a> </li><li>  <a href="https://habrahabr.ru/post/351900/"><strong>Chapter 16: Full Text Search</strong></a> </li><li>  <a href="https://habrahabr.ru/post/352266/"><strong>Chapter 17: Deploying to Linux</strong></a> </li><li>  <a href="https://habrahabr.ru/post/352830/"><strong>Chapter 18: Deploying to Heroku</strong></a> </li><li>  <a href="https://habrahabr.ru/post/353234/"><strong>Chapter 19: Deploying to Docker Containers</strong></a> </li><li>  <a href="https://habrahabr.ru/post/353804/"><strong>Chapter 20: JavaScript Magic</strong></a> </li><li>  <a href="https://habrahabr.ru/post/354322/"><strong>Chapter 21: User Notifications</strong></a> (This article) </li><li>  <a href="https://habrahabr.ru/post/354752/"><strong>Chapter 22: Background Tasks</strong></a> </li><li>  Chapter 23: Application Programming Interfaces (APIs) (Available May 8, 2018) </li></ul></div></div><br><p>  <em>Note 1: If you are looking for old versions of this course, this is <a href="https://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-i-hello-world-legacy" title="here">here</a> .</em> </p><br><p>  <em>Note 2: If suddenly you would like to speak in support of my (Miguel) work, or simply do not have the patience to wait for the article for a week, I (Miguel Greenberg) offer the full version of this manual (in English) in the form of an electronic book or video.</em>  <em>For more information, visit <a href="http://learn.miguelgrinberg.com/" title="learn.miguelgrinberg.com">learn.miguelgrinberg.com</a> .</em> </p><br><p>  In this chapter, I want to continue working on improving the user interface of Microblog.  One aspect that applies to many applications is the presentation of alerts or notifications to the user.  Social networks show these notifications so that you know that you have new mentions or private messages, usually showing a small number icon in the top navigation bar.  Although this is the most obvious use, the notification template can be applied to many other types of applications to inform the user that something needs their attention. </p><br><p>  But in order to show you the methods associated with creating custom notifications, I needed to extend the functionality of Microblog.  Therefore, in the first part of this chapter, I am going to build a user messaging system that allows any user to send a private message to another user.  This is actually simpler than it seems, and it will be a good excuse to brush up on the basics of working with Flask and reminding you how effective and interesting programming is with Flask.  And as soon as the messaging system is installed, I'm going to discuss some options for implementing a notification icon that shows the number of unread messages. </p><br><p>  <em>GitHub links for this chapter:</em> <a href="">Browse</a> , <a href="">Zip</a> , <a href="">Diff</a> . </p><br><h2 id="lichnye-soobscheniya">  Private messages </h2><br><p>  The private messaging feature I'm going to implement will be very simple.  When you visit the user profile page, there will be a link to send a private message to this user.  The link will take you to a new page that has a web form for receiving a message.  To read messages sent to you, the navigation bar at the top of the page will have a new "Messages" link, which will lead you to a page that is similar in structure to the index or explore pages, but instead of displaying blog posts, it will show messages from other users sent to you. </p><br><p>  The following sections describe the steps I took to implement this feature. </p><br><h2 id="podderzhka-baz-dannyh-dlya-lichnyh-soobscheniy">  Database support for private messages </h2><br><p>  The first task is to expand the database to support personal messages.  Here is the new message model: </p><br><blockquote>  <strong>app / models.py</strong> : <em>Message model.</em> </blockquote><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Message(db.Model): id = db.<span class="hljs-keyword"><span class="hljs-keyword">Column</span></span>(db.Integer, primary_key=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) sender_id = db.<span class="hljs-keyword"><span class="hljs-keyword">Column</span></span>(db.Integer, db.ForeignKey(<span class="hljs-string"><span class="hljs-string">'user.id'</span></span>)) recipient_id = db.<span class="hljs-keyword"><span class="hljs-keyword">Column</span></span>(db.Integer, db.ForeignKey(<span class="hljs-string"><span class="hljs-string">'user.id'</span></span>)) body = db.<span class="hljs-keyword"><span class="hljs-keyword">Column</span></span>(db.String(<span class="hljs-number"><span class="hljs-number">140</span></span>)) <span class="hljs-type"><span class="hljs-type">timestamp</span></span> = db.<span class="hljs-keyword"><span class="hljs-keyword">Column</span></span>(db.DateTime, <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, default=datetime.utcnow) def __repr__(self): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;Message {}&gt;'</span></span>.format(self.body)</code> </pre> <br><p>  This model class is similar to the <code>Post</code> model, with the only difference that there are two user foreign keys, one for the sender and one for the receiver.  The <code>User</code> model can get relationships for these two users, as well as a new field indicating what was the last time users read their private messages: </p><br><blockquote>  <strong>app / models.py</strong> : <em>Support for private messages in the User model</em> . </blockquote><br><pre> <code class="hljs haskell"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UserMixin</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Model</span></span></span><span class="hljs-class">): # ... messages_sent = db.relationship('</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Message</span></span></span><span class="hljs-class">', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foreign_keys</span></span></span><span class="hljs-class">='</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Message</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sender_id'</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">backref</span></span></span><span class="hljs-class">='</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">author'</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lazy</span></span></span><span class="hljs-class">='</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dynamic'</span></span></span><span class="hljs-class">) messages_received = db.relationship('</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Message</span></span></span><span class="hljs-class">', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foreign_keys</span></span></span><span class="hljs-class">='</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Message</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">recipient_id'</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">backref</span></span></span><span class="hljs-class">='</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">recipient'</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lazy</span></span></span><span class="hljs-class">='</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dynamic'</span></span></span><span class="hljs-class">) last_message_read_time = db.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Column</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DateTime</span></span></span><span class="hljs-class">) # ... def new_messages(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">): last_read_time = self.last_message_read_time or datetime(1900, 1, 1) return </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Message</span></span></span><span class="hljs-class">.query.filter_by(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">recipient</span></span></span><span class="hljs-class">=</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">).filter( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Message</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">timestamp</span></span></span><span class="hljs-class"> &gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">last_read_time</span></span></span><span class="hljs-class">).count()</span></span></code> </pre> <br><p>  These two links will return messages sent and received for this user, and on the side of the <code>Message</code> relationship will be added links to <code>author</code> and <code>recipient</code> .  The reason why I used <em>backref</em> (back link) <code>author</code> instead of perhaps a more appropriate <code>sender</code> (sender) is that with the help of <code>author</code> I can visualize these posts using the same logic that I use for blog posts.  The <code>last_message_read_time</code> field will contain <em>last time</em> when the user last visited the message page, and will be used to determine if there are unread messages that will have a newer time stamp than in this field.  The helper method <code>new_messages()</code> actually uses this field to return the number of unread messages from the user.  By the end of this chapter, I will have this number displayed as an icon in the navigation bar at the top of the page. </p><br><p>  This completes the database changes, so now it's time to create a new migration and update the database with it: </p><br><pre> <code class="hljs ruby">(venv) $ flask db migrate -m <span class="hljs-string"><span class="hljs-string">"private messages"</span></span> (venv) $ flask db upgrade</code> </pre> <br><h2 id="otpravka-lichnogo-soobscheniya">  Send private message </h2><br><p>  Next, I'm going to work on sending messages.  I will need a simple web form that allows you to type a message: </p><br><blockquote>  <strong>app / main / forms.py:</strong> <em>The class of the private message form.</em> </blockquote><br><pre> <code class="hljs haskell"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessageForm</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FlaskForm</span></span></span><span class="hljs-class">): message = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextAreaField</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_l</span></span></span><span class="hljs-class">('</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Message</span></span></span><span class="hljs-class">'), validators=[ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataRequired</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">min</span></span></span><span class="hljs-class">=0, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">max</span></span></span><span class="hljs-class">=140)]) submit = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SubmitField</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_l</span></span></span><span class="hljs-class">('</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Submit</span></span></span><span class="hljs-class">'))</span></span></code> </pre> <br><p>  And I also need an HTML template that displays this form on a webpage: </p><br><blockquote>  <strong>app / templates / send_message.html:</strong> <em>HTML template Send a private message.</em> </blockquote><br><pre> <code class="hljs django"><span class="xml"></span><span class="hljs-template-tag"><span class="xml"></span><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">extends</span></span></span></span></span><span class="hljs-template-tag"> "base.html" %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name">import</span></span></span><span class="hljs-template-tag"> 'bootstrap/wtf.html' </span><span class="hljs-keyword"><span class="hljs-template-tag"><span class="hljs-keyword">as</span></span></span><span class="hljs-template-tag"> wtf %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">block</span></span></span></span></span><span class="hljs-template-tag"> app_content %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ _('Send Message to %(recipient)s', recipient=recipient) }}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"row"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"col-md-4"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ wtf.quick_form(form) }}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endblock</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"></span><span class="xml"></span></code> </pre> <br><p>  Next, I'm going to add <em>new / send_message / to handle the actual sending of the private message:</em> <br></p><blockquote>  <strong>app / main / routes.py:</strong> <em>Route of sending a private message.</em> </blockquote><br><pre> <code class="hljs kotlin">from app.main.forms <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MessageForm from app.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Message # ... <span class="hljs-meta"><span class="hljs-meta">@bp</span></span>.route(<span class="hljs-string"><span class="hljs-string">'/send_message/&lt;recipient&gt;'</span></span>, methods=[<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'POST'</span></span>]) <span class="hljs-meta"><span class="hljs-meta">@login_required</span></span> def send_message(recipient): user = User.query.filter_by(username=recipient).first_or_404() form = MessageForm() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> form.validate_on_submit(): msg = Message(author=current_user, recipient=user, body=form.message.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) db.session.add(msg) db.session.commit() flash(_(<span class="hljs-string"><span class="hljs-string">'Your message has been sent.'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> redirect(url_for(<span class="hljs-string"><span class="hljs-string">'main.user'</span></span>, username=recipient)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> render_template(<span class="hljs-string"><span class="hljs-string">'send_message.html'</span></span>, title=_(<span class="hljs-string"><span class="hljs-string">'Send Message'</span></span>), form=form, recipient=recipient)</code> </pre> <br><p>  I think that the logic in this function should be basically understandable.  The action of sending a private message is simply performed by adding a new <code>Message</code> instance to the database. </p><br><p>  The last change that binds together is to add a link to the above route on the user profile page: </p><br><blockquote>  <strong>app / templates / user.html: The</strong> link to send a private message on the user profile page. </blockquote><br><pre> <code class="hljs django"><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">if</span></span></span></span></span><span class="hljs-template-tag"> user != current_user %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ url_for('main.send_message', recipient=user.username) }}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ _('Send private message') }}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endif</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"></span><span class="xml"></span></code> </pre> <br><h2 id="prosmotr-lichnyh-soobscheniy">  View Private Messages </h2><br><p>  The second big part of this feature is viewing personal messages.  To do this, I'm going to add another route to <em>/ messages</em> , which works quite similarly to the index and explores the pages, including full support for pagination: </p><br><blockquote>  <strong>app / main / routes.py:</strong> <em>Viewing messages route.</em> </blockquote><br><pre> <code class="hljs pgsql">@bp.route(<span class="hljs-string"><span class="hljs-string">'/messages'</span></span>) @login_required def messages(): <span class="hljs-built_in"><span class="hljs-built_in">current_user</span></span>.last_message_read_time = datetime.utcnow() db.<span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>() page = request.args.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">'page'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=<span class="hljs-type"><span class="hljs-type">int</span></span>) messages = <span class="hljs-built_in"><span class="hljs-built_in">current_user</span></span>.messages_received.order_by( Message.timestamp.<span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>()).paginate( page, current_app.config[<span class="hljs-string"><span class="hljs-string">'POSTS_PER_PAGE'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) next_url = url_for(<span class="hljs-string"><span class="hljs-string">'main.messages'</span></span>, page=messages.next_num) \ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> messages.has_next <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> prev_url = url_for(<span class="hljs-string"><span class="hljs-string">'main.messages'</span></span>, page=messages.prev_num) \ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> messages.has_prev <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> render_template(<span class="hljs-string"><span class="hljs-string">'messages.html'</span></span>, messages=messages.items, next_url=next_url, prev_url=prev_url)</code> </pre> <br><p>  The first thing I do in this view function is to update the <code>User.last_message_read_time</code> field with the current time.  Mark all messages that were sent to this user as read.  Then I query the <code>Message</code> model for a list of messages, sorted by label from new to old.  I decided to use the <code>POSTS_PER_PAGE</code> configuration element from the page of posts and messages, which will be very similar, but, of course, if the pages are common, it may make sense to add a separate variable for the messages.  The paging logic is identical to what I used for messages, so you should be familiar with all this. </p><br><p>  The view function above ends with the rendering of the template file <em>/app/templates/messages.html</em> , which you can see below: </p><br><blockquote>  <strong>app / templates / messages.html:</strong> HTML message view template. </blockquote><br><pre> <code class="hljs django"><span class="xml"></span><span class="hljs-template-tag"><span class="xml"></span><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">extends</span></span></span></span></span><span class="hljs-template-tag"> "base.html" %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">block</span></span></span></span></span><span class="hljs-template-tag"> app_content %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ _('Messages') }}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">for</span></span></span></span></span><span class="hljs-template-tag"> post </span><span class="hljs-keyword"><span class="hljs-template-tag"><span class="hljs-keyword">in</span></span></span><span class="hljs-template-tag"> messages %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">include</span></span></span></span></span><span class="hljs-template-tag"> '_post.html' %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endfor</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">nav</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aria-label</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"..."</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"pager"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">li</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"previous</span></span></span></span></span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">if</span></span></span></span></span><span class="hljs-template-tag"> not prev_url %}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string"> disabled</span></span></span></span></span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endif</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ prev_url or '#' }}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">span</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aria-hidden</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">&amp;larr;</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">span</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ _('Newer messages') }}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">li</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">li</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"next</span></span></span></span></span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">if</span></span></span></span></span><span class="hljs-template-tag"> not next_url %}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string"> disabled</span></span></span></span></span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endif</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ next_url or '#' }}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ _('Older messages') }}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">span</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aria-hidden</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">&amp;rarr;</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">span</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">li</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">nav</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endblock</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"></span><span class="xml"></span></code> </pre> <br><p>  Here I resorted to another little trick.  I noticed that the <code>Post</code> and <code>Message</code> instances have almost the same structure, except that <code>Message</code> gets an extra connection to the <code>recipient</code> (which I don‚Äôt need to show on the Messages page, as this is always the current user).  Therefore, I decided to reuse the <em>app / templates / _post.html</em> sub-template also for displaying private messages.  For this reason, this template uses a specific for-loop for <code>for post in messages</code> , so all references to the <code>post</code> in the sub-template also work with messages. </p><br><p>  To give users access to a new viewing function, the navigation page receives a new "Messages" link: </p><br><blockquote>  <strong>app / templates / base.html:</strong> <em>Messages link in the navigation bar.</em> </blockquote><br><pre> <code class="hljs django"><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">if</span></span></span></span></span><span class="hljs-template-tag"> current_user.is_anonymous %}</span></span><span class="xml"><span class="xml"> ... </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">else</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">li</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ url_for('main.messages') }}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ _('Messages') }}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">li</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ... </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endif</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"></span><span class="xml"></span></code> </pre> <br><p>  This function has now been completed, but within all of these changes some new texts have appeared, which have been added in several places, and they should be included in the language translations.  The first step is to update all language directories: </p><br><pre> <code class="hljs pgsql">(venv) $ flask translate <span class="hljs-keyword"><span class="hljs-keyword">update</span></span></code> </pre> <br><p>  Then each of the languages ‚Äã‚Äãin <em>app / translations</em> should have its own <em>messages.po</em> file updated with new translations.  You can find Spanish translations in the GitHub repository for this project or in a <a href="">zip file</a> . </p><br><h2 id="staticheskiy-znachok-uvedomleniya">  Static Notification Icon </h2><br><p>  Now the private messaging function is implemented, but, of course, there is nothing that tells the user that there are private messages awaiting perusal.  The simplest implementation of the navigation bar indicator can be displayed as part of the base template using the Bootstrap badge widget: </p><br><blockquote>  <strong>app / templates / base.html:</strong> Static message counter icon in the navigation bar. </blockquote><br><pre> <code class="hljs django"><span class="xml"><span class="xml"> ... </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">li</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ url_for('main.messages') }}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ _('Messages') }}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name">set</span></span></span><span class="hljs-template-tag"> new_messages = current_user.new_messages() %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">if</span></span></span></span></span><span class="hljs-template-tag"> new_messages %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">span</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"badge"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ new_messages }}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">span</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endif</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">li</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ...</span></span></code> </pre> <br><p>  Here I call the <code>new_messages()</code> method, which I added to the <code>User</code> model above directly from the template, and store this number in the template variable <code>new_messages</code> .  Then, if this variable is not zero, I simply add the icon with the number next to the Messages link.  Here is how it looks on the page: </p><br><p><img src="https://habrastorage.org/webt/kf/_h/gq/kf_hgqmhvwt190hhhyxypmqnnzi.png"></p><br><h2 id="dinamicheskiy-znachok-uvedomleniya">  Dynamic Notification Icon </h2><br><p>  The solution presented in the previous section is a decent and easy way to show a notification, but it has the disadvantage that the icon appears only when loading a new page.  If a user reads content on one page for a long time, without clicking on any links, new messages that arrive during this time will not be displayed until the user finally clicks on the link and loads a new page. </p><br><p>  To make this application more useful for my users, I want the icon to update the number of unread messages on my own, without having to click on links and download new pages.  One of the problems with the solution from the previous section is that the icon is displayed on the page only when the number of messages at the time of loading the page was non-zero.  What is really more convenient is to always include the icon in the navigation bar and mark it as hidden when the number of messages is zero.  This makes it easy to make the icon visible using javascript: </p><br><blockquote>  <strong>app / templates / base.html:</strong> <em>Unread message icon, compatible with JavaScript.</em> </blockquote><br><pre> <code class="hljs django"><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">li</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ url_for('main.messages') }}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ _('Messages') }}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name">set</span></span></span><span class="hljs-template-tag"> new_messages = current_user.new_messages() %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">span</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"message_count"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"badge"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"visibility: </span></span></span></span></span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">if</span></span></span></span></span><span class="hljs-template-tag"> new_messages %}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">visible </span></span></span></span></span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">else</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">hidden </span></span></span></span></span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endif</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">;"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ new_messages }}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">span</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">li</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br><p>  In this version of the badge it is always on.  But!  The CSS property <code>visible</code> set to <code>visible</code> when <code>new_messages</code> nonzero and hidden if it is zero.  I also added an <code>id</code> attribute to the <code>&lt;span&gt;</code> element, which represents an icon, to make it easier to access this element using the jQuery <code>$('#message_count')</code> selector <code>$('#message_count')</code> . </p><br><p>  Now I can encode a short JavaScript function that updates this icon to the new number: </p><br><blockquote>  <strong>app / templates / base.html:</strong> Static message counter icon in the navigation bar. </blockquote><br><pre> <code class="hljs django"><span class="xml"><span class="xml">... </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">block</span></span></span></span></span><span class="hljs-template-tag"> scripts %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="actionscript"><span class="xml"><span class="actionscript"> </span></span><span class="hljs-comment"><span class="xml"><span class="actionscript"><span class="hljs-comment">// ... function set_message_count(n) { $('#message_count').text(n); $('#message_count').css('visibility', n ? 'visible' : 'hidden'); } </span></span></span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endblock</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"></span><span class="xml"></span></code> </pre> <br><p>  The new <code>set_message_count()</code> function sets the number of messages in the badge element, and also adjusts the visibility so that the icon is hidden when the counter is 0, and is otherwise visible. </p><br><h2 id="dostavka-uvedomleniy-klientam">  Delivery notifications to customers </h2><br><p>  It now remains to add a mechanism by which the client receives periodic updates regarding the number of unread messages that the user has.  When one of these updates occurs, the client calls the <code>set_message_count()</code> function to make the update known to users. </p><br><p>  There are actually two methods on the server to deliver these updates to the client, and, as you probably guess, both have pros and cons, so which one to choose depends largely on the project.  In the first approach, the client periodically requests updates from the server, sending an asynchronous request.  The response to this request is a list of updates that the client can use to update various page elements, such as the unread message counter icon.  The second approach requires a special type of connection between the client and the server, which allows the server to freely transfer data to the client.  Please note that regardless of the approach, I want to consider notifications as general entities so that I can extend this platform to support other types of events besides the icon of unread messages. </p><br><p>  The most important thing in the first solution is that it is easy to implement.  All I need to do is add another route to the application, say <em>/ notifications</em> , which will return the JSON list of notifications.  The client application then scans the list of notifications and applies the necessary changes to the page for each of them.  The disadvantage of this solution is that there will be a delay between the actual event and the notification for it, because the client will request a list of notifications at regular intervals.  For example, if a client requests a notification every 10 seconds, a notification can be received with a delay of up to 10 seconds. </p><br><p>  The second solution requires changes at the protocol level, since HTTP has no conditions for the server to send data to the client without a client request.  Today, the most common way to implement messages initiated by a server is to extend the server to support <a href="https://en.wikipedia.org/wiki/WebSocket">WebSocket</a> connections in addition to HTTP.  WebSocket is a protocol that, in contrast to HTTP, establishes a permanent connection between a server and a client.  The server and the client can simultaneously send data to the other side, without paying attention to the other side.  The advantage of this mechanism is that whenever an event of interest to the client occurs, the server can send a notification without any delay.  The disadvantage is that WebSocket requires more complex configuration than HTTP, because the server needs to maintain a constant connection with each client.  Imagine that a server, which, for example, has four workflows, can usually serve several hundred HTTP clients, since HTTP connections are short-lived and are constantly being processed.  The same server will only be able to process four WebSocket clients, which in most cases will be insufficient.  It is for this limitation that WebSocket applications are usually developed around <em>asynchronous</em> servers, since these servers are more efficient in managing large numbers of working and active connections. </p><br><p>  The good news is that regardless of the method you use, in the client you will have a callback function that will be called with a list of updates.  Therefore, I could start with the first option, which is much easier to implement, and then, if I find it insufficient, I will switch to the WebSocket server, which can be configured to call the same client callback.  In my opinion, for this type of application the first solution is actually acceptable.  A WebSocket-based implementation would be useful for an application that requires updates to be delivered with an almost zero delay. </p><br><p>  If you're interested, Twitter also uses the first approach for navigation bar notifications.  Facebook uses a variant called <a href="https://en.wikipedia.org/wiki/Push_technology">Long_polling</a> , which removes some of the limitations of direct polling, while still using HTTP requests.  Stack Overflow and Trello are two Sites that implement WebSocket for their notifications.  You can find out what type of background activity occurs on any site by viewing the Network tab in the browser debugger. </p><br><p>  So let's continue and implement the survey solution.  First, I'm going to add a new model to track notifications for all users, as well as relationships in the user model. </p><br><blockquote>  <strong>app / models.py:</strong> <em>Model of notifications.</em> </blockquote><br><pre> <code class="hljs vhdl">import json from <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> import <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> # ... class User(UserMixin, db.Model): # ... notifications = db.relationship(<span class="hljs-symbol"><span class="hljs-symbol">'Notification</span></span>', backref=<span class="hljs-symbol"><span class="hljs-symbol">'user</span></span>', lazy=<span class="hljs-symbol"><span class="hljs-symbol">'dynamic</span></span>') # ... class Notification(db.Model): id = db.Column(db.<span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span>, primary_key=<span class="hljs-literal"><span class="hljs-literal">True</span></span>) name = db.Column(db.<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>), index=<span class="hljs-literal"><span class="hljs-literal">True</span></span>) user_id = db.Column(db.<span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span>, db.ForeignKey(<span class="hljs-symbol"><span class="hljs-symbol">'user</span></span>.id')) timestamp = db.Column(db.Float, index=<span class="hljs-literal"><span class="hljs-literal">True</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>) payload_json = db.Column(db.<span class="hljs-literal"><span class="hljs-literal">Text</span></span>) def get_data(self): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> json.loads(str(self.payload_json))</code> </pre> <br><p>  The notification will have the name of the associated user, a Unix timestamp, and a payload.  The timestamp gets its default value from the <code>time.time()</code> function.  The payload will be different for each type of notification, so I write it as a JSON string, as this will allow me to write lists, dictionaries, or individual values, such as numbers or strings.  For convenience, I added the <code>get_data()</code> method so that the caller doesn‚Äôt have to worry about JSON deserialization. </p><br><p>  These changes need to be included in the new database migration: </p><br><pre> <code class="hljs ruby">(venv) $ flask db migrate -m <span class="hljs-string"><span class="hljs-string">"notifications"</span></span> (venv) $ flask db upgrade</code> </pre> <br><p>  For convenience, I'm going to add new <code>Message</code> and <code>Notification</code> models to the shell context, so that when the shell is started using the <code>flask shell</code> command, the model class is automatically imported for me: </p><br><blockquote>  <strong>microblog.py:</strong> <em>Add a message model to a shell context.</em> </blockquote><br><pre> <code class="hljs scala"># ... from app.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-type"><span class="hljs-type">User</span></span>, <span class="hljs-type"><span class="hljs-type">Post</span></span>, <span class="hljs-type"><span class="hljs-type">Notification</span></span>, <span class="hljs-type"><span class="hljs-type">Message</span></span> # ... <span class="hljs-meta"><span class="hljs-meta">@app</span></span>.shell_context_processor <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">make_shell_context</span></span></span></span>(): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {<span class="hljs-symbol"><span class="hljs-symbol">'d</span></span>b': db, <span class="hljs-symbol"><span class="hljs-symbol">'Use</span></span>r': <span class="hljs-type"><span class="hljs-type">User</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">'Pos</span></span>t': <span class="hljs-type"><span class="hljs-type">Post</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">'Messag</span></span>e': <span class="hljs-type"><span class="hljs-type">Message</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'Notificatio</span></span>n': <span class="hljs-type"><span class="hljs-type">Notification</span></span>}</code> </pre> <br><p>  I am also going to add the <code>add_notification()</code> helper method to the user model in order to simplify working with these objects: </p><br><blockquote>  <strong>app / models.py:</strong> Model notification. </blockquote><br><pre> <code class="hljs haskell"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UserMixin</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Model</span></span></span><span class="hljs-class">): # ... def add_notification(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">): self.notifications.filter_by(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">=</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">).delete() n = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Notification</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">=</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payload_json</span></span></span><span class="hljs-class">=</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">json</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dumps</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">), user=self) db.session.add(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">n</span></span></span><span class="hljs-class">) return n</span></span></code> </pre> <br><p>  This method not only adds a notification for the user to the database, but also ensures that if a notification with the same name already exists, it will be deleted.  The notification I'm going to work with will be called <code>unread_message_count</code> .  If the database already has a notification with this name, for example, with 3 values ‚Äã‚Äãat the time when the user receives a new message, and the number of messages reaches 4, I want to replace the old notification. </p><br><p>  In any place where the number of unread messages changes, I need to call <code>add_notification()</code> to update my notifications for the user.  There are two places where it changes.  First, when a user receives a new private message in the <code>send_message()</code> function: </p><br><blockquote>  <strong>app / main / routes.py:</strong> Update user notification. </blockquote><br><pre> <code class="hljs ruby">@bp.route(<span class="hljs-string"><span class="hljs-string">'/send_message/&lt;recipient&gt;'</span></span>, methods=[<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'POST'</span></span>]) @login_required <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(recipient)</span></span></span></span>: <span class="hljs-comment"><span class="hljs-comment"># ... if form.validate_on_submit(): # ... user.add_notification('unread_message_count', user.new_messages()) db.session.commit() # ... # ...</span></span></code> </pre> <br><p>  The second place where I need to notify the user is when the user goes to the messages page, after which the unread message counter returns to zero: </p><br><blockquote>  <strong>app / main / routes.py:</strong> <em>Viewing messages route.</em> </blockquote><br><pre> <code class="hljs ruby">@bp.route(<span class="hljs-string"><span class="hljs-string">'/messages'</span></span>) @login_required <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">messages</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: current_user.last_message_read_time = datetime.utcnow() current_user.add_notification(<span class="hljs-string"><span class="hljs-string">'unread_message_count'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) db.session.commit() <span class="hljs-comment"><span class="hljs-comment"># ...</span></span></code> </pre> <br><p>  Now that all notifications for users are maintained in the database, I can add a new route that the client can use to retrieve notifications for a registered user: </p><br><blockquote>  <strong>app / main / routes.py:</strong> <em>The function of viewing notifications.</em> </blockquote><br><pre> <code class="hljs scala">from app.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-type"><span class="hljs-type">Notification</span></span> # ... <span class="hljs-meta"><span class="hljs-meta">@bp</span></span>.route('/notifications') <span class="hljs-meta"><span class="hljs-meta">@login</span></span>_required <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifications</span></span></span></span>(): since = request.args.get(<span class="hljs-symbol"><span class="hljs-symbol">'sinc</span></span>e', <span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">=float</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notifications</span></span></span><span class="hljs-class"> </span></span>= current_user.notifications.filter( <span class="hljs-type"><span class="hljs-type">Notification</span></span>.timestamp &gt; since).order_by(<span class="hljs-type"><span class="hljs-type">Notification</span></span>.timestamp.asc()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> jsonify([{ <span class="hljs-symbol"><span class="hljs-symbol">'nam</span></span>e': n.name, <span class="hljs-symbol"><span class="hljs-symbol">'dat</span></span>a': n.get_data(), <span class="hljs-symbol"><span class="hljs-symbol">'timestam</span></span>p': n.timestamp } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> n in notifications])</code> </pre> <br><p>  This is a fairly simple function that returns the payload in JSON with a list of notifications to the user.  Each notification is provided as a dictionary with three elements, the name of the notification, additional data related to the notification (for example, the number of messages), and a timestamp.  Notifications are delivered in the order in which they were created, from the oldest to the newest. </p><br><p>   ,     ,           .  <code>since</code> ¬´¬ª       URL-           .  ,     ,  ,    . </p><br><p>  ,          .     ‚Äî   ,       : </p><br><blockquote> <strong>app/templates/base.html:</strong> <em>  .</em> </blockquote><br><pre> <code class="hljs django"><span class="xml"><span class="xml">... </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">block</span></span></span></span></span><span class="hljs-template-tag"> scripts %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="actionscript"><span class="xml"><span class="actionscript"> </span></span><span class="hljs-comment"><span class="xml"><span class="actionscript"><span class="hljs-comment">// ... </span></span></span></span></span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">if</span></span></span></span></span><span class="hljs-template-tag"> current_user.is_authenticated %}</span></span><span class="xml"><span class="javascript"><span class="xml"><span class="javascript"> $(</span></span><span class="hljs-function"><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span></span><span class="xml"><span class="javascript"><span class="hljs-function">(</span></span></span><span class="hljs-params"></span><span class="xml"><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span></span><span class="xml"><span class="javascript">{ </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">var</span></span></span></span><span class="xml"><span class="javascript"> since = </span></span><span class="hljs-number"><span class="xml"><span class="javascript"><span class="hljs-number">0</span></span></span></span><span class="xml"><span class="javascript">; setInterval(</span></span><span class="hljs-function"><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span></span><span class="xml"><span class="javascript"><span class="hljs-function">(</span></span></span><span class="hljs-params"></span><span class="xml"><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span></span><span class="xml"><span class="javascript">{ $.ajax(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ url_for('main.notifications') }}</span></span><span class="xml"><span class="xml"><span class="xml"><span class="xml">?since=' + since).done( function(notifications) { for (var i = 0; i </span></span><span class="hljs-tag"><span class="xml"><span class="xml"><span class="hljs-tag">&lt; </span></span></span><span class="hljs-attr"><span class="xml"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">notifications.length</span></span></span></span></span><span class="xml"><span class="xml"><span class="hljs-tag">; </span></span></span><span class="hljs-attr"><span class="xml"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span></span><span class="xml"><span class="xml"><span class="hljs-tag">++) { </span></span></span><span class="hljs-attr"><span class="xml"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span></span></span><span class="xml"><span class="xml"><span class="hljs-tag"> (</span></span></span><span class="hljs-attr"><span class="xml"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">notifications</span></span></span></span></span><span class="xml"><span class="xml"><span class="hljs-tag">[</span></span></span><span class="hljs-attr"><span class="xml"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span></span><span class="xml"><span class="xml"><span class="hljs-tag">]</span></span></span><span class="hljs-attr"><span class="xml"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">.name</span></span></span></span></span><span class="xml"><span class="xml"><span class="hljs-tag"> == </span></span></span><span class="hljs-string"><span class="xml"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'unread_message_count'</span></span></span></span></span><span class="xml"><span class="xml"><span class="hljs-tag">) </span></span></span><span class="hljs-attr"><span class="xml"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">set_message_count</span></span></span></span></span><span class="xml"><span class="xml"><span class="hljs-tag">(</span></span></span><span class="hljs-attr"><span class="xml"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">notifications</span></span></span></span></span><span class="xml"><span class="xml"><span class="hljs-tag">[</span></span></span><span class="hljs-attr"><span class="xml"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span></span><span class="xml"><span class="xml"><span class="hljs-tag">]</span></span></span><span class="hljs-attr"><span class="xml"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">.data</span></span></span></span></span><span class="xml"><span class="xml"><span class="hljs-tag">); </span></span></span><span class="hljs-attr"><span class="xml"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">since</span></span></span></span></span><span class="xml"><span class="xml"><span class="hljs-tag"> = </span></span></span><span class="hljs-string"><span class="xml"><span class="xml"><span class="hljs-tag"><span class="hljs-string">notifications[i].timestamp;</span></span></span></span></span><span class="xml"><span class="xml"><span class="hljs-tag"> } } ); }, </span></span></span><span class="hljs-attr"><span class="xml"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">10000</span></span></span></span></span><span class="xml"><span class="xml"><span class="hljs-tag">); }); </span></span></span></span></span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endif</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="undefined"><span class="xml"><span class="undefined"> </span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br><p>      conditional,         ,     .  ,     ,     . </p><br><p>    <code>$(function() { ...})</code> jQuery's  <a href="https://habr.com/post/353804/"> 20</a> .         .        ,     .     <code>setTimeout()</code> JavaScript,   ,       .  <code>setInterval()</code>    ,    <code>setTimeout()</code> ,                 .        10  (  ),             . </p><br><p> ,    ,  Ajax-    ,         .      <code>unread_message_count</code>       ,  ,  ,   . </p><br><p> ,     <code>since</code> ,   .        0.      URL-,          <code>url_for()</code> Flask,    ,   <code>url_for()</code>     ,     <code>since</code>   .        <em>/notifications?since=0</em> ,      ,   <code>since</code>   .  ,     ,       ,      ,   .   ,     <code>since</code>    ,     ,     ,  ,          . </p><br><p>         .      ,   .            .      ,    ,     10 .      "Messages"     . </p><br><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://habrahabr.ru/post/353804/">There</a> <img src="https://habrastorage.org/webt/rw/dy/-g/rwdy-grsvbpcetjttrmecdkxtlk.png"></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/354322/">https://habr.com/ru/post/354322/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354304/index.html">Operation Orangeworm: hackers infect medical equipment around the world using the Kwampirs Trojan</a></li>
<li><a href="../354310/index.html">Forms on the site - a spammer reluctantly</a></li>
<li><a href="../354312/index.html">How to optimize power consumption in iOS</a></li>
<li><a href="../354314/index.html">Roskomnadzor‚Äôs locks in the Telegram case reached the mining pools</a></li>
<li><a href="../354318/index.html">Hypothesis parameters</a></li>
<li><a href="../354324/index.html">Make Windows slower! Part One: File Access</a></li>
<li><a href="../354326/index.html">Using the MVC pattern when designing the tableview</a></li>
<li><a href="../354328/index.html">HOPE X. Conference "Breaking the elevator: from the basement to the penthouse." Part 1. "Elevator equipment"</a></li>
<li><a href="../354332/index.html">Edimax Office1-2-3 and what it is eaten with</a></li>
<li><a href="../354334/index.html">How we build DevOps in a team of 125 developers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>