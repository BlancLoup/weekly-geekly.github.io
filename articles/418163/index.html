<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Production Tests: Chaos Automation Platform on Netflix</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Our June Test in Production mitap was devoted to chaos engineering. Lead Software Engineer Norah Jones began with how Netflix performs production test...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Production Tests: Chaos Automation Platform on Netflix</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/026/eed/7ae/026eed7aeca23963ee742877d91b8340.jpg"><br><br>  Our June Test in Production mitap was devoted to chaos engineering.  Lead Software Engineer Norah Jones began with how Netflix performs production tests. <br><br><blockquote>  ‚ÄúChaos engineering ... these are production experiments to find vulnerabilities in the system before they make the service unusable for customers.  At Netflix, we do it with a tool called ChAP ... [it] catches vulnerabilities and allows us to introduce failures in services and production.  These failures confirm the assumptions about these services before they lead to full-scale outages. ‚Äù </blockquote><a name="habracut"></a><br>  Watch a presentation (or read the transcript) about how its team helps users ‚Äî Netflix engineers ‚Äî safely test in production and actively identify vulnerabilities in their systems. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <iframe width="560" height="315" src="https://www.youtube.com/embed/3WRVgC8SiGc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3>  Decryption </h3><br>  I am very glad to be here today. <br><br>  Netflix makes extensive use of tests in production.  We do them with the help of chaos engineering, and recently renamed our team Resiliance Engineering [sustainable development], because chaos engineering is one of the means to achieve overall sustainability.  This is what I‚Äôm going to talk about today. <br><br>  Our goal is to increase uptime by proactively searching for vulnerabilities in services.  We do this through production experiments.  The team is confident that a certain class of vulnerabilities and problems can only be detected on real traffic. <br><br>  First of all, you should take care of security and monitoring, otherwise you will not be able to deploy normal tests in production.  Such tests can be scary: if they are scary, you should listen to this voice and find out why.  Maybe because you don't have a good security system.  Or because there is no good monitoring.  In our tools, we really care about these things. <br><br>  If we formulate chaos-engineering in one sentence, then this is the discipline of production experiments in order to find vulnerabilities in the system before they cause the service to become unsuitable for customers.  At Netflix, we do this with a tool called ChAP, which means the Chaos Automation Platform (Chaos Automation Platform).  ChAP catches vulnerabilities and allows users to introduce failures in services and production.  These failures confirm the users' assumptions about these services before they lead to full-scale outages. <br><br>  I will tell you how the platform works at a high level.  This is a hypothetical set of dependencies of microservices.  There is a proxy.  He sends a request to service A, which then diverges in terms of services B, C and D, and there is still a level of persistence.  Service D accesses Cassandra, and then Service B accesses the cache. <br><br>  I rush forward and squeeze everything out, because the essence begins later.  We want to make sure that service D is resilient to cache failure.  The user logs on to the ChAP interface and selects service D as the service that monitors cache failures and the service for failure.  ChAP in reality clones service B into two copies.  We use them for control in experimental clusters: in some way they work like A / B tests or canary tests.  These replicas are much smaller in size than service B. We send only a very, very small percentage of clients to these clusters, because we obviously don‚Äôt want a full-scale failure.  We calculate this percentage based on the current number of users using the service at the moment. <br><br>  ChAP then instructs the crash implementation system to mark requests that match our criteria.  This is done by adding information to the request headers.  Two sets of tags are created.  In the first set of instructions for failure and routing to a canary-replica, and in the second - only instructions for routing to the monitoring element. <br><br>  When the RPC client and service A receive the instructions needed to route the request, they actually send traffic to the monitoring cluster or the experimental cluster.  Then, the crash injection system at the RPC level of the experimental cluster sees that the request is flagged for failure, and returns a failed response.  As before, the experimental cluster, as a failed response from the cache, will execute the code to handle the failure.  We do this on the assumption that it is fault tolerant, right?  But sometimes we see that it is not.  From the point of view of service A, everything looks like normal behavior. <br><br>  We carefully control the chaos-engineering, which can go really bad.  When Netflix first started such experiments, we didn‚Äôt have a good control system.  We ran an artificial crash and sat in the room, crossing our fingers and checking that everything was working fine.  Now we have a lot more attention to security. <br><br>  We look at key business metrics.  One of them is called SPS (stream starts per second), that is, video stream starts per second.  If you think that the most important thing for a Netflix business is that users can run any series any time they want. <br><br><img src="https://habrastorage.org/webt/pm/z0/rk/pmz0rkkuglqzi4qcpkduiapdxd8.jpeg"><br><br>  On the graphs you see a real experiment.  It shows the difference in SPS between the experimental and control clusters during the test.  You may notice that the graphs deviate strongly from each other, which should not be, because the same percentage of traffic is sent to both clusters. <br><br>  For this reason, automated canary analysis is used in the test.  He gives a signal that the graphics are very deviated from each other.  In this case, the test is immediately interrupted so that people can work normally with the site.  From the user's point of view, this is more like a short-term glitch when this happens. <br><br>  We have many other remedies.  We limit the amount of test traffic in each region, so we do not conduct an experiment only in the US West 2 zone. We do it everywhere and limit the number of experiments that can be performed in the region at a time.  Tests are held only during working hours, so we will not wake up the engineers if something goes wrong.  If the test fails, it cannot be automatically started again until someone explicitly manually fixes it and confirms: ‚ÄúHey, I know that the test did not pass, but I fixed everything I needed.‚Äù <br><br>  It is possible to apply custom properties to clusters.  This is useful if the service is divided into shards, like many Netflix services.  In addition, you can embed failures based on the type of device.  If we assume some problems on Apple devices or on a certain type of TV, then we can conduct tests specifically for them. <br><br>  ChAP found a lot of bugs.  Here is one of my favorites.  We conducted an experiment to test the backup path of the service, which is crucial for its availability, and found a bug there.  The problem was solved before it led to the incident of service availability.  This is a really interesting case, because this backup path was not executed frequently.  Therefore, the user did not really know if he was working correctly, and we managed to imitate him.  We actually caused a crash in the service and checked whether it went along the siding and whether this way works properly.  In this case, the user thought that his service was not critical or secondary, but in fact it was a critical service. <br><br>  Here is another example.  We conducted an experiment to reproduce the problem in the registration process, which manifested itself at night on some servers.  Something strange was happening with the service.  The problem was able to reproduce after the introduction of a delay of 500 milliseconds.  During the test, the problem was found in the logs uploaded to the Big Data Portal.  It helped to understand why registration did not work in some cases.  Only through the ChAP experiment was it possible to see what was happening and why. <br><br>  ChAP test setup requires a lot of information.  Need to figure out the appropriate point of implementation bugs.  Teams need to determine if they want a glitch or delay.  It all depends on the point of injection.  You can crash Cassandra, Hystrix (our backup system), RPC service, RPC client, S3, SQS, or our cache, or add a delay from them.  Or do both.  You can even come up with combinations of different experiments. <br><br>  What you need to do is get together with the service team and come up with a good test.  It will take a lot of time.  When setting up an experiment, you should also define ACA (Automated Canary Analysis) configurations or automatic canary configurations. <br><br>  We had several ready-made ACA configurations.  There was one ChAP configuration for SPS.  There was one with monitoring system indicators.  Another one that checked RPS failures.  Another one made sure that our service actually works fine and how it should inject bugs.  We realized that designing a test can be very time consuming, so it happened.  There were not so many tests.  It is difficult for a person to keep in his head everything that is necessary for a good experiment.  We decided to automate something with ChAP.  We looked at the indicators: where and from whom calls are coming, files with timeouts, repeated calls.  It became clear that all information comes from different places.  It was necessary to aggregate it. <br><br>  We scaled the analysis to the level of ChAP, where it is much more convenient to work with information and you can use Monocle.  Now all information about the application and the cluster can be studied in one place.  Here, each line represents a dependency, and these dependencies are the nutrient medium for experiments of chaos engineering. <br><br>  We collected all the information in one place for the development of the experiment, but did not understand that such aggregation is very useful in itself, so this is an interesting side effect.  Here you can go and actually see the anti-patterns associated with a particular service.  For example, a dependency is discovered that was not considered critical, but does not have an alternate execution path.  Obviously, it is now becoming critical.  People could see inconsistencies of timeouts, inconsistencies of repeated calls.  We use this information to assess the criticality of a particular type of experiment and enter it into an algorithm that determines priorities. <br><br>  Each line represents a dependency, and these lines can be expanded.  Here is an interesting example. <br><br><img src="https://habrastorage.org/webt/dw/dz/jz/dwdzjzq5kbg7hzytpb6bpecln9s.jpeg"><br><br>  Here, the blue line above indicates someone's timeout, and the purple line below shows the normal execution time.  As you can see, it is very, very far from the timeout.  But much of this information was not available.  What happens if we test right below the timeout?  What do you think?  Will he pass?  This is an interesting question.  We are trying to provide users with this level of detail prior to running tests, so that they can draw conclusions and change settings. <br><br>  I want to play a little game.  There is a vulnerability in this Netflix service, try to detect it.  Take a second and see. <br><br><img src="https://habrastorage.org/webt/1m/wr/oi/1mwroisscpys9j6aymq7gn1yzgw.jpeg"><br><br><img src="https://habrastorage.org/webt/xl/ro/sx/xlrosxxotacqtxvrrbixhzeaelm.png"><br><br>  To give you some context, the remote Hystrix command includes both sample-rest-client and sample-rest-client.GET.  Hystrix timeout is set to 500 milliseconds.  Sample-rest-client.GET has a 200 ms timeout with one retry, which is good, for a total of 400 milliseconds, which fits into the Hystrix limit.  The second client has timeouts of 100 and 600 with one retry. <br><br>  In this case, a retry cannot be completed taking into account the timeout of the Hystrix shell, that is, Hystrix refuses the request before the client can receive a response.  This is where the vulnerability lies.  We provide this information to users.  Interestingly, most of the logic in the implementation of these functions is in different places, and earlier they could not compare these things.  They thought that everything is working fine, but here is a bug. <br><br>  Why did it happen?  Of course, the developer is easy to see the conflict and change the timeout, is not it?  But we want to find out the reason.  We can change the timeout, but how to ensure that this does not happen again?  We also help find out the reasons. <br><br>  When creating automatic tests, we also use Monocle.  The user creates an experiment on numerous types of input data.  We take all this and automate the creation of such tests so that users do not bother themselves.  We automatically create and assign priorities for Hystrix experiments and RPC experiments with delays and failures due to delays.  ACA configurations are added by default.  We have SPC, system metrics, query statistics, and experiments run automatically.  Priorities for experiments are also created.  For them, the high-level algorithm works.  We use RPS statistics.  We use multiple retries and related Hystrix commands.  The whole set is weighted properly. <br><br>  In addition, the number of commands without backup execution paths and any external influence (curated impact), which the client adds to his dependency, are taken into account.  External influence strongly influences the authorization, registration and SPS procedures.  And we really measure its impact and do not conduct experiments if the result is negative.  Then tests are ranked and run in decreasing order of criticality.  The higher the criticality score, the earlier and more often the test runs. <br><br>  Ironically, Monocle provided us with feedback that allows us to perform fewer tests in production.  We conducted so many tests that resulted in a feedback loop: we saw connections between tests.  Now you can look at certain configuration files and see certain anti-patterns.  Even without tests on this information, one can understand what exactly will cause a failure, at that time we did not understand it before. <br><br>  This led to a new level of security.  Previously, an unsuccessful experiment was marked as resolved.  Now it is marked as resolved before re-launch.  But now we can clearly add external (curator) effects to addiction.  The user logs into his Monocle and indicates: this factor precisely influences the authorization procedure.  This one is on SPC.  And we are working on a feedback loop to ensure that such a curatorial effect is added in case of failure. <br><br>  Thus, Monocle in ChAP is an important tool in which all information is collected, it automatically generates experiments, automatically prioritizes and searches for vulnerabilities before they lead to full-scale outages.  To summarize, it is important to remember why we are engaged in chaos engineering and conduct all these experiments in production.  This is done to understand how customers use the service, and not to lose sight of them.  You want to provide people with the most convenient service.  So monitoring and security are paramount.  Netflix should always show videos. <br><br>  Thank. </div><p>Source: <a href="https://habr.com/ru/post/418163/">https://habr.com/ru/post/418163/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../418153/index.html">Videos from Kolesa Android Meetup: About MVVM, Anti-Patterns and Modular Development</a></li>
<li><a href="../418155/index.html">Diode. Light-emitting diode. Zener diode</a></li>
<li><a href="../418157/index.html">The book "Elegant Objects. Java Edition ¬ª</a></li>
<li><a href="../418159/index.html">Where to go to the designer: prestigious awards of Russia, Eastern Europe and the CIS countries</a></li>
<li><a href="../418161/index.html">Stanford developed streaming batteries operating at room temperature.</a></li>
<li><a href="../418165/index.html">Quasar, Sobaken and Vermin: reveal the details of the current cyber espionage campaign</a></li>
<li><a href="../418167/index.html">ScadaPy: add the IEC 60870-5-104 protocol</a></li>
<li><a href="../418169/index.html">What's new in Veeam Availability Console 2.0 Update 1?</a></li>
<li><a href="../418171/index.html">What metrics to rely on, if users perform few conversions on the site?</a></li>
<li><a href="../418173/index.html">"There and back" for neural networks, or a review of auto-encoder applications in text analysis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>