<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Networks for the smallest. Part ten. Basic MPLS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The network of our imaginary company linkmeup is growing. She already has trunk lines in various cities, a client base and an excellent staff of engin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Networks for the smallest. Part ten. Basic MPLS</h1><div class="post__text post__text-html js-mediator-article">  The network of our imaginary company linkmeup is growing.  She already has trunk lines in various cities, a client base and an excellent staff of engineers who grew up on the SDTSM cycle. <br>  But they are not enough.  BBA services are good and necessary, but there is still a huge potential market for corporate customers who need a VPN. <br>  The guys thought about it, puzzled and came to the conclusion that there is no way to do without MPLS. <br><br>  If the multicast was the first topic that required some rebuilding of the understanding of IP networks, then while studying MPLS, you definitely have to forget almost everything that you knew before - this is a special world with its own rules. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/274/6f2/5d2/2746f25d279323e9b7e23b4f053f6572.jpg"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Today in issue: <br><ul><li>  <a href="https://habr.com/ru/post/246425/">What is MPLS</a> </li><li>  <a href="https://habr.com/ru/post/246425/">MPLS network traffic transmission</a> </li><li>  <a href="https://habr.com/ru/post/246425/">Terminology</a> </li><li>  <a href="https://habr.com/ru/post/246425/">Label distribution</a> </li><li>  <a href="https://habr.com/ru/post/246425/">- Methods of distribution of tags</a> </li><li>  <a href="https://habr.com/ru/post/246425/">- - - DU vs DoD</a> </li><li>  <a href="https://habr.com/ru/post/246425/">- - - Ordered Control vs. Independent Control</a> </li><li>  <a href="https://habr.com/ru/post/246425/">- - - Liberal Label Retention Mode vs Conservative Label Retention Mode</a> </li><li>  <a href="https://habr.com/ru/post/246425/">- - - PHP</a> </li><li>  <a href="https://habr.com/ru/post/246425/">- Label Distribution Protocols</a> </li><li>  <a href="https://habr.com/ru/post/246425/">- - - LDP</a> </li><li>  <a href="https://habr.com/ru/post/246425/">- - - - Practice</a> </li><li>  <a href="https://habr.com/ru/post/246425/">- - - Use pure MPLS in conjunction with BGP</a> </li><li>  <a href="https://habr.com/ru/post/246425/">- - - RSVP-TE</a> </li><li>  <a href="https://habr.com/ru/post/246425/">- - - - Practice</a> </li><li>  <a href="https://habr.com/ru/post/246425/">- Q &amp; A</a> </li><li>  <a href="https://habr.com/ru/post/246425/">- Useful links</a> </li></ul><br><br>  And we start with the question: "What is wrong with IP?" <br><br><a name="habracut"></a><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/hZyfM4UZDac" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <i>Traditional video</i> <br><br>  And really, what's wrong?  Why fence MPLS? <br><a name="ABOUT_MPLS"></a><br>  Yes, everything is so.  The advantages and disadvantages of IP derive from the fact that it appeared later than classic networks and is incredibly flexible.  Nowadays, there is a transition to packet switching, which is based on IP at the network level, and Ethernet is gaining more and more popularity on the channel link. <br>  This is good, because now, on the basis of one backbone network and access network, you can provide <a href="http://lookmeup.linkmeup.ru/">broadband access</a> , IP-telephony, IPTV and other possible services. <br>  The same can be seen in the networks of mobile operators.  The network of the second generation at the dawn were entirely on the basis of <a href="http://lookmeup.linkmeup.ru/">circuit switching</a> .  The core of 3G networks is for the most part IP, but telephony services can still be provided in circuit-switched mode.  4G networks are already full-fledged IP networks, where voice transmission is only one of the applications, as well as broadband access. <br><br>  However, there is still a huge number of segments that use old technology.  For example, somewhere there is ATM, in another place you need to transfer PDH from one part of the network to another, and then the client wanted his piece of Ethernet-network to be accessible from the other end of the city as if he was connected directly - in other words VPN. <br>  As it was solved before: you need an ATM between two geographic points - build a channel between them based on ATM, PDH - build PDH. <br>  And you want to do all this through one network, and not to build a separate one for each type of traffic. <br>  For this, GRE, PPPoE, PPPoA, ATM over Ethernet, TDM over IP, and numerous other over'y were invented at one time.  You can create another thousand others to cover all the combinations, and universal happiness will come in the chaos of standards ( <i>by the way, some small manufacturers have gone this way</i> ). <br><br>  In the mid-90s, hotheads from several companies (IBM, Toshiba, Cisco, Ipsilon) came up with the idea of ‚Äã‚Äãcreating a mechanism for routing not looking inside the package and combining the routing table in search of a better way, but to be guided by a certain label.  Shot from Cisco, and the mechanism was called plain: TAG Switching. <br>  Moreover, the goal pursued by the developers was to allow high-speed switches to transmit traffic exclusively in hardware.  The fact is that hardware IP routing has been an inaccessible pleasure for a long time, and it was impractical to use it on low-cost switches, and making decisions based on the label could be simple and fast. <br>  But at the same time, super-large-scale integrated circuits have appeared (even if I do not agree with this term - the English <a href="http://en.wikipedia.org/wiki/Very-large-scale_integration">VLSI</a> describes the essence much better), and the task of saving on analyzing the contents of the package was not so relevant.  In addition, the concept of FIB appeared, which assumes that for each packet it is not necessary to search for a destination in the routing table and accordingly involve the central processor - all hot information is already on the line card. <br>  That is, in essence, the need for such a mechanism has disappeared. <br><br>  But <i>suddenly</i> it became clear that label switching has unplanned potential - it doesn‚Äôt matter what is under the label - IP, Ethernet, ATM, Frame Relay.  It also gives you the opportunity to get rid of the limitations of IP routing. <br>  Hence the technology approved by IETF - MPLS - MultiProtocol Label Switching.  It was the year 1997. <br>  And this, seemingly insignificant, detail gave rise to a new era in telecommunications.  Today MPLS can be found in any more or less large provider. <br><br>  Main MPLS applications now: <br><ul><li>  MPLS L2VPN </li><li>  MPLS L3VPN </li><li>  MPLS TE </li></ul><br><br>  We will talk about each of them in separate articles - these are monstrously huge topics.  But we will briefly touch them at the end of the article. <br><br><a name="FORWARDING"></a><br><h1>  MPLS </h1><br>  By itself, pure MPLS is rarely used.  The performance gain is insignificant, because the difference between looking at the FIB / changing some fields in the headers and seeing the table of labels / changing the label in the MPLS header is not that big.  Of course, its applications listed above are used. <br>  But in this article we will concentrate on pure MPLS, in order to understand how it works in its most basic form. <br>  <a href="https://habr.com/ru/post/246425/">Below we will</a> also <a href="https://habr.com/ru/post/246425/">consider</a> one application of pure MPLS. <br><br>  Despite the fact that MPLS is not tied to the type of network on which it will work, in our time it lives in symbiosis only with IP.  That is, the network itself is built on top of IP, but at the same time it can transfer data from many other protocols. <br>  But let's get to the point, and first I want to say that <b>MPLS does not replace IP routing</b> , but works on top of it. <br><br>  To be more specific, I will take such a network. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ab7/92c/4ab/ab792c4abdfea6ef13239d13279f6bab.png"><br><br>  Now it is fully operational, but without any hint of MPLS.  That is, R1, for example, sees R6 and can ping it with Loopback. <br>  PC1 sends an ICMP request to server 172.16.0.2.  An ICMP request is an IP packet.  On R1, according to the basic principles, the packet goes through the FE0 / 0 interface on R2 - the Routing Table said so. <br>  R2, after receiving the packet, checks the destination address, looks at its FIB, sees the next router and sends the packet to the FE0 / 0 interface. <br>  And this process is repeated time after time.  Each router independently decides the fate of the packet. <br><br>  This is how a traffic dump looks quite familiar: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/813/2e5/0fc/8132e50fc6d4ac836e1f340b19d056d4.png"><br><br>  What happens if we activate MPLS?  Immediately, at the same second the world changes.  After that, the label tables are filled in on routers and numerous LSPs are built. <br><br>  And now the same path will be done a little differently. <br><br><img src="https://habrastorage.org/files/32c/f20/5d3/32cf205d34d648caa6ab8c2983f754db.gif" width="900"><br><br>  When an IP packet from PC1 enters the MPLS network, the first router hangs a label, then this packet goes to the destination point, and each next router changes one label to another.  When you exit the MPLS network, the label is removed and the already clear IP packet is transmitted as it was at the very beginning. <br><br>  This is the basic principle of MPLS - routers switch packets by tags without looking inside the MPLS packet.  The first one adds, the last one deletes. <br><br>  Let us consider, step by step, the transfer of a data packet from PC1 to the destination node: <br><br>  <b>1.</b> PC1 - a normal computer - sends a normal package to a remote server. <br><br>  <b>2.</b> The package reaches R1.  It adds label 18. It is inserted between the IP header and Ethernet. <br>  This information can be obtained from the FIB: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/625/41e/23e/62541e23e4d76ca8e2a9f296994f7372.png"><br><br>  The FIB shows that the packet with the addressee <b>6.6.6.6</b> needs to be labeled <b>18</b> and sent to the interface <b>FE0 / 0</b> . <br>  Actually, this is what he does: he adds the heading and writes 18 to it: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d16/08c/6d2/d1608c6d2f1b8a3aad046e9a0ba2eae9.png"><br>  <i>Dump between R1 and R2</i> . <br><br>  <b>3.</b> R2 receives this packet, sees in the Ethernet header that it is an MPLS packet (Ethertype 8847), reads the label and refers to its tag table: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/824/e27/cf6/824e27cf6fcc1d0fd4000690fdab313a.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/976/12a/6fd/97612a6fd03f6bfab2eebe54fd56dfda.png"><br><br>  We read the letters: if the MPLS packet came with a mark of 18, you need to change it to 20 and send the packet to the FE0 / 0 interface. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/982/898/c90/982898c90022287f501d1d211daaf059.png"><br>  <i>Dump after R2.</i> <br><br>  <b>4.</b> R5 performs similar actions - sees that a packet with a label of 20 has arrived, it needs to be changed to 0 and sent to FE1 / 0.  Without any access to the routing table. <br><br>  <b>5.</b> R6, having received the MPLS package, sees in its table that the label must now be removed.  And, having removed it, he already sees that the recipient of the packet - 172.16.0.2 - is a Directly Connected network.  Next, the packet is transmitted in the usual way by the routing table already without any tags. <br><br><h5>  That is, the whole process looks like this: </h5><br><img src="https://habrastorage.org/files/c31/6ae/95b/c316ae95bc8d4450a30e99e111354025.gif"><br>  <i>We will not consider the end nodes in order not to complicate the scheme.</i> <br><br>  So far, it seems, everything is simple, even if it is not clear why. <br><a name="BGP-MPLS"></a><br>  Now the IGP and MPLS domains are the same, and MPLS only promises to us in the future some kind of buns: L2VPN, L3VPN, MPLS TE. <br>  But, in fact, even basic MPLS gives us advantages if we remember that we are a provider. <br>  As a provider, we do not use IGP protocols for routing between ASs.  For this we use BGP.  And it is in conjunction with BGP that the benefits of MPLS will become clear. <br>  Consider our network in conjunction with neighboring AS: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8c1/736/24d/8c173624de35861dd01faec049ac51e1.png"><br><br>  From the BGP release, we know that BGP must be configured <b>on every</b> router in our AS.  Otherwise we will not be able to transfer traffic from neighboring AS and our customers through our AS.  Each router must know all routes. <br><br>  But that was before MPLS! <br>  When MPLS is configured on our network, we no longer have to configure BGP on every router on the network.  It is enough to configure it only on border routers in the AS, on those that are connected to other clients or providers. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/35d/9cb/cbb/35d9cbcbba58691695b6a1f6859b5758.png"><br><br>  But this is not all good news.  In addition to the fact that BGP can now not be configured on each router in the AS, routers also do not need to create a label for each BGP prefix.  It is enough to know how to get to the IP address, which is listed as next-hop.  That is, if the BGP session is configured between Loopback0 R1 and Loopback0 R6, then nothing changes in the table of labels, even if each of them sends hundreds of thousands of routes via BGP: <br><br>  For example, several routes have come to router R1 via BGP from router R6: <br><img src="https://habrastorage.org/getpro/habr/post_images/170/19b/01d/17019b01d26155748c601685ef0a822a.png"><br><br>  Let's see how the packets that go to the network 100.0.0.0/16 will be processed: <br><img src="https://habrastorage.org/getpro/habr/post_images/ba3/1a8/a18/ba31a8a1862cd76619e3106096533500.png"><br><br>  In the output above, it is clear that packets 27 will be added to the packets. <br>  And, if you look at the table of labels, then there are no labels for routes that are known from BGP, but there is a label 27 and it corresponds to 6.6.6.6/32.  And this is exactly the address that we saw in the routes that came on BGP from R6: <br><img src="https://habrastorage.org/getpro/habr/post_images/132/a3f/512/132a3f512d3d34a2439bd32a57294984.png"><br><br>  An example of the setting you can find <a href="https://habr.com/ru/post/246425/">below</a> . <br><br>  We ran a little ahead, but now that it has become clearer what advantages even basic MPLS gives, we can plunge into the conceptual apparatus in the world of MPLS. <br><br><a name="GLOSSARY"></a><br><h1>  Terminology </h1><br>  <u><b>Label</b></u> - a label - a value from 0 to 1,048,575. Based on it, the LSR decides what to do with the package: which new label to hang, where to transfer it. <br>  It is part of the MPLS header. <br><br>  <u><b>Label Stack</b></u> - a stack of labels.  Each package can carry one, two, three, but at least 10 tags - one above the other.  The decision about what to do with the package is made on the basis of the upper tag.  Each layer plays its own role. <br>  For example, when transmitting a packet, a transport label is used, that is, a label that organizes transit from the first to the last MPLS router. <br>  Others may carry information that this packet belongs to a particular VPN. <br>  In this release there will always be only one label - more is not needed yet. <br><br>  <u><b>Push Label</b></u> ‚Äî the operation of adding a label to a data packet ‚Äî is done at the very beginning ‚Äî on the first router in the MPLS network (in our example, R1). <br><br>  <u><b>Swap Label</b></u> - label replacement operation - occurs on intermediate routers in the MPLS network - the node receives a packet with one label, changes it and sends it with another (R2, R5). <br><br>  <u><b>Pop Label</b></u> - label removal operation - performed by the last router - the node receives the MPLS packet and removes the <b>top</b> label before passing it on (R6). <br><br><blockquote>  In fact, a label can be added and removed anywhere within the MPLS network. <br>  It all depends on the specific services.  It would be more correct to say that the label is added by the first path router (LSP), and is removed last. <br>  But for simplicity, in this article we will talk about the boundaries of the MPLS network. <br>  In addition, the removal of the top label does not mean that there is a pure IP packet left, if we are talking about a stack of tags.  That is, if a Pop Label operation was performed on a package with three labels, then there are two labels left and then it is still processed as MPLS.  And in our example there was one, and after that there would be no one left - and this is already an IP case. <br></blockquote><br><br>  <u><b>LSR - <i>Label Switch Router</i></b></u> is any router in the MPLS network.  It is called that because it performs some operations with labels.  In our example, these are all nodes: R1, R2, R3, R4, R5, R6. <br>  LSR is divided into 3 types: <br>  <u><b>Intermediate LSR</b></u> - MPLS intermediate router - it performs the Swap Label operation (R2, R5). <br>  <u><b>Ingress LSR</b></u> - ‚Äúinput‚Äù, the first MPLS router - it performs the Push Label (R1) operation. <br>  <u><b>Egress LSR</b></u> is ‚Äúoutput‚Äù, the last MPLS router is performing the Pop Label (R6) operation. <br>  <u><b>LER - <i>Label Edge Router</i></b></u> is a router at the edge of the MPLS network. <br>  In particular, Ingress LSR and Egress LSR are boundary, which means they are also LER. <br><br>  <u><b>LSP - <i>Label Switched Path</i></b></u> - label switching path.  This is a unidirectional channel from the Ingress LSR to the Egress LSR, that is, the path that the packet will actually go through the MPLS network.  In other words, it is the LSR sequence. <br>  It is important to understand that the LSP is <b>in fact</b> unidirectional.  This means that, firstly, traffic is transmitted only in one direction, secondly, if there is ‚Äúthere‚Äù, it does not necessarily exist ‚Äúback‚Äù, thirdly, ‚Äúback‚Äù does not necessarily follow the same path, that "there".  Well, it's like the tunnel interfaces in GRE. <br><br>  What does LSP look like? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fc5/fe5/e0b/fc5fe5e0bf81d9205674c632fb3f2b39.png"><br><br>  Yes, that's so unpredictable. <br>  This is a compiled output from four LSRs - R1, R2, R5, R6.  That is, on the LSR you will not see the complete sequence of nodes from the input to the output, according to the type of the AS-PATH attribute in BGP.  Here, each node knows only the input and output labels.  But the LSP does exist. <br><br>  This looks a bit like IP routing.  Despite the fact that there is a path from point A to point B, the routing table only knows the next node to send traffic to.  But the difference is that the LSR does not decide on each packet based on the destination address ‚Äî the path is determined in advance. <br><br>  And one of the most important concepts that you need to understand - <u><b>FEC - <i>Forwarding Equivalence Class</i></b></u> .  For some reason it was very hard for me, although in fact everything is simple.  FEC are traffic classes.  In the simplest case, the class identifier is the destination address prefix (roughly speaking, the IP address or the destination subnet). <br>  For example, there are traffic flows from different clients and different applications that go all to the same address ‚Äî all these flows belong to the same class ‚Äî one FEC ‚Äî use the same LSP. <br>  If we take other streams from other clients and applications to another destination address, this will be a different class and another LSP respectively. <br><br><blockquote>  In theory, in addition to the destination address, FEC can take into account, for example, QoS labels, source address, VPN identifier, or application type.  It is important to understand here that packets of one FEC are not required to follow to the same destination address.  And at the same time, even if two packages follow to one place, they will not necessarily belong to one FEC. <br><br>  I will explain why all this is necessary.  The fact is that for each FEC, its own LSP is selected ‚Äî its own path through the MPLS network.  And then, for example, for WEB-surfing, you set the QoS <a href="http://lookmeup.linkmeup.ru/test">BE</a> priority - this will be one FEC - and for VoIP - <a href="http://lookmeup.linkmeup.ru/test">EF</a> - the other FEC.  And then you can specify that for the FEC BE the LSP should go in a wide but long and unguaranteed way, and for the FEC EF it can be narrow but fast. <br><br>  Unfortunately or fortunately, but now only an IP prefix can act as an FEC.  Things like QoS marking are not considered. <br></blockquote><br><br>  If you pay attention to the label table, the FEC is there, since the label replacement parameters are determined just on the basis of the FEC, but this is done only at the first moment in time - when these labels are distributed.  When real traffic is running on the LSP, no one except Ingress LSR looks at it ‚Äî only labels and interfaces.  Ingress LSR takes all the work to determine the FEC and in which LSP to send traffic - after receiving a clean packet, it analyzes it, checks which class it belongs to, and hangs the corresponding label.  Packages of different FECs will receive different labels and will be sent to the appropriate interfaces. <br>  Packages of the same FEC receive the same label. <br><br>  That is, intermediate LSRs are threshers, which for all transit traffic only do the switching of tags.  And all the intellectual work is done by Ingress LSR. <br><br>  <u><b>LIB - <i>Label Information Base</i></b></u> - a table of labels.  Analogue of the routing table (RIB) in IP.  It indicates for each input label, what to do with the package - change the label or remove it and which interface to send. <br>  <u><b>LFIB - <i>Label Forwarding Information Base</i></b></u> - by analogy with the FIB - this is the label base that the network processor refers to.  When you receive a new package, there is no need to contact the CPU and lookup into the table of tags - everything is already at hand. <br><hr><br><br>  One of the initial ideas of MPLS - to maximize the spread of Control Plane and Data Plane - went into oblivion. <br>  Developers wanted that when transmitting a packet through a router there was no analysis - just read the label, changed it to another one, transferred it to the correct interface. <br>  To achieve this, there were just two separated processes - a relatively long construction of a path (Control Plane) and a fast transfer of traffic along this path (Data Plane) <br><br>  But with the advent of cheap chips (ASIC, FPGA) and the FIB mechanism, the usual IP transmission also became fast and simple. <br>  For the router, it doesn't matter where to look when sending a packet - in the FIB or in the LFIB. <br>  But what is undoubtedly important and useful is that MPLS‚Äôs indifference to what is transmitted under its heading ‚Äî IP, Ethernet, ATM.  No need to fence GRE or any other uncomfortable VPNs before the pain in the joints.  But let's talk more about this. <br><br><h2>  MPLS header </h2><br>  The entire MPLS header is 32 bits.  The format of the fields and their length are fixed.  Often the entire title is called a tag, although this is not entirely true. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1ac/41b/b2d/1ac41bb2d984d5f88172929fa6e83f44.png"><br><br>  <b><i>Label</i></b> is the label itself.  The length is 20 bits. <br>  <b><i>TC</i></b> - Traffic Class.  It carries the packet priority, as the DSCP field in IP. <br>  Length 3 bits.  That is, it can encode 8 different values. <br>  For example, when an IP packet is transmitted over an MPLS network, the value in the DSCP field is definitely assigned the value of TC.  Thus, a packet can be processed almost equally in queues all along its path, both on a pure IP site and in MPLS. <br>  But, naturally, this is a lossy conversion ‚Äî the six bits of the DSCP are closely in 3 bits of TC: 64 against 8. Therefore, there is a special correspondence table, where the whole range is just one value. <br><blockquote>  Initially, the field was called EXP (experimental), and its contents were not regulated.  It was assumed that it can be used for research, the introduction of new functionality.  But this is in the past. <br>  If someone argues with you that this field is experimental and not formally approved for the QoS function, it <s>does not look farther</s> <a href="http://packetlife.net/blog/2009/mar/2/mpls-qos-no-longer-experimental/">behind life</a> . <br></blockquote><br><br><blockquote>  <i>=====================</i> <i><br> <a href="http://linkmeup.ru/blog/155.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"></a></i>  <i><a href="http://linkmeup.ru/blog/155.html"><b>Problem number 1</b></a></i> <i><br><br></i>  <i>The network has a simple QoS policy configured in which IP packets that come from host 10.0.17.7 to address 6.6.6.6 are marked and transmitted over the MPLS network.</i>  <i>For marking of packages, the EXP field is used, the value of field 3.</i> <i><br><br></i> <div class="spoiler">  <i><b class="spoiler_title">Scheme</b></i> <div class="spoiler_text"> <i><img src="https://habrastorage.org/getpro/habr/post_images/d25/ba6/1ae/d25ba61aea0a08460d54480061b0927a.png"><br></i> </div></div> <i><br><br>   R6   QoS,      EXP. <br> ,   ,    R6  .  ,  ,    EXP 3      class default. <br><br> :   ,    R6 . <br><br>  R7    .  MPLS  R7  R1  . <br><br>     <a href="http://linkmeup.ru/blog/155.html"></a> . <br></i>  <i>=====================</i> <i><br></i> </blockquote><br><br> <b><i>S</i></b> ‚Äî Bottom of Stack ‚Äî       1 .  MPLS     , ,      MPLS,      VPN.  LSR      .   S  ¬´1¬ª,     (  )  ¬´0¬ª,       (  ).   LSR  ,     ,  ,     ‚Äî      - .          ,   ,    . ,  ,   ,     :     MPLS    -  (IP, Ethernet, ATM, FR ). <br><br><blockquote>    : ‚Äú,  ,   ,     ‚Äù ‚Äî   .   MPLS,   ,     ( Ethertype  Ethernet'  Protocol  IP). <br>      ‚Äî      ‚Äî  ,    ,      ,      ? <br>     ‚Äî ,    ,         ,   ,     ‚Äî  IP   Ethernet    -.          .    ,    Pop Label,     (   ) ,   . <br></blockquote><br><br><img src="https://habrastorage.org/getpro/habr/post_images/638/510/cc9/638510cc9eaac5c3e4f1cdad6a20958f.png"><br><br>  ,      ‚Äî  ,   (LIFO ‚Äî Last Input ‚Äî First Output). <br><br>  ,   ,    MPLS ,      ‚Äî       . <br><br> <b><i>TTL</i></b> ‚Äî Time To Live ‚Äî   <a href="http://lookmeup.linkmeup.ru/">IP TTL</a> .       ‚Äî 8 .   ‚Äî          .   IP-   MPLS  IP TTL     MPLS TTL,   .      255,       IP  IP TTL   ,   . <br><hr><br><br>  ,  MPLS       ,    ‚Äî   IP ‚Äî .   MPLS   2,5 ,   ‚Äî Shim-header ‚Äî -. <br> <i> ,        MPLS.   IETF,      ATM, AAL5, Frame Relay. <br></i> <br><br>      : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6cb/541/d98/6cb541d988a9e06a42ec3a717c59ff0b.png"><br><br><h2>   </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As mentioned above, there may be 2 ^ 20 labels. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Some of them are reserved: </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IPv4 Explicit NULL Label</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . "Explicit empty label." It is used on the very last MPLS span - before the Egress LSR - in order to notify it that this 0 mark can be removed without looking at the tag table (more precisely LFIB). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For those FECs that originate locally (directly connected), Egress LSR selects label 0 and sends it to its neighbors ‚Äî the penultimate LSR (Penultimate LSR). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When transmitting a data packet, the penultimate LSR changes the current label to 0. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When the Egress LSR receives a packet, it knows for sure that the top label just needs to be removed.</font></font><br><br><blockquote>  This was not always the case.  ,   0              , LSR      MPLS    . <br>  -      ,          ,     . <br>     0    ()    Pop Label   ,             . <br></blockquote><br><br> <b>1</b> :  <i>Router Alert Label</i> ‚Äî   Router Alert  IP ‚Äî    ,   .      ,      ,        ,    ‚Äî  ,          1. <br><br> <b>2</b> : <i>IPv6 Explicit NULL Label</i> ‚Äî  ,   0,       IP. <br><br> <b>3</b> : <i>Implicit Null</i> .  ,        MPLS  Egress LSR.    ,       MPLS .   . <br><br> <b>4-15</b> : . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Depending on the vendor, other tag values ‚Äã‚Äãcan be fixed, for example, on Huawei equipment, labels 16-1023 are used for static LSPs, and everything above is in dynamic ones. </font><font style="vertical-align: inherit;">In Cisco, available tags start at the 16th.</font></font><br><br><blockquote>  <i>=====================</i> <i><br> <a href="http://linkmeup.ru/blog/156.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem number 2</font></font></b></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In the following diagram, all routers except R5 are Huawei routers. </font><font style="vertical-align: inherit;">R5 - Cisco.</font></font><br><br></i> <div class="spoiler"> <i><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scheme</font></font></b></i> <div class="spoiler_text"> <i><img src="https://habrastorage.org/getpro/habr/post_images/37c/2b3/094/37c2b309425f77169cc8daf757c5f7fb.png"><br></i> </div></div> <i><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For the R5 router configuration below, you need to configure it so that the distribution of tag values ‚Äã‚Äãmatches Huawei. </font><font style="vertical-align: inherit;">Speech that in Huawei dynamic tags begin with 1024, and in Cisco with 16.</font></font><br><br></i> <div class="spoiler"> <i><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R5 configuration</font></font></b></i> <div class="spoiler_text"><pre><code class="bash hljs">ip cef ! interface Loopback0 ip address 5.5.5.5 255.255.255.255 ip router isis ! interface FastEthernet0/0 description to R4 ip address 10.0.45.5 255.255.255.0 ip router isis mpls ip ! interface FastEthernet0/1 description to R2 ip address 10.0.25.5 255.255.255.0 ip router isis mpls ip ! interface FastEthernet1/0 description to R6 ip address 10.0.56.5 255.255.255.0 ip router isis mpls ip ! router isis net 10.0000.0000.0005.00 ! mpls ldp router-id Loopback0 force</code> </pre> <br></div></div><br><br>  Details of the problem <a href="http://linkmeup.ru/blog/156.html">here</a> . <br>  ===================== <br></blockquote><br><br><hr><br><br>  In general, it became clear how traffic is transmitted and how MPLS tags are involved. <br>  But tags are not taken from the bald - no one needs additional chaos on the eve of the New Year.  Special protocols allocate labels between the Egress LSR and Ingress LSR, creating the LSP. <br><br><a name="LABEL_DISTRIBUTION"></a><br><h1>  Label distribution </h1><br>  First, as you already understood, on some devices you can do everything manually - vivat diligence and diligence! <br>  But in the era of automatic washing machines, there are three basic protocols for distributing tags - LDP, RSVP-TE and MBGP. <br><br>  In short, the LDP - the easiest and most understandable way - is based on the routing information of the nodes.  RSVP-TE is a development of the once-developed but unpopular <a href="http://lookmeup.linkmeup.ru/">RSVP</a> protocol ‚Äî it is used in MPLS-TE to build LSPs that meet certain conditions.  IGP supporting Traffic Engineering (OSPF, ISIS) are necessary for its work. <br>  MBGP is a close relative of BGP, but it‚Äôs a protocol from a slightly different story, it passes tags for other purposes.  Therefore, it stands aside from the LDP and RSVP-TE. <br><br>  Let's talk about each of them, but before that, a few words about how LSRs handle tags in general. <br><a name="MODES"></a><br><h3>  Tag Distribution Methods </h3><br>  The first obvious fact is that the tags are distributed in the direction from the traffic receiver to the sender, and more precisely from the Egress LER to the Ingress LER.  The first unobvious fact - in MPLS Downstream - is from the sender to the receiver, and Upstream from the receiver to the sender.  For myself, I defined it this way: LSP ‚Äúgrows‚Äù from FEC <b>up</b> to Ingress LER, like a tree, and user traffic ‚Äúgoes down‚Äù to the recipient along the LSP, like rainwater along branches.  That is, tags are distributed to meet traffic. <br><br>  They also say that the LSP is built to meet traffic. <br><br>  The very mechanism of distribution of tags depends on the protocol, settings and manufacturer. <br><br><a name="DU_DOD"></a><br><h5>  DU vs DoD </h5><br>  <u>First</u> , the router can distribute tags to all its neighbors immediately and without unnecessary questions, and can issue it on request from the superiors (we remember, yes, which direction is called Upstream?) <br>  The first mode is called <u><b>DU - <i>Downstream Unsolicited</i></b></u> .  As soon as the LSR learns about FEC, it sends tags to all its MPLS neighbors for this FEC. <br>  It looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a7b/cfa/0c4/a7bcfa0c4e6604185cf84ad1ccae91ad.png"><br><br>  All LSRs will learn about all FECs in all possible ways.  First, the FEC-tagging diverges across the entire network from neighbor to neighbor, almost as it does with the <a href="http://lookmeup.linkmeup.ru/">BootStrap</a> messages in the PIM SM.  And then each LSR chooses only the one that came along the best path, and uses it for the LSP - <a href="http://lookmeup.linkmeup.ru/">Reverse Path Forwarding</a> in the same <a href="http://linkmeup.ru/blog/129.html">PIM SM</a> works in the same way. <br><br>  Quickly, simply, clearly, although it is not always necessary for everyone to know everything. <br><br>  The second mode - <u><b>DoD - <i>Downstream-on-Demand</i></b></u> .  The LSR knows the FEC, it has neighbors, but until they ask what label is for this FEC, the LSR remains silent. <br><br><img src="https://habrastorage.org/files/b56/523/10c/b5652310c50f4238938f1bda1e8e7206.gif"><br><br>  This method is convenient when some requirements are imposed on the LSP, for example, on the bandwidth.  Why send a tag just like that if it is immediately dropped?  Better, the superior LSR will ask the downstream: I need a label from you for this FEC - and that one is: ‚Äúok, on‚Äù. <br><br>  The tag selection mode is interface specific and is determined at the time the connection is established.  Both ways can be used on the network, but on the same line, neighbors should only agree on one specific one. <br><a name="LABEL_CONTROL"></a><br><h5>  Ordered Control vs. Independent Control </h5><br>  <u>Second</u> , the LSR can wait for the FEC label to come from the Egress LER side before telling its upstream neighbors.  Or maybe send out tags for FEC as soon as I found out about him. <br><br>  The first mode is called <b><u>Ordered Control.</u></b> <br><br><img src="https://habrastorage.org/files/36f/ea5/c7e/36fea5c7edcb49679ded58494d19d604.gif"><br><br>  Ensures that by the time of data transfer all the way up to the output LER will be built. <br><br>  The second mode is <u><b>Independent Control</b></u> . <br><br><img src="https://habrastorage.org/files/08d/b3d/af5/08db3daf5031411a9e2b6fcc1407fe16.gif"><br><br>  That is, tags are transmitted in an irregular manner.  Convenient in that traffic can begin to transmit even before the entire path is built.  The same is dangerous. <br><br><a name="RETENTION_MODE"></a><br><h5>  Liberal Label Retention Mode vs Conservative Label Retention Mode </h5><br>  <u>Thirdly</u> , it is important how the LSR handles the labels passed to it. <br>  For example, in such a situation, should R1 store the information about tag 20 received from neighbor R3, which is not the best way to get to R6? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2cb/652/ddc/2cb652ddc7f31748a2cf4a772702fb08.png"><br><br>  And this is determined by the label holding mode. <br>  <b><u>Liberal Label Retention Mode</u></b> - tags are retained.  In the case when R3 becomes the next step (for example, problems with the main route), the traffic will be redirected more quickly, because the label is already there.  That is, the reaction rate is higher, but the number of tags used is also large. <br>  <b><u>Conservative Label Retention Mode</u></b> - an extra label is discarded as soon as it is received.  This reduces the number of tags used, but MPLS will respond more slowly in the event of an accident. <br><br><a name="PHP"></a><br><h5>  Php </h5><br>  No, this is not the PHP you thought of.  It's about <b>Penultimate Hop Popping</b> .  All the engineers are a <i>little</i> optimizers, and here the guys thought: why should we process the MPLS headers twice - first on the penultimate router, then on the output one. <br>  And they decided that the label should be removed on the penultimate LSR and called this action - PHP. <br>  For PHP there is a special label - 3. <br>  Returning to our example, for FEC 6.6.6.6 and 172.16.0.2 R6 allocates label 3 and reports it to R5. <br>  When sending a packet to R6, R5 should assign it a dummy tag - 3, but in fact it does not apply and a bare IP packet is sent to the interface (note that PHP only works on IP networks) - that is, the Pop Label procedure was performed on R5 . <br><br>  Let's follow the life of the package, taking into account everything that we now know. <br><br><img src="https://habrastorage.org/files/2c7/449/998/2c74499985d7463da7e67beac679038f.gif"><br><br>  With how traffic is transmitted, it seems, more or less clear.  But who performs all the titanic work on creating labels, filling in tables? <br><br><a name="PROTOCOLS"></a><br><h1>  Label Distribution Protocols </h1><br>  There are not so many of them - three: LDP, RSVP-TE, MBGP. <br>  There are two global goals - the distribution of transport marks and the distribution of service tags. <br>  Explain that <u>transport labels</u> are used <b>to transmit traffic</b> over an MPLS network.  These are the ones we are talking about the whole issue.  LDP and RSVP-TE are used for them. <br><br>  <u>Service tags</u> are used <b>to separate</b> different services.  This is where MBGP and the LDP process - <a href="http://lookmeup.linkmeup.ru/test">tLDP</a> come into the arena. <br>  In particular, MBGP allows, for example, to mark that such a route belongs to such a VPN.  Then he sends this route as a vpn-ipv4 family to his neighbor with a tag, so that he can then separate the flies from the chops. <br>  So, so that he could separate, and he needs to report on compliance label-FEC. <br>  But this is the action of another play, which we will play in another six months or a year. <br><br>  A prerequisite for the operation of all dynamic label distribution protocols is the basic setting of IP connectivity.  That is, the network must be running IGP. <br><hr><br><br>  Well, now, when I have completely confused you, you can begin to unravel. <br>  So what is the easiest way to distribute tags?  The answer is to enable LDP. <br><br><a name="LDP"></a><br><h2>  LDP </h2><br>  The protocol with a very transparent name - <b>Labed Distribution Protocol</b> - has an appropriate working principle. <br>  Consider it on the network linkmeup, which we muzyzhim entire issue: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b0c/860/e9c/b0c860e9c51aa36fc8bf612ee1ae4127.png"><br><br>  <b>1.</b> After LDP is enabled, LSR multicasts sending UDP datagrams to all interfaces to the address 224.0.0.2 and port 646, where LDP is activated - this is how the neighbors are searched. <br>  The TTL of such packets is 1, since the LDP-neighborhood is established between directly connected nodes. <br><br><blockquote>  <i>Generally speaking, this is not always the case - a LDP session can be established for certain purposes and with a remote node, then it is called tLDP - <a href="http://lookmeup.linkmeup.ru/test">Targeted LDP</a> .</i>  <i>We will talk about it in other issues.</i> <i><br></i> </blockquote><br>  Such messages are called <b>Hello</b> . <br><br>  <b>2.</b> When neighbors are detected, a TCP connection is established with them, also on port 646 - <b>Initialization</b> .  Further messages (except Hello) are transmitted already with a TTL of 255. <br><br>  <b>3.</b> Now LSR periodically exchange messages <b>Keepalive is</b> addressable over TCP and still keep trying to find neighbors using Hello. <br><br>  <b>4.</b> At some point, one of the LSRs finds a second person in itself ‚Äî the Egress LSR ‚Äî that is, it is the output for some FEC.  This is a fact that you need to inform the world. <br>  Depending on the mode, it waits for a request for a label for this FEC, or sends it immediately. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0ff/eb8/04b/0ffeb804b3e9b2833e68a28a3ced0926.png"><br><br>  This information is transmitted in the message <b>Label Mapping Message</b> .  Based on the name, it carries the correspondence of FEC and labels. <br><br>  R5 receives information on the compliance of FEC 6.6.6.6/32 and label 3 (implicit null) and writes it into its table of labels.  Now, when he needs to send data to 6.6.6.6, he will know that he needs to remove the top MPLS header and send the remaining packet to the FE1 / 0 interface. <br><br>  Next, he selects the input label for this FEC, writes this information to his label table, and sends it to his upstream neighbors. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6f0/4b6/734/6f04b673471f57f639a9bbacb957384c.png"><br><br>  Now R5 knows that if an MPLS packet with a label of 20 arrived, it needs to be sent to the FE1 / 0 interface, removing the label, that is, following the PHP procedure. <br><br>  R2 receives from R5 information about compliance with the FEC-tag (6.6.6.6 - 20), inserts it into the table and, creating its input label (18), transmits it even higher.  And so on, until all LSRs get their output label. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/374/25c/75e/37425c75e09bbcc2b9361fa95c677cb2.png"><br><br>  Thus, we have built LSP from R1 to R6.  R1, when sending a packet to 6.6.6.6/32, adds a label 18 to it (Push Label) and sends it to port FE0 / 0.  R2, receiving a packet with label 18, changes the label to 20 (Swap Label) and sends it to port FE0 / 0.  R5 sees that for a packet with a label of 20, you need to run PHP (output label - 3 - implicit null), removes the label (Pop Label) and sends data to the port FE1 / 0. <br><br>  At the same time, LSPs from R2 to R6, from R5 to R6, from R4 to R6, etc., were built in parallel.  That is, from all LSR - I just did not show it in the illustration. <br><br>  If you have enough strength, then on the gif below you can see the whole process in dynamics. <br><br><img src="https://habrastorage.org/files/b13/71a/cab/b1371acab49e47c9bab46aa0af23123b.gif"><br><br>  Naturally, you understand that not only R6 suddenly began sending out its own correspondences to the FEC-tag, but all the others - R1 about 1.1.1.1/32, R2 - 2.2.2.2/32 and so on.  All of these messages are lightning fast spread across the MPLS network, building dozens of LSPs.  As a result, each LSR will know about all existing FECs and a corresponding LSP will be built. <br><br>  Again, on the gif above, the process is not fully shown, then R1 then transfers information to R3, R3 to R4, R4 to R5. <br>  And if we look at R5, then we see that for FEC 6.6.6.6/32 we have more than one output label, as expected, but 3: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0d9/000/f38/0d9000f3850ff737d73d7266c9b5d91e.png"><br><br>  Moreover, R6 itself will record a label for FEC 6.6.6.6, which it will receive from R5: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9a9/ce0/1be/9a9ce01be287ac87def2999293236961.png"><br><br>  <i>Inuse</i> - correct - <b>imp-null</b> towards R6.  But the other two of the ring are from R2 and R4.  This is not a mistake and not a loop - just R2 and R4 generated these labels for the FEC 6.6.6.6/32 routing table that he knows about. <br><br>  There are two questions: <br>  1) How does he plan to use them?  They are stupid.  The answer: no way.  There can be no such situation in our network when 2.2.2.2 or 4.4.4.4 will be the next nodes on the way to 6.6.6.6 ‚Äî IGP will not build a route like this.  This means that tags will not be used.  It's just that the LDP is stupid - its messages scatter across the entire network, making their way into every crack.  A smart LSR already decides which one to use. <br>  2) What about loops?  Will the LDP message ply the network until the TTL expires? <br>  And here everything is simple - receiving a new message Label Mapping Message does not initiate the creation of a new one - the resulting correspondence is simply recorded in the LDP table.  That is, in our case, the R5 has already invented once the label for FEC 6.6.6.6/32 and sent it to its higher neighbors and it will not change until the LDP process restarts. <br><blockquote>  <i>You may have noticed that when configuring LDP, you can enable Loop Detection functionality, but I hasten to reassure you - this is for networks with no TTL, for example, ATM.</i>  <i>This functionality will switch LDP to DoD mode.</i> <i><br></i> </blockquote><br>  This is basic information on how LDP works. <br>  In fact, everything here is very dependent on the manufacturer.  In principle, LDP supports all kinds of work with tags: DoD / DU, Independent Control / Ordered Control, and Conservative / Liberal Label Retention.  This is not regulated by the RFC, so each vendor is free to choose his own path. <br>  For example, basically everyone uses DUs for LDP, but at the same time, Juniper tags are distributed in an orderly manner, and at Cisco independently. <br>  Only Loopback LSR interfaces are selected as the FEC in Huawei and Juniper, and Cisco FEC is created for all entries in the routing table. <br><br>  But all this is hardly somehow reflected on the real network. <br><br>  The most important thing to understand about LDP is that it does not use dynamic routing protocols in its work ‚Äî it works similarly to <a href="http://linkmeup.ru/tag/%25D1%2581%25D0%25B5%25D1%2582%25D0%25B8%2520%25D0%25B4%25D0%25BB%25D1%258F%2520%25D1%2581%25D0%25B0%25D0%25BC%25D1%258B%25D1%2585%2520%25D0%25BC%25D0%25B0%25D0%25BB%25D0%25B5%25D0%25BD%25D1%258C%25D0%25BA%25D0%25B8%25D1%2585/">PIM DM</a> in its operation: it floods the entire network with tags, but it relies on information from the LSR routing table.  And if two labels for one FEC from different neighbors come to R1, then it will select for the LSP only the one that is received through the best interface before this FEC according to the information from TM. <br>  This means three things: <ul><li>  You are free to choose IGP, which you like best, even RIP. </li><li>  LDP always builds only one (best) route and cannot build, for example, a backup one. </li><li>  When the network topology changes, the LSP will rebuild according to the updated routing table, that is, the IGP must first converge, and only then the LSP will rise. </li></ul><br><br>  And in general, after LDP is turned on, traffic will go the same way as without it, with the only difference that MPLS labels appear. <br>  Including LDP, like IP, supports <a href="http://lookmeup.linkmeup.ru/">ECMP</a> , just hash calculation algorithms, and accordingly balancing may differ. <br><br>  An interesting <a href="http://blog.ipspace.net/2011/11/junos-versus-cisco-ios-mpls-and-ldp.html">article</a> from Ivan Pepelnyak on the topic of LDP and a <a href="http://blog.ipspace.net/2014/10/tech-talks-introduction-to-label.html">video</a> on how the protocol works. <br><br>  LDP is described in <a href="https://tools.ietf.org/html/rfc5036">RFC 5036</a> . <br><a name="LDP_PRACTICE"></a><br><h3>  LDP practice </h3><br>  Stay true to the network linkmeup. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b0c/860/e9c/b0c860e9c51aa36fc8bf612ee1ae4127.png"><br><br>  OSPF is running, routers see Loopback and each other, MPLS is turned off. <br><br>  <a href="https://docs.google.com/document/d/1YZUNAu3NmdXyTOt118jjxRrA-p61kUVcpkf6yS-WHxQ/pub">Initial configuration file.</a> <br><br>  To enable MPLS globally, you need to give two commands: <br><pre> <code class="bash hljs">R1(config)<span class="hljs-comment"><span class="hljs-comment">#ip cef R1(config)#mpls ip</span></span></code> </pre> <br>  The first is already standard de facto and de jure on almost any network equipment - it starts the CEF mechanism on the router, the second starts MPLS and LDP globally (can also be given by default). <br><br>  The Router ID (and in the more general (non-cyclic) LSR ID terminology) in MPLS is straightforwardly chosen: <br><ol><li>  Largest Loopback Interface Address </li><li>  If not, the largest IP address configured on the router. </li></ol><br>  Naturally, do not trust the automatics - we will configure the LSR ID manually: <br><pre> <code class="bash hljs">R1(config)<span class="hljs-comment"><span class="hljs-comment"># mpls ldp router-id Loopback0 force</span></span></code> </pre> <br>  If you do not add the <b>force</b> keyword, the Router ID changes only when the LDP session is reset.  <b>Force</b> forces the router to change its Router ID by force and, if necessary (if it has changed), reestablishes the LDP connection. <br><br>  Next on the right interfaces, we give the command <b>mpls ip</b> : <br><pre> <code class="bash hljs">R1(config)<span class="hljs-comment"><span class="hljs-comment">#interface FastEthernet 0/0 R1(config-if)#mpls ip R1(config)#interface FastEthernet 0/1 R1(config-if)#mpls ip</span></span></code> </pre> <br>  Cisco here again uses its principle of a lazy engineer - a minimum of effort from the staff.  The <b>mpls ip</b> command turns on the LDP interface simultaneously with MPLS, whether we like it or not.  Similarly, the <b>ip pim sparse-mode</b> command enables IGMP on the interface, as I described it in the <a href="http://linkmeup.ru/blog/129.html">multicast</a> article. <br>  After activating the LDP, the router begins to probe the soil via UDP: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0e6/33c/f62/0e633cf623c854decca78e7ed8dfa12f.png"><br>  Checks are sent to multicast address 224.0.0.2. <br><br>  Now we repeat all the same manipulations on R2 <br><pre> <code class="bash hljs">R2(config)<span class="hljs-comment"><span class="hljs-comment">#ip cef R2(config)#mpls ip R2(config)# mpls ldp router-id Loopback0 force R2(config)#interface FastEthernet 0/0 R2(config-if)#mpls ip R2(config)#interface FastEthernet 0/1 R2(config-if)#mpls ip</span></span></code> </pre> <br>  and enjoy the result. <br>  R2 is also looking for neighbors. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/286/a04/5ce/286a045ce8c56b9337cbbb355780e290.png"><br><br>  We learned about each other, and R2 raises the LDP session: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/511/d1c/795/511d1c7953d4778c8fc5da77ca2dd387.png"><br><br><div class="spoiler">  <i><b class="spoiler_title">If you are interested in how they establish a TCP connection</b></i> <div class="spoiler_text"> <i><img src="https://habrastorage.org/getpro/habr/post_images/9c2/7ca/8ce/9c27ca8ceaac4d5bebdd2d16f6b550d1.png"></i> </div></div> <i><br></i> <br><br><br>  Now they are neighbors, which is easily verified with the <b>show mpls ldp neighbor command</b> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f99/4e1/d28/f994e1d28bd3c35e3d3e7aa0fffdb424.png"><br><br>  And then one tells the other about their correspondences FEC-tag: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/383/c5e/397/383c5e39775d73974ce23d3ac3dd22ca.png"><br><br><blockquote>  Here you can see the details - R1 sends 12 FECs at once - one for each entry in its routing table.  In the same situation, Huawei or Juniper would transfer only six FEC - Loopback interface addresses, because they consider FEC only / 32-prefixes by default. <br>  In this regard, Cisco is very unequivocal about tagging resources. <br>  However, this behavior can be changed on any equipment.  In our case, the <b>mpls ldp advertise-labels</b> command can help. <br><br>  But how so, you ask?  Is it enough to have tags only in Loopback? <br><br>  If we <a href="https://habr.com/ru/post/246425/">recall</a> that we considered the articles at the beginning, that BGP prefixes do not receive their labels, and that labels are needed only for next-hop, it becomes clear that there will be enough labels for Loopback. <br><br>  In order to get to other networks within our AS, IGP is enough for us. <br></blockquote><br><br><blockquote>  <i>=====================</i> <i><br> <a href="http://linkmeup.ru/blog/157.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"></a></i>  <i><a href="http://linkmeup.ru/blog/157.html"><b>Problem number 3</b></a></i> <i><br><br></i>  <i>If Cisco announces tags by default for all networks (except those received via BGP), then Juniper, by default, only loopbacks are announced.</i> <i><br><br></i> <div class="spoiler">  <i><b class="spoiler_title">Scheme</b></i> <div class="spoiler_text"> <i><img src="https://habrastorage.org/getpro/habr/post_images/37c/2b3/094/37c2b309425f77169cc8daf757c5f7fb.png"><br></i> </div></div> <i><br></i>  <i>All routers except R5 are Juniper routers.</i> <i><br><br></i>  <i>For the following R5 router configuration, tune it so that the Cisco router settings match the default settings in Juniper.</i> <i><br><br></i> <div class="spoiler">  <i><b class="spoiler_title">R5 configuration</b></i> <div class="spoiler_text"><pre> <i><code class="bash hljs">ip cef ! interface Loopback0 ip address 5.5.5.5 255.255.255.255 ip router isis ! interface FastEthernet0/0 description to R4 ip address 10.0.45.5 255.255.255.0 ip router isis mpls ip ! interface FastEthernet0/1 description to R2 ip address 10.0.25.5 255.255.255.0 ip router isis mpls ip ! interface FastEthernet1/0 description to R6 ip address 10.0.56.5 255.255.255.0 ip router isis mpls ip ! router isis net 10.0000.0000.0005.00 ! mpls ldp router-id Loopback0 force</code></i> </pre> <i><br></i> </div></div> <i><br><br></i>  <i>Details of the problem <a href="http://linkmeup.ru/blog/157.html">here</a> .</i> <i><br></i>  <i>=====================</i> <i><br></i> </blockquote><br><br><img src="https://habrastorage.org/getpro/habr/post_images/8cd/5ad/37f/8cd5ad37f0c66e2e046fa155057d71ab.png"><br><br>  So <b>R1</b> informs R2 that if he wants to send traffic for <b>FEC 3.3.3.3</b> , he must use tag <b>17</b> . <br><br>  Please note that LDP on R3 has not yet been raised, that is, R1 announced the label for FEC 3.3.3.3, without waiting for it from R5, this indicates that Independent Control is used. <br>  And the fact that there was no explicit request from R2 for this FEC indicates that the mode is Downstrean unsolicited. <br><br>  Next, the nodes will continue to monitor new neighbors using Hello LDP over UDP and exchange LDP Keepalive already targeted: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e90/5b9/b9a/e905b9b9a893d47c6deff64f99518916.png"><br><br>  Now, using the <b>show mpls forwarding-table</b> command, you can see which tags have been assigned to each FEC: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ecb/c9b/8ea/ecbc9b8ea05891b4b21646463afaee84.png"><br><br>  On the second line, the FEC 3.3.3.3 already considered, and we see that for it the local label is 17, that is, R1 will tell everyone that for FEC 3.3.3.3 it is 17, which was in the dump. <br>  But outgoing tag or output tag - <i>Untagged</i> - this means that packets are sent to a <b>pure</b> IP (without any reservations on the stack).  Moreover, <i>Untagged</i> means that there is no MPLS between R1 and R3 at all - that's right: we didn‚Äôt turn it on to R3. <br>  But with R2 (first line) the situation is different.  Local label 16 is what R1 will transmit to everyone.  And the output - <i>Pop tag</i> .  That is, when sending a packet to R2, R1 should remove the label.  In our case, this means that pure IP will be transmitted (but in a more general case, only the top tag is removed).  What is the difference with FEC 3.3.3.3?  And the difference is that between R1 and R2 there is MPLS and what we see is the same PHP - Penultimate Hop Popping.  A packet addressed to 2.2.2.2 will still be processed on R2, so in order not to produce entities beyond the necessary R1 will helpfully remove the label. <br><br>  And then an interesting question arises, how does R1 know that it is the penultimate of the Mohicans?     ,  LDP    ,      ,   2.2.2.2     R2 ‚Äî    ,  2.2.2.2   10.0.12.2. <br><br>          R2  R1: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ec9/932/644/ec9932644908b97cdf17f1f35c29e9ec.png"><br><br>       3 ‚Äî implicit-null.   R2 ,  R1    MPLS    . <br>    ‚Äî R1      3  R2 ‚Äî      .       IP-.   3      MPLS. <br>     3     MPLS,  <i>Pop Tag</i> . <br><br>   R5  R6    ,    MPLS  ,    ,       R2,  R2   FEC-  .      R6   <b></b>  MPLS  R1  R2  <b> </b> . <br> ,    Ordered Control, R2       R5  R6,       IP. <br><br>    MPLS+LDP      .      ‚Äî   Neighbor Discovery, Initialization,  , PHP. <br><br>   : <br><pre> <code class="bash hljs">&lt;b&gt;mpls ip&lt;/b&gt; ! interface Loopback0 ip address 1.1.1.1 255.255.255.255 ip router isis ! interface FastEthernet0/0 description to R2 ip address 10.0.12.1 255.255.255.0 ip router isis &lt;b&gt; mpls ip&lt;/b&gt; ! interface FastEthernet0/1 description to R3 ip address 10.0.13.1 255.255.255.0 ip router isis &lt;b&gt; mpls ip&lt;/b&gt; ! router isis net 10.0000.0000.0001.00 ! &lt;b&gt;mpls ldp router-id Loopback0 force&lt;/b&gt;</code> </pre><br><br> <a href="https://docs.google.com/document/d/1QgtI-U-EGp0no_vshOW5pDvO8pZoGb3eHenlt_qaPTU/pub">  LDP.</a> <br><br>         MPLS  <b>R1</b> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0e5/37a/ccf/0e537accf9874de09ba6ee2699c35445.png" width="559"><br><br>   FEC   . <br>    LSP  R1  R6        <br><br> <b>R2:</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/d6f/8da/114/d6f8da114cac76512989583d218cc285.png"><br><br> <b>R5:</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/97d/7ba/8bf/97d7ba8bfb629b41316c2f1d0f7e655c.png"><br><br>  <br> 1.  <b>R1</b>   MPLS   <b>21</b> ,       <b>Fa0/0</b>     <b>18</b> . <br> 2.  <b>R2</b>   MPLS   <b>18</b> ,       <b>Fa0/0</b>     <b>20</b> . <br> 3.  <b>R5</b>   MPLS   <b>20</b> ,       <b>Fa1/0</b>    ‚Äî <b>PHP</b> . <br><br>    LSR     ,   -      ip cef ‚Äî    . <br><br>  ,      <b>show mpls forwarding table</b> ‚Äî  <b>LFIB</b> ( <b><i>Lable Forwarding Information Base</i></b> ) ‚Äî        ‚Äî  Data Plane.      Control Plane?   LDP   ?        ? <br>   : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d1f/97d/2f4/d1f97d2f48624c7454172fa0d957d370.png"><br><br>   FEC       : <br> <i>local binding</i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- what this LSR sends to the </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">remote binding</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> neighbors </font><font style="vertical-align: inherit;">- what this LSR has received from its neighbors. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the illustration above, you can see the word "tib". </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TIB is the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tag Information Base</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which is correctly called Label Information Base - LIB. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is a relic of the late-born </font></font><a href="http://lookmeup.linkmeup.ru/test"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TDP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the progenitor of the LDP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notice that 2 remote binding everywhere are two ways to get tags. </font><font style="vertical-align: inherit;">For example, you can get to R2 directly from R1, or you can get through R3-R4-R5-R2. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, you understand yes? </font><font style="vertical-align: inherit;">Not only does he make FEC from each entry in the routing table, but this scoundrel also uses Liberal Retention Mode to hold tags. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's summarize: the default LDP in Cisco works in the following modes:</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DU </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Independent control </font></font></li><li> Liberal Retention Mode </li><li>   FEC       </li></ul><br>  ,     . <br><br>    <b>show mpls ip binding</b> .          ,    ,     LSP: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/815/576/ba4/815576ba40e8aeb2b5b50103a385090c.png"><br><br>  , , ,        LSP ‚Äî     Ingress LSR,   ,     ,   LSP? <br>         IP CEF.    Ingress LSR     ,  FEC    . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/531/26d/76e/53126d76efe708d66071a59e4848dae2.png"><br><br>    Next Hop       <br><br><hr><br>      ,   LDP  LER, Ingress LSR, Egress LSR ‚Äî    -        .    FEC  LSP,   .      FEC     Egress LSR   Ingress LSR ( ,  ),    LSP. <br>   ,  LER       LSP,    ,   Ingress,  Egress. <br><br><a name="MPLS-BGP"></a><br><h2> MPLS  BGP </h2><br>         MPLS   IGP-.  ,            . <br><br>       MPLS  BGP.         .   ,     ,    BGP,       MPLS      VPN. <br>       MPLS  BGP     . <br><br>   BGP  IGP   ,  MPLS      BGP.    ,     BGP,   ,     .     MPLS  BGP? <br>  : <br><ol><li>     ,     next-hop  ,     BGP (     next-hop-self  IBGP-). </li><li>   Ingress LSR     ,     BGP,    next-hop,        ,     . </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now, in order to configure BGP on each router in our AS, we can only configure it on border routers to which clients or other providers are connected. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's look at the example of the network: </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/35d/9cb/cbb/35d9cbcbba58691695b6a1f6859b5758.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If we need to get from R1 to Filkin Certificate networks, we see that they are accessible through R6 and ‚Äúfly through‚Äù through MPLS to address 6.6.6.6. And when we get to R6, he already knows where to go next. Similarly, it will be the opposite, in Balagan Telecom. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The configuration for this scheme and a couple of commands with information output can be found </font></font><a href="https://docs.google.com/document/d/19ehYnTkg4Y-NvGyxWAzPm4c2vhTTL_dIZRNvwkAahk4/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><blockquote>  <i>=====================</i> <i><br> <a href="http://linkmeup.ru/blog/158.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"> <b> ‚Ññ 4</b></a> <br><br>    MPLS  OSPF. MPLS    ,    R7  R1. <br>   R1-R2-R3-R4-R5-R6     MPLS. <br>     BGP,    R1  R6. <br><br>   BGP   . <br>    R1    ,    BGP  R6,    MPLS  IP-,    next-hop   BGP. <br><br>   R7  ,    BGP  R6. <br><br> <strong>:</strong> <br>   ,   R7   100.0.0.1. <br><br> <strong>:</strong> <br>    BGP. <br><br></i> <div class="spoiler"> <i><b class="spoiler_title"></b></i> <div class="spoiler_text"> <i><img src="https://habrastorage.org/getpro/habr/post_images/e44/6cc/544/e446cc5440d6822135160ba4309a4216.png"><br></i> </div></div> <i><br><br>      <a href="http://linkmeup.ru/blog/158.html"></a> . <br></i>  <i>=====================</i> <i><br></i> </blockquote><br><br><a name="RSVP-TE"></a><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> RSVP-TE </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LDP is good. </font><font style="vertical-align: inherit;">It works simply and clearly. </font><font style="vertical-align: inherit;">But there is such a technology as MPLS TE - Traffic Engineering. </font><font style="vertical-align: inherit;">And the best route that the LDP can provide is not enough for her. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traffic management implies that you can direct traffic between nodes as you like, given the various restrictions. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For example, in our network, the client has two points of connection of its nodes - on R1 and on R6. </font><font style="vertical-align: inherit;">And between them, he asks for a VPN with a guaranteed channel width of 100 Mb / s. </font><font style="vertical-align: inherit;">But at the same time, we also have regular broadband servers on the network chasing vkontaktik and a dozen other customers who rent a VPN, but they don‚Äôt need to reserve a band. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you do not intervene in this situation, there may be an overload somewhere on R2, and you will not get 100 Mb / s for a dear client.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MPLS TE allows you to go through the entire network from the sender to the recipient and reserve resources on each node. If you are familiar with the concept of IntServ, then yes, it is she who organizes QoS all the way, instead of allowing each router to make a decision for the passing packet. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actually, the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RSVP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resource ReSerVation Protocol</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font><b><i><font style="vertical-align: inherit;">protocol</font></i></b><font style="vertical-align: inherit;"> was originally (in 1993) designed to organize IntServ in IP networks. He had to convey QoS information for a specific data flow to each node and force it to reserve resources. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the first approximation, it works simply.</font></font><br><br> 1) -       5 /.      RSVP       ‚Äî <b>Path Message</b> .      ,         IP- ,    . <br> 2)  Path        .   ,     . <br> 3)  ,  Path,   .       ,      ,            . <br> 4)       5 / (  ),          . <br> 5)  Path    ,     <b>Resv</b> ,       . <br> 6)  ,  Resv, ,     ,     . <br><br>             ,     . <br><br>      ‚Äî    <b>RSVP  Traffic Engineering</b> ,   ‚Äî <b>RSVP TE</b> ,      MPLS TE. <br>    ,   LDP ‚Äî    LSR     LSP    .  ,    ,   ‚Äî LSP    . <br><br> RSVP TE      LSP,     ,    ,    ,    ,  ,      . <br>          MPLS TE   .       ,   RSVP TE  LSP. <br><blockquote>      ,  LSP ‚Äî ,         .    ‚Äî   LSP. <br></blockquote><br><br>        ‚Äî      LSP,      LSR. <br><br>    ,  RSVP    .   . <br> 0) R1  LSP  FEC 6.6.6.6/32.     Tunnel  R1,     6.6.6.6   Traffic Engineering. <br> 1)    RSVP Path   6.6.6.6.       ‚Äî <b>Label Request</b> .  Path       FEC ‚Äî     . <br> 2)      Path       6.6.6.6.  Etc. <br> 3) Path  Egress LSR.  ,  -  ,       Resv.       ‚Äî <b>Label</b> .   Egress LSR      FEC ,    . <br> 4) Resv  ,    .    LSP,   ,   . <br><br>      ( Path    ),      ( Resv    ). <br>       ,         Downstream on Demand + Ordered Control. Path   ,  Resv       ,      LSR,       . <br><br>  Stop!  ,  RSVP TE    LDP     ,       IGP,     ¬´  6.6.6.6¬ª. <br>          RSVP TE  LDP. RSVP TE       ,         ‚Äî     ,     . <br> <b>-</b> ,   ,       (link-state),   OSPF  ISIS. <br> <b>-</b> , OSPF  ISIS      .   OSPF    <i>LSA ‚Äî Opaque LSA</i> ,   ISIS ‚Äî  <i>TLV IS Neighbor</i>  <i>IP Reachability</i> . <br> <b>-</b> ,     Ingress LSR  Egress LSR     SPF ‚Äî CSPF ( <i>Constrained Shortest Path First</i> ). <br><br>  Now more. <br><br>  Path     .       ‚Äî  R1,   ‚Äî 6.6.6.6.          . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/558/270/e25/558270e25a31797164df6c3404d4f621.png"><br><br>   Path      FIB      ,        ,    . ,    . <br>     Ingress LSR     . <br>    , RSVP TE    .  ,    ?  RSVP     ,   ,      OSPF  ISIS.     ,     RIP, IGRP  EIGRP ‚Äî     ,      ‚Äî  Feasible Successor. <br>    SPF     ,             <a href="http://lookmeup.linkmeup.ru/">AD</a> ,       . <br>      CSPF.       ,     , ,  - ,   - ,   <a href="http://linkmeup.ru/topic/edit/150/"> </a> . <br>   RSVP TE    CSPF      -    . <br>  ,        IGP? .    Constraints ‚Äî . RSVP TE      ‚Äî   ,   ,     ,   LSP  .  ,  CSPF   ,              .      ,       ‚Äî  ,              . <br>          OSPF  ISIS    ,    ,  .          . <br> ,  OSPF    3   LSA: <br><br><ul><li> <b>Type 9</b> ‚Äî link-local scope </li><li> <b>Type 10</b> ‚Äî area-local scope </li><li> <b>Type 11</b> ‚Äî AS scope </li></ul><br><br> <i><b>Opaque</b></i>   ( OSPF).    LSA,       OSPF    .         .  TE       (  <b>TED ‚Äî <i>Traffic Egineering Database</i></b> ).    TE    ‚Äî       ,     -   ,     Opaque LSA. <br>      ISIS.  : IS-IS TLV 22 (Extended IS Reachability), 134 (Traffic Engineering router ID), 135 (Extended IP reachability). <br><br> ,       . <br><br> <b>0)</b>  R1   MPLS TE   ISIS (OSPF)      TE.      .     TED. RSVP . <br><br><img src="https://habrastorage.org/files/e49/7a6/f18/e497a6f187b049e18a5b9a85d1ce9414.gif"><br><br> <b>1)</b>    ,     (Traffic Engineering),   (6.6.6.6)     . LSR  CSPF:      R1  6.6.6.6    .        ‚Äî       (R2, R5, R6). <br><br> <b>2)</b>     RSVP     <b>ERO</b> . R1  RSPV Path, , ,  ERO.   ‚Äî 6.6.6.6.  ,    Label Request,   ,          FEC (6.6.6.6/32). <br><blockquote> <b>ERO ‚Äî Explicit Route Object</b> ‚Äî    RSVP Path.    ,      . <br></blockquote><br><br> <b>3)</b>  RSVP Path    ‚Äî    ,    ERO.      IGP  ERO ,     R2. <br><br> <b>4)</b> R2,  RSVP Path,     ,   ,   MPLS  FEC 6.6.6.6/32.   Path    ,   ERO  ‚Äî     R2.    ,         R2.    ERO   : (R5, R6).     R2   Path  R5. <br><br> <b>5)</b> R5   :  ,  ,    ERO,   Path    ,       ERO ‚Äî R6. <br><img src="https://habrastorage.org/getpro/habr/post_images/464/5b4/b53/4645b4b538ccf69f9c9857755469ea89.png"><br><br> <b>6)</b> R6,  , ,     .   Path,    FEC 6.6.6.6      <b>Label</b>    Resv. <br> ,      ,   ,       LSR,   . <br> <b>7)</b>  RESV   R1 (Ingress LSR),      LSP. Resv      ,  Path,    . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/034/ce2/5e2/034ce25e252d2eaabea95d9b3fc7d233.png"><br><br> <b>8)</b>    LSP  R1  6.6.6.6 .        R1  R6.       ,      R6    1.1.1.1 ‚Äî      . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/20f/3ff/f1d/20f3fff1d78edc3af9cae7a259ca7a1b.png"><br><br>   ‚Äî    Path 6.6.6.6,          ?     ‚Äî       .  ERO          Ingress LSR  Egress LSR ‚Äî    .   LSR  ,     .        Ingress LSR    . <br>    IGP.  ,    OSPF   ISIS     ,   .    (   )             SPF.        . <br>     ,     IGP       (link-state),    ‚Äî    - ‚Äî      ,     ,     ‚Äî     ,   ,       ,       <a href="http://lookmeup.linkmeup.ru/">ABR</a> . <br>  ,       ,   MPLS TE   ‚Äî CSPF     ,          ‚Äî  ,    . <br>      <b>Explicit Path</b> (    ERO).  ,    ,      LSP ‚Äî        ,     LSP. Ingress LSR     .      CSPF   . <br>  Explicit Path   ?   . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0e2/990/5ba/0e29905bada0e34ebad3f4a183741622.png"><br><br>    ,      : <br> Explicit-path: R1, R3, R5. <br><br>   Explicit Path   CSPF,    ,  ,     Area 0:  R1  R3. <br> ,   ,   ERO,          Explicit-path ‚Äî R5. : R1, R2, R3. Path     ERO,   R3.  ,    -  ,    ,         -  Explicit-path   CSPF.        (R3, R4, R5),    ERO,       . <br>      Ingress LSR  Egress LSR          ,     ABR. <br><br>  ,  Explicit Path      ,     ,     ,    LSP  ,       LSP. <br>         ,  MPLS TE. <br><br><blockquote>     , ,       Link-State IGP.        EIGRP,  .       RIP.  And now what?   TE? <br>    ,     Cisco ‚Äî   <a href="http://www.cisco.com/c/en/us/td/docs/ios/mpls/configuration/guide/12_2sy/mp_12_2sy_book/mp_te_verbatim_path.html">Verbatim</a> . <br><br>      Link-State ?      TE,  CSPF    Ingress LSR  Egress LSR. .  Fine.        Explicit Path,       ?      . <br>   ,        ,      CSPF. <br>     .    ,  . <br>   : <br><pre> <code class="bash hljs">Router(config-if)<span class="hljs-comment"><span class="hljs-comment"># tunnel mpls traffic-eng path-option 1 explicit name &lt;i&gt;test&lt;/i&gt; verbatim</span></span></code> </pre><br>               CSPF. <br>      ,     .   ,    ,       . <br></blockquote><br><br><a name="RSVP_PRACTICE"></a><br><h3>  RSVP TE </h3><br><br><img src="https://habrastorage.org/getpro/habr/post_images/37c/2b3/094/37c2b309425f77169cc8daf757c5f7fb.png"><br><br>  <b>mpls ip</b>      LDP.       ‚Äî      <a href="https://docs.google.com/document/d/1YZUNAu3NmdXyTOt118jjxRrA-p61kUVcpkf6yS-WHxQ/pub"> </a> . <br>    <b>mpls traffic-eng tunnels</b> .     TE-   RSVP TE: <br><pre> <code class="bash hljs">R1(config)<span class="hljs-comment"><span class="hljs-comment">#mpls traffic-eng tunnels</span></span></code> </pre> <br>        : <br><br><pre> <code class="bash hljs">R1(config)<span class="hljs-comment"><span class="hljs-comment"># interface FastEthernet 0/0 R1(config-if)# mpls traffic-eng tunnels R1(config)# interface FastEthernet 0/1 R1(config-if)# mpls traffic-eng tunnels</span></span></code> </pre> <br>    . RSVP . <br><br>    IGP    TE.      ISIS: <br><pre> <code class="bash hljs">R1(config)<span class="hljs-comment"><span class="hljs-comment">#router isis R1(config-router)# metric-style wide R1(config-router)# mpls traffic-eng router-id Loopback0 R1(config-router)# mpls traffic-eng level-2</span></span></code> </pre><br>     ‚Äî ,  TE  . <br>  LSR-ID,       LDP, <br>     ISIS, , TE  . <br><br><div class="spoiler"> <b class="spoiler_title">    OSPF</b> <div class="spoiler_text"> R1(config)# mpls traffic-eng area 0 <br> R1(config-router)# mpls traffic-eng router-id Loopback0 <br></div></div><br>       . <br><br>    ISIS     TE: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/268/c58/d63/268c58d6327e0c1fa18a9f82591bdef9.png"><br><br>      LSR-ID,     (  TE),    . <br><br>     TED. <br><br>       ISIS: <b>#show isis database verbose</b> <br><br> RSVP  . <br><br>   TE-. <br><pre> <code class="bash hljs">R1(config)<span class="hljs-comment"><span class="hljs-comment"># interface Tunnel1 R1(config-if)# ip unnumbered Loopback0 R1(config-if)# tunnel destination 6.6.6.6 R1(config-if)# tunnel mode mpls traffic-eng R1(config-if)# tunnel mpls traffic-eng path-option 10 dynamic</span></span></code> </pre> <br>   ‚Äî     .     L2TP, GRE, IPIP ,  ,  MPLS TE. <br> <b>ip unnumbered Loopback0</b> ,         Loopback0. <br> <b>tunnel destination 6.6.6.6</b> ‚Äî     ,   ,  . <br> <b>tunnel mode mpls traffic-eng</b> ‚Äî  .       ,   . <br> <b>tunnel mpls traffic-eng path-option 10 dynamic</b> ‚Äî    CSPF   ,    . <br><br>       ,     : <br><pre> <i><code class="bash hljs">%LINEPROTO-5-UPDOWN: Line protocol on Interface Tunnel1, changed state to up</code></i> </pre> <br><br>    ? <br> <b>R1  Path.</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3bf/092/bbf/3bf092bbf7e15cf59341ac0a6a2b29b2.png"><br> <i>    R1-R2.</i> <br><br>      ,  ERO  Label Request. <br> <b> </b> ‚Äî 6.6.6.6,     . <br> <b>Explicit Route:</b> <br> 10.0.12.2 <b>-&gt;</b> 10.0.25.2 <b>-&gt;</b> 10.0.25.5 <b>-&gt;</b> 10.0.56.5 <b>-&gt;</b> 10.0.56.6. <br>               .  LSR    ,      Path. <br>   ERO  10.0.12.1,   R1     . <br>   <b>Label Request</b>   ,  LSR      FEC. <br>         Path <b></b> ‚Äî    . <br> <i>Resv    ,   Resv   LSR.</i> <br><br>      R5: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7f5/ff9/db5/7f5ff9db5c5037702608edf7705fc26e.png"><br> <i>    R2-R5.</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/607/de6/0e7/607de60e7010cf54b65539a8eacaa143.png"><br> <i>    R2-R5.</i> <br><br>  Path   R6.    RSPV Resv: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ff7/ebb/d02/ff7ebbd02109a20c29308bbb4dea03a3.png"><br> <i>    R5-R6.</i> <br><br>    ,  Resv     . <br>   <b>Label</b>  ,   FEC. <br><br>  ,  R6   0 ‚Äî Expliit Null.     ‚Äî    ,   MPLS  R5  R6  (       EXP, ),  R6   ,   0     ,   ,       . <br>   ,         (,  VPN),   <a href="http://tools.ietf.org/html/rfc3032">RFC 3032</a> (      ) R5     ,     ,       0.  , ,  . <br>   ,  ,   0    ,   ‚Äî   .   <a href="https://tools.ietf.org/html/rfc4182">RFC 4182</a>   .   0      . <br>   ‚Äî PHP.   ,       ‚Äî 3 ‚Äî LSR  PHP     0.     <a href="http://blog.ipspace.net/2008/09/mpls-te-if-you-want-standard-compliance.html"></a> . <br><br> R5  Resv  R2,  R2  R1. <br><img src="https://habrastorage.org/getpro/habr/post_images/c74/4fd/247/c744fd247d28512d8ff5aa6979283985.png"><br> <i>    R1-R2.</i> <br><br> ,  ,    ‚Äî 16. <br><br><blockquote>  <i>=====================</i> <i><br> <a href="http://linkmeup.ru/blog/159.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"> <b> ‚Ññ 5</b></a> <br><br>        Resv,     ,    ,        ,       LSP.   ? <br><br>   <a href="http://linkmeup.ru/blog/159.html"></a> . <br></i>  <i>=====================</i> <i><br></i> </blockquote><br><br><h3> Explicit Path </h3><br>      ‚Äî     R1-R3-R4-R5-R6. <br>  :  -  explicit-path: <br><pre> <code class="bash hljs">R1(config)<span class="hljs-comment"><span class="hljs-comment"># ip explicit-path name R1-to-R6-primary R1(cfg-ip-expl-path)# next-address 10.0.13.3 R1(cfg-ip-expl-path)# next-address 10.0.34.4 R1(cfg-ip-expl-path)# next-address 10.0.45.5 R1(cfg-ip-expl-path)# next-address 10.0.56.6</span></span></code> </pre> <br>      : <br><pre> <code class="bash hljs">R1(config)<span class="hljs-comment"><span class="hljs-comment"># Interface Tunnel 1 R1(config-if)# tunnel mpls traffic-eng path-option 5 explicit name R1-to-R6-primary</span></span></code> </pre> <br> ,      ,    ‚Äî 5  10.      explicit-path,     - ,  R1   LSP  ( -). <br><br>     : <br><pre> <code class="bash hljs">interface Tunnel1 ip unnumbered Loopback0 tunnel destination 6.6.6.6 tunnel mode mpls traffic-eng tunnel mpls traffic-eng path-option 5 explicit name R1-to-R6-primary tunnel mpls traffic-eng path-option 10 dynamic no routing dynamic</code> </pre> <br>     Path,     ERO: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/40e/5ab/989/40e5ab98993b27c1001177ed7e55fa4d.png"><br><br>     ,   <b>show mpls traffic-eng tunnels</b> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/387/b42/e37/387b42e3700af52097109d95faf2f9c0.png"><br><br>      : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/659/2b1/639/6592b163938789627a62cd575118a1a4.png"><br><br>  LSP      ,   Loose  Strict, FRR  make before break, Affinity  ,        MPLS TE. <br><br> <a href="https://docs.google.com/document/d/1A2xZ9kXWEUrrUYc5fcRwd_9U-lgXZQ0L3N1b3GLg1FA/pub">   RSVP-TE</a> . <br><br><a name="FAQ"></a><br><h1>  </h1><br> <b>1:</b>   RSVP TE LSP  LDP LSP? <br><blockquote>  ,      ,    MPLS    . LSP ‚Äî    LSP ‚Äî     . <br>    CR-LSP (ConstRaint-based LSP) ‚Äî   RSVP TE.      ,  CR-LSP      . <br></blockquote><br> <b>2:</b>   Explicit Path  ERO? <br><blockquote>     Explicit Path,  RSVP  ERO,   Explicit Path.       Explicit-Path     Egress LSR, RSVP      CSPF. <br></blockquote><br><br> <b>3:</b>         LDP (RSVP TE)      /,    LSP , ,        IP,       MPLS? <br><blockquote>   RSVP TE Ingress LSR       TED       Egress LSR,    Path, ,      LSP. <br>      . <br><br>     LDP,   . ,   R2  LDP   FE0/0 (  R5),  <br> 1)  R1    FEC 6.6.6.6/32.    2:   R2,  ‚Äî  R3,      ‚Äî  R2,   LSP     R2. <br> 2)  R2  ,    ‚Äî   1.1.1.1.    ,     .    LSP  R1  FEC 6.6.6.6/32   . <br> 3)  R5   FEC 6.6.6.6/32  <br><br>  ,  ,    LSP: {R1-R2, R5-R6}.    ,   . LSP    Label Switched,         ,      R1  R2 MPLS,  R2  R5 IP,   R5  R6  MPLS. <b>LSP  FEC 6.6.6.6/32  </b> .    ,  ,     -  MPLS, , ,  VPN,     . <br></blockquote><br><br> <b>4:</b> ,   MPLS      ‚Äî    -  ,    ,    MPLS TE-?           IGP. <br><blockquote>   ,     .  But‚Ä¶ <br>  ,     ,    ,          ,  .            ,               .          ,             . <br>         LSP       ,   .      TE   . <br><br>    ,         40 /  50 / ,      ?  ,       -     QoS ,     ,         3         .          50/,        ,      <a href="http://lookmeup.linkmeup.ru/">SLA</a> . <br></blockquote><br><br> <b>5:</b>   -   Explicit Null  Implicit Null?       ? <br><blockquote>  Need to.  ,    MPLS   <b></b>       LSR.       ¬´0¬ª,  Egress LSR  ,    .      ,    TC  MPLS,        .          . <br><br>      ¬´3¬ª       Egress LSR.     QoS (   , ,   DSCP),           ‚Äî     ,   Egress LSR .     IP- ‚Äî    IP,   - E1,     ,   ,   lookup  LFIB  ,     . <br></blockquote><br><br> <b>6:</b>   FEC LSR           ? <br><blockquote>    : <br><ul><li>    </li><li>    </li><li>    </li></ul><br>      ,    FEC    <b></b>    . <br>   ‚Äî      (  LSR),        FEC <b></b>   . <br>     ,      FEC     ,       ,    .         . <br></blockquote><br><br><hr><br>  ,   MPLS      ,             .      LSP  ,     . <br>        LPD over TE.    RSVP-TE       Traffic Engineering,  LDP    VPN, . <br> Egress LSR,    MPLS  ,    .        .     .       MPLS      VPN. <br><br><a name="USEFUL"></a><br><h1>  useful links </h1><br><ul><li>    ,     ,   MPLS: <a href="http://www.nanog.org/meetings/nanog49/presentations/Sunday/mpls-nanog49.pdf">MPLS for Dummies</a> . </li><li>    RFC,   : </li><li>       <a href="http://www.networkworld.com/blog/jeff-doyle-on-ip-routing"> </a> .              . <br><ul><li> <a href="http://www.networkworld.com/article/2350449/cisco-subnet/understanding-the-role-of-fecs-in-mpls.html">Understanding the Role of FECs in MPLS</a> </li><li> <a href="http://www.networkworld.com/article/2350577/cisco-subnet/understanding-mpls-label-stacking.html">Understanding MPLS Label Stacking</a> </li><li> <a href="http://www.networkworld.com/article/2343494/cisco-subnet/understanding-signaling-in-mpls-networks.html">Understanding Signaling in MPLS Networks</a> </li><li> <a href="http://www.networkworld.com/article/2237487/cisco-subnet/understanding-mpls-label-distribution.html">Understanding MPLS Label Distribution</a> </li><li> <a href="http://www.networkworld.com/article/2350466/cisco-subnet/understanding-mpls-explicit-and-implicit-null-labels.html">Understanding MPLS Explicit and Implicit Null Labels</a> </li><li> <a href="http://www.networkworld.com/article/2343657/cisco-subnet/understanding-mpls-cspf.html">Understanding MPLS CSPF</a> </li></ul><br></li></ul><br><br>       <a href="http://habrahabr.ru/users/jdima/">JDima</a> . <br>         <a href="http://xgu.ru/wiki/%25D0%259A%25D0%25B0%25D1%2582%25D0%25B5%25D0%25B3%25D0%25BE%25D1%2580%25D0%25B8%25D1%258F:%25D0%2590%25D0%25B2%25D1%2582%25D0%25BE%25D1%2580_%25D0%259D%25D0%25B0%25D1%2582%25D0%25B0%25D1%2588%25D0%25B0_%25D0%25A1%25D0%25B0%25D0%25BC%25D0%25BE%25D0%25B9%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25BA%25D0%25BE"> </a> . <br><a name="Niko"></a>   <a href="http://www.nina-dolgopolova.com/"> </a> ‚Äî     . <br>       <a href="http://habrahabr.ru/users/thegluck/"> the gluck</a> </div><p>Source: <a href="https://habr.com/ru/post/246425/">https://habr.com/ru/post/246425/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../246411/index.html">Search for the longest word chains in Russian using the Wolfram Language (Mathematica)</a></li>
<li><a href="../246413/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ139 (December 15 - 21, 2014)</a></li>
<li><a href="../246415/index.html">How the right programmers cook Easter eggs</a></li>
<li><a href="../246419/index.html">Recommendations on choosing a data center in Russia. Likbez on data center services</a></li>
<li><a href="../246421/index.html">The best of the world PHP for 2014 + competition from the company JetBrains! PHP ‚Äë Digest 53</a></li>
<li><a href="../246429/index.html">Description of one integration of 1C and Bitrix, and why I do not recommend my clients to use such integration</a></li>
<li><a href="../246431/index.html">Using Google Analytics with CocoonJS</a></li>
<li><a href="../246433/index.html">PCI DSS Virtualization Guide. Part 2</a></li>
<li><a href="../246435/index.html">Typical fixes after upgrading Windows Store applications from version 8 to 8.1</a></li>
<li><a href="../246437/index.html">Solving the traveling salesman problem using the branch and bound method</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>