<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Consequences of rewriting Firefox components on Rust</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last articles of the series, we discussed memory security and thread safety in Rust. In this last article, we will look at the implications of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Consequences of rewriting Firefox components on Rust</h1><div class="post__text post__text-html js-mediator-article">  <i>In the last articles of the series, we discussed <a href="https://habr.com/ru/post/438288/">memory</a> <a href="https://habr.com/ru/post/441370/">security</a> and <a href="https://habr.com/ru/post/441370/">thread safety</a> in Rust.</i>  <i>In this last article, we will look at the implications of a real Rust application using the example <a href="https://hacks.mozilla.org/2017/08/inside-a-super-fast-css-engine-quantum-css-aka-stylo/">of the Quantum CSS project</a> .</i> <br><br>  The CSS engine applies the CSS rules on the page.  This is a downstream process that descends the DOM tree, after calculating the parent CSS, child styles can be calculated independently: ideal for parallel computing.  By 2017, Mozilla made two attempts to parallelize the style system using C ++.  Both failed. <br><br>  Quantum CSS development has begun to improve performance.  Improving security is just a good side effect. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fb1/391/190/fb139119031a0bf7077a9b5dd8381b77.jpg"></div><a name="habracut"></a><br>  There is a definite connection between memory protection and information security bugs.  Therefore, we expected Rust to reduce the attack surface in Firefox.  This article will look at potential vulnerabilities that have been identified in the CSS engine since the initial release of Firefox in 2002.  Then look at what could and couldn‚Äôt have been prevented with Rust. <br><br>  For all the time in the CSS component of Firefox 69 security errors were detected.  If we had a time machine and we could write Rust from the very beginning, then 51 (73.9%) error would have become impossible.  Although Rust makes it easier to write good code, it also does not provide absolute protection. <br><br><h1>  Rusty </h1><br>  Rust is a modern system programming language, safe for types and memory.  As a side effect of these security guarantees, Rust programs are also thread-safe during compilation.  Thus, Rust is particularly well suited for: <br><br><ul><li>  secure processing of unreliable incoming data; <br></li><li>  concurrency to improve performance; <br></li><li>  integration of individual components into the existing code base. </li></ul><br>  However, Rust does not explicitly fix some classes of errors, especially errors of correctness.  In fact, when our engineers rewrote Quantum CSS, they accidentally repeated a critical security bug that had previously been fixed in C ++ code, they accidentally deleted fix <a href="https://bugzilla.mozilla.org/show_bug.cgi%3Fid%3D641731">641731</a> , which allows global history to leak through SVG.  Error registered again as a <a href="https://bugzilla.mozilla.org/show_bug.cgi%3Fid%3D1420001">bug 1420001</a> .  History leakage is rated as a critical security vulnerability.  The initial correction was an additional check to see if the document is an SVG image.  Unfortunately, this check was missed when rewriting the code. <br><br>  Although automated tests should find violations of the rules <code>:visited</code> like this, in practice they did not detect this error.  To speed up automated tests, we temporarily disabled the mechanism that tested this feature ‚Äî tests are not particularly useful if they are not performed.  The risk of re-implementing logical errors can be reduced by good test coverage.  But there is still the danger of new logical errors. <br><br>  As the developer becomes familiar with Rust, his code becomes even more secure.  Although Rust does not prevent all possible vulnerabilities, it eliminates a whole class of the most serious bugs. <br><br><h1>  Quantum CSS security bugs </h1><br>  In general, by default, Rust prevents memory errors, bounds, zero / uninitialized variables, and integer overflow.  The nonstandard bug mentioned above remains possible: it crashes due to failed memory allocation. <br><br><h3>  Security bugs by category </h3><br><blockquote><ul><li>  Memory: 32 <br></li><li>  Borders: 12 <br></li><li>  Implementation: 12 <br></li><li>  Null: 7 <br></li><li>  Stack Overflow: 3 <br></li><li>  Integer overflow: 2 <br></li><li>  Other: 1 </li></ul></blockquote>  In our analysis, all security bugs are related, but only 43 have been officially assessed (it is assigned by Mozilla security engineers on the basis of qualified assumptions about ‚Äúexploitation‚Äù).  Regular bugs may indicate missing functions or some kind of failures that do not necessarily lead to data leakage or behavior changes.  Official security errors range from low importance (if there is a strong limitation on the attack surface) to critical vulnerability (it may allow an attacker to run arbitrary code on the user's platform). <br><br>  Memory vulnerabilities are often classified as serious security issues.  Of the 34 critical / serious problems, 32 were memory related. <br><br><h3>  Distribution of security bugs by severity </h3><br><blockquote><ul><li>  Total: 70 <br></li><li>  Security Errors: 43 <br></li><li>  Critical / Serious: 34 <br></li><li>  Fixed Rust: 32 </li></ul></blockquote><h1>  Comparing Rust and C ++ </h1><br>  <a href="https://bugzilla.mozilla.org/show_bug.cgi%3Fid%3D955913">Bug 955913</a> - Heap buffer overflow in <code>GetCustomPropertyNameAt</code> function.  The code used the wrong variable for indexing, which led to the interpretation of memory after the end of the array.  This can cause a crash when accessing a bad pointer or copying memory into a string that is passed to another component. <br><br>  The order of all <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Properties_Reference">CSS properties</a> (including custom, that is, custom) is stored in the <code>mOrder</code> array.  Each element is represented either by the value of the CSS property or, in the case of custom properties, by a value that starts with <code>eCSSProperty_COUNT</code> (the total number of non-custom CSS properties).  To get the name of custom properties, you first need to get a value from <code>mOrder</code> , and then access the name in the appropriate index of the <code>mVariableOrder</code> array, which stores the names of custom properties in order. <br><br><h3>  Vulnerable C ++ code: </h3><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCustomPropertyNameAt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> aIndex, nsAString&amp; aResult)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ MOZ_ASSERT(mOrder[aIndex] &gt;= eCSSProperty_COUNT); aResult.Truncate(); aResult.AppendLiteral(<span class="hljs-string"><span class="hljs-string">"var-"</span></span>); aResult.Append(mVariableOrder[aIndex]);</code> </pre> <br>  The problem occurs in line 6 when using <code>aIndex</code> to access the element of the <code>mVariableOrder</code> array.  The fact is that <code>aIndex</code> should be used with the array <code>mOrder</code> , not <code>mVariableOrder</code> .  The corresponding element for the custom property represented by <code>aIndex</code> in <code>mOrder</code> is actually <code>mOrder[aIndex] - eCSSProperty_COUNT</code> . <br><br><h3>  Corrected C ++ code: </h3><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> Get </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomPropertyNameAt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> aIndex, nsAString&amp; aResult)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ MOZ_ASSERT(mOrder[aIndex] &gt;= eCSSProperty_COUNT); <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> variableIndex = mOrder[aIndex] - eCSSProperty_COUNT; aResult.Truncate(); aResult.AppendLiteral(<span class="hljs-string"><span class="hljs-string">"var-"</span></span>); aResult.Append(mVariableOrder[variableIndex]); }</code> </pre> <br><h3>  Corresponding Rust Code </h3><br>  Although Rust is somewhat similar to C ++, it uses other abstractions and data structures.  The Rust code will be very different from C ++ (see below for details).  First, let's consider what happens if we translate the vulnerable code as literally as possible: <br><br><pre> <code class="rust hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCustomPropertyNameAt</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, aIndex: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">assert!</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.mOrder[aIndex] &gt;= <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.eCSSProperty_COUNT); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> result = <span class="hljs-string"><span class="hljs-string">"var-"</span></span>.to_string(); result += &amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.mVariableOrder[aIndex]; result }</code> </pre> <br>  The Rust compiler will accept such code, because the length of the vectors cannot be determined before execution.  Unlike arrays, the length of which must be known, the <a href="https://doc.rust-lang.org/std/vec/struct.Vec.html">Vec type</a> in Rust has a dynamic size.  However, in the implementation of the vector of the standard library built-in check boundaries.  When an invalid index appears, the program immediately terminates in a controlled manner, preventing any unauthorized access. <br><br>  <a href="">The real code</a> in Quantum CSS uses very different data structures, so there is no exact equivalent.  For example, we use the powerful built-in Rust data structures to unify the ordering and property names.  This eliminates the need to maintain two independent arrays.  Rust data structures also improve data encapsulation and reduce the likelihood of such logical errors.  Since the code must interact with C ++ code in other parts of the browser, the new <code>GetCustomPropertyNameAt</code> function <code>GetCustomPropertyNameAt</code> not look like idiomatic Rust code.  But it still gives all the security guarantees, while providing a more understandable abstraction of the underlying data. <br><br><h1>  tl; dr </h1><br>  Since vulnerabilities are often related to memory security breaches, Rust code should significantly reduce the number of critical <a href="https://cve.mitre.org/">CVEs</a> .  But even Rust is not perfect.  Developers still need to track correctness errors and data leakage attacks.  Code review, tests and fuzzing are still needed to support secure libraries. <br><br>  Compilers cannot catch all programmer errors.  Nevertheless, Rust removes the memory security burden from our shoulders, allowing us to focus on the logical correctness of the code. </div><p>Source: <a href="https://habr.com/ru/post/445670/">https://habr.com/ru/post/445670/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../445652/index.html">Responsibilities of search engines: how to ‚Äúedit‚Äù the search in Russia</a></li>
<li><a href="../445658/index.html">STAX History: Electrostats Against Market Conjugation</a></li>
<li><a href="../445662/index.html">Tick-tick: the time of smart watches is gone, but now bracelets are pretending to be them</a></li>
<li><a href="../445666/index.html">You need a ready June - teach him yourself, or How we started a course of seminars for students</a></li>
<li><a href="../445668/index.html">Neoquest 2019: ‚ÄúConnection to Heaven‚Äù</a></li>
<li><a href="../445672/index.html">Muon catalysis from the point of view of quantum chemistry. Part II: electronic vs. muon chemical bond</a></li>
<li><a href="../445676/index.html">New in git 3: closures</a></li>
<li><a href="../445678/index.html">4. Check Point Getting Started R80.20. Installation and Initialization</a></li>
<li><a href="../445682/index.html">PVS-Studio for Java is sent to the path. Next stop - Elasticsearch</a></li>
<li><a href="../445684/index.html">Monoblock vs. modular UPS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>