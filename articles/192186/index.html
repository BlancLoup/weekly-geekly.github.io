<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Trove 4.0? Primitives in the standard framework of collections from Java 8</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="About a month ago on Habr√© there was an article about Trove - the most frequently mentioned library when asked about data structures with primitives i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Trove 4.0? Primitives in the standard framework of collections from Java 8</h1><div class="post__text post__text-html js-mediator-article"> About a month ago on Habr√© there was <a href="http://habrahabr.ru/post/187234/">an article about Trove</a> - the most frequently mentioned library when asked about data structures with primitives in Java.  About a couple of days before that, I sat down to rewrite this library.  The time is definitely over, so I‚Äôm sharing the search with you, although I don‚Äôt really hope that someone will continue this business. <br><br>  At the moment, there are 6 types of hash tables: sets of primitives, objects, and all 4 variants of maps: primitive - primitive, primitive - object, object - primitive, and object - object, over which hangs a cloud of generalizing interfaces. <br><br>  I have always wondered why all such libraries create <i>another</i> type hierarchy, rather than being built into the <i>long-</i> established standard framework of Java collections.  I have not seen or see any fundamental problems with this.  Therefore, <a href="http://download.java.net/jdk8/docs/api/java/lang/Iterable.html"><code>java.lang.Iterable</code></a> , <a href="http://download.java.net/jdk8/docs/api/java/util/Collection.html"><code>java.util.Collection</code></a> and <a href="http://download.java.net/jdk8/docs/api/java/util/Map.html"><code>java.util.Map</code></a> rise above my cloud of interfaces, like on the pantheon.  I knowingly gave references to the Java 8 documentation. Almost all methods from future interfaces have been implemented, except for the <code>spliterator()</code> .  You can start to get used to. <br><a name="habracut"></a><br><h3>  Additional elements of the new framework Trove </h3><br>  mapIterator () is a hybrid <code>spliterator()</code> from Java 8 and <code>entrySet().iterator()</code> . <br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TMapIterator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">K</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">V</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tryAdvance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">K </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">key</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; ... } <span class="hljs-comment"><span class="hljs-comment">//   for (IntKeyMapIterator&lt;String&gt; it = map.mapIterator(); it.tryAdvance(); ) { doSomething(it.intKey(), it.value()); }</span></span></code> </pre><br>  This is hardly more cumbersome than <code>entrySet().iterator()</code> , but much more efficient. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In all object hashes, there are methods to control the splitting of objects into equivalent sets: <br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DHashSet</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">E</span></span></span><span class="hljs-class">&gt; </span></span>{ ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">elementsEquals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@NotNull E a, @Nullable E b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a.equals(b); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">elementHashCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@NotNull E element)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> element.hashCode(); } }</code> </pre><br><br>  ‚ÄúReversible‚Äù methods over entire collections: <code>addAllTo()</code> , <code>allContainingIn()</code> , <code>removeAllFrom()</code> - to speed up stream operations.  In the standard framework, the method is always called on the collection, which will change, although it will have to be iterated over the second one.  Although it is the latter that ‚Äúknows‚Äù how best to go through all the elements. <br><br>  In some cases, the reversing pass can be performed 2 times faster than the external one, using a regular iterator.  For example, when dumping sets into a list. <br><br>  Since the contracts of the corresponding methods from the standard framework have rather subtle nuances, it is not recommended to call the reverse methods manually so as not to do something wrong.  They are already called from within the usual methods in implementations. <br><br><h3>  Implementation </h3><br>  The heart of Trove is open-addressing and double-hashing hash tables for resolving collisions.  When you delete an item in them, you cannot simply mark a cell as free.  Therefore, if elements are regularly removed from the table and added, it is completely clogged with occupied and ‚Äúdeleted‚Äù cells, the speed of operations drops.  In the previous version of Trove, in order to prevent this, there was a deletions counter, heuristically tied to a given table occupancy rate. <br><br>  With the coefficient k (from 0 to 1) it turns out that with constant deletions, before rebuilding the table, there are k - k ^ 2 filled cells, and k ^ 2 deleted, with alternate deletions and insertions of different random elements - k filled and (1 - k) ^ 2 - free (all values ‚Äã‚Äã- in fractions from 1). <br><br>  Substitute the numbers.  With a default factor of 0.5, in both cases, a maximum of a quarter of deleted items in the table is obtained.  Very beautiful.  But with my favorite ratio of 0.8 - with a completely normal pattern for using a table, only 4% of free cells can remain - this is a crime. <br><br>  Therefore, I introduced a much simpler principle - the number of deleted cells at any moment should not exceed either the number of employees (that is, the size of the table) or the number of free ones, otherwise a rebuilding occurs: <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DoubleHashBase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> size, free, removed, modCount; ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postRemoveHook</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ modCount++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( ( --size &lt; ++removed || removed &gt; free ) &amp;&amp; autoRehashEnabled ) { rehash(); } }</code> </pre><br><br>  The key method in the implementation of the hash table is the item search.  In the case of a double-hash table, the array, the length of which is a prime number, jumps in an almost random order, and compares the element at the current index with the desired one.  At the same time looking for an element in the hash table, either in order to insert it there then, or to take a value from a parallel array ( <code>map.get()</code> or <code>set.contains()</code> ).  In the first case, we can assume that the element in the table, <i>most likely,</i> is not yet, and in the second - that it <i>most likely</i> already lies there.  In the previous implementation of the Trove, in both variants of the search, it is first of all checked to see if the cell is empty, and then whether what we are looking for lies there.  Although when searching for "taking", it is necessary first of all to check whether the current element is not equal to the desired one (yes it is). <br><br>  This two-line change sped up <code>IntHashSet.contains(int)</code> by 5 ns. <br><br><h3>  Another attempt to write normally benchmarks on JMH </h3><br>  CharHashSet <code>CharHashSet</code> , fill factor 0.5, the table takes about 4 KB in memory.  Details omitted: <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@GenerateMicroBenchmark</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">charSet_simple</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CharSetState state)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> sum = <span class="hljs-number"><span class="hljs-number">0</span></span>; TCharIterator it = state.iterator; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (it.hasNext()) { sum += it.nextChar(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum; } <span class="hljs-meta"><span class="hljs-meta">@GenerateMicroBenchmark</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">charSet_forEachLoop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CharSetState state)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> sum = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> v : state) { sum += v; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CharSum</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CharConsumer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> sum; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b )</span></span></span><span class="hljs-function"> </span></span>{ sum += b; } } <span class="hljs-meta"><span class="hljs-meta">@GenerateMicroBenchmark</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">charSet_forEachFunction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CharSetState state)</span></span></span><span class="hljs-function"> </span></span>{ CharSum procedure = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CharSum(); state.set.forEach( procedure ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> procedure.sum; } <span class="hljs-meta"><span class="hljs-meta">@GenerateMicroBenchmark</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">charSet_tryAdvance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CharSetState state)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> sum = <span class="hljs-number"><span class="hljs-number">0</span></span>; TCharIterator it = state.iterator; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (it.tryAdvance()) { sum += it.charValue(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum; }</code> </pre><br>  Result: <br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">Mean</span></span> Mean <span class="hljs-literal"><span class="hljs-literal">error</span></span> charSet_forEachFunction <span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span> nsec/iter charSet_forEachLoop <span class="hljs-number"><span class="hljs-number">15</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span> nsec/iter charSet_simple <span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span> nsec/iter charSet_tryAdvance <span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span> nsec/iter</code> </pre><br>  As you can see, for the pleasure of using the shortest method, foreach jlIterable, you still have to pay. <br><br>  The ‚Äúsimple‚Äù method is about 30% faster than the similar one in the previous version of Trove, due to the fact that the next element was searched 2 times at each iteration: in the <code>hasNext()</code> method, and then in <code>next()</code> .  Now the index of the next element is stored in the field of the iterator class. <br><br><h3>  Why all this </h3><br>  As I said, I have absolutely no time to finish the library: <br>  No listings ( <code>CharArrayList</code> ) <br>  Serializable support temporarily removed from all classes <br>  There is almost no documentation, just a little copy-paste from Java 8. <br><br>  But, since the new framework is consistent with the standard one, it is very easy to test it on real-world tasks, especially if you wrote prudently <br><pre> <code class="java hljs">Map&lt;Integer, Long&gt; map = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;();</code> </pre><br>  Although I did not try to compile a new library with anything other than Java 7u25, it should be compatible with Java 6 from source (and build). <br><br>  The repository includes a very detailed bundle for development for Intellij: <a href="https://bitbucket.org/leventov/trove/src/">bitbucket.org/leventov/trove/src</a> <br><br>  I would be glad to hear your thoughts about the design of such libraries and the implementation of hashes. <br><br>  By reference to the original - (expected) discussion in English. </div><p>Source: <a href="https://habr.com/ru/post/192186/">https://habr.com/ru/post/192186/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../192176/index.html">Performance obsession or profiling experience in a virtual environment</a></li>
<li><a href="../192178/index.html">Mexican city raised its own cellular network</a></li>
<li><a href="../192180/index.html">How I simplify my life by working at the computer and in the IRL</a></li>
<li><a href="../192182/index.html">The history of personal computers in advertising. Part 2: 1980s</a></li>
<li><a href="../192184/index.html">Crypto-correspondence for the distrustful</a></li>
<li><a href="../192188/index.html">Raspisco - remote access to Cisco via Raspberry Pi</a></li>
<li><a href="../192190/index.html">Git Automatic verification of a server-side commit message using Python</a></li>
<li><a href="../192192/index.html">Python for Programmers</a></li>
<li><a href="../192196/index.html">A Brief History of Indonesian Jabber</a></li>
<li><a href="../192200/index.html">New Vogue. Now banana</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>