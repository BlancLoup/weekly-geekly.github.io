<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using the battery from the iPhone in the development of wearable electronics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings reader. 

 Quite often, I have the task of developing portable devices powered by a single cell Li-ion battery. And, if the customer usually...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using the battery from the iPhone in the development of wearable electronics</h1><div class="post__text post__text-html js-mediator-article">  Greetings reader. <br><br>  Quite often, I have the task of developing portable devices powered by a single cell Li-ion battery.  And, if the customer usually does not bother, then I, like an experienced engineer, at the sight of such TK, a shiver runs down my back.  This is due to the fact that the assessment of the battery charge level, as well as the remaining operating time is a very difficult task, although at first glance it may seem different. <br><br><img src="https://habrastorage.org/webt/ws/kh/og/wskhog7wo9xnqs6b3-perfg2zpe.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There are several options for action in this case, talk about them below. <br><a name="habracut"></a><br>  <b>-</b> The simplest thing is not to do anything to determine the level of battery charge.  A charge circuit on a simple linear memory (for example, TP4054) and a voltage converter to power the device.  Turn off without warning and at the most inopportune moment. <br><br>  <b>-</b> Measure the voltage on the battery.  The result is about the same as the previous point, but it requires more effort.  Typical measurement scheme: <br><br><img src="https://habrastorage.org/webt/0g/ff/3y/0gff3ybn_7u0r95qrs7zinzrhr4.png"><br><br>  In fact, it is a voltage divider across resistors R19 and R21, which is connected via a VT6 switch.  The VT7 transistor is needed to eliminate the parasitic powering of the MK through the EN output. <br>  VBAT - battery voltage <br>  VBAT_mes - voltage coming to the ADC <br>  EN - divider control signal (0-off, 1-on) <br><br>  Now we know the voltage of the battery, we are great fellows.  BUT it gives almost nothing !!!  The fact is that a typical Li-ion battery discharge curve, to put it mildly, is not linear and it depends on the current consumption and the temperature of the battery itself: <br><br><img src="https://habrastorage.org/webt/i7/gz/d1/i7gzd1gllelpirlcxygnosgkody.gif"><br><br>  Looking at these graphs, can you say what is the residual capacity of the battery at 3.5V?  I think no‚Ä¶ <br><br>  This method can be slightly improved by using the built-in thermal sensor for estimating the temperature of the battery, or by installing a sensor to measure the current or (if the current consumption is approximately constant) to construct a discharge curve for a typical current consumption.  This will allow at least a little justify the effort, but about any accuracy and can be no question.  For charge indication on 3x LEDs - yes, it will. <br><br>  In the case of a constant current consumption, you can consider the battery life and estimate the consumed charge and the time spent on charging to estimate the accumulated charge.  This method gives a cumulative error, since calibration can only be at two points (full charge or full charge), but they are not always achieved.  In addition, as the battery deteriorates, the maximum operating time should be adjusted, but in general, the method has the right to life. <br><br>  <b>-</b> Make your own battery charge control system (BMS).  For its implementation, we need sensors for current, temperature and battery voltage.  We believe that the MK in the device already has and remains ‚Äúonly‚Äù to write software for it, which I spent a little less than a year. <br><br>  <b>-</b> Take a ready-made Gas Gauge chip (for example, from TI or Maxim Integrated), configure it, calibrate it and work.  For example, the scheme for bq27220: <br><br><img src="https://habrastorage.org/webt/ob/c6/sk/obc6skpnnbt-w_ikd611wqplbhc.png"><br><br>  There are several nuances when choosing this concept: <br><br><ol><li>  In case the battery is removable, it is necessary either to install a charge determination circuit on the battery itself (otherwise it will be reset when disconnected) or to use special versions of Gas Gauge that allow shutting down the battery.  In the first case, the battery of your device becomes unique and its replacement is possible only with your participation, which is not always convenient.  In the second case, there is the problem of placing the temperature sensor on the battery. </li><li>  The high cost of the solution.  Main components: Gas Gauge microcircuit, protection microcircuit, transistors, thermistor, current sensor resistor. </li></ol><br>  <b>-</b> To use more simple options for ready-made solutions such as CW2015: <br><br><img src="https://habrastorage.org/webt/qa/wh/fp/qawhfpgzcdscvtnrgh4jcgw0evq.png"><br><br>  This is the Chinese analogue chip MAX17048.  Absolutely simple chip without temperature and current sensors, with corresponding low accuracy, but at the same time cheap, easy to use and program.  Has the ability to work on the side of the device, which allows not to modify the battery itself.  The chip was found on the network in the process of writing material, there is no experience with it, but there is a desire to try, because the option is really interesting.  Perhaps in the next article I will talk about this chip in more detail. <br><br>  <b>-</b> And finally, the last known method to which I want to devote today's article.  In my opinion, this method is the easiest, but it gives the best result.  It lies in the fact that we take the battery from the iPhone with built-in Gas Gauge and protection, we connect via HDQ or I2C, we interrogate and work.  At the same time, the battery is already assembled and calibrated.  Below is a table with battery options known to me: <br><br><img src="https://habrastorage.org/webt/rg/v-/ug/rgv-uggse_y-oethz2ppdzrtb_a.png"><br><br>  The table is partially taken from <a href="https://ripitapart.com/tag/iphone-gas-gauge/">ripitapart.com</a> and <a href="https://www.macplus.ru/info/obzory-i-sravneniya/obzor-i-sravnenie-iphone/sravnenie-akkumulyatorov-iphone.html">www.macplus.ru</a> .  Please pay special attention to an unknown controller labeled A1141.  This chip manufactured by <a href="http://www.powerflash.com.tw/Product-1Cell.html">PowerFlash</a> and this is all the information that was found.  The author of the <a href="https://ripitapart.com/tag/iphone-gas-gauge/">blog</a> , from which I took the table, was not sure that he got the original battery from the iPhone SE.  Thanks to the recall of <b>asterix_tyumen</b> , which dismantled the original battery from the SE, it was found that it contains sn27545.  Below, we will be forced to consider A1141 in more detail.  But for now look at the batteries: <br><br><img src="https://habrastorage.org/webt/fc/lc/4l/fclc4lpb7ypo6w4vudjrg79zqko.png"><br><br>  As you can see, the battery for every taste and color, with and without an apple.  They can also be connected in parallel to increase capacity, with separate polling.  Among the drawbacks, it is worth noting that the length / width ratio is about 3: 1, which is not always convenient, as well as a unique connector for connection.  Due to the popularity of Apple phones, these batteries can be easily bought in many places and in large quantities (as it turned out, this is not quite true). <br><br>  When developing a <a href="http://blog.open-dev.ru/iot-rfid-in">wireless standalone RFID reader,</a> we went this way. <br><br><img src="https://habrastorage.org/webt/cp/hq/vh/cphqvhsqgrbt586x74tk4q3-xty.jpeg"><br><br>  The battery was chosen from the iPhone 6, which suited us in terms of capacity and size.  Were purchased several copies in different places to check: <br><br><img src="https://habrastorage.org/webt/fk/vu/fj/fkvufjecvn19x89jigbrv776zfu.jpeg"><br><br>  The right was bought in China, the rest in Moscow.  The cost is $ 6-11.  When they are checked, quite interesting results will be obtained.  Pay special attention to the box with the inscription "Orig", we will return to it later.  The test was carried out using the RFID reader itself, the EV2300 programmer from TI and the Battery Management Studio program. <br><br>  The power supply circuit of the RFID reader is shown in the figure: <br><br><img src="https://habrastorage.org/webt/qo/6x/sx/qo6xsxtbahocxjy_psg6ufypuxk.png"><br><br>  Linear charger based on STC4054 (TP4054), charge current 500 mA, power switch with automatic pickup based on reed switch SF1, capacitor C19, diode VD4 and resistor R15, as well as a pulse converter based on NCP1529. <br><br>  First I connected a copy from China for $ 6: <br><br><img src="https://habrastorage.org/webt/nb/qx/pj/nbqxpjz_o9zlq-p6w5vbsafunvo.png"><br><br>  The battery responds, BUT the current was not displayed either during charge or discharge, the voltage did not correspond to the actually measured and the degree of charge did not change.  I did not answer the battery commands.  There was an assumption that this copy is a fake, so I removed a protective tape from it to look at the board: <br><br><img src="https://habrastorage.org/webt/d7/u1/bt/d7u1btz9c2lmev89z_meth6c1li.jpeg"><br><br>  This is a twist ... I didn‚Äôt even redraw the circuit - here it‚Äôs clear that the bq27545 emulator and overdischarge / overcharge protection circuit are worth it.  Immediately there was an idea to save yourself time and open all the batteries. <br><br><img src="https://habrastorage.org/webt/nw/es/uv/nwesuvggds1wjz4xkcp-hix4n1s.jpeg"><br><br>  The neighbor to the left of the Chinese colleague for $ 8 is similar with the difference in marking on the chips.  The rest behaves the same.  These 2 copies immediately in the trash.  Unfortunately, I did not have an iPhone 6 on hand to check these batteries in the target device, it was very interesting to see how the phone would have behaved when working on these batteries. <br><br><img src="https://habrastorage.org/webt/ft/c5/v9/ftc5v9rgjn6dgcrau78bdndqccg.jpeg"><br><br>  And this is a central battery, worth $ 8.  It even has a current sensor and some kind of 8 pin chip with a modest 6G3 marking.  In Battery Management Studio, this battery pretends to be more sophisticated bq27545.  Displays charge level, correct voltage, battery current.  But if all this was real, then a fake would not be a fake.  In reality, the temperature was set by a constant, the current was measured very badly.  The picture shows the current consumption of the RFID reader, which is measured by the battery while constantly reading the card. <br><br><img src="https://habrastorage.org/webt/ze/tf/tl/zetftlpv8pt7ajm0rzslb9kn-tq.png"><br><br>  In reality, it is ~ 55 mA for this mode of operation and, since the reader field is always on, it cannot be zero.  When charging (when the current is constant for a long period of time), the current sensor works normally.  Naturally, all other parameters are calculated incorrectly (charge level, operation time until full discharge, etc.).  Flag FC (Full charge) is set at a voltage of 4.4V. <br><br><img src="https://habrastorage.org/webt/j7/g_/dw/j7g_dwkhejdguxcchvr-schljyu.png"><br><br>  The battery is not responding to commands, the QEN and RUP_DIS flags are not set.  In general, this is an unsuccessful attempt by the Chinese to write the bq27545 snag on MK (in any case, I think this is so).  Also in the trash. <br><br>  Remember, I asked to pay special attention to a copy in a box with the words "Orig"?  It was he who turned out to be as close as possible to what we were looking for (and how not to believe advertising now?): <br><br><img src="https://habrastorage.org/webt/hg/oj/3d/hgoj3d1hpv0omsd1n427kc-wjl0.jpeg"><br><br>  Its cost was $ 9.  In the center, you can clearly see the chip with the marking SN27545 - this is exactly what we were looking for.  With this instance, I began to work more closely.  During the charge-discharge trial cycle, problems arose.  I could not get the FC flag set (Full charge), which meant the end of the charge process.  The charge current at the battery voltage close to 4.2V became extremely small (about 20mA) and the charging process threatened to never end.  One of the possible reasons was a USB cable with a large voltage drop (it reached 4.5V before the memory chip), we replaced it with a better one with a lower voltage drop.  The indicators improved, the battery charged to 4.2V, the current dropped to 0, but SOC (State of charge) reached only 85, respectively, the FC flag was not set. <br><br><img src="https://habrastorage.org/webt/wi/yj/vk/wiyjvks7vaannnb1-rsbribojxm.png"><br><br>  For several days I drove cycles with the expectation that the battery would learn, but this did not help.  The problem turned out to be banal, but its search took 2 days.  At some point, I noticed that the battery is 4.35V and this was the answer to all the questions.  The memory is standard at 4.2V and I did not notice at all that the battery is at 4.35V and an incomplete charge occurs.  Since the boards were already manufactured, the only option to get out of the situation was to look for a replacement for the STC4054 with a voltage of 4.35V.  It turned out that such microcircuits exist, but in our great country they cannot be easily bought (apparently unpopular from the word at all).  Therefore, the MCP73832T-3 version was ordered with a wait of a couple of weeks. <br><br>  In the meantime, the ordered rides, we will make a collective farm patch to check the concept.  To do this, we make a "backup" of 0.15V for the memory chip using a diode: <br><br><img src="https://habrastorage.org/webt/8s/ft/mi/8sftmi64vw_xtce2htduhh_gt44.png"><br><br>  It must be admitted that the collective farm has earned, the FC flag has been established, everything works, but the final voltage of the battery is 4.4 V (the drop on the diode is greater than the required 0.15 V). <br><br><img src="https://habrastorage.org/webt/wx/hb/aa/wxhbaaplpa9gagt0vpls28kzirk.png"><br><br>  It is important to note that it is possible to charge up to 4.2 V with a corresponding loss of ~ 15% of capacity, but at the same time significantly extend the life of the battery.  With the copy of "Orig" we finished - it can be safely laid in the development. <br><br>  Left the last copy.  The most expensive ($ 11), in the coolest package and demanded the most time for yourself.  See what's inside: <br><br><img src="https://habrastorage.org/webt/ex/r-/kz/exr-kzemael4n2lpvhewzuq4-hm.jpeg"><br><br>  Here it is the unknown A1141 chip on which there is no documentation other than the <a href="http://www.powerflash.com.tw/Product-1Cell.html">manufacturer's page</a> .  When forcedly connected to bq27545 in the Battery Management Studio, we see the following picture: <br><br><img src="https://habrastorage.org/webt/cv/eq/fb/cveqfbcfpdguby-7cawqy06sivg.png"><br><br>  Complete trash.  When trying to charge with a current of ~ 500 mA, it shows 125 mA, when discharging with a current of ~ 25 mA it shows 214 mA.  It is clear that if the A1141 has other parameter addresses or a data storage format different from bq27545, then nothing shines without documentation from this battery.  Therefore, it was put aside, but at the end of the writing of the material, I decided to connect it again.  I took the command table of the bq27545 chip: <br><br><img src="https://habrastorage.org/webt/le/d2/bk/led2bk_-eatwxsizt2gdrnd8sly.png"><br><br>  And counted the voltage registers (0x08 and 0x09) through the Advanced Comm menu: <br><br><img src="https://habrastorage.org/webt/kc/cl/9o/kccl9oh1im7n8upg5i9im3y8hoi.png"><br><br>  We get 0x10 &lt;&lt; 8 |  0x38 = 4152 or 4.152V, which corresponds to a voltage of 4.15V measured by a multimeter.  So if the data is correct, why does the program display 57mV ???  We notice that 57mV is exactly 0x38, that is, the value of the 0x08 register.  With a battery voltage of 4.152 V, the charge level of 96% looks quite correct, it can be obtained by considering the registers 0x2c and 0x2d.  Read 0x2c = 0x60, 0x2d = 0 (in the case of the SOC parameter, the upper register is always zero).  It has been suggested that the program or the EV2300 cannot count (or the battery does not respond) either the high byte in the request or the byte with an odd address.  To test this theory, the battery was connected directly to the RFID reader and the battery was polled through the MC.  The HDQ interface was implemented according <a href="http://www.ti.com/lit/an/slua408a/slua408a.pdf">to the TI document</a> .  The bq27545 microcircuit uses the single-wire HDQ protocol for communication with the controlling controller, which is quite conveniently implemented on the STM32 based on the single-wire UART thanks to the support of the Half Duplex mode. <br><br>  Since  Our RFID reader works on MicroPython, we wrapped the work with HDQ into a class and got the work with the charge controller in the following form: <br><br>  from hdq import HDQ <br>  bat = HDQ (pyb.UART (1)) <br>  bat.charge () # charge <br>  bat.read_u16 (0x14) # arbitrary register <br><br>  In practice, it turned out that the A1141 does not respond to a request to read bytes with odd addresses. <br><img src="https://habrastorage.org/webt/wa/lo/jr/walojrft1ezmjmrguuotfjfjl5i.png"><br>  The oscillogram shows that there is a request, but there is no answer.  When they added the reboot of the logic of data exchange (Break) before each request - once, but the chip began to respond correctly. <br><br><img src="https://habrastorage.org/webt/t6/ht/oi/t6htoivlgn1nng-zodal_-hqbl4.png"><br><br>  Then they compared the exchange rate of the EV2300 and the RFID reader, and it turned out that the EV2300 uses a speed lower by 10-15% than the TI sets: <br><br><img src="https://habrastorage.org/webt/22/je/07/22je07teuaf7b5t0ppbkjf5zroy.png"><br><br>  After reducing the speed of HDQ and performing Break with each request, the battery earned normally!  The main battery parameters were read: <br><br><img src="https://habrastorage.org/webt/jg/fu/r5/jgfur5j37kq31_df2x5oyci0lxe.png"><br><br>  Complete victory!  In fact, the A1141 turned out to be a high-quality clone bq27545 with a few drawbacks.  It remains to talk about the nuances of working with the battery from the software (using sleep modes, wake-up current, etc.), but this will double the recording volume and, perhaps, I will write it another time. <br><br><h4>  findings </h4><br>  As you can see, there are many options for developing devices with a Li-ion battery.  Honestly, it was originally planned to write material in the style came, saw, won, but in the process a lot of nuances came out (the struggle with A1141 is especially good) and the material was very interesting and extensive.  From 5 copies of batteries, only 2 in fact can be used normally.  Therefore, the choice of supplier in this case is very relevant.  If you have seen batteries from other devices that contain BMS, then write the models in the comments.  Thank you all for your attention! </div><p>Source: <a href="https://habr.com/ru/post/423617/">https://habr.com/ru/post/423617/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../423603/index.html">RxSwift part 1</a></li>
<li><a href="../423607/index.html">Linus Torvalds refuses hard style and takes time out</a></li>
<li><a href="../423609/index.html">Where do web sites go after death? Personal experience</a></li>
<li><a href="../423611/index.html">Pay in one click - good or evil?</a></li>
<li><a href="../423615/index.html">Professional skills in demand among UX-specialists (section 2018)</a></li>
<li><a href="../423619/index.html">‚ÄúI intend to buy‚Äù or the easiest way to assess the quality of grocery search</a></li>
<li><a href="../423623/index.html">Management for the geek: why count them?</a></li>
<li><a href="../423625/index.html">Meet the first lunar tourist</a></li>
<li><a href="../423627/index.html">Come study classical administration: regulations, tools, scripts Southbridge</a></li>
<li><a href="../423629/index.html">Managing Changes in Mars IT Infrastructure</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>