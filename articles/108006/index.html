<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OOP workshop in PHP5: Analysis of errors, advantages and disadvantages of two different implementations of impurities in PHP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After the release of my article on impurities, we continued discussions in the comments to the article and in personal messages. Today I saw in my blo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OOP workshop in PHP5: Analysis of errors, advantages and disadvantages of two different implementations of impurities in PHP</h1><div class="post__text post__text-html js-mediator-article">  After the release of <a href="http://habrahabr.ru/blogs/php/107682/">my article on impurities,</a> we continued discussions in the comments to the article and in personal messages.  Today I saw in my blog a <a href="http://ru.fractalizer.ru/frpost_128/%25D0%25BE%25D0%25BE%25D0%25BF-%25D0%25BF%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B8%25D0%25BA%25D1%2583%25D0%25BC-php5-%25D1%258D%25D0%25BC%25D1%2583%25D0%25BB%25D1%258F%25D1%2586%25D0%25B8%25D1%258F-%25D0%25BF%25D1%2580%25D0%25B8%25D0%25BC%25D0%25B5%25D1%2581%25D0%25B5%25D0%25B9-mixin-%25D0%25B2-%25D1%258F/">comment</a> from a reader who asked me to explain in what way I see the advantage of my implementation over the implementation of <a href="http://schleicher.ru/blog/183.html">Leonid Schleicher</a> . <br><br>  I was going to answer in the comments to the post of my site, but suddenly it turned out that the question is quite interesting.  Or rather, not the question itself, but the analysis that I conducted, preparing the answer. <br><a name="habracut"></a><br>  I doubt if any of the two of us with Leonid set himself the task of universal realization of impurities in projects of any size.  Both of our implementations, it seems to me, do not go far beyond the level of home frameworks and are more likely an impurity implementation concept without eval () than a working tool.  But, nevertheless, let's try to dive into the comparison. <br><br>  My option is more productive by using a so-called registry to store cached information about impurities.  But the caching option I used is only effective when repeatedly invoking the impurity method / property.  If the access is one-time - in my version, it is likely to be decently slower than that of Leonid, because you must first build the cache.  To eliminate this drawback, in my case, you should move from the static registry class model to the singleton registry model, initialized through an abstract factory, or implement the standard ‚Äúregistry‚Äù pattern of the framework level.  This will allow the registry implementation to be varied depending on the project requirements and, for example, replace caching with direct calls to speed up one-time calls to methods. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As my reader noted, the implementation of caching complicated the code and made it more error-prone (these are not empty words, I caught more than one bug while debugging, and tests were too lazy to write) and somewhat more difficult to understand, of course. <br><br>  Both I and Leonid seem to have made the same implementation error related to garbage collection.  Pay attention to cyclic references: the aggregator class stores references to instances of impurity classes, and in turn, references to instances of aggregator classes are stored in turn.  In PHP versions younger than 5.3, a memory leak will occur because the garbage collector does not know how to work with circular references.  In 5.3, you can activate a special garbage collector for this purpose, but it slows down the work of the script as a whole, so this is undesirable.  What's bad about it?  It all depends on what and how impurities are used.  If there are many aggregator objects with their impurities, they are large and complex, often created / destroyed - everything will be very bad.  If the impurities are mixed in to the aggregators that exist throughout the life of the script, there will be nothing terrible, since all memory occupied by the script will be forcibly released upon its completion. <br><br>  How to fix this error?  In both implementations, it is quite simple to do this by using the PHP destructor, which is not too often used by PHP.  It is necessary to add a destructor, forcibly resetting the reference to the owning class, to the impurity and the destructor to the aggregator class, clearing the list of impurities of this class. <br><br>  Now it turned out that the Leonid variant is not compiled at all, because the magic method __call () in the Caller class cannot be protected.  Fixed, earned.  In 5.3, the <a href="http://schleicher.ru/blog/183.comments.html">commentary</a> version of this error no longer exists. <br><br>  Leonid implemented magical methods in admixture so that the impurity could refer to the members of the aggregator class as his own.  I did not guess.  However, I will think about whether to implement this idea in myself.  So far, I don‚Äôt really like the call graph, which is obtained at the same time, and some vagueness of the scope. <br><br>  Leonid option static.  For some reason, the code is written in such a way that impurities need to be created in the constructor of the aggregator, which, in general, slightly contradicts the concept of impurities.  In my version of the impurities to the classes are connected dynamically, and this does not even require loading the classes themselves (neither aggregators nor impurities).  That is, all impurities can be connected in one place of the project without sacrificing performance.  This has its drawback: the error in the name of the class-aggregator or impurities is more difficult to track.  After all, classes are not loaded until they actually start to be used. <br><br>  Impurities in the Leonid variant are realized exclusively by inheritance.  In my version of the composition, along with inheritance, is also available.  Sometimes this is useful if a class cannot be inherited from an aggregator class. <br><br>  Due to the ‚Äúconnection‚Äù in my version, impurities can be connected to classes directly in the process of executing the main code.  That is, if you lose caution, it may turn out that this impurity is mixed into one copy of the class and not into the other.  We have obtained excessive flexibility that is easy to eliminate, if necessary.  By the way, this can be done by examining the cache (registry). <br><br>  Leonid's version does not implement all the magic methods of the aggregator class (the main emphasis is on the methods), but this is easy to fix. <br><br>  Both of our options react to the situation with the presence of impurity methods with the same name in the same way: the impurity method registered first will be called.  In my opinion, is also not quite the correct option.  However, the implementation of verification is somewhat costly, especially in cases where speed is required from impurities: after all, it is impossible to verify the presence of duplicates without loading all classes of impurities for a given aggregator.  So, it seems, we both decided to come to terms with it. <br><br>  Leonid forgot to add error checking in a situation if an impurity is attempted through himself to call the aggregator method with a nonexistent name.  This is not good, because in the resulting implementation there is no error situation and just nothing happens.  Or maybe so intended?  In general, from my point of view, this is bad.  Better get an error.  However, everything is easily corrected. <br><br>  Leonid has another curious situation, if in the admixture determine a protected or private method with a name, and then try to call a method with that name on the aggregator.  Pay attention to the call graph.  The aggregator calls __call (), it searches for a method with the specified name among the impurity methods using method_exists ().  Matching is found because method_exists () for hidden and protected members also returns true.  An attempt is made to call this method already on the impurity instance.  Since the method is still protected and is not available from this scope, the magic impurity method __call () is called, which, in turn, calls the pseudo-magic aggregator method __access_call, in which Leonid forgot to add error checking.  Since there is no error checking, nothing happens and we do not get any error, although I personally would like.  Yes, and the graph itself turned out to be complicated, in my opinion, for the realization of impurities on 80 lines ... Of course, it is easy to fix the error. <br><br>  In the commentary to the article, the author mentions that ‚Äúeach parent class must create instances of all its impurities.  However, he can use common copies for all, obtaining them with the help of the Registry. ‚Äù  In this case, it is convenient to receive ready-made copies through the registry only if the impurities do not have their own state.  Otherwise, the idea loses its meaning and you need to look for another way. <br><br>  In the comments on the site, the author mentions that he added support for static methods of impurities.  In my version, this requires that you make an additional cache in the registry for static methods.  Slightly more gestures.  While refraining, I guess. <br><br>  It should be noted that in the implementation of Leonid there are pseudo-magic aggregator methods that actually open access to hidden and protected class members in the public interface.  Whether this is bad or good depends on the project.  In principle, normal programmers should understand that methods that begin with two underscores do systemic, internal things and should be called only by the framework's internals.  So, this is not a particular problem. <br><br>  I actively use PHP in PHP for additional checks.  I did not notice Leonid, but this is nothing. <br><br>  In PHP 5.3, a static property with a list of impurities for static calls was added <a href="http://schleicher.ru/blog/183.comments.html">to the comments page</a> .  I think it looks somewhat out of context, since at first glance it seems that impurities are divided into static and specific, which is not true. <br><br>  By the way, the author's version is already working in the project, but mine is not yet.  It lies on your computer idle ... <br><br>  From the irrelevant, I can note that when you read the code on the site, I would like to see if the <a href="http://wordpress.org/extend/plugins/wp-synhighlight/">syntax</a> is not <a href="http://wordpress.org/extend/plugins/wp-synhighlight/">highlighted in color</a> , then at least that the indents are normal.  Leonid's code had to be formatted for analysis in Zend Studio.  I apologize if the code on the site was not intended for analysis by outsiders.  It justifies me except that it is still obtained from open sources. <br><br>  Leonid also asked in the comments about the advantages of impurities over ordinary delegation, but this is a topic for my next article, which will not take long to appear.  The volume does not allow to state my point of view on this question here. <br><br>  A huge request in the comments not to compare the two implementations in terms of "bad / good."  Respect yourself.  Speaking of strengths and weaknesses, refrain from demagogy.  Facts, facts and facts again.  Trolls who adore shouting "UG" and "KG / AM" without even understanding the question, are asked <a href="http://lleo.aha.ru/na/">to go to the landing</a> , the train will soon depart. <br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/108006/">https://habr.com/ru/post/108006/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../107992/index.html">Regular Umlauts</a></li>
<li><a href="../107994/index.html">Context-sensitive research activities</a></li>
<li><a href="../107997/index.html">Overview of the beta version of the application to protect Android devices</a></li>
<li><a href="../107998/index.html">JQuery Mobile Alpha 2 and 1.4.4 Releases</a></li>
<li><a href="../108005/index.html">A-Mobile -> A-Mobile 2010 - what is the X?</a></li>
<li><a href="../108007/index.html">Share your experience. How is storage and password management organized in your studio?</a></li>
<li><a href="../108009/index.html">A couple of suggestions for Q & A</a></li>
<li><a href="../108010/index.html">Cloud Hosting Survey Results</a></li>
<li><a href="../108011/index.html">85 rubles for domain. RF</a></li>
<li><a href="../108016/index.html">5 things you did not know about multithreading</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>