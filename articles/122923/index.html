<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Object Representation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Object presentation of data 
 Good day. In this blog, I would like to talk about presenting data as a set of objects of the same type. The result of a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Object Representation</h1><div class="post__text post__text-html js-mediator-article"><h4>  Object presentation of data </h4><br>  Good day.  In this blog, I would like to talk about presenting data as a set of objects of the same type.  The result of a database query can be represented by a list of tuples, either in the form of a list of named sequences (dictionaries), which are subsequently used in the application, and access to the elements of one sequence occurs by index, or by the attribute name.  Let's try as a result of the sample to get a list of objects that have: <br><br><ul><li>  Attributes that have the same name as the table fields (column name in the query) </li><li>  Simple data processing methods </li></ul><br>  For complex queries, the use of this mechanism is likely to be not justified, but it is quite suitable for working with reference data.  Let's take python as the programming language. <br><br>  So let's get started. <br><a name="habracut"></a><br><h6>  Initial conditions </h6><br>  In our database we have a table of settlements.  For each entry, a primary key, name, time zone correction, and line activity indicator are defined. <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> dicts.points ( id_point <span class="hljs-built_in"><span class="hljs-built_in">serial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">--    "name" character varying(50) DEFAULT ''::character varying, --  sync_hour integer DEFAULT 0, --    ... is_active boolean DEFAULT true, --   CONSTRAINT pk_points PRIMARY KEY (id_point) );</span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Application code </h5><br><h6>  Database Connection Module </h6><br>  We will use the pg canon module to work with PostgreSQL. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pg <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Connection</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""       DB API2 """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,dbname,user,password,host,port)</span></span></span><span class="hljs-function">:</span></span> self.dbname = dbname self.user = user self.password = password self.host = host self.port = port self.db = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-comment"><span class="hljs-comment">#      self.query_collector = None #     self.err = '' #     def Connect(self): """     """ try: self.db = pg.DB(dbname=self.dbname,user=self.user,passwd=self.password,host=self.host,port=self.port) except Exception,err: raise Exception("    : %s" % err.message) def Disconnect(self): self.db.close() def SendQueryReturn(self,query): """  SELECT- """ try: self.query_collector = self.db.query(query) except ProgrammingError,err: self.err = " %s:    \n %s" % (__name__,err.message) return -1 else: return self.query_collector.ntuples() def SendQueryNoreturn(self,query): """  ,    """ try: self.db.query(query) except ProgrammingError,err: self.err = " %s:    \n %s" % (__name__,err.message) return -1 else: return 0 def SendBEGIN(self): """   """ try: self.db.query("BEGIN") except ProgrammingError,err: self.err = " %s:    \n %s" % (__name__,err.message) return -1 else: return 0 def SendCOMMIT(self): """   """ try: self.db.query("COMMIT") except ProgrammingError,err: self.err = " %s:    \n %s" % (__name__,err.message) return -1 else: return 0 def SendROLLBACK(self): """   """ try: self.db.query("ROLLBACK") except ProgrammingError,err: self.err = " %s:     \n %s" % (__name__,err.message) return -1 else: return 0 def GetTupleResult(self): """       """ try: res = self.query_collector.getresult() except: res = [] self.query_collector = None return res def GetDictResult(self): """       """ try: res = self.query_collector.dictresult() except: res = {} self.query_collector = None return res def GetError(self): """      """ res = self.err self.err = '' return res def GetObjectStruct(self,name): try: return self.db.get_attnames(name) except Exception,err: self.err = " %s:     \n%s"%(__name__,err.message) return ()</span></span></code> </pre> <br><br>  Let's sort some methods of the presented class.  The <b>SendQueryReturn</b> and <b>SendQueryNoreturn methods</b> are highlighted for convenience, although, in principle, you can dwell on the use of something one.  The first method is for queries that return the result of a sample. <br><br>  It returns, in case of successful execution of the query, the number of rows.  The result of the query is stored in the attribute class query_collector. <br><br>  SendQueryNoreturn, respectively, is designed to execute queries that do not return datasets.  If the request is successful, the method will return 0. <br><br>  In the case of an error, both methods return -1.  Error description can be returned to the program using <b>GetError</b> . <br><br>  The methods <b>GetTupleResult</b> and <b>GetDictResult</b> return the result of the resulting selection as a list of tuples or as a list of named sequences.  And one more method to focus on is <b>GetObjectStruct</b> .  This method returns a dictionary consisting of the pairs "field name" - "data type". <br><br><h5>  Query level </h5><br>  I singled out requests to the database in a separate module.  The classes used do not know anything about the type of DBMS or database connection library.  The use of the pg module was described above, although nothing prevents you from using something else.  The main condition is that the database connection level classes should have an identical set of methods. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_connection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> connection <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> conn == <span class="hljs-string"><span class="hljs-string">'pg'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> connection.pg_connection <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> connection ...</code> </pre> <br><br>  The <b>set_connection</b> function determines the type of connection to the database and imports the corresponding module under the pseudonym <i>connection</i> . <br>  Then there can be one or several classes that hide the query processing mechanisms: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> query_constants <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QueryLayout</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,dbname,user,password,host=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'localhost'</span></span></span></span><span class="hljs-function"><span class="hljs-params">,port=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5432</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> connection self.err_list = [] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> connection: self.conn = connection.Connection(dbname,user,password,host,port) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: self.CONNECTED = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> self.err_list = [] self.CONNECTED = self.SetConnection() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetConnection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: self.conn.Connect() <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception,err: self.err_list.append(err.message) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CloseConnection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.conn.Disconnect() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">QueryNoreturn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,query)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   ,    """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.conn.SendQueryNoreturn(query) == <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: self.err_list.append(self.conn.GetError()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">QueryReturn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,query)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   ,   """</span></span> res = self.conn.SendQueryReturn(query) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> res &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>: self.err_list.append(self.conn.GetError()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetDataTuple</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.conn.GetTupleResult() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetDataDict</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.conn.GetDictResult() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetErrors</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> res = self.err_list self.err_list = [] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetObjectStruct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,objname)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.conn.GetObjectStruct(objname) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomQuery</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(QueryLayout)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,dbname,user,password,host=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'localhost'</span></span></span></span><span class="hljs-function"><span class="hljs-params">,port=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5432</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> QueryLayout.__init__(self,dbname,user,password,host,port) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BEGIN</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.conn.SendBEGIN() &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>: err_list = self.conn.GetErrors() err_list.insert(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-string"><span class="hljs-string">u" "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">COMMIT</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.conn.SendCOMMIT() &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>: err_list = self.conn.GetErrors() err_list.insert(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-string"><span class="hljs-string">u" "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ROLLBACK</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.conn.SendROLLBACK() &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>: err_list = self.conn.GetErrors() err_list.insert(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-string"><span class="hljs-string">u" "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomGet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,query,mode=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'dict'</span></span></span></span><span class="hljs-function"><span class="hljs-params">,warn=False)</span></span></span><span class="hljs-function">:</span></span> nRes = self.QueryReturn(query) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> nRes &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> mode == <span class="hljs-string"><span class="hljs-string">'tuple'</span></span>: res = self.GetDataTuple() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: res = self.GetDataDict() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {<span class="hljs-string"><span class="hljs-string">'res'</span></span>:len(res),<span class="hljs-string"><span class="hljs-string">'err'</span></span>:[],<span class="hljs-string"><span class="hljs-string">'inf'</span></span>:res} <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> nRes == <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> warn: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {<span class="hljs-string"><span class="hljs-string">'res'</span></span>:<span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-string"><span class="hljs-string">'err'</span></span>:[<span class="hljs-string"><span class="hljs-string">u" "</span></span>],<span class="hljs-string"><span class="hljs-string">'inf'</span></span>:[]} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {<span class="hljs-string"><span class="hljs-string">'res'</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-string"><span class="hljs-string">'err'</span></span>:[],<span class="hljs-string"><span class="hljs-string">'inf'</span></span>:{}} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: err_list = self.GetErrors() err_list.insert(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-string"><span class="hljs-string">u"   "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {<span class="hljs-string"><span class="hljs-string">'res'</span></span>:<span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-string"><span class="hljs-string">'err'</span></span>:err_list,<span class="hljs-string"><span class="hljs-string">'inf'</span></span>:[]} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomSet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,query)</span></span></span><span class="hljs-function">:</span></span> nRes = self.QueryNoreturn(query) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> nRes == <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {<span class="hljs-string"><span class="hljs-string">'res'</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-string"><span class="hljs-string">'err'</span></span>:[],<span class="hljs-string"><span class="hljs-string">'inf'</span></span>:[]} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: err_list = self.GetErrors() err_list.insert(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-string"><span class="hljs-string">u"   "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {<span class="hljs-string"><span class="hljs-string">'res'</span></span>:<span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-string"><span class="hljs-string">'err'</span></span>:err_list,<span class="hljs-string"><span class="hljs-string">'inf'</span></span>:[]}</code> </pre> <br><br>  In the <b>CustomGet</b> and <b>CustomSet</b> methods, <b>they</b> are a unified add-in on query execution processes, returning results.  The return value is the dictionary.  The first element of the dictionary is the result of the query.  The second is a list of exceptions encountered.  The third is the result of the query.  The <b>CustomGet</b> method takes the form of the returned data as additional parameters and the processing flag of the empty sample (in some cases this can be perceived as an error). <br><br><h6>  Requests and their execution </h6><br>  Now we define the query templates for our table. <br><br><pre> <code class="python hljs">ADD_NEW_POINT = <span class="hljs-string"><span class="hljs-string">"select * from dicts.insert_point('%s',%s)"</span></span> DELETE_POINT = <span class="hljs-string"><span class="hljs-string">"select * from dicts.delete_point(%s)"</span></span> EDIT_POINT = <span class="hljs-string"><span class="hljs-string">"select * from dicts.update_point(%s,'%s',%s)"</span></span> GET_ALL_POINTS = <span class="hljs-string"><span class="hljs-string">"select * from dicts.get_all_points"</span></span></code> </pre> <br><br>  You can use queries explicitly, but I prefer to work with views and stored procedures. <br><br>  Now you can imagine the mechanism for executing requests at a higher level: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QueryCollector</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(CustomQuery)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,dbname,user,password,host=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'localhost'</span></span></span></span><span class="hljs-function"><span class="hljs-params">,port=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5432</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> CustomQuery.__init__(self,dbname,user,password,host,port) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddNewPoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,sPointName,nHour)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.CustomSet(ADD_NEW_POINT%(sPointName,nHour)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeletePoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,nIdPoint)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.CustomSet(DELETE_POINT%nIdPoint) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EditPoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,nIdPoint,sPointName,nHour)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.CustomSet(EDIT_POINT%(nIdPoint,sPointName,nHour)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAllPoints</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.CustomGet(GET_ALL_POINTS)</code> </pre> <br><br><h5>  Data models </h5><br>  To use the models, we will have to define some constants. <br><br><pre> <code class="python hljs">COLUMN_TYPES = {<span class="hljs-string"><span class="hljs-string">'int'</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>:int(),<span class="hljs-string"><span class="hljs-string">'bool'</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>:bool(),<span class="hljs-string"><span class="hljs-string">'text'</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>:unicode()} CAST_TYPES = {<span class="hljs-string"><span class="hljs-string">'int'</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x:int(x),<span class="hljs-string"><span class="hljs-string">'bool'</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x:bool(x),<span class="hljs-string"><span class="hljs-string">'text'</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x:unicode(x,<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>)} POINTS = {<span class="hljs-string"><span class="hljs-string">'obj_name'</span></span>:<span class="hljs-string"><span class="hljs-string">'Point'</span></span>,<span class="hljs-string"><span class="hljs-string">'struct'</span></span>:<span class="hljs-string"><span class="hljs-string">'dicts.get_all_points'</span></span>,<span class="hljs-string"><span class="hljs-string">'select'</span></span>:<span class="hljs-string"><span class="hljs-string">'GetAllPoints'</span></span>,<span class="hljs-string"><span class="hljs-string">'insert'</span></span>:<span class="hljs-string"><span class="hljs-string">'AddNewPoint'</span></span>,<span class="hljs-string"><span class="hljs-string">'update'</span></span>:<span class="hljs-string"><span class="hljs-string">'EditPoint'</span></span>,<span class="hljs-string"><span class="hljs-string">'delete'</span></span>:<span class="hljs-string"><span class="hljs-string">'DeletePoint'</span></span>} CONST_NAMES = {<span class="hljs-string"><span class="hljs-string">'Points'</span></span>:POINTS}</code> </pre> <br><br>  COLUMN_TYPES define the base attribute type.  It is necessary at the stage of describing the class of the future data model.  CAST_TYPES is an attempt to cast the data to the required type during the creation of objects. <br>  The POINTS dictionary is the metadata of our object.  The class name is stored here, as well as the names of the methods that will be called when determining the structure of an object, executing the Select, Insert, Update, etc. <br><br><h5>  Creating objects </h5><br>  At first, I described each type of object obtained from the database as a separate class, but soon I came to a more elegant solution ‚Äî the use of a class factory.  In our example, two types of objects will be created: a container object that will contain a collection of atomic objects, each of which will describe a settlement received from the base. <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelManager</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,dbname,user,password,host=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'localhost'</span></span></span></span><span class="hljs-function"><span class="hljs-params">,port=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5432</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> self.query_collector = query_layout.QueryCollector(dbname,user,password,host,port) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuildModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,name,**props)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" model builder NAME - the name of data struct, props - additional properties """</span></span> c_atts = self.GetMetaData(name) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> {} struct = self.query_collector.GetObjectStruct(c_atts[<span class="hljs-string"><span class="hljs-string">'struct'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> {} dctOptions = {} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> struct.items(): dctOptions[i[<span class="hljs-number"><span class="hljs-number">0</span></span>]] = m_const.COLUMN_TYPES.get(i[<span class="hljs-number"><span class="hljs-number">1</span></span>])() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> props.items(): dctOptions[i[<span class="hljs-number"><span class="hljs-number">0</span></span>]] = i[<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [struct,dctOptions] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetMetaData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,name)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" get meta data for loading struct """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_const.CONST_NAMES.get(name) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetInlineMethods</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,name,**methods)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" get's methods from QueryCollector object"""</span></span> c_atts = self.GetMetaData(name) dctMethods = {} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> methods: dctMethods.update(methods) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> c_atts: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: dctMethods[<span class="hljs-string"><span class="hljs-string">'Update'</span></span>] = getattr(self.query_collector,c_atts[<span class="hljs-string"><span class="hljs-string">'update'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: dctMethods[<span class="hljs-string"><span class="hljs-string">'Update'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>:Warning(<span class="hljs-string"><span class="hljs-string">"This method is not implemented!"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: dctMethods[<span class="hljs-string"><span class="hljs-string">'Delete'</span></span>] = getattr(self.query_collector,c_atts[<span class="hljs-string"><span class="hljs-string">'delete'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: dctMethods[<span class="hljs-string"><span class="hljs-string">'Delete'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>:Warning(<span class="hljs-string"><span class="hljs-string">"This method is not implemented!"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dctMethods <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCollectMethods</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,name,**methods)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" get's methods from QueryCollector to Collection object """</span></span> c_atts = self.GetMetaData(name) dctMethods = {} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> methods: dctMethods.update(methods) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> c_atts: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: dctMethods[<span class="hljs-string"><span class="hljs-string">'Insert'</span></span>] = getattr(self.query_collector,c_atts[<span class="hljs-string"><span class="hljs-string">'insert'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: dctMethods[<span class="hljs-string"><span class="hljs-string">'Insert'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>:Warning(<span class="hljs-string"><span class="hljs-string">"This method is not implemented!"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: dctMethods[<span class="hljs-string"><span class="hljs-string">'Select'</span></span>] = getattr(self.query_collector,c_atts[<span class="hljs-string"><span class="hljs-string">'select'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: dctMethods[<span class="hljs-string"><span class="hljs-string">'Select'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>:Warning(<span class="hljs-string"><span class="hljs-string">"This method is not implemented!"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dctMethods <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateClass</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,name,i_methods={},props={})</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" creates a new object """</span></span> c_atts = self.GetMetaData(name) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> c_atts o_meth = self.GetInlineMethods(name,**i_methods) struct,o_prop = self.BuildModel(name,**props) obj = classobj(c_atts[<span class="hljs-string"><span class="hljs-string">'obj_name'</span></span>],(object,),o_meth) setattr(obj,<span class="hljs-string"><span class="hljs-string">'struct'</span></span>,struct) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> o_prop.items(): setattr(obj,i[<span class="hljs-number"><span class="hljs-number">0</span></span>],i[<span class="hljs-number"><span class="hljs-number">1</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,obj,**values)</span></span></span><span class="hljs-function">:</span></span> dct_keys = obj.__dict__.keys() new_obj = obj() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> values.items(): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> i[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dct_keys: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: new_obj.__dict__[i[<span class="hljs-number"><span class="hljs-number">0</span></span>]] = m_const.CAST_TYPES[new_obj.struct[i[<span class="hljs-number"><span class="hljs-number">0</span></span>]]](i[<span class="hljs-number"><span class="hljs-number">1</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: new_obj.__dict__[i[<span class="hljs-number"><span class="hljs-number">0</span></span>]] = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new_obj <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitCollection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,name,**props)</span></span></span><span class="hljs-function">:</span></span> o = self.CreateClass(name) coll_meth = self.GetCollectMethods(name) collection = classobj(name,(object,),coll_meth)() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> props: collection.__dict__.update(props) setattr(collection,<span class="hljs-string"><span class="hljs-string">'items'</span></span>,[]) dctRes = collection.Select() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> dctRes[<span class="hljs-string"><span class="hljs-string">'res'</span></span>]&gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>: collection.items = [self.InitObject(o,**i) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dctRes[<span class="hljs-string"><span class="hljs-string">'inf'</span></span>]] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> collection</code> </pre> <br><br>  The <b>ModelManager</b> class at the initial stage determines the structure of the object being built (BuildModel).  If desired, the attributes of the model can be added to your own.  The <b>GetInlineMethods</b> and <b>GetCollectMethods methods</b> bind the existing database access functions to future objects.  Atom objects will have built-in methods Update and Delete, and container objects will be able to replenish and update their collections using the Insert and Select methods.  The <b>CreateClass</b> method <b>is</b> responsible for creating a <u>class</u> , instances of which will be subsequently created by us.  Here we will use the classobj function of the module new, which will return us a new class. <br><br>  Now you can specify the type of database being used, create an instance of the ModelManager class, and call the InitCollection method, which will return an object containing a list of objects from the Points table in the <i>items</i> attribute. <br>  In principle, container objects can also be used as atom objects.  In the implementation of one-to-many connections, parent objects will act as containers for their descendants. </div><p>Source: <a href="https://habr.com/ru/post/122923/">https://habr.com/ru/post/122923/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../122914/index.html">Reviews of web studios on WebProfessionals.ru</a></li>
<li><a href="../122915/index.html">Indian Groupon laid out a database with passwords of 200,000 users</a></li>
<li><a href="../122918/index.html">Pokki: web applications inside the OS</a></li>
<li><a href="../122919/index.html">Functional programming in Java</a></li>
<li><a href="../122920/index.html">Nesting icons with pseudo-elements and css clip properties</a></li>
<li><a href="../122925/index.html">Will United Russia ban outsourcing?</a></li>
<li><a href="../122926/index.html">Oracle. Start</a></li>
<li><a href="../122927/index.html">Generate one-time passwords using a smartphone</a></li>
<li><a href="../122928/index.html">Microsoft patent for listening to VoIP telephony</a></li>
<li><a href="../122929/index.html">Using procedures and functions in Delphi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>