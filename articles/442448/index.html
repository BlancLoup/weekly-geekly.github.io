<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Concurrency and error patterns hidden in code: Deadlock</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Surely, many have heard, and someone has met in practice, words such as deadlock and race condition. These concepts belong to the category of errors i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Concurrency and error patterns hidden in code: Deadlock</h1><div class="post__text post__text-html js-mediator-article">  Surely, many have heard, and someone has met in practice, words such as deadlock and race condition.  These concepts belong to the category of errors in the use of concurrency.  If I ask you the question of what a deadlock is, you will most likely without any doubt begin to draw a classic image of the deadlock or its presentation in pseudocode.  Something like that: <br><br><img src="https://habrastorage.org/webt/mr/0l/ld/mr0lldyuxzcz1am0qcmo5hsgxze.png"><br><br>  This information we receive at the institute, can be found in books and articles on the Internet.  Such deadlock using, for example, two mutexes, in all its glory can be found in the code.  But in most cases, not everything is so simple, and not everyone can see the classic error pattern in the code, if it is not presented in the usual way. <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/fd/sk/mg/fdskmgiramf-v9islka0at8scgi.jpeg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Consider the class in which we are interested in the methods StartUpdate, CheckAndUpdate and Stop, using C ++, the code is simplified as much as possible: <br><br><pre><code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::recursive_mutex m_mutex; Future m_future; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-function">unique_lock </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scoped_lock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(m_mutex)</span></span></span></span>; m_future.Wait(); <span class="hljs-comment"><span class="hljs-comment">// do something } void StartUpdate() { m_future.Wait(); m_future = Future::Schedule(std::bind(&amp;Element::CheckAndUpdate, this), std::chrono::milliseconds(100); } void CheckAndUpdate() { std::unique_lock scoped_lock(m_mutex); //do something }</span></span></code> </pre> <br>  What you should pay attention to in the presented code: <br><br><ol><li>  recursive mutex is used.  Repeated capture of a recursive mutex does not lead to waiting only if these captures occur in the same stream.  At the same time, the number of mutex releases should correspond to the number of captures.  If we try to capture a recursive mutex that is already captured in another thread, the thread goes into standby mode. </li><li>  the Future :: Schedule function starts (after n milliseconds) the callback passed to it in a separate thread </li></ol><br>  Now let's analyze all the received information and make a picture: <br><br><img src="https://habrastorage.org/webt/9t/nm/rq/9tnmrqiylhu8rq-pmewzbft1etc.png"><br><br>  Taking into account the two facts presented above, it is easy to conclude that an attempt to capture a recursive mutex in one of the functions will lead to waiting for the mutex to be released if it has already been captured in another function, since the CheckAndUpdate callback is always in a separate thread. <br><br>  At first glance, there is nothing suspicious about the deadlock.  But to be more attentive, it all comes down to our classic picture.  When a functional object starts to run, we kind of implicitly grab the m_future resource, callback directly <br>  associated with m_future: <br><br><img src="https://habrastorage.org/webt/d7/vd/df/d7vddfwbntho41g-9j02le7xouw.png"><br><br>  <b>The order of actions leading to deadlock is as follows:</b> <br><br><ol><li>  CheckAndUpdate is scheduled to run, but the callback does not start immediately, after n milliseconds. </li><li>  The Stop method is called, and then it started: trying to capture the mutex - one resource is captured, we start to wait for the completion of the m_future - the object has not yet been called, we are waiting. </li><li>  CheckAndUpdate execution begins: trying to capture a mutex - we can not, the resource is already captured by another thread, we are waiting for release. </li></ol><br>  That's all: the thread making the Stop call waits for the completion of CheckAndUpdate, and another thread in turn cannot continue to work until it captures the mutex that has already been captured by the thread mentioned earlier.  Quite a classic deadlock.  The floor of the case is done - the cause of the problem is detected <br><br><div class="spoiler">  <b class="spoiler_title">Now a little about how to fix it.</b> <div class="spoiler_text">  <b>Approach 1</b> <br>  The order of seizure of resources should be the same, this will avoid the deadlocks.  That is, you need to see if it is possible to change the order in which resources are captured in the Stop method.  Since here the deadlock case is not quite obvious, and there is no obvious seizure of the m_future resource in CheckAndUpdate, we decided to think over another solution in order to avoid returning an error in the future. <br><br>  <b>Approach 2</b> <br><ol><li>  Check if you can stop using mutex in CheckAndUpdate. </li><li>  Once we use the synchronization mechanism, we restrict access to some resources.  Perhaps it will be enough for you to convert these resources into atomics (as it was with us), access to which is already thread-safe. </li><li>  It turned out that the variables, access to which was limited, can be easily converted into atomics, so the mentioned mutex is successfully removed. </li></ol><br></div></div><br>  Such a simple example with non-obvious deadlock easily comes down to the pattern of this error.  Finally, I want to wish you to write reliable and thread-safe code! </div><p>Source: <a href="https://habr.com/ru/post/442448/">https://habr.com/ru/post/442448/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../442438/index.html">A first glance at JavaScript through the eyes of a Java developer</a></li>
<li><a href="../442440/index.html">Create Android apps using Anko Layouts and Anko Coroutines</a></li>
<li><a href="../442442/index.html">Senior Engineer in search of work. About tasks on technical interviews and theoretical questions</a></li>
<li><a href="../442444/index.html">Myths of modern popular physics</a></li>
<li><a href="../442446/index.html">Digital transformation on the example of the Call Center of any business</a></li>
<li><a href="../442450/index.html">Blockchain and medical data: how it works</a></li>
<li><a href="../442452/index.html">How to log in NodeJS to the boys in the yard respected</a></li>
<li><a href="../442454/index.html">Magic Leap plans to add digital layers to the real world</a></li>
<li><a href="../442456/index.html">How to save resources in the browser and not break the web. Yandex report</a></li>
<li><a href="../442458/index.html">Handmade chasm or the path from the RPA pilot to company-wide implementation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>