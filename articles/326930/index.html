<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Recovering data from a damaged RAID 50 array</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many companies require servers with a high-performance disk subsystem of large capacity, which is achieved through the use of a large number of high-p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Recovering data from a damaged RAID 50 array</h1><div class="post__text post__text-html js-mediator-article">  Many companies require servers with a high-performance disk subsystem of large capacity, which is achieved through the use of a large number of high-performance disks.  We have a case when the company used a solution of 10 <abbr title="Hard disk drive">HDDs</abbr> with a <abbr title="Serial Attached SCSI">SAS</abbr> interface with a capacity of 600 GB, organized into a <abbr title="Redundant Array of Independent Disks">RAID</abbr> 50 array (the usable capacity of the array is 600 * 8 = 4800 GB).  This RAID 50 is a combined array, which is considered as two RAID 5 arrays combined into a RAID 0 array. This solution allows you to get a higher write speed on the array compared to a regular RAID 5 with the same number of participating disks, because the formation of a parity block requires a smaller number of read operations from the disks of the participants (the speed of calculating the parity block itself can be neglected due to the fact that it represents a very small load for modern RAID controllers).  Also in RAID 50, in some cases, fault tolerance will be higher, since it is possible to lose up to two drives (provided that drives from different RAID 5 arrays included in this RAID).  In our case, according to the system administrator, 2 drives failed, which caused the RAID array to stop.  This was followed by the actions of the system administrator and the service department of the server vendor company, which cannot be described due to confusing and contradictory testimony. <br><a name="habracut"></a><br>  In our case, the disks are numbered by the customer‚Äôs representative from 0 to 9 with the words: ‚Äúin that order they were used in the array, and no one changed them in some places‚Äù.  This statement is subject to mandatory verification.  We were also informed that this array was used as storage for the ESXi server, and it should contain several dozen virtual machines. <br><br>  Before you start any operations on disks from an array, you need to check their physical integrity and operability, as well as create copies and continue to work exclusively with copies for safe work.  If there are seriously damaged drives, consider the need to perform data extraction, that is, if only one drive is seriously damaged, it is necessary to find out by analyzing the array collected from the remaining disks whether the problematic HDD contains up-to-date data, or if they need to be ignored. XOR account operations over the remaining members of one of the RAID 5 that included this drive. <br><br>  Copies were created, as a result of which it turned out that 4 drives have defects between <abbr title="Logical block adressing">LBA</abbr> 424,000,000 and LBA 425,000,000, which is expressed in the form of unreadable several dozen sectors on each of the problematic disks.  The unread sectors in the copies are filled with the pattern 0xDE 0xAD so that later there is the possibility of identifying the affected data. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The primary analysis involves identifying the RAID controller to which the disks were connected, more precisely identifying the location of the RAID controller metadata so that these areas do not include when assembled into an array. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/4ea/67c/134/4ea67c13460f4e98b00d7cd5f94a8645.png"></div><br>  In this case, in the last sector of each of the disks, we find the characteristic 0xDE 0x11 0xDE 0x11 with further marking of the brand of the RAID controller.  The metadata of this controller is located solely at the end of the LBA range, any buffer zones in the middle of the range are not used by this controller.  Based on this and previous data, the conclusion is that array collection should begin with LBA 0 of each of the disks. <br><br>  Knowing that the total capacity of the array is more than 2 TB, we search LBA 0 for each disk in the partition table (protective <abbr title="Master boot record">MBR</abbr> ) <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/336/467/1d9/3364671d9a474d8bbd6a87112fa9ae7e.png"></div><br>  and <abbr title="GUID Partition Table">GPT</abbr> header in LBA 1. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/45d/bcc/b20/45dbccb209ee4c23b33c022c5e1618be.png"></div><br>  In this case, these structures are not detected.  These structures usually fall victim to the rash actions of server maintenance personnel who did not work out situations of storage system failure and did not study the specific features of the operation of a specific RAID controller. <br><br>  For further analysis of the features of the array, it is necessary to search regular expressions of monotonically increasing sequences on one of the disks.  These can be either <abbr title="File allocation table">FAT</abbr> tables or a rather large <abbr title="Master file table">MFT</abbr> fragment, or other structures that are convenient for analysis.  Knowing that this array contained Windows virtual machines, we can assume that the <abbr title="New Techology File System">NTFS</abbr> file system was used inside these machines.  Based on this, we search for MFT records using the characteristic regular expression 0x46 0x49 0x4C 0x45 with zero offset from the 512-byte block (sector).  In our case, after LBA 2,400,000 (1.2GB), a sufficiently long (more than 5000 records) MFT fragment is found.  In our case, the MFT record size is standard and is 1024 bytes (2 sectors). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/721/714/8ef/7217148efaf94124886aeeacdd45e483.png"></div><br>  Localize the boundaries of the found fragment with MFT records and check for the presence of a fragment with MFT records in these boundaries on the remaining disks participating in the array (the boundaries may slightly differ, but not more than by the size of the block used in the RAID array).  In our case, the presence of MFT records is confirmed.  Scroll through the records with the analysis of numbers (the DWORD number is located at offset 0x2C).  Analyze the number of blocks, where the increase in the number of MFT records occurs with a change of one, based on this, we calculate the size of the block used in this RAID array.  In our case, the size is 0x10000 bytes (128 sectors or 64KiB).  Next, choose among the MFT records any of the places where the MFT records or the result of their XOR operation are symmetrically located on all the participating disks and create a matrix with the record numbers from which the array blocks with double the number of rows begin. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/245/60b/c48/24560bc4888248bb951065044a6f9f3e.png"></div><br>  By record numbers, we will determine which of the disks are included in the first RAID 5, and which in the second.  Checking the correctness is performed through the XOR operation.  In our case, according to the table, we see that the numbering of the disks by the customer‚Äôs representative was done incorrectly, since the matrices of both arrays differ in the location of the parity block (denoted as ‚ÄúXOR‚Äù).  We also see that in this array there is no parity delay, since the position of the parity block changes with each line. <br><br>  By filling the table with MFT record numbers for the specified offsets from each of the disks, you can proceed to filling in the doubled disk usage matrix.  It is doubled due to the fact that we started to form the matrix in an arbitrary place.  The next task is to determine from which row the correct matrix begins.  The task is easily accomplished if we take the first five offsets indicated in the figure above and multiply by 8. Next, solve a simple example in the form a = a + b where the starting values ‚Äã‚Äãare a = 0x0 b = 0x280000 (0x280000 = 0x10000 * 0x28, where 0x28 is the number blocks with data that are contained in the disk usage matrix) and solve it in a loop until it reaches one of the offset values ‚Äã‚Äãmultiplied by 8. <br><br>  After constructing the disk utilization matrix, we can produce an array by any means available for this, which can work with a matrix of arbitrary size.  But such an array collection option will not take into account the relevance of data on all disks, and therefore additional analyzes are needed to exclude a disk containing irrelevant data (it was first excluded from the array). <br><br>  Determining an irrelevant disk does not usually require a complete array collection.  It is enough to collect the first 10-100GB and analyze the structures found.  In our case, we operate with the beginning of an array of 20GB.  As already written, the protective MBR and GPT are absent on the disks, and, of course, they are not in the assembled array, but when searching quite quickly you can find the magic <abbr title="Virtual Machine File System">VMFS</abbr> block, taking away its position 0x100000 (2048 sectors), we get the beginning point of the VMFS partition.  Having determined the position of fdc.sf (file descriptor system file), we will analyze its contents.  In many cases, the analysis of this structure will allow to find a place where there are erroneous records.  Comparing it with the disk usage matrix, we obtain the number of the disk containing irrelevant data.  In our case, this turned out to be enough and no additional analytical measures were required. <br><br>  By completing the entire array collection with compensation for missing data due to XOR operations, we obtained a complete array image.  Knowing the localization of defects and the localization of virtual machine files in the image, it is possible to establish which particular virtual machine files are defective.  After copying the virtual machine files from the VMFS storage, we can mount them in the OS as separate disks and check the integrity of the files contained in the virtual machines by searching for files containing sectors with the 0xDE 0xAD pattern.  Having formed the list of damaged files, the work of recovering information from damaged RAID 50 can be considered completed. <br><br>  I draw your attention to the fact that this publication does not intentionally mention professional data recovery systems that simplify the work of a specialist. <br><br>  <a href="https://habrahabr.ru/post/327414/">Next post: Restore 1C Enterprise (DBF) database after formatting.</a> </div><p>Source: <a href="https://habr.com/ru/post/326930/">https://habr.com/ru/post/326930/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326914/index.html">Welcome to Android Devs Meetup April 26</a></li>
<li><a href="../326916/index.html">Ten main reasons that make a programmer unhappy</a></li>
<li><a href="../326920/index.html">Yii 1.1.18</a></li>
<li><a href="../326926/index.html">Where to start programming in add. education? Or SmallBasic and all-all-all</a></li>
<li><a href="../326928/index.html">Universal work with VCS / SCM within the framework of automation with FutoIn CID</a></li>
<li><a href="../326932/index.html">How often the light is chopped, and how does it end for business</a></li>
<li><a href="../326936/index.html">Pseudo-toning of images: eleven algorithms and sources</a></li>
<li><a href="../326940/index.html">Development of a component for creating collages</a></li>
<li><a href="../326942/index.html">Connect to the webinar: "Azure Stack TP3 Technical Overview." Beginning April 27 at 11:00 (Moscow time)</a></li>
<li><a href="../326944/index.html">Video marketing in social networks: the most important indicators in 2017</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>