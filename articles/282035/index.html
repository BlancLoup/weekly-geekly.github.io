<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Weak [weak] links in the new version of Delphi</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. 

 Embarcadero yesterday announced the release of a new version of Delphi RAD studio XE 10.1 , 
 You can see the entire list of changes here , ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Weak [weak] links in the new version of Delphi</h1><div class="post__text post__text-html js-mediator-article">  Hello. <br><br>  Embarcadero yesterday announced the release of a new version of <a href="http://community.embarcadero.com/blogs/entry/this-is-the-release-you-are-looking-for">Delphi RAD studio XE 10.1</a> , <br>  You can see the entire list of changes <a href="http://docwiki.embarcadero.com/RADStudio/Berlin/en/What%2527s_New">here</a> , but I want to talk about the most valuable (for our company) improvement, namely the introduction of <a href="https://habrahabr.ru/post/163679/">weak [weak] links</a> to the classical compiler (Win32 / Win64). <br><br>  Above the article gives details of the problem, so that those who want to see what they have done in Delphi, please under the cat. <br><a name="habracut"></a><br>  So, we will consider as the example of using weak links, the interface container.  Of course, weak links are necessary in other situations, but we will consider this particular case.  In such a collection, we have the following problem: the elements of the container must have a link to the owner-collection (for example, to have a link to an element, it can be removed from the collection or simply accessed to it).  In turn, the collection itself should also contain links to the elements.  Since in previous versions of Delphi, we had the opportunity to declare only normal references (strong references), as a result, we received circular references in this collection, which made it impossible to correctly free memory.  Usually, there were two ways out of this situation: <br>  1. In the element class, a non-typed pointer for the FOwner field was used.  Assigning an interface reference to such an index did not lead to an increase in the reference count, which solved the problem of a circular reference, but this code is not safe - if the collection dies before the element (a link to which has been assigned somewhere), there is no safe way to learn about deletion collection - owner.  FOwner pointer - continued to point to memory already removed. <br>  2. To solve the problem of the previous method, you can implement an alert for items about the collection being deleted.  When deleting, the collection runs through all its elements and causes a certain method in them, which in turn ‚Äúunderstates‚Äù the FOwner field.  The disadvantage of this approach is the additional code and time required for its execution.  In the case of our collection example, this is not so scary, but in other non-trivial examples this code can confuse logic and add errors. <br>  And in the latest version of the XE10.1 Berlin, there is a humanly normal opportunity to solve this problem.  All you need is to declare the FOwner field with the attribute [weak].  Such a link will still be strongly typed, but assigning it to which will not increase the reference count to the original object.  In the case when the object (in our case, the owner-collection) is deleted from memory, such a link will automatically ‚Äúbecome underestimated‚Äù, which will be an indicator that the object is deleted. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's write two interfaces, and 2 classes that implement these interfaces (this example is simplified to the limit, and the issues of speed optimization did not stand at all) <br><div class="spoiler">  <b class="spoiler_title">Description of interfaces and classes</b> <div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-comment"><span class="hljs-comment">{ }</span></span> IXListItem = <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> [<span class="hljs-string"><span class="hljs-string">'{02E680D6-9F86-4303-85B5-256ACD89AD46}'</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetName</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">Name</span></span></span></span><span class="hljs-function"><span class="hljs-params">: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> GetName <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> SetName; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-comment"><span class="hljs-comment">{ }</span></span> IXList = <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> [<span class="hljs-string"><span class="hljs-string">'{922BDB26-4728-46DA-8632-C4F331C5A013}'</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-function">:</span></span> IXListItem; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Count</span></span></span><span class="hljs-function">:</span></span> Integer; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetItem</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">Index</span></span></span></span><span class="hljs-function"><span class="hljs-params">: Integer)</span></span></span><span class="hljs-function">:</span></span> IXListItem; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> Items[<span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>: Integer]: IXListItem <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> GetItem; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Clear</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-comment"><span class="hljs-comment">{  }</span></span> <span class="hljs-title"><span class="hljs-title">TXListItem</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TInterfacedObject, IXListItem) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> [weak] FOwner: IXList; <span class="hljs-comment"><span class="hljs-comment">//     FName: string; public constructor Create(const Owner: IXList); destructor Destroy; override; procedure SetName(const Name: string); function GetName: string; end; {  } TXList = class(TInterfacedObject, IXList) private FItems: array of IXListItem; public function Add: IXListItem; function Count: Integer; function GetItem(Index: Integer): IXListItem; procedure Clear; destructor Destroy; override; end;</span></span></code> </pre> <br></div></div><br>  As you can see in the TXListItem object there is a weak reference to the owner object. <br><br>  The implementation of the TXListItem class, in the GetName method, we use our weak reference: <br><div class="spoiler">  <b class="spoiler_title">TXListItem</b> <div class="spoiler_text"><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">{TXListItem}</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TXListItem</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Owner: IXList)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> FOwner := Owner; <span class="hljs-comment"><span class="hljs-comment">//    end; destructor TXListItem.Destroy; begin ShowMessage('Destroy ' + GetName); inherited; end; function TXListItem.GetName: string; var List: IXList; begin List := FOwner; if Assigned(List) then Exit(FName + '; owner assined!') else Exit(FName + '; owner NOT assined!'); end; procedure TXListItem.SetName(const Name: string); begin FName := Name; end;</span></span></code> </pre><br></div></div><br>  TXList class is trivial: <br><div class="spoiler">  <b class="spoiler_title">Txlist</b> <div class="spoiler_text"><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">{ TXList }</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TXList</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-function">:</span></span> IXListItem; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> c: Integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> c := Length(FItems); SetLength(FItems, c + <span class="hljs-number"><span class="hljs-number">1</span></span>); Result := TXListItem.Create(Self); FItems[c] := Result; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TXList</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Clear</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: Integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Length(FItems) - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> FItems[i] := <span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TXList</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Count</span></span></span><span class="hljs-function">:</span></span> Integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := Length(FItems); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">destructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TXList</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Destroy</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Clear; ShowMessage(<span class="hljs-string"><span class="hljs-string">'Destroy list'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">inherited</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TXList</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetItem</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">Index</span></span></span></span><span class="hljs-function"><span class="hljs-params">: Integer)</span></span></span><span class="hljs-function">:</span></span> IXListItem; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := FItems[<span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br></div></div><br>  We declare our variables: <br><div class="spoiler">  <b class="spoiler_title">var</b> <div class="spoiler_text"><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Form1: TForm1; List: IXList; Item: IXListItem;</code> </pre><br></div></div><br>  And methods for creating and deleting objects. <br><div class="spoiler">  <b class="spoiler_title">methods</b> <div class="spoiler_text"><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btnListCreateAndFillClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> List := TXList.Create; <span class="hljs-comment"><span class="hljs-comment">//   List.Add.Name := 'item1'; //    List.Add.Name := 'item2'; Item := List.Add; //       Item.Name := 'item3'; end; procedure TForm1.btnListClearClick(Sender: TObject); begin List := nil; //   end; procedure TForm1.btnLastItemFreeClick(Sender: TObject); begin Item := nil; //   ,    end; procedure TForm1.FormCreate(Sender: TObject); begin ReportMemoryLeaksOnShutdown := true; //     end;</span></span></code> </pre><br></div></div><br>  An example of working with the announcement [weak] links: <br><img src="https://habrastorage.org/files/bd2/33b/56b/bd233b56b241442196176304522fbd9f.gif" alt="image"><br><br>  Example of working without declaring [weak] links: <br><img src="https://habrastorage.org/files/018/0b6/1a8/0180b61a8b35405aa0242593f69c2f3d.gif"><br><br>  As you can see, without using [weak] links, the collection and the elements cyclically link to each other and they do not call destructors, and accordingly we receive a memory leak, which is what FastMM informs us about. <br><br>  Also in the new version there is an attribute [unsafe] which is analogous to [weak], but when you delete an object to which it refers, the link is not automatically ‚Äúunderestimated‚Äù. <br>  By the way, we already found one bug with it, which we sent to <a href="https://quality.embarcadero.com/browse/RSP-14233">qc</a> . <br><br>  Thanks for the example and help in writing a colleague <a href="https://habrahabr.ru/users/h_xandr/" class="user_link">h_xandr</a> . <br><br>  upd.  <a href="https://bitbucket.org/ingword/examples/src/e6630dff25d2fff7fa499afc6813a54b1fbb2665/WeakLinks_Berlin_10.1/%3Fat%3Dmaster">Link to the repository</a> </div><p>Source: <a href="https://habr.com/ru/post/282035/">https://habr.com/ru/post/282035/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282025/index.html">Increase Magento Performance</a></li>
<li><a href="../282027/index.html">Houdini: one of the most impressive CSS projects you've never heard of</a></li>
<li><a href="../282029/index.html">IDS / IPS Suricata rule appearance statistics for new threats</a></li>
<li><a href="../282031/index.html">8 mistakes when developing a mobile application</a></li>
<li><a href="../282033/index.html">April 23-24, from 12:00 to 12:00, we invite you to # 1 Global Chatbots Hackathon from Webinar.ru</a></li>
<li><a href="../282037/index.html">We do multitasking</a></li>
<li><a href="../282039/index.html">Moscow Python Meetup ‚Ññ34 (April 27)</a></li>
<li><a href="../282041/index.html">JS Loader + template engine or history of another</a></li>
<li><a href="../282043/index.html">On the development of non-paged keys based on passwords</a></li>
<li><a href="../282045/index.html">Scaling to 100 million: architecture defined by service level</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>