<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>An affordable explanation of the wave function collapse algorithm</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Wavefunction Collapse Algorithm teaches a computer to improvise. At the input, it receives archetypal data and creates procedurally generated data...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>An affordable explanation of the wave function collapse algorithm</h1><div class="post__text post__text-html js-mediator-article">  The Wavefunction Collapse Algorithm teaches a computer to improvise.  At the input, it receives archetypal data and creates procedurally generated data similar to the original. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8ba/2ac/867/8ba2ac86732b567e3dc2c20793051e0a.png"></div><br>  <em>( <a href="https://selfsame.itch.io/unitywfc">Source</a> )</em> <br><br>  Most often it is used to create images, but it can also build <a href="https://selfsame.itch.io/unitywfc">cities</a> , <a href="https://arcadia-clojure.itch.io/proc-skater-2016">skateparks</a> and write <a href="https://github.com/mewo2/oisin">awful poems</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b18/54d/0a4/b1854d0a45b83b3f99be84e626650285.png"></div><br>  <em>( <a href="https://selfsame.itch.io/unitywfc">Source</a> )</em> <br><br>  The collapse of the wave function is a very independent-minded algorithm that requires virtually no help or instructions from outside.  You only need an example of the style that you want to achieve, and he will do the rest.  Despite his self-sufficiency, he is surprisingly simple.  It does not use any neural networks, random forests, or anything else that resembles machine learning.  If you deal with the idea, it will become very understandable and intuitive for you. <br><br>  Most implementations and explanations of the collapse of the wave function are a complete, speed-optimized version of the algorithm.  Of course, all of them are important and necessary, but it is difficult to understand them from scratch.  In this post, I will explain everything in a simple language that I understand, focusing on the limited version of Wavefunction, which I called <em>Even Simpler Tiled Model</em> .  In addition, I posted <a href="https://github.com/robert/wavefunction-collapse">an example implementation of ESTM on Github</a> .  The code in it is inefficient and slow, but very readable and commented in detail.  As soon as you understand the technology underlying ESTM, you will become closer to understanding more complex versions of the algorithm.  If you want to understand the wave function collapse algorithm, then this article will be a good start. <br><a name="habracut"></a><br>  Let's start with the story. <br><br><h2>  Wedding </h2><br>  Imagine that you are planning your wedding.  In addition to the selection of jewelry and music, you need to create a seating plan for guests for dinner.  Your family likes to argue and be naughty, so it can be difficult.  A father cannot sit closer than two tables from his mother.  A cousin becomes lonely if she does not sit with another cousin.  And it‚Äôs better not to plant Uncle Roy next to the environmentally-friendly members of your partner‚Äôs family.  There is only 5 hours left before the arrival of food, so you decide to attack this stubborn task using the wave function collapse algorithm. <br><br>  You start with a long list of rules and an empty seating plan. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d6b/81f/be8/d6b81fbe8f02d46e2c8605e672daf480.png"></div><br>  You create the original <em>wave function of the</em> plan.  She ties each chair to a list of people who can sit on it.  While any person can sit on any chair.  The wave function of seating guests begins with a complete <em>superposition</em> (the concept is borrowed from quantum physics) of each possible scheme. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/266/24d/401/26624d401c97db4be9042eac28e4eb44.png"></div><br>  Schr√∂dinger's cat was dead and alive at the same time, until someone opened the box and checked;  your plan is at the same time every possible scheme until you put things in order.  A complete superposition is a useful theoretical construct, but it will not help your grandmother figure out where she needs to sit.  You need to bring the wave function of the guests' location to a single certain state, which can then be turned into ordinary, non-quantum name cards. <br><br>  We begin to do this by performing the <em>collapse of the wave function</em> for one chair.  We select a chair, look at the list of people who can sit on it, and randomly assign it to one of them.  In this case, the wave function of the stool becomes collapsed. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/abc/e44/fd1/abce44fd1d7be4c3b25db2fab11c3898.png"></div><br>  This choice has consequences that apply to the wave functions of the remaining chairs.  If Uncle Roy is sitting at table 2, then cousin Frank and Michelle Obama (a friend of your partner's family) will definitely not be next to him.  And if Michelle does not sit at table 2, then Barack will not be behind him either.  We are updating the wave function of the location plan by deleting people from the lists of possible candidates. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/435/12f/716/43512f7161b3572e88320d38daa53fbe.png"></div><br>  As soon as the vibrations settle, we repeat this process.  We select another chair with several possible candidates and collapse its wave function, randomly choosing one of the people acceptable for it.  Again, we extend the vibrations caused by this choice to the rest of the plan, removing people from the wave function of the chair if they can no longer sit on it. <br><br>  We repeat this process either until the wave function collapses (that is, exactly 1 sitting person remains in it), or until we reach a <em>contradiction</em> .  Contradiction is a chair that no one can sit on, because they were all expelled due to previous elections.  The contradiction makes the impossibility of the collapse of the entire wave function. <br><br>  If you have reached a contradiction, then the easiest way is to start over.  Discard all previous work, find a new empty plan and start the algorithm again, completing the collapse of the wave function for another random chair.  You can also implement a backtracking system that allows you to cancel a single choice, rather than immediately abandon everything ("what if Sheila is transferred to chair 54?"). <br><br>  After a few false starts, you will finally reach a completely collapsed state in which each chair is assigned to exactly one person and all the rules are followed.  Done! <br><br><h2>  From wedding to bitmaps </h2><br>  This is not a theoretical example.  You really can implement the option of collapse of the wave function, which will create a seating plan for guests for the wedding.  However, in the more traditional Wavefunction Collapse, we usually try not to seat people at the wedding, but to arrange the pixels in the output image.  However, the process will be very similar.  We teach the algorithm a set of rules that the output should satisfy.  We initialize the wave function.  We perform the collapse of one element and extend the consequences to the rest of the wave function.  And we continue to do so, either until the wave function completely collapses, or until we reach a contradiction. <br><br>  The traditional collapse of the wave function differs from the wedding collapse in the way we teach the algorithm the rules that it must follow.  In the wedding version, we had to write down the rules ourselves.  But in the traditional version, we just give the algorithm an example image, and based on it, the algorithm creates the rest.  He parses an example, analyzes its patterns and finds out how pixels or <em>tiles</em> should line up. <br><br>  Let's start researching the real collapse of a wave function by looking at a simple special case, which <a href="https://twitter.com/exutumno"><code>ExUtumno</code></a> (the creator of the algorithm) calls the <em>Simple Tiled Model</em> . <br><br><h2>  Simple tiled model </h2><br>  In the Simple Tiled Model, input and output images are constructed from a small number of predefined tiles, and each square in the output image is limited to only its four nearest neighbors.  For example, suppose we generate random worlds for a two-dimensional game with a top view.  We can have tiles for land, coast and sea, as well as a set of rules such as ‚Äúthe coast can be near the sea‚Äù, ‚Äúland can be near the coast‚Äù and ‚Äúthe sea can be near another sea‚Äù. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fad/636/6e9/fad6366e936dea0271782d2179260b57.png"></div><br>  <em>The Simple Tiled Model</em> takes into account the symmetry and rotation of its tiles.  For example, land may be near the coast, but only in the correct orientation. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0df/31c/70e/0df31c70e056e480c35b1734c951ee40.png"></div><br>  This symmetry processing provides better output images, but complicates the code.  To keep things simple, let's look at an even simpler form of wave function collapse, which I called <em>Even Simpler Tiled Model</em> . <br><br><h2>  Even Simpler Tiled Model </h2><br>  Even the Simpler Tiled Model (‚Äúan even simpler tile model‚Äù) is similar to the Simple Tiled Model, but its tiles do not have symmetry properties.  Each tile is one pixel of the same color, that is, we will not be able to confuse their edges in any way. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6da/0ae/fcd/6da0aefcd8f0a78b05109d5f9b89cee4.png"></div><br>  Even Simpler Tiled Model rules determine which tiles can be placed next to each other and in which orientation.  Each rule is a tuple of three elements (3-tuple): two tiles and a direction.  For example, <code>(SEA, COAST, LEFT)</code> means that the <code>SEA</code> tile (sea) can be <code></code> from the <code>COAST</code> tile (coast).  This rule must be accompanied by another rule that describes the situation from the point of view of <code>COAST</code> - <code>(COAST, SEA, RIGHT)</code> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/918/fd1/c25/918fd1c25a24f6eda37f75d5ef39748a.png"></div><br>  If you want the <code>SEA</code> tiles to be located not only to the <code></code> , but to the <code></code> from the <code>COAST</code> tiles.  then they need additional rules: <code>(SEA, COAST, RIGHT)</code> and <code>(COAST, SEA, LEFT)</code> . <br><br>  As I said above, we do not need to create a list of all these rules ourselves.  The collapse of the wave function can create a set of rules for Even Simpler Tile Model by parsing an example image and collecting a list of all 3-tuple it contains. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/944/ea7/8ff/944ea78ff7e49911267b435a8741fde9.png"></div><br>  Having examined the example image shown above, Even Simpler Tiled Model notices that the sea tiles can only be under or to the side of the coast tiles, or anywhere near other sea tiles.  She also notes that coast tiles can be located next to land, sea, or other coast tiles, but only above sea tiles and under land tiles.  She does not try to derive any more complex rules, for example, "sea tiles should be near at least one sea tile" or "each island must contain at least one land tile."  None of the tiles can affect the fact that some types of tiles can or cannot be located two or more squares from them.  This is similar to a wedding plan model, with the only rule: ‚ÄúX can sit next to Y‚Äù. <br><br>  When analyzing the incoming image, we also need to record the frequency with which each of the tiles meets.  Later, we use these numbers as weights when choosing the wave function of the square whose collapse needs to be performed, as well as when choosing the tile assigned to the square when it is collapsed. <br><br>  Having learned the rules that the output image must adhere to, we are ready to build the collapse of the wave function of the output image. <br><br><h2>  Collapse </h2><br>  As in the wedding example, we begin the process of collapsing with a wave function in which each square of the output image is in a superposition of each type of tile. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b00/c76/278/b00c76278927df358d545336dd0e73c4.png"></div><br>  We begin by choosing a square whose wave function will collapse.  In the wedding example, this choice was made by chance.  However, as <code>ExUtumno</code> noted, people usually approach these tasks differently.  Instead, they look for squares with the lowest <em>entropy</em> .  Entropy is a measure of uncertainty and disorder.  In general, a square with high entropy is a square with many possible tiles remaining in its wave function.  It is still not clear to which tile he ultimately collapses.  A low entropy square is a square with the fewest possible tiles in the wave function.  The set of tiles, to one of which he collapses as a result, is already very limited. <br><br>  For example, in the Even Simpler Tile Model, a square without information about the surrounding squares is unlimited and can become any tile.  Therefore, it has a very high entropy.  But a square around which several squares have already collapsed can have a choice of only 2 tiles. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1cf/3ec/319/1cf3ec3198ebde9f2f3e3b3620efdfff.png"></div><br>  The wave function of the central square in the figure above did not completely collapse, but we already know that it cannot be a land tile.  However, it is already limited, which means it has an <em>entropy</em> lower than that of the upper right square, which can still be land, sea or coast. <br><br>  It is such limited tiles with low entropy that people usually pay attention to when they manually solve such problems.  Even if you do not use the collapse of the wave function to create a plan for accommodating guests at the wedding and will draw it up yourself, you will still focus on those areas of the plan that already have the greatest number of restrictions.  You will not put Dwayne at table 1, and then randomly jump to get Katie at table 7 (which is empty so far).  You first put Dwayne, then you will figure out who can sit next to him, then who can sit next to this person, and so on.  I have not yet seen the rationale for this, but my intuition says that using this <em>heuristic of minimal entropy</em> is likely to produce less <em>contradictions</em> than if you randomly select squares for collapse. <br><br>  The <em>Shannon formula</em> is used as the entropy formula in the wave function collapse algorithm.  It uses the weights of the tiles that we parsed from the incoming image in the previous step: <br><br><pre> <code class="cpp hljs"># Sums are over the weights of each remaining <span class="hljs-meta"><span class="hljs-meta"># allowed tile type for the square whose # entropy we are calculating. shannon_entropy_for_square = log(sum(weight)) - (sum(weight * log(weight)) / sum(weight))</span></span></code> </pre> <br>  Having calculated the square of the wave function with the smallest entropy, we collapse its wave function.  We do this by randomly selecting one of the tiles that are still available for the square, weighted by the weights of the tiles that we parsed from the incoming image.  Weights are used because it provides a more realistic output image.  Suppose the wave function of a square reports that it can be land or coast.  We do not always have to choose one of the options with a probability of 50%.  If the input image has more land tiles than the coast, then we should reflect this advantage in the output image.  This is realized using simple global weights.  If in the example image there are <code>20</code> land tiles and <code>10</code> coast tiles, then the square collapses into land with a probability of <code>2/3</code> , and in the coast - with the remaining probability of <code>1/3</code> . <br><br>  Then we extend the consequences of the choice to the rest of the wave function of the output (‚Äúif that tile turned out to be the sea, then this tile cannot be land, that is, this cannot be the coast‚Äù).  When all these tremors have settled, we repeat the process using the minimum entropy heuristic to select the next collapsing tile.  We repeat this collapse-propagation cycle, either until the entire wave function of the output image completely collapses and we can return the result, or until we reach a contradiction and return an error. <br><br>  As a result, we created a world (or mistake). <br><br><h2>  Where to go next </h2><br>  Having dealt with the Even Simpler Tiled Model, you are ready to climb the ladder of power and complexity of the algorithm.  Start with the Simple Tiled Model that we mentioned at the beginning of this post, then go on to the full Overlapping Model.  In the Overlapping Model, tiles or pixels affect each other from a distance.  If you understand such things, then <code>ExUtumno</code> notices that the Simple Tiled Model is similar to the Markov chain of order-1, and more complex models resemble chains of a larger order. <br><br>  Wavefunction Collapse can even take into account additional restrictions, for example, ‚Äúthis tile must be sea‚Äù or ‚Äúthis pixel must be red‚Äù or ‚Äúthere can be only one monster in the output‚Äù.  All this is described by the <a href="https://github.com/mxgmn/WaveFunctionCollapse">README of the main project</a> .  You can also study the speed optimizations made to the full implementation.  It is not necessary to recalculate the entropy of each square in each iteration, and the dissemination of information by the wave function can be done much faster.  These aspects become more important as the size of the output images increases. <br><br>  The collapse of the wave function is a beautiful and powerful tool that is worth mastering.  Think about it the next time you plan a wedding or generate a procedural world. </div><p>Source: <a href="https://habr.com/ru/post/461323/">https://habr.com/ru/post/461323/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461313/index.html">Zimbra 8.8.15 LTS Released</a></li>
<li><a href="../461317/index.html">9 Principles for Creating Quality iOS Applications</a></li>
<li><a href="../461319/index.html">What does a game designer do?</a></li>
<li><a href="../46132/index.html">Firefox 3 bug: phantom borders and how to deal with them</a></li>
<li><a href="../461321/index.html">Generic and metaprogramming models: Go, Rust, Swift, D and others</a></li>
<li><a href="../461325/index.html">Victory at PHDays 9. We share life hacks in three parts. Part 3</a></li>
<li><a href="../461327/index.html">Front-end crisis?</a></li>
<li><a href="../461333/index.html">ITX5 mitap: live JAVA, Kotlin magic and tomato tinder</a></li>
<li><a href="../461339/index.html">How to be data driven. From the very beginning</a></li>
<li><a href="../46134/index.html">Delivery of video content to users</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>