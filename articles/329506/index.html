<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What to do if PK Identity runs out of values?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sometimes, when designing a database, developers underestimate the scale of the project. And then, the project shoots and becomes heavily loaded. Then...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What to do if PK Identity runs out of values?</h1><div class="post__text post__text-html js-mediator-article">  Sometimes, when designing a database, developers underestimate the scale of the project.  And then, the project shoots and becomes heavily loaded.  Then, at some point, someone notices that an identity of type INT is selected as the primary key of a large table, with a limit of 2,147,483,647. <br><br>  Initially, it seems that 2 billion records is a lot.  But if, do you have 10 million new entries added daily?  And already spent more than 1 billion values?  Do you have a 24/7 application?  You only have 114 days left to fix the type of primary key.  This is not so much if you use the key value in both the web application and the client. <br><img src="https://habrastorage.org/web/d80/08c/83f/d8008c83fc414c27b962118b4ad541d8.jpg"><br><a name="habracut"></a><br>  If the described situation is familiar to you, and you have noticed this regrettable detail - you are running out of primary key values ‚Äã‚Äã- too late, then this article is for you.  In the article you will find the scripts that are listed for the TableWithPKViolation table, in which the TableWithPKViolationId field causes the problem. <br><br>  In the worst case, you encountered the error ‚ÄúArithmetic overflow error converting to data type int‚Äù.  This means that the primary key values ‚Äã‚Äãhave already run out and your application has stopped working.  In this case, you can use the following solutions: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Change the type of primary key to BIGINT.  Everyone and everyone understands that the best option is to sit in a time machine and change INT to BIGINT there, in the past.  But you can do it now, if the TableWithPKViolationId field is not used in the server and client applications, then you have the opportunity to quickly and painlessly change the type.  Do this and do not waste time on the rest of the article.  Please note that if your table has more than 1 billion records, the change will be applied, i.e.  may take more than 3 hours, depending on the capacity of your server, and will require additional space in the transaction log (if you can, switch to the Recovery Mode in Simple).  The script to change is as follows: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> TableWithPKViolation <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> TableWithPKViolationId <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>;</code> </pre> <br>  If this method is not available to you, you need to plan the transfer of the key to BIGINT as soon as possible. <br><br></li><li>  Use negative values.  Usually, when using identity, the default IDENTITY (1,1) is used.  When the value goes to 2 billion records, you can reset the initial value using the following command: <br><br><pre> <code class="sql hljs">DBCC CHECKIDENT (TableWithPKViolation, - 2147483647, reseed)</code> </pre> <br>  and thus get much more time to go to BIGINT.  The only inconvenience of this solution is the negative values ‚Äã‚Äãof the primary key.  Check that your business logic allows for negative values.  Perhaps this is the easiest solution. <br><br></li><li>  Iii.  Create a table with unused values.  Count the values ‚Äã‚Äãthat are missing and create a table with a list of unused values.  This will give you extra time to go to BIGINT. <br><br>  This method will suit you if you do not rely on the order of records in the table, that is, do not use ORDERY BY Id.  Or there are not many places where there is such a sort, and you can change the sorting to another field, for example, on the date the record was added. <br><br>  You can create a table with unused values ‚Äã‚Äãin two ways: <br><br>  <b>Method A</b>  Missing values. <br><br>  When you use Identity, you always have missing values, since values ‚Äã‚Äãare reserved at the start of a transaction, and, in the case of its rollback, the next transaction is assigned a new, following the reserved, value of the primary key.  The reserved value that was generated for the canceled transaction will remain unused.  These unused values ‚Äã‚Äãcan be formed into a separate table and applied using the code below. <br><br>  <b>Method B</b>  Remote values. <br><br>  If you usually delete records from the table where the primary key values ‚Äã‚Äãend, then all deleted values ‚Äã‚Äãcan be reused as free ones.  I will give an example of code for this option below. <br><br>  Source Table TableWithPKViolation. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [dbo].[TableWithPKViolation]( [TableWithPKViolationId] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">IDENTITY</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY]</code> </pre> <br><br>  1. Create a table for storing free IDs. <br>  10-CreateNewId.sql <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [dbo].[NewIds]( [NewId] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [DateUsedUtc] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY]</code> </pre><br>  Further, depending on the method: <br><br>  To generate a sequence using Method A. Missing values: <br><br>  2. Generate a sequence of missing identifiers <br>  20-GenerateGaps.sql <br>  "Option1 FindGaps \ 20-GenerateGaps.sql" <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [dbo].[spNewIDPopulateInsertFromGaps] @batchsize <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-number"><span class="hljs-number">10000</span></span>, @startFrom <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> XACT_ABORT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; IF @startFrom IS NULL <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @startFrom = <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>([NewId]) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.NewIds; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @startId <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(@startFrom,<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @rowscount <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = @batchsize; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @maxId <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @maxId = <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(TableWithPKViolationId) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.TableWithPKViolation; WHILE @startId &lt; @maxId <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.NewIds ([NewId]) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (@batchsize) @startId + ROW_NUMBER() <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> TableWithPKViolationId) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.TableWithPKViolation <span class="hljs-comment"><span class="hljs-comment">--any table where you have @batchsize rows ) AS genids WHERE id &lt; @maxId AND NOT EXISTS ( SELECT 1 FROM [dbo].[TableWithPKViolation] as Tb WITH (NOLOCK) WHERE Tb.TableWithPKViolationId = genids.id ); SET @rowscount = @@ROWCOUNT; SET @startId = @startId + @batchsize; PRINT CONVERT(VARCHAR(50),GETDATE(),121)+' '+ CAST(@startId AS VARCHAR(50)); END END</span></span></code> </pre><br>  To generate a sequence with method B Remote values: <br>  2. Create a table for generating a sequence and fill it with data from 1 to 2,147,483,647 <br>  15-CreateInt.sql <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [dbo].[IntRange]( [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY]</code> </pre><br>  20-GenerateInt.sql <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [dbo].[spNewIDPopulateInsert] @batchsize <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-number"><span class="hljs-number">10000</span></span>, @startFrom <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> XACT_ABORT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; IF @startFrom IS NULL <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @startFrom = <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.IntRange; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @startId <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(@startFrom,<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @rowscount <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = @batchsize; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @maxId <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-number"><span class="hljs-number">2147483647</span></span>; WHILE @rowscount = @batchsize <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.IntRange (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (@batchsize) @startId + ROW_NUMBER() <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> TableWithPKViolationId) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.TableWithPKViolation <span class="hljs-comment"><span class="hljs-comment">--any table where you have @batchsize rows ) AS genids WHERE id &lt; @maxId; SET @rowscount = @@ROWCOUNT; SET @startId = @startId + @rowscount; PRINT CONVERT(VARCHAR(50),GETDATE(),121)+' '+ CAST(@startId AS VARCHAR(50)); END END</span></span></code> </pre><br>  25-PopulateRange.sql <br><br><pre> <code class="sql hljs">exec dbo.spNewIDPopulateInsert @batchsize = 10000000</code> </pre><br>  The script uses the TableWithPKViolation table to generate a sequence, you can use any method for this, including the sequence built into MS SQL (Sequence).  This method was chosen because it worked faster than others. <br><br>  30-CreateIndexOnInt.sql <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [dbo].[IntRange] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED ( [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> )<span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (PAD_INDEX = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, STATISTICS_NORECOMPUTE = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, SORT_IN_TEMPDB = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, IGNORE_DUP_KEY = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ONLINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, ALLOW_ROW_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, ALLOW_PAGE_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY]</code> </pre><br>  and fill it up <br>  50-GenerateNewId.sql <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [dbo].[spNewIDPopulateInsertFiltered] @batchsize <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-number"><span class="hljs-number">10000</span></span>, @startFrom <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @endTill <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> XACT_ABORT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; IF @startFrom IS NULL <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @startFrom = <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>([NewId]) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.NewIds; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @startId <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(@startFrom,<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @rowscount <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = @batchsize; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @maxId <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(@endTill,<span class="hljs-number"><span class="hljs-number">2147483647</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @endId <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = @startId + @batchsize; WHILE @startId &lt; @maxId <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [NewIds] ([NewId]) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> IR.id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[IntRange] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> IR <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> IR.id &gt;= @startId <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> IR.id &lt; @endId <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[TableWithPKViolation] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Tb <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (NOLOCK) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> Tb.TableWithPKViolationId = IR.id ); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @rowscount = @@ROWCOUNT; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @startId = @endId; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @endId = @endId + @batchsize; IF @endId &gt; @maxId <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @endId = @maxId; PRINT CONVERT(VARCHAR(50),GETDATE(),121)+' '+ CAST(@startId AS VARCHAR(50)); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br>  55-ExecGeneration.sql <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-----Run each part in separate window in parallel ----- --part 1 exec dbo.spNewIDPopulateInsertFiltered @batchsize = 10000000, @startFrom = 1, @endTill= 500000000 --end of part 1 --part 2 exec dbo.spNewIDPopulateInsertFiltered @batchsize = 10000000, @startFrom = 500000000, @endTill= 1000000000 --end of part 2 --part 3 exec dbo.spNewIDPopulateInsertFiltered @batchsize = 10000000, @startFrom = 1000000000, @endTill= 1500000000 --end of part 3 --part 4 DECLARE @maxId INT SELECT @maxId = MAX(TableWithPKViolationId) FROM dbo.TableWithPKViolation exec dbo.spNewIDPopulateInsertFiltered @batchsize = 10000000, @startFrom = 1500000000, @endTill= @maxId --end of part 4</span></span></code> </pre><br>  3. A table of free identifiers generated by method A or B is ready.  Create indexes on a table with free keys. <br>  60-CreateIndex.sql <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [dbo].[NewIds] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [PK_NewIds] PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED ( [NewId] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> )<span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (PAD_INDEX = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, STATISTICS_NORECOMPUTE = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, SORT_IN_TEMPDB = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, IGNORE_DUP_KEY = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ONLINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, ALLOW_ROW_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, ALLOW_PAGE_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> NONCLUSTERED <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> [IX_NewIds_DateUsedUtc] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[NewIds] ( [DateUsedUtc] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> )<span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (PAD_INDEX = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, STATISTICS_NORECOMPUTE = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, SORT_IN_TEMPDB = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, DROP_EXISTING = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ONLINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, ALLOW_ROW_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, ALLOW_PAGE_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [dbo].[NewIds] <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ( LOCK_ESCALATION = <span class="hljs-keyword"><span class="hljs-keyword">DISABLE</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br>  We check that everything has been correctly generated.  There should not be an ID in the NewId table that is in the main TableWithPKViolation table. <br>  70-CheckData.sql <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @maxId <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> @maxId = <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(TableWithPKViolationId) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> [dbo].[TableWithPKViolation] <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> [dbo].[NewIds] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [NewId] &gt; @maxId) <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> PRINT <span class="hljs-string"><span class="hljs-string">'PROBLEM. Wait for cleanup'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @batchsize <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-number"><span class="hljs-number">10000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @rowcount <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = @batchsize; while @rowcount = @batchsize <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> top (@batchsize) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> [dbo].[NewIds] <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> DFVId &gt; @maxId; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @rowcount = @@rowcount; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> PRINT <span class="hljs-string"><span class="hljs-string">'OK'</span></span>;</code> </pre><br>  If you generate sequentially on another server (for example, on a server with a restored backup of the database), then you can upload data to a file using the script: <br>  80-BulkOut.sql <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @command <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">4096</span></span>), @dbname <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>), @<span class="hljs-keyword"><span class="hljs-keyword">path</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1024</span></span>), @filename <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>), @batchsize <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @dbname = DB_NAME(); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">path</span></span> = <span class="hljs-string"><span class="hljs-string">'D:\NewIds\'; SET @filename = '</span></span>NewIds-<span class="hljs-string"><span class="hljs-string">'+@dbname+'</span></span>.txt<span class="hljs-string"><span class="hljs-string">'; SET @batchsize = 10000000; SET @command = '</span></span>bcp <span class="hljs-string"><span class="hljs-string">"['+@dbname+'].dbo.NewIds"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-string"><span class="hljs-string">"'+@path+@filename+'"</span></span> -c -t, -S localhost -T -b <span class="hljs-string"><span class="hljs-string">'+CAST(@batchsize AS VARCHAR(255)); PRINT @command exec master..xp_cmdshell @command</span></span></code> </pre><br>  4. Create a procedure that marks the required number of available IDs and returns them as a result. <br>  90-GetNewId.sql <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [dbo].[spGetTableWithPKViolationIds] @batchsize <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> XACT_ABORT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @rowcount <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">now</span></span> DATETIME = <span class="hljs-keyword"><span class="hljs-keyword">GETUTCDATE</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRAN <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> TOP (@batchsize) dbo.NewIds <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> DateUsedUtc = @<span class="hljs-keyword"><span class="hljs-keyword">now</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTPUT</span></span> inserted.[NewId] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> DateUsedUtc <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @rowcount = @@ROWCOUNT; IF @rowcount != @batchsize <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @msg <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2048</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @msg = <span class="hljs-string"><span class="hljs-string">'TableWithPKViolationId out of ids. sp spGetTableWithPKViolationIds, table NewIds. '</span></span> +<span class="hljs-string"><span class="hljs-string">'Ids requested '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(@batchsize <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)) + <span class="hljs-string"><span class="hljs-string">', IDs available '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(@rowcount <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)); RAISERROR(@msg, 16,1); <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span> TRAN <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br>  5. Add to all the procedures in which the data was inserted into the table and return SCOPE_IDENTITY (), a call to the new procedure. <br><br>  If performance permits or time is very expensive for you, and you need to change a lot of procedures, you can make a trigger instead of insert. <br><br>  Here is an example of how you can use the procedure to issue new primary key values: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-comment"><span class="hljs-comment">#tmp_Id (Id INT); INSERT INTO #tmp_Id EXEC spGetTableWithPKViolationIds @batchsize=@IDNumber; SELECT @newVersionId = Id FROM #tmp_Id; SET IDENTITY_INSERT [dbo].[TableWithPKViolation] ON;</span></span></code> </pre><br>  Note that the SET IDENTITY_INSERT ON option requires that the user calling the procedure has ALTER permission for the TableWithPKViolation table. <br><br>  6. Then you can configure the JOB, which will clear the table with the used identifiers <br>  95-SPsCleanup.sql <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> dbo.spCleanupNewIds @batchSize <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-number"><span class="hljs-number">4999</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @minId <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @maxId <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @minId = <span class="hljs-keyword"><span class="hljs-keyword">Min</span></span>([NewId]), @maxId = <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>([NewId]) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.NewIds <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (NOLOCK) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> DateUsedUtc <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @totRowCount <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @rowCount <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = @batchSize <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @rowcount = @batchsize <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> TOP (@batchsize) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.NewIds <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> DateUsedUtc <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> [NewId] &gt;= @minId <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> [NewId] &lt;= @maxId <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @rowcount = @@ROWCOUNT <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @totRowCount = @totRowCount + @rowcount <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> PRINT <span class="hljs-string"><span class="hljs-string">'Total records cleaned up - '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(@totRowCount <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br>  JOB, which will delete used records once a day, is not required.  If you regularly delete records from the main table, then you can supplement this table with deleted values. <br><br>  I would still recommend to plan the transition to BIGINT. <br><br>  New identifiers, of course, will be issued incrementally, however, it is necessary to think through the logic of sorting new identifiers so that they go after previously issued old identifiers, even if the arithmetic value of new ones is less. <br></li></ol><br>  The temporary solutions described in this article to the fact that the primary key values ‚Äã‚Äãhave suddenly run out help you gain time and keep the system operational while you change the system and the program for a new data type. <br><br>  The best solution is to monitor the boundary values ‚Äã‚Äãand transition to the appropriate data types in advance. <br><br>  <a href="https://drive.google.com/file/d/0B2xL7TcM6ZSpcjRfSU51N25Dd0E/view%3Fusp%3Dsharing">Archive with code</a> </div><p>Source: <a href="https://habr.com/ru/post/329506/">https://habr.com/ru/post/329506/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../329488/index.html">Visual editor of letters on React + Redux. Overview, example of use and expansion</a></li>
<li><a href="../329492/index.html">Industrial mitap # 3: safe process automation is in focus</a></li>
<li><a href="../329494/index.html">About generics in PHP and why we need them</a></li>
<li><a href="../329498/index.html">Autoboxing and unboxing in Java</a></li>
<li><a href="../329500/index.html">How we won the hackathon in New York</a></li>
<li><a href="../329510/index.html">How to achieve the reuse of React components (Translation)</a></li>
<li><a href="../329512/index.html">Results WannaCry: a selection of basic materials on the "Habrahabr" and not only</a></li>
<li><a href="../329514/index.html">Stack Overflow brought more than a million users out of Vim</a></li>
<li><a href="../329516/index.html">Comprehensive online marketing guide. Day 1. Three ways to scale a business</a></li>
<li><a href="../329518/index.html">Experiments with malloc and neural networks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>