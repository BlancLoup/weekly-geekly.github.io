<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Solving the problem of sorting trees using a binary Materialized Path</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Faced the problem of implementing tree comments on one project, in this post I post my decision. 

 Task Description 


- Storing hierarchical data (t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Solving the problem of sorting trees using a binary Materialized Path</h1><div class="post__text post__text-html js-mediator-article">  Faced the problem of implementing tree comments on one project, in this post I post my decision. <br><br><h4>  Task Description </h4><br><ul><li>  Storing hierarchical data (tree comments) in a relational MySQL database </li><li>  Simple addition of nodes / branches </li><li>  Selection of the entire tree in one query, with the branches sorted in the right order </li></ul><br>  In principle, the task is classical, and at first I solved it with the help of the combination of the <a href="http://habrahabr.ru/post/46659/">Adjacency List and the Materialized Path</a> .  In other words, columns are added to the table. <br><br><pre><code class="sql hljs">id INT(11) parentid INT(11) mpath VARCHAR(255)</code> </pre> <br>  The mpath stored the full path of the branch in the tree, for example <b>/</b> 1/3/4/5/8/9, where the comment ID is listed through the "/" sign. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      With this approach, it is very easy to add new comments of almost any nesting level.  The sample was made by the query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> messages <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> postid=$postid <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> mpath <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span></code> </pre> <br>  The problem arose with an increase in the number of comments. <a name="habracut"></a>  For example, there is a tree with the following paths: <br><br><pre> <code class="html hljs xml">1 1.2 1.2.10 1.2.3 1.2.7 4 4.8 4.8.9 5 5.6</code> </pre> <br>  Here the numbers indicate the ID, and the order is what it would have turned out when using <code>ORDER BY mpath ASC</code> . <br>  Comment 1.2.10 goes to 1.2.3 and others, although it was added later (judging by the ID). <br><br><h4>  The solution of the problem </h4><br>  The solution of the problem was partially described here: <a href="http://habrahabr.ru/post/125729/">http://habrahabr.ru/post/125729/</a> .  The idea is to use not decimal IDs on the way, but to encode to another number system in order to have less restrictions on the length of the way.  At the same time, separators in the form of dots or other characters are not needed, since the field will be used only for sorting. <br><br>  I used base 95, this is just the number of printable characters in ASCII. <br><br><pre> <code class="hljs tex"> !"#<span class="hljs-formula"><span class="hljs-formula">$%&amp;</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">'</span></span></span></span></span><span class="hljs-formula">()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">]</span></span></span></span></span><span class="hljs-formula">^_`abcdefghijklmnopqrstuvwxyz{|}~</span></span></code> </pre><br><br>  If for each value in the path we use a fixed length, we get the following upper ID threshold: <br>  1 - 95 ^ 1 - 1 = 94 <br>  2 - 95 ^ 2 - 1 = 9,024 <br>  3 - 95 ^ 3 - 1 = 857 374 <br>  4 - 95 ^ 4 - 1 = 81 450 624 <br>  5 - 95 ^ 5 - 1 = 7 737 809 374 <br><br>  5 characters is enough to not worry about the maximum number of comments. <br>  The maximum level of nesting, at the same time, for VARCHAR 255/5 = 51 <br><br>  Theoretically, you can take not BASE95, but BASE256 (along with unprintable characters), but keep it all binary in the BLOB, although here I am not sure about the sorting performance (need to check).  Then by 3 characters we could encode 16,777,215 variants, and 4 - 4,294,967,295. <br><br><h4>  How it looks in code </h4><br>  I will give my example of the implementation of this whole theory. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// $mpath -   materialized path   "/" //    : $db-&gt;Execute(" UPDATE messages SET mpath=?, bpath=?, depth=? WHERE id=? ", array( $mpath, bpath($mpath), $depth, $messid )); // . . . //      define('BASE95', ' !"#$%&amp;\'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuvwxyz{|}~'); // . . . //  bpath function bpath($mpath, $sep = '/', $max_len = 5) { $bpath = ''; $chunks = explode($sep, trim($mpath, $sep)); $zero = substr(BASE95, 0, 1); foreach($chunks as $chunk) $bpath .= str_pad(dec2base($chunk, 95, BASE95), $max_len, $zero, STR_PAD_LEFT); return $bpath; }</span></span></code> </pre><br>  And further sample: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> messages <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> postid=$postid <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> bpath <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span></code> </pre> <br>  The dec2base function is taken <a href="http://www.php.net/manual/en/ref.bc.php">from here</a> . <br><br>  Such a solution, in my opinion, is very simple.  If you also have beautiful solutions in your arsenal, share them in the comments. </div><p>Source: <a href="https://habr.com/ru/post/226741/">https://habr.com/ru/post/226741/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../226711/index.html">The company Ilona Mask SolarCity intends to become the largest manufacturer of solar panels in the world</a></li>
<li><a href="../226713/index.html">Summer Mini-Conference on Robotics in Yekaterinburg</a></li>
<li><a href="../226715/index.html">Video recordings of DesignLab conference reports</a></li>
<li><a href="../226723/index.html">The most complete collection of video games in the world sold for 750 thousand dollars</a></li>
<li><a href="../226725/index.html">How we increased JSON generation speed by 6000 times</a></li>
<li><a href="../226743/index.html">Overview teXet TM-511R: a secure phone with a 2,700 mAh battery</a></li>
<li><a href="../226749/index.html">ElasticSearch and search vice versa. Percolate API</a></li>
<li><a href="../226755/index.html">Hybrid Cloud FAQ: Good old virtualization in a new financial wrapper</a></li>
<li><a href="../226759/index.html">How to use Routing in Ext JS 5</a></li>
<li><a href="../226763/index.html">Zero Downtime Upgrade for an application in Microsoft Azure. Part 2: IaaS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>