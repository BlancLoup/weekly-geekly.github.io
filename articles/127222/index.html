<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ActionMailer_X509: Sign and Encrypt Emails Directly in Ruby On Rails</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In one of the last projects, it was necessary to sign and encrypt using X.509 certificates letters sent by the application to Ruby on Rails 3. A quick...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ActionMailer_X509: Sign and Encrypt Emails Directly in Ruby On Rails</h1><div class="post__text post__text-html js-mediator-article">  In one of the last projects, it was necessary to sign and encrypt using X.509 certificates letters sent by the application to Ruby on Rails 3. A quick search resulted in the <a href="https://github.com/penso/actionmailer_x509">actionmailer_x509</a> plugin, but then the problems started. <br><br>  It turned out that it has not been updated since 2008, most likely it does not work with Rails 3 (in particular, it embarrassed the author‚Äôs comment: ‚ÄúIt has been tested with Rails 2.0.1‚Äù) and is only able to sign, but not encrypt letters.  <a href="http://stackoverflow.com/questions/6428983/how-do-i-send-signed-emails-from-actionmailer-in-rails-3">Search for</a> <a href="http://habrahabr.ru/qa/8779/">alternative</a> <a href="http://serverfault.com/questions/285381/how-to-sign-and-encrypt-all-sended-mail-via-sendmail-postfix/285751">solutions</a> <a href="http://stackoverflow.com/questions/6858756/sendmail-postfix-milter-mimedefang-how-to-encrypt-and-sign-and-emails">gave</a> nothing, and had to get acquainted with the plugin closer. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The acquaintance was complicated very quickly: the test suite that came with the plugin fell during the run.  As it turned out, although it was not easy to notice right away, the fact was that the certificates that the author included in the test set had expired.  Recreated certificates.  Next, I removed the libraries from Rails 2 from the test helper and added the corresponding ones from Rails 3, made a number of changes <br><br>  It immediately turned out that <a href="https://github.com/mikel/mail">Mail</a> , the new mail processing gem, which is now used in Ruby on Rails 3, is significantly different from <a href="http://tmail.rubyforge.org/">Tmail</a> .  I had to cut into the internal Mail and Tmail device, rewrite all the parts affecting Tmail.  Ok, done.  Of course, I tinker, and the letter headers were not transferred, but this was solvable. <br><br>  New problem: in the comments to the code, the author <a href="">writes</a> ‚ÄúNOTE: we can‚Äôt reparse the whole mail, TMail adds a \ r \ n which breaks the signature ...‚Äù.  Indeed, the signature verification does not work and in the resulting body of the Mail object \ r \ n stand every 60 characters, while in the original, every 64 characters. It took a very long time to fight this problem.  I tried gsub to get everything in place, I studied the code of gem Mail, left bug reports in Mail, wrote to the list of mailings, but everything was in vain.  In the end, I was saved <a href="http://stackoverflow.com/questions/6663409/ruby-mail-gem-add-r-n-after-60-chars-in-mail">by a stackoverflow question</a> .  It turned out that Mail adds a content-id that changes the headers of the letter, and, therefore, the signature becomes incorrect, and this has nothing to do with \ r \ n, which the author wrote about the original actionmailer_x509. <br><br>  After the correction and the forced installation of content_id, everything went smoothly: I cleaned the code, wrapped everything in a separate gem, corrected the rake tasks and added the code responsible for encrypting the letter. <br><br>  You can enjoy the result of my labors in my <a href="https://github.com/petRUShka/actionmailer_x509">forma actionmailer_x509</a> on github or with the help of the line gem 'actionmailer_x509' in your Gemfile. <br><br>  It allows the following simple code to include signature and / or encrypt outgoing mail. <br><br><pre><code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FooMailer</span></span></span><span class="hljs-class"> &lt; ActionMailer::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sending_method</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">email</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">from</span></span></span><span class="hljs-class"> , </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subject</span></span></span><span class="hljs-class"> = "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Empty</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subject</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">signed</span></span></span><span class="hljs-class">") </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#    x509_sign true x509_sign_cert "certs/yourwebsite.crt" x509_sign_key "certs/yourwebsite.key" #     x509_sign_passphrase "my passphrase for the certificate" #    x509_crypt true x509_crypt_cert "certs/crypt.crt" #    ,     DES x509_crypt_cipher "AES-128-CBC" mail(:subject =&gt; subject, :to =&gt; email, :from =&gt; from) end end</span></span></span></span></code> </pre> <br><br>  In addition, the plugin allows you to set all these key settings for the entire application as a whole and provides several rake tasks for testing settings and speed.  Read more about this in the <a href="https://github.com/petRUShka/actionmailer_x509">README</a> . <br><br><h5>  Instead of conclusion </h5><br>  I spent more than a month adapting actionmailer_x509 to Ruby on Rails 3 features. I learned smime openssl, gem Mail, gem Tmail, and ActionMailer.  I learned how to wrap code in a gem and how the gem structure should look like;  how correctly, with the help of the railtie, load the rake tasks so that they become visible in the final Rails application.  There were moments when I was ready to give up, and looked for workarounds for solving my problem, but, fortunately, I managed to finish the game with a gem. <br><br>  I do not regret the time spent, and I look at the newly created gem with a sense of satisfaction.  Now I feel the whole Ruby on Rails mailbox much better, and I‚Äôve become a lot more knowledgeable about OpenSSL related issues.  If you suddenly have to choose to finish / create an existing solution or try to work around the problem somehow - try to do something new for the community, you should like it! </div><p>Source: <a href="https://habr.com/ru/post/127222/">https://habr.com/ru/post/127222/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../127213/index.html">Git and site publishing</a></li>
<li><a href="../127214/index.html">Sound Design in Cubase 5</a></li>
<li><a href="../127216/index.html">Interview with Ryan Dahl. Part one</a></li>
<li><a href="../127218/index.html">Analysis of the Russian Post site and an attempt to make it better</a></li>
<li><a href="../127220/index.html">Cocos2d-x: Building a project for Android</a></li>
<li><a href="../127223/index.html">Digest Wanted.VC # 12</a></li>
<li><a href="../127224/index.html">10 fabulous speeches by Steve Jobs</a></li>
<li><a href="../127225/index.html">LiveInternet.ru: how user passwords are stored</a></li>
<li><a href="../127227/index.html">Quick and automatic launch of Django on IIS 7.x in a production environment (+ performance tests)</a></li>
<li><a href="../127229/index.html">We write letters from iOS applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>