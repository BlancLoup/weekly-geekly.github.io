<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Script to backup EC2-instance to AMI</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. 

 I want to share a script for $ subj. Perhaps someone will be useful. 

 Task setting: there are a number of EC2 servers in AWS scattered acr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Script to backup EC2-instance to AMI</h1><div class="post__text post__text-html js-mediator-article">  Hello. <br><br>  I want to share a script for $ subj.  Perhaps someone will be useful. <br><br>  Task setting: there are a number of EC2 servers in AWS scattered across different regions.  It is required to automate their backups so that recovery is easy and fast. <br><a name="habracut"></a><br>  Actually, the script itself: <a href="">ec2-automate-backup2ami.sh</a> <br>  Description: <a href="">README.md</a> <br>  Script wrapper for <a href="">cron</a> launch: <a href="">ec2-backup-wrapper.sh</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For the script to work, you must first: <br><ul><li>  Install the <a href="http://aws.amazon.com/developertools/351">ec2-api-tools</a> package (I have version 1.6.7.3) </li><li>  Edit the wrapper script, specifying the path to ec2-automate-backup2ami.sh and to the log file </li><li>  Create a separate user in AWS IAM for backups and assign him a similar policy: <br><pre><code class="markdown hljs">{ "Version": "2012-10-17", "Statement": [ { "Sid": "Stmt1389911824000", "Effect": "Allow", "Action": [ "ec2:CreateImage", "ec2:CreateSnapshot", "ec2:CreateTags", "ec2:DeleteSnapshot", "ec2:DeregisterImage", "ec2:DescribeRegions", "ec2:DescribeSnapshotAttribute", "ec2:ModifySnapshotAttribute", "ec2:DescribeImages", "ec2:DescribeInstances", "ec2:DescribeSnapshots", "ec2:DescribeTags", "ec2:DescribeVolumeAttribute", "ec2:DescribeVolumeStatus", "ec2:DescribeVolumes" ], "Resource": [ "*" ] } ] }</code> </pre> <br></li><li>  Create a file with access parameters for the created user: <br><pre> <code class="markdown hljs">[ec2-user@zenoss ~]$ cat .stage export AWS<span class="hljs-emphasis"><span class="hljs-emphasis">_ACCESS_</span></span>KEY=access<span class="hljs-emphasis"><span class="hljs-emphasis">_key export AWS_</span></span>SECRET<span class="hljs-emphasis"><span class="hljs-emphasis">_KEY=secret_</span></span>key export AWS<span class="hljs-emphasis"><span class="hljs-emphasis">_ACCESS_</span></span>KEY<span class="hljs-emphasis"><span class="hljs-emphasis">_ID=access_</span></span>key export AWS<span class="hljs-emphasis"><span class="hljs-emphasis">_SECRET_</span></span>ACCESS<span class="hljs-emphasis"><span class="hljs-emphasis">_KEY=secret_</span></span>key</code> </pre></li><li>  Specify EC2_HOME </li><li>  Mark each instance that requires backup with a <b>Backup</b> tag with a value of <b>true</b> </li></ul><br>  The Krontab looks something like this: <br><pre> <code class="markdown hljs">[ec2-user@backup ~]$ crontab -l PATH=$PATH:/usr/kerberos/bin:/usr/local/bin:/bin:/usr/bin EC2_HOME=/usr/local SHELL=/bin/bash 00 2 <span class="hljs-bullet"><span class="hljs-bullet">* *</span></span> * ./ec2-backup-wrapper.sh stage "alerts1@mydomain.cc alerts2@mydomain.cc"</code> </pre><br><br>  The result of the script is written to the log file type ec2-automate-backup2ami.stage.log.  In case of a runtime error, it will be sent to the specified email addresses. <br><br>  It is worth paying attention that the file with parameters is called <b>.</b>  stage, and the script is called with a name without a dot. <br><br>  After successful execution, an image with the name ec2ab_server.domain.cc_YYYY-MM-DD will appear in AWS AMI with the following tags: <br><ul><li>  <b>Name</b> - EC2 instance name </li><li>  <b>InitiatingHost</b> - FQDN backup server </li><li>  <b>PurgeAfterFE</b> - date of image removal in unix time format </li><li>  <b>PurgeAfter</b> - the date of image removal in the format YYYY-MM-DD (only for the convenience of the administrator, the script uses PurgeAfterFE) </li><li>  <b>PurgeAllow</b> - allows automatic deletion of the image (true by default) </li><li>  <b>Instance</b> - EC2 <b>Instance</b> ID </li><li>  <b>Created</b> - the date the image was created in the format YYYY-MM-DD </li></ul><br><br>  PS The script is based on <a href="https://github.com/colinbjohnson/aws-missing-tools/tree/master/ec2-automate-backup">ec2-automate-backup</a> (backup EBS-disks, without iteration by region) from <a href="https://github.com/colinbjohnson">colinbjohnson</a> , for which many thanks to him! <br><br>  PPS Perhaps, the script will work incorrectly under Mac OS / X (see the fourth line in the get_purge_after_date () function), but I have no opportunity to check it. <br><br>  PPPS Before creating snapshots, the script does not flush the file system buffers, so the backup may be inconsistent.  To create consistent snapshots, use <a href="https://github.com/alestic/ec2-consistent-snapshot">ec2-consistent-snapshot.</a> <br><br>  UPD Added the ability to automatically copy the images created in the process of backup AMI to other regions.  To enable this option, you must specify the <b>-y</b> option in the script launch command line, and add the corresponding tag to the instance settings.  The region is selected before creating backups at random from all possible ones or from the list specified on the command line with the <b>-o</b> key (space separator).  In other words, all copies will fall into one region within one script run. <br>  For example: <br><pre> <code class="markdown hljs">/usr/local/bin/ec2-automate-backup2ami.sh -s tag -t "Backup=true" -k 14d -p -h -u -n -y "CopyRegion=true" -o "us-west-1 eu-west-1"</code> </pre><br>  In the given example script: <br><ul><li>  zabekapit all instances that have a Backup tag with a value of true (-s, -t) </li><li>  will remove backups created more than 13 days ago (-k, -p) </li><li>  will add to the backup various informational tags (-h, -u, -n) </li><li>  will copy all backups into one of the two of the two listed at the start of the script (-y, -o) </li></ul><br>  The list of region names can be obtained using the <b>ec2-describe-regions</b> command. <br><br>  After copying, a <b>CopyRegion</b> tag will be added to the original AMI with a value corresponding to the region where it was copied.  And to the copied AMI - <b>SourceRegion</b> tag, defining the source region. </div><p>Source: <a href="https://habr.com/ru/post/256515/">https://habr.com/ru/post/256515/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256501/index.html">Apple Watch: how to make an application under the clock and not screw it up</a></li>
<li><a href="../256503/index.html">Write under that, I don‚Äôt know what: development features for Apple Watch using Mail.Ru Mail as an example</a></li>
<li><a href="../256505/index.html">Webix. The first acquaintance with the JavaScript framework</a></li>
<li><a href="../256509/index.html">Subject-event approach to modeling complex systems</a></li>
<li><a href="../256513/index.html">The challenge of a hundred boxes and the rescue of prisoners - the final chord</a></li>
<li><a href="../256517/index.html">Separate interfaces for unit testing</a></li>
<li><a href="../256521/index.html">Scientifically looking for errors in the cloud: an unexpected CEO adventure</a></li>
<li><a href="../256523/index.html">Sprockets 3 encoding problem when working with HTML files</a></li>
<li><a href="../256525/index.html">Checking the Haiku operating system (BeOS family) with PVS-Studio. Part 2</a></li>
<li><a href="../256527/index.html">Prototype this Or useful functionality faster than a cup of coffee</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>