<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Jii: Active Record for Node.js with API from Yii 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Hello to all habrovchanam, fans of Yii and Node.js. 
 This is the second article about the Jii framework ( GitHub ), in a previous arti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Jii: Active Record for Node.js with API from Yii 2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/b9c/e1d/925/b9ce1d9253aa4d0595a6aedb0157380f.png" alt="Jii" align="right"><h1>  Introduction </h1><br>  Hello to all habrovchanam, fans of Yii and Node.js. <br>  This is the second article about the <a href="http://www.jiiframework.ru/">Jii</a> framework ( <a href="https://github.com/jiisoft">GitHub</a> ), in a <a href="http://habrahabr.ru/post/260295/">previous article</a> we looked at Data Access Objects and Query Builder. <br>  As promised, in this article I will talk about using Active Record. <br><br><h1>  Active record </h1><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a0c/e49/a69/a0ce49a699f74a138d2989ec37d5295e.jpg"></div><a name="habracut"></a>  <a href="http://en.wikipedia.org/wiki/Active_record_pattern">Active Record</a> provides an object-oriented interface for accessing and manipulating data stored in databases.  The Active Record class is associated with a database table, an instance of the class corresponds to a row of this table, and the attributes represent the values ‚Äã‚Äãof a specific column in that row.  Instead of writing SQL queries explicitly, you have access to Active Record attributes and methods that manipulate data. <br><br>  Suppose we have the Active Record class  ªapp.models.Customer`, which is associated with the `customer` table and` name` is the name of the column in the `customer` table.  You can write the following code to add a new row to the `customer` table: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> customer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> app.models.Customer(); customer.name = <span class="hljs-string"><span class="hljs-string">'Vladimir'</span></span>; customer.save();</code> </pre> <br>  This is equivalent to the following code, in which you can make more mistakes when writing and where there may be incompatibilities with different types of data: <br><br><pre> <code class="javascript hljs">db.createCommand(<span class="hljs-string"><span class="hljs-string">'INSERT INTO `customer` (`name`) VALUES (:name)'</span></span>, { <span class="hljs-string"><span class="hljs-string">':name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Vladimir'</span></span>, }).execute();</code> </pre><br><h2>  Active Record Class Declaration </h2><br>  First, declare the class Active Record, inheriting <i>Jii.sql.ActiveRecord</i> .  Each Active Record class is associated with a database table, so in this class you must override the static <i>Jii.sql.ActiveRecord.tableName ()</i> method to specify which table the class is associated with. <br><br>  In the following example, we declare a class named  ªapp.models.Customer` for the `customer` table. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Jii = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'jii'</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** * @class app.models.Customer * @extends Jii.sql.ActiveRecord */</span></span> Jii.defineClass(<span class="hljs-string"><span class="hljs-string">'app.models.Customer'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/** @lends app.models.Customer.prototype */</span></span>{ <span class="hljs-attr"><span class="hljs-attr">__extends</span></span>: Jii.sql.ActiveRecord, <span class="hljs-attr"><span class="hljs-attr">__static</span></span>: <span class="hljs-comment"><span class="hljs-comment">/** @lends app.models.Customer */</span></span>{ <span class="hljs-attr"><span class="hljs-attr">tableName</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'customer'</span></span>; } } });</code> </pre><br>  The Active Record class is a model, so usually we put the Active Record classes in the `models` namespace. <br><br>  The <i>Jii.sql.ActiveRecord</i> class inherits <i>Jii.base.Model</i> , which means that it inherits * all * model capabilities, such as attributes, validation rules, data serialization, etc. <br><br><h2>  Creating a database connection </h2><br>  By default, Active Record uses <a href="http://www.jiiframework.ru/guide/structure-application-components">the application component</a> `db`, which contains an instance of <i>Jii.sql.BaseConnection</i> to read and modify data in the database.  As described in the previous <a href="http://habrahabr.ru/post/260295/">article</a> , in the ‚ÄúDatabase Access Objects‚Äù section, you can configure the application component `db` as follows: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">components</span></span>: { <span class="hljs-attr"><span class="hljs-attr">db</span></span>: { <span class="hljs-attr"><span class="hljs-attr">className</span></span>: <span class="hljs-string"><span class="hljs-string">'Jii.sql.mysql.Connection'</span></span>, <span class="hljs-attr"><span class="hljs-attr">host</span></span>: <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">database</span></span>: <span class="hljs-string"><span class="hljs-string">'testdb'</span></span>, <span class="hljs-attr"><span class="hljs-attr">username</span></span>: <span class="hljs-string"><span class="hljs-string">'demo'</span></span>, <span class="hljs-attr"><span class="hljs-attr">password</span></span>: <span class="hljs-string"><span class="hljs-string">'demo'</span></span>, <span class="hljs-attr"><span class="hljs-attr">charset</span></span>: <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>, } } };</code> </pre><br>  If you want to use another connection to the database, you must override the <i>Jii.sql.ActiveRecord.getDb ()</i> method: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @class app.models.Customer * @extends Jii.sql.ActiveRecord */</span></span> Jii.defineClass(<span class="hljs-string"><span class="hljs-string">'app.models.Customer'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/** @lends app.models.Customer.prototype */</span></span>{ <span class="hljs-attr"><span class="hljs-attr">__extends</span></span>: Jii.sql.ActiveRecord, <span class="hljs-attr"><span class="hljs-attr">__static</span></span>: <span class="hljs-comment"><span class="hljs-comment">/** @lends app.models.Customer */</span></span>{ <span class="hljs-attr"><span class="hljs-attr">STATUS_INACTIVE</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">STATUS_ACTIVE</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-comment"><span class="hljs-comment">// ... getDb: function() { // use the "db2" application component return Jii.app.db2; } } });</span></span></code> </pre><br><h2>  Data retrieval </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/files/4bc/cec/931/4bccec931e5049a69f67722b60df98fd.jpg"></div><br>  After declaring the class Active Record, you can use it to query data from the corresponding database table. <br>  To do this, you must perform three steps: <br><br>  1. Create a new request object by calling the <i>Jii.sql.ActiveRecord.find ()</i> method; <br>  2. Generate the request object by calling the query creation methods; <br>  3. Call one of the query methods to retrieve data in the form of Active Record records. <br><br>  These actions are very similar to actions when working with the query designer.  The only difference is that to create a query object, you must call the <i>Jii.sql.ActiveRecord.find ()</i> method, and not create an instance using `new`. <br><br>  Consider a few examples showing how to use Active Query to get data: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    ID 123 // SELECT * FROM `customer` WHERE `id` = 123 app.models.Customer.find() .where({id: 123}) .one() .then(function(customer) { // ... }); //    ,   ID // SELECT * FROM `customer` WHERE `status` = 1 ORDER BY `id` app.models.Customer.find() .where({status: app.models.Customer.STATUS_ACTIVE}) .orderBy('id') .all() .then(function(customers) { // ... }); //     // SELECT COUNT(*) FROM `customer` WHERE `status` = 1 app.models.Customer.find() .where({status': app.models.Customer.STATUS_ACTIVE}) .count() .then(function(count) { // ... }); //      ,    ID  // SELECT * FROM `customer` app.models.Customer.find() .indexBy('id') .all() .then(function(customers) { // ... });</span></span></code> </pre><br>  To simplify obtaining models by ID methods are created: <br><ul><li>  <i>Jii.sql.ActiveRecord.findOne ()</i> : Returns the Active Record instance corresponding to the first line of the result of the query. </li><li>  <i>Jii.sql.ActiveRecord.findAll ()</i> : Returns an array or object of several Active Record corresponding to the rows of the query result. </li></ul><br>  Both methods take the first argument in the following format: <br><ul><li>  Scalar value: A value is treated as the value of the primary key that is being searched.  The primary key is determined automatically from the database schema. </li><li>  Array of scalar values: an array is considered as the primary key values ‚Äã‚Äãthat are searched.  - An object whose keys are the names of the columns, and the values ‚Äã‚Äãcorrespond to the values ‚Äã‚Äãof the columns being searched. </li></ul><br>  The following examples show how these methods can be used: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    ID 123 // SELECT * FROM `customer` WHERE `id` = 123 app.models.Customer .findOne(123) .then(function(customer) { // ... }); //   ID 100, 101, 123  124 // SELECT * FROM `customer` WHERE `id` IN (100, 101, 123, 124) app.models.Customer .findAll([100, 101, 123, 124]) .then(function(customers) { // ... }); //     ID 123 // SELECT * FROM `customer` WHERE `id` = 123 AND `status` = 1 app.models.Customer .findOne({ id: 123, status: app.models.Customer.STATUS_ACTIVE }) .then(function(customer) { // ... }); //     // SELECT * FROM `customer` WHERE `status` = 0 app.models.Customer .findAll({ status: app.models.Customer.STATUS_INACTIVE }) .then(function(customers) { // ... });</span></span></code> </pre><br><blockquote>  Note: Neither <i>Jii.sql.ActiveRecord.findOne ()</i> nor <i>Jii.sql.ActiveQuery.one ()</i> will add `LIMIT 1` to the SQL expression.  If your query can really return a lot of data, then you need to call `limit (1)` to set the limit, for example,  ªapp.models.Customer.find (). Limit (1) .one () `. </blockquote><br>  You can also use regular SQL queries to retrieve data and fill it in Active Record.  To do this, use the <i>Jii.sql.ActiveRecord.findBySql ()</i> method: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//     var sql = 'SELECT * FROM customer WHERE status=:status'; app.models.Customer .findBySql(sql, {':status': app.models.Customer.STATUS_INACTIVE}) .all() .then(function(customers) { // ... });</span></span></code> </pre><br>  Do not call the query creation methods after calling <i>Jii.sql.ActiveRecord.findBySql ()</i> , they will be ignored. <br><br><h2>  Data access </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/files/9e6/9e5/414/9e69e5414a394661816c4a84e02e194d.jpg"></div><br>  As mentioned above, Active Record instances are populated with data from the SQL query results, and each row of the query result corresponds to one Active Record instance.  You can access column values ‚Äã‚Äãthrough Active Record attributes, for example, <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   "id"  "email"   "customer" app.models.Customer .findOne(123) .then(function(customer) { var id = customer.get('id'); var email = customer.get('email'); });</span></span></code> </pre><br><h3>  Getting data in objects </h3><br>  Retrieving data as an Active Record is convenient, but sometimes it may be sub-optimal due to the large memory consumption that is spent on creating Active Record instances.  In this case, you can get them as ordinary objects. To do this, call the <i>Jii.sql.ActiveQuery.asArray ()</i> method. <br><blockquote>  In fact, in JavaScript you get an array filled with objects.  Therefore, it would be more correct to call the method <i>asObject ()</i> , and there is such a method (synonym).  But to save the API Yii 2, the <i>asArray ()</i> method was left. </blockquote><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   ,    //    app.models.Customer.find() .asArray() // alias is asObject() .all() .then(function(customers) { // ... });</span></span></code> </pre><br><h2>  Saving data </h2><br>  Using Active Record, you can save data to the database by performing the following steps: <br><ol><li>  Receive or create an instance of Active Record; </li><li>  Set new value to attributes </li><li>  Call the <i>Jii.sql.ActiveRecord.save ()</i> method to save the data. </li></ol><br>  For example, <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//      var customer = new app.models.Customer(); customer.set('name', 'James'); customer.set('email', 'james@example.com'); customer.save().then(function(success) { return app.models.Customer.findOne(123); }).then(function(customer) { //   customer.set('email', 'james@newexample.com'); return customer.save(); }).then(function(success) { // ... });</span></span></code> </pre><br>  The <i>Jii.sql.ActiveRecord.save ()</i> method can either add or update data lines, depending on the state of Active Record.  If an instance was created using the `new` operator, the method will add a new string.  If an instance was obtained via the <i>find ()</i> method and similar to it, or the <i>save ()</i> method was previously called, then the <i>save ()</i> method <br>  will update the data. <br><br><h3>  Data validation </h3><br>  The <i>Jii.sql.ActiveRecord</i> class <i>is</i> inherited from <i>Jii.base.Model</i> , so data validation is available in it.  You can set the rules for the implementation by overriding the <i>Jii.sql.ActiveRecord.rules ()</i> method and check for correct values ‚Äã‚Äãusing the <i>Jii.sql.ActiveRecord.validate ()</i> method. <br><br>  When you call the <i>Jii.sql.ActiveRecord.save ()</i> method, by default, the <i>Jii.sql.ActiveRecord.validate ()</i> method will be automatically called.  Only validated data should be stored in the database;  If the data is not correct, the method will return `false` and you may get an error through the <i>Jii.sql.ActiveRecord.getErrors ()</i> method or the like. <br><br><h3>  Change attribute set </h3><br>  Like regular models, an Active Record instance also supports changing attributes through object transfer.  Using this method, you can assign the values ‚Äã‚Äãof several Active Record attributes by calling a single method.  Remember that only safe attributes can be massively assigned. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> values = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'James'</span></span>, <span class="hljs-attr"><span class="hljs-attr">email</span></span>: <span class="hljs-string"><span class="hljs-string">'james@example.com'</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> customer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> app.models.Customer(); customer.setAttributes(values); customer.save();</code> </pre><br><h3>  Changed Attributes </h3><br>  When you call the <i>Jii.sql.ActiveRecord.save ()</i> method, only the changed Active Record attributes are saved.  An attribute is considered changed if its value has been changed.  Note that data validation will be performed regardless of the existence of modified attributes. <br><br>  Active Record automatically saves the list of changed attributes.  It saves old versions of attributes and compares them with the latest version.  You can get changed attributes through the <i>Jii.sql.ActiveRecord.getDirtyAttributes ()</i> method. <br><br>  To get old attribute values, call <i>Jii.sql.ActiveRecord.getOldAttributes ()</i> or <i>Jii.sql.ActiveRecord.getOldAttribute ()</i> . <br><br><h3>  Default values </h3><br>  Some of your columns in the table may have default values ‚Äã‚Äãdefined in the database.  You can pre-populate Active Record with these values ‚Äã‚Äãby calling the <i>Jii.sql.ActiveRecord.loadDefaultValues ‚Äã‚Äã()</i> method.  This method is synchronous, because  The database schema is preloaded when the connection is opened. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> customer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> app.models.Customer(); customer.loadDefaultValues(); <span class="hljs-comment"><span class="hljs-comment">// customer.get('xyz')   `xyz`    -   `xyz`.</span></span></code> </pre><br><h3>  Update multiple lines </h3><br>  The methods described above work with Active Record instances.  To update several lines at the same time, you can call the static method <i>Jii.sql.ActiveRecord.updateAll ()</i> : <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// UPDATE `customer` SET `status` = 1 WHERE `email` LIKE `%@example.com%` app.models.Customer.updateAll({status: app.models.Customer.STATUS_ACTIVE}, {'like', 'email', '@example.com'});</span></span></code> </pre><br><h2>  Data deletion </h2><br>  To remove a row from a table, it is necessary to call the <i>Jii.sql.ActiveRecord.delete ()</i> method from the Active Record corresponding to this row. <br><br><pre> <code class="javascript hljs">app.models.Customer .findOne(<span class="hljs-number"><span class="hljs-number">123</span></span>) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer</span></span></span><span class="hljs-function">) </span></span>{ customer.delete(); });</code> </pre><br>  You can call the static <i>Jii.sql.ActiveRecord.deleteAll ()</i> method to remove multiple rows by condition. <br>  For example, <br><br><pre> <code class="javascript hljs">app.models.Customer.deleteAll({<span class="hljs-attr"><span class="hljs-attr">status</span></span>: app.models.Customer.STATUS_INACTIVE});</code> </pre><br><h2>  Work with related data </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ddb/2db/383/ddb2db383aa74be985d057f79ca9c25b.jpg"></div><br>  In addition to working with individual database tables, Active Record is able to link data through raw data.  For example, customer data may be associated with orders.  When declaring a corresponding connection in Active Record, you can get information about the customer‚Äôs order using the expression `customer.load ('orders')`, and you will receive an array of instances of `app.models.Order` at the output. <br><br><h3>  Addiction </h3><br>  To work with relational data using Active Record, you first need to declare the relationship in the Active Record class.  For example, <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @class app.models.Customer * @extends Jii.sql.ActiveRecord */</span></span> Jii.defineClass(<span class="hljs-string"><span class="hljs-string">'app.models.Customer'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/** @lends app.models.Customer.prototype */</span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... getOrders: function() { return this.hasMany(app.models.Order.className(), {customer_id: 'id'}); } }); /** * @class app.models.Order * @extends Jii.sql.ActiveRecord */ Jii.defineClass('app.models.Order', /** @lends app.models.Order.prototype */{ // ... getCustomer: function() { return this.hasOne(app.models.Customer.className(), {id: 'customer_id'}); } });</span></span></code> </pre><br>  In the above code, we declared the  ªorders` ratio for the `app.models.Customer` class, and the` customer` relation for the `app.models.Order` class. <br><br>  Each relational method should be named `getXyz` (get + the name of the relationship with the first letter in lower case).  Please note that relationship names are * case sensitive *. <br><br>  In regards, you must provide the following information: <br><br><ul><li>  The multiplicity of the connection: specified when calling the <i>Jii.sql.ActiveRecord.hasMany ()</i> or <i>Jii.sql.ActiveRecord.hasOne ()</i> methods.  In the example above, the customer has many orders, and the order has only one customer. </li><li>  The name of the associated class Active Record: is specified as the first parameter of the above methods.  It is recommended to get the class name through `Xyz.className ()`, firstly, to check the existence of the class at the stage of constructing the relationship, and secondly, for the IDE to tell you the name of the class when writing. </li><li>  Relationship between two table schemas: defines the column (s) through which the two types of data are connected.  The object values ‚Äã‚Äãare the primary data columns, and the keys are the related data columns. </li></ul><br><h3>  Access to related data </h3><br>  After declaring a relationship, you can access related data through the name of the relationship.  If you are sure that the associated data is already loaded into Active Record, then you can get the associated Active Record in the same way as accessing the <a href="http://www.jiiframework.ru/guide/concept-properties">properties of an</a> object through the <i>get ()</i> method.  Otherwise, it is better to use the <i>Jii.sql.ActiveRecord.load ()</i> method to load the associated data, which will always return the `Promise` object, but will not send an extra query to the database if the link has already been loaded before. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// SELECT * FROM `customer` WHERE `id` = 123 app.models.Customer .findOne(123) .then(function(customer) { // SELECT * FROM `order` WHERE `customer_id` = 123 return customer.load('orders'); }) .then(function(orders) { // orders -    `app.models.Order` });</span></span></code> </pre><br>  If the relationship is declared by the <i>Jii.sql.ActiveRecord.hasMany ()</i> method, then the relationship will be represented by an array of Active Record instances (or an empty array).  If using <i>Jii.sql.ActiveRecord.hasOne ()</i> , then the relationship data will be represented by an instance of Active Record or `null` if there is no data. <br><br>  When accessing a relation for the first time, a SQL query will be executed in the database, as shown in the example above.  When re-accessing, the request will not be executed. <br><br><h3>  Relationships through an additional table (Junction Table) </h3><br>  When modeling databases, when the connection is between two Many-Many tables, an additional table is usually added - the <a href="https://en.wikipedia.org/wiki/Junction_table">Junction Table</a> .  For example, the `order` table and the` item` table can be linked using the `order_item` table. <br><br>  When declaring such relationships, you need to call the <i>Jii.sql.ActiveQuery.via ()</i> or <i>Jii.sql.ActiveQuery.viaTable ()</i> methods with the indication of the additional table.  The difference between these methods is that the first one indicates the transition table from the point of view of the current name of the relation, while the last one directly indicates the additional table.  For example, <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @class app.models.Order * @extends Jii.sql.ActiveRecord */</span></span> Jii.defineClass(<span class="hljs-string"><span class="hljs-string">'app.models.Order'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/** @lends app.models.Order.prototype */</span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... getItems: function() { return this.hasMany(app.models.Item.className(), {id: 'item_id'}) .viaTable('order_item', {order_id: 'id'}); } });</span></span></code> </pre><br>  or alternatively <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @class app.models.Order * @extends Jii.sql.ActiveRecord */</span></span> Jii.defineClass(<span class="hljs-string"><span class="hljs-string">'app.models.Order'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/** @lends app.models.Order.prototype */</span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... getOrderItems: function() { return this.hasMany(app.models.OrderItem.className(), {order_id: 'id'}); }, getItems: function() { return this.hasMany(app.models.Item.className(), {id: 'item_id'}) .via('orderItems'); } });</span></span></code> </pre><br>  Using relationships declared with an additional table is similar to regular relationships.  For example, <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// SELECT * FROM `order` WHERE `id` = 100 app.models.Order .findOne(100) .then(function(order) { // SELECT * FROM `order_item` WHERE `order_id` = 100 // SELECT * FROM `item` WHERE `item_id` IN (...) return order.load('items'); }) .then(function(items) { // items -   `app.models.Item` });</span></span></code> </pre><br><h3>  Lazy Loading and greedy loading </h3><br>  In the section for accessing related data, we told you that you can access a relation from Active Record via <i>get ()</i> or <i>load ()</i> methods.  The SQL query will be sent to the database only the first time it accesses the related data.  Such data loading methods are called lazy loading. <br>  For example, <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// SELECT * FROM `customer` WHERE `id` = 123 app.models.Customer .findOne(123) .then(function(customer) { // SELECT * FROM `order` WHERE `customer_id` = 123 customer.load('orders').then(function(orders) { // SQL    return customer.load('orders'); }).then(function(orders2) { //   ,      &lt;i&gt;get()&lt;/i&gt;. var orders3 = customer.get('orders'); }); });</span></span></code> </pre><br>  Lazy load is very convenient to use.  However, this can cause performance problems when you need to access related tied to multiple instances of Active Record.  Consider the following code sample, how many SQL queries will be executed? <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// SELECT * FROM `customer` LIMIT 100 app.models.Customer.find() .limit(100) .all() .then(function(customers) { return Promise.all(customers.map(function(customer) { // SELECT * FROM `order` WHERE `customer_id` = ... return customer.load('orders'); })); }).then(function(result) { var firstOrder = result[0][0]; // ... });</span></span></code> </pre><br>  In this example, 101 SQL queries will be executed!  Because for each client applications will be received through a separate request.  To solve this performance problem, you can use the eager loading * approach *, as shown below, <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// SELECT * FROM `customer` LIMIT 100; // SELECT * FROM `orders` WHERE `customer_id` IN (...) app.models.Customer.find() .with('orders') .limit(100) .all() .then(function(customers) { customers.forEach(function(customer) { //  SQL  var orders = customer.get('orders'); }); });</span></span></code> </pre><br>  You can load one or more relationships along with the main entry.  You can even load nested relationships immediately.  For example, if  ªapp.models.Customer` is associated with  ªapp.models.Order` through the `orders` relationship, and` app.models.Order` is associated with `Item` through` items`.  When you query  ªapp.models.Customer`, you can immediately load the `items` relationship by specifying` orders.items` in the <i>with ()</i> method. <br><br>  The following code shows the different usage of <i>Jii.sql.ActiveQuery.with ()</i> .  We assume that the class `app.models.Customer` has two relationships:` orders` and `country`, while the class` app.models.Order` has one relationship - `items`. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    "orders"  "country" app.models.Customer.find() .with('orders', 'country') .all() .then(function(customers) { // ... }); //      app.models.Customer.find() .with(['orders', 'country']) .all() .then(function(customers) { //  SQL  var orders = customers[0].get('orders'); var country = customers[0].get('country'); }); //    "orders"    "orders.items" app.models.Customer.find() .with('orders.items') .all() .then(function(customers) { //         //  SQL  var items = customers[0].get('orders')[0].get('items'); });</span></span></code> </pre><br>  You can load forced deeply nested relationships, such as `abcd`.  All parent relationships will be forcibly loaded. <br><br>  With greedy relations loading, you can configure the corresponding request by passing an anonymous function.  For example, <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//          // SELECT * FROM `customer` // SELECT * FROM `country` WHERE `id` IN (...) // SELECT * FROM `order` WHERE `customer_id` IN (...) AND `status` = 1 app.models.Customer.find() .with({ country: 'country', orders: function (query) { query.andWhere({'status': app.models.Order.STATUS_ACTIVE}); } }) .all() .then(function(customers) { // ... });</span></span></code> </pre><br>  When setting up a relational query for a link, you must specify the name of the relationship as the key of the object and use the anonymous function as the value of the corresponding object.  The first argument of the nonym function is the `query` parameter, which is a <i>Jii.sql.ActiveQuery</i> object.  In the example above, we modify the request by adding an additional condition on the status of the order. <br><br><h3>  Inverse relationship </h3><br>  Relationships between Active Record classes are often inversely related.  For example, the class `app.models.Customer` is associated with` app.models.Order` through the relationship `orders`, and the class` app.models.Order` is inversely associated with the class  ªapp.models.Customer` through the relationship `customer` . <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @class app.models.Customer * @extends Jii.sql.ActiveRecord */</span></span> Jii.defineClass(<span class="hljs-string"><span class="hljs-string">'app.models.Customer'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/** @lends app.models.Customer.prototype */</span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... getOrders: function() { return this.hasMany(app.models.Order.className(), {customer_id: 'id'}); } }); /** * @class app.models.Order * @extends Jii.sql.ActiveRecord */ Jii.defineClass('app.models.Order', /** @lends app.models.Order.prototype */{ // ... getCustomer: function() { return this.hasOne(app.models.Customer.className(), {id: 'customer_id'}); } });</span></span></code> </pre><br>  Now consider the following code snippet: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// SELECT * FROM `customer` WHERE `id` = 123 app.models.Customer .findOne(123) .then(function(customer) { // SELECT * FROM `order` WHERE `customer_id` = 123 return customer.load('orders'); }).then(function(orders) { var order = orders[0]; // SELECT * FROM `customer` WHERE `id` = 123 return order.load('customer'); }).then(function(customer2) { //  "not the same" console.log(customer2 === customer ? 'same' : 'not the same'); });</span></span></code> </pre><br>  We assume that the objects `customer` and` customer2` are the same, but actually this is not the case.        .    `order.customer`   SQL      `customer2`. <br><br>      SQL     ,   ,  `customer`  * *  `orders`    <i>Jii.sql.ActiveQuery.inverseOf()</i> . <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @class app.models.Customer * @extends Jii.sql.ActiveRecord */</span></span> Jii.defineClass(<span class="hljs-string"><span class="hljs-string">'app.models.Customer'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/** @lends app.models.Customer.prototype */</span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... getOrders: function() { return this.hasMany(app.models.Order.className(), {customer_id: 'id'}).inverseOf('customer'); } });</span></span></code> </pre><br>     : <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// SELECT * FROM `customer` WHERE `id` = 123 app.models.Customer .findOne(123) .then(function(customer) { // SELECT * FROM `order` WHERE `customer_id` = 123 return customer.load('orders'); }).then(function(orders) { var order = orders[0]; // SELECT * FROM `customer` WHERE `id` = 123 return order.load('customer'); }).then(function(customer2) { //  "same" console.log(customer2 === customer ? 'same' : 'not the same'); });</span></span></code> </pre><br><blockquote> :       Many-Many,     (Junction Table). </blockquote><br><h2>   </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/files/3b0/6a6/86d/3b06a686d9e74310a984a6308b3df021.jpg"></div><br>     ,           .        ,   .   Active Record      : <br><br><pre> <code class="javascript hljs">app.models.Customer .findOne(<span class="hljs-number"><span class="hljs-number">123</span></span>) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> order = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> app.models.Order(); order.subtotal = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ... //  ,   "customer"  `app.models.Order`  . order.customer_id = customer.id; order.save(); });</span></span></code> </pre><br> Active Record   <i>Jii.sql.ActiveRecord.link()</i> ,      : <br><br><pre> <code class="javascript hljs">app.models.Customer .findOne(<span class="hljs-number"><span class="hljs-number">123</span></span>) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> order = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> app.models.Order(); order.subtotal = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ... order.link('customer', customer); });</span></span></code> </pre><br>  <i>Jii.sql.ActiveRecord.link()</i>      Active Record,     .     Active Record     .    ,    `customer_id`  `app.models.Order`. <br><blockquote> :          Active Record. </blockquote><br>     <i>Jii.sql.ActiveRecord.link()</i>   ,       . ,     ,    `app.models.Order`  `app.models.Item`: <br><br><pre> <code class="javascript hljs">order.link(<span class="hljs-string"><span class="hljs-string">'items'</span></span>, item);</code> </pre><br>        `order_item`   . <br><br>       Active Record,   <i>Jii.sql.ActiveRecord.unlink()|unlink()</i> . <br>  For example, <br><br><pre> <code class="javascript hljs">app.models.Customer.find() .with(<span class="hljs-string"><span class="hljs-string">'orders'</span></span>) .all() .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer</span></span></span><span class="hljs-function">) </span></span>{ customer.unlink(<span class="hljs-string"><span class="hljs-string">'orders'</span></span>, customer.get(<span class="hljs-string"><span class="hljs-string">'orders'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>]); });</code> </pre><br>  ,  <i>Jii.sql.ActiveRecord.unlink()</i>    ,  ,  `null`. ,     `isDelete`  `true`,     . <br><br><h1>   </h1><br><div style="text-align:center;"><img src="https://habrastorage.org/files/332/cc1/b11/332cc1b116d9437687454015cd74f7c1.jpg"></div><br><br>     Active Record  Jii   ,        . <br>      <a href="http://habrahabr.ru/post/260295/"> </a> , Jii ‚Äî  ,     ,  -    Jii.   affka@affka.ru. <br><br>   ‚Äî <a href="http://www.jiiframework.ru/">jiiframework.ru</a> <br> GitHub ‚Äî <a href="https://github.com/jiisoft">github.com/jiisoft</a> <br><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><ul><li> <a href="http://habrahabr.ru/post/266929/">Jii:   </a> </li><li>  <a href="http://habrahabr.ru/post/260931/">Jii - a JavaScript framework with architecture from Yii 2</a> </li><li> <a href="http://habrahabr.ru/post/260569/">Jii: Active Record  Node.js  API  Yii 2</a> </li><li> <a href="http://habrahabr.ru/post/260295/">Jii:  Query Builder  Node.js  API  Yii 2</a> </li></ul></div></div></div><p>Source: <a href="https://habr.com/ru/post/260569/">https://habr.com/ru/post/260569/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../260553/index.html">Sending Nginx logs to Google Analytics</a></li>
<li><a href="../260557/index.html">XARA vulnerabilities in OS X and iOS</a></li>
<li><a href="../260559/index.html">AngularJS directive for remembering e-mail</a></li>
<li><a href="../260561/index.html">ECMAScript 2015 official release</a></li>
<li><a href="../260565/index.html">TEETH based on Intel Edison will find a way to motivate you to brush your teeth and send a report to the cloud</a></li>
<li><a href="../260571/index.html">ECMAScript 2015 Specification Approved</a></li>
<li><a href="../260573/index.html">New io.js features that you may not be using</a></li>
<li><a href="../260575/index.html">Comparing the HP 3PAR 10000 with the new high-end HP 3PAR 20000 system</a></li>
<li><a href="../260579/index.html">How to identify a person in a photo using PHP</a></li>
<li><a href="../260581/index.html">What programming languages ‚Äã‚Äãand why are used in finance</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>