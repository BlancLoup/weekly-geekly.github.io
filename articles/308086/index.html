<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Individual daily limit for outgoing calls (limitation of paid directions)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I want to tell how we solved a non-typical task on FreePBX. By the definition of ‚Äúnon-typical,‚Äù I mean that it cannot be solved by sta...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Individual daily limit for outgoing calls (limitation of paid directions)</h1><div class="post__text post__text-html js-mediator-article">  In this article I want to tell how we solved a non-typical task on FreePBX.  By the definition of ‚Äúnon-typical,‚Äù I mean that it cannot be solved by standard means, without additional tools. <br><br><h3>  Prehistory </h3><br>  There is a group of employees, which is engaged in calling customers.  In order to save on outgoing calls, different phone numbers are used for different directions.  This is quietly solved with the help of patterns (masks) of numbers in Outbound Routes.  But part of the directions, for example, calls to mobile, remains paid.  So that at the end of the month the company‚Äôs account for telephone services does not exceed XXX $, it is necessary to strictly control and, if necessary, limit the corresponding directions of calls. <br><br><h3>  Task </h3><br>  Set an individual daily limit for a group of managers.  Bar outgoing calls to certain destinations when the limit is reached.  When the threshold is reached:&gt; 50%,&gt; 90% and&gt; 100%, send the corresponding notification to the employee's email.  If the employee during the day has not fully exhausted his daily limit, the balance should be transferred to the next day. <br><a name="habracut"></a><br><h3>  Getting Started </h3><br>  First you need to determine which numbers we limit dialing.  In our case, these are mobile operators in Kazakhstan.  We find the corresponding article in <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25B5%25D0%25BB%25D0%25B5%25D1%2584%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BF%25D0%25BB%25D0%25B0%25D0%25BD_%25D0%25BD%25D1%2583%25D0%25BC%25D0%25B5%25D1%2580%25D0%25B0%25D1%2586%25D0%25B8%25D0%25B8_%25D0%259A%25D0%25B0%25D0%25B7%25D0%25B0%25D1%2585%25D1%2581%25D1%2582%25D0%25B0%25D0%25BD%25D0%25B0">Wikipedia</a> and try to create templates (masks) of numbers.  Since FreePBX does not have the ability to use full-fledged <a href="http://wiki.freepbx.org/display/FPG/Outbound%2BRoutes%2BModule%2BUser%2BGuide">regular expressions</a> , we managed to package the 23 possible prefixes into 3 templates: <br><ul><li>  870 [5780-2] XXXXXXX </li><li>  877 [15-8] XXXXXXX </li><li>  8747XXXXXXX </li></ul><br>  Create corresponding entries in Outbound Routes.  In this example, we open the directions for the internal number 2055: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/b5d/f99/4fc/b5df994fc65a449b8122fc78468a6c32.png"><br><br>  We do this so that the corresponding rules are created in the configuration file: <pre><code class="bash hljs">/etc/asterisk/extensions_additional.conf</code> </pre> <br>  Since when editing and applying settings in FreePBX, the system overwrites configuration files every time, we find the blocks we need and move to the file: <pre> <code class="bash hljs">/etc/asterisk/extensions_custom.conf</code> </pre>  in which FreePBX does not climb. <br><br>  The block of the following type: <br><br><div class="spoiler">  <b class="spoiler_title">Outbound routes</b> <div class="spoiler_text"><pre> <code class="bash hljs">exten =&gt; _877[15-8]XXXXXXX,1,Macro(user-callerid,LIMIT,EXTERNAL,) exten =&gt; _877[15-8]XXXXXXX/2055,1,Macro(user-callerid,LIMIT,EXTERNAL,) exten =&gt; _877[15-8]XXXXXXX/2055,n,ExecIf($[ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CALLEE_ACCOUNCODE}</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">""</span></span> ] ?Set(CDR(accountcode)=<span class="hljs-variable"><span class="hljs-variable">${CALLEE_ACCOUNCODE}</span></span>)) exten =&gt; _877[15-8]XXXXXXX/2055,n,Set(MOHCLASS=<span class="hljs-variable"><span class="hljs-variable">${IF($["${MOHCLASS}</span></span><span class="hljs-string"><span class="hljs-string">"="</span></span><span class="hljs-string"><span class="hljs-string">"]?default:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${MOHCLASS}</span></span></span><span class="hljs-string">)}) exten =&gt; _877[15-8]XXXXXXX/2055,n,ExecIf($["</span></span><span class="hljs-variable"><span class="hljs-variable">${KEEPCID}</span></span><span class="hljs-string"><span class="hljs-string">"!="</span></span>TRUE<span class="hljs-string"><span class="hljs-string">" &amp; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${LEN(${TRUNKCIDOVERRIDE}</span></span></span><span class="hljs-string">)}=0]?Set(TRUNKCIDOVERRIDE=&lt;7123456789&gt;)) exten =&gt; _877[15-8]XXXXXXX/2055,n,Set(_NODEST=) exten =&gt; _877[15-8]XXXXXXX/2055,n,Gosub(sub-record-check,s,1(out,</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${EXTEN}</span></span></span><span class="hljs-string">,)) exten =&gt; _877[15-8]XXXXXXX/2055,n,Macro(dialout-trunk,10,</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${EXTEN}</span></span></span><span class="hljs-string">,,off) exten =&gt; _877[15-8]XXXXXXX/2055,n,Macro(outisbusy,)</span></span></code> </pre><br></div></div><br>  If you are friends with the Asterisk config file syntax, you can skip the two previous steps and create the blocks you need yourself. <br><br>  Now we can delete the previously created Outbound Routes, we need the enabling rules now contained in extensions_custom.conf.  Thus, we allowed employees to call in these areas.  Further more. <br><br>  Since the limit is individual, and we need to send notifications by mail, it is necessary to store all this information somewhere.  The best choice would be to use the database.  Here we had two options: <br><ul><li>  use the existing asterisk database, and add the fields we need to the users table; </li><li>  create your own database with tables of the desired structure. </li></ul><br>  The choice fell on option number 2, and it turned out about the following: <br><div class="spoiler">  <b class="spoiler_title">SQL Create table</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`users`</span></span> ( <span class="hljs-string"><span class="hljs-string">`user_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`user_name`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_unicode_ci <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">`extension`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">CHARACTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> utf8 <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'000'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span>, <span class="hljs-string"><span class="hljs-string">`mobile_limit_flag`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'    '</span></span>, <span class="hljs-string"><span class="hljs-string">`mobile_limit`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">`base_mobile_limit`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`user_id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> AUTO_INCREMENT=<span class="hljs-number"><span class="hljs-number">33</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8 <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span>=utf8_unicode_ci</code> </pre><br></div></div><br>  Description of the main parameters: <br><ul><li>  <b>base_mobile_limit</b> stores the subscriber's individual limit (in seconds), is set at a time; </li><li>  <b>mobile_limit</b> contains the current limit for the current day, taking into account <b>unused</b> minutes; </li><li>  <b>mobile_limit_flag</b> determines what threshold the user has reached for the limit to be exhausted ( <i>0 - &lt;50%</i> , <i>1 -&gt; 50 and &lt;90%</i> , <i>2 -&gt; 90% and &lt;100%</i> , 3 -&gt; 100%); </li></ul><br>  Let's create Vasya Pupkin, with internal number 2055 already known to us. <br><br><img src="https://habrastorage.org/files/e21/9f1/e00/e219f1e0017f4818983f66426458746e.png"><br><br>  We proceed to the formation of the main system, the logic is as follows: <br><ul><li>  according to the schedule (by krone) the script checks how many each subscriber has spoken in the directions we need; </li><li>  if the subscriber has crossed the threshold of 0.1 or 2, the mobile_limit_flag parameter changes to the corresponding one and a message is sent to the email; </li><li>  if the subscriber is on the verge of 3 (the limit is fully exhausted), the corresponding notification is sent to the email, the corresponding block is commented in the configuration file, dialplan reload is performed. </li></ul><br>  To store the positions of the blocks of the corresponding internal numbers, we create the following XML file: <br><br><div class="spoiler">  <b class="spoiler_title">XML</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bocks</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- BLOCKS START --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">block</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">number</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2055"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">element</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">first</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"4"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">last</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"11"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">element</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">first</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"117"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">last</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"124"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">element</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">first</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"230"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">last</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"237"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">block</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">block</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">number</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2066"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">element</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">first</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"14"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">last</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"21"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">element</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">first</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"127"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">last</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"134"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">element</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">first</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"240"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">last</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"247"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">block</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">block</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">number</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2077"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">element</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">first</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"24"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">last</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"31"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">element</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">first</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"137"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">last</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"144"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">element</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">first</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"250"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">last</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"257"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">block</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bocks</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  Since we have created three masks for accessing mobile numbers, there will be three permitting blocks for each extension.  In XML, we specify the line numbers of the beginning and end of each of these blocks.  We comment them with the following code: <br><br><div class="spoiler">  <b class="spoiler_title">Block commenting function</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">commentBlocks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(numb)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> xml.etree.cElementTree <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ET tree = ET.ElementTree(file=<span class="hljs-string"><span class="hljs-string">'conf.xml'</span></span>) root = tree.getroot() f = open(<span class="hljs-string"><span class="hljs-string">r'extensions_custom.conf'</span></span>) lines = f.readlines() f.close() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> elem <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> tree.iterfind(<span class="hljs-string"><span class="hljs-string">'block[@number="'</span></span>+numb+<span class="hljs-string"><span class="hljs-string">'"]/element'</span></span>): lines[int(elem.get(<span class="hljs-string"><span class="hljs-string">'first'</span></span>))<span class="hljs-number"><span class="hljs-number">-2</span></span>] = <span class="hljs-string"><span class="hljs-string">";--\n"</span></span> lines[int(elem.get(<span class="hljs-string"><span class="hljs-string">'last'</span></span>))] = <span class="hljs-string"><span class="hljs-string">"--;\n"</span></span> f = open(<span class="hljs-string"><span class="hljs-string">r'extensions_custom.conf'</span></span>,<span class="hljs-string"><span class="hljs-string">'w'</span></span>) f.writelines(lines) f.close()</code> </pre><br></div></div><br>  And actually the main brains: <br><br><div class="spoiler">  <b class="spoiler_title">Main script</b> <div class="spoiler_text">  Twitches on schedule, for example, every 5 minutes.  Bonus gorgeous SQL query and divine code. <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#  import send_email import flags print ('###########START_MOBILE_LIMIT############') import pymysql mainconn = pymysql.connect(host='10.10.2.1', user='user', passwd='password', db='asteriskcdrdb', charset='utf8') maincur = mainconn.cursor() maincur.execute("""SELECT SUM(billsec) AS sec, src FROM cdr WHERE disposition = 'ANSWERED' AND (dst LIKE '8700%' OR dst LIKE '8701%' OR dst LIKE '8702%' OR dst LIKE '8705%' OR dst LIKE '8707%' OR dst LIKE '8708%' OR dst LIKE '8747%' OR dst LIKE '8771%' OR dst LIKE '8775%' OR dst LIKE '8776%' OR dst LIKE '8777%' OR dst LIKE '8778%') AND DATE(calldate) = DATE(CURDATE()) AND src in (2055,2066,2077) GROUP BY src;""") row = maincur.fetchone() print ('ROW COUNT: ' + str(self.maincur.rowcount)) while row is not None: #row[1] -   #row[0] -     #   flags.UpdateUserCurrentLimit(str(row[1]), str(row[0])) per = row[0] * 100 / flags.checkUserLimit(row[1]) flag = flags.checkFlag(row[1]) #   ,      manager_mail = send_email.getEmail(row[1]) # %   print (row[1] + ' (' + str(round(per,0)) + '%): ' + str(row[0])) #  if per &gt;= 50 and per &lt; 90: message = 'Nomer ' + row[1] + ', limit ischerpan na ' + str(round(per, 0)) + '%' if flag == 0: print ('go email to ' + send_email.getEmail(row[1])) send_email.send_message(manager_mail, message) flags.changeFlag(row[1], 1) flags.insertLog(row[1], per) print (message) elif per &gt; 90 and per &lt; 100: message = 'Nomer ' + row[1] + ', limit ischerpan na ' + str(round(per, 0)) + '%' if flag == 1: print ('go email to ' + send_email.getEmail(row[1])) send_email.send_message(manager_mail, message) flags.changeFlag(row[1], 2) flags.insertLog(row[1], per) print (message) elif per &gt;= 100: message = 'Nomer ' + row[1] + ', limit polnostiu ischerpan' if flag != 3: print ('go email to ' + send_email.getEmail(row[1])) send_email.send_message(manager_mail, message) flags.changeFlag(row[1], 3) flags.insertLog(row[1], per) #     flags.commentBlocks(str(row[1])) import subprocess #     subprocess.call(['./dialplan_reload.sh']) print (message) row = maincur.fetchone() maincur.close() mainconn.close() print ('############END_MOBILE_LIMIT#############')</span></span></code> </pre><br></div></div><br>  At the end of the working day, we add an unused limit: <br><br><div class="spoiler">  <b class="spoiler_title">AddUnusedLimit</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddUnusedLimit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ext)</span></span></span><span class="hljs-function">:</span></span> conn = pymysql.connect(host=<span class="hljs-string"><span class="hljs-string">'10.10.2.2'</span></span>, user=<span class="hljs-string"><span class="hljs-string">'user'</span></span>, passwd=<span class="hljs-string"><span class="hljs-string">'password'</span></span>, db=<span class="hljs-string"><span class="hljs-string">'crm'</span></span>, charset=<span class="hljs-string"><span class="hljs-string">'utf8'</span></span>) cur = conn.cursor() cur.execute (<span class="hljs-string"><span class="hljs-string">""" UPDATE users SET mobile_limit=base_mobile_limit+mobile_limit WHERE extension=%s """</span></span>, (ext)) conn.commit() print(<span class="hljs-string"><span class="hljs-string">'changed'</span></span>, cur.rowcount) cur.close() conn.close()</code> </pre><br></div></div><br>  We <b>reset the mobile_limit_flag</b> to the default value of 0 and unlock all the blocks: <br><br><div class="spoiler">  <b class="spoiler_title">uncommentBlocks</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uncommentBlocks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> xml.etree.cElementTree <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ET tree = ET.ElementTree(file=<span class="hljs-string"><span class="hljs-string">'conf.xml'</span></span>) root = tree.getroot() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> elem <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> tree.iterfind(<span class="hljs-string"><span class="hljs-string">'block/element'</span></span>): first = int(elem.get(<span class="hljs-string"><span class="hljs-string">'first'</span></span>)) last = int(elem.get(<span class="hljs-string"><span class="hljs-string">'last'</span></span>)) lines[first<span class="hljs-number"><span class="hljs-number">-2</span></span>] = <span class="hljs-string"><span class="hljs-string">"\n"</span></span> lines[last] = <span class="hljs-string"><span class="hljs-string">"\n"</span></span> f = open(<span class="hljs-string"><span class="hljs-string">r'/etc/asterisk/extensions_custom.conf'</span></span>) lines = f.readlines() f.close() <span class="hljs-comment"><span class="hljs-comment">############################################ cur.execute (""" UPDATE users SET mobile_limit_flag=%s """, (0))</span></span></code> </pre><br></div></div><br>  To solve possible disputable situations, we write to the log data on the change of the threshold limit: <br><br><div class="spoiler">  <b class="spoiler_title">LOG</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#    def insertLog(ext, per): import pymysql conn = pymysql.connect(host='10.10.2.1', user='user', passwd='password', db='crm', charset='utf8') cur = conn.cursor() cur.execute (""" INSERT INTO mobile_limit (extension, percent) VALUES (%s, %s) """, (ext, per)) conn.commit() print('insert', cur.rowcount) cur.close() conn.close()</span></span></code> </pre><br></div></div><br>  Here is a <s>crooked</s> solution to the problem.  In version 2.0 of the script, we will dynamically form permitting blocks, which will allow more flexible use of the system, with any changes. </div><p>Source: <a href="https://habr.com/ru/post/308086/">https://habr.com/ru/post/308086/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../308074/index.html">Cisco and Fortinet Release Safety Notices after Data Leakage by Equation Group</a></li>
<li><a href="../308076/index.html">Microsoft opened the source code of PowerShell</a></li>
<li><a href="../308080/index.html">Website development based on ASP.NET Core and Platformus CMS</a></li>
<li><a href="../308082/index.html">Analysis of the Quran with AI</a></li>
<li><a href="../308084/index.html">SObjectizer: from simple to complex. Part III</a></li>
<li><a href="../308088/index.html">Safely use Go language in web programming</a></li>
<li><a href="../308090/index.html">About the division of labor and its consequences</a></li>
<li><a href="../308092/index.html">It's time to tell you how I was Beeline for 4 years on Habr√© - and what I learned about Habr during that time</a></li>
<li><a href="../308094/index.html">Training with reinforcements for the smallest</a></li>
<li><a href="../308098/index.html">CsvLogWriter plugin for JMeter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>