<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>When the butler is a victim</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today we move away from the classic clich√© of second-rate detectives and tell you about a case from our practice, when the butler himself acted as a v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>When the butler is a victim</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/getpro/habr/post_images/15d/fa3/2bd/15dfa32bddfbab022ad0a356c1b85fcb.png" alt="Picture 5" align="left"></p>  Today we move away from the classic clich√© of second-rate detectives and tell you about a case from our practice, when the butler himself acted as a victim, and the search for a real criminal led us to an unexpected result.  But do not be afraid.  This, of course, is not about real people, but about programs.  And that we are not afraid to admit our own mistakes: we know that not a single team of developers is insured against them. <br><a name="habracut"></a><br><h2>  Introduction </h2><br>  At the beginning - a little theory.  We are developing <a href="https://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> - static code analyzer for C, C ++ and C #.  For internal testing of our product, we use a variety of tools and techniques: Unit and Visual Studio UI tests, joint code review, specialized application testers.  I will dwell in more detail on the last paragraph. <br><br>  When developing new diagnostic rules, as well as when changing the internal mechanisms of the analyzer, it is always necessary to understand how exactly the changes made affected the quality of the analysis.  To solve this problem, we perform test runs of the analyzer on a set of large open projects.  About 150 projects are used for C / C ++ code, and 52 for C #. The tester for analyzing C / C ++ projects in Windows is called SelfTester.  Next, it will be about this tool.  There is also a specialized system for Linux, but now it will remain behind the scenes. <br><br>  All work is done on the build server with Windows 10. As the build system, we use Jenkins, which is configured to run regularly overnight, including testers.  Running Jenkins itself is done from cmd-file with the command: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cpp hljs">java -jar jenkins.war &gt; %JENKINS_PROJECTS%\Logs\%YYYY%.%MM%.%DD%_%HH%.%MI%.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  The <i>JENKINS_PROJECTS</i> variable sets the location of the Jenkins project folder on the local disk.  The variables <i>YYYY</i> , <i>MM</i> , <i>DD</i> , <i>HH</i> and <i>MI</i> contain, respectively, the date and time at the time of execution.  Thus, after starting Jenkins, the output of its console will be redirected to a file with the name of the form: <br><br><pre> <code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">2017.11</span></span><span class="hljs-number"><span class="hljs-number">.08</span></span>_17<span class="hljs-number"><span class="hljs-number">.58</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span></code> </pre> <br>  Cmd-file starts using the Windows Task Scheduler.  Running Jenkins as a Windows service for us turned out to be inapplicable, since in this case there were problems in the work of Visual Studio UI tests: the service does not have a desktop.  Thus, the run chain looks like this: <br><br><pre> <code class="cpp hljs">Windows Task Manager -&gt; cmd.exe -&gt; java.exe</code> </pre> <br>  So, having read a brief introductory, we turn to the question of what went wrong. <br><br><h2>  Problem </h2><br>  About six months ago, we began to notice that from time to time Jenkins closed during nightly assemblies.  As a result, you had to manually start it, check the logs and restart some tasks.  The problem was reproduced quite regularly.  It was decided to start the investigation with a more careful study of the Jenkins behavior, because it is he who does all the ‚Äúdirty work‚Äù and is the first to fall under suspicion.  Yes, yes, that same butler. <br><br><h2>  Jenkins </h2><br>  First of all, the configuration and settings of Jenkins tasks were checked.  The check revealed nothing serious.  Especially, if an error had been made, for example, in the order, priority, or time of launching tasks, then the problem would probably manifest itself differently.  Yes, and it is unlikely that Jenkins fell due to configuration errors. <br><br>  As a temporary measure, the Windows scheduler task was migrated to periodically launch Jenkins every 30 minutes.  To protect against restarting, a check was made for the presence of an already running process. <br><br>  The next step is to study the Jenkins console logs.  As you probably remember, with us they are saved in the <i>% JENKINS_PROJECTS% \ Logs</i> folder, and the file names contain the creation timestamp (in fact, the Jenkins restart time).  After some time, we examined the contents of this folder and, as expected, we found a fairly large number of files there.  This indicated that Jenkins continues to restart.  In this case, the Jenkins console logs themselves did not contain anything criminal.  And the problem has acquired a slightly different character: some of the night tests have ceased to be performed.  They just did not start.  And those that started, often ended with errors. <br><br>  All this was in favor of the fact that Jenkins himself was probably not at fault.  Someone from the outside impedes his work, "killing" the java.exe process. <br><br><p><img src="https://habrastorage.org/getpro/habr/post_images/80e/9e5/6f7/80e9e56f7a3155f5e89c93dc09a0f481.png" alt="Picture 4"></p><br><h2>  Windows </h2><br>  Windows was chosen as the next suspect.  Well, really, who else but the operating system should be responsible for the unplanned completion of processes.  The system may restart after installing updates, or for some reason it closes only the java.exe process.  This is possible when someone prevents the restart and it is not performed, but the system has already managed to kill some of the processes.  One way or another, but the analysis of the Windows logs gave no results.  Yes, sometimes the system really rebooted, but everything was happening in normal mode.  And the time and place of the "crime" did not coincide. <br><br>  At about the same time as we were conducting our investigation, another incident occurred, which was not immediately given much attention.  One night our assembly server ‚Äúfell‚Äù due to the emergence of BSOD.  An automatic reboot did not happen, so in the morning we could see a very bleak picture. <br><br>  Windows Debugger (WinDbg) was used to analyze the memory dump.  The utility was found along the path "C: \ Program Files (x86) \ Windows Kits \ 10 \ Debuggers \ x64 \ windbg.exe".  The dump was in the standard path "C: \ Windows \ MEMORY.DMP".  After analyzing the dump in WinDbg, the cause and originator of the BSOD was discovered: <br><br><pre> <code class="cpp hljs">CRITICAL_PROCESS_DIED (ef) CRITICAL_PROCESS: svchost.exe .... FAILURE_BUCKET_ID: <span class="hljs-number"><span class="hljs-number">0xEF</span></span>_svchost.exe_BUGCHECK_CRITICAL_PROCESS_TERMINATED_BY_ SelfTester.exe_6771c7c0</code> </pre> <br>  As you understand, forcibly closing instances of svchost.exe processes usually results in BSOD.  You can check. <br><br>  Yes, our flawless SelfTester tool caused Windows to crash.  But since this was the first such incident in the entire long history of the tester‚Äôs existence, and the last changes to its code were made a long time ago, it was decided to consider what ‚Äúit seemed to us‚Äù. <br><br>  Meanwhile, the investigation went on as usual.  To find out the culprit of the completion of the java.exe process, a regular Windows utility was used to configure the registry keys ‚ÄúGlobal Flags‚Äù.  Among other things, it allows you to specify the monitoring mode for the completion of the specified process with the event logged in the system log: <br><br><p><img src="https://habrastorage.org/getpro/habr/post_images/936/0d8/bf1/9360d8bf160732ef342a6fc849a1a29b.png" alt="Picture 7"></p><br>  In case of a forced termination of a process by a third-party process, the Application log of Windows should contain an event with an Event ID = 3001 from the source Process Exit Monitor. <br><br>  As often happens in such cases, it was worth setting the traps, as the prey was immediately hidden.  The next couple of weeks the server worked perfectly, the tasks were successfully completed, and the Windows log did not contain the required events. <br><br>  Finally, one fine morning, the problem repeated, and the following entry appeared in the system log: <br><br>  The process 'C: \ Program Files \ java \ jre1.8.0_102 \ bin \ java.exe was terminated by the process' D: \ SelfTester \ SelfTester.exe with termination code 0. 0x01d3541edc4f867b. <br><br>  SelfTester again.  It turns out that it was due to his fault that the java.exe process was completed, which generated it.  Incredible deceit. <br><br><p><img src="https://habrastorage.org/getpro/habr/post_images/d65/8c0/e53/d658c0e53cabe06a1b5bff6df644964d.png" alt="Picture 9"></p><br><h2>  SelfTester </h2><br>  Finding the culprit is only half the battle.  Now it is necessary to understand what exactly is happening and how it can be corrected.  To do this, we examine the mechanisms of the tester. <br><br>  To analyze each C ++ project, the tester starts the analyzer process (PVS-Studio_cmd.exe) with parameters.  Upon completion of the analysis, the tester does not wait for the process to finish directly, but responds to the event that a verification report (plog) has been created, after which, ‚Äújust in case‚Äù, ends the analyzer process and its child processes.  Probably at this very moment something unexpected happens. <br><br>  In fact, this algorithm is a legacy of the past and now there is no such necessity in it.  Earlier, devenv.exe was run for analysis with parameters.  The check was carried out by the PVS-Studio plugin for Visual Studio.  In the course of this, many child processes were spawned, which had to be terminated. <br><br>  To understand what exactly is happening, it was necessary to add a logging mechanism for terminating processes.  After studying the logs, we managed to find out the following.  Child processes for PVS-Studio_cmd.exe in the tester are searched for with the following WMI request: <br><br><pre> <code class="cpp hljs">SELECT * FROM Win32_Process WHERE ParentProcessId={<span class="hljs-number"><span class="hljs-number">0</span></span>}</code> </pre> <br>  The problem is that at the time of the execution of this request, the process may no longer exist.  He honestly worked and ended, but the tester does not know.  Sometimes a situation arises where the process ID matches (was reused) with the process that originally spawned cmd.exe, on which java.exe hangs (Task Scheduler process).  At the same time, Windows remembers the IDs of the parent processes, even if they are already completed.  So we get this cmd.exe and terminate it, as well as its child processes (recursively). <br><br><p><img src="https://habrastorage.org/getpro/habr/post_images/3dd/e6b/c25/3dde6bc255c3398c6f80199463880448.png" alt="Picture 2"></p><br><h2>  Decision </h2><br>  The problem was solved by adding two conditions to the tester code, under which the child processes cannot be terminated: <br><br><ol><li>  The parent process has already ended. </li><li>  The parent process was not completed, but it started later than its intended subsidiaries.  In this case, he could re-use the ID of an already completed process. </li></ol><br><h2>  Conclusion </h2><br>  So, the investigation is complete.  All suspicions from innocent people were removed, and the guilty were found and severely punished (corrected). <br><br>  In conclusion, I want to note that the situation described is, in my opinion, a good example of how even a small oversight can lead to a difficult to reproduce error. <br><br>  We are not ashamed to admit our mistakes and, I think, readers were interested in meeting one of them. <br><br>  Bezdazhnogo code and successful builds! </div><p>Source: <a href="https://habr.com/ru/post/344142/">https://habr.com/ru/post/344142/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../344132/index.html">Master class ‚ÄúWhy Steve Jobs loved fonts‚Äù (Alexey Kapterev)</a></li>
<li><a href="../344134/index.html">Top 10 examples and anti-examples of developer-audience interaction: Part One</a></li>
<li><a href="../344136/index.html">New life old pagination</a></li>
<li><a href="../344138/index.html">10 best free CRM systems for business</a></li>
<li><a href="../344140/index.html">Rostelecom: other people's accounts are not spam</a></li>
<li><a href="../344144/index.html">Binary search in graphs</a></li>
<li><a href="../344146/index.html">Kotlin Night Moscow - video, photo, presentation</a></li>
<li><a href="../344150/index.html">Survey for users of the browser Vivaldi</a></li>
<li><a href="../344156/index.html">Visual Studio extension to render instances of custom classes in debug mode. Part 2</a></li>
<li><a href="../344160/index.html">List of useful ideas for high-load services</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>