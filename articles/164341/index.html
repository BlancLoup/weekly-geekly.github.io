<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>theos: writing a tweak for iOS SpringBoard</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good skoronovogodnogo evening dear habraludyam! 

 Today I will talk about creating a tweak for iOS SpringBoard using theos . What for? As an interest...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>theos: writing a tweak for iOS SpringBoard</h1><div class="post__text post__text-html js-mediator-article">  Good skoronovogodnogo evening dear habraludyam! <br><br>  Today I will talk about creating a tweak for iOS SpringBoard using <a href="https://github.com/rpetrich/theos">theos</a> .  What for?  As an interesting story and workout.  At the end of the tutorial we will get something like this right on the screen of the blocking of our i-device: <br><br><img src="https://habrastorage.org/storage2/128/048/fcd/128048fcd9592e7787912bd943503ae9.png"><br><a name="habracut"></a><br><h3>  Creating a project and setting up theos </h3><br>  We start: we create an empty folder, we throw Teos into it (I threw it in the form of a guitar submodule). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Next, create a new project using the NIC: <br><br><pre><code class="bash hljs">iHabrTweak git:(master) theos/bin/nic.pl NIC 2.0 - New Instance Creator ------------------------------ [1.] iphone/application [2.] iphone/library [3.] iphone/preference_bundle [4.] iphone/tool [5.] iphone/tweak Choose a Template (required): 5 Project Name (required): iHabrTweak Package Name [com.yourcompany.ihabrtweak]: com.silvansky.ihabr Author/Maintainer Name [Valentine Silvansky]: silvansky [iphone/tweak] MobileSubstrate Bundle filter [com.apple.springboard]: Instantiating iphone/tweak <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ihabrtweak/... Done.</code> </pre> <br>  Now we have a folder ihabrtweak, in which we need the files we need. <br><br><pre> <code class="bash hljs">iHabrTweak git:(master) ‚úó <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ihabrtweak ihabrtweak git:(master) ‚úó ls Makefile Tweak.xm control iHabrTweak.plist theos</code> </pre><br>  Now run make and see errors: not everything is so simple!  Our system is not fully ready for theos testing. <br><br>  Well, it is necessary to enter the settings necessary for normal assembly: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ARCHS=armv7 <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> TARGET=iphone:latest:4.3 <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> THEOS=<span class="hljs-string"><span class="hljs-string">"`pwd`/theos"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> SDKVERSION=6.0 <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> THEOS_DEVICE_IP=192.168.2.2</code> </pre><br>  <code>ARCHS</code> indicates to us that we will only collect for armv7, and on armv6 we will score.  <code>TARGET</code> tells us what we will build for iOS using the latest (in the system) SDK and with compatibility from version 4.3.  The remaining three are self-evident. <br><br><pre> <code class="bash hljs">ihabrtweak git:(master) ‚úó make Making all <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> tweak iHabrTweak... Preprocessing Tweak.xm... Compiling Tweak.xm... Linking tweak iHabrTweak... Stripping iHabrTweak... Signing iHabrTweak... ihabrtweak git:(master) ‚úó ls .theos/obj Tweak.xm.o iHabrTweak.dylib</code> </pre><br>  Now we have our wonderful dynamic library, which so far is not able to do anything at all!  But we can install our tweak on the device: <br><br><pre> <code class="bash hljs">ihabrtweak git:(master) ‚úó make package Making all <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> tweak iHabrTweak... make[2]: Nothing to be <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> `internal-library-compile<span class="hljs-string"><span class="hljs-string">'. Making stage for tweak iHabrTweak... dpkg-deb: building package `com.silvansky.ihabr'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> `./com.silvansky.ihabr_0.0.1-1_iphoneos-arm.deb<span class="hljs-string"><span class="hljs-string">'. ihabrtweak git:(master) ‚úó make package install Making all for tweak iHabrTweak... make[2]: Nothing to be done for `internal-library-compile'</span></span>. Making stage <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> tweak iHabrTweak... dpkg-deb: building package `com.silvansky.ihabr<span class="hljs-string"><span class="hljs-string">' in `./com.silvansky.ihabr_0.0.1-2_iphoneos-arm.deb'</span></span>. install.copyFile <span class="hljs-string"><span class="hljs-string">"./com.silvansky.ihabr_0.0.1-2_iphoneos-arm.deb"</span></span> <span class="hljs-string"><span class="hljs-string">"com.silvansky.ihabr_0.0.1-2_iphoneos-arm.deb"</span></span> root@192.168.2.2<span class="hljs-string"><span class="hljs-string">'s password: com.silvansky.ihabr_0.0.1-2_iphoneos-arm.deb 100% 1454 1.4KB/s 00:00 install.exec "dpkg -i com.silvansky.ihabr_0.0.1-2_iphoneos-arm.deb" root@192.168.2.2'</span></span>s password: Selecting previously deselected package com.silvansky.ihabr. (Reading database ... 2516 files and directories currently installed.) Unpacking com.silvansky.ihabr (from com.silvansky.ihabr_0.0.1-2_iphoneos-arm.deb) ... Setting up com.silvansky.ihabr (0.0.1-2) ... install.exec <span class="hljs-string"><span class="hljs-string">"timeout 10s sbreload || ( ( respring || killall -9 SpringBoard ) &amp;&amp; launchctl load /System/Library/LaunchDaemons/com.apple.SpringBoard.plist )"</span></span> root@192.168.2.2<span class="hljs-string"><span class="hljs-string">'s password: launchctl unload SpringBoard.plist waiting for kill(29) != 0...</span></span></code> </pre><br>  Actually, the tweak is ready!  Put, but does nothing.  We will rule it.  Let's start with the theory of theos and its tweaks. <br>  As you have already noticed, in the project we have the file Tweak.xm, which is our main source. <br><br>  At the moment everything is commented out in it, and the commentary itself is partial documentation.  Actually, this file is a template for generating the final .mm file.  Consider some useful macros for this template: <br><br><h4>  % hook and% end </h4><br>  The base tweaks in theos are hooks.  They are based on the richest runtime of the Objective-C language, which allows the substitution of methods for an arbitrary class.  Actually, it is used like this: <br><br><pre> <code class="objectivec hljs">%hook SomeClass -(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)someMethod { <span class="hljs-comment"><span class="hljs-comment">// some code goes here } %end</span></span></code> </pre><br>  Here We are introducing (replacing) the method "someMethod" in the class "SomeClass".  For example, we can embed our code in the SpringBoard, for example, we can add our views to the lock screen. <br><br><h4>  % orig and% new </h4><br>  Well, we have redefined the method, but how to call the original one?  Yes is also very simple!  For this there is a macro% orig.  Being called without parameters, this macro redirects to the original function the same parameters as it came to our hook.  But you can also transfer any of your own: <br><br><pre> <code class="objectivec hljs">%hook SomeClass - (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)initWithFrame:(<span class="hljs-built_in"><span class="hljs-built_in">CGRect</span></span>)frame { <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> result = %orig; <span class="hljs-comment"><span class="hljs-comment">// some custom code return result; } - (id)initWithName:(NSString *)name { id result = %orig(@"customName"); // some custom code return result; } %end</span></span></code> </pre><br>  If simple method definitions inside the hooks override existing ones, then the macro% new can be used to add new methods.  In essence, this is a separator between the methods we replace and the methods we add.  ALL methods coming after% new will be added.  Example: <br><br><pre> <code class="objectivec hljs">%hook SomeClass - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)someOldMethod { <span class="hljs-comment"><span class="hljs-comment">// some code here } %new - (void)someNewMethod { // some more code here } %end</span></span></code> </pre><br>  But with this approach, we will not be able to call our new method from the redefined one: theos treats vornings as errors and will not allow to build a project.  After all, we have not announced our method!  But this is fixable, just add this to our file: <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeClass</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NewMethods</span></span></span><span class="hljs-class">) - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">someNewMethod</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class">;</span></span></code> </pre><br><h4>  % log </h4><br>  The% log macro allows you to write a function call to the system log.  Usually used for debugging. <br><br>  Other macros can be viewed <a href="http://iphonedevwiki.net/index.php/Logos">here</a> . <br><br><h3>  We write something useful </h3><br>  Complete with theos, we get the system framework headers.  In our project, they are in <code>theos/include</code> .  If they do not lie, do not forget to do this: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> theos git submodule init git submodule update</code> </pre><br>  There we find the folder SpringBoard, and in it - a bunch of headers.  Well, let's go through the class names.  Note the interesting class SBAwayView, which is the main view of the lock screen.  Well, we will put hooks in it.  First you need to catch the moment of its creation: <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;SpringBoard/SBAwayView.h&gt;</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><span class="hljs-meta"> %hook SBAwayView -(id)initWithFrame:(CGRect)frame { id result = %orig; if (result) { // here goes the code... } return result; } %end</span></span></code> </pre><br>  We can put% log and make sure after the build-installation that this method is actually called.  Now we can add new views!  Just where?  Let's add them to the background image.  We find ivar <code>UIImageView *_backgroundView</code> for the <code>SBSlidingAlertDisplay</code> class, from which <code>SBAwayView</code> is inherited, we also find the method <code>-(CGRect)middleFrame;</code>  .  But how do we get the ivar value?  Let's google  Find the MSHookIvar function that will do everything: <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;SpringBoard/SBAwayView.h&gt;</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;substrate.h&gt;</span></span></span><span class="hljs-meta"> %hook SBAwayView -(id)initWithFrame:(CGRect)frame { id result = %orig; if (result) { CGRect labelRect = [self middleFrame]; labelRect.origin.y = labelRect.origin.y + 20.f; labelRect.size.height = 50.f; UILabel *habrLabel = [[[UILabel alloc] initWithFrame:labelRect] autorelease]; habrLabel.text = @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Hello, Habr!"</span></span></span><span class="hljs-meta">; habrLabel.textColor = [UIColor colorWithRed:155.f/255.f green:182.f/255.f blue:206.f/255.f alpha:1.f]; habrLabel.opaque = NO; habrLabel.textAlignment = UITextAlignmentCenter; habrLabel.font = [UIFont boldSystemFontOfSize:36]; habrLabel.backgroundColor = [UIColor clearColor]; UIImageView *backgroundView = MSHookIvar</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;UIImageView *&gt;</span></span></span><span class="hljs-meta">(self, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"_backgroundView"</span></span></span><span class="hljs-meta">); [backgroundView addSubview:habrLabel]; } return result; } %end</span></span></code> </pre><br>  Run and enjoy the spectacle! <br><img src="https://habrastorage.org/storage2/3bd/6b0/1a8/3bd6b01a8b394b13a49e8ec270e229d9.png"><br>  Now we will complicate the task.  We will upload a picture!  In theory, everything is simple: instead of UILabel, create a UIImageView.  And where does the picture come from? <br><br>  The picture should be put in the SpringBoard.app bundle, but it is better if the picture itself is copied during the package installation.  To do this, we will reorganize the project structure: create the Layout folder, in it the DEBIAN folder, where we will move the existing control file, next to the DEBIAN folder, make System / Library / CoreServices / SpringBoard.app, where we place our picture: <br><br><pre> <code class="bash hljs">SpringBoard.app git:(master) <span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span> /Users/silvansky/Projects/iHabrTweak/ihabrtweak/Layout/System/Library/CoreServices/SpringBoard.app SpringBoard.app git:(master) ls habr_logo_hat.png</code> </pre><br><br>  Now you can write the final New Year code: <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;SpringBoard/SBAwayView.h&gt;</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;substrate.h&gt;</span></span></span><span class="hljs-meta"> #define IMG_WIDTH 150.f #define IMG_HEIGHT 186.f %hook SBAwayView -(id)initWithFrame:(CGRect)frame { id result = %orig; if (result) { CGRect imageRect = [self middleFrame]; imageRect.origin.y = imageRect.origin.y + 20.f; imageRect.origin.x = (imageRect.size.width - IMG_WIDTH) / 2.f; imageRect.size.width = IMG_WIDTH; imageRect.size.height = IMG_HEIGHT; UIImageView *habrLogoView = [[[UIImageView alloc] initWithFrame:imageRect] autorelease]; habrLogoView.image = [UIImage imageNamed:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"habr_logo_hat"</span></span></span><span class="hljs-meta">]; UIImageView *backgroundView = MSHookIvar</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;UIImageView *&gt;</span></span></span><span class="hljs-meta">(self, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"_backgroundView"</span></span></span><span class="hljs-meta">); [backgroundView addSubview:habrLogoView]; } return result; } %end</span></span></code> </pre><br>  And - admiring the resulting beauty: <br><img src="https://habrastorage.org/storage2/8f9/e2f/d70/8f9e2fd70ee2492056b2ded1aa46c7c7.png"><br><br>  Full source, as usual, please take <a href="https://github.com/silvansky/iHabrTweak">a githaba</a> . <br><br>  Happy New Year!  Joy and good luck next year!  =) </div><p>Source: <a href="https://habr.com/ru/post/164341/">https://habr.com/ru/post/164341/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../164321/index.html">How expensive is Google Chrome for your SSD?</a></li>
<li><a href="../164327/index.html">Nearby Entertainment Literature</a></li>
<li><a href="../164329/index.html">Problems with the list of sites Roskomnadzor. Telecom operators, beware</a></li>
<li><a href="../164333/index.html">We sculpt a snowman (decorate the application)</a></li>
<li><a href="../164337/index.html">Custom scripts in Opera Mobile for android</a></li>
<li><a href="../164349/index.html">Videobook ultrabook (tablet) Lenovo IdeaPad Yoga-13</a></li>
<li><a href="../164353/index.html">2013: it's time to stop chasing flops</a></li>
<li><a href="../164355/index.html">"IBM 5 in 5". Is the future close?</a></li>
<li><a href="../164357/index.html">Building Qt 5.3.0 in Visual Studio 2008</a></li>
<li><a href="../164359/index.html">LG will release its mobile processor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>