<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cassandra Cluster Rescue Experience</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I happened to save the cluster of Cassandra that had gone into oblivion. It was an interesting experience that I would like to share, because in a reg...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cassandra Cluster Rescue Experience</h1><div class="post__text post__text-html js-mediator-article">  I happened to save the cluster of Cassandra that had gone into oblivion.  It was an interesting experience that I would like to share, because in a regular situation, most databases work the same way, but the level of stress during a fall can differ very much. <br><br><a name="habracut"></a><br><br><h4>  about the project </h4>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A service that uses Cassandra should store N recent events for each user.  Events come much more often than the user can read them and, in most cases, the recorded data will never be read, but will be simply superseded by newer events.  In the world in general, there are not so many databases that work well in write-intensive tasks, but Cassandra is one of them.  Writing to the cluster (with minimal consistency) is much faster than reading.  Of course, it helps that you only need to select data by the primary key - the user id. <br><br><h4>  Something went wrong </h4><br><br>  The person who started the service was not serious enough about documentation and did not balance the ring.  The fact is that when you automatically add a node, it is allocated half of the largest at the time of adding a segment.  As a result, of the five almost simultaneously running nodes, a very bizarre configuration was obtained, in which two servers were loaded much stronger than the other three. <br><br> <code>nodetool ring <br> 161594151652226679147006417055137150248 <br> X1 Up 106.92 GB 38459616957251446947579138011358024346 |&lt;--| <br> X2 Up 261.58 GB 87228834825681839886276714150491220347 | ^ <br> X3 Up 268.08 GB 136691754424709629435450736264931173936 v | <br> X4 Up 148.58 GB 151190524462851319585265604946253553766 | ^ <br> X5 Up 72.71 GB 161594151652226679147006417055137150248 |--&gt;| <br></code> <br><br>  The size of the hard drive on all five servers was 260GB.  Two nodes fell, because of the end of disk space and the entire cluster choked in the load. <br><br>  Documentation, on the other hand, repeatedly warns that one should not allow automatic selection of ring segments in production.  Provides PHP formula and code for manual calculation of tokens. <br><br><h4>  Resuscitation </h4><br><br>  First, with Cassandra turned off, you can do anything with its data files.  We moved one of the heavy and old files (30GB) to NFS and put symlink on it.  We started the cluster, checked the service - it works.  The total repair time since the detection of the problem is 15 minutes.  Almost all this time was spent on transferring a file to NFS. <br><br>  Secondly, I immediately enabled caching in the database.  Cassandra has a pretty decent caching mechanism, which significantly reduces hard disk accesses.  At least in our application, cache hits were between 80% and 90%. <br><br> <code>nodetool setcachecapacity App Feeds 200000 1000000</code> <br> <br>  Note: cache size is set in ‚Äúrecords‚Äù, not bytes.  It is necessary to properly imagine the size of the average record, so as not to miss.  I, of course, missed, singled out more available and in a few hours I received the first node that took off from Out Of Memory.  It is treated by a simple restart and more careful cache size. <br><br><h4>  Attempt to cure </h4><br><br>  So, the service came to life, copes with the load, but it‚Äôs impossible to have an unbalanced cluster with a part of data on NFS for a long time.  After reading the documentation, an attempt was made to use the nodetool move command.  I tried to make it work for almost a week.  The essence of the problem was that the data between the nodes did not move.  The streams directory appeared on the source node, which contained the data prepared for the transfer, but the transfer itself (which can be watched by the notedool streams command) always hung.  Sometimes even at the very beginning. <br><br>  So for the first time I ran into bug <a href="https://issues.apache.org/jira/browse/CASSANDRA-1221">1221</a> .  After reading the fix, I tried to upgrade to the latest version, but here I was caught by a <a href="https://issues.apache.org/jira/browse/CASSANDRA-1760">1760</a> bug.  In the end, I still updated the cluster to 0.6.5, but it did not help much.  The cluster is ‚Äústuck‚Äù in an unbalanced state. <br><br>  I must say that the tools for managing the cluster are not just poor, but rudimentary.  You can give only a few commands and monitor their process by indirect signs.  That's all. <br><br>  To my great joy, by this time the leadership has forked out on a training seminar from <a href="http://www.riptano.com/">Riptano</a> .  This company is Cassandra, they develop it and provide paid support.  At this seminar I opened the Tao Cassandra. <br><br><h4>  Tao Cassandra </h4><br><br>  <b>Do not try to treat anything.</b>  <b>Falling - finish, clean, turn on as new.</b>  That was what was said at the seminar.  This explains the vestigiality of tools for managing the cluster.  The fact is that according to the authors' idea, the management consists of two main operations - 1) add a node;  2) remove the node. <br><br>  It was in this way that I finally managed to fix the cluster.  The nodes were removed one by one from the cluster, cleared and run with correctly counted tokens.  Of course, I had to sit down with the paper, inventing a restart procedure that would allow me to do without downtime.  It turned out to be an interesting, though not very difficult task in combinatorics. <br><br>  Without bugs, of course, not done.  <a href="https://issues.apache.org/jira/browse/CASSANDRA-1676">1676</a> pursued me all the time.  The loading node received 50GB of its new data and calmly sat on.  Restarting the service led to the next 50GB.  And so until everything comes. <br><br><h4>  Conclusion </h4><br><br>  Fix the cluster turned out.  My opinion about Cassandra has changed from ‚Äúwhat a student's hand-made article, no tools there are‚Äù to ‚Äúsurprisingly stable database‚Äù.  In fact, for two months the cluster worked with damaged servers - at two speeds of access to the HDD were slowed down to the speed of NFS.  And while the service as a whole lived and users did not really complain. <br><br>  During this time, I learned a lot about the insides of this database, talked to its creators (amazingly responsive and intelligent people) and even got closer to the end of the process, enjoyed it. </div><p>Source: <a href="https://habr.com/ru/post/114160/">https://habr.com/ru/post/114160/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../114154/index.html">B-tree</a></li>
<li><a href="../114156/index.html">280 crinkles or explosive power of regular expressions</a></li>
<li><a href="../114157/index.html">What is the speed of your internet access?</a></li>
<li><a href="../114158/index.html">Scala + Processing is a fun way to learn a new language.</a></li>
<li><a href="../114159/index.html">Introduction to eZ Publish on the example of creating a site</a></li>
<li><a href="../114161/index.html">Steelseries Ikari Laser White - white crow</a></li>
<li><a href="../114162/index.html">In the footsteps of GTUG Day Meeting # 1 Minsk</a></li>
<li><a href="../114164/index.html">Let's try to pragmatically discuss the situation with Nokia and MS</a></li>
<li><a href="../114165/index.html">Toshiba's first Wintel tablet</a></li>
<li><a href="../114168/index.html">In honor of the # Jan25 revolution, the Egyptian named his daughter Facebook</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>