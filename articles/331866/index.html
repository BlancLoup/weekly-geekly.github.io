<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using Pinba in Badoo: what you don't know yet</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! My name is Denis, I am a PHP developer at Badoo, and now I‚Äôll tell you how we use Pinba ourselves. It is assumed that you already know what ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using Pinba in Badoo: what you don't know yet</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/00d/101/145/00d101145487496c85c8bc8bf4c9d0c9.jpg"></p><br><p>  Hi, Habr!  My name is Denis, I am a PHP developer at Badoo, and now I‚Äôll tell you how we use <a href="http://pinba.org/">Pinba</a> ourselves.  It is assumed that you already know what kind of tool it is, and you have experience in using it.  If not, then for reference I <a href="https://habrahabr.ru/company/badoo/blog/149695/">recommend the article of</a> my colleague, Maxim Matyukhin. </p><br><p>  In general, there are enough materials on Habr√© about using Pinba in various companies, including the <a href="https://habrahabr.ru/company/badoo/blog/319934/">post of Oleg Efimov</a> in our blog.  But they all relate to other companies, not Badoo, which is a bit illogical: they themselves invented a tool, posted it in open source and do not share their experiences.  Yes, we often mention Pinba in various publications and in reports at IT conferences, but usually it looks something like this: "But we got these wonderful graphs from data from Pinba" or "We used Pinba for measurement", and that's it. . </p><br><p>  Communication with colleagues from other companies showed two things: firstly, quite a lot of people use Pinba, and secondly, some of them do not know or do not use all the features of this tool, and some do not fully understand its purpose.  Therefore, I will try to tell you about those nuances that are not clearly indicated in the documentation, about the new features and the most interesting cases of using Pinba in Badoo.  Go! </p><a name="habracut"></a><br><h3 id="nebolshoe-vvedenie">  Small introduction </h3><br><p>  The documentation states that ‚ÄúPinba is a statistics server that uses MySQL as an interface ...‚Äù Pay attention to the concept of ‚Äúinterface‚Äù, which is not used in the meaning of the data warehouse, but in the meaning of the interface.  In the first versions of Pinba, the author of which was still Andrei Nigmatulin, there was no MySQL interface, and a separate protocol was necessary to obtain data.  Which, of course, uncomfortable. </p><br><p>  Later Anton Dovgal <a href="https://habrahabr.ru/users/tony2001/" class="user_link">tony2001</a> added this functionality, which greatly facilitated the process of data acquisition.  It became possible not to write any scripts, all MySQL clients need is to join the database and receive all the information using simple SQL queries.  But at the same time inside Pinba stores data in its internal format, and the MySQL engine is used only for display.  What does it mean?  So this is what actually no real tables exist.  "No spoons."  You can even safely delete one of the so-called ‚Äúraw‚Äù data tables, for example, requests - and after that all your reports will still work. </p><br><p>  After all, the data itself will not disappear anywhere.  You simply cannot access this table in SQL queries.  That is why the main reason for using exactly the reports (and not the "raw" tables) is that with complex queries (several JOINs, etc.), Pinba must filter and group all the data on the fly. </p><br><p>  I understand that, knowing SQL, you can easily get all the samples from the ‚Äúraw‚Äù data tables, but this is the way to the dark side of the force.  This method is extremely resource intensive.  Of course, all queries will work, and often, when something is urgently needed, you can get into the table of requests or tags.  But I really do not recommend doing it without need only because it is easier and faster.  All the power of Pinba is in the reports. </p><br><p> It is quite simple to create reports, but even here there are some subtleties.  As I have already said, no tables exist, and when you create a report, that is, execute a <code>CREATE TABLE</code> query, you only inform the service which aggregations you will need.  And until the first request is made to this ‚Äútable‚Äù, no aggregations will be collected.  Here there is one important nuance: if you started collecting some data, and then they are no longer needed, then it is better to delete the ‚Äútable‚Äù with the report.  Pinba does not monitor whether you stopped using the report or not: once you requested data, it will always be collected. </p><br><p>  Another point to consider when creating reports: for each type of report has its own set of fields.  When displayed in MySQL, Pinba focuses on the order of the fields, and not on their names, so you can‚Äôt just take and swap fields or leave out some of the fields: </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`tag_report_perf`</span></span> ( <span class="hljs-string"><span class="hljs-string">`script_name`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">`tag_value`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`req_count`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`req_per_sec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`hit_count`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`hit_per_sec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`timer_value`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`timer_median`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ru_utime_value`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ru_stime_value`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`index_value`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`p75`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`p95`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`p99`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`p100`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`script_name`</span></span> (<span class="hljs-string"><span class="hljs-string">`script_name`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=PINBA <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=latin1 <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">'tag_report:perf::75,95,99,100'</span></span></code> </pre> <br><p>  In this example, we create a report of type <code>tag_report</code> ;  this means that the first field will always contain the name of the script, the value of the <code>perf</code> tag will follow, then the full set of all fields and at the end we need the percentages.  This is the case when you do not need to fantasize, but simply take the structure of the table from the documentation and copy it.  Naturally, the field with the name of the tags can and even should be called more clearly than <code>tag1_value, tag2_value</code> , and the order of the tags and percentiles in the table should match their order in the description. </p><br><h3 id="agregacii-po-tegam-zaprosa-requests-tags">  Request Tag Aggregations </h3><br><p>  As you know, Pinba has several types of reports, and relatively recently (a year and a half ago) we added more reports on request tags.  Prior to this, by request tags (do not confuse with timers tags, these are different things) it was only possible to filter, but there were no aggregations. </p><br><p>  Why did we need such functionality?  One of the main types of content in Badoo is photography.  More than 350 million users use our service, most of whom have photos.  In order to upload photos, we have two types of machines: the so-called photokegs ‚Äî machines with ‚Äúfast‚Äù disks, on which only the actively requested images lie, and the main ‚Äúclusters‚Äù - machines, where all the photos are stored. </p><br><p>  Read more about the photo storage system <a href="https://www.youtube.com/watch%3Fv%3DSU9ETg39FEg">told</a> on the last HighLoad ++ Artem Denisov.  If we give up caching and allow all traffic to the ‚Äúslow‚Äù photo storage, then at best the photo upload time will increase, at worst - we won't be able to give content from some machines at all, and requests will fall off due to a timeout.  Now we have about 98% trickrate. </p><br><p>  It would seem that everything is very good, but a drop in the cunning rate, say, to 96% immediately increases the load on the photo storage cluster by two times.  Therefore, it is very important for us to follow the trick rate and to avoid significant falls.  And we decided to do this with Pinba.  Since PHP is not used on machines with photo caches (all content is delivered via a web server), we use the <a href="http_pinba_module">Pinba plugin for nginx</a> . </p><br><p>  But here's a bad luck - inside nginx we cannot use timers and aggregation of timer tags, but we can actively tag the request itself.  And we really wanted to make a breakdown by the size of the images, by the type of application and by several other parameters.  A query can have multiple tags, and we need to aggregate all of them.  For this purpose the following types of reports were created: </p><br><ul><li>  <code>rtag_info</code> - aggregation by one tag, </li><li>  <code>rtagN_info</code> - multiple tag aggregation, </li><li>  <code>rtag_report</code> - aggregation by one tag and host, </li><li>  <code>rtagN_report</code> - aggregation by several tags and host. </li></ul><br><p>  Here are examples of reports: </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`photoscache_report_hitrate`</span></span> ( <span class="hljs-string"><span class="hljs-string">`hostname`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">`tag1_value`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`tag2_value`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`tag3_value`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`req_count`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`req_per_sec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`req_time_total`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`req_time_percent`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`req_time_per_sec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ru_utime_total`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ru_utime_percent`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ru_utime_per_sec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ru_stime_total`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ru_stime_percent`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ru_stime_per_sec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`traffic_total`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`traffic_percent`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`traffic_per_sec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`memory_footprint_total`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`memory_footprint_percent`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`req_time_median`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`index_value`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`hostname`</span></span> (<span class="hljs-string"><span class="hljs-string">`hostname`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=PINBA <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=latin1 <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">'rtagN_report:served_by,build,img_size'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`photoscache_top_size`</span></span> ( <span class="hljs-string"><span class="hljs-string">`geo`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`req_count`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`req_per_sec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`req_time_total`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`req_time_percent`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`req_time_per_sec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ru_utime_total`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ru_utime_percent`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ru_utime_per_sec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ru_stime_total`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ru_stime_percent`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ru_stime_per_sec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`traffic_total`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`traffic_percent`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`traffic_per_sec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`memory_footprint_total`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`memory_footprint_percent`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`req_time_median`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`index_value`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`p95`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`p99`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=PINBA <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=latin1 <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">'rtag_info:geo:tag.img_size=top:95,99'</span></span></code> </pre> <br><p>  (yes in the last report we aggregate by <code>geo</code> tag and filter by <code>img_size</code> tag). </p><br><p>  In the nginx configuration files, install the necessary tags: </p><br><pre> <code class="hljs cs">location ~ <span class="hljs-string"><span class="hljs-string">'.....'</span></span> { ... pinba_tag fit_size <span class="hljs-string"><span class="hljs-string">'500x500'</span></span>; pinba_tag is_fit <span class="hljs-number"><span class="hljs-number">1</span></span>; pinba_tag img_size <span class="hljs-string"><span class="hljs-string">'920'</span></span>; ‚Ä¶</code> </pre> <br><p>  - and in the end we can get these charts: </p><br><p><img src="https://habrastorage.org/web/6f1/71f/a7f/6f171fa7f5a2440483917d15c8270d1c.png"></p><br><p>  We smoothly moved to examples of use.  I will not focus on rather trivial examples - I‚Äôll just list some basic things that we monitor with Pinba: </p><br><ul><li>  the number and time of requests for PHP clusters; </li><li>  memory consumption by PHP scripts; </li><li>  request time to all external services (C, Go, Memcached, MySQL daemons, etc.); </li><li>  using the nginx plugin, monitor the number of requests per second and the time of each request to nginx, broken down by response status; </li><li>  other. </li></ul><br><h3 id="monitoring-ocheredey">  Queue Monitoring </h3><br><p>  In almost every more or less serious project, sooner or later the task of processing the queue of events arises.  Certain user actions on the site initiate the dispatch of an event, to which several handlers can be subscribed, and each of them has its own queue.  We have this process divided into three parts: </p><br><ul><li>  transport - events from all hosts are collected and sent to the machine where the script cloner runs, which clones the events into a queue for each subscriber; </li><li>  queue: the event is in the queue (we use both MySQL and other brokers for queues, for example, Darner); </li><li>  processing: the event reached the subscriber and begins to be processed. </li></ul><br><p>  At some point, we wanted to measure how much time passes from the moment an event is generated until it is processed.  The problem is that this is not just one PHP script, but several different scripts (in general, not even PHP): in one event it rushes, in the other - the event is sent to the queue to the processor, finally, the script processor itself that gets the event from the queue.  How to be?  In fact, everything is very simple.  At the time of generating the event, we fix the time and write it into these events, and then at each stage we remember the difference between the time of sending and the current time.  As a result, at the very end, when the event is processed, we have all the necessary timer values ‚Äã‚Äãthat we send to Pinba.  As a result, we can make this report: </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`tag_info_measure_cpq_consumer`</span></span> ( <span class="hljs-string"><span class="hljs-string">`type`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`consumer`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`timer`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, .... ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=PINBA <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=latin1 <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">'tagN_info:type,consumer,timer'</span></span></code> </pre> <br><p>  where <code>timer</code> is the name of the timer for a certain stage of event processing, <code>consumer</code> - the name of the subscriber, <code>type</code> - in our case, this is the type of event dispatch (within one site or inter site) (we have two sites with the same infrastructure - in Europe and in the USA, and events can depart from site to site). </p><br><p>  With the help of this report, we got these charts: </p><br><p><img src="https://habrastorage.org/web/e5e/9c0/9b2/e5e9c09b2d54468791b4d5eef6b014df.png"></p><br><p>  In this example, the event updates the user‚Äôs coordinate data.  As you can see, the whole process takes less than five seconds.  This means that when you came to your favorite bar, opened the Badoo application and tried to find users nearby, they will really show you who is now in this place, and not where you were half an hour ago (of course, if your mobile device sends your location data). </p><br><p>  This principle (to collect all the timers, and then send them to Pinba) is used in Jinba.  Jinba is our project to measure client-side performance, which is based on Pinba;  stands for javascript is not a bottleneck anymore.  More information about Jinba can be found <a href="https://tech.badoo.com/presentation/123/realtime-statistika-skorosti-prilogenij/">in the report of Pavel Dovbush</a> and <a href="https://github.com/dpp-name/jinba">on the project website</a> . </p><br><p>  We collect all the timers on the client and then send them to the PHP script in one request, which already sends everything to Pinba.  In addition to standard report types, we actively use histograms in Jinba.  I will not talk in detail about them - let me just say that, thanks to the functionality of the histograms, we have the opportunity to indicate percentiles in the reports. </p><br><p>  By default, Pinba divides the entire time interval into which the requests fell into 512 segments, and in the histogram we save the number of queries that fell into one or another segment.  I have already said that we measure the time of the PHP scripts, the response time of nginx, the time of accessing external services, etc. But what time do we measure?  For example, per second there were 1000 requests for a script, respectively, we have 1000 different values.  Which of them need to be displayed on the chart?  The majority will say: ‚ÄúAverage arithmetic‚Äù, - someone will say that you need to look at how many slowest queries are executed.  Leave this question outside of this post.  For those who do not know what percentile is, let me give you the simplest example: the 50th percentile (or median) is a value where 50% of queries are executed in a time that does not exceed this value. </p><br><p><img src="https://habrastorage.org/web/9a7/571/ac5/9a7571ac59364ad08f4d59b0366176f0.png"></p><br><p>  We always measure the arithmetic mean and the highest percentiles: the 95th, 99th, and even the 100th (the highest query execution time).  Why are senior percentile so important to us?  Here is an example of a graph with the answers of one of our external services: </p><br><p><img src="https://habrastorage.org/web/28b/6f3/146/28b6f3146f54466c949a1a4db4569c94.png"></p><br><p>  It can be seen from the figure that both the arithmetic mean and the median (50th percentile) are approximately two times smaller than the 95th percentile.  That is, when you make a report for management or speak at a conference, it will be advantageous to show exactly this request time, but if you want to make users happier, then it will be more correct to pay attention to 5% of slow requests.  There are cases when the value of the 95th percentile is almost an order of magnitude higher than the average, which means that somewhere there is a problem that needs to be found and fixed. </p><br><h3 id="mysql-is-not-a-bottleneck-anymore">  MySQL is not a bottleneck anymore </h3><br><p>  Since we are monitoring requests to all external services, naturally, we cannot ignore database requests.  We use MySQL in Badoo.  When we had the task of monitoring it, we first decided to use Slowlog + Zabbix.  But it turned out to be very inconvenient.  Slowlog can be very large, and it is often difficult to find the cause of the problem in it, especially when it needs to be done quickly.  Therefore, we began to consider commercial solutions. </p><br><p>  At first glance, everything was fine, but it was embarrassing that the trial version worked only on a limited number of servers (an order of magnitude smaller than ours on the same site), and there was a risk that a solution could make money on the whole cluster. </p><br><p>  Simultaneously with the testing of a commercial solution, our DBA (by the way, we have only two of them: main and backup, or master and slave) made their own development.  They used <code>performance_schema</code> , scripts in Python, sent all this to Elastic, and used Kibana for reports.  And, oddly enough, everything worked, but to make monitoring of our entire MySQL cluster would require an Elasticsearch cluster of comparable power. </p><br><p>  Unfortunately, even in Badoo, you can‚Äôt get a hundred extra machines for a cluster on the click of your fingers.  And here we remembered Pinba.  But the following caveat arose: how to save information about a SQL query in Pinba?  Moreover, you need to save information not about a specific query, but about a ‚Äúpattern‚Äù of a query, that is, if you have 1000 queries of the form <code>Select * from table where field = field_value</code> , and the field_value field is different in each of them, then you need to Pinba save pattern data <code>Select * from table where field = #placeholder#</code> .  To do this, we refactored all the code and everywhere, where in SQL the field values ‚Äã‚Äãwere substituted directly in the code, we put the placeholders.  But still, the request template may be too large, so we take a hash for each template and it is its value that goes to Pinba.  Accordingly, in a separate table we store the ‚Äúhash - template text‚Äù bundles.  Pinba created this report: </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`minba_query_details`</span></span> ( <span class="hljs-string"><span class="hljs-string">`tag_value`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ... <span class="hljs-string"><span class="hljs-string">`p95`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`p99`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=PINBA <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=latin1 <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">'tag_info:query::95,99'</span></span></code> </pre> <br><p>  In the PHP code, we create an array of tags for each request: </p><br><pre> <code class="hljs php">$tags = [ <span class="hljs-string"><span class="hljs-string">'query'</span></span> =&gt; $query_hash, <span class="hljs-string"><span class="hljs-string">'dest_host'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'dbs1.mlan'</span></span>, <span class="hljs-string"><span class="hljs-string">'src_host'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'www1.mlan'</span></span>, <span class="hljs-string"><span class="hljs-string">'dest_cluster'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'dbs.mlan'</span></span>, <span class="hljs-string"><span class="hljs-string">'sql_op'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'select'</span></span>, <span class="hljs-string"><span class="hljs-string">'script_name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'demoScript.php'</span></span>, ];</code> </pre> <br><p>  Naturally, there should be one place in the code where the query to the database is executed, a certain wrapper class;  <code>mysqli_query</code> course, you cannot directly call the <code>mysql_query</code> or <code>mysqli_query</code> methods. </p><br><p>  In the place where the request is executed, we count the time of the request and send the data to Pinba. </p><br><pre> <code class="hljs php">$config = [<span class="hljs-string"><span class="hljs-string">'host'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'pinbamysql.mlan'</span></span>, <span class="hljs-string"><span class="hljs-string">'pinba_port'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">30002</span></span>]; $PinbaClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \PinbaClient($config); $timer_value = <span class="hljs-comment"><span class="hljs-comment">/*Execute query and get execution time */</span></span> $PinbaClient‚ÜíaddTimer($tags, $timer_value); <span class="hljs-comment"><span class="hljs-comment">/* Some logic */</span></span> $PinbaClient-&gt;send();</code> </pre> <br><p>  Note the use of the <code>\PinbaClient</code> class.  If you compiled PHP with Pinba support, then you will have this class out of the box (if you use non-PHP, then other languages ‚Äã‚Äãhave their own analogues of this class).  It is clear that there will be a lot of queries to the database, and writing to the same Pinba server where the script statistics are collected will fail.  Hamster will burst.  In the settings of <code>php.ini</code> you can specify only one Pinba host, where data will be sent upon completion of the script.  And then the <code>\PinbaClient</code> class comes to <code>\PinbaClient</code> .  It allows you to specify an arbitrary host with Pinba and send timer values ‚Äã‚Äãthere.  By the way, we also use a separate Pinba server to monitor the queues.  Since the data in Pinba stores a limited amount of time, the table with a bunch of ‚Äúhash - SQL template‚Äù stores only actual hashes. </p><br><p>  There are really a lot of requests, so we decided to send to Pinba every second.  This is about one hundred and fifty thousand requests per second.  And it works.  At any moment we can see which requests on which hosts slow down, which requests have appeared, which requests are being executed very much.  And these reports are available to every employee. </p><br><p>  Another non-trivial case for using Pinba is the monitoring of the memkey cache.  At each site we have a cluster of machines with Memcached, and it was necessary to understand whether we effectively use memkes.  The problem is that we have a lot of different keys, and the amount of data for each of them varies from a few bytes to hundreds of kilobytes.  Memkesh breaks all the memory provided to him into pages, which are then distributed among the weak (slabs).  A weak is a fixed amount of memory allocated for one key.  For example, the third is weakly 152 bytes in size, and the fourth is 192 bytes.  This means that all keys with data from 152 to 192 bytes will be in the fourth weaker.  Under each weakly allocated a certain number of pages, each divided into pieces (chunks), equal to the size of the weak.  Accordingly, a situation may arise when some weaknesses are allocated more pages than necessary, and the trickrate on these keys is quite high, and on the other keys, the trickrate can be very low, while the memke has enough free memory.  To avoid this, you need to redistribute the pages between the weak.  Accordingly, we need to know the trick of each key at a given time, and for this we also use Pinba. </p><br><p>  In this case, we acted similarly to monitoring requests to MySQL - refactored and brought all keys to <code>‚Äúkey_family‚Äù:%s_%s</code> , that is, we selected the unchangeable part (key family) and separated it with a colon from the parts to be changed, for example, <code>messages_cnt:13589</code> (the number of messages with the user ID 13589) or <code>personal_messages_cnt:13589_4569</code> (the number of messages from the user 13589 to the user 4569). </p><br><p>  In the place where the data is read by key, we form the following array of tags: </p><br><pre> <code class="hljs php">$tags = [ <span class="hljs-string"><span class="hljs-string">'key'</span></span> =&gt;<span class="hljs-string"><span class="hljs-string">'uc'</span></span>, <span class="hljs-string"><span class="hljs-string">'cluster'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'wwwbma'</span></span>, <span class="hljs-string"><span class="hljs-string">'hit'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'mchost'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'memcache1.mlan'</span></span>, <span class="hljs-string"><span class="hljs-string">'cmd'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'get'</span></span>, ];</code> </pre> <br><p>  where <code>key</code> is the key family, <code>cluster</code> is a cluster of machines from which the request is sent to the memkey, <code>hit</code> is the data in the cache or not, <code>mchost</code> is the host with the memkey, <code>cmd</code> is the command that is sent to the memkey. </p><br><p>  And in Pinba this report was created: </p><br><pre> <code class="hljs sql">tag_info_key_hit_mchost | <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`tag_info_key_hit_mchost`</span></span> ( <span class="hljs-string"><span class="hljs-string">`key`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">190</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`hit`</span></span> tinyint(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`mchost`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ... ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=PINBA <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=latin1 <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">'tagN_info:key,hit,mchost'</span></span>,</code> </pre> <br><p>  thanks to which we were able to build these charts: </p><br><p><img src="https://habrastorage.org/web/adb/8b5/2a1/adb8b52a1dbd4da9bc335b93ab4ba6a8.png"></p><br><p>  By analogy with monitoring MySQL, a separate Pinba instance is used for these reports. </p><br><p>  Sharding </p><br><p>  With the increase in the number of users and the development of functionality, we are faced with a situation where Pinba could no longer cope on the most heavily loaded PHP cluster where requests from mobile devices arrive.  The solution we found is very simple - to raise several Pinba services and a ‚Äúround of robin‚Äù to send data to an arbitrary one.  The difficulty here is one - how to collect data then?  When collecting data, we created a ‚Äúmerge‚Äù rule for each field type.  For example, the number of queries are summed, and for percentile values, the maximum is always taken, etc. </p><br><h3 id="rezyume">  Summary </h3><br><p>  First, remember that Pinba is not a data warehouse.  Pinba is not about storage at all, but about aggregation, so in most cases it is enough to select the desired type of report, specify a set of percentiles - and you will receive the necessary sample in real time. </p><br><p>  Secondly, do not unnecessarily use tables with ‚Äúraw‚Äù data, even if everything works for you and nothing slows down. </p><br><p>  Third, do not be afraid to experiment.  As practice shows, using Pinba can solve a wide range of tasks. </p><br><p> PS         ,         Pinba,   ,    .          PHP. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/331866/">https://habr.com/ru/post/331866/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../331854/index.html">PETYA malware. Recovery is possible</a></li>
<li><a href="../331858/index.html">How to beat the Petya virus</a></li>
<li><a href="../331860/index.html">WannaCry and Petya - how does the center for monitoring and response to cyber attacks in case of global incidents work?</a></li>
<li><a href="../331862/index.html">Secure USB flash drive. Myth or Reality</a></li>
<li><a href="../331864/index.html">Sizes of raster images: pixels, DPI, PPI, centimeters - you do not confuse anything?</a></li>
<li><a href="../331868/index.html">IBM Bluemix in universities: examples of implemented projects from students and teachers</a></li>
<li><a href="../331870/index.html">Cobian Backup and sending messages to Telegram</a></li>
<li><a href="../331872/index.html">CoreDNS - DNS server for the cloud native world and Service Discovery for Kubernetes</a></li>
<li><a href="../331874/index.html">How to create a successful loyalty program: approaches, technology and statistics</a></li>
<li><a href="../331878/index.html">AGAIN UPDATED: Technical details of the new global attack Trojan.Encoder.12544 (in various sources - Petya, etc.)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>