<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Use Thrift in C</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings, dear habraiser. 

 I'll start with a little background. At the moment I am working on a rather complex product, which consists of the serve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Use Thrift in C</h1><div class="post__text post__text-html js-mediator-article"> Greetings, dear habraiser. <br><br>  I'll start with a little background.  At the moment I am working on a rather complex product, which consists of the server part (includes several services) and the client SDK ported to certain platforms.  All this zoo we need to somehow test together. <br><br>  Client applications (some kind of drivers) were made that use the corresponding SDKs and are able to receive commands from the testing service of the ‚Äúgo to the server, do this‚Äù type, or ‚Äúgive me such a result for testing‚Äù.  The client receives the commands using <a href="https://thrift.apache.org/">Thrift</a> ( <a href="https://ru.wikipedia.org/wiki/Apache_Thrift">wiki</a> ).  And everything was fine, until we got to porting the SDK to C and did not find that Apache didn‚Äôt have an intelligent manual for C.  Found a <a href="https://issues.apache.org/jira/browse/THRIFT-976">ticket</a> for the creation of this manual and a poor example there.  After the successful application of Thrift in C, it was decided to write a small educational program on this topic. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>The goals we set are:</b> <br>  - The client should receive commands from the testing service using Thrift; <br>  - Commands are great, but you also need to communicate with the server; <br>  - The client must work in the same thread. <br><a name="habracut"></a><br>  I will describe the features of work, using the example of ‚ÄúRPC calculator‚Äù from the <a href="https://thrift.apache.org/tutorial/cpp">Apache</a> website.  Thrift's n-th implementation uses glib, which means we'll have to. <br>  First of all, we will generate the sources according to the scheme from the example: <br><br> <code>thrift -r --gen c_glib ./tutorial.thrift</code> <br> <br>  Received several * .c and * .h files.  We will need them in the future. <br>  Now we will write a function to initialize the Thrift connection: <br><br><div class="spoiler">  <b class="spoiler_title">Thrift_init () function</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;glib.h&gt; #include &lt;glib-object.h&gt; #include &lt;thrift/c_glib/protocol/thrift_protocol.h&gt; #include &lt;thrift/c_glib/protocol/thrift_binary_protocol.h&gt; #include &lt;thrift/c_glib/transport/thrift_transport.h&gt; #include &lt;thrift/c_glib/transport/thrift_buffered_transport.h&gt; #include &lt;thrift/c_glib/transport/thrift_socket.h&gt; #include &lt;unistd.h&gt; #include &lt;stdlib.h&gt; #include &lt;stdio.h&gt; #include &lt;calculator.h&gt; //   static ThriftSocket *socket = NULL; static ThriftTransport *transport = NULL; static ThriftProtocol *protocol = NULL; static CalculatorClient *client = NULL; static CalculatorIf *iface = NULL; int thrift_init(const char *hostname, int port) { printf("Initializing Thrift client (server=%s:%d)...\n", hostname, port); g_type_init(); GError *error = NULL; socket = THRIFT_SOCKET(g_object_new(THRIFT_TYPE_SOCKET, "hostname", hostname, "port", port, &amp;error)); if (error) { printf("Failed to create thrift socket: %s\n", error-&gt;message); g_error_free(error); return -1; } transport = THRIFT_TRANSPORT(g_object_new(THRIFT_TYPE_BUFFERED_TRANSPORT, "transport", socket, &amp;error)); if (error) { printf("Failed to create thrift transport: %s\n", error-&gt;message); g_error_free(error); return -1; } protocol = THRIFT_PROTOCOL(g_object_new(THRIFT_TYPE_BINARY_PROTOCOL, "transport", transport, &amp;error)); if (error) { printf("Failed to create thrift binary protocol: %s\n", error-&gt;message); g_error_free(error); return -1; } client = CALCULATOR_CLIENT(g_object_new(TYPE_CALCULATOR_CLIENT, "input_protocol", protocol, "output_protocol", protocol, &amp;error)); if (error) { printf("Failed to create thrift client: %s\n", error-&gt;message); g_error_free(error); return -1; } iface = CALCULATOR_IF(client); thrift_transport_open(transport, &amp;error); //   if (error) { printf("Failed to open thrift connection: %s\n", error-&gt;message); g_error_free(error); return -1; } return socket-&gt;sd; //   .   }</span></span></span></span></code> </pre><br></div></div><br>  Here we create and initialize such important things as: a socket for data transfer, a transport binary protocol, a client interface, etc. Now, let's try calling the calculator method: <br><br><pre> <code class="cpp hljs">GError *error = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; gint32 result = <span class="hljs-number"><span class="hljs-number">0</span></span>; calculator_client_add(iface, &amp;result, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, &amp;error);</code> </pre><br><br>  Well, the result variable got the value 7. But that's not enough for us.  The call turned out to be blocking, but in our case the testing service may not immediately return the command / result, while the client still needs to read and process the responses from our server (working in one thread, remember?).  Fortunately, the Thrift implementation allows us to split the call to <b>calculator_client_add</b> into 2 calls: <b>calculator_client_send_add</b> and <b>calculator_client_recv_add</b> .  The first of them sends a request with function arguments.  The second, respectively, reads the response with the returned value.  Our <b>thrift_init</b> function just returns the socket Thrift handle, and we will use it: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> socket = <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((socket = thrift_init(<span class="hljs-string"><span class="hljs-string">"localhost"</span></span>, <span class="hljs-number"><span class="hljs-number">9090</span></span>)) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { GError *error = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; calculator_client_send_add(iface, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, &amp;error); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error) { <span class="hljs-comment"><span class="hljs-comment">//   g_error_free(error); return -1; } struct pollfd fds; fds.fd = socket; fds.events = POLLIN; fds.revents = 0; if (poll(&amp;fds, 1, 5000 /*5  */) &gt; 0) { if (fds.revents &amp; POLLIN) { gint32 result = 0; calculator_client_recv_add(iface, &amp;result, &amp;error); //  7  result if (error) { //   g_error_free(error); return -1; } } } return 0; } return -1; }</span></span></code> </pre><br><br>  And finally - a function for freeing resources: <br><br><div class="spoiler">  <b class="spoiler_title">Thrift_destroy () function</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">thrift_destroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (transport) { thrift_transport_close(transport, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); g_object_unref(transport); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client) { g_object_unref(client); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (protocol) { g_object_unref(protocol); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (socket) { g_object_unref(socket); } }</code> </pre></div></div><br>  Thus, we managed to kill two birds with one stone: chat with the server and pull thrift calls.  In this case, no fork'ov and thread'ov.  I want to add that Thrift is a great and easy-to-use RPC tool ... Even if you are developing in C. </div><p>Source: <a href="https://habr.com/ru/post/236345/">https://habr.com/ru/post/236345/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../236335/index.html">News from the world of Node: DataCollection.js, Supererror, Readability</a></li>
<li><a href="../236337/index.html">First look at the design of the new standard WordPress theme "Twenty Fifteen"</a></li>
<li><a href="../23634/index.html">AjaxTree - a dynamic scriptaculous menu</a></li>
<li><a href="../236341/index.html">Learn to cook Log4j + Logstash + ElasticSearch + Kibana 3 + Auth (Google OAuth2 / BasicAuth / CAS Authentication)</a></li>
<li><a href="../236343/index.html">WebStorm 9 EAP v.2 released - what was added this time?</a></li>
<li><a href="../236347/index.html">JSOC: how to measure availability of the Security Operation Center?</a></li>
<li><a href="../236349/index.html">Learning how to learn: a brief overview of course materials</a></li>
<li><a href="../23635/index.html">MySpace and Asian culture</a></li>
<li><a href="../236351/index.html">A strange git bug, almost costing 10 hours of work</a></li>
<li><a href="../236353/index.html">A fly in the ointment fly Linux Mint: or how I overcame the brightness</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>