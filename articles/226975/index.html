<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"Correct" speed limit in nginx. Myth or reality?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For many years, Nginx users have been tormented by the same question: ‚ÄúHow can I limit the overall speed for an IP address regardless of the number of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"Correct" speed limit in nginx. Myth or reality?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/8a6/589/9a0/8a65899a0a2a03f149cacc945fd64b8e.jpg"><br><br>  For many years, Nginx users have been tormented by the same question: ‚ÄúHow can I limit the overall speed for an IP address regardless of the number of sessions (connections)?  Why is Nginx not able to?  Why the Nginx developers so stubbornly don‚Äôt want to implement this simple functional? ‚ÄùAnd they don‚Äôt have anything to say to me, what the Nginx developers are thinking about - it‚Äôs not clear and it‚Äôs known only to God <br><br>  You can fight this in different ways, someone uses scripts like <a href="http://habrahabr.ru/post/88624/">htb.init</a> , someone writes shaping scripts on their own and <a href="http://habrahabr.ru/post/119611/">shares successful experiences on Habr√©</a> , and some <a href="http://habrahabr.ru/post/51442/">use PHP</a> to limit the speed of uploading files.  Just imagine what the overhead projector and memory consumption will be when using PHP for such purposes. <br><a name="habracut"></a><br>  At the moment, Nginx does not know how to limit the speed for IP and only does this during individual sessions.  What does this mean?  If the administrator has set a speed limit of 100 KB / s in the config, then by creating 10 connections to the server, you can get a speed of 1 MB / s, which does not fit into the administrator's plans.  To achieve the desired means of Nginx itself can only set a limit, for example 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">http</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">limit_conn_zone</span></span> <span class="hljs-variable"><span class="hljs-variable">$binary_remote_addr</span></span> zone=perip:<span class="hljs-number"><span class="hljs-number">10m</span></span>; <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /download/ { <span class="hljs-attribute"><span class="hljs-attribute">limit_conn</span></span> perip <span class="hljs-number"><span class="hljs-number">1</span></span>; } } }</code> </pre> <br>  which will not allow you to create more than 1 connection from a single IP address.  However, in practice, using such a restriction on the server makes little sense, because thousands of users can hide behind one IP address, and if the network connection is unstable, the user runs the risk of not getting access to the file. <br><br>  But, as it turned out, not everything is so gloomy and there is a way out of the situation.  This is a simple little <b>yaoweibin</b> module called <a href="https://github.com/yaoweibin/nginx_limit_speed_module">nginx_limit_speed_module</a> .  Let's take a look at how this module works: <br><br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">http</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">limit_speed_zone</span></span> one <span class="hljs-variable"><span class="hljs-variable">$binary_remote_addr</span></span> <span class="hljs-number"><span class="hljs-number">10m</span></span>; <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /download/ { <span class="hljs-attribute"><span class="hljs-attribute">limit_speed</span></span> one <span class="hljs-number"><span class="hljs-number">100k</span></span>; } } }</code> </pre><br>  The limit_speed directive sets the total speed for all connections from the same IP address.  For example, if a speed limit of 100 Kb / s is set, and the user downloads a file into 10 streams, the download speed for each individual stream will be 10 Kb / sec (100k / 10).  Notice, this is without any dancing with shaping in Linux and no perversions using PHP.  Convenient, simple and clear.  In my opinion, this is exactly how it should be, but for some reason this port is still not in Nginx ‚Äúout of the box‚Äù for which I would like to throw a big such pebble into the Nginx garden. <br><br>  To build Nginx with this great module, just add the following entry to the ./configure parameters: <br><br> <code>--add-module=/    /nginx_limit_speed_module</code> <br> <br>  For example: <br><br> <code>./configure --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-http_ssl_module --with-http_realip_module --with-http_addition_module --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_stub_status_module --with-http_auth_request_module --with-file-aio --with-ipv6 --with-http_spdy_module --add-module=/root/nginx_limit_speed_module --with-cc-opt='-O2 -g -pipe -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -m64 -mtune=generic'</code> <br> <br>  I will not dwell on building Nginx in detail; quite a few articles have already been written on this topic.  As a brief guide to the assembly, you can use <a href="http://goo.gl/8PbvpK">this instruction</a> . <br><br>  The module page on GitHub: <a href="https://github.com/yaoweibin/nginx_limit_speed_module">https://github.com/yaoweibin/nginx_limit_speed_module</a> </div><p>Source: <a href="https://habr.com/ru/post/226975/">https://habr.com/ru/post/226975/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../226965/index.html">Zen Diary - a personal diary with the ability to encrypt</a></li>
<li><a href="../226967/index.html">On the prerequisites of the socialist revolution in copyright</a></li>
<li><a href="../226969/index.html">Each by Landing Page. Sore</a></li>
<li><a href="../226971/index.html">Safe and smart web server on debian 7</a></li>
<li><a href="../226973/index.html">Live debian</a></li>
<li><a href="../226977/index.html">Listening Ukrainian mobile phones: how it is done and how to protect</a></li>
<li><a href="../226979/index.html">Google Web Starter Kit: Mobile Website Builder</a></li>
<li><a href="../226981/index.html">"Dauria" in space</a></li>
<li><a href="../226983/index.html">A simple way to monitor the response time of Sphinx indexes using Zabbix</a></li>
<li><a href="../226985/index.html">"Epson Printing Factory" and a laser printer: break stereotypes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>