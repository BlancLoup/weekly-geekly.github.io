<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Defending Revel from CSRF attacks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After playing with Revel and realized what kind of freak it is, it's time to learn how to prepare it for production in terms of security. This note ma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Defending Revel from CSRF attacks</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/8ae/57a/b1d/8ae57ab1d38643479f5e281abfe638cb.png"><br><br>  After <a href="http://habrahabr.ru/post/162115/">playing with Revel</a> and realized what kind of freak it is, it's time to learn how to prepare it for production in terms of security.  This note may well be used in any web application, but I will tell on the example of a simple application on Revel. <br><a name="habracut"></a><br>  In general, the problem lies in the fact that there is a class of attacks on the Internet called Cross-Site Request Forgery (abbr. CSRF).  If you are not familiar with them, please turn your attention.  I will give a short excerpt from the wiki: <br><br><blockquote>  CSRF is a type of attack on website visitors that uses the disadvantages of the HTTP protocol.  If the victim enters the site created by the attacker, a request is secretly sent to another server (for example, to the server of the payment system), performing some kind of malicious operation (for example, transferring money to the attacker's account).  To carry out this attack, the victim must be authenticated on the server to which the request is sent, and this request must not require any confirmation from the user, which cannot be ignored or forged by the attacking script. </blockquote><br><img src="https://habrastorage.org/files/2f5/c70/cdb/2f5c70cdbc4c43499a8f543960edb370.png">  <i>rice</i>  <i>An example of a CSRF attack on a bank site</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I also recommend reading <a href="http://habrahabr.ru/post/235247/">typical errors when protecting sites from CSRF attacks</a> . <br><br>  On a fresh Revel application, the CSRF attacks successfully pass because  there is no protection initially. <br><br><h4>  So, let's start kutit with gopher - installation protection </h4><br>  Comrades from Revel offer us a ready-made module to protect <a href="https://github.com/revel/modules/tree/master/csrf/app">github.com/revel/modules/tree/master/csrf/app</a> with installation instructions: <br><blockquote>  CsrfFilter enables CSRF request token creation and verification. <br><br>  Usage: <br>  1) Add `csrf.CsrfFilter` to the app's filter (it must come after the revel.SessionFilter). <br>  2) Add CSRF fields with the template tag `{{csrftoken.  }} `.  The filter adds it a little bit.  Ajax support provided through the `X-CSRFToken` header. <br></blockquote><br>  Actually everything is OK!  Added a filter in the init.go application for this instruction ... And it will not work unless your browser sends <a href="https://ru.wikipedia.org/wiki/HTTP_referer">Referer</a> in the <a href="https://ru.wikipedia.org/wiki/HTTP_referer">header</a> .  Therefore, we will skip the entire installation of this filter in this note and proceed to an alternative option. <br><br>  One of the options proposed <a href="https://github.com/revel/revel/issues/788">in the Revel bug tracker on CSRF</a> was a project: <a href="https://github.com/cbonello/revel-csrf">github.com/cbonello/revel-csrf</a> .  The installation principle is simple: <br><br>  First, we pump everything into GOPATH <br><pre><code class="bash hljs">go get github.com/cbonello/revel-csrf</code> </pre> <br><br>  Next in /app/init.go we add a line to the import section: <br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"github.com/cbonello/revel-csrf"</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/revel/revel"</span></span> )</code> </pre><br><br>  And in the init () function in the same file /app/init.go we add this filter: <br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// Filters is the default set of global filters. revel.Filters = []revel.Filter{ ... revel.SessionFilter, // Restore and write the session cookie. revel.FlashFilter, // Restore and write the flash cookie. HeaderFilter, // Add some security based headers csrf.CSRFFilter, // CSRF prevention. &lt;---------------------------- revel.ValidationFilter, // Restore kept validation errors and save new ones from cookie. ... } ... }</span></span></code> </pre><br><br>  Installation is almost ready!  Now all methods except GET, HEAD, OPTIONS, TRACE, WS are considered ‚Äúunsafe‚Äù and in the absence of the generated token in the request there will be 403 errors. <br><br><h4>  How to transfer a token </h4><br>  Basic unsafe requests are generated using web forms.  Accordingly, logchino now insert a hidden field containing a token into each form: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"login-form"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-vertical"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{url "</span></span></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">App.ConfirmLogin</span></span></span><span class="hljs-tag">"}}" </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"post"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"csrf_token"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{.csrf_token }}"</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  For simplicity, you can take the function for the template engine from the module from the Revel command. <br><br>  Most actions are solved this way - by embedding a hidden field in a web form.  But there is a category of actions that do not require sending a web form, but are unsafe from a business logic point of view.  For example: user logon link / logout.  To carry out an attack on such an action is very simple, therefore, the processing of such an action must be transferred from the secure GET method to the POST method, which is unsafe for us.  To do this, in the / conf / routes file we add our action only for the POST method: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">POST</span></span> /logout App.Logout</code> </pre><br><br>  Now you need to make the links suitable for working with POST methods.  For such cases, you can use a good wrapper for working with ajax in RoR: <a href="https://github.com/rails/jquery-ujs">github.com/rails/jquery-ujs</a> <br><br>  Install to your project through Bower: <br><pre> <code class="bash hljs">$ bower install jquery-ujs --save</code> </pre><br>  And connect it to your template.  I will not write the details here as I do, I have an assembly through Grunt and the connection of already assembled scripts.  I hope you will not make this work;) <br><br>  After connecting, you need to add a couple more lines to the header so that the library understands which token to send: <br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ru"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"csrf-token"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{.csrf_token}}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"csrf-param"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"csrf_token"</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> ...</code> </pre><br><br>  After that, it is worthwhile to include another filter support for Ajax (disabled by default). To do this, add the following to the /conf/app.conf file: <br><pre> <code class="hljs objectivec">csrf.ajax = <span class="hljs-literal"><span class="hljs-literal">true</span></span> csrf.token.length = <span class="hljs-number"><span class="hljs-number">64</span></span></code> </pre><br>  The second line here changes the length of the token, by default it is only 32 characters.  The length can range from 32 to 512 characters. <br><br>  If everything is connected correctly, then now you can make such secure links that will make the POST request method: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{url "</span></span></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">App.Logout</span></span></span><span class="hljs-tag">"}}" </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"post"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  I have it all.  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/274457/">https://habr.com/ru/post/274457/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274447/index.html">Emsisoft Specialists Discovered Javascript Extortionist</a></li>
<li><a href="../274449/index.html">Own search by hand rutracker.org - implementation on Yii2</a></li>
<li><a href="../274451/index.html">Expansion of sections without data loss</a></li>
<li><a href="../274453/index.html">Black Hat USA 2015: the full story of the hacking of the very Jeep</a></li>
<li><a href="../274455/index.html">Creating a function on Rust that accepts a String or & str</a></li>
<li><a href="../274461/index.html">The tale of the compressor, which can be called, but I do not remember how</a></li>
<li><a href="../274463/index.html">We write DXE-driver for taking screenshots from BIOS Setup and other UEFI-applications</a></li>
<li><a href="../274469/index.html">BlackEnergy Trojan is used in cyber attacks on media and industrial facilities in Ukraine</a></li>
<li><a href="../274471/index.html">Multiplication tables ... kind of</a></li>
<li><a href="../274473/index.html">Draw Elliptic Curves with SQL</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>