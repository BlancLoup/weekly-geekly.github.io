<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unpacking Perl2Exe</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the most commonly used products for creating standalone applications from perl scripts and organizing some kind of protection is IndigoStar Per...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unpacking Perl2Exe</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/2c2/b90/f16/2c2b90f163e98d9f994be6e742055c34.jpg"><br><br>  One of the most commonly used products for creating standalone applications from perl scripts and organizing some kind of protection is <a href="http://www.indigostar.com/perl2exe.php">IndigoStar Perl2Exe</a> .  Periodically, there are situations when the source code of the script is lost, and in the hands there is only an exe-file obtained using this program, but without fail I want to get to the samples.  We will understand how to do it. <br><a name="habracut"></a><br>  To begin with, we will download the product itself (the further description is based on <a href="">Perl2Exe V11.00 for Windows</a> ) and use it for its intended purpose - we will turn the attached script sample.pl into a full-fledged exe-file.  To do this, enter the simple perl2exe command sample.pl into the console, or simply drag sample.pl to perl2exe in the explorer. <br>  So, we have sample.exe, which needs to be examined for the possibility of extracting source code.  Let's start with the banal: <br>  Take any hex editor and try to search for script code elements in the body of the file.  In vain, apparently, the code is stored in a packed / encrypted form, which is quite logical. <br><br>  We use the <a href="http://www.rohitab.com/apimonitor">API Monitor</a> utility and analyze the accesses to files that sample.exe makes after launching (as an alternative, you can use <a href="http://technet.microsoft.com/en-us/sysinternals/bb896645.aspx">Process Monitor</a> by Mark Russinovich).  To do this, we note in the list of intercepted functions CreateFileA, CreateFileW, press Ctrl + H and specify the process in the context of which the observation will be conducted. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/d12/060/c26/d12060c261e1410ff01b3d5129e0ec1a.png"></a> <br><br>  Again miss, intermediate files for storing the source code of the script in a readable form are not used. <br><br>  Well, we will arm ourselves with a debugger and proceed to a cursory study of the internal structure of the program.  The goal is to determine whether the code of interest appears in the memory of the process in open form, and at what stage of the program it will be easiest to intercept and copy it.  In this case, I would prefer to use <a href="http://ollydbg.de/">OllyDbg</a> , but in general, almost any debugger would work, for example, WinDbg, IDA or, say, Syser. <br>  We load the program into the debugger and observe the standard CRT shny prolog. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/e2c/618/1c2/e2c6181c21cbb33ccd20dae8f710d31b.png"></a> <br><br>  Without really thinking about it, we press F5 - the program successfully works, we are thrown into the depths of ntdll.  Open the process memory (Alt + M) and look for some piece of the script, for example, the string "This is sample".  Voila, we find the source code in memory.  It is worth noting that this approach is unreliable, because by the time the program is finished, the data of interest to us could have been erased in memory, which is the right approach from a security point of view (say, the master password in the Firefox browser cannot be found after some time in mind). <br>  Find out after what stage this code appears in memory.  Let's skip the CRT shno intro and move on to the study of the first significant part of the code. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/1eb/a33/09b/1eba3309b63a9ad72f3d30418e6f0b95.png"></a> <br><br>  We observe the loading of the p2x5142.dll dynamic library file, obtaining the address of the exported RunPerl function and its call.  Having carried out simple manipulations, we find that the sacrament of interest to us occurs inside RunPerl.  We examine its contents. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/7ba/223/8ba/7ba2238ba322e13f14319f91ead5958e.png"></a> <br><br>  Appeals to WinAPI functions do not interest us, but there is a curious sequence of calls to functions with the perl prefix (Perl_sys_init3, perl_alloc, perl_contruct, perl_parse, perl_run, ...), and, having conducted an investigative experiment, we find out that the code appears in memory in open form after calling perl_parse.  Let's see what is inside perl_parse.  Great, again a bunch of function calls with the perl prefix and other crap, the study of which is impeded by natural laziness and the excuse "yes, I write this article in general while sitting on the bus." <br>  Let's go the other way.  We run the program a couple of times and make sure that the memory for the source code of the script is allocated in the same place (which is again an unreliable approach, and it would be more logical to intercept the functions malloc, free and analyze the addressable areas).  Put a breakpoint on it to find the code responsible for recording data at the address of interest to us. <br>  Restart the program and drop out somewhere here: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/3d9/0d1/7fb/3d90d17fb038612e71952ffa979e4491.png"></a> <br><br>  But intercepting data in the middle of a cycle is probably not the best choice.  Let's see what we have before returning from a function. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/006/5b9/248/0065b924849c970fe9e66b10634695ad.png"></a> <br><br>  But this more than suits us.  In the ebx register and the stack, we see the addresses pointing to the memory region with the source code of interest.  Let's write down the virtual address of the instruction retn in a notebook, look at the address where the p2x5142.dll was loaded into the memory.  We subtract one from the other and get an offset, which is useful later. <br><br>  Now it would be nice to automate this process.  To do this, we will write a simple library, which we will load into the sample.exe memory.  The library itself will install a vector exception handler, track the moment when the library p2x5142.dll is loaded into memory, replace the retn instruction with <a href="http://ru.wikipedia.org/wiki/Int3">int3</a> using the <a href="http://ru.wikipedia.org/wiki/Int3">offset</a> received earlier and dump the contents of the memory addressed by the register to a file. <br>  In order not to write the code of the library's injecting in a new way, we will use the class that I once wrote, having mastered some part of the ‚ÄúC ++ for 21 Day‚Äù book.  <a href="http://kaimi.ru/2011/07/cpp-injector-class/">Here it is</a> .  <s>Its size should be ... about the thickness of the thumb.</s>  <s>That's about this.</s>  We will also use Microsoft's <a href="http://research.microsoft.com/en-us/projects/detours/">Detours</a> library to intercept the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms684175%2528v%3Dvs.85%2529.aspx">LoadLibrary</a> call.  Of course, it would be possible to refer to the <a href="http://kaimi.ru/2010/08/your-own-injector/">developments in MASM</a> on this topic, but, unfortunately, Friday is not a day of programming in low-level languages.  Let's start writing.  Let's start with the launcher program, which will run sample.exe in the suspended state, inject the library into the created process and resume its work. <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    #include &lt;iostream&gt; #include &lt;Windows.h&gt; #include "injector.hpp" using namespace std; //       //     ,   ,       wstring str2wstr(const char * aIn); int main(int argc, char *argv[]) { //       ,     if(argc != 3) { cout&lt;&lt;"Usage: launcher sample.exe inject.dll"&lt;&lt;endl; return 1; } //   STARTUPINFO si = {0}; PROCESS_INFORMATION pi = {0}; //  ,      // CREATE_SUSPENDED   ,      ""  if(CreateProcess(str2wstr(argv[1]).c_str(), NULL, NULL, NULL, FALSE, CREATE_SUSPENDED, NULL, NULL, &amp;si, &amp;pi) == 0) { cout&lt;&lt;"Failed to create process"&lt;&lt;endl; return 1; } //    injector injector a; //     (     ) a.set_blocking(false); try { //       a.inject(pi.dwProcessId, str2wstr(argv[2])); } catch(const injector_exception &amp;e) { //  -   ,         e.show_error(); CloseHandle(pi.hThread); CloseHandle(pi.hProcess); TerminateProcess(pi.hProcess, 1); return 1; } //    ResumeThread(pi.hThread); //  ,      CloseHandle(pi.hThread); CloseHandle(pi.hProcess); return 0; }</span></span></code> </pre> <br><br>  Let's go to the source code of the library. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//   #include &lt;iostream&gt; #include &lt;sstream&gt; #include &lt;fstream&gt; #include &lt;Windows.h&gt; #include "detours.h" #pragma comment(lib, "detours.lib") using namespace std; // ,        static unsigned int i = 0; //   ,     int3 static const DWORD retn_offset = 0xB40E9; static const wstring dump_directory = L"dump"; static const wstring file_prefix = L"src_"; static const wstring perl_dll_name = L"p2x5142.dll"; //  ANSI ?      (   ) HMODULE (WINAPI * real_loadlibrary)(LPCSTR lpFileName) = LoadLibraryA; //  ,     string wstr2str(const wchar_t * aIn); //    void hook() { //  ,       void * base_address = GetModuleHandle(perl_dll_name.c_str()); if(base_address == NULL) return; DWORD pr; //      base_address = reinterpret_cast&lt;void *&gt;(reinterpret_cast&lt;DWORD&gt;(base_address) + retn_offset); //    ,  int3,    VirtualProtect(base_address, 1, PAGE_READWRITE, &amp;pr); CopyMemory(base_address, "\xCC", 1); VirtualProtect(base_address, 1, pr, &amp;pr); } // ,      void dump_data(char * buffer, unsigned int size) { DWORD pr; wstringstream ss; //      ss &lt;&lt; dump_directory &lt;&lt; L"\\" &lt;&lt; file_prefix &lt;&lt; i++ &lt;&lt; L".txt"; ofstream file(ss.str(), ofstream::binary); file.exceptions(0); if(file.is_open()) { //        VirtualProtect(buffer, size, PAGE_READONLY, &amp;pr); file.write(buffer, size); VirtualProtect(buffer, size, pr, &amp;pr); file.close(); } } // ,     LoadLibraryA HMODULE WINAPI my_loadlibrary(LPCSTR lpFileName) { HMODULE h = real_loadlibrary(lpFileName); //    ,    if ( strstr(lpFileName, wstr2str(perl_dll_name.c_str()).c_str()) &amp;&amp; i == 0 ) { i++; hook(); } return h; } //   ,     int3 LONG CALLBACK VEH(PEXCEPTION_POINTERS ExceptionInfo) { if ( //   ,   Eax   ,   Ebx    ExceptionInfo-&gt;ContextRecord-&gt;Eax &gt; 0 &amp;&amp; ExceptionInfo-&gt;ContextRecord-&gt;Eax &lt; 0xFFFFF &amp;&amp; //      -  ,     "" //         ExceptionInfo-&gt;ContextRecord-&gt;Ebx &lt; 0x77000000 &amp;&amp; ExceptionInfo-&gt;ContextRecord-&gt;Ebx &gt; reinterpret_cast&lt;DWORD&gt;(GetProcessHeap()) ) dump_data(reinterpret_cast&lt;char *&gt;(ExceptionInfo-&gt;ContextRecord-&gt;Ebx), ExceptionInfo-&gt;ContextRecord-&gt;Eax); //   Eip            4  // ,  ,   retn ExceptionInfo-&gt;ContextRecord-&gt;Eip = *reinterpret_cast&lt;DWORD *&gt;(ExceptionInfo-&gt;ContextRecord-&gt;Esp); ExceptionInfo-&gt;ContextRecord-&gt;Esp += sizeof(DWORD); //    -    return EXCEPTION_CONTINUE_EXECUTION; } BOOL WINAPI DllMain(HINSTANCE hinst, DWORD dwReason, LPVOID reserved) { if(dwReason == DLL_PROCESS_ATTACH) { //       CreateDirectory(dump_directory.c_str(), NULL); AddVectoredExceptionHandler(1, VEH); //         detours DetourRestoreAfterWith(); DetourTransactionBegin(); DetourUpdateThread(GetCurrentThread()); DetourAttach(&amp;reinterpret_cast&lt;PVOID &amp;&gt;(real_loadlibrary), my_loadlibrary); DetourTransactionCommit(); } else if(dwReason == DLL_PROCESS_DETACH) { DetourTransactionBegin(); DetourUpdateThread(GetCurrentThread()); DetourDetach(&amp;reinterpret_cast&lt;PVOID &amp;&gt;(real_loadlibrary), my_loadlibrary); DetourTransactionCommit(); } return TRUE; }</span></span></code> </pre><br><br>  It remains only to test the resulting solution. <br><br> <a href=""><img src="http://kaimi.ru/wp-content/uploads/2012/08/result-300x125.png"></a> <br><br>  As you can see, everything went great.  We reached the goal. <br>  <a href="https://kaimi.ru/2011/08/unpacking-perlapp/">Those</a> interested can also see a similar <a href="https://kaimi.ru/2011/08/unpacking-perlapp/">example of unpacking PerlApp</a> . <br><br>  Source code from the article: <a href="">download</a> </div><p>Source: <a href="https://habr.com/ru/post/149015/">https://habr.com/ru/post/149015/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../149006/index.html">We do it yourself Single-Side Arduino with a COM port on board</a></li>
<li><a href="../149007/index.html">Destructive printers for the healthcare modernization program</a></li>
<li><a href="../149010/index.html">Masking numeric values ‚Äã‚Äãusing autoNumeric and Knockout</a></li>
<li><a href="../149012/index.html">Labeled pointers, or how to fit an object in one inte</a></li>
<li><a href="../149014/index.html">Background Image Design of the Start Screen in Windows 8</a></li>
<li><a href="../149016/index.html">How can Inkscape be useful for web developers?</a></li>
<li><a href="../149017/index.html">Siemens builds a very large wind turbine</a></li>
<li><a href="../149019/index.html">Stock robot in 45 minutes led to a loss of 440 million dollars</a></li>
<li><a href="../149026/index.html">Visualization of the board made in EAGLE using Photoshop</a></li>
<li><a href="../149027/index.html">Do you use cloud storage to back up data on your servers?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>