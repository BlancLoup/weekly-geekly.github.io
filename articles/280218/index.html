<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Redis - which is faster, UNIX socket or TCP? What is more stable? + pconnect</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We at PushAll process several thousand requests per second to get delivery statistics and open notifications and to send content alerts. A regular dat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Redis - which is faster, UNIX socket or TCP? What is more stable? + pconnect</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/ceb/21f/a15/ceb21fa1539a0fcbf482cff0e5224a55.png" alt="image"><br><br>  We at PushAll process several thousand requests per second to get delivery statistics and open notifications and to send content alerts.  A regular database like MySQL cannot cope with such a flow of queries and cannot respond so quickly. <br><br>  Trying to transfer more and more operations to fast NoSQL repositories like Redis, we want to know how to use it more efficiently and whether we will have problems with a large number of connections. <br>  We also use PHP forks to work with, and we wondered how Redis would behave if we made several thousand connections in several threads simultaneously.  We decided to share our tests with the community. <br><a name="habracut"></a><br><h1>  Iron </h1><br>  We are testing on one of the VPS PushAll: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      CPU: Intel Xeon E5-1650v2 3.5 Ghz - 2 cores. <br>  RAM: 3 Gb DDR3 1866Mhz <br><br>  PHP7. <br>  Redis 3.0.7 <br><br><h1>  Test conditions </h1><br>  We wrote a PHP multithreaded bot that: <br><br><ul><li>  Makes forks in a cycle - 100 forks without any delays </li><li>  Each fork in its cycle creates a connection with Redis 1000 times and produces an increment </li><li>  The parent process waits for 3 seconds and takes the value, if not wait - Redis will not return the full value of the encerement </li></ul><br><br>  We also tested the version with 1000 forks and how the results will differ when using UNIX-socket and TCP. <br><br><h4>  100 forks, 1000 connections each, TCP </h4><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># time php benchmark.php End:100000 real 0m8.666s user 0m0.063s sys 0m0.073s</span></span></code> </pre> <br><br><h4>  100 forks, 1000 connections each, UNIX socket </h4><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># time php benchmark.php End:100000 real 0m6.021s user 0m0.023s sys 0m0.067s</span></span></code> </pre><br><br>  TCP socket is on average 30% slower.  (remember, it‚Äôs not Redis performance itself that is being tested anymore, but how it handles connections) <br><br><h4>  1000 forks, 1000 connections each, TCP + UNIX </h4><br>  Raise the stakes <br><br>  TCP: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># time php benchmark.php End:903505 real 1m7.659s user 0m0.073s sys 0m0.753s</span></span></code> </pre><br>  For 3 seconds, Redis did not have time to process them to the end - this is one of the details that must be taken into account.  If you read the values ‚Äã‚Äãtoo quickly, you can catch a moment when they are still old. <br><br>  What is most interesting, when conducting the same test, but for a unix-socket, we get errors: <br><pre> <code class="bash hljs">Fatal error: Uncaught RedisException: Redis server went away <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ....</code> </pre><br>  That is, in spite of the fact that it is faster, a unix-socket can handle a slightly smaller number of requests.  Or, alternatively, it is possible that because of the fact that it is so fast, the Redis server itself cannot cope. <br><br>  We conducted similar tests for php-fpm - there also a TCP socket gave fewer errors with a bundle with NGINX than a UNIX socket.  The difference in speed was insignificant there. <br><br>  Attaching the script: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span>(ticks = <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>($i=<span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; <span class="hljs-number"><span class="hljs-number">1000</span></span>; $i++){ $pid = pcntl_fork(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($pid == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(<span class="hljs-string"><span class="hljs-string">'could not fork'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($pid) { <span class="hljs-comment"><span class="hljs-comment">//parent } else { //child for ($a=0; $a &lt; 1000; $a++) { $redis = new Redis(); //$redis-&gt;connect('127.0.0.1:6379'); $redis-&gt;connect('/run/redis/redis.sock'); $redis-&gt;incr('pushall:benchmark'); $redis-&gt;close(); } exit; } } pcntl_wait($status); //wait sleep(3); $redis = new Redis(); $redis-&gt;connect('/run/redis/redis.sock'); echo 'End:'.$redis-&gt;get('pushall:benchmark')."\r\n"; $redis-&gt;setTimeout('pushall:benchmark', 1); $redis-&gt;close();</span></span></code> </pre><br><br><h1>  UPD pconnect </h1><br>  It turns out pconnect works in forks (strange) <br><br>  Took the case of 100 TCP processes: <br>  pconnect <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># time php benchmark.php End:100000 real 0m4.679s user 0m0.023s sys 0m0.080s</span></span></code> </pre><br><br>  connect <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># time php benchmark.php End:100000 real 0m9.100s user 0m0.037s sys 0m0.103s</span></span></code> </pre><br><br>  For comparison, UNIX socket on 100 forks: <br>  pconnect <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># time php benchmark.php End:100000 real 0m4.393s user 0m0.023s sys 0m0.073s</span></span></code> </pre><br><br>  connect <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># time php benchmark.php End:100000 real 0m6.002s user 0m0.027s sys 0m0.057s</span></span></code> </pre><br><br>  And, interestingly, when using pconnect, the difference between TCP and UNIX sockets is not so big 5-10%.  At the same time, even having done everything that I was offered in the comments - I could not get the unix-sockets to work with 1000 forks. <br><br><h1>  UPD 2 Pconnect + 1000 forks </h1><br><br>  UNIX socket <br>  pconnect <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># time php benchmark.php End:1000000 real 0m35.445s user 0m0.050s sys 0m0.637s</span></span></code> </pre><br>  connect - crashes in Fatal error: Uncaught RedisException: Redis server went away in ... <br><br>  Tcp <br>  pconnect <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># time php benchmark.php End:989596 real 0m43.711s user 0m0.050s sys 0m0.623s</span></span></code> </pre><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># time php benchmark.php End:903505 real 1m7.659s user 0m0.073s sys 0m0.753s</span></span></code> </pre><br>  The difference is 20%. <br><br>  Ps.  Habr, why is there a MongoDB hub and MySQL, but not Redis? </div><p>Source: <a href="https://habr.com/ru/post/280218/">https://habr.com/ru/post/280218/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280208/index.html">Distributed nature of Tox Messenger</a></li>
<li><a href="../280210/index.html">About Go functionality</a></li>
<li><a href="../280212/index.html">Do not miss js-error</a></li>
<li><a href="../280214/index.html">Silicon Framework - WebAPI on C ++</a></li>
<li><a href="../280216/index.html">Finger Math: The Mendo Engine and the Irnshaw Theorem</a></li>
<li><a href="../280222/index.html">Automated testing of the basic accessibility of interfaces for Android applications</a></li>
<li><a href="../280224/index.html">Caller ID handling and distinctive 3CX Phone System call</a></li>
<li><a href="../280228/index.html">Drupal licensing FAQ</a></li>
<li><a href="../280232/index.html">Microsoft DevCon 2016 - computer vision, SQL Server 2016, Data Science and more</a></li>
<li><a href="../280234/index.html">Rules for working with Tasks API. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>