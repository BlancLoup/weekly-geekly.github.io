<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Static analysis of the HPX library with PVS-Studio</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is a translation of Hartmut Kaiser's blog post about the experience of using PVS-Studio on the HPX - C ++ library for distributed / paral...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Static analysis of the HPX library with PVS-Studio</h1><div class="post__text post__text-html js-mediator-article">  This article is a translation of Hartmut Kaiser's <a href="http://stellar-group.org/2015/07/hpx-and-pvs-studio/">blog post</a> about the experience of using PVS-Studio on the <a href="http://stellar-group.org/libraries/hpx/">HPX</a> - C ++ library for distributed / parallel computing of any scale. <br><br>  Once we already used the trial version of the PVS-Studio analyzer for HPX, and then it was remembered to us by its verbosity.  Recently, there have been many articles about this utility, and, because  A lot of time has passed since its use, we decided to contact the developers in order to find out if they are ready to support our open-source product.  We were very happy when we received a license for 1 year in exchange for an article about the problems found. <br><a name="habracut"></a><br><h4>  General impressions </h4><br>  <a href="http://www.viva64.com/en/pvs-studio-download/">After</a> downloading <a href="http://www.viva64.com/en/pvs-studio-download/">PVS-Studio V5.26</a> , I didn‚Äôt have any problems installing it as an extension for Visual Studio 2013 Professional, although I would prefer to test it with the 2015RC1 version - my main development environment.  Unfortunately, at the moment VS 2015 is not supported, but I hope this will happen soon after the new release from Microsoft. <br><br>  The integration of PVS-Studio into Visual Studio made a very good impression.  One additional menu button provides access to all commands and options.  All diagnostic messages are displayed in a special window from which you can directly go to the source code.  You can also open a web-based context-sensitive help, explaining each of the diagnostics separately.  All as I would like. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Messages have 3 different levels of importance (severity levels): high, medium and low, and, in turn, are grouped into 3 categories of analysis: general, optimization and analysis of 64-bit compatibility.  The user interface allows you to limit the displayed diagnostics and filter the result.  For the main HPX module, the analyzer generated about 70 messages from approximately 1000 .h and .cpp files (~ 140,000 lines of code), which was, in my opinion, not bad (high severity: 5, medium: 44, low: 21).  The initial analysis on my laptop took about 10 minutes. <br><br><h4>  Error examples </h4><br>  I eagerly wanted to see hidden bugs in HPX.  Our team is very sensitive to the quality of the code, and each pool of requests is reviewed by at least one developer before the merge in the main branch.  So I was sure that the analyzer could not find anything. <br><br>  First, let's look at high-severity errors.  Four of them were very similar and had a common nature: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Archive&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Archive&amp; ar)</span></span></span><span class="hljs-function"> </span></span>{ actions::manage_object_action_base* act = <span class="hljs-number"><span class="hljs-number">0</span></span>; ar &gt;&gt; hpx::serialization::detail::raw_ptr(act); <span class="hljs-comment"><span class="hljs-comment">// V522: Dereferencing of the null pointer 'act' might take place. HPX_ASSERT(act-&gt;is_valid()); // ... }</span></span></code> </pre> <br><br>  This code deserializes a polymorphic object through a pointer to the base class.  We know that raw_ptr (act) dynamically creates a new object, assigning its address to the passed pointer.  We also know that in case of an error, the function throws an exception.  All this could be visible to the static analyzer, since  The entire serialization module in HPX is located in headers.  The analyzer, apparently, did not see this and generated errors.  Fortunately, you can explicitly tell PVS-Studio to ignore this error with just one click, which will add a magic comment like // - V522 - very convenient.  Moreover, PVS-Studio gives many options for suppressing messages based on files or directories on patterns in file names - all options are easily accessible and well explained. <br><br>  The second mistake alarmed me: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> HPX_VERSION_MAJOR 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> HPX_VERSION_MINOR 9 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> HPX_VERSION_SUBMINOR 11 std::string full_version_as_string() { </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// V609 Mod by zero. Denominator '0' == 0. return boost::str( boost::format("%d.%d.%d") % HPX_VERSION_MAJOR % HPX_VERSION_MINOR % HPX_VERSION_SUBMINOR); }</span></span></span></span></code> </pre><br><br>  To understand what the analyzer wanted to say, it took me some time, because  operator% from Boost.Format for me looked completely inconspicuous.  However, even if operator% was not overloaded, and the code was indeed problematic, the error message would still be obscure.  I ‚Äúsolved‚Äù this problem in the same way - by suppressing the message. <br><br>  The last ‚Äúhigh severity‚Äù message was the result of the optimization: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// V808 'hostname' object of 'basic_string' type was created // but was not utilized. std::string hostname = boost::asio::ip::host_name();</span></span></code> </pre><br><br>  And the analyzer was right, the hostname variable was not used at all in this context.  None of the compilers, which we use for regular testing on more than 20 platforms, have found this before - a great note! <br><br>  Messages of medium and low importance were mainly related to benign problems about 32bit / 64bit compatibility, such as the implicit conversion of sign integers into large unsigned integers (for example, int32_t -&gt; uint64_t). <br><br>  But two errors turned out to be real bugs: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> runtime_support::load_components(util::section&amp; ini) { <span class="hljs-comment"><span class="hljs-comment">// load all components as described in the configuration information if (!ini.has_section("hpx.components")) { // V601 The 'true' value is implicitly cast to the integer type. return true; // no components to load } // ... }</span></span></code> </pre><br><br>  The message itself indicates the problem: once we changed the return type of the function from bool to int, but forgot to change one of the return expressions.  In the future, this could create complex problems for reproduction. <br><br>  Another mistake turned out to be more serious: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">when_each_frame</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">// ... private: // V690 Copy constructor is declared as private in the // 'when_each_frame' class, but the default '=' operator // will still be generated by compiler. It is dangerous // to use such a class. when_each_frame(); when_each_frame(when_each_frame const&amp;); public: // ... };</span></span></code> </pre><br><br>  This is a really good point, especially because we added the constructor declaration as a workaround for older versions of gcc that incorrectly instantiated default implementations. <br><br>  In the end, I was glad to spend time launching the analyzer for the entire HPX code base.  I was glad to see that no serious problems were found, as confirmation of our policy review, which we introduced a long time ago.  I also decided to add PVS-Studio to our contiguous integration process, which starts at every commit. <br><br><h4>  Conclusion </h4><br>  Static analysis definitely matters.  Running utilities like PVS-Studio, although it takes some time and effort, but in my opinion, is the right investment of time and money.  Compilers are not suitable for the deep analysis that PVS-Studio does, since  otherwise, it would significantly increase the compile time. <br><br>  One of the most useful opportunities for us was the easy integration into the CI process.  Since we run our daily tests on various platforms (including Windows), the analysis results are available for developers working under other operating systems (Linux, Mac OS). <br><br>  Another pleased option of PVS-Studio is to launch an analysis every time after a successful project build.  Surprisingly, this does not add much overhead to the normal build process, and also gives feedback to subtle code problems at the very early stages of implementation.  I left the option enabled to evaluate the utility of the tool in the process. <br><br>  While analyzing the generated messages, I was surprised that, even though the utility has time to analyze as deeply as possible, PVS-Studio could not analyze the overloads of certain operators to determine the non-default semantics.  An example with the operator% from Boost.Format demonstrated this.  I agree - this is indeed a very delicate moment, and I am not sure that it is possible to provide the correct diagnosis in this case.  On the other hand, it is here, in an in-depth analysis of the semantics of the code, the tool must have all the power. <br><br>  If you are interested in HPX, forknit the library with <a href="https://github.com/STEllAR-GROUP/hpx">github</a> . </div><p>Source: <a href="https://habr.com/ru/post/262455/">https://habr.com/ru/post/262455/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262443/index.html">A simple replacement for Boost :: Optional for using nullable types in C ++ projects</a></li>
<li><a href="../262445/index.html">Facebook World Data Analysis</a></li>
<li><a href="../262447/index.html">Event for university teachers in St. Petersburg on programming training</a></li>
<li><a href="../262451/index.html">Practical task with the analysis of the solution</a></li>
<li><a href="../262453/index.html">Overview of application frameworks on symfony2</a></li>
<li><a href="../262457/index.html">Programming Philosophy 7 - practicality</a></li>
<li><a href="../262459/index.html">Hackers got to the Patriot missiles?</a></li>
<li><a href="../262461/index.html">Choice between C ++ and C #</a></li>
<li><a href="../262465/index.html">Integrating Jira and Slack for PHP</a></li>
<li><a href="../262467/index.html">Stop shot. Recorded and transmitted</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>