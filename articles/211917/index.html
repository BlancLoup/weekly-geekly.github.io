<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Data backup with btrfs and LVM bash scripts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There have already been a lot of posts about backups, especially a lot for Linux. I also took care of setting up a backup. 
 It was necessary to creat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Data backup with btrfs and LVM bash scripts</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/ce0/59a/2f0/ce059a2f04e49e6b79d79c60a9126abd.jpg" alt="image"><br><br>  There have already been a lot of posts about backups, especially a lot for Linux.  I also took care of setting up a backup. <br>  It was necessary to create system backups, data from the mounted partition and LVM volumes (virtual machine disks).  There were thoughts to use Bacula, because  familiar with it, but since at home only 1 computer client-server architecture would only create additional difficulties when restoring in case of damage to the system.  It means that we simply copy the system and data, we create the image of the LVM partition using dd.  I wanted to make a backup every day (at least data) and store at least 14 days.  But the search for ready-made and simple solutions that satisfy all needs were not crowned with success.  So take the bash and write your bike.  In this article, I share what happened. <br><a name="habracut"></a><br>  <i>Disclaimer: when writing scripts there was no goal to write monsters that do everything.</i>  <i>I needed a simple and reliable way to backup.</i>  <i>I would be grateful for pointing out inaccuracies and bottlenecks of scripts (those where errors may occur).</i>  <i>The article is intended more for newbies in Linux, who are looking for a ready-made solution and for lazy people, :) who are too lazy to write themselves.</i> <br><br><h5>  Initial conditions: </h5><br><ul><li>  OS: Arch Linux </li><li>  Root file system (/): btrfs, you need to copy all files. </li><li>  Data partition (/ mnt / data /): btrfs. </li><li>  LVM volumes (/ dev / virt_image_array / *). </li><li>  Section for backups (/ mnt / backup /: etx4, backups will be added here. </li><li>  Required utilities (except those included in the base distr): rsync, btrfs-progs (for managing btrfs). </li></ul><br>  It was decided once a week to make a full copy of everything and create snapshots of btrfs sections every day.  You can also create snapshots of LVM volumes, but for me the loss of data for the week is not critical, so weekly copies will suffice. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, script number 1, creates a copy of the root partition files in / mnt / backup / root / "day number" /. <br><br><div class="spoiler">  <b class="spoiler_title">Script number 1</b> <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash set -e echo "Date_start: `date +%Y-%m-%d-%H-%M-%S`" #     ### Vars ### #     (1970 ) day=$((`date +%s` / (60*60*24))) #    dayexp=21 #  path="/" #  (  ) spath="/snapshots/backup_script/" #  dpath="/mnt/backup/root/" ### Delete Old Backups ### #   find $dpath -maxdepth 1 -type d -mtime +$dayexp -exec rm -rf {} \; ### Check exist snapshot ### #  , ,   if (( "`btrfs subvolume list $path | grep backup_script |wc -l`" &gt; 0 )) then echo "Warning: Snapshot exist, deleting" btrfs subvolume delete $spath fi ### Create snapshot ### #  btrfs subvolume snapshot $path $spath ### Rsync ### #    rsync -aAXv $spath $dpath$day ### Delete snapshot ### #  btrfs subvolume delete $spath echo "Backup succesful complete" echo "Date_end: `date +%Y-%m-%d-%H-%M-%S`" exit 0</span></span></code> </pre> <br></div></div><br><br>  Script No. 2, creates root files snapshots (the script is very similar in logic to the 1st, so I will only comment on the differences).  Snapshot is named auto_ "number of the day." <br><div class="spoiler">  <b class="spoiler_title">Script number 2</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash set -e echo "Date_start: `date +%Y-%m-%d-%H-%M-%S`" ### Vars ### day=$((`date +%s` / (60*60*24))) dayexp=14 path="/" spath="/snapshots/" ### Delete Old Backups / Check existing snapshot ### #  ,      btrfs subvolume list $path |grep auto |sed -e '1,$ s/.*_//g'| while read ONE_OF_LIST do if [[ "$ONE_OF_LIST" -lt "$day - $dayexp" ]] then echo "remove: $spath"auto_"$ONE_OF_LIST" btrfs subvolume delete $spath"auto_"$ONE_OF_LIST fi if [[ "$ONE_OF_LIST" -eq "$day" ]] then echo "Eroor: snapshot auto_$ONE_OF_LIST exist. Stop script execution." exit 1 fi done ### Create snapshot ### btrfs subvolume snapshot $path $spath"auto_"$day ### End ### echo "Snapshot succesful created" echo "Date_end: `date +%Y-%m-%d-%H-%M-%S`" exit 0</span></span></code> </pre><br></div></div><br><br>  Script No. 3, creates a copy of the LVM volume: <br><br><div class="spoiler">  <b class="spoiler_title">Script number 3</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash set -e echo "Date_start: `date +%Y-%m-%d-%H-%M-%S`" ### Vars ### day=$((`date +%s` / (60*60*24))) dayexp=21 #  LVM  path="/dev/virt_image_array/win_home_system" spath="/dev/virt_image_array/backup_lvm1" dpath="/mnt/backup/lvm1/" ### Delete Old Backups ### find $dpath -maxdepth 1 -type f -mtime +$dayexp -exec rm -rf {} \; ### Check exist snapshot ### #  , ,   if (( "`ls /dev/virt_image_array |grep backup_lvm1|wc -l`" &gt; 0 )) then echo "Warning: Snapshot exist, deleting" lvremove --autobackup y -f $spath fi ### Create snapshot ### # ,      ,      .   10 Gb. lvcreate --size 10G --snapshot --name backup_lvm1 $path #              echo #echo "y"| lvcreate --size 10G -A y --snapshot --name backup_lvm1 $path ### DD ### #   bs,       16M dd if=$spath of=$dpath$day bs=16M ### Delete snapshot ### lvremove --autobackup y -f $spath echo "Backup succesful complete" echo "Date_end: `date +%Y-%m-%d-%H-%M-%S`" exit 0</span></span></code> </pre><br></div></div><br><br>  Since the scripts backing up data from / mnt / data are similar to scripts 1 and 2 I think there is no need to write them. <br><br>  Add to crontab and determine how often to create backups (in my example, backup is created once a week, snapshots once a day). <br><pre> <code class="bash hljs">20 01 * * 1 /usr/bin/backup_root.sh &gt;&gt; /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/backup_root.log 2&gt;&amp;1 50 01 * * 1 /usr/bin/backup_lvm1.sh &gt;&gt; /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/backup_lvm.log 2&gt;&amp;1 20 01 * * * /usr/bin/snapshot_root.sh &gt;&gt; /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/snapshot_root.log 2&gt;&amp;1</code> </pre><br><br><h5>  What else can be screwed: </h5><br><ul><li>  If you need to create more backups, but there is no space, then you can install a file system with deduplication (for example, Opendedup), but the reliability of data storage will decrease. </li><li>  The storage may be a folder connected via NFS or sshfs. </li><li>  If you need to create backups or snapshots more than once a day, you can count not days since 1970, but hours (a crutch, it will be even more incomprehensible for what date the backup). </li></ul><br><br>  <b>UPD.</b>  According to the advice of <b>onix74, the</b> scripts were corrected. </div><p>Source: <a href="https://habr.com/ru/post/211917/">https://habr.com/ru/post/211917/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211905/index.html">Use Audio API to create vocoder</a></li>
<li><a href="../211909/index.html">Forwarding a video card to a guest OS from a KVM hypervisor using VFIO technology</a></li>
<li><a href="../211911/index.html">Watch the Olympics using IPTV</a></li>
<li><a href="../211913/index.html">Screw ActiveRecord to the site</a></li>
<li><a href="../211915/index.html">Virtualization with OpenVZ</a></li>
<li><a href="../211921/index.html">Forward notifications of incoming calls and SMS to the computer</a></li>
<li><a href="../211923/index.html">Opening of the Olympiad: stress test of the 4G network from MegaFon</a></li>
<li><a href="../211925/index.html">Passport integration into SailsJS 0.9</a></li>
<li><a href="../211927/index.html">Get a snapshot of a webcam and a screenshot of the screen using VLC</a></li>
<li><a href="../211929/index.html">Competition "SKB Kontur" through the eyes of a trainee Supl.biz</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>