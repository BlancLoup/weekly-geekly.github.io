<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FPGA Image Filtering</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is a continuation of my previous article on motion detection on FPGAs . In it, I want to consider the implementation of three image filte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FPGA Image Filtering</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/10b/121/a73/10b121a734b2452f8509bfede85edf0b.jpg"><br><br>  This article is a continuation of my previous <a href="https://habrahabr.ru/post/323258/">article on motion detection on FPGAs</a> .  In it, I want to consider the implementation of three image filtering algorithms, one of which is the most important when developing a motion detector. <br><a name="habracut"></a><br>  The need to apply filtering is caused by noise present in the frame.  These noises are of a different nature: some of them are made by the camera itself, others are made by transformation algorithms, others are made by the environment, but they all create obstacles for us to detect objects. <br><br>  In this project, I was faced with the noise that the camera makes and the algorithms for image binarization (Background subtraction and Frame difference).  These noises manifest themselves in the form of individual points or their accumulations both locally and throughout the frame.  Depending on the detection algorithm used, they can be ignored or mistaken for an object. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To avoid such false detection or minimizing its probability, we will apply filtering. <br><br><h4>  Median filter </h4><br>  The median filter, in my opinion, is the most significant for suppressing the interference I encountered while developing this project.  It is just suitable for eliminating all sorts of small dispersed patches, but it is not an ideal tool because  allows slightly larger areas of concentrated interference. <br><br>  The median filter is a sliding window, in our case, a dimension of 3x3 pixels.  At the input it takes 9 values ‚Äã‚Äã(pixels), and the output gives one.  The median filter works like this: sorts the input data (pixels) in ascending order and gives the median result (median). <br><div style="text-align:center;"><img src="https://habrastorage.org/files/b98/c71/dba/b98c71dba58a43b99e69bffebd2cec76.png"></div><br>  This algorithm is quite simply implemented in the C language, but for the FPGA its implementation is somewhat different.  The functional classic filter scheme is shown in the figure below.  It consists of 19 basic elements. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/7d8/f62/f4d/7d8f62f4de18422aa6e2b2dd122164bc.png"></div><br>  Each basic element (node) is a comparator and multiplexer. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/d10/53d/99b/d1053d99ba7a4c6ba80f420931dfefc4.png"></div><br>  In Verilog it looks like this: <br><br><div class="spoiler">  <b class="spoiler_title">Median filter node</b> <div class="spoiler_text"><pre><code class="hljs lua">module median_node #( parameter DATA_WIDTH = <span class="hljs-number"><span class="hljs-number">8</span></span>, parameter LOW_MUX = <span class="hljs-number"><span class="hljs-number">1</span></span>, // disable low <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> parameter HI_MUX = <span class="hljs-number"><span class="hljs-number">1</span></span> // disable high <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> )( <span class="hljs-built_in"><span class="hljs-built_in">input</span></span> wire [DATA_WIDTH<span class="hljs-number"><span class="hljs-number">-1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] data_a, <span class="hljs-built_in"><span class="hljs-built_in">input</span></span> wire [DATA_WIDTH<span class="hljs-number"><span class="hljs-number">-1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] data_b, <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> reg [DATA_WIDTH<span class="hljs-number"><span class="hljs-number">-1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] data_hi, <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> reg [DATA_WIDTH<span class="hljs-number"><span class="hljs-number">-1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] data_lo ); wire sel0; alt_compare cmp( .dataa(data_a), .datab(data_b), .agb(sel0), .alb() ); always @(*) begin : mux_lo_hi case (sel0) <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">'b0 : begin if(LOW_MUX == 1) data_lo = data_a; if(HI_MUX == 1) data_hi = data_b; end 1'</span></span>b1 : begin <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(LOW_MUX == <span class="hljs-number"><span class="hljs-number">1</span></span>) data_lo = data_b; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(HI_MUX == <span class="hljs-number"><span class="hljs-number">1</span></span>) data_hi = data_a; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> default : begin data_lo = {DATA_WIDTH{<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">'b0}}; data_hi = {DATA_WIDTH{1'</span></span>b0}}; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> endcase <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> endmodule</code> </pre> <br><br></div></div><br>  The mega- <b>function</b> alt_compare is used as a comparator.  Further, all nodes are connected according to the scheme.  Simulation of the filter in ModelSim looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b5e/002/57b/b5e00257bf0d421dae36cd9c3db98c05.png"></div><br>  Red rectangle - input data, yellow - filter output.  The output signal is delayed by 1 clock.  The filter has a synchronous register output. <br><br>  So, everything is clear with the median filter, it remains to deal with the 3x3 window. <br><br><h4>  3x3 sliding window </h4><br>  That's how it looks in action.  I imagine it not as a window slides over the picture, but as a picture passes through a static window), but this does not change the essence. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ea0/399/1b7/ea03991b78b9484eab7d435432410a04.png"></div><br>  In the FPGA, the window is not complicated, but it requires 2 FIFO elements the size of one line, in our case 320 elements.  It looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f55/d76/81a/f55d7681a12748c984c680794e9a7139.png"></div><br>  The bottom <b>line buffer</b> is line 1, the top <b>line buffer</b> is line 2, and the data of line 3 is taken directly from the stream when both FIFOs are filled in 320, in our case, elements. <br>  In the Verilog language, this is done like this: <br><br><div class="spoiler">  <b class="spoiler_title">Line buffer</b> <div class="spoiler_text"><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">wire</span></span> [<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] line3_data = data_in; wire line2_empty; wire line2_wr_rq = (data_in_en &amp;&amp; !line2_data_ready); wire line2_data_valid = !line2_empty; wire line2_data_ready; wire [<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] line2_data; wire [<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] median_out_t, sobel_out_t, gaus_out_t; reg [<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] filter_out_r = <span class="hljs-number"><span class="hljs-number">0</span></span>; // row <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-type"><span class="hljs-type">FIFO</span></span> alt_fifo_512x8 <span class="hljs-type"><span class="hljs-type">LINE2_FIFO</span></span> ( .aclr(), .clock(clk), .<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">line3_data</span></span></span><span class="hljs-class">), .rdreq(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">line1_wr_rq</span></span></span><span class="hljs-class">), .wrreq(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">line2_wr_rq</span></span></span><span class="hljs-class">), .almost_full(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">line2_data_ready</span></span></span><span class="hljs-class">), .empty(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">line2_empty</span></span></span><span class="hljs-class">), .full(), .q(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">line2_data</span></span></span><span class="hljs-class">), .usedw() ); wire line1_wr_rq = (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">line2_data_valid</span></span></span><span class="hljs-class"> &amp;&amp; !</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">line1_data_ready</span></span></span><span class="hljs-class">); wire line1_data_ready; wire [7:0] line1_data; // row 2 </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FIFO</span></span></span><span class="hljs-class"> alt_fifo_512x8 </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LINE1_FIFO</span></span></span><span class="hljs-class"> ( .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aclr</span></span></span><span class="hljs-class">(), .clock(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">clk</span></span></span><span class="hljs-class">), .</span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">line2_data</span></span></span><span class="hljs-class">), .rdreq(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">line1_rd_rq</span></span></span><span class="hljs-class">), .wrreq(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">line1_wr_rq</span></span></span><span class="hljs-class">), .almost_full(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">line1_data_ready</span></span></span><span class="hljs-class">), .empty(), .full(), .q(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">line1_data</span></span></span><span class="hljs-class">), .usedw() ); // median filter top median_top #( .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DATA_WIDTH(8)</span></span></span><span class="hljs-class"> ) median_top ( .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">clk</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">clk</span></span></span><span class="hljs-class">), .a0(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a0</span></span></span><span class="hljs-class">), .b0(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b0</span></span></span><span class="hljs-class">), .c0(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">c0</span></span></span><span class="hljs-class">), .a1(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a1</span></span></span><span class="hljs-class">), .b1(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b1</span></span></span><span class="hljs-class">), .c1(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">c1</span></span></span><span class="hljs-class">), .a2(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a2</span></span></span><span class="hljs-class">), .b2(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b2</span></span></span><span class="hljs-class">), .c2(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">c2</span></span></span><span class="hljs-class">), .median(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">median_out_t</span></span></span><span class="hljs-class">) );</span></span></code> </pre> <br></div></div><br><h4>  Detector Sobel </h4><br>  The Sobel detector is an operator that calculates an approximate brightness gradient.  Like the median filter, the Sobel detector is a window, in our case 3x3, function with 9 inputs and one output.  In the classic version, the output of this function is the square root of the sum of squares of gradients along the X and Y axes. The result of the detector operation looks like white outlines of contrasting objects on a black background. <br><br>  Filter coefficient matrix: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/44c/bc4/f59/44cbc4f590b64ab19afca9e81774dcd5.png"></div><br>  The gradient is calculated by convolving the pixel values ‚Äã‚Äãwith the coefficients of the filter matrix using the formula: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/531/330/925/5313309254a14369bc5e710144ebf37c.png"></div><br>  As in the case of the median filter, we need to use the formation of a 3x3 pixel window to work with this filter: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/79e/a28/4e4/79ea284e47d649628ff8c9be7529dab7.png"></div><br>  <b>Shift register</b> 1, 2, and 3 on the functional diagram are zapayplaynny input data from the FIFO, on Verilog looks like this: <br><br><pre> <code class="hljs django"><span class="xml"><span class="xml">reg [7:0] a0,b0,c0,a1,b1,c1,a2,b2,c2; always @(posedge clk or negedge nRst) if (!nRst) begin a0 </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">8</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d0</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b0</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">8</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d0</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">c0</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">8</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d0</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a1</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">8</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d0</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b1</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">8</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d0</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">c1</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">8</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d0</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a2</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">8</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d0</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b2</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">8</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d0</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">c2</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">8</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">d0</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">else</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">begin</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a0</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">line1_data;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b0</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">line2_data;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">c0</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">line3_data;</span></span></span></span><span class="xml"><span class="hljs-tag"> //</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pipeline</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">step</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a1</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">a0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b1</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">b0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">c1</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">c0;</span></span></span></span><span class="xml"><span class="hljs-tag"> //</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pipeline</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">step</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a2</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">a1;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b2</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">b1;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">c2</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">c1;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span></span></span></span></code> </pre> <br>  The code of the detector itself is very simple: <br><br><div class="spoiler">  <b class="spoiler_title">Edge detector</b> <div class="spoiler_text"><pre> <code class="hljs vhdl">module sobel_detector (clk,z0,z1,z2,z3,z4,z5,z6,z7,z8,edge_out); input clk; input [<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] z0,z1,z2,z3,z4,z5,z6,z7,z8; output [<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] edge_out; reg <span class="hljs-built_in"><span class="hljs-built_in">signed</span></span> [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] Gx; reg <span class="hljs-built_in"><span class="hljs-built_in">signed</span></span> [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] Gy; reg <span class="hljs-built_in"><span class="hljs-built_in">signed</span></span> [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] abs_Gx; reg <span class="hljs-built_in"><span class="hljs-built_in">signed</span></span> [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] abs_Gy; reg [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] sum; always @ (posedge clk) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> //original //Gx&lt;=((z2-z0)+((z5-z3)&lt;&lt;<span class="hljs-number"><span class="hljs-number">1</span></span>)+(z8-z6)); //masking <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> x direction //Gy&lt;=((z0-z6)+((z1-z7)&lt;&lt;<span class="hljs-number"><span class="hljs-number">1</span></span>)+(z2-z8)); //masking <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> y direction // modified Gx &lt;= (z4-z3); Gy &lt;= (z4-z1); abs_Gx &lt;= (Gx[<span class="hljs-number"><span class="hljs-number">10</span></span>]?~Gx+<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b1</span></span>:Gx);//<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> negative, <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> invert <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> add <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> make pos. abs_Gy &lt;= (Gy[<span class="hljs-number"><span class="hljs-number">10</span></span>]?~Gy+<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b1</span></span>:Gy);//<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> negative, <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> invert <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> add <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> make pos. sum &lt;= abs_Gx+abs_Gy; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> //Apply Threshold assign edge_out = (sum &gt; <span class="hljs-number"><span class="hljs-number">20</span></span>) ? <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hff</span></span> : <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h00</span></span>; endmodule sobel_detector sobel ( .clk(clk), .z0(a0), .z1(a1), .z2(a2), .z3(b0), .z4(b1), .z5(b2), .z6(c0), .z7(c1), .z8(c2), .edge_out(sobel_out_t) );</code> </pre><br></div></div><br>  However, when testing this detector, it turned out that a lot of noise goes on its output, and instead of a beautiful white outline on a black background, we see white spots.  What is the reason for such a result, I did not understand, the use of different threshold values ‚Äã‚Äãof the classical detector did not give the desired result. <br><br>  I did not search for the reasons for such a detector‚Äôs behavior, because  This detector is of no practical interest to me, only informative.  Instead, I modified the matrix of the Sobel operator and got an acceptable result. <br><br>  Classic Matrix: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e76/cb8/d7b/e76cb8d7baac418182e9681b6f0809f8.png"></div><br>  Modified Matrix: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a65/10f/9e8/a6510f9e8aa24f608d0c8b6a8c572b0f.png"></div><br><h4>  Gauss Filter </h4><br>  The Gaussian filter, like the median filter, is used to eliminate noise in the frame, but it also has a side effect - blurring the image.  In our project there is no such noise that needs to be removed with a Gaussian filter, therefore the implementation of this filter is of academic interest only. <br><br>  Like the two previously considered filters, the Gauss operator is also a 3x3 window function. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/aba/f5b/583/abaf5b583831409d8ade63626f999462.png"></div><br>  Schematically, its implementation looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/43e/b08/060/43eb08060548455988c500f8317155f7.png"></div><br>  Verilog code: <br><br><div class="spoiler">  <b class="spoiler_title">Gaussian filter</b> <div class="spoiler_text"><pre> <code class="hljs mel">module gaus_filter #( parameter DATA_IN_WIDTH = <span class="hljs-number"><span class="hljs-number">8</span></span> )( input <span class="hljs-keyword"><span class="hljs-keyword">wire</span></span> [DATA_IN_WIDTH<span class="hljs-number"><span class="hljs-number">-1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] d00_in, input <span class="hljs-keyword"><span class="hljs-keyword">wire</span></span> [DATA_IN_WIDTH<span class="hljs-number"><span class="hljs-number">-1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] d01_in, input <span class="hljs-keyword"><span class="hljs-keyword">wire</span></span> [DATA_IN_WIDTH<span class="hljs-number"><span class="hljs-number">-1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] d02_in, input <span class="hljs-keyword"><span class="hljs-keyword">wire</span></span> [DATA_IN_WIDTH<span class="hljs-number"><span class="hljs-number">-1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] d10_in, input <span class="hljs-keyword"><span class="hljs-keyword">wire</span></span> [DATA_IN_WIDTH<span class="hljs-number"><span class="hljs-number">-1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] d11_in, input <span class="hljs-keyword"><span class="hljs-keyword">wire</span></span> [DATA_IN_WIDTH<span class="hljs-number"><span class="hljs-number">-1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] d12_in, input <span class="hljs-keyword"><span class="hljs-keyword">wire</span></span> [DATA_IN_WIDTH<span class="hljs-number"><span class="hljs-number">-1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] d20_in, input <span class="hljs-keyword"><span class="hljs-keyword">wire</span></span> [DATA_IN_WIDTH<span class="hljs-number"><span class="hljs-number">-1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] d21_in, input <span class="hljs-keyword"><span class="hljs-keyword">wire</span></span> [DATA_IN_WIDTH<span class="hljs-number"><span class="hljs-number">-1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] d22_in, output <span class="hljs-keyword"><span class="hljs-keyword">wire</span></span> [DATA_IN_WIDTH<span class="hljs-number"><span class="hljs-number">-1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] ftr_out, ); <span class="hljs-keyword"><span class="hljs-keyword">wire</span></span> [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] s1 = d00_in+(d01_in&lt;&lt;<span class="hljs-number"><span class="hljs-number">1</span></span>)+d02_in+(d10_in&lt;&lt;<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">wire</span></span> [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] s2 = (d11_in&lt;&lt;<span class="hljs-number"><span class="hljs-number">2</span></span>)+(d12_in&lt;&lt;<span class="hljs-number"><span class="hljs-number">1</span></span>)+d20_in+(d21_in&lt;&lt;<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">wire</span></span> [<span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] s3 = s1+s2+d22_in; assign ftr_out = s3&gt;&gt;<span class="hljs-number"><span class="hljs-number">4</span></span>; endmodule gaus_filter #( .DATA_IN_WIDTH(<span class="hljs-number"><span class="hljs-number">8</span></span>) ) gaus_filter_inst( .d00_in (a0), .d01_in (a1), .d02_in (a2), .d10_in (b0), .d11_in (b1), .d12_in (b2), .d20_in (c0), .d21_in (c1), .d22_in (c2), .ftr_out (gaus_out_t), );</code> </pre><br></div></div><br><h4>  Filter Input Values </h4><br>  The absolute difference of frames of a grayscale representation for its subsequent filtering is fed to the input of the median filter, while the input of the Sobel detector and the Gauss filter is fed to the grayscale representation itself, and not its difference. <br><br><h4>  findings </h4><br>  The above filters were not perfected because  there was no need for this project.  If desired, you can implement and use more complex and resource-intensive filter designs for a specific task, and this article is for informational purposes only. <br><br>  For the further development of this project, we need only a median filter. <br><br><h4>  Demonstration of the result </h4><br><iframe width="560" height="315" src="https://www.youtube.com/embed/xEPRVCT3N2o" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  The right half of the screen alternately displays different modes of operation, indicated by color markers (the <i>square in the corner of the image</i> ) <br><br>  Black - grayscale view without filtering <br>  Red - frame difference without filtering <br>  Green - frame difference filtered by median filter <br>  Blue - Sobel's detector <br>  White - Gaussian filter <br><br>  The first pass to the video is the work of the Frame difference algorithm.  Filtering by the median filter is not very noticeable on the video.  Second pass - Background subtraction.  There is a noticeable difference between the difference without filtering and filtering - some separate white dots have disappeared. <br><br>  After the Gauss filter, the image changes to grayscale and the difference becomes noticeable: with Gauss, the image is less sharp than just grayscale. <br><br><h4>  Materials </h4><br>  ‚Üí <a href="http://halcyon.usc.edu/~pk/prasannawebsite/papers/2013/Sanny-reconfig2013.pdf">Median filter FPGA implementation</a> <br>  ‚Üí <a href="http://edge.kitiyo.com/2009/codes/sobel-core-verilog-module.html">Sobel filter implementation</a> <br>  ‚Üí <a href="https://thesai.org/Downloads/Volume7No7/Paper_71-FPGA_implementation_of_filtered_image_using%25202D.pdf">Gaussian filter on FPGA</a> </div><p>Source: <a href="https://habr.com/ru/post/324070/">https://habr.com/ru/post/324070/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324060/index.html">What is Resizable Concurrent Map</a></li>
<li><a href="../324062/index.html">Count to three</a></li>
<li><a href="../324064/index.html">5 reasons to enter the international marketplace</a></li>
<li><a href="../324066/index.html">Modern JWT authorization for modern Kode framework Node.js</a></li>
<li><a href="../324068/index.html">How to feed cattle. Advice to the head of the developer unit</a></li>
<li><a href="../324072/index.html">Software defined storage: compare 7 solutions</a></li>
<li><a href="../324076/index.html">Mitap MSK.NET Community</a></li>
<li><a href="../324078/index.html">Report from Data Fest‚Å¥ February 11-12</a></li>
<li><a href="../324080/index.html">Atomic payments for parking fees in Lamoda</a></li>
<li><a href="../324082/index.html">Data Science Weekend. Speaker presentations</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>