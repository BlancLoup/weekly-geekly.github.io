<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Custom SQLite Android functions or its own LOWER_FNC ()</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="SELECT * WHERE LOWER_FNC (name) like '% "+ filterText +"%' " 

 When developing an Android application, I ran into a problem in a SQLite filter query ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Custom SQLite Android functions or its own LOWER_FNC ()</h1><div class="post__text post__text-html js-mediator-article">  SELECT * WHERE LOWER_FNC (name) like '% "+ filterText +"%' " <br><br>  When developing an Android application, I ran into a problem in a SQLite filter query with Russian letters.  There are no problems with English localization.  For other international layouts, capitalized letters in the request were incorrectly processed. <br>  Having a little understood I came across the following description: <br><br>  <i>(18) Case-insensitive matching of Unicode characters does not work.</i> <i>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </i>  <i>The default configuration of SQLite only supports case-insensitive comparisons of ASCII characters.</i>  <i>It would be a little bit different for the SQLite library.</i>  <i>It‚Äôs not worth it.</i> <i><br><br></i>  <i>Instead of providing full Unicode case support by default, SQLite provides a linking and conversion routines.</i> <i><br></i> <br>  Probably the current implementation of SQLite Android is <blockquote>  only supports case-insensitive comparisons of ASCII characters </blockquote><br><br>  I saw the solution through <a href="https://gist.github.com/ramzes642/5400792">CursorWrapper</a> but decided to build my version of SQLite and use addCustomFunction <br><br>  What came out of this read under the cut <br><a name="habracut"></a><br><br>  The idea of ‚Äã‚Äãusing direct and reverse data exchange with the SQLite library of your own (custom) assembly <br>  To start, look at the <a href="">SQLite Android Bindings</a> instruction. <br>  I used the Android API levels 15 (Android 4.0.3) version.  There is a slight difference in the additional folder or package package org.sqlite.os; <br><br>  Further standardly we collect library through NDK sqliteX.  We connect to the project.  And ship our library <br><br><pre><code class="java hljs">System.loadLibrary(<span class="hljs-string"><span class="hljs-string">"sqliteX"</span></span>);</code> </pre> <br>  Now we define our user function, which will be called from the SQL query. <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> SQLiteDatabase.CustomFunction mLowerFnc = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SQLiteDatabase.CustomFunction() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ String text = args[<span class="hljs-number"><span class="hljs-number">0</span></span>]; text = text.toLowerCase(); Log.d(LOG, <span class="hljs-string"><span class="hljs-string">"LOWER_FNC : "</span></span> + text); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } };</code> </pre><br>  The function itself is connected as follows. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataBase</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQLiteOpenHelper</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DataBase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context, context.getDatabasePath(DATABASE_NAME).getPath(), <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, DATABASE_VERSION); context.openOrCreateDatabase(context.getDatabasePath(DATABASE_NAME).getPath(), context.MODE_PRIVATE, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">open</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> SQLException </span></span>{ database = getWritableDatabase(); database.addCustomFunction(<span class="hljs-string"><span class="hljs-string">"LOWER_FNC"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, mLowerFnc); }</code> </pre><br>  Parameters: The name of the function by which it will be called from the SQLite query string.  The number of arguments, in this case, the input string and the handler function itself <br><br>  Please note that you need to open the base along the full path.  Option to get the full path: <br><br><pre> <code class="java hljs">DB_PATH = getApplicationContext().getDatabasePath(<span class="hljs-string"><span class="hljs-string">"test.db"</span></span>); DB_PATH.mkdirs();</code> </pre><br>  In the logs we see the call to our function LOWER_FNC and the lines from the request.  Fine! <br>  What's next?  How to use these lines and return them back in processed form? <br><br>  We watch source codes of SQLite: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Called each time a custom function is evaluated. static void sqliteCustomFunctionCallback(sqlite3_context *context, int argc, sqlite3_value **argv) { ... // </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Support functions that return values. env-&gt;CallVoidMethod(functionObj, gSQLiteCustomFunctionClassInfo.dispatchCallback, argsArray); ...</span></span></code> </pre><br>  We see CallVoidMethod and further TODO: Support functions that return values <br>  Wonderful.  The authors did not finish.  I'll have to myself ... <br>  I will say that the approach was not found immediately.  Spent two days, but the result was achieved.  And this is the main thing <br><br><pre> <code class="cpp hljs"> result = env-&gt;CallObjectMethod( functionObj, gSQLiteCustomFunctionClassInfo.dispatchCallback, argsArray); char_result = env-&gt;GetStringUTFChars( (jstring) result, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); sqlite3_result_text(context, char_result, <span class="hljs-number"><span class="hljs-number">-1</span></span>, SQLITE_TRANSIENT);</code> </pre><br>  Instead of CallVoidMethod, we do a CallObjectMethod in which we pick up a string from Android <br><div class="spoiler">  <b class="spoiler_title">Full version of the function</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Called each time a custom function is evaluated. static void sqliteCustomFunctionCallback(sqlite3_context *context, int argc, sqlite3_value **argv) { jobject result; JNIEnv* env = 0; const char* char_result; gpJavaVM-&gt;GetEnv((void**)&amp;env, JNI_VERSION_1_4); // Get the callback function object. // Create a new local reference to it in case the callback tries to do something // dumb like unregister the function (thereby destroying the global ref) while it is running. jobject functionObjGlobal = reinterpret_cast&lt;jobject&gt;(sqlite3_user_data(context)); jobject functionObj = env-&gt;NewLocalRef(functionObjGlobal); jobjectArray argsArray = env-&gt;NewObjectArray(argc, gStringClassInfo.clazz, NULL); if (argsArray) { for (int i = 0; i &lt; argc; i++) { const jchar* arg = static_cast&lt;const jchar*&gt;(sqlite3_value_text16(argv[i])); if (!arg) { ALOGW("NULL argument in custom_function_callback. This should not happen."); } else { size_t argLen = sqlite3_value_bytes16(argv[i]) / sizeof(jchar); jstring argStr = env-&gt;NewString(arg, argLen); if (!argStr) { goto error; // out of memory error } env-&gt;SetObjectArrayElement(argsArray, i, argStr); env-&gt;DeleteLocalRef(argStr); } } // </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Support functions that return values. //env-&gt;CallVoidMethod(functionObj, // gSQLiteCustomFunctionClassInfo.dispatchCallback, argsArray); result = env-&gt;CallObjectMethod( functionObj, gSQLiteCustomFunctionClassInfo.dispatchCallback, argsArray); char_result = env-&gt;GetStringUTFChars( (jstring) result, NULL); sqlite3_result_text(context, char_result, -1, SQLITE_TRANSIENT); error: env-&gt;DeleteLocalRef(argsArray); } env-&gt;DeleteLocalRef(functionObj); env-&gt;DeleteLocalRef(result); if (env-&gt;ExceptionCheck()) { ALOGE("An exception was thrown by custom SQLite function."); /* LOGE_EX(env); */ env-&gt;ExceptionClear(); } }</span></span></code> </pre><br></div></div><br>  There is one more thing.  You need to change in register_android_database_SQLiteConnection: <br><br><pre> <code class="cpp hljs"> GET_METHOD_ID(gSQLiteCustomFunctionClassInfo.dispatchCallback, clazz, <span class="hljs-string"><span class="hljs-string">"dispatchCallback"</span></span>, <span class="hljs-string"><span class="hljs-string">"([Ljava/lang/String;)Ljava/lang/String;"</span></span>);</code> </pre><br>  Adding Ljava / lang / String;  as a parameter.  This is a string that will be returned from the Android application.  Otherwise, Android OS will not find our new implementation. <br><br><div class="spoiler">  <b class="spoiler_title">register_android_database_SQLiteConnection (JNIEnv * env)</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">register_android_database_SQLiteConnection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv *env)</span></span></span><span class="hljs-function"> </span></span>{ jclass clazz; FIND_CLASS(clazz, <span class="hljs-string"><span class="hljs-string">"org/sqlite/database/sqlite/SQLiteCustomFunction"</span></span>); GET_FIELD_ID(gSQLiteCustomFunctionClassInfo.name, clazz, <span class="hljs-string"><span class="hljs-string">"name"</span></span>, <span class="hljs-string"><span class="hljs-string">"Ljava/lang/String;"</span></span>); GET_FIELD_ID(gSQLiteCustomFunctionClassInfo.numArgs, clazz, <span class="hljs-string"><span class="hljs-string">"numArgs"</span></span>, <span class="hljs-string"><span class="hljs-string">"I"</span></span>); GET_METHOD_ID(gSQLiteCustomFunctionClassInfo.dispatchCallback, clazz, <span class="hljs-string"><span class="hljs-string">"dispatchCallback"</span></span>, <span class="hljs-string"><span class="hljs-string">"([Ljava/lang/String;)Ljava/lang/String;"</span></span>); FIND_CLASS(clazz, <span class="hljs-string"><span class="hljs-string">"java/lang/String"</span></span>); gStringClassInfo.clazz = jclass(env-&gt;NewGlobalRef(clazz)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> jniRegisterNativeMethods(env, <span class="hljs-string"><span class="hljs-string">"org/sqlite/database/sqlite/SQLiteConnection"</span></span>, sMethods, NELEM(sMethods) ); }</code> </pre><br></div></div><br>  The final stage.  Change the callback and interface so that it returns a String. <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> SQLiteDatabase.CustomFunction mLowerFnc = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SQLiteDatabase.CustomFunction() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ String text = args[<span class="hljs-number"><span class="hljs-number">0</span></span>]; text = text.toLowerCase(); Log.d(LOG, <span class="hljs-string"><span class="hljs-string">"LOWER_FNC : "</span></span> + text); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } }; ... <span class="hljs-comment"><span class="hljs-comment">/** * A callback interface for a custom sqlite3 function. * This can be used to create a function that can be called from * sqlite3 database triggers. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@hide</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomFunction</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span></span>; }</code> </pre><br></div></div><br>  Thus, you can redefine any function, build on it or make your own with unique functionality.  The application is all found in the project <a href="https://play.google.com/store/apps/details%3Fid%3Dnet.appz.airtikets">Air Tickets</a> <br>  Used feed Aviasales, but that's another story <br><br>  I hope the article will be useful.  Write SQLite queries with your functionality! <br><br>  Article materials: <br>  <a href="">SQLite Android Bindings</a> <br>  <a href="https://developer.android.com/tools/sdk/ndk/index.html">Android NDK</a> </div><p>Source: <a href="https://habr.com/ru/post/252823/">https://habr.com/ru/post/252823/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252809/index.html">Restart daemon in PHP without losing connections to it</a></li>
<li><a href="../252813/index.html">Can you trust the code in the editor? bi-directional text</a></li>
<li><a href="../252817/index.html">Automation of financial statements</a></li>
<li><a href="../252819/index.html">How to prepare TCP</a></li>
<li><a href="../252821/index.html">Nginx and https. We get class A +</a></li>
<li><a href="../252829/index.html">Sound effects in Windows Phone 8 applications</a></li>
<li><a href="../252831/index.html">Track devices via passive WiFi listening</a></li>
<li><a href="../252833/index.html">Calculation of prescaler parameters for 8250-compatible USART</a></li>
<li><a href="../252837/index.html">Freedom dependent variables</a></li>
<li><a href="../252843/index.html">What is wrong with online courses and how to fix it: HTML Academy experience</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>