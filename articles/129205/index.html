<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>On-the-fly Compilation in Erlang</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In some cases it is convenient to compile certain parts of the program while the application is running. For example, in the world of Java this is how...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>On-the-fly Compilation in Erlang</h1><div class="post__text post__text-html js-mediator-article">  In some cases it is convenient to compile certain parts of the program while the application is running.  For example, in the world of Java this is how a web server compiles a .jsp page into servlets.  Other possible uses of this technique are different pattern languages, regular expressions, etc. <br><br>  In Erlang, the translator is built into the runtime library, and allows you to fully manage all stages of the broadcast. <br><br>  How to do it <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For example, create a module containing one function.  Let it be - the addition of two numbers. <br><br>  So.  We form the line containing the text of the module. <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">Src</span></span> = [ <span class="hljs-string"><span class="hljs-string">"-module(testmodule)."</span></span>, <span class="hljs-string"><span class="hljs-string">"-export([add_two_numbers/2])."</span></span>, <span class="hljs-string"><span class="hljs-string">"-compile(native)."</span></span> , <span class="hljs-string"><span class="hljs-string">"add_two_numbers(X,Y) -&gt; X+Y."</span></span>].</code> </pre> <br><br>  Next we need to do a lexical analysis, <br><br><pre> <code class="hljs kotlin"> Lexems = lists:map(<span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fun</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(X)</span></span></span></span> -&gt; {ok,Scanned,_} = erl_scan:string(X), Scanned end, Src).</code> </pre><br><br>  As a result, in Lexems we get a list of tokens, something like <br><br><pre> <code class="hljs javascript">[[{<span class="hljs-string"><span class="hljs-string">'-'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>}, {atom,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-built_in"><span class="hljs-built_in">module</span></span>}, {<span class="hljs-string"><span class="hljs-string">'('</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>}, {atom,<span class="hljs-number"><span class="hljs-number">1</span></span>,testmodule}, {<span class="hljs-string"><span class="hljs-string">')'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>}, {dot,<span class="hljs-number"><span class="hljs-number">1</span></span>}], [{<span class="hljs-string"><span class="hljs-string">'-'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>}, {atom,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">export</span></span>}, {<span class="hljs-string"><span class="hljs-string">'('</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-string"><span class="hljs-string">'['</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>}, {atom,<span class="hljs-number"><span class="hljs-number">1</span></span>,add_two_numbers}, ...  ..</code> </pre><br><br>  Parsing <br><br><pre> <code class="hljs kotlin"> Parsed = lists:map(<span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fun</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(X)</span></span></span></span> -&gt; {ok,P} = erl_parse:parse_form(X), P end, Lexems).</code> </pre><br><br>  At this stage, Parsed will contain the internal presentation of our program.  By the way, in a readable form. <br><br><pre> <code class="hljs java">[{attribute,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>,testmodule}, {attribute,<span class="hljs-number"><span class="hljs-number">1</span></span>,export,[{add_two_numbers,<span class="hljs-number"><span class="hljs-number">2</span></span>}]}, {attribute,<span class="hljs-number"><span class="hljs-number">1</span></span>,compile,<span class="hljs-keyword"><span class="hljs-keyword">native</span></span>}, {function,<span class="hljs-number"><span class="hljs-number">1</span></span>,add_two_numbers,<span class="hljs-number"><span class="hljs-number">2</span></span>, [{clause,<span class="hljs-number"><span class="hljs-number">1</span></span>, [{<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">'X'</span></span>},{<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">'Y'</span></span>}], [], [{op,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">'+'</span></span>,{<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">'X'</span></span>},{<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">'Y'</span></span>}}]}]}]</code> </pre><br><br>  So that in some simple cases it can be reasonable to build such an attribute tree right away without prior lexical and syntactic analysis. <br><br>  There was a trifle.  Convert an attribute tree to a virtual machine binary code, <br><br><pre> <code class="hljs erlang-repl">{ok,_,B} = compile:forms(Parsed).</code> </pre><br><br>  And download this code from the string to the virtual machine. <br><pre> <code class="hljs erlang">code:load_binary(testmodule,<span class="hljs-string"><span class="hljs-string">"nofile"</span></span>,B).</code> </pre><br><br>  Check <br><pre> <code class="hljs erlang-repl"><span class="hljs-meta"><span class="hljs-meta">19&gt; </span></span>testmodule:add_two_numbers(<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>). <span class="hljs-number"><span class="hljs-number">13</span></span></code> </pre><br><br>  Everything is working!  We formed a module in memory, read it, downloaded it, and now it is no different from other Erlang modules.  You can call it from anywhere, change it (thanks to the Erlang for this opportunity), and, by the way, it was compiled with the native option ‚Äî that is, into the processor code, using hipe. </div><p>Source: <a href="https://habr.com/ru/post/129205/">https://habr.com/ru/post/129205/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../129198/index.html">Profit Zynga fell by 95%</a></li>
<li><a href="../129199/index.html">Cloud4Y at InfoSecurity Russia. StorageExpo. Documation '2011</a></li>
<li><a href="../129201/index.html">The implementation of dictionary objects, as in Javascript</a></li>
<li><a href="../129202/index.html">Put the objects on the stream, the pattern of the factory of objects</a></li>
<li><a href="../129204/index.html">The story of a hack or how they tried to lead away everything, but did not take away anything</a></li>
<li><a href="../129206/index.html">Zynga launched CityVille on Google+</a></li>
<li><a href="../129207/index.html">Writing your own linux daemon with auto repair feature</a></li>
<li><a href="../129208/index.html">Sea, sun, student projects: Mat Fur Summer School</a></li>
<li><a href="../129211/index.html">Rally for a radical extension of life</a></li>
<li><a href="../129212/index.html">What markup is better to use for a content resource?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>