<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MassTransit. Rabbit Rabbit Server based messaging bus (MSMQ) for .Net</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I first heard about the MassTransit (MT) library about a year ago from an ex-colleague who came to our office to share experiences. The company, in wh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MassTransit. Rabbit Rabbit Server based messaging bus (MSMQ) for .Net</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/0ec/946/515/0ec946515ef338c16f8beb61a680e40d.png" alt="MassTransit" align="left"><br>  I first heard about the <a href="http://masstransit-project.com/">MassTransit</a> (MT) library about a year ago from an ex-colleague who came to our office to share experiences.  The company, in which he settled, used MT to reduce the connectivity between the modules of the service they are developing and, since the high connectivity began to turn into a problem and for us, the experience of others turned out to be very useful.  In addition to reducing connectivity by switching to an event-based model of interaction between modules, MT was useful to us for the distribution of resource-intensive tasks among several processes. <br><br><a name="habracut"></a><br><br><h4>  What is MassTransit. </h4><br>  MassTransit is an implementation of the well-known <a href="http://c2.com/cgi/wiki%3FDataBusPattern">DataBus</a> pattern.  The main objective of this pattern is to organize the interaction of several objects that are unaware of the existence of each other through the exchange of messages between them.  The library was written by Dru Sellers and <a href="http://blog.phatboyg.com/">Chris Patterson</a> as a free <a href="http://particular.net/NServiceBus">version of the NServiceBus</a> project, capable of using a RabbitMQ or MSMQ message server to choose from as a transport.  In our project, we chose to use RabbitMQ, so here we will describe the experience and pitfalls that await the configuration of the bus on this server queues.  Despite the fact that MassTransit is a layer of abstraction over the AMQP protocol and the developers tried to hide the implementation details so that knowledge about the device of the queue server and the AMQP protocol for using the library is practically not required, to understand the article and successfully go around the rake during bus configuration RabbitMQ server is desirable to have.  This is bad news, but there is good news as well. At the very least knowledge is needed, it will be enough to read the first four lessons <a href="http://www.rabbitmq.com/getstarted.html">from here</a> .  The lessons are small and clear, learning the basics of working with RabbitMQ does not take much time, but it can bring many benefits.  By the way, the first couple of lessons were even translated into Habr√©.  <a href="http://habrahabr.ru/post/149694/">Lesson one</a> and <a href="http://habrahabr.ru/post/150134/">lesson two</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  To the point. </h4><br>  Let's move from theory to practice and try using the MassTransit library to accomplish a task similar in functionality to the first example from the tutorial on RabbitMQ.  We will write a simple console application in which two objects Publisher and Subscriber will interact.  Publisher, when you press any key, will send a ‚ÄúKeyWasPressed‚Äù message and key code to the bus.  Subscriber will capture this message from the bus and display it on the screen. <br><br><div class="spoiler">  <b class="spoiler_title">First we have to</b> <div class="spoiler_text">  1) Install <a href="http://www.erlang.org/download.html">Erlang</a> <br>  2) Install <a href="http://www.rabbitmq.com/download.html">RabbitMQ</a> <br>  3) Install MassTransit.RabbitMQ to the test application by running the command PM&gt; Install-Package MassTransit.RabbitMQ. <br></div></div><br>  Let's go directly to the code.  Messages sent to the bus are normal <a href="http://ru.wikipedia.org/wiki/DTO">DTO</a> objects.  First of all, we need to create a class of the message itself, sent from the publisher to the subscriber.  Let's call it KeyWasPressed. <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">KeyWasPressed</span></span> { <span class="hljs-comment"><span class="hljs-comment">//       public ConsoleKey PressedKey { get; set; } }</span></span></code> </pre> <br><br>  We now turn to writing a simple publisher (subscriber) and subscriber.  The key element of the library is the ServiceBus.  The ServiceBus in MassTransit is a messaging environment in which the RabbitMQ (or MSMQ) queue server is responsible for transporting messages.  Our subscriber and publisher will be objects of this type - ServiceBus. <br><br><h5>  Subscriber. </h5><br><pre> <code class="cs hljs"> IServiceBus subscriber = ServiceBusFactory.New(sbc =&gt; { <span class="hljs-comment"><span class="hljs-comment">//        rabbitMq sbc.UseRabbitMq(); //            sbc.ReceiveFrom("rabbitmq://localhost/subscriber"); //   KeyWasPressed.   //      sbc.Subscribe(subs =&gt; subs.Handler&lt;KeyWasPressed&gt;(msg =&gt; Console.WriteLine("{0}{1}{2}{3}",Environment.NewLine,"Key '", msg.PressedKey, "' was pressed") )); });</span></span></code> </pre><br><br><h5>  Publisher. </h5><br><pre> <code class="cs hljs">IServiceBus publisher = ServiceBusFactory.New(sbc =&gt; { <span class="hljs-comment"><span class="hljs-comment">//,        rabbitMq sbc.UseRabbitMq(); // ,       sbc.ReceiveFrom("rabbitmq://localhost/publisher"); });</span></span></code> </pre><br><br>  MassTransit does not divide ServiceBus instances connected to the message server into publishers and subscribers; through each connected instance you can both publish and process messages.  Therefore, we always need to specify a queue for receiving messages, although sometimes, as in the case of the publisher object, we are not going to receive anything. <br>  Now we write an infinite loop in which each key pressed will be sent to the bus. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { publisher.Publish(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyWasPressed() { PressedKey = Console.ReadKey().Key }); }</code> </pre><br>  Everything is ready, run our application and click on the keys. <br><img src="https://habrastorage.org/getpro/habr/post_images/00a/783/36a/00a78336abd8b6cef524cfa831b195b3.png"><br><br><h4>  What happens on the queue server. </h4><br>  Let's see what happens on the queue server when launching our application.  By default, the RabbitMQ installer registers RabbitMQ as a Windows service, so we can always see what is currently happening on the queue server through the command line utilities.  But it is more convenient to use the web plugin, which is also included in the standard distribution package. <br><br><div class="spoiler">  <b class="spoiler_title">To install it, we will have to follow these few steps.</b> <div class="spoiler_text">  1) In the command line, go to the sbin folder from the server installation directory (for example,% PROGRAMFILES% \ RabbitMQ Server \ rabbitmq_server_2.7.1 \ sbin \) <br><br>  2) Next, run the following command. <br>  rabbitmq-plugins.bat enable rabbitmq_management <br><br>  3) Finally, to enable the plugin control, we must reinstall the RabbitMQ service.  Perform the following sequence of commands to install the service: <br>  rabbitmq-service.bat stop <br>  rabbitmq-service.bat install <br>  rabbitmq-service.bat start <br>  To make sure that the RabbitMQ server management plugin is installed and running, launch a browser and go to the <a href="http://localhost:15672/mgmt/">next page</a> (for version 3.0, the default port is 55672).  If everything went well, a screen similar to the following will appear: <br><img src="https://habrastorage.org/getpro/habr/post_images/77c/726/998/77c726998a092518d5adb1febd68508a.png"><br>  The default login / password is guest / guest.  Go inside and click on the list of points of exchange. </div></div><br>  For each message for which there is at least one subscriber, MT creates an exchange point (exchange) with a name using the Namespace: ClassName pattern and associates subscriber queues with it.  In our application, there is only one exchange point, called MT: KeyWasPressed, and this exchange point is tied to one queue - subscriber. <br><img src="https://habrastorage.org/getpro/habr/post_images/2e3/b49/169/2e3b491697aff3770758e7c9f33b7721.png"><br>  In new versions of MT, the queues and default exchange points became permanent (durable), I did not understand this bug or feature, but earlier, when creating each subscription, it was necessary to explicitly call the Permanent () method to fix the corresponding exchange point on the queue server.  Stable exchange points and queues are convenient because if the subscriber is disconnected from the queue server at the time of publishing the message, the published message will still not pass by the subscriber, but will queue up and quietly wait for its (subscriber) connection. <br><br><h4>  Add new subscribers. </h4><br>  Let's change our application by adding another subscriber to the KeyWasPressed message.  Unlike the first one, it will be subscribed to the queue called anothersubscriber and will display a numeric representation of each key pressed by the user. <br><br><pre> <code class="cs hljs">IServiceBus anotherSubscriber = ServiceBusFactory.New(sbc =&gt; { sbc.UseRabbitMq(); sbc.ReceiveFrom(<span class="hljs-string"><span class="hljs-string">"rabbitmq://localhost/anothersubscriber"</span></span>); sbc.Subscribe(subs =&gt; subs.Handler&lt;KeyWasPressed&gt;(msg =&gt; Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"{0}{1}{2}{3}"</span></span>, Environment.NewLine, <span class="hljs-string"><span class="hljs-string">"Key with code "</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) msg.PressedKey, <span class="hljs-string"><span class="hljs-string">" was pressed"</span></span>) )); });</code> </pre><br>  Run the application and click on the keys. <br><img src="https://habrastorage.org/getpro/habr/post_images/11c/ec7/3ec/11cec73ecbd2f3db061bd8a927000fa6.png"><br>  Now, when you press each key, two lines appear on the screen - with the numeric and character code of each key pressed.  If you enter the queue server control panel, you can see that now two subscriber and anothersubscriber queues are already attached to the MT: KeyWasPressed exchange point.  And each received message of the MT.KeyWasPressed type, the RabbitMQ queue server sends to both queues. <br><br><h4>  Distribution of resource-intensive tasks. </h4><br>  Now let's see how using the MassTransit + RabbitMQ bundle, you can distribute resource-intensive tasks among several processes. <br>  Imagine that our task is to create a service for converting video files.  For this task, we have two servers.  Experimentally, we have established that the optimal load for server number one is three parallel convertible video files, for server number two the number of simultaneously convertible video files should not exceed five.  The conversion process, we, of course, will emulate.  Imagine that we have a queue called filesToConvert, which receives files for conversion.  Each file will represent an object of type VideoFile. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">VideoFile</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Num { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//,       public int TimeToConvert { get; set; } }</span></span></code> </pre><br>  The subscriber, having received such a message, according to the rules of the game, will have to fall asleep by the number of milliseconds specified in the TimeToConvert field of the incoming message. <br>  The code, according to legend, runs on the first server. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> firstServerFilesCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; IServiceBus firstServer = ServiceBusFactory.New(sbc =&gt; { sbc.UseRabbitMq(); <span class="hljs-comment"><span class="hljs-comment">//   ,      sbc.SetConcurrentConsumerLimit(3); sbc.Subscribe(subs =&gt; subs.Handler&lt;VideoFile&gt;(msg =&gt; { firstServerFilesCount++; Thread.Sleep(msg.TimeToConvert); Console.WriteLine(" 1. {0} {1}   {2} . : {3}  3. ThreadId - {4}", Environment.NewLine, msg.Num, msg.TimeToConvert, firstServerFilesCount, Thread.CurrentThread.ManagedThreadId); firstServerFilesCount--; })); //prefetch=3.   ,         sbc.ReceiveFrom("rabbitmq://localhost/filesToConvert?prefetch=3"); });</span></span></code> </pre><br>  According to legend, on the first server we decided to limit the number of simultaneously disassembled messages to three.  Therefore, we call the SetConcurrentConsumerLimit method with argument 3. This means that when the firstServer object is connected to the message server, MassTransit will have a pool of three threads ready to process messages from the server.  But we must remember that RabbitMQ is engaged in the distribution of messages, and he cannot know the fact that the firstServer object is ready to parse up to three messages at the same time.  We can send this information to it by specifying the prefetch parameter in the Uri, through which firstServer connects to the message server. <br><br>  The code, according to legend, runs on the second server. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> secondServerFilesCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; IServiceBus secondServer = ServiceBusFactory.New(sbc =&gt; { sbc.UseRabbitMq(); <span class="hljs-comment"><span class="hljs-comment">//   ,      sbc.SetConcurrentConsumerLimit(5); sbc.Subscribe(subs =&gt; subs.Handler&lt;VideoFile&gt;(msg =&gt; { secondServerFilesCount++; Thread.Sleep(msg.TimeToConvert); Console.WriteLine(" 2. {0} {1}   {2} . : {3}  5. ThreadId - {4}", Environment.NewLine, msg.Num, msg.TimeToConvert, secondServerFilesCount, Thread.CurrentThread.ManagedThreadId); secondServerFilesCount--; })); //prefetch=3.   ,         sbc.ReceiveFrom("rabbitmq://localhost/filesToConvert?prefetch=5"); });</span></span></code> </pre><br>  Differences, as you can guess, are only in the number of threads in the pool, designed to parse the message, and the value of prefetch in Uri.  It is much more important to note the fact that we connected the secondServer to the same queue, where the firstServer was connected, thereby creating a competition between the subscribers for the messages appearing in this queue.  If the firstServer and secondServer objects are connected to different queues, then we will face the fact that each file will be converted twice, once on each server. <br><br>  Now let's write the code that fills the filesToConvert queue with hundreds of ‚Äúvideo files‚Äù, with the conversion time set by random. <br><pre> <code class="cs hljs">Random rnd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt;= <span class="hljs-number"><span class="hljs-number">100</span></span>; i++) { publisher.Publish(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VideoFile() {Num = i, TimeToConvert = rnd.Next(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">5000</span></span>)}); }</code> </pre><br>  We start and make sure that our subscriber servers work in parallel using the number of threads we have assigned. <br><img src="http://habrastorage.org/storage3/094/cc5/2a8/094cc52a8b235d32ee3bb0ea60d94fb2.png"><br><br><h4>  What other features can MassTransit offer us? <br></h4><br>  Within the framework of one article it is impossible to consider all the possibilities offered by the MassTransit library.  But you can list (what I do). <br><br><ul><li>  <strong>Sagas.</strong>  Mechanism for coordinating distributed processes </li></ul><br><br><ul><li>  <strong>Scheduling</strong>  Integration with the library Quartz.net allows you to send messages in the queue on a schedule </li></ul><br><br><ul><li>  <strong>Diagnostics.</strong>  Support <a href="http://www.eaipatterns.com/ControlBus.html">ControlBus</a> , <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa373083(v%3Dvs.85).aspx">PerfomanceCounters</a> </li></ul><br><br><ul><li>  <strong>Rx integration.</strong>  <a href="http://msdn.microsoft.com/ru-ru/data/gg577609.aspx">Rx Extensions</a> Support </li></ul><br><br><ul><li>  <strong>Encryption.</strong>  Encryption of sent messages.  Rijndael block cipher is used for encryption. </li></ul><br><br><ul><li>  <strong>Unit Testability.</strong>  For testing purposes, MassTransit can use the built-in transport (Loopback), which does not require external MQ servers. </li></ul><br><br>  Code examples from the article can be found <a href="https://github.com/steamru85/MTExamples">here</a> . <br></div><p>Source: <a href="https://habr.com/ru/post/210428/">https://habr.com/ru/post/210428/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../210418/index.html">Accident Alert Info Panel Project (Part 1)</a></li>
<li><a href="../210420/index.html">We write monitoring the availability of tickets for Russian Railways</a></li>
<li><a href="../210422/index.html">We try Audio API on an example of writing a visualizer</a></li>
<li><a href="../210424/index.html">Post preparation for printing</a></li>
<li><a href="../210426/index.html">Convenient switching wifi in access point mode</a></li>
<li><a href="../210432/index.html">Poisson process simulation</a></li>
<li><a href="../210434/index.html">Are you also looking for SQL dependencies manually? Then we go to you! SQL Dynamite, search in database objects</a></li>
<li><a href="../210436/index.html">The beginning of the preparation of the conference AI & BigData Lab</a></li>
<li><a href="../210438/index.html">New free courses of virtual academy of Microsoft Virtual Academy</a></li>
<li><a href="../210442/index.html">Twister: Windows version is available.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>