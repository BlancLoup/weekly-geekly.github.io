<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development of PHP parser using ANTLR</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As a hobby for the past few months I have been developing a PHP parser using ANTLR . The project itself is rather just Just for me for me, but in the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development of PHP parser using ANTLR</h1><div class="post__text post__text-html js-mediator-article">  As a hobby for the past few months I have been developing a PHP parser using <a href="http://www.antlr2.org/">ANTLR</a> .  The <a href="http://code.google.com/p/php-llk-parser-core/">project</a> itself is rather just Just for me for me, but in the course of its implementation I, of course, had difficulties.  This is reflected in both the feature of the PHP language with the complete absence of specifications and the limitations of the LL (k) algorithms. <br><br>  In this article I would like to share technical solutions and some tricks in the implementation of the parser and its testing procedure.  This article will be useful to those who want to understand in more detail how to use the ANTLR v2 tool. <a name="habracut"></a><br><br><h4>  Problematics </h4><br>  Here I will try to tell you what this task is interesting for and what difficulties were to be solved. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h6>  1. Lack of formal language specification </h6><br>  This is perhaps the main obstacle in the development of the parser, since in this case, in addition to the development itself, some kind of reverse engineering of grammar is required. <br><br><h6>  2. PHP grammar is not context free </h6><br>  This means that in the pure form the existing parsing algorithms (groups of algorithms LL (k) and LR (k)) are in principle inapplicable.  The reasons are as follows: <br><ol><li>  Interleaving executable code with an arbitrary text stream. </li><li>  HEREDOC notation - a quote is an arbitrary sequence of characters </li><li>  A number of keywords in a language can serve as ordinary identifiers. </li></ol><br><br>  The list of purely technical difficulties can be easily attributed to the alternative syntax of control structures and the incompleteness of official documentation. <br><br><br><h4>  Implementation </h4><br><h5>  Separation of code from text "garbage" </h5><br>  When I started this job, I thought I knew php.  Actually, therefore, at first, the fact that there were no specifications did not bother me at all.  Initially, the most serious question seemed to be how to describe in a formal language the fact that the source code to be recognized should be considered only what is in the section <pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> ‚Ä¶ <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre> <br><br>  The most concise here was the solution based on the <a href="http://www.antlr2.org/doc/streams.html">multiplexing of tokens</a> and the use of the stack of lexers.  For this purpose, I have already needed an additional entity that stores the current state of the entire parser (at least, the state is ‚Äúnow waiting for the code‚Äù or ‚Äúwe are now forwarding any text‚Äù, see <a href="">ParsingState.java</a> ). <br>  And, of course, two different <a href="">lexer</a> grammars: <a href="">phpLexer</a> and <a href="">phpOutTheCode</a> .  The signals for context switching are directly the tokens <code>&lt;?php</code> , <code>&lt;?=</code> And <code>?&gt;</code> . <br><br>  Schematically, this idea is shown below. <br><img src="http://habrastorage.org/storage2/811/4aa/43c/8114aa43c0a78970e99caedc3228e718.png" alt="image"><br><br><h5>  HEREDOC lines </h5><br>  The <a href="http://www.php.net/manual/en/language.types.string.php">HEREDOC</a> notation is a multi-line string literal, which can be any identifier as a ‚Äúquotation‚Äù.  Such a literal is recognized by embedded code, which is executed after the beginning of HEREDOC is encountered in the form of a lexeme &lt;&lt;&lt;.  Directly this fragment of the lexer grammar can be seen <a href="">here</a> . <br><br><h5>  Keywords as ids </h5><br>  Keywords in the ANTLR grammar are not identifiers.  If you look at the code that in such cases is generated by ANTLR, the keyword is always recognized as a regular identifier, and then the image (string representation) is checked using the keyword dictionary.  This operation is performed inside the lexer class, which at the time of recognition does not know (and cannot know) the context of the parser class for the following reasons: <br><br><ul><li>  The parser takes the next lexeme not from a lexer, but from a special buffer.  The buffer is filled ahead of time to be able to look ahead to the k lexemes, as required by the LL (k) algorithm.  This means that at the moment of recognizing the lexeme, the parser may still not know whether an identifier is expected in this place or not: the lexer is working ahead. <br></li><li>  In the case of processing syntactic predicates (so-called Managed backtracking), the parser can perform kickbacks along the stream of tokens, and it is difficult to catch the rollback / dokat situation from the outside predicate. </li></ul><br><br>  Fortunately, the solution is simple enough: to declare a rule at the parser level as an identifier and to list, in addition to ‚Äúhonest‚Äù identifiers, keyword tokens as possible values.  Here, however, there is another danger: there will be ambiguity at the level of the rules of the parser, for example, the operation of casting to type <br> <code>(typeName) expression</code> <br>  can be interpreted as <br>  <code>(expression) expression</code> , because, for example, the <code>int</code> keyword will, by virtue of the reason described, be an input token in <code>expression</code> (since it will be an identifier).  The design does not make sense and will lead to a recognition error. <br><br>  Such a problem was solved with the help of an additional syntactic predicate (see <a href="">php.g</a> ). <br><pre> <code class="lua hljs">typeCastExpression[boolean allowComma]: (LPAREN typeName RPAREN expression[<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>]) =&gt; (LPAREN^ typeName RPAREN { #LPAREN.setType(TYPE_CAST) ;} typeCastExpression[allowComma] ) | (LNOT^ typeCastExpression[allowComma]) | (DOG^ typeCastExpression[allowComma]) | (BW_NOT^ typeCastExpression[allowComma] ) | (MINUS^ {#MINUS.setType(UNARY_MINUS);} typeCastExpression[allowComma]) | (PLUS^ {#PLUS.setType(UNARY_PLUS);} typeCastExpression[allowComma]) | incrementExpression[allowComma] ;</code> </pre><br><br><h5>  Priority of operations and other </h5><br>  A lot of effort was spent on figuring out and ‚Äúsetting up‚Äù the priority of operations.  Official <a href="http://php.net/manual/ru/language.operators.precedence.php">documentation is</a> incomplete.  So, among the operators there is a comma, which they are not in PHP. <br>  Interestingly, in PHP, the use of assignment is allowed inside the ternary operator (thanks to <a href="https://habrahabr.ru/users/mark_ablov/" class="user_link">mark_ablov</a> for the <a href="http://habrahabr.ru/post/140179/">clarification</a> ).  That is, the construction of the form <br><pre> <code class="hljs swift">a = test() ? b = <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> : d = e;</code> </pre> <br>  It will not compile in C / C ++, but compiled in PHP (such an example was found in the code of phpBB3). <br><br>  Another curious thing: the expression <code>echo</code> (this is not a function, but an expression) allows for the enumeration of operands separated by commas.  This will work as concatenation during output, but thanks to the phpMyAdmin source, another similar construct was found - print, which is similar to echo, but does not allow commas anymore. <br><br>  The lexeme <code>?&gt;</code> Turns out to be equivalent to a semicolon.  The <code>&lt;?=</code> Operator is equivalent to <code>echo</code> (including the remark above about the comma). <br><br>  The dollar symbol often looks like an operator (I <a href="http://habrahabr.ru/qa/14070/">asked a</a> question on this topic earlier), but it is not: the possibility of ‚Äúusing‚Äù several dollars in a row is recognized by the lexer and then it still looks like one lexeme - this is done in the official compiler. <br><br><h5>  Testing </h5><br>  All the listed subtleties of the language were found out, as a rule, during testing.  In this case, testing on the source code of real projects made it possible to make sure that the grammar covers the most complete language.  In addition, it is extremely important to track regressions: one small revision in a grammar can break absolutely everything. <br><br>  The meaning of the tests that I use for these purposes is extremely simple: a simple console wrapper is created around the library that accepts the php file as input.  If the parser has recognized the file without problems, then the wrapper does nothing, the problem is encountered - we print the relevant information. <br>  The wrapper program is launched by the find command with output to a file. <br>  Like that: <br> <code>$ (find ~/Documents/distr/phpBB3/ -name '*.php' -print -exec java -jar bin/jar/parse-php-test.jar -f {} \; ) &amp;&gt;./out-phpbb.txt</code> <br> <br>  Output files (in this case, out-phpbb.txt) can be saved and compared with the new result.  The result has improved or deteriorated - you can understand by the number of lines in the file: <br><pre> <code class="hljs pgsql">$ wc -l ./<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>-koh.txt* <span class="hljs-number"><span class="hljs-number">498</span></span> ./<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>-koh.txt <span class="hljs-number"><span class="hljs-number">502</span></span> ./<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>-koh.txt.<span class="hljs-built_in"><span class="hljs-built_in">old</span></span></code> </pre> <br><br><h4>  Conclusion </h4><br>  The project of the parser is currently of more academic interest.  It can be used as a basis, for example, to extend <a href="http://checkstyle.sourceforge.net/">CheckStyle</a> functionality or to implement your own php beautifier. <br><br>  As you can see, the parser is now designed for language version 5.2, although there are no fundamental problems in bringing grammar to level 5.3 in my opinion (with version 5.4 it is more difficult: there is practically no test base for grammar validation).  At the moment, the parser successfully parses the entire set of source codes ZF 1.11, Yii Framework 1.1.10 and phpBB 3.0.10. <br><br>  I would be glad if this work seemed to someone interesting and / or useful.  Your comments and criticisms will also be helpful. <br><br>  Thank you for your attention! </div><p>Source: <a href="https://habr.com/ru/post/140179/">https://habr.com/ru/post/140179/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../140169/index.html">"The very goal" in the design to order</a></li>
<li><a href="../140171/index.html">Excursion to the data center "Beeline"</a></li>
<li><a href="../140172/index.html">AndroidLost: remote control of a lost smartphone</a></li>
<li><a href="../140176/index.html">POST card or educational program for the diagnosis of Part II</a></li>
<li><a href="../140178/index.html">Dynamically adding groups of elements in Zend Framework forms using ZendX_JQuery</a></li>
<li><a href="../140180/index.html">Fans have already collected $ 1.3M on Wasteland 2</a></li>
<li><a href="../140181/index.html">JAX-RS Basics</a></li>
<li><a href="../140182/index.html">SSI loop - Loops in SSI</a></li>
<li><a href="../140184/index.html">Monitor Nginx with ZTC and Zabbix</a></li>
<li><a href="../140185/index.html">SQL.js: SQLite engine is translated to JavaScript via Emscripten</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>